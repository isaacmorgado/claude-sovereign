/**
 * SPLICE Website - Checkout Flow Simulation Test
 * Simulates end-to-end checkout flow against the deployed API
 *
 * Run: node tests/checkout-simulation.test.js [--live]
 *
 * By default tests against production: https://splice-website.vercel.app
 * Use --local to test against http://localhost:3000
 */

const isLocal = process.argv.includes('--local');
const BASE_URL = isLocal
  ? 'http://localhost:3000'
  : 'https://splice-website.vercel.app';

let passed = 0;
let failed = 0;
const results = [];

async function test(name, fn) {
  try {
    await fn();
    console.log(`  ✓ ${name}`);
    passed++;
    results.push({ name, status: 'passed' });
  } catch (error) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
    failed++;
    results.push({ name, status: 'failed', error: error.message });
  }
}

function assert(condition, message) {
  if (!condition) {
    throw new Error(message || "Assertion failed");
  }
}

async function fetchWithTimeout(url, options = {}, timeout = 10000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const response = await fetch(url, { ...options, signal: controller.signal });
    clearTimeout(id);
    return response;
  } catch (error) {
    clearTimeout(id);
    throw error;
  }
}

console.log(`\n=== Checkout Simulation Tests ===`);
console.log(`Testing against: ${BASE_URL}\n`);

async function runTests() {
  // ============================================
  // Health Check
  // ============================================
  console.log("Health Checks:");

  await test("Website is accessible", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}`);
    assert(response.ok, `Website returned ${response.status}`);
  });

  await test("Checkout page loads", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/checkout?plan=pro`);
    assert(response.ok, `Checkout page returned ${response.status}`);
    const html = await response.text();
    assert(html.includes('Start Free Trial') || html.includes('checkout'), 'Missing checkout content');
  });

  await test("Pricing page loads", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/pricing`);
    assert(response.ok, `Pricing page returned ${response.status}`);
    const html = await response.text();
    assert(html.includes('$15') || html.includes('$39') || html.includes('$129'), 'Missing pricing');
  });

  // ============================================
  // API Endpoint Tests
  // ============================================
  console.log("\nCheckout API:");

  await test("POST /api/checkout requires plan", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/api/checkout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: 'test@example.com' })
    });
    assert(response.status === 400, `Expected 400, got ${response.status}`);
    const data = await response.json();
    assert(data.error, 'Should return error for missing plan');
  });

  await test("POST /api/checkout rejects invalid plan", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/api/checkout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ plan: 'invalid-plan', email: 'test@example.com' })
    });
    assert(response.status === 400 || response.status === 500, `Expected error status, got ${response.status}`);
    const data = await response.json();
    assert(data.error, 'Should return error for invalid plan');
  });

  await test("POST /api/checkout accepts valid plans", async () => {
    // This test will create a real Stripe session if Stripe is configured
    // We only verify the API accepts the request structure
    const response = await fetchWithTimeout(`${BASE_URL}/api/checkout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        plan: 'starter',
        email: 'simulation-test@example.com',
        billing: 'monthly'
      })
    });

    // Either success (creates session) or 500 (Stripe not configured in test env)
    const data = await response.json();
    if (response.ok) {
      assert(data.sessionId || data.url, 'Should return sessionId or url on success');
    } else {
      // Acceptable: Stripe might not be configured in test environment
      assert(data.error, 'Should return error object');
      console.log(`    (Note: ${data.error})`);
    }
  });

  await test("GET /api/checkout requires session_id", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/api/checkout`);
    assert(response.status === 400, `Expected 400, got ${response.status}`);
    const data = await response.json();
    assert(data.error.includes('Session ID'), 'Should indicate session_id required');
  });

  await test("GET /api/checkout handles invalid session", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/api/checkout?session_id=invalid_session_123`);
    // Stripe will return error for invalid session
    assert(response.status === 500 || response.status === 400, `Expected error status, got ${response.status}`);
  });

  // ============================================
  // Plan Selection Tests
  // ============================================
  console.log("\nPlan Validation:");

  const validPlans = ['starter', 'pro', 'team'];
  const billingOptions = ['monthly', 'annual'];

  for (const plan of validPlans) {
    await test(`Plan '${plan}' is recognized`, async () => {
      const response = await fetchWithTimeout(`${BASE_URL}/api/checkout`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plan, email: `test-${plan}@example.com` })
      });
      const data = await response.json();
      // Should not return "Invalid plan" error
      assert(!data.error?.includes('Invalid plan'), `Plan '${plan}' should be valid`);
    });
  }

  // ============================================
  // Success/Cancel Page Tests
  // ============================================
  console.log("\nSuccess/Cancel Pages:");

  await test("Success page loads", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/checkout/success`);
    assert(response.ok, `Success page returned ${response.status}`);
  });

  await test("Cancel page loads", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/checkout/cancel`);
    assert(response.ok, `Cancel page returned ${response.status}`);
    const html = await response.text();
    assert(html.includes('cancel') || html.includes('Cancel') || html.includes('back'), 'Missing cancel content');
  });

  // ============================================
  // Security Tests
  // ============================================
  console.log("\nSecurity:");

  await test("API has CORS headers", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/api/checkout`, {
      method: 'OPTIONS'
    });
    // Next.js handles CORS implicitly, just verify endpoint exists
    assert(response.status !== 404, 'API endpoint should exist');
  });

  await test("No sensitive data in error responses", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/api/checkout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ plan: 'invalid' })
    });
    const data = await response.json();
    const errorStr = JSON.stringify(data);
    assert(!errorStr.includes('sk_'), 'Should not expose Stripe secret key');
    assert(!errorStr.includes('Bearer'), 'Should not expose auth tokens');
    assert(!errorStr.includes('password'), 'Should not expose passwords');
  });

  // ============================================
  // Webhook Endpoint Tests
  // ============================================
  console.log("\nWebhook Security:");

  await test("Webhook requires POST method", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/api/webhook`, {
      method: 'GET'
    });
    assert(response.status === 405, `Expected 405 Method Not Allowed, got ${response.status}`);
  });

  await test("Webhook requires Stripe signature", async () => {
    const response = await fetchWithTimeout(`${BASE_URL}/api/webhook`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'test.event' })
    });
    // Should fail without proper Stripe signature
    assert(response.status === 400 || response.status === 500, `Expected error for missing signature, got ${response.status}`);
  });

  // ============================================
  // Results Summary
  // ============================================
  console.log("\n========================================");
  console.log(`Simulation Tests: ${passed} passed, ${failed} failed`);
  console.log("========================================\n");

  if (failed > 0) {
    console.log("Failed tests:");
    results.filter(r => r.status === 'failed').forEach(r => {
      console.log(`  - ${r.name}: ${r.error}`);
    });
    console.log("");
  }

  return failed === 0;
}

// Run tests
runTests()
  .then(success => process.exit(success ? 0 : 1))
  .catch(error => {
    console.error("Test runner error:", error);
    process.exit(1);
  });
