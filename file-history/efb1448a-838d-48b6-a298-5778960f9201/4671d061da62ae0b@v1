#!/bin/bash
# Batch rename downloaded images to match landmark naming convention
#
# Usage:
#   1. Download generated images to a folder
#   2. Run: ./scripts/batch-rename-images.sh <source_folder> <gender> <race> <profile>
#
# Example:
#   ./scripts/batch-rename-images.sh ~/Downloads/male_white male white front

SOURCE_DIR=$1
GENDER=$2
RACE=$3
PROFILE=$4

if [ -z "$SOURCE_DIR" ] || [ -z "$GENDER" ] || [ -z "$RACE" ] || [ -z "$PROFILE" ]; then
    echo "Usage: $0 <source_folder> <gender> <race> <profile>"
    echo "Example: $0 ~/Downloads/male_white male white front"
    exit 1
fi

TARGET_DIR="public/landmarks/$PROFILE"
mkdir -p "$TARGET_DIR"

# Define landmark order (must match generation order)
if [ "$PROFILE" == "front" ]; then
    LANDMARKS=(
        "leftEyePupil" "rightEyePupil" "leftEyeMedialCanthus" "rightEyeMedialCanthus"
        "leftEyeLateralCanthus" "rightEyeLateralCanthus" "leftEyeUpperEyelid" "rightEyeUpperEyelid"
        "leftEyeLowerEyelid" "rightEyeLowerEyelid" "leftUpperEyelidCrease" "rightUpperEyelidCrease"
        "leftEyelidHoodEnd" "rightEyelidHoodEnd" "leftBrowHead" "rightBrowHead"
        "leftBrowTail" "rightBrowTail" "leftBrowArch" "rightBrowArch"
        "leftBrowPeak" "rightBrowPeak" "leftBrowInnerCorner" "rightBrowInnerCorner"
        "nasalBase" "noseBottom" "noseLeft" "noseRight" "leftNoseBridge" "rightNoseBridge"
        "cupidsBow" "innerCupidsBow" "mouthMiddle" "mouthLeft" "mouthRight" "lowerLip"
        "chinBottom" "chinLeft" "chinRight"
        "leftTopGonion" "rightTopGonion" "leftBottomGonion" "rightBottomGonion"
        "leftCheek" "rightCheek" "leftTemple" "rightTemple"
        "leftOuterEar" "rightOuterEar" "neckLeft" "neckRight" "hairline"
    )
else
    LANDMARKS=(
        "trichion" "glabella" "forehead" "vertex" "occiput"
        "nasion" "orbitale" "cornealApex" "eyelidEnd" "lowerEyelid"
        "rhinion" "supratip" "pronasale" "infratip" "columella" "subalare" "subnasale"
        "labraleSuperius" "labraleInferius" "cheilion" "sublabiale"
        "pogonion" "menton" "gonionTop" "gonionBottom"
        "tragus" "porion" "intertragicNotch"
        "cervicalPoint" "neckPoint" "cheekbone"
    )
fi

# Get source files sorted by name/number
FILES=($(ls -1 "$SOURCE_DIR"/*.{png,jpg,jpeg,webp} 2>/dev/null | sort))

echo "Found ${#FILES[@]} files in $SOURCE_DIR"
echo "Expected ${#LANDMARKS[@]} landmarks"

if [ ${#FILES[@]} -ne ${#LANDMARKS[@]} ]; then
    echo "WARNING: File count doesn't match landmark count!"
fi

# Rename and move files
for i in "${!FILES[@]}"; do
    if [ $i -lt ${#LANDMARKS[@]} ]; then
        SRC="${FILES[$i]}"
        LANDMARK="${LANDMARKS[$i]}"
        DEST="$TARGET_DIR/${GENDER}_${RACE}_${LANDMARK}.webp"

        echo "Converting: $SRC -> $DEST"

        # Convert to webp and move
        if command -v cwebp &> /dev/null; then
            cwebp -q 85 "$SRC" -o "$DEST"
        else
            # Fallback: just copy with extension change
            cp "$SRC" "$DEST"
        fi
    fi
done

echo "Done! Images saved to $TARGET_DIR"
