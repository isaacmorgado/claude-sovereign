import { S3Client, PutObjectCommand, GetObjectCommand } from '@aws-sdk/client-s3'
import { getSignedUrl } from '@aws-sdk/s3-request-presigner'
import { env } from '../config/env.js'
import crypto from 'crypto'

const s3Client = new S3Client({
  region: env.AWS_REGION,
  credentials:
    env.AWS_ACCESS_KEY_ID && env.AWS_SECRET_ACCESS_KEY
      ? {
          accessKeyId: env.AWS_ACCESS_KEY_ID,
          secretAccessKey: env.AWS_SECRET_ACCESS_KEY,
        }
      : undefined,
  ...(env.S3_ENDPOINT && {
    endpoint: env.S3_ENDPOINT,
    forcePathStyle: true, // Required for LocalStack
  }),
})

const ALLOWED_CONTENT_TYPES = [
  'audio/mpeg',
  'audio/mp3',
  'audio/wav',
  'audio/wave',
  'audio/x-wav',
  'audio/aac',
  'audio/ogg',
  'audio/flac',
  'audio/m4a',
  'audio/x-m4a',
  'video/mp4',
  'video/quicktime',
]

const MAX_FILE_SIZE = 500 * 1024 * 1024 // 500MB

interface PresignedUrlResult {
  uploadUrl: string
  fileKey: string
  publicUrl: string
}

export const s3Service = {
  isConfigured(): boolean {
    return !!(env.S3_BUCKET_NAME && env.AWS_ACCESS_KEY_ID && env.AWS_SECRET_ACCESS_KEY)
  },

  async generateUploadUrl(
    userId: string,
    filename: string,
    contentType: string,
    fileSize: number
  ): Promise<PresignedUrlResult> {
    if (!env.S3_BUCKET_NAME) {
      throw new Error('S3 is not configured')
    }

    if (!ALLOWED_CONTENT_TYPES.includes(contentType)) {
      throw new Error(`Invalid content type: ${contentType}. Allowed: ${ALLOWED_CONTENT_TYPES.join(', ')}`)
    }

    if (fileSize > MAX_FILE_SIZE) {
      throw new Error(`File too large. Maximum size is ${String(MAX_FILE_SIZE / 1024 / 1024)}MB`)
    }

    // Generate unique file key with user folder
    const ext = filename.split('.').pop() || 'audio'
    const uniqueId = crypto.randomUUID()
    const fileKey = `uploads/${userId}/${uniqueId}.${ext}`

    const command = new PutObjectCommand({
      Bucket: env.S3_BUCKET_NAME,
      Key: fileKey,
      ContentType: contentType,
      ContentLength: fileSize,
    })

    const uploadUrl = await getSignedUrl(s3Client, command, { expiresIn: 3600 }) // 1 hour

    // LocalStack uses path-style URLs, AWS uses virtual-hosted style
    const publicUrl = env.S3_ENDPOINT
      ? `${env.S3_ENDPOINT}/${env.S3_BUCKET_NAME}/${fileKey}`
      : `https://${env.S3_BUCKET_NAME}.s3.${env.AWS_REGION}.amazonaws.com/${fileKey}`

    return {
      uploadUrl,
      fileKey,
      publicUrl,
    }
  },

  async generateDownloadUrl(fileKey: string): Promise<string> {
    if (!env.S3_BUCKET_NAME) {
      throw new Error('S3 is not configured')
    }

    const command = new GetObjectCommand({
      Bucket: env.S3_BUCKET_NAME,
      Key: fileKey,
    })

    return getSignedUrl(s3Client, command, { expiresIn: 3600 }) // 1 hour
  },
}
