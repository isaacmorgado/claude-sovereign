import { z } from "zod"

/**
 * Bridge connection states
 */
export type BridgeConnectionState = "disconnected" | "connecting" | "connected" | "error"

/**
 * Message types for browser-extension communication
 */
export const BridgeMessageTypeSchema = z.enum([
	// Connection management
	"connect",
	"disconnect",
	"ping",
	"pong",
	"handshake",
	"handshake_ack",

	// DOM inspection
	"dom_inspect_request",
	"dom_inspect_response",
	"dom_query_selector",
	"dom_query_selector_response",
	"dom_get_computed_styles",
	"dom_get_computed_styles_response",
	"dom_highlight_element",
	"dom_highlight_clear",

	// Page interaction
	"page_screenshot",
	"page_screenshot_response",
	"page_navigate",
	"page_navigate_response",
	"page_reload",
	"page_execute_script",
	"page_execute_script_response",
	"page_get_info",
	"page_get_info_response",

	// Network monitoring
	"network_enable",
	"network_disable",
	"network_request",
	"network_response",
	"network_get_requests",
	"network_get_requests_response",
	"network_clear",

	// Console monitoring
	"console_enable",
	"console_disable",
	"console_message",
	"console_get_messages",
	"console_get_messages_response",
	"console_clear",

	// Tab management
	"tabs_list",
	"tabs_list_response",
	"tabs_activate",
	"tabs_close",
	"tabs_create",
	"tabs_create_response",

	// Error handling
	"error",
])

export type BridgeMessageType = z.infer<typeof BridgeMessageTypeSchema>

/**
 * Base bridge message schema
 */
export const BridgeMessageSchema = z.object({
	id: z.string(),
	type: BridgeMessageTypeSchema,
	timestamp: z.number(),
	tabId: z.number().optional(),
	payload: z.record(z.unknown()).optional(),
})

export type BridgeMessage = z.infer<typeof BridgeMessageSchema>

/**
 * DOM element info returned from inspection
 */
export interface DOMElementInfo {
	tagName: string
	id?: string
	className?: string
	attributes: Record<string, string>
	textContent?: string
	innerHTML?: string
	outerHTML?: string
	rect?: DOMRect
	computedStyles?: Record<string, string>
	children?: DOMElementInfo[]
	xpath?: string
	cssSelector?: string
}

/**
 * Page info returned from page inspection
 */
export interface PageInfo {
	url: string
	title: string
	favicon?: string
	readyState: DocumentReadyState
	viewport: {
		width: number
		height: number
		devicePixelRatio: number
	}
	scrollPosition: {
		x: number
		y: number
	}
}

/**
 * Network request info
 */
export interface NetworkRequestInfo {
	requestId: string
	url: string
	method: string
	headers: Record<string, string>
	body?: string
	timestamp: number
	type: string
	status?: number
	statusText?: string
	responseHeaders?: Record<string, string>
	responseBody?: string
	responseTimestamp?: number
	duration?: number
	error?: string
}

/**
 * Console message info
 */
export interface ConsoleMessageInfo {
	id: string
	level: "log" | "warn" | "error" | "info" | "debug"
	message: string
	args?: unknown[]
	timestamp: number
	source?: string
	lineNumber?: number
	columnNumber?: number
	stackTrace?: string
}

/**
 * Tab info
 */
export interface TabInfo {
	id: number
	url: string
	title: string
	favicon?: string
	active: boolean
	pinned: boolean
	windowId: number
}

/**
 * Handshake payload from extension
 */
export interface HandshakePayload {
	extensionId: string
	extensionVersion: string
	browserName: string
	browserVersion: string
	userAgent: string
}

/**
 * Bridge event types
 */
export interface BridgeEvents {
	connected: (info: HandshakePayload) => void
	disconnected: (reason?: string) => void
	error: (error: Error) => void
	"connection-state-changed": (state: BridgeConnectionState) => void
	"network-request": (request: NetworkRequestInfo) => void
	"network-response": (response: NetworkRequestInfo) => void
	"console-message": (message: ConsoleMessageInfo) => void
	"tab-activated": (tabId: number) => void
	"tab-updated": (tab: TabInfo) => void
	"tab-removed": (tabId: number) => void
}

/**
 * Bridge configuration options
 */
export interface BridgeConfig {
	port: number
	host: string
	enableNetworkMonitoring: boolean
	enableConsoleMonitoring: boolean
	maxNetworkRequests: number
	maxConsoleMessages: number
	heartbeatInterval: number
	connectionTimeout: number
}

/**
 * Default bridge configuration
 */
export const DEFAULT_BRIDGE_CONFIG: BridgeConfig = {
	port: 9876,
	host: "127.0.0.1",
	enableNetworkMonitoring: true,
	enableConsoleMonitoring: true,
	maxNetworkRequests: 1000,
	maxConsoleMessages: 500,
	heartbeatInterval: 30000,
	connectionTimeout: 10000,
}
