#!/bin/bash
# Project Navigator - Generate efficient project structure for Claude
# Based on patterns from: repomix, rich (Textualize), spaCy
# Helps Claude navigate projects without burning tokens

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CACHE_DIR="${HOME}/.claude/cache/project-structure"
INDEX_FILE=".claude/project-index.md"

mkdir -p "$CACHE_DIR"

# ============================================================================
# Tree Generation (from repomix pattern)
# ============================================================================

generate_tree_line() {
    local depth=$1
    local is_last=$2
    local name=$3
    local is_dir=$4

    local prefix=""
    for ((i=0; i<depth-1; i++)); do
        prefix+="â”‚   "
    done

    if [ "$is_last" = "true" ]; then
        prefix+="â””â”€â”€ "
    else
        prefix+="â”œâ”€â”€ "
    fi

    if [ "$is_dir" = "true" ]; then
        echo "${prefix}ðŸ“ $name/"
    else
        echo "${prefix}ðŸ“„ $name"
    fi
}

walk_directory() {
    local dir="$1"
    local depth="${2:-0}"
    local max_depth="${3:-4}"
    local prefix="${4:-}"

    # Stop at max depth
    if [ "$depth" -ge "$max_depth" ]; then
        return
    fi

    # Ignore patterns
    local ignore_patterns=(
        "node_modules"
        ".git"
        "dist"
        "build"
        ".next"
        "__pycache__"
        "*.pyc"
        ".pytest_cache"
        "coverage"
        ".coverage"
        "venv"
        ".venv"
        ".DS_Store"
        "*.log"
    )

    # Get all entries
    local entries=()
    while IFS= read -r -d '' entry; do
        local basename=$(basename "$entry")

        # Check ignore patterns
        local should_ignore=false
        for pattern in "${ignore_patterns[@]}"; do
            if [[ "$basename" == $pattern ]]; then
                should_ignore=true
                break
            fi
        done

        [ "$should_ignore" = false ] && entries+=("$entry")
    done < <(find "$dir" -mindepth 1 -maxdepth 1 -print0 2>/dev/null | sort -z)

    local count=${#entries[@]}
    local idx=0

    for entry in "${entries[@]}"; do
        ((idx++))
        local is_last=false
        [ $idx -eq $count ] && is_last=true

        local basename=$(basename "$entry")

        if [ -d "$entry" ]; then
            generate_tree_line "$depth" "$is_last" "$basename" true
            walk_directory "$entry" $((depth + 1)) "$max_depth"
        else
            generate_tree_line "$depth" "$is_last" "$basename" false
        fi
    done
}

# ============================================================================
# Important Files Detection
# ============================================================================

find_important_files() {
    local project_root="${1:-.}"

    echo "## ðŸ“‹ Important Files"
    echo ""

    # Configuration files
    echo "### Configuration"
    for pattern in "*.json" "*.yaml" "*.yml" "*.toml" "*.ini" ".env*" "Makefile" "Dockerfile" "*.config.js"; do
        find "$project_root" -maxdepth 2 -name "$pattern" -type f 2>/dev/null | sed 's|^|â€¢ |'
    done
    echo ""

    # Documentation
    echo "### Documentation"
    for pattern in "README*" "CLAUDE.md" "ARCHITECTURE.md" "*.md"; do
        find "$project_root" -maxdepth 2 -name "$pattern" -type f 2>/dev/null | sed 's|^|â€¢ |'
    done
    echo ""

    # Entry points
    echo "### Entry Points"
    for pattern in "main.*" "index.*" "app.*" "server.*" "__init__.py"; do
        find "$project_root" -maxdepth 3 -name "$pattern" -type f 2>/dev/null | sed 's|^|â€¢ |'
    done
    echo ""
}

# ============================================================================
# Project Statistics
# ============================================================================

calculate_stats() {
    local project_root="${1:-.}"

    echo "## ðŸ“Š Project Statistics"
    echo ""

    # File counts by type
    local js_count=$(find "$project_root" -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" 2>/dev/null | wc -l | tr -d ' ')
    local py_count=$(find "$project_root" -name "*.py" 2>/dev/null | wc -l | tr -d ' ')
    local rust_count=$(find "$project_root" -name "*.rs" 2>/dev/null | wc -l | tr -d ' ')
    local go_count=$(find "$project_root" -name "*.go" 2>/dev/null | wc -l | tr -d ' ')

    echo "**Languages:**"
    [ "$js_count" -gt 0 ] && echo "â€¢ JavaScript/TypeScript: $js_count files"
    [ "$py_count" -gt 0 ] && echo "â€¢ Python: $py_count files"
    [ "$rust_count" -gt 0 ] && echo "â€¢ Rust: $rust_count files"
    [ "$go_count" -gt 0 ] && echo "â€¢ Go: $go_count files"
    echo ""

    # Total lines of code (rough estimate)
    local total_lines=$(find "$project_root" -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.rs" -o -name "*.go" \) -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}')
    echo "**Estimated LOC:** ${total_lines:-0}"
    echo ""
}

# ============================================================================
# Directory Purpose Detection
# ============================================================================

detect_directory_purpose() {
    local dir="$1"

    local basename=$(basename "$dir")

    case "$basename" in
        src|source|lib|app)
            echo "Source code"
            ;;
        test|tests|__tests__|spec)
            echo "Test files"
            ;;
        docs|documentation)
            echo "Documentation"
            ;;
        config|conf)
            echo "Configuration"
            ;;
        scripts|bin)
            echo "Scripts/utilities"
            ;;
        public|static|assets)
            echo "Static assets"
            ;;
        components)
            echo "UI components"
            ;;
        pages|routes)
            echo "Routes/pages"
            ;;
        api|server)
            echo "Backend API"
            ;;
        utils|helpers)
            echo "Utility functions"
            ;;
        models|schemas)
            echo "Data models"
            ;;
        hooks)
            echo "Custom hooks"
            ;;
        *)
            echo ""
            ;;
    esac
}

# ============================================================================
# Main Index Generator
# ============================================================================

generate_project_index() {
    local project_root="${1:-.}"
    local max_depth="${2:-4}"

    cd "$project_root"

    local project_name=$(basename "$project_root")
    local generated_date=$(date '+%Y-%m-%d %H:%M:%S')

    cat <<EOF
# ðŸ—‚ï¸ Project Structure: $project_name

**Generated**: $generated_date
**Purpose**: Quick navigation reference for Claude (token-efficient)

---

## ðŸ“ Directory Tree

\`\`\`
$(pwd)
EOF

    walk_directory "$project_root" 0 "$max_depth"

    cat <<'EOF'
```

---

EOF

    find_important_files "$project_root"

    cat <<'EOF'

---

EOF

    calculate_stats "$project_root"

    cat <<'EOF'

---

## ðŸ§­ Navigation Guide

### Quick File Location
- Use \`grep -r "pattern" src/\` to search source
- Use \`find . -name "*.ext"\` to locate by extension
- Check CLAUDE.md for project-specific context

### Common Directories
EOF

    # List top-level directories with purposes
    for dir in "$project_root"/*; do
        if [ -d "$dir" ]; then
            local basename=$(basename "$dir")
            local purpose=$(detect_directory_purpose "$dir")
            if [ -n "$purpose" ]; then
                echo "â€¢ **$basename/**: $purpose"
            else
                echo "â€¢ **$basename/**"
            fi
        fi
    done

    cat <<'EOF'

---

## ðŸ’¡ Usage Tips

**For Claude:**
1. Read this file first before exploring (saves tokens)
2. Use Grep/Glob tools for targeted searches
3. Reference specific paths from tree above
4. Check Important Files for config/docs

**Regenerate:**
```bash
~/.claude/hooks/project-navigator.sh generate
```

**Auto-update:** Index refreshes on major file changes (>10 files edited)
EOF
}

# ============================================================================
# Cache Management
# ============================================================================

get_cache_key() {
    local project_root="${1:-.}"
    echo "$project_root" | md5sum | cut -d' ' -f1
}

is_cache_valid() {
    local project_root="${1:-.}"
    local cache_file="$CACHE_DIR/$(get_cache_key "$project_root").md"

    # Cache valid if less than 1 hour old
    if [ -f "$cache_file" ]; then
        local cache_age=$(($(date +%s) - $(stat -f %m "$cache_file" 2>/dev/null || stat -c %Y "$cache_file")))
        [ $cache_age -lt 3600 ] && return 0
    fi

    return 1
}

# ============================================================================
# Main Command Handler
# ============================================================================

case "${1:-help}" in
    generate)
        project_root="${2:-.}"
        max_depth="${3:-4}"

        echo "Generating project index for: $project_root"

        index_content=$(generate_project_index "$project_root" "$max_depth")

        # Save to project .claude directory
        mkdir -p "$project_root/.claude"
        echo "$index_content" > "$project_root/$INDEX_FILE"
        echo "âœ… Index saved to: $project_root/$INDEX_FILE"

        # Save to cache
        cache_key=$(get_cache_key "$project_root")
        echo "$index_content" > "$CACHE_DIR/${cache_key}.md"
        echo "âœ… Cached at: $CACHE_DIR/${cache_key}.md"
        ;;

    quick)
        # Quick generation with cached check
        project_root="${2:-.}"

        if is_cache_valid "$project_root"; then
            echo "Using cached index (less than 1 hour old)"
            cache_key=$(get_cache_key "$project_root")
            cat "$CACHE_DIR/${cache_key}.md"
        else
            echo "Generating fresh index..."
            generate_project_index "$project_root" 3
        fi
        ;;

    tree)
        # Just show tree, no full index
        project_root="${2:-.}"
        max_depth="${3:-4}"
        echo "$(pwd)"
        walk_directory "$project_root" 0 "$max_depth"
        ;;

    stats)
        # Just show stats
        project_root="${2:-.}"
        calculate_stats "$project_root"
        ;;

    important)
        # Just show important files
        project_root="${2:-.}"
        find_important_files "$project_root"
        ;;

    help|*)
        cat <<'EOF'
Project Navigator - Efficient codebase navigation for Claude

Usage:
  project-navigator.sh generate [dir] [depth]  - Generate full project index
  project-navigator.sh quick [dir]             - Quick index (uses cache if valid)
  project-navigator.sh tree [dir] [depth]      - Show directory tree only
  project-navigator.sh stats [dir]             - Show project statistics
  project-navigator.sh important [dir]         - List important files
  project-navigator.sh help                    - Show this help

Arguments:
  dir    Project directory (default: current directory)
  depth  Maximum tree depth (default: 4)

Examples:
  # Generate index for current project
  project-navigator.sh generate

  # Generate index with max depth 3
  project-navigator.sh generate . 3

  # Quick check (uses cache)
  project-navigator.sh quick

  # Show tree only
  project-navigator.sh tree

Output:
  Saves to: .claude/project-index.md (in project root)
  Caches to: ~/.claude/cache/project-structure/

Integration:
  â€¢ Auto-generated after 10 file changes (post-edit-quality hook)
  â€¢ Claude reads this before exploring to save tokens
  â€¢ Provides quick navigation reference

Token Savings:
  â€¢ Replaces multiple file reads with single index
  â€¢ Tree view shows structure at a glance
  â€¢ Important files listed upfront
  â€¢ ~50-70% reduction in exploratory token usage
EOF
        ;;
esac
