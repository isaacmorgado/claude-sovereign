/**
 * Music Alignment E2E Tests
 * Tests for beat detection, audio trimming, and fade out generation
 */

const assert = require('assert');

// Test counters
let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    passed++;
    console.log(`✓ ${name}`);
  } catch (error) {
    failed++;
    console.log(`✗ ${name}`);
    console.log(`  Error: ${error.message}`);
  }
}

async function asyncTest(name, fn) {
  try {
    await fn();
    passed++;
    console.log(`✓ ${name}`);
  } catch (error) {
    failed++;
    console.log(`✗ ${name}`);
    console.log(`  Error: ${error.message}`);
  }
}

console.log('\n========================================');
console.log('Music Alignment E2E Tests');
console.log('========================================\n');

// ============================================
// musicAlignment.js Service Tests
// ============================================

console.log('--- musicAlignment.js Service Tests ---\n');

const musicAlignment = require('../services/musicAlignment');

// Test exports
test('musicAlignment exports detectBeats function', () => {
  assert.strictEqual(typeof musicAlignment.detectBeats, 'function');
});

test('musicAlignment exports parseBeatOutput function', () => {
  assert.strictEqual(typeof musicAlignment.parseBeatOutput, 'function');
});

test('musicAlignment exports detectBeatsWithFallback function', () => {
  assert.strictEqual(typeof musicAlignment.detectBeatsWithFallback, 'function');
});

test('musicAlignment exports parseSilenceAsBeats function', () => {
  assert.strictEqual(typeof musicAlignment.parseSilenceAsBeats, 'function');
});

test('musicAlignment exports generateSyntheticBeats function', () => {
  assert.strictEqual(typeof musicAlignment.generateSyntheticBeats, 'function');
});

test('musicAlignment exports getAudioDuration function', () => {
  assert.strictEqual(typeof musicAlignment.getAudioDuration, 'function');
});

test('musicAlignment exports findNearestBeat function', () => {
  assert.strictEqual(typeof musicAlignment.findNearestBeat, 'function');
});

test('musicAlignment exports findBestCutBeat function', () => {
  assert.strictEqual(typeof musicAlignment.findBestCutBeat, 'function');
});

test('musicAlignment exports trimToLength function', () => {
  assert.strictEqual(typeof musicAlignment.trimToLength, 'function');
});

test('musicAlignment exports applyFadeOut function', () => {
  assert.strictEqual(typeof musicAlignment.applyFadeOut, 'function');
});

test('musicAlignment exports analyzeBeats function', () => {
  assert.strictEqual(typeof musicAlignment.analyzeBeats, 'function');
});

test('musicAlignment exports crossfade function', () => {
  assert.strictEqual(typeof musicAlignment.crossfade, 'function');
});

test('musicAlignment exports validateAlignmentOptions function', () => {
  assert.strictEqual(typeof musicAlignment.validateAlignmentOptions, 'function');
});

// Test constants
test('musicAlignment exports DEFAULT_FADE_DURATION constant', () => {
  assert.strictEqual(musicAlignment.DEFAULT_FADE_DURATION, 2.0);
});

test('musicAlignment exports MIN_FADE_DURATION constant', () => {
  assert.strictEqual(musicAlignment.MIN_FADE_DURATION, 0.5);
});

test('musicAlignment exports MAX_FADE_DURATION constant', () => {
  assert.strictEqual(musicAlignment.MAX_FADE_DURATION, 5.0);
});

test('musicAlignment exports BEAT_SEARCH_WINDOW constant', () => {
  assert.strictEqual(musicAlignment.BEAT_SEARCH_WINDOW, 3.0);
});

test('musicAlignment exports MIN_AUDIO_DURATION constant', () => {
  assert.strictEqual(musicAlignment.MIN_AUDIO_DURATION, 5.0);
});

// ============================================
// parseBeatOutput Tests
// ============================================

console.log('\n--- parseBeatOutput Tests ---\n');

test('parseBeatOutput parses lavfi.aubio.time format', () => {
  const data = `
    lavfi.aubio.time=0.5
    lavfi.aubio.time=1.0
    lavfi.aubio.time=1.5
  `;
  const beats = musicAlignment.parseBeatOutput(data);
  assert.deepStrictEqual(beats, [0.5, 1.0, 1.5]);
});

test('parseBeatOutput parses pts_time format', () => {
  const data = `
    pts_time:0.25
    pts_time:0.75
    pts_time:1.25
  `;
  const beats = musicAlignment.parseBeatOutput(data);
  assert.deepStrictEqual(beats, [0.25, 0.75, 1.25]);
});

test('parseBeatOutput removes duplicates', () => {
  const data = `
    lavfi.aubio.time=1.0
    lavfi.aubio.time=1.0
    lavfi.aubio.time=2.0
  `;
  const beats = musicAlignment.parseBeatOutput(data);
  assert.deepStrictEqual(beats, [1.0, 2.0]);
});

test('parseBeatOutput returns empty array for empty input', () => {
  const beats = musicAlignment.parseBeatOutput('');
  assert.deepStrictEqual(beats, []);
});

test('parseBeatOutput sorts beats chronologically', () => {
  const data = `
    lavfi.aubio.time=2.0
    lavfi.aubio.time=0.5
    lavfi.aubio.time=1.5
  `;
  const beats = musicAlignment.parseBeatOutput(data);
  assert.deepStrictEqual(beats, [0.5, 1.5, 2.0]);
});

// ============================================
// parseSilenceAsBeats Tests
// ============================================

console.log('\n--- parseSilenceAsBeats Tests ---\n');

test('parseSilenceAsBeats parses silence_start markers', () => {
  const data = `
    silence_start: 2.5
    silence_end: 3.0
    silence_start: 5.0
    silence_end: 5.5
  `;
  const beats = musicAlignment.parseSilenceAsBeats(data);
  assert.deepStrictEqual(beats, [2.5, 5.0]);
});

test('parseSilenceAsBeats handles empty input', () => {
  const beats = musicAlignment.parseSilenceAsBeats('');
  assert.deepStrictEqual(beats, []);
});

test('parseSilenceAsBeats sorts beats', () => {
  const data = `
    silence_start: 10.0
    silence_start: 2.5
    silence_start: 5.0
  `;
  const beats = musicAlignment.parseSilenceAsBeats(data);
  assert.deepStrictEqual(beats, [2.5, 5.0, 10.0]);
});

// ============================================
// findNearestBeat Tests
// ============================================

console.log('\n--- findNearestBeat Tests ---\n');

test('findNearestBeat finds exact match', () => {
  const beats = [1.0, 2.0, 3.0, 4.0, 5.0];
  const result = musicAlignment.findNearestBeat(beats, 3.0);
  assert.strictEqual(result.beat, 3.0);
  assert.strictEqual(result.offset, 0);
});

test('findNearestBeat finds closest beat before target', () => {
  const beats = [1.0, 2.0, 4.0, 5.0];
  const result = musicAlignment.findNearestBeat(beats, 3.0);
  assert.strictEqual(result.beat, 2.0);
  assert.strictEqual(result.offset, 1.0);
});

test('findNearestBeat finds closest beat after target', () => {
  const beats = [1.0, 2.0, 4.0, 5.0];
  const result = musicAlignment.findNearestBeat(beats, 3.9);
  assert.strictEqual(result.beat, 4.0);
  assert.ok(result.offset < 0.5);
});

test('findNearestBeat respects search window', () => {
  const beats = [1.0, 2.0, 10.0]; // 10.0 is outside 3s window from target 5.0
  const result = musicAlignment.findNearestBeat(beats, 5.0, 3.0);
  assert.strictEqual(result.beat, 2.0);
});

test('findNearestBeat returns null for empty array', () => {
  const result = musicAlignment.findNearestBeat([], 5.0);
  assert.strictEqual(result, null);
});

test('findNearestBeat returns null for null array', () => {
  const result = musicAlignment.findNearestBeat(null, 5.0);
  assert.strictEqual(result, null);
});

// ============================================
// findBestCutBeat Tests
// ============================================

console.log('\n--- findBestCutBeat Tests ---\n');

test('findBestCutBeat prefers beat before target', () => {
  const beats = [1.0, 2.0, 3.0, 4.0, 5.0];
  const result = musicAlignment.findBestCutBeat(beats, 3.5);
  assert.strictEqual(result.beat, 3.0);
  assert.strictEqual(result.direction, 'before');
});

test('findBestCutBeat finds exact beat', () => {
  const beats = [1.0, 2.0, 3.0, 4.0, 5.0];
  const result = musicAlignment.findBestCutBeat(beats, 3.0);
  assert.strictEqual(result.beat, 3.0);
  assert.strictEqual(result.direction, 'before');
});

test('findBestCutBeat uses beat after if no good before option', () => {
  const beats = [1.0, 10.0, 11.0, 12.0];
  const result = musicAlignment.findBestCutBeat(beats, 9.5, 3.0);
  assert.strictEqual(result.beat, 10.0);
  assert.strictEqual(result.direction, 'after');
});

test('findBestCutBeat returns target time if no beats in window', () => {
  const beats = [1.0, 2.0, 100.0];
  const result = musicAlignment.findBestCutBeat(beats, 50.0, 3.0);
  assert.strictEqual(result.beat, 50.0);
  assert.strictEqual(result.direction, 'exact');
});

test('findBestCutBeat handles empty array gracefully', () => {
  const result = musicAlignment.findBestCutBeat([], 10.0);
  assert.strictEqual(result.beat, 10.0);
  assert.strictEqual(result.direction, 'exact');
});

// ============================================
// validateAlignmentOptions Tests
// ============================================

console.log('\n--- validateAlignmentOptions Tests ---\n');

test('validateAlignmentOptions accepts valid options', () => {
  const result = musicAlignment.validateAlignmentOptions({
    targetDuration: 30,
    fadeDuration: 2.0,
    searchWindow: 3.0
  });
  assert.strictEqual(result.valid, true);
  assert.deepStrictEqual(result.errors, []);
});

test('validateAlignmentOptions accepts empty options', () => {
  const result = musicAlignment.validateAlignmentOptions({});
  assert.strictEqual(result.valid, true);
  assert.deepStrictEqual(result.errors, []);
});

test('validateAlignmentOptions rejects non-number targetDuration', () => {
  const result = musicAlignment.validateAlignmentOptions({
    targetDuration: 'thirty'
  });
  assert.strictEqual(result.valid, false);
  assert.ok(result.errors.some(e => e.includes('targetDuration')));
});

test('validateAlignmentOptions rejects too short targetDuration', () => {
  const result = musicAlignment.validateAlignmentOptions({
    targetDuration: 3
  });
  assert.strictEqual(result.valid, false);
  assert.ok(result.errors.some(e => e.includes('5 seconds')));
});

test('validateAlignmentOptions rejects invalid fadeDuration type', () => {
  const result = musicAlignment.validateAlignmentOptions({
    fadeDuration: 'two'
  });
  assert.strictEqual(result.valid, false);
  assert.ok(result.errors.some(e => e.includes('fadeDuration')));
});

test('validateAlignmentOptions rejects fadeDuration below min', () => {
  const result = musicAlignment.validateAlignmentOptions({
    fadeDuration: 0.1
  });
  assert.strictEqual(result.valid, false);
  assert.ok(result.errors.some(e => e.includes('fadeDuration')));
});

test('validateAlignmentOptions rejects fadeDuration above max', () => {
  const result = musicAlignment.validateAlignmentOptions({
    fadeDuration: 10.0
  });
  assert.strictEqual(result.valid, false);
  assert.ok(result.errors.some(e => e.includes('fadeDuration')));
});

test('validateAlignmentOptions rejects invalid searchWindow type', () => {
  const result = musicAlignment.validateAlignmentOptions({
    searchWindow: 'three'
  });
  assert.strictEqual(result.valid, false);
  assert.ok(result.errors.some(e => e.includes('searchWindow')));
});

test('validateAlignmentOptions rejects searchWindow below 0.5', () => {
  const result = musicAlignment.validateAlignmentOptions({
    searchWindow: 0.1
  });
  assert.strictEqual(result.valid, false);
  assert.ok(result.errors.some(e => e.includes('searchWindow')));
});

test('validateAlignmentOptions rejects searchWindow above 10', () => {
  const result = musicAlignment.validateAlignmentOptions({
    searchWindow: 15.0
  });
  assert.strictEqual(result.valid, false);
  assert.ok(result.errors.some(e => e.includes('searchWindow')));
});

test('validateAlignmentOptions collects multiple errors', () => {
  const result = musicAlignment.validateAlignmentOptions({
    targetDuration: 1,
    fadeDuration: 20,
    searchWindow: 100
  });
  assert.strictEqual(result.valid, false);
  assert.strictEqual(result.errors.length, 3);
});

// ============================================
// Server Endpoint Tests
// ============================================

console.log('\n--- Server Endpoint Static Tests ---\n');

const fs = require('fs');
const path = require('path');

const serverPath = path.join(__dirname, '..', 'server.js');
const serverContent = fs.readFileSync(serverPath, 'utf8');

test('server.js imports musicAlignment service', () => {
  assert.ok(serverContent.includes("musicAlignment = require('./services/musicAlignment')"));
});

test('server.js has POST /music/align endpoint', () => {
  assert.ok(serverContent.includes("app.post('/music/align'"));
});

test('server.js has POST /music/analyze-beats endpoint', () => {
  assert.ok(serverContent.includes("app.post('/music/analyze-beats'"));
});

test('server.js has GET /music/alignment-options endpoint', () => {
  assert.ok(serverContent.includes("app.get('/music/alignment-options'"));
});

test('/music/align endpoint requires authentication', () => {
  assert.ok(serverContent.includes("app.post('/music/align', requireCredits"));
});

test('/music/analyze-beats endpoint requires authentication', () => {
  assert.ok(serverContent.includes("app.post('/music/analyze-beats', requireCredits"));
});

test('/music/align endpoint validates jobId', () => {
  const alignSection = serverContent.substring(
    serverContent.indexOf("app.post('/music/align'"),
    serverContent.indexOf("app.post('/music/align'") + 2000
  );
  assert.ok(alignSection.includes("jobId is required"));
});

test('/music/align endpoint validates targetDuration', () => {
  const alignSection = serverContent.substring(
    serverContent.indexOf("app.post('/music/align'"),
    serverContent.indexOf("app.post('/music/align'") + 2000
  );
  assert.ok(alignSection.includes("targetDuration"));
});

test('/music/align endpoint verifies job ownership', () => {
  const alignSection = serverContent.substring(
    serverContent.indexOf("app.post('/music/align'"),
    serverContent.indexOf("app.post('/music/align'") + 2000
  );
  assert.ok(alignSection.includes("Access denied"));
});

test('/music/align endpoint checks job completion status', () => {
  const alignSection = serverContent.substring(
    serverContent.indexOf("app.post('/music/align'"),
    serverContent.indexOf("app.post('/music/align'") + 2000
  );
  assert.ok(alignSection.includes("must be completed"));
});

// ============================================
// Plugin UI Tests
// ============================================

console.log('\n--- Plugin UI Static Tests ---\n');

const musicJsPath = path.join(__dirname, '..', '..', 'splice-plugin', 'js', 'music.js');
const musicJsContent = fs.readFileSync(musicJsPath, 'utf8');

test('music.js has alignment state', () => {
  assert.ok(musicJsContent.includes('isAligning: false'));
  assert.ok(musicJsContent.includes('alignmentOptions: null'));
  assert.ok(musicJsContent.includes('beatAnalysis: null'));
});

test('music.js has alignMusicRequest function', () => {
  assert.ok(musicJsContent.includes('async function alignMusicRequest'));
});

test('music.js has analyzeBeatsRequest function', () => {
  assert.ok(musicJsContent.includes('async function analyzeBeatsRequest'));
});

test('music.js has getAlignmentOptions function', () => {
  assert.ok(musicJsContent.includes('async function getAlignmentOptions'));
});

test('music.js has getSequenceDuration function', () => {
  assert.ok(musicJsContent.includes('async function getSequenceDuration'));
});

test('music.js has showAlignmentModal function', () => {
  assert.ok(musicJsContent.includes('async function showAlignmentModal'));
});

test('music.js has renderAlignmentModal function', () => {
  assert.ok(musicJsContent.includes('function renderAlignmentModal'));
});

test('music.js has hideAlignmentModal function', () => {
  assert.ok(musicJsContent.includes('function hideAlignmentModal'));
});

test('music.js has handleAlignmentConfirm function', () => {
  assert.ok(musicJsContent.includes('async function handleAlignmentConfirm'));
});

test('music.js has showAlignedDownload function', () => {
  assert.ok(musicJsContent.includes('function showAlignedDownload'));
});

test('music.js has importAlignedMusic function', () => {
  assert.ok(musicJsContent.includes('async function importAlignedMusic'));
});

test('music.js has formatDuration function', () => {
  assert.ok(musicJsContent.includes('function formatDuration'));
});

test('music.js library includes align button', () => {
  assert.ok(musicJsContent.includes("data-action=\"align\""));
});

test('music.js handleLibraryAction handles align action', () => {
  const handlerSection = musicJsContent.substring(
    musicJsContent.indexOf('async function handleLibraryAction'),
    musicJsContent.indexOf('async function handleLibraryAction') + 500
  );
  assert.ok(handlerSection.includes("case 'align':"));
  assert.ok(handlerSection.includes('showAlignmentModal'));
});

test('music.js exports alignment functions', () => {
  assert.ok(musicJsContent.includes('alignMusicRequest,'));
  assert.ok(musicJsContent.includes('analyzeBeatsRequest,'));
  assert.ok(musicJsContent.includes('getAlignmentOptions,'));
  assert.ok(musicJsContent.includes('showAlignmentModal,'));
  assert.ok(musicJsContent.includes('hideAlignmentModal,'));
  assert.ok(musicJsContent.includes('formatDuration,'));
  assert.ok(musicJsContent.includes('getSequenceDuration,'));
});

test('music.js calls correct API endpoint for alignment', () => {
  assert.ok(musicJsContent.includes("`${getBackendUrl()}/music/align`"));
});

test('music.js calls correct API endpoint for beat analysis', () => {
  assert.ok(musicJsContent.includes("`${getBackendUrl()}/music/analyze-beats`"));
});

test('music.js calls correct API endpoint for alignment options', () => {
  assert.ok(musicJsContent.includes("`${getBackendUrl()}/music/alignment-options`"));
});

// ============================================
// r2Storage Integration Tests
// ============================================

console.log('\n--- r2Storage Integration Tests ---\n');

const r2StoragePath = path.join(__dirname, '..', 'services', 'r2Storage.js');
const r2StorageContent = fs.readFileSync(r2StoragePath, 'utf8');

test('r2Storage exports uploadBuffer function', () => {
  assert.ok(r2StorageContent.includes('async function uploadBuffer'));
  assert.ok(r2StorageContent.includes('uploadBuffer,'));
});

test('r2Storage exports downloadFile function', () => {
  assert.ok(r2StorageContent.includes('async function downloadFile'));
  assert.ok(r2StorageContent.includes('downloadFile,'));
});

test('r2Storage downloadFile converts stream to buffer', () => {
  const downloadSection = r2StorageContent.substring(
    r2StorageContent.indexOf('async function downloadFile'),
    r2StorageContent.indexOf('async function downloadFile') + 500
  );
  assert.ok(downloadSection.includes('Buffer.concat'));
});

// ============================================
// Alignment Modal UI Tests
// ============================================

console.log('\n--- Alignment Modal UI Tests ---\n');

test('alignment modal has duration input', () => {
  assert.ok(musicJsContent.includes('alignTargetDuration'));
});

test('alignment modal has fade duration input', () => {
  assert.ok(musicJsContent.includes('alignFadeDuration'));
});

test('alignment modal has beat align checkbox', () => {
  assert.ok(musicJsContent.includes('alignBeatAlign'));
});

test('alignment modal has match sequence button', () => {
  assert.ok(musicJsContent.includes('alignMatchSequenceBtn'));
});

test('alignment modal displays BPM', () => {
  assert.ok(musicJsContent.includes('beatAnalysis.bpm'));
});

test('alignment modal displays beat count', () => {
  assert.ok(musicJsContent.includes('beatAnalysis.beatCount'));
});

test('alignment modal displays original duration', () => {
  assert.ok(musicJsContent.includes('beatAnalysis.duration'));
});

test('alignment modal shows sequence duration if available', () => {
  assert.ok(musicJsContent.includes('sequenceDuration'));
  assert.ok(musicJsContent.includes('Sequence Duration'));
});

// ============================================
// Integration Flow Tests
// ============================================

console.log('\n--- Integration Flow Tests ---\n');

test('alignment flow downloads audio from R2', () => {
  assert.ok(serverContent.includes('downloadFile(masterKey)'));
});

test('alignment flow calls trimToLength', () => {
  assert.ok(serverContent.includes('musicAlignment.trimToLength'));
});

test('alignment flow uploads aligned audio to R2', () => {
  assert.ok(serverContent.includes('uploadBuffer(alignedKey'));
});

test('alignment flow generates signed download URL', () => {
  assert.ok(serverContent.includes('getSignedDownloadUrl(alignedKey'));
});

test('alignment result includes wasAligned flag', () => {
  assert.ok(serverContent.includes('wasAligned:'));
});

test('alignment result includes beatCount', () => {
  assert.ok(serverContent.includes('beatCount:'));
});

test('alignment result includes actualDuration', () => {
  assert.ok(serverContent.includes('actualDuration:'));
});

// ============================================
// Error Handling Tests
// ============================================

console.log('\n--- Error Handling Tests ---\n');

test('server handles missing music alignment service', () => {
  assert.ok(serverContent.includes("!musicAlignment"));
  assert.ok(serverContent.includes("Music alignment service not available"));
});

test('server handles job not found', () => {
  const alignSection = serverContent.substring(
    serverContent.indexOf("app.post('/music/align'"),
    serverContent.indexOf("app.post('/music/align'") + 2000
  );
  assert.ok(alignSection.includes("Job not found"));
});

test('server handles access denied for non-owner', () => {
  const alignSection = serverContent.substring(
    serverContent.indexOf("app.post('/music/align'"),
    serverContent.indexOf("app.post('/music/align'") + 2000
  );
  assert.ok(alignSection.includes("Access denied"));
});

test('server handles incomplete job status', () => {
  const alignSection = serverContent.substring(
    serverContent.indexOf("app.post('/music/align'"),
    serverContent.indexOf("app.post('/music/align'") + 2000
  );
  assert.ok(alignSection.includes("must be completed"));
});

test('plugin handles alignment errors gracefully', () => {
  assert.ok(musicJsContent.includes('Alignment failed:'));
});

test('plugin handles missing temp folder', () => {
  assert.ok(musicJsContent.includes('Could not access temp folder'));
});

// ============================================
// Summary
// ============================================

console.log('\n========================================');
console.log(`Total: ${passed + failed} tests`);
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log('========================================\n');

if (failed > 0) {
  process.exit(1);
}
