import { NextRequest, NextResponse } from "next/server";
import { cookies } from "next/headers";

// Backend API URL for authentication
const BACKEND_API_URL =
  process.env.BACKEND_API_URL || "https://splice-api-production.up.railway.app";

export async function GET(_request: NextRequest) {
  try {
    const cookieStore = await cookies();
    const token = cookieStore.get("splice_token")?.value;

    // No token means not authenticated
    if (!token) {
      return NextResponse.json(
        { error: "Not authenticated" },
        { status: 401 }
      );
    }

    // Fetch credits data from backend
    const response = await fetch(`${BACKEND_API_URL}/credits`, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });

    if (!response.ok) {
      // WS-CRIT-004 FIX: Return proper error instead of fallback data
      // Returning fallback data could mask auth issues or give false account state
      if (response.status === 401) {
        return NextResponse.json(
          { error: "Session expired", message: "Please log in again" },
          { status: 401 }
        );
      }
      if (response.status === 403) {
        return NextResponse.json(
          { error: "Access denied", message: "Your account may be suspended" },
          { status: 403 }
        );
      }
      // Service unavailable
      console.error("[API Usage] Backend error:", response.status);
      return NextResponse.json(
        { error: "Service unavailable", message: "Unable to fetch usage data. Please try again." },
        { status: 503 }
      );
    }

    const data = await response.json();

    // Return usage stats from backend data
    return NextResponse.json({
      hoursRemaining: data.hoursRemaining || 0,
      hoursUsed: data.hoursUsed || 0,
      totalHours: data.totalHours || data.hoursRemaining || 0,
      musicCredits: data.musicCredits || 0,
      musicCreditsUsed: data.musicCreditsUsed || 0,
      variationsCredits: data.variationsCredits || 0,
      sceneAwareCredits: data.sceneAwareCredits || 0,
      projectsThisMonth: data.projectsThisMonth || 0,
    });
  } catch (error) {
    console.error("[API Usage] Error:", error);
    return NextResponse.json(
      { error: "Failed to fetch usage data" },
      { status: 500 }
    );
  }
}
