/**
 * Phase 3 E2E Tests: Plugin Integration (Music Tab UI)
 * Tests music.js plugin module and API endpoints in server.js
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

// Test counters
let passed = 0;
let failed = 0;
const failures = [];

function test(name, fn) {
  try {
    fn();
    passed++;
    console.log(`  ✓ ${name}`);
  } catch (error) {
    failed++;
    failures.push({ name, error: error.message });
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
  }
}

// ============================================
// PLUGIN MUSIC MODULE TESTS
// ============================================
console.log('\n=== Plugin Music Module Tests ===\n');

const musicPluginPath = path.join(__dirname, '../../splice-plugin/js/music.js');
const musicPluginCode = fs.readFileSync(musicPluginPath, 'utf8');

test('music.js exists and is readable', () => {
  assert(fs.existsSync(musicPluginPath), 'music.js should exist');
  assert(musicPluginCode.length > 0, 'music.js should have content');
});

test('music.js exports musicModule', () => {
  assert(musicPluginCode.includes('window.musicModule'), 'Should export musicModule');
});

test('musicModule has init function', () => {
  assert(musicPluginCode.includes('init: initMusicModule'), 'Should have init function');
});

test('musicModule has identifySong function', () => {
  assert(musicPluginCode.includes('identifySong'), 'Should have identifySong function');
});

test('musicModule has generateMusicRequest function', () => {
  assert(musicPluginCode.includes('generateMusicRequest'), 'Should have generateMusicRequest function');
});

test('musicModule has getMusicLibrary function', () => {
  assert(musicPluginCode.includes('getMusicLibrary'), 'Should have getMusicLibrary function');
});

test('musicModule has getMusicCredits function', () => {
  assert(musicPluginCode.includes('getMusicCredits'), 'Should have getMusicCredits function');
});

// ============================================
// MOOD OPTIONS TESTS
// ============================================
console.log('\n=== Mood Options Tests ===\n');

test('has MOOD_OPTIONS constant', () => {
  assert(musicPluginCode.includes('MOOD_OPTIONS'), 'Should have MOOD_OPTIONS');
});

test('MOOD_OPTIONS includes energetic', () => {
  assert(musicPluginCode.includes("id: 'energetic'"), 'Should have energetic mood');
});

test('MOOD_OPTIONS includes relaxed', () => {
  assert(musicPluginCode.includes("id: 'relaxed'"), 'Should have relaxed mood');
});

test('MOOD_OPTIONS includes happy', () => {
  assert(musicPluginCode.includes("id: 'happy'"), 'Should have happy mood');
});

test('MOOD_OPTIONS includes melancholic', () => {
  assert(musicPluginCode.includes("id: 'melancholic'"), 'Should have melancholic mood');
});

test('MOOD_OPTIONS includes neutral', () => {
  assert(musicPluginCode.includes("id: 'neutral'"), 'Should have neutral mood');
});

// ============================================
// INSTRUMENT OPTIONS TESTS
// ============================================
console.log('\n=== Instrument Options Tests ===\n');

test('has INSTRUMENT_OPTIONS constant', () => {
  assert(musicPluginCode.includes('INSTRUMENT_OPTIONS'), 'Should have INSTRUMENT_OPTIONS');
});

test('INSTRUMENT_OPTIONS includes acoustic', () => {
  assert(musicPluginCode.includes("id: 'acoustic'"), 'Should have acoustic');
});

test('INSTRUMENT_OPTIONS includes electronic', () => {
  assert(musicPluginCode.includes("id: 'electronic'"), 'Should have electronic');
});

test('INSTRUMENT_OPTIONS includes orchestral', () => {
  assert(musicPluginCode.includes("id: 'orchestral'"), 'Should have orchestral');
});

// ============================================
// DURATION OPTIONS TESTS
// ============================================
console.log('\n=== Duration Options Tests ===\n');

test('has DURATION_OPTIONS constant', () => {
  assert(musicPluginCode.includes('DURATION_OPTIONS'), 'Should have DURATION_OPTIONS');
});

test('DURATION_OPTIONS includes 30 seconds', () => {
  assert(musicPluginCode.includes('value: 30'), 'Should have 30 seconds');
});

test('DURATION_OPTIONS includes 60 seconds', () => {
  assert(musicPluginCode.includes('value: 60'), 'Should have 60 seconds');
});

test('DURATION_OPTIONS includes 180 seconds', () => {
  assert(musicPluginCode.includes('value: 180'), 'Should have 180 seconds');
});

// ============================================
// API FUNCTION TESTS
// ============================================
console.log('\n=== API Function Tests ===\n');

test('identifySong calls /music/identify endpoint', () => {
  assert(musicPluginCode.includes('/music/identify'), 'Should call identify endpoint');
});

test('generateMusicRequest calls /music/generate endpoint', () => {
  assert(musicPluginCode.includes('/music/generate'), 'Should call generate endpoint');
});

test('getJobStatus calls /music/status endpoint', () => {
  assert(musicPluginCode.includes('/music/status'), 'Should call status endpoint');
});

test('getMusicLibrary calls /music/library endpoint', () => {
  assert(musicPluginCode.includes('/music/library'), 'Should call library endpoint');
});

test('getMusicFile calls /music/:jobId endpoint', () => {
  assert(musicPluginCode.includes('`${getBackendUrl()}/music/${jobId}`'), 'Should call music file endpoint');
});

test('deleteMusicFile uses DELETE method', () => {
  assert(musicPluginCode.includes("method: 'DELETE'"), 'Should use DELETE method');
});

test('getMusicCredits calls /music/credits endpoint', () => {
  assert(musicPluginCode.includes('/music/credits'), 'Should call credits endpoint');
});

// ============================================
// UI FUNCTION TESTS
// ============================================
console.log('\n=== UI Function Tests ===\n');

test('has initMusicModule function', () => {
  assert(musicPluginCode.includes('function initMusicModule'), 'Should have initMusicModule');
});

test('has setupMusicEventListeners function', () => {
  assert(musicPluginCode.includes('function setupMusicEventListeners'), 'Should have setupMusicEventListeners');
});

test('has populateMoodDropdown function', () => {
  assert(musicPluginCode.includes('function populateMoodDropdown'), 'Should have populateMoodDropdown');
});

test('has populateInstrumentDropdown function', () => {
  assert(musicPluginCode.includes('function populateInstrumentDropdown'), 'Should have populateInstrumentDropdown');
});

test('has populateDurationDropdown function', () => {
  assert(musicPluginCode.includes('function populateDurationDropdown'), 'Should have populateDurationDropdown');
});

test('has handleYoutubeUrlChange function', () => {
  assert(musicPluginCode.includes('function handleYoutubeUrlChange'), 'Should have handleYoutubeUrlChange');
});

test('has handleIdentifySong function', () => {
  assert(musicPluginCode.includes('async function handleIdentifySong'), 'Should have handleIdentifySong');
});

test('has handleGenerateMusic function', () => {
  assert(musicPluginCode.includes('async function handleGenerateMusic'), 'Should have handleGenerateMusic');
});

test('has displayIdentifiedSong function', () => {
  assert(musicPluginCode.includes('function displayIdentifiedSong'), 'Should have displayIdentifiedSong');
});

test('has handleClearReference function', () => {
  assert(musicPluginCode.includes('function handleClearReference'), 'Should have handleClearReference');
});

// ============================================
// JOB MANAGEMENT TESTS
// ============================================
console.log('\n=== Job Management Tests ===\n');

test('has addJobToList function', () => {
  assert(musicPluginCode.includes('function addJobToList'), 'Should have addJobToList');
});

test('has startPollingJob function', () => {
  assert(musicPluginCode.includes('function startPollingJob'), 'Should have startPollingJob');
});

test('has renderJobsList function', () => {
  assert(musicPluginCode.includes('function renderJobsList'), 'Should have renderJobsList');
});

test('polls at 5 second intervals', () => {
  assert(musicPluginCode.includes('MUSIC_POLL_INTERVAL = 5000'), 'Should poll every 5 seconds');
});

test('handles completed status', () => {
  assert(musicPluginCode.includes("status === 'completed'"), 'Should handle completed');
});

test('handles failed status', () => {
  assert(musicPluginCode.includes("status === 'failed'"), 'Should handle failed');
});

// ============================================
// LIBRARY TESTS
// ============================================
console.log('\n=== Library Tests ===\n');

test('has loadMusicLibrary function', () => {
  assert(musicPluginCode.includes('async function loadMusicLibrary'), 'Should have loadMusicLibrary');
});

test('has handleLibraryAction function', () => {
  assert(musicPluginCode.includes('async function handleLibraryAction'), 'Should have handleLibraryAction');
});

test('has previewMusic function', () => {
  assert(musicPluginCode.includes('async function previewMusic'), 'Should have previewMusic');
});

test('has importMusicToTimeline function', () => {
  assert(musicPluginCode.includes('async function importMusicToTimeline'), 'Should have importMusicToTimeline');
});

test('has confirmDeleteMusic function', () => {
  assert(musicPluginCode.includes('async function confirmDeleteMusic'), 'Should have confirmDeleteMusic');
});

// ============================================
// AUDIO PLAYER TESTS
// ============================================
console.log('\n=== Audio Player Tests ===\n');

test('creates Audio player for preview', () => {
  assert(musicPluginCode.includes('new Audio()'), 'Should create Audio player');
});

test('stores audioPlayer in state', () => {
  assert(musicPluginCode.includes('musicState.audioPlayer'), 'Should store player in state');
});

test('handles audio ended event', () => {
  assert(musicPluginCode.includes("'ended'"), 'Should handle ended event');
});

// ============================================
// VALIDATION TESTS
// ============================================
console.log('\n=== Validation Tests ===\n');

test('has isValidYouTubeUrl function', () => {
  assert(musicPluginCode.includes('function isValidYouTubeUrl'), 'Should have isValidYouTubeUrl');
});

test('validates youtube.com/watch URL', () => {
  assert(musicPluginCode.includes('youtube\\.com\\/watch'), 'Should validate youtube.com/watch');
});

test('validates youtu.be URL', () => {
  assert(musicPluginCode.includes('youtu\\.be'), 'Should validate youtu.be');
});

test('validates youtube.com/embed URL', () => {
  assert(musicPluginCode.includes('youtube\\.com\\/embed'), 'Should validate youtube.com/embed');
});

// ============================================
// STATUS DISPLAY TESTS
// ============================================
console.log('\n=== Status Display Tests ===\n');

test('has setMusicStatus function', () => {
  assert(musicPluginCode.includes('function setMusicStatus'), 'Should have setMusicStatus');
});

test('setMusicStatus supports info type', () => {
  assert(musicPluginCode.includes("'info'"), 'Should support info type');
});

test('setMusicStatus supports success type', () => {
  assert(musicPluginCode.includes("'success'"), 'Should support success type');
});

test('setMusicStatus supports warning type', () => {
  assert(musicPluginCode.includes("'warning'"), 'Should support warning type');
});

test('setMusicStatus supports error type', () => {
  assert(musicPluginCode.includes("'error'"), 'Should support error type');
});

test('auto-hides non-error messages', () => {
  assert(musicPluginCode.includes('5000'), 'Should auto-hide after 5 seconds');
});

// ============================================
// HELPER FUNCTION TESTS
// ============================================
console.log('\n=== Helper Function Tests ===\n');

test('has escapeHtml function', () => {
  assert(musicPluginCode.includes('function escapeHtml'), 'Should have escapeHtml');
});

test('has debounce function', () => {
  assert(musicPluginCode.includes('function debounce'), 'Should have debounce');
});

test('uses debounce for URL input', () => {
  assert(musicPluginCode.includes('debounce(handleYoutubeUrlChange'), 'Should debounce URL changes');
});

test('has getTempFolder function', () => {
  assert(musicPluginCode.includes('async function getTempFolder'), 'Should have getTempFolder');
});

test('has updateMusicCreditsDisplay function', () => {
  assert(musicPluginCode.includes('async function updateMusicCreditsDisplay'), 'Should have updateMusicCreditsDisplay');
});

// ============================================
// STATE MANAGEMENT TESTS
// ============================================
console.log('\n=== State Management Tests ===\n');

test('has musicState object', () => {
  assert(musicPluginCode.includes('const musicState'), 'Should have musicState');
});

test('musicState tracks jobs', () => {
  assert(musicPluginCode.includes('jobs: []'), 'Should track jobs');
});

test('musicState tracks selectedJob', () => {
  assert(musicPluginCode.includes('selectedJob:'), 'Should track selectedJob');
});

test('musicState tracks isIdentifying', () => {
  assert(musicPluginCode.includes('isIdentifying:'), 'Should track isIdentifying');
});

test('musicState tracks isGenerating', () => {
  assert(musicPluginCode.includes('isGenerating:'), 'Should track isGenerating');
});

test('musicState tracks identifiedSong', () => {
  assert(musicPluginCode.includes('identifiedSong:'), 'Should track identifiedSong');
});

test('musicState tracks pollInterval', () => {
  assert(musicPluginCode.includes('pollInterval:'), 'Should track pollInterval');
});

// ============================================
// SERVER ENDPOINTS TESTS
// ============================================
console.log('\n=== Server Music Endpoints Tests ===\n');

const serverPath = path.join(__dirname, '../server.js');
const serverCode = fs.readFileSync(serverPath, 'utf8');

test('server has POST /music/identify endpoint', () => {
  assert(serverCode.includes("app.post('/music/identify'"), 'Should have identify endpoint');
});

test('server has POST /music/generate endpoint', () => {
  assert(serverCode.includes("app.post('/music/generate'"), 'Should have generate endpoint');
});

test('server has GET /music/status/:jobId endpoint', () => {
  assert(serverCode.includes("app.get('/music/status/:jobId'"), 'Should have status endpoint');
});

test('server has GET /music/library endpoint', () => {
  assert(serverCode.includes("app.get('/music/library'"), 'Should have library endpoint');
});

test('server has GET /music/:jobId endpoint', () => {
  assert(serverCode.includes("app.get('/music/:jobId'"), 'Should have get music endpoint');
});

test('server has DELETE /music/:jobId endpoint', () => {
  assert(serverCode.includes("app.delete('/music/:jobId'"), 'Should have delete endpoint');
});

test('server has GET /music/credits endpoint', () => {
  assert(serverCode.includes("app.get('/music/credits'"), 'Should have credits endpoint');
});

test('server has GET /music/moods endpoint', () => {
  assert(serverCode.includes("app.get('/music/moods'"), 'Should have moods endpoint');
});

test('server has GET /music/instruments endpoint', () => {
  assert(serverCode.includes("app.get('/music/instruments'"), 'Should have instruments endpoint');
});

test('server has GET /music/queue-stats endpoint', () => {
  assert(serverCode.includes("app.get('/music/queue-stats'"), 'Should have queue-stats endpoint');
});

// ============================================
// SERVER AUTH TESTS
// ============================================
console.log('\n=== Server Auth Tests ===\n');

test('music/identify requires auth', () => {
  assert(serverCode.includes("/music/identify', requireCredits"), 'identify should require auth');
});

test('music/generate requires auth', () => {
  assert(serverCode.includes("/music/generate', requireCredits"), 'generate should require auth');
});

test('music/status requires auth', () => {
  assert(serverCode.includes("/music/status/:jobId', requireCredits"), 'status should require auth');
});

test('music/library requires auth', () => {
  assert(serverCode.includes("/music/library', requireCredits"), 'library should require auth');
});

test('server verifies job ownership', () => {
  assert(serverCode.includes("status.data.customerId !== customerId"), 'Should verify ownership');
});

test('server returns 403 for unauthorized access', () => {
  assert(serverCode.includes("403).json({ error: 'Access denied'"), 'Should return 403 for unauthorized');
});

// ============================================
// SERVER ERROR HANDLING TESTS
// ============================================
console.log('\n=== Server Error Handling Tests ===\n');

test('server handles missing youtubeUrl', () => {
  assert(serverCode.includes("'youtubeUrl is required'"), 'Should handle missing URL');
});

test('server handles service not available', () => {
  assert(serverCode.includes('service not available'), 'Should handle service unavailable');
});

test('server handles job not found', () => {
  assert(serverCode.includes("'Job not found'"), 'Should handle job not found');
});

test('server handles music not found', () => {
  assert(serverCode.includes("'Music not found'"), 'Should handle music not found');
});

test('server handles authentication required', () => {
  assert(serverCode.includes("'Authentication required'"), 'Should handle auth required');
});

// ============================================
// INTEGRATION TESTS
// ============================================
console.log('\n=== Integration Tests ===\n');

test('plugin uses getBackendUrl for API calls', () => {
  assert(musicPluginCode.includes('getBackendUrl()'), 'Should use getBackendUrl');
});

test('plugin uses getAuthHeaders for auth', () => {
  assert(musicPluginCode.includes('getAuthHeaders()'), 'Should use getAuthHeaders');
});

test('plugin uses fetchWithTimeout', () => {
  assert(musicPluginCode.includes('fetchWithTimeout'), 'Should use fetchWithTimeout');
});

test('plugin uses parseErrorResponse', () => {
  assert(musicPluginCode.includes('parseErrorResponse'), 'Should use parseErrorResponse');
});

test('server imports music services', () => {
  assert(serverCode.includes("require('./services/musicQueue')"), 'Should import musicQueue');
  assert(serverCode.includes("require('./services/songIdentification')"), 'Should import songIdentification');
  assert(serverCode.includes("require('./services/musicGeneration')"), 'Should import musicGeneration');
  assert(serverCode.includes("require('./services/r2Storage')"), 'Should import r2Storage');
});

test('server uses lazy loading for music services', () => {
  assert(serverCode.includes('let musicQueue, songIdentification'), 'Should use lazy loading');
});

// ============================================
// SUMMARY
// ============================================
console.log('\n========================================');
console.log(`Phase 3 E2E Tests: ${passed} passed, ${failed} failed`);
console.log('========================================\n');

if (failures.length > 0) {
  console.log('Failures:');
  failures.forEach(f => {
    console.log(`  - ${f.name}: ${f.error}`);
  });
  console.log('');
}

// Exit with appropriate code
process.exit(failed > 0 ? 1 : 0);
