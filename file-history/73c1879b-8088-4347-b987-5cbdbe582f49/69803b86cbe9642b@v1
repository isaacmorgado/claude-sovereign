/**
 * Phase 4 E2E Tests: Billing Integration
 * Tests music credits in usageTracking.js and server.js integration
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

// Test counters
let passed = 0;
let failed = 0;
const failures = [];

function test(name, fn) {
  try {
    fn();
    passed++;
    console.log(`  ✓ ${name}`);
  } catch (error) {
    failed++;
    failures.push({ name, error: error.message });
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
  }
}

// ============================================
// USAGE TRACKING MUSIC CREDITS TESTS
// ============================================
console.log('\n=== Usage Tracking Music Credits Tests ===\n');

const usageTrackingPath = path.join(__dirname, '../services/usageTracking.js');
const usageTrackingCode = fs.readFileSync(usageTrackingPath, 'utf8');

test('usageTracking.js exports getMusicCredits', () => {
  assert(usageTrackingCode.includes('getMusicCredits'), 'Should export getMusicCredits');
  assert(usageTrackingCode.includes('async function getMusicCredits'), 'Should have getMusicCredits function');
});

test('usageTracking.js exports hasMusicCredits', () => {
  assert(usageTrackingCode.includes('hasMusicCredits'), 'Should export hasMusicCredits');
  assert(usageTrackingCode.includes('async function hasMusicCredits'), 'Should have hasMusicCredits function');
});

test('usageTracking.js exports deductMusicCredit', () => {
  assert(usageTrackingCode.includes('deductMusicCredit'), 'Should export deductMusicCredit');
  assert(usageTrackingCode.includes('async function deductMusicCredit'), 'Should have deductMusicCredit function');
});

test('usageTracking.js exports resetMusicCredits', () => {
  assert(usageTrackingCode.includes('resetMusicCredits'), 'Should export resetMusicCredits');
  assert(usageTrackingCode.includes('async function resetMusicCredits'), 'Should have resetMusicCredits function');
});

test('usageTracking.js exports addMusicCredits', () => {
  assert(usageTrackingCode.includes('addMusicCredits'), 'Should export addMusicCredits');
  assert(usageTrackingCode.includes('async function addMusicCredits'), 'Should have addMusicCredits function');
});

test('usageTracking.js exports getMusicUsageHistory', () => {
  assert(usageTrackingCode.includes('getMusicUsageHistory'), 'Should export getMusicUsageHistory');
  assert(usageTrackingCode.includes('async function getMusicUsageHistory'), 'Should have getMusicUsageHistory function');
});

test('usageTracking.js exports initMusicCreditsColumns', () => {
  assert(usageTrackingCode.includes('initMusicCreditsColumns'), 'Should export initMusicCreditsColumns');
  assert(usageTrackingCode.includes('async function initMusicCreditsColumns'), 'Should have initMusicCreditsColumns function');
});

// ============================================
// TIER CREDITS TESTS
// ============================================
console.log('\n=== Tier Credits Tests ===\n');

test('has TIER_MUSIC_CREDITS constant', () => {
  assert(usageTrackingCode.includes('TIER_MUSIC_CREDITS'), 'Should have TIER_MUSIC_CREDITS');
});

test('starter tier has 5 credits', () => {
  assert(usageTrackingCode.includes('starter: 5'), 'Starter should have 5 credits');
});

test('pro tier has 20 credits', () => {
  assert(usageTrackingCode.includes('pro: 20'), 'Pro should have 20 credits');
});

test('team tier has 100 credits', () => {
  assert(usageTrackingCode.includes('team: 100'), 'Team should have 100 credits');
});

test('cancelled tier has 0 credits', () => {
  // Check that cancelled is defined with 0
  assert(usageTrackingCode.includes('cancelled: 0'), 'Cancelled should have 0 credits');
});

// ============================================
// OVERAGE RATES TESTS
// ============================================
console.log('\n=== Overage Rates Tests ===\n');

test('has MUSIC_OVERAGE_RATES constant', () => {
  assert(usageTrackingCode.includes('MUSIC_OVERAGE_RATES'), 'Should have MUSIC_OVERAGE_RATES');
});

test('starter overage rate is $0.50', () => {
  assert(usageTrackingCode.includes('starter: 0.50'), 'Starter overage should be $0.50');
});

test('pro overage rate is $0.30', () => {
  assert(usageTrackingCode.includes('pro: 0.30'), 'Pro overage should be $0.30');
});

test('team overage rate is $0.20', () => {
  assert(usageTrackingCode.includes('team: 0.20'), 'Team overage should be $0.20');
});

// ============================================
// getMusicCredits FUNCTION TESTS
// ============================================
console.log('\n=== getMusicCredits Function Tests ===\n');

test('getMusicCredits queries database', () => {
  assert(usageTrackingCode.includes('pool.query'), 'Should query database');
});

test('getMusicCredits selects music_credits_remaining', () => {
  assert(usageTrackingCode.includes('music_credits_remaining'), 'Should select remaining credits');
});

test('getMusicCredits selects music_credits_total', () => {
  assert(usageTrackingCode.includes('music_credits_total'), 'Should select total credits');
});

test('getMusicCredits selects tier', () => {
  assert(usageTrackingCode.includes('tier'), 'Should select tier');
});

test('getMusicCredits returns remaining, total, tier', () => {
  assert(usageTrackingCode.includes('remaining:'), 'Should return remaining');
  assert(usageTrackingCode.includes('total:'), 'Should return total');
});

test('getMusicCredits handles no user found', () => {
  assert(usageTrackingCode.includes('result.rows.length === 0'), 'Should handle no user');
});

// ============================================
// deductMusicCredit FUNCTION TESTS
// ============================================
console.log('\n=== deductMusicCredit Function Tests ===\n');

test('deductMusicCredit uses transaction', () => {
  assert(usageTrackingCode.includes("'BEGIN'"), 'Should use BEGIN');
  assert(usageTrackingCode.includes("'COMMIT'"), 'Should use COMMIT');
  assert(usageTrackingCode.includes("'ROLLBACK'"), 'Should use ROLLBACK');
});

test('deductMusicCredit locks row for update', () => {
  assert(usageTrackingCode.includes('FOR UPDATE'), 'Should lock row');
});

test('deductMusicCredit checks remaining credits', () => {
  assert(usageTrackingCode.includes('music_credits_remaining > 0'), 'Should check credits');
});

test('deductMusicCredit handles overage', () => {
  assert(usageTrackingCode.includes('MUSIC_OVERAGE_RATES'), 'Should use overage rates');
  assert(usageTrackingCode.includes('charged'), 'Should track charged amount');
});

test('deductMusicCredit logs usage', () => {
  assert(usageTrackingCode.includes('music_usage_log'), 'Should log to music_usage_log');
});

test('deductMusicCredit returns success, remaining, charged', () => {
  assert(usageTrackingCode.includes('success: true'), 'Should return success');
  assert(usageTrackingCode.includes('remaining:'), 'Should return remaining');
  assert(usageTrackingCode.includes('charged'), 'Should return charged');
});

test('deductMusicCredit handles errors', () => {
  assert(usageTrackingCode.includes("success: false"), 'Should return false on error');
  assert(usageTrackingCode.includes("error:"), 'Should return error message');
});

// ============================================
// resetMusicCredits FUNCTION TESTS
// ============================================
console.log('\n=== resetMusicCredits Function Tests ===\n');

test('resetMusicCredits updates credits based on tier', () => {
  assert(usageTrackingCode.includes('TIER_MUSIC_CREDITS[tier]'), 'Should use tier credits');
});

test('resetMusicCredits updates music_credits_remaining', () => {
  assert(usageTrackingCode.includes('music_credits_remaining ='), 'Should update remaining');
});

test('resetMusicCredits updates music_credits_total', () => {
  assert(usageTrackingCode.includes('music_credits_total ='), 'Should update total');
});

test('resetMusicCredits updates reset timestamp', () => {
  assert(usageTrackingCode.includes('music_credits_reset_at = CURRENT_TIMESTAMP'), 'Should update reset timestamp');
});

// ============================================
// addMusicCredits FUNCTION TESTS
// ============================================
console.log('\n=== addMusicCredits Function Tests ===\n');

test('addMusicCredits adds to existing balance', () => {
  assert(usageTrackingCode.includes('music_credits_remaining + $2'), 'Should add to balance');
});

test('addMusicCredits returns new balance', () => {
  assert(usageTrackingCode.includes('RETURNING music_credits_remaining'), 'Should return new balance');
});

test('addMusicCredits returns success and newBalance', () => {
  assert(usageTrackingCode.includes('newBalance:'), 'Should return newBalance');
});

// ============================================
// initMusicCreditsColumns FUNCTION TESTS
// ============================================
console.log('\n=== initMusicCreditsColumns Function Tests ===\n');

test('initMusicCreditsColumns adds columns if not exist', () => {
  assert(usageTrackingCode.includes('IF NOT EXISTS'), 'Should check if columns exist');
  assert(usageTrackingCode.includes('ADD COLUMN music_credits_remaining'), 'Should add remaining column');
  assert(usageTrackingCode.includes('ADD COLUMN music_credits_total'), 'Should add total column');
  assert(usageTrackingCode.includes('ADD COLUMN music_credits_reset_at'), 'Should add reset_at column');
});

test('initMusicCreditsColumns creates music_usage_log table', () => {
  assert(usageTrackingCode.includes('CREATE TABLE IF NOT EXISTS music_usage_log'), 'Should create music_usage_log');
});

test('initMusicCreditsColumns creates index on customer', () => {
  assert(usageTrackingCode.includes('idx_music_usage_customer'), 'Should create customer index');
});

// ============================================
// SERVER INTEGRATION TESTS
// ============================================
console.log('\n=== Server Integration Tests ===\n');

const serverPath = path.join(__dirname, '../server.js');
const serverCode = fs.readFileSync(serverPath, 'utf8');

test('server /music/credits uses usageTracking.getMusicCredits', () => {
  assert(serverCode.includes('usageTracking.getMusicCredits'), 'Should use getMusicCredits');
});

test('server requires auth for /music/credits', () => {
  assert(serverCode.includes("/music/credits', requireCredits"), 'Should require auth');
});

test('server handles authentication required', () => {
  assert(serverCode.includes("'Authentication required'"), 'Should handle no auth');
});

test('server returns credits from database', () => {
  assert(serverCode.includes('res.json(credits)'), 'Should return credits');
});

// ============================================
// MUSIC GENERATION BILLING TESTS
// ============================================
console.log('\n=== Music Generation Billing Tests ===\n');

test('music generation endpoint checks customer auth', () => {
  assert(serverCode.includes('req.stripeCustomerId'), 'Should get customer ID');
});

test('music generation endpoint passes customerId to queue', () => {
  assert(serverCode.includes('customerId,'), 'Should pass customerId');
  assert(serverCode.includes('addMusicJob'), 'Should add to music job queue');
});

// ============================================
// DATABASE SCHEMA TESTS
// ============================================
console.log('\n=== Database Schema Tests ===\n');

test('music_credits_remaining column defined', () => {
  assert(usageTrackingCode.includes('music_credits_remaining'), 'Should have remaining column');
});

test('music_credits_total column defined', () => {
  assert(usageTrackingCode.includes('music_credits_total'), 'Should have total column');
});

test('music_credits_reset_at column defined', () => {
  assert(usageTrackingCode.includes('music_credits_reset_at'), 'Should have reset_at column');
});

test('music_usage_log table has stripe_customer_id', () => {
  assert(usageTrackingCode.includes('stripe_customer_id VARCHAR(255)'), 'Should have customer ID');
});

test('music_usage_log table has credits_used', () => {
  assert(usageTrackingCode.includes('credits_used'), 'Should have credits_used');
});

test('music_usage_log table has overage_charged', () => {
  assert(usageTrackingCode.includes('overage_charged'), 'Should have overage_charged');
});

test('music_usage_log table has created_at', () => {
  assert(usageTrackingCode.includes('created_at TIMESTAMP'), 'Should have created_at');
});

// ============================================
// EXPORTS TESTS
// ============================================
console.log('\n=== Exports Tests ===\n');

test('module.exports includes getMusicCredits', () => {
  assert(usageTrackingCode.includes('getMusicCredits,'), 'Should export getMusicCredits');
});

test('module.exports includes hasMusicCredits', () => {
  assert(usageTrackingCode.includes('hasMusicCredits,'), 'Should export hasMusicCredits');
});

test('module.exports includes deductMusicCredit', () => {
  assert(usageTrackingCode.includes('deductMusicCredit,'), 'Should export deductMusicCredit');
});

test('module.exports includes resetMusicCredits', () => {
  assert(usageTrackingCode.includes('resetMusicCredits,'), 'Should export resetMusicCredits');
});

test('module.exports includes addMusicCredits', () => {
  assert(usageTrackingCode.includes('addMusicCredits,'), 'Should export addMusicCredits');
});

test('module.exports includes TIER_MUSIC_CREDITS', () => {
  assert(usageTrackingCode.includes('TIER_MUSIC_CREDITS,'), 'Should export TIER_MUSIC_CREDITS');
});

test('module.exports includes MUSIC_OVERAGE_RATES', () => {
  assert(usageTrackingCode.includes('MUSIC_OVERAGE_RATES'), 'Should export MUSIC_OVERAGE_RATES');
});

// ============================================
// MARGIN ANALYSIS TESTS
// ============================================
console.log('\n=== Margin Analysis Tests ===\n');

// Cost per song: ~$0.05 (Mureka $0.03 + ACRCloud $0.01 + R2 $0.002 + overhead $0.01)
// These tests verify pricing maintains 75-90% margins

test('starter overage maintains 90% margin', () => {
  // $0.50 price, $0.05 cost = 90% margin
  const price = 0.50;
  const cost = 0.05;
  const margin = (price - cost) / price;
  assert(margin >= 0.85, `Starter margin should be >= 85%, got ${(margin * 100).toFixed(1)}%`);
});

test('pro overage maintains 83% margin', () => {
  // $0.30 price, $0.05 cost = 83% margin
  const price = 0.30;
  const cost = 0.05;
  const margin = (price - cost) / price;
  assert(margin >= 0.75, `Pro margin should be >= 75%, got ${(margin * 100).toFixed(1)}%`);
});

test('team overage maintains 75% margin', () => {
  // $0.20 price, $0.05 cost = 75% margin
  const price = 0.20;
  const cost = 0.05;
  const margin = (price - cost) / price;
  assert(margin >= 0.70, `Team margin should be >= 70%, got ${(margin * 100).toFixed(1)}%`);
});

// ============================================
// SUMMARY
// ============================================
console.log('\n========================================');
console.log(`Phase 4 E2E Tests: ${passed} passed, ${failed} failed`);
console.log('========================================\n');

if (failures.length > 0) {
  console.log('Failures:');
  failures.forEach(f => {
    console.log(`  - ${f.name}: ${f.error}`);
  });
  console.log('');
}

// Exit with appropriate code
process.exit(failed > 0 ? 1 : 0);
