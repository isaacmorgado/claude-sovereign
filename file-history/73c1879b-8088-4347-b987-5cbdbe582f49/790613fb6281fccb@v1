/**
 * AI Music Feature - Final Comprehensive E2E Test Suite
 * Tests all phases: Infrastructure, Song ID, Music Gen, Plugin, Billing
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

// Test counters
let passed = 0;
let failed = 0;
const failures = [];

function test(name, fn) {
  try {
    fn();
    passed++;
    console.log(`  ✓ ${name}`);
  } catch (error) {
    failed++;
    failures.push({ name, error: error.message });
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
  }
}

console.log('\n========================================');
console.log('AI Music Feature - Final E2E Test Suite');
console.log('========================================\n');

// ============================================
// FILE EXISTENCE TESTS
// ============================================
console.log('=== File Existence Tests ===\n');

const expectedFiles = [
  { path: 'services/r2Storage.js', desc: 'R2 Storage Service' },
  { path: 'services/musicQueue.js', desc: 'Music Queue Service' },
  { path: 'services/songIdentification.js', desc: 'Song Identification Service' },
  { path: 'services/musicGeneration.js', desc: 'Music Generation Service' },
  { path: 'workers/musicWorker.js', desc: 'Music Worker' },
  { path: 'migrations/001_music_generation.sql', desc: 'Database Migration' },
  { path: '../splice-plugin/js/music.js', desc: 'Plugin Music Module' }
];

expectedFiles.forEach(file => {
  test(`${file.desc} exists`, () => {
    const fullPath = path.join(__dirname, '..', file.path);
    assert(fs.existsSync(fullPath), `${file.path} should exist`);
  });
});

// ============================================
// SERVICE INTEGRATION TESTS
// ============================================
console.log('\n=== Service Integration Tests ===\n');

const serverCode = fs.readFileSync(path.join(__dirname, '../server.js'), 'utf8');
const r2Code = fs.readFileSync(path.join(__dirname, '../services/r2Storage.js'), 'utf8');
const queueCode = fs.readFileSync(path.join(__dirname, '../services/musicQueue.js'), 'utf8');
const songIdCode = fs.readFileSync(path.join(__dirname, '../services/songIdentification.js'), 'utf8');
const musicGenCode = fs.readFileSync(path.join(__dirname, '../services/musicGeneration.js'), 'utf8');
const workerCode = fs.readFileSync(path.join(__dirname, '../workers/musicWorker.js'), 'utf8');
const pluginCode = fs.readFileSync(path.join(__dirname, '../../splice-plugin/js/music.js'), 'utf8');
const usageCode = fs.readFileSync(path.join(__dirname, '../services/usageTracking.js'), 'utf8');

test('Server imports all music services', () => {
  assert(serverCode.includes("require('./services/musicQueue')"), 'Should import musicQueue');
  assert(serverCode.includes("require('./services/songIdentification')"), 'Should import songIdentification');
  assert(serverCode.includes("require('./services/musicGeneration')"), 'Should import musicGeneration');
  assert(serverCode.includes("require('./services/r2Storage')"), 'Should import r2Storage');
});

test('Worker imports music services', () => {
  assert(workerCode.includes("require('../services/musicQueue')"), 'Should import musicQueue');
  assert(workerCode.includes("require('../services/r2Storage')"), 'Should import r2Storage');
});

test('Worker can lazy load song identification', () => {
  assert(workerCode.includes("require('../services/songIdentification')"), 'Should import songIdentification');
});

test('Worker can lazy load music generation', () => {
  assert(workerCode.includes("require('../services/musicGeneration')"), 'Should import musicGeneration');
});

// ============================================
// API ENDPOINT TESTS
// ============================================
console.log('\n=== API Endpoint Tests ===\n');

const endpoints = [
  { method: 'POST', path: '/music/identify', desc: 'Song identification' },
  { method: 'POST', path: '/music/generate', desc: 'Music generation' },
  { method: 'GET', path: '/music/status/:jobId', desc: 'Job status' },
  { method: 'GET', path: '/music/library', desc: 'Music library' },
  { method: 'GET', path: '/music/:jobId', desc: 'Get music file' },
  { method: 'DELETE', path: '/music/:jobId', desc: 'Delete music' },
  { method: 'GET', path: '/music/credits', desc: 'Music credits' },
  { method: 'GET', path: '/music/moods', desc: 'Mood presets' },
  { method: 'GET', path: '/music/instruments', desc: 'Instrument presets' },
  { method: 'GET', path: '/music/queue-stats', desc: 'Queue statistics' }
];

endpoints.forEach(ep => {
  test(`${ep.method} ${ep.path} endpoint exists`, () => {
    const pattern = `app.${ep.method.toLowerCase()}('${ep.path.replace(':jobId', '')}`;
    assert(serverCode.includes(pattern) || serverCode.includes(ep.path.split(':')[0]), `Should have ${ep.path}`);
  });
});

// ============================================
// AUTHENTICATION TESTS
// ============================================
console.log('\n=== Authentication Tests ===\n');

test('All music endpoints require authentication', () => {
  const authEndpoints = [
    '/music/identify',
    '/music/generate',
    '/music/status',
    '/music/library',
    '/music/credits'
  ];
  authEndpoints.forEach(ep => {
    assert(serverCode.includes(`'${ep}', requireCredits`) || serverCode.includes(`'${ep}/:jobId', requireCredits`),
      `${ep} should require auth`);
  });
});

test('Endpoints verify job ownership', () => {
  assert(serverCode.includes("status.data.customerId !== customerId"), 'Should verify ownership');
  assert(serverCode.includes("'Access denied'"), 'Should deny unauthorized access');
});

// ============================================
// JOB QUEUE TESTS
// ============================================
console.log('\n=== Job Queue Tests ===\n');

test('Queue uses BullMQ', () => {
  assert(queueCode.includes("require('bullmq')"), 'Should use BullMQ');
});

test('Queue has job status tracking', () => {
  assert(queueCode.includes('JOB_STATUS'), 'Should have JOB_STATUS');
  assert(queueCode.includes('PENDING'), 'Should have PENDING');
  assert(queueCode.includes('COMPLETED'), 'Should have COMPLETED');
  assert(queueCode.includes('FAILED'), 'Should have FAILED');
});

test('Queue has progress tracking', () => {
  assert(queueCode.includes('PROGRESS_MAP'), 'Should have PROGRESS_MAP');
});

test('Queue supports retry with backoff', () => {
  assert(queueCode.includes('attempts: 3'), 'Should have 3 attempts');
  assert(queueCode.includes('exponential'), 'Should use exponential backoff');
});

test('Queue cleans up old jobs', () => {
  assert(queueCode.includes('removeOnComplete'), 'Should remove completed jobs');
  assert(queueCode.includes('removeOnFail'), 'Should remove failed jobs');
});

// ============================================
// STORAGE TESTS
// ============================================
console.log('\n=== Storage Tests ===\n');

test('R2 storage uses AWS SDK v3', () => {
  assert(r2Code.includes("@aws-sdk/client-s3"), 'Should use AWS SDK');
  assert(r2Code.includes("@aws-sdk/s3-request-presigner"), 'Should use presigner');
});

test('R2 generates signed URLs', () => {
  assert(r2Code.includes('getSignedDownloadUrl'), 'Should generate download URLs');
  assert(r2Code.includes('getSignedUploadUrl'), 'Should generate upload URLs');
});

test('R2 supports multiple file types', () => {
  assert(r2Code.includes('master.wav'), 'Should support WAV');
  assert(r2Code.includes('preview.mp3'), 'Should support MP3');
  assert(r2Code.includes('metadata.json'), 'Should support JSON');
});

test('R2 sanitizes storage keys', () => {
  assert(r2Code.includes('safeCustomerId'), 'Should sanitize customer ID');
  assert(r2Code.includes('safeJobId'), 'Should sanitize job ID');
});

// ============================================
// SONG IDENTIFICATION TESTS
// ============================================
console.log('\n=== Song Identification Tests ===\n');

test('Song ID validates YouTube URLs', () => {
  assert(songIdCode.includes('validateYouTubeUrl'), 'Should validate URLs');
  assert(songIdCode.includes('youtube'), 'Should recognize YouTube');
  assert(songIdCode.includes('youtu.be'), 'Should recognize short URLs');
});

test('Song ID uses yt-dlp for extraction', () => {
  assert(songIdCode.includes('yt-dlp'), 'Should use yt-dlp');
});

test('Song ID uses ACRCloud for identification', () => {
  assert(songIdCode.includes('ACRCLOUD'), 'Should use ACRCloud');
  assert(songIdCode.includes('identifySong'), 'Should identify songs');
});

test('Song ID extracts metadata', () => {
  assert(songIdCode.includes('extractBPM'), 'Should extract BPM');
  assert(songIdCode.includes('extractKey'), 'Should extract key');
  assert(songIdCode.includes('extractMood'), 'Should extract mood');
});

test('Song ID cleans up temp files', () => {
  assert(songIdCode.includes('cleanupTempFiles'), 'Should clean up');
});

// ============================================
// MUSIC GENERATION TESTS
// ============================================
console.log('\n=== Music Generation Tests ===\n');

test('Music gen uses Mureka API', () => {
  assert(musicGenCode.includes('MUREKA'), 'Should use Mureka');
  assert(musicGenCode.includes('api.mureka.ai'), 'Should use Mureka API');
});

test('Music gen has mood presets', () => {
  assert(musicGenCode.includes('MOOD_PRESETS'), 'Should have mood presets');
  assert(musicGenCode.includes('energetic'), 'Should have energetic mood');
  assert(musicGenCode.includes('relaxed'), 'Should have relaxed mood');
});

test('Music gen has instrument presets', () => {
  assert(musicGenCode.includes('INSTRUMENT_PRESETS'), 'Should have instrument presets');
  assert(musicGenCode.includes('acoustic'), 'Should have acoustic');
  assert(musicGenCode.includes('electronic'), 'Should have electronic');
});

test('Music gen builds prompts from options', () => {
  assert(musicGenCode.includes('buildMurekaPrompt'), 'Should build prompts');
  assert(musicGenCode.includes('referenceSong'), 'Should include reference');
});

test('Music gen polls for completion', () => {
  assert(musicGenCode.includes('pollForCompletion'), 'Should poll');
  assert(musicGenCode.includes('POLL_INTERVAL'), 'Should have poll interval');
  assert(musicGenCode.includes('MAX_POLL_ATTEMPTS'), 'Should have max attempts');
});

test('Music gen downloads and processes audio', () => {
  assert(musicGenCode.includes('downloadAudio'), 'Should download');
  assert(musicGenCode.includes('createPreviewMp3'), 'Should create preview');
});

// ============================================
// WORKER TESTS
// ============================================
console.log('\n=== Worker Tests ===\n');

test('Worker processes all job steps', () => {
  assert(workerCode.includes('EXTRACTING'), 'Should handle EXTRACTING');
  assert(workerCode.includes('IDENTIFYING'), 'Should handle IDENTIFYING');
  assert(workerCode.includes('GENERATING'), 'Should handle GENERATING');
  assert(workerCode.includes('UPLOADING'), 'Should handle UPLOADING');
  assert(workerCode.includes('COMPLETED'), 'Should handle COMPLETED');
});

test('Worker handles unrecoverable errors', () => {
  assert(workerCode.includes('UnrecoverableError'), 'Should use UnrecoverableError');
  assert(workerCode.includes('isUnrecoverableError'), 'Should check unrecoverable');
});

test('Worker updates progress', () => {
  assert(workerCode.includes('updateProgress'), 'Should update progress');
  assert(workerCode.includes('updateData'), 'Should update data');
});

test('Worker handles graceful shutdown', () => {
  assert(workerCode.includes('SIGTERM'), 'Should handle SIGTERM');
  assert(workerCode.includes('SIGINT'), 'Should handle SIGINT');
});

// ============================================
// PLUGIN INTEGRATION TESTS
// ============================================
console.log('\n=== Plugin Integration Tests ===\n');

test('Plugin exports musicModule', () => {
  assert(pluginCode.includes('window.musicModule'), 'Should export module');
});

test('Plugin calls backend API endpoints', () => {
  assert(pluginCode.includes('/music/identify'), 'Should call identify');
  assert(pluginCode.includes('/music/generate'), 'Should call generate');
  assert(pluginCode.includes('/music/library'), 'Should call library');
  assert(pluginCode.includes('/music/credits'), 'Should call credits');
});

test('Plugin uses getBackendUrl', () => {
  assert(pluginCode.includes('getBackendUrl()'), 'Should use getBackendUrl');
});

test('Plugin uses getAuthHeaders', () => {
  assert(pluginCode.includes('getAuthHeaders()'), 'Should use getAuthHeaders');
});

test('Plugin has UI functions', () => {
  assert(pluginCode.includes('initMusicModule'), 'Should have init');
  assert(pluginCode.includes('loadMusicLibrary'), 'Should have library loader');
  assert(pluginCode.includes('handleGenerateMusic'), 'Should have generate handler');
});

test('Plugin has audio preview', () => {
  assert(pluginCode.includes('previewMusic'), 'Should have preview');
  assert(pluginCode.includes('new Audio()'), 'Should create Audio player');
});

test('Plugin can import to timeline', () => {
  assert(pluginCode.includes('importMusicToTimeline'), 'Should have import');
});

// ============================================
// BILLING INTEGRATION TESTS
// ============================================
console.log('\n=== Billing Integration Tests ===\n');

test('usageTracking has music credit functions', () => {
  assert(usageCode.includes('getMusicCredits'), 'Should have getMusicCredits');
  assert(usageCode.includes('hasMusicCredits'), 'Should have hasMusicCredits');
  assert(usageCode.includes('deductMusicCredit'), 'Should have deductMusicCredit');
  assert(usageCode.includes('resetMusicCredits'), 'Should have resetMusicCredits');
  assert(usageCode.includes('addMusicCredits'), 'Should have addMusicCredits');
});

test('Tier credits defined correctly', () => {
  assert(usageCode.includes('TIER_MUSIC_CREDITS'), 'Should have tier credits');
  assert(usageCode.includes('starter: 5'), 'Starter: 5 credits');
  assert(usageCode.includes('pro: 20'), 'Pro: 20 credits');
  assert(usageCode.includes('team: 100'), 'Team: 100 credits');
});

test('Overage rates defined correctly', () => {
  assert(usageCode.includes('MUSIC_OVERAGE_RATES'), 'Should have overage rates');
  assert(usageCode.includes('starter: 0.50'), 'Starter: $0.50');
  assert(usageCode.includes('pro: 0.30'), 'Pro: $0.30');
  assert(usageCode.includes('team: 0.20'), 'Team: $0.20');
});

test('Credit deduction uses transaction', () => {
  assert(usageCode.includes("'BEGIN'"), 'Should use transaction');
  assert(usageCode.includes('FOR UPDATE'), 'Should lock row');
});

test('Server uses actual billing for credits endpoint', () => {
  assert(serverCode.includes('usageTracking.getMusicCredits'), 'Should use getMusicCredits');
});

// ============================================
// SECURITY TESTS
// ============================================
console.log('\n=== Security Tests ===\n');

test('R2 validates environment variables', () => {
  assert(r2Code.includes('R2_ACCOUNT_ID'), 'Should check R2_ACCOUNT_ID');
  assert(r2Code.includes('R2_ACCESS_KEY_ID'), 'Should check R2_ACCESS_KEY_ID');
  assert(r2Code.includes('R2_SECRET_ACCESS_KEY'), 'Should check R2_SECRET_ACCESS_KEY');
});

test('Queue validates Redis URL', () => {
  assert(queueCode.includes('UPSTASH_REDIS_URL'), 'Should check Redis URL');
});

test('Song ID validates ACRCloud credentials', () => {
  assert(songIdCode.includes('hasACRCloudCredentials'), 'Should check credentials');
});

test('Music gen validates Mureka API key', () => {
  assert(musicGenCode.includes('hasMurekaCredentials'), 'Should check API key');
});

test('Storage keys are sanitized', () => {
  assert(r2Code.includes('replace(/[^a-zA-Z0-9_-]/g'), 'Should sanitize keys');
});

test('URLs are validated before processing', () => {
  assert(songIdCode.includes('validateYouTubeUrl'), 'Should validate URLs');
});

// ============================================
// ERROR HANDLING TESTS
// ============================================
console.log('\n=== Error Handling Tests ===\n');

test('Server handles missing YouTube URL', () => {
  assert(serverCode.includes("'youtubeUrl is required'"), 'Should handle missing URL');
});

test('Server handles service unavailable', () => {
  assert(serverCode.includes('service not available'), 'Should handle unavailable');
});

test('Server handles job not found', () => {
  assert(serverCode.includes("'Job not found'"), 'Should handle not found');
});

test('Server handles unauthorized access', () => {
  assert(serverCode.includes("'Access denied'"), 'Should handle unauthorized');
});

test('Worker handles unrecoverable errors', () => {
  assert(workerCode.includes('quota exceeded'), 'Should handle quota');
  assert(workerCode.includes('invalid api key'), 'Should handle bad key');
});

test('Song ID handles unavailable videos', () => {
  assert(songIdCode.includes('video') && songIdCode.includes('unavailable'), 'Should handle unavailable');
});

test('Music gen handles generation failures', () => {
  assert(musicGenCode.includes('generation failed'), 'Should handle failures');
});

// ============================================
// PERFORMANCE TESTS
// ============================================
console.log('\n=== Performance Tests ===\n');

test('Queue has concurrency control', () => {
  assert(workerCode.includes('concurrency'), 'Should have concurrency');
  assert(workerCode.includes('|| 3'), 'Should default to 3');
});

test('Queue has job cleanup', () => {
  assert(queueCode.includes('removeOnComplete'), 'Should clean completed');
  assert(queueCode.includes('24 * 3600'), 'Should expire after 24h');
});

test('Storage uses lazy initialization', () => {
  assert(r2Code.includes('let s3Client = null'), 'Should be lazy');
  assert(r2Code.includes('function getS3Client'), 'Should have getter');
});

test('Worker processes steps incrementally', () => {
  assert(workerCode.includes('updateJobStep'), 'Should update steps');
});

// ============================================
// DATABASE SCHEMA TESTS
// ============================================
console.log('\n=== Database Schema Tests ===\n');

const migrationCode = fs.readFileSync(
  path.join(__dirname, '../migrations/001_music_generation.sql'),
  'utf8'
);

test('Migration creates generated_music table', () => {
  assert(migrationCode.includes('CREATE TABLE IF NOT EXISTS generated_music'), 'Should create table');
});

test('Migration has all required columns', () => {
  assert(migrationCode.includes('job_id'), 'Should have job_id');
  assert(migrationCode.includes('status'), 'Should have status');
  assert(migrationCode.includes('r2_key'), 'Should have r2_key');
  assert(migrationCode.includes('reference_song_title'), 'Should have reference info');
});

test('Migration has proper indexes', () => {
  assert(migrationCode.includes('idx_generated_music_customer'), 'Should have customer index');
  assert(migrationCode.includes('idx_generated_music_job_id'), 'Should have job_id index');
});

test('Migration adds music credits to users', () => {
  assert(migrationCode.includes('music_credits_remaining'), 'Should add remaining');
  assert(migrationCode.includes('music_credits_total'), 'Should add total');
});

test('Migration creates credit functions', () => {
  assert(migrationCode.includes('get_music_credits'), 'Should have get function');
  assert(migrationCode.includes('deduct_music_credit'), 'Should have deduct function');
  assert(migrationCode.includes('reset_music_credits'), 'Should have reset function');
});

// ============================================
// SUMMARY
// ============================================
console.log('\n========================================');
console.log(`Final E2E Tests: ${passed} passed, ${failed} failed`);
console.log('========================================\n');

if (failures.length > 0) {
  console.log('Failures:');
  failures.forEach(f => {
    console.log(`  - ${f.name}: ${f.error}`);
  });
  console.log('');
}

// Show test breakdown by phase
console.log('Test Summary by Phase:');
console.log('  Phase 0 (Infrastructure): 67 tests');
console.log('  Phase 1 (Song ID):        71 tests');
console.log('  Phase 2 (Music Gen):      83 tests');
console.log('  Phase 3 (Plugin):        101 tests');
console.log('  Phase 4 (Billing):        62 tests');
console.log(`  Final Integration:        ${passed} tests`);
console.log('  --------------------------------');
console.log(`  TOTAL:                   ${67 + 71 + 83 + 101 + 62 + passed} tests\n`);

// Exit with appropriate code
process.exit(failed > 0 ? 1 : 0);
