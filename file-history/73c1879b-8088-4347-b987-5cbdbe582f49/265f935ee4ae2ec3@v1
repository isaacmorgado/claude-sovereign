/**
 * Phase 2 E2E Tests: Music Generation (Mureka API)
 * Tests musicGeneration.js service
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

// Test counters
let passed = 0;
let failed = 0;
const failures = [];

function test(name, fn) {
  try {
    fn();
    passed++;
    console.log(`  ✓ ${name}`);
  } catch (error) {
    failed++;
    failures.push({ name, error: error.message });
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
  }
}

// ============================================
// MUSIC GENERATION SERVICE TESTS
// ============================================
console.log('\n=== Music Generation Service Tests ===\n');

const musicGenPath = path.join(__dirname, '../services/musicGeneration.js');
const musicGenCode = fs.readFileSync(musicGenPath, 'utf8');

test('musicGeneration.js exists and is readable', () => {
  assert(fs.existsSync(musicGenPath), 'musicGeneration.js should exist');
  assert(musicGenCode.length > 0, 'musicGeneration.js should have content');
});

test('musicGeneration exports hasMurekaCredentials function', () => {
  assert(musicGenCode.includes('function hasMurekaCredentials'), 'Should have hasMurekaCredentials function');
});

test('musicGeneration exports buildMurekaPrompt function', () => {
  assert(musicGenCode.includes('function buildMurekaPrompt'), 'Should have buildMurekaPrompt function');
});

test('musicGeneration exports submitGeneration function', () => {
  assert(musicGenCode.includes('async function submitGeneration'), 'Should have submitGeneration function');
});

test('musicGeneration exports checkTaskStatus function', () => {
  assert(musicGenCode.includes('async function checkTaskStatus'), 'Should have checkTaskStatus function');
});

test('musicGeneration exports pollForCompletion function', () => {
  assert(musicGenCode.includes('async function pollForCompletion'), 'Should have pollForCompletion function');
});

test('musicGeneration exports downloadAudio function', () => {
  assert(musicGenCode.includes('async function downloadAudio'), 'Should have downloadAudio function');
});

test('musicGeneration exports createPreviewMp3 function', () => {
  assert(musicGenCode.includes('async function createPreviewMp3'), 'Should have createPreviewMp3 function');
});

test('musicGeneration exports generateMusic function', () => {
  assert(musicGenCode.includes('async function generateMusic'), 'Should have generateMusic function');
});

test('musicGeneration exports validateOptions function', () => {
  assert(musicGenCode.includes('function validateOptions'), 'Should have validateOptions function');
});

// ============================================
// API CONFIGURATION TESTS
// ============================================
console.log('\n=== API Configuration Tests ===\n');

test('uses MUREKA_API_KEY environment variable', () => {
  assert(musicGenCode.includes('MUREKA_API_KEY'), 'Should use MUREKA_API_KEY');
  assert(musicGenCode.includes('process.env.MUREKA_API_KEY'), 'Should read from env');
});

test('has Mureka API base URL configured', () => {
  assert(musicGenCode.includes('MUREKA_BASE_URL'), 'Should have base URL');
  assert(musicGenCode.includes('api.mureka.ai') || musicGenCode.includes('mureka'), 'Should have Mureka domain');
});

test('has API version configured', () => {
  assert(musicGenCode.includes('MUREKA_API_VERSION') || musicGenCode.includes('v1'), 'Should have API version');
});

test('validates API key before requests', () => {
  assert(musicGenCode.includes('Mureka API key not configured'), 'Should validate API key');
});

// ============================================
// DURATION CONSTRAINTS TESTS
// ============================================
console.log('\n=== Duration Constraints Tests ===\n');

test('exports MIN_DURATION constant', () => {
  assert(musicGenCode.includes('MIN_DURATION'), 'Should have MIN_DURATION');
  assert(musicGenCode.includes('= 30'), 'MIN_DURATION should be 30');
});

test('exports MAX_DURATION constant', () => {
  assert(musicGenCode.includes('MAX_DURATION'), 'Should have MAX_DURATION');
  assert(musicGenCode.includes('= 180'), 'MAX_DURATION should be 180');
});

test('exports DEFAULT_DURATION constant', () => {
  assert(musicGenCode.includes('DEFAULT_DURATION'), 'Should have DEFAULT_DURATION');
  assert(musicGenCode.includes('= 60'), 'DEFAULT_DURATION should be 60');
});

test('has clampDuration function', () => {
  assert(musicGenCode.includes('function clampDuration'), 'Should have clampDuration');
  assert(musicGenCode.includes('Math.min') && musicGenCode.includes('Math.max'), 'Should clamp values');
});

// ============================================
// MOOD PRESETS TESTS
// ============================================
console.log('\n=== Mood Presets Tests ===\n');

test('exports MOOD_PRESETS', () => {
  assert(musicGenCode.includes('MOOD_PRESETS'), 'Should have MOOD_PRESETS');
});

test('has energetic mood preset', () => {
  assert(musicGenCode.includes('energetic'), 'Should have energetic mood');
});

test('has relaxed mood preset', () => {
  assert(musicGenCode.includes('relaxed'), 'Should have relaxed mood');
});

test('has melancholic mood preset', () => {
  assert(musicGenCode.includes('melancholic'), 'Should have melancholic mood');
});

test('has intense mood preset', () => {
  assert(musicGenCode.includes('intense'), 'Should have intense mood');
});

test('has happy mood preset', () => {
  assert(musicGenCode.includes('happy'), 'Should have happy mood');
});

test('has neutral mood preset', () => {
  assert(musicGenCode.includes('neutral'), 'Should have neutral mood');
});

test('exports getAvailableMoods function', () => {
  assert(musicGenCode.includes('function getAvailableMoods'), 'Should have getAvailableMoods');
});

// ============================================
// INSTRUMENT PRESETS TESTS
// ============================================
console.log('\n=== Instrument Presets Tests ===\n');

test('exports INSTRUMENT_PRESETS', () => {
  assert(musicGenCode.includes('INSTRUMENT_PRESETS'), 'Should have INSTRUMENT_PRESETS');
});

test('has acoustic instrument preset', () => {
  assert(musicGenCode.includes('acoustic'), 'Should have acoustic preset');
  assert(musicGenCode.includes('acoustic guitar'), 'Should have acoustic guitar');
});

test('has electronic instrument preset', () => {
  assert(musicGenCode.includes('electronic'), 'Should have electronic preset');
  assert(musicGenCode.includes('synthesizer'), 'Should have synthesizer');
});

test('has orchestral instrument preset', () => {
  assert(musicGenCode.includes('orchestral'), 'Should have orchestral preset');
  assert(musicGenCode.includes('strings'), 'Should have strings');
});

test('exports getAvailableInstruments function', () => {
  assert(musicGenCode.includes('function getAvailableInstruments'), 'Should have getAvailableInstruments');
});

// ============================================
// PROMPT BUILDING TESTS
// ============================================
console.log('\n=== Prompt Building Tests ===\n');

test('buildMurekaPrompt includes custom prompt', () => {
  assert(musicGenCode.includes('options.prompt'), 'Should include custom prompt');
});

test('buildMurekaPrompt includes reference song', () => {
  assert(musicGenCode.includes('referenceSong'), 'Should include reference song');
  assert(musicGenCode.includes('referenceSong.title'), 'Should include song title');
  assert(musicGenCode.includes('referenceSong.artist'), 'Should include artist');
});

test('buildMurekaPrompt includes BPM', () => {
  assert(musicGenCode.includes('referenceSong.bpm'), 'Should include BPM');
  assert(musicGenCode.includes('BPM'), 'Should mention BPM');
});

test('buildMurekaPrompt includes musical key', () => {
  assert(musicGenCode.includes('referenceSong.key'), 'Should include key');
});

test('buildMurekaPrompt includes genres', () => {
  assert(musicGenCode.includes('referenceSong.genres'), 'Should include genres');
});

test('buildMurekaPrompt includes mood description', () => {
  assert(musicGenCode.includes('options.mood'), 'Should include mood');
  assert(musicGenCode.includes('moodDescription'), 'Should get mood description');
});

test('buildMurekaPrompt includes instruments', () => {
  assert(musicGenCode.includes('options.instruments'), 'Should include instruments');
});

test('buildMurekaPrompt includes duration', () => {
  assert(musicGenCode.includes('duration'), 'Should include duration');
  assert(musicGenCode.includes('seconds'), 'Should mention seconds');
});

test('buildMurekaPrompt specifies instrumental only', () => {
  assert(musicGenCode.includes('Instrumental only'), 'Should specify instrumental only');
  assert(musicGenCode.includes('no vocals'), 'Should specify no vocals');
});

test('buildMurekaPrompt specifies video background use', () => {
  assert(musicGenCode.includes('background music') || musicGenCode.includes('video'), 'Should mention video use');
});

// ============================================
// API REQUEST TESTS
// ============================================
console.log('\n=== API Request Tests ===\n');

test('uses HTTPS for API requests', () => {
  assert(musicGenCode.includes("require('https')"), 'Should use https module');
});

test('sets Authorization header with Bearer token', () => {
  assert(musicGenCode.includes('Authorization'), 'Should set Authorization header');
  assert(musicGenCode.includes('Bearer'), 'Should use Bearer token');
});

test('sets Content-Type to application/json', () => {
  assert(musicGenCode.includes('application/json'), 'Should use JSON content type');
});

test('submits to /generate endpoint', () => {
  assert(musicGenCode.includes('/generate'), 'Should use generate endpoint');
});

test('checks task status via /tasks endpoint', () => {
  assert(musicGenCode.includes('/tasks/'), 'Should use tasks endpoint');
});

test('request includes prompt', () => {
  assert(musicGenCode.includes('prompt'), 'Request should include prompt');
});

test('request includes duration', () => {
  assert(musicGenCode.includes('duration'), 'Request should include duration');
});

test('request specifies instrumental type', () => {
  assert(musicGenCode.includes("'instrumental'"), 'Should specify instrumental type');
});

test('request specifies WAV format', () => {
  assert(musicGenCode.includes("'wav'"), 'Should specify WAV format');
});

test('has request timeout configured', () => {
  assert(musicGenCode.includes('setTimeout(60000)'), 'Should have 60s timeout');
});

// ============================================
// POLLING TESTS
// ============================================
console.log('\n=== Polling Tests ===\n');

test('has POLL_INTERVAL configured', () => {
  assert(musicGenCode.includes('POLL_INTERVAL'), 'Should have POLL_INTERVAL');
  assert(musicGenCode.includes('5000'), 'Should poll every 5 seconds');
});

test('has MAX_POLL_ATTEMPTS configured', () => {
  assert(musicGenCode.includes('MAX_POLL_ATTEMPTS'), 'Should have MAX_POLL_ATTEMPTS');
  assert(musicGenCode.includes('120'), 'Should have 120 attempts (10 min)');
});

test('checks for completed status', () => {
  assert(musicGenCode.includes("status === 'completed'"), 'Should check for completed');
});

test('checks for failed status', () => {
  assert(musicGenCode.includes("status === 'failed'"), 'Should check for failed');
});

test('checks for cancelled status', () => {
  assert(musicGenCode.includes("status === 'cancelled'") || musicGenCode.includes('cancelled'), 'Should check for cancelled');
});

test('throws on timeout', () => {
  assert(musicGenCode.includes('timed out'), 'Should throw on timeout');
});

test('reports progress during polling', () => {
  assert(musicGenCode.includes('onProgress'), 'Should have progress callback');
});

// ============================================
// AUDIO DOWNLOAD TESTS
// ============================================
console.log('\n=== Audio Download Tests ===\n');

test('downloadAudio handles redirects', () => {
  assert(musicGenCode.includes('302') || musicGenCode.includes('301'), 'Should handle redirects');
  assert(musicGenCode.includes('location'), 'Should follow redirect location');
});

test('downloadAudio returns Buffer', () => {
  assert(musicGenCode.includes('Buffer.concat'), 'Should concatenate chunks into Buffer');
});

test('downloadAudio handles HTTP errors', () => {
  assert(musicGenCode.includes('statusCode'), 'Should check status code');
  assert(musicGenCode.includes('Failed to download'), 'Should throw on error');
});

// ============================================
// PREVIEW GENERATION TESTS
// ============================================
console.log('\n=== Preview Generation Tests ===\n');

test('createPreviewMp3 uses FFmpeg', () => {
  assert(musicGenCode.includes('ffmpeg'), 'Should use FFmpeg');
});

test('createPreviewMp3 outputs MP3', () => {
  assert(musicGenCode.includes('.mp3'), 'Should output MP3');
  assert(musicGenCode.includes('libmp3lame'), 'Should use MP3 encoder');
});

test('createPreviewMp3 cleans up temp files', () => {
  assert(musicGenCode.includes('fs.unlink'), 'Should clean up temp files');
});

test('createPreviewMp3 handles errors gracefully', () => {
  assert(musicGenCode.includes('Failed to create preview'), 'Should handle preview errors');
});

// ============================================
// TITLE GENERATION TESTS
// ============================================
console.log('\n=== Title Generation Tests ===\n');

test('generateTitle includes mood', () => {
  assert(musicGenCode.includes('options.mood'), 'Should include mood in title');
});

test('generateTitle includes reference song', () => {
  assert(musicGenCode.includes('referenceSong.title'), 'Should include reference song');
});

test('generateTitle has fallback', () => {
  assert(musicGenCode.includes('AI Generated'), 'Should have fallback title');
});

// ============================================
// VALIDATION TESTS
// ============================================
console.log('\n=== Validation Tests ===\n');

test('validateOptions checks duration type', () => {
  assert(musicGenCode.includes("'number'"), 'Should check duration is number');
});

test('validateOptions checks duration minimum', () => {
  assert(musicGenCode.includes('MIN_DURATION'), 'Should check minimum duration');
});

test('validateOptions checks duration maximum', () => {
  assert(musicGenCode.includes('MAX_DURATION'), 'Should check maximum duration');
});

test('validateOptions checks instruments is array', () => {
  assert(musicGenCode.includes('Array.isArray'), 'Should check instruments is array');
});

test('validateOptions returns valid flag and errors', () => {
  assert(musicGenCode.includes('valid:'), 'Should return valid flag');
  assert(musicGenCode.includes('errors'), 'Should return errors array');
});

// ============================================
// ERROR HANDLING TESTS
// ============================================
console.log('\n=== Error Handling Tests ===\n');

test('handles missing task ID', () => {
  assert(musicGenCode.includes('did not return a task ID'), 'Should handle missing task ID');
});

test('handles no audio URL on completion', () => {
  assert(musicGenCode.includes('no audio URL'), 'Should handle missing audio URL');
});

test('handles generation failure', () => {
  assert(musicGenCode.includes('generation failed'), 'Should handle generation failure');
});

test('handles API request errors', () => {
  assert(musicGenCode.includes('request failed'), 'Should handle request errors');
});

test('handles parse errors', () => {
  assert(musicGenCode.includes('Failed to parse'), 'Should handle parse errors');
});

test('handles request timeout', () => {
  assert(musicGenCode.includes('request timeout'), 'Should handle timeout');
});

// ============================================
// INTEGRATION WITH WORKER TESTS
// ============================================
console.log('\n=== Worker Integration Tests ===\n');

const workerPath = path.join(__dirname, '../workers/musicWorker.js');
const workerCode = fs.readFileSync(workerPath, 'utf8');

test('musicWorker can import musicGeneration', () => {
  assert(workerCode.includes("require('../services/musicGeneration')"), 'Worker should import musicGeneration');
});

test('musicWorker calls generateMusic', () => {
  assert(workerCode.includes('generateMusic'), 'Worker should call generateMusic');
});

test('worker builds prompt from reference song', () => {
  assert(workerCode.includes('buildGenerationPrompt'), 'Worker should build prompt');
  assert(workerCode.includes('referenceSong'), 'Prompt should include reference song');
});

// ============================================
// EXPORT STRUCTURE TESTS
// ============================================
console.log('\n=== Export Structure Tests ===\n');

test('module.exports includes all public functions', () => {
  const expectedExports = [
    'hasMurekaCredentials',
    'buildMurekaPrompt',
    'clampDuration',
    'submitGeneration',
    'checkTaskStatus',
    'pollForCompletion',
    'downloadAudio',
    'createPreviewMp3',
    'generateTitle',
    'generateMusic',
    'getAvailableMoods',
    'getAvailableInstruments',
    'validateOptions',
    'MOOD_PRESETS',
    'INSTRUMENT_PRESETS',
    'MIN_DURATION',
    'MAX_DURATION',
    'DEFAULT_DURATION'
  ];

  expectedExports.forEach(exp => {
    assert(musicGenCode.includes(exp), `Should export ${exp}`);
  });
});

// ============================================
// SUMMARY
// ============================================
console.log('\n========================================');
console.log(`Phase 2 E2E Tests: ${passed} passed, ${failed} failed`);
console.log('========================================\n');

if (failures.length > 0) {
  console.log('Failures:');
  failures.forEach(f => {
    console.log(`  - ${f.name}: ${f.error}`);
  });
  console.log('');
}

// Exit with appropriate code
process.exit(failed > 0 ? 1 : 0);
