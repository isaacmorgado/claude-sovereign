# AI Music Features V2 - Continuation Prompt

## Task
Implement the 4 advanced music features from the plan agent output (agent ID: a5b7abb).

## Features to Implement (in order)

1. **3 Song Variations** (8-10 hrs)
   - Parallel Mureka generation
   - `POST /music/generate-variations` endpoint
   - Plugin UI with 3 audio previews + selection

2. **Scene-Aware Music** (12-15 hrs)
   - New: `services/sceneAnalysis.js`
   - GPT-4o-mini sentiment analysis
   - Energy timeline from transcript
   - Enhanced prompt building

3. **Music-to-Cut Alignment** (10-12 hrs)
   - New: `services/musicAlignment.js`
   - FFmpeg beat detection (`aubio`)
   - Trim at nearest beat + fade out

4. **Mood Timeline** (15-20 hrs)
   - New: `services/musicTimeline.js`
   - Per-chapter mood assignment
   - FFmpeg crossfade assembly
   - `POST /music/generate-timeline` endpoint

## Key Files
- `splice-backend/services/musicGeneration.js` - Add variation logic
- `splice-backend/services/musicQueue.js` - Parallel job management
- `splice-backend/services/chapterDetection.js` - Reuse for mood timeline
- `splice-plugin/js/music.js` - UI updates for all features

## Testing Instructions
After implementing each feature run an end to end test that looks for bottlenecks, bugs, makes sure everything is wired correctly, there are no issues with the UI, the UI and logic are wired correctly, API endpoints are tested and work correctly. the process should work as implement -> end to end test -> identifies a bug -> fixes the bug -> runs the test again -> test comes back clean -> move onto the next feature -> repeat this process until all features are completed. After everything has been completed then it should run an end to end test that looks tests that everything is wired correctly, implemented, there are no issues, etc. Make the prompt short, to the point, and reference key files. Once this has been completed it should update the documentation to reflect the updates.

## Pricing
- Variations: 2.5 credits (79% margin)
- Scene-Aware: 1.5 credits (75% margin)
- Cut Alignment: 1 credit (90% margin)
- Mood Timeline: 0.8 credits/segment (84% margin)
