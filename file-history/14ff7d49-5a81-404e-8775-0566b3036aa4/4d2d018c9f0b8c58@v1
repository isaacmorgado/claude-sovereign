'use client';

import { useState, useRef, useCallback, useEffect } from 'react';
import Image from 'next/image';
import { motion } from 'framer-motion';

export interface LandmarkPoint {
  id: string;
  label: string;
  description: string;
  x: number;
  y: number;
}

interface SideProfileManualToolProps {
  imageUrl: string;
  onLandmarksChange?: (landmarks: LandmarkPoint[]) => void;
  onComplete?: (landmarks: LandmarkPoint[]) => void;
}

const INITIAL_LANDMARKS: LandmarkPoint[] = [
  {
    id: 'nasion',
    label: 'Nasion',
    description: 'Bridge of nose (between eyes)',
    x: 0.45,
    y: 0.28,
  },
  {
    id: 'pronasale',
    label: 'Pronasale',
    description: 'Tip of nose',
    x: 0.35,
    y: 0.42,
  },
  {
    id: 'subnasale',
    label: 'Subnasale',
    description: 'Base of nose',
    x: 0.42,
    y: 0.48,
  },
  {
    id: 'labrale',
    label: 'Labrale',
    description: 'Center of upper lip',
    x: 0.40,
    y: 0.55,
  },
  {
    id: 'pogonion',
    label: 'Pogonion',
    description: 'Front of chin',
    x: 0.38,
    y: 0.72,
  },
];

export function SideProfileManualTool({
  imageUrl,
  onLandmarksChange,
  onComplete,
}: SideProfileManualToolProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const [landmarks, setLandmarks] = useState<LandmarkPoint[]>(INITIAL_LANDMARKS);
  const [activeLandmark, setActiveLandmark] = useState<string | null>(null);
  const [containerSize, setContainerSize] = useState({ width: 0, height: 0 });

  useEffect(() => {
    const updateSize = () => {
      if (containerRef.current) {
        const rect = containerRef.current.getBoundingClientRect();
        setContainerSize({ width: rect.width, height: rect.height });
      }
    };

    updateSize();
    window.addEventListener('resize', updateSize);
    return () => window.removeEventListener('resize', updateSize);
  }, []);

  useEffect(() => {
    onLandmarksChange?.(landmarks);
  }, [landmarks, onLandmarksChange]);

  const handleMouseDown = useCallback((id: string) => {
    setActiveLandmark(id);
  }, []);

  const handleMouseMove = useCallback(
    (e: React.MouseEvent<HTMLDivElement>) => {
      if (!activeLandmark || !containerRef.current) return;

      const rect = containerRef.current.getBoundingClientRect();
      const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
      const y = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));

      setLandmarks((prev) =>
        prev.map((lm) => (lm.id === activeLandmark ? { ...lm, x, y } : lm))
      );
    },
    [activeLandmark]
  );

  const handleMouseUp = useCallback(() => {
    setActiveLandmark(null);
  }, []);

  const handleTouchStart = useCallback((id: string) => {
    setActiveLandmark(id);
  }, []);

  const handleTouchMove = useCallback(
    (e: React.TouchEvent<HTMLDivElement>) => {
      if (!activeLandmark || !containerRef.current) return;

      const touch = e.touches[0];
      const rect = containerRef.current.getBoundingClientRect();
      const x = Math.max(0, Math.min(1, (touch.clientX - rect.left) / rect.width));
      const y = Math.max(0, Math.min(1, (touch.clientY - rect.top) / rect.height));

      setLandmarks((prev) =>
        prev.map((lm) => (lm.id === activeLandmark ? { ...lm, x, y } : lm))
      );
    },
    [activeLandmark]
  );

  const handleTouchEnd = useCallback(() => {
    setActiveLandmark(null);
  }, []);

  const handleComplete = () => {
    onComplete?.(landmarks);
  };

  return (
    <div className="w-full max-w-3xl mx-auto">
      {/* Instructions */}
      <motion.div
        initial={{ opacity: 0, y: -10 }}
        animate={{ opacity: 1, y: 0 }}
        className="mb-6 text-center"
      >
        <h2 className="text-xl font-semibold text-white mb-2">
          Align the Facial Landmarks
        </h2>
        <p className="text-foreground-dim">
          Drag each neon marker to match the corresponding point on your profile
        </p>
      </motion.div>

      {/* Image Container with Overlay */}
      <motion.div
        initial={{ opacity: 0, scale: 0.98 }}
        animate={{ opacity: 1, scale: 1 }}
        className="relative"
      >
        <div
          ref={containerRef}
          className="relative w-full aspect-[3/4] rounded-2xl overflow-hidden bg-black border border-border select-none"
          onMouseMove={handleMouseMove}
          onMouseUp={handleMouseUp}
          onMouseLeave={handleMouseUp}
          onTouchMove={handleTouchMove}
          onTouchEnd={handleTouchEnd}
        >
          {/* User's uploaded image */}
          <Image
            src={imageUrl}
            alt="Side profile"
            fill
            className="object-contain pointer-events-none"
            unoptimized
            draggable={false}
          />

          {/* SVG Profile Outline Template */}
          <svg
            className="absolute inset-0 w-full h-full pointer-events-none"
            viewBox="0 0 100 100"
            preserveAspectRatio="none"
          >
            {/* Semi-transparent profile outline guide */}
            <path
              d="M 45 15
                 Q 48 18 48 22
                 L 48 26
                 Q 46 28 45 28
                 Q 38 32 35 42
                 Q 34 45 36 48
                 L 42 48
                 Q 43 50 42 52
                 L 40 55
                 Q 39 58 40 60
                 L 42 62
                 Q 40 68 38 72
                 Q 36 78 40 82
                 Q 44 85 48 84
                 L 52 82"
              fill="none"
              stroke="rgba(0, 243, 255, 0.3)"
              strokeWidth="0.5"
              strokeDasharray="2,2"
            />
          </svg>

          {/* Connection lines between landmarks */}
          <svg
            className="absolute inset-0 w-full h-full pointer-events-none"
            viewBox="0 0 100 100"
            preserveAspectRatio="none"
          >
            {landmarks.map((landmark, index) => {
              if (index === landmarks.length - 1) return null;
              const nextLandmark = landmarks[index + 1];
              return (
                <line
                  key={`line-${landmark.id}`}
                  x1={landmark.x * 100}
                  y1={landmark.y * 100}
                  x2={nextLandmark.x * 100}
                  y2={nextLandmark.y * 100}
                  stroke="rgba(0, 243, 255, 0.4)"
                  strokeWidth="0.3"
                  strokeDasharray="1,1"
                />
              );
            })}
          </svg>

          {/* Draggable Landmark Handles */}
          {landmarks.map((landmark) => (
            <div
              key={landmark.id}
              className={`
                absolute w-5 h-5 -translate-x-1/2 -translate-y-1/2 cursor-grab
                ${activeLandmark === landmark.id ? 'cursor-grabbing z-20' : 'z-10'}
              `}
              style={{
                left: `${landmark.x * 100}%`,
                top: `${landmark.y * 100}%`,
              }}
              onMouseDown={() => handleMouseDown(landmark.id)}
              onTouchStart={() => handleTouchStart(landmark.id)}
            >
              {/* Outer glow ring */}
              <div
                className={`
                  absolute inset-0 rounded-full
                  bg-[#00f3ff]/20
                  transition-all duration-200
                  ${activeLandmark === landmark.id ? 'scale-150 bg-[#00f3ff]/30' : ''}
                `}
              />

              {/* Main handle */}
              <div
                className={`
                  absolute inset-1 rounded-full
                  bg-[#00f3ff] border-2 border-white
                  shadow-[0_0_10px_#00f3ff,0_0_20px_#00f3ff]
                  transition-all duration-200
                  ${activeLandmark === landmark.id ? 'scale-125 shadow-[0_0_15px_#00f3ff,0_0_30px_#00f3ff]' : ''}
                `}
              />

              {/* Label tooltip */}
              <div
                className={`
                  absolute left-6 top-1/2 -translate-y-1/2 whitespace-nowrap
                  px-2 py-1 rounded bg-black/90 border border-[#00f3ff]/50
                  text-xs text-[#00f3ff] font-medium
                  opacity-0 pointer-events-none transition-opacity duration-200
                  ${activeLandmark === landmark.id ? 'opacity-100' : 'group-hover:opacity-100'}
                `}
                style={{
                  opacity: activeLandmark === landmark.id ? 1 : 0,
                }}
              >
                {landmark.label}
              </div>
            </div>
          ))}
        </div>
      </motion.div>

      {/* Landmark Legend */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.2 }}
        className="mt-6 grid grid-cols-2 sm:grid-cols-3 gap-3"
      >
        {landmarks.map((landmark) => (
          <div
            key={landmark.id}
            className={`
              flex items-center gap-2 px-3 py-2 rounded-lg
              border transition-all duration-200
              ${
                activeLandmark === landmark.id
                  ? 'border-[#00f3ff] bg-[#00f3ff]/10'
                  : 'border-border bg-background-secondary'
              }
            `}
          >
            <div className="w-3 h-3 rounded-full bg-[#00f3ff] shadow-[0_0_8px_#00f3ff]" />
            <div>
              <p className="text-sm font-medium text-white">{landmark.label}</p>
              <p className="text-xs text-foreground-dim">{landmark.description}</p>
            </div>
          </div>
        ))}
      </motion.div>

      {/* Complete Button */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3 }}
        className="mt-8 flex justify-center"
      >
        <button
          onClick={handleComplete}
          className="
            px-8 py-4 rounded-lg font-semibold text-lg
            bg-[#00f3ff] text-black
            hover:shadow-[0_0_30px_rgba(0,243,255,0.5)]
            transition-all duration-300
          "
        >
          Confirm Landmarks
        </button>
      </motion.div>
    </div>
  );
}
