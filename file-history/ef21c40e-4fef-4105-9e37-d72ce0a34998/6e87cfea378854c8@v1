/**
 * Caption Styling UI - Main UI controller
 * Handles all user interactions with the caption styling system
 */

// Initialize the styling system
const stylingSystem = new CaptionStylingSystem();

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  initializeUI();
});

function initializeUI() {
  // Set preview canvas
  const canvas = document.getElementById('preview-canvas');
  stylingSystem.setPreviewCanvas(canvas);

  // Initialize all color pickers
  stylingSystem.initializeAllPickers();

  // Setup event listeners
  setupFontControls();
  setupOutlineControls();
  setupBoxControls();
  setupShadowControls();
  setupAnimationControls();
  setupChapterControls();
  setupActionButtons();

  // Initial preview update
  stylingSystem.updatePreview();

  console.log('Caption Styling UI initialized');
}

/**
 * Setup font controls
 */
function setupFontControls() {
  const fillTypeSelect = document.getElementById('font-fill-type');
  const solidGroup = document.getElementById('font-solid-group');
  const gradientGroup = document.getElementById('font-gradient-group');
  const gradientAngle = document.getElementById('font-gradient-angle');
  const gradientAngleValue = document.getElementById('font-gradient-angle-value');
  const fontSize = document.getElementById('font-size');
  const fontFamily = document.getElementById('font-family');

  // Fill type toggle
  fillTypeSelect.addEventListener('change', (e) => {
    const fillType = e.target.value;
    stylingSystem.currentStyle.font.fillType = fillType;

    if (fillType === 'solid') {
      solidGroup.style.display = 'block';
      gradientGroup.style.display = 'none';
    } else {
      solidGroup.style.display = 'none';
      gradientGroup.style.display = 'block';
      stylingSystem.recalculateGradient('font');
    }

    stylingSystem.updatePreview();
  });

  // Gradient angle
  gradientAngle.addEventListener('input', (e) => {
    const angle = parseInt(e.target.value);
    gradientAngleValue.textContent = angle;
    stylingSystem.currentStyle.font.gradient.angle = angle;
    stylingSystem.recalculateGradient('font');
    stylingSystem.updatePreview();
  });

  // Font size
  fontSize.addEventListener('input', (e) => {
    stylingSystem.currentStyle.font.size = parseInt(e.target.value);
    stylingSystem.updatePreview();
  });

  // Font family
  fontFamily.addEventListener('change', (e) => {
    stylingSystem.currentStyle.font.family = e.target.value;
    stylingSystem.updatePreview();
  });
}

/**
 * Setup outline controls
 */
function setupOutlineControls() {
  const enabled = document.getElementById('outline-enabled');
  const controls = document.getElementById('outline-controls');
  const width = document.getElementById('outline-width');
  const widthValue = document.getElementById('outline-width-value');

  enabled.addEventListener('change', (e) => {
    stylingSystem.currentStyle.outline.enabled = e.target.checked;
    controls.style.display = e.target.checked ? 'block' : 'none';
    stylingSystem.updatePreview();
  });

  width.addEventListener('input', (e) => {
    const value = parseFloat(e.target.value);
    widthValue.textContent = value;
    stylingSystem.currentStyle.outline.width = value;
    stylingSystem.updatePreview();
  });
}

/**
 * Setup box controls
 */
function setupBoxControls() {
  const enabled = document.getElementById('box-enabled');
  const controls = document.getElementById('box-controls');
  const fillTypeSelect = document.getElementById('box-fill-type');
  const solidGroup = document.getElementById('box-solid-group');
  const gradientGroup = document.getElementById('box-gradient-group');
  const gradientAngle = document.getElementById('box-gradient-angle');
  const gradientAngleValue = document.getElementById('box-gradient-angle-value');
  const padding = document.getElementById('box-padding');
  const paddingValue = document.getElementById('box-padding-value');
  const borderRadius = document.getElementById('box-border-radius');
  const borderRadiusValue = document.getElementById('box-border-radius-value');

  enabled.addEventListener('change', (e) => {
    stylingSystem.currentStyle.box.enabled = e.target.checked;
    controls.style.display = e.target.checked ? 'block' : 'none';
    stylingSystem.updatePreview();
  });

  fillTypeSelect.addEventListener('change', (e) => {
    const fillType = e.target.value;
    stylingSystem.currentStyle.box.fillType = fillType;

    if (fillType === 'solid') {
      solidGroup.style.display = 'block';
      gradientGroup.style.display = 'none';
    } else {
      solidGroup.style.display = 'none';
      gradientGroup.style.display = 'block';
      stylingSystem.recalculateGradient('box');
    }

    stylingSystem.updatePreview();
  });

  gradientAngle.addEventListener('input', (e) => {
    const angle = parseInt(e.target.value);
    gradientAngleValue.textContent = angle;
    stylingSystem.currentStyle.box.gradient.angle = angle;
    stylingSystem.recalculateGradient('box');
    stylingSystem.updatePreview();
  });

  padding.addEventListener('input', (e) => {
    const value = parseInt(e.target.value);
    paddingValue.textContent = value;
    stylingSystem.currentStyle.box.padding = value;
    stylingSystem.updatePreview();
  });

  borderRadius.addEventListener('input', (e) => {
    const value = parseInt(e.target.value);
    borderRadiusValue.textContent = value;
    stylingSystem.currentStyle.box.borderRadius = value;
    stylingSystem.updatePreview();
  });
}

/**
 * Setup shadow controls
 */
function setupShadowControls() {
  const enabled = document.getElementById('shadow-enabled');
  const controls = document.getElementById('shadow-controls');
  const blur = document.getElementById('shadow-blur');
  const blurValue = document.getElementById('shadow-blur-value');
  const offsetX = document.getElementById('shadow-offset-x');
  const offsetXValue = document.getElementById('shadow-offset-x-value');
  const offsetY = document.getElementById('shadow-offset-y');
  const offsetYValue = document.getElementById('shadow-offset-y-value');

  enabled.addEventListener('change', (e) => {
    stylingSystem.currentStyle.shadow.enabled = e.target.checked;
    controls.style.display = e.target.checked ? 'block' : 'none';
    stylingSystem.updatePreview();
  });

  blur.addEventListener('input', (e) => {
    const value = parseInt(e.target.value);
    blurValue.textContent = value;
    stylingSystem.currentStyle.shadow.blur = value;
    stylingSystem.updatePreview();
  });

  offsetX.addEventListener('input', (e) => {
    const value = parseInt(e.target.value);
    offsetXValue.textContent = value;
    stylingSystem.currentStyle.shadow.offsetX = value;
    stylingSystem.updatePreview();
  });

  offsetY.addEventListener('input', (e) => {
    const value = parseInt(e.target.value);
    offsetYValue.textContent = value;
    stylingSystem.currentStyle.shadow.offsetY = value;
    stylingSystem.updatePreview();
  });
}

/**
 * Setup animation controls
 */
function setupAnimationControls() {
  const typeSelect = document.getElementById('animation-type');

  typeSelect.addEventListener('change', (e) => {
    stylingSystem.currentStyle.animation.type = e.target.value;
    console.log(`Animation type changed to: ${e.target.value}`);
  });
}

/**
 * Setup chapter controls
 */
function setupChapterControls() {
  const fontSize = document.getElementById('chapter-font-size');

  fontSize.addEventListener('input', (e) => {
    stylingSystem.currentStyle.chapter.fontSize = parseInt(e.target.value);
  });
}

/**
 * Setup action buttons
 */
function setupActionButtons() {
  const resetBtn = document.getElementById('reset-style');
  const savePresetBtn = document.getElementById('save-preset');
  const loadPresetBtn = document.getElementById('load-preset');
  const applyStyleBtn = document.getElementById('apply-style');

  // Reset style
  resetBtn.addEventListener('click', () => {
    if (confirm('Reset all styling to defaults?')) {
      location.reload(); // Simple reset by reloading
    }
  });

  // Save preset
  savePresetBtn.addEventListener('click', () => {
    const name = prompt('Enter preset name:');
    if (name) {
      const preset = stylingSystem.exportPreset(name);
      localStorage.setItem(`caption-preset-${name}`, JSON.stringify(preset));
      alert(`Preset "${name}" saved!`);
    }
  });

  // Load preset
  loadPresetBtn.addEventListener('click', () => {
    const name = prompt('Enter preset name to load:');
    if (name) {
      const presetData = localStorage.getItem(`caption-preset-${name}`);
      if (presetData) {
        const preset = JSON.parse(presetData);
        stylingSystem.importPreset(preset);
        alert(`Preset "${name}" loaded!`);

        // Update UI to reflect loaded preset
        updateUIFromStyle();
      } else {
        alert(`Preset "${name}" not found.`);
      }
    }
  });

  // Apply style
  applyStyleBtn.addEventListener('click', async () => {
    const style = stylingSystem.getStyle();
    console.log('Applying style to captions:', style);

    // This would integrate with the main SPLICE plugin
    // For now, just show confirmation
    alert('Style applied! (Integration with main plugin pending)');

    // TODO: Send style to main plugin
    // await applyCaptionStyle(style);
  });
}

/**
 * Update UI controls from current style
 */
function updateUIFromStyle() {
  const style = stylingSystem.currentStyle;

  // Font
  document.getElementById('font-fill-type').value = style.font.fillType;
  document.getElementById('font-size').value = style.font.size;
  document.getElementById('font-family').value = style.font.family;
  document.getElementById('font-gradient-angle').value = style.font.gradient.angle;
  document.getElementById('font-gradient-angle-value').textContent = style.font.gradient.angle;

  // Show/hide font groups
  if (style.font.fillType === 'gradient') {
    document.getElementById('font-solid-group').style.display = 'none';
    document.getElementById('font-gradient-group').style.display = 'block';
  } else {
    document.getElementById('font-solid-group').style.display = 'block';
    document.getElementById('font-gradient-group').style.display = 'none';
  }

  // Outline
  document.getElementById('outline-enabled').checked = style.outline.enabled;
  document.getElementById('outline-controls').style.display = style.outline.enabled ? 'block' : 'none';
  document.getElementById('outline-width').value = style.outline.width;
  document.getElementById('outline-width-value').textContent = style.outline.width;

  // Box
  document.getElementById('box-enabled').checked = style.box.enabled;
  document.getElementById('box-controls').style.display = style.box.enabled ? 'block' : 'none';
  document.getElementById('box-fill-type').value = style.box.fillType;
  document.getElementById('box-padding').value = style.box.padding;
  document.getElementById('box-padding-value').textContent = style.box.padding;
  document.getElementById('box-border-radius').value = style.box.borderRadius;
  document.getElementById('box-border-radius-value').textContent = style.box.borderRadius;

  // Show/hide box groups
  if (style.box.fillType === 'gradient') {
    document.getElementById('box-solid-group').style.display = 'none';
    document.getElementById('box-gradient-group').style.display = 'block';
  } else {
    document.getElementById('box-solid-group').style.display = 'block';
    document.getElementById('box-gradient-group').style.display = 'none';
  }

  // Shadow
  document.getElementById('shadow-enabled').checked = style.shadow.enabled;
  document.getElementById('shadow-controls').style.display = style.shadow.enabled ? 'block' : 'none';
  document.getElementById('shadow-blur').value = style.shadow.blur;
  document.getElementById('shadow-blur-value').textContent = style.shadow.blur;
  document.getElementById('shadow-offset-x').value = style.shadow.offsetX;
  document.getElementById('shadow-offset-x-value').textContent = style.shadow.offsetX;
  document.getElementById('shadow-offset-y').value = style.shadow.offsetY;
  document.getElementById('shadow-offset-y-value').textContent = style.shadow.offsetY;

  // Animation
  document.getElementById('animation-type').value = style.animation.type;

  // Chapter
  document.getElementById('chapter-font-size').value = style.chapter.fontSize;

  // Update preview
  stylingSystem.updatePreview();
}

// Export for use in main plugin
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { stylingSystem, updateUIFromStyle };
}
