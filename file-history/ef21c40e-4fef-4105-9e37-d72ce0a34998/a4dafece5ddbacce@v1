/**
 * ColorPicker - Simple color picker component for UXP
 * Lightweight alternative to Pickr for Adobe UXP environment
 */
class ColorPicker {
  /**
   * @param {Object} options - Configuration options
   */
  constructor(options = {}) {
    this.options = {
      default: '#FFFFFF',
      swatches: [
        '#FF0000', '#00FF00', '#0000FF',
        '#FFFF00', '#FF00FF', '#00FFFF',
        '#000000', '#FFFFFF', '#808080'
      ],
      showOpacity: true,
      showSwatches: true,
      onChange: null,
      onSave: null,
      ...options
    };

    this.currentColor = this.options.default;
    this.element = null;
    this.isOpen = false;
  }

  /**
   * Create and return the color picker element
   * @param {string} containerId - ID of container element
   * @returns {HTMLElement} Color picker element
   */
  create(containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
      throw new Error(`Container ${containerId} not found`);
    }

    // Create color picker button
    const button = document.createElement('button');
    button.className = 'color-picker-button';
    button.style.backgroundColor = this.currentColor;
    button.title = 'Click to change color';

    // Create picker panel (hidden by default)
    const panel = document.createElement('div');
    panel.className = 'color-picker-panel';
    panel.style.display = 'none';

    // Hex input
    const hexInput = document.createElement('input');
    hexInput.type = 'text';
    hexInput.className = 'color-picker-hex';
    hexInput.value = this.currentColor;
    hexInput.placeholder = '#RRGGBB';

    // RGB sliders
    const rgbContainer = document.createElement('div');
    rgbContainer.className = 'color-picker-rgb';

    const rgb = this.hexToRgb(this.currentColor);

    const createSlider = (label, value, max = 255) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'slider-wrapper';

      const labelEl = document.createElement('label');
      labelEl.textContent = label;

      const slider = document.createElement('input');
      slider.type = 'range';
      slider.min = '0';
      slider.max = max.toString();
      slider.value = value.toString();
      slider.className = 'color-slider';

      const valueEl = document.createElement('span');
      valueEl.className = 'slider-value';
      valueEl.textContent = value;

      slider.addEventListener('input', (e) => {
        valueEl.textContent = e.target.value;
        this.updateColorFromSliders();
      });

      wrapper.appendChild(labelEl);
      wrapper.appendChild(slider);
      wrapper.appendChild(valueEl);

      return { wrapper, slider };
    };

    const rSlider = createSlider('R', rgb.r);
    const gSlider = createSlider('G', rgb.g);
    const bSlider = createSlider('B', rgb.b);

    rgbContainer.appendChild(rSlider.wrapper);
    rgbContainer.appendChild(gSlider.wrapper);
    rgbContainer.appendChild(bSlider.wrapper);

    // Opacity slider (if enabled)
    let aSlider = null;
    if (this.options.showOpacity) {
      aSlider = createSlider('A', Math.round((rgb.a || 1) * 100), 100);
      rgbContainer.appendChild(aSlider.wrapper);
    }

    // Swatches
    const swatchesContainer = document.createElement('div');
    swatchesContainer.className = 'color-picker-swatches';

    if (this.options.showSwatches) {
      this.options.swatches.forEach(color => {
        const swatch = document.createElement('button');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = color;
        swatch.title = color;
        swatch.addEventListener('click', () => {
          this.setColor(color);
        });
        swatchesContainer.appendChild(swatch);
      });
    }

    // Action buttons
    const actions = document.createElement('div');
    actions.className = 'color-picker-actions';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Save';
    saveBtn.className = 'btn-primary';
    saveBtn.addEventListener('click', () => {
      this.save();
      this.close();
    });

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.className = 'btn-secondary';
    cancelBtn.addEventListener('click', () => {
      this.close();
    });

    actions.appendChild(saveBtn);
    actions.appendChild(cancelBtn);

    // Assemble panel
    panel.appendChild(hexInput);
    panel.appendChild(rgbContainer);
    panel.appendChild(swatchesContainer);
    panel.appendChild(actions);

    // Assemble picker
    container.appendChild(button);
    container.appendChild(panel);

    // Event listeners
    button.addEventListener('click', () => {
      this.toggle();
    });

    hexInput.addEventListener('input', (e) => {
      const hex = e.target.value;
      if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
        this.setColor(hex);
      }
    });

    // Store references
    this.element = container;
    this.button = button;
    this.panel = panel;
    this.hexInput = hexInput;
    this.rSlider = rSlider.slider;
    this.gSlider = gSlider.slider;
    this.bSlider = bSlider.slider;
    this.aSlider = aSlider ? aSlider.slider : null;

    return container;
  }

  /**
   * Update color from RGB sliders
   */
  updateColorFromSliders() {
    const r = parseInt(this.rSlider.value);
    const g = parseInt(this.gSlider.value);
    const b = parseInt(this.bSlider.value);
    const a = this.aSlider ? parseInt(this.aSlider.value) / 100 : 1;

    const hex = this.rgbToHex(r, g, b, a);
    this.setColor(hex, false); // Don't update sliders (avoid loop)
  }

  /**
   * Set the current color
   * @param {string} color - Hex color
   * @param {boolean} updateSliders - Update slider values
   */
  setColor(color, updateSliders = true) {
    this.currentColor = color;
    this.button.style.backgroundColor = color;
    this.hexInput.value = color;

    if (updateSliders) {
      const rgb = this.hexToRgb(color);
      this.rSlider.value = rgb.r;
      this.gSlider.value = rgb.g;
      this.bSlider.value = rgb.b;
      if (this.aSlider) {
        this.aSlider.value = Math.round(rgb.a * 100);
      }

      // Update value displays
      this.rSlider.nextElementSibling.textContent = rgb.r;
      this.gSlider.nextElementSibling.textContent = rgb.g;
      this.bSlider.nextElementSibling.textContent = rgb.b;
      if (this.aSlider) {
        this.aSlider.nextElementSibling.textContent = Math.round(rgb.a * 100);
      }
    }

    // Trigger onChange callback
    if (this.options.onChange) {
      this.options.onChange(color);
    }
  }

  /**
   * Get the current color
   * @returns {string} Current hex color
   */
  getColor() {
    return this.currentColor;
  }

  /**
   * Save the current color
   */
  save() {
    if (this.options.onSave) {
      this.options.onSave(this.currentColor);
    }
  }

  /**
   * Open the picker panel
   */
  open() {
    this.panel.style.display = 'block';
    this.isOpen = true;
  }

  /**
   * Close the picker panel
   */
  close() {
    this.panel.style.display = 'none';
    this.isOpen = false;
  }

  /**
   * Toggle the picker panel
   */
  toggle() {
    if (this.isOpen) {
      this.close();
    } else {
      this.open();
    }
  }

  /**
   * Destroy the picker
   */
  destroy() {
    if (this.element) {
      this.element.innerHTML = '';
      this.element = null;
    }
  }

  /**
   * Convert hex to RGB
   * @param {string} hex - Hex color
   * @returns {Object} RGB object
   */
  hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i.exec(hex);
    if (!result) return { r: 255, g: 255, b: 255, a: 1 };

    return {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16),
      a: result[4] ? parseInt(result[4], 16) / 255 : 1
    };
  }

  /**
   * Convert RGB to hex
   * @param {number} r - Red (0-255)
   * @param {number} g - Green (0-255)
   * @param {number} b - Blue (0-255)
   * @param {number} a - Alpha (0-1)
   * @returns {string} Hex color
   */
  rgbToHex(r, g, b, a = 1) {
    const toHex = (n) => {
      const hex = Math.round(n).toString(16);
      return hex.length === 1 ? '0' + hex : hex;
    };

    let hex = '#' + toHex(r) + toHex(g) + toHex(b);

    if (a < 1) {
      hex += toHex(a * 255);
    }

    return hex;
  }
}

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
  module.exports = ColorPicker;
}
