/**
 * Slice 5: GPT-4o-mini Take Detection Service
 *
 * Analyzes transcripts to identify distinct takes (repeated attempts).
 * Uses GPT-4o-mini for intelligent content analysis.
 */

const OpenAI = require('openai');

// Initialize OpenAI client
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

/**
 * Build the take detection prompt
 * @param {string} segmentsText - Formatted transcript segments
 * @returns {string} The prompt for GPT
 */
function buildPrompt(segmentsText) {
  return `Analyze this video transcript and identify distinct "takes" (repeated attempts at the same content).

Look for:
- Explicit markers: "take 1", "take 2", "cut", "again", "one more time"
- Content repetition: same lines delivered multiple times
- Natural breaks: long pauses, restarts, or topic shifts that indicate a new attempt

TRANSCRIPT WITH TIMESTAMPS:
${segmentsText}

Respond with JSON only (no markdown):
{
  "takes": [
    {
      "takeNumber": 1,
      "start": 0.00,
      "end": 10.50,
      "description": "Brief description of this take",
      "isBest": false,
      "reason": "Why this is/isn't the best take"
    }
  ],
  "analysis": "Brief overall analysis of the recording"
}

If no distinct takes are found (continuous recording), return a single take covering the full duration.`;
}

/**
 * Format transcript segments for the prompt
 * @param {Array} segments - Transcript segments with timestamps
 * @returns {string} Formatted text
 */
function formatSegments(segments) {
  return segments
    .map(s => `[${s.start.toFixed(2)}-${s.end.toFixed(2)}] ${s.text}`)
    .join('\n');
}

/**
 * Create fallback response when parsing fails
 * @param {number} duration - Total duration of the recording
 * @returns {Object} Fallback takes response
 */
function createFallbackResponse(duration) {
  return {
    takes: [{
      takeNumber: 1,
      start: 0,
      end: duration || 0,
      description: 'Full recording (parsing failed)',
      isBest: true,
      reason: 'Single continuous take'
    }],
    analysis: 'Could not parse take detection response'
  };
}

/**
 * Detect takes in a transcript using GPT-4o-mini
 * @param {Object} transcript - Transcript with segments and duration
 * @returns {Promise<{takes: Array, analysis: string}>}
 */
async function detectTakes(transcript) {
  console.log('[SPLICE] Starting GPT-4o-mini take detection...');

  const segmentsText = formatSegments(transcript.segments);
  const prompt = buildPrompt(segmentsText);

  const response = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [{ role: 'user', content: prompt }],
    temperature: 0.3,
  });

  const content = response.choices[0].message.content;
  console.log('[SPLICE] Take detection complete');

  try {
    return JSON.parse(content);
  } catch {
    console.error('[SPLICE] Failed to parse GPT response:', content);
    return createFallbackResponse(transcript.duration);
  }
}

module.exports = { detectTakes };
