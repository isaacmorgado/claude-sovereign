# Splice v3

Cloud-powered SaaS for Adobe Premiere Pro with AI-driven auto-cutting, take detection, and subscription billing.

## Monorepo Structure

```
/                         # Root
├── src/                  # Premiere Pro UXP Plugin
│   ├── components/
│   │   ├── panels/       # PluginApp (main container)
│   │   └── common/       # UI: Header, SelectionPanel, AIToolsPanel, AuthPanel, CuttingPanel
│   ├── types/            # TypeScript: plugin, api, premiere, audio, take-detection
│   ├── utils/
│   │   ├── api/          # premiere.ts, backend-client.ts, audio-processor.ts
│   │   └── helpers/      # formatters, validators
│   └── styles/           # Global CSS, Spectrum theming
│
├── backend/              # Node.js + Express API
│   └── src/
│       ├── routes/       # auth, billing, jobs, audio, usage
│       ├── controllers/  # Route handlers
│       ├── services/     # Business logic
│       ├── workers/      # BullMQ job processors (transcription, vocal isolation)
│       ├── db/           # migrations/, repositories/
│       └── middleware/   # auth, rate-limit, usage-limit
│
├── dashboard/            # Next.js Web Dashboard
│   └── app/              # login, signup, dashboard (usage, billing, settings)
│
├── tests/                # Vitest unit + Playwright e2e
└── public/               # manifest.json, icons
```

## Tech Stack

| Layer     | Stack                                                             |
| --------- | ----------------------------------------------------------------- |
| Plugin    | Lit 3.2 + Spectrum Web Components + TypeScript                    |
| Backend   | Node.js + Express + PostgreSQL + BullMQ/Redis                     |
| Dashboard | Next.js + React                                                   |
| Audio     | Whisper/Deepgram (transcription) + Demucs/Dolby (vocal isolation) |
| Payments  | Stripe                                                            |

## Code Quality - Zero Tolerance

After editing ANY file, run:

```bash
npm run lint
npm run typecheck
```

Fix ALL errors/warnings before continuing.

## Organization Rules

- **Plugin components** → `src/components/`, one per file
- **Backend routes** → `backend/src/routes/`, one per resource
- **Types** → `src/types/` or `backend/src/types/`, grouped by domain
- **Tests** → `tests/unit/` and `tests/e2e/`
- **Max file length: 300 lines** — Split into separate modules when exceeded

## UXP API Constraints

**Available:** `createSetNameAction`, `createInsertProjectItemAction`, `createRemoveItemsAction`, `createSetInPointAction/OutPointAction`, `ProjectItem.setColorLabel`

**NOT Available:** Razor/split (use remove+re-insert workaround), TrackItem colors (set on ProjectItem before insert), Audio waveforms (use FFmpeg externally)

## Pricing Tiers

| Plan       | Monthly   | Yearly (17% off) | Limit        |
| ---------- | --------- | ---------------- | ------------ |
| Free Trial | $0        | —                | 10 min total |
| Pro        | $29.99/mo | $298.70/yr       | 300 min/mo   |
| Enterprise | $69.99/mo | $697.10/yr       | 500 min/mo   |

## Stripe Configuration

| Item               | Value                            |
| ------------------ | -------------------------------- |
| Pro Monthly        | `price_1Sf3te2L5BseYEbCr6dUdwrD` |
| Pro Yearly         | `price_1Sf3vE2L5BseYEbC2v1whC72` |
| Enterprise Monthly | `price_1Sf3tg2L5BseYEbCMkv9AgVD` |
| Enterprise Yearly  | `price_1Sf3vG2L5BseYEbCkACPluoj` |

## Current Focus

Section: Phase 1 - Backend (audio processing complete, dashboard next)
Files: `dashboard/` (Next.js app to be created)

## Last Session (2025-12-16)

- Built complete audio processing system:
  - Created audio types (`backend/src/types/audio.ts`)
  - Created audio repository (`backend/src/db/repositories/audio-repository.ts`)
  - Created database migration for audio_jobs table
  - Created audio service with BullMQ queue integration (`backend/src/services/audio-service.ts`)
  - Created transcription worker with Deepgram/Whisper support
  - Created vocal isolation worker with Dolby/Demucs support
  - Created audio controller and routes (`/api/audio/*`)
  - Added `invoice.paid` webhook handler to reset usage on billing renewal
  - Integrated `recordUsage()` calls after job completion
- All lint and typecheck passes

## Audio API Endpoints

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/api/audio/check?minutes=N` | GET | Required | Pre-flight check if user can submit job |
| `/api/audio/jobs` | GET | Required | List user's audio jobs |
| `/api/audio/jobs/:jobId` | GET | Required | Get specific job status |
| `/api/audio/transcribe` | POST | Required | Submit transcription job |
| `/api/audio/isolate-vocals` | POST | Required | Submit vocal isolation job |

## Environment Variables (New)

```
DEEPGRAM_API_KEY=     # For cloud transcription
DOLBY_API_KEY=        # For vocal isolation
WHISPER_API_URL=      # Self-hosted Whisper (optional)
DEMUCS_API_URL=       # Self-hosted Demucs (optional)
```

## Next Steps

1. Run database migration: `npm run migrate up` in backend/
2. Build Next.js dashboard (`dashboard/app/`)
3. Create plugin backend client to call audio APIs
4. Add file upload support for audio (S3 or similar)
5. Add job progress notifications (WebSocket or polling)
