'use client';

import React, { useState, useEffect } from 'react';
import {
    PaymentElement,
    useStripe,
    useElements
} from '@stripe/react-stripe-js';
import { Loader2, Lock, ShieldCheck, AlertCircle } from 'lucide-react';
import { motion } from 'framer-motion';

interface CheckoutFormProps {
    amount: number;
    planName: string;
    isDemoMode?: boolean;
}

export const CheckoutForm: React.FC<CheckoutFormProps> = ({ amount, planName, isDemoMode = false }) => {
    const stripe = useStripe();
    const elements = useElements();

    const [message, setMessage] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [paymentSuccess, setPaymentSuccess] = useState(false);

    useEffect(() => {
        if (!stripe && !isDemoMode) {
            return;
        }

        if (!isDemoMode && stripe) {
            const clientSecret = new URLSearchParams(window.location.search).get(
                'payment_intent_client_secret'
            );

            if (!clientSecret) {
                return;
            }

            stripe.retrievePaymentIntent(clientSecret).then(({ paymentIntent }) => {
                switch (paymentIntent?.status) {
                    case 'succeeded':
                        setMessage('Payment succeeded!');
                        setPaymentSuccess(true);
                        break;
                    case 'processing':
                        setMessage('Your payment is processing.');
                        break;
                    case 'requires_payment_method':
                        setMessage('Your payment was not successful, please try again.');
                        break;
                    default:
                        setMessage('Something went wrong.');
                        break;
                }
            });
        }
    }, [stripe, isDemoMode]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        if (isDemoMode) {
            setIsLoading(true);
            // Simulate API call
            setTimeout(() => {
                setIsLoading(false);
                setPaymentSuccess(true);
                // Redirect to success page after a short delay
                setTimeout(() => {
                    window.location.href = '/success?demo=true';
                }, 1500);
            }, 2000);
            return;
        }

        if (!stripe || !elements) {
            // Stripe.js has not yet loaded.
            return;
        }

        setIsLoading(true);

        const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: {
                // Make sure to change this to your payment completion page
                return_url: `${window.location.origin}/success`,
            },
        });

        // This point will only be reached if there is an immediate error when
        // confirming the payment. Otherwise, your customer will be redirected to
        // your `return_url`.
        if (error.type === 'card_error' || error.type === 'validation_error') {
            setMessage(error.message || 'An unexpected error occurred.');
        } else {
            setMessage('An unexpected error occurred.');
        }

        setIsLoading(false);
    };

    if (paymentSuccess) {
        return (
            <div className="text-center py-12">
                <motion.div
                    initial={{ scale: 0.8, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6"
                >
                    <ShieldCheck size={32} className="text-black" />
                </motion.div>
                <h3 className="text-2xl font-black italic text-white mb-2 uppercase">Payment Successful</h3>
                <p className="text-neutral-400 text-sm mb-6">Your upgrade to {planName} is complete.</p>
                <div className="text-xs font-mono text-neutral-600">REDIRECTING TO DASHBOARD...</div>
            </div>
        );
    }

    return (
        <form id="payment-form" onSubmit={handleSubmit} className="space-y-6">
            {isDemoMode && (
                <div className="p-4 bg-amber-500/10 border border-amber-500/20 rounded-xl flex items-start gap-3">
                    <AlertCircle className="text-amber-500 shrink-0 mt-0.5" size={16} />
                    <div>
                        <h4 className="text-xs font-black uppercase text-amber-500 mb-1">Demo Mode Active</h4>
                        <p className="text-[10px] text-amber-200/70">
                            No actual payment will be processed. Click &ldquo;Pay Now&rdquo; to simulate a successful transaction.
                        </p>
                    </div>
                </div>
            )}

            {isDemoMode ? (
                // Mock Fields for Demo Mode
                <div className="space-y-4 opacity-50 pointer-events-none grayscale">
                    <div className="p-4 rounded-xl border border-white/10 bg-neutral-900/50">
                        <div className="h-4 w-32 bg-white/10 rounded mb-4" />
                        <div className="h-10 w-full bg-white/5 rounded border border-white/5" />
                    </div>
                </div>
            ) : (
                <PaymentElement id="payment-element" options={{ layout: 'tabs' }} />
            )}

            {message && (
                <div id="payment-message" className="text-red-400 text-sm font-bold bg-red-500/10 p-3 rounded-lg border border-red-500/20">
                    {message}
                </div>
            )}

            <button
                disabled={isLoading || (!stripe && !isDemoMode) || (!elements && !isDemoMode)}
                id="submit"
                className="w-full py-4 bg-cyan-500 hover:bg-cyan-400 text-black font-black uppercase tracking-widest rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 group"
            >
                {isLoading ? (
                    <Loader2 className="animate-spin" size={20} />
                ) : (
                    <>
                        <Lock size={16} className="group-hover:hidden transition-all" />
                        <span className="hidden group-hover:inline transition-all">Secure Checkout</span>
                        <span>Pay ${amount}</span>
                    </>
                )}
            </button>

            <div className="flex items-center justify-center gap-2 text-[10px] text-neutral-600 font-bold uppercase tracking-widest">
                <ShieldCheck size={12} />
                256-Bit SSL Encrypted
            </div>
        </form>
    );
};
