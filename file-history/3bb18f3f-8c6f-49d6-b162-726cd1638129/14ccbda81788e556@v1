/**
 * Forum Types - Matches backend Pydantic schemas
 */

// === ENUMS ===

export type VoteType = 'up' | 'down';

export type TargetType = 'post' | 'comment';

export type ReportReason =
  | 'spam'
  | 'harassment'
  | 'misinformation'
  | 'off_topic'
  | 'inappropriate'
  | 'other';

export type SortOrder = 'hot' | 'new' | 'top';

// === SUB-FORUM ===

export interface SubForum {
  id: string;
  name: string;
  slug: string;
  description: string | null;
  icon: string | null;
  displayOrder: number;
  postCount: number;
}

// === CATEGORY ===

export interface Category {
  id: string;
  name: string;
  slug: string;
  description: string | null;
  icon: string | null;
  displayOrder: number;
  postCount: number;
  subForums: SubForum[];
}

export interface CategoryListItem {
  id: string;
  name: string;
  slug: string;
  description: string | null;
  icon: string | null;
  displayOrder: number;
  postCount: number;
}

// === POST ===

export interface PostAuthor {
  id: string;
  username: string;
  karma?: number;  // Optional karma for display
}

export interface Post {
  id: string;
  title: string;
  content: string;
  subForumId: string;
  subForumSlug: string;
  categorySlug: string;
  author: PostAuthor;
  isPinned: boolean;
  isGuide: boolean;
  voteCount: number;
  commentCount: number;
  userVote: VoteType | null;
  createdAt: string;
  updatedAt: string;
}

export interface PostListItem {
  id: string;
  title: string;
  contentPreview: string;
  subForumSlug: string;
  categorySlug: string;
  author: PostAuthor;
  isPinned: boolean;
  isGuide: boolean;
  voteCount: number;
  commentCount: number;
  userVote: VoteType | null;
  createdAt: string;
}

export interface PostListResponse {
  posts: PostListItem[];
  totalCount: number;
  hasMore: boolean;
}

// === CURSOR PAGINATION ===

export interface CursorPaginatedPostListResponse {
  posts: PostListItem[];
  nextCursor: string | null;
  hasMore: boolean;
  totalCount?: number;  // Optional - expensive to compute
}

export interface PostCreate {
  title: string;
  content: string;
  subForumId: string;
}

export interface PostUpdate {
  title?: string;
  content?: string;
}

// === COMMENT ===

export interface Comment {
  id: string;
  content: string;
  postId: string;
  author: PostAuthor;
  parentId: string | null;
  voteCount: number;
  userVote: VoteType | null;
  depth: number;
  replies: Comment[];
  createdAt: string;
  updatedAt: string;
}

export interface CommentCreate {
  content: string;
  parentId?: string;
}

export interface CommentUpdate {
  content: string;
}

export interface PaginatedCommentsResponse {
  comments: Comment[];
  totalRootComments: number;
  hasMore: boolean;
  nextOffset: number | null;
}

export interface CommentRepliesResponse {
  replies: Comment[];
  hasMore: boolean;
  totalReplies: number;
}

// === VOTE ===

export interface VoteRequest {
  voteType: VoteType;
}

export interface VoteResponse {
  success: boolean;
  newVoteCount: number;
  userVote: VoteType | null;
}

// === REPORT ===

export interface ReportCreate {
  targetType: TargetType;
  targetId: string;
  reason: ReportReason;
  details?: string;
}

export interface Report {
  id: string;
  targetType: TargetType;
  targetId: string;
  reason: ReportReason;
  status: string;
  createdAt: string;
}

// === GUIDES SECTION ===

export interface GuideSection {
  category: CategoryListItem;
  guides: PostListItem[];
}

// === RECOMMENDED FORUMS ===

export interface RecommendedForum {
  category: CategoryListItem;
  matchedFlaws: string[];
  priority: number;
}

// === SEARCH ===

export type SearchResultType = 'post' | 'comment';

export interface ForumSearchResult {
  id: string;
  type: SearchResultType;
  title: string | null;  // Only for posts
  contentPreview: string;
  postId: string | null;  // Only for comments
  postTitle: string | null;  // Only for comments
  author: PostAuthor;
  voteCount: number;
  categorySlug: string;
  subForumSlug: string;
  createdAt: string;
}

export interface ForumSearchResponse {
  results: ForumSearchResult[];
  totalCount: number;
  query: string;
  searchType: string;
  hasMore: boolean;
}

// === USER PROFILE ===

export interface ForumUserProfile {
  id: string;
  username: string;
  forumPostsCount: number;
  forumCommentsCount: number;
  forumKarma: number;
  memberSince: string;
}

export interface UserPostItem {
  id: string;
  title: string;
  contentPreview: string;
  subForumSlug: string;
  categorySlug: string;
  isPinned: boolean;
  isGuide: boolean;
  voteCount: number;
  commentCount: number;
  userVote: VoteType | null;
  createdAt: string;
}

export interface UserPostListResponse {
  posts: UserPostItem[];
  totalCount: number;
  hasMore: boolean;
}

export interface UserCommentItem {
  id: string;
  content: string;
  postId: string;
  postTitle: string;
  categorySlug: string;
  voteCount: number;
  userVote: VoteType | null;
  createdAt: string;
}

export interface UserCommentListResponse {
  comments: UserCommentItem[];
  totalCount: number;
  hasMore: boolean;
}

// === BOOKMARK TYPES ===

export interface BookmarkToggleResponse {
  isBookmarked: boolean;
  message: string;
}

export interface BookmarkStatus {
  postId: string;
  isBookmarked: boolean;
  bookmarkedAt: string | null;
}

export interface BookmarkedPostsResponse {
  posts: PostListItem[];
  totalCount: number;
  hasMore: boolean;
}

// === ADMIN/MODERATION TYPES ===

export type ReportStatusEnum = 'pending' | 'reviewed' | 'resolved' | 'dismissed';

export type ActionTaken = 'content_removed' | 'user_warned' | 'user_banned' | 'no_action';

export interface ReportDetail {
  id: string;
  targetType: TargetType;
  targetId: string;
  reason: ReportReason;
  details: string | null;
  status: ReportStatusEnum;
  reporterId: string;
  reporterUsername: string;
  reviewedBy: string | null;
  reviewedAt: string | null;
  resolutionNotes: string | null;
  actionTaken: ActionTaken | null;
  createdAt: string;
  // Denormalized content for preview
  contentPreview: string | null;
  contentAuthorId: string | null;
  contentAuthorUsername: string | null;
}

export interface AdminReportListResponse {
  reports: ReportDetail[];
  totalCount: number;
  hasMore: boolean;
}

export interface ResolveReportRequest {
  status: ReportStatusEnum;
  resolutionNotes?: string;
  actionTaken?: ActionTaken;
}

export interface ModerationStats {
  pendingReports: number;
  resolvedToday: number;
  resolvedThisWeek: number;
  totalReports: number;
  reportsByReason: Record<string, number>;
  reportsByStatus: Record<string, number>;
}

export interface BanUserRequest {
  reason?: string;
}

export interface BanUserResponse {
  userId: string;
  username: string;
  isBanned: boolean;
  message: string;
}

export interface BannedUser {
  id: string;
  username: string;
  email: string;
  isBanned: boolean;
  createdAt: string | null;
  updatedAt: string | null;
}

export interface BannedUsersResponse {
  users: BannedUser[];
  totalCount: number;
  hasMore: boolean;
}

// === KARMA LEADERBOARD TYPES ===

export type KarmaTier = 'bronze' | 'silver' | 'gold' | 'platinum' | 'diamond';

export interface KarmaLeaderboardEntry {
  rank: number;
  userId: string;
  username: string;
  forumKarma: number;
  forumPostsCount: number;
  forumCommentsCount: number;
}

export interface KarmaLeaderboardResponse {
  entries: KarmaLeaderboardEntry[];
  totalCount: number;
  hasMore: boolean;
}

// === KARMA UTILITIES ===

/**
 * Karma tier thresholds:
 * - Bronze: 0-99
 * - Silver: 100-499
 * - Gold: 500-999
 * - Platinum: 1000-4999
 * - Diamond: 5000+
 */
export function getKarmaTier(karma: number): KarmaTier {
  if (karma >= 5000) return 'diamond';
  if (karma >= 1000) return 'platinum';
  if (karma >= 500) return 'gold';
  if (karma >= 100) return 'silver';
  return 'bronze';
}

export function getKarmaTierColor(tier: KarmaTier): string {
  switch (tier) {
    case 'diamond': return 'text-cyan-300';
    case 'platinum': return 'text-purple-400';
    case 'gold': return 'text-amber-400';
    case 'silver': return 'text-neutral-300';
    case 'bronze': return 'text-amber-600';
    default: return 'text-neutral-400';
  }
}

export function getKarmaTierBgColor(tier: KarmaTier): string {
  switch (tier) {
    case 'diamond': return 'bg-cyan-500/10 border-cyan-500/20';
    case 'platinum': return 'bg-purple-500/10 border-purple-500/20';
    case 'gold': return 'bg-amber-500/10 border-amber-500/20';
    case 'silver': return 'bg-neutral-400/10 border-neutral-400/20';
    case 'bronze': return 'bg-amber-700/10 border-amber-700/20';
    default: return 'bg-neutral-500/10 border-neutral-500/20';
  }
}

export function getKarmaTierLabel(tier: KarmaTier): string {
  switch (tier) {
    case 'diamond': return 'Diamond';
    case 'platinum': return 'Platinum';
    case 'gold': return 'Gold';
    case 'silver': return 'Silver';
    case 'bronze': return 'Bronze';
    default: return 'Bronze';
  }
}

// === QUOTA TYPES ===

export interface ForumQuota {
  postsUsed: number;
  postsMax: number | null;  // null = unlimited
  commentsUsed: number;
  commentsMax: number | null;  // null = unlimited
  resetsAt: string;  // ISO datetime string
}

// === ANALYTICS TYPES ===

export interface DailyMetric {
  date: string;  // YYYY-MM-DD
  count: number;
}

export interface TopContributor {
  userId: string;
  username: string;
  forumKarma: number;
  postsCount: number;
  commentsCount: number;
}

export interface CategoryEngagement {
  categoryId: string;
  categoryName: string;
  categorySlug: string;
  postsCount: number;
  commentsCount: number;
  totalVotes: number;
}

export interface ForumAnalytics {
  // Time-series data (last 30 days)
  postsPerDay: DailyMetric[];
  commentsPerDay: DailyMetric[];

  // Aggregate metrics
  totalPosts: number;
  totalComments: number;
  totalVotes: number;
  avgVotesPerPost: number;
  avgCommentsPerPost: number;

  // User metrics
  activeUsersToday: number;
  activeUsersWeek: number;
  activeUsersMonth: number;
  totalUsers: number;

  // Top contributors
  topContributors: TopContributor[];

  // Category breakdown
  categoryEngagement: CategoryEngagement[];

  // Generated timestamp
  generatedAt: string;
}
