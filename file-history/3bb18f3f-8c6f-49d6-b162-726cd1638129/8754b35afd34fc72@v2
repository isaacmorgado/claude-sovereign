'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { ForumHeader } from '@/components/forum';
import { KarmaBadge } from '@/components/forum/KarmaBadge';
import { api } from '@/lib/api';
import { KarmaLeaderboardEntry, getKarmaTier, getKarmaTierColor } from '@/types/forum';
import {
  Trophy,
  Crown,
  Medal,
  Star,
  ArrowLeft,
  Loader2,
  TrendingUp,
} from 'lucide-react';

// ============================================
// RANK BADGE
// ============================================
function RankBadge({ rank }: { rank: number }) {
  if (rank === 1) {
    return (
      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center shadow-lg shadow-amber-500/20">
        <Crown size={24} className="text-white" />
      </div>
    );
  }
  if (rank === 2) {
    return (
      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-neutral-300 to-neutral-500 flex items-center justify-center shadow-lg shadow-neutral-400/20">
        <Medal size={24} className="text-white" />
      </div>
    );
  }
  if (rank === 3) {
    return (
      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-600 to-amber-800 flex items-center justify-center shadow-lg shadow-amber-700/20">
        <Star size={24} className="text-white" />
      </div>
    );
  }
  return (
    <div className="w-12 h-12 rounded-xl bg-neutral-800/50 border border-neutral-700/50 flex items-center justify-center">
      <span className="text-lg font-black text-neutral-500">{rank}</span>
    </div>
  );
}

// ============================================
// LEADERBOARD ENTRY
// ============================================
function LeaderboardEntry({ entry, index }: { entry: KarmaLeaderboardEntry; index: number }) {
  const tier = getKarmaTier(entry.forumKarma);
  const tierColor = getKarmaTierColor(tier);
  const isTopThree = entry.rank <= 3;

  return (
    <motion.div
      initial={{ opacity: 0, x: -20 }}
      animate={{ opacity: 1, x: 0 }}
      transition={{ delay: index * 0.03 }}
    >
      <Link
        href={`/forum/user/${entry.userId}`}
        className={`group flex items-center gap-4 p-4 rounded-2xl border transition-all ${
          isTopThree
            ? 'bg-neutral-900/50 border-white/10 hover:border-cyan-500/30'
            : 'bg-neutral-900/30 border-white/5 hover:border-white/10'
        }`}
      >
        {/* Rank */}
        <RankBadge rank={entry.rank} />

        {/* User info */}
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 mb-1">
            <span className={`font-bold group-hover:text-cyan-400 transition-colors truncate ${
              isTopThree ? 'text-white text-lg' : 'text-neutral-300'
            }`}>
              u/{entry.username}
            </span>
            <KarmaBadge karma={entry.forumKarma} size={isTopThree ? 'sm' : 'xs'} />
          </div>
          <div className="flex items-center gap-4 text-xs text-neutral-600">
            <span>{entry.forumPostsCount} posts</span>
            <span>{entry.forumCommentsCount} comments</span>
          </div>
        </div>

        {/* Karma */}
        <div className="text-right">
          <p className={`text-2xl font-black italic ${tierColor}`}>
            {entry.forumKarma.toLocaleString()}
          </p>
          <p className="text-[9px] font-black uppercase tracking-widest text-neutral-600">
            karma
          </p>
        </div>
      </Link>
    </motion.div>
  );
}

// ============================================
// SKELETON LOADER
// ============================================
function LeaderboardSkeleton() {
  return (
    <div className="space-y-3">
      {[...Array(10)].map((_, i) => (
        <div
          key={i}
          className="flex items-center gap-4 p-4 rounded-2xl bg-neutral-900/30 border border-white/5 animate-pulse"
        >
          <div className="w-12 h-12 rounded-xl bg-neutral-800" />
          <div className="flex-1">
            <div className="h-4 w-32 bg-neutral-800 rounded mb-2" />
            <div className="h-3 w-24 bg-neutral-800/50 rounded" />
          </div>
          <div className="text-right">
            <div className="h-6 w-16 bg-neutral-800 rounded mb-1" />
            <div className="h-2 w-10 bg-neutral-800/50 rounded" />
          </div>
        </div>
      ))}
    </div>
  );
}

// ============================================
// MAIN PAGE
// ============================================
export default function ForumLeaderboardPage() {
  const [entries, setEntries] = useState<KarmaLeaderboardEntry[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchLeaderboard = async () => {
      try {
        setIsLoading(true);
        const response = await api.getKarmaLeaderboard({ limit: 50 });
        setEntries(response.entries);
      } catch (err) {
        console.error('Failed to load karma leaderboard:', err);
        setError('Failed to load leaderboard');
      } finally {
        setIsLoading(false);
      }
    };

    fetchLeaderboard();
  }, []);

  return (
    <div className="min-h-screen bg-black text-white">
      <ForumHeader />

      <main className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Back link */}
        <Link
          href="/forum"
          className="inline-flex items-center gap-2 text-neutral-600 hover:text-cyan-400 transition-colors mb-8"
        >
          <ArrowLeft size={14} />
          <span className="text-[10px] font-black uppercase tracking-widest">
            Back to Forum
          </span>
        </Link>

        {/* Header */}
        <div className="mb-12">
          <div className="flex items-center gap-4 mb-4">
            <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/20 flex items-center justify-center">
              <Trophy size={28} className="text-amber-400" />
            </div>
            <div>
              <h1 className="text-3xl font-black italic text-white">
                Karma Leaderboard
              </h1>
              <p className="text-sm text-neutral-500">
                Top contributors ranked by karma points
              </p>
            </div>
          </div>

          {/* Stats */}
          <div className="flex items-center gap-6 mt-6">
            <div className="flex items-center gap-2 text-xs text-neutral-600">
              <TrendingUp size={14} className="text-cyan-400" />
              <span>Earn karma through upvotes on posts and comments</span>
            </div>
          </div>
        </div>

        {/* Error state */}
        {error && (
          <div className="p-8 rounded-2xl bg-red-500/10 border border-red-500/20 text-center">
            <p className="text-red-400">{error}</p>
          </div>
        )}

        {/* Loading state */}
        {isLoading && <LeaderboardSkeleton />}

        {/* Empty state */}
        {!isLoading && !error && entries.length === 0 && (
          <div className="p-12 rounded-2xl bg-neutral-900/30 border border-white/5 text-center">
            <Trophy size={48} className="text-neutral-700 mx-auto mb-4" />
            <p className="text-neutral-500">No contributors yet</p>
            <p className="text-neutral-600 text-sm mt-2">
              Be the first to earn karma by posting helpful content!
            </p>
          </div>
        )}

        {/* Leaderboard */}
        {!isLoading && !error && entries.length > 0 && (
          <div className="space-y-3">
            {entries.map((entry, index) => (
              <LeaderboardEntry key={entry.userId} entry={entry} index={index} />
            ))}
          </div>
        )}

        {/* Footer note */}
        {!isLoading && entries.length > 0 && (
          <div className="mt-8 text-center">
            <p className="text-[9px] font-black uppercase tracking-widest text-neutral-700">
              Karma updates in real-time based on community votes
            </p>
          </div>
        )}
      </main>
    </div>
  );
}
