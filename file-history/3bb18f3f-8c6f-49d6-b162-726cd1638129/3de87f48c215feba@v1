-- Migration: Add forum performance indexes for scale
-- Date: 2025-12-27

-- PERF-001: Partial index for active posts (most common query pattern)
CREATE INDEX IF NOT EXISTS idx_posts_active
ON forum_posts(sub_forum_id, created_at DESC)
WHERE is_deleted = FALSE AND is_approved = TRUE;

-- PERF-002: Cursor pagination support (keyset pagination)
CREATE INDEX IF NOT EXISTS idx_posts_cursor
ON forum_posts(created_at DESC, id DESC)
WHERE is_deleted = FALSE AND is_approved = TRUE;

-- PERF-003: Category-level post queries with sub-forum join
CREATE INDEX IF NOT EXISTS idx_subforums_category
ON forum_sub_forums(issue_category_id);

-- PERF-004: Comment listing optimization
CREATE INDEX IF NOT EXISTS idx_comments_post_active
ON forum_comments(post_id, created_at)
WHERE is_deleted = FALSE;

-- PERF-005: Full-text search on posts (PostgreSQL GIN)
-- Note: Uses pg_catalog.english dictionary for word stemming
CREATE INDEX IF NOT EXISTS idx_posts_fts
ON forum_posts USING gin(to_tsvector('english', title || ' ' || COALESCE(content, '')))
WHERE is_deleted = FALSE;

-- Additional: Index for user's posts/comments (profile pages)
CREATE INDEX IF NOT EXISTS idx_posts_author
ON forum_posts(author_id, created_at DESC)
WHERE is_deleted = FALSE;

CREATE INDEX IF NOT EXISTS idx_comments_author
ON forum_comments(author_id, created_at DESC)
WHERE is_deleted = FALSE;

-- Additional: Notification read status for unread counts
CREATE INDEX IF NOT EXISTS idx_notifications_user_unread
ON notifications(user_id, created_at DESC)
WHERE read = FALSE;
