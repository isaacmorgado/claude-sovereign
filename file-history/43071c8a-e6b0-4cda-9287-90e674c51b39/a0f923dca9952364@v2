"use client";

import { createContext, useContext, useEffect, useState, useMemo, ReactNode } from "react";

/**
 * Simple A/B Testing Framework
 *
 * Uses cookies to persist variant assignments across sessions.
 * Integrates with Google Analytics for tracking.
 */

type Variant = "control" | "variant";

interface ABTestingContextType {
  getVariant: (experimentId: string) => Variant;
  trackConversion: (experimentId: string, eventName: string) => void;
  experiments: Record<string, Variant>;
}

const ABTestingContext = createContext<ABTestingContextType | null>(null);

// Helper to get/set cookies
function getCookie(name: string): string | null {
  if (typeof document === "undefined") return null;
  const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
  return match ? match[2] : null;
}

function setCookie(name: string, value: string, days: number = 30) {
  if (typeof document === "undefined") return;
  const expires = new Date(Date.now() + days * 864e5).toUTCString();
  document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
}

// Deterministic random based on user ID for consistent assignment
function assignVariant(experimentId: string): Variant {
  // Get or create a persistent user ID
  let userId = getCookie("ab_user_id");
  if (!userId) {
    userId = Math.random().toString(36).substring(2) + Date.now().toString(36);
    setCookie("ab_user_id", userId, 365);
  }

  // Hash the experiment ID + user ID to get consistent assignment
  let hash = 0;
  const str = experimentId + userId;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }

  // 50/50 split
  return Math.abs(hash) % 2 === 0 ? "control" : "variant";
}

// Initialize experiments from cookies (runs once on mount)
function initializeExperiments(enabledExperiments: string[]): Record<string, Variant> {
  const assigned: Record<string, Variant> = {};

  enabledExperiments.forEach((expId) => {
    const cookieKey = `ab_exp_${expId}`;
    let variant = getCookie(cookieKey) as Variant | null;

    if (!variant || (variant !== "control" && variant !== "variant")) {
      variant = assignVariant(expId);
      setCookie(cookieKey, variant, 30);
    }

    assigned[expId] = variant;
  });

  return assigned;
}

interface ABTestingProviderProps {
  children: ReactNode;
  enabledExperiments?: string[];
}

export function ABTestingProvider({
  children,
  enabledExperiments = []
}: ABTestingProviderProps) {
  // Use lazy initialization to avoid setState in useEffect
  const [experiments] = useState<Record<string, Variant>>(() =>
    initializeExperiments(enabledExperiments)
  );

  // Track exposure in GA (side effect only, no state update)
  useEffect(() => {
    if (typeof window === "undefined") return;

    const gtag = (window as unknown as { gtag?: (...args: unknown[]) => void }).gtag;
    if (!gtag) return;

    Object.entries(experiments).forEach(([expId, variant]) => {
      gtag("event", "experiment_exposure", {
        experiment_id: expId,
        variant: variant,
      });
    });
  }, [experiments]);

  const contextValue = useMemo(() => ({
    getVariant: (experimentId: string): Variant => {
      return experiments[experimentId] || "control";
    },
    trackConversion: (experimentId: string, eventName: string) => {
      const variant = experiments[experimentId];
      if (!variant) return;

      if (typeof window !== "undefined" && (window as unknown as { gtag?: (...args: unknown[]) => void }).gtag) {
        (window as unknown as { gtag: (...args: unknown[]) => void }).gtag("event", "experiment_conversion", {
          experiment_id: experimentId,
          variant: variant,
          conversion_event: eventName,
        });
      }
    },
    experiments,
  }), [experiments]);

  return (
    <ABTestingContext.Provider value={contextValue}>
      {children}
    </ABTestingContext.Provider>
  );
}

export function useABTesting() {
  const context = useContext(ABTestingContext);
  if (!context) {
    // Return default implementation when outside provider
    return {
      getVariant: () => "control" as Variant,
      trackConversion: () => {},
      experiments: {},
    };
  }
  return context;
}

// Convenience component for A/B tests
interface ABTestProps {
  experimentId: string;
  control: ReactNode;
  variant: ReactNode;
}

export function ABTest({ experimentId, control, variant }: ABTestProps) {
  const { getVariant } = useABTesting();
  const assignedVariant = getVariant(experimentId);

  return <>{assignedVariant === "variant" ? variant : control}</>;
}
