"use client";

import { useState, useEffect, useCallback } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Button } from "@/components/ui/button";
import { X, Gift, Clock, ArrowRight } from "lucide-react";
import Link from "next/link";

interface ExitIntentPopupProps {
  delay?: number; // Delay before enabling exit detection (ms)
  cooldown?: number; // Hours before showing again after dismissal
}

export function ExitIntentPopup({
  delay = 5000,
  cooldown = 24
}: ExitIntentPopupProps) {
  const [isVisible, setIsVisible] = useState(false);
  const [isEnabled, setIsEnabled] = useState(false);

  // Check if we should show the popup (cooldown logic)
  const shouldShow = useCallback(() => {
    if (typeof window === "undefined") return false;

    const lastDismissed = localStorage.getItem("exit_popup_dismissed");
    if (lastDismissed) {
      const dismissedAt = parseInt(lastDismissed, 10);
      const hoursSince = (Date.now() - dismissedAt) / (1000 * 60 * 60);
      if (hoursSince < cooldown) return false;
    }

    // Don't show if user already converted
    const hasConverted = localStorage.getItem("splice_converted");
    if (hasConverted) return false;

    return true;
  }, [cooldown]);

  // Handle mouse leaving viewport
  const handleMouseLeave = useCallback((e: MouseEvent) => {
    if (!isEnabled || !shouldShow()) return;

    // Only trigger when mouse leaves from top of page
    if (e.clientY <= 0) {
      setIsVisible(true);
    }
  }, [isEnabled, shouldShow]);

  // Handle dismiss
  const handleDismiss = () => {
    setIsVisible(false);
    localStorage.setItem("exit_popup_dismissed", Date.now().toString());
  };

  // Handle CTA click
  const handleCTAClick = () => {
    setIsVisible(false);
    localStorage.setItem("splice_converted", "true");
  };

  // Enable exit detection after delay
  useEffect(() => {
    const timer = setTimeout(() => {
      setIsEnabled(true);
    }, delay);

    return () => clearTimeout(timer);
  }, [delay]);

  // Add mouse leave listener
  useEffect(() => {
    if (!isEnabled) return;

    document.addEventListener("mouseleave", handleMouseLeave);
    return () => document.removeEventListener("mouseleave", handleMouseLeave);
  }, [isEnabled, handleMouseLeave]);

  return (
    <AnimatePresence>
      {isVisible && (
        <>
          {/* Backdrop */}
          <motion.div
            className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={handleDismiss}
          />

          {/* Popup */}
          <motion.div
            className="fixed inset-0 z-50 flex items-center justify-center px-4"
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.9 }}
            transition={{ type: "spring", damping: 25, stiffness: 300 }}
          >
          <div className="w-full max-w-lg">
            <div className="relative bg-[#0d1829] rounded-2xl border border-[#00D4FF]/30 shadow-2xl shadow-[#00D4FF]/10 overflow-hidden">
              {/* Close button */}
              <button
                onClick={handleDismiss}
                className="absolute top-4 right-4 p-2 rounded-full text-gray-400 hover:text-white hover:bg-white/10 transition-colors z-10"
                aria-label="Close popup"
              >
                <X className="w-5 h-5" />
              </button>

              {/* Gradient header */}
              <div className="bg-gradient-to-r from-[#00D4FF]/20 to-purple-500/20 p-8 pb-6">
                <div className="flex items-center gap-3 mb-4">
                  <div className="p-3 rounded-full bg-[#00D4FF]/20">
                    <Gift className="w-6 h-6 text-[#00D4FF]" />
                  </div>
                  <span className="text-sm font-medium text-[#00D4FF]">Limited Time Offer</span>
                </div>

                <h3 className="text-2xl md:text-3xl font-bold text-white mb-2">
                  Wait! Get 20% Off Your First Month
                </h3>
                <p className="text-gray-300">
                  Use code <span className="font-mono font-bold text-[#00D4FF]">WELCOME20</span> at checkout
                </p>
              </div>

              {/* Content */}
              <div className="p-8 pt-6">
                <div className="flex items-center gap-2 text-sm text-gray-400 mb-6">
                  <Clock className="w-4 h-4" />
                  <span>Offer expires in 24 hours</span>
                </div>

                <ul className="space-y-3 mb-6">
                  <li className="flex items-center gap-3 text-gray-300">
                    <div className="w-5 h-5 rounded-full bg-green-500/20 flex items-center justify-center">
                      <svg className="w-3 h-3 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                    14-day free trial included
                  </li>
                  <li className="flex items-center gap-3 text-gray-300">
                    <div className="w-5 h-5 rounded-full bg-green-500/20 flex items-center justify-center">
                      <svg className="w-3 h-3 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                    30-day money-back guarantee
                  </li>
                  <li className="flex items-center gap-3 text-gray-300">
                    <div className="w-5 h-5 rounded-full bg-green-500/20 flex items-center justify-center">
                      <svg className="w-3 h-3 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                    Cancel anytime, no questions asked
                  </li>
                </ul>

                <div className="flex flex-col sm:flex-row gap-3">
                  <Button
                    className="flex-1 bg-[#00D4FF] hover:bg-[#00B8E6] text-black font-semibold h-12"
                    onClick={handleCTAClick}
                    asChild
                  >
                    <Link href="/checkout?plan=pro&coupon=WELCOME20">
                      Claim 20% Off
                      <ArrowRight className="w-4 h-4 ml-2" />
                    </Link>
                  </Button>
                  <Button
                    variant="ghost"
                    className="text-gray-400 hover:text-white"
                    onClick={handleDismiss}
                  >
                    No thanks
                  </Button>
                </div>
              </div>
            </div>
          </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  );
}
