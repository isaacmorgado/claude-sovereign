# Phase 11: Google OAuth & Claude-in-Chrome Integration

## Overview
Add Google OAuth for Gemini subscriptions and integrate Claude-in-Chrome as an MCP server for browser automation.

## Key Decisions
- **Claude-in-Chrome**: Configure as external MCP server via `bundled-servers.json` (simpler, follows existing patterns)
- **Google OAuth**: Support both OAuth for subscription detection AND API key fallback
- **Browser Extension**: No new extension needed - use existing Claude-in-Chrome MCP which connects to Claude Chrome extension

---

## Implementation Steps

### 1. Google OAuth Integration

#### 1.1 Create `src/integrations/google/oauth.ts`
Mirror the Claude Code OAuth pattern:
- PKCE flow with Google OAuth 2.0 endpoints
- Local HTTP callback server on port 54546
- Token storage in VS Code secrets
- Token refresh logic with 5-minute buffer

```typescript
// Key exports:
export const GOOGLE_OAUTH_CONFIG = {
  authorizationEndpoint: "https://accounts.google.com/o/oauth2/v2/auth",
  tokenEndpoint: "https://oauth2.googleapis.com/token",
  clientId: "<registered-client-id>",
  redirectUri: "http://localhost:54546/callback",
  scopes: "openid email https://www.googleapis.com/auth/cloud-platform",
}
export class GoogleOAuthManager { ... }
export const googleOAuthManager = new GoogleOAuthManager()
```

#### 1.2 Create `src/integrations/google/subscription.ts`
Subscription tier detection:
- `checkGeminiSubscription()` - query Google API for subscription status
- Support Free, Pro, Max tiers
- Cache subscription status with TTL

#### 1.3 Create `src/integrations/google/index.ts`
Export unified interface for Google auth:
- `getGeminiCredentials()` - returns OAuth token OR API key
- `isGeminiMaxSubscriber()` - check subscription tier

---

### 2. Update Gemini Provider

#### 2.1 Modify `src/api/providers/gemini.ts`
- Add support for OAuth token in addition to API key
- Check subscription tier for feature gating
- Use `googleOAuthManager.getAccessToken()` when OAuth is configured

---

### 3. Claude-in-Chrome MCP Integration

#### 3.1 Update `src/services/mcp/bundled/bundled-servers.json`
Add Claude-in-Chrome as bundled MCP server:
```json
{
  "claude-in-chrome": {
    "type": "stdio",
    "command": "npx",
    "args": ["-y", "@anthropic/claude-in-chrome"],
    "disabled": true,
    "description": "Browser automation via Claude Chrome extension",
    "documentation": "https://github.com/anthropics/claude-in-chrome"
  }
}
```

#### 3.2 Update `src/services/mcp/bundled/index.ts`
Handle Claude-in-Chrome server lifecycle:
- Start MCP server when enabled
- Connect to existing Chrome extension if running

---

### 4. Extension Wiring

#### 4.1 Update `src/extension.ts`
Initialize Google OAuth manager:
```typescript
import { googleOAuthManager } from "./integrations/google/oauth"
// In activate():
googleOAuthManager.initialize(context)
```

Add settings change listener for Google auth:
```typescript
vscode.workspace.onDidChangeConfiguration((e) => {
  if (e.affectsConfiguration("multi-agent.google.enabled")) {
    // Re-initialize Google services
  }
})
```

---

### 5. VS Code Settings

#### 5.1 Update `src/package.json`
Add configuration properties:
```json
{
  "multi-agent.google.enabled": {
    "type": "boolean",
    "default": false,
    "description": "Enable Google OAuth for Gemini subscription features"
  },
  "multi-agent.google.useOAuth": {
    "type": "boolean",
    "default": false,
    "description": "Use Google OAuth instead of API key for Gemini"
  },
  "multi-agent.bundledMcp.claudeInChrome.enabled": {
    "type": "boolean",
    "default": false,
    "description": "Enable Claude-in-Chrome browser automation MCP server"
  }
}
```

---

## Files to Create
1. `src/integrations/google/oauth.ts` - Google OAuth flow
2. `src/integrations/google/subscription.ts` - Subscription management
3. `src/integrations/google/index.ts` - Unified exports

## Files to Modify
1. `src/services/mcp/bundled/bundled-servers.json` - Add Claude-in-Chrome
2. `src/services/mcp/bundled/index.ts` - Handle new server
3. `src/api/providers/gemini.ts` - Support OAuth token
4. `src/extension.ts` - Initialize Google OAuth
5. `src/package.json` - Add settings

---

## Build Commands
```bash
pnpm run check-types  # TypeScript validation
pnpm run lint         # ESLint
pnpm run test         # Unit tests
```

---

## Notes
- Existing `BrowserExtensionBridge` can be used alongside Claude-in-Chrome MCP for direct WebSocket communication if needed
- Google OAuth requires registering OAuth client in Google Cloud Console
- Claude-in-Chrome MCP handles Chrome extension communication internally
