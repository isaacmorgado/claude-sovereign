/**
 * Google Integration Module
 *
 * Provides OAuth authentication and subscription management for Google services,
 * primarily focused on Gemini API access.
 */

// OAuth exports
export {
	GOOGLE_OAUTH_CONFIG,
	GoogleOAuthManager,
	googleOAuthManager,
	generateCodeVerifier,
	generateCodeChallenge,
	generateState,
	buildAuthorizationUrl,
	exchangeCodeForTokens,
	refreshAccessToken,
	isTokenExpired,
	type GoogleCredentials,
} from "./oauth"

// Subscription exports
export {
	checkGeminiSubscription,
	isGeminiMaxSubscriber,
	isGeminiProOrHigher,
	hasGeminiSubscription,
	getCachedSubscription,
	clearSubscriptionCache,
	getSubscriptionTierDisplayName,
	getSubscriptionFeatures,
	type GeminiSubscriptionTier,
	type GeminiSubscriptionStatus,
} from "./subscription"

// Unified credential retrieval
import { googleOAuthManager } from "./oauth"

/**
 * Get Gemini credentials (OAuth token or API key)
 *
 * Priority:
 * 1. OAuth access token if authenticated
 * 2. API key from options if provided
 *
 * @param apiKey - Optional API key to use as fallback
 * @returns Credential object with token and source
 */
export async function getGeminiCredentials(apiKey?: string): Promise<{
	token: string
	source: "oauth" | "api_key"
	email?: string
} | null> {
	// Try OAuth first
	const accessToken = await googleOAuthManager.getAccessToken()

	if (accessToken) {
		const email = await googleOAuthManager.getEmail()
		return {
			token: accessToken,
			source: "oauth",
			email: email || undefined,
		}
	}

	// Fall back to API key
	if (apiKey) {
		return {
			token: apiKey,
			source: "api_key",
		}
	}

	return null
}

/**
 * Check if Google OAuth is configured and authenticated
 */
export async function isGoogleAuthenticated(): Promise<boolean> {
	return googleOAuthManager.isAuthenticated()
}

/**
 * Get current Google user info
 */
export async function getGoogleUserInfo(): Promise<{
	email: string | null
	name: string | null
	isAuthenticated: boolean
}> {
	const isAuth = await googleOAuthManager.isAuthenticated()

	if (!isAuth) {
		return {
			email: null,
			name: null,
			isAuthenticated: false,
		}
	}

	const [email, name] = await Promise.all([googleOAuthManager.getEmail(), googleOAuthManager.getName()])

	return {
		email,
		name,
		isAuthenticated: true,
	}
}

/**
 * Initiate Google OAuth login flow
 *
 * @returns Authorization URL to open in browser
 */
export function startGoogleLogin(): string {
	return googleOAuthManager.startAuthorizationFlow()
}

/**
 * Wait for Google OAuth callback and complete authentication
 */
export async function completeGoogleLogin(): Promise<{
	success: boolean
	email?: string
	error?: string
}> {
	try {
		const credentials = await googleOAuthManager.waitForCallback()
		return {
			success: true,
			email: credentials.email,
		}
	} catch (error) {
		return {
			success: false,
			error: error instanceof Error ? error.message : "Authentication failed",
		}
	}
}

/**
 * Logout from Google (clear credentials)
 */
export async function logoutGoogle(): Promise<void> {
	await googleOAuthManager.clearCredentials()
}
