#!/usr/bin/env node
/**
 * SPLICE CEP Comprehensive UI Test Runner
 * Tests all UI components, buttons, handlers, and workflows
 *
 * Run: node tests/comprehensive-ui-test.js
 */

const fs = require('fs');
const path = require('path');

// Test results tracking
const results = {
    passed: 0,
    failed: 0,
    tests: []
};

function test(name, fn) {
    try {
        fn();
        results.passed++;
        results.tests.push({ name, status: 'PASS' });
        console.log(`  ✓ ${name}`);
    } catch (error) {
        results.failed++;
        results.tests.push({ name, status: 'FAIL', error: error.message });
        console.log(`  ✗ ${name}: ${error.message}`);
    }
}

function assert(condition, message) {
    if (!condition) throw new Error(message);
}

function assertContains(content, substring, message) {
    if (!content.includes(substring)) {
        throw new Error(message || `Expected content to contain "${substring}"`);
    }
}

function assertMatch(content, regex, message) {
    if (!regex.test(content)) {
        throw new Error(message || `Expected content to match ${regex}`);
    }
}

// Read all source files
const panelDir = path.join(__dirname, '..', 'panel');
const jsDir = path.join(panelDir, 'js');
const cssDir = path.join(panelDir, 'css');

const indexHtml = fs.readFileSync(path.join(panelDir, 'index.html'), 'utf8');
const mainJs = fs.readFileSync(path.join(jsDir, 'main.js'), 'utf8');
const configJs = fs.readFileSync(path.join(jsDir, 'config.js'), 'utf8');
const creditsJs = fs.readFileSync(path.join(jsDir, 'credits.js'), 'utf8');
const musicJs = fs.readFileSync(path.join(jsDir, 'music.js'), 'utf8');
const textEditorJs = fs.readFileSync(path.join(jsDir, 'textEditor.js'), 'utf8');
const multitrackJs = fs.readFileSync(path.join(jsDir, 'multitrack.js'), 'utf8');
const captionsJs = fs.readFileSync(path.join(jsDir, 'animatedCaptions.js'), 'utf8');
const reframeJs = fs.readFileSync(path.join(jsDir, 'socialReframe.js'), 'utf8');
const styleCss = fs.readFileSync(path.join(cssDir, 'style.css'), 'utf8');

console.log('\n========================================');
console.log('SPLICE CEP Comprehensive UI Tests');
console.log('========================================\n');

// ============================================================================
// TEST SUITE: HTML Structure
// ============================================================================
console.log('\n--- HTML Structure ---');

test('Has GO button', () => {
    assertContains(indexHtml, 'id="goBtn"', 'Missing GO button');
});

test('Has options toggle', () => {
    assertContains(indexHtml, 'id="optionsToggle"', 'Missing options toggle');
});

test('Has preset selector', () => {
    assertContains(indexHtml, 'id="presetSelector"', 'Missing preset selector');
});

test('Has sensitivity slider', () => {
    assertContains(indexHtml, 'id="sensitivitySlider"', 'Missing sensitivity slider');
});

test('Has J-cut lead in/out sliders', () => {
    assertContains(indexHtml, 'id="jcutLeadIn"', 'Missing J-cut lead in slider');
    assertContains(indexHtml, 'id="jcutLeadOut"', 'Missing J-cut lead out slider');
});

test('Has credit badge', () => {
    assertContains(indexHtml, 'id="creditBadge"', 'Missing credit badge');
});

test('Has login modal', () => {
    assertContains(indexHtml, 'id="loginModal"', 'Missing login modal');
});

test('Has license key input', () => {
    assertContains(indexHtml, 'id="licenseKeyInput"', 'Missing license key input');
});

test('Has settings modal', () => {
    assertContains(indexHtml, 'id="settingsModal"', 'Missing settings modal');
});

test('Has empty state message', () => {
    assertContains(indexHtml, 'id="resultsEmpty"', 'Missing empty state');
});

test('Has combined preview', () => {
    assertContains(indexHtml, 'id="combinedPreview"', 'Missing combined preview');
});

test('Has progress container', () => {
    assertContains(indexHtml, 'id="progressContainer"', 'Missing progress container');
});

// Feature toggles
test('Has enableTakesDetection checkbox', () => {
    assertContains(indexHtml, 'id="enableTakesDetection"', 'Missing takes detection toggle');
});

test('Has enableChapters checkbox', () => {
    assertContains(indexHtml, 'id="enableChapters"', 'Missing chapters toggle');
});

test('Has enableProfanity checkbox', () => {
    assertContains(indexHtml, 'id="enableProfanity"', 'Missing profanity toggle');
});

test('Has enableZoom checkbox', () => {
    assertContains(indexHtml, 'id="enableZoom"', 'Missing zoom toggle');
});

test('Has Buy License button in login modal', () => {
    assertContains(indexHtml, 'btn-buy-license', 'Missing Buy License button');
    assertContains(indexHtml, 'splice.video/pricing', 'Missing pricing link');
});

// ============================================================================
// TEST SUITE: Main.js Handlers
// ============================================================================
console.log('\n--- Main.js Handlers ---');

test('Has GO button initialization', () => {
    assertContains(mainJs, 'initGoButton', 'Missing GO button init');
});

test('Has runDetection function', () => {
    assertContains(mainJs, 'async function runDetection', 'Missing runDetection');
});

test('Has options toggle handler', () => {
    assertContains(mainJs, 'initOptionsToggle', 'Missing options toggle handler');
});

test('Has preset selector handler', () => {
    assertContains(mainJs, 'initPresetSelector', 'Missing preset selector handler');
});

test('Has takes detection error handling', () => {
    assertContains(mainJs, 'Takes detection skipped: insufficient credits', 'Missing takes error handling');
});

test('Has profanity detection handler', () => {
    assertContains(mainJs, 'Detecting profanity', 'Missing profanity detection');
    assertContains(mainJs, '/profanity', 'Missing profanity endpoint');
});

test('Has currentProfanity variable', () => {
    assertContains(mainJs, 'let currentProfanity', 'Missing currentProfanity variable');
});

test('Has credit badge click handler', () => {
    assertContains(mainJs, 'handleCreditBadgeClick', 'Missing credit badge handler');
});

test('Has chapter detection', () => {
    assertContains(mainJs, 'Detecting chapters', 'Missing chapter detection');
});

test('Has zoom detection', () => {
    assertContains(mainJs, 'Detecting zoom points', 'Missing zoom detection');
});

test('Has showCombinedPreview function', () => {
    assertContains(mainJs, 'function showCombinedPreview', 'Missing showCombinedPreview');
});

test('Has escapeHtml usage for XSS prevention', () => {
    assertMatch(mainJs, /escapeHtml\s*\(/, 'Missing escapeHtml usage');
});

// ============================================================================
// TEST SUITE: Credits Module
// ============================================================================
console.log('\n--- Credits Module ---');

test('Has fetchCredits function', () => {
    assertContains(creditsJs, 'async function fetchCredits', 'Missing fetchCredits');
});

test('Has updateCreditDisplay function', () => {
    assertContains(creditsJs, 'function updateCreditDisplay', 'Missing updateCreditDisplay');
});

test('Has retryFetchCredits function', () => {
    assertContains(creditsJs, 'async function retryFetchCredits', 'Missing retryFetchCredits');
});

test('Has handleCreditBadgeClick function', () => {
    assertContains(creditsJs, 'function handleCreditBadgeClick', 'Missing handleCreditBadgeClick');
});

test('Has exponential backoff in retry', () => {
    assertContains(creditsJs, 'Math.pow(2, creditsRetryCount', 'Missing exponential backoff');
});

test('Has MAX_CREDITS_RETRIES constant', () => {
    assertContains(creditsJs, 'MAX_CREDITS_RETRIES', 'Missing MAX_CREDITS_RETRIES');
});

test('Has trial badge display', () => {
    assertContains(creditsJs, 'isOnTrial', 'Missing trial detection');
    assertContains(creditsJs, 'trialDaysRemaining', 'Missing trial days');
});

test('Has isolation access check', () => {
    assertContains(creditsJs, 'checkIsolationAccess', 'Missing isolation access check');
});

test('Exports all functions to window', () => {
    assertContains(creditsJs, 'window.fetchCredits', 'Missing fetchCredits export');
    assertContains(creditsJs, 'window.retryFetchCredits', 'Missing retryFetchCredits export');
    assertContains(creditsJs, 'window.handleCreditBadgeClick', 'Missing handleCreditBadgeClick export');
});

// ============================================================================
// TEST SUITE: Music Module
// ============================================================================
console.log('\n--- Music Module ---');

test('Has initMusic function', () => {
    assertContains(musicJs, 'function initMusic', 'Missing initMusic');
});

test('Has handleGenerateMusic function', () => {
    assertContains(musicJs, 'handleGenerateMusic', 'Missing handleGenerateMusic');
});

test('Has handleGenerateVariations function', () => {
    assertContains(musicJs, 'handleGenerateVariations', 'Missing handleGenerateVariations');
});

test('Has showAlignmentModal function', () => {
    assertContains(musicJs, 'showAlignmentModal', 'Missing showAlignmentModal');
});

test('Has music library functions', () => {
    assertContains(musicJs, 'loadMusicLibrary', 'Missing loadMusicLibrary');
});

test('Has escapeHtml for XSS prevention', () => {
    assertMatch(musicJs, /function\s+escapeHtml/, 'Missing escapeHtml in music');
});

// ============================================================================
// TEST SUITE: Text Editor Module
// ============================================================================
console.log('\n--- Text Editor Module ---');

test('Has initTextEditor function', () => {
    assertContains(textEditorJs, 'function initTextEditor', 'Missing initTextEditor');
});

test('Has searchInTranscript function', () => {
    assertContains(textEditorJs, 'searchInTranscript', 'Missing searchInTranscript');
});

test('Has replaceInTranscript function', () => {
    assertContains(textEditorJs, 'replaceInTranscript', 'Missing replaceInTranscript');
});

test('Has undo/redo functions', () => {
    assertContains(textEditorJs, 'undoTextEdit', 'Missing undoTextEdit');
    assertContains(textEditorJs, 'redoTextEdit', 'Missing redoTextEdit');
});

// ============================================================================
// TEST SUITE: Multitrack Module
// ============================================================================
console.log('\n--- Multitrack Module ---');

test('Has initMultitrack function', () => {
    assertContains(multitrackJs, 'function initMultitrack', 'Missing initMultitrack');
});

test('Has analyzeMultitrack function', () => {
    assertContains(multitrackJs, 'analyzeMultitrack', 'Missing analyzeMultitrack');
});

test('Has autoBalanceMultitrack function', () => {
    assertContains(multitrackJs, 'autoBalanceMultitrack', 'Missing autoBalanceMultitrack');
});

test('Has escapeHtml usage for XSS prevention', () => {
    assertContains(multitrackJs, 'escapeHtml(', 'Missing escapeHtml usage in multitrack');
});

// ============================================================================
// TEST SUITE: Captions Module
// ============================================================================
console.log('\n--- Captions Module ---');

test('Has initAnimatedCaptions function', () => {
    assertContains(captionsJs, 'initAnimatedCaptions', 'Missing initAnimatedCaptions');
});

test('Has generateCaptions function', () => {
    assertContains(captionsJs, 'generateCaptions', 'Missing generateCaptions');
});

test('Has renderTemplateGallery function', () => {
    assertContains(captionsJs, 'renderTemplateGallery', 'Missing renderTemplateGallery');
});

test('Has escapeHtml for XSS prevention', () => {
    assertMatch(captionsJs, /function\s+escapeHtml/, 'Missing escapeHtml in captions');
});

// ============================================================================
// TEST SUITE: Social Reframe Module
// ============================================================================
console.log('\n--- Social Reframe Module ---');

test('Has initSocialReframe function', () => {
    assertContains(reframeJs, 'initSocialReframe', 'Missing initSocialReframe');
});

test('Has analyzeForReframe function', () => {
    assertContains(reframeJs, 'analyzeForReframe', 'Missing analyzeForReframe');
});

test('Has renderPlatformSelector function', () => {
    assertContains(reframeJs, 'renderPlatformSelector', 'Missing renderPlatformSelector');
});

test('Has exportReframe function', () => {
    assertContains(reframeJs, 'exportReframe', 'Missing exportReframe');
});

test('Has escapeHtml for XSS prevention', () => {
    assertMatch(reframeJs, /escapeHtmlReframe|function\s+escapeHtml/, 'Missing escapeHtml in reframe');
});

// ============================================================================
// TEST SUITE: Config Module
// ============================================================================
console.log('\n--- Config Module ---');

test('Has PRESETS defined', () => {
    assertContains(configJs, 'const PRESETS', 'Missing PRESETS');
});

test('Has all preset profiles', () => {
    assertContains(configJs, 'podcast', 'Missing podcast preset');
    assertContains(configJs, 'interview', 'Missing interview preset');
    assertContains(configJs, 'reaction', 'Missing reaction preset');
    assertContains(configJs, 'tutorial', 'Missing tutorial preset');
    assertContains(configJs, 'vlog', 'Missing vlog preset');
});

test('Has getBackendUrl function', () => {
    assertContains(configJs, 'function getBackendUrl', 'Missing getBackendUrl');
});

test('Has fetchWithTimeout function', () => {
    assertContains(configJs, 'async function fetchWithTimeout', 'Missing fetchWithTimeout');
});

test('Has getAuthHeaders function', () => {
    assertContains(configJs, 'function getAuthHeaders', 'Missing getAuthHeaders');
});

test('Has escapeHtml function', () => {
    assertContains(configJs, 'function escapeHtml', 'Missing escapeHtml');
});

test('Has jsx bridge', () => {
    assertContains(configJs, 'const jsx', 'Missing jsx bridge');
});

// ============================================================================
// TEST SUITE: CSS Styles
// ============================================================================
console.log('\n--- CSS Styles ---');

test('Has credit badge styles', () => {
    assertContains(styleCss, '.credit-badge', 'Missing credit badge styles');
});

test('Has credit badge states', () => {
    assertContains(styleCss, '.credit-badge.ok', 'Missing ok state');
    assertContains(styleCss, '.credit-badge.low', 'Missing low state');
    assertContains(styleCss, '.credit-badge.error', 'Missing error state');
    assertContains(styleCss, '.credit-badge.login', 'Missing login state');
    assertContains(styleCss, '.credit-badge.trial', 'Missing trial state');
});

test('Has retrying state with animation', () => {
    assertContains(styleCss, '.credit-badge.retrying', 'Missing retrying state');
    assertContains(styleCss, '@keyframes pulse', 'Missing pulse animation');
});

test('Has btn-buy-license styles', () => {
    assertContains(styleCss, '.btn-buy-license', 'Missing buy license button styles');
});

test('Has modal styles', () => {
    assertContains(styleCss, '.modal', 'Missing modal styles');
});

test('Has progress styles', () => {
    assertContains(styleCss, '.progress-bar', 'Missing progress bar styles');
});

// ============================================================================
// TEST SUITE: API Endpoints
// ============================================================================
console.log('\n--- API Endpoints ---');

test('Uses correct silence detection endpoint', () => {
    assertContains(mainJs, '/silences-rms', 'Missing silences-rms endpoint');
});

test('Uses correct analyze endpoint', () => {
    assertContains(mainJs, '/analyze', 'Missing analyze endpoint');
});

test('Uses correct profanity endpoint', () => {
    assertContains(mainJs, '/profanity', 'Missing profanity endpoint');
});

test('Uses correct chapters endpoint', () => {
    assertContains(mainJs, '/chapters', 'Missing chapters endpoint');
});

test('Uses correct zoom endpoint', () => {
    assertContains(mainJs, '/zoom', 'Missing zoom endpoint');
});

test('Uses correct credits endpoint', () => {
    assertContains(creditsJs, '/credits', 'Missing credits endpoint');
});

test('Uses correct music endpoints', () => {
    assertContains(musicJs, '/music/generate', 'Missing music generate endpoint');
    assertContains(musicJs, '/music/align', 'Missing music align endpoint');
});

test('Uses correct multitrack endpoint', () => {
    assertContains(multitrackJs, '/multitrack', 'Missing multitrack endpoint');
});

// ============================================================================
// TEST SUITE: Error Handling
// ============================================================================
console.log('\n--- Error Handling ---');

test('Has try-catch in runDetection', () => {
    assertMatch(mainJs, /runDetection[\s\S]*?try\s*\{/, 'Missing try-catch in runDetection');
});

test('Has error handling for takes detection', () => {
    assertContains(mainJs, 'Takes detection failed', 'Missing takes detection error handling');
});

test('Has error handling for profanity detection', () => {
    assertContains(mainJs, 'Profanity detection failed', 'Missing profanity detection error handling');
});

test('Has error handling for chapter detection', () => {
    assertContains(mainJs, 'Chapter detection failed', 'Missing chapter detection error handling');
});

test('Has error handling for zoom detection', () => {
    assertContains(mainJs, 'Zoom detection failed', 'Missing zoom detection error handling');
});

test('Has parseErrorResponse function', () => {
    assertContains(configJs, 'parseErrorResponse', 'Missing parseErrorResponse');
});

// ============================================================================
// SUMMARY
// ============================================================================
console.log('\n========================================');
console.log('TEST SUMMARY');
console.log('========================================');
console.log(`  Passed: ${results.passed}`);
console.log(`  Failed: ${results.failed}`);
console.log(`  Total:  ${results.passed + results.failed}`);
console.log('========================================\n');

if (results.failed > 0) {
    console.log('FAILED TESTS:');
    results.tests.filter(t => t.status === 'FAIL').forEach(t => {
        console.log(`  - ${t.name}: ${t.error}`);
    });
    console.log('');
    process.exit(1);
} else {
    console.log('All tests passed! UI is ready for SaaS release.\n');
    process.exit(0);
}
