/**
 * SPLICE Animated Captions E2E Tests
 *
 * Tests service functions, API endpoints, and UI wiring.
 * Run: node tests/animated-captions.test.js
 */

const fs = require('fs');
const path = require('path');

// Test results tracking
let totalTests = 0;
let passedTests = 0;
let failedTests = 0;

function describe(name, fn) {
  console.log(`\nğŸ“¦ ${name}`);
  fn();
}

function it(name, fn) {
  totalTests++;
  try {
    fn();
    passedTests++;
    console.log(`  âœ… ${name}`);
  } catch (err) {
    failedTests++;
    console.log(`  âŒ ${name}`);
    console.log(`     Error: ${err.message}`);
  }
}

function assert(condition, message) {
  if (!condition) {
    throw new Error(message || 'Assertion failed');
  }
}

// ============================================================================
// SERVICE TESTS
// ============================================================================

describe('Animated Captions Service', () => {
  const servicePath = path.join(__dirname, '../services/animatedCaptions.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should export generateAnimatedCaptions function', () => {
    assert(serviceCode.includes('async function generateAnimatedCaptions'), 'Function not found');
    assert(serviceCode.includes('module.exports') && serviceCode.includes('generateAnimatedCaptions'), 'Not exported');
  });

  it('should export detectKeywords function', () => {
    assert(serviceCode.includes('async function detectKeywords'), 'Function not found');
    assert(serviceCode.includes('detectKeywords'), 'Not exported');
  });

  it('should export insertEmojis function', () => {
    assert(serviceCode.includes('async function insertEmojis'), 'Function not found');
    assert(serviceCode.includes('insertEmojis'), 'Not exported');
  });

  it('should export applyTemplate function', () => {
    assert(serviceCode.includes('function applyTemplate'), 'Function not found');
    assert(serviceCode.includes('applyTemplate'), 'Not exported');
  });

  it('should export generateMOGRTData function', () => {
    assert(serviceCode.includes('function generateMOGRTData'), 'Function not found');
    assert(serviceCode.includes('generateMOGRTData'), 'Not exported');
  });

  it('should export exportBurnedInCaptions function', () => {
    assert(serviceCode.includes('async function exportBurnedInCaptions'), 'Function not found');
    assert(serviceCode.includes('exportBurnedInCaptions'), 'Not exported');
  });

  it('should export getTemplates function', () => {
    assert(serviceCode.includes('function getTemplates'), 'Function not found');
    assert(serviceCode.includes('getTemplates'), 'Not exported');
  });

  it('should export getTemplateById function', () => {
    assert(serviceCode.includes('function getTemplateById'), 'Function not found');
    assert(serviceCode.includes('getTemplateById'), 'Not exported');
  });
});

describe('Template Definitions', () => {
  const servicePath = path.join(__dirname, '../services/animatedCaptions.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should define mrbeast template', () => {
    assert(serviceCode.includes("mrbeast:"), 'mrbeast template not found');
    assert(serviceCode.includes("'MrBeast'") || serviceCode.includes('"MrBeast"'), 'MrBeast name not found');
    assert(serviceCode.includes('shake-scale'), 'shake-scale animation not found');
  });

  it('should define hormozi template', () => {
    assert(serviceCode.includes("hormozi:"), 'hormozi template not found');
    assert(serviceCode.includes("'Hormozi'") || serviceCode.includes('"Hormozi"'), 'Hormozi name not found');
    assert(serviceCode.includes('slide-in'), 'slide-in animation not found');
  });

  it('should define gaming template', () => {
    assert(serviceCode.includes("gaming:"), 'gaming template not found');
    assert(serviceCode.includes("'Gaming'") || serviceCode.includes('"Gaming"'), 'Gaming name not found');
    assert(serviceCode.includes('glitch'), 'glitch animation not found');
  });

  it('should define corporate template', () => {
    assert(serviceCode.includes("corporate:"), 'corporate template not found');
    assert(serviceCode.includes("'Corporate'") || serviceCode.includes('"Corporate"'), 'Corporate name not found');
    assert(serviceCode.includes("type: 'fade'") || serviceCode.includes('type: "fade"'), 'fade animation not found');
  });

  it('should define karaoke template', () => {
    assert(serviceCode.includes("karaoke:"), 'karaoke template not found');
    assert(serviceCode.includes("'Karaoke'") || serviceCode.includes('"Karaoke"'), 'Karaoke name not found');
    assert(serviceCode.includes('progressive-fill'), 'progressive-fill animation not found');
  });

  it('should include template styles', () => {
    assert(serviceCode.includes('fontFamily'), 'fontFamily not found');
    assert(serviceCode.includes('fontSize'), 'fontSize not found');
    assert(serviceCode.includes('color:'), 'color not found');
    assert(serviceCode.includes('strokeColor'), 'strokeColor not found');
  });

  it('should include animation settings', () => {
    assert(serviceCode.includes('animation:'), 'animation object not found');
    assert(serviceCode.includes("type:"), 'animation type not found');
    assert(serviceCode.includes('duration:'), 'animation duration not found');
    assert(serviceCode.includes('easing:'), 'animation easing not found');
  });

  it('should include highlight settings', () => {
    assert(serviceCode.includes('highlight:'), 'highlight object not found');
    assert(serviceCode.includes('enabled:'), 'highlight enabled not found');
    assert(serviceCode.includes('keywords:'), 'highlight keywords not found');
  });
});

describe('Emoji Mappings', () => {
  const servicePath = path.join(__dirname, '../services/animatedCaptions.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should define EMOJI_MAPPINGS', () => {
    assert(serviceCode.includes('EMOJI_MAPPINGS'), 'EMOJI_MAPPINGS not found');
  });

  it('should include emotion emojis', () => {
    assert(serviceCode.includes("happy:"), 'happy not found');
    assert(serviceCode.includes("sad:"), 'sad not found');
    assert(serviceCode.includes("fire:") || serviceCode.includes("'fire'"), 'fire not found');
  });

  it('should include action emojis', () => {
    assert(serviceCode.includes("win:"), 'win not found');
    assert(serviceCode.includes("money:"), 'money not found');
  });

  it('should include emphasis emojis', () => {
    assert(serviceCode.includes("rocket:") || serviceCode.includes("'rocket'"), 'rocket not found');
    assert(serviceCode.includes("star:") || serviceCode.includes("'star'"), 'star not found');
  });
});

describe('Service Functions Runtime', () => {
  const service = require('../services/animatedCaptions');

  it('should get templates list', () => {
    const result = service.getTemplates();
    assert(result.templates, 'templates array missing');
    assert(result.templates.length >= 5, 'Should have at least 5 templates');
    assert(result.count >= 5, 'count should match');
  });

  it('should get template by ID', () => {
    const template = service.getTemplateById('mrbeast');
    assert(template, 'mrbeast template not found');
    assert(template.id === 'mrbeast', 'ID mismatch');
    assert(template.name === 'MrBeast', 'Name mismatch');
    assert(template.style, 'style object missing');
    assert(template.animation, 'animation object missing');
  });

  it('should return null for invalid template ID', () => {
    const template = service.getTemplateById('nonexistent');
    assert(template === null, 'Should return null for invalid ID');
  });

  it('should extract words from transcript', () => {
    const words = service.extractWords({
      words: [
        { word: 'Hello', start: 0, end: 0.5 },
        { word: 'World', start: 0.6, end: 1.0 }
      ]
    });
    assert(words.length === 2, 'Should extract 2 words');
    assert(words[0].word === 'Hello', 'First word mismatch');
  });

  it('should extract words from segments', () => {
    const words = service.extractWords({
      segments: [{
        words: [
          { word: 'Test', start: 0, end: 0.3 }
        ]
      }]
    });
    assert(words.length === 1, 'Should extract 1 word');
    assert(words[0].word === 'Test', 'Word mismatch');
  });

  it('should extract text from transcript', () => {
    const text = service.extractText({ text: 'Hello World' });
    assert(text === 'Hello World', 'Text extraction failed');
  });

  it('should group words into lines', () => {
    const words = [
      { word: 'One', start: 0, end: 0.2 },
      { word: 'Two', start: 0.3, end: 0.5 },
      { word: 'Three', start: 0.6, end: 0.8 },
      { word: 'Four', start: 0.9, end: 1.1 },
      { word: 'Five', start: 1.2, end: 1.4 }
    ];
    const lines = service.groupWordsIntoLines(words, 3);
    assert(lines.length === 2, 'Should create 2 lines');
    assert(lines[0].words.length === 3, 'First line should have 3 words');
  });

  it('should get emoji for word', () => {
    const emoji = service.getEmojiForWord('fire', 'high');
    assert(emoji, 'Should return emoji for fire');
  });

  it('should apply template to caption data', () => {
    const captionData = {
      captions: [
        { id: 'c1', text: 'Hello', start: 0, end: 1, style: {}, animation: {} }
      ]
    };
    const result = service.applyTemplate(captionData, 'hormozi');
    assert(result.success, 'Apply template failed');
    assert(result.template === 'hormozi', 'Template mismatch');
    assert(result.captions[0].style.fontFamily, 'Style not applied');
  });

  it('should fail to apply invalid template', () => {
    const result = service.applyTemplate({ captions: [] }, 'invalid');
    assert(!result.success, 'Should fail for invalid template');
    assert(result.error, 'Should have error message');
  });

  it('should generate MOGRT data', () => {
    const captions = [
      { id: 'c1', text: 'Hello World', start: 0, end: 2, style: {}, animation: { type: 'fade', duration: 0.3 }, words: [] }
    ];
    const result = service.generateMOGRTData(captions, { frameRate: 30 });
    assert(result.success, 'MOGRT generation failed');
    assert(result.data, 'MOGRT data missing');
    assert(result.data.composition, 'composition missing');
    assert(result.data.layers.length === 1, 'layers count mismatch');
  });
});

// ============================================================================
// API ENDPOINT TESTS
// ============================================================================

describe('Server API Endpoints', () => {
  const serverPath = path.join(__dirname, '../server.js');
  const serverCode = fs.readFileSync(serverPath, 'utf8');

  it('should have POST /captions/animate endpoint', () => {
    assert(serverCode.includes("app.post('/captions/animate'"), 'Endpoint not found');
  });

  it('should have GET /captions/templates endpoint', () => {
    assert(serverCode.includes("app.get('/captions/templates'"), 'Endpoint not found');
  });

  it('should have GET /captions/template/:id endpoint', () => {
    assert(serverCode.includes("app.get('/captions/template/:id'"), 'Endpoint not found');
  });

  it('should have POST /captions/detect-keywords endpoint', () => {
    assert(serverCode.includes("app.post('/captions/detect-keywords'"), 'Endpoint not found');
  });

  it('should have POST /captions/insert-emojis endpoint', () => {
    assert(serverCode.includes("app.post('/captions/insert-emojis'"), 'Endpoint not found');
  });

  it('should have POST /captions/apply-template endpoint', () => {
    assert(serverCode.includes("app.post('/captions/apply-template'"), 'Endpoint not found');
  });

  it('should have POST /captions/export/mogrt endpoint', () => {
    assert(serverCode.includes("app.post('/captions/export/mogrt'"), 'Endpoint not found');
  });

  it('should have POST /captions/export/burned endpoint', () => {
    assert(serverCode.includes("app.post('/captions/export/burned'"), 'Endpoint not found');
  });

  it('should require auth for animate endpoint', () => {
    assert(serverCode.includes("'/captions/animate', requireCredits"), 'Auth not required for animate');
  });

  it('should require auth for detect-keywords endpoint', () => {
    assert(serverCode.includes("'/captions/detect-keywords', requireCredits"), 'Auth not required');
  });

  it('should require auth for insert-emojis endpoint', () => {
    assert(serverCode.includes("'/captions/insert-emojis', requireCredits"), 'Auth not required');
  });

  it('should require auth for export/mogrt endpoint', () => {
    assert(serverCode.includes("'/captions/export/mogrt', requireCredits"), 'Auth not required');
  });

  it('should require auth for export/burned endpoint', () => {
    assert(serverCode.includes("'/captions/export/burned', requireCredits"), 'Auth not required');
  });

  it('should validate transcript in animate endpoint', () => {
    const match = serverCode.match(/\/captions\/animate[\s\S]{0,500}transcript is required/);
    assert(match, 'Transcript validation not found');
  });

  it('should deduct usage for caption generation', () => {
    assert(serverCode.includes("await req.deductUsage(0.5)"), 'Usage deduction not found');
  });

  it('should call generateAnimatedCaptions service', () => {
    assert(serverCode.includes("generateAnimatedCaptions(transcript, template, settings)"), 'Service call not found');
  });

  it('should log errors correctly', () => {
    assert(serverCode.includes("[SPLICE] Animated captions error:"), 'Error logging not found');
  });
});

// ============================================================================
// PLUGIN UI TESTS
// ============================================================================

describe('Plugin UI Module', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/animatedCaptions.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should define animatedCaptionsState', () => {
    assert(pluginCode.includes('animatedCaptionsState'), 'State object not found');
  });

  it('should have initAnimatedCaptions function', () => {
    assert(pluginCode.includes('async function initAnimatedCaptions'), 'Init function not found');
  });

  it('should have loadCaptionTemplates function', () => {
    assert(pluginCode.includes('async function loadCaptionTemplates'), 'Load templates function not found');
  });

  it('should have renderTemplateGallery function', () => {
    assert(pluginCode.includes('function renderTemplateGallery'), 'Render gallery function not found');
  });

  it('should have selectCaptionTemplate function', () => {
    assert(pluginCode.includes('function selectCaptionTemplate'), 'Select template function not found');
  });

  it('should have generateCaptions function', () => {
    assert(pluginCode.includes('async function generateCaptions'), 'Generate captions function not found');
  });

  it('should have renderCaptionPreview function', () => {
    assert(pluginCode.includes('function renderCaptionPreview'), 'Render preview function not found');
  });

  it('should have exportCaptions function', () => {
    assert(pluginCode.includes('async function exportCaptions'), 'Export function not found');
  });

  it('should have applyCaptionsToTimeline function', () => {
    assert(pluginCode.includes('async function applyCaptionsToTimeline'), 'Apply to timeline function not found');
  });

  it('should expose module globally', () => {
    assert(pluginCode.includes('window.spliceAnimatedCaptions'), 'Global export not found');
  });

  it('should include all exported functions', () => {
    assert(pluginCode.includes('init: initAnimatedCaptions'), 'init not exported');
    assert(pluginCode.includes('generate: generateCaptions'), 'generate not exported');
    assert(pluginCode.includes('setTranscript: setCaptionTranscript'), 'setTranscript not exported');
    assert(pluginCode.includes('selectTemplate: selectCaptionTemplate'), 'selectTemplate not exported');
    assert(pluginCode.includes('export: exportCaptions'), 'export not exported');
  });

  it('should setup event listeners', () => {
    assert(pluginCode.includes('setupCaptionEventListeners'), 'Event listeners setup not found');
    assert(pluginCode.includes("'generate-captions-btn'"), 'Generate button listener not found');
  });

  it('should use config helpers', () => {
    assert(pluginCode.includes('getBackendUrl'), 'getBackendUrl not used');
    assert(pluginCode.includes('fetchWithTimeout'), 'fetchWithTimeout not used');
    assert(pluginCode.includes('getAuthHeaders'), 'getAuthHeaders not used');
  });

  it('should handle fallback templates', () => {
    assert(pluginCode.includes("{ id: 'mrbeast'"), 'Fallback templates not found');
  });

  it('should have status display functions', () => {
    assert(pluginCode.includes('function showCaptionStatus'), 'Status function not found');
    assert(pluginCode.includes('caption-status-error'), 'Error status class not found');
    assert(pluginCode.includes('caption-status-success'), 'Success status class not found');
  });
});

describe('UI State Management', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/animatedCaptions.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should track templates', () => {
    assert(pluginCode.includes('templates: []'), 'templates state not found');
  });

  it('should track selected template', () => {
    assert(pluginCode.includes("selectedTemplate: 'mrbeast'"), 'selectedTemplate not found');
  });

  it('should track captions', () => {
    assert(pluginCode.includes('captions: null'), 'captions state not found');
  });

  it('should track keywords', () => {
    assert(pluginCode.includes('keywords: []'), 'keywords state not found');
  });

  it('should track settings', () => {
    assert(pluginCode.includes('settings:'), 'settings not found');
    assert(pluginCode.includes('maxWordsPerLine'), 'maxWordsPerLine not found');
    assert(pluginCode.includes('highlightKeywords'), 'highlightKeywords not found');
    assert(pluginCode.includes('insertEmojis'), 'insertEmojis not found');
    assert(pluginCode.includes('emojiFrequency'), 'emojiFrequency not found');
  });

  it('should track generating state', () => {
    assert(pluginCode.includes('isGenerating: false'), 'isGenerating not found');
  });
});

describe('UI Event Handling', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/animatedCaptions.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should handle template card clicks', () => {
    assert(pluginCode.includes('.caption-template-card'), 'Template card selector not found');
    assert(pluginCode.includes('data-template-id'), 'Template ID data attribute not found');
  });

  it('should handle generate button click', () => {
    assert(pluginCode.includes("'generate-captions-btn'"), 'Generate button ID not found');
    assert(pluginCode.includes('generateCaptions()'), 'Generate function call not found');
  });

  it('should handle export buttons', () => {
    assert(pluginCode.includes("'export-captions-srt-btn'"), 'SRT export button not found');
    assert(pluginCode.includes("'export-captions-mogrt-btn'"), 'MOGRT export button not found');
  });

  it('should handle apply to timeline button', () => {
    assert(pluginCode.includes("'apply-captions-timeline-btn'"), 'Apply button not found');
    assert(pluginCode.includes('applyCaptionsToTimeline'), 'Apply function not found');
  });

  it('should handle settings changes', () => {
    assert(pluginCode.includes("'caption-words-per-line'"), 'Words per line input not found');
    assert(pluginCode.includes("'caption-highlight-keywords'"), 'Highlight keywords checkbox not found');
    assert(pluginCode.includes("'caption-insert-emojis'"), 'Insert emojis checkbox not found');
    assert(pluginCode.includes("'caption-emoji-frequency'"), 'Emoji frequency select not found');
  });
});

describe('Export Functionality', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/animatedCaptions.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should support SRT export', () => {
    assert(pluginCode.includes("exportCaptions('srt')"), 'SRT export not found');
  });

  it('should support MOGRT export', () => {
    assert(pluginCode.includes("exportCaptions('mogrt')"), 'MOGRT export not found');
    assert(pluginCode.includes('/captions/export/mogrt'), 'MOGRT endpoint not called');
  });

  it('should have download functions', () => {
    assert(pluginCode.includes('function downloadJSON'), 'downloadJSON not found');
    assert(pluginCode.includes('function downloadText'), 'downloadText not found');
  });

  it('should support copy to clipboard', () => {
    assert(pluginCode.includes('copyCaptionsToClipboard'), 'Copy function not found');
    assert(pluginCode.includes('navigator.clipboard'), 'Clipboard API not used');
  });

  it('should have flattenCaptionWords helper', () => {
    assert(pluginCode.includes('function flattenCaptionWords'), 'Flatten function not found');
  });
});

// ============================================================================
// INTEGRATION TESTS
// ============================================================================

describe('Integration: Service -> API -> UI', () => {
  const servicePath = path.join(__dirname, '../services/animatedCaptions.js');
  const serverPath = path.join(__dirname, '../server.js');
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/animatedCaptions.js');

  const serviceCode = fs.readFileSync(servicePath, 'utf8');
  const serverCode = fs.readFileSync(serverPath, 'utf8');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should wire generateAnimatedCaptions correctly', () => {
    // Service exports it
    assert(serviceCode.includes('generateAnimatedCaptions'), 'Service missing');
    // Server imports and uses it
    assert(serverCode.includes("require('./services/animatedCaptions')"), 'Server import missing');
    assert(serverCode.includes('generateAnimatedCaptions(transcript'), 'Server call missing');
    // Plugin calls API
    assert(pluginCode.includes('/captions/animate'), 'Plugin API call missing');
  });

  it('should wire getTemplates correctly', () => {
    assert(serviceCode.includes('function getTemplates'), 'Service missing');
    assert(serverCode.includes('getTemplates'), 'Server missing');
    assert(pluginCode.includes('/captions/templates'), 'Plugin missing');
  });

  it('should wire applyTemplate correctly', () => {
    assert(serviceCode.includes('function applyTemplate'), 'Service missing');
    assert(serverCode.includes('applyTemplate'), 'Server missing');
    assert(pluginCode.includes('/captions/apply-template'), 'Plugin missing');
  });

  it('should wire MOGRT export correctly', () => {
    assert(serviceCode.includes('function generateMOGRTData'), 'Service missing');
    assert(serverCode.includes('generateMOGRTData'), 'Server missing');
    assert(pluginCode.includes('/captions/export/mogrt'), 'Plugin missing');
  });

  it('should use consistent template IDs', () => {
    // Service defines templates
    const templates = ['mrbeast', 'hormozi', 'gaming', 'corporate', 'karaoke'];
    templates.forEach(t => {
      assert(serviceCode.includes(`${t}:`), `Service missing ${t}`);
    });
    // Plugin uses same IDs in fallback
    templates.forEach(t => {
      assert(pluginCode.includes(`'${t}'`) || pluginCode.includes(`"${t}"`), `Plugin missing ${t}`);
    });
  });
});

// ============================================================================
// RUN TESTS
// ============================================================================

console.log('\nğŸ§ª Animated Captions E2E Tests\n');
console.log('='.repeat(50));

// Tests are run via describe/it calls above

console.log('\n' + '='.repeat(50));
console.log(`\nğŸ“Š Results: ${passedTests}/${totalTests} passed`);

if (failedTests > 0) {
  console.log(`âŒ ${failedTests} test(s) failed\n`);
  process.exit(1);
} else {
  console.log('âœ… All tests passed!\n');
  process.exit(0);
}
