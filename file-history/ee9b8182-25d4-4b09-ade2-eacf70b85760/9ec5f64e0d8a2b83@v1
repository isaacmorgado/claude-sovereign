/**
 * SPLICE Chapter Dividers E2E Tests
 * Tests chapter divider generation, API endpoints, and builder integration
 */

const fs = require('fs');
const path = require('path');

// Test results tracking
let totalTests = 0;
let passedTests = 0;
let failedTests = 0;

function describe(name, fn) {
  console.log(`\nğŸ“¦ ${name}`);
  fn();
}

function it(name, fn) {
  totalTests++;
  try {
    fn();
    passedTests++;
    console.log(`  âœ… ${name}`);
  } catch (err) {
    failedTests++;
    console.log(`  âŒ ${name}`);
    console.log(`     Error: ${err.message}`);
  }
}

function assert(condition, message) {
  if (!condition) {
    throw new Error(message || 'Assertion failed');
  }
}

// ============================================================================
// TESTS
// ============================================================================

describe('Chapter Detection Service', () => {
  const servicePath = path.join(__dirname, '../services/chapterDetection.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should export generateChapterDividers function', () => {
    assert(serviceCode.includes('function generateChapterDividers'), 'generateChapterDividers not found');
    assert(serviceCode.includes("module.exports") && serviceCode.includes('generateChapterDividers'), 'Not exported');
  });

  it('should export getDividerPresets function', () => {
    assert(serviceCode.includes('function getDividerPresets'), 'getDividerPresets not found');
    assert(serviceCode.includes('getDividerPresets'), 'Not exported');
  });

  it('should define color schemes', () => {
    assert(serviceCode.includes('colorSchemes'), 'colorSchemes not found');
    assert(serviceCode.includes("blue:"), 'blue scheme not found');
    assert(serviceCode.includes("purple:"), 'purple scheme not found');
    assert(serviceCode.includes("green:"), 'green scheme not found');
    assert(serviceCode.includes("orange:"), 'orange scheme not found');
  });

  it('should define position presets', () => {
    assert(serviceCode.includes("'center'"), 'center position not found');
    assert(serviceCode.includes("'lower-third'"), 'lower-third position not found');
    assert(serviceCode.includes("'top'"), 'top position not found');
  });

  it('should generate divider objects with required properties', () => {
    assert(serviceCode.includes('insertTime:'), 'insertTime property not found');
    assert(serviceCode.includes('duration:'), 'duration property not found');
    assert(serviceCode.includes('displayTitle:'), 'displayTitle property not found');
    assert(serviceCode.includes('colors:'), 'colors property not found');
    assert(serviceCode.includes('markerData:'), 'markerData property not found');
  });

  it('should support fade in/out animation', () => {
    assert(serviceCode.includes('fadeIn'), 'fadeIn not found');
    assert(serviceCode.includes('fadeOut'), 'fadeOut not found');
    assert(serviceCode.includes('animation:'), 'animation property not found');
  });

  it('should include chapter number option', () => {
    assert(serviceCode.includes('includeChapterNumber'), 'includeChapterNumber not found');
    assert(serviceCode.includes('Chapter ${chapterNum}'), 'Chapter numbering not found');
  });
});

describe('Server API Endpoints', () => {
  const serverPath = path.join(__dirname, '../server.js');
  const serverCode = fs.readFileSync(serverPath, 'utf8');

  it('should have POST /chapters/dividers endpoint', () => {
    assert(serverCode.includes("app.post('/chapters/dividers'"), 'Endpoint not found');
  });

  it('should require authentication for dividers endpoint', () => {
    assert(serverCode.includes("'/chapters/dividers', requireCredits"), 'Auth not required');
  });

  it('should validate chapters array', () => {
    assert(serverCode.includes("!Array.isArray(chapters)"), 'Array validation not found');
    assert(serverCode.includes("chapters.length === 0"), 'Empty array check not found');
  });

  it('should validate chapter startTime', () => {
    assert(serverCode.includes("typeof ch.startTime !== 'number'"), 'startTime validation not found');
  });

  it('should validate chapter title', () => {
    assert(serverCode.includes("!ch.title"), 'title validation not found');
  });

  it('should have GET /chapters/dividers/presets endpoint', () => {
    assert(serverCode.includes("app.get('/chapters/dividers/presets'"), 'Presets endpoint not found');
  });

  it('should call generateChapterDividers service', () => {
    assert(serverCode.includes("generateChapterDividers(chapters, settings)"), 'Service call not found');
  });

  it('should deduct usage for dividers', () => {
    assert(serverCode.includes("req.deductUsage"), 'Usage deduction not found');
  });
});

describe('UXP Plugin Builder Integration', () => {
  const builderPath = path.join(__dirname, '../../splice-plugin/js/builder.js');
  const builderCode = fs.readFileSync(builderPath, 'utf8');

  it('should have insertChapterDividers function', () => {
    assert(builderCode.includes('async function insertChapterDividers'), 'Function not found');
  });

  it('should have applyChapterDividers function', () => {
    assert(builderCode.includes('async function applyChapterDividers'), 'Function not found');
  });

  it('should have getChapterDividerPresets function', () => {
    assert(builderCode.includes('async function getChapterDividerPresets'), 'Function not found');
  });

  it('should export chapter divider functions', () => {
    assert(builderCode.includes('insertChapterDividers,'), 'insertChapterDividers not exported');
    assert(builderCode.includes('applyChapterDividers,'), 'applyChapterDividers not exported');
    assert(builderCode.includes('getChapterDividerPresets,'), 'getChapterDividerPresets not exported');
  });

  it('should call /chapters/dividers endpoint', () => {
    assert(builderCode.includes('/chapters/dividers'), 'API call not found');
  });

  it('should call /chapters/dividers/presets endpoint', () => {
    assert(builderCode.includes('/chapters/dividers/presets'), 'Presets API call not found');
  });

  it('should create markers for dividers', () => {
    assert(builderCode.includes('createMarkers'), 'createMarkers option not found');
    assert(builderCode.includes('seq.markers.createMarker'), 'Marker creation not found');
  });

  it('should use auth headers', () => {
    assert(builderCode.includes('getAuthHeaders'), 'Auth headers not used');
  });

  it('should handle video track index', () => {
    assert(builderCode.includes('videoTrackIndex'), 'videoTrackIndex not found');
  });
});

describe('Divider Data Structure', () => {
  const servicePath = path.join(__dirname, '../services/chapterDetection.js');
  const { generateChapterDividers, getDividerPresets } = require(servicePath);

  it('should generate dividers from chapters', () => {
    const chapters = [
      { startTime: 0, title: 'Introduction', description: 'Start of video' },
      { startTime: 120, title: 'Main Content', description: 'Core topic' }
    ];
    const result = generateChapterDividers(chapters);

    assert(result.dividers, 'dividers not returned');
    assert(result.dividers.length === 2, `Expected 2 dividers, got ${result.dividers.length}`);
    assert(result.metadata, 'metadata not returned');
    assert(result.metadata.count === 2, 'Count mismatch');
  });

  it('should include all required divider properties', () => {
    const chapters = [{ startTime: 0, title: 'Test' }];
    const result = generateChapterDividers(chapters);
    const divider = result.dividers[0];

    assert(typeof divider.insertTime === 'number', 'insertTime should be number');
    assert(typeof divider.duration === 'number', 'duration should be number');
    assert(typeof divider.displayTitle === 'string', 'displayTitle should be string');
    assert(divider.colors, 'colors should exist');
    assert(divider.font, 'font should exist');
    assert(divider.position, 'position should exist');
    assert(divider.markerData, 'markerData should exist');
  });

  it('should apply custom settings', () => {
    const chapters = [{ startTime: 0, title: 'Test' }];
    const settings = {
      duration: 5,
      colorScheme: 'purple',
      position: 'lower-third',
      includeChapterNumber: false
    };
    const result = generateChapterDividers(chapters, settings);
    const divider = result.dividers[0];

    assert(divider.duration === 5, 'Duration not applied');
    assert(divider.displayTitle === 'Test', 'Chapter number should be excluded');
    assert(divider.position.y === 80, 'Lower-third position not applied');
  });

  it('should return valid presets', () => {
    const presets = getDividerPresets();

    assert(Array.isArray(presets.styles), 'styles should be array');
    assert(Array.isArray(presets.colorSchemes), 'colorSchemes should be array');
    assert(Array.isArray(presets.positions), 'positions should be array');
    assert(presets.defaults, 'defaults should exist');
    assert(presets.styles.length >= 3, 'Should have at least 3 styles');
    assert(presets.colorSchemes.length >= 5, 'Should have at least 5 color schemes');
  });

  it('should include marker data with color index', () => {
    const chapters = [{ startTime: 60, title: 'Chapter One' }];
    const result = generateChapterDividers(chapters);
    const marker = result.dividers[0].markerData;

    assert(marker.time === 60, 'Marker time mismatch');
    assert(marker.name.includes('Chapter'), 'Marker name should include Chapter');
    assert(typeof marker.colorIndex === 'number', 'colorIndex should be number');
  });
});

describe('Edge Cases', () => {
  const { generateChapterDividers } = require('../services/chapterDetection.js');

  it('should handle empty chapters array', () => {
    const result = generateChapterDividers([]);
    assert(result.dividers.length === 0, 'Should return empty dividers');
    assert(result.metadata.count === 0, 'Count should be 0');
  });

  it('should handle chapters without description', () => {
    const chapters = [{ startTime: 0, title: 'No Description' }];
    const result = generateChapterDividers(chapters);
    assert(result.dividers[0].description === '', 'Description should default to empty');
  });

  it('should handle custom colors', () => {
    const chapters = [{ startTime: 0, title: 'Custom' }];
    const settings = {
      colorScheme: 'custom',
      customColors: { start: '#ff0000', end: '#00ff00', text: '#0000ff' }
    };
    const result = generateChapterDividers(chapters, settings);
    assert(result.dividers[0].colors.background === '#ff0000', 'Custom start color not applied');
  });

  it('should calculate total duration correctly', () => {
    const chapters = [
      { startTime: 0, title: 'One' },
      { startTime: 60, title: 'Two' },
      { startTime: 120, title: 'Three' }
    ];
    const settings = { duration: 4 };
    const result = generateChapterDividers(chapters, settings);
    assert(result.metadata.totalDuration === 12, 'Total duration should be 12 (3 x 4)');
  });
});

// ============================================================================
// RUN TESTS
// ============================================================================

console.log('\nğŸ§ª Chapter Dividers E2E Tests\n');
console.log('='.repeat(50));

// Tests are run via describe/it calls above

console.log('\n' + '='.repeat(50));
console.log(`\nğŸ“Š Results: ${passedTests}/${totalTests} passed`);

if (failedTests > 0) {
  console.log(`âŒ ${failedTests} test(s) failed\n`);
  process.exit(1);
} else {
  console.log('âœ… All tests passed!\n');
  process.exit(0);
}
