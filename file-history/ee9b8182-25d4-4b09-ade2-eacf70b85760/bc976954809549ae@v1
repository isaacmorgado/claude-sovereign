/**
 * SPLICE YouTube Generator E2E Tests
 * Tests YouTube description, title, and shorts metadata generation
 */

const fs = require('fs');
const path = require('path');

// Test results tracking
let totalTests = 0;
let passedTests = 0;
let failedTests = 0;

function describe(name, fn) {
  console.log(`\nüì¶ ${name}`);
  fn();
}

function it(name, fn) {
  totalTests++;
  try {
    fn();
    passedTests++;
    console.log(`  ‚úÖ ${name}`);
  } catch (err) {
    failedTests++;
    console.log(`  ‚ùå ${name}`);
    console.log(`     Error: ${err.message}`);
  }
}

function assert(condition, message) {
  if (!condition) {
    throw new Error(message || 'Assertion failed');
  }
}

// ============================================================================
// TESTS
// ============================================================================

describe('YouTube Generator Service', () => {
  const servicePath = path.join(__dirname, '../services/youtubeGenerator.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should export generateDescription function', () => {
    assert(serviceCode.includes('async function generateDescription'), 'generateDescription not found');
    assert(serviceCode.includes('module.exports') && serviceCode.includes('generateDescription'), 'Not exported');
  });

  it('should export generateTitle function', () => {
    assert(serviceCode.includes('async function generateTitle'), 'generateTitle not found');
    assert(serviceCode.includes('generateTitle'), 'Not exported');
  });

  it('should export generateShortsMetadata function', () => {
    assert(serviceCode.includes('async function generateShortsMetadata'), 'generateShortsMetadata not found');
    assert(serviceCode.includes('generateShortsMetadata'), 'Not exported');
  });

  it('should export getGeneratorOptions function', () => {
    assert(serviceCode.includes('function getGeneratorOptions'), 'getGeneratorOptions not found');
    assert(serviceCode.includes('getGeneratorOptions'), 'Not exported');
  });

  it('should support description styles', () => {
    assert(serviceCode.includes("'standard'"), 'standard style not found');
    assert(serviceCode.includes("'seo'"), 'seo style not found');
    assert(serviceCode.includes("'minimal'"), 'minimal style not found');
  });

  it('should support title styles', () => {
    assert(serviceCode.includes("'engaging'"), 'engaging style not found');
    assert(serviceCode.includes("'clickbait'"), 'clickbait style not found');
    assert(serviceCode.includes("'professional'"), 'professional style not found');
  });

  it('should support multiple platforms for shorts', () => {
    assert(serviceCode.includes("'youtube_shorts'"), 'youtube_shorts not found');
    assert(serviceCode.includes("'tiktok'"), 'tiktok not found');
    assert(serviceCode.includes("'reels'"), 'reels not found');
  });

  it('should include timestamp formatting', () => {
    assert(serviceCode.includes('function formatTimestamp'), 'formatTimestamp not found');
    assert(serviceCode.includes('padStart'), 'Padding for timestamps not found');
  });

  it('should include hashtag support', () => {
    assert(serviceCode.includes('includeHashtags'), 'includeHashtags not found');
    assert(serviceCode.includes('maxHashtags'), 'maxHashtags not found');
  });

  it('should use GPT-4o-mini model', () => {
    assert(serviceCode.includes("'gpt-4o-mini'"), 'GPT-4o-mini not configured');
  });
});

describe('Server API Endpoints', () => {
  const serverPath = path.join(__dirname, '../server.js');
  const serverCode = fs.readFileSync(serverPath, 'utf8');

  it('should have POST /youtube/description endpoint', () => {
    assert(serverCode.includes("app.post('/youtube/description'"), 'Endpoint not found');
  });

  it('should have POST /youtube/title endpoint', () => {
    assert(serverCode.includes("app.post('/youtube/title'"), 'Endpoint not found');
  });

  it('should have POST /youtube/shorts endpoint', () => {
    assert(serverCode.includes("app.post('/youtube/shorts'"), 'Endpoint not found');
  });

  it('should have GET /youtube/options endpoint', () => {
    assert(serverCode.includes("app.get('/youtube/options'"), 'Endpoint not found');
  });

  it('should require authentication for description endpoint', () => {
    assert(serverCode.includes("'/youtube/description', requireCredits"), 'Auth not required');
  });

  it('should require authentication for title endpoint', () => {
    assert(serverCode.includes("'/youtube/title', requireCredits"), 'Auth not required');
  });

  it('should require authentication for shorts endpoint', () => {
    assert(serverCode.includes("'/youtube/shorts', requireCredits"), 'Auth not required');
  });

  it('should validate transcript is required', () => {
    // Check that all three POST endpoints validate transcript
    const descMatch = serverCode.match(/\/youtube\/description[\s\S]{0,500}transcript is required/);
    const titleMatch = serverCode.match(/\/youtube\/title[\s\S]{0,500}transcript is required/);
    const shortsMatch = serverCode.match(/\/youtube\/shorts[\s\S]{0,500}transcript is required/);
    assert(descMatch, 'Description endpoint should validate transcript');
    assert(titleMatch, 'Title endpoint should validate transcript');
    assert(shortsMatch, 'Shorts endpoint should validate transcript');
  });

  it('should deduct usage for each endpoint', () => {
    assert(serverCode.includes("await req.deductUsage(0.5)"), 'Description usage deduction not found');
    assert(serverCode.includes("await req.deductUsage(0.25)"), 'Title/shorts usage deduction not found');
  });

  it('should call correct service functions', () => {
    assert(serverCode.includes("generateDescription(transcript, options)"), 'generateDescription call not found');
    assert(serverCode.includes("generateTitle(transcript, options)"), 'generateTitle call not found');
    assert(serverCode.includes("generateShortsMetadata(transcript, options)"), 'generateShortsMetadata call not found');
  });
});

describe('Generator Options', () => {
  const { getGeneratorOptions } = require('../services/youtubeGenerator');

  it('should return description styles', () => {
    const options = getGeneratorOptions();
    assert(Array.isArray(options.descriptionStyles), 'descriptionStyles should be array');
    assert(options.descriptionStyles.length >= 3, 'Should have at least 3 description styles');
    assert(options.descriptionStyles.some(s => s.id === 'standard'), 'standard style missing');
    assert(options.descriptionStyles.some(s => s.id === 'seo'), 'seo style missing');
  });

  it('should return title styles', () => {
    const options = getGeneratorOptions();
    assert(Array.isArray(options.titleStyles), 'titleStyles should be array');
    assert(options.titleStyles.length >= 4, 'Should have at least 4 title styles');
    assert(options.titleStyles.some(s => s.id === 'engaging'), 'engaging style missing');
  });

  it('should return platforms for shorts', () => {
    const options = getGeneratorOptions();
    assert(Array.isArray(options.platforms), 'platforms should be array');
    assert(options.platforms.some(p => p.id === 'youtube_shorts'), 'youtube_shorts missing');
    assert(options.platforms.some(p => p.id === 'tiktok'), 'tiktok missing');
  });

  it('should return defaults', () => {
    const options = getGeneratorOptions();
    assert(options.defaults, 'defaults should exist');
    assert(options.defaults.maxHashtags, 'maxHashtags default missing');
    assert(options.defaults.titleCount, 'titleCount default missing');
    assert(options.defaults.maxTitleLength, 'maxTitleLength default missing');
  });
});

describe('Text Extraction', () => {
  const { extractText } = require('../services/youtubeGenerator');

  it('should extract text from string', () => {
    const result = extractText('Hello world');
    assert(result === 'Hello world', 'Should return string as-is');
  });

  it('should extract text from transcript.text', () => {
    const result = extractText({ text: 'Hello from transcript' });
    assert(result === 'Hello from transcript', 'Should extract text property');
  });

  it('should extract text from segments', () => {
    const result = extractText({
      segments: [
        { text: 'Hello' },
        { text: 'World' }
      ]
    });
    assert(result === 'Hello World', 'Should join segment texts');
  });

  it('should extract text from words', () => {
    const result = extractText({
      words: [
        { word: 'Hello' },
        { word: 'World' }
      ]
    });
    assert(result === 'Hello World', 'Should join word texts');
  });

  it('should handle empty transcript', () => {
    const result = extractText({});
    assert(result === '', 'Should return empty string');
  });
});

describe('Timestamp Formatting', () => {
  const { formatTimestamp } = require('../services/youtubeGenerator');

  it('should format seconds under a minute', () => {
    assert(formatTimestamp(45) === '0:45', 'Should format as 0:45');
    assert(formatTimestamp(5) === '0:05', 'Should pad seconds');
  });

  it('should format minutes and seconds', () => {
    assert(formatTimestamp(125) === '2:05', 'Should format as 2:05');
    assert(formatTimestamp(600) === '10:00', 'Should format as 10:00');
  });

  it('should format hours when needed', () => {
    assert(formatTimestamp(3661) === '1:01:01', 'Should format as 1:01:01');
    assert(formatTimestamp(7200) === '2:00:00', 'Should format as 2:00:00');
  });

  it('should handle zero', () => {
    assert(formatTimestamp(0) === '0:00', 'Should format as 0:00');
  });
});

describe('Input Validation', () => {
  const servicePath = path.join(__dirname, '../services/youtubeGenerator.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should handle short transcripts for description', () => {
    assert(serviceCode.includes('text.length < 50'), 'Length check not found for description');
    assert(serviceCode.includes('transcript_too_short'), 'Short transcript error not found');
  });

  it('should handle short transcripts for title', () => {
    assert(serviceCode.includes("'Transcript too short for title generation'") ||
           serviceCode.includes('Transcript too short'), 'Title short check not found');
  });

  it('should handle short transcripts for shorts', () => {
    assert(serviceCode.includes('text.length < 20'), 'Length check for shorts not found');
  });

  it('should truncate long transcripts', () => {
    assert(serviceCode.includes('text.length > 10000'), 'Truncation check not found');
    assert(serviceCode.includes('substring(0, 10000)'), 'Truncation not implemented');
  });
});

describe('Error Handling', () => {
  const serverPath = path.join(__dirname, '../server.js');
  const serverCode = fs.readFileSync(serverPath, 'utf8');

  it('should catch and return errors for description', () => {
    assert(serverCode.includes("'[SPLICE] YouTube description error:'"), 'Error logging not found');
  });

  it('should catch and return errors for title', () => {
    assert(serverCode.includes("'[SPLICE] YouTube title error:'"), 'Error logging not found');
  });

  it('should catch and return errors for shorts', () => {
    assert(serverCode.includes("'[SPLICE] YouTube shorts error:'"), 'Error logging not found');
  });

  it('should return 400 for missing transcript', () => {
    const matches = serverCode.match(/res\.status\(400\)\.json\(\{ error: 'transcript is required' \}\)/g);
    assert(matches && matches.length >= 3, 'Should return 400 for missing transcript in all endpoints');
  });
});

// ============================================================================
// RUN TESTS
// ============================================================================

console.log('\nüß™ YouTube Generator E2E Tests\n');
console.log('='.repeat(50));

// Tests are run via describe/it calls above

console.log('\n' + '='.repeat(50));
console.log(`\nüìä Results: ${passedTests}/${totalTests} passed`);

if (failedTests > 0) {
  console.log(`‚ùå ${failedTests} test(s) failed\n`);
  process.exit(1);
} else {
  console.log('‚úÖ All tests passed!\n');
  process.exit(0);
}
