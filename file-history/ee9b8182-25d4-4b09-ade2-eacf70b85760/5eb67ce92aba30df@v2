/**
 * SPLICE CEP Plugin - E2E Tests
 * Tests JSX host script, panel communication, and workflow integration
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

// Test configuration
const CEP_ROOT = path.join(__dirname, '..');
const JSX_PATH = path.join(CEP_ROOT, 'jsx', 'hostScript.jsx');
const PANEL_PATH = path.join(CEP_ROOT, 'panel');

// ============================================================================
// TEST RUNNER
// ============================================================================
let totalTests = 0;
let passedTests = 0;
let failedTests = [];

function describe(name, fn) {
    console.log(`\n${name}`);
    fn();
}

function it(description, fn) {
    totalTests++;
    try {
        fn();
        passedTests++;
        console.log(`  ✓ ${description}`);
    } catch (error) {
        failedTests.push({ description, error: error.message });
        console.log(`  ✗ ${description}`);
        console.log(`    Error: ${error.message}`);
    }
}

function before(fn) {
    fn();
}

console.log('='.repeat(60));
console.log('SPLICE CEP Plugin - E2E Tests');
console.log('='.repeat(60));

// ============================================================================
// FILE STRUCTURE TESTS
// ============================================================================

describe('CEP Plugin Structure', () => {
    it('should have manifest.xml', () => {
        const manifestPath = path.join(CEP_ROOT, 'CSXS', 'manifest.xml');
        assert(fs.existsSync(manifestPath), 'manifest.xml should exist');

        const content = fs.readFileSync(manifestPath, 'utf8');
        assert(content.includes('com.splice.panel'), 'Should have correct extension ID');
        assert(content.includes('PPRO'), 'Should target Premiere Pro');
        assert(content.includes('./jsx/hostScript.jsx'), 'Should reference JSX script');
    });

    it('should have JSX host script', () => {
        assert(fs.existsSync(JSX_PATH), 'hostScript.jsx should exist');

        const content = fs.readFileSync(JSX_PATH, 'utf8');
        assert(content.includes('SPLICE_VERSION'), 'Should have version constant');
        assert(content.includes('function initialise'), 'Should have initialise function');
    });

    it('should have panel HTML', () => {
        const htmlPath = path.join(PANEL_PATH, 'index.html');
        assert(fs.existsSync(htmlPath), 'index.html should exist');

        const content = fs.readFileSync(htmlPath, 'utf8');
        assert(content.includes('id="goBtn"'), 'Should have GO button');
        assert(content.includes('id="creditBadge"'), 'Should have credit badge');
    });

    it('should have panel JavaScript files', () => {
        const mainJs = path.join(PANEL_PATH, 'js', 'main.js');
        const configJs = path.join(PANEL_PATH, 'js', 'config.js');
        const csInterface = path.join(PANEL_PATH, 'js', 'CSInterface.js');
        const builderJs = path.join(PANEL_PATH, 'js', 'builder.js');

        assert(fs.existsSync(mainJs), 'main.js should exist');
        assert(fs.existsSync(configJs), 'config.js should exist');
        assert(fs.existsSync(csInterface), 'CSInterface.js should exist');
        assert(fs.existsSync(builderJs), 'builder.js should exist');
    });

    it('should have panel CSS', () => {
        const cssPath = path.join(PANEL_PATH, 'css', 'style.css');
        assert(fs.existsSync(cssPath), 'style.css should exist');
    });
});

// ============================================================================
// JSX HOST SCRIPT TESTS
// ============================================================================

describe('JSX Host Script Functions', () => {
    let jsxContent;

    before(() => {
        jsxContent = fs.readFileSync(JSX_PATH, 'utf8');
    });

    it('should have initialization functions', () => {
        assert(jsxContent.includes('function initialise()'), 'Should have initialise');
        assert(jsxContent.includes('function storeDefaultTimecode()'), 'Should have storeDefaultTimecode');
        assert(jsxContent.includes('function checkSequenceOpen()'), 'Should have checkSequenceOpen');
    });

    it('should have time conversion utilities', () => {
        assert(jsxContent.includes('function quantise_time'), 'Should have quantise_time');
        assert(jsxContent.includes('function frames_to_time'), 'Should have frames_to_time');
        assert(jsxContent.includes('function seconds_to_ticks'), 'Should have seconds_to_ticks');
        assert(jsxContent.includes('TICKS_PER_SECOND = 254016000000'), 'Should have correct TICKS constant');
    });

    it('should have razor operations', () => {
        assert(jsxContent.includes('function razorSequenceAtFrames'), 'Should have razorSequenceAtFrames');
        assert(jsxContent.includes('function razorSequenceAtSeconds'), 'Should have razorSequenceAtSeconds');
        assert(jsxContent.includes('function razorTrackAtFrames'), 'Should have razorTrackAtFrames');
        assert(jsxContent.includes('function razorSequenceAtFramesArray'), 'Should have razorSequenceAtFramesArray');
    });

    it('should have clip operations', () => {
        assert(jsxContent.includes('function getClipsInTrack'), 'Should have getClipsInTrack');
        assert(jsxContent.includes('function deleteClipsAtSilencePointsInTrack'), 'Should have deleteClipsAtSilencePointsInTrack');
        assert(jsxContent.includes('function makeRemainingClipsContiguousInTrack'), 'Should have makeRemainingClipsContiguousInTrack');
        assert(jsxContent.includes('function setClipInOutPoints'), 'Should have setClipInOutPoints');
    });

    it('should have track operations', () => {
        assert(jsxContent.includes('function getTrackNames'), 'Should have getTrackNames');
        assert(jsxContent.includes('function getNumTracks'), 'Should have getNumTracks');
        assert(jsxContent.includes('function addVideoTrack'), 'Should have addVideoTrack');
        assert(jsxContent.includes('function addAudioTrack'), 'Should have addAudioTrack');
    });

    it('should have mute state operations', () => {
        assert(jsxContent.includes('function getMuteState'), 'Should have getMuteState');
        assert(jsxContent.includes('function setMuteState'), 'Should have setMuteState');
    });

    it('should have project item operations', () => {
        assert(jsxContent.includes('function findItemByName'), 'Should have findItemByName');
        assert(jsxContent.includes('function findItemByPath'), 'Should have findItemByPath');
        assert(jsxContent.includes('function importFile'), 'Should have importFile');
        assert(jsxContent.includes('function getSpliceBin'), 'Should have getSpliceBin');
    });

    it('should have marker operations', () => {
        assert(jsxContent.includes('function createMarker'), 'Should have createMarker');
        assert(jsxContent.includes('function getMarkers'), 'Should have getMarkers');
        assert(jsxContent.includes('function deleteMarker'), 'Should have deleteMarker');
        assert(jsxContent.includes('function deleteAllMarkers'), 'Should have deleteAllMarkers');
    });

    it('should have chapter marker operations', () => {
        assert(jsxContent.includes('function addChapterMarker'), 'Should have addChapterMarker');
        assert(jsxContent.includes('function getChapterMarkers'), 'Should have getChapterMarkers');
    });

    it('should have sequence building operations', () => {
        assert(jsxContent.includes('function cloneSequence'), 'Should have cloneSequence');
        assert(jsxContent.includes('function createNewSequence'), 'Should have createNewSequence');
        assert(jsxContent.includes('function buildSequenceFromCutList'), 'Should have buildSequenceFromCutList');
        assert(jsxContent.includes('function clearSequence'), 'Should have clearSequence');
    });

    it('should have color label operations', () => {
        assert(jsxContent.includes('COLOR_LABELS'), 'Should have COLOR_LABELS constant');
        assert(jsxContent.includes('SEGMENT_COLORS'), 'Should have SEGMENT_COLORS mapping');
        assert(jsxContent.includes('function setClipColorLabel'), 'Should have setClipColorLabel');
    });

    it('should have zoom marker support', () => {
        assert(jsxContent.includes('function addZoomMarker'), 'Should have addZoomMarker');
    });

    it('should have undo operations', () => {
        assert(jsxContent.includes('function undo()'), 'Should have undo');
        assert(jsxContent.includes('function redo()'), 'Should have redo');
    });

    it('should return JSON from all major functions', () => {
        // Check that functions return JSON.stringify for complex data
        const jsonFunctions = [
            'getActiveSequence',
            'getSequenceSettings',
            'cloneSequence',
            'getClipsInTrack',
            'getTrackNames',
            'getMuteState',
            'getAllProjectItems',
            'getMarkers',
            'getChapterMarkers',
            'buildSequenceFromCutList'
        ];

        jsonFunctions.forEach(fn => {
            const regex = new RegExp(`function ${fn}[\\s\\S]*?return JSON\\.stringify`);
            assert(regex.test(jsxContent), `${fn} should return JSON.stringify`);
        });
    });
});

// ============================================================================
// PANEL JAVASCRIPT TESTS
// ============================================================================

describe('Panel JavaScript', () => {
    let mainJs;
    let configJs;

    before(() => {
        mainJs = fs.readFileSync(path.join(PANEL_PATH, 'js', 'main.js'), 'utf8');
        configJs = fs.readFileSync(path.join(PANEL_PATH, 'js', 'config.js'), 'utf8');
    });

    describe('config.js', () => {
        it('should have backend configuration', () => {
            assert(configJs.includes('SPLICE_CONFIG'), 'Should have SPLICE_CONFIG');
            assert(configJs.includes('BACKEND_PROD'), 'Should have production backend URL');
            assert(configJs.includes('BACKEND_DEV'), 'Should have development backend URL');
        });

        it('should have getBackendUrl function', () => {
            assert(configJs.includes('function getBackendUrl'), 'Should have getBackendUrl');
        });

        it('should have JSX bridge', () => {
            assert(configJs.includes('const jsx'), 'Should have jsx object');
            assert(configJs.includes('evalScript:'), 'Should have evalScript method');
            assert(configJs.includes('call:'), 'Should have call method');
        });

        it('should have fetch utilities', () => {
            assert(configJs.includes('async function fetchWithTimeout'), 'Should have fetchWithTimeout');
            assert(configJs.includes('async function parseErrorResponse'), 'Should have parseErrorResponse');
        });

        it('should have auth headers function', () => {
            assert(configJs.includes('function getAuthHeaders'), 'Should have getAuthHeaders');
            assert(configJs.includes('x-stripe-customer-id'), 'Should include Stripe header');
            assert(configJs.includes('x-license-key'), 'Should include license key header');
        });

        it('should have settings management', () => {
            assert(configJs.includes('DEFAULT_SETTINGS'), 'Should have DEFAULT_SETTINGS');
            assert(configJs.includes('function getSettings'), 'Should have getSettings');
            assert(configJs.includes('function saveSettings'), 'Should have saveSettings');
        });

        it('should have offline detection', () => {
            assert(configJs.includes('function isOnline'), 'Should have isOnline');
            assert(configJs.includes('function initOfflineDetection'), 'Should have initOfflineDetection');
            assert(configJs.includes('function updateOfflineUI'), 'Should have updateOfflineUI');
        });

        it('should have utility functions', () => {
            assert(configJs.includes('function formatTime'), 'Should have formatTime');
            assert(configJs.includes('function setStatus'), 'Should have setStatus');
        });
    });

    describe('main.js', () => {
        it('should have UI caching', () => {
            assert(mainJs.includes('const ui = {}'), 'Should have ui object');
            assert(mainJs.includes('function cacheUIElements'), 'Should have cacheUIElements');
        });

        it('should have initialization', () => {
            assert(mainJs.includes("addEventListener('DOMContentLoaded'"), 'Should have DOMContentLoaded listener');
            assert(mainJs.includes('cacheUIElements()'), 'Should call cacheUIElements');
            assert(mainJs.includes('loadSettingsToUI()'), 'Should call loadSettingsToUI');
        });

        it('should have JSX connection check', () => {
            assert(mainJs.includes('async function checkJSXConnection'), 'Should have checkJSXConnection');
            assert(mainJs.includes('async function checkSequenceOpen'), 'Should have checkSequenceOpen');
        });

        it('should have preset management', () => {
            assert(mainJs.includes('const PRESETS'), 'Should have PRESETS object');
            assert(mainJs.includes('function initPresetSelector'), 'Should have initPresetSelector');
            assert(mainJs.includes('function applyPreset'), 'Should have applyPreset');
        });

        it('should have main workflow', () => {
            assert(mainJs.includes('function initGoButton'), 'Should have initGoButton');
            assert(mainJs.includes('async function runDetection'), 'Should have runDetection');
        });

        it('should have progress UI', () => {
            assert(mainJs.includes('function showProgress'), 'Should have showProgress');
            assert(mainJs.includes('function updateProgress'), 'Should have updateProgress');
            assert(mainJs.includes('function hideProgress'), 'Should have hideProgress');
        });

        it('should have preview functionality', () => {
            assert(mainJs.includes('function showCombinedPreview'), 'Should have showCombinedPreview');
            assert(mainJs.includes('function renderPreviewList'), 'Should have renderPreviewList');
            assert(mainJs.includes('function toggleSilenceSelection'), 'Should have toggleSilenceSelection');
        });

        it('should have sequence building', () => {
            assert(mainJs.includes('async function buildSequence'), 'Should have buildSequence');
        });

        it('should have marker functionality', () => {
            assert(mainJs.includes('async function applyPreviewAndMarkers'), 'Should have applyPreviewAndMarkers');
            assert(mainJs.includes('async function addChapterMarkers'), 'Should have addChapterMarkers');
        });

        it('should have chapter functionality', () => {
            assert(mainJs.includes('function renderChapterList'), 'Should have renderChapterList');
            assert(mainJs.includes('function copyYouTubeTimestamps'), 'Should have copyYouTubeTimestamps');
        });

        it('should have modal handlers', () => {
            assert(mainJs.includes('function initModals'), 'Should have initModals');
            assert(mainJs.includes('function showLoginModal'), 'Should have showLoginModal');
            assert(mainJs.includes('async function activateLicense'), 'Should have activateLicense');
        });

        it('should have credits functionality', () => {
            assert(mainJs.includes('function initCredits'), 'Should have initCredits');
            assert(mainJs.includes('async function updateCredits'), 'Should have updateCredits');
        });

        it('should export debug interface', () => {
            assert(mainJs.includes('window.spliceDebug'), 'Should export spliceDebug');
        });
    });
});

// ============================================================================
// PANEL HTML TESTS
// ============================================================================

describe('Panel HTML', () => {
    let htmlContent;

    before(() => {
        htmlContent = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    });

    it('should have proper document structure', () => {
        assert(htmlContent.includes('<!DOCTYPE html>'), 'Should have DOCTYPE');
        assert(htmlContent.includes('<html>'), 'Should have html tag');
        assert(htmlContent.includes('<head>'), 'Should have head tag');
        assert(htmlContent.includes('<body>'), 'Should have body tag');
    });

    it('should include all scripts in correct order', () => {
        assert(htmlContent.includes('CSInterface.js'), 'Should include CSInterface.js');
        assert(htmlContent.includes('config.js'), 'Should include config.js');
        assert(htmlContent.includes('main.js'), 'Should include main.js');

        // Check order
        const csPos = htmlContent.indexOf('CSInterface.js');
        const configPos = htmlContent.indexOf('config.js');
        const mainPos = htmlContent.indexOf('main.js');
        assert(csPos < configPos, 'CSInterface.js should be before config.js');
        assert(configPos < mainPos, 'config.js should be before main.js');
    });

    it('should have header elements', () => {
        assert(htmlContent.includes('id="creditBadge"'), 'Should have credit badge');
        assert(htmlContent.includes('id="helpBtn"'), 'Should have help button');
        assert(htmlContent.includes('id="settingsBtn"'), 'Should have settings button');
    });

    it('should have GO button', () => {
        assert(htmlContent.includes('id="goBtn"'), 'Should have GO button');
        assert(htmlContent.includes('class="go-btn"'), 'Should have go-btn class');
    });

    it('should have options panel', () => {
        assert(htmlContent.includes('id="optionsToggle"'), 'Should have options toggle');
        assert(htmlContent.includes('id="optionsPanel"'), 'Should have options panel');
    });

    it('should have preset selector', () => {
        assert(htmlContent.includes('id="presetSelector"'), 'Should have preset selector');
        assert(htmlContent.includes('value="podcast"'), 'Should have podcast preset');
        assert(htmlContent.includes('value="interview"'), 'Should have interview preset');
    });

    it('should have sensitivity slider', () => {
        assert(htmlContent.includes('id="sensitivitySlider"'), 'Should have sensitivity slider');
        assert(htmlContent.includes('id="sensitivityValue"'), 'Should have sensitivity value display');
    });

    it('should have feature toggles', () => {
        assert(htmlContent.includes('id="enableTakesDetection"'), 'Should have takes detection toggle');
        assert(htmlContent.includes('id="enableJCut"'), 'Should have J-cut toggle');
        assert(htmlContent.includes('id="enableZoom"'), 'Should have zoom toggle');
        assert(htmlContent.includes('id="enableChapters"'), 'Should have chapters toggle');
    });

    it('should have J-cut settings', () => {
        assert(htmlContent.includes('id="jcutSettings"'), 'Should have J-cut settings');
        assert(htmlContent.includes('id="jcutLeadIn"'), 'Should have lead-in slider');
        assert(htmlContent.includes('id="jcutLeadOut"'), 'Should have lead-out slider');
    });

    it('should have zoom settings', () => {
        assert(htmlContent.includes('id="zoomSettings"'), 'Should have zoom settings');
        assert(htmlContent.includes('id="zoomFrequency"'), 'Should have zoom frequency');
        assert(htmlContent.includes('id="zoomPreset"'), 'Should have zoom preset');
        assert(htmlContent.includes('id="zoomPlacement"'), 'Should have zoom placement');
    });

    it('should have chapter settings', () => {
        assert(htmlContent.includes('id="chapterSettings"'), 'Should have chapter settings');
        assert(htmlContent.includes('id="maxChapters"'), 'Should have max chapters');
        assert(htmlContent.includes('id="minChapterLength"'), 'Should have min chapter length');
    });

    it('should have results area', () => {
        assert(htmlContent.includes('class="results-area"'), 'Should have results area');
        assert(htmlContent.includes('id="progressContainer"'), 'Should have progress container');
        assert(htmlContent.includes('id="resultsEmpty"'), 'Should have empty results state');
    });

    it('should have preview section', () => {
        assert(htmlContent.includes('id="combinedPreview"'), 'Should have combined preview');
        assert(htmlContent.includes('id="previewList"'), 'Should have preview list');
        assert(htmlContent.includes('id="selectAllSilences"'), 'Should have select all checkbox');
    });

    it('should have action buttons', () => {
        assert(htmlContent.includes('id="applyPreviewBtn"'), 'Should have apply button');
        assert(htmlContent.includes('id="buildSequenceBtn"'), 'Should have build sequence button');
        assert(htmlContent.includes('id="cancelPreviewBtn"'), 'Should have cancel button');
    });

    it('should have chapter results section', () => {
        assert(htmlContent.includes('id="chapterResults"'), 'Should have chapter results');
        assert(htmlContent.includes('id="chapterList"'), 'Should have chapter list');
        assert(htmlContent.includes('id="copyYouTubeBtn"'), 'Should have copy YouTube button');
        assert(htmlContent.includes('id="addChapterMarkersBtn"'), 'Should have add markers button');
    });

    it('should have modals', () => {
        assert(htmlContent.includes('id="settingsModal"'), 'Should have settings modal');
        assert(htmlContent.includes('id="loginModal"'), 'Should have login modal');
        assert(htmlContent.includes('id="licenseKeyInput"'), 'Should have license key input');
    });

    it('should have ARIA attributes', () => {
        assert(htmlContent.includes('role="status"'), 'Should have status role');
        assert(htmlContent.includes('role="dialog"'), 'Should have dialog role');
        assert(htmlContent.includes('aria-modal="true"'), 'Should have aria-modal');
        assert(htmlContent.includes('aria-live="polite"'), 'Should have aria-live');
    });
});

// ============================================================================
// CSS TESTS
// ============================================================================

describe('Panel CSS', () => {
    let cssContent;

    before(() => {
        cssContent = fs.readFileSync(path.join(PANEL_PATH, 'css', 'style.css'), 'utf8');
    });

    it('should have base styles', () => {
        assert(cssContent.includes('body {'), 'Should have body styles');
        assert(cssContent.includes('background: #323232'), 'Should have dark background');
        assert(cssContent.includes('color: #e1e1e1'), 'Should have light text color');
    });

    it('should have header styles', () => {
        assert(cssContent.includes('.header {'), 'Should have header styles');
        assert(cssContent.includes('.icon-btn'), 'Should have icon button styles');
    });

    it('should have credit badge styles', () => {
        assert(cssContent.includes('.credit-badge'), 'Should have credit badge');
        assert(cssContent.includes('.credit-badge.ok'), 'Should have ok state');
        assert(cssContent.includes('.credit-badge.low'), 'Should have low state');
        assert(cssContent.includes('.credit-badge.error'), 'Should have error state');
    });

    it('should have GO button styles', () => {
        assert(cssContent.includes('.go-btn'), 'Should have go button styles');
        assert(cssContent.includes('linear-gradient'), 'Should have gradient background');
    });

    it('should have slider styles', () => {
        assert(cssContent.includes('.slider-container'), 'Should have slider container');
        assert(cssContent.includes('input[type="range"]'), 'Should have range input styles');
    });

    it('should have preview styles', () => {
        assert(cssContent.includes('.preview-section'), 'Should have preview section');
        assert(cssContent.includes('.preview-list'), 'Should have preview list');
        assert(cssContent.includes('.preview-item'), 'Should have preview item');
    });

    it('should have modal styles', () => {
        assert(cssContent.includes('.modal'), 'Should have modal styles');
        assert(cssContent.includes('.modal-content'), 'Should have modal content');
        assert(cssContent.includes('.modal-header'), 'Should have modal header');
    });

    it('should have button styles', () => {
        assert(cssContent.includes('.btn'), 'Should have button base');
        assert(cssContent.includes('.btn-primary'), 'Should have primary button');
        assert(cssContent.includes('.btn-secondary'), 'Should have secondary button');
    });

    it('should have utility classes', () => {
        assert(cssContent.includes('.hidden'), 'Should have hidden class');
        assert(cssContent.includes('.collapsed'), 'Should have collapsed class');
    });
});

// ============================================================================
// CSINTERFACE TESTS
// ============================================================================

describe('CSInterface', () => {
    let csContent;

    before(() => {
        csContent = fs.readFileSync(path.join(PANEL_PATH, 'js', 'CSInterface.js'), 'utf8');
    });

    it('should define CSInterface class', () => {
        assert(csContent.includes('function CSInterface()'), 'Should have constructor');
    });

    it('should have evalScript method', () => {
        assert(csContent.includes('prototype.evalScript'), 'Should have evalScript');
    });

    it('should have getHostEnvironment method', () => {
        assert(csContent.includes('prototype.getHostEnvironment'), 'Should have getHostEnvironment');
    });

    it('should have getSystemPath method', () => {
        assert(csContent.includes('prototype.getSystemPath'), 'Should have getSystemPath');
    });

    it('should have event methods', () => {
        assert(csContent.includes('prototype.addEventListener'), 'Should have addEventListener');
        assert(csContent.includes('prototype.removeEventListener'), 'Should have removeEventListener');
    });

    it('should export to window', () => {
        assert(csContent.includes('window.CSInterface = CSInterface'), 'Should export to window');
    });
});

// ============================================================================
// BUILDER.JS TESTS
// ============================================================================

describe('Builder Module', () => {
    let builderJs;

    before(() => {
        builderJs = fs.readFileSync(path.join(PANEL_PATH, 'js', 'builder.js'), 'utf8');
    });

    it('should have color constants', () => {
        assert(builderJs.includes('const SPLICE_COLORS'), 'Should have SPLICE_COLORS');
        assert(builderJs.includes('const SEGMENT_COLORS'), 'Should have SEGMENT_COLORS');
        assert(builderJs.includes('const COLOR_HINT_MAP'), 'Should have COLOR_HINT_MAP');
    });

    it('should have project item cache', () => {
        assert(builderJs.includes('const projectItemCache'), 'Should have projectItemCache');
        assert(builderJs.includes('async function buildProjectItemCache'), 'Should have buildProjectItemCache');
        assert(builderJs.includes('function clearProjectItemCache'), 'Should have clearProjectItemCache');
    });

    it('should have sequence building', () => {
        assert(builderJs.includes('async function buildSequenceFromCutList'), 'Should have buildSequenceFromCutList');
        assert(builderJs.includes('function processCutList'), 'Should have processCutList');
    });

    it('should have marker operations', () => {
        assert(builderJs.includes('async function addSilenceMarkers'), 'Should have addSilenceMarkers');
        assert(builderJs.includes('async function addTakeMarkers'), 'Should have addTakeMarkers');
        assert(builderJs.includes('async function addChapterMarkers'), 'Should have addChapterMarkers');
        assert(builderJs.includes('async function addZoomMarkers'), 'Should have addZoomMarkers');
        assert(builderJs.includes('async function clearSpliceMarkers'), 'Should have clearSpliceMarkers');
    });

    it('should have razor operations', () => {
        assert(builderJs.includes('async function razorAtSilences'), 'Should have razorAtSilences');
        assert(builderJs.includes('async function deleteClipsAtSilences'), 'Should have deleteClipsAtSilences');
    });

    it('should have utility functions', () => {
        assert(builderJs.includes('function getColorForSegment'), 'Should have getColorForSegment');
        assert(builderJs.includes('async function getActiveSequence'), 'Should have getActiveSequence');
        assert(builderJs.includes('async function checkSequenceOpen'), 'Should have checkSequenceOpen');
        assert(builderJs.includes('async function cloneSequence'), 'Should have cloneSequence');
        assert(builderJs.includes('async function undo'), 'Should have undo');
    });

    it('should export via window.spliceBuilder', () => {
        assert(builderJs.includes('window.spliceBuilder'), 'Should export to window');
    });

    it('should use jsx.call for all JSX operations', () => {
        assert(builderJs.includes("jsx.call('getAllProjectItems')"), 'Should call getAllProjectItems');
        assert(builderJs.includes("jsx.call('buildSequenceFromCutList'"), 'Should call buildSequenceFromCutList');
        assert(builderJs.includes("jsx.call('createMarker'"), 'Should call createMarker');
        assert(builderJs.includes("jsx.call('addChapterMarker'"), 'Should call addChapterMarker');
    });
});

// ============================================================================
// BACKEND API COMPATIBILITY TESTS
// ============================================================================

describe('Backend API Compatibility', () => {
    let configJs;
    let mainJs;

    before(() => {
        configJs = fs.readFileSync(path.join(PANEL_PATH, 'js', 'config.js'), 'utf8');
        mainJs = fs.readFileSync(path.join(PANEL_PATH, 'js', 'main.js'), 'utf8');
    });

    it('should call /silences-rms endpoint', () => {
        assert(mainJs.includes('/silences-rms'), 'Should use /silences-rms endpoint');
    });

    it('should call /analyze endpoint', () => {
        assert(mainJs.includes('/analyze'), 'Should use /analyze endpoint');
    });

    it('should call /chapters endpoint', () => {
        assert(mainJs.includes('/chapters'), 'Should use /chapters endpoint');
    });

    it('should call /zoom endpoint', () => {
        assert(mainJs.includes('/zoom'), 'Should use /zoom endpoint');
    });

    it('should call /cut-list endpoint', () => {
        assert(mainJs.includes('/cut-list'), 'Should use /cut-list endpoint');
    });

    it('should call /credits endpoint', () => {
        assert(mainJs.includes('/credits'), 'Should use /credits endpoint');
    });

    it('should call /license/activate endpoint', () => {
        assert(mainJs.includes('/license/activate'), 'Should use /license/activate endpoint');
    });

    it('should include auth headers in requests', () => {
        assert(mainJs.includes('getAuthHeaders()'), 'Should use getAuthHeaders');
    });
});

// ============================================================================
// PRINT SUMMARY
// ============================================================================

console.log('\n' + '='.repeat(60));
console.log(`Total: ${totalTests} | Passed: ${passedTests} | Failed: ${failedTests.length}`);

if (failedTests.length > 0) {
    console.log('\nFailed Tests:');
    failedTests.forEach(({ description, error }) => {
        console.log(`  - ${description}: ${error}`);
    });
    process.exit(1);
} else {
    console.log('\nAll tests passed!');
    process.exit(0);
}
