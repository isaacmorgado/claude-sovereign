/**
 * SPLICE Text-Based Editing E2E Tests
 *
 * Tests service functions, API endpoints, and UI wiring.
 * Run: node tests/text-based-editing.test.js
 */

const fs = require('fs');
const path = require('path');

// Test results tracking
let totalTests = 0;
let passedTests = 0;
let failedTests = 0;

function describe(name, fn) {
  console.log(`\nğŸ“¦ ${name}`);
  fn();
}

function it(name, fn) {
  totalTests++;
  try {
    fn();
    passedTests++;
    console.log(`  âœ… ${name}`);
  } catch (err) {
    failedTests++;
    console.log(`  âŒ ${name}`);
    console.log(`     Error: ${err.message}`);
  }
}

function assert(condition, message) {
  if (!condition) {
    throw new Error(message || 'Assertion failed');
  }
}

// ============================================================================
// SERVICE TESTS
// ============================================================================

describe('Text-Based Editing Service', () => {
  const servicePath = path.join(__dirname, '../services/textBasedEditing.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should export generateEditableTranscript function', () => {
    assert(serviceCode.includes('function generateEditableTranscript'), 'Function not found');
    assert(serviceCode.includes('module.exports') && serviceCode.includes('generateEditableTranscript'), 'Not exported');
  });

  it('should export applyTextEdits function', () => {
    assert(serviceCode.includes('function applyTextEdits'), 'Function not found');
    assert(serviceCode.includes('applyTextEdits'), 'Not exported');
  });

  it('should export detectDeletions function', () => {
    assert(serviceCode.includes('function detectDeletions'), 'Function not found');
    assert(serviceCode.includes('detectDeletions'), 'Not exported');
  });

  it('should export detectReorderings function', () => {
    assert(serviceCode.includes('function detectReorderings'), 'Function not found');
    assert(serviceCode.includes('detectReorderings'), 'Not exported');
  });

  it('should export generateEditCutList function', () => {
    assert(serviceCode.includes('function generateEditCutList'), 'Function not found');
    assert(serviceCode.includes('generateEditCutList'), 'Not exported');
  });

  it('should export searchTranscript function', () => {
    assert(serviceCode.includes('function searchTranscript'), 'Function not found');
    assert(serviceCode.includes('searchTranscript'), 'Not exported');
  });

  it('should export searchAndReplace function', () => {
    assert(serviceCode.includes('function searchAndReplace'), 'Function not found');
    assert(serviceCode.includes('searchAndReplace'), 'Not exported');
  });

  it('should export previewEdits function', () => {
    assert(serviceCode.includes('function previewEdits'), 'Function not found');
    assert(serviceCode.includes('previewEdits'), 'Not exported');
  });
});

describe('Diff Algorithm', () => {
  const servicePath = path.join(__dirname, '../services/textBasedEditing.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should implement LCS-based diff', () => {
    assert(serviceCode.includes('computeDiff'), 'computeDiff not found');
    assert(serviceCode.includes('LCS') || serviceCode.includes('Longest Common Subsequence'), 'LCS reference not found');
  });

  it('should handle keep, insert, and delete operations', () => {
    assert(serviceCode.includes("type: 'keep'"), 'keep type not found');
    assert(serviceCode.includes("type: 'insert'"), 'insert type not found');
    assert(serviceCode.includes("type: 'delete'"), 'delete type not found');
  });

  it('should generate unique word IDs', () => {
    assert(serviceCode.includes('word_${index}'), 'Word ID pattern not found');
    assert(serviceCode.includes('Math.random()'), 'Random component not found');
  });
});

describe('Service Functions Runtime', () => {
  const service = require('../services/textBasedEditing');

  it('should generate editable transcript', () => {
    const transcript = {
      words: [
        { word: 'Hello', start: 0, end: 0.5 },
        { word: 'World', start: 0.6, end: 1.0 }
      ]
    };
    const result = service.generateEditableTranscript(transcript);
    assert(result.success, 'Should succeed');
    assert(result.editableTranscript, 'editableTranscript missing');
    assert(result.editableTranscript.words.length === 2, 'Should have 2 words');
    assert(result.editableTranscript.words[0].id, 'Words should have IDs');
  });

  it('should fail for empty transcript', () => {
    const result = service.generateEditableTranscript({ words: [] });
    assert(!result.success, 'Should fail for empty');
    assert(result.error, 'Should have error message');
  });

  it('should extract words from segments', () => {
    const words = service.extractWords({
      segments: [{ words: [{ word: 'Test', start: 0, end: 0.5 }] }]
    });
    assert(words.length === 1, 'Should extract 1 word');
  });

  it('should tokenize text', () => {
    const tokens = service.tokenizeText('Hello  World  Test');
    assert(tokens.length === 3, 'Should have 3 tokens');
    assert(tokens[0] === 'Hello', 'First token mismatch');
  });

  it('should group words into paragraphs', () => {
    const words = [
      { word: 'Hello.', start: 0, end: 0.5 },
      { word: 'World', start: 0.6, end: 1.0 }
    ];
    const paragraphs = service.groupIntoParagraphs(words);
    assert(paragraphs.length >= 1, 'Should have at least 1 paragraph');
  });

  it('should apply text edits', () => {
    const transcript = {
      words: [
        { id: 'w1', word: 'Hello', start: 0, end: 0.5 },
        { id: 'w2', word: 'World', start: 0.6, end: 1.0 },
        { id: 'w3', word: 'Test', start: 1.1, end: 1.5 }
      ],
      plainText: 'Hello World Test'
    };
    const result = service.applyTextEdits(transcript, 'Hello Test');
    assert(result.success, 'Should succeed');
    assert(result.operations.length > 0, 'Should have operations');
    assert(result.stats.deletions >= 1, 'Should detect deletion');
  });

  it('should detect deletions', () => {
    const diff = [
      { type: 'keep', word: { id: 'w1', word: 'Hello', start: 0, end: 0.5 } },
      { type: 'delete', originalIndex: 1, word: { id: 'w2', word: 'World', start: 0.6, end: 1.0 } }
    ];
    const deletions = service.detectDeletions(diff);
    assert(deletions.length === 1, 'Should detect 1 deletion');
    assert(deletions[0].wordId === 'w2', 'Should identify correct word');
  });

  it('should search transcript', () => {
    const transcript = {
      words: [
        { id: 'w1', word: 'Hello', start: 0, end: 0.5 },
        { id: 'w2', word: 'World', start: 0.6, end: 1.0 }
      ]
    };
    const result = service.searchTranscript(transcript, 'Hello');
    assert(result.success, 'Should succeed');
    assert(result.totalMatches === 1, 'Should find 1 match');
    assert(result.matches[0].start === 0, 'Should have correct timestamp');
  });

  it('should search and replace', () => {
    const transcript = {
      words: [
        { id: 'w1', word: 'Hello', start: 0, end: 0.5 },
        { id: 'w2', word: 'World', start: 0.6, end: 1.0 }
      ]
    };
    const result = service.searchAndReplace(transcript, 'Hello', '');
    assert(result.success, 'Should succeed');
    assert(result.matchCount === 1, 'Should find 1 match');
    assert(result.operations.length === 1, 'Should have 1 operation');
    assert(result.operations[0].type === 'cut', 'Should be cut operation');
  });

  it('should generate edit cut list', () => {
    const operations = [
      { type: 'cut', start: 5, end: 10, wordIds: ['w1'] }
    ];
    const result = service.generateEditCutList(operations, { duration: 30 });
    assert(result.success, 'Should succeed');
    assert(result.cutList, 'Should have cutList');
    assert(result.cutList.version === '3.5', 'Should be v3.5 format');
    assert(result.cutList.segments.length >= 1, 'Should have segments');
  });

  it('should preview edits', () => {
    const transcript = {
      words: [
        { id: 'w1', word: 'Hello', start: 0, end: 0.5 },
        { id: 'w2', word: 'World', start: 0.6, end: 1.0 }
      ],
      duration: 1.0,
      plainText: 'Hello World'
    };
    const result = service.previewEdits(transcript, 'Hello');
    assert(result.success, 'Should succeed');
    assert(result.changes, 'Should have changes');
    assert(result.impact, 'Should have impact');
  });

  it('should format time correctly', () => {
    assert(service.formatTime(65) === '1:05.00', 'Should format 65s as 1:05.00');
    assert(service.formatTime(0) === '0:00.00', 'Should format 0 as 0:00.00');
  });
});

// ============================================================================
// API ENDPOINT TESTS
// ============================================================================

describe('Server API Endpoints', () => {
  const serverPath = path.join(__dirname, '../server.js');
  const serverCode = fs.readFileSync(serverPath, 'utf8');

  it('should have POST /text-edit/prepare endpoint', () => {
    assert(serverCode.includes("app.post('/text-edit/prepare'"), 'Endpoint not found');
  });

  it('should have POST /text-edit/apply endpoint', () => {
    assert(serverCode.includes("app.post('/text-edit/apply'"), 'Endpoint not found');
  });

  it('should have POST /text-edit/search endpoint', () => {
    assert(serverCode.includes("app.post('/text-edit/search'"), 'Endpoint not found');
  });

  it('should have POST /text-edit/replace endpoint', () => {
    assert(serverCode.includes("app.post('/text-edit/replace'"), 'Endpoint not found');
  });

  it('should have POST /text-edit/preview endpoint', () => {
    assert(serverCode.includes("app.post('/text-edit/preview'"), 'Endpoint not found');
  });

  it('should have POST /text-edit/cut-list endpoint', () => {
    assert(serverCode.includes("app.post('/text-edit/cut-list'"), 'Endpoint not found');
  });

  it('should require auth for prepare endpoint', () => {
    assert(serverCode.includes("'/text-edit/prepare', requireCredits"), 'Auth not required');
  });

  it('should require auth for apply endpoint', () => {
    assert(serverCode.includes("'/text-edit/apply', requireCredits"), 'Auth not required');
  });

  it('should require auth for search endpoint', () => {
    assert(serverCode.includes("'/text-edit/search', requireCredits"), 'Auth not required');
  });

  it('should require auth for replace endpoint', () => {
    assert(serverCode.includes("'/text-edit/replace', requireCredits"), 'Auth not required');
  });

  it('should require auth for preview endpoint', () => {
    assert(serverCode.includes("'/text-edit/preview', requireCredits"), 'Auth not required');
  });

  it('should require auth for cut-list endpoint', () => {
    assert(serverCode.includes("'/text-edit/cut-list', requireCredits"), 'Auth not required');
  });

  it('should validate transcript in endpoints', () => {
    const prepareMatch = serverCode.match(/\/text-edit\/prepare[\s\S]{0,300}transcript is required/);
    const applyMatch = serverCode.match(/\/text-edit\/apply[\s\S]{0,300}transcript is required/);
    assert(prepareMatch, 'Prepare should validate transcript');
    assert(applyMatch, 'Apply should validate transcript');
  });

  it('should deduct usage', () => {
    assert(serverCode.includes('await req.deductUsage(0.5)'), '0.5 usage not found');
    assert(serverCode.includes('await req.deductUsage(0.25)'), '0.25 usage not found');
    assert(serverCode.includes('await req.deductUsage(0.1)'), '0.1 usage not found');
  });

  it('should log errors correctly', () => {
    assert(serverCode.includes('[SPLICE] Text-edit prepare error:'), 'Prepare error log not found');
    assert(serverCode.includes('[SPLICE] Text-edit apply error:'), 'Apply error log not found');
    assert(serverCode.includes('[SPLICE] Text-edit search error:'), 'Search error log not found');
  });
});

// ============================================================================
// PLUGIN UI TESTS
// ============================================================================

describe('Plugin UI Module', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/textEditor.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should define textEditorState', () => {
    assert(pluginCode.includes('textEditorState'), 'State object not found');
  });

  it('should have initTextEditor function', () => {
    assert(pluginCode.includes('async function initTextEditor'), 'Init function not found');
  });

  it('should have loadTranscriptIntoEditor function', () => {
    assert(pluginCode.includes('async function loadTranscriptIntoEditor'), 'Load function not found');
  });

  it('should have handleTextChange function', () => {
    assert(pluginCode.includes('function handleTextChange'), 'Handle change function not found');
  });

  it('should have undoTextEdit function', () => {
    assert(pluginCode.includes('function undoTextEdit'), 'Undo function not found');
  });

  it('should have redoTextEdit function', () => {
    assert(pluginCode.includes('function redoTextEdit'), 'Redo function not found');
  });

  it('should have previewTextEdits function', () => {
    assert(pluginCode.includes('async function previewTextEdits'), 'Preview function not found');
  });

  it('should have applyTextEdits function', () => {
    assert(pluginCode.includes('async function applyTextEdits'), 'Apply function not found');
  });

  it('should have searchInTranscript function', () => {
    assert(pluginCode.includes('async function searchInTranscript'), 'Search function not found');
  });

  it('should have replaceInTranscript function', () => {
    assert(pluginCode.includes('async function replaceInTranscript'), 'Replace function not found');
  });

  it('should have replaceAllInTranscript function', () => {
    assert(pluginCode.includes('async function replaceAllInTranscript'), 'Replace all function not found');
  });

  it('should have buildSequenceFromEdits function', () => {
    assert(pluginCode.includes('async function buildSequenceFromEdits'), 'Build sequence function not found');
  });

  it('should expose module globally', () => {
    assert(pluginCode.includes('window.spliceTextEditor'), 'Global export not found');
  });

  it('should include all exported functions', () => {
    assert(pluginCode.includes('init: initTextEditor'), 'init not exported');
    assert(pluginCode.includes('loadTranscript: loadTranscriptIntoEditor'), 'loadTranscript not exported');
    assert(pluginCode.includes('applyEdits: applyTextEdits'), 'applyEdits not exported');
    assert(pluginCode.includes('undo: undoTextEdit'), 'undo not exported');
    assert(pluginCode.includes('redo: redoTextEdit'), 'redo not exported');
  });
});

describe('UI State Management', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/textEditor.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should track original transcript', () => {
    assert(pluginCode.includes('originalTranscript: null'), 'originalTranscript not found');
  });

  it('should track editable transcript', () => {
    assert(pluginCode.includes('editableTranscript: null'), 'editableTranscript not found');
  });

  it('should track current text', () => {
    assert(pluginCode.includes("currentText: ''"), 'currentText not found');
  });

  it('should track undo/redo stacks', () => {
    assert(pluginCode.includes('undoStack: []'), 'undoStack not found');
    assert(pluginCode.includes('redoStack: []'), 'redoStack not found');
  });

  it('should track search results', () => {
    assert(pluginCode.includes('searchResults: []'), 'searchResults not found');
    assert(pluginCode.includes('currentSearchIndex: -1'), 'currentSearchIndex not found');
  });

  it('should track dirty state', () => {
    assert(pluginCode.includes('isDirty: false'), 'isDirty not found');
  });

  it('should track processing state', () => {
    assert(pluginCode.includes('isProcessing: false'), 'isProcessing not found');
  });
});

describe('Keyboard Shortcuts', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/textEditor.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should setup keyboard shortcuts', () => {
    assert(pluginCode.includes('setupKeyboardShortcuts'), 'Setup function not found');
  });

  it('should handle Ctrl/Cmd+Z for undo', () => {
    assert(pluginCode.includes("e.key === 'z'"), 'Z key not detected');
    assert(pluginCode.includes('undoTextEdit()'), 'Undo not called');
  });

  it('should handle Ctrl/Cmd+F for search', () => {
    assert(pluginCode.includes("e.key === 'f'"), 'F key not detected');
    assert(pluginCode.includes('text-search-input'), 'Search input not focused');
  });
});

describe('Undo/Redo Logic', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/textEditor.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should save to undo stack on change', () => {
    assert(pluginCode.includes('undoStack.push'), 'Push to undo stack not found');
  });

  it('should clear redo stack on new edit', () => {
    assert(pluginCode.includes('redoStack = []'), 'Redo stack clear not found');
  });

  it('should limit undo stack size', () => {
    assert(pluginCode.includes('undoStack.length > 50'), 'Stack limit not found');
    assert(pluginCode.includes('undoStack.shift()'), 'Shift not found');
  });

  it('should move between stacks on undo/redo', () => {
    assert(pluginCode.includes('undoStack.pop()'), 'Pop from undo not found');
    assert(pluginCode.includes('redoStack.pop()'), 'Pop from redo not found');
  });
});

describe('API Integration', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/textEditor.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should call prepare endpoint', () => {
    assert(pluginCode.includes('/text-edit/prepare'), 'Prepare endpoint not called');
  });

  it('should call apply endpoint', () => {
    assert(pluginCode.includes('/text-edit/apply'), 'Apply endpoint not called');
  });

  it('should call preview endpoint', () => {
    assert(pluginCode.includes('/text-edit/preview'), 'Preview endpoint not called');
  });

  it('should call search endpoint', () => {
    assert(pluginCode.includes('/text-edit/search'), 'Search endpoint not called');
  });

  it('should call cut-list endpoint', () => {
    assert(pluginCode.includes('/text-edit/cut-list'), 'Cut-list endpoint not called');
  });

  it('should use config helpers', () => {
    assert(pluginCode.includes('getBackendUrl'), 'getBackendUrl not used');
    assert(pluginCode.includes('fetchWithTimeout'), 'fetchWithTimeout not used');
    assert(pluginCode.includes('getAuthHeaders'), 'getAuthHeaders not used');
  });
});

// ============================================================================
// INTEGRATION TESTS
// ============================================================================

describe('Integration: Service -> API -> UI', () => {
  const servicePath = path.join(__dirname, '../services/textBasedEditing.js');
  const serverPath = path.join(__dirname, '../server.js');
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/textEditor.js');

  const serviceCode = fs.readFileSync(servicePath, 'utf8');
  const serverCode = fs.readFileSync(serverPath, 'utf8');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should wire generateEditableTranscript correctly', () => {
    assert(serviceCode.includes('generateEditableTranscript'), 'Service missing');
    assert(serverCode.includes("require('./services/textBasedEditing')"), 'Server import missing');
    assert(serverCode.includes('generateEditableTranscript(transcript)'), 'Server call missing');
    assert(pluginCode.includes('/text-edit/prepare'), 'Plugin API call missing');
  });

  it('should wire applyTextEdits correctly', () => {
    assert(serviceCode.includes('applyTextEdits'), 'Service missing');
    assert(serverCode.includes('applyTextEdits(transcript'), 'Server missing');
    assert(pluginCode.includes('/text-edit/apply'), 'Plugin missing');
  });

  it('should wire searchTranscript correctly', () => {
    assert(serviceCode.includes('searchTranscript'), 'Service missing');
    assert(serverCode.includes('searchTranscript(transcript'), 'Server missing');
    assert(pluginCode.includes('/text-edit/search'), 'Plugin missing');
  });

  it('should wire generateEditCutList correctly', () => {
    assert(serviceCode.includes('generateEditCutList'), 'Service missing');
    assert(serverCode.includes('generateEditCutList(operations'), 'Server missing');
    assert(pluginCode.includes('/text-edit/cut-list'), 'Plugin missing');
  });

  it('should use v3.5 cut list format', () => {
    assert(serviceCode.includes("version: '3.5'"), 'v3.5 not in service');
    assert(pluginCode.includes('spliceBuilder') || pluginCode.includes('buildSequence'), 'Builder integration missing');
  });
});

// ============================================================================
// RUN TESTS
// ============================================================================

console.log('\nğŸ§ª Text-Based Editing E2E Tests\n');
console.log('='.repeat(50));

// Tests are run via describe/it calls above

console.log('\n' + '='.repeat(50));
console.log(`\nğŸ“Š Results: ${passedTests}/${totalTests} passed`);

if (failedTests > 0) {
  console.log(`âŒ ${failedTests} test(s) failed\n`);
  process.exit(1);
} else {
  console.log('âœ… All tests passed!\n');
  process.exit(0);
}
