/**
 * SPLICE Social Reframe E2E Tests
 *
 * Tests face detection, social reframe, API endpoints, and UI wiring.
 * Run: node tests/social-reframe.test.js
 */

const fs = require('fs');
const path = require('path');

// Test results tracking
let totalTests = 0;
let passedTests = 0;
let failedTests = 0;

function describe(name, fn) {
  console.log(`\nğŸ“¦ ${name}`);
  fn();
}

function it(name, fn) {
  totalTests++;
  try {
    fn();
    passedTests++;
    console.log(`  âœ… ${name}`);
  } catch (err) {
    failedTests++;
    console.log(`  âŒ ${name}`);
    console.log(`     Error: ${err.message}`);
  }
}

function assert(condition, message) {
  if (!condition) {
    throw new Error(message || 'Assertion failed');
  }
}

// ============================================================================
// FACE DETECTION SERVICE TESTS
// ============================================================================

describe('Face Detection Service', () => {
  const servicePath = path.join(__dirname, '../services/faceDetection.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should export detectFaces function', () => {
    assert(serviceCode.includes('async function detectFaces'), 'Function not found');
    assert(serviceCode.includes('module.exports') && serviceCode.includes('detectFaces'), 'Not exported');
  });

  it('should export trackFaces function', () => {
    assert(serviceCode.includes('async function trackFaces'), 'Function not found');
    assert(serviceCode.includes('trackFaces'), 'Not exported');
  });

  it('should export identifySpeaker function', () => {
    assert(serviceCode.includes('function identifySpeaker'), 'Function not found');
    assert(serviceCode.includes('identifySpeaker'), 'Not exported');
  });

  it('should export calculateCropRegion function', () => {
    assert(serviceCode.includes('function calculateCropRegion'), 'Function not found');
    assert(serviceCode.includes('calculateCropRegion'), 'Not exported');
  });

  it('should export calculateCenterCrop function', () => {
    assert(serviceCode.includes('function calculateCenterCrop'), 'Function not found');
    assert(serviceCode.includes('calculateCenterCrop'), 'Not exported');
  });

  it('should export getFaceAtTime function', () => {
    assert(serviceCode.includes('function getFaceAtTime'), 'Function not found');
    assert(serviceCode.includes('getFaceAtTime'), 'Not exported');
  });
});

describe('Face Detection Runtime', () => {
  const faceService = require('../services/faceDetection');

  it('should smooth face positions', () => {
    const positions = [
      { timestamp: 0, x: 0.5, y: 0.4, width: 0.2, height: 0.3, confidence: 0.9 },
      { timestamp: 1, x: 0.55, y: 0.42, width: 0.2, height: 0.3, confidence: 0.9 }
    ];
    const smoothed = faceService.smoothPositions(positions, 0.3);
    assert(smoothed.length === 2, 'Should return same length');
    assert(smoothed[1].x !== positions[1].x, 'Should modify positions');
  });

  it('should calculate center crop', () => {
    const crop = faceService.calculateCenterCrop(9 / 16, { width: 1920, height: 1080 });
    assert(crop.x >= 0 && crop.x <= 1, 'x should be normalized');
    assert(crop.y >= 0 && crop.y <= 1, 'y should be normalized');
    assert(crop.pixelWidth > 0, 'pixelWidth should be positive');
    assert(crop.pixelHeight > 0, 'pixelHeight should be positive');
  });

  it('should calculate crop region for face', () => {
    const face = { x: 0.4, y: 0.3, width: 0.2, height: 0.3 };
    const crop = faceService.calculateCropRegion(face, 9 / 16, { width: 1920, height: 1080 });
    assert(crop.x >= 0, 'x should be non-negative');
    assert(crop.y >= 0, 'y should be non-negative');
  });

  it('should identify speaker from faces', () => {
    const faces = [
      {
        trackId: 'face_0',
        positions: [{ x: 0.4, y: 0.3, width: 0.2, height: 0.3 }]
      },
      {
        trackId: 'face_1',
        positions: [{ x: 0.1, y: 0.3, width: 0.1, height: 0.15 }]
      }
    ];
    const result = faceService.identifySpeaker(faces);
    assert(result.success, 'Should succeed');
    assert(result.primarySpeaker === 'face_0', 'Should identify larger/centered face');
  });
});

// ============================================================================
// SOCIAL REFRAME SERVICE TESTS
// ============================================================================

describe('Social Reframe Service', () => {
  const servicePath = path.join(__dirname, '../services/socialReframe.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should export analyzeForReframe function', () => {
    assert(serviceCode.includes('async function analyzeForReframe'), 'Function not found');
    assert(serviceCode.includes('analyzeForReframe'), 'Not exported');
  });

  it('should export calculateReframeCrops function', () => {
    assert(serviceCode.includes('function calculateReframeCrops'), 'Function not found');
    assert(serviceCode.includes('calculateReframeCrops'), 'Not exported');
  });

  it('should export generateMotionPath function', () => {
    assert(serviceCode.includes('function generateMotionPath'), 'Function not found');
    assert(serviceCode.includes('generateMotionPath'), 'Not exported');
  });

  it('should export getSafeZones function', () => {
    assert(serviceCode.includes('function getSafeZones'), 'Function not found');
    assert(serviceCode.includes('getSafeZones'), 'Not exported');
  });

  it('should export batchExportFormats function', () => {
    assert(serviceCode.includes('async function batchExportFormats'), 'Function not found');
    assert(serviceCode.includes('batchExportFormats'), 'Not exported');
  });

  it('should export getPlatformPresets function', () => {
    assert(serviceCode.includes('function getPlatformPresets'), 'Function not found');
    assert(serviceCode.includes('getPlatformPresets'), 'Not exported');
  });
});

describe('Aspect Ratio Presets', () => {
  const servicePath = path.join(__dirname, '../services/socialReframe.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should define portrait aspect ratio', () => {
    assert(serviceCode.includes("portrait:"), 'portrait not found');
    assert(serviceCode.includes('9 / 16') || serviceCode.includes('9/16'), '9:16 ratio not found');
  });

  it('should define square aspect ratio', () => {
    assert(serviceCode.includes("square:"), 'square not found');
    assert(serviceCode.includes('ratio: 1'), '1:1 ratio not found');
  });

  it('should define portrait 4:5 aspect ratio', () => {
    assert(serviceCode.includes("portrait_4_5:"), 'portrait_4_5 not found');
    assert(serviceCode.includes('4 / 5') || serviceCode.includes('4/5'), '4:5 ratio not found');
  });

  it('should define landscape aspect ratio', () => {
    assert(serviceCode.includes("landscape:"), 'landscape not found');
    assert(serviceCode.includes('16 / 9') || serviceCode.includes('16/9'), '16:9 ratio not found');
  });
});

describe('Platform Presets', () => {
  const servicePath = path.join(__dirname, '../services/socialReframe.js');
  const serviceCode = fs.readFileSync(servicePath, 'utf8');

  it('should define TikTok preset', () => {
    assert(serviceCode.includes("tiktok:"), 'tiktok not found');
    assert(serviceCode.includes("'TikTok'") || serviceCode.includes('"TikTok"'), 'TikTok name not found');
    assert(serviceCode.includes('maxDuration: 180'), 'TikTok max duration not found');
  });

  it('should define Instagram Reels preset', () => {
    assert(serviceCode.includes("reels:"), 'reels not found');
    assert(serviceCode.includes('Instagram Reels'), 'Reels name not found');
  });

  it('should define YouTube Shorts preset', () => {
    assert(serviceCode.includes("shorts:"), 'shorts not found');
    assert(serviceCode.includes('YouTube Shorts'), 'Shorts name not found');
    assert(serviceCode.includes('maxDuration: 60'), 'Shorts max duration not found');
  });

  it('should define safe zones for platforms', () => {
    assert(serviceCode.includes('safeZone:'), 'safeZone not found');
    assert(serviceCode.includes('top:'), 'top safe zone not found');
    assert(serviceCode.includes('bottom:'), 'bottom safe zone not found');
  });
});

describe('Social Reframe Runtime', () => {
  const reframeService = require('../services/socialReframe');

  it('should get platform presets', () => {
    const presets = reframeService.getPlatformPresets();
    assert(presets.aspectRatios.length >= 3, 'Should have 3+ aspect ratios');
    assert(presets.platforms.length >= 3, 'Should have 3+ platforms');
    assert(presets.defaults, 'Should have defaults');
  });

  it('should get safe zones for TikTok', () => {
    const result = reframeService.getSafeZones('tiktok');
    assert(result.success, 'Should succeed');
    assert(result.platform === 'TikTok', 'Should be TikTok');
    assert(result.safeZone, 'Should have safeZone');
    assert(result.safeArea, 'Should have safeArea');
  });

  it('should fail for unknown platform', () => {
    const result = reframeService.getSafeZones('unknown_platform');
    assert(!result.success, 'Should fail');
    assert(result.availablePlatforms, 'Should list available platforms');
  });

  it('should generate motion path', () => {
    const crops = [
      { time: 0, crop: { x: 0.3, y: 0, width: 0.4, height: 1 } },
      { time: 5, crop: { x: 0.35, y: 0, width: 0.4, height: 1 } }
    ];
    const result = reframeService.generateMotionPath(crops, 5, 30);
    assert(result.success, 'Should succeed');
    assert(result.totalFrames === 150, 'Should have 150 frames');
    assert(result.path.length === 150, 'Path should have 150 entries');
  });

  it('should calculate reframe crops', () => {
    const tracking = {
      videoInfo: { width: 1920, height: 1080, duration: 10, frameRate: 30 },
      tracks: [{
        trackId: 'face_0',
        positions: [
          { timestamp: 0, x: 0.4, y: 0.3, width: 0.2, height: 0.3 }
        ]
      }]
    };
    const result = reframeService.calculateReframeCrops(tracking, 9 / 16);
    assert(result.method === 'face-tracking', 'Should use face tracking');
    assert(result.keyframes.length >= 1, 'Should have keyframes');
  });

  it('should generate FFmpeg filter', () => {
    const crops = {
      static: true,
      crop: { pixelX: 420, pixelY: 0, pixelWidth: 1080, pixelHeight: 1080 }
    };
    const aspect = { width: 1080, height: 1080 };
    const videoInfo = { width: 1920, height: 1080 };
    const filter = reframeService.generateFFmpegFilter(crops, aspect, videoInfo);
    assert(filter.includes('crop='), 'Should have crop filter');
    assert(filter.includes('scale='), 'Should have scale filter');
  });

  it('should perform linear interpolation', () => {
    const result = reframeService.lerp(0, 10, 0.5);
    assert(result === 5, 'lerp(0, 10, 0.5) should be 5');
  });
});

// ============================================================================
// API ENDPOINT TESTS
// ============================================================================

describe('Server API Endpoints', () => {
  const serverPath = path.join(__dirname, '../server.js');
  const serverCode = fs.readFileSync(serverPath, 'utf8');

  it('should have POST /reframe/analyze endpoint', () => {
    assert(serverCode.includes("app.post('/reframe/analyze'"), 'Endpoint not found');
  });

  it('should have POST /reframe/calculate endpoint', () => {
    assert(serverCode.includes("app.post('/reframe/calculate'"), 'Endpoint not found');
  });

  it('should have POST /reframe/motion-path endpoint', () => {
    assert(serverCode.includes("app.post('/reframe/motion-path'"), 'Endpoint not found');
  });

  it('should have POST /reframe/export endpoint', () => {
    assert(serverCode.includes("app.post('/reframe/export'"), 'Endpoint not found');
  });

  it('should have GET /reframe/platforms endpoint', () => {
    assert(serverCode.includes("app.get('/reframe/platforms'"), 'Endpoint not found');
  });

  it('should have GET /reframe/safe-zones/:platform endpoint', () => {
    assert(serverCode.includes("app.get('/reframe/safe-zones/:platform'"), 'Endpoint not found');
  });

  it('should have POST /faces/detect endpoint', () => {
    assert(serverCode.includes("app.post('/faces/detect'"), 'Endpoint not found');
  });

  it('should have POST /faces/track endpoint', () => {
    assert(serverCode.includes("app.post('/faces/track'"), 'Endpoint not found');
  });

  it('should have POST /faces/identify-speaker endpoint', () => {
    assert(serverCode.includes("app.post('/faces/identify-speaker'"), 'Endpoint not found');
  });

  it('should require auth for analyze endpoint', () => {
    assert(serverCode.includes("'/reframe/analyze', requireCredits"), 'Auth not required');
  });

  it('should require auth for export endpoint', () => {
    assert(serverCode.includes("'/reframe/export', requireCredits"), 'Auth not required');
  });

  it('should require auth for face detect endpoint', () => {
    assert(serverCode.includes("'/faces/detect', requireCredits"), 'Auth not required');
  });

  it('should validate videoPath in endpoints', () => {
    const analyzeMatch = serverCode.match(/\/reframe\/analyze[\s\S]{0,300}videoPath is required/);
    const exportMatch = serverCode.match(/\/reframe\/export[\s\S]{0,300}videoPath is required/);
    assert(analyzeMatch, 'Analyze should validate videoPath');
    assert(exportMatch, 'Export should validate videoPath');
  });

  it('should log errors correctly', () => {
    assert(serverCode.includes('[SPLICE] Reframe analyze error:'), 'Analyze error log not found');
    assert(serverCode.includes('[SPLICE] Reframe export error:'), 'Export error log not found');
    assert(serverCode.includes('[SPLICE] Face detect error:'), 'Face detect error log not found');
  });
});

// ============================================================================
// PLUGIN UI TESTS
// ============================================================================

describe('Plugin UI Module', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/socialReframe.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should define socialReframeState', () => {
    assert(pluginCode.includes('socialReframeState'), 'State object not found');
  });

  it('should have initSocialReframe function', () => {
    assert(pluginCode.includes('async function initSocialReframe'), 'Init function not found');
  });

  it('should have loadPlatformPresets function', () => {
    assert(pluginCode.includes('async function loadPlatformPresets'), 'Load presets function not found');
  });

  it('should have renderPlatformSelector function', () => {
    assert(pluginCode.includes('function renderPlatformSelector'), 'Render selector not found');
  });

  it('should have selectPlatform function', () => {
    assert(pluginCode.includes('function selectPlatform'), 'Select platform not found');
  });

  it('should have selectAspectRatio function', () => {
    assert(pluginCode.includes('function selectAspectRatio'), 'Select aspect ratio not found');
  });

  it('should have analyzeForReframe function', () => {
    assert(pluginCode.includes('async function analyzeForReframe'), 'Analyze function not found');
  });

  it('should have exportReframe function', () => {
    assert(pluginCode.includes('async function exportReframe'), 'Export function not found');
  });

  it('should have exportAllFormats function', () => {
    assert(pluginCode.includes('async function exportAllFormats'), 'Export all function not found');
  });

  it('should have updateCropPreview function', () => {
    assert(pluginCode.includes('function updateCropPreview'), 'Update preview not found');
  });

  it('should have toggleSafeZones function', () => {
    assert(pluginCode.includes('function toggleSafeZones'), 'Toggle safe zones not found');
  });

  it('should expose module globally', () => {
    assert(pluginCode.includes('window.spliceSocialReframe'), 'Global export not found');
  });

  it('should include all exported functions', () => {
    assert(pluginCode.includes('init: initSocialReframe'), 'init not exported');
    assert(pluginCode.includes('analyze: analyzeForReframe'), 'analyze not exported');
    assert(pluginCode.includes('export: exportReframe'), 'export not exported');
    assert(pluginCode.includes('exportAll: exportAllFormats'), 'exportAll not exported');
  });
});

describe('UI State Management', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/socialReframe.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should track platforms', () => {
    assert(pluginCode.includes('platforms: []'), 'platforms not found');
  });

  it('should track aspect ratios', () => {
    assert(pluginCode.includes('aspectRatios: []'), 'aspectRatios not found');
  });

  it('should track selected platform', () => {
    assert(pluginCode.includes("selectedPlatform: 'tiktok'"), 'selectedPlatform not found');
  });

  it('should track selected aspect ratio', () => {
    assert(pluginCode.includes("selectedAspectRatio: 'portrait'"), 'selectedAspectRatio not found');
  });

  it('should track analysis data', () => {
    assert(pluginCode.includes('analysis: null'), 'analysis not found');
  });

  it('should track analyzing state', () => {
    assert(pluginCode.includes('isAnalyzing: false'), 'isAnalyzing not found');
  });

  it('should track exporting state', () => {
    assert(pluginCode.includes('isExporting: false'), 'isExporting not found');
  });

  it('should track safe zones', () => {
    assert(pluginCode.includes('safeZones: null'), 'safeZones not found');
  });
});

describe('API Integration', () => {
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/socialReframe.js');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should call platforms endpoint', () => {
    assert(pluginCode.includes('/reframe/platforms'), 'Platforms endpoint not called');
  });

  it('should call analyze endpoint', () => {
    assert(pluginCode.includes('/reframe/analyze'), 'Analyze endpoint not called');
  });

  it('should call export endpoint', () => {
    assert(pluginCode.includes('/reframe/export'), 'Export endpoint not called');
  });

  it('should call safe-zones endpoint', () => {
    assert(pluginCode.includes('/reframe/safe-zones/'), 'Safe-zones endpoint not called');
  });

  it('should use config helpers', () => {
    assert(pluginCode.includes('getBackendUrl'), 'getBackendUrl not used');
    assert(pluginCode.includes('fetchWithTimeout'), 'fetchWithTimeout not used');
    assert(pluginCode.includes('getAuthHeaders'), 'getAuthHeaders not used');
  });
});

// ============================================================================
// INTEGRATION TESTS
// ============================================================================

describe('Integration: Face Detection -> Reframe -> Export', () => {
  const faceServicePath = path.join(__dirname, '../services/faceDetection.js');
  const reframeServicePath = path.join(__dirname, '../services/socialReframe.js');
  const serverPath = path.join(__dirname, '../server.js');
  const pluginPath = path.join(__dirname, '../../splice-plugin/js/socialReframe.js');

  const faceServiceCode = fs.readFileSync(faceServicePath, 'utf8');
  const reframeServiceCode = fs.readFileSync(reframeServicePath, 'utf8');
  const serverCode = fs.readFileSync(serverPath, 'utf8');
  const pluginCode = fs.readFileSync(pluginPath, 'utf8');

  it('should wire face tracking to reframe', () => {
    assert(reframeServiceCode.includes("require('./faceDetection')"), 'faceDetection import missing');
    assert(reframeServiceCode.includes('trackFaces'), 'trackFaces usage missing');
  });

  it('should wire analyze endpoint correctly', () => {
    assert(serverCode.includes("require('./services/socialReframe')"), 'Server import missing');
    assert(serverCode.includes('analyzeForReframe(videoPath'), 'Server call missing');
    assert(pluginCode.includes('/reframe/analyze'), 'Plugin API call missing');
  });

  it('should wire export endpoint correctly', () => {
    assert(serverCode.includes('batchExportFormats(videoPath'), 'Server call missing');
    assert(pluginCode.includes('/reframe/export'), 'Plugin API call missing');
  });

  it('should wire platform presets correctly', () => {
    assert(serverCode.includes('getPlatformPresets'), 'Server missing');
    assert(pluginCode.includes('/reframe/platforms'), 'Plugin missing');
  });

  it('should use consistent platform IDs', () => {
    const platforms = ['tiktok', 'reels', 'shorts', 'instagram_feed'];
    platforms.forEach(p => {
      assert(reframeServiceCode.includes(`${p}:`), `Service missing ${p}`);
    });
  });
});

// ============================================================================
// RUN TESTS
// ============================================================================

console.log('\nğŸ§ª Social Reframe E2E Tests\n');
console.log('='.repeat(50));

// Tests are run via describe/it calls above

console.log('\n' + '='.repeat(50));
console.log(`\nğŸ“Š Results: ${passedTests}/${totalTests} passed`);

if (failedTests > 0) {
  console.log(`âŒ ${failedTests} test(s) failed\n`);
  process.exit(1);
} else {
  console.log('âœ… All tests passed!\n');
  process.exit(0);
}
