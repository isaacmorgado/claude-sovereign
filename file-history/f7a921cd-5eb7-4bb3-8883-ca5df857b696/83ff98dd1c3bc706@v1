#!/bin/bash
#
# SPLICE CEP - DEFINITIVE FIX SCRIPT
# This script fixes the EvalScript error by:
# 1. Setting debug mode for ALL CEP versions
# 2. Killing the macOS preference cache daemon
# 3. Quitting Premiere Pro
#

echo "=============================================="
echo "SPLICE CEP - DEFINITIVE FIX"
echo "=============================================="
echo ""

# Step 1: Quit Premiere Pro
echo "Step 1: Quitting Adobe Premiere Pro..."
osascript -e 'quit app "Adobe Premiere Pro"' 2>/dev/null
osascript -e 'quit app "Adobe Premiere Pro 2024"' 2>/dev/null
osascript -e 'quit app "Adobe Premiere Pro 2025"' 2>/dev/null
killall "Adobe Premiere Pro" 2>/dev/null
killall "Adobe Premiere Pro 2024" 2>/dev/null
killall "Adobe Premiere Pro 2025" 2>/dev/null
sleep 2
echo "‚úì Premiere Pro quit"
echo ""

# Step 2: Set debug mode for ALL CEP versions
echo "Step 2: Enabling CEP debug mode for ALL versions..."
for v in 8 9 10 11 12 13 14; do
    defaults write com.adobe.CSXS.$v PlayerDebugMode 1
    echo "  ‚úì CSXS.$v PlayerDebugMode = 1"
done
echo ""

# Step 3: CRITICAL - Kill the macOS preference cache daemon
echo "Step 3: Refreshing macOS preference cache..."
echo "  (This is the step most people miss!)"
killall -u $(whoami) cfprefsd 2>/dev/null
sleep 1
echo "‚úì Preference cache refreshed"
echo ""

# Step 4: Verify settings were applied
echo "Step 4: Verifying debug mode settings..."
for v in 10 11 12 13; do
    val=$(defaults read com.adobe.CSXS.$v PlayerDebugMode 2>/dev/null || echo "NOT SET")
    echo "  CSXS.$v PlayerDebugMode = $val"
done
echo ""

# Step 5: Clear CEP cache
echo "Step 5: Clearing CEP cache..."
if [ -d ~/Library/Caches/Adobe/CEP ]; then
    rm -rf ~/Library/Caches/Adobe/CEP
    echo "‚úì CEP cache cleared"
else
    echo "‚úì No CEP cache to clear"
fi
echo ""

# Done
echo "=============================================="
echo "‚úÖ FIX COMPLETE!"
echo "=============================================="
echo ""
echo "NEXT STEPS:"
echo "1. Wait 5 seconds"
echo "2. Open Adobe Premiere Pro"
echo "3. Go to Window ‚Üí Extensions ‚Üí SPLICE - AI Video Editor"
echo "4. Click the debug button (üîç) and run diagnostics"
echo ""
echo "All tests should now pass!"
echo ""
