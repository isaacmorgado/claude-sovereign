/**
 * E2E Tests for Music Variations Feature
 * Tests parallel generation of 3 song variations, selection, and billing
 */

const fs = require('fs');
const path = require('path');

// Test file paths
const MUSIC_GENERATION_PATH = path.join(__dirname, '../services/musicGeneration.js');
const MUSIC_QUEUE_PATH = path.join(__dirname, '../services/musicQueue.js');
const USAGE_TRACKING_PATH = path.join(__dirname, '../services/usageTracking.js');
const SERVER_PATH = path.join(__dirname, '../server.js');
const MUSIC_PLUGIN_PATH = path.join(__dirname, '../../splice-plugin/js/music.js');

let passedTests = 0;
let failedTests = 0;
const errors = [];

function test(name, fn) {
  try {
    fn();
    passedTests++;
    console.log(`  ✓ ${name}`);
  } catch (error) {
    failedTests++;
    errors.push({ name, error: error.message });
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
  }
}

function assert(condition, message) {
  if (!condition) {
    throw new Error(message || 'Assertion failed');
  }
}

function assertIncludes(haystack, needle, message) {
  if (!haystack.includes(needle)) {
    throw new Error(message || `Expected "${haystack.substring(0, 100)}..." to include "${needle}"`);
  }
}

function assertMatch(str, regex, message) {
  if (!regex.test(str)) {
    throw new Error(message || `Expected "${str.substring(0, 100)}..." to match ${regex}`);
  }
}

console.log('\n=== Music Variations E2E Tests ===\n');

// ============================================
// musicGeneration.js Tests
// ============================================
console.log('--- musicGeneration.js ---');

const musicGenerationContent = fs.readFileSync(MUSIC_GENERATION_PATH, 'utf-8');

test('exports generateVariations function', () => {
  assertIncludes(musicGenerationContent, 'generateVariations');
  assertMatch(musicGenerationContent, /module\.exports\s*=\s*\{[^}]*generateVariations/);
});

test('exports createVariationPrompts function', () => {
  assertIncludes(musicGenerationContent, 'createVariationPrompts');
  assertMatch(musicGenerationContent, /module\.exports\s*=\s*\{[^}]*createVariationPrompts/);
});

test('exports getVariationName function', () => {
  assertIncludes(musicGenerationContent, 'getVariationName');
  assertMatch(musicGenerationContent, /module\.exports\s*=\s*\{[^}]*getVariationName/);
});

test('generateVariations validates Mureka credentials', () => {
  assertIncludes(musicGenerationContent, 'hasMurekaCredentials()');
});

test('createVariationPrompts creates 3 variations', () => {
  assertIncludes(musicGenerationContent, 'Version A');
  assertIncludes(musicGenerationContent, 'Version B');
  assertIncludes(musicGenerationContent, 'Version C');
});

test('variations have unique prompt modifiers', () => {
  assertIncludes(musicGenerationContent, 'Original interpretation');
  assertIncludes(musicGenerationContent, 'More dynamic');
  assertIncludes(musicGenerationContent, 'More subtle');
});

test('generateVariations uses Promise.all for parallel submission', () => {
  assertMatch(musicGenerationContent, /Promise\.all\s*\(\s*\n?\s*variationPrompts\.map/);
});

test('generateVariations uses Promise.all for parallel polling', () => {
  assertMatch(musicGenerationContent, /Promise\.all\s*\(\s*\n?\s*submittedTasks\.map/);
});

test('generateVariations returns success count', () => {
  assertIncludes(musicGenerationContent, 'successCount');
  assertIncludes(musicGenerationContent, 'failedCount');
  assertIncludes(musicGenerationContent, 'totalCount');
});

test('generateVariations includes variation metadata in results', () => {
  assertIncludes(musicGenerationContent, 'variationIndex');
  assertIncludes(musicGenerationContent, 'variationName');
  assertIncludes(musicGenerationContent, 'promptDescription');
});

test('handles individual variation failures gracefully', () => {
  assertMatch(musicGenerationContent, /failed:\s*true/);
  assertMatch(musicGenerationContent, /error:\s*error\.message/);
});

test('throws if all variations fail', () => {
  assertIncludes(musicGenerationContent, 'All variations failed to generate');
});

test('buildMurekaPromptWithVariation handles moodModifier', () => {
  assertIncludes(musicGenerationContent, 'buildMurekaPromptWithVariation');
  assertIncludes(musicGenerationContent, 'options.moodModifier');
});

// ============================================
// musicQueue.js Tests
// ============================================
console.log('\n--- musicQueue.js ---');

const musicQueueContent = fs.readFileSync(MUSIC_QUEUE_PATH, 'utf-8');

test('exports addVariationsJob function', () => {
  assertIncludes(musicQueueContent, 'addVariationsJob');
  assertMatch(musicQueueContent, /module\.exports\s*=\s*\{[^}]*addVariationsJob/);
});

test('exports getVariationsJobStatus function', () => {
  assertIncludes(musicQueueContent, 'getVariationsJobStatus');
  assertMatch(musicQueueContent, /module\.exports\s*=\s*\{[^}]*getVariationsJobStatus/);
});

test('exports selectVariation function', () => {
  assertIncludes(musicQueueContent, 'selectVariation');
  assertMatch(musicQueueContent, /module\.exports\s*=\s*\{[^}]*selectVariation/);
});

test('exports updateVariationProgress function', () => {
  assertIncludes(musicQueueContent, 'updateVariationProgress');
  assertMatch(musicQueueContent, /module\.exports\s*=\s*\{[^}]*updateVariationProgress/);
});

test('exports storeVariations function', () => {
  assertIncludes(musicQueueContent, 'storeVariations');
  assertMatch(musicQueueContent, /module\.exports\s*=\s*\{[^}]*storeVariations/);
});

test('JOB_STATUS includes GENERATING_VARIATIONS', () => {
  assertIncludes(musicQueueContent, "GENERATING_VARIATIONS: 'generating_variations'");
});

test('JOB_STATUS includes SELECTING', () => {
  assertIncludes(musicQueueContent, "SELECTING: 'selecting'");
});

test('addVariationsJob generates variations_ prefixed jobId', () => {
  assertMatch(musicQueueContent, /const jobId = `variations_/);
});

test('addVariationsJob sets isVariations flag', () => {
  assertIncludes(musicQueueContent, 'isVariations: true');
});

test('addVariationsJob initializes variationProgress array', () => {
  assertIncludes(musicQueueContent, 'variationProgress: [0, 0, 0]');
});

test('addVariationsJob tracks selectedVariation', () => {
  assertIncludes(musicQueueContent, 'selectedVariation: null');
});

test('addVariationsJob uses higher priority', () => {
  assertIncludes(musicQueueContent, 'priority: 1');
});

test('getVariationsJobStatus returns isVariations flag', () => {
  assertMatch(musicQueueContent, /isVariations:\s*true/);
});

test('getVariationsJobStatus returns variationProgress', () => {
  assertMatch(musicQueueContent, /variationProgress:\s*job\.data\.variationProgress/);
});

test('selectVariation verifies ownership', () => {
  assertIncludes(musicQueueContent, 'job.data.customerId !== customerId');
  assertIncludes(musicQueueContent, 'Not authorized to access this job');
});

test('selectVariation validates variation index', () => {
  assertIncludes(musicQueueContent, 'variationIndex < 0');
  assertIncludes(musicQueueContent, 'Invalid variation index');
});

test('selectVariation checks if variation failed', () => {
  assertIncludes(musicQueueContent, 'selectedVar.failed');
  assertIncludes(musicQueueContent, 'Selected variation failed');
});

test('selectVariation updates job with selection', () => {
  assertIncludes(musicQueueContent, 'selectedVariation: variationIndex');
  assertMatch(musicQueueContent, /step:\s*JOB_STATUS\.COMPLETED/);
});

test('updateVariationProgress calculates overall progress', () => {
  assertIncludes(musicQueueContent, 'overallProgress');
  assertMatch(musicQueueContent, /variationProgress\.reduce\s*\(\s*\(\s*a\s*,\s*b\s*\)\s*=>\s*a\s*\+\s*b/);
});

test('storeVariations counts successful variations', () => {
  assertMatch(musicQueueContent, /successCount\s*=\s*variations\.filter/);
});

// ============================================
// usageTracking.js Tests
// ============================================
console.log('\n--- usageTracking.js ---');

const usageTrackingContent = fs.readFileSync(USAGE_TRACKING_PATH, 'utf-8');

test('exports VARIATIONS_CREDIT_COST constant', () => {
  assertIncludes(usageTrackingContent, 'VARIATIONS_CREDIT_COST = 2.5');
  assertMatch(usageTrackingContent, /module\.exports\s*=\s*\{[^}]*VARIATIONS_CREDIT_COST/);
});

test('exports VARIATIONS_OVERAGE_RATES constant', () => {
  assertIncludes(usageTrackingContent, 'VARIATIONS_OVERAGE_RATES');
  assertMatch(usageTrackingContent, /module\.exports\s*=\s*\{[^}]*VARIATIONS_OVERAGE_RATES/);
});

test('VARIATIONS_OVERAGE_RATES has correct tier pricing', () => {
  assertIncludes(usageTrackingContent, 'starter: 1.25');
  assertIncludes(usageTrackingContent, 'pro: 0.75');
  assertIncludes(usageTrackingContent, 'team: 0.50');
});

test('exports checkVariationsCredits function', () => {
  assertIncludes(usageTrackingContent, 'async function checkVariationsCredits');
  assertMatch(usageTrackingContent, /module\.exports\s*=\s*\{[^}]*checkVariationsCredits/);
});

test('exports deductVariationsCredit function', () => {
  assertIncludes(usageTrackingContent, 'async function deductVariationsCredit');
  assertMatch(usageTrackingContent, /module\.exports\s*=\s*\{[^}]*deductVariationsCredit/);
});

test('checkVariationsCredits returns canGenerate flag', () => {
  assertIncludes(usageTrackingContent, 'canGenerate');
});

test('checkVariationsCredits returns creditsAvailable and creditsRequired', () => {
  assertIncludes(usageTrackingContent, 'creditsAvailable');
  assertIncludes(usageTrackingContent, 'creditsRequired');
});

test('deductVariationsCredit uses transaction with row locking', () => {
  assertMatch(usageTrackingContent, /FOR UPDATE/);
  assertIncludes(usageTrackingContent, 'await client.query(\'BEGIN\')');
  assertIncludes(usageTrackingContent, 'await client.query(\'COMMIT\')');
});

test('deductVariationsCredit handles full credits case', () => {
  assertIncludes(usageTrackingContent, 'music_credits_remaining >= VARIATIONS_CREDIT_COST');
});

test('deductVariationsCredit handles partial credits case', () => {
  assertIncludes(usageTrackingContent, 'Partial credits');
  assertIncludes(usageTrackingContent, 'overagePortion');
});

test('deductVariationsCredit handles zero credits case', () => {
  assertIncludes(usageTrackingContent, 'full overage');
  assertIncludes(usageTrackingContent, 'VARIATIONS_OVERAGE_RATES');
});

test('deductVariationsCredit logs usage to music_usage_log', () => {
  assertMatch(usageTrackingContent, /INSERT INTO music_usage_log.*credits_used.*overage_charged/s);
});

test('deductVariationsCredit returns creditsDeducted in result', () => {
  assertIncludes(usageTrackingContent, 'creditsDeducted');
});

// ============================================
// server.js Tests
// ============================================
console.log('\n--- server.js ---');

const serverContent = fs.readFileSync(SERVER_PATH, 'utf-8');

test('has POST /music/generate-variations endpoint', () => {
  assertMatch(serverContent, /app\.post\s*\(\s*['"]\/music\/generate-variations['"]/);
});

test('/music/generate-variations requires authentication', () => {
  assertMatch(serverContent, /app\.post\s*\(\s*['"]\/music\/generate-variations['"],\s*requireCredits/);
});

test('/music/generate-variations checks for variations credits', () => {
  assertIncludes(serverContent, 'checkVariationsCredits');
  assertIncludes(serverContent, 'Insufficient credits for variations');
});

test('/music/generate-variations returns 402 for insufficient credits', () => {
  assertMatch(serverContent, /res\.status\s*\(\s*402\s*\).*Insufficient credits for variations/s);
});

test('/music/generate-variations uses addVariationsJob', () => {
  assertIncludes(serverContent, 'musicQueue.addVariationsJob');
});

test('/music/generate-variations returns isVariations flag', () => {
  assertMatch(serverContent, /isVariations:\s*true/);
});

test('has GET /music/variations/status/:jobId endpoint', () => {
  assertMatch(serverContent, /app\.get\s*\(\s*['"]\/music\/variations\/status\/:jobId['"]/);
});

test('/music/variations/status verifies ownership', () => {
  assertIncludes(serverContent, 'status.data.customerId !== customerId');
  assertIncludes(serverContent, 'Not authorized to access this job');
});

test('/music/variations/status uses getVariationsJobStatus', () => {
  assertIncludes(serverContent, 'musicQueue.getVariationsJobStatus');
});

test('has POST /music/variations/:jobId/select endpoint', () => {
  assertMatch(serverContent, /app\.post\s*\(\s*['"]\/music\/variations\/:jobId\/select['"]/);
});

test('/music/variations/:jobId/select requires variationIndex', () => {
  assertIncludes(serverContent, 'variationIndex is required');
});

test('/music/variations/:jobId/select validates variationIndex range', () => {
  assertIncludes(serverContent, 'variationIndex must be 0, 1, or 2');
});

test('/music/variations/:jobId/select uses selectVariation', () => {
  assertIncludes(serverContent, 'musicQueue.selectVariation');
});

test('/music/variations/:jobId/select deducts variations credit', () => {
  assertIncludes(serverContent, 'deductVariationsCredit');
});

// ============================================
// music.js Plugin Tests
// ============================================
console.log('\n--- music.js (Plugin) ---');

const musicPluginContent = fs.readFileSync(MUSIC_PLUGIN_PATH, 'utf-8');

test('musicState includes variationsJob', () => {
  assertIncludes(musicPluginContent, 'variationsJob: null');
});

test('musicState includes variationsPollingInterval', () => {
  assertIncludes(musicPluginContent, 'variationsPollingInterval: null');
});

test('musicState includes variationPlayers array', () => {
  assertIncludes(musicPluginContent, 'variationPlayers: [null, null, null]');
});

test('exports generateVariationsRequest function', () => {
  assertIncludes(musicPluginContent, 'async function generateVariationsRequest');
  assertIncludes(musicPluginContent, '/music/generate-variations');
});

test('exports getVariationsStatus function', () => {
  assertIncludes(musicPluginContent, 'async function getVariationsStatus');
  assertIncludes(musicPluginContent, '/music/variations/status/');
});

test('exports selectVariation function', () => {
  assertIncludes(musicPluginContent, 'async function selectVariation');
  assertIncludes(musicPluginContent, '/music/variations/');
  assertIncludes(musicPluginContent, '/select');
});

test('has handleGenerateVariations function', () => {
  assertIncludes(musicPluginContent, 'async function handleGenerateVariations');
});

test('handleGenerateVariations calls generateVariationsRequest', () => {
  assertMatch(musicPluginContent, /await generateVariationsRequest\s*\(/);
});

test('handleGenerateVariations starts polling', () => {
  assertIncludes(musicPluginContent, 'startPollingVariations');
});

test('handleGenerateVariations shows variations panel', () => {
  assertIncludes(musicPluginContent, 'showVariationsPanel');
});

test('has startPollingVariations function', () => {
  assertIncludes(musicPluginContent, 'function startPollingVariations');
});

test('startPollingVariations uses getVariationsStatus', () => {
  assertMatch(musicPluginContent, /await getVariationsStatus\s*\(/);
});

test('startPollingVariations checks for selecting status', () => {
  assertIncludes(musicPluginContent, "status.status === 'selecting'");
});

test('startPollingVariations renders variations selection', () => {
  assertIncludes(musicPluginContent, 'renderVariationsSelection');
});

test('has showVariationsPanel function', () => {
  assertIncludes(musicPluginContent, 'function showVariationsPanel');
});

test('showVariationsPanel displays 3 progress bars', () => {
  assertIncludes(musicPluginContent, 'variation-progress-item');
  assertMatch(musicPluginContent, /data-index="0"/);
  assertMatch(musicPluginContent, /data-index="1"/);
  assertMatch(musicPluginContent, /data-index="2"/);
});

test('has hideVariationsPanel function', () => {
  assertIncludes(musicPluginContent, 'function hideVariationsPanel');
});

test('hideVariationsPanel stops polling', () => {
  assertIncludes(musicPluginContent, 'clearInterval(musicState.variationsPollingInterval)');
});

test('hideVariationsPanel stops audio players', () => {
  assertIncludes(musicPluginContent, 'musicState.variationPlayers.forEach');
  assertIncludes(musicPluginContent, 'player.pause()');
});

test('has renderVariationsProgress function', () => {
  assertIncludes(musicPluginContent, 'function renderVariationsProgress');
});

test('renderVariationsProgress updates progress bars', () => {
  assertMatch(musicPluginContent, /fill\.style\.width\s*=\s*`\$\{progress\}%`/);
});

test('has renderVariationsSelection function', () => {
  assertIncludes(musicPluginContent, 'function renderVariationsSelection');
});

test('renderVariationsSelection creates variation cards', () => {
  assertIncludes(musicPluginContent, 'variation-card');
  assertIncludes(musicPluginContent, 'variations-cards');
});

test('renderVariationsSelection includes play buttons', () => {
  assertIncludes(musicPluginContent, 'play-btn');
  assertIncludes(musicPluginContent, 'data-action="play"');
});

test('renderVariationsSelection includes select buttons', () => {
  assertIncludes(musicPluginContent, 'select-variation-btn');
  assertIncludes(musicPluginContent, 'Select This Version');
});

test('has handleVariationPlay function', () => {
  assertIncludes(musicPluginContent, 'async function handleVariationPlay');
});

test('handleVariationPlay stops other players', () => {
  assertMatch(musicPluginContent, /musicState\.variationPlayers\.forEach\s*\(/);
});

test('handleVariationPlay toggles play/pause', () => {
  assertIncludes(musicPluginContent, 'player.paused');
  assertIncludes(musicPluginContent, 'player.play()');
  assertIncludes(musicPluginContent, 'player.pause()');
});

test('has handleVariationSelect function', () => {
  assertIncludes(musicPluginContent, 'async function handleVariationSelect');
});

test('handleVariationSelect calls selectVariation API', () => {
  assertMatch(musicPluginContent, /await selectVariation\s*\(\s*jobId\s*,\s*index\s*\)/);
});

test('handleVariationSelect refreshes library after selection', () => {
  assertIncludes(musicPluginContent, 'loadMusicLibrary()');
  assertIncludes(musicPluginContent, 'updateMusicCreditsDisplay()');
});

test('handleVariationSelect hides panel after selection', () => {
  assertIncludes(musicPluginContent, 'hideVariationsPanel()');
});

test('setupMusicEventListeners binds variations button', () => {
  assertIncludes(musicPluginContent, 'musicGenerateVariationsBtn');
  assertIncludes(musicPluginContent, 'handleGenerateVariations');
});

test('window.musicModule exports variations functions', () => {
  assertIncludes(musicPluginContent, 'generateVariationsRequest');
  assertIncludes(musicPluginContent, 'getVariationsStatus');
  assertIncludes(musicPluginContent, 'handleGenerateVariations');
  assertIncludes(musicPluginContent, 'showVariationsPanel');
  assertIncludes(musicPluginContent, 'hideVariationsPanel');
});

// ============================================
// Integration Tests
// ============================================
console.log('\n--- Integration Tests ---');

test('variations flow: endpoint calls queue function', () => {
  // server.js calls musicQueue.addVariationsJob
  assertIncludes(serverContent, 'musicQueue.addVariationsJob');
});

test('variations flow: status endpoint calls getVariationsJobStatus', () => {
  assertIncludes(serverContent, 'musicQueue.getVariationsJobStatus');
});

test('variations flow: select endpoint calls selectVariation and deducts credits', () => {
  assertIncludes(serverContent, 'musicQueue.selectVariation');
  assertIncludes(serverContent, 'usageTracking.deductVariationsCredit');
});

test('variations flow: plugin calls correct endpoints', () => {
  assertIncludes(musicPluginContent, '/music/generate-variations');
  assertIncludes(musicPluginContent, '/music/variations/status/');
  assertMatch(musicPluginContent, /\/music\/variations\/.*\/select/);
});

test('pricing: 2.5 credits = 79% margin', () => {
  // Cost is ~$0.525 (3 * $0.175), charging 2.5 credits, margin ~79%
  assertIncludes(usageTrackingContent, 'VARIATIONS_CREDIT_COST = 2.5');
});

test('error handling: all components handle failures', () => {
  assertIncludes(musicGenerationContent, 'failed: true');
  assertIncludes(musicQueueContent, 'JOB_STATUS.FAILED');
  assertIncludes(musicPluginContent, "status.status === 'failed'");
});

// ============================================
// Summary
// ============================================
console.log('\n=== Test Summary ===');
console.log(`Passed: ${passedTests}`);
console.log(`Failed: ${failedTests}`);
console.log(`Total: ${passedTests + failedTests}`);

if (failedTests > 0) {
  console.log('\nFailed tests:');
  errors.forEach(({ name, error }) => {
    console.log(`  - ${name}: ${error}`);
  });
  process.exit(1);
} else {
  console.log('\nAll tests passed!');
  process.exit(0);
}
