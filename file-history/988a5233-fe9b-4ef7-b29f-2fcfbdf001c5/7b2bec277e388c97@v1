/**
 * Phase 1 Complete Test Suite
 *
 * Validates all Phase 1 features:
 * 1. Takes Labeling & Color Coding
 * 2. J-Cut Basic Support
 * 3. UI Infrastructure Updates
 *
 * Also validates integration with existing systems.
 */

const { execSync } = require('child_process');
const path = require('path');

console.log('='.repeat(60));
console.log('PHASE 1 COMPLETE TEST SUITE');
console.log('='.repeat(60));

let totalPassed = 0;
let totalFailed = 0;

function runTest(name, file) {
  console.log(`\n>>> Running ${name}...`);
  try {
    const result = execSync(`node ${file}`, {
      cwd: __dirname,
      encoding: 'utf8',
      timeout: 60000
    });

    // Extract passed/failed counts
    const passedMatch = result.match(/Passed:\s*(\d+)/);
    const failedMatch = result.match(/Failed:\s*(\d+)/);

    if (passedMatch) totalPassed += parseInt(passedMatch[1]);
    if (failedMatch) totalFailed += parseInt(failedMatch[1]);

    console.log(`    ✓ ${name} completed`);
    return true;
  } catch (err) {
    console.log(`    ✗ ${name} failed`);
    if (err.stdout) console.log(err.stdout);
    if (err.stderr) console.log(err.stderr);
    totalFailed += 1;
    return false;
  }
}

// Phase 1 Tests
console.log('\n--- PHASE 1 FEATURE TESTS ---');
runTest('Takes Labeling & Color Coding', 'phase1-takes-labeling.test.js');
runTest('J-Cut Basic Support', 'phase1-jcut.test.js');
runTest('UI Infrastructure Updates', 'phase1-ui-infrastructure.test.js');

// Integration Tests (ensure Phase 1 didn't break anything)
console.log('\n--- INTEGRATION TESTS ---');
runTest('Final E2E Tests', 'final-e2e.test.js');
runTest('Builder UXP Runtime Tests', 'builder-uxp-runtime.test.js');
runTest('Offline Detection Tests', 'offline-detection.test.js');

// Summary
console.log('\n' + '='.repeat(60));
console.log('PHASE 1 COMPLETE TEST SUMMARY');
console.log('='.repeat(60));
console.log(`Total Passed: ${totalPassed}`);
console.log(`Total Failed: ${totalFailed}`);
console.log(`Total Tests:  ${totalPassed + totalFailed}`);
console.log('='.repeat(60));

if (totalFailed > 0) {
  console.log('\n⚠ SOME TESTS FAILED - Review output above');
  process.exit(1);
} else {
  console.log('\n✅ ALL PHASE 1 TESTS PASSED');
  console.log('Phase 1 features are ready for production!');
  console.log('\nFeatures implemented:');
  console.log('  1. Takes Labeling & Color Coding');
  console.log('     - Take numbering (Take 1, Take 2, etc.)');
  console.log('     - Short label generation from transcript');
  console.log('     - Color hints for segment types');
  console.log('     - Enhanced color palette (cerulean, lavender, etc.)');
  console.log('');
  console.log('  2. J-Cut Basic Support');
  console.log('     - Enable/disable J-Cut checkbox');
  console.log('     - Lead-in slider (audio before video)');
  console.log('     - Lead-out slider (audio after video)');
  console.log('     - API integration with cut-list endpoint');
  console.log('     - Builder handles audio offsets');
  console.log('');
  console.log('  3. UI Infrastructure Updates');
  console.log('     - Presets include J-Cut settings');
  console.log('     - Preset application updates J-Cut UI');
  console.log('     - Podcast/Interview/Tutorial enable J-Cut by default');
  console.log('     - Reaction/Vlog disable J-Cut for tight cuts');
  process.exit(0);
}
