/**
 * Phase 1 Tests: UI Infrastructure Updates
 *
 * Tests the UI integration of Phase 1 features:
 * 1. Preset J-Cut settings
 * 2. J-Cut UI state management
 * 3. Preset application updates J-Cut UI
 */

const assert = require('assert');
const path = require('path');
const fs = require('fs');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// ============================================================================
// Load and parse source files
// ============================================================================

const settingsJsPath = path.join(__dirname, '../../splice-plugin/js/settings.js');
const mainJsPath = path.join(__dirname, '../../splice-plugin/js/main.js');
const indexHtmlPath = path.join(__dirname, '../../splice-plugin/index.html');

const settingsJs = fs.readFileSync(settingsJsPath, 'utf8');
const mainJs = fs.readFileSync(mainJsPath, 'utf8');
const indexHtml = fs.readFileSync(indexHtmlPath, 'utf8');

// ============================================================================
// Test Suite 1: Preset J-Cut Settings
// ============================================================================

console.log('\n=== 1. Preset J-Cut Settings ===');

test('Podcast preset has J-Cut enabled', () => {
  assert.ok(settingsJs.includes("podcast:") && settingsJs.includes("enableJCut: true"),
    'Podcast preset should have enableJCut: true');
});

test('Podcast preset has jCutLeadIn', () => {
  // Look for jCutLeadIn in podcast context
  const podcastMatch = settingsJs.match(/podcast:\s*{[\s\S]*?jCutLeadIn:\s*([\d.]+)/);
  assert.ok(podcastMatch && parseFloat(podcastMatch[1]) > 0,
    'Podcast preset should have positive jCutLeadIn');
});

test('Interview preset has J-Cut enabled', () => {
  assert.ok(settingsJs.includes("interview:") && settingsJs.includes("enableJCut: true"),
    'Interview preset should have enableJCut: true');
});

test('Reaction preset has J-Cut disabled', () => {
  // Reaction should have J-Cut disabled for tight cuts
  const reactionSection = settingsJs.match(/reaction:\s*{[\s\S]*?enableJCut:\s*(true|false)/);
  assert.ok(reactionSection && reactionSection[1] === 'false',
    'Reaction preset should have enableJCut: false');
});

test('Vlog preset has J-Cut disabled', () => {
  const vlogSection = settingsJs.match(/vlog:\s*{[\s\S]*?enableJCut:\s*(true|false)/);
  assert.ok(vlogSection && vlogSection[1] === 'false',
    'Vlog preset should have enableJCut: false');
});

test('Tutorial preset has J-Cut enabled', () => {
  const tutorialSection = settingsJs.match(/tutorial:\s*{[\s\S]*?enableJCut:\s*(true|false)/);
  assert.ok(tutorialSection && tutorialSection[1] === 'true',
    'Tutorial preset should have enableJCut: true');
});

test('All presets have jCutLeadOut setting', () => {
  const presetNames = ['podcast', 'interview', 'reaction', 'tutorial', 'vlog'];
  for (const name of presetNames) {
    assert.ok(settingsJs.includes(`jCutLeadOut:`),
      `All presets should have jCutLeadOut setting`);
  }
});

// ============================================================================
// Test Suite 2: J-Cut UI State Management
// ============================================================================

console.log('\n=== 2. J-Cut UI State Management ===');

test('updateJCutUIFromSettings function exists', () => {
  assert.ok(mainJs.includes('function updateJCutUIFromSettings(settings)'),
    'Should have updateJCutUIFromSettings function');
});

test('updateJCutUIFromSettings handles null settings', () => {
  assert.ok(mainJs.includes('if (!settings) return'),
    'Should handle null settings gracefully');
});

test('updateJCutUIFromSettings updates enable checkbox', () => {
  assert.ok(mainJs.includes('ui.enableJCut.checked = settings.enableJCut'),
    'Should update enableJCut checkbox from settings');
});

test('updateJCutUIFromSettings toggles settings panel visibility', () => {
  assert.ok(mainJs.includes("ui.jcutSettings.style.display = settings.enableJCut ? 'block' : 'none'"),
    'Should toggle jcutSettings visibility');
});

test('updateJCutUIFromSettings updates lead-in slider', () => {
  assert.ok(mainJs.includes('ui.jcutLeadIn.value = settings.jCutLeadIn'),
    'Should update jcutLeadIn slider value');
});

test('updateJCutUIFromSettings updates lead-in display', () => {
  assert.ok(mainJs.includes('ui.jcutLeadInValue.textContent'),
    'Should update lead-in value display');
});

test('updateJCutUIFromSettings updates lead-out slider', () => {
  assert.ok(mainJs.includes('ui.jcutLeadOut.value = settings.jCutLeadOut'),
    'Should update jcutLeadOut slider value');
});

// ============================================================================
// Test Suite 3: Preset Application Updates J-Cut UI
// ============================================================================

console.log('\n=== 3. Preset Application Updates J-Cut UI ===');

test('applyPresetAndUpdateUI calls updateJCutUIFromSettings for custom presets', () => {
  // Check that updateJCutUIFromSettings is called in custom preset branch
  const customPresetBranch = mainJs.includes('updateJCutUIFromSettings(settings)');
  assert.ok(customPresetBranch, 'Should call updateJCutUIFromSettings for custom presets');
});

test('applyPresetAndUpdateUI calls updateJCutUIFromSettings for built-in presets', () => {
  // Check that updateJCutUIFromSettings is called in built-in preset branch
  const builtInBranch = mainJs.includes('updateJCutUIFromSettings(appliedSettings)');
  assert.ok(builtInBranch, 'Should call updateJCutUIFromSettings for built-in presets');
});

// ============================================================================
// Test Suite 4: UI Element Wiring
// ============================================================================

console.log('\n=== 4. UI Element Wiring ===');

test('All J-Cut UI elements are cached', () => {
  assert.ok(mainJs.includes("ui.enableJCut = document.getElementById('enableJCut')"),
    'Should cache enableJCut element');
  assert.ok(mainJs.includes("ui.jcutSettings = document.getElementById('jcutSettings')"),
    'Should cache jcutSettings element');
  assert.ok(mainJs.includes("ui.jcutLeadIn = document.getElementById('jcutLeadIn')"),
    'Should cache jcutLeadIn element');
  assert.ok(mainJs.includes("ui.jcutLeadOut = document.getElementById('jcutLeadOut')"),
    'Should cache jcutLeadOut element');
});

test('J-Cut checkbox has event listener', () => {
  assert.ok(mainJs.includes("ui.enableJCut.addEventListener('change'"),
    'Should have change event listener on enableJCut');
});

test('Lead-in slider has event listener', () => {
  assert.ok(mainJs.includes("ui.jcutLeadIn.addEventListener('input'"),
    'Should have input event listener on jcutLeadIn');
});

test('Lead-out slider has event listener', () => {
  assert.ok(mainJs.includes("ui.jcutLeadOut.addEventListener('input'"),
    'Should have input event listener on jcutLeadOut');
});

// ============================================================================
// Test Suite 5: CSS Styling
// ============================================================================

console.log('\n=== 5. CSS Styling ===');

test('J-Cut options section has styling', () => {
  assert.ok(indexHtml.includes('class="jcut-options"'),
    'Should have jcut-options CSS class');
});

test('Collapsed class hides elements', () => {
  assert.ok(indexHtml.includes('.collapsed') && indexHtml.includes('display: none'),
    'Collapsed class should hide elements');
});

// ============================================================================
// Test Suite 6: Phase 1 Integration
// ============================================================================

console.log('\n=== 6. Phase 1 Integration ===');

test('buildSequenceWithCutList includes labelTakes setting', () => {
  assert.ok(mainJs.includes('labelTakes: true'),
    'Should include labelTakes setting in API request');
});

test('buildSequenceWithCutList includes colorCode setting', () => {
  assert.ok(mainJs.includes('colorCode: true'),
    'Should include colorCode setting in API request');
});

test('initJCutUI is called during initialization', () => {
  assert.ok(mainJs.includes('initJCutUI()'),
    'Should call initJCutUI during DOMContentLoaded');
});

// ============================================================================
// Summary
// ============================================================================

console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed > 0) {
  console.log('\n⚠ Some tests failed!');
  process.exit(1);
} else {
  console.log('\n✓ All tests passed!');
  process.exit(0);
}
