/**
 * Phase 1 Tests: Takes Labeling & Color Coding
 *
 * Tests the new features:
 * 1. Take labeling in cutListGenerator.js
 * 2. Color hint system
 * 3. Short label generation
 * 4. Builder color mapping
 */

const assert = require('assert');
const path = require('path');
const fs = require('fs');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// ============================================================================
// Load and parse source files
// ============================================================================

const cutListGeneratorPath = path.join(__dirname, '../services/cutListGenerator.js');
const builderJsPath = path.join(__dirname, '../../splice-plugin/js/builder.js');

const cutListGeneratorSource = fs.readFileSync(cutListGeneratorPath, 'utf8');
const builderJsSource = fs.readFileSync(builderJsPath, 'utf8');

// ============================================================================
// Test Suite 1: Cut List Generator - Takes Labeling
// ============================================================================

console.log('\n=== 1. Cut List Generator - Takes Labeling ===');

test('generateCutList has labelTakes setting', () => {
  assert.ok(cutListGeneratorSource.includes('labelTakes = true'),
    'Should have labelTakes setting with default true');
});

test('generateCutList has colorCode setting', () => {
  assert.ok(cutListGeneratorSource.includes('colorCode = true'),
    'Should have colorCode setting with default true');
});

test('generateCutList has take numbering counter', () => {
  assert.ok(cutListGeneratorSource.includes('let takeNumber = 1'),
    'Should initialize takeNumber counter');
});

test('segments include takeLabel field', () => {
  assert.ok(cutListGeneratorSource.includes('segment.takeLabel'),
    'Should add takeLabel to segments');
});

test('segments include takeNumber field', () => {
  assert.ok(cutListGeneratorSource.includes('segment.takeNumber = takeNumber'),
    'Should add takeNumber to segments');
});

test('takeLabel format is correct', () => {
  // Should be: `Take ${takeNumber}${shortLabel ? `: ${shortLabel}` : ''}`
  assert.ok(cutListGeneratorSource.includes('`Take ${takeNumber}'),
    'Take label should include take number');
});

test('segments include colorHint field', () => {
  assert.ok(cutListGeneratorSource.includes('segment.colorHint'),
    'Should add colorHint to segments');
});

test('metadata includes takesLabeled flag', () => {
  assert.ok(cutListGeneratorSource.includes('takesLabeled:'),
    'Metadata should include takesLabeled flag');
});

test('metadata includes colorCoded flag', () => {
  assert.ok(cutListGeneratorSource.includes('colorCoded:'),
    'Metadata should include colorCoded flag');
});

// ============================================================================
// Test Suite 2: Short Label Generation
// ============================================================================

console.log('\n=== 2. Short Label Generation ===');

test('generateShortLabel function exists', () => {
  assert.ok(cutListGeneratorSource.includes('function generateShortLabel(text)'),
    'Should have generateShortLabel function');
});

test('generateShortLabel handles null input', () => {
  assert.ok(cutListGeneratorSource.includes("if (!text || typeof text !== 'string') return ''"),
    'Should handle null/undefined/non-string input');
});

test('generateShortLabel limits to 5 words', () => {
  assert.ok(cutListGeneratorSource.includes('words.slice(0, 5)'),
    'Should take first 5 words max');
});

test('generateShortLabel truncates to 30 chars', () => {
  assert.ok(cutListGeneratorSource.includes('label.length > 30'),
    'Should truncate labels longer than 30 chars');
});

// ============================================================================
// Test Suite 3: Color Hint System
// ============================================================================

console.log('\n=== 3. Color Hint System ===');

test('getColorHintForType function exists', () => {
  assert.ok(cutListGeneratorSource.includes('function getColorHintForType(type)'),
    'Should have getColorHintForType function');
});

test('getColorHintForType returns cerulean for best_take', () => {
  assert.ok(cutListGeneratorSource.includes("case 'best_take':") &&
            cutListGeneratorSource.includes("return 'cerulean'"),
    'best_take should return cerulean color hint');
});

test('getColorHintForType returns lavender for take', () => {
  assert.ok(cutListGeneratorSource.includes("case 'take':") &&
            cutListGeneratorSource.includes("return 'lavender'"),
    'take should return lavender color hint');
});

test('getColorHintForType returns green for speech', () => {
  assert.ok(cutListGeneratorSource.includes("case 'speech':") &&
            cutListGeneratorSource.includes("return 'green'"),
    'speech should return green color hint');
});

test('getColorHintForType returns yellow for wide_shot', () => {
  assert.ok(cutListGeneratorSource.includes("case 'wide_shot':") &&
            cutListGeneratorSource.includes("return 'yellow'"),
    'wide_shot should return yellow color hint');
});

test('getColorHintForType handles speaker colors', () => {
  assert.ok(cutListGeneratorSource.includes("case 'speaker_a':") &&
            cutListGeneratorSource.includes("return 'mango'"),
    'speaker_a should return mango color hint');
  assert.ok(cutListGeneratorSource.includes("case 'speaker_b':") &&
            cutListGeneratorSource.includes("return 'caribbean'"),
    'speaker_b should return caribbean color hint');
});

// ============================================================================
// Test Suite 4: Builder.js - Color Mapping
// ============================================================================

console.log('\n=== 4. Builder.js - Color Mapping ===');

test('SPLICE_COLORS includes new types', () => {
  assert.ok(builderJsSource.includes('TAKE: COLOR_LABELS.LAVENDER'),
    'Should have TAKE color');
  assert.ok(builderJsSource.includes('WIDE_SHOT: COLOR_LABELS.YELLOW'),
    'Should have WIDE_SHOT color');
  assert.ok(builderJsSource.includes('SPEAKER_A: COLOR_LABELS.MANGO'),
    'Should have SPEAKER_A color');
  assert.ok(builderJsSource.includes('SPEAKER_B: COLOR_LABELS.CARIBBEAN'),
    'Should have SPEAKER_B color');
});

test('COLOR_HINT_MAP exists', () => {
  assert.ok(builderJsSource.includes('const COLOR_HINT_MAP = {'),
    'Should have COLOR_HINT_MAP constant');
});

test('COLOR_HINT_MAP has all color hints', () => {
  assert.ok(builderJsSource.includes("'green': COLOR_LABELS.GREEN"),
    'Should map green hint');
  assert.ok(builderJsSource.includes("'cerulean': COLOR_LABELS.CERULEAN"),
    'Should map cerulean hint');
  assert.ok(builderJsSource.includes("'lavender': COLOR_LABELS.LAVENDER"),
    'Should map lavender hint');
  assert.ok(builderJsSource.includes("'yellow': COLOR_LABELS.YELLOW"),
    'Should map yellow hint');
});

test('getColorForSegment function exists', () => {
  assert.ok(builderJsSource.includes('function getColorForSegment(type, colorHint)'),
    'Should have getColorForSegment function');
});

test('getColorForSegment prefers color hint over type', () => {
  assert.ok(builderJsSource.includes('if (colorHint && COLOR_HINT_MAP[colorHint]'),
    'Should check color hint first');
});

test('getColorForSegmentType legacy alias exists', () => {
  assert.ok(builderJsSource.includes('function getColorForSegmentType(type)'),
    'Should have legacy getColorForSegmentType function');
  assert.ok(builderJsSource.includes('return getColorForSegment(type, null)'),
    'Legacy function should call new function');
});

// ============================================================================
// Test Suite 5: Builder.js - Take Labeling
// ============================================================================

console.log('\n=== 5. Builder.js - Take Labeling ===');

test('applyTakeLabels function exists', () => {
  assert.ok(builderJsSource.includes('async function applyTakeLabels(sequence, segmentsToInsert)'),
    'Should have applyTakeLabels function');
});

test('applyTakeLabels checks for labels', () => {
  assert.ok(builderJsSource.includes('const hasLabels = segmentsToInsert.some(seg => seg.takeLabel)'),
    'Should check if any segments have labels');
});

test('applyTakeLabels uses createSetNameAction', () => {
  assert.ok(builderJsSource.includes('createSetNameAction'),
    'Should use createSetNameAction to set clip names');
});

test('applyTakeLabels is called after setTrackItemInOutPoints', () => {
  // Check the order in the code
  const inOutIndex = builderJsSource.indexOf('await setTrackItemInOutPoints');
  const labelsIndex = builderJsSource.indexOf('await applyTakeLabels');
  assert.ok(labelsIndex > inOutIndex,
    'applyTakeLabels should be called after setTrackItemInOutPoints');
});

test('segmentsToInsert includes takeLabel', () => {
  assert.ok(builderJsSource.includes('takeLabel: segment.takeLabel'),
    'Should include takeLabel in segment data');
});

test('segmentsToInsert includes takeNumber', () => {
  assert.ok(builderJsSource.includes('takeNumber: segment.takeNumber'),
    'Should include takeNumber in segment data');
});

// ============================================================================
// Test Suite 6: Builder.js - Exports
// ============================================================================

console.log('\n=== 6. Builder.js - Exports ===');

test('window.spliceBuilder exports applyTakeLabels', () => {
  assert.ok(builderJsSource.includes('applyTakeLabels,'),
    'Should export applyTakeLabels function');
});

test('window.spliceBuilder exports getColorForSegment', () => {
  assert.ok(builderJsSource.includes('getColorForSegment,'),
    'Should export getColorForSegment function');
});

test('window.spliceBuilder exports COLOR_HINT_MAP', () => {
  assert.ok(builderJsSource.includes('COLOR_HINT_MAP'),
    'Should export COLOR_HINT_MAP constant');
});

// ============================================================================
// Test Suite 7: Integration - Segment Processing
// ============================================================================

console.log('\n=== 7. Integration - Segment Processing ===');

test('Segments use getColorForSegment with colorHint', () => {
  assert.ok(builderJsSource.includes('getColorForSegment(segment.type, segment.colorHint)'),
    'Should pass both type and colorHint to getColorForSegment');
});

test('Transaction name includes Take Labels', () => {
  assert.ok(builderJsSource.includes("'SPLICE: Apply Take Labels'"),
    'Transaction should be named appropriately');
});

// ============================================================================
// Summary
// ============================================================================

console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed > 0) {
  console.log('\n⚠ Some tests failed!');
  process.exit(1);
} else {
  console.log('\n✓ All tests passed!');
  process.exit(0);
}
