/**
 * Phase 1 Tests: J-Cut Basic Support
 *
 * Tests the new J-Cut/L-Cut features:
 * 1. UI elements exist and are wired correctly
 * 2. J-Cut settings are passed to backend
 * 3. Backend handles J-Cut offset in cut list
 * 4. Builder applies audio offsets
 */

const assert = require('assert');
const path = require('path');
const fs = require('fs');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// ============================================================================
// Load and parse source files
// ============================================================================

const indexHtmlPath = path.join(__dirname, '../../splice-plugin/index.html');
const mainJsPath = path.join(__dirname, '../../splice-plugin/js/main.js');
const builderJsPath = path.join(__dirname, '../../splice-plugin/js/builder.js');
const cutListGeneratorPath = path.join(__dirname, '../services/cutListGenerator.js');

const indexHtml = fs.readFileSync(indexHtmlPath, 'utf8');
const mainJs = fs.readFileSync(mainJsPath, 'utf8');
const builderJs = fs.readFileSync(builderJsPath, 'utf8');
const cutListGeneratorSource = fs.readFileSync(cutListGeneratorPath, 'utf8');

// ============================================================================
// Test Suite 1: UI Elements
// ============================================================================

console.log('\n=== 1. J-Cut UI Elements ===');

test('Enable J-Cut checkbox exists', () => {
  assert.ok(indexHtml.includes('id="enableJCut"'),
    'Should have enableJCut checkbox');
});

test('J-Cut settings container exists', () => {
  assert.ok(indexHtml.includes('id="jcutSettings"'),
    'Should have jcutSettings container');
});

test('Lead-in slider exists', () => {
  assert.ok(indexHtml.includes('id="jcutLeadIn"'),
    'Should have jcutLeadIn slider');
});

test('Lead-in value display exists', () => {
  assert.ok(indexHtml.includes('id="jcutLeadInValue"'),
    'Should have jcutLeadInValue display');
});

test('Lead-out slider exists', () => {
  assert.ok(indexHtml.includes('id="jcutLeadOut"'),
    'Should have jcutLeadOut slider');
});

test('Lead-out value display exists', () => {
  assert.ok(indexHtml.includes('id="jcutLeadOutValue"'),
    'Should have jcutLeadOutValue display');
});

test('Slider has correct range (0-1 seconds)', () => {
  assert.ok(indexHtml.includes('min="0" max="1"'),
    'Slider should have 0-1 second range');
});

// ============================================================================
// Test Suite 2: Main.js - UI Caching
// ============================================================================

console.log('\n=== 2. Main.js - UI Caching ===');

test('Caches enableJCut element', () => {
  assert.ok(mainJs.includes("ui.enableJCut = document.getElementById('enableJCut')"),
    'Should cache enableJCut checkbox');
});

test('Caches jcutSettings element', () => {
  assert.ok(mainJs.includes("ui.jcutSettings = document.getElementById('jcutSettings')"),
    'Should cache jcutSettings container');
});

test('Caches jcutLeadIn element', () => {
  assert.ok(mainJs.includes("ui.jcutLeadIn = document.getElementById('jcutLeadIn')"),
    'Should cache jcutLeadIn slider');
});

test('Caches jcutLeadOut element', () => {
  assert.ok(mainJs.includes("ui.jcutLeadOut = document.getElementById('jcutLeadOut')"),
    'Should cache jcutLeadOut slider');
});

// ============================================================================
// Test Suite 3: Main.js - J-Cut Initialization
// ============================================================================

console.log('\n=== 3. Main.js - J-Cut Initialization ===');

test('initJCutUI function exists', () => {
  assert.ok(mainJs.includes('function initJCutUI()'),
    'Should have initJCutUI function');
});

test('initJCutUI is called during initialization', () => {
  assert.ok(mainJs.includes('initJCutUI()'),
    'Should call initJCutUI during DOMContentLoaded');
});

test('Enable checkbox toggles settings visibility', () => {
  assert.ok(mainJs.includes("ui.enableJCut.addEventListener('change'"),
    'Should listen for checkbox changes');
  assert.ok(mainJs.includes("ui.jcutSettings.style.display"),
    'Should toggle settings display');
});

test('Lead-in slider updates value display', () => {
  assert.ok(mainJs.includes("ui.jcutLeadIn.addEventListener('input'"),
    'Should listen for lead-in slider changes');
});

test('Lead-out slider updates value display', () => {
  assert.ok(mainJs.includes("ui.jcutLeadOut.addEventListener('input'"),
    'Should listen for lead-out slider changes');
});

// ============================================================================
// Test Suite 4: Main.js - getJCutSettings Function
// ============================================================================

console.log('\n=== 4. Main.js - getJCutSettings ===');

test('getJCutSettings function exists', () => {
  assert.ok(mainJs.includes('function getJCutSettings()'),
    'Should have getJCutSettings function');
});

test('getJCutSettings returns enabled flag', () => {
  assert.ok(mainJs.includes('enabled: true') || mainJs.includes('enabled: false'),
    'Should return enabled flag');
});

test('getJCutSettings returns jCutOffset (negative)', () => {
  assert.ok(mainJs.includes('jCutOffset: -leadIn'),
    'Should return negative jCutOffset for J-cut');
});

test('getJCutSettings returns lCutOffset (positive)', () => {
  assert.ok(mainJs.includes('lCutOffset: leadOut'),
    'Should return positive lCutOffset for L-cut');
});

test('getJCutSettings is exported globally', () => {
  assert.ok(mainJs.includes('window.getJCutSettings = getJCutSettings'),
    'Should export getJCutSettings to window');
});

// ============================================================================
// Test Suite 5: Main.js - API Integration
// ============================================================================

console.log('\n=== 5. Main.js - API Integration ===');

test('buildSequenceWithCutList calls getJCutSettings', () => {
  assert.ok(mainJs.includes('const jcutSettings = getJCutSettings()'),
    'Should get J-Cut settings before API call');
});

test('API request includes jCutOffset', () => {
  assert.ok(mainJs.includes('jCutOffset: jcutSettings.jCutOffset'),
    'Should include jCutOffset in request body');
});

test('API request includes lCutOffset', () => {
  assert.ok(mainJs.includes('lCutOffset: jcutSettings.lCutOffset'),
    'Should include lCutOffset in request body');
});

// ============================================================================
// Test Suite 6: Backend - Cut List Generator
// ============================================================================

console.log('\n=== 6. Backend - Cut List Generator ===');

test('cutListGenerator has jCutOffset setting', () => {
  assert.ok(cutListGeneratorSource.includes('jCutOffset = 0'),
    'Should have jCutOffset with default 0');
});

test('cutListGenerator has lCutOffset setting', () => {
  assert.ok(cutListGeneratorSource.includes('lCutOffset = 0'),
    'Should have lCutOffset with default 0');
});

test('Segments include audioInOffset when set', () => {
  assert.ok(cutListGeneratorSource.includes('segment.audioInOffset = jCutOffset'),
    'Should add audioInOffset to segments');
});

test('Segments include audioOutOffset when set', () => {
  assert.ok(cutListGeneratorSource.includes('segment.audioOutOffset = lCutOffset'),
    'Should add audioOutOffset to segments');
});

test('Segments include audioInPoint calculation', () => {
  assert.ok(cutListGeneratorSource.includes('segment.audioInPoint'),
    'Should calculate audioInPoint for segments');
});

test('Segments include audioOutPoint calculation', () => {
  assert.ok(cutListGeneratorSource.includes('segment.audioOutPoint'),
    'Should calculate audioOutPoint for segments');
});

test('Metadata includes hasAudioOffsets flag', () => {
  assert.ok(cutListGeneratorSource.includes('hasAudioOffsets:'),
    'Metadata should include hasAudioOffsets flag');
});

// ============================================================================
// Test Suite 7: Builder - Audio Offset Handling
// ============================================================================

console.log('\n=== 7. Builder - Audio Offset Handling ===');

test('Builder handles audioInPoint', () => {
  assert.ok(builderJs.includes('segment.audioInPoint'),
    'Builder should handle audioInPoint');
});

test('Builder handles audioOutPoint', () => {
  assert.ok(builderJs.includes('segment.audioOutPoint'),
    'Builder should handle audioOutPoint');
});

test('Builder tracks hasAudioOffset flag', () => {
  assert.ok(builderJs.includes('hasAudioOffset:'),
    'Builder should track hasAudioOffset per segment');
});

test('setTrackItemInOutPoints handles audio offsets', () => {
  assert.ok(builderJs.includes('segData.hasAudioOffset'),
    'Should check for audio offsets when setting in/out points');
  assert.ok(builderJs.includes('segData.audioInPoint'),
    'Should use audioInPoint for audio track');
  assert.ok(builderJs.includes('segData.audioOutPoint'),
    'Should use audioOutPoint for audio track');
});

// ============================================================================
// Test Suite 8: CSS Styles
// ============================================================================

console.log('\n=== 8. CSS Styles ===');

test('Collapsed class is defined in CSS', () => {
  assert.ok(indexHtml.includes('.collapsed'),
    'Should have .collapsed CSS class');
  assert.ok(indexHtml.includes('display: none'),
    '.collapsed should hide elements');
});

test('J-Cut slider styling exists', () => {
  assert.ok(indexHtml.includes('.jcut-options'),
    'Should have J-Cut options styling');
});

// ============================================================================
// Summary
// ============================================================================

console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed > 0) {
  console.log('\n⚠ Some tests failed!');
  process.exit(1);
} else {
  console.log('\n✓ All tests passed!');
  process.exit(0);
}
