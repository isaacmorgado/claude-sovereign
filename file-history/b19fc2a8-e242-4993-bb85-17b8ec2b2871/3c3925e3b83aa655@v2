/**
 * E2E Test Endpoint for Product Registry
 * GET /api/test-guides
 */

import { NextResponse } from 'next/server';
import {
  GUIDE_PRODUCTS,
  getBaseStackProducts,
  getTotalProductCount,
  getProductCategories,
  getCategoryDisplayInfo,
  getGuideProductById,
} from '@/data/guides';

export async function GET() {
  const tests: Array<{ name: string; passed: boolean; details: string }> = [];

  // Test 1: Total product count
  const totalCount = getTotalProductCount();
  tests.push({
    name: 'Total Products = 33',
    passed: totalCount === 33,
    details: `Got: ${totalCount}`,
  });

  // Test 2: Category counts
  const categories = getProductCategories();
  const expectedCounts: Record<string, number> = {
    hygiene: 4,
    grooming: 5,
    skincare: 5,
    miscellaneous: 9,
    supplements: 10,
  };

  let categoryPassed = true;
  const categoryDetails: string[] = [];
  categories.forEach(({ category, count }) => {
    const expected = expectedCounts[category];
    if (count !== expected) {
      categoryPassed = false;
      categoryDetails.push(`${category}: expected ${expected}, got ${count}`);
    } else {
      categoryDetails.push(`${category}: ${count} âœ“`);
    }
  });

  tests.push({
    name: 'Category Counts',
    passed: categoryPassed,
    details: categoryDetails.join(', '),
  });

  // Test 3: Base stack products exist
  const baseStack = getBaseStackProducts();
  tests.push({
    name: 'Base Stack Products',
    passed: baseStack.length > 0,
    details: `${baseStack.length} products: ${baseStack.map(p => p.name).join(', ')}`,
  });

  // Test 4: All products have region links
  const productsWithRegions = GUIDE_PRODUCTS.filter(
    p => Object.keys(p.regionLinks).length >= 5 || p.directLink
  );
  tests.push({
    name: 'Products Have Region Links',
    passed: productsWithRegions.length === GUIDE_PRODUCTS.length,
    details: `${productsWithRegions.length}/${GUIDE_PRODUCTS.length} have 5+ regions`,
  });

  // Test 5: All products have taglines
  const productsWithTaglines = GUIDE_PRODUCTS.filter(
    p => p.tagline && p.tagline.length >= 10
  );
  tests.push({
    name: 'Products Have Taglines',
    passed: productsWithTaglines.length === GUIDE_PRODUCTS.length,
    details: `${productsWithTaglines.length}/${GUIDE_PRODUCTS.length} have taglines`,
  });

  // Test 6: Get product by ID
  const testProduct = getGuideProductById('creatine_mono');
  tests.push({
    name: 'Get Product By ID',
    passed: testProduct !== undefined && testProduct.name === 'Creatine Monohydrate',
    details: testProduct ? `Found: ${testProduct.name}` : 'Not found',
  });

  // Test 7: Category display info
  const hygieneInfo = getCategoryDisplayInfo('hygiene');
  tests.push({
    name: 'Category Display Info',
    passed: hygieneInfo.name === 'Hygiene' && hygieneInfo.icon !== undefined,
    details: `name: ${hygieneInfo.name}, icon: ${hygieneInfo.icon}`,
  });

  // Test 8: Region links contain affiliate tags
  const firstProduct = GUIDE_PRODUCTS[0];
  const usLink = firstProduct.regionLinks.us || '';
  tests.push({
    name: 'Affiliate Tags in Links',
    passed: usLink.includes('tag=looksmaxx-20'),
    details: usLink.substring(0, 80) + '...',
  });

  // Summary
  const passedCount = tests.filter(t => t.passed).length;
  const allPassed = passedCount === tests.length;

  return NextResponse.json({
    status: allPassed ? 'PASS' : 'FAIL',
    summary: `${passedCount}/${tests.length} tests passed`,
    tests,
    productSample: {
      id: GUIDE_PRODUCTS[0].id,
      name: GUIDE_PRODUCTS[0].name,
      tagline: GUIDE_PRODUCTS[0].tagline,
      regions: Object.keys(GUIDE_PRODUCTS[0].regionLinks),
    },
  });
}
