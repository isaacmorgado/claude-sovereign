/**
 * SPLICE Email Service
 *
 * Handles email delivery for license keys, payment notifications, etc.
 * Supports multiple providers: SendGrid (primary), AWS SES (fallback)
 *
 * Required env vars:
 * - EMAIL_PROVIDER: 'sendgrid' | 'ses' | 'console' (default: 'console' for dev)
 * - SENDGRID_API_KEY: SendGrid API key
 * - AWS_SES_REGION: AWS SES region (default: 'us-east-1')
 * - AWS_ACCESS_KEY_ID: AWS access key (for SES)
 * - AWS_SECRET_ACCESS_KEY: AWS secret (for SES)
 * - EMAIL_FROM: Sender email address (default: 'noreply@splice.video')
 */

// ============================================================================
// CONFIGURATION
// ============================================================================

const EMAIL_CONFIG = {
  provider: process.env.EMAIL_PROVIDER || 'console',
  from: process.env.EMAIL_FROM || 'SPLICE <noreply@splice.video>',
  replyTo: process.env.EMAIL_REPLY_TO || 'support@splice.video',
  sendgrid: {
    apiKey: process.env.SENDGRID_API_KEY
  },
  ses: {
    region: process.env.AWS_SES_REGION || 'us-east-1'
  }
};

// Email templates
const TEMPLATES = {
  licenseKey: {
    subject: 'Your SPLICE License Key',
    html: (data) => `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }
    .license-box { background: #f8f5ff; border: 2px solid #7c3aed; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }
    .license-key { font-family: monospace; font-size: 24px; font-weight: bold; color: #7c3aed; letter-spacing: 2px; }
    .tier-badge { display: inline-block; background: #7c3aed; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-top: 10px; }
    .instructions { background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; }
    .instructions h3 { margin-top: 0; color: #374151; }
    .instructions ol { margin: 0; padding-left: 20px; }
    .instructions li { margin: 8px 0; }
    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }
    .button { display: inline-block; background: #7c3aed; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">SPLICE</div>
      <p>AI-Powered Video Editing</p>
    </div>

    <h2>Welcome to SPLICE!</h2>
    <p>Thank you for subscribing. Your license key is ready:</p>

    <div class="license-box">
      <div class="license-key">${escapeHtml(data.licenseKey)}</div>
      <div class="tier-badge">${escapeHtml(data.tier.toUpperCase())} Plan</div>
    </div>

    <div class="instructions">
      <h3>How to Activate</h3>
      <ol>
        <li>Open Adobe Premiere Pro</li>
        <li>Go to <strong>Window > Extensions > SPLICE</strong></li>
        <li>Click the <strong>Settings</strong> icon (gear)</li>
        <li>Enter your license key in the activation field</li>
        <li>Click <strong>Activate</strong></li>
      </ol>
    </div>

    <p>Your ${escapeHtml(data.tier)} plan includes:</p>
    <ul>
      <li><strong>${escapeHtml(String(data.hours))} hours</strong> of AI processing per month</li>
      <li><strong>${escapeHtml(String(data.musicCredits))} music credits</strong> per month</li>
      <li>All premium features</li>
    </ul>

    <p style="text-align: center;">
      <a href="https://splice.video/docs/getting-started" class="button">View Getting Started Guide</a>
    </p>

    <div class="footer">
      <p>Need help? Reply to this email or visit <a href="https://splice.video/support">splice.video/support</a></p>
      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
    `,
    text: (data) => `
SPLICE - Your License Key

Thank you for subscribing to SPLICE!

Your license key: ${data.licenseKey}
Plan: ${data.tier.toUpperCase()}

HOW TO ACTIVATE:
1. Open Adobe Premiere Pro
2. Go to Window > Extensions > SPLICE
3. Click the Settings icon (gear)
4. Enter your license key in the activation field
5. Click Activate

Your ${data.tier} plan includes:
- ${data.hours} hours of AI processing per month
- ${data.musicCredits} music credits per month
- All premium features

Need help? Visit https://splice.video/support

© ${new Date().getFullYear()} SPLICE. All rights reserved.
    `
  },

  paymentWarning: {
    subject: 'Action Required: Payment Failed for SPLICE',
    html: (data) => `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }
    .warning-box { background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; padding: 20px; margin: 20px 0; }
    .warning-icon { font-size: 48px; text-align: center; }
    .button { display: inline-block; background: #7c3aed; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }
    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">SPLICE</div>
    </div>

    <div class="warning-box">
      <div class="warning-icon">⚠️</div>
      <h2 style="text-align: center; color: #dc2626; margin: 10px 0;">Payment Failed</h2>
      <p>We were unable to process your payment for your SPLICE subscription. This was attempt ${escapeHtml(String(data.attemptCount))} of 3.</p>
    </div>

    <p>To keep your subscription active and avoid interruption to your service, please update your payment method:</p>

    <p style="text-align: center;">
      <a href="https://splice.video/account/billing" class="button">Update Payment Method</a>
    </p>

    <p><strong>What happens next?</strong></p>
    <ul>
      <li>We'll automatically retry the payment in a few days</li>
      <li>If all payment attempts fail, your subscription will be cancelled</li>
      <li>You'll lose access to premium features</li>
    </ul>

    <p>If you have any questions or need assistance, please don't hesitate to reach out.</p>

    <div class="footer">
      <p>Need help? Reply to this email or visit <a href="https://splice.video/support">splice.video/support</a></p>
      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
    `,
    text: (data) => `
SPLICE - Payment Failed

We were unable to process your payment for your SPLICE subscription.
This was attempt ${data.attemptCount} of 3.

To keep your subscription active, please update your payment method:
https://splice.video/account/billing

WHAT HAPPENS NEXT:
- We'll automatically retry the payment in a few days
- If all payment attempts fail, your subscription will be cancelled
- You'll lose access to premium features

If you have any questions, please reply to this email.

© ${new Date().getFullYear()} SPLICE. All rights reserved.
    `
  },

  licenseLookup: {
    subject: 'Your SPLICE License Key',
    html: (data) => `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }
    .license-box { background: #f8f5ff; border: 2px solid #7c3aed; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }
    .license-key { font-family: monospace; font-size: 24px; font-weight: bold; color: #7c3aed; letter-spacing: 2px; }
    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">SPLICE</div>
    </div>

    <h2>License Key Lookup</h2>
    <p>You requested your SPLICE license key. Here it is:</p>

    <div class="license-box">
      <div class="license-key">${escapeHtml(data.licenseKey)}</div>
    </div>

    <p>If you didn't request this, you can safely ignore this email.</p>

    <div class="footer">
      <p>Need help? Reply to this email or visit <a href="https://splice.video/support">splice.video/support</a></p>
      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
    `,
    text: (data) => `
SPLICE - License Key Lookup

You requested your SPLICE license key. Here it is:

${data.licenseKey}

If you didn't request this, you can safely ignore this email.

Need help? Visit https://splice.video/support

© ${new Date().getFullYear()} SPLICE. All rights reserved.
    `
  }
};

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Escape HTML to prevent XSS in email content
 */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  if (typeof str !== 'string') str = String(str);

  const escapeMap = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;'
  };

  return str.replace(/[&<>"']/g, char => escapeMap[char]);
}

/**
 * Get tier details for email
 */
function getTierDetails(tier) {
  const tiers = {
    starter: { hours: 4, musicCredits: 2 },
    pro: { hours: 15, musicCredits: 10 },
    team: { hours: 50, musicCredits: 50 }
  };
  return tiers[tier] || tiers.starter;
}

// ============================================================================
// EMAIL PROVIDERS
// ============================================================================

/**
 * Send email via SendGrid
 */
async function sendViaSendGrid(to, subject, html, text) {
  if (!EMAIL_CONFIG.sendgrid.apiKey) {
    throw new Error('SENDGRID_API_KEY not configured');
  }

  const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${EMAIL_CONFIG.sendgrid.apiKey}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      personalizations: [{ to: [{ email: to }] }],
      from: { email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || EMAIL_CONFIG.from, name: 'SPLICE' },
      reply_to: { email: EMAIL_CONFIG.replyTo },
      subject,
      content: [
        { type: 'text/plain', value: text },
        { type: 'text/html', value: html }
      ]
    })
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`SendGrid error: ${response.status} - ${error}`);
  }

  return { provider: 'sendgrid', messageId: response.headers.get('x-message-id') };
}

/**
 * Send email via AWS SES
 */
async function sendViaSES(to, subject, html, text) {
  // Dynamically import AWS SDK to avoid loading if not needed
  try {
    const { SESClient, SendEmailCommand } = await import('@aws-sdk/client-ses');

    const client = new SESClient({ region: EMAIL_CONFIG.ses.region });

    const command = new SendEmailCommand({
      Source: EMAIL_CONFIG.from,
      Destination: { ToAddresses: [to] },
      ReplyToAddresses: [EMAIL_CONFIG.replyTo],
      Message: {
        Subject: { Data: subject, Charset: 'UTF-8' },
        Body: {
          Html: { Data: html, Charset: 'UTF-8' },
          Text: { Data: text, Charset: 'UTF-8' }
        }
      }
    });

    const result = await client.send(command);
    return { provider: 'ses', messageId: result.MessageId };
  } catch (err) {
    if (err.code === 'ERR_MODULE_NOT_FOUND') {
      throw new Error('AWS SDK not installed. Run: npm install @aws-sdk/client-ses');
    }
    throw err;
  }
}

/**
 * Log email to console (development mode)
 */
function sendViaConsole(to, subject, html, text) {
  console.log('\n========== EMAIL (CONSOLE MODE) ==========');
  console.log(`To: ${to}`);
  console.log(`Subject: ${subject}`);
  console.log(`From: ${EMAIL_CONFIG.from}`);
  console.log('--- TEXT VERSION ---');
  console.log(text);
  console.log('==========================================\n');

  return { provider: 'console', messageId: `console-${Date.now()}` };
}

// ============================================================================
// PUBLIC API
// ============================================================================

/**
 * Send an email using the configured provider
 * @param {string} to - Recipient email
 * @param {string} subject - Email subject
 * @param {string} html - HTML content
 * @param {string} text - Plain text content
 * @returns {Promise<{provider: string, messageId: string}>}
 */
async function sendEmail(to, subject, html, text) {
  const provider = EMAIL_CONFIG.provider.toLowerCase();

  console.log(`[SPLICE Email] Sending to ${to} via ${provider}`);

  try {
    let result;

    switch (provider) {
      case 'sendgrid':
        result = await sendViaSendGrid(to, subject, html, text);
        break;
      case 'ses':
        result = await sendViaSES(to, subject, html, text);
        break;
      case 'console':
      default:
        result = sendViaConsole(to, subject, html, text);
        break;
    }

    console.log(`[SPLICE Email] Sent successfully via ${result.provider}: ${result.messageId}`);
    return result;
  } catch (err) {
    console.error(`[SPLICE Email] Failed to send via ${provider}:`, err.message);
    throw err;
  }
}

/**
 * Send license key email to customer
 * @param {string} email - Customer email
 * @param {string} licenseKey - The license key
 * @param {string} tier - Subscription tier (starter/pro/team)
 */
async function sendLicenseKeyEmail(email, licenseKey, tier) {
  const tierDetails = getTierDetails(tier);
  const template = TEMPLATES.licenseKey;

  const data = {
    licenseKey,
    tier,
    hours: tierDetails.hours,
    musicCredits: tierDetails.musicCredits
  };

  return sendEmail(
    email,
    template.subject,
    template.html(data),
    template.text(data)
  );
}

/**
 * Send payment warning email to customer
 * @param {string} email - Customer email
 * @param {number} attemptCount - Which payment attempt failed (1-3)
 */
async function sendPaymentWarningEmail(email, attemptCount) {
  const template = TEMPLATES.paymentWarning;
  const data = { attemptCount };

  return sendEmail(
    email,
    template.subject,
    template.html(data),
    template.text(data)
  );
}

/**
 * Send license key lookup email
 * @param {string} email - Customer email
 * @param {string} licenseKey - The license key
 */
async function sendLicenseLookupEmail(email, licenseKey) {
  const template = TEMPLATES.licenseLookup;
  const data = { licenseKey };

  return sendEmail(
    email,
    template.subject,
    template.html(data),
    template.text(data)
  );
}

/**
 * Check if email service is configured for production use
 */
function isEmailConfigured() {
  const provider = EMAIL_CONFIG.provider.toLowerCase();

  if (provider === 'sendgrid') {
    return !!EMAIL_CONFIG.sendgrid.apiKey;
  }

  if (provider === 'ses') {
    return !!(process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY);
  }

  // Console mode is always "configured" (for dev)
  return true;
}

// ============================================================================
// EXPORTS
// ============================================================================

module.exports = {
  sendEmail,
  sendLicenseKeyEmail,
  sendPaymentWarningEmail,
  sendLicenseLookupEmail,
  isEmailConfigured,
  EMAIL_CONFIG
};
