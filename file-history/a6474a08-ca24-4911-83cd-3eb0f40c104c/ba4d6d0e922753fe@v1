'use client';

import { useState, useMemo, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { X, ChevronLeft, ChevronRight, ChevronDown, Target, TrendingUp, TrendingDown } from 'lucide-react';
import { MetricScoreResult, Gender, Ethnicity } from '@/lib/harmony-scoring';
import { generateAIDescription, getSeverityFromScore } from '@/lib/aiDescriptions';
import { getScoreColor, Ratio } from '@/types/results';
import { GradientRangeBar } from '../visualization/GradientRangeBar';
import { FaceOverlay } from '../visualization/FaceOverlay';
import { LandmarkPoint } from '@/lib/landmarks';

// ============================================
// TYPES
// ============================================

interface RatioDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  ratio: MetricScoreResult | null;
  onPrevious?: () => void;
  onNext?: () => void;
  hasPrevious?: boolean;
  hasNext?: boolean;
  facePhoto?: string;
  landmarks?: LandmarkPoint[];
  allRatios?: Ratio[];
  profileType?: 'front' | 'side';
  gender?: Gender;
  ethnicity?: Ethnicity;
}

// ============================================
// COMPACT SCORE DISPLAY
// ============================================

function ScoreDisplay({ score, label }: { score: number; label: string }) {
  const color = getScoreColor(score);
  return (
    <div className="text-center">
      <div className="text-3xl font-bold" style={{ color }}>{score.toFixed(1)}</div>
      <div className="text-[10px] text-neutral-500 uppercase tracking-wider">{label}</div>
    </div>
  );
}

// ============================================
// ABOUT DESCRIPTIONS
// ============================================

// eslint-disable-next-line @typescript-eslint/no-unused-vars
function getAboutDescription(name: string, category: string, gender?: Gender, ethnicity?: Ethnicity): string {
  const descriptions: Record<string, string> = {
    'Face Width to Height Ratio': 'Facial Width-to-Height Ratio evaluates midface compactness by comparing its width to height. Balanced proportions suit most faces; higher ratios (shorter midfaces) are preferred for males.',
    'Lower Third': 'Facial thirds assess the vertical height of facial thirds relative to total facial height, favoring a balanced proportion with a slightly taller Lower Third in males.',
    'Middle Third': 'The middle third spans from the brow line to the base of the nose. A balanced middle third contributes to overall facial harmony.',
    'Upper Third': 'The upper third spans from the hairline to the brow line. Its proportion affects forehead prominence and hairline positioning.',
    'Lateral Canthal Tilt': 'Canthal tilt measures the angle of the eye from inner to outer corner. A positive tilt (outer corner higher) is generally considered more attractive and youthful.',
    'Gonial Angle': 'The gonial angle measures the angle at the jaw corner. A well-defined angle contributes to jaw prominence and facial structure.',
    'Bigonial Width': 'Bigonial width measures the distance between the jaw angles. It contributes to the perception of jaw strength and facial width.',
    'Eye Aspect Ratio': 'Eye aspect ratio compares eye height to width. Almond-shaped eyes with balanced proportions are often considered ideal.',
    'Nasal Index': 'The nasal index compares nose width to height. Balanced proportions contribute to facial harmony.',
    'Chin Philtrum Ratio': 'This ratio compares chin height to philtrum length. Proper balance contributes to lower face harmony.',
    'Submental Cervical Angle': 'This angle measures the definition between chin and neck. A well-defined angle creates a clean jawline profile.',
    'Nose Bridge Width': 'Compares nose bridge width to the overall nose width. Ideal proportions create a refined nasal appearance.',
    'Eyebrow Tilt': 'Measures the angle of the eyebrows. Balanced tilt contributes to a harmonious eye region.',
    'Brow Length Ratio': 'Compares eyebrow length to face width. Appropriately proportioned eyebrows create better facial framing.',
  };

  let baseDescription = descriptions[name] ||
    `This measurement evaluates your ${category.toLowerCase()} proportions and contributes to overall facial harmony.`;

  // Add gender-specific context if available
  if (gender) {
    const genderContext = gender === 'male'
      ? ' Ideal ranges for males tend to favor more angular and defined features.'
      : ' Ideal ranges for females tend to favor softer, more balanced proportions.';
    baseDescription += genderContext;
  }

  return baseDescription;
}

// ============================================
// MAIN MODAL COMPONENT
// ============================================

import { useResults } from '@/contexts/ResultsContext';

export function RatioDetailModal({
  isOpen,
  onClose,
  ratio,
  onPrevious,
  onNext,
  hasPrevious = false,
  hasNext = false,
  facePhoto,
  landmarks = [],
  allRatios = [],
  profileType = 'front',
  gender,
  ethnicity,
}: RatioDetailModalProps) {
  // Get data from context
  const { showLandmarkOverlay } = useResults();

  // Handle client-side mounting for portal
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  // Generate AI description from ratio data
  const flawDetail = useMemo(() => {
    if (!ratio) return null;

    return generateAIDescription(
      ratio.metricId.toLowerCase().replace(/\s+/g, ''),
      ratio.name,
      ratio.value,
      ratio.idealMin,
      ratio.idealMax,
      ratio.score,
      ratio.unit,
      ratio.category
    );
  }, [ratio]);

  // Find the full Ratio object for FaceOverlay visualization
  const selectedRatioForOverlay = useMemo((): Ratio | null => {
    if (!ratio) return null;
    // Try to find the matching ratio in allRatios
    const found = allRatios.find(r => r.id === ratio.metricId || r.name === ratio.name);
    if (found) return found;

    // Create a minimal Ratio object from MetricScoreResult for visualization
    return {
      id: ratio.metricId,
      name: ratio.name,
      value: ratio.value,
      score: ratio.score,
      standardizedScore: ratio.standardizedScore || ratio.score,
      idealMin: ratio.idealMin,
      idealMax: ratio.idealMax,
      category: ratio.category,
      unit: ratio.unit === 'ratio' ? 'x' : ratio.unit === 'percent' ? '%' : ratio.unit === 'degrees' ? 'Â°' : '',
      qualityLevel: ratio.qualityTier || 'good',
      severity: ratio.severity || 'moderate',
    } as Ratio;
  }, [ratio, allRatios]);

  // Early returns
  if (!mounted) return null;
  if (!ratio || !flawDetail) return null;

  const scoreColor = getScoreColor(ratio.score);
  const isWithinIdeal = ratio.value >= ratio.idealMin && ratio.value <= ratio.idealMax;
  const severity = getSeverityFromScore(ratio.score);

  // Get metric config for decay rate
  const metricConfig = METRIC_CONFIGS[ratio.metricId];
  const decayRate = metricConfig?.decayRate || 4;

  // Format values with units
  const formatUnit = (v: number) => {
    const formatted = v.toFixed(ratio.unit === 'percent' ? 1 : 2);
    let suffix = '';
    switch (ratio.unit) {
      case 'percent':
        suffix = ' %';
        break;
      case 'degrees':
        suffix = '\u00B0';
        break;
      case 'mm':
        suffix = ' mm';
        break;
      case 'ratio':
      default:
        suffix = '';
    }
    return `${formatted}${suffix}`;
  };

  // Calculate range for visualization
  const idealRange = ratio.idealMax - ratio.idealMin;
  const rangeMin = ratio.idealMin - idealRange * 1.5;
  const rangeMax = ratio.idealMax + idealRange * 1.5;

  // Use portal to render modal at document body level
  const modalContent = (
    <AnimatePresence>
      {isOpen && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[9998]"
          />

          {/* Navigation Arrows - Desktop */}
          {hasPrevious && onPrevious && (
            <motion.button
              initial={{ opacity: 0, x: -10 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -10 }}
              onClick={onPrevious}
              className="hidden lg:flex fixed left-4 xl:left-8 top-1/2 -translate-y-1/2 z-[10001] w-12 h-12 rounded-full bg-neutral-800 border border-neutral-600 shadow-xl hover:bg-neutral-700 hover:border-neutral-500 transition-all items-center justify-center group"
              aria-label="Previous measurement"
            >
              <ChevronLeft className="w-6 h-6 text-neutral-300 group-hover:text-white" />
            </motion.button>
          )}

          {hasNext && onNext && (
            <motion.button
              initial={{ opacity: 0, x: 10 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: 10 }}
              onClick={onNext}
              className="hidden lg:flex fixed right-4 xl:right-8 top-1/2 -translate-y-1/2 z-[10001] w-12 h-12 rounded-full bg-neutral-800 border border-neutral-600 shadow-xl hover:bg-neutral-700 hover:border-neutral-500 transition-all items-center justify-center group"
              aria-label="Next measurement"
            >
              <ChevronRight className="w-6 h-6 text-neutral-300 group-hover:text-white" />
            </motion.button>
          )}

          {/* Modal Container - Full screen flex centering */}
          <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 pointer-events-none">
            <motion.div
              initial={{ opacity: 0, scale: 0.95, y: 20 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              transition={{ type: 'spring', damping: 25, stiffness: 300 }}
              className="relative w-full max-w-5xl max-h-[90vh] overflow-hidden bg-neutral-900 border border-neutral-700 rounded-2xl shadow-2xl pointer-events-auto"
            >
              {/* Header */}
              <div className="sticky top-0 bg-neutral-900/95 backdrop-blur-sm border-b border-neutral-800 px-4 py-4 md:px-6 z-10">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3 flex-1 min-w-0">
                    {/* Mobile nav */}
                    {hasPrevious && onPrevious && (
                      <button
                        onClick={onPrevious}
                        className="lg:hidden flex-shrink-0 p-1.5 rounded-lg hover:bg-neutral-800 transition-colors text-neutral-400"
                        aria-label="Previous measurement"
                      >
                        <ChevronLeft className="w-5 h-5" />
                      </button>
                    )}

                    <h2 className="text-lg md:text-xl font-semibold text-white truncate">
                      {ratio.name}
                    </h2>

                    {hasNext && onNext && (
                      <button
                        onClick={onNext}
                        className="lg:hidden flex-shrink-0 p-1.5 rounded-lg hover:bg-neutral-800 transition-colors text-neutral-400"
                        aria-label="Next measurement"
                      >
                        <ChevronRight className="w-5 h-5" />
                      </button>
                    )}
                  </div>

                  <button
                    onClick={onClose}
                    className="flex-shrink-0 ml-4 p-2 rounded-lg hover:bg-neutral-800 transition-colors text-neutral-400 hover:text-white"
                  >
                    <X className="w-5 h-5" />
                  </button>
                </div>
              </div>

              {/* Content */}
              <div className="p-4 md:p-6 space-y-4 overflow-y-auto max-h-[calc(90vh-72px)]">
                {/* Stats Grid */}
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <StatCard
                    label="Your Value"
                    value={formatUnit(ratio.value)}
                    subtext={isWithinIdeal ? 'Within ideal' : 'Outside ideal'}
                    variant="default"
                    subtextColor={isWithinIdeal ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'}
                  />
                  <StatCard
                    label="Ideal Range"
                    value={`${formatUnit(ratio.idealMin)} - ${formatUnit(ratio.idealMax)}`}
                    subtext="Target range"
                    variant="ideal"
                  />
                  <StatCard
                    label="Score"
                    value={`${ratio.score.toFixed(2)}/10`}
                    subtext="Normalized score (1-10)"
                    variant="score"
                    scoreColor={scoreColor}
                  />
                </div>

                {/* Gradient Range Bar */}
                <GradientRangeBar
                  value={ratio.value}
                  idealMin={ratio.idealMin}
                  idealMax={ratio.idealMax}
                  rangeMin={rangeMin}
                  rangeMax={rangeMax}
                  unit={ratio.unit}
                />

                {/* Two Column Layout */}
                <div className="grid lg:grid-cols-2 gap-4">
                  {/* Face Image with Visualization */}
                  {facePhoto && (
                    <div>
                      <FaceOverlay
                        photo={facePhoto}
                        landmarks={landmarks}
                        selectedRatio={selectedRatioForOverlay}
                        profileType={profileType}
                        showAllLandmarks={showLandmarkOverlay}
                      />
                    </div>
                  )}

                  {/* Info Sections */}
                  <div className={`space-y-4 ${!facePhoto ? 'lg:col-span-2' : ''}`}>
                    {/* May Indicate Strengths - Only show if score is >= 7 */}
                    {ratio.score >= 7 && (
                      <div className="rounded-xl bg-cyan-500/10 border border-cyan-500/30 p-4">
                        <div className="flex items-center gap-2 mb-3">
                          <Sparkles size={14} className="text-cyan-400" />
                          <span className="text-[10px] font-medium text-cyan-400 uppercase tracking-wider">
                            May Indicate Strengths
                          </span>
                        </div>
                        <div className="space-y-3">
                          <div className="pb-3 last:border-0 last:pb-0">
                            <div className="text-sm font-semibold text-white mb-1">
                              {ratio.score >= 9 ? 'Ideal ' : 'Good '}{ratio.name.toLowerCase()}
                            </div>
                            <div className="text-xs text-neutral-300 leading-relaxed">
                              The {ratio.name} measurement is {isWithinIdeal ? 'within' : 'close to'} the ideal range.
                              This contributes to a harmonious {ratio.category.toLowerCase()} appearance.
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* May Indicate Flaws - Only show if score is below 7 */}
                    {ratio.score < 7 && (
                      <div className="rounded-xl bg-amber-500/10 border border-amber-500/30 p-4">
                        <div className="flex items-center gap-2 mb-3">
                          <AlertTriangle size={14} className="text-amber-400" />
                          <span className="text-[10px] font-medium text-amber-400 uppercase tracking-wider">
                            May Indicate Flaws
                          </span>
                        </div>
                        <div className="space-y-3">
                          <div className="pb-3 last:border-0 last:pb-0">
                            <div className="text-sm font-semibold text-white mb-1">
                              {flawDetail.flawName}
                            </div>
                            <div className="text-xs text-neutral-300 leading-relaxed">
                              {flawDetail.reasoning}
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* About This Ratio */}
                    <div className="rounded-xl bg-neutral-800/50 border border-neutral-700 p-4">
                      <div className="flex items-center gap-2 mb-3">
                        <Info size={14} className="text-neutral-400" />
                        <span className="text-[10px] font-medium text-neutral-400 uppercase tracking-wider">
                          About This Ratio
                        </span>
                      </div>
                      <div className="text-sm text-neutral-300 leading-relaxed">
                        {getAboutDescription(ratio.name, ratio.category, gender, ethnicity)}
                      </div>
                    </div>

                    {/* Scoring Methodology Chart */}
                    <ScoringMethodologyChart
                      value={ratio.value}
                      score={ratio.score}
                      idealMin={ratio.idealMin}
                      idealMax={ratio.idealMax}
                      rangeMin={rangeMin}
                      rangeMax={rangeMax}
                      unit={ratio.unit}
                      decayRate={decayRate}
                    />

                    {/* Category Badge */}
                    <div className="flex flex-wrap items-center gap-2">
                      <span className="px-3 py-1.5 rounded-lg bg-neutral-800 border border-neutral-700 text-xs font-medium text-neutral-300">
                        {ratio.category}
                      </span>
                      <span
                        className="px-3 py-1.5 rounded-lg text-xs font-medium capitalize"
                        style={{
                          backgroundColor: `${scoreColor}20`,
                          color: scoreColor,
                          border: `1px solid ${scoreColor}40`,
                        }}
                      >
                        {severity.replace('_', ' ')}
                      </span>
                      {gender && (
                        <span className="px-3 py-1.5 rounded-lg bg-neutral-800 border border-neutral-700 text-xs font-medium text-neutral-300 capitalize">
                          {gender}
                        </span>
                      )}
                      {ethnicity && ethnicity !== 'other' && (
                        <span className="px-3 py-1.5 rounded-lg bg-neutral-800 border border-neutral-700 text-xs font-medium text-neutral-300 capitalize">
                          {ethnicity.replace('_', ' ')}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </motion.div>
          </div>
        </>
      )}
    </AnimatePresence>
  );

  return createPortal(modalContent, document.body);
}

export default RatioDetailModal;
