'use client';

import { motion } from 'framer-motion';
import Image from 'next/image';
import { User, ScanFace, Sparkles, ChevronRight, TrendingUp, TrendingDown, Ruler, Eye, Zap } from 'lucide-react';
import { useResults } from '@/contexts/ResultsContext';
import { useHeightOptional } from '@/contexts/HeightContext';
import { TabContent } from '../ResultsLayout';
import { ScoreBar, AnimatedScore, ShareButton, ExportButton } from '../shared';
import { FacialRadarChart } from '../visualization/FacialRadarChart';
import { RatioDetailModal } from '../modals/RatioDetailModal';
import { getScoreColor, ResponsibleRatio, Ratio } from '@/types/results';
import { MetricScoreResult } from '@/lib/harmony-scoring';
import { RankedMetric, getWeightTierColor } from '@/lib/looksmax-scoring';
import { calculatePSL, getTierColor } from '@/lib/psl-calculator';
import { useState, useCallback, useMemo } from 'react';
import { usePricing } from '@/contexts/PricingContext';

// ============================================
// BENTO GRID CARDS - Clean, hierarchical design
// ============================================

interface ProfileScoreCardProps {
  title: string;
  score: number | string;
  icon: React.ReactNode;
  photo?: string;
  ratioCount: number;
  onClick?: () => void;
}

function ProfileScoreCard({ title, score, icon, photo, ratioCount, onClick }: ProfileScoreCardProps) {
  const numericScore = typeof score === 'number' ? score : 0;
  const color = getScoreColor(numericScore);

  return (
    <motion.button
      onClick={onClick}
      className="group bg-neutral-900/60 border border-neutral-800/50 rounded-2xl p-4 hover:border-cyan-500/30 hover:bg-neutral-900/80 transition-all text-left w-full"
      whileHover={{ y: -2 }}
      whileTap={{ scale: 0.98 }}
    >
      <div className="flex items-center gap-4">
        {/* Photo */}
        <div className="relative w-12 h-12 rounded-xl overflow-hidden bg-neutral-800 flex-shrink-0">
          {photo ? (
            <Image src={photo} alt={title} width={48} height={48} className="object-cover" unoptimized />
          ) : (
            <div className="w-full h-full flex items-center justify-center">{icon}</div>
          )}
        </div>

        {/* Info */}
        <div className="flex-1 min-w-0">
          <h3 className="text-xs font-medium text-neutral-500 uppercase tracking-wider">{title}</h3>
          <div className="flex items-baseline gap-1.5">
            <span className="text-xl font-bold" style={{ color }}>
              {typeof score === 'number' ? score.toFixed(1) : score}
            </span>
            <span className="text-xs text-neutral-600">/10</span>
          </div>
        </div>

        {/* Arrow */}
        <div className="flex items-center gap-2">
          <span className="text-xs text-neutral-600">{ratioCount}</span>
          <ChevronRight size={16} className="text-neutral-700 group-hover:text-cyan-400 transition-colors" />
        </div>
      </div>
    </motion.button>
  );
}

// ============================================
// COMPACT INSIGHT CARD
// ============================================

interface CompactInsightProps {
  label: string;
  value: string;
  trend?: 'up' | 'down' | 'neutral';
  color?: string;
  onClick?: () => void;
}

function CompactInsight({ label, value, trend, color, onClick }: CompactInsightProps) {
  return (
    <button
      onClick={onClick}
      className="flex items-center gap-2 px-3 py-2 bg-neutral-800/50 rounded-lg hover:bg-neutral-800 transition-colors group"
    >
      {trend && (
        <div className={`w-5 h-5 rounded flex items-center justify-center ${
          trend === 'up' ? 'bg-green-500/20' : trend === 'down' ? 'bg-red-500/20' : 'bg-neutral-700'
        }`}>
          {trend === 'up' ? <TrendingUp size={12} className="text-green-400" /> :
           trend === 'down' ? <TrendingDown size={12} className="text-red-400" /> : null}
        </div>
      )}
      <div className="text-left">
        <p className="text-[10px] text-neutral-500 uppercase tracking-wider">{label}</p>
        <p className="text-sm font-semibold" style={{ color: color || 'white' }}>{value}</p>
      </div>
      {onClick && <ChevronRight size={12} className="text-neutral-600 group-hover:text-cyan-400 ml-auto" />}
    </button>
  );
}

// ============================================
// QUICK STATS ROW - Condensed horizontal display
// ============================================

interface QuickStatsRowProps {
  topMetrics: RankedMetric[];
  bottomMetrics: RankedMetric[];
  onViewDetails: () => void;
}

function QuickStatsRow({ topMetrics, bottomMetrics, onViewDetails }: QuickStatsRowProps) {
  const topMetric = topMetrics[0];
  const bottomMetric = bottomMetrics[0];

  if (!topMetric && !bottomMetric) return null;

  return (
    <div className="flex flex-wrap items-center gap-3">
      {topMetric && (
        <div className="flex items-center gap-2 px-3 py-2 bg-green-500/10 border border-green-500/20 rounded-xl">
          <TrendingUp size={14} className="text-green-400" />
          <span className="text-xs text-neutral-400">Best:</span>
          <span className="text-sm font-medium text-green-400">{topMetric.name}</span>
          <span className="text-xs text-green-400/70">
            {typeof topMetric.score === 'number' ? topMetric.score.toFixed(1) : topMetric.score}
          </span>
        </div>
      )}
      {bottomMetric && (
        <div className="flex items-center gap-2 px-3 py-2 bg-orange-500/10 border border-orange-500/20 rounded-xl">
          <TrendingDown size={14} className="text-orange-400" />
          <span className="text-xs text-neutral-400">Focus:</span>
          <span className="text-sm font-medium text-orange-400">{bottomMetric.name}</span>
          <span className="text-xs text-orange-400/70">
            {typeof bottomMetric.score === 'number' ? bottomMetric.score.toFixed(1) : bottomMetric.score}
          </span>
        </div>
      )}
      <button
        onClick={onViewDetails}
        className="ml-auto text-xs text-cyan-400 hover:text-cyan-300 flex items-center gap-1"
      >
        View all metrics <ChevronRight size={12} />
      </button>
    </div>
  );
}

// ============================================
// HERO SCORE CARD - Clean bento-style main score
// ============================================

function HeroScoreCard() {
  const { overallScore, harmonyPercentage, pslRating } = useResults();

  const safeOverallScore = typeof overallScore === 'number' && Number.isFinite(overallScore) ? overallScore : 0;
  const safeHarmonyPercentage = typeof harmonyPercentage === 'number' && Number.isFinite(harmonyPercentage) ? harmonyPercentage : 0;
  const safePsl = typeof pslRating?.psl === 'number' && Number.isFinite(pslRating.psl) ? pslRating.psl : 3.0;
  const safeTier = pslRating?.tier || 'MTN';
  const safePercentile = typeof pslRating?.percentile === 'number' && Number.isFinite(pslRating.percentile) ? pslRating.percentile : 50;

  const getPslColor = (psl: number) => {
    if (psl >= 7.0) return '#a855f7';
    if (psl >= 6.0) return '#22d3ee';
    if (psl >= 5.0) return '#22c55e';
    if (psl >= 4.0) return '#eab308';
    return '#f97316';
  };

  return (
    <motion.div
      className="bg-gradient-to-br from-neutral-900/90 to-neutral-950 border border-neutral-800/50 rounded-2xl p-6"
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
    >
      {/* Header */}
      <p className="text-xs text-neutral-500 uppercase tracking-wider mb-4">Weighted Harmony Score</p>

      {/* PSL + Tier Badge */}
      <div className="flex items-center gap-3 mb-4">
        <div className="px-4 py-2 bg-neutral-800/80 border border-neutral-700/50 rounded-xl">
          <div className="flex items-center gap-2">
            <span className="text-2xl font-bold" style={{ color: getPslColor(safePsl) }}>
              {safePsl.toFixed(1)}
            </span>
            <span className="text-xs text-neutral-500">PSL</span>
            <div className="h-4 w-px bg-neutral-700" />
            <span className="text-xs font-medium" style={{ color: getPslColor(safePsl) }}>
              {safeTier}
            </span>
            <span className="text-[10px] text-neutral-600">Top {(100 - safePercentile).toFixed(0)}%</span>
          </div>
        </div>
      </div>

      {/* Harmony Badge */}
      <div className="inline-flex px-3 py-1 bg-gradient-to-r from-purple-500/10 to-cyan-500/10 border border-purple-500/20 rounded-full mb-6">
        <span className="text-lg font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">
          {safeHarmonyPercentage.toFixed(0)}%
        </span>
        <span className="text-xs text-neutral-500 ml-2 self-center">Harmony</span>
      </div>

      {/* Main Score */}
      <div className="flex justify-center">
        <AnimatedScore
          score={safeOverallScore}
          duration={2}
          delay={0.3}
          showConfetti={true}
          confettiThreshold={7.5}
        />
      </div>
    </motion.div>
  );
}

// ============================================
// RADAR CARD - Category breakdown
// ============================================

function RadarCard() {
  return (
    <motion.div
      className="bg-neutral-900/60 border border-neutral-800/50 rounded-2xl p-4 h-full"
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      transition={{ delay: 0.2 }}
    >
      <div className="flex items-center justify-between mb-2">
        <p className="text-xs text-neutral-500 uppercase tracking-wider">Category Breakdown</p>
      </div>
      <div className="h-[220px]">
        <FacialRadarChart height={220} />
      </div>
    </motion.div>
  );
}

// ============================================
// OVERVIEW TAB
// ============================================

export function OverviewTab() {
  const {
    overallScore,
    frontScore,
    sideScore,
    frontRatios,
    sideRatios,
    strengths,
    flaws,
    frontPhoto,
    sidePhoto,
    frontLandmarks,
    sideLandmarks,
    gender,
    ethnicity,
    setActiveTab,
    topMetrics,
    bottomMetrics,
    setSelectedVisualizationMetric,
    isUnlocked,
  } = useResults();

  const { openPricingModal } = usePricing();

  const heightContext = useHeightOptional();
  const [selectedRatio, setSelectedRatio] = useState<MetricScoreResult | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  // Calculate PSL for the preview card
  const pslPreviewData = useMemo(() => {
    const heightCm = heightContext?.heightCm;
    if (!heightCm || !overallScore) {
      return { hasHeight: false, score: 0, tier: 'Unknown', tierColor: '#6b7280' };
    }

    const numericScore = typeof overallScore === 'number' ? overallScore : 0;
    const pslResult = calculatePSL({
      faceScore: numericScore,
      heightCm,
      gender: gender || 'male',
    });

    return {
      hasHeight: true,
      score: pslResult.score,
      tier: pslResult.tier,
      tierColor: getTierColor(pslResult.tier),
    };
  }, [heightContext?.heightCm, overallScore, gender]);

  // All ratios combined for modal navigation
  const allRatios = useMemo(() => [...frontRatios, ...sideRatios], [frontRatios, sideRatios]);

  // Current ratio index for navigation
  const currentRatioIndex = useMemo(() => {
    if (!selectedRatio) return -1;
    return allRatios.findIndex(r => r.id === selectedRatio.metricId);
  }, [selectedRatio, allRatios]);

  // Convert Ratio to MetricScoreResult for modal
  const ratioToMetricResult = useCallback((ratio: Ratio): MetricScoreResult => {
    return {
      metricId: ratio.id,
      name: ratio.name,
      value: ratio.value,
      score: ratio.score,
      standardizedScore: ratio.standardizedScore,
      idealMin: ratio.idealMin,
      idealMax: ratio.idealMax,
      deviation: 0,
      deviationDirection: 'within',
      unit: ratio.unit === 'x' ? 'ratio' : ratio.unit === '%' ? 'percent' : ratio.unit === 'Â°' ? 'degrees' : ratio.unit,
      category: ratio.category,
      qualityTier: ratio.qualityLevel,
      severity: ratio.severity,
    } as MetricScoreResult;
  }, []);

  // Handle ratio click from strengths/flaws sections
  const handleRatioClick = useCallback((ratio: ResponsibleRatio, categoryName: string) => {
    // Find the full ratio data from frontRatios or sideRatios
    const fullRatio = allRatios.find(
      (r) => r.name === ratio.ratioName || r.id === ratio.ratioId
    );

    // Update the visualization first (shows on face image)
    if (fullRatio) {
      setSelectedVisualizationMetric(fullRatio.id);
      setSelectedRatio(ratioToMetricResult(fullRatio));
    } else {
      // Create a minimal MetricScoreResult from ResponsibleRatio
      setSelectedVisualizationMetric(ratio.ratioId);
      setSelectedRatio({
        metricId: ratio.ratioId,
        name: ratio.ratioName,
        value: ratio.value,
        score: ratio.score,
        standardizedScore: ratio.score,
        idealMin: ratio.idealMin,
        idealMax: ratio.idealMax,
        deviation: 0,
        deviationDirection: 'within',
        unit: (ratio.unit as 'ratio' | 'percent' | 'degrees' | 'mm' | 'none') || 'ratio',
        category: ratio.category || categoryName,
        qualityTier: (typeof ratio.score === 'number' ? ratio.score : 0) >= 8 ? 'ideal' : (typeof ratio.score === 'number' ? ratio.score : 0) >= 6 ? 'excellent' : (typeof ratio.score === 'number' ? ratio.score : 0) >= 4 ? 'good' : 'below_average',
        severity: 'optimal',
      } as MetricScoreResult);
    }
    setIsModalOpen(true);
  }, [allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);

  // Navigate to previous/next ratio in modal
  const handlePreviousRatio = useCallback(() => {
    if (currentRatioIndex > 0) {
      const prevRatio = allRatios[currentRatioIndex - 1];
      setSelectedRatio(ratioToMetricResult(prevRatio));
      setSelectedVisualizationMetric(prevRatio.id);
    }
  }, [currentRatioIndex, allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);

  const handleNextRatio = useCallback(() => {
    if (currentRatioIndex < allRatios.length - 1) {
      const nextRatio = allRatios[currentRatioIndex + 1];
      setSelectedRatio(ratioToMetricResult(nextRatio));
      setSelectedVisualizationMetric(nextRatio.id);
    }
  }, [currentRatioIndex, allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);

  // Determine if selected ratio is from side profile
  const isSideRatio = useMemo(() => {
    if (!selectedRatio) return false;
    const sideMetricIds = sideRatios.map(r => r.id);
    return sideMetricIds.includes(selectedRatio.metricId);
  }, [selectedRatio, sideRatios]);

  // Memoized modal values (useMemo instead of useCallback for computed values)
  const modalPhoto = useMemo(() => {
    if (!selectedRatio) return frontPhoto;
    return isSideRatio ? (sidePhoto || frontPhoto) : frontPhoto;
  }, [selectedRatio, isSideRatio, frontPhoto, sidePhoto]);

  const modalLandmarks = useMemo(() => {
    return isSideRatio ? (sideLandmarks || []) : (frontLandmarks || []);
  }, [isSideRatio, frontLandmarks, sideLandmarks]);

  const modalProfileType = useMemo((): 'front' | 'side' => {
    return isSideRatio ? 'side' : 'front';
  }, [isSideRatio]);

  return (
    <TabContent
      title="Overview"
      subtitle="Your facial harmony analysis"
      rightContent={
        <div className="flex items-center gap-2">
          <ShareButton score={overallScore} frontScore={frontScore} sideScore={sideScore} />
          <ExportButton elementId="results-overview" />
        </div>
      }
    >
      {/* Bento Grid Layout */}
      <div id="results-overview" className="space-y-4">
        {/* Row 1: Hero Score + Radar Chart */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-4">
          <div className="lg:col-span-3">
            <HeroScoreCard />
          </div>
          <div className="lg:col-span-2">
            <RadarCard />
          </div>
        </div>

        {/* Row 2: Profile Cards */}
        <div className="grid grid-cols-2 gap-3">
          <ProfileScoreCard
            title="Front"
            score={frontScore}
            icon={<User size={20} className="text-neutral-600" />}
            photo={frontPhoto}
            ratioCount={frontRatios.length}
            onClick={() => setActiveTab('front-ratios')}
          />
          <ProfileScoreCard
            title="Side"
            score={sideScore}
            icon={<ScanFace size={20} className="text-neutral-600" />}
            photo={sidePhoto || undefined}
            ratioCount={sideRatios.length}
            onClick={() => setActiveTab('side-ratios')}
          />
        </div>

        {/* Row 3: Quick Stats */}
        <div className="bg-neutral-900/40 border border-neutral-800/50 rounded-2xl p-4">
          <QuickStatsRow
            topMetrics={topMetrics}
            bottomMetrics={bottomMetrics}
            onViewDetails={() => setActiveTab('front-ratios')}
          />
        </div>

        {/* Row 4: Action Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {/* PSL Card */}
          <motion.button
            onClick={() => setActiveTab('psl')}
            className="group flex items-center gap-4 p-4 bg-neutral-900/60 border border-neutral-800/50 rounded-2xl hover:border-purple-500/30 transition-all text-left"
            whileHover={{ y: -2 }}
          >
            <div className="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
              <Eye size={18} className="text-purple-400" />
            </div>
            <div className="flex-1">
              <p className="text-xs text-neutral-500 uppercase tracking-wider">PSL Rating</p>
              <p className="text-sm font-medium text-white">View detailed breakdown</p>
            </div>
            <ChevronRight size={16} className="text-neutral-700 group-hover:text-purple-400" />
          </motion.button>

          {/* Plan Card */}
          <motion.button
            onClick={() => {
              if (isUnlocked) {
                setActiveTab('plan');
              } else {
                openPricingModal('overview_cta');
              }
            }}
            className="group flex items-center gap-4 p-4 bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-500/20 rounded-2xl hover:border-cyan-500/40 transition-all text-left"
            whileHover={{ y: -2 }}
          >
            <div className="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center">
              <Zap size={18} className="text-cyan-400" />
            </div>
            <div className="flex-1">
              <p className="text-xs text-neutral-500 uppercase tracking-wider">Your Plan</p>
              <p className="text-sm font-medium text-white">
                {isUnlocked ? 'View recommendations' : 'Unlock your potential'}
              </p>
            </div>
            <ChevronRight size={16} className="text-neutral-700 group-hover:text-cyan-400" />
          </motion.button>
        </div>
      </div>

      {/* Ratio Detail Modal */}
      <RatioDetailModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        ratio={selectedRatio}
        onPrevious={handlePreviousRatio}
        onNext={handleNextRatio}
        hasPrevious={currentRatioIndex > 0}
        hasNext={currentRatioIndex < allRatios.length - 1}
        facePhoto={modalPhoto}
        landmarks={modalLandmarks}
        allRatios={allRatios}
        profileType={modalProfileType}
        gender={gender}
        ethnicity={ethnicity}
      />
    </TabContent>
  );
}
