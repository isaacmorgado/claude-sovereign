# Minor Issues Analysis - Female Analysis Testing

## STATUS: ✅ BOTH ISSUES FIXED (2025-12-23)

Commit: `6565afc` - "Fix lipRatio naming and Bezier curve demographic scoring"

## Summary
Two minor issues were identified during comprehensive female analysis testing:
1. `lipRatio` metric config not found
2. Scoring below 8.0 at ideal midpoint for some metrics

---

## Issue 1: lipRatio Config Not Found

### What Happened
The test called `getMetricConfigForDemographics('lipRatio', 'female', 'black')` and it returned `null`.

### Root Cause
**Naming mismatch between DEMOGRAPHIC_OVERRIDES and FACEIQ_METRICS**

| Location | Key Name | Lines |
|----------|----------|-------|
| `DEMOGRAPHIC_OVERRIDES` | `lipRatio` | 405-421 |
| `FACEIQ_METRICS` | `lowerToUpperLipRatio` | 1136-1151 |

The function `getMetricConfigForDemographics()` works like this:
```typescript
export function getMetricConfigForDemographics(
  metricId: string,
  gender: Gender,
  ethnicity: Ethnicity = 'other'
): MetricConfig | null {
  const baseConfig = FACEIQ_METRICS[metricId];  // ← Looks for 'lipRatio' here
  if (!baseConfig) return null;                  // ← Returns null because key is 'lowerToUpperLipRatio'
  // ... applies demographic overrides
}
```

### File Location
**File**: `src/lib/faceiq-scoring.ts`

**DEMOGRAPHIC_OVERRIDES section (lines 405-421):**
```typescript
lipRatio: {
  black_male: { idealMin: 1.6, idealMax: 2.2 },
  black_female: { idealMin: 1.3, idealMax: 1.6 },  // Exists!
  hispanic_female: { idealMin: 1.1, idealMax: 1.35 },
  // ...
}
```

**FACEIQ_METRICS section (lines 1136-1151):**
```typescript
lowerToUpperLipRatio: {  // ← Different name!
  id: 'lowerToUpperLipRatio',
  name: 'Lower Lip to Upper Lip Ratio',
  idealMin: 1.58,
  idealMax: 1.88,
  // ...
}
```

### Fix Options
1. **Option A**: Rename the key in DEMOGRAPHIC_OVERRIDES from `lipRatio` to `lowerToUpperLipRatio`
2. **Option B**: Add a separate `lipRatio` entry to FACEIQ_METRICS
3. **Option C**: Update the test to use `lowerToUpperLipRatio` instead of `lipRatio`

### Impact
- Low impact: The demographic overrides for lip ratio are not being applied
- Female-specific lip ratio ideal ranges exist but are not used in scoring

---

## Issue 2: Scoring Below 8.0 at Ideal Midpoint

### What Happened
Test: gonialAngle (white female)
- Value tested: 126 (midpoint of ideal range)
- Expected score: ≥8.0
- Actual score: 7.58

### Root Cause
**Bezier curve scoring is not perfectly symmetric around the ideal range**

The scoring uses custom Bezier curves (`FACEIQ_BEZIER_CURVES.gonialAngle`) that were extracted from FaceIQ. These curves:
1. Are optimized for the base ideal range (115-121°, per FACEIQ_METRICS)
2. When demographic overrides shift the ideal range (to 122-130° for female white), the Bezier curve doesn't automatically recenter

### File Location
**File**: `src/lib/faceiq-scoring.ts`

**Base config (lines 1311-1326):**
```typescript
gonialAngle: {
  id: 'gonialAngle',
  idealMin: 115,  // FaceIQ base range
  idealMax: 121,  // ← Bezier curve optimized for this range
  customCurve: FACEIQ_BEZIER_CURVES.gonialAngle,
}
```

**Demographic override (lines 275-289):**
```typescript
gonialAngle: {
  white_female: { idealMin: 122.0, idealMax: 130.0 },  // ← Override shifts range
  // But Bezier curve is still optimized for 115-121
}
```

**Bezier curve definition (src/lib/faceiq-bezier-curves.ts):**
```typescript
gonialAngle: [
  { x: 0.00, y: 0.00, ... },  // Score at rangeMin
  { x: 0.45, y: 1.00, ... },  // Peak at ~45% of range (around 115-121)
  { x: 1.00, y: 0.00, ... },  // Score at rangeMax
]
```

### Technical Explanation
The Bezier curve was designed for the base range (115-121°). When the `calculateFaceIQScore()` function applies it:

1. Value 126 is normalized relative to rangeMin (90) and rangeMax (145)
2. Normalized position = (126 - 90) / (145 - 90) = 0.655 (65.5% of range)
3. The Bezier peak is around 0.45 (45% of range, which is ~115-118°)
4. At 65.5%, the curve has already descended from peak, giving ~7.58 score

### Fix Options
1. **Option A**: Create separate Bezier curves for each demographic override
2. **Option B**: Dynamically shift the Bezier curve based on demographic ideal range
3. **Option C**: Use exponential decay scoring (fallback) instead of Bezier for demographics with shifted ranges
4. **Option D**: Accept as-is (7.58 is still a "good" score, just not "ideal")

### Impact
- Medium impact: Values at the demographic-specific ideal midpoint score lower than expected
- Only affects metrics with both custom Bezier curves AND demographic overrides that shift the range significantly

---

## Files Copied

1. **faceiq-scoring.ts** - Main scoring engine with all metric configs and scoring functions
2. **test-female-analysis.ts** - Comprehensive female analysis test suite
3. **test-female-recommendations.ts** - Female recommendations test suite

---

## Recommendations

### Immediate (Low Effort)
- Update test to use `lowerToUpperLipRatio` instead of `lipRatio`
- Document that Bezier curves are optimized for base ranges

### Future Enhancement (Medium Effort)
- Rename `lipRatio` in DEMOGRAPHIC_OVERRIDES to match `lowerToUpperLipRatio`
- Consider dynamic Bezier curve adjustment for demographic overrides

### Long-Term (High Effort)
- Extract and create demographic-specific Bezier curves from FaceIQ for each gender/ethnicity combination
