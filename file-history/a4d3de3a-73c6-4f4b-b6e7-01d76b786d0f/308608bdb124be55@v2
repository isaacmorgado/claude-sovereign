# SPLICE
AI-powered Premiere Pro UXP plugin for detecting takes, removing silences, and accelerating video editing workflows.

## Current Focus
Section: Slice 9 - Custom Razor API via XML workflow
Files: splice-plugin/js/slice9-razor.js, splice-backend/services/xmlProcessor.js

## Last Session (2025-12-19)
- **Slice 9 COMPLETE**: Custom Razor API fully working via XML export/modify/import
- **FFprobe Silence Detection**: Audio-level silence detection working (-30dB threshold)
- **XML Processor**: XMEML format parsing, clip splitting, gap removal all working
- **Tested**: Exported XML from Premiere Pro, processed with silences, clips correctly split

### Slice 9 Test Results
- Detected silence at 154.52s-155.06s (0.54s duration)
- Split video clip into 2 segments (0-4636 frames, 4652-5009 frames)
- Split 2 audio clips the same way (linked video/audio sync maintained)
- Gap removed: second clip shifted by 16 frames to close gap
- Output XML ready for import back to Premiere Pro

## Slice 9: Custom Razor API

The core innovation - actual clip splitting without UXP razor API:

### Workflow
1. Export sequence to FCP XML (manual export for now)
2. Detect silences with FFprobe (`silencedetect` filter)
3. Process XML: split clips at silence boundaries
4. Import processed XML as new sequence

### Files
- `splice-backend/services/ffprobeSilence.js` - FFprobe silence detection
- `splice-backend/services/xmlProcessor.js` - FCP XML parsing/modification
- `splice-plugin/js/slice9-razor.js` - Plugin razor workflow

### New API Endpoints
- `POST /silences-audio` - FFprobe-based silence detection
  ```json
  { "wavPath": "/path.wav", "threshold": -30, "minDuration": 0.5, "padding": 0.1 }
  ```
- `POST /process-xml` - Process FCP XML with silences
  ```json
  { "xmlPath": "/path.xml", "silences": [...], "removeGaps": true }
  ```
- `GET /ffprobe-check` - Check if FFprobe is installed

## UXP Action Pattern (CRITICAL)
```javascript
const project = await ppro.Project.getActiveProject();
project.lockedAccess(() => {
  project.executeTransaction((compoundAction) => {
    const action = clip.createSetNameAction(label);  // CREATE INSIDE
    compoundAction.addAction(action);
  }, 'Undo Label');
});
```

## API Endpoints
- `POST /analyze` - `{ wavPath }` → takes with shortLabel (cached)
- `POST /silences` - Whisper-based gap detection (original)
- `POST /silences-audio` - FFprobe-based audio silence detection (NEW)
- `POST /process-xml` - FCP XML processing (NEW)

## Key Constraints
- UXP requires Premiere Pro 25.6+ or Beta
- Use `127.0.0.1` not `localhost` in fetch URLs
- Plugin caches JS - reload via UXP Dev Tools
- Timebase: 254016000000 ticks/second
- TickTime objects: use `.ticks` property
- FFprobe required for audio silence detection: `brew install ffmpeg`

## Dependencies
```
splice-backend/
├── express, cors, dotenv
├── groq-sdk (Whisper transcription)
├── openai (GPT-4o-mini take detection)
└── fast-xml-parser (FCP XML manipulation) [NEW]
```

## Next Steps
1. ~~Test Slice 9 FFprobe silence detection~~ DONE
2. ~~Test XML export/process/import workflow end-to-end~~ DONE (export+process working)
3. Test importing processed XML back into Premiere Pro
4. Add automatic XML export via UXP (when API available)
5. Multiple silence handling (currently tested with 1 silence)

## Project Structure
```
splice-plugin/js/
├── config.js, utils.js, main.js
├── slice1-timeline.js (read clips)
├── slice3-export.js (export WAV)
├── slice6-analyze.js (transcription + takes)
├── slice7-apply.js (label + disable clips)
├── slice8-silence.js (Whisper-based silence)
└── slice9-razor.js (FFprobe + XML razor) [NEW]

splice-backend/
├── server.js
└── services/
    ├── transcription.js (Groq Whisper)
    ├── takeDetection.js (GPT-4o-mini)
    ├── silenceDetection.js (Whisper gaps)
    ├── ffprobeSilence.js (FFprobe silencedetect) [NEW]
    └── xmlProcessor.js (FCP XML processing) [NEW]
```
