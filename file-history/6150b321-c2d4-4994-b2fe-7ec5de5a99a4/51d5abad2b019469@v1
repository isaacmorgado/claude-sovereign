/**
 * Test script for the side-landmarks API endpoint
 *
 * Usage: node test-side-landmarks.js
 */

const API_URL = 'https://api-production-6148.up.railway.app';

// Sample side profile image (small test image) - using a placeholder
// In production, replace with actual side profile image
const SAMPLE_SIDE_PROFILE_URL = 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop&crop=face';

async function fetchImageAsBase64(url) {
  console.log('Fetching image from:', url);
  const response = await fetch(url);
  const buffer = await response.arrayBuffer();
  const base64 = Buffer.from(buffer).toString('base64');
  const contentType = response.headers.get('content-type') || 'image/jpeg';
  return `data:${contentType};base64,${base64}`;
}

async function testSideLandmarks() {
  console.log('='.repeat(60));
  console.log('Testing Side Landmarks API');
  console.log('API URL:', API_URL);
  console.log('='.repeat(60));

  try {
    // Step 1: Check API health
    console.log('\n[1/3] Checking API health...');
    const healthRes = await fetch(`${API_URL}/health`);
    const healthData = await healthRes.json();
    console.log('Health check:', healthData);

    if (!healthData.detection_ready) {
      console.error('ERROR: Detection model not ready');
      process.exit(1);
    }

    // Step 2: Fetch sample image
    console.log('\n[2/3] Fetching sample image...');
    const base64Image = await fetchImageAsBase64(SAMPLE_SIDE_PROFILE_URL);
    console.log('Image size:', Math.round(base64Image.length / 1024), 'KB');

    // Step 3: Test the FaceIQ-compatible endpoint
    console.log('\n[3/3] Testing /api/side-landmarks endpoint...');
    const startTime = Date.now();

    const response = await fetch(`${API_URL}/api/side-landmarks`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ image: base64Image }),
    });

    const elapsed = Date.now() - startTime;
    console.log(`Response time: ${elapsed}ms`);
    console.log(`Status: ${response.status} ${response.statusText}`);

    const data = await response.json();

    if (data.success) {
      console.log('\n✅ SUCCESS!');
      console.log('\nResponse data:');
      console.log('- Direction:', data.data.direction);
      console.log('- Rotation angle:', data.data.rotationAngle.toFixed(4), 'rad');
      console.log('- Center:', `(${data.data.center.x.toFixed(1)}, ${data.data.center.y.toFixed(1)})`);
      console.log('- Landmark count:', data.data.landmarkCount);
      console.log('- BBox:', data.data.bbox.map(v => v.toFixed(1)).join(', '));
      console.log('- Crop:', JSON.stringify(data.data.crop));

      console.log('\nNamed landmarks detected:');
      const namedKeys = Object.keys(data.data.namedLandmarks);
      console.log(`- ${namedKeys.length} named landmarks: ${namedKeys.slice(0, 10).join(', ')}...`);

      // Show a few specific landmarks
      const importantLandmarks = ['nasion', 'pronasale', 'subnasale', 'pogonion', 'menton'];
      console.log('\nKey landmarks:');
      for (const lm of importantLandmarks) {
        const point = data.data.namedLandmarks[lm];
        if (point) {
          console.log(`  - ${lm}: (${point.x.toFixed(1)}, ${point.y.toFixed(1)})`);
        }
      }
    } else {
      console.log('\n❌ FAILED!');
      console.log('Error:', data.error || data.message || 'Unknown error');
    }

    console.log('\n' + '='.repeat(60));

  } catch (error) {
    console.error('\n❌ ERROR:', error.message);
    if (error.cause) {
      console.error('Cause:', error.cause);
    }
    process.exit(1);
  }
}

// Also test the legacy endpoint for comparison
async function testLegacyEndpoint() {
  console.log('\n[BONUS] Testing legacy /detection/side endpoint...');

  const base64Image = await fetchImageAsBase64(SAMPLE_SIDE_PROFILE_URL);

  const response = await fetch(`${API_URL}/detection/side`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ image: base64Image }),
  });

  const data = await response.json();
  console.log('Legacy response success:', data.success);
  console.log('Legacy message:', data.message);
  if (data.direction) console.log('Direction:', data.direction);
  if (data.mapped_landmarks) {
    console.log('Mapped landmarks:', Object.keys(data.mapped_landmarks).length);
  }
}

// Run tests
testSideLandmarks()
  .then(() => testLegacyEndpoint())
  .then(() => {
    console.log('\n✅ All tests completed!');
  })
  .catch(console.error);
