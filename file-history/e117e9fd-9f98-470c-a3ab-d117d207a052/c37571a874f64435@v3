# SPLICE Auto-Cutting Enhancement Plan

## Goal
Add fully automatic clip cutting with unified detection modes and takes trimming.

## Key Features
1. **Automatic Cutting** - Clips cut and gaps closed without manual XML export/import
2. **Unified Workflow** - Single "Remove Silences" with detection mode dropdown
3. **Detection Modes:**
   - **Audio Only** - FFprobe silence detection (fast, good for clean audio)
   - **Audio + Dialogue** - FFprobe + LLM takes detection combined (for dialogue-heavy content)

## Smart Settings (Seamless UX)

### Always-On (No User Config Needed)
- **Natural Pause Detection** - Automatically preserves breaths and short thinking pauses (<0.5s)
- **Sentence Boundary Respect** - Never cuts mid-sentence (uses LLM in dialogue mode)
- **Minimum Keep Duration** - Never creates clips shorter than 0.3s (prevents choppy edits)

### User Controls
| Setting | Description | Default |
|---------|-------------|---------|
| **Sensitivity Slider** | Less (conservative) → More (aggressive) | 50% |
| **Padding Slider** | Breath room before/after cuts | 0.3s |
| **Detection Mode** | Audio Only vs Audio + Dialogue | Audio + Dialogue |
| **Vocal Isolation** | Isolate voice from noisy audio (recommended for loud backgrounds) | OFF |
| **Preview Before Apply** | Show cut regions as markers before deleting | ON |

### Usage & Billing Model
All usage is metered per user to ensure 80% profit margins.

| Mode | Our Cost | User Credit Cost | Notes |
|------|----------|------------------|-------|
| **Audio Only** | ~$0.005/min | 1 credit/min | FFprobe processing |
| **Audio + Dialogue** | ~$0.02/min | 3 credits/min | Whisper + GPT-4o-mini |
| **+ Vocal Isolation** | +$0.02/run | +2 credits | Replicate Demucs |

**Rate Limiting:**
- Each user has a credit balance
- API checks remaining credits before processing
- Exceeding limit shows upgrade prompt
- Usage tracked per endpoint in backend

### Preview Mode (Safety Net)
Before any cuts are made:
1. Colored markers appear on timeline showing proposed cuts
2. User can scrub through and see exactly what will be removed
3. Click "Apply" to proceed or "Adjust" to tweak settings
4. Prevents "oops I deleted something important" moments

---

## Technical Approach

### Challenge
UXP has no cut/delete APIs. Current workaround is XML export → process → import.

### Solution
**Cross-platform automation via backend** to control Premiere Pro menu actions:

**macOS:** AppleScript via `osascript`
**Windows:** PowerShell with UIAutomation / SendKeys

```
[UXP Plugin] --HTTP--> [Backend] --platform detect--> [Premiere Pro]
                           |            |
                           |    macOS: osascript
                           |    Windows: PowerShell
                           |
                    xmlProcessor.js
                    (cut clips, close gaps)
```

### Platform-Specific Automation

**macOS (`automator-mac.js`):**
```javascript
const { exec } = require('child_process');

async function exportXML(outputPath) {
  const script = `
    tell application "Adobe Premiere Pro 2025"
      activate
      tell application "System Events"
        keystroke "e" using {command down, shift down}  -- Export
        delay 0.5
        -- Navigate to FCP XML option
      end tell
    end tell
  `;
  await exec(`osascript -e '${script}'`);
}
```

**Windows (`automator-win.js`):**
```javascript
const { exec } = require('child_process');

async function exportXML(outputPath) {
  const script = `
    Add-Type -AssemblyName System.Windows.Forms
    $wshell = New-Object -ComObject wscript.shell
    $wshell.AppActivate('Adobe Premiere Pro')
    Start-Sleep -Milliseconds 500
    [System.Windows.Forms.SendKeys]::SendWait('^+e')  # Ctrl+Shift+E for Export
  `;
  await exec(`powershell -Command "${script}"`);
}
```

**Auto-detection (`automator.js`):**
```javascript
const os = require('os');
const platform = os.platform();

const automator = platform === 'darwin'
  ? require('./automator-mac')
  : require('./automator-win');

module.exports = automator;
```

---

## Files to Modify

### Backend (New)

**`splice-backend/services/automator.js`** - AppleScript automation
```javascript
// Export sequence to XML via menu automation
async function exportSequenceXML(outputPath)

// Import processed XML via menu automation
async function importXML(xmlPath)
```

**`splice-backend/services/hybridDetection.js`** - Combined detection
```javascript
// Combines audio silences with LLM takes for dialogue content
// Returns silences + non-best take regions merged
async function detectHybrid(wavPath, params)
```

### Backend (Modify)

**`splice-backend/server.js`** - New endpoints
```javascript
POST /detect-hybrid      // Audio + LLM detection combined
POST /auto-cut           // Full workflow: export → process → import
```

### Frontend (Modify)

**`splice-plugin/index.html`** - Simplified to single card
```html
<!-- Single action card with detection mode dropdown -->
<sp-dropdown id="detectionMode">
  <sp-menu-item value="audio">Audio Only (Fast)</sp-menu-item>
  <sp-menu-item value="dialogue">Audio + Dialogue (Recommended)</sp-menu-item>
</sp-dropdown>
<sp-checkbox id="usePadding" checked>Add padding (0.5s)</sp-checkbox>
```

**`splice-plugin/js/main.js`** - Unified workflow
- Single `initWorkflow()` that handles both modes
- Mode determines which backend endpoint to call

---

## UI Layout (Clean, Minimal)

### Default View
```
+----------------------------------------------------------+
|  SPLICE                                      [?] [GEAR]   |
+----------------------------------------------------------+
|  Credits: 47/100                              [Get More]  |
+----------------------------------------------------------+
|  +------------------------------------------------------+ |
|  |  Detection: ( ) Audio Only      (1 credit/min)       | |
|  |             (*) Audio + Dialogue (3 credits/min)     | |
|  |                                                      | |
|  |  [ ] Vocal Isolation (noisy audio) (+2 credits)      | |
|  |                                                      | |
|  |  Sensitivity: [========|=================]           | |
|  |               Less              More                 | |
|  |                                                      | |
|  |  Padding:     [=======|==================]  0.3s     | |
|  |               Less              More                 | |
|  |                                                      | |
|  |              [ ANALYZE ]                             | |
|  +------------------------------------------------------+ |
+----------------------------------------------------------+
```

### Preview Mode (After "Analyze")
```
+----------------------------------------------------------+
|  PREVIEW: 12 silences found (8.3s total)                  |
+----------------------------------------------------------+
|  [Timeline visualization with red markers]                |
|  |--[keep]--[CUT]--[keep]--[CUT]--[keep]--|              |
+----------------------------------------------------------+
|  [ APPLY CUTS ]            [ ADJUST ]      [ CANCEL ]    |
+----------------------------------------------------------+
```

### After Apply
```
+----------------------------------------------------------+
|  Done! Removed 12 silences (8.3s saved)                   |
|                                                          |
|  [ UNDO ]                                                |
+----------------------------------------------------------+
```

### Workflow Steps
1. **Pick preset** or adjust sensitivity (2 seconds)
2. **Click Analyze** - silences detected, preview shown
3. **Review preview** - see exactly what will be cut
4. **Click Apply** - cuts made, gaps closed
5. **Undo if needed** - one-click restore

---

## Fallback: Semi-Automatic

If AppleScript fails (permissions, app name changes):

1. Detection runs automatically
2. Modal guides user: "Export to `/tmp/splice_watch/`"
3. Backend watches folder, auto-processes
4. Modal guides user: "Import `/tmp/splice_processed/`"

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| **macOS** Accessibility permissions | Clear user instructions, fallback to manual mode |
| **Windows** UAC/focus issues | Run as admin option, fallback to manual mode |
| Premiere menu name changes | Version detection, configurable menu paths |
| Timing issues | Configurable delays, retry logic, progress feedback |
| Platform edge cases | Test on both macOS and Windows CI |

---

## Critical Files

| File | Changes |
|------|---------|
| `splice-backend/services/automator.js` | NEW - Cross-platform router (detects OS) |
| `splice-backend/services/automator-mac.js` | NEW - macOS AppleScript automation |
| `splice-backend/services/automator-win.js` | NEW - Windows PowerShell automation |
| `splice-backend/services/hybridDetection.js` | NEW - Audio + LLM combined detection |
| `splice-backend/services/smartFiltering.js` | NEW - Natural pause preservation, sentence boundaries |
| `splice-backend/services/usageTracking.js` | NEW - Credit balance, rate limiting, usage logging |
| `splice-backend/middleware/rateLimiter.js` | NEW - Credit check middleware for all endpoints |
| `splice-backend/server.js` | ADD `/analyze`, `/apply-cuts`, `/credits` endpoints |
| `splice-plugin/index.html` | Credit display, single action card, vocal isolation toggle |
| `splice-plugin/js/main.js` | Unified workflow with credit checks |
| `splice-plugin/js/credits.js` | NEW - Fetch and display user credit balance |
| `splice-plugin/js/preview.js` | NEW - Timeline visualization for cut preview |

---

## Implementation Phases

### Phase 1: Usage & Billing System (Backend)
Create credit/billing infrastructure:
- `usageTracking.js` - Credit balance per user, usage logging
- `rateLimiter.js` - Middleware to check credits before processing
- `/credits` endpoint - Return current balance
- Estimate credits needed before processing starts

### Phase 2: UI Simplification (Frontend)
Update `index.html`:
- Credit balance display with "Get More" link
- Detection mode radio buttons with credit costs
- Vocal isolation checkbox (+2 credits)
- Dual sliders (sensitivity + padding)

### Phase 3: Preview Mode (Frontend + Backend)
1. Backend returns cut regions with timestamps after `/analyze`
2. Frontend shows visual timeline with keep/cut segments
3. User reviews before confirming with "Apply Cuts"
4. "Adjust" button re-opens settings without re-analyzing

### Phase 4: Smart Filtering (Backend)
Create `smartFiltering.js`:
- `filterNaturalPauses(silences)` - removes breaths/short pauses from cut list
- `respectSentenceBoundaries(silences, transcript)` - extends cuts to sentence ends (dialogue mode only)
- `enforceMinimumDuration(silences)` - prevents micro-clips

### Phase 5: Cross-Platform Automation (Backend)
Create automation layer:
- `automator.js` - Platform detection and routing
- `automator-mac.js` - AppleScript via `osascript` for macOS
- `automator-win.js` - PowerShell/SendKeys for Windows
- Export sequence to XML automatically
- Process cuts in XML using existing `xmlProcessor.js`
- Import processed XML as new sequence
- Fallback to manual mode if permissions fail on either platform

### Phase 6: Integration & Polish
- End-to-end testing on macOS
- End-to-end testing on Windows
- Error handling and user feedback
- Loading states and progress indicators
- Documentation for permission setup (both platforms)
