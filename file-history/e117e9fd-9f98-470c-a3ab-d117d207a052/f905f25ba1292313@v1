/**
 * Slice 3: Audio Export
 *
 * Exports audio from the timeline as a WAV file
 * for transcription by the backend.
 */

/**
 * Initialize the Export Audio button
 */
function initAudioExporter() {
  document.getElementById('exportAudioBtn').addEventListener('click', async () => {
    const btn = document.getElementById('exportAudioBtn');

    btn.disabled = true;
    setStatus('Preparing audio export...');

    try {
      const context = await getActiveSequence();
      if (!context) {
        setStatus('No project or sequence open');
        btn.disabled = false;
        return;
      }

      const { sequence } = context;

      // Get EncoderManager
      const encoderManager = ppro.EncoderManager.getManager();
      if (!encoderManager) {
        setStatus('EncoderManager not available');
        btn.disabled = false;
        return;
      }

      setStatus(`Exporting to: ${WAV_PATH}`);

      // Export with WAV preset
      const result = await encoderManager.exportSequence(
        sequence,
        ppro.EncoderManager.EXPORT_IMMEDIATELY,
        WAV_PATH,
        WAV_PRESET_PATH,
        true // exportFull - export entire sequence
      );

      if (result) {
        setStatus(`Export complete: ${WAV_PATH}`);
        // Show the silence detection section after successful export
        showSilenceSection();
      } else {
        setStatus('Export returned false - check console');
      }

    } catch (err) {
      setStatus(`Export error: ${err.message}`);
      console.error('SPLICE export error:', err);
      console.error('Full error:', JSON.stringify(err, null, 2));
    }

    btn.disabled = false;
  });
}
