import type { PercentileResults, MeasurementScores } from '../types/scoring.js';
import { calculatePercentile } from '../utils/statistics.js';
import { POPULATION_STATS, DEFAULT_POPULATION_STATS } from '../constants/populationStats.js';

/**
 * Calculate percentiles for all measurements
 */
export function calculateAllPercentiles(
  scores: MeasurementScores
): PercentileResults {
  const byMeasurement: Record<string, number> = {};

  // Calculate percentile for each measurement score
  if (scores.fwhr) {
    byMeasurement.fwhr = scores.fwhr.percentile;
  }

  if (scores.canthalTilt) {
    byMeasurement.canthalTilt = scores.canthalTilt.percentile;
  }

  if (scores.facialThirds) {
    byMeasurement.facialThirds = scores.facialThirds.percentile;
  }

  if (scores.symmetry) {
    byMeasurement.symmetry = scores.symmetry.percentile;
  }

  if (scores.goldenRatio) {
    byMeasurement.goldenRatio = scores.goldenRatio.percentile;
  }

  if (scores.nasalIndex) {
    byMeasurement.nasalIndex = scores.nasalIndex.percentile;
  }

  if (scores.lipRatio) {
    byMeasurement.lipRatio = scores.lipRatio.percentile;
  }

  if (scores.nasolabialAngle) {
    byMeasurement.nasolabialAngle = scores.nasolabialAngle.percentile;
  }

  if (scores.gonialAngle) {
    byMeasurement.gonialAngle = scores.gonialAngle.percentile;
  }

  if (scores.chinProjection) {
    byMeasurement.chinProjection = scores.chinProjection.percentile;
  }

  if (scores.noseProjection) {
    byMeasurement.noseProjection = scores.noseProjection.percentile;
  }

  if (scores.facialConvexity) {
    byMeasurement.facialConvexity = scores.facialConvexity.percentile;
  }

  // Calculate overall percentile from harmony score
  const harmonyStats = POPULATION_STATS.harmonyScore || DEFAULT_POPULATION_STATS;
  const overall = calculatePercentile(scores.harmonyScore, harmonyStats);

  return {
    overall,
    byMeasurement,
  };
}

/**
 * Get percentile description
 */
export function getPercentileDescription(percentile: number): string {
  if (percentile >= 99) return 'Top 1%';
  if (percentile >= 95) return 'Top 5%';
  if (percentile >= 90) return 'Top 10%';
  if (percentile >= 80) return 'Top 20%';
  if (percentile >= 70) return 'Top 30%';
  if (percentile >= 60) return 'Above Average';
  if (percentile >= 40) return 'Average';
  if (percentile >= 30) return 'Below Average';
  if (percentile >= 20) return 'Bottom 30%';
  if (percentile >= 10) return 'Bottom 20%';
  if (percentile >= 5) return 'Bottom 10%';
  return 'Bottom 5%';
}

/**
 * Get percentile color for visualization
 */
export function getPercentileColor(percentile: number): string {
  if (percentile >= 90) return '#22c55e'; // Green
  if (percentile >= 70) return '#84cc16'; // Lime
  if (percentile >= 50) return '#eab308'; // Yellow
  if (percentile >= 30) return '#f97316'; // Orange
  return '#ef4444'; // Red
}

/**
 * Format percentile for display
 */
export function formatPercentile(percentile: number): string {
  const rounded = Math.round(percentile);

  // Handle ordinal suffix
  const suffix = getOrdinalSuffix(rounded);

  return `${rounded}${suffix} percentile`;
}

/**
 * Get ordinal suffix for a number
 */
function getOrdinalSuffix(n: number): string {
  const s = ['th', 'st', 'nd', 'rd'];
  const v = n % 100;
  return s[(v - 20) % 10] || s[v] || s[0];
}

/**
 * Calculate percentile rank within a group
 */
export function calculatePercentileRank(
  value: number,
  values: number[]
): number {
  if (values.length === 0) return 50;

  const sorted = [...values].sort((a, b) => a - b);
  const index = sorted.findIndex((v) => v >= value);

  if (index === -1) return 100;
  if (index === 0) return 0;

  return (index / sorted.length) * 100;
}

/**
 * Get comparison text for percentile
 */
export function getComparisonText(percentile: number): string {
  if (percentile >= 99) {
    return 'better than 99% of the population';
  }
  if (percentile >= 90) {
    return `better than ${Math.round(percentile)}% of the population`;
  }
  if (percentile >= 50) {
    return `above average, better than ${Math.round(percentile)}% of the population`;
  }
  if (percentile >= 25) {
    return `below average, at the ${Math.round(percentile)}th percentile`;
  }
  return `at the ${Math.round(percentile)}th percentile`;
}
