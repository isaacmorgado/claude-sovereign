import type { NamedSideLandmarks } from '../types/landmarks.js';
import type { SideProfileMeasurements, ProfileType, NasalDorsumShape } from '../types/measurements.js';
import { distance, angle, signedPerpendicularDistance, lineAngle, slope } from '../utils/geometry.js';
import { PROFILE_TYPE_THRESHOLDS } from '../constants/idealValues.js';

/**
 * Calculate all side profile measurements from named landmarks
 */
export function calculateSideProfileMeasurements(
  landmarks: NamedSideLandmarks
): SideProfileMeasurements {
  const facialConvexity = calculateFacialConvexity(landmarks);

  return {
    // Angles
    nasofrontalAngle: calculateNasofrontalAngle(landmarks),
    nasofacialAngle: calculateNasofacialAngle(landmarks),
    nasolabialAngle: calculateNasolabialAngle(landmarks),
    nasomentaAngle: calculateNasomentaAngle(landmarks),
    mentocervicalAngle: calculateMentocervicalAngle(landmarks),
    gonialAngle: calculateGonialAngle(landmarks),

    // Profile Analysis
    profileType: classifyProfileType(facialConvexity),
    facialConvexity,

    // Nose Profile
    nasalDorsumShape: classifyNasalDorsumShape(landmarks),
    nasalProjection: calculateNasalProjection(landmarks),
    nasalTipRotation: calculateNasalTipRotation(landmarks),
    columellaLobularRatio: calculateColumellaLobularRatio(landmarks),

    // Lip Analysis
    lipProjection: calculateLipProjection(landmarks),
    upperLipAngle: calculateUpperLipAngle(landmarks),
    lowerLipAngle: calculateLowerLipAngle(landmarks),

    // Chin Analysis
    chinProjection: calculateChinProjection(landmarks),
    chinHeight: calculateChinHeight(landmarks),

    // Jaw Analysis
    mandibularPlaneAngle: calculateMandibularPlaneAngle(landmarks),
    ramalHeight: calculateRamalHeight(landmarks),
  };
}

/**
 * Calculate nasofrontal angle (forehead to nose bridge)
 */
export function calculateNasofrontalAngle(landmarks: NamedSideLandmarks): number {
  // Angle between glabella, nasion (or sellion), and nose bridge
  return angle(landmarks.glabella, landmarks.nasion, landmarks.pronasale);
}

/**
 * Calculate nasofacial angle (nose projection angle from face)
 */
export function calculateNasofacialAngle(landmarks: NamedSideLandmarks): number {
  // Angle between vertical face plane and nose dorsum
  const faceVertical = { x: landmarks.glabella.x, y: landmarks.glabella.y + 100 };
  return angle(faceVertical, landmarks.glabella, landmarks.pronasale);
}

/**
 * Calculate nasolabial angle (nose to upper lip angle)
 * Ideal: 90-110 degrees (male: ~95, female: ~105)
 */
export function calculateNasolabialAngle(landmarks: NamedSideLandmarks): number {
  // Angle at subnasale between columella and upper lip
  return angle(landmarks.columella, landmarks.subnasale, landmarks.labraleSuperius);
}

/**
 * Calculate nasomenta angle (nose tip to chin angle)
 */
export function calculateNasomentaAngle(landmarks: NamedSideLandmarks): number {
  return angle(landmarks.nasion, landmarks.pronasale, landmarks.pogonion);
}

/**
 * Calculate mentocervical angle (chin to neck angle)
 */
export function calculateMentocervicalAngle(landmarks: NamedSideLandmarks): number {
  // Approximate neck point as below and behind chin
  const neckPoint = {
    x: landmarks.menton.x - 30,
    y: landmarks.menton.y + 50,
  };
  return angle(landmarks.pogonion, landmarks.menton, neckPoint);
}

/**
 * Calculate gonial angle (jaw angle)
 * Ideal: 120-130 degrees
 */
export function calculateGonialAngle(landmarks: NamedSideLandmarks): number {
  // Angle at gonion between condylion and menton
  return angle(landmarks.condylion, landmarks.gonion, landmarks.menton);
}

/**
 * Calculate facial convexity angle
 * Glabella - Subnasale - Pogonion angle
 */
export function calculateFacialConvexity(landmarks: NamedSideLandmarks): number {
  return angle(landmarks.glabella, landmarks.subnasale, landmarks.pogonion);
}

/**
 * Classify profile type based on facial convexity
 */
export function classifyProfileType(facialConvexity: number): ProfileType {
  if (facialConvexity < PROFILE_TYPE_THRESHOLDS.straight.min) {
    return 'convex';
  } else if (facialConvexity > PROFILE_TYPE_THRESHOLDS.straight.max) {
    return 'concave';
  }
  return 'straight';
}

/**
 * Classify nasal dorsum shape
 */
export function classifyNasalDorsumShape(landmarks: NamedSideLandmarks): NasalDorsumShape {
  // Calculate deviation of nose bridge midpoint from nasion-pronasale line
  if (landmarks.noseBridge.length < 3) {
    return 'straight';
  }

  const midIdx = Math.floor(landmarks.noseBridge.length / 2);
  const midPoint = landmarks.noseBridge[midIdx];

  const deviation = signedPerpendicularDistance(
    midPoint,
    landmarks.nasion,
    landmarks.pronasale
  );

  // Positive deviation = bump (convex), negative = concave
  if (deviation > 3) {
    return 'convex';
  } else if (deviation < -3) {
    return 'concave';
  }
  return 'straight';
}

/**
 * Calculate nasal projection (Goode ratio)
 * Ratio of nose projection to nose length
 */
export function calculateNasalProjection(landmarks: NamedSideLandmarks): number {
  // Nose length (nasion to pronasale)
  const noseLength = distance(landmarks.nasion, landmarks.pronasale);

  // Nose projection (horizontal distance from alar base to tip)
  const projection = Math.abs(landmarks.pronasale.x - landmarks.subnasale.x);

  if (noseLength === 0) return 0;
  return projection / noseLength;
}

/**
 * Calculate nasal tip rotation angle
 */
export function calculateNasalTipRotation(landmarks: NamedSideLandmarks): number {
  // Angle of columella from horizontal
  const columellaAngle = lineAngle(landmarks.subnasale, landmarks.columella);

  // Adjust to standard rotation angle
  return 90 + columellaAngle;
}

/**
 * Calculate columella-lobular ratio
 */
export function calculateColumellaLobularRatio(landmarks: NamedSideLandmarks): number {
  // Columella length (visible columella)
  const columellaLength = distance(landmarks.subnasale, landmarks.columella);

  // Lobule height (approximate from nose tip contour)
  const lobuleHeight = Math.abs(landmarks.pronasale.y - landmarks.columella.y);

  if (lobuleHeight === 0) return 0;
  return columellaLength / lobuleHeight;
}

/**
 * Calculate lip projection relative to reference line
 */
export function calculateLipProjection(landmarks: NamedSideLandmarks): number {
  // Reference line from subnasale to pogonion (Ricketts E-line approximation)
  const lipMid = {
    x: (landmarks.labraleSuperius.x + landmarks.labraleInferius.x) / 2,
    y: (landmarks.labraleSuperius.y + landmarks.labraleInferius.y) / 2,
  };

  return signedPerpendicularDistance(
    lipMid,
    landmarks.subnasale,
    landmarks.pogonion
  );
}

/**
 * Calculate upper lip angle
 */
export function calculateUpperLipAngle(landmarks: NamedSideLandmarks): number {
  // Angle of upper lip from horizontal
  return lineAngle(landmarks.subnasale, landmarks.labraleSuperius);
}

/**
 * Calculate lower lip angle
 */
export function calculateLowerLipAngle(landmarks: NamedSideLandmarks): number {
  // Angle of lower lip to chin
  return lineAngle(landmarks.labraleInferius, landmarks.pogonion);
}

/**
 * Calculate chin projection relative to nose
 * Measured as horizontal distance from reference line
 */
export function calculateChinProjection(landmarks: NamedSideLandmarks): number {
  // Vertical reference line from subnasale
  return landmarks.pogonion.x - landmarks.subnasale.x;
}

/**
 * Calculate chin height
 */
export function calculateChinHeight(landmarks: NamedSideLandmarks): number {
  return distance(landmarks.stomion, landmarks.menton);
}

/**
 * Calculate mandibular plane angle
 */
export function calculateMandibularPlaneAngle(landmarks: NamedSideLandmarks): number {
  // Angle of mandibular plane from horizontal
  const mandibularSlope = slope(landmarks.gonion, landmarks.menton);
  return Math.atan(mandibularSlope) * (180 / Math.PI);
}

/**
 * Calculate ramal height (ramus height)
 */
export function calculateRamalHeight(landmarks: NamedSideLandmarks): number {
  return distance(landmarks.condylion, landmarks.gonion);
}

/**
 * Calculate nose length
 */
export function calculateNoseLength(landmarks: NamedSideLandmarks): number {
  return distance(landmarks.nasion, landmarks.pronasale);
}

/**
 * Calculate face height (trichion to menton)
 */
export function calculateFaceHeight(landmarks: NamedSideLandmarks): number {
  return distance(landmarks.trichion, landmarks.menton);
}

/**
 * Calculate lower face height (subnasale to menton)
 */
export function calculateLowerFaceHeight(landmarks: NamedSideLandmarks): number {
  return distance(landmarks.subnasale, landmarks.menton);
}

/**
 * Check if measurements are within normal ranges
 */
export function validateSideProfileMeasurements(
  measurements: SideProfileMeasurements
): { valid: boolean; warnings: string[] } {
  const warnings: string[] = [];

  // Check for extreme values that might indicate measurement errors
  if (measurements.nasolabialAngle < 60 || measurements.nasolabialAngle > 150) {
    warnings.push(`Nasolabial angle (${measurements.nasolabialAngle.toFixed(1)}°) is outside expected range`);
  }

  if (measurements.gonialAngle < 90 || measurements.gonialAngle > 160) {
    warnings.push(`Gonial angle (${measurements.gonialAngle.toFixed(1)}°) is outside expected range`);
  }

  if (measurements.facialConvexity < 140 || measurements.facialConvexity > 190) {
    warnings.push(`Facial convexity (${measurements.facialConvexity.toFixed(1)}°) is outside expected range`);
  }

  return {
    valid: warnings.length === 0,
    warnings,
  };
}
