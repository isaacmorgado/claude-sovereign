/**
 * Example: Analyze facial measurements from landmark data
 *
 * This example demonstrates how to use the FacialAnalyzer class
 * to analyze side profile landmarks and generate measurements and scores.
 */

import { FacialAnalyzer, ReportGenerator } from '../src/index.js';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

// Get current directory for ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Load sample landmark data
const sampleDataPath = join(__dirname, '../tests/testData/sampleLandmarks.json');
const sampleData = JSON.parse(readFileSync(sampleDataPath, 'utf-8'));

async function main() {
  console.log('=== Facial Analysis Engine Demo ===\n');

  // Create analyzer with male gender
  const analyzer = new FacialAnalyzer({ gender: 'male' });

  // Load side profile landmarks
  console.log('Loading side profile landmarks...');
  analyzer.setSideLandmarks(sampleData.sideLandmarks);
  console.log(`Loaded ${sampleData.sideLandmarks.length} landmarks\n`);

  // Calculate side profile measurements
  console.log('Calculating measurements...');
  const measurements = analyzer.calculateSideMeasurements();

  if (measurements) {
    console.log('\n--- Side Profile Measurements ---');
    console.log(`Nasolabial Angle: ${measurements.nasolabialAngle.toFixed(2)}°`);
    console.log(`Gonial Angle: ${measurements.gonialAngle.toFixed(2)}°`);
    console.log(`Facial Convexity: ${measurements.facialConvexity.toFixed(2)}°`);
    console.log(`Profile Type: ${measurements.profileType}`);
    console.log(`Nasal Projection (Goode): ${measurements.nasalProjection.toFixed(3)}`);
    console.log(`Nasal Dorsum Shape: ${measurements.nasalDorsumShape}`);
    console.log(`Chin Projection: ${measurements.chinProjection.toFixed(2)} px`);
  }

  // Calculate scores
  console.log('\n--- Calculating Scores ---');
  const scores = analyzer.calculateScores();

  console.log(`\nHarmony Score: ${scores.harmonyScore.toFixed(1)}/100`);

  if (scores.nasolabialAngle) {
    console.log(`\nNasolabial Angle:`);
    console.log(`  Value: ${scores.nasolabialAngle.value.toFixed(2)}°`);
    console.log(`  Score: ${scores.nasolabialAngle.score.toFixed(1)}/100`);
    console.log(`  Rating: ${scores.nasolabialAngle.rating}`);
    console.log(`  Ideal: ${scores.nasolabialAngle.idealValue}°`);
  }

  if (scores.gonialAngle) {
    console.log(`\nGonial Angle:`);
    console.log(`  Value: ${scores.gonialAngle.value.toFixed(2)}°`);
    console.log(`  Score: ${scores.gonialAngle.score.toFixed(1)}/100`);
    console.log(`  Rating: ${scores.gonialAngle.rating}`);
    console.log(`  Ideal: ${scores.gonialAngle.idealValue}°`);
  }

  // Calculate percentiles
  console.log('\n--- Population Comparison ---');
  const percentiles = analyzer.calculatePercentiles();
  console.log(`Overall Percentile: ${percentiles.overall.toFixed(1)}%`);

  for (const [key, value] of Object.entries(percentiles.byMeasurement)) {
    console.log(`  ${key}: ${value.toFixed(1)}%`);
  }

  // Get bell curve data for visualization
  console.log('\n--- Bell Curve Data (Harmony Score) ---');
  const bellCurve = analyzer.getBellCurveData('harmonyScore');
  if (bellCurve) {
    console.log(`Your value: ${bellCurve.userValue.toFixed(1)}`);
    console.log(`Your percentile: ${bellCurve.userPercentile.toFixed(1)}%`);
    console.log(`Population mean: ${bellCurve.mean}`);
    console.log(`Standard deviation: ${bellCurve.standardDeviation}`);
  }

  // Generate recommendations
  console.log('\n--- Recommendations ---');
  const recommendations = analyzer.generateRecommendations();

  if (recommendations.length === 0) {
    console.log('No significant recommendations - measurements are within ideal ranges!');
  } else {
    for (const rec of recommendations) {
      const icon = rec.priority === 'high' ? '!' : rec.priority === 'medium' ? '*' : '-';
      console.log(`[${icon}] ${rec.measurement}: ${rec.description}`);
    }
  }

  // Compare male vs female analysis
  console.log('\n--- Gender Comparison ---');
  console.log('Male analysis:');
  console.log(`  Harmony Score: ${scores.harmonyScore.toFixed(1)}`);

  analyzer.setGender('female');
  const femaleScores = analyzer.calculateScores();
  console.log('\nFemale analysis (same landmarks):');
  console.log(`  Harmony Score: ${femaleScores.harmonyScore.toFixed(1)}`);

  console.log('\n=== Demo Complete ===');
}

main().catch(console.error);
