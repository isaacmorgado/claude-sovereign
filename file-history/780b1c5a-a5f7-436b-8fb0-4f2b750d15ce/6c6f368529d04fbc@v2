import type { MeasurementScores, MeasurementScore } from '../types/scoring.js';
import type { FrontFaceMeasurements, SideProfileMeasurements } from '../types/measurements.js';
import type { Gender } from '../types/landmarks.js';
import { getScoringConfig, createMeasurementScore } from './bellCurve.js';
import { calculatePercentile } from '../utils/statistics.js';
import { getPopulationStats } from '../constants/populationStats.js';
import { weightedAverage } from '../utils/statistics.js';

/**
 * Calculate all measurement scores from front face measurements
 */
export function calculateFrontFaceScores(
  measurements: FrontFaceMeasurements,
  gender: Gender
): Partial<MeasurementScores> {
  const scores: Partial<MeasurementScores> = {};

  // FWHR
  const fwhrConfig = getScoringConfig('fwhr', gender);
  if (fwhrConfig) {
    const fwhrStats = getPopulationStats('fwhr');
    const fwhrPercentile = fwhrStats
      ? calculatePercentile(measurements.fwhr, fwhrStats)
      : 50;
    scores.fwhr = createMeasurementScore(measurements.fwhr, fwhrConfig, fwhrPercentile);
  }

  // Canthal Tilt
  const canthalConfig = getScoringConfig('canthalTilt', gender);
  if (canthalConfig) {
    const canthalStats = getPopulationStats('canthalTilt');
    const canthalPercentile = canthalStats
      ? calculatePercentile(measurements.canthalTilt, canthalStats)
      : 50;
    scores.canthalTilt = createMeasurementScore(
      measurements.canthalTilt,
      canthalConfig,
      canthalPercentile
    );
  }

  // Facial Thirds (use average deviation from 33.33)
  const thirdsConfig = getScoringConfig('facialThirds', gender);
  if (thirdsConfig) {
    const avgThird =
      (measurements.upperThird + measurements.middleThird + measurements.lowerThird) / 3;
    scores.facialThirds = createMeasurementScore(avgThird, thirdsConfig, 50);
  }

  // Symmetry
  const symmetryConfig = getScoringConfig('symmetry', gender);
  if (symmetryConfig) {
    const symmetryStats = getPopulationStats('symmetry');
    const symmetryPercentile = symmetryStats
      ? calculatePercentile(measurements.overallSymmetry, symmetryStats)
      : 50;
    scores.symmetry = createMeasurementScore(
      measurements.overallSymmetry,
      symmetryConfig,
      symmetryPercentile
    );
  }

  // Golden Ratio
  const goldenConfig = getScoringConfig('goldenRatio', gender);
  if (goldenConfig) {
    const goldenStats = getPopulationStats('goldenRatioMatch');
    const goldenPercentile = goldenStats
      ? calculatePercentile(measurements.goldenRatioScores.overall, goldenStats)
      : 50;
    scores.goldenRatio = createMeasurementScore(
      measurements.goldenRatioScores.overall,
      goldenConfig,
      goldenPercentile
    );
  }

  // Nasal Index
  const nasalConfig = getScoringConfig('nasalIndex', gender);
  if (nasalConfig) {
    const nasalStats = getPopulationStats('nasalIndex');
    const nasalPercentile = nasalStats
      ? calculatePercentile(measurements.nasalIndex, nasalStats)
      : 50;
    scores.nasalIndex = createMeasurementScore(
      measurements.nasalIndex,
      nasalConfig,
      nasalPercentile
    );
  }

  // Lip Ratio
  const lipConfig = getScoringConfig('lipRatio', gender);
  if (lipConfig) {
    const lipStats = getPopulationStats('lipRatio');
    const lipPercentile = lipStats
      ? calculatePercentile(measurements.lipRatio, lipStats)
      : 50;
    scores.lipRatio = createMeasurementScore(
      measurements.lipRatio,
      lipConfig,
      lipPercentile
    );
  }

  return scores;
}

/**
 * Calculate all measurement scores from side profile measurements
 */
export function calculateSideProfileScores(
  measurements: SideProfileMeasurements,
  gender: Gender
): Partial<MeasurementScores> {
  const scores: Partial<MeasurementScores> = {};

  // Nasolabial Angle
  const nasolabialConfig = getScoringConfig('nasolabialAngle', gender);
  if (nasolabialConfig) {
    const nasolabialStats = getPopulationStats('nasolabialAngle');
    const nasolabialPercentile = nasolabialStats
      ? calculatePercentile(measurements.nasolabialAngle, nasolabialStats)
      : 50;
    scores.nasolabialAngle = createMeasurementScore(
      measurements.nasolabialAngle,
      nasolabialConfig,
      nasolabialPercentile
    );
  }

  // Gonial Angle
  const gonialConfig = getScoringConfig('gonialAngle', gender);
  if (gonialConfig) {
    const gonialStats = getPopulationStats('gonialAngle');
    const gonialPercentile = gonialStats
      ? calculatePercentile(measurements.gonialAngle, gonialStats)
      : 50;
    scores.gonialAngle = createMeasurementScore(
      measurements.gonialAngle,
      gonialConfig,
      gonialPercentile
    );
  }

  // Chin Projection
  const chinConfig = getScoringConfig('chinProjection', gender);
  if (chinConfig) {
    const chinStats = getPopulationStats('chinProjection');
    const chinPercentile = chinStats
      ? calculatePercentile(measurements.chinProjection, chinStats)
      : 50;
    scores.chinProjection = createMeasurementScore(
      measurements.chinProjection,
      chinConfig,
      chinPercentile
    );
  }

  // Nose Projection
  const noseConfig = getScoringConfig('noseProjection', gender);
  if (noseConfig) {
    const noseStats = getPopulationStats('noseProjection');
    const nosePercentile = noseStats
      ? calculatePercentile(measurements.nasalProjection, noseStats)
      : 50;
    scores.noseProjection = createMeasurementScore(
      measurements.nasalProjection,
      noseConfig,
      nosePercentile
    );
  }

  // Facial Convexity
  const convexityConfig = getScoringConfig('facialConvexity', gender);
  if (convexityConfig) {
    const convexityStats = getPopulationStats('facialConvexity');
    const convexityPercentile = convexityStats
      ? calculatePercentile(measurements.facialConvexity, convexityStats)
      : 50;
    scores.facialConvexity = createMeasurementScore(
      measurements.facialConvexity,
      convexityConfig,
      convexityPercentile
    );
  }

  return scores;
}

/**
 * Calculate overall harmony score from all measurement scores
 */
export function calculateHarmonyScore(
  scores: Partial<MeasurementScores>,
  gender: Gender
): number {
  const scoreValues: number[] = [];
  const weights: number[] = [];

  // Collect all scores and their weights
  const scoreEntries: [string, MeasurementScore | undefined][] = [
    ['fwhr', scores.fwhr],
    ['canthalTilt', scores.canthalTilt],
    ['facialThirds', scores.facialThirds],
    ['symmetry', scores.symmetry],
    ['goldenRatio', scores.goldenRatio],
    ['nasalIndex', scores.nasalIndex],
    ['lipRatio', scores.lipRatio],
    ['nasolabialAngle', scores.nasolabialAngle],
    ['gonialAngle', scores.gonialAngle],
    ['chinProjection', scores.chinProjection],
    ['noseProjection', scores.noseProjection],
    ['facialConvexity', scores.facialConvexity],
  ];

  for (const [key, score] of scoreEntries) {
    if (score) {
      const config = getScoringConfig(key, gender);
      if (config) {
        scoreValues.push(score.score);
        weights.push(config.weight);
      }
    }
  }

  if (scoreValues.length === 0) {
    return 0;
  }

  return weightedAverage(scoreValues, weights);
}

/**
 * Combine front and side scores
 */
export function combineScores(
  frontScores: Partial<MeasurementScores>,
  sideScores: Partial<MeasurementScores>,
  gender: Gender
): MeasurementScores {
  const combined: Partial<MeasurementScores> = {
    ...frontScores,
    ...sideScores,
  };

  const harmonyScore = calculateHarmonyScore(combined, gender);

  return {
    ...combined,
    harmonyScore,
  } as MeasurementScores;
}

/**
 * Get score breakdown by category
 */
export function getScoreBreakdown(scores: MeasurementScores): {
  facial: number;
  eyes: number;
  nose: number;
  lips: number;
  profile: number;
} {
  const getScoreValue = (score: MeasurementScore | undefined) => score?.score ?? 0;
  const getScoreCount = (score: MeasurementScore | undefined) => (score ? 1 : 0);

  // Facial proportions
  const facialScores = [scores.fwhr, scores.facialThirds, scores.symmetry, scores.goldenRatio];
  const facialSum = facialScores.reduce((sum, s) => sum + getScoreValue(s), 0);
  const facialCount = facialScores.reduce((sum, s) => sum + getScoreCount(s), 0);
  const facial = facialCount > 0 ? facialSum / facialCount : 0;

  // Eyes
  const eyesScores = [scores.canthalTilt];
  const eyesSum = eyesScores.reduce((sum, s) => sum + getScoreValue(s), 0);
  const eyesCount = eyesScores.reduce((sum, s) => sum + getScoreCount(s), 0);
  const eyes = eyesCount > 0 ? eyesSum / eyesCount : 0;

  // Nose
  const noseScores = [scores.nasalIndex, scores.noseProjection, scores.nasolabialAngle];
  const noseSum = noseScores.reduce((sum, s) => sum + getScoreValue(s), 0);
  const noseCount = noseScores.reduce((sum, s) => sum + getScoreCount(s), 0);
  const nose = noseCount > 0 ? noseSum / noseCount : 0;

  // Lips
  const lipsScores = [scores.lipRatio];
  const lipsSum = lipsScores.reduce((sum, s) => sum + getScoreValue(s), 0);
  const lipsCount = lipsScores.reduce((sum, s) => sum + getScoreCount(s), 0);
  const lips = lipsCount > 0 ? lipsSum / lipsCount : 0;

  // Profile
  const profileScores = [scores.gonialAngle, scores.chinProjection, scores.facialConvexity];
  const profileSum = profileScores.reduce((sum, s) => sum + getScoreValue(s), 0);
  const profileCount = profileScores.reduce((sum, s) => sum + getScoreCount(s), 0);
  const profile = profileCount > 0 ? profileSum / profileCount : 0;

  return { facial, eyes, nose, lips, profile };
}
