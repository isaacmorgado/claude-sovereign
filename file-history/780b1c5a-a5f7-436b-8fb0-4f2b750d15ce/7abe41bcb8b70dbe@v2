import { describe, it, expect } from 'vitest';
import {
  distance,
  angle,
  midpoint,
  normalCDF,
  bellCurveScore,
  calculatePercentile,
} from '../src/utils/index.js';
import {
  extractNamedSideLandmarks,
  validateLandmarks,
} from '../src/utils/imageProcessing.js';
import {
  calculateSideProfileMeasurements,
  calculateNasolabialAngle,
  calculateGonialAngle,
  calculateFacialConvexity,
} from '../src/measurements/sideProfile.js';
import { LANDMARK_COUNTS } from '../src/constants/landmarkIndices.js';
import sampleData from './testData/sampleLandmarks.json';

describe('Geometry Utilities', () => {
  it('should calculate distance between two points', () => {
    const p1 = { x: 0, y: 0 };
    const p2 = { x: 3, y: 4 };
    expect(distance(p1, p2)).toBe(5);
  });

  it('should calculate distance for same point', () => {
    const p = { x: 5, y: 5 };
    expect(distance(p, p)).toBe(0);
  });

  it('should calculate midpoint', () => {
    const p1 = { x: 0, y: 0 };
    const p2 = { x: 10, y: 10 };
    const mid = midpoint(p1, p2);
    expect(mid.x).toBe(5);
    expect(mid.y).toBe(5);
  });

  it('should calculate angle between three points', () => {
    const p1 = { x: 0, y: 0 };
    const vertex = { x: 5, y: 0 };
    const p2 = { x: 5, y: 5 };
    const ang = angle(p1, vertex, p2);
    expect(ang).toBeCloseTo(90, 1);
  });

  it('should calculate angle for straight line', () => {
    const p1 = { x: 0, y: 0 };
    const vertex = { x: 5, y: 0 };
    const p2 = { x: 10, y: 0 };
    const ang = angle(p1, vertex, p2);
    expect(ang).toBeCloseTo(180, 1);
  });
});

describe('Statistics Utilities', () => {
  it('should calculate normal CDF correctly', () => {
    // Z=0 should give 0.5
    expect(normalCDF(0)).toBeCloseTo(0.5, 2);
    // Z=1 should be approximately 0.8413
    expect(normalCDF(1)).toBeCloseTo(0.8413, 2);
    // Z=-1 should be approximately 0.1587
    expect(normalCDF(-1)).toBeCloseTo(0.1587, 2);
  });

  it('should calculate bell curve score correctly', () => {
    // At ideal value, score should be max
    const score = bellCurveScore(1.9, 1.9, 0.15, 0, 100);
    expect(score).toBe(100);
  });

  it('should calculate lower score for deviation from ideal', () => {
    const idealScore = bellCurveScore(1.9, 1.9, 0.15, 0, 100);
    const deviatedScore = bellCurveScore(2.1, 1.9, 0.15, 0, 100);
    expect(deviatedScore).toBeLessThan(idealScore);
  });

  it('should calculate percentile correctly', () => {
    const stats = { mean: 50, standardDeviation: 10, sampleSize: 1000 };
    // At mean, percentile should be 50
    expect(calculatePercentile(50, stats)).toBeCloseTo(50, 1);
    // Above mean, percentile should be > 50
    expect(calculatePercentile(60, stats)).toBeGreaterThan(50);
    // Below mean, percentile should be < 50
    expect(calculatePercentile(40, stats)).toBeLessThan(50);
  });
});

describe('Landmark Validation', () => {
  it('should validate correct side landmarks', () => {
    const result = validateLandmarks(
      sampleData.sideLandmarks,
      LANDMARK_COUNTS.SIDE_PROFILE
    );
    expect(result.valid).toBe(true);
  });

  it('should reject wrong landmark count', () => {
    const result = validateLandmarks(
      sampleData.sideLandmarks.slice(0, 50),
      LANDMARK_COUNTS.SIDE_PROFILE
    );
    expect(result.valid).toBe(false);
  });

  it('should reject invalid landmark structure', () => {
    const invalidLandmarks = [{ x: 1, y: 2 }, { x: 3 }] as any;
    const result = validateLandmarks(invalidLandmarks, 2);
    expect(result.valid).toBe(false);
  });
});

describe('Side Profile Measurements', () => {
  const namedLandmarks = extractNamedSideLandmarks(sampleData.sideLandmarks);

  it('should extract named landmarks', () => {
    expect(namedLandmarks.menton).toBeDefined();
    expect(namedLandmarks.nasion).toBeDefined();
    expect(namedLandmarks.pogonion).toBeDefined();
    expect(namedLandmarks.gonion).toBeDefined();
  });

  it('should calculate side profile measurements', () => {
    const measurements = calculateSideProfileMeasurements(namedLandmarks);

    expect(measurements).toBeDefined();
    expect(typeof measurements.nasolabialAngle).toBe('number');
    expect(typeof measurements.gonialAngle).toBe('number');
    expect(typeof measurements.facialConvexity).toBe('number');
    expect(typeof measurements.nasalProjection).toBe('number');
  });

  it('should calculate nasolabial angle in reasonable range', () => {
    const nasolabial = calculateNasolabialAngle(namedLandmarks);
    // Should be a valid angle (between 0 and 180 degrees)
    expect(nasolabial).toBeGreaterThan(0);
    expect(nasolabial).toBeLessThan(180);
  });

  it('should calculate gonial angle in reasonable range', () => {
    const gonial = calculateGonialAngle(namedLandmarks);
    // Should be a valid angle (between 0 and 180 degrees)
    expect(gonial).toBeGreaterThan(0);
    expect(gonial).toBeLessThan(180);
  });

  it('should classify profile type', () => {
    const measurements = calculateSideProfileMeasurements(namedLandmarks);
    expect(['straight', 'convex', 'concave']).toContain(measurements.profileType);
  });

  it('should calculate facial convexity', () => {
    const convexity = calculateFacialConvexity(namedLandmarks);
    // Should be a valid angle (between 0 and 180 degrees)
    expect(convexity).toBeGreaterThan(0);
    expect(convexity).toBeLessThan(180);
  });
});

describe('Measurement Consistency', () => {
  const namedLandmarks = extractNamedSideLandmarks(sampleData.sideLandmarks);
  const measurements = calculateSideProfileMeasurements(namedLandmarks);

  it('should produce consistent results', () => {
    const measurements2 = calculateSideProfileMeasurements(namedLandmarks);
    expect(measurements.nasolabialAngle).toBe(measurements2.nasolabialAngle);
    expect(measurements.gonialAngle).toBe(measurements2.gonialAngle);
    expect(measurements.facialConvexity).toBe(measurements2.facialConvexity);
  });

  it('should have valid nose projection ratio', () => {
    // Goode ratio should be between 0 and 1
    expect(measurements.nasalProjection).toBeGreaterThanOrEqual(0);
    expect(measurements.nasalProjection).toBeLessThanOrEqual(1);
  });
});
