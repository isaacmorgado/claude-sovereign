import type { ScoringConfig, MeasurementScore, ScoreRating, GenderScoringConfig } from '../types/scoring.js';
import type { Gender } from '../types/landmarks.js';
import { bellCurveScore } from '../utils/statistics.js';

/**
 * Scoring configurations for all measurements
 */
export const SCORING_CONFIGS: Record<string, GenderScoringConfig> = {
  fwhr: {
    male: {
      idealValue: 1.9,
      standardDeviation: 0.15,
      minScore: 0,
      maxScore: 100,
      weight: 0.12,
      name: 'FWHR',
      description: 'Facial Width-to-Height Ratio',
    },
    female: {
      idealValue: 1.75,
      standardDeviation: 0.15,
      minScore: 0,
      maxScore: 100,
      weight: 0.12,
      name: 'FWHR',
      description: 'Facial Width-to-Height Ratio',
    },
  },

  canthalTilt: {
    male: {
      idealValue: 4,
      standardDeviation: 3,
      minScore: 0,
      maxScore: 100,
      weight: 0.10,
      name: 'Canthal Tilt',
      description: 'Eye angle from horizontal',
    },
    female: {
      idealValue: 6,
      standardDeviation: 3,
      minScore: 0,
      maxScore: 100,
      weight: 0.10,
      name: 'Canthal Tilt',
      description: 'Eye angle from horizontal',
    },
  },

  facialThirds: {
    male: {
      idealValue: 33.33,
      standardDeviation: 3,
      minScore: 0,
      maxScore: 100,
      weight: 0.08,
      name: 'Facial Thirds',
      description: 'Balance of facial thirds',
    },
    female: {
      idealValue: 33.33,
      standardDeviation: 3,
      minScore: 0,
      maxScore: 100,
      weight: 0.08,
      name: 'Facial Thirds',
      description: 'Balance of facial thirds',
    },
  },

  symmetry: {
    male: {
      idealValue: 100,
      standardDeviation: 5,
      minScore: 0,
      maxScore: 100,
      weight: 0.15,
      name: 'Symmetry',
      description: 'Overall facial symmetry',
    },
    female: {
      idealValue: 100,
      standardDeviation: 5,
      minScore: 0,
      maxScore: 100,
      weight: 0.15,
      name: 'Symmetry',
      description: 'Overall facial symmetry',
    },
  },

  goldenRatio: {
    male: {
      idealValue: 100,
      standardDeviation: 15,
      minScore: 0,
      maxScore: 100,
      weight: 0.10,
      name: 'Golden Ratio',
      description: 'Match to golden ratio proportions',
    },
    female: {
      idealValue: 100,
      standardDeviation: 15,
      minScore: 0,
      maxScore: 100,
      weight: 0.10,
      name: 'Golden Ratio',
      description: 'Match to golden ratio proportions',
    },
  },

  nasalIndex: {
    male: {
      idealValue: 0.7,
      standardDeviation: 0.08,
      minScore: 0,
      maxScore: 100,
      weight: 0.05,
      name: 'Nasal Index',
      description: 'Nose width to height ratio',
    },
    female: {
      idealValue: 0.65,
      standardDeviation: 0.08,
      minScore: 0,
      maxScore: 100,
      weight: 0.05,
      name: 'Nasal Index',
      description: 'Nose width to height ratio',
    },
  },

  lipRatio: {
    male: {
      idealValue: 0.5,
      standardDeviation: 0.1,
      minScore: 0,
      maxScore: 100,
      weight: 0.05,
      name: 'Lip Ratio',
      description: 'Upper to lower lip ratio',
    },
    female: {
      idealValue: 0.5,
      standardDeviation: 0.1,
      minScore: 0,
      maxScore: 100,
      weight: 0.05,
      name: 'Lip Ratio',
      description: 'Upper to lower lip ratio',
    },
  },

  nasolabialAngle: {
    male: {
      idealValue: 95,
      standardDeviation: 8,
      minScore: 0,
      maxScore: 100,
      weight: 0.08,
      name: 'Nasolabial Angle',
      description: 'Nose to upper lip angle',
    },
    female: {
      idealValue: 105,
      standardDeviation: 8,
      minScore: 0,
      maxScore: 100,
      weight: 0.08,
      name: 'Nasolabial Angle',
      description: 'Nose to upper lip angle',
    },
  },

  gonialAngle: {
    male: {
      idealValue: 125,
      standardDeviation: 5,
      minScore: 0,
      maxScore: 100,
      weight: 0.08,
      name: 'Gonial Angle',
      description: 'Jaw angle definition',
    },
    female: {
      idealValue: 128,
      standardDeviation: 5,
      minScore: 0,
      maxScore: 100,
      weight: 0.08,
      name: 'Gonial Angle',
      description: 'Jaw angle definition',
    },
  },

  chinProjection: {
    male: {
      idealValue: 0,
      standardDeviation: 3,
      minScore: 0,
      maxScore: 100,
      weight: 0.06,
      name: 'Chin Projection',
      description: 'Chin position relative to face',
    },
    female: {
      idealValue: -2,
      standardDeviation: 3,
      minScore: 0,
      maxScore: 100,
      weight: 0.06,
      name: 'Chin Projection',
      description: 'Chin position relative to face',
    },
  },

  noseProjection: {
    male: {
      idealValue: 0.67,
      standardDeviation: 0.05,
      minScore: 0,
      maxScore: 100,
      weight: 0.06,
      name: 'Nose Projection',
      description: 'Goode ratio - nose projection',
    },
    female: {
      idealValue: 0.67,
      standardDeviation: 0.05,
      minScore: 0,
      maxScore: 100,
      weight: 0.06,
      name: 'Nose Projection',
      description: 'Goode ratio - nose projection',
    },
  },

  facialConvexity: {
    male: {
      idealValue: 170,
      standardDeviation: 5,
      minScore: 0,
      maxScore: 100,
      weight: 0.07,
      name: 'Facial Convexity',
      description: 'Profile straightness',
    },
    female: {
      idealValue: 168,
      standardDeviation: 5,
      minScore: 0,
      maxScore: 100,
      weight: 0.07,
      name: 'Facial Convexity',
      description: 'Profile straightness',
    },
  },
};

/**
 * Get scoring config for a measurement by gender
 */
export function getScoringConfig(
  measurement: string,
  gender: Gender
): ScoringConfig | null {
  const config = SCORING_CONFIGS[measurement];
  if (!config) return null;
  return config[gender];
}

/**
 * Calculate score for a single measurement using bell curve
 */
export function calculateMeasurementScore(
  value: number,
  config: ScoringConfig
): number {
  return bellCurveScore(
    value,
    config.idealValue,
    config.standardDeviation,
    config.minScore,
    config.maxScore
  );
}

/**
 * Get rating category from score
 */
export function getScoreRating(score: number): ScoreRating {
  if (score >= 90) return 'exceptional';
  if (score >= 80) return 'excellent';
  if (score >= 70) return 'good';
  if (score >= 50) return 'average';
  if (score >= 30) return 'below_average';
  return 'poor';
}

/**
 * Create full measurement score object
 */
export function createMeasurementScore(
  value: number,
  config: ScoringConfig,
  percentile: number
): MeasurementScore {
  const score = calculateMeasurementScore(value, config);
  const deviation = value - config.idealValue;

  return {
    name: config.name,
    value,
    score,
    idealValue: config.idealValue,
    deviation,
    percentile,
    rating: getScoreRating(score),
  };
}

/**
 * Calculate deviation description
 */
export function getDeviationDescription(
  value: number,
  idealValue: number,
  unit: string = ''
): string {
  const diff = value - idealValue;
  const absDiff = Math.abs(diff);

  if (absDiff < 0.01) {
    return 'ideal';
  }

  const direction = diff > 0 ? 'above' : 'below';
  return `${absDiff.toFixed(2)}${unit} ${direction} ideal`;
}

/**
 * Get scoring weight for a measurement
 */
export function getScoringWeight(measurement: string, gender: Gender): number {
  const config = getScoringConfig(measurement, gender);
  return config?.weight ?? 0;
}

/**
 * Get all available scoring metrics
 */
export function getAvailableScoringMetrics(): string[] {
  return Object.keys(SCORING_CONFIGS);
}
