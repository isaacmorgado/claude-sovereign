import { describe, it, expect } from 'vitest';
import {
  getScoringConfig,
  calculateMeasurementScore,
  getScoreRating,
  createMeasurementScore,
} from '../src/scoring/bellCurve.js';
import {
  calculateSideProfileScores,
  calculateHarmonyScore,
} from '../src/scoring/harmonyScore.js';
import {
  getPercentileDescription,
  formatPercentile,
} from '../src/scoring/percentile.js';
import { calculateSideProfileMeasurements } from '../src/measurements/sideProfile.js';
import { extractNamedSideLandmarks } from '../src/utils/imageProcessing.js';
import sampleData from './testData/sampleLandmarks.json';

describe('Scoring Configuration', () => {
  it('should get scoring config for male', () => {
    const config = getScoringConfig('fwhr', 'male');
    expect(config).toBeDefined();
    expect(config?.idealValue).toBe(1.9);
  });

  it('should get scoring config for female', () => {
    const config = getScoringConfig('fwhr', 'female');
    expect(config).toBeDefined();
    expect(config?.idealValue).toBe(1.75);
  });

  it('should return null for unknown measurement', () => {
    const config = getScoringConfig('unknown', 'male');
    expect(config).toBeNull();
  });

  it('should have different ideal values for different genders', () => {
    const maleConfig = getScoringConfig('nasolabialAngle', 'male');
    const femaleConfig = getScoringConfig('nasolabialAngle', 'female');
    expect(maleConfig?.idealValue).not.toBe(femaleConfig?.idealValue);
  });
});

describe('Score Calculation', () => {
  it('should give max score at ideal value', () => {
    const config = getScoringConfig('fwhr', 'male')!;
    const score = calculateMeasurementScore(1.9, config);
    expect(score).toBe(100);
  });

  it('should give lower score away from ideal', () => {
    const config = getScoringConfig('fwhr', 'male')!;
    const idealScore = calculateMeasurementScore(1.9, config);
    const awayScore = calculateMeasurementScore(2.2, config);
    expect(awayScore).toBeLessThan(idealScore);
  });

  it('should give symmetric scores for equal deviations', () => {
    const config = getScoringConfig('fwhr', 'male')!;
    const aboveScore = calculateMeasurementScore(2.05, config);
    const belowScore = calculateMeasurementScore(1.75, config);
    expect(Math.abs(aboveScore - belowScore)).toBeLessThan(1);
  });
});

describe('Score Rating', () => {
  it('should rate 90+ as exceptional', () => {
    expect(getScoreRating(95)).toBe('exceptional');
    expect(getScoreRating(90)).toBe('exceptional');
  });

  it('should rate 80-89 as excellent', () => {
    expect(getScoreRating(85)).toBe('excellent');
    expect(getScoreRating(80)).toBe('excellent');
  });

  it('should rate 70-79 as good', () => {
    expect(getScoreRating(75)).toBe('good');
    expect(getScoreRating(70)).toBe('good');
  });

  it('should rate 50-69 as average', () => {
    expect(getScoreRating(60)).toBe('average');
    expect(getScoreRating(50)).toBe('average');
  });

  it('should rate 30-49 as below_average', () => {
    expect(getScoreRating(40)).toBe('below_average');
    expect(getScoreRating(30)).toBe('below_average');
  });

  it('should rate below 30 as poor', () => {
    expect(getScoreRating(20)).toBe('poor');
    expect(getScoreRating(10)).toBe('poor');
  });
});

describe('Measurement Score Creation', () => {
  it('should create complete measurement score object', () => {
    const config = getScoringConfig('nasolabialAngle', 'male')!;
    const score = createMeasurementScore(95, config, 50);

    expect(score.name).toBe('Nasolabial Angle');
    expect(score.value).toBe(95);
    expect(score.idealValue).toBe(95);
    expect(score.percentile).toBe(50);
    expect(typeof score.score).toBe('number');
    expect(typeof score.rating).toBe('string');
  });

  it('should calculate correct deviation', () => {
    const config = getScoringConfig('nasolabialAngle', 'male')!;
    const score = createMeasurementScore(100, config, 50);
    expect(score.deviation).toBe(5); // 100 - 95 = 5
  });
});

describe('Side Profile Scores', () => {
  const namedLandmarks = extractNamedSideLandmarks(sampleData.sideLandmarks);
  const measurements = calculateSideProfileMeasurements(namedLandmarks);

  it('should calculate side profile scores', () => {
    const scores = calculateSideProfileScores(measurements, 'male');

    expect(scores).toBeDefined();
    // Should have at least some scores
    const hasScores = scores.nasolabialAngle || scores.gonialAngle || scores.facialConvexity;
    expect(hasScores).toBeTruthy();
  });

  it('should calculate different scores for different genders', () => {
    const maleScores = calculateSideProfileScores(measurements, 'male');
    const femaleScores = calculateSideProfileScores(measurements, 'female');

    // Nasolabial angle should score differently due to different ideals
    if (maleScores.nasolabialAngle && femaleScores.nasolabialAngle) {
      // They might be the same by chance, but ideals are different
      expect(maleScores.nasolabialAngle.idealValue).not.toBe(femaleScores.nasolabialAngle.idealValue);
    }
  });
});

describe('Harmony Score', () => {
  const namedLandmarks = extractNamedSideLandmarks(sampleData.sideLandmarks);
  const measurements = calculateSideProfileMeasurements(namedLandmarks);
  const scores = calculateSideProfileScores(measurements, 'male');

  it('should calculate harmony score', () => {
    const harmony = calculateHarmonyScore(scores, 'male');
    expect(typeof harmony).toBe('number');
    expect(harmony).toBeGreaterThanOrEqual(0);
    expect(harmony).toBeLessThanOrEqual(100);
  });

  it('should return 0 for empty scores', () => {
    const harmony = calculateHarmonyScore({}, 'male');
    expect(harmony).toBe(0);
  });
});

describe('Percentile Formatting', () => {
  it('should format percentile with ordinal suffix', () => {
    expect(formatPercentile(1)).toBe('1st percentile');
    expect(formatPercentile(2)).toBe('2nd percentile');
    expect(formatPercentile(3)).toBe('3rd percentile');
    expect(formatPercentile(4)).toBe('4th percentile');
    expect(formatPercentile(21)).toBe('21st percentile');
    expect(formatPercentile(22)).toBe('22nd percentile');
    expect(formatPercentile(23)).toBe('23rd percentile');
  });

  it('should describe percentiles correctly', () => {
    expect(getPercentileDescription(99)).toBe('Top 1%');
    expect(getPercentileDescription(95)).toBe('Top 5%');
    expect(getPercentileDescription(90)).toBe('Top 10%');
    expect(getPercentileDescription(50)).toBe('Average');
    expect(getPercentileDescription(10)).toBe('Bottom 20%');
    expect(getPercentileDescription(3)).toBe('Bottom 5%');
  });
});
