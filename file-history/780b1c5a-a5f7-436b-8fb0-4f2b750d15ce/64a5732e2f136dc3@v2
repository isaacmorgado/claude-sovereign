import type {
  Point,
  Gender,
  AnalyzerOptions,
  NamedFrontLandmarks,
  NamedSideLandmarks,
} from '../types/landmarks.js';
import type {
  FrontFaceMeasurements,
  SideProfileMeasurements,
} from '../types/measurements.js';
import type {
  MeasurementScores,
  PercentileResults,
  BellCurveData,
  FullAnalysisReport,
  AnalysisRecommendation,
} from '../types/scoring.js';
import {
  extractNamedFrontLandmarks,
  extractNamedSideLandmarks,
  validateLandmarks,
} from '../utils/imageProcessing.js';
import { generateBellCurveData } from '../utils/statistics.js';
import { LANDMARK_COUNTS } from '../constants/landmarkIndices.js';
import { getPopulationStats, DEFAULT_POPULATION_STATS } from '../constants/populationStats.js';
import { getIdealValue } from '../constants/idealValues.js';
import { calculateFrontFaceMeasurements } from '../measurements/frontFace.js';
import { calculateSideProfileMeasurements } from '../measurements/sideProfile.js';
import {
  calculateFrontFaceScores,
  calculateSideProfileScores,
  combineScores,
} from '../scoring/harmonyScore.js';
import { getScoringConfig } from '../scoring/bellCurve.js';
import { calculateAllPercentiles } from '../scoring/percentile.js';

/**
 * Main facial analysis class
 */
export class FacialAnalyzer {
  private gender: Gender = 'male';
  private frontLandmarks: Point[] | null = null;
  private sideLandmarks: Point[] | null = null;
  private namedFrontLandmarks: NamedFrontLandmarks | null = null;
  private namedSideLandmarks: NamedSideLandmarks | null = null;

  private frontMeasurements: FrontFaceMeasurements | null = null;
  private sideMeasurements: SideProfileMeasurements | null = null;
  private scores: MeasurementScores | null = null;

  constructor(options?: AnalyzerOptions) {
    if (options?.gender) {
      this.gender = options.gender;
    }
  }

  /**
   * Set the gender for gender-specific ideal values
   */
  setGender(gender: Gender): void {
    this.gender = gender;
    // Recalculate scores if measurements exist
    if (this.frontMeasurements || this.sideMeasurements) {
      this.calculateScores();
    }
  }

  /**
   * Get current gender setting
   */
  getGender(): Gender {
    return this.gender;
  }

  /**
   * Set front face landmarks (MediaPipe 478 points)
   */
  setFrontLandmarks(landmarks: Point[]): void {
    const validation = validateLandmarks(landmarks, LANDMARK_COUNTS.FRONT_FACE_MEDIAPIPE);
    if (!validation.valid) {
      throw new Error(`Invalid front landmarks: ${validation.message}`);
    }

    this.frontLandmarks = landmarks;
    this.namedFrontLandmarks = extractNamedFrontLandmarks(landmarks);
    this.frontMeasurements = null;
    this.scores = null;
  }

  /**
   * Set side profile landmarks (106 points)
   */
  setSideLandmarks(landmarks: Point[]): void {
    const validation = validateLandmarks(landmarks, LANDMARK_COUNTS.SIDE_PROFILE);
    if (!validation.valid) {
      throw new Error(`Invalid side landmarks: ${validation.message}`);
    }

    this.sideLandmarks = landmarks;
    this.namedSideLandmarks = extractNamedSideLandmarks(landmarks);
    this.sideMeasurements = null;
    this.scores = null;
  }

  /**
   * Get the named front landmarks
   */
  getNamedFrontLandmarks(): NamedFrontLandmarks | null {
    return this.namedFrontLandmarks;
  }

  /**
   * Get the named side landmarks
   */
  getNamedSideLandmarks(): NamedSideLandmarks | null {
    return this.namedSideLandmarks;
  }

  /**
   * Calculate front face measurements
   */
  calculateFrontMeasurements(): FrontFaceMeasurements | null {
    if (!this.namedFrontLandmarks) {
      return null;
    }

    this.frontMeasurements = calculateFrontFaceMeasurements(this.namedFrontLandmarks);
    return this.frontMeasurements;
  }

  /**
   * Calculate side profile measurements
   */
  calculateSideMeasurements(): SideProfileMeasurements | null {
    if (!this.namedSideLandmarks) {
      return null;
    }

    this.sideMeasurements = calculateSideProfileMeasurements(this.namedSideLandmarks);
    return this.sideMeasurements;
  }

  /**
   * Calculate all measurements
   */
  calculateAllMeasurements(): {
    front: FrontFaceMeasurements | null;
    side: SideProfileMeasurements | null;
  } {
    return {
      front: this.calculateFrontMeasurements(),
      side: this.calculateSideMeasurements(),
    };
  }

  /**
   * Calculate scores for all measurements
   */
  calculateScores(): MeasurementScores {
    // Ensure measurements are calculated
    if (!this.frontMeasurements && this.namedFrontLandmarks) {
      this.calculateFrontMeasurements();
    }
    if (!this.sideMeasurements && this.namedSideLandmarks) {
      this.calculateSideMeasurements();
    }

    // Calculate front scores
    const frontScores = this.frontMeasurements
      ? calculateFrontFaceScores(this.frontMeasurements, this.gender)
      : {};

    // Calculate side scores
    const sideScores = this.sideMeasurements
      ? calculateSideProfileScores(this.sideMeasurements, this.gender)
      : {};

    // Combine scores
    this.scores = combineScores(frontScores, sideScores, this.gender);

    return this.scores;
  }

  /**
   * Calculate harmony score
   */
  calculateHarmonyScore(): number {
    if (!this.scores) {
      this.calculateScores();
    }
    return this.scores?.harmonyScore ?? 0;
  }

  /**
   * Calculate percentiles for population comparison
   */
  calculatePercentiles(): PercentileResults {
    if (!this.scores) {
      this.calculateScores();
    }
    return calculateAllPercentiles(this.scores!);
  }

  /**
   * Get bell curve data for a specific measurement
   */
  getBellCurveData(measurement: string): BellCurveData | null {
    // Get the measurement value
    let value: number | null = null;

    if (this.frontMeasurements) {
      const frontMeasurements = this.frontMeasurements as unknown as Record<string, unknown>;
      if (typeof frontMeasurements[measurement] === 'number') {
        value = frontMeasurements[measurement] as number;
      }
    }

    if (value === null && this.sideMeasurements) {
      const sideMeasurements = this.sideMeasurements as unknown as Record<string, unknown>;
      if (typeof sideMeasurements[measurement] === 'number') {
        value = sideMeasurements[measurement] as number;
      }
    }

    if (value === null) {
      return null;
    }

    // Get population stats and ideal value
    const stats = getPopulationStats(measurement) ?? DEFAULT_POPULATION_STATS;
    const idealRange = getIdealValue(measurement, this.gender);
    const idealValue = idealRange?.ideal ?? stats.mean;

    return generateBellCurveData(stats, value, idealValue);
  }

  /**
   * Generate recommendations based on analysis
   */
  generateRecommendations(): AnalysisRecommendation[] {
    const recommendations: AnalysisRecommendation[] = [];

    if (!this.scores) {
      this.calculateScores();
    }

    const scores = this.scores!;

    // Check each score and generate recommendations for low scores
    const checkScore = (
      scoreKey: keyof MeasurementScores,
      measurementKey: string,
      category: AnalysisRecommendation['category']
    ) => {
      const score = scores[scoreKey];
      if (score && typeof score !== 'number' && score.score < 70) {
        const config = getScoringConfig(measurementKey, this.gender);
        if (config) {
          recommendations.push({
            category,
            measurement: config.name,
            currentValue: score.value,
            idealValue: score.idealValue,
            deviation: score.deviation,
            description: `${config.name} (${score.value.toFixed(2)}) deviates from ideal (${score.idealValue.toFixed(2)})`,
            priority: score.score < 50 ? 'high' : score.score < 60 ? 'medium' : 'low',
          });
        }
      }
    };

    // Check front face scores
    checkScore('fwhr', 'fwhr', 'ratio');
    checkScore('canthalTilt', 'canthalTilt', 'angle');
    checkScore('symmetry', 'symmetry', 'symmetry');
    checkScore('goldenRatio', 'goldenRatio', 'proportion');
    checkScore('nasalIndex', 'nasalIndex', 'ratio');
    checkScore('lipRatio', 'lipRatio', 'ratio');

    // Check side profile scores
    checkScore('nasolabialAngle', 'nasolabialAngle', 'angle');
    checkScore('gonialAngle', 'gonialAngle', 'angle');
    checkScore('chinProjection', 'chinProjection', 'projection');
    checkScore('noseProjection', 'noseProjection', 'projection');
    checkScore('facialConvexity', 'facialConvexity', 'angle');

    // Sort by priority
    const priorityOrder = { high: 0, medium: 1, low: 2 };
    recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

    return recommendations;
  }

  /**
   * Perform full analysis and return complete report
   */
  analyze(): FullAnalysisReport {
    // Calculate all measurements
    this.calculateAllMeasurements();

    // Calculate scores
    const scores = this.calculateScores();

    // Calculate percentiles
    const percentiles = this.calculatePercentiles();

    // Generate bell curves for key measurements
    const bellCurves: Record<string, BellCurveData> = {};
    const bellCurveKeys = [
      'fwhr',
      'canthalTilt',
      'symmetry',
      'nasolabialAngle',
      'gonialAngle',
      'harmonyScore',
    ];

    for (const key of bellCurveKeys) {
      const data = this.getBellCurveData(key);
      if (data) {
        bellCurves[key] = data;
      }
    }

    // Add harmony score bell curve
    const harmonyStats = getPopulationStats('harmonyScore') ?? DEFAULT_POPULATION_STATS;
    bellCurves.harmonyScore = generateBellCurveData(
      harmonyStats,
      scores.harmonyScore,
      100
    );

    // Generate recommendations
    const recommendations = this.generateRecommendations();

    return {
      timestamp: new Date(),
      gender: this.gender,
      measurements: {
        front: this.frontMeasurements,
        side: this.sideMeasurements,
      },
      scores,
      harmonyScore: scores.harmonyScore,
      percentiles,
      bellCurves,
      recommendations,
    };
  }

  /**
   * Reset the analyzer
   */
  reset(): void {
    this.frontLandmarks = null;
    this.sideLandmarks = null;
    this.namedFrontLandmarks = null;
    this.namedSideLandmarks = null;
    this.frontMeasurements = null;
    this.sideMeasurements = null;
    this.scores = null;
  }

  /**
   * Check if front landmarks are set
   */
  hasFrontLandmarks(): boolean {
    return this.frontLandmarks !== null;
  }

  /**
   * Check if side landmarks are set
   */
  hasSideLandmarks(): boolean {
    return this.sideLandmarks !== null;
  }

  /**
   * Get raw front landmarks
   */
  getRawFrontLandmarks(): Point[] | null {
    return this.frontLandmarks;
  }

  /**
   * Get raw side landmarks
   */
  getRawSideLandmarks(): Point[] | null {
    return this.sideLandmarks;
  }

  /**
   * Get current front measurements (without recalculating)
   */
  getFrontMeasurements(): FrontFaceMeasurements | null {
    return this.frontMeasurements;
  }

  /**
   * Get current side measurements (without recalculating)
   */
  getSideMeasurements(): SideProfileMeasurements | null {
    return this.sideMeasurements;
  }

  /**
   * Get current scores (without recalculating)
   */
  getScores(): MeasurementScores | null {
    return this.scores;
  }
}
