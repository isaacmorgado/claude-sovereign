// Popup script for Web Snatcher extension

let currentMode = 'element';

// Initialize popup
document.addEventListener('DOMContentLoaded', async () => {
  // Load saved settings
  const settings = await chrome.storage.local.get([
    'mode',
    'includeJs',
    'inlineStyles',
    'downloadAssets'
  ]);

  currentMode = settings.mode || 'element';

  // Set toggle states
  document.getElementById('includeJs').checked = settings.includeJs !== false;
  document.getElementById('inlineStyles').checked = settings.inlineStyles !== false;
  document.getElementById('downloadAssets').checked = settings.downloadAssets !== false;

  // Set active mode button
  updateModeButtons();
  updateActionButton();
});

// Mode button handlers
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    currentMode = btn.dataset.mode;
    updateModeButtons();
    updateActionButton();
    saveSettings();
  });
});

function updateModeButtons() {
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === currentMode);
  });
}

function updateActionButton() {
  const actionText = document.getElementById('actionText');
  if (currentMode === 'element') {
    actionText.textContent = 'Start Element Selection';
  } else {
    actionText.textContent = 'Download Full Page';
  }
}

// Save settings on toggle change
document.querySelectorAll('.toggle input').forEach(toggle => {
  toggle.addEventListener('change', saveSettings);
});

async function saveSettings() {
  await chrome.storage.local.set({
    mode: currentMode,
    includeJs: document.getElementById('includeJs').checked,
    inlineStyles: document.getElementById('inlineStyles').checked,
    downloadAssets: document.getElementById('downloadAssets').checked
  });
}

// Main action button
document.getElementById('startBtn').addEventListener('click', async () => {
  const btn = document.getElementById('startBtn');
  const status = document.getElementById('status');

  btn.disabled = true;
  status.className = 'status';
  status.textContent = 'Working...';

  try {
    // Get current tab
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

    if (!tab.url.startsWith('http')) {
      throw new Error('Cannot capture this page type');
    }

    const settings = {
      mode: currentMode,
      includeJs: document.getElementById('includeJs').checked,
      inlineStyles: document.getElementById('inlineStyles').checked,
      downloadAssets: document.getElementById('downloadAssets').checked
    };

    if (currentMode === 'element') {
      // Send message to content script to start element selection
      await chrome.tabs.sendMessage(tab.id, {
        action: 'startElementSelection',
        settings
      });

      status.className = 'status success';
      status.textContent = 'Click an element to capture';

      // Close popup after short delay
      setTimeout(() => window.close(), 500);

    } else {
      // Full page capture
      status.textContent = 'Capturing full page...';

      const response = await chrome.tabs.sendMessage(tab.id, {
        action: 'captureFullPage',
        settings
      });

      if (response.success) {
        status.className = 'status success';
        status.textContent = `Captured! ${response.fileCount} files`;
      } else {
        throw new Error(response.error || 'Capture failed');
      }
    }

  } catch (error) {
    console.error('Capture error:', error);
    status.className = 'status error';
    status.textContent = error.message || 'Error occurred';
  }

  btn.disabled = false;
});

// Listen for messages from content script
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  const status = document.getElementById('status');

  if (message.type === 'captureComplete') {
    status.className = 'status success';
    status.textContent = message.message || 'Capture complete!';
  } else if (message.type === 'captureError') {
    status.className = 'status error';
    status.textContent = message.error || 'Capture failed';
  } else if (message.type === 'captureProgress') {
    status.textContent = message.message;
  }
});
