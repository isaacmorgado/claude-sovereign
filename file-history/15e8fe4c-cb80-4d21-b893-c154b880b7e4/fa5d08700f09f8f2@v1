# üö® URGENT: Danny's CEP Panel Fix

## ‚ö° The Problem

**Danny's CEP panel is trying to connect to LOCAL backend (`https://127.0.0.1:3847`) instead of PRODUCTION Railway backend!**

### Why This Happens

The CEP panel runs from `file://` protocol, and this code automatically detects that as "development mode":

```javascript
// File: splice-cep/panel/js/config.js:21-31
function getBackendUrl() {
    const isDev = window.location.protocol === 'file:' ||
                  window.location.hostname === 'localhost' ||
                  window.location.hostname === '127.0.0.1';

    return isDev ? SPLICE_CONFIG.BACKEND_DEV : SPLICE_CONFIG.BACKEND_PROD;
    //             ‚Üë Returns localhost!
}
```

**Result**: Panel tries to connect to `https://127.0.0.1:3847` which is NOT running ‚Üí "Connection Error: Check server is running"

---

## ‚úÖ Quick Fix (30 seconds)

Danny needs to force the CEP panel to use the PRODUCTION backend:

### Step 1: Enable CEP Debug Mode
```bash
# On Mac, run in Terminal:
defaults write com.adobe.CSXS.11 PlayerDebugMode 1

# Restart Premiere Pro
```

### Step 2: Open Debug Console
1. Restart Adobe Premiere Pro
2. Open Chrome browser
3. Go to: `http://localhost:8092`
4. Click on "SPLICE" panel to open debugger

### Step 3: Force Production Backend
In the debug console, paste and run:
```javascript
localStorage.setItem('spliceBackendUrl', 'https://splice-api-production.up.railway.app');
location.reload();
```

### Step 4: Test Login
Try logging in again with a license key. It should now connect to Railway production backend!

---

## üîß Permanent Fix (Update CEP Code)

To fix this for all users, update the CEP panel config:

**File**: `splice-cep/panel/js/config.js`

**Option A: Always Use Production (Recommended for Release)**
```javascript
// Line 21-31, change to:
function getBackendUrl() {
    // Priority 1: Custom URL override via localStorage
    const customUrl = localStorage.getItem('spliceBackendUrl');
    if (customUrl) return customUrl;

    // Priority 2: Always use production (unless overridden)
    return SPLICE_CONFIG.BACKEND_PROD;  // ‚Üê Changed from isDev logic
}
```

**Option B: Add Production Flag**
```javascript
// Add at top of config.js:
const USE_PRODUCTION_BACKEND = true;  // Set to false for local dev

function getBackendUrl() {
    const customUrl = localStorage.getItem('spliceBackendUrl');
    if (customUrl) return customUrl;

    if (USE_PRODUCTION_BACKEND) {
        return SPLICE_CONFIG.BACKEND_PROD;
    }

    const isDev = window.location.protocol === 'file:' ||
                  window.location.hostname === 'localhost' ||
                  window.location.hostname === '127.0.0.1';

    return isDev ? SPLICE_CONFIG.BACKEND_DEV : SPLICE_CONFIG.BACKEND_PROD;
}
```

---

## üß™ Verify the Fix

After applying the fix, verify it's working:

1. Open CEP panel debug console
2. Run:
   ```javascript
   console.log('Backend URL:', getBackendUrl());
   // Should output: "Backend URL: https://splice-api-production.up.railway.app"
   ```
3. Test license activation

---

## üìä Root Cause Summary

| Issue | Cause | Fix |
|-------|-------|-----|
| CEP panel can't reach backend | Panel runs from `file://` ‚Üí detects as dev mode ‚Üí uses `localhost:3847` | Force production URL via localStorage or update getBackendUrl() logic |
| Local backend not running | No backend at `127.0.0.1:3847` | N/A - use production backend instead |
| Error message misleading | Says "check if backend is running" but doesn't say WHICH backend | Add URL to error message for clarity |

---

## üéØ Next Steps

1. **For Danny (immediate)**: Use localStorage override (see Quick Fix above)
2. **For team (code fix)**: Update `getBackendUrl()` to default to production
3. **For future releases**: Consider environment variable or build flag to control backend URL
4. **For UX improvement**: Show which backend URL is being used in panel footer

---

*File created: 2026-01-11*
*Issue tracked in: FIX_DANNY_LOGIN_ISSUE.md*
