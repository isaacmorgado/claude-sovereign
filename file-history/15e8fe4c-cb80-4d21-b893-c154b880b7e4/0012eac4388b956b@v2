# Fix: Danny's "Connection Error: Check server is running" Issue

**Date**: 2026-01-11
**Issue**: CEP Plugin shows "Connection Error: Server is not responding. Check if backend is running" when Danny tries to login
**Status**: Backend is healthy ‚úÖ | Issue is client-side network/connectivity
**Plugin**: Adobe CEP Panel (Legacy)

---

## üîç Root Cause Analysis

**Source of Error**: Adobe CEP Panel (`splice-cep/panel/js/config.js:832-833`)

The error occurs when the CEP panel **cannot reach** the Railway backend at:
```
https://splice-api-production.up.railway.app/license/activate
```

**Error triggered by**:
- Timeout (>120 seconds) ‚Üí "Server is not responding"
- Network failure ‚Üí "Cannot reach [URL]. Check network/firewall"
- CORS error ‚Üí "CORS error"
- SSL error ‚Üí "SSL certificate error"

### Backend Health Status: ‚úÖ ALL GREEN

```bash
# All diagnostic tests PASS from our servers:
‚úì DNS resolution successful
‚úì Network connectivity working
‚úì HTTPS endpoint responding (HTTP 200)
‚úì SSL certificate valid
‚úì Backend health check: OK
‚úì License endpoint responding
‚úì Response time: 0.19s (well under 30s timeout)
‚úì CORS properly configured
```

**Conclusion**: The backend is working perfectly. Danny's connection issue is **client-side**.

---

## üõ†Ô∏è Fix Steps for Danny

### Step 1: Run Network Diagnostics

Danny should run this diagnostic script from his machine:

```bash
cd /Users/imorgado/SPLICE
./diagnose-connection.sh
```

This will test:
- DNS resolution
- Network connectivity
- SSL certificate validation
- Backend health endpoint
- License activation endpoint
- Response times
- CORS headers

**Expected Result**: If all tests pass, the issue is specific to the UXP plugin environment.

---

### Step 2: Check CEP Panel Console (Debug Mode)

1. Open **Adobe Premiere Pro** with SPLICE CEP panel loaded
2. **Enable CEP Debug Mode**:
   ```bash
   # On macOS:
   defaults write com.adobe.CSXS.11 PlayerDebugMode 1
   # Or for older versions:
   defaults write com.adobe.CSXS.10 PlayerDebugMode 1
   defaults write com.adobe.CSXS.9 PlayerDebugMode 1
   ```
3. **Restart Premiere Pro**
4. **Open Remote Debugger**:
   - Open Chrome/Edge browser
   - Navigate to: `http://localhost:8092` (or 8093, 8094 depending on CEP version)
   - Find SPLICE panel and click to inspect
5. **Try to login** and watch for errors in the console
6. Look for the diagnostic output starting with `[SPLICE DEBUG]`:
   - Error name and message
   - Backend URL being attempted
   - Fetch timeout setting
   - Full error object

**Take a screenshot** of the `[SPLICE DEBUG]` logs and send them to the team.

---

### Step 3: Try Local Backend (Temporary Testing)

To verify the CEP panel works with a local backend:

1. **Set local backend URL via localStorage**:
   - Open CEP panel debug console (see Step 2)
   - In console, run:
     ```javascript
     localStorage.setItem('spliceBackendUrl', 'https://127.0.0.1:3847');
     location.reload();
     ```
   - Alternatively, edit the config file:
     ```bash
     # File: splice-cep/panel/js/config.js, line 31
     # Change getBackendUrl() to always return BACKEND_DEV:
     return SPLICE_CONFIG.BACKEND_DEV;
     ```

2. **Start local backend**:
   ```bash
   cd splice-backend
   npm run dev
   ```

3. **Test login in plugin** - it should work with local backend

4. **If it works**: The issue is network/firewall blocking Railway
5. **If it still fails**: The issue is with the plugin's fetch implementation

**Don't forget to switch back to PROD after testing!**

---

### Step 4: Check for Network Blocks

Common causes of Railway blocking:

#### A. Corporate Firewall/Proxy
```bash
# Test if Railway is blocked
curl -I https://splice-api-production.up.railway.app/health

# If this fails, Danny's network is blocking Railway
```

**Solution**: Ask IT to whitelist `*.railway.app` domain

#### B. VPN/Security Software
- Try disabling VPN temporarily
- Check antivirus/firewall software (Norton, McAfee, Windows Defender)
- Add exception for Adobe apps to access Railway domains

#### C. DNS Issues
```bash
# Test DNS resolution
nslookup splice-api-production.up.railway.app

# Try using Google DNS
# System Preferences ‚Üí Network ‚Üí Advanced ‚Üí DNS
# Add: 8.8.8.8 and 8.8.4.4
```

#### D. SSL Certificate Trust
```bash
# Test SSL validation
openssl s_client -connect splice-api-production.up.railway.app:443

# If "Verify return code" is not 0, system doesn't trust Railway's cert
```

**Solution**: Update system certificates or add Railway's CA to trusted store

---

## üîß Additional Fixes Completed

### 1. ‚úÖ Fixed Vercel MCP Server Configuration
**File**: `.mcp.json`
**Change**: Moved `VERCEL_API_KEY` from `args` to `env` object

```json
{
  "vercel": {
    "command": "npx",
    "args": ["-y", "vercel-mcp"],
    "env": {
      "VERCEL_API_KEY": "vck_..."
    }
  }
}
```

### 2. ‚ö†Ô∏è Website Environment Variable Required

**Issue**: `splice-website` tries to connect to `https://api.spliceclips.com` (doesn't exist)
**Cause**: `BACKEND_API_URL` not set in Vercel production environment

**Fix**: Add environment variable in Vercel dashboard:

1. Go to: https://vercel.com/dashboard ‚Üí `splice-website` ‚Üí Settings ‚Üí Environment Variables
2. Add new variable:
   - **Name**: `BACKEND_API_URL`
   - **Value**: `https://splice-api-production.up.railway.app`
   - **Environments**: Production, Preview, Development
3. Redeploy: `vercel --prod`

**Affected Files** (all need this env var):
- `src/app/api/auth/login/route.ts`
- `src/app/api/auth/me/route.ts`
- `src/app/api/auth/logout/route.ts`
- `src/app/api/auth/refresh/route.ts`
- `src/app/api/usage/route.ts`
- `src/app/api/webhook/route.ts`
- `src/lib/csrf.ts`

---

## üî¨ Technical Details

### CEP Panel Timeout Configuration
```javascript
// File: splice-cep/panel/js/config.js:13
const SPLICE_CONFIG = {
    FETCH_TIMEOUT: 120000, // 2 minutes (120 seconds)
    RETRY_ATTEMPTS: 3,
    RETRY_DELAY: 1000
};

// CEP panel will wait up to 2 minutes before showing "Connection Error"
// This is 4x longer than UXP plugin (30s)
```

### Backend CORS Configuration
```javascript
// File: splice-backend/server.js:319-341
corsOptions: {
  origin: function (origin, callback) {
    // Allow requests with no origin (Adobe plugins, mobile apps)
    if (!origin) return callback(null, true);

    // Allow file:// and bolt:// protocols (Adobe CEP/UXP)
    if (origin.startsWith('file://') || origin.startsWith('bolt://')) {
      return callback(null, true);
    }

    // Whitelist check...
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', ...]
}
```

**CORS is correctly configured** to allow Adobe plugin requests with no origin.

### Backend URL Selection Logic (CEP)
```javascript
// File: splice-cep/panel/js/config.js:9-32
const SPLICE_CONFIG = {
    BACKEND_PROD: 'https://splice-api-production.up.railway.app',
    BACKEND_DEV: 'https://127.0.0.1:3847'
};

function getBackendUrl() {
    // Priority 1: Custom URL override via localStorage
    const customUrl = localStorage.getItem('spliceBackendUrl');
    if (customUrl) return customUrl;

    // Priority 2: Auto-detect based on environment
    const isDev = window.location.protocol === 'file:' ||
                  window.location.hostname === 'localhost' ||
                  window.location.hostname === '127.0.0.1';

    // Return appropriate URL
    return isDev ? SPLICE_CONFIG.BACKEND_DEV : SPLICE_CONFIG.BACKEND_PROD;
}

// Note: CEP panels run from file:// protocol, so will default to DEV
// unless localStorage override is set
```

**Important**: CEP panels running from `file://` protocol will default to `BACKEND_DEV` unless overridden!

---

## üìä Diagnostic Results Summary

| Test | Status | Details |
|------|--------|---------|
| DNS Resolution | ‚úÖ PASS | Resolves to 66.33.22.168 |
| Network Connectivity | ‚úÖ PASS | Can reach Railway servers |
| HTTPS Health Endpoint | ‚úÖ PASS | HTTP 200, healthy response |
| SSL Certificate | ‚úÖ PASS | Valid certificate |
| Backend Health Check | ‚úÖ PASS | All services OK (DB, Redis, Stripe, etc.) |
| License Endpoint | ‚úÖ PASS | Responds with expected validation error |
| Response Time | ‚úÖ PASS | 0.19s (excellent, well under 30s) |
| CORS Configuration | ‚úÖ PASS | Allows no-origin and plugin requests |

**Verdict**: Backend infrastructure is perfect. Issue is Danny's client environment.

---

## üêõ Most Likely Causes

Based on the evidence, in order of probability:

1. **Corporate Firewall/Proxy** (70% likely)
   - Railway domain blocked by IT security
   - Solution: Whitelist `*.railway.app`

2. **Adobe UXP Network Restrictions** (20% likely)
   - UXP may have stricter network policies than browser
   - Solution: Test with local backend to isolate

3. **SSL Certificate Rejection** (5% likely)
   - System doesn't trust Railway's CA
   - Solution: Update system certificates

4. **DNS Resolution Failure** (3% likely)
   - Can't resolve `splice-api-production.up.railway.app`
   - Solution: Use Google DNS (8.8.8.8)

5. **VPN/Security Software** (2% likely)
   - Antivirus blocking Adobe's network access
   - Solution: Temporarily disable to test

---

## üìû Next Steps

1. **Danny runs diagnostic script** ‚Üí Sends results to team
2. **Danny checks UXP console** ‚Üí Takes screenshot of errors
3. **Danny tests local backend** ‚Üí Confirms plugin functionality
4. **Team analyzes results** ‚Üí Determines specific blocker
5. **Apply targeted fix** ‚Üí Based on diagnostic findings

---

## üìù Prevention for Future

### For Plugin Users:
- Document required network access in user guide
- Add "Check your network" step in plugin error messages
- Consider fallback/retry logic with exponential backoff

### For Development:
- Add more detailed error messages in plugin (show actual URL being attempted)
- Implement connection health check on plugin startup
- Add "Test Connection" button in plugin settings

---

## ‚úÖ Quick Reference

**Backend URL**: https://splice-api-production.up.railway.app
**Health Endpoint**: https://splice-api-production.up.railway.app/health
**License Endpoint**: https://splice-api-production.up.railway.app/license/activate
**Timeout**: 120 seconds (2 minutes)
**CEP Config File**: `splice-cep/panel/js/config.js`
**Error Handler**: `splice-cep/panel/js/config.js:806-847`
**URL Selection**: `splice-cep/panel/js/config.js:21-32`

**Backend Status**: ‚úÖ Healthy
**Backend Response Time**: 0.19s
**Backend CORS**: ‚úÖ Configured for plugins

---

*Document generated: 2026-01-11*
*Run diagnostics: `./diagnose-connection.sh`*
