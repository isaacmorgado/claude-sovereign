#!/bin/bash
# SPLICE Backend Connection Diagnostics
# Run this script to diagnose Danny's "Connection Error: Check server is running" issue

echo "=================================================="
echo "SPLICE Backend Connection Diagnostics"
echo "=================================================="
echo ""

BACKEND_URL="https://splice-api-production.up.railway.app"

# Color codes for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Test 1: DNS Resolution
echo "1. Testing DNS Resolution..."
if host splice-api-production.up.railway.app > /dev/null 2>&1; then
    echo -e "${GREEN}✓ DNS resolution successful${NC}"
    host splice-api-production.up.railway.app
else
    echo -e "${RED}✗ DNS resolution failed${NC}"
    echo "  This could indicate a network or DNS server issue"
fi
echo ""

# Test 2: Network Connectivity
echo "2. Testing Network Connectivity (ping)..."
if ping -c 3 splice-api-production.up.railway.app > /dev/null 2>&1; then
    echo -e "${GREEN}✓ Can reach Railway servers${NC}"
else
    echo -e "${YELLOW}⚠ Ping failed (this is normal for some servers)${NC}"
fi
echo ""

# Test 3: HTTPS Connection
echo "3. Testing HTTPS Connection to Health Endpoint..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${BACKEND_URL}/health")
if [ "$HTTP_CODE" = "200" ]; then
    echo -e "${GREEN}✓ Backend is responding (HTTP $HTTP_CODE)${NC}"
else
    echo -e "${RED}✗ Backend returned HTTP $HTTP_CODE or timed out${NC}"
fi
echo ""

# Test 4: SSL Certificate
echo "4. Testing SSL Certificate..."
if openssl s_client -connect splice-api-production.up.railway.app:443 -servername splice-api-production.up.railway.app </dev/null 2>/dev/null | grep -q "Verify return code: 0"; then
    echo -e "${GREEN}✓ SSL certificate is valid${NC}"
else
    echo -e "${RED}✗ SSL certificate validation failed${NC}"
    echo "  This could cause UXP plugin to reject the connection"
fi
echo ""

# Test 5: Detailed Health Check Response
echo "5. Testing Health Endpoint Response..."
HEALTH_RESPONSE=$(curl -s --max-time 10 "${BACKEND_URL}/health")
if [ -n "$HEALTH_RESPONSE" ]; then
    echo -e "${GREEN}✓ Backend health response:${NC}"
    echo "$HEALTH_RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$HEALTH_RESPONSE"
else
    echo -e "${RED}✗ No response from health endpoint${NC}"
fi
echo ""

# Test 6: License Activation Endpoint
echo "6. Testing License Activation Endpoint..."
LICENSE_RESPONSE=$(curl -s --max-time 10 -X POST "${BACKEND_URL}/license/activate" \
    -H "Content-Type: application/json" \
    -d '{"key":"TEST-1234-5678-9012"}')
if echo "$LICENSE_RESPONSE" | grep -q "Invalid license key format\|error"; then
    echo -e "${GREEN}✓ License endpoint is responding${NC}"
    echo "  Response: $LICENSE_RESPONSE"
else
    echo -e "${RED}✗ License endpoint issue${NC}"
    echo "  Response: $LICENSE_RESPONSE"
fi
echo ""

# Test 7: Response Time
echo "7. Testing Response Time..."
TIME_TOTAL=$(curl -s -o /dev/null -w "%{time_total}" --max-time 30 "${BACKEND_URL}/health")
if [ -n "$TIME_TOTAL" ]; then
    echo "  Response time: ${TIME_TOTAL}s"
    if (( $(echo "$TIME_TOTAL > 5.0" | bc -l) )); then
        echo -e "${YELLOW}⚠ Slow response (>5s) - may cause plugin timeout${NC}"
    else
        echo -e "${GREEN}✓ Response time is good${NC}"
    fi
else
    echo -e "${RED}✗ Request timed out (>30s)${NC}"
fi
echo ""

# Test 8: CORS Headers
echo "8. Testing CORS Headers (for plugin requests)..."
CORS_HEADERS=$(curl -s -I -X OPTIONS "${BACKEND_URL}/license/activate" \
    -H "Origin: null" \
    -H "Access-Control-Request-Method: POST" \
    -H "Access-Control-Request-Headers: Content-Type")
if echo "$CORS_HEADERS" | grep -q "Access-Control-Allow"; then
    echo -e "${GREEN}✓ CORS headers present${NC}"
    echo "$CORS_HEADERS" | grep "Access-Control"
else
    echo -e "${YELLOW}⚠ No CORS headers detected${NC}"
    echo "  This might be okay if the backend allows all origins"
fi
echo ""

# Summary
echo "=================================================="
echo "Summary"
echo "=================================================="
echo ""
echo "If all tests pass but Danny still sees the error:"
echo "1. Check Adobe UXP plugin console for detailed errors"
echo "2. Try temporarily switching plugin to local backend"
echo "3. Check for corporate firewall/proxy blocking Railway"
echo "4. Verify system time is correct (for SSL validation)"
echo ""
echo "Backend URL: ${BACKEND_URL}"
echo "Plugin timeout: 30 seconds"
echo "Plugin config: splice-plugin/js/config.js"
echo ""
