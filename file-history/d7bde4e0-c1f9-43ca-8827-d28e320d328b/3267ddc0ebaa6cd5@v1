/**
 * Music Timeline E2E Tests
 * Tests for Feature 4: Mood Timeline (Per-chapter mood assignment with crossfade assembly)
 *
 * Phase 8.4 Features:
 * - Per-chapter mood assignment using chapter detection + scene analysis
 * - Parallel music generation for each chapter segment
 * - FFmpeg crossfade assembly between segments
 * - Final audio with smooth transitions matching video structure
 */

const assert = require('assert');

// Test counters
let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    passed++;
    console.log(`  ✓ ${name}`);
  } catch (err) {
    failed++;
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
  }
}

async function asyncTest(name, fn) {
  try {
    await fn();
    passed++;
    console.log(`  ✓ ${name}`);
  } catch (err) {
    failed++;
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
  }
}

// ============================================
// SECTION 1: musicTimeline.js Service Tests
// ============================================
console.log('\n=== Section 1: musicTimeline.js Service ===\n');

test('Service file exists and exports required functions', () => {
  const musicTimeline = require('../services/musicTimeline');
  assert(typeof musicTimeline.analyzeChapterMoods === 'function', 'analyzeChapterMoods should be a function');
  assert(typeof musicTimeline.generateChapterMusic === 'function', 'generateChapterMusic should be a function');
  assert(typeof musicTimeline.generateAllChapterMusic === 'function', 'generateAllChapterMusic should be a function');
  assert(typeof musicTimeline.assembleWithCrossfades === 'function', 'assembleWithCrossfades should be a function');
  assert(typeof musicTimeline.buildMultiCrossfadeFilter === 'function', 'buildMultiCrossfadeFilter should be a function');
  assert(typeof musicTimeline.generateTimelineMusic === 'function', 'generateTimelineMusic should be a function');
  assert(typeof musicTimeline.validateTimelineOptions === 'function', 'validateTimelineOptions should be a function');
  assert(typeof musicTimeline.getTimelinePresets === 'function', 'getTimelinePresets should be a function');
  assert(typeof musicTimeline.estimateGenerationTime === 'function', 'estimateGenerationTime should be a function');
});

test('Service exports constants', () => {
  const musicTimeline = require('../services/musicTimeline');
  assert(typeof musicTimeline.MOOD_MAPPING === 'object', 'MOOD_MAPPING should be an object');
  assert(typeof musicTimeline.DEFAULT_CROSSFADE_DURATION === 'number', 'DEFAULT_CROSSFADE_DURATION should be a number');
  assert(typeof musicTimeline.MIN_CROSSFADE_DURATION === 'number', 'MIN_CROSSFADE_DURATION should be a number');
  assert(typeof musicTimeline.MAX_CROSSFADE_DURATION === 'number', 'MAX_CROSSFADE_DURATION should be a number');
  assert(typeof musicTimeline.MIN_CHAPTER_MUSIC_DURATION === 'number', 'MIN_CHAPTER_MUSIC_DURATION should be a number');
  assert(typeof musicTimeline.MAX_CONCURRENT_GENERATIONS === 'number', 'MAX_CONCURRENT_GENERATIONS should be a number');
});

test('MOOD_MAPPING covers all scene analysis moods', () => {
  const musicTimeline = require('../services/musicTimeline');
  const expectedMoods = ['happy', 'sad', 'angry', 'fearful', 'surprised', 'neutral', 'excited', 'calm', 'tense', 'inspirational', 'humorous'];

  expectedMoods.forEach(mood => {
    assert(musicTimeline.MOOD_MAPPING[mood], `MOOD_MAPPING should have mapping for ${mood}`);
  });
});

test('MOOD_MAPPING maps to valid music generation moods', () => {
  const musicTimeline = require('../services/musicTimeline');
  const validMusicMoods = ['energetic', 'relaxed', 'melancholic', 'intense', 'happy', 'mysterious', 'epic', 'neutral'];

  Object.values(musicTimeline.MOOD_MAPPING).forEach(mappedMood => {
    assert(validMusicMoods.includes(mappedMood), `${mappedMood} should be a valid music generation mood`);
  });
});

test('Constants have reasonable values', () => {
  const musicTimeline = require('../services/musicTimeline');

  assert(musicTimeline.DEFAULT_CROSSFADE_DURATION >= 0.5, 'Default crossfade should be at least 0.5s');
  assert(musicTimeline.DEFAULT_CROSSFADE_DURATION <= 5, 'Default crossfade should be at most 5s');
  assert(musicTimeline.MIN_CROSSFADE_DURATION > 0, 'Min crossfade should be positive');
  assert(musicTimeline.MAX_CROSSFADE_DURATION > musicTimeline.MIN_CROSSFADE_DURATION, 'Max should be greater than min');
  assert(musicTimeline.MIN_CHAPTER_MUSIC_DURATION >= 10, 'Min chapter music should be at least 10s');
  assert(musicTimeline.MAX_CONCURRENT_GENERATIONS >= 1, 'Should allow at least 1 concurrent generation');
});

// ============================================
// SECTION 2: validateTimelineOptions Tests
// ============================================
console.log('\n=== Section 2: Validation Tests ===\n');

test('validateTimelineOptions accepts valid transcript', () => {
  const musicTimeline = require('../services/musicTimeline');

  const result = musicTimeline.validateTimelineOptions({
    text: 'Test transcript',
    segments: [{ start: 0, end: 10, text: 'Hello' }],
    duration: 300
  });

  assert(result.valid === true, 'Should be valid');
  assert(result.errors.length === 0, 'Should have no errors');
});

test('validateTimelineOptions rejects null transcript', () => {
  const musicTimeline = require('../services/musicTimeline');

  const result = musicTimeline.validateTimelineOptions(null);

  assert(result.valid === false, 'Should be invalid');
  assert(result.errors.includes('Transcript is required'), 'Should have transcript error');
});

test('validateTimelineOptions rejects transcript without text or segments', () => {
  const musicTimeline = require('../services/musicTimeline');

  const result = musicTimeline.validateTimelineOptions({ duration: 300 });

  assert(result.valid === false, 'Should be invalid');
  assert(result.errors.some(e => e.includes('text or segments')), 'Should mention text or segments');
});

test('validateTimelineOptions rejects transcript without duration', () => {
  const musicTimeline = require('../services/musicTimeline');

  const result = musicTimeline.validateTimelineOptions({
    text: 'Hello',
    duration: 0
  });

  assert(result.valid === false, 'Should be invalid');
  assert(result.errors.some(e => e.includes('duration')), 'Should mention duration');
});

test('validateTimelineOptions rejects invalid maxChapters', () => {
  const musicTimeline = require('../services/musicTimeline');

  const result = musicTimeline.validateTimelineOptions(
    { text: 'Hello', duration: 300 },
    { maxChapters: 50 }
  );

  assert(result.valid === false, 'Should be invalid');
  assert(result.errors.some(e => e.includes('maxChapters')), 'Should mention maxChapters');
});

test('validateTimelineOptions rejects invalid minChapterLength', () => {
  const musicTimeline = require('../services/musicTimeline');

  const result = musicTimeline.validateTimelineOptions(
    { text: 'Hello', duration: 300 },
    { minChapterLength: 10 }  // Too short
  );

  assert(result.valid === false, 'Should be invalid');
  assert(result.errors.some(e => e.includes('minChapterLength')), 'Should mention minChapterLength');
});

test('validateTimelineOptions rejects invalid crossfadeDuration', () => {
  const musicTimeline = require('../services/musicTimeline');

  const result = musicTimeline.validateTimelineOptions(
    { text: 'Hello', duration: 300 },
    { crossfadeDuration: 0.1 }  // Too short
  );

  assert(result.valid === false, 'Should be invalid');
  assert(result.errors.some(e => e.includes('crossfadeDuration')), 'Should mention crossfadeDuration');
});

test('validateTimelineOptions accepts valid options', () => {
  const musicTimeline = require('../services/musicTimeline');

  const result = musicTimeline.validateTimelineOptions(
    { text: 'Hello', duration: 300 },
    { maxChapters: 5, minChapterLength: 60, crossfadeDuration: 2 }
  );

  assert(result.valid === true, 'Should be valid');
  assert(result.errors.length === 0, 'Should have no errors');
});

// ============================================
// SECTION 3: getTimelinePresets Tests
// ============================================
console.log('\n=== Section 3: Timeline Presets Tests ===\n');

test('getTimelinePresets returns expected structure', () => {
  const musicTimeline = require('../services/musicTimeline');

  const presets = musicTimeline.getTimelinePresets();

  assert(typeof presets === 'object', 'Should return object');
  assert(typeof presets.defaults === 'object', 'Should have defaults');
  assert(typeof presets.moodMapping === 'object', 'Should have moodMapping');
  assert(typeof presets.constraints === 'object', 'Should have constraints');
});

test('getTimelinePresets defaults include required fields', () => {
  const musicTimeline = require('../services/musicTimeline');

  const { defaults } = musicTimeline.getTimelinePresets();

  assert(typeof defaults.maxChapters === 'number', 'Should have maxChapters');
  assert(typeof defaults.minChapterLength === 'number', 'Should have minChapterLength');
  assert(typeof defaults.crossfadeDuration === 'number', 'Should have crossfadeDuration');
});

test('getTimelinePresets constraints include required fields', () => {
  const musicTimeline = require('../services/musicTimeline');

  const { constraints } = musicTimeline.getTimelinePresets();

  assert(typeof constraints.minCrossfadeDuration === 'number', 'Should have minCrossfadeDuration');
  assert(typeof constraints.maxCrossfadeDuration === 'number', 'Should have maxCrossfadeDuration');
  assert(typeof constraints.minChapterMusicDuration === 'number', 'Should have minChapterMusicDuration');
  assert(typeof constraints.maxConcurrentGenerations === 'number', 'Should have maxConcurrentGenerations');
});

test('getTimelinePresets defaults are within constraints', () => {
  const musicTimeline = require('../services/musicTimeline');

  const { defaults, constraints } = musicTimeline.getTimelinePresets();

  assert(defaults.crossfadeDuration >= constraints.minCrossfadeDuration, 'Default crossfade should be >= min');
  assert(defaults.crossfadeDuration <= constraints.maxCrossfadeDuration, 'Default crossfade should be <= max');
});

// ============================================
// SECTION 4: estimateGenerationTime Tests
// ============================================
console.log('\n=== Section 4: Time Estimation Tests ===\n');

test('estimateGenerationTime returns expected structure', () => {
  const musicTimeline = require('../services/musicTimeline');

  const estimate = musicTimeline.estimateGenerationTime({ duration: 300 });

  assert(typeof estimate === 'object', 'Should return object');
  assert(typeof estimate.estimatedChapters === 'number', 'Should have estimatedChapters');
  assert(typeof estimate.estimatedMinutes === 'number', 'Should have estimatedMinutes');
  assert(typeof estimate.estimatedTimeDisplay === 'string', 'Should have estimatedTimeDisplay');
});

test('estimateGenerationTime calculates chapters based on duration', () => {
  const musicTimeline = require('../services/musicTimeline');

  // 5 minute video with 60s min chapter = ~5 chapters
  const estimate = musicTimeline.estimateGenerationTime({ duration: 300 }, { minChapterLength: 60 });

  assert(estimate.estimatedChapters >= 1, 'Should estimate at least 1 chapter');
  assert(estimate.estimatedChapters <= 5, 'Should not exceed expected chapter count');
});

test('estimateGenerationTime respects maxChapters', () => {
  const musicTimeline = require('../services/musicTimeline');

  // 10 minute video but max 3 chapters
  const estimate = musicTimeline.estimateGenerationTime({ duration: 600 }, { maxChapters: 3, minChapterLength: 60 });

  assert(estimate.estimatedChapters <= 3, 'Should respect maxChapters limit');
});

test('estimateGenerationTime handles short videos', () => {
  const musicTimeline = require('../services/musicTimeline');

  // 30 second video
  const estimate = musicTimeline.estimateGenerationTime({ duration: 30 });

  assert(estimate.estimatedChapters >= 1, 'Should estimate at least 1 chapter');
});

test('estimateGenerationTime handles long videos', () => {
  const musicTimeline = require('../services/musicTimeline');

  // 1 hour video
  const estimate = musicTimeline.estimateGenerationTime({ duration: 3600 }, { maxChapters: 10 });

  assert(estimate.estimatedChapters <= 10, 'Should not exceed maxChapters');
  assert(estimate.estimatedMinutes > 0, 'Should have estimated time');
});

// ============================================
// SECTION 5: buildMultiCrossfadeFilter Tests
// ============================================
console.log('\n=== Section 5: FFmpeg Filter Tests ===\n');

test('buildMultiCrossfadeFilter handles 2 segments', () => {
  const musicTimeline = require('../services/musicTimeline');

  const filter = musicTimeline.buildMultiCrossfadeFilter(2, 2);

  assert(typeof filter === 'string', 'Should return string');
  assert(filter.includes('acrossfade'), 'Should use acrossfade');
  assert(filter.includes('[0:a]'), 'Should reference first input');
  assert(filter.includes('[1:a]'), 'Should reference second input');
});

test('buildMultiCrossfadeFilter handles 3 segments', () => {
  const musicTimeline = require('../services/musicTimeline');

  const filter = musicTimeline.buildMultiCrossfadeFilter(3, 2);

  assert(typeof filter === 'string', 'Should return string');
  assert(filter.includes('[0:a]'), 'Should reference first input');
  assert(filter.includes('[1:a]'), 'Should reference second input');
  assert(filter.includes('[2:a]'), 'Should reference third input');
  // Should chain crossfades
  assert(filter.includes(';'), 'Should chain multiple filters');
});

test('buildMultiCrossfadeFilter handles 4+ segments', () => {
  const musicTimeline = require('../services/musicTimeline');

  const filter = musicTimeline.buildMultiCrossfadeFilter(4, 2);

  assert(typeof filter === 'string', 'Should return string');
  assert(filter.includes('[0:a]'), 'Should reference first input');
  assert(filter.includes('[3:a]'), 'Should reference fourth input');
  // Should have multiple semicolons for chaining
  assert((filter.match(/;/g) || []).length >= 2, 'Should chain 3 crossfades');
});

test('buildMultiCrossfadeFilter uses specified crossfade duration', () => {
  const musicTimeline = require('../services/musicTimeline');

  const filter = musicTimeline.buildMultiCrossfadeFilter(2, 3.5);

  assert(filter.includes('d=3.5'), 'Should use specified duration');
});

test('buildMultiCrossfadeFilter uses triangular crossfade', () => {
  const musicTimeline = require('../services/musicTimeline');

  const filter = musicTimeline.buildMultiCrossfadeFilter(2, 2);

  assert(filter.includes('c1=tri'), 'Should use triangular fade for input 1');
  assert(filter.includes('c2=tri'), 'Should use triangular fade for input 2');
});

// ============================================
// SECTION 6: Server Endpoint Tests
// ============================================
console.log('\n=== Section 6: Server Endpoint Tests ===\n');

test('server.js imports musicTimeline service', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  assert(serverContent.includes('musicTimeline'), 'Should import musicTimeline');
  assert(serverContent.includes("require('./services/musicTimeline')"), 'Should require musicTimeline service');
});

test('POST /music/generate-timeline endpoint exists', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  assert(serverContent.includes("app.post('/music/generate-timeline'"), 'Should have POST /music/generate-timeline endpoint');
});

test('GET /music/timeline-options endpoint exists', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  assert(serverContent.includes("app.get('/music/timeline-options'"), 'Should have GET /music/timeline-options endpoint');
});

test('POST /music/timeline-estimate endpoint exists', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  assert(serverContent.includes("app.post('/music/timeline-estimate'"), 'Should have POST /music/timeline-estimate endpoint');
});

test('Timeline endpoint has requireCredits middleware', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  // Check that the main endpoint has auth
  const endpointMatch = serverContent.match(/app\.post\('\/music\/generate-timeline'.*requireCredits/s);
  assert(endpointMatch, 'generate-timeline should require credits');
});

test('Timeline endpoint validates transcript', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  assert(serverContent.includes("'transcript is required'") || serverContent.includes('"transcript is required"'),
    'Should validate transcript presence');
});

test('Timeline endpoint has error handling', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  assert(serverContent.includes('Timeline generation error') || serverContent.includes('Timeline] Generation error'),
    'Should have error handling');
});

test('Timeline endpoint logs usage', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  assert(serverContent.includes('logMusicUsage'), 'Should log music usage');
});

// ============================================
// SECTION 7: Plugin UI Tests
// ============================================
console.log('\n=== Section 7: Plugin UI Tests ===\n');

test('music.js has timeline state', () => {
  const fs = require('fs');
  const musicJs = fs.readFileSync(__dirname + '/../../splice-plugin/js/music.js', 'utf8');

  assert(musicJs.includes('isGeneratingTimeline'), 'Should have isGeneratingTimeline state');
  assert(musicJs.includes('timelineOptions'), 'Should have timelineOptions state');
});

test('music.js has timeline API functions', () => {
  const fs = require('fs');
  const musicJs = fs.readFileSync(__dirname + '/../../splice-plugin/js/music.js', 'utf8');

  assert(musicJs.includes('generateTimelineRequest'), 'Should have generateTimelineRequest');
  assert(musicJs.includes('getTimelineOptions'), 'Should have getTimelineOptions');
  assert(musicJs.includes('estimateTimelineRequest'), 'Should have estimateTimelineRequest');
});

test('music.js has timeline UI functions', () => {
  const fs = require('fs');
  const musicJs = fs.readFileSync(__dirname + '/../../splice-plugin/js/music.js', 'utf8');

  assert(musicJs.includes('showTimelineModal'), 'Should have showTimelineModal');
  assert(musicJs.includes('hideTimelineModal'), 'Should have hideTimelineModal');
  assert(musicJs.includes('renderTimelineModal'), 'Should have renderTimelineModal');
  assert(musicJs.includes('handleTimelineConfirm'), 'Should have handleTimelineConfirm');
});

test('music.js has timeline progress functions', () => {
  const fs = require('fs');
  const musicJs = fs.readFileSync(__dirname + '/../../splice-plugin/js/music.js', 'utf8');

  assert(musicJs.includes('showTimelineProgressPanel'), 'Should have showTimelineProgressPanel');
  assert(musicJs.includes('hideTimelineProgressPanel'), 'Should have hideTimelineProgressPanel');
  assert(musicJs.includes('showTimelineResult'), 'Should have showTimelineResult');
});

test('music.js exports timeline functions', () => {
  const fs = require('fs');
  const musicJs = fs.readFileSync(__dirname + '/../../splice-plugin/js/music.js', 'utf8');

  assert(musicJs.includes('generateTimelineRequest,'), 'Should export generateTimelineRequest');
  assert(musicJs.includes('showTimelineModal,'), 'Should export showTimelineModal');
  assert(musicJs.includes('importTimelineMusic,'), 'Should export importTimelineMusic');
});

test('music.js has timeline event listener setup', () => {
  const fs = require('fs');
  const musicJs = fs.readFileSync(__dirname + '/../../splice-plugin/js/music.js', 'utf8');

  assert(musicJs.includes('musicGenerateTimelineBtn'), 'Should reference timeline button');
  assert(musicJs.includes('updateTimelineAvailability'), 'Should update timeline availability');
});

// ============================================
// SECTION 8: Integration Tests
// ============================================
console.log('\n=== Section 8: Integration Tests ===\n');

test('musicTimeline uses chapterDetection service', () => {
  const fs = require('fs');
  const timelineContent = fs.readFileSync(__dirname + '/../services/musicTimeline.js', 'utf8');

  assert(timelineContent.includes("require('./chapterDetection')"), 'Should import chapterDetection');
  assert(timelineContent.includes('detectChapters'), 'Should use detectChapters');
});

test('musicTimeline uses sceneAnalysis service', () => {
  const fs = require('fs');
  const timelineContent = fs.readFileSync(__dirname + '/../services/musicTimeline.js', 'utf8');

  assert(timelineContent.includes("require('./sceneAnalysis')"), 'Should import sceneAnalysis');
  assert(timelineContent.includes('analyzeScenes'), 'Should use analyzeScenes');
});

test('musicTimeline uses musicGeneration service', () => {
  const fs = require('fs');
  const timelineContent = fs.readFileSync(__dirname + '/../services/musicTimeline.js', 'utf8');

  assert(timelineContent.includes("require('./musicGeneration')"), 'Should import musicGeneration');
  assert(timelineContent.includes('generateMusic'), 'Should use generateMusic');
});

test('musicTimeline uses musicAlignment service', () => {
  const fs = require('fs');
  const timelineContent = fs.readFileSync(__dirname + '/../services/musicTimeline.js', 'utf8');

  assert(timelineContent.includes("require('./musicAlignment')"), 'Should import musicAlignment');
  assert(timelineContent.includes('getAudioDuration'), 'Should use getAudioDuration');
});

// ============================================
// SECTION 9: Billing Tests
// ============================================
console.log('\n=== Section 9: Billing Tests ===\n');

test('Timeline has credit cost of 3', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  // Look for credit cost definition in the endpoint
  const creditCostMatch = serverContent.match(/creditCost\s*=\s*3/);
  assert(creditCostMatch, 'Timeline should cost 3 credits');
});

test('Timeline logs usage with type', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  assert(serverContent.includes("type: 'timeline'"), 'Should log with timeline type');
});

test('Timeline logs chapter count', () => {
  const fs = require('fs');
  const serverContent = fs.readFileSync(__dirname + '/../server.js', 'utf8');

  assert(serverContent.includes('chapterCount'), 'Should log chapter count');
});

// ============================================
// SECTION 10: Error Handling Tests
// ============================================
console.log('\n=== Section 10: Error Handling Tests ===\n');

test('analyzeChapterMoods handles empty segments gracefully', () => {
  const musicTimeline = require('../services/musicTimeline');

  // This tests the internal handling - we can't fully test without mocking
  // but we can verify the function exists and has proper structure
  assert(typeof musicTimeline.analyzeChapterMoods === 'function', 'Should have analyzeChapterMoods');
});

test('generateAllChapterMusic handles rate limiting', () => {
  const musicTimeline = require('../services/musicTimeline');

  // Verify MAX_CONCURRENT_GENERATIONS is set
  assert(musicTimeline.MAX_CONCURRENT_GENERATIONS >= 1, 'Should limit concurrent generations');
  assert(musicTimeline.MAX_CONCURRENT_GENERATIONS <= 5, 'Should not have too many concurrent');
});

test('assembleWithCrossfades handles single segment', () => {
  // This is tested via the structure - function should handle edge cases
  const fs = require('fs');
  const timelineContent = fs.readFileSync(__dirname + '/../services/musicTimeline.js', 'utf8');

  assert(timelineContent.includes('successfulSegments.length === 1'), 'Should handle single segment case');
});

test('Service handles FFmpeg errors gracefully', () => {
  const fs = require('fs');
  const timelineContent = fs.readFileSync(__dirname + '/../services/musicTimeline.js', 'utf8');

  assert(timelineContent.includes('finally'), 'Should have cleanup in finally block');
  assert(timelineContent.includes('fs.unlink'), 'Should cleanup temp files');
});

// ============================================
// SECTION 11: CLAUDE.md Documentation Tests
// ============================================
console.log('\n=== Section 11: Documentation Tests ===\n');

test('CLAUDE.md documents timeline endpoint', () => {
  const fs = require('fs');
  try {
    const claudeMd = fs.readFileSync(__dirname + '/../../CLAUDE.md', 'utf8');

    // Check for endpoint documentation
    assert(claudeMd.includes('/music/generate-timeline') || claudeMd.includes('generate-timeline'),
      'Should document timeline endpoint');
  } catch (e) {
    // CLAUDE.md might not exist in test environment
    console.log('    (CLAUDE.md not found, skipping documentation check)');
  }
});

// ============================================
// Test Summary
// ============================================
console.log('\n========================================');
console.log(`Music Timeline E2E Tests: ${passed} passed, ${failed} failed`);
console.log('========================================\n');

if (failed > 0) {
  process.exit(1);
}
