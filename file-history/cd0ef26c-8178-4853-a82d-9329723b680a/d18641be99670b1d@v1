#!/usr/bin/env python3
"""
RunPod Endpoint Control Script
Pause, resume, and check status of RunPod serverless endpoints from CLI

Usage:
    python runpod-control.py pause <endpoint_id>     # Pause endpoint (workers = 0)
    python runpod-control.py resume <endpoint_id>    # Resume endpoint
    python runpod-control.py status <endpoint_id>    # Check status
    python runpod-control.py pause-all               # Pause all endpoints
    python runpod-control.py resume-all              # Resume all endpoints
    python runpod-control.py list                    # List all endpoints
"""

import os
import sys
import requests
import json

# Configuration
RUNPOD_API_KEY = os.getenv("RUNPOD_API_KEY", "YOUR_RUNPOD_API_KEY")
GRAPHQL_ENDPOINT = "https://api.runpod.io/graphql"

# Your endpoint configurations
ENDPOINTS = {
    "architect": {
        "id": "YOUR_ENDPOINT_ID_1",
        "name": "DeepSeek-R1 Architect",
        "default_min": 0,
        "default_max": 3
    },
    "code": {
        "id": "YOUR_ENDPOINT_ID_2",
        "name": "Qwen3-Coder Writer",
        "default_min": 0,
        "default_max": 3
    },
    "research": {
        "id": "YOUR_ENDPOINT_ID_3",
        "name": "Qwen3-Next Research",
        "default_min": 0,
        "default_max": 3
    },
    "quick": {
        "id": "YOUR_ENDPOINT_ID_4",
        "name": "Qwen3-4B Quick",
        "default_min": 0,
        "default_max": 3
    }
}


def graphql_request(query, variables=None):
    """Make a GraphQL request to RunPod API"""
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {RUNPOD_API_KEY}"
    }

    payload = {"query": query}
    if variables:
        payload["variables"] = variables

    response = requests.post(GRAPHQL_ENDPOINT, headers=headers, json=payload)
    response.raise_for_status()
    return response.json()


def get_endpoint_status(endpoint_id):
    """Get current status of an endpoint"""
    query = """
    query GetEndpoint($endpointId: String!) {
        endpoint(endpointId: $endpointId) {
            id
            name
            workersMin
            workersMax
            workersStandby
            workersRunning
            workersIdle
        }
    }
    """

    try:
        result = graphql_request(query, {"endpointId": endpoint_id})
        if "errors" in result:
            print(f"‚ùå Error: {result['errors']}")
            return None
        return result["data"]["endpoint"]
    except Exception as e:
        print(f"‚ùå Error getting status: {e}")
        return None


def pause_endpoint(endpoint_id, name="Endpoint"):
    """Pause endpoint by setting workers to 0"""
    query = """
    mutation UpdateEndpoint($input: EndpointUpdateInput!) {
        updateEndpoint(input: $input) {
            id
            workersMin
            workersMax
        }
    }
    """

    variables = {
        "input": {
            "endpointId": endpoint_id,
            "workersMin": 0,
            "workersMax": 0
        }
    }

    try:
        print(f"‚è∏Ô∏è  Pausing {name}...")
        result = graphql_request(query, variables)
        if "errors" in result:
            print(f"‚ùå Error: {result['errors']}")
            return False
        print(f"‚úÖ {name} paused (workers: 0)")
        return True
    except Exception as e:
        print(f"‚ùå Error pausing endpoint: {e}")
        return False


def resume_endpoint(endpoint_id, name="Endpoint", workers_min=0, workers_max=3):
    """Resume endpoint by restoring worker counts"""
    query = """
    mutation UpdateEndpoint($input: EndpointUpdateInput!) {
        updateEndpoint(input: $input) {
            id
            workersMin
            workersMax
        }
    }
    """

    variables = {
        "input": {
            "endpointId": endpoint_id,
            "workersMin": workers_min,
            "workersMax": workers_max
        }
    }

    try:
        print(f"‚ñ∂Ô∏è  Resuming {name}...")
        result = graphql_request(query, variables)
        if "errors" in result:
            print(f"‚ùå Error: {result['errors']}")
            return False
        print(f"‚úÖ {name} resumed (workers: {workers_min}-{workers_max})")
        return True
    except Exception as e:
        print(f"‚ùå Error resuming endpoint: {e}")
        return False


def list_endpoints():
    """List all configured endpoints with their status"""
    print("\nüìã Configured Endpoints:")
    print("=" * 80)

    for key, config in ENDPOINTS.items():
        status = get_endpoint_status(config["id"])
        if status:
            running = status.get("workersRunning", 0)
            idle = status.get("workersIdle", 0)
            min_workers = status.get("workersMin", 0)
            max_workers = status.get("workersMax", 0)

            state = "üü¢ ACTIVE" if (running + idle) > 0 else "‚ö´ PAUSED"

            print(f"\n{key.upper():12} - {config['name']}")
            print(f"  ID: {config['id']}")
            print(f"  State: {state}")
            print(f"  Workers: {min_workers}-{max_workers} (Running: {running}, Idle: {idle})")
        else:
            print(f"\n{key.upper():12} - {config['name']}")
            print(f"  ‚ùå Error getting status")

    print("=" * 80)


def pause_all():
    """Pause all configured endpoints"""
    print("\n‚è∏Ô∏è  Pausing all endpoints...\n")
    for key, config in ENDPOINTS.items():
        pause_endpoint(config["id"], config["name"])
    print("\n‚úÖ All endpoints paused")


def resume_all():
    """Resume all configured endpoints"""
    print("\n‚ñ∂Ô∏è  Resuming all endpoints...\n")
    for key, config in ENDPOINTS.items():
        resume_endpoint(
            config["id"],
            config["name"],
            config["default_min"],
            config["default_max"]
        )
    print("\n‚úÖ All endpoints resumed")


def main():
    if len(sys.argv) < 2:
        print(__doc__)
        sys.exit(1)

    command = sys.argv[1].lower()

    if command == "list":
        list_endpoints()

    elif command == "pause-all":
        pause_all()

    elif command == "resume-all":
        resume_all()

    elif command == "status":
        if len(sys.argv) < 3:
            print("Usage: python runpod-control.py status <endpoint_key>")
            print(f"Available keys: {', '.join(ENDPOINTS.keys())}")
            sys.exit(1)

        key = sys.argv[2]
        if key in ENDPOINTS:
            config = ENDPOINTS[key]
            status = get_endpoint_status(config["id"])
            if status:
                print(json.dumps(status, indent=2))
        else:
            print(f"‚ùå Unknown endpoint: {key}")
            print(f"Available: {', '.join(ENDPOINTS.keys())}")

    elif command == "pause":
        if len(sys.argv) < 3:
            print("Usage: python runpod-control.py pause <endpoint_key>")
            print(f"Available keys: {', '.join(ENDPOINTS.keys())}")
            sys.exit(1)

        key = sys.argv[2]
        if key in ENDPOINTS:
            config = ENDPOINTS[key]
            pause_endpoint(config["id"], config["name"])
        else:
            print(f"‚ùå Unknown endpoint: {key}")

    elif command == "resume":
        if len(sys.argv) < 3:
            print("Usage: python runpod-control.py resume <endpoint_key>")
            print(f"Available keys: {', '.join(ENDPOINTS.keys())}")
            sys.exit(1)

        key = sys.argv[2]
        if key in ENDPOINTS:
            config = ENDPOINTS[key]
            resume_endpoint(
                config["id"],
                config["name"],
                config["default_min"],
                config["default_max"]
            )
        else:
            print(f"‚ùå Unknown endpoint: {key}")

    else:
        print(f"‚ùå Unknown command: {command}")
        print(__doc__)
        sys.exit(1)


if __name__ == "__main__":
    main()
