"""
Physique Analysis database model - stores body composition photos and analysis results
"""

import uuid
from datetime import datetime
from sqlalchemy import Column, String, DateTime, ForeignKey, Float, JSON
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship

from app.database import Base


class PhysiqueAnalysis(Base):
    __tablename__ = "physique_analyses"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False, unique=True)

    # Photo URLs (stored in S3)
    front_photo_url = Column(String, nullable=True)
    side_photo_url = Column(String, nullable=True)
    back_photo_url = Column(String, nullable=True)

    # Body Analysis Results (from Claude Vision)
    estimated_body_fat = Column(Float, nullable=True)  # 5-45%
    muscle_mass = Column(String, nullable=True)  # low|medium|medium-high|high|very-high
    frame_size = Column(String, nullable=True)  # small|medium|large|very-large
    shoulder_width = Column(String, nullable=True)  # narrow|average|broad|very-broad
    waist_definition = Column(String, nullable=True)  # undefined|slight|defined|very-defined
    posture = Column(String, nullable=True)  # poor|fair|good|excellent
    analysis_confidence = Column(Float, nullable=True)  # 0-1
    analysis_notes = Column(String, nullable=True)

    # Legacy field for backward compatibility
    muscle_level = Column(String, nullable=True)

    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    analyzed_at = Column(DateTime, nullable=True)

    # Relationships
    user = relationship("User", backref="physique_analysis")

    def __repr__(self):
        return f"<PhysiqueAnalysis user_id={self.user_id}>"


class VisionExtraction(Base):
    """Stores comprehensive vision extraction results for face photos"""
    __tablename__ = "vision_extractions"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False, unique=True)

    # Face Photo URLs
    front_face_url = Column(String, nullable=True)
    side_face_url = Column(String, nullable=True)

    # Skin Analysis
    skin_clarity = Column(Float, nullable=True)  # 0-10
    skin_tone = Column(String, nullable=True)  # pale|fair|medium|olive|tan|dark
    acne_level = Column(String, nullable=True)  # none|mild|moderate|severe
    acne_scarring = Column(String, nullable=True)  # none|mild|moderate|severe
    pore_visibility = Column(String, nullable=True)  # minimal|visible|prominent
    texture_issues = Column(JSON, nullable=True)  # list of issues

    # Hair Analysis
    hairline_nw = Column(Float, nullable=True)  # 0-7 Norwood scale
    hair_density = Column(String, nullable=True)  # thin|medium|thick
    hair_texture = Column(String, nullable=True)  # straight|wavy|curly|coily
    hair_color = Column(String, nullable=True)

    # Eye Analysis
    eye_color = Column(String, nullable=True)
    under_eye_darkness = Column(Float, nullable=True)  # 0-10
    under_eye_puffiness = Column(Float, nullable=True)  # 0-10

    # Facial Features
    hollow_cheeks = Column(Float, nullable=True)  # 0-10
    eyebrow_density = Column(String, nullable=True)  # sparse|medium|thick
    facial_hair_potential = Column(String, nullable=True)  # low|medium|high

    # Teeth
    teeth_color = Column(String, nullable=True)
    teeth_alignment = Column(String, nullable=True)
    teeth_visible = Column(String, nullable=True)

    # Confidence & Timestamps
    confidence = Column(Float, nullable=True)
    extracted_at = Column(DateTime, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationship
    user = relationship("User", backref="vision_extraction")

    def __repr__(self):
        return f"<VisionExtraction user_id={self.user_id}>"
