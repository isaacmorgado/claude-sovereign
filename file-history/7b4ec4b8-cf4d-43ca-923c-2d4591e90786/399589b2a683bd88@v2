'use client';

import React, { createContext, useContext, useState, ReactNode } from 'react';

export interface PhysiqueImage {
  file: File;
  preview: string;
}

export type PhysiqueAngle = 'front' | 'side' | 'back';

export interface PhysiqueAnalysisResult {
  bodyFatPercent: number;
  muscleLevel: 'low' | 'moderate' | 'high' | 'very_high';
  confidence: number;
  notes?: string;
}

interface PhysiqueContextType {
  frontPhoto: PhysiqueImage | null;
  sidePhoto: PhysiqueImage | null;
  backPhoto: PhysiqueImage | null;
  setFrontPhoto: (image: PhysiqueImage | null) => void;
  setSidePhoto: (image: PhysiqueImage | null) => void;
  setBackPhoto: (image: PhysiqueImage | null) => void;
  skipped: boolean;
  setSkipped: (skipped: boolean) => void;
  clearAll: () => void;
  hasAnyPhotos: boolean;
  // Analysis results
  physiqueAnalysis: PhysiqueAnalysisResult | null;
  setPhysiqueAnalysis: (result: PhysiqueAnalysisResult | null) => void;
  isAnalyzing: boolean;
  setIsAnalyzing: (analyzing: boolean) => void;
}

const PhysiqueContext = createContext<PhysiqueContextType | undefined>(undefined);

export function PhysiqueProvider({ children }: { children: ReactNode }) {
  const [frontPhoto, setFrontPhoto] = useState<PhysiqueImage | null>(null);
  const [sidePhoto, setSidePhoto] = useState<PhysiqueImage | null>(null);
  const [backPhoto, setBackPhoto] = useState<PhysiqueImage | null>(null);
  const [skipped, setSkipped] = useState<boolean>(false);
  const [physiqueAnalysis, setPhysiqueAnalysis] = useState<PhysiqueAnalysisResult | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState<boolean>(false);

  const clearAll = () => {
    if (frontPhoto?.preview) URL.revokeObjectURL(frontPhoto.preview);
    if (sidePhoto?.preview) URL.revokeObjectURL(sidePhoto.preview);
    if (backPhoto?.preview) URL.revokeObjectURL(backPhoto.preview);
    setFrontPhoto(null);
    setSidePhoto(null);
    setBackPhoto(null);
    setSkipped(false);
    setPhysiqueAnalysis(null);
    setIsAnalyzing(false);
  };

  const hasAnyPhotos = !!(frontPhoto || sidePhoto || backPhoto);

  return (
    <PhysiqueContext.Provider
      value={{
        frontPhoto,
        sidePhoto,
        backPhoto,
        setFrontPhoto,
        setSidePhoto,
        setBackPhoto,
        skipped,
        setSkipped,
        clearAll,
        hasAnyPhotos,
        physiqueAnalysis,
        setPhysiqueAnalysis,
        isAnalyzing,
        setIsAnalyzing,
      }}
    >
      {children}
    </PhysiqueContext.Provider>
  );
}

export function usePhysique() {
  const context = useContext(PhysiqueContext);
  if (context === undefined) {
    throw new Error('usePhysique must be used within a PhysiqueProvider');
  }
  return context;
}
