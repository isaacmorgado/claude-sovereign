#!/bin/bash
# Setup MCP Servers for Context Window Management
# Addresses small context windows in abliterated models (8K-32K tokens)

set -e

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Context Window Management Setup for Small Models"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "This will install MCP servers that help manage context efficiently:"
echo ""
echo "  1. Memory Keeper   - Persistent context storage"
echo "  2. Claude Context  - Semantic code search (40% token reduction)"
echo "  3. Context7        - Up-to-date library documentation"
echo ""
echo "Benefits:"
echo "  ✓ Works with 8K context models (Llama-3, WhiteRabbitNeo)"
echo "  ✓ Retrieve only relevant context on-demand"
echo "  ✓ Prevents context loss during compaction"
echo "  ✓ Reduces hallucination overhead"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Check if claude command exists
if ! command -v claude &> /dev/null; then
    echo "❌ Error: 'claude' command not found"
    echo "   Make sure Claude Code is installed"
    exit 1
fi

echo "Installing MCP servers..."
echo ""

# 1. Memory Keeper (Essential - no API keys needed)
echo "1/3 Installing Memory Keeper..."
if claude mcp add memory-keeper npx mcp-memory-keeper; then
    echo "   ✅ Memory Keeper installed"
else
    echo "   ⚠️  Memory Keeper installation failed (may already be installed)"
fi
echo ""

# 2. Claude Context (Requires API keys)
echo "2/3 Claude Context (requires API keys)..."
echo ""
echo "   This requires:"
echo "   - OpenAI API key: https://platform.openai.com/api-keys"
echo "   - Zilliz Cloud token: https://cloud.zilliz.com/ (free tier)"
echo ""
read -p "   Do you have these API keys? [y/N] " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    read -p "   Enter OpenAI API key: " OPENAI_KEY
    read -p "   Enter Zilliz token: " MILVUS_TOKEN

    if claude mcp add claude-context \
       -e OPENAI_API_KEY="$OPENAI_KEY" \
       -e MILVUS_TOKEN="$MILVUS_TOKEN" \
       -- npx @zilliz/claude-context-mcp@latest; then
        echo "   ✅ Claude Context installed"
    else
        echo "   ⚠️  Claude Context installation failed"
    fi
else
    echo "   ⏭️  Skipping Claude Context (you can add it later)"
    echo "   Run: claude mcp add claude-context -e OPENAI_API_KEY=... -e MILVUS_TOKEN=... -- npx @zilliz/claude-context-mcp@latest"
fi
echo ""

# 3. Context7 (Requires free API key)
echo "3/3 Context7 (requires free API key)..."
echo ""
echo "   Get free API key: https://context7.com/dashboard"
echo ""
read -p "   Do you have a Context7 API key? [y/N] " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    read -p "   Enter Context7 API key: " CONTEXT7_KEY

    if claude mcp add context7 -- npx -y @upstash/context7-mcp --api-key "$CONTEXT7_KEY"; then
        echo "   ✅ Context7 installed"
    else
        echo "   ⚠️  Context7 installation failed"
    fi
else
    echo "   ⏭️  Skipping Context7 (you can add it later)"
    echo "   Run: claude mcp add context7 -- npx -y @upstash/context7-mcp --api-key YOUR_KEY"
fi
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ Setup complete!"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Next steps:"
echo ""
echo "1. Verify installation:"
echo "   $ claude mcp list"
echo ""
echo "2. Start using with small context models:"
echo "   $ clauded"
echo "   /model featherless/failspy/Meta-Llama-3-8B-Instruct-abliterated-v3"
echo ""
echo "3. Save important context:"
echo "   mcp_context_save({key: 'auth', value: 'Using JWT', priority: 'high'})"
echo ""
echo "4. Index your codebase (if Claude Context installed):"
echo "   index_codebase()"
echo ""
echo "5. Search code efficiently:"
echo "   search_code(\"authentication functions\")"
echo ""
echo "6. Monitor context usage:"
echo "   /context"
echo ""
echo "Documentation:"
echo "  ~/.claude/CONTEXT_WINDOW_SOLUTIONS.md"
echo ""
echo "For models with 8K context, disable unused MCP servers:"
echo "  /mcp"
echo ""
