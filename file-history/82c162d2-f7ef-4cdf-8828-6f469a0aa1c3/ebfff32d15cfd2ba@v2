#!/bin/bash
# Verify clauded setup is correct

GREEN='\033[38;5;46m'
RED='\033[38;5;196m'
YELLOW='\033[38;5;226m'
CYAN='\033[38;5;51m'
RESET='\033[0m'

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ” Verifying clauded Setup"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check 1: Original CLI unchanged
echo -n "1. Checking original claude CLI is unchanged... "
if grep -q "GLM-4.7" /opt/homebrew/lib/node_modules/@anthropic-ai/claude-code/cli.js 2>/dev/null; then
    echo -e "${RED}âœ— FAIL${RESET} - Original CLI was modified!"
    exit 1
else
    echo -e "${GREEN}âœ“ PASS${RESET}"
fi

# Check 2: Patched CLI exists
echo -n "2. Checking patched clauded CLI exists... "
if [ -f "$HOME/.claude/clauded-cli/cli.js" ]; then
    echo -e "${GREEN}âœ“ PASS${RESET}"
else
    echo -e "${RED}âœ— FAIL${RESET} - Patched CLI not found!"
    exit 1
fi

# Check 3: Patched CLI has custom models
echo -n "3. Checking patched CLI has custom models... "
if grep -q "GLM-4.7" "$HOME/.claude/clauded-cli/cli.js" 2>/dev/null; then
    echo -e "${GREEN}âœ“ PASS${RESET}"
else
    echo -e "${RED}âœ— FAIL${RESET} - Custom models not found in patched CLI!"
    exit 1
fi

# Check 4: Backup exists
echo -n "4. Checking backup of patched CLI exists... "
if [ -f "$HOME/.claude/clauded-cli/cli.js.backup-before-model-patch" ]; then
    echo -e "${GREEN}âœ“ PASS${RESET}"
else
    echo -e "${YELLOW}âš  WARNING${RESET} - No backup found"
fi

# Check 5: Proxy server exists
echo -n "5. Checking proxy server exists... "
if [ -f "$HOME/.claude/model-proxy-server.js" ]; then
    echo -e "${GREEN}âœ“ PASS${RESET}"
else
    echo -e "${YELLOW}âš  WARNING${RESET} - Proxy server not found"
fi

# Check 6: Google OAuth tokens
echo -n "6. Checking Google OAuth tokens... "
if [ -f "$HOME/.claude/gemini-oauth.json" ]; then
    echo -e "${GREEN}âœ“ PASS${RESET}"
else
    echo -e "${YELLOW}âš  WARNING${RESET} - Google OAuth not configured"
fi

# Check 7: Featherless API key
echo -n "7. Checking Featherless API key... "
if [ ! -z "$FEATHERLESS_API_KEY" ]; then
    echo -e "${GREEN}âœ“ PASS${RESET}"
else
    echo -e "${YELLOW}âš  WARNING${RESET} - FEATHERLESS_API_KEY not set in environment"
fi

# Check 8: Custom commands
echo -n "8. Checking custom model commands... "
COMMAND_COUNT=$(ls -1 "$HOME/.claude/commands/"*.md 2>/dev/null | wc -l | tr -d ' ')
if [ "$COMMAND_COUNT" -gt "10" ]; then
    echo -e "${GREEN}âœ“ PASS${RESET} (${COMMAND_COUNT} commands)"
else
    echo -e "${YELLOW}âš  WARNING${RESET} - Only ${COMMAND_COUNT} commands found"
fi

# Check 9: clauded wrapper
echo -n "9. Checking clauded wrapper... "
if [ -f "/usr/local/bin/clauded" ]; then
    echo -e "${GREEN}âœ“ PASS${RESET}"
else
    echo -e "${YELLOW}âš  NEEDS INSTALLATION${RESET}"
    echo ""
    echo "   Run: bash ~/Desktop/Tools/INSTALL_CLAUDED.sh"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${GREEN}âœ… Verification Complete${RESET}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Files verified:"
echo "  âœ“ Original CLI: /opt/homebrew/.../cli.js (unchanged)"
echo "  âœ“ Patched CLI: ~/.claude/clauded-cli/cli.js (9 custom models)"
echo "  âœ“ Backup: ~/.claude/clauded-cli/cli.js.backup-before-model-patch"
echo ""

if [ -f "/usr/local/bin/clauded" ]; then
    echo "Next step: Start clauded and run /model"
    echo ""
    echo "  $ clauded"
    echo "  > /model"
    echo ""
else
    echo "Next step: Install clauded wrapper"
    echo ""
    echo "  $ bash ~/Desktop/Tools/INSTALL_CLAUDED.sh"
    echo ""
fi
