#!/usr/bin/env node
/**
 * Patch clauded-specific cli.js to inject custom models into the model picker
 * This ONLY affects clauded, not the regular claude command
 */

const fs = require('fs');
const path = require('path');
const os = require('os');

const CLI_PATH = path.join(os.homedir(), '.claude/clauded-cli/cli.js');
const BACKUP_PATH = CLI_PATH + '.backup-before-model-patch';

console.log('ğŸ”§ Patching clauded CLI to add custom models...\n');
console.log('Target: ' + CLI_PATH);
console.log('This will NOT affect regular claude command\n');

// Verify this is the clauded copy, not the original
if (CLI_PATH.includes('/opt/homebrew/')) {
    console.error('âŒ ERROR: Refusing to patch original Claude Code installation');
    console.error('This script should only patch ~/.claude/clauded-cli/cli.js');
    process.exit(1);
}

// Step 1: Backup original file
if (!fs.existsSync(BACKUP_PATH)) {
    console.log('Creating backup...');
    fs.copyFileSync(CLI_PATH, BACKUP_PATH);
    console.log('âœ“ Backup created at:', BACKUP_PATH);
} else {
    console.log('âœ“ Backup already exists');
}

// Step 2: Read cli.js
console.log('\nReading cli.js...');
let content = fs.readFileSync(CLI_PATH, 'utf8');
console.log(`âœ“ Read ${Math.round(content.length / 1024 / 1024)}MB`);

// Step 3: Find the model list array
console.log('\nğŸ” Searching for model definitions...');

// Pattern 1: Find where display names are defined
const displayNamePattern = /"Opus 4\.5"|"Sonnet 4\.5"|"Haiku 4\.5"/;
const match = content.match(displayNamePattern);

if (!match) {
    console.error('âŒ Could not find model display names in cli.js');
    console.error('The CLI structure may have changed. Manual patching required.');
    process.exit(1);
}

console.log('âœ“ Found model definitions at position:', match.index);

// Find the model constants
const opusPattern = /PqA\s*=\s*\{[^}]+claude-opus-4-5[^}]+\}/;
const sonnetPattern = /LT1\s*=\s*\{[^}]+claude-sonnet-4-5[^}]+\}/;

const opusMatch = content.match(opusPattern);
const sonnetMatch = content.match(sonnetPattern);

if (!opusMatch || !sonnetMatch) {
    console.error('âŒ Could not find model constant definitions');
    process.exit(1);
}

console.log('âœ“ Found model constants');

// Step 4: Inject custom model definitions after the existing ones
const customModelDefs = `
// Custom models injected by patch for clauded
,XqA={firstParty:"glm/glm-4.7",bedrock:"glm/glm-4.7",vertex:"glm/glm-4.7",foundry:"glm/glm-4.7"}
,YqA={firstParty:"glm/glm-4-flash",bedrock:"glm/glm-4-flash",vertex:"glm/glm-4-flash",foundry:"glm/glm-4-flash"}
,ZqA={firstParty:"google/gemini-3-pro",bedrock:"google/gemini-3-pro",vertex:"google/gemini-3-pro",foundry:"google/gemini-3-pro"}
,WqA={firstParty:"google/gemini-2.0-flash",bedrock:"google/gemini-2.0-flash",vertex:"google/gemini-2.0-flash",foundry:"google/gemini-2.0-flash"}
,VqA={firstParty:"featherless/dphn/Dolphin-Mistral-24B-Venice-Edition",bedrock:"featherless/dphn/Dolphin-Mistral-24B-Venice-Edition",vertex:"featherless/dphn/Dolphin-Mistral-24B-Venice-Edition",foundry:"featherless/dphn/Dolphin-Mistral-24B-Venice-Edition"}
,UqA={firstParty:"featherless/huihui-ai/Qwen2.5-72B-Instruct-abliterated",bedrock:"featherless/huihui-ai/Qwen2.5-72B-Instruct-abliterated",vertex:"featherless/huihui-ai/Qwen2.5-72B-Instruct-abliterated",foundry:"featherless/huihui-ai/Qwen2.5-72B-Instruct-abliterated"}
,TqA={firstParty:"featherless/WhiteRabbitNeo/Llama-3.1-WhiteRabbitNeo-2-70B",bedrock:"featherless/WhiteRabbitNeo/Llama-3.1-WhiteRabbitNeo-2-70B",vertex:"featherless/WhiteRabbitNeo/Llama-3.1-WhiteRabbitNeo-2-70B",foundry:"featherless/WhiteRabbitNeo/Llama-3.1-WhiteRabbitNeo-2-70B"}
,SqA={firstParty:"featherless/Llama-3-70B-Instruct-abliterated",bedrock:"featherless/Llama-3-70B-Instruct-abliterated",vertex:"featherless/Llama-3-70B-Instruct-abliterated",foundry:"featherless/Llama-3-70B-Instruct-abliterated"}
,RqA={firstParty:"featherless/Llama-3-8B-Instruct-abliterated",bedrock:"featherless/Llama-3-8B-Instruct-abliterated",vertex:"featherless/Llama-3-8B-Instruct-abliterated",foundry:"featherless/Llama-3-8B-Instruct-abliterated"}`;

// Insert after the last model constant (PqA for Opus 4.5)
const insertPosition = opusMatch.index + opusMatch[0].length;
content = content.slice(0, insertPosition) + customModelDefs + content.slice(insertPosition);

console.log('âœ“ Injected custom model definitions');

// Step 5: Find the itA() function that creates model structure
const itaPattern = /function itA\(A\)\{return\{([^}]+)\}\}/;
const itaMatch = content.match(itaPattern);

if (!itaMatch) {
    console.error('âŒ Could not find itA() function');
    process.exit(1);
}

// Add our models to the return object
const originalReturn = itaMatch[1];
const customModelsInReturn = `,glm47:XqA[A],glm4flash:YqA[A],geminipro:ZqA[A],gemini2flash:WqA[A],dolphin:VqA[A],qwen:UqA[A],whiterabbit:TqA[A],llama70b:SqA[A],llama8b:RqA[A]`;

content = content.replace(
    itaPattern,
    `function itA(A){return{${originalReturn}${customModelsInReturn}}}`
);

console.log('âœ“ Added custom models to itA() function');

// Step 6: Add display names to vzQ() function
const vzqDisplayNames = `
if(A.includes("glm/glm-4.7"))return"ğŸš€ GLM-4.7 (Orchestrator/Builder)";
if(A.includes("glm/glm-4-flash"))return"âš¡ GLM-4 Flash (Free)";
if(A.includes("google/gemini-3-pro"))return"ğŸ¨ Gemini 3 Pro (Frontend/Research)";
if(A.includes("google/gemini-2.0-flash"))return"âœ¨ Gemini 2.0 Flash";
if(A.includes("dphn/Dolphin"))return"ğŸ”“ Dolphin-3 (Security/RE)";
if(A.includes("Qwen2.5-72B-Instruct-abliterated"))return"ğŸ”“ Qwen 72B (Unrestricted)";
if(A.includes("WhiteRabbitNeo"))return"ğŸ° WhiteRabbitNeo 70B (Unrestricted)";
if(A.includes("Llama-3-70B-Instruct-abliterated"))return"ğŸ”“ Llama 70B (Uncensored)";
if(A.includes("Llama-3-8B-Instruct-abliterated"))return"ğŸ”“ Llama 8B (Uncensored)";`;

// Find the vzQ function and inject our display names at the beginning
const vzqPattern = /function vzQ\(A\)\{/;
content = content.replace(vzqPattern, `function vzQ(A){${vzqDisplayNames}`);

console.log('âœ“ Added display names for custom models');

// Step 7: Write patched file
console.log('\nğŸ’¾ Writing patched cli.js...');
fs.writeFileSync(CLI_PATH, content, 'utf8');
console.log('âœ“ Patch applied successfully!');

console.log('\nâœ… Custom models added to clauded model picker!');
console.log('\nAdded models:');
console.log('  - ğŸš€ GLM-4.7 (Orchestrator/Builder)');
console.log('  - âš¡ GLM-4 Flash (Free)');
console.log('  - ğŸ¨ Gemini 3 Pro (Frontend/Research)');
console.log('  - âœ¨ Gemini 2.0 Flash');
console.log('  - ğŸ”“ Dolphin-3 (Security/RE)');
console.log('  - ğŸ”“ Qwen 72B (Unrestricted)');
console.log('  - ğŸ° WhiteRabbitNeo 70B (Unrestricted)');
console.log('  - ğŸ”“ Llama 70B (Uncensored)');
console.log('  - ğŸ”“ Llama 8B (Uncensored)');
console.log('\nRestart clauded to see the new models in /model picker');
console.log('\nTo restore original: cp', BACKUP_PATH, CLI_PATH);
console.log('\nâš ï¸  IMPORTANT: Regular "claude" command is unchanged!');
