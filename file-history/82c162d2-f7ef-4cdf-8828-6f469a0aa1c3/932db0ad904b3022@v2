#!/bin/bash
# Claude Code Multi-Provider Proxy - Fixed Authentication
# Based on claudish approach: uses placeholder key

set -e

CLAUDE_DIR="${HOME}/.claude"
PROXY_SERVER="${CLAUDE_DIR}/model-proxy-server.js"
PROXY_PORT="${CLAUDISH_PORT:-3000}"
PROXY_PID_FILE="${CLAUDE_DIR}/.proxy.pid"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Claudish approach: Use placeholder to prevent auth dialog
# This allows Claude Code to start, but we route to other providers
PLACEHOLDER_KEY="sk-ant-api03-proxy-placeholder"

check_proxy_running() {
    if [ -f "$PROXY_PID_FILE" ]; then
        local pid=$(cat "$PROXY_PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            return 0
        else
            rm -f "$PROXY_PID_FILE"
            return 1
        fi
    fi
    return 1
}

start_proxy() {
    echo -e "${BLUE}Starting multi-provider proxy...${NC}"

    if ! [ -f "$PROXY_SERVER" ]; then
        echo -e "${RED}Error: Proxy server not found${NC}"
        exit 1
    fi

    node "$PROXY_SERVER" "$PROXY_PORT" > "${CLAUDE_DIR}/proxy.log" 2>&1 &
    local pid=$!
    echo "$pid" > "$PROXY_PID_FILE"

    sleep 2

    if ps -p $pid > /dev/null 2>&1; then
        echo -e "${GREEN}✓ Proxy started on port ${PROXY_PORT}${NC}"
        return 0
    else
        echo -e "${RED}✗ Proxy failed to start${NC}"
        cat "${CLAUDE_DIR}/proxy.log" | tail -20
        rm -f "$PROXY_PID_FILE"
        exit 1
    fi
}

stop_proxy() {
    if [ -f "$PROXY_PID_FILE" ]; then
        local pid=$(cat "$PROXY_PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            kill "$pid" 2>/dev/null || true
            sleep 1
            if ps -p "$pid" > /dev/null 2>&1; then
                kill -9 "$pid" 2>/dev/null || true
            fi
        fi
        rm -f "$PROXY_PID_FILE"
    fi
}

cleanup() {
    echo ""
    echo -e "${YELLOW}Stopping proxy...${NC}"
    stop_proxy
}

trap cleanup EXIT INT TERM

main() {
    echo ""
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║   Claude Code Multi-Provider Proxy                           ║${NC}"
    echo -e "${BLUE}║   GLM · Featherless · Google (Anthropic via separate key)    ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    # Check providers
    echo -e "${BLUE}Provider Status:${NC}"
    echo -e "  ${GREEN}✓${NC} GLM          - Ready"
    echo -e "  ${GREEN}✓${NC} Featherless - Ready"
    [ -n "$GOOGLE_API_KEY" ] && echo -e "  ${GREEN}✓${NC} Google       - Ready" || echo -e "  ${YELLOW}⚠${NC} Google       - Need GOOGLE_API_KEY"

    if [ -n "$ANTHROPIC_API_KEY" ] && [ "$ANTHROPIC_API_KEY" != "$PLACEHOLDER_KEY" ]; then
        echo -e "  ${GREEN}✓${NC} Anthropic    - Ready (your API key)"
    else
        echo -e "  ${YELLOW}⚠${NC} Anthropic    - Use your real API key or default Claude"
    fi
    echo ""

    # Note about Anthropic
    echo -e "${YELLOW}Note:${NC} For Anthropic models, you have two options:"
    echo -e "  1. Set ${GREEN}ANTHROPIC_API_KEY${NC} (your real API key)"
    echo -e "  2. Use Claude Code normally without proxy for Anthropic"
    echo ""

    if check_proxy_running; then
        echo -e "${YELLOW}Proxy already running (PID: $(cat $PROXY_PID_FILE))${NC}"
    else
        start_proxy
    fi

    echo ""
    echo -e "${BLUE}Available Models:${NC}"
    echo -e "  ${YELLOW}/model glm/glm-4${NC}                              - GLM (free)"
    echo -e "  ${YELLOW}/model featherless/Llama-3-8B-Instruct-abliterated${NC}"
    echo -e "  ${YELLOW}/model google/gemini-pro${NC}                      - Google"
    [ -n "$ANTHROPIC_API_KEY" ] && [ "$ANTHROPIC_API_KEY" != "$PLACEHOLDER_KEY" ] && \
        echo -e "  ${YELLOW}/model claude-sonnet-4-5${NC}                     - Anthropic"
    echo ""

    echo -e "${GREEN}Starting Claude Code...${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo ""

    # Start with placeholder to prevent auth dialog, but use real key if provided
    if [ -n "$ANTHROPIC_API_KEY" ]; then
        # User has set their own key
        ANTHROPIC_BASE_URL="http://127.0.0.1:${PROXY_PORT}" claude "$@"
    else
        # Use placeholder (Anthropic models won't work, but Claude Code will start)
        ANTHROPIC_API_KEY="$PLACEHOLDER_KEY" ANTHROPIC_BASE_URL="http://127.0.0.1:${PROXY_PORT}" claude "$@"
    fi
}

case "${1:-}" in
    stop)
        stop_proxy
        exit 0
        ;;
    status)
        if check_proxy_running; then
            echo -e "${GREEN}✓ Proxy running (PID: $(cat $PROXY_PID_FILE))${NC}"
        else
            echo -e "${RED}✗ Proxy not running${NC}"
        fi
        exit 0
        ;;
    help|--help|-h)
        cat <<EOF
${BLUE}Claude Code Multi-Provider Proxy${NC}

${GREEN}Usage:${NC}
  $0 [command]

${GREEN}Commands:${NC}
  (none)   Start Claude Code with proxy
  stop     Stop proxy server
  status   Check proxy status
  help     Show this help

${GREEN}Authentication:${NC}
  ${YELLOW}For Anthropic models:${NC} Set ANTHROPIC_API_KEY (your real key)
  ${YELLOW}For GLM/Featherless:${NC} Already configured
  ${YELLOW}For Google:${NC} Set GOOGLE_API_KEY

${GREEN}Examples:${NC}
  # Use with Anthropic key
  export ANTHROPIC_API_KEY="sk-ant-your-key"
  $0

  # Use without Anthropic (GLM/Featherless only)
  $0
  /model glm/glm-4

${GREEN}Model Switching:${NC}
  /model glm/glm-4
  /model featherless/Llama-3-8B-Instruct-abliterated
  /model google/gemini-pro
  /model claude-sonnet-4-5  # if ANTHROPIC_API_KEY set

EOF
        exit 0
        ;;
    *)
        main "$@"
        ;;
esac
