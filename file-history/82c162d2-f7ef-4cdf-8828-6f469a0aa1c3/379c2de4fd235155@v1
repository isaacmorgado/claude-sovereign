# Custom Models in Claude Code Model Picker

## Solution Overview

Since Claude Code hardcodes the model list in its minified `cli.js` file, this solution **directly patches the compiled bundle** to inject custom models into the `/model` picker.

## What This Does

Adds 5 custom models to the Claude Code model picker:

1. üåê **GLM-4 (Free)** - Chinese provider, free tier
2. üåê **GLM-4 Flash (Free)** - Faster GLM variant
3. üîì **Llama 3 8B (Uncensored)** - Abliterated model via Featherless
4. üîì **Llama 3 70B (Uncensored)** - Larger abliterated model
5. üî∑ **Gemini 2.0 Flash** - Google's latest via OAuth

## Installation

Run the installation script:

```bash
bash /tmp/install-custom-models.sh
```

This will:
1. ‚úÖ Backup original `cli.js`
2. ‚úÖ Patch `cli.js` to add custom models
3. ‚úÖ Create `clauded` wrapper with custom ASCII art
4. ‚úÖ Test the installation

## How It Works

### The Patch Process

The patch modifies `/opt/homebrew/lib/node_modules/@anthropic-ai/claude-code/cli.js`:

1. **Inject Model Constants** - Adds new model definitions:
   ```javascript
   XqA={firstParty:"glm/glm-4",...}
   YqA={firstParty:"glm/glm-4-flash",...}
   ZqA={firstParty:"featherless/Llama-3-8B-Instruct-abliterated",...}
   // etc.
   ```

2. **Update itA() Function** - Adds models to the structure:
   ```javascript
   function itA(A){return{
     // existing models...
     glm4:XqA[A],
     glm4flash:YqA[A],
     llama8b:ZqA[A],
     llama70b:WqA[A],
     gemini2flash:VqA[A]
   }}
   ```

3. **Update vzQ() Function** - Adds display names:
   ```javascript
   function vzQ(A){
     if(A.includes("glm/glm-4"))return"üåê GLM-4 (Free)";
     if(A.includes("featherless/Llama-3-8B"))return"üîì Llama 3 8B (Uncensored)";
     // etc.
   }
   ```

### The clauded Wrapper

Creates `/usr/local/bin/clauded` which:
1. Shows custom CLAUDE ASCII art with horns (matrix green)
2. Starts the multi-provider proxy on port 3000
3. Launches Claude Code with `ANTHROPIC_BASE_URL=http://127.0.0.1:3000`
4. Automatically stops proxy on exit

### The Proxy Server

Your existing `~/.claude/model-proxy-server.js`:
- Routes requests to different providers based on model prefix
- Provides tool calling emulation for abliterated models
- Handles OAuth for Google Gemini
- Translates between Anthropic/OpenAI/Google API formats

## Usage

### Start clauded

```bash
clauded
```

You'll see:
```
     ‚ñ≤                                        ‚ñ≤
    ‚ñê‚ñà‚ñå                                      ‚ñê‚ñà‚ñå
   ‚ñê‚ñà‚ñà‚ñà‚ñå    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
   ...

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   Multi-Provider Proxy - All Models Available in /model      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚úì Proxy started
```

### Switch Models

Inside Claude Code, run `/model`:

```
> /model

Select model
Switch between Claude models. Applies to this session and future Claude Code sessions.

  1. Opus 4.5         - Most capable for complex work
> 2. Sonnet 4.5       - Best for everyday tasks
  3. Haiku 4.5        - Fastest for quick answers
  4. üåê GLM-4 (Free)
  5. üåê GLM-4 Flash (Free)
  6. üîì Llama 3 8B (Uncensored)
  7. üîì Llama 3 70B (Uncensored)
  8. üî∑ Gemini 2.0 Flash

Enter to confirm ¬∑ escape to exit
```

Select any model and it will work with **full tool support**!

## Tool Support

All custom models have:
- ‚úÖ **MCP Tools** - Read, Write, Bash, Grep, etc.
- ‚úÖ **Agent Spawning** - `/explore`, `/rootcause`, `/build` commands
- ‚úÖ **Parallel Tool Calls** - Multiple tools in one response
- ‚úÖ **Memory** - Context preservation

### How Tool Emulation Works

For models without native tool support (Llama 8B/70B):

1. Proxy injects tool definitions into system prompt
2. Model generates XML tool calls: `<tool_call>{"name":"Read",...}</tool_call>`
3. Proxy parses XML and converts to Anthropic format
4. Claude Code executes tools normally

Result: Even uncensored models can use all Claude Code features!

## Google OAuth Setup

To use Gemini models:

```bash
node ~/.claude/model-proxy-server.js --gemini-login
```

This opens your browser for Google sign-in and saves OAuth tokens.

## Restoring Original

### Restore cli.js

```bash
sudo cp /opt/homebrew/lib/node_modules/@anthropic-ai/claude-code/cli.js.backup-before-model-patch \
       /opt/homebrew/lib/node_modules/@anthropic-ai/claude-code/cli.js
```

### Use Original Claude

Just run `claude` instead of `clauded` - it's unmodified.

## Files Created/Modified

| File | Purpose |
|------|---------|
| `/opt/homebrew/.../cli.js` | Patched to add custom models |
| `/opt/homebrew/.../cli.js.backup-before-model-patch` | Original backup |
| `/usr/local/bin/clauded` | Wrapper with ASCII art + proxy |
| `/tmp/patch-models-in-cli.js` | Patcher script (Node.js) |
| `/tmp/install-custom-models.sh` | Installation script |

## Troubleshooting

### Models don't appear in /model

1. Check if patch was applied:
   ```bash
   grep "glm/glm-4" /opt/homebrew/lib/node_modules/@anthropic-ai/claude-code/cli.js
   ```
   Should return matches.

2. Restart Claude Code completely

3. Re-run the installer:
   ```bash
   bash /tmp/install-custom-models.sh
   ```

### Proxy not starting

Check logs:
```bash
tail -f /tmp/claude-proxy.log
```

Test proxy manually:
```bash
node ~/.claude/model-proxy-server.js 3000
```

### Models work but no tool support

Verify proxy is being used:
```bash
lsof -i :3000
```

Check ANTHROPIC_BASE_URL:
```bash
echo $ANTHROPIC_BASE_URL
```
Should be `http://127.0.0.1:3000` when using `clauded`.

### Patch breaks on Claude Code update

When Claude Code updates, the cli.js is replaced with a new version.

To re-apply:
1. Update Claude Code: `npm install -g @anthropic-ai/claude-code@latest`
2. Re-run patcher: `bash /tmp/install-custom-models.sh`

## Architecture

```
clauded wrapper
    ‚Üì
Shows custom ASCII art
    ‚Üì
Starts proxy server (port 3000)
    ‚Üì
ANTHROPIC_BASE_URL=http://127.0.0.1:3000 claude
    ‚Üì
Claude Code (patched cli.js with custom models)
    ‚Üì
User selects model from /model picker (8 models)
    ‚Üì
Request goes to proxy (port 3000)
    ‚Üì
Proxy routes to provider:
    ‚îú‚îÄ glm/*        ‚Üí GLM API
    ‚îú‚îÄ featherless/* ‚Üí Featherless API (tool emulation)
    ‚îú‚îÄ google/*     ‚Üí Google API (OAuth)
    ‚îî‚îÄ anthropic/*  ‚Üí Anthropic API
    ‚Üì
Response converted to Anthropic format
    ‚Üì
Claude Code executes tools if needed
```

## Summary

- ‚úÖ 5 custom models added to `/model` picker
- ‚úÖ Full tool support for all models (even uncensored)
- ‚úÖ Custom CLAUDE ASCII art with horns
- ‚úÖ Matrix green color theme
- ‚úÖ Automatic proxy management
- ‚úÖ Easy restoration to original
- ‚úÖ Survives until next Claude Code update

**You now have 8 models in the Claude Code picker with full capabilities!**
