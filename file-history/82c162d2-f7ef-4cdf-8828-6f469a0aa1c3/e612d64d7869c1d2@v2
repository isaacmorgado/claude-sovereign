#!/bin/bash
# Complete Claude Code setup with clauded wrapper
# Features: Tool calling, agent spawning, MCP servers, memory for all models

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ”§ Claude Code Complete Setup"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "Step 1: Reinstalling original Claude Code..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
sudo npm install -g @anthropic-ai/claude-code@2.0.76 --force

echo ""
echo "âœ… Original Claude Code installed"
echo ""

echo "Step 2: Creating clauded wrapper..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Create clauded wrapper with full feature support
sudo tee /usr/local/bin/clauded > /dev/null << 'WRAPPER_EOF'
#!/bin/bash
# clauded - Claude Code with multi-provider proxy
# Features: Tool calling, agent spawning, MCP servers, memory for smaller models

GREEN='\033[38;5;46m'
CYAN='\033[38;5;51m'
RESET='\033[0m'

# Display custom ASCII art
cat << 'ART_EOF'

     â–²                                        â–²
    â–â–ˆâ–Œ                                      â–â–ˆâ–Œ
   â–â–ˆâ–ˆâ–ˆâ–Œ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
  â–â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•
   â–â–ˆâ–ˆâ–ˆâ–Œ   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â–â–ˆâ–Œ    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•
     â–²     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
            â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•

ART_EOF

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
echo -e "${GREEN}â•‘   Multi-Provider Proxy with Full Tool Support                â•‘${RESET}"
echo -e "${GREEN}â•‘   âœ“ Tool Calling  âœ“ Agent Spawning  âœ“ MCP Servers  âœ“ Memory  â•‘${RESET}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

# Check for proxy server
PROXY_SERVER="$HOME/.claude/model-proxy-server.js"
if [ ! -f "$PROXY_SERVER" ]; then
    echo "âš ï¸  Proxy server not found at $PROXY_SERVER"
    echo "Starting regular Claude Code..."
    echo ""
    exec claude "$@"
fi

# Check if proxy is already running
if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
    echo -e "${CYAN}âœ“ Proxy already running on port 3000${RESET}"
    PROXY_PID=""
else
    # Start proxy server
    echo "Starting multi-provider proxy..."
    node "$PROXY_SERVER" 3000 > /tmp/claude-proxy.log 2>&1 &
    PROXY_PID=$!

    # Wait for proxy startup
    sleep 2

    # Verify proxy started
    if ! ps -p $PROXY_PID > /dev/null 2>/dev/null; then
        echo "âŒ Proxy failed to start. Check: tail /tmp/claude-proxy.log"
        echo "Starting regular Claude Code..."
        exec claude "$@"
    fi

    echo -e "${GREEN}âœ“ Proxy started successfully${RESET}"
fi

echo ""
echo -e "${CYAN}Available Models (all with full tool support):${RESET}"
echo ""
echo -e "${GREEN}  GLM (Free):${RESET}"
echo "    /model glm/glm-4              - Native tool calling"
echo "    /model glm/glm-4-plus         - Advanced reasoning"
echo ""
echo -e "${GREEN}  Featherless (Abliterated - Tool Emulation):${RESET}"
echo "    /model featherless/Llama-3-8B-Instruct-abliterated"
echo "    /model featherless/Llama-3-70B-Instruct-abliterated"
echo "    /model featherless/Qwen2.5-72B-Instruct"
echo "    /model featherless/Llama-3.1-405B-Instruct"
echo ""
echo -e "${GREEN}  Google (OAuth):${RESET}"
echo "    /model google/gemini-2.0-flash    - Native tool calling"
echo "    /model google/gemini-1.5-pro      - Advanced reasoning"
echo ""
echo -e "${CYAN}Tool Features:${RESET}"
echo "  âœ“ All MCP servers (file ops, git, web, etc.)"
echo "  âœ“ Agent spawning (Task tool with parallel support)"
echo "  âœ“ Memory management for smaller models"
echo "  âœ“ Parallel tool calling"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Cleanup function
cleanup() {
    if [ ! -z "$PROXY_PID" ]; then
        echo ""
        echo "Stopping proxy..."
        kill $PROXY_PID 2>/dev/null || true
    fi
}

# Register cleanup on exit
trap cleanup EXIT INT TERM

# Start Claude Code with proxy
ANTHROPIC_BASE_URL=http://127.0.0.1:3000 claude "$@"
WRAPPER_EOF

# Make executable
sudo chmod +x /usr/local/bin/clauded

echo "âœ… clauded wrapper created"
echo ""

echo "Step 3: Testing installation..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

echo "Testing 'claude' (original):"
claude --version 2>&1 | head -3
echo ""

echo "Testing 'clauded' (wrapper):"
which clauded
ls -la /usr/local/bin/clauded | awk '{print "  Permissions:", $1, "  Owner:", $3}'
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Setup Complete!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Commands available:"
echo ""
echo "  claude       Original Claude Code (unchanged)"
echo "  clauded      Custom setup with:"
echo "               âœ“ ASCII art with horns (matrix green)"
echo "               âœ“ Multi-provider proxy"
echo "               âœ“ Tool calling for all models"
echo "               âœ“ Agent spawning support"
echo "               âœ“ MCP servers integration"
echo "               âœ“ Memory for smaller models"
echo ""
echo "Quick start:"
echo ""
echo "  1. Start clauded:"
echo "     clauded"
echo ""
echo "  2. Switch to abliterated model with full tools:"
echo "     /model featherless/Llama-3-70B-Instruct-abliterated"
echo ""
echo "  3. Test agent spawning:"
echo "     Spawn an agent to explore the codebase"
echo ""
echo "  4. Use MCP tools normally:"
echo "     Read package.json"
echo "     Search for 'function' in src/"
echo ""
echo "Google OAuth (optional):"
echo "  node ~/.claude/model-proxy-server.js --gemini-login"
echo ""
echo "Proxy logs:"
echo "  tail -f /tmp/claude-proxy.log"
echo ""
