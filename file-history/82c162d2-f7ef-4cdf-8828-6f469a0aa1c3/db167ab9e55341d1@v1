#!/bin/bash
# Complete fix: Reinstall Claude Code + Create clauded wrapper + Setup commands

set -e

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ”§ Complete Claude Code Fix & Setup"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "Step 1: Reinstalling original Claude Code..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
sudo npm install -g @anthropic-ai/claude-code@2.0.76 --force

echo ""
echo "âœ… Original Claude Code installed"
echo ""

echo "Step 2: Creating clauded wrapper..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Create clauded wrapper
sudo tee /usr/local/bin/clauded > /dev/null << 'WRAPPER_EOF'
#!/bin/bash
# clauded - Claude Code with custom ASCII art and multi-provider proxy

GREEN='\033[38;5;46m'
CYAN='\033[38;5;51m'
RESET='\033[0m'

# Custom CLAUDE ASCII art with horns (matrix green)
echo -e "${GREEN}"
cat << 'ART'

     â–²                                        â–²
    â–â–ˆâ–Œ                                      â–â–ˆâ–Œ
   â–â–ˆâ–ˆâ–ˆâ–Œ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
  â–â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•
   â–â–ˆâ–ˆâ–ˆâ–Œ   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â–â–ˆâ–Œ    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•
     â–²     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
            â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•

ART
echo -e "${RESET}"

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
echo -e "${GREEN}â•‘   Multi-Provider Proxy with Full Tool Support                â•‘${RESET}"
echo -e "${GREEN}â•‘   âœ“ Tool Calling  âœ“ Agent Spawning  âœ“ MCP Servers  âœ“ Memory  â•‘${RESET}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

# Check for proxy server
PROXY_SERVER="$HOME/.claude/model-proxy-server.js"
if [ ! -f "$PROXY_SERVER" ]; then
    echo "âš ï¸  Proxy not found. Starting regular Claude Code..."
    exec claude "$@"
fi

# Check if proxy is already running
if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
    echo -e "${CYAN}âœ“ Proxy already running on port 3000${RESET}"
    PROXY_PID=""
else
    echo "Starting proxy..."
    node "$PROXY_SERVER" 3000 > /tmp/claude-proxy.log 2>&1 &
    PROXY_PID=$!
    sleep 2

    if ! ps -p $PROXY_PID > /dev/null 2>/dev/null; then
        echo "âŒ Proxy failed. Check: tail /tmp/claude-proxy.log"
        exec claude "$@"
    fi

    echo -e "${GREEN}âœ“ Proxy started${RESET}"
fi

echo ""
echo -e "${CYAN}Quick Model Commands:${RESET}"
echo "  /glm4       - GLM-4 (Free)"
echo "  /llama8b    - Llama 3 8B (Uncensored)"
echo "  /llama70b   - Llama 3 70B (Uncensored)"
echo "  /gemini     - Gemini 2.0 Flash"
echo "  /qwen       - Qwen 2.5 72B"
echo "  /models     - Show all available models"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Cleanup on exit
cleanup() {
    if [ ! -z "$PROXY_PID" ]; then
        echo ""
        echo "Stopping proxy..."
        kill $PROXY_PID 2>/dev/null || true
    fi
}
trap cleanup EXIT INT TERM

# Start Claude Code with proxy
ANTHROPIC_BASE_URL=http://127.0.0.1:3000 claude "$@"
WRAPPER_EOF

sudo chmod +x /usr/local/bin/clauded

echo "âœ… clauded wrapper created"
echo ""

echo "Step 3: Custom commands already created in ~/.claude/commands/"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ls -1 ~/.claude/commands/*.md 2>/dev/null | wc -l | xargs echo "  Found commands:"
echo ""

echo "Step 4: Testing installation..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Testing 'claude' (original):"
claude --version 2>&1 | head -2
echo ""
echo "Testing 'clauded' (wrapper):"
which clauded
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Setup Complete!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "IMPORTANT: Model list workaround"
echo ""
echo "Claude Code hardcodes the /model list and ignores /v1/models."
echo "Use these custom commands inside Claude to switch models:"
echo ""
echo "  /glm4       - Free GLM-4 model"
echo "  /llama8b    - 8B uncensored model"
echo "  /llama70b   - 70B uncensored model"
echo "  /gemini     - Google Gemini"
echo "  /models     - See all available models"
echo ""
echo "Start with: clauded"
echo ""
