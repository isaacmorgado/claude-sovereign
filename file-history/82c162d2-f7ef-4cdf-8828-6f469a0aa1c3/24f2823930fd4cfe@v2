#!/bin/bash
# Install clauded with custom model picker
# This script requires sudo to create /usr/local/bin/clauded

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ¨ Installing clauded with Custom Model Picker"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "This will:"
echo "  âœ“ Create /usr/local/bin/clauded wrapper"
echo "  âœ“ Use patched CLI at ~/.claude/clauded-cli/cli.js"
echo "  âœ“ Add 9 custom models to /model picker"
echo "  âœ“ Keep regular 'claude' command unchanged"
echo ""
read -p "Continue? (y/n) " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    exit 1
fi

echo ""
echo "Creating clauded wrapper..."
sudo tee /usr/local/bin/clauded > /dev/null << 'WRAPPER_EOF'
#!/bin/bash
# clauded - Claude Code with custom models, ASCII art, and multi-provider proxy
# Uses patched CLI at ~/.claude/clauded-cli/cli.js (regular claude is unchanged)

GREEN='\033[38;5;46m'
CYAN='\033[38;5;51m'
YELLOW='\033[38;5;226m'
RESET='\033[0m'

# Custom CLAUDE ASCII art with horns (matrix green)
echo -e "${GREEN}"
cat << 'ART'

     â–²                                        â–²
    â–â–ˆâ–Œ                                      â–â–ˆâ–Œ
   â–â–ˆâ–ˆâ–ˆâ–Œ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
  â–â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•
   â–â–ˆâ–ˆâ–ˆâ–Œ   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â–â–ˆâ–Œ    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•
     â–²     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
            â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•

ART
echo -e "${RESET}"

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
echo -e "${GREEN}â•‘   Custom Multi-Model Setup with Full Tool Support            â•‘${RESET}"
echo -e "${GREEN}â•‘   âœ“ 12 Models  âœ“ Tool Calling  âœ“ Agents  âœ“ MCP  âœ“ Memory    â•‘${RESET}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

# Use the patched CLI
CLAUDED_CLI="$HOME/.claude/clauded-cli/cli.js"

if [ ! -f "$CLAUDED_CLI" ]; then
    echo -e "${YELLOW}âš ï¸  Patched CLI not found at $CLAUDED_CLI${RESET}"
    echo -e "${YELLOW}âš ï¸  Falling back to regular claude...${RESET}"
    exec claude "$@"
fi

# Check for proxy server
PROXY_SERVER="$HOME/.claude/model-proxy-server.js"
if [ ! -f "$PROXY_SERVER" ]; then
    echo -e "${YELLOW}âš ï¸  Proxy not found. Starting without proxy...${RESET}"
    exec node "$CLAUDED_CLI" "$@"
fi

# Check if proxy is already running
if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
    echo -e "${CYAN}âœ“ Proxy already running on port 3000${RESET}"
    PROXY_PID=""
else
    echo "Starting proxy..."
    node "$PROXY_SERVER" 3000 > /tmp/claude-proxy.log 2>&1 &
    PROXY_PID=$!
    sleep 2

    if ! ps -p $PROXY_PID > /dev/null 2>/dev/null; then
        echo -e "${YELLOW}âš ï¸  Proxy failed. Check: tail /tmp/claude-proxy.log${RESET}"
        exec node "$CLAUDED_CLI" "$@"
    fi

    echo -e "${GREEN}âœ“ Proxy started${RESET}"
fi

echo ""
echo -e "${CYAN}Available Models (use /model picker):${RESET}"
echo "  Claude: Opus 4.5, Sonnet 4.5, Haiku 4.5"
echo "  ğŸš€ GLM-4.7 (Orchestrator/Builder)"
echo "  ğŸ¨ Gemini 3 Pro (Frontend/Research)"
echo "  ğŸ”“ Dolphin-3 (Security/RE)"
echo "  ğŸ”“ Qwen 72B, WhiteRabbitNeo 70B"
echo "  ğŸ”“ Llama 70B/8B (Uncensored)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Cleanup on exit
cleanup() {
    if [ ! -z "$PROXY_PID" ]; then
        echo ""
        echo "Stopping proxy..."
        kill $PROXY_PID 2>/dev/null || true
    fi
}
trap cleanup EXIT INT TERM

# Start Claude Code with patched CLI and proxy
ANTHROPIC_BASE_URL=http://127.0.0.1:3000 node "$CLAUDED_CLI" "$@"
WRAPPER_EOF

sudo chmod +x /usr/local/bin/clauded

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Installation Complete!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Start clauded with: clauded"
echo ""
echo "Inside clauded, run: /model"
echo ""
echo "You should now see:"
echo "  1. Opus 4.5"
echo "  2. Sonnet 4.5"
echo "  3. Haiku 4.5"
echo "  4. ğŸš€ GLM-4.7 (Orchestrator/Builder)"
echo "  5. âš¡ GLM-4 Flash (Free)"
echo "  6. ğŸ¨ Gemini 3 Pro (Frontend/Research)"
echo "  7. âœ¨ Gemini 2.0 Flash"
echo "  8. ğŸ”“ Dolphin-3 (Security/RE)"
echo "  9. ğŸ”“ Qwen 72B (Unrestricted)"
echo " 10. ğŸ° WhiteRabbitNeo 70B (Unrestricted)"
echo " 11. ğŸ”“ Llama 70B (Uncensored)"
echo " 12. ğŸ”“ Llama 8B (Uncensored)"
echo ""
echo "âš ï¸  IMPORTANT: Regular 'claude' command remains unchanged!"
echo ""
