#!/bin/bash
# Comprehensive End-to-End Test for clauded
# Tests everything from installation to functionality

GREEN='\033[38;5;46m'
RED='\033[38;5;196m'
YELLOW='\033[38;5;226m'
CYAN='\033[38;5;51m'
RESET='\033[0m'

PASS_COUNT=0
FAIL_COUNT=0
WARN_COUNT=0

test_pass() {
    echo -e "${GREEN}âœ“ PASS${RESET} - $1"
    PASS_COUNT=$((PASS_COUNT + 1))
}

test_fail() {
    echo -e "${RED}âœ— FAIL${RESET} - $1"
    FAIL_COUNT=$((FAIL_COUNT + 1))
}

test_warn() {
    echo -e "${YELLOW}âš  WARN${RESET} - $1"
    WARN_COUNT=$((WARN_COUNT + 1))
}

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ§ª Comprehensive clauded End-to-End Test"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Test 1: Installation Verification
echo "â”â”â” Phase 1: Installation Verification â”â”â”"
echo ""

# Test 1.1: clauded wrapper exists
if [ -f "/usr/local/bin/clauded" ] && [ -x "/usr/local/bin/clauded" ]; then
    test_pass "clauded wrapper exists and is executable"
else
    test_fail "clauded wrapper missing or not executable"
fi

# Test 1.2: Patched CLI exists
if [ -f "$HOME/.claude/clauded-cli/cli.js" ]; then
    test_pass "Patched CLI exists at ~/.claude/clauded-cli/cli.js"
else
    test_fail "Patched CLI missing"
fi

# Test 1.3: Backup exists
if [ -f "$HOME/.claude/clauded-cli/cli.js.backup-before-model-patch" ]; then
    test_pass "Backup of patched CLI exists"
else
    test_warn "No backup found (not critical)"
fi

# Test 1.4: Original CLI unchanged
if grep -q "GLM-4.7" /opt/homebrew/lib/node_modules/@anthropic-ai/claude-code/cli.js 2>/dev/null; then
    test_fail "Original claude CLI was modified (should be unchanged!)"
else
    test_pass "Original claude CLI is unchanged"
fi

echo ""
echo "â”â”â” Phase 2: Patched CLI Verification â”â”â”"
echo ""

# Test 2.1: All model constants present
MODEL_CONSTANTS=$(grep -c "XqA=\|YqA=\|ZqA=\|WqA=\|VqA=\|UqA=\|TqA=\|SqA=\|RqA=" ~/.claude/clauded-cli/cli.js 2>/dev/null || echo "0")
if [ "$MODEL_CONSTANTS" -gt "0" ]; then
    test_pass "Model constants injected ($MODEL_CONSTANTS references found)"
else
    test_fail "Model constants missing from patched CLI"
fi

# Test 2.2: Display names present
for model_name in "GLM-4.7" "Dolphin-3" "Gemini 3 Pro" "Qwen 72B" "WhiteRabbitNeo"; do
    if grep -q "$model_name" ~/.claude/clauded-cli/cli.js 2>/dev/null; then
        test_pass "Display name '$model_name' found"
    else
        test_fail "Display name '$model_name' missing"
    fi
done

# Test 2.3: itA function modified
if grep -q "glm47:XqA\[A\]" ~/.claude/clauded-cli/cli.js 2>/dev/null; then
    test_pass "itA() function includes custom models"
else
    test_fail "itA() function not properly modified"
fi

# Test 2.4: vzQ function modified
if grep -q 'includes("glm/glm-4.7")' ~/.claude/clauded-cli/cli.js 2>/dev/null; then
    test_pass "vzQ() function includes display name mapping"
else
    test_fail "vzQ() function not properly modified"
fi

echo ""
echo "â”â”â” Phase 3: Supporting Infrastructure â”â”â”"
echo ""

# Test 3.1: Proxy server exists
if [ -f "$HOME/.claude/model-proxy-server.js" ]; then
    test_pass "Multi-provider proxy server exists"
else
    test_fail "Proxy server missing"
fi

# Test 3.2: Proxy syntax check
if node -c "$HOME/.claude/model-proxy-server.js" 2>/dev/null; then
    test_pass "Proxy server has valid JavaScript syntax"
else
    test_fail "Proxy server has syntax errors"
fi

# Test 3.3: Google OAuth module exists
if [ -f "$HOME/.claude/lib/gemini-oauth.js" ]; then
    test_pass "Google OAuth module exists"
else
    test_warn "Google OAuth module missing"
fi

# Test 3.4: Google OAuth tokens
if [ -f "$HOME/.claude/gemini-oauth.json" ]; then
    test_pass "Google OAuth tokens saved"
else
    test_warn "Google OAuth not configured (run: node ~/.claude/model-proxy-server.js --gemini-login)"
fi

echo ""
echo "â”â”â” Phase 4: API Keys & Authentication â”â”â”"
echo ""

# Test 4.1: Featherless API key
if [ ! -z "$FEATHERLESS_API_KEY" ]; then
    test_pass "FEATHERLESS_API_KEY environment variable set"
elif grep -q "FEATHERLESS_API_KEY" ~/.claudish_env 2>/dev/null; then
    test_pass "FEATHERLESS_API_KEY found in ~/.claudish_env"
elif grep -q "FEATHERLESS_API_KEY.*rc_" ~/.claude/model-proxy-server.js 2>/dev/null; then
    test_pass "FEATHERLESS_API_KEY hardcoded in proxy (fallback)"
else
    test_warn "FEATHERLESS_API_KEY not found (some models may not work)"
fi

# Test 4.2: Anthropic API key
if [ ! -z "$ANTHROPIC_API_KEY" ]; then
    test_pass "ANTHROPIC_API_KEY environment variable set"
else
    test_warn "ANTHROPIC_API_KEY not in environment (may be in keychain)"
fi

# Test 4.3: GLM API key
if grep -q "GLM_API_KEY.*9a58c733" ~/.claude/model-proxy-server.js 2>/dev/null; then
    test_pass "GLM free API key built into proxy"
else
    test_warn "GLM API key not found in proxy"
fi

echo ""
echo "â”â”â” Phase 5: Custom Commands â”â”â”"
echo ""

# Test 5.1: Commands directory
COMMAND_COUNT=$(ls -1 "$HOME/.claude/commands/"*.md 2>/dev/null | wc -l | tr -d ' ')
if [ "$COMMAND_COUNT" -gt "10" ]; then
    test_pass "Custom model commands found ($COMMAND_COUNT total)"
else
    test_warn "Few custom commands found ($COMMAND_COUNT)"
fi

# Test 5.2: Key commands exist
for cmd in "whiterabbit" "dolphin" "glm47" "gemini-pro" "qwen"; do
    if [ -f "$HOME/.claude/commands/$cmd.md" ]; then
        test_pass "Command file /$cmd exists"
    else
        test_warn "Command file /$cmd missing"
    fi
done

echo ""
echo "â”â”â” Phase 6: File Permissions â”â”â”"
echo ""

# Test 6.1: clauded executable
if [ -x "/usr/local/bin/clauded" ]; then
    test_pass "/usr/local/bin/clauded is executable"
else
    test_fail "/usr/local/bin/clauded is not executable"
fi

# Test 6.2: Patched CLI executable
if [ -x "$HOME/.claude/clauded-cli/cli.js" ]; then
    test_pass "Patched CLI is executable"
else
    test_fail "Patched CLI is not executable"
fi

# Test 6.3: Proxy executable
if [ -r "$HOME/.claude/model-proxy-server.js" ]; then
    test_pass "Proxy server is readable"
else
    test_fail "Proxy server permissions issue"
fi

echo ""
echo "â”â”â” Phase 7: Proxy Integration Test â”â”â”"
echo ""

# Test 7.1: Check if proxy is already running
if lsof -i :3000 >/dev/null 2>&1; then
    test_pass "Proxy already running on port 3000"
    PROXY_RUNNING=true
else
    # Try to start proxy briefly
    echo "   Starting proxy for 2 seconds..."
    node "$HOME/.claude/model-proxy-server.js" 3000 > /tmp/proxy-test.log 2>&1 &
    PROXY_PID=$!
    sleep 2

    if ps -p $PROXY_PID > /dev/null 2>&1; then
        test_pass "Proxy starts successfully"
        kill $PROXY_PID 2>/dev/null
        wait $PROXY_PID 2>/dev/null || true
    else
        test_fail "Proxy failed to start (check /tmp/proxy-test.log)"
        cat /tmp/proxy-test.log 2>/dev/null | head -10
    fi
    PROXY_RUNNING=false
fi

echo ""
echo "â”â”â” Phase 8: Model API Tests â”â”â”"
echo ""

# Test 8.1: Test Featherless API availability
echo "   Testing Featherless API..."
FEATHERLESS_TEST=$(curl -s -X POST "https://api.featherless.ai/v1/chat/completions" \
  -H "Authorization: Bearer rc_0d2c186ee945d2e0a15310e7630233b1b3bd5448fdf0d587ab5dc71cf5994fa3" \
  -H "Content-Type: application/json" \
  -d '{"model":"dphn/Dolphin-Mistral-24B-Venice-Edition","messages":[{"role":"user","content":"test"}],"max_tokens":5}' \
  2>&1 | grep -o "choices\|error" | head -1)

if [ "$FEATHERLESS_TEST" = "choices" ]; then
    test_pass "Featherless API responds correctly"
elif [ "$FEATHERLESS_TEST" = "error" ]; then
    test_warn "Featherless API returned error (may need warm-up)"
else
    test_warn "Featherless API unreachable (check internet connection)"
fi

echo ""
echo "â”â”â” Phase 9: Documentation â”â”â”"
echo ""

# Test 9.1: Check for documentation files
for doc in "README.md" "COMPLETE_SETUP_SUMMARY.md" "MODEL_CONFIGURATION.md" "INSTALL_CLAUDED.sh"; do
    if [ -f "$HOME/Desktop/Tools/$doc" ]; then
        test_pass "Documentation: $doc exists"
    else
        test_warn "Documentation: $doc missing"
    fi
done

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“Š Test Summary"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo -e "${GREEN}âœ“ Passed: $PASS_COUNT${RESET}"
echo -e "${YELLOW}âš  Warnings: $WARN_COUNT${RESET}"
echo -e "${RED}âœ— Failed: $FAIL_COUNT${RESET}"
echo ""

if [ $FAIL_COUNT -eq 0 ]; then
    echo -e "${GREEN}âœ… ALL CRITICAL TESTS PASSED${RESET}"
    echo ""
    echo "clauded is ready to use!"
    echo ""
    echo "Start with: clauded"
    echo "Then run: /model"
    echo ""
    exit 0
else
    echo -e "${RED}âŒ SOME TESTS FAILED${RESET}"
    echo ""
    echo "Please review failed tests above."
    echo ""
    exit 1
fi
