#!/bin/bash
# Claude Code Model Switcher - Frictionless Model Selection
# Usage: m [model-name|number|list]
# Created: 2026-01-12
# Compatible with bash 3.2+ (macOS default)

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Model registry (bash 3.2 compatible - no associative arrays)
# Format: key|model_id|description
MODELS_DATA="
opus|claude-opus-4-5-20251101|ðŸ›ï¸  Claude Opus 4.5 - Architecture & Deep Thinking
sonnet|claude-sonnet-4-5-20250929|ðŸ”§ Claude Sonnet 4.5 - Coding & Development (Default)
haiku|claude-haiku-4-5-20250919|âš¡ Claude Haiku 4.5 - Fast & Efficient
glm|glm/glm-4.7|ðŸš€ GLM-4.7 - Orchestrator/Builder (Chinese Native)
glm-fast|glm/glm-4-flash|ðŸŒ GLM-4 Flash - Fast Response
glm-air|glm/glm-4-air|ðŸŒ GLM-4 Air - Balanced Performance
glm-standard|glm/glm-4|ðŸŒ GLM-4 - Standard Model
dolphin|featherless/dphn/Dolphin-Mistral-24B-Venice-Edition|ðŸ” Dolphin-3 Venice - Security/RE (Unrestricted)
qwen|featherless/huihui-ai/Qwen2.5-72B-Instruct-abliterated|ðŸ”“ Qwen 2.5 72B - Reasoning (Unrestricted)
rabbit|featherless/WhiteRabbitNeo/Llama-3-WhiteRabbitNeo-8B-v2.0|ðŸ° WhiteRabbitNeo 8B - Creative Coding (Unrestricted)
rabbitv3|featherless/WhiteRabbitNeo/WhiteRabbitNeo-V3-7B|ðŸ” WhiteRabbitNeo V3 7B - Cybersecurity (Unrestricted)
llama8b|featherless/mlabonne/Meta-Llama-3.1-8B-Instruct-abliterated|ðŸ”“ Llama 3.1 8B - Fast (Unrestricted)
llama70b|featherless/huihui-ai/Llama-3.3-70B-Instruct-abliterated|ðŸ”“ Llama 3.3 70B - Quality (Unrestricted)
gemini|google/gemini-2.0-flash|ðŸ”· Gemini 2.0 Flash - Google AI
gemini-pro|google/gemini-pro|ðŸ”· Gemini Pro - Google AI
"

# Helper: Get model ID by key
get_model_id() {
    local key=$1
    echo "$MODELS_DATA" | grep "^$key|" | cut -d'|' -f2
}

# Helper: Get description by key
get_description() {
    local key=$1
    echo "$MODELS_DATA" | grep "^$key|" | cut -d'|' -f3
}

# Ordered list of model keys (for number selection)
ORDERED_KEYS=(opus sonnet haiku glm glm-fast glm-air glm-standard dolphin qwen rabbit llama8b llama70b gemini gemini-pro)

# Current model tracking file
MODEL_STATE="$HOME/.claude/current-model.state"

# Function: Show all available models
show_models() {
    echo ""
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}   Claude Code - Available Models${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    local counter=1

    # Anthropic Models
    echo -e "${YELLOW}Anthropic Models (Native via API)${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    for key in opus sonnet haiku; do
        printf "${GREEN}%2d.${NC} %-12s â†’ %s\n" "$counter" "$key" "$(get_description $key)"
        ((counter++))
    done
    echo ""

    # GLM Models
    echo -e "${YELLOW}GLM Models (Z.AI - Multilingual Support)${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    for key in glm glm-fast glm-air glm-standard; do
        printf "${GREEN}%2d.${NC} %-12s â†’ %s\n" "$counter" "$key" "$(get_description $key)"
        ((counter++))
    done
    echo ""

    # Featherless Models
    echo -e "${YELLOW}Featherless Models (Unrestricted/Security)${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    for key in dolphin qwen rabbit llama8b llama70b; do
        printf "${GREEN}%2d.${NC} %-12s â†’ %s\n" "$counter" "$key" "$(get_description $key)"
        ((counter++))
    done
    echo ""

    # Google Models
    echo -e "${YELLOW}Google Models${NC}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    for key in gemini gemini-pro; do
        printf "${GREEN}%2d.${NC} %-12s â†’ %s\n" "$counter" "$key" "$(get_description $key)"
        ((counter++))
    done
    echo ""

    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "Usage:"
    echo "  m [name]       - Start Claude with specified model"
    echo "  m [number]     - Start Claude with model by number"
    echo "  m list         - Show this list"
    echo "  m current      - Show currently selected model"
    echo ""
    echo "Examples:"
    echo "  m glm          - Start with GLM-4.7 (Chinese support)"
    echo "  m dolphin      - Start with Dolphin (Security/RE)"
    echo "  m 2            - Start with Sonnet (number 2)"
    echo ""
}

# Function: Get model by number
get_model_by_number() {
    local num=$1
    local counter=1

    for key in "${ORDERED_KEYS[@]}"; do
        if [ "$counter" -eq "$num" ]; then
            echo "$key"
            return 0
        fi
        counter=$((counter + 1))
    done

    return 1
}

# Function: Save current model
save_model() {
    local model=$1
    mkdir -p "$(dirname "$MODEL_STATE")"
    echo "$model" > "$MODEL_STATE"
    echo "$(date +%s)" >> "$MODEL_STATE"
}

# Function: Get current model
get_current_model() {
    if [ -f "$MODEL_STATE" ]; then
        head -n 1 "$MODEL_STATE"
    else
        echo "sonnet"  # Default
    fi
}

# Function: Start Claude with model
start_claude() {
    local model_key=$1
    local model_id=$(get_model_id "$model_key")

    if [ -z "$model_id" ]; then
        echo -e "${YELLOW}âš  Unknown model: $model_key${NC}"
        echo ""
        echo "Run 'm list' to see available models"
        exit 1
    fi

    # Save selection
    save_model "$model_key"

    # Check if model requires proxy
    if [[ "$model_id" == glm/* ]] || [[ "$model_id" == featherless/* ]] || [[ "$model_id" == google/* ]]; then
        # Check if proxy is running
        if ! ps aux | grep -q "[m]odel-proxy-server.js"; then
            echo -e "${YELLOW}âš  Proxy server not running. Starting...${NC}"
            node ~/.claude/model-proxy-server.js 3000 > /tmp/claude-proxy.log 2>&1 &
            echo "  Proxy PID: $!"
            sleep 2
        fi

        echo -e "${CYAN}ðŸš€ Starting Claude Code with: $(get_description $model_key)${NC}"
        echo -e "${MAGENTA}   Model ID: ${model_id}${NC}"
        echo -e "${BLUE}   Via Proxy: http://127.0.0.1:3000${NC}"
        echo ""

        # Start with proxy and auto-switch to model
        ANTHROPIC_BASE_URL=http://127.0.0.1:3000 claude --dangerously-skip-permissions --model "$model_id"
    else
        echo -e "${CYAN}ðŸš€ Starting Claude Code with: $(get_description $model_key)${NC}"
        echo -e "${MAGENTA}   Model ID: ${model_id}${NC}"
        echo ""

        # Start with native model
        claude --dangerously-skip-permissions --model "$model_id"
    fi
}

# Main logic
case "${1:-}" in
    "list"|"ls"|"l")
        show_models
        ;;

    "current"|"c")
        current=$(get_current_model)
        echo ""
        echo -e "${CYAN}Current model: $(get_description $current)${NC}"
        echo -e "${MAGENTA}Model ID: $(get_model_id $current)${NC}"
        echo ""
        ;;

    ""|"help"|"h"|"-h"|"--help")
        show_models
        ;;

    [0-9]|[0-9][0-9])
        # Number selection
        model_key=$(get_model_by_number "$1")
        if [ $? -eq 0 ]; then
            start_claude "$model_key"
        else
            echo -e "${YELLOW}âš  Invalid model number: $1${NC}"
            echo ""
            show_models
            exit 1
        fi
        ;;

    *)
        # Name selection
        model_id=$(get_model_id "$1")
        if [ -n "$model_id" ]; then
            start_claude "$1"
        else
            echo -e "${YELLOW}âš  Unknown model: $1${NC}"
            echo ""
            show_models
            exit 1
        fi
        ;;
esac
