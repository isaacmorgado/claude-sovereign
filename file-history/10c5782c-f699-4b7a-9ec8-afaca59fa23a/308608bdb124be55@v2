# SPLICE

AI-powered Premiere Pro UXP plugin for detecting takes, removing silences, and accelerating video editing workflows.

## Current Focus
**Auto-Cutting v3.4** - Timeline Markers + Isolation Tier Pricing

## Quick Reference

### Pricing Tiers
| Tier | Price | Hours | Isolation | Stripe Price ID |
|------|-------|-------|-----------|-----------------|
| Starter | $19/mo | 15 hrs | ❌ None | price_1SgH4m2L5BseYEbCih347qfr |
| Pro | $49/mo | 50 hrs | 45 min included | price_1SgH4o2L5BseYEbCIoR19lhQ |
| Team | $149/mo | 150 hrs | 3 hrs included | price_1SgH4q2L5BseYEbCYTlimb5M |
| Overage | $1/hr | - | $0.10/min | price_1SgH4y2L5BseYEbClZuxNRu8 |

### Isolation Pricing (v3.4)
- **Starter**: No access (upgrade required)
- **Pro**: 45 min included, then $0.10/min overage
- **Team**: 3 hrs included, then $0.10/min overage
- **Our cost**: $0.015/min → **85% margin on overage**
- **Worst-case margin**: 80%+ (sized to maintain margins at full utilization)

### Key Constraints
- UXP requires Premiere Pro 25.6+
- Use `127.0.0.1` not `localhost` in fetch URLs
- Backend (prod): https://splice-api-production.up.railway.app

## Key Files

| File | Purpose |
|------|---------|
| `splice-backend/server.js` | Express + all endpoints + webhook handler |
| `splice-backend/services/usageTracking.js` | Credit balance, usage logging |
| `splice-plugin/js/credits.js` | Fetch/display credit balance |
| `splice-plugin/js/main.js` | Plugin initialization + workflows |
| `splice-plugin/index.html` | UI with credit badge in header |

## Implementation Phases

- Phase 1: Backend billing ✅
- Phase 2: Frontend credits ✅
- Phase 3: Preview Mode ✅
- Phase 4-6: Smart Filtering, Automation, Polish

## Last Session (2025-12-20)

**Phase 3.3 - Take-Aware Unified Workflow:**

Merged separate "Remove Silences" and "Detect Takes" into single "SPLICE" workflow that automatically protects speech segments.

**Architecture:**
```
Audio Timeline:
|----SILENCE----|---TAKE 1---|--SILENCE--|---TAKE 2---|--SILENCE--|

After Analysis:
|====RED====|---BLUE---|==YELLOW==|---BLUE---|====RED====|
  (remove)    (keep)   (protected)   (keep)     (remove)
```

**UI Changes:**
- Single "SPLICE" action card (removed separate "Detect Takes" card)
- Combined preview with color-coded markers:
  - Red = silences safe to remove
  - Blue = takes (speech segments)
  - Yellow = silences protected by takes (won't be removed)
- Settings modal: "Detect takes (protects speech)" checkbox
- Legend showing silence/take counts

**Core Functions:**
- `initUnifiedWorkflow()` - Single GO button triggers both detections
- `filterSilencesByTakes(silences, takes)` - Protects silences overlapping speech
- `showCombinedPreview(safe, protected, takes)` - Color-coded timeline view
- `Promise.all([detectSilences(), transcribeAudio()])` - Parallel detection

**Exported API (updated):**
- `window.splicePreviewState.getSelectedSilences()` - Returns safe silences only
- `window.splicePreviewState.getSelectedTakes()` - Returns detected takes
- `window.splicePreviewState.hasPreview()` - Check if preview is active

**Transcription Migration:**
- Switched from Groq Whisper to GPT-4o-mini-transcribe
- Cost: $0.003/min (50% cheaper than Whisper's $0.006/min)
- File: `splice-backend/services/transcription.js`
- Uses OpenAI SDK with `gpt-4o-mini-transcribe` model
- Fallback `estimateSegments()` for when API doesn't return segments

**v3.4 - Isolation Tier Pricing:**
- Isolation allocation sized for 80%+ margins at full utilization
- Pro: 45 min included, Team: 3 hrs included
- Overage billing at $0.10/min (85% margin)
- Database schema: `isolation_hours_remaining`, `isolation_hours_total` columns
- Backend: `checkIsolationAccess()`, `deductIsolationUsage()` functions
- Frontend: Dynamic tier badge showing remaining isolation minutes
- Disabled isolation checkbox for Starter tier

**v3.4.1 - Timeline Markers:**
- Added Premiere Pro timeline markers for visual preview
- Red markers: Silences safe to remove (users can see what will be cut)
- Yellow markers: Protected silences (overlapping speech)
- Blue markers: Takes (speech segments for reference)
- Markers auto-clear on cancel, persist on apply
- Uses UXP `Markers.getMarkers()` and `createAddMarkerAction()` API
- File: `splice-plugin/js/main.js` - `addTimelineMarkers()`, `clearSpliceMarkers()`

**Stopped at:** Timeline markers implemented, v3.4.1

## Previous Session (2025-12-19)

**Phase 3.2 - Performance Optimizations & Takes Preview:**
- CSS performance (contain, will-change, 44px touch targets)
- JS performance (DOM caching, event delegation, DocumentFragment)
- Error handling (double-click protection, validation, race conditions)
- Keyboard shortcuts (Enter, Escape, Cmd+A/D/I)

## Next Steps
1. Add customer ID input in settings modal
2. Usage history display
3. Batch undo support
4. Virtual scrolling for 200+ silences (lower priority - timeline markers reduce need)

---
*Last updated: 2025-12-20*
