/**
 * Repetition Phrase Highlighting E2E Test
 *
 * Tests Feature 8: Color-coded repetition phrase highlighting UI
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// Load files
const indexHtml = fs.readFileSync(path.join(__dirname, '../../splice-plugin/index.html'), 'utf8');
const mainJs = fs.readFileSync(path.join(__dirname, '../../splice-plugin/js/main.js'), 'utf8');
const serverJs = fs.readFileSync(path.join(__dirname, '../server.js'), 'utf8');

console.log('\n=== Repetition Phrase Highlighting E2E Tests ===\n');

// === 1. HTML UI Elements ===
console.log('=== 1. HTML UI Elements ===');

test('Repetition results container exists', () => {
  assert.ok(indexHtml.includes('id="repetitionResults"'),
    'repetitionResults container should exist');
});

test('Repetition preview container exists', () => {
  assert.ok(indexHtml.includes('id="repetitionPreview"'),
    'repetitionPreview container should exist');
});

test('Repetition count element exists', () => {
  assert.ok(indexHtml.includes('id="repetitionCount"'),
    'repetitionCount element should exist');
});

test('Stutter count element exists', () => {
  assert.ok(indexHtml.includes('id="stutterCount"'),
    'stutterCount element should exist');
});

test('Detect repetitions button exists', () => {
  assert.ok(indexHtml.includes('id="detectRepetitionsBtn"'),
    'detectRepetitionsBtn should exist');
});

test('Remove repetitions button exists', () => {
  assert.ok(indexHtml.includes('id="removeRepetitionsBtn"'),
    'removeRepetitionsBtn should exist');
});

test('Repetition legend container exists', () => {
  assert.ok(indexHtml.includes('id="repetitionLegend"'),
    'repetitionLegend container should exist');
});

test('Repetition colors container exists', () => {
  assert.ok(indexHtml.includes('id="repetitionColors"'),
    'repetitionColors container should exist');
});

// === 2. CSS Styling ===
console.log('\n=== 2. CSS Styling ===');

test('Repetition phrase base styles exist', () => {
  assert.ok(indexHtml.includes('.repetition-phrase {'),
    'repetition-phrase base styles should exist');
});

test('Color classes exist for repetition groups', () => {
  assert.ok(indexHtml.includes('.repetition-color-1'),
    'Color class 1 should exist');
  assert.ok(indexHtml.includes('.repetition-color-2'),
    'Color class 2 should exist');
  assert.ok(indexHtml.includes('.repetition-color-3'),
    'Color class 3 should exist');
  assert.ok(indexHtml.includes('.repetition-color-4'),
    'Color class 4 should exist');
});

test('Stutter word style exists', () => {
  assert.ok(indexHtml.includes('.stutter-word'),
    'stutter-word style should exist');
  assert.ok(indexHtml.includes('line-through'),
    'Stutter words should have strikethrough');
});

test('Color chip styles exist for legend', () => {
  assert.ok(indexHtml.includes('.color-chip'),
    'color-chip style should exist');
  assert.ok(indexHtml.includes('.chip-dot'),
    'chip-dot style should exist');
});

test('Selected state style exists', () => {
  assert.ok(indexHtml.includes('.repetition-phrase.selected'),
    'Selected state style should exist');
});

// === 3. JavaScript Color Configuration ===
console.log('\n=== 3. JavaScript Color Configuration ===');

test('REPETITION_COLORS constant exists', () => {
  assert.ok(mainJs.includes('REPETITION_COLORS'),
    'REPETITION_COLORS constant should exist');
});

test('Colors include hex values', () => {
  assert.ok(mainJs.includes("hex: '#ff6b6b'"),
    'Should include hex color values');
});

test('Colors include class references', () => {
  assert.ok(mainJs.includes("class: 'repetition-color-1'"),
    'Should include class references');
});

test('At least 6 colors are defined', () => {
  const colorMatches = mainJs.match(/repetition-color-\d/g) || [];
  assert.ok(colorMatches.length >= 6,
    `Should have at least 6 colors, found ${colorMatches.length}`);
});

// === 4. Rendering Functions ===
console.log('\n=== 4. Rendering Functions ===');

test('renderRepetitionPreview function exists', () => {
  assert.ok(mainJs.includes('function renderRepetitionPreview(data)'),
    'renderRepetitionPreview function should exist');
});

test('Groups repetitions by phrase', () => {
  assert.ok(mainJs.includes('phraseGroups'),
    'Should group repetitions by phrase');
});

test('Assigns colors to phrase groups', () => {
  assert.ok(mainJs.includes('phraseColors'),
    'Should assign colors to phrase groups');
});

test('Renders stutters separately', () => {
  assert.ok(mainJs.includes("Stutters:"),
    'Should render stutters in separate section');
});

test('Builds legend with color chips', () => {
  assert.ok(mainJs.includes('legendHtml'),
    'Should build legend HTML');
});

test('Adds click handlers for seeking', () => {
  assert.ok(mainJs.includes("querySelectorAll('.repetition-phrase')"),
    'Should add click handlers to phrases');
});

// === 5. Seek Function ===
console.log('\n=== 5. Seek Function ===');

test('seekToTime function exists', () => {
  assert.ok(mainJs.includes('function seekToTime(time)'),
    'seekToTime function should exist');
});

test('seekToTime uses TickTime', () => {
  assert.ok(mainJs.includes('TickTime.createWithSeconds(time)'),
    'Should convert time to TickTime');
});

test('seekToTime calls setPlayerPosition', () => {
  assert.ok(mainJs.includes('setPlayerPosition'),
    'Should call setPlayerPosition');
});

// === 6. Detection Function ===
console.log('\n=== 6. Detection Function ===');

test('detectRepetitions function exists', () => {
  assert.ok(mainJs.includes('async function detectRepetitions()'),
    'detectRepetitions function should exist');
});

test('detectRepetitions calls /repetitions endpoint', () => {
  assert.ok(mainJs.includes("getBackendUrl()}/repetitions"),
    'Should call /repetitions endpoint');
});

test('detectRepetitions includes auth headers', () => {
  assert.ok(mainJs.includes('...getAuthHeaders()'),
    'Should include auth headers');
});

test('detectRepetitions renders preview on success', () => {
  assert.ok(mainJs.includes('renderRepetitionPreview(data)'),
    'Should call renderRepetitionPreview on success');
});

// === 7. Removal Function ===
console.log('\n=== 7. Removal Function ===');

test('removeSelectedRepetitions function exists', () => {
  assert.ok(mainJs.includes('async function removeSelectedRepetitions()'),
    'removeSelectedRepetitions function should exist');
});

test('Tracks selected repetitions in Set', () => {
  assert.ok(mainJs.includes('selectedRepetitions = new Set'),
    'Should use Set for selection tracking');
});

// === 8. Initialization ===
console.log('\n=== 8. Initialization ===');

test('initRepetitionUI function exists', () => {
  assert.ok(mainJs.includes('function initRepetitionUI()'),
    'initRepetitionUI function should exist');
});

test('initRepetitionUI is called on startup', () => {
  assert.ok(mainJs.includes('initRepetitionUI()'),
    'initRepetitionUI should be called during initialization');
});

test('Wires detect button event', () => {
  assert.ok(mainJs.includes("detectBtn.addEventListener('click', detectRepetitions)"),
    'Should wire detect button click event');
});

test('Wires remove button event', () => {
  assert.ok(mainJs.includes("removeBtn.addEventListener('click', removeSelectedRepetitions)"),
    'Should wire remove button click event');
});

// === 9. Backend Support ===
console.log('\n=== 9. Backend Support ===');

test('POST /repetitions endpoint exists', () => {
  assert.ok(serverJs.includes("app.post('/repetitions'"),
    'POST /repetitions endpoint should exist');
});

test('Endpoint returns repetitions array', () => {
  // Result is spread from detectAllRepetitions which returns { repetitions: [...] }
  assert.ok(serverJs.includes('...result'),
    'Should spread result containing repetitions in response');
});

test('Endpoint returns stutters array', () => {
  // Result is spread from detectAllRepetitions which returns { stutters: [...] }
  // And endpoint filters stutters based on includeStutters option
  assert.ok(serverJs.includes('result.stutters'),
    'Should access stutters from result');
});

// === Summary ===
console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed === 0) {
  console.log('\n✓ All tests passed!');
} else {
  console.log('\n✗ Some tests failed');
}

process.exit(failed > 0 ? 1 : 0);
