/**
 * Stutter Detection Tests
 *
 * Tests stutter detection behavior:
 * - Single-character word stutters ("I I I think")
 * - Short word stutters ("the the the")
 * - Gap-based detection (maxGapMs)
 * - Filler word handling
 * - Edge cases
 */

const assert = require('assert');
const path = require('path');
const fs = require('fs');

// Load service code for static analysis
const servicePath = path.join(__dirname, '../services/repetitionDetection.js');
const serviceCode = fs.readFileSync(servicePath, 'utf8');

// Import service for runtime tests
const {
  detectStutters,
  normalizeWord,
  levenshteinDistance,
  DEFAULT_OPTIONS
} = require('../services/repetitionDetection.js');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// Helper to create word objects with timing
function makeWords(wordList, startTime = 0, wordDuration = 0.1, gapDuration = 0.05) {
  const words = [];
  let currentTime = startTime;

  for (const word of wordList) {
    words.push({
      word: word,
      start: currentTime,
      end: currentTime + wordDuration
    });
    currentTime += wordDuration + gapDuration;
  }

  return words;
}

console.log('============================================================');
console.log('STUTTER DETECTION TEST SUITE');
console.log('Testing stutter detection service');
console.log('============================================================');
console.log('');

// === 1. Service Structure Tests ===
console.log('=== 1. Service Structure Tests ===');

test('detectStutters function exists', () => {
  assert.ok(typeof detectStutters === 'function',
    'detectStutters should be a function');
});

test('detectStutters is exported', () => {
  assert.ok(serviceCode.includes("detectStutters,"),
    'detectStutters should be exported');
});

test('normalizeWord function exists', () => {
  assert.ok(typeof normalizeWord === 'function',
    'normalizeWord should be a function');
});

test('DEFAULT_OPTIONS defined', () => {
  assert.ok(DEFAULT_OPTIONS !== undefined,
    'DEFAULT_OPTIONS should be defined');
});

// === 2. Stutter Detection Options ===
console.log('\n=== 2. Stutter Detection Options ===');

test('Supports minRepeats option', () => {
  assert.ok(serviceCode.includes('minRepeats = 2'),
    'Should have minRepeats default of 2');
});

test('Supports maxGapMs option', () => {
  assert.ok(serviceCode.includes('maxGapMs = 500'),
    'Should have maxGapMs default of 500ms');
});

test('Supports ignoreFillers option', () => {
  assert.ok(serviceCode.includes('ignoreFillers = true'),
    'Should ignore fillers by default');
});

test('Supports minWordLength option', () => {
  assert.ok(serviceCode.includes('minWordLength = 1'),
    'Should allow single char words by default');
});

// === 3. Filler Words ===
console.log('\n=== 3. Filler Words ===');

test('Defines filler word set', () => {
  assert.ok(serviceCode.includes("fillerWords = new Set(["),
    'Should define fillerWords Set');
});

test('Includes "um" as filler', () => {
  assert.ok(serviceCode.includes("'um'"),
    'Should include um as filler');
});

test('Includes "uh" as filler', () => {
  assert.ok(serviceCode.includes("'uh'"),
    'Should include uh as filler');
});

test('Includes "like" as filler', () => {
  assert.ok(serviceCode.includes("'like'"),
    'Should include like as filler');
});

// === 4. Normalization ===
console.log('\n=== 4. Normalization ===');

test('normalizeWord lowercases', () => {
  assert.strictEqual(normalizeWord('HELLO'), 'hello',
    'Should lowercase words');
});

test('normalizeWord removes punctuation', () => {
  assert.strictEqual(normalizeWord('hello!'), 'hello',
    'Should remove punctuation');
});

test('normalizeWord preserves apostrophe', () => {
  assert.strictEqual(normalizeWord("don't"), "don't",
    'Should preserve apostrophes');
});

test('normalizeWord trims whitespace', () => {
  assert.strictEqual(normalizeWord('  hello  '), 'hello',
    'Should trim whitespace');
});

// === 5. Runtime Stutter Detection ===
console.log('\n=== 5. Runtime Stutter Detection ===');

test('Detects "I I I think" as stutter', () => {
  const words = makeWords(['I', 'I', 'I', 'think']);
  const result = detectStutters({ words });
  assert.strictEqual(result.stutters.length, 1, 'Should detect 1 stutter');
  assert.strictEqual(result.stutters[0].word, 'i', 'Should normalize to lowercase');
  assert.strictEqual(result.stutters[0].occurrences, 3, 'Should count 3 occurrences');
});

test('Detects "the the the cat" as stutter', () => {
  const words = makeWords(['the', 'the', 'the', 'cat']);
  const result = detectStutters({ words });
  assert.strictEqual(result.stutters.length, 1, 'Should detect 1 stutter');
  assert.strictEqual(result.stutters[0].word, 'the', 'Should detect "the"');
});

test('Ignores single word (no stutter)', () => {
  const words = makeWords(['hello', 'world']);
  const result = detectStutters({ words });
  assert.strictEqual(result.stutters.length, 0, 'Should detect no stutters');
});

test('Ignores filler words by default', () => {
  const words = makeWords(['um', 'um', 'um', 'hello']);
  const result = detectStutters({ words });
  assert.strictEqual(result.stutters.length, 0, 'Should ignore um stutter');
});

test('Detects fillers with ignoreFillers=false', () => {
  const words = makeWords(['um', 'um', 'um', 'hello']);
  const result = detectStutters({ words }, { ignoreFillers: false });
  assert.strictEqual(result.stutters.length, 1, 'Should detect um stutter');
});

test('Respects minRepeats option', () => {
  const words = makeWords(['I', 'I', 'think']); // Only 2 repeats
  const result3 = detectStutters({ words }, { minRepeats: 3 });
  assert.strictEqual(result3.stutters.length, 0, 'Should not detect with minRepeats=3');

  const result2 = detectStutters({ words }, { minRepeats: 2 });
  assert.strictEqual(result2.stutters.length, 1, 'Should detect with minRepeats=2');
});

test('Handles empty transcript', () => {
  const result = detectStutters({ words: [] });
  assert.strictEqual(result.stutters.length, 0, 'Should handle empty words');
});

test('Returns correct metadata', () => {
  const words = makeWords(['I', 'I', 'I', 'think']);
  const result = detectStutters({ words });
  assert.ok(result.metadata, 'Should have metadata');
  assert.strictEqual(result.metadata.type, 'stutters', 'Should have type stutters');
  assert.strictEqual(result.metadata.stutterCount, 1, 'Should count 1 stutter');
});

// === 6. Timing Calculation ===
console.log('\n=== 6. Timing Calculation ===');

test('Stutter has keep and remove times', () => {
  const words = makeWords(['I', 'I', 'I', 'think']);
  const result = detectStutters({ words });
  const stutter = result.stutters[0];

  assert.ok(stutter.keepStart !== undefined, 'Should have keepStart');
  assert.ok(stutter.keepEnd !== undefined, 'Should have keepEnd');
  assert.ok(stutter.removeStart !== undefined, 'Should have removeStart');
  assert.ok(stutter.removeEnd !== undefined, 'Should have removeEnd');
});

test('Keep range is first occurrence', () => {
  const words = makeWords(['I', 'I', 'I', 'think']);
  const result = detectStutters({ words });
  const stutter = result.stutters[0];

  assert.strictEqual(stutter.keepStart, words[0].start, 'Should keep first word');
  assert.strictEqual(stutter.keepEnd, words[0].end, 'Should keep first word');
});

test('Remove range is remaining occurrences', () => {
  const words = makeWords(['I', 'I', 'I', 'think']);
  const result = detectStutters({ words });
  const stutter = result.stutters[0];

  assert.strictEqual(stutter.removeStart, words[1].start, 'Should remove from 2nd word');
  assert.strictEqual(stutter.removeEnd, words[2].end, 'Should remove through 3rd word');
});

// === 7. Gap Detection ===
console.log('\n=== 7. Gap Detection ===');

test('Detects stutters within maxGapMs', () => {
  // Words with 50ms gaps (default maxGapMs is 500)
  const words = makeWords(['I', 'I', 'I', 'think'], 0, 0.1, 0.05);
  const result = detectStutters({ words });
  assert.strictEqual(result.stutters.length, 1, 'Should detect within gap');
});

test('Splits on gap > maxGapMs', () => {
  // Create words with 600ms gap between 2nd and 3rd "I"
  const words = [
    { word: 'I', start: 0, end: 0.1 },
    { word: 'I', start: 0.15, end: 0.25 },
    { word: 'I', start: 1.0, end: 1.1 },  // 750ms gap
    { word: 'think', start: 1.15, end: 1.25 }
  ];
  const result = detectStutters({ words }, { maxGapMs: 500 });
  // First 2 "I"s are a stutter, 3rd is isolated
  assert.strictEqual(result.stutters.length, 1, 'Should only detect first pair');
  assert.strictEqual(result.stutters[0].occurrences, 2, 'Should have 2 occurrences');
});

// === 8. Case Insensitivity ===
console.log('\n=== 8. Case Insensitivity ===');

test('Detects mixed case stutters', () => {
  const words = makeWords(['I', 'i', 'I', 'think']);
  const result = detectStutters({ words });
  assert.strictEqual(result.stutters.length, 1, 'Should detect mixed case');
  assert.strictEqual(result.stutters[0].occurrences, 3, 'Should count all 3');
});

test('Detects THE/The/the as same stutter', () => {
  const words = makeWords(['THE', 'The', 'the', 'cat']);
  const result = detectStutters({ words });
  assert.strictEqual(result.stutters.length, 1, 'Should detect mixed case');
});

// === 9. Multiple Stutters ===
console.log('\n=== 9. Multiple Stutters ===');

test('Detects multiple separate stutters', () => {
  const words = makeWords(['I', 'I', 'I', 'think', 'the', 'the', 'the', 'cat']);
  const result = detectStutters({ words });
  assert.strictEqual(result.stutters.length, 2, 'Should detect 2 stutters');
});

test('Metadata counts total stutters', () => {
  const words = makeWords(['I', 'I', 'think', 'the', 'the', 'cat']);
  const result = detectStutters({ words });
  assert.strictEqual(result.metadata.stutterCount, 2, 'Should count 2 stutters');
});

// === 10. Levenshtein Distance ===
console.log('\n=== 10. Levenshtein Distance ===');

test('Levenshtein exact match is 0', () => {
  assert.strictEqual(levenshteinDistance('hello', 'hello'), 0);
});

test('Levenshtein single char diff is 1', () => {
  assert.strictEqual(levenshteinDistance('hello', 'hallo'), 1);
});

test('Levenshtein empty vs word is length', () => {
  assert.strictEqual(levenshteinDistance('', 'hello'), 5);
});

// === Summary ===
console.log('\n============================================================');
console.log('TEST SUMMARY');
console.log('============================================================');
console.log(`Total Tests: ${passed + failed}`);
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Success Rate: ${((passed / (passed + failed)) * 100).toFixed(1)}%`);

if (failed === 0) {
  console.log('\n✓ All stutter detection tests passed!');
} else {
  console.log(`\n✗ ${failed} test(s) failed`);
}

process.exit(failed > 0 ? 1 : 0);
