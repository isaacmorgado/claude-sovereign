import { NextRequest, NextResponse } from "next/server";
import { cookies } from "next/headers";

// Backend API URL for authentication
const BACKEND_API_URL =
  process.env.BACKEND_API_URL || "https://splice-api-production.up.railway.app";

export async function GET(_request: NextRequest) {
  try {
    const cookieStore = await cookies();
    const token = cookieStore.get("splice_token")?.value;

    // No token means not authenticated
    if (!token) {
      return NextResponse.json(
        { error: "Not authenticated" },
        { status: 401 }
      );
    }

    // Fetch credits data from backend
    const response = await fetch(`${BACKEND_API_URL}/credits`, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });

    if (!response.ok) {
      // Return fallback data if backend fails
      return NextResponse.json({
        hoursRemaining: 0,
        hoursUsed: 0,
        totalHours: 0,
        musicCredits: 0,
        musicCreditsUsed: 0,
        variationsCredits: 0,
        sceneAwareCredits: 0,
        projectsThisMonth: 0,
      });
    }

    const data = await response.json();

    // Return usage stats from backend data
    return NextResponse.json({
      hoursRemaining: data.hoursRemaining || 0,
      hoursUsed: data.hoursUsed || 0,
      totalHours: data.totalHours || data.hoursRemaining || 0,
      musicCredits: data.musicCredits || 0,
      musicCreditsUsed: data.musicCreditsUsed || 0,
      variationsCredits: data.variationsCredits || 0,
      sceneAwareCredits: data.sceneAwareCredits || 0,
      projectsThisMonth: data.projectsThisMonth || 0,
    });
  } catch (error) {
    console.error("[API Usage] Error:", error);
    return NextResponse.json(
      { error: "Failed to fetch usage data" },
      { status: 500 }
    );
  }
}
