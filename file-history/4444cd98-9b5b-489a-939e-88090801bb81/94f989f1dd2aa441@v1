import { NextRequest, NextResponse } from "next/server";
import { CSRF_HEADER_NAME } from "@/lib/csrf-server";

// Backend API URL for authentication
const BACKEND_API_URL =
  process.env.BACKEND_API_URL || "https://splice-api-production.up.railway.app";

// Cookie configuration
const isProduction = process.env.NODE_ENV === "production";
const COOKIE_OPTIONS = {
  httpOnly: true,
  secure: isProduction, // Only secure in production (allows localhost in dev)
  sameSite: "lax" as const, // Use "lax" to allow cookies on top-level navigations
  path: "/",
};

// Token expiry times
const ACCESS_TOKEN_MAX_AGE = 60 * 60; // 1 hour in seconds
const REFRESH_TOKEN_MAX_AGE = 7 * 24 * 60 * 60; // 7 days in seconds

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { licenseKey } = body;

    if (!licenseKey) {
      return NextResponse.json(
        { error: "License key is required" },
        { status: 400 }
      );
    }

    // Get CSRF token from request to forward to backend
    const csrfToken = request.headers.get(CSRF_HEADER_NAME);
    const backendHeaders: Record<string, string> = {
      "Content-Type": "application/json",
    };
    if (csrfToken) {
      backendHeaders[CSRF_HEADER_NAME] = csrfToken;
    }

    // Get CSRF cookie to forward to backend
    const csrfCookie = request.cookies.get("splice_csrf")?.value;
    if (csrfCookie) {
      backendHeaders["Cookie"] = `splice_csrf=${csrfCookie}`;
    }

    // Forward the login request to the backend
    const response = await fetch(`${BACKEND_API_URL}/auth/login`, {
      method: "POST",
      headers: backendHeaders,
      body: JSON.stringify({ licenseKey }),
    });

    const data = await response.json();

    if (!response.ok) {
      return NextResponse.json(
        {
          error: data.error || "Authentication failed",
          message: data.message || "Please check your license key and try again",
        },
        { status: response.status }
      );
    }

    // Create the response with user data (excluding tokens)
    const jsonResponse = NextResponse.json({
      success: true,
      customerId: data.customerId,
      tier: data.tier,
      hoursRemaining: data.hoursRemaining,
    });

    // Set HttpOnly cookies for tokens
    jsonResponse.cookies.set("splice_token", data.token, {
      ...COOKIE_OPTIONS,
      maxAge: ACCESS_TOKEN_MAX_AGE,
    });

    jsonResponse.cookies.set("splice_refresh_token", data.refreshToken, {
      ...COOKIE_OPTIONS,
      maxAge: REFRESH_TOKEN_MAX_AGE,
    });

    // Set a non-HttpOnly cookie for client-side auth state check
    // This doesn't contain sensitive data, just indicates logged-in status
    jsonResponse.cookies.set("splice_auth_status", "authenticated", {
      httpOnly: false,
      secure: isProduction,
      sameSite: "lax" as const, // Use "lax" to allow cookies on top-level navigations
      path: "/",
      maxAge: ACCESS_TOKEN_MAX_AGE,
    });

    // Store user metadata in a separate cookie for client access
    jsonResponse.cookies.set(
      "splice_user",
      JSON.stringify({
        customerId: data.customerId,
        tier: data.tier,
        hoursRemaining: data.hoursRemaining,
      }),
      {
        httpOnly: false,
        secure: isProduction,
        sameSite: "lax" as const, // Use "lax" to allow cookies on top-level navigations
        path: "/",
        maxAge: ACCESS_TOKEN_MAX_AGE,
      }
    );

    return jsonResponse;
  } catch (error) {
    console.error("[Auth] Login error:", error);
    return NextResponse.json(
      {
        error: "Authentication failed",
        message: "Unable to connect to the authentication server. Please try again later.",
      },
      { status: 500 }
    );
  }
}
