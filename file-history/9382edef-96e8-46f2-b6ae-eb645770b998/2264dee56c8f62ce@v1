# PSL Enhancement System - Implementation Specification

## Overview

This document outlines the implementation of an enhanced PSL (Pretty Scale Level) scoring system with AI-powered feature extraction, archetype classification, and personalized advice generation. The AI vision analysis is a **paid feature**.

---

## Table of Contents

1. [System Architecture](#1-system-architecture)
2. [PSL Scoring Formula](#2-psl-scoring-formula)
3. [AI Vision Feature Extraction (Paid)](#3-ai-vision-feature-extraction-paid)
4. [Archetype Classification System](#4-archetype-classification-system)
5. [Advice Generation Engine](#5-advice-generation-engine)
6. [Database Schema](#6-database-schema)
7. [API Endpoints](#7-api-endpoints)
8. [Frontend Components](#8-frontend-components)
9. [Implementation Phases](#9-implementation-phases)
10. [Cost & Pricing](#10-cost--pricing)

---

## 1. System Architecture

### High-Level Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           USER INPUT                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  FREE TIER                          │  PAID TIER (AI Vision)                │
│  ├── Gender                         │  ├── All FREE tier data               │
│  ├── Ethnicity                      │  ├── AI Skin Analysis                 │
│  ├── Front Photo                    │  ├── AI Hair/Hairline Analysis        │
│  ├── Side Photo                     │  ├── AI Teeth Analysis                │
│  └── Height (manual input)          │  ├── AI Hollow Cheeks Detection       │
│                                      │  ├── AI Eye Color Extraction         │
│                                      │  ├── Physique Photo (optional)        │
│                                      │  └── AI Body Composition Analysis     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PROCESSING PIPELINE                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  STAGE 1: Landmark Analysis (Existing)                                      │
│  ├── MediaPipe 478 landmarks (client-side)                                  │
│  ├── InsightFace 106 landmarks (server-side)                                │
│  └── 70+ facial metrics computed                                            │
│                                                                              │
│  STAGE 2: AI Vision Extraction (Paid Only)                                  │
│  ├── Claude Vision API analyzes photos                                      │
│  ├── Extracts soft tissue features                                          │
│  └── Stores in vision_extractions table                                     │
│                                                                              │
│  STAGE 3: PSL Calculation                                                   │
│  ├── Face Score (from landmarks) × 0.75                                     │
│  ├── Height Score (from input) × 0.20                                       │
│  ├── Body Score (from AI vision, if available) × 0.05                       │
│  ├── Apply bonuses and constraints                                          │
│  └── Classify into tier                                                     │
│                                                                              │
│  STAGE 4: Archetype Classification                                          │
│  ├── Rule-based scoring per archetype                                       │
│  ├── AI refinement for edge cases (paid)                                    │
│  └── Sub-archetype determination                                            │
│                                                                              │
│  STAGE 5: Advice Generation                                                 │
│  ├── Hairstyle recommendations (face shape + hairline)                      │
│  ├── Skincare routine (skin analysis)                                       │
│  ├── Style guide (archetype-matched)                                        │
│  └── Prioritized action plan (flaws → fixes)                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              OUTPUT                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  ├── Enhanced PSL Score (0-10) with tier badge                              │
│  ├── Score breakdown (Face/Height/Body/Bonuses)                             │
│  ├── Primary + Secondary Archetype                                          │
│  ├── Hairstyle Recommendations (3-5 options)                                │
│  ├── Skincare Routine (AM/PM)                                               │
│  ├── Style Guide (clothing, colors, accessories)                            │
│  └── Personalized Action Plan (prioritized by impact)                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Service Architecture

```
looksmaxx-api/
├── app/
│   ├── services/
│   │   ├── psl_service.py           # PSL calculation with formula
│   │   ├── vision_service.py        # Claude Vision API integration
│   │   ├── archetype_service.py     # Archetype classification
│   │   └── advice_service.py        # Recommendation generation
│   │
│   ├── routers/
│   │   ├── psl.py                   # PSL endpoints
│   │   ├── vision.py                # AI vision endpoints
│   │   └── advice.py                # Advice endpoints
│   │
│   └── data/
│       ├── archetypes.json          # Archetype definitions
│       ├── hairstyles.json          # Hairstyle database
│       ├── skincare.json            # Skincare routines
│       └── style_guides.json        # Style recommendations

looksmaxx-app/
├── src/
│   ├── contexts/
│   │   └── PSLContext.tsx           # Enhanced PSL state
│   │
│   ├── components/
│   │   └── psl/
│   │       ├── PSLScoreCard.tsx     # Main score display
│   │       ├── PSLBreakdown.tsx     # Component breakdown
│   │       ├── TierBadge.tsx        # Tier visualization
│   │       ├── ArchetypeCard.tsx    # Archetype display
│   │       ├── HairstyleRecs.tsx    # Hairstyle recommendations
│   │       ├── SkincareRoutine.tsx  # Skincare display
│   │       ├── StyleGuide.tsx       # Style recommendations
│   │       └── ActionPlan.tsx       # Prioritized improvements
│   │
│   └── lib/
│       ├── psl-calculator.ts        # Client-side PSL logic
│       └── archetype-classifier.ts  # Client-side classification
```

---

## 2. PSL Scoring Formula

### 2.1 Base Formula

```
PSL_Score = (Face × 0.75) + (Height × 0.20) + (Body × 0.05) + Bonuses
```

Where:
- **Face** = Harmony score from landmark analysis (0-10)
- **Height** = Height rating from lookup table (0-10)
- **Body** = Body composition score from AI vision (0-10), defaults to 5.0 if not available
- **Bonuses** = Threshold and synergy bonuses (0-0.85 max)

### 2.2 Height Rating Table

| Height (Male) | Rating | Height (Female) | Rating |
|---------------|--------|-----------------|--------|
| < 5'3" (160cm) | 1.0 | < 4'11" (150cm) | 1.0 |
| 5'3" (160cm) | 2.0 | 4'11" (150cm) | 2.0 |
| 5'5" (165cm) | 3.0 | 5'1" (155cm) | 3.5 |
| 5'7" (170cm) | 4.0 | 5'3" (160cm) | 5.0 |
| 5'9" (175cm) | 5.0 | 5'5" (165cm) | 6.0 |
| 5'10" (178cm) | 5.5 | 5'6" (168cm) | 6.5 |
| 5'11" (180cm) | 6.0 | 5'7" (170cm) | 7.0 |
| 6'0" (183cm) | 7.0 | 5'8" (173cm) | 7.5 |
| 6'1" (185cm) | 7.5 | 5'9" (175cm) | 8.0 |
| 6'2" (188cm) | 8.0 | 5'10" (178cm) | 8.5 |
| 6'3" (190cm) | 8.5 | 5'11" (180cm) | 9.0 |
| 6'4" (193cm) | 9.0 | 6'0"+ (183cm+) | 9.0 (cap) |
| 6'5"+ (196cm+) | 9.5 (diminishing) | - | - |

### 2.3 Body Rating Scale

| Body Fat % | Muscle Level | Rating | Description |
|------------|--------------|--------|-------------|
| 25%+ | Low | 2.0-3.0 | Overweight, no definition |
| 20-25% | Low | 3.5-4.5 | Soft, minimal definition |
| 18-22% | Medium | 5.0-5.5 | Average, some definition |
| 15-18% | Medium | 6.0-6.5 | Lean, visible abs starting |
| 12-15% | Medium-High | 7.0-7.5 | Athletic, clear definition |
| 10-12% | High | 8.0-8.5 | Shredded, competition lean |
| 8-10% | Very High | 9.0-9.5 | Elite physique |
| < 8% | Extreme | 9.5+ | IFBB Pro tier |

### 2.4 Bonus System

#### Threshold Bonuses (when category ≥ 8.5)
| Category | Bonus |
|----------|-------|
| Face ≥ 8.5 | +0.30 |
| Height ≥ 8.5 | +0.20 |
| Body ≥ 8.5 | +0.10 |

#### Synergy Bonuses (when multiple categories ≥ 8.5)
| Combination | Additional Bonus |
|-------------|------------------|
| Face + Height ≥ 8.5 | +0.15 |
| Face + Body ≥ 8.5 | +0.10 |
| Height + Body ≥ 8.5 | +0.05 |

#### Triple Synergy (all three ≥ 8.5)
- **+0.35** flat bonus (replaces pair bonuses, stacks with threshold bonuses)

### 2.5 Constraints (Failos)

| Constraint | Effect |
|------------|--------|
| Major facial failo present | Caps tier regardless of score |
| Body < 5.0 | -0.3 to face perception |
| Height < 8.0 rating | Cannot reach Gigachad tier |
| Severe asymmetry | -0.5 penalty |

### 2.6 Tier Classification

| Tier | Score Range | Percentile | Description |
|------|-------------|------------|-------------|
| Deformity | 0.0 - 1.0 | Bottom 0.01% | Medical intervention territory |
| Subhuman | 1.25 - 1.75 | Bottom 0.1% | Genetic outlier |
| Incel | 2.0 - 3.0 | Bottom 2.5% | Visibly below average |
| LTN (Low Tier Normie) | 3.5 - 4.5 | Bottom 13.59% | Somewhat unattractive |
| MTN (Mid Tier Normie) | 4.75 - 5.25 | Middle 68% | True average |
| HTN (High Tier Normie) | 5.5 - 6.5 | Top 13.59% | Somewhat attractive |
| Chadlite | 7.0 - 8.0 | Top 2.5% | Attractive, local star |
| Chad | 8.25 - 8.75 | Top 0.1% | Very attractive, elite |
| Gigachad | 9.0 - 9.5 | Top 0.01% | Mythical tier |
| True Mogger | 9.5+ | Apex | Theoretical limit |

### 2.7 Implementation

```typescript
// psl-calculator.ts

interface PSLInput {
  faceScore: number;        // 0-10 from harmony analysis
  heightCm: number;         // User input
  gender: 'male' | 'female';
  bodyAnalysis?: {          // From AI vision (paid)
    bodyFatPercent: number;
    muscleLevel: 'low' | 'medium' | 'medium-high' | 'high' | 'very-high' | 'extreme';
  };
  failos?: string[];        // Detected major failos
}

interface PSLResult {
  score: number;            // Final PSL 0-10
  tier: string;             // Tier name
  percentile: number;       // Population percentile
  breakdown: {
    face: { raw: number; weighted: number };
    height: { raw: number; weighted: number };
    body: { raw: number; weighted: number };
    bonuses: { threshold: number; synergy: number; total: number };
    penalties: number;
  };
  potential: number;        // Estimated max with improvements
}

function calculatePSL(input: PSLInput): PSLResult {
  // 1. Get height rating
  const heightRating = getHeightRating(input.heightCm, input.gender);

  // 2. Get body rating (default 5.0 if not available)
  const bodyRating = input.bodyAnalysis
    ? getBodyRating(input.bodyAnalysis.bodyFatPercent, input.bodyAnalysis.muscleLevel)
    : 5.0;

  // 3. Calculate base score
  const faceWeighted = input.faceScore * 0.75;
  const heightWeighted = heightRating * 0.20;
  const bodyWeighted = bodyRating * 0.05;
  let baseScore = faceWeighted + heightWeighted + bodyWeighted;

  // 4. Calculate bonuses
  let thresholdBonus = 0;
  let synergyBonus = 0;

  if (input.faceScore >= 8.5) thresholdBonus += 0.30;
  if (heightRating >= 8.5) thresholdBonus += 0.20;
  if (bodyRating >= 8.5) thresholdBonus += 0.10;

  const highCount = [input.faceScore, heightRating, bodyRating].filter(s => s >= 8.5).length;

  if (highCount === 3) {
    synergyBonus = 0.35; // Triple synergy replaces pairs
  } else if (highCount === 2) {
    if (input.faceScore >= 8.5 && heightRating >= 8.5) synergyBonus += 0.15;
    if (input.faceScore >= 8.5 && bodyRating >= 8.5) synergyBonus += 0.10;
    if (heightRating >= 8.5 && bodyRating >= 8.5) synergyBonus += 0.05;
  }

  // 5. Apply penalties
  let penalties = 0;
  if (bodyRating < 5.0) penalties += 0.3;
  if (input.failos?.includes('severe_asymmetry')) penalties += 0.5;

  // 6. Final score
  const finalScore = Math.min(10, Math.max(0, baseScore + thresholdBonus + synergyBonus - penalties));

  // 7. Classify tier (with constraints)
  const tier = classifyTier(finalScore, heightRating, input.failos);

  return {
    score: Math.round(finalScore * 100) / 100,
    tier: tier.name,
    percentile: tier.percentile,
    breakdown: {
      face: { raw: input.faceScore, weighted: faceWeighted },
      height: { raw: heightRating, weighted: heightWeighted },
      body: { raw: bodyRating, weighted: bodyWeighted },
      bonuses: { threshold: thresholdBonus, synergy: synergyBonus, total: thresholdBonus + synergyBonus },
      penalties,
    },
    potential: estimatePotential(input),
  };
}
```

---

## 3. AI Vision Feature Extraction (Paid)

### 3.1 Features Extracted

#### From Face Photos

| Feature | Scale | Description | Used For |
|---------|-------|-------------|----------|
| **Skin Clarity** | 0-10 | Overall skin quality | Skincare recommendations |
| **Skin Tone** | Category | pale/fair/medium/olive/tan/dark | Style color matching |
| **Acne Level** | none/mild/moderate/severe | Current breakout status | Skincare priority |
| **Acne Scarring** | none/mild/moderate/severe | Historical scarring | Treatment recommendations |
| **Pore Visibility** | minimal/visible/prominent | Pore size assessment | Skincare routine |
| **Texture Issues** | list | Roughness, bumps, etc. | Targeted treatments |
| **Hairline NW** | 0-7 | Norwood scale classification | Hairstyle recommendations |
| **Hair Density** | thin/medium/thick | Hair thickness | Hairstyle options |
| **Hair Texture** | straight/wavy/curly/coily | Natural texture | Styling recommendations |
| **Hair Color** | Category | Natural color classification | Style matching |
| **Eye Color** | Category | Iris color | Style color matching |
| **Under-eye Darkness** | 0-10 | Dark circle severity | Skincare/concealer advice |
| **Under-eye Puffiness** | 0-10 | Bag severity | Lifestyle recommendations |
| **Hollow Cheeks** | 0-10 | Buccal fat assessment | Leanness indicator |
| **Teeth Color** | white/off-white/yellow/stained | Tooth shade | Whitening recommendations |
| **Teeth Alignment** | aligned/minor-issues/crooked | Orthodontic status | Treatment options |
| **Eyebrow Density** | sparse/medium/thick | Brow fullness | Grooming advice |
| **Facial Hair Potential** | low/medium/high | Beard growth capability | Style recommendations |

#### From Physique Photo (Optional)

| Feature | Scale | Description | Used For |
|---------|-------|-------------|----------|
| **Body Fat %** | 5-40% | Estimated body fat | Body score calculation |
| **Muscle Mass** | low/medium/medium-high/high/very-high | Muscularity | Body score, archetype |
| **Frame Size** | small/medium/large/very-large | Skeletal frame | Archetype classification |
| **Shoulder Width** | narrow/average/broad/very-broad | Shoulder assessment | Style recommendations |
| **Waist Definition** | undefined/slight/defined/very-defined | V-taper indicator | Physique score |
| **Posture** | poor/fair/good/excellent | Standing posture | Improvement advice |

### 3.2 Claude Vision Implementation

```python
# vision_service.py

import anthropic
from typing import Optional
import base64

class VisionService:
    def __init__(self):
        self.client = anthropic.Anthropic()
        self.model = "claude-sonnet-4-20250514"

    async def extract_features(
        self,
        front_photo_url: str,
        side_photo_url: Optional[str] = None,
        physique_photo_url: Optional[str] = None
    ) -> VisionExtractionResult:

        # Prepare images
        images = [{"type": "image", "source": {"type": "url", "url": front_photo_url}}]
        if side_photo_url:
            images.append({"type": "image", "source": {"type": "url", "url": side_photo_url}})

        # Face analysis prompt
        face_prompt = """Analyze this face photo and extract the following features.
        Return a JSON object with these exact keys:

        {
          "skin": {
            "clarity": <0-10 score>,
            "tone": "<pale|fair|medium|olive|tan|dark>",
            "acne_level": "<none|mild|moderate|severe>",
            "acne_scarring": "<none|mild|moderate|severe>",
            "pore_visibility": "<minimal|visible|prominent>",
            "texture_issues": ["<list of issues>"]
          },
          "hair": {
            "hairline_nw": <0-7 Norwood scale>,
            "density": "<thin|medium|thick>",
            "texture": "<straight|wavy|curly|coily>",
            "color": "<blonde|light-brown|brown|dark-brown|black|red|gray>"
          },
          "eyes": {
            "color": "<blue|green|hazel|brown|dark-brown|black>",
            "under_eye_darkness": <0-10>,
            "under_eye_puffiness": <0-10>
          },
          "facial_features": {
            "hollow_cheeks": <0-10>,
            "eyebrow_density": "<sparse|medium|thick>",
            "facial_hair_potential": "<low|medium|high>"
          },
          "teeth": {
            "color": "<white|off-white|yellow|stained>",
            "alignment": "<aligned|minor-issues|crooked>",
            "visible_in_photo": <boolean>
          }
        }

        Be objective and accurate. If a feature cannot be determined from the photo, use null.
        """

        response = await self.client.messages.create(
            model=self.model,
            max_tokens=1024,
            messages=[{
                "role": "user",
                "content": [*images, {"type": "text", "text": face_prompt}]
            }]
        )

        face_features = parse_json_response(response.content[0].text)

        # Body analysis if physique photo provided
        body_features = None
        if physique_photo_url:
            body_features = await self._analyze_physique(physique_photo_url)

        return VisionExtractionResult(
            face=face_features,
            body=body_features
        )

    async def _analyze_physique(self, photo_url: str) -> BodyAnalysis:
        body_prompt = """Analyze this physique photo and extract:

        {
          "body_fat_percent": <estimated 5-40%>,
          "muscle_mass": "<low|medium|medium-high|high|very-high>",
          "frame_size": "<small|medium|large|very-large>",
          "shoulder_width": "<narrow|average|broad|very-broad>",
          "waist_definition": "<undefined|slight|defined|very-defined>",
          "posture": "<poor|fair|good|excellent>",
          "estimated_height_category": "<short|average|tall|very-tall>"
        }

        Be objective. Base body fat estimate on visible definition and vascularity.
        """

        response = await self.client.messages.create(
            model=self.model,
            max_tokens=512,
            messages=[{
                "role": "user",
                "content": [
                    {"type": "image", "source": {"type": "url", "url": photo_url}},
                    {"type": "text", "text": body_prompt}
                ]
            }]
        )

        return parse_json_response(response.content[0].text)
```

### 3.3 Caching Strategy

- Vision extractions are cached per analysis ID
- Cache invalidated if photos are updated
- Results stored in `vision_extractions` table
- TTL: Permanent (until analysis deleted)

---

## 4. Archetype Classification System

### 4.1 Archetype Taxonomy

```
ARCHETYPES
├── SOFTBOY (Low Dimorphism, Ectomorphic)
│   ├── K-Pop Idol
│   │   ├── Traits: East/SE Asian, flat midface, clear skin, styled hair
│   │   ├── Style: Slim tailored, high contrast colors, layered hair
│   │   └── Examples: BTS members, K-drama actors
│   │
│   ├── Softboy
│   │   ├── Traits: Youthful, delicate features, slim build
│   │   ├── Style: Oversized fits, light colors, long hair
│   │   └── Examples: Timothée Chalamet, young Leonardo DiCaprio
│   │
│   └── Academic
│       ├── Traits: Intellectual look, refined, understated
│       ├── Style: Preppy, glasses, earth tones
│       └── Examples: Young Hugh Grant
│
├── PRETTYBOY (Balanced Dimorphism, Good Harmony)
│   ├── Skater
│   │   ├── Traits: Casual cool, athletic lean, relaxed
│   │   ├── Style: Streetwear, baggy pants, sneakers
│   │   └── Examples: Young Heath Ledger
│   │
│   ├── Prettyboy
│   │   ├── Traits: Symmetrical, harmonious, classic beauty
│   │   ├── Style: Clean, fitted, minimal
│   │   └── Examples: Francisco Lachowski, Sean O'Pry
│   │
│   └── Surfer
│       ├── Traits: Sun-kissed, athletic, carefree
│       ├── Style: Beach casual, natural fabrics
│       └── Examples: Young Chris Hemsworth
│
├── ROBUST PRETTYBOY (Pretty + Edge/Intensity)
│   ├── Fallen Angel
│   │   ├── Traits: Ethereal, intense, mysterious
│   │   ├── Style: Dark romantic, leather, black
│   │   └── Examples: Young Jared Leto, Jordan Barrett
│   │
│   ├── Prince
│   │   ├── Traits: Regal, refined, elegant
│   │   ├── Style: Tailored suits, classic elegance
│   │   └── Examples: Young Alain Delon, Matt Bomer
│   │
│   ├── Bad Boy
│   │   ├── Traits: Rebellious, smoldering, dangerous appeal
│   │   ├── Style: Leather jackets, boots, rough edges
│   │   └── Examples: James Dean, Young Johnny Depp
│   │
│   └── Artist
│       ├── Traits: Creative, unconventional, magnetic
│       ├── Style: Eclectic, statement pieces
│       └── Examples: Harry Styles, Zayn Malik
│
├── CHAD (High Dimorphism, Strong Features)
│   ├── Vampire
│   │   ├── Traits: Sharp features, pale, mysterious, hollow cheeks
│   │   ├── Style: Dark, sophisticated, elegant
│   │   └── Examples: Robert Pattinson, Ian Somerhalder
│   │
│   ├── Superman
│   │   ├── Traits: Heroic, strong jaw, broad build, classic handsome
│   │   ├── Style: Classic American, clean-cut
│   │   └── Examples: Henry Cavill, David Gandy
│   │
│   ├── Jock
│   │   ├── Traits: Athletic, confident, dominant presence
│   │   ├── Style: Athletic wear, casual sporty
│   │   └── Examples: Chris Evans, Michael B. Jordan
│   │
│   ├── Casanova
│   │   ├── Traits: Charming, seductive, smooth
│   │   ├── Style: Tailored, sophisticated, European
│   │   └── Examples: George Clooney, Pierce Brosnan
│   │
│   ├── Executive
│   │   ├── Traits: Powerful, authoritative, successful look
│   │   ├── Style: Power suits, luxury watches
│   │   └── Examples: Jon Hamm, Gabriel Macht
│   │
│   └── Pharaoh
│       ├── Traits: Exotic, regal, chiseled, Middle Eastern features
│       ├── Style: Luxurious, gold accents, designer
│       └── Examples: Fares Fares, Egyptian models
│
├── HYPERMASCULINE (Extreme Masculine Features)
│   ├── Aquaman
│   │   ├── Traits: Tall, muscular, long hair, rugged handsome
│   │   ├── Style: Relaxed, bohemian, natural fabrics
│   │   └── Examples: Jason Momoa, Thor-era Chris Hemsworth
│   │
│   ├── Hypermasculine
│   │   ├── Traits: Extreme bone structure, heavy brow, dominant
│   │   ├── Style: Minimalist, masculine basics
│   │   └── Examples: Dolph Lundgren (prime), Michael Fassbender
│   │
│   ├── Outlaw
│   │   ├── Traits: Rough, weathered, dangerous
│   │   ├── Style: Leather, denim, boots, rugged
│   │   └── Examples: Young Clint Eastwood, Josh Brolin
│   │
│   └── Countryman
│       ├── Traits: Rugged, outdoorsy, strong silent
│       ├── Style: Workwear, flannel, boots
│       └── Examples: Yellowstone cast, Young Sam Elliott
│
└── OGRE (Maximum Size/Mass)
    ├── Viking
    │   ├── Traits: Massive, bearded, warrior look, Norse features
    │   ├── Style: Rugged, fur, leather, minimalist
    │   └── Examples: Hafþór Björnsson, Alexander Skarsgård (Northman)
    │
    └── Bodybuilder
        ├── Traits: Extreme muscle, massive frame, imposing
        ├── Style: Fitted to show physique, tank tops
        └── Examples: Arnold Schwarzenegger (prime), Dwayne Johnson
```

### 4.2 Classification Criteria

#### Input Features for Classification

| Feature | Source | Weight |
|---------|--------|--------|
| Gonial Angle | Landmarks | High |
| Facial Width/Height Ratio | Landmarks | High |
| Brow Ridge Prominence | Landmarks + Vision | Medium |
| Cheekbone Height | Landmarks | Medium |
| Eye Area Score | Landmarks | Medium |
| Dimorphism Level | Computed | High |
| Body Type | Vision (physique) | Medium |
| Frame Size | Vision | Medium |
| Ethnicity | User input | Medium |
| Hollow Cheeks | Vision | Low |
| Skin Tone | Vision | Low |

#### Dimorphism Classification

| Level | Gonial Angle | Brow Ridge | Jaw Definition | Features |
|-------|--------------|------------|----------------|----------|
| Low | ≥ 130° | Minimal | Soft, undefined | Neotenous, youthful |
| Low-Balanced | 125-130° | Slight | Harmonious soft | Balanced but softer |
| Balanced | 118-125° | Moderate | Neutral | Neither masc nor fem |
| Above-Average | 115-120° | Moderate+ | Defined | Leaning masculine |
| High | 110-118° | Prominent | Very defined | Strongly masculine |
| Very High | < 110° | Heavy | Extremely defined | Hypermasculine |

#### Body Type Classification

| Type | Shoulder-Waist Ratio | Build | Archetype Fit |
|------|---------------------|-------|---------------|
| Ectomorphic | < 1.35 | Slim, lean | Softboy, Prettyboy |
| Ecto-Mesomorphic | 1.35-1.45 | Lean athletic | Robust Prettyboy, Vampire Chad |
| Mesomorphic | 1.45-1.55 | Athletic | Chad, Jock |
| Endo-Mesomorphic | > 1.55, high muscle | Muscular large | Hypermasculine, Aquaman |
| Meso-Endomorphic | > 1.45, higher BF | Thick, strong | Ogre, Viking |

### 4.3 Classification Algorithm

```typescript
// archetype-classifier.ts

interface ClassificationInput {
  // From landmarks
  gonialAngle: number;
  fwhr: number;
  browRidgeProminence: number;
  cheekboneHeight: number;
  eyeAreaScore: number;

  // Computed
  dimorphismLevel: DimorphismLevel;

  // From vision (if available)
  hollowCheeks?: number;
  skinTone?: string;

  // From physique (if available)
  bodyType?: BodyType;
  frameSize?: FrameSize;

  // User input
  ethnicity: string;
  gender: 'male' | 'female';
}

interface ArchetypeResult {
  primary: {
    category: string;      // e.g., "Chad"
    subArchetype: string;  // e.g., "Vampire"
    confidence: number;    // 0-1
  };
  secondary: {
    category: string;
    subArchetype: string;
    confidence: number;
  };
  traits: string[];
  styleGuide: StyleRecommendation;
  transitionPath?: {
    target: string;
    requirements: string[];
  };
}

function classifyArchetype(input: ClassificationInput): ArchetypeResult {
  const scores: Record<string, number> = {};

  // Score each main category
  scores.Softboy = scoreSoftboy(input);
  scores.Prettyboy = scorePrettyboy(input);
  scores.RobustPrettyboy = scoreRobustPrettyboy(input);
  scores.Chad = scoreChad(input);
  scores.Hypermasculine = scoreHypermasculine(input);
  scores.Ogre = scoreOgre(input);

  // Get top 2 categories
  const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  const primaryCategory = sorted[0][0];
  const secondaryCategory = sorted[1][0];

  // Determine sub-archetype within primary
  const primarySub = classifySubArchetype(primaryCategory, input);
  const secondarySub = classifySubArchetype(secondaryCategory, input);

  return {
    primary: {
      category: primaryCategory,
      subArchetype: primarySub.name,
      confidence: sorted[0][1] / 100,
    },
    secondary: {
      category: secondaryCategory,
      subArchetype: secondarySub.name,
      confidence: sorted[1][1] / 100,
    },
    traits: [...primarySub.traits, ...secondarySub.traits.slice(0, 2)],
    styleGuide: getStyleGuide(primaryCategory, primarySub.name),
    transitionPath: getTransitionPath(primaryCategory, sorted),
  };
}

function scoreChad(input: ClassificationInput): number {
  let score = 0;

  // Gonial angle (strong jaw)
  if (input.gonialAngle <= 120) score += 25;
  else if (input.gonialAngle <= 125) score += 15;

  // High dimorphism
  if (input.dimorphismLevel === 'high') score += 25;
  else if (input.dimorphismLevel === 'above-average') score += 15;

  // Brow ridge
  if (input.browRidgeProminence >= 7) score += 15;

  // Body type
  if (input.bodyType === 'mesomorphic') score += 15;
  else if (input.bodyType === 'ecto-mesomorphic') score += 10;

  // Hollow cheeks (vampire sub-type indicator)
  if (input.hollowCheeks && input.hollowCheeks >= 7) score += 10;

  // Frame
  if (input.frameSize === 'large') score += 10;

  return score;
}

// Similar scoring functions for other categories...
```

---

## 5. Advice Generation Engine

### 5.1 Advice Categories

1. **Hairstyle Recommendations**
2. **Skincare Routine**
3. **Style Guide** (clothing, colors, accessories)
4. **Grooming Guide** (facial hair, eyebrows, etc.)
5. **Physique Recommendations**
6. **Action Plan** (prioritized improvements)

### 5.2 Hairstyle Recommendations

#### Face Shape Detection (from landmarks)

| Face Shape | Characteristics | Detection Criteria |
|------------|-----------------|-------------------|
| Oval | Balanced, slightly longer | FWHR 1.4-1.6, cheekbones widest |
| Round | Wide, soft angles | FWHR > 1.6, minimal jaw definition |
| Square | Strong jaw, equal width/length | FWHR ≈ 1.5, wide bigonial |
| Oblong | Long, narrow | FWHR < 1.4, high forehead |
| Heart | Wide forehead, narrow chin | Wide temples, narrow lower third |
| Diamond | Narrow forehead/chin, wide cheeks | High cheekbones, narrow bigonial |

#### Hairstyle Database Structure

```json
{
  "hairstyles": [
    {
      "id": "textured-fringe",
      "name": "Textured Fringe",
      "description": "Layered top with textured fringe covering forehead",
      "face_shapes": ["oblong", "heart", "diamond"],
      "hairline_max_nw": 2,
      "hair_textures": ["straight", "wavy"],
      "archetypes": ["Prettyboy", "Softboy", "RobustPrettyboy"],
      "maintenance": "medium",
      "styling_time": "5-10 min",
      "products": ["texturizing paste", "sea salt spray"],
      "reference_images": ["url1", "url2"]
    },
    {
      "id": "slicked-back",
      "name": "Slicked Back",
      "description": "Hair pushed back with product for clean look",
      "face_shapes": ["oval", "square", "diamond"],
      "hairline_max_nw": 1,
      "hair_textures": ["straight", "wavy"],
      "archetypes": ["Chad", "Executive", "Prince"],
      "maintenance": "low",
      "styling_time": "2-5 min",
      "products": ["pomade", "gel"],
      "reference_images": ["url1", "url2"]
    },
    {
      "id": "buzz-cut",
      "name": "Buzz Cut",
      "description": "Very short all around, low maintenance",
      "face_shapes": ["oval", "square"],
      "hairline_max_nw": 7,
      "hair_textures": ["any"],
      "archetypes": ["Hypermasculine", "Jock", "Ogre"],
      "maintenance": "very-low",
      "styling_time": "0 min",
      "products": [],
      "reference_images": ["url1", "url2"]
    }
    // ... more hairstyles
  ]
}
```

#### Recommendation Logic

```typescript
function recommendHairstyles(
  faceShape: FaceShape,
  hairlineNW: number,
  hairTexture: string,
  archetype: ArchetypeResult,
  preferences?: { maintenance?: string }
): HairstyleRecommendation[] {

  return HAIRSTYLES
    .filter(h => h.face_shapes.includes(faceShape))
    .filter(h => h.hairline_max_nw >= hairlineNW)
    .filter(h => h.hair_textures.includes(hairTexture) || h.hair_textures.includes('any'))
    .filter(h => h.archetypes.some(a =>
      a === archetype.primary.category || a === archetype.primary.subArchetype
    ))
    .sort((a, b) => {
      // Prioritize by archetype match strength
      const aMatch = getArchetypeMatchScore(a, archetype);
      const bMatch = getArchetypeMatchScore(b, archetype);
      return bMatch - aMatch;
    })
    .slice(0, 5);
}
```

### 5.3 Skincare Routine Generation

#### Routine Structure

```typescript
interface SkincareRoutine {
  morning: SkincareStep[];
  evening: SkincareStep[];
  weekly: SkincareStep[];
  targetedTreatments: Treatment[];
}

interface SkincareStep {
  order: number;
  type: 'cleanser' | 'toner' | 'serum' | 'moisturizer' | 'sunscreen' | 'treatment';
  product: {
    name: string;
    ingredients: string[];
    purpose: string;
  };
  frequency: 'daily' | 'alternate' | 'weekly';
  notes?: string;
}
```

#### Routine Logic Based on Skin Analysis

```typescript
function generateSkincareRoutine(skinAnalysis: SkinAnalysis): SkincareRoutine {
  const routine: SkincareRoutine = {
    morning: [],
    evening: [],
    weekly: [],
    targetedTreatments: [],
  };

  // Morning routine (always)
  routine.morning.push(
    { order: 1, type: 'cleanser', product: getCleanser(skinAnalysis) },
    { order: 2, type: 'moisturizer', product: getMoisturizer(skinAnalysis) },
    { order: 3, type: 'sunscreen', product: { name: 'SPF 50+ Sunscreen', ingredients: ['zinc oxide'], purpose: 'UV protection' } }
  );

  // Evening routine (always)
  routine.evening.push(
    { order: 1, type: 'cleanser', product: getCleanser(skinAnalysis) },
    { order: 2, type: 'treatment', product: getEveningTreatment(skinAnalysis) },
    { order: 3, type: 'moisturizer', product: getMoisturizer(skinAnalysis) }
  );

  // Add targeted treatments based on issues
  if (skinAnalysis.acne_level !== 'none') {
    routine.targetedTreatments.push({
      concern: 'acne',
      product: 'Benzoyl Peroxide 2.5% or Salicylic Acid 2%',
      frequency: 'daily',
      notes: 'Apply to affected areas only'
    });
  }

  if (skinAnalysis.acne_scarring !== 'none') {
    routine.targetedTreatments.push({
      concern: 'scarring',
      product: 'Vitamin C Serum (morning) + Retinol (evening)',
      frequency: 'daily',
      notes: 'Start retinol slowly, 2x/week then increase'
    });
  }

  if (skinAnalysis.under_eye_darkness >= 6) {
    routine.targetedTreatments.push({
      concern: 'dark circles',
      product: 'Caffeine Eye Serum + Vitamin K cream',
      frequency: 'twice daily',
      notes: 'Also improve sleep and hydration'
    });
  }

  // Weekly treatments
  if (skinAnalysis.pore_visibility !== 'minimal') {
    routine.weekly.push({
      order: 1,
      type: 'treatment',
      product: { name: 'Clay Mask', ingredients: ['kaolin', 'bentonite'], purpose: 'Deep pore cleansing' },
      frequency: 'weekly'
    });
  }

  return routine;
}
```

### 5.4 Style Guide Generation

```typescript
interface StyleGuide {
  archetype: string;
  subArchetype: string;

  clothing: {
    essentials: ClothingItem[];
    fits: string[];
    avoid: string[];
  };

  colors: {
    primary: string[];      // Best colors based on skin tone
    accent: string[];       // Accent colors
    avoid: string[];        // Colors to avoid
  };

  accessories: {
    recommended: Accessory[];
    optional: Accessory[];
  };

  grooming: {
    facialHair: string;     // Recommendation based on features
    eyebrows: string;
    hair: string;           // Reference to hairstyle recs
  };

  inspirationImages: string[];
  celebrityReferences: string[];
}

function generateStyleGuide(
  archetype: ArchetypeResult,
  skinTone: string,
  visionFeatures: VisionFeatures
): StyleGuide {

  const baseGuide = STYLE_GUIDES[archetype.primary.subArchetype];

  // Customize colors based on skin tone
  const colors = getColorPalette(skinTone, archetype);

  // Facial hair recommendation
  const facialHair = recommendFacialHair(
    archetype,
    visionFeatures.facial_hair_potential,
    visionFeatures.hollow_cheeks
  );

  return {
    ...baseGuide,
    colors,
    grooming: {
      facialHair,
      eyebrows: recommendEyebrowGrooming(visionFeatures.eyebrow_density),
      hair: 'See hairstyle recommendations',
    },
  };
}
```

### 5.5 Action Plan Generation

```typescript
interface ActionPlan {
  tier: 'foundation' | 'enhancement' | 'advanced';
  items: ActionItem[];
  estimatedTimeframe: string;
  estimatedCost: CostRange;
  potentialPSLGain: number;
}

interface ActionItem {
  priority: number;
  category: 'skincare' | 'hair' | 'physique' | 'style' | 'dental' | 'surgical';
  action: string;
  reason: string;
  impact: 'high' | 'medium' | 'low';
  difficulty: 'easy' | 'medium' | 'hard';
  timeframe: string;
  cost: CostRange;
  linkedFlaw?: string;
}

function generateActionPlan(
  flaws: Flaw[],
  strengths: Strength[],
  visionFeatures: VisionFeatures,
  archetype: ArchetypeResult,
  userPreferences: { budget: string; timeline: string }
): ActionPlan[] {

  const items: ActionItem[] = [];

  // 1. Foundation tier (softmaxxing, low cost, high impact)

  // Skincare if issues detected
  if (visionFeatures.skin.acne_level !== 'none' || visionFeatures.skin.clarity < 7) {
    items.push({
      priority: 1,
      category: 'skincare',
      action: 'Establish consistent skincare routine',
      reason: `Current skin clarity: ${visionFeatures.skin.clarity}/10`,
      impact: 'high',
      difficulty: 'easy',
      timeframe: '2-4 weeks for visible improvement',
      cost: { min: 30, max: 100, currency: 'USD', frequency: 'monthly' },
    });
  }

  // Haircut if not matching archetype
  items.push({
    priority: 2,
    category: 'hair',
    action: `Get archetype-matched haircut (${archetype.primary.subArchetype} style)`,
    reason: 'Hairstyle should complement face shape and archetype',
    impact: 'high',
    difficulty: 'easy',
    timeframe: 'Immediate',
    cost: { min: 20, max: 80, currency: 'USD', frequency: 'monthly' },
  });

  // Physique if needed
  if (visionFeatures.body && visionFeatures.body.body_fat_percent > 18) {
    items.push({
      priority: 3,
      category: 'physique',
      action: 'Reduce body fat to 12-15% range',
      reason: `Current estimated BF: ${visionFeatures.body.body_fat_percent}%. Lower BF reveals facial definition and hollow cheeks.`,
      impact: 'high',
      difficulty: 'medium',
      timeframe: '3-6 months',
      cost: { min: 0, max: 100, currency: 'USD', frequency: 'monthly' },
    });
  }

  // Style update
  items.push({
    priority: 4,
    category: 'style',
    action: `Adopt ${archetype.primary.subArchetype} wardrobe essentials`,
    reason: 'Clothing should reinforce your natural archetype',
    impact: 'medium',
    difficulty: 'easy',
    timeframe: '1-2 weeks',
    cost: { min: 200, max: 500, currency: 'USD', frequency: 'one-time' },
  });

  // Dental if issues
  if (visionFeatures.teeth.color !== 'white') {
    items.push({
      priority: 5,
      category: 'dental',
      action: 'Whiten teeth',
      reason: `Current tooth color: ${visionFeatures.teeth.color}`,
      impact: 'medium',
      difficulty: 'easy',
      timeframe: '2-4 weeks',
      cost: { min: 30, max: 500, currency: 'USD', frequency: 'one-time' },
    });
  }

  // 2. Enhancement tier (from existing flaws)
  flaws.forEach((flaw, index) => {
    const treatment = findBestTreatment(flaw);
    if (treatment && treatment.phase !== 'Surgical') {
      items.push({
        priority: 10 + index,
        category: treatment.category,
        action: treatment.name,
        reason: flaw.summary,
        impact: treatment.impact > 0.5 ? 'high' : 'medium',
        difficulty: 'medium',
        timeframe: treatment.timeline,
        cost: treatment.cost,
        linkedFlaw: flaw.id,
      });
    }
  });

  // Sort by priority and group into tiers
  const sorted = items.sort((a, b) => a.priority - b.priority);

  return [
    {
      tier: 'foundation',
      items: sorted.filter(i => i.priority <= 5),
      estimatedTimeframe: '1-3 months',
      estimatedCost: sumCosts(sorted.filter(i => i.priority <= 5)),
      potentialPSLGain: 0.5,
    },
    {
      tier: 'enhancement',
      items: sorted.filter(i => i.priority > 5 && i.priority <= 15),
      estimatedTimeframe: '3-6 months',
      estimatedCost: sumCosts(sorted.filter(i => i.priority > 5 && i.priority <= 15)),
      potentialPSLGain: 1.0,
    },
    {
      tier: 'advanced',
      items: sorted.filter(i => i.priority > 15),
      estimatedTimeframe: '6-12 months',
      estimatedCost: sumCosts(sorted.filter(i => i.priority > 15)),
      potentialPSLGain: 0.5,
    },
  ];
}
```

---

## 6. Database Schema

### 6.1 New Tables

```sql
-- Enhanced user profile
ALTER TABLE users ADD COLUMN IF NOT EXISTS height_cm INTEGER;
ALTER TABLE users ADD COLUMN IF NOT EXISTS physique_photo_url TEXT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS psl_tier VARCHAR(20);

-- Vision extractions (cached AI analysis)
CREATE TABLE vision_extractions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Face features
    skin_clarity DECIMAL(3,2),
    skin_tone VARCHAR(50),
    acne_level VARCHAR(20),
    acne_scarring VARCHAR(20),
    pore_visibility VARCHAR(20),
    texture_issues JSONB,

    -- Hair features
    hairline_nw INTEGER,
    hair_density VARCHAR(20),
    hair_texture VARCHAR(20),
    hair_color VARCHAR(50),

    -- Eye features
    eye_color VARCHAR(50),
    under_eye_darkness DECIMAL(3,2),
    under_eye_puffiness DECIMAL(3,2),

    -- Facial features
    hollow_cheeks DECIMAL(3,2),
    eyebrow_density VARCHAR(20),
    facial_hair_potential VARCHAR(20),

    -- Teeth
    teeth_color VARCHAR(20),
    teeth_alignment VARCHAR(20),

    -- Body (if physique photo provided)
    body_fat_percent DECIMAL(4,1),
    muscle_mass VARCHAR(20),
    frame_size VARCHAR(20),
    shoulder_width VARCHAR(20),
    waist_definition VARCHAR(20),
    posture VARCHAR(20),

    -- Metadata
    raw_response JSONB,
    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(analysis_id)
);

-- PSL scores (enhanced)
CREATE TABLE psl_scores (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,

    -- Component scores
    face_score DECIMAL(4,2) NOT NULL,
    height_score DECIMAL(4,2) NOT NULL,
    body_score DECIMAL(4,2),

    -- Bonuses
    threshold_bonus DECIMAL(4,2) DEFAULT 0,
    synergy_bonus DECIMAL(4,2) DEFAULT 0,
    penalties DECIMAL(4,2) DEFAULT 0,

    -- Final
    total_score DECIMAL(4,2) NOT NULL,
    tier VARCHAR(20) NOT NULL,
    percentile DECIMAL(5,2),

    -- Potential
    potential_score DECIMAL(4,2),

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(analysis_id)
);

-- Archetype classifications
CREATE TABLE archetype_results (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,

    -- Primary archetype
    primary_category VARCHAR(50) NOT NULL,
    primary_sub_archetype VARCHAR(50) NOT NULL,
    primary_confidence DECIMAL(3,2) NOT NULL,

    -- Secondary archetype
    secondary_category VARCHAR(50),
    secondary_sub_archetype VARCHAR(50),
    secondary_confidence DECIMAL(3,2),

    -- Details
    traits JSONB,
    style_guide JSONB,
    transition_path JSONB,

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(analysis_id)
);

-- Generated advice
CREATE TABLE advice_results (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,

    -- Recommendations
    hairstyle_recommendations JSONB,
    skincare_routine JSONB,
    style_guide JSONB,
    grooming_guide JSONB,
    action_plan JSONB,

    -- User preferences used
    budget VARCHAR(20),
    timeline VARCHAR(20),
    goals JSONB,

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(analysis_id)
);

-- Indexes
CREATE INDEX idx_vision_extractions_analysis ON vision_extractions(analysis_id);
CREATE INDEX idx_vision_extractions_user ON vision_extractions(user_id);
CREATE INDEX idx_psl_scores_analysis ON psl_scores(analysis_id);
CREATE INDEX idx_psl_scores_user ON psl_scores(user_id);
CREATE INDEX idx_archetype_results_analysis ON archetype_results(analysis_id);
CREATE INDEX idx_advice_results_analysis ON advice_results(analysis_id);
```

---

## 7. API Endpoints

### 7.1 PSL Endpoints

| Endpoint | Method | Auth | Paid | Description |
|----------|--------|------|------|-------------|
| `/psl/calculate` | POST | Yes | No | Calculate PSL from face + height |
| `/psl/calculate-full` | POST | Yes | Yes | Calculate PSL with AI vision + body |
| `/psl/{analysis_id}` | GET | Yes | No | Get stored PSL score |

#### POST /psl/calculate
```json
// Request
{
  "analysis_id": "uuid",
  "height_cm": 180
}

// Response
{
  "score": 6.75,
  "tier": "HTN",
  "percentile": 78.5,
  "breakdown": {
    "face": { "raw": 7.2, "weighted": 5.4 },
    "height": { "raw": 7.0, "weighted": 1.4 },
    "body": { "raw": 5.0, "weighted": 0.25 },
    "bonuses": { "threshold": 0, "synergy": 0, "total": 0 },
    "penalties": 0
  },
  "potential": 7.8
}
```

### 7.2 Vision Endpoints (Paid)

| Endpoint | Method | Auth | Paid | Description |
|----------|--------|------|------|-------------|
| `/vision/extract` | POST | Yes | Yes | Extract features from photos |
| `/vision/extract-body` | POST | Yes | Yes | Analyze physique photo |
| `/vision/{analysis_id}` | GET | Yes | Yes | Get stored vision extraction |

#### POST /vision/extract
```json
// Request
{
  "analysis_id": "uuid",
  "include_body": false
}

// Response
{
  "extraction_id": "uuid",
  "face": {
    "skin": {
      "clarity": 7.5,
      "tone": "medium",
      "acne_level": "mild",
      "acne_scarring": "none",
      "pore_visibility": "visible"
    },
    "hair": {
      "hairline_nw": 1,
      "density": "thick",
      "texture": "wavy",
      "color": "dark-brown"
    },
    "eyes": {
      "color": "brown",
      "under_eye_darkness": 4.5,
      "under_eye_puffiness": 2.0
    },
    "facial_features": {
      "hollow_cheeks": 6.5,
      "eyebrow_density": "thick",
      "facial_hair_potential": "high"
    },
    "teeth": {
      "color": "off-white",
      "alignment": "aligned"
    }
  },
  "body": null
}
```

### 7.3 Archetype Endpoints

| Endpoint | Method | Auth | Paid | Description |
|----------|--------|------|------|-------------|
| `/archetype/classify` | POST | Yes | No* | Classify archetype (enhanced with vision if paid) |
| `/archetype/{analysis_id}` | GET | Yes | No | Get stored archetype |
| `/archetype/styles` | GET | No | No | Get all style guides |

### 7.4 Advice Endpoints (Paid)

| Endpoint | Method | Auth | Paid | Description |
|----------|--------|------|------|-------------|
| `/advice/generate` | POST | Yes | Yes | Generate full advice package |
| `/advice/hairstyles` | GET | Yes | Yes | Get hairstyle recommendations |
| `/advice/skincare` | GET | Yes | Yes | Get skincare routine |
| `/advice/style` | GET | Yes | Yes | Get style guide |
| `/advice/action-plan` | GET | Yes | Yes | Get action plan |
| `/advice/{analysis_id}` | GET | Yes | Yes | Get all stored advice |

#### POST /advice/generate
```json
// Request
{
  "analysis_id": "uuid",
  "preferences": {
    "budget": "medium",
    "timeline": "6mo",
    "goals": ["dating", "confidence"]
  }
}

// Response
{
  "advice_id": "uuid",
  "hairstyles": [...],
  "skincare": {...},
  "style_guide": {...},
  "grooming": {...},
  "action_plan": [...]
}
```

---

## 8. Frontend Components

### 8.1 Component Structure

```
src/components/psl/
├── PSLScoreCard.tsx          # Main score display with tier badge
├── PSLBreakdown.tsx          # Visual breakdown (face/height/body pie)
├── PSLTierBadge.tsx          # Tier icon and name
├── PSLComparison.tsx         # Current vs Potential
├── PSLUpgradePrompt.tsx      # Prompt to unlock AI vision
│
├── archetype/
│   ├── ArchetypeCard.tsx     # Primary archetype display
│   ├── ArchetypeTraits.tsx   # Trait badges
│   ├── ArchetypeComparison.tsx # Primary vs Secondary
│   └── ArchetypeTransition.tsx # Path to next archetype
│
├── advice/
│   ├── HairstyleRecommendations.tsx  # Hairstyle cards with images
│   ├── SkincareRoutine.tsx           # AM/PM routine display
│   ├── StyleGuide.tsx                # Clothing/color recommendations
│   ├── GroomingGuide.tsx             # Facial hair, brows, etc.
│   └── ActionPlan.tsx                # Prioritized improvements
│
└── shared/
    ├── FeatureCard.tsx       # Extracted feature display
    ├── ScoreBar.tsx          # Horizontal score visualization
    ├── TierIcon.tsx          # Tier-specific icons
    └── PaywallOverlay.tsx    # Upgrade prompt overlay
```

### 8.2 Results Tab Integration

```typescript
// Add to ResultsLayout.tsx tabs
const TABS: TabConfig[] = [
  { id: 'overview', label: 'Overview', icon: <LayoutDashboard size={18} /> },
  { id: 'front-ratios', label: 'Front Ratios', icon: <User size={18} /> },
  { id: 'side-ratios', label: 'Side Ratios', icon: <ScanFace size={18} /> },
  { id: 'leaderboard', label: 'Leaderboard', icon: <Trophy size={18} /> },
  { id: 'plan', label: 'Your Plan', icon: <Sparkles size={18} /> },
  // NEW TABS
  { id: 'psl', label: 'PSL Score', icon: <Gauge size={18} />, paid: false },
  { id: 'archetype', label: 'Archetype', icon: <Shapes size={18} />, paid: false },
  { id: 'advice', label: 'AI Advice', icon: <Lightbulb size={18} />, paid: true },
  // EXISTING
  { id: 'options', label: 'Options', icon: <Settings size={18} /> },
  { id: 'support', label: 'Support', icon: <HelpCircle size={18} /> },
];
```

### 8.3 Key Component: PSLScoreCard

```tsx
// PSLScoreCard.tsx
interface PSLScoreCardProps {
  psl: PSLResult;
  showBreakdown?: boolean;
  showPotential?: boolean;
}

export function PSLScoreCard({ psl, showBreakdown = true, showPotential = true }: PSLScoreCardProps) {
  return (
    <div className="bg-zinc-900 rounded-xl p-6 border border-zinc-800">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-xl font-semibold text-white">PSL Rating</h2>
        <PSLTierBadge tier={psl.tier} />
      </div>

      {/* Main Score */}
      <div className="flex items-center gap-6 mb-6">
        <div className="text-6xl font-bold text-cyan-400">
          {psl.score.toFixed(2)}
        </div>
        <div className="text-zinc-400">
          <div className="text-lg">{psl.tier}</div>
          <div className="text-sm">Top {(100 - psl.percentile).toFixed(1)}%</div>
        </div>
      </div>

      {/* Breakdown */}
      {showBreakdown && (
        <PSLBreakdown breakdown={psl.breakdown} />
      )}

      {/* Potential */}
      {showPotential && psl.potential > psl.score && (
        <div className="mt-4 pt-4 border-t border-zinc-800">
          <div className="flex items-center justify-between text-sm">
            <span className="text-zinc-400">Potential with improvements</span>
            <span className="text-green-400 font-semibold">
              {psl.potential.toFixed(2)} (+{(psl.potential - psl.score).toFixed(2)})
            </span>
          </div>
        </div>
      )}
    </div>
  );
}
```

### 8.4 Key Component: ArchetypeCard

```tsx
// ArchetypeCard.tsx
interface ArchetypeCardProps {
  archetype: ArchetypeResult;
  showSecondary?: boolean;
  showTransition?: boolean;
}

export function ArchetypeCard({ archetype, showSecondary = true, showTransition = true }: ArchetypeCardProps) {
  return (
    <div className="bg-zinc-900 rounded-xl p-6 border border-zinc-800">
      {/* Primary Archetype */}
      <div className="flex items-start gap-4 mb-6">
        <div className="w-16 h-16 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
          <ArchetypeIcon archetype={archetype.primary.subArchetype} />
        </div>
        <div>
          <div className="text-sm text-zinc-400 mb-1">Your Archetype</div>
          <div className="text-2xl font-bold text-white">
            {archetype.primary.subArchetype}
          </div>
          <div className="text-sm text-zinc-500">
            {archetype.primary.category} • {(archetype.primary.confidence * 100).toFixed(0)}% match
          </div>
        </div>
      </div>

      {/* Traits */}
      <div className="flex flex-wrap gap-2 mb-6">
        {archetype.traits.map(trait => (
          <span key={trait} className="px-3 py-1 rounded-full bg-zinc-800 text-zinc-300 text-sm">
            {trait}
          </span>
        ))}
      </div>

      {/* Secondary */}
      {showSecondary && archetype.secondary && (
        <div className="p-4 rounded-lg bg-zinc-800/50 mb-4">
          <div className="text-sm text-zinc-400 mb-1">Secondary Match</div>
          <div className="text-lg text-white">
            {archetype.secondary.subArchetype}
            <span className="text-zinc-500 text-sm ml-2">
              ({(archetype.secondary.confidence * 100).toFixed(0)}%)
            </span>
          </div>
        </div>
      )}

      {/* Transition Path */}
      {showTransition && archetype.transitionPath && (
        <div className="p-4 rounded-lg border border-dashed border-zinc-700">
          <div className="text-sm text-zinc-400 mb-2">Transition Potential</div>
          <div className="flex items-center gap-2">
            <span className="text-white">{archetype.primary.subArchetype}</span>
            <ArrowRight className="text-zinc-600" size={16} />
            <span className="text-cyan-400">{archetype.transitionPath.target}</span>
          </div>
          <div className="text-xs text-zinc-500 mt-2">
            Requirements: {archetype.transitionPath.requirements.join(', ')}
          </div>
        </div>
      )}
    </div>
  );
}
```

---

## 9. Implementation Phases

### Phase 1: PSL Foundation (Week 1)
**Priority: Critical**

- [ ] Add `height_cm` to users table
- [ ] Implement height input in onboarding/results
- [ ] Create `psl-calculator.ts` with formula
- [ ] Create `PSLScoreCard`, `PSLBreakdown`, `PSLTierBadge` components
- [ ] Add PSL tab to results page
- [ ] Create `/psl/calculate` endpoint

### Phase 2: Archetype System (Week 2)
**Priority: High**

- [ ] Create `archetypes.json` with full taxonomy
- [ ] Implement `archetype-classifier.ts`
- [ ] Create `archetype_service.py`
- [ ] Create `ArchetypeCard`, `ArchetypeTraits` components
- [ ] Add Archetype tab to results page
- [ ] Create `/archetype/classify` endpoint

### Phase 3: AI Vision Integration (Week 3)
**Priority: High - Paid Feature**

- [ ] Set up Claude API integration
- [ ] Implement `vision_service.py`
- [ ] Create `vision_extractions` table
- [ ] Create `/vision/extract` endpoint
- [ ] Add paywall for AI vision access
- [ ] Display extracted features in UI

### Phase 4: Advice Engine (Week 4)
**Priority: High - Paid Feature**

- [ ] Create `hairstyles.json` database
- [ ] Create `skincare.json` routines
- [ ] Create `style_guides.json`
- [ ] Implement `advice_service.py`
- [ ] Create advice components (`HairstyleRecommendations`, `SkincareRoutine`, etc.)
- [ ] Add Advice tab to results page
- [ ] Create `/advice/*` endpoints

### Phase 5: Action Plan (Week 5)
**Priority: Medium**

- [ ] Implement action plan generation logic
- [ ] Create `ActionPlan` component
- [ ] Integrate with existing recommendations
- [ ] Add cost/timeline estimates
- [ ] Link flaws to specific actions

### Phase 6: Polish & Integration (Week 6)
**Priority: Medium**

- [ ] End-to-end testing
- [ ] Performance optimization
- [ ] Caching for AI calls
- [ ] Error handling
- [ ] Mobile responsiveness
- [ ] Analytics integration

---

## 10. Cost & Pricing

### 10.1 API Costs

| Service | Cost per Call | Usage |
|---------|--------------|-------|
| Claude Vision (face) | ~$0.01-0.02 | Per face extraction |
| Claude Vision (body) | ~$0.01 | Per body extraction |
| Total per user | ~$0.02-0.03 | One-time per analysis |

### 10.2 Suggested Pricing Tiers

| Feature | Free | Pro ($X/mo) | Premium ($Y/mo) |
|---------|------|-------------|-----------------|
| Landmark Analysis | ✓ | ✓ | ✓ |
| Basic PSL (face + height) | ✓ | ✓ | ✓ |
| Archetype (rule-based) | ✓ | ✓ | ✓ |
| AI Vision Extraction | ✗ | ✓ | ✓ |
| Enhanced PSL (with body) | ✗ | ✓ | ✓ |
| Hairstyle Recommendations | ✗ | ✓ | ✓ |
| Skincare Routine | ✗ | ✓ | ✓ |
| Style Guide | ✗ | ✓ | ✓ |
| Action Plan | ✗ | ✓ | ✓ |
| Unlimited Re-analyses | ✗ | ✗ | ✓ |

### 10.3 Margin Analysis

- Cost per paid user: ~$0.03 (one-time AI call)
- If user pays $5/month: 99%+ margin
- If user pays $20 one-time: 99%+ margin
- AI costs are negligible relative to value provided

---

## Appendix A: Halos & Failos Reference

### Halos (Positive Features)

| Halo | Detection Method | Impact |
|------|------------------|--------|
| Hunter Eyes | Landmarks (canthal tilt, deep-set) | High |
| Hollow Cheeks | Vision AI | High |
| Strong Jawline | Landmarks (gonial angle, bigonial) | High |
| Clear Skin | Vision AI | High |
| NW0-1 Hairline | Vision AI | Medium |
| White Teeth | Vision AI | Medium |
| Compact Midface | Landmarks | High |
| Dense Eyebrows | Vision AI | Low |
| Golden/Tanned Skin | Vision AI | Low |

### Failos (Negative Features)

| Failo | Detection Method | Severity |
|-------|------------------|----------|
| Negative Canthal Tilt | Landmarks | Major |
| Receding Chin | Landmarks | Major |
| Long Philtrum | Landmarks | Moderate |
| Severe Acne/Scarring | Vision AI | Major |
| Asymmetry | Landmarks | Moderate-Major |
| NW3+ Hairline | Vision AI | Moderate |
| Scleral Show | Landmarks | Moderate |
| Thin Neck | Landmarks/Vision | Minor |
| Mouth Breathing Signs | Landmarks | Major |
| Narrow Palate | Landmarks | Moderate |

---

## Appendix B: Celebrity Calibration

Use these known ratings for algorithm validation:

| Celebrity | Expected PSL | Archetype | Key Features |
|-----------|--------------|-----------|--------------|
| Francisco Lachowski | 9.0+ | Prettyboy | Perfect harmony, no failos |
| Henry Cavill | 8.5-9.0 | Superman Chad | Strong jaw, dimorphism |
| Ian Somerhalder | 8.0-8.5 | Vampire Chad | Hunter eyes, hollow cheeks |
| Zac Efron (prime) | 8.0-8.5 | Jock Chad | Athletic, symmetrical |
| Timothée Chalamet | 7.5-8.0 | Softboy | Harmony, low dimorphism |
| Josh Hutcherson | 5.5-6.0 | HTN | Average height limits ceiling |
| Average man | 5.0 | MTN | By definition |

---

## Appendix C: File Paths Summary

### Backend (looksmaxx-api)

```
app/
├── services/
│   ├── psl_service.py           # NEW
│   ├── vision_service.py        # NEW
│   ├── archetype_service.py     # NEW
│   └── advice_service.py        # NEW
├── routers/
│   ├── psl.py                   # NEW
│   ├── vision.py                # NEW
│   └── advice.py                # NEW
├── models/
│   ├── vision_extraction.py     # NEW
│   ├── psl_score.py             # NEW
│   ├── archetype_result.py      # NEW
│   └── advice_result.py         # NEW
└── data/
    ├── archetypes.json          # NEW
    ├── hairstyles.json          # NEW
    ├── skincare.json            # NEW
    └── style_guides.json        # NEW
```

### Frontend (looksmaxx-app)

```
src/
├── components/
│   └── psl/                     # NEW (entire folder)
├── contexts/
│   └── PSLContext.tsx           # NEW
├── lib/
│   ├── psl-calculator.ts        # NEW
│   └── archetype-classifier.ts  # NEW
└── types/
    └── psl.ts                   # NEW
```

---

*Document Version: 1.0*
*Last Updated: 2025-01-XX*
*Author: LOOKSMAXX Team*
