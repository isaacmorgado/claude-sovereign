# Security Audit

Perform a comprehensive security audit of this codebase covering all critical security areas.

## 1. Pre-Production Security Audit

Do a security audit of this codebase. Check for:
1. Hardcoded secrets (API keys, passwords, tokens)
2. Environment variables that might leak to the client
3. SQL injection vulnerabilities
4. XSS (cross-site scripting) vulnerabilities
5. Missing authentication on sensitive endpoints
6. Missing input validation
7. Exposed debug routes or admin panels
8. Insecure dependencies with known vulnerabilities

For each issue found, tell me: what the problem is, where it is, how severe it is (critical/high/medium/low), and how to fix it.

## 2. Environment Variable Handling

Check my environment variable handling:
1. Is .env in .gitignore?
2. Are any secrets prefixed with NEXT_PUBLIC_, VITE_, or REACT_APP_? (These expose to client)
3. Are any secrets hardcoded in the source code?
4. Are environment variables being logged anywhere?
5. Is there a .env.example file showing what variables are needed (without actual values)?

Fix any issues you find.

## 3. Client-Side Secret Exposure

Audit my codebase for client-side secret exposure:
1. Find all environment variables prefixed with NEXT_PUBLIC_, REACT_APP_, or VITE_
2. Check if any of these are actual secrets (API keys, tokens, passwords)
3. If yes, these are exposed to the client - show me how to move them server-side
4. Create a list of which variables are safe for client vs must stay server-only

## 4. Git History Secrets Check

Search the git history for accidentally committed secrets:
1. Run: git log -p | grep -i "api_key\|apikey\|secret\|password\|token\|credential"
2. Check if any .env files were ever committed
3. Look for any hardcoded keys that were later removed

If you find exposed secrets, tell me which ones need to be rotated (get new keys and invalidate old ones).

## 5. Authentication Audit

Audit authentication across all API routes:
1. List every API endpoint in this project
2. For each endpoint, state:
   - Does it currently require authentication?
   - SHOULD it require authentication?
3. Flag any endpoints that are unprotected but should be protected
4. Show me how to add authentication to the unprotected routes

## 6. Authorization Audit

Audit authorization across all API routes:
1. Find all endpoints that access user-specific data
2. For each one, check: Does it verify the requesting user owns/has access to this data?
3. Can User A access User B's data by changing an ID?
4. Are admin-only routes properly restricted?
5. Fix any authorization gaps you find

## 7. Input Validation Check

Check input validation across the codebase:
1. Find all places where user input is accepted (forms, API endpoints, URL parameters)
2. For each one, check: Is the input validated? Is it sanitized before use?
3. Are file uploads checking file type and size?
4. Is user input ever directly used in database queries or HTML output?

Add proper validation where it's missing.

## 8. SQL Injection Check

Check this codebase for SQL injection vulnerabilities:
1. Find all database queries
2. Check if any use string concatenation or template literals with user input
3. Convert vulnerable queries to parameterized queries / prepared statements
4. Show me before and after for each fix

## 9. XSS Vulnerability Check

Check this codebase for XSS vulnerabilities:
1. Find all places where user input is displayed in HTML
2. Check if the output is properly escaped
3. Look for dangerous patterns: innerHTML, dangerouslySetInnerHTML, v-html
4. Fix any unescaped output

## 10. Dependency Vulnerability Check

Run npm audit (or yarn audit) to check for vulnerable dependencies. For each vulnerability:
1. Tell me what it is and how severe
2. Is there a patched version available?
3. If yes, update the package
4. If no patch exists, is there a workaround or alternative package?

Prioritize critical and high severity issues.

## 11. Database Security Audit

Audit database security:
1. Is the database only accessible from my application servers (not the public internet)?
2. Are we using parameterized queries/prepared statements for all database operations?
3. Are passwords hashed (not stored as plain text)?
4. Is sensitive data (SSNs, credit cards, etc.) encrypted?
5. Are database credentials strong and unique?

Fix any issues.

## 12. Information Leakage Check

Check for information leakage:
1. Are detailed error messages/stack traces shown in production?
2. Do API responses include unnecessary fields (like password hashes, internal IDs)?
3. Are there any debug routes or endpoints that should be removed?
4. Are source maps being deployed to production?
5. Is the server revealing its software version in headers?

Fix any issues.

## 13. API Response Security

Audit API responses for information leakage:
1. For each endpoint, check what data is returned
2. Flag any sensitive fields being returned (password hashes, internal IDs, etc.)
3. Are error messages revealing internal details?
4. Create response DTOs that only include necessary fields
5. Standardize error responses to not leak information

## 14. Rate Limiting Check

Add rate limiting to this API:
1. Identify sensitive endpoints (login, signup, password reset, data-heavy queries)
2. Add rate limiting - suggested limits:
   - Login: 5 attempts per minute per IP
   - Signup: 10 per hour per IP
   - General API: 100 per minute per user
3. Return 429 Too Many Requests with Retry-After header when limited
4. Log rate limit violations for monitoring

## 15. CORS Configuration

Configure CORS properly for this API:
1. What origins should be allowed? (my frontend domain only)
2. What methods should be allowed? (GET, POST, PUT, DELETE as needed)
3. What headers should be allowed?
4. Set up CORS to only allow my frontend, not the whole internet
5. Make sure credentials (cookies) are handled correctly

## 16. Security Headers

Add security headers to all API responses:
1. Add X-Content-Type-Options: nosniff
2. Add X-Frame-Options: DENY (or SAMEORIGIN if needed)
3. Add X-XSS-Protection: 1; mode=block
4. Consider Content-Security-Policy based on what the API needs
5. Add Strict-Transport-Security for HTTPS enforcement

Show me where to configure these (middleware, server config, etc.)

## 17. File Upload Security

Audit file upload security:
1. Find all file upload functionality
2. Check what validations are in place:
   - File type validation (by content, not just extension)
   - File size limits
   - Filename sanitization
3. Where are uploads stored? Are they executable?
4. Add missing protections

## 18. Path Traversal Check

Check for path traversal vulnerabilities:
1. Find all places where user input is used in file paths
2. Check if input is validated to prevent ../ attacks
3. Verify paths are constrained to expected directories
4. Add validation to prevent path traversal

## 19. Security Logging

Set up security logging for this API:
1. Log failed login attempts with IP address
2. Log authorization failures (user tried to access something they shouldn't)
3. Log rate limit violations
4. Make sure passwords and secrets are NEVER logged
5. Show me how to query these logs to spot attacks

## 20. HTTPS and Security Headers Check

Check HTTPS and security headers:
1. Is HTTPS enforced? (HTTP should redirect to HTTPS)
2. Is HSTS (HTTP Strict Transport Security) enabled?
3. Are these security headers set:
   - Content-Security-Policy
   - X-Content-Type-Options
   - X-Frame-Options
   - X-XSS-Protection

If not, add them. Show me the configuration.

---

## Quick Security Checklist

After completing the audit, verify:

**Secrets:**
- [ ] No hardcoded API keys or passwords
- [ ] .env is in .gitignore
- [ ] Client-side code doesn't have access to server secrets
- [ ] Git history doesn't contain secrets

**Authentication:**
- [ ] All sensitive routes require auth
- [ ] Users can't access other users' data
- [ ] Admin functions are protected

**Input:**
- [ ] All user input is validated
- [ ] Database queries use parameterized statements
- [ ] HTML output is escaped to prevent XSS

**Production:**
- [ ] Debug mode is off
- [ ] Error messages don't leak details
- [ ] HTTPS is enforced
- [ ] Dependencies are updated
