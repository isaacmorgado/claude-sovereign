# LOOKSMAXX - FaceIQ Parity Fixes

## Session Date: 2025-12-20

## Current State Summary

### What's Complete
- [x] Core exponential decay scoring formula (exact match)
- [x] Bezier curve interpolation with Newton-Raphson
- [x] Updated all metric ideal ranges to match FaceIQ exactly
- [x] Updated maxScore weights (2.5-30 scale)
- [x] Results page layout with 6 tabs
- [x] Surgery database (100+ procedures in `hardmaxxing.ts`)
- [x] Softmaxxing treatments database
- [x] Non-surgical treatments database
- [x] Supplements database
- [x] TypeScript compilation passing

### What's Complete (Added 2025-12-20)
- [x] InsightFace on Railway - FIXED! detection_ready: true
- [x] Detailed flaw mappings for 28 metrics (METRIC_FLAW_MAPPINGS)
- [x] Custom Bezier curves for 5 key metrics (METRIC_CUSTOM_CURVES)

---

## Gaps to Fix (FaceIQ Parity)

### 1. Detailed Flaw Mappings Per Metric [HIGH PRIORITY]

**Current:** Basic string arrays like `["Wide face", "Long midface"]`

**FaceIQ Format:**
```typescript
interface FlawMapping {
  category: string;           // "Occlusion/Jaw Growth"
  flawName: string;           // "Hyper-divergent jaw growth"
  confidence: 'confirmed' | 'likely' | 'possible';
  actualValue: string;        // "38.05%"
  idealRange: string;         // "31-33.5%"
  deviation: string;          // "4.55% above ideal"
  score: number;              // 0.19
  severity: 'extremely severe' | 'severe' | 'major' | 'moderate' | 'minor';
  reasoning: string;          // AI-generated explanation
  isUnlocked: boolean;
}
```

**Example from FaceIQ (Lower Third Proportion at 38.05%):**
```json
{
  "mayIndicateFlaws": [
    {
      "category": "Occlusion/Jaw Growth",
      "flawName": "Hyper-divergent jaw growth",
      "confidence": "confirmed",
      "actualValue": "38.05%",
      "idealRange": "31-33.5%",
      "deviation": "4.55% above ideal",
      "score": 0.19,
      "severity": "extremely severe",
      "reasoning": "The upper jaw is too long relative to lower jaw, possibly from a long upper jaw or short lower jaw, or a combination of both. This disrupts facial harmony by elongating the lower face."
    },
    {
      "category": "Jaw Shape",
      "flawName": "Disproportionate lower face (short chin or long philtrum)",
      "confidence": "confirmed",
      ...
    },
    {
      "category": "Midface/Face Shape",
      "flawName": "Long upper jaw",
      "confidence": "confirmed",
      ...
    },
    {
      "category": "Midface/Face Shape",
      "flawName": "Short lower jaw",
      "confidence": "confirmed",
      ...
    }
  ]
}
```

**Files to modify:**
- `src/lib/faceiq-scoring.ts` - Add FLAW_MAPPINGS constant
- `src/contexts/ResultsContext.tsx` - Update `getFlawStrengthMappings()` function
- `src/types/results.ts` - Add FlawMapping interface

---

### 2. Custom Bezier Curves for ALL Metrics [HIGH PRIORITY]

**Current:** Only `totalFacialWidthToHeight` has custom curves

**FaceIQ Format:** 12 control points with Bezier handles per metric
```typescript
interface CurvePoint {
  x: number;
  y: number;
  leftHandleX?: number;
  leftHandleY?: number;
  rightHandleX?: number;
  rightHandleY?: number;
  fixed?: boolean;
}

interface CurveConfig {
  mode: 'custom' | 'exponential';
  customPoints?: CurvePoint[];
  idealMin: number;
  idealMax: number;
  maxScore: number;
  chartRange: { min: number; max: number };
  decayRate?: number;
}
```

**Example from FaceIQ (Lower Third Proportion):**
```json
{
  "customPoints": [
    {"x": 25.6, "y": 0, "leftHandleX": 24.8, "leftHandleY": 0, "rightHandleX": 26.4, "rightHandleY": 0},
    {"x": 28.01, "y": 1.58, "leftHandleX": 27.23, "leftHandleY": 0.53, "rightHandleX": 28.27, "rightHandleY": 1.97},
    {"x": 28.83, "y": 3.21, ...},
    {"x": 29.63, "y": 5.85, ...},
    {"x": 30.27, "y": 8.56, ...},
    {"x": 31, "y": 10, "fixed": true},
    {"x": 33.5, "y": 10, "fixed": true},
    {"x": 34.23, "y": 8.56, ...},
    {"x": 34.87, "y": 5.85, ...},
    {"x": 35.67, "y": 3.21, ...},
    {"x": 36.49, "y": 1.58, ...},
    {"x": 38.9, "y": 0, ...}
  ]
}
```

**Files to modify:**
- `src/lib/faceiq-scoring.ts` - Add `customCurve` to each metric in FACEIQ_METRICS

**Data source:** Extract from `/Users/imorgado/Desktop/FACEIQCOPY/FACEIQPAID/FACEIQ-FRONT RATIOS.html`

---

### 3. Enhanced Illustration Configs [MEDIUM PRIORITY]

**Current:** Basic configs for ~8 metrics

**FaceIQ Format:**
```typescript
interface IllustrationConfig {
  points: Record<string, {
    type: 'landmark' | 'calculated';
    x?: number;
    y?: number;
  }>;
  lines: Array<{
    from: string;
    to: string;
    label: string;
    color: string;
    labelColor: string;
    labelPosition: 'left' | 'right' | 'top' | 'bottom';
  }>;
}
```

**Files to modify:**
- `src/contexts/ResultsContext.tsx` - Expand `generateIllustration()` function

---

### 4. Improved Flaw-to-Treatment Matching [MEDIUM PRIORITY]

**Current:** Basic keyword matching in `generateRecommendations()`

**Target:**
- Use metric scores to prioritize treatments
- Match specific flaws to specific procedures
- Calculate expected improvement percentages

**Files to modify:**
- `src/contexts/ResultsContext.tsx` - `generateRecommendations()` function
- `src/lib/recommendations/severity.ts` - Enhance `getTreatmentIdsForMetric()`

---

### 5. Severity Display Enhancement [MEDIUM PRIORITY]

**Current:** 5-tier but not prominently displayed

**Target:** Show severity badges like FaceIQ:
- "Extremely Severe" (red)
- "Severe" (orange)
- "Major" (yellow)
- "Moderate" (light yellow)
- "Minor" (gray)

**Files to modify:**
- `src/components/results/cards/StrengthFlawCards.tsx`
- `src/types/results.ts` - Add severity color mapping

---

### 6. Railway InsightFace Deployment [BLOCKED]

**Current Error:** `Unable to import dependency onnxruntime`

**Changes Ready (not yet pushed):**
- `looksmaxx-api/Dockerfile`: python:3.11-bookworm base, added cmake & libopenblas-dev
- `looksmaxx-api/requirements.txt`: onnxruntime-cpu==1.16.3

**To deploy:**
```bash
cd /Users/imorgado/LOOKSMAXX/looksmaxx-api
git add Dockerfile requirements.txt
git commit -m "Fix onnxruntime: use bookworm base + onnxruntime-cpu 1.16.3"
git push
```

---

### 7. AI-Generated Descriptions [LOW PRIORITY]

**Current:** Static descriptions per metric

**Target:** Add `aiDescription` field with personalized explanations based on the user's actual values

---

### 8. Decay Curve Charts [LOW PRIORITY]

**Current:** Not implemented

**Target:** Visualize the scoring curve showing where user's value falls

---

### 9. Potential Score Calculations [LOW PRIORITY]

**Current:** Basic in Plan tab

**Target:** "Your score could be X with treatment Y" with projected improvements

---

## File Locations

### Key Files to Modify
```
src/lib/faceiq-scoring.ts          # Scoring configs, ideal ranges, curves
src/contexts/ResultsContext.tsx     # Data transformation, flaw mappings
src/types/results.ts                # Type definitions
src/lib/recommendations/severity.ts # Flaw-to-treatment mapping
src/components/results/cards/       # UI components for flaws/strengths
```

### FaceIQ Reference Data
```
/Users/imorgado/Desktop/FACEIQCOPY/FACEIQPAID/
├── FACEIQ-FRONT RATIOS.html   # Front profile metrics with curves
├── FACEIQ-SIDERATIOS.html     # Side profile metrics
├── FACEIQ-ALL.har             # API calls with full response data
├── FACEIQALL-HTML.html        # Full page capture
└── site-capture-*.json        # Additional capture data
```

---

## Metrics Updated This Session

### Front Profile (Updated ideal ranges + maxScores)
| Metric | New Ideal | maxScore |
|--------|-----------|----------|
| Face Width to Height | 1.96-2.0 | 30 |
| Middle Third | 31.4-33.4% | 10 |
| Upper Third | 30-32% | 10 |
| Cheekbone Height | 83-100% | 15 |
| Midface Ratio | 0.97-1.0 | 12.5 |
| Jaw Frontal Angle | 86.5-92.5° | 20 |
| Bigonial Width | 87.75-91.75% | 15 |
| Lateral Canthal Tilt | 6.1-7.8° | 10 |
| Eye Aspect Ratio | 3.0-3.5 | 15 |
| Eye Separation | 45.7-46.8% | 10 |
| IPD-Mouth Ratio | 0.83-0.87 | 10 |
| Eyebrow Tilt | 6.5-11° | 10 |
| Eyebrow Low Setedness | 0-0.45 | 10 |
| Intercanthal-Nasal | 1.04-1.16 | 10 |
| Nose Tip Position | 0.5-3.5mm | 2.5 |
| Mouth/Nose Ratio | 1.43-1.51 | 10 |
| Lower/Upper Lip | 1.58-1.88 | 7.5 |
| Chin/Philtrum | 2.15-2.45 | 12.5 |
| IAA-JFA Deviation | 0-2.5° | 10 |
| Neck Width | 92-98% | 10 |

### Side Profile (Updated ideal ranges)
| Metric | New Ideal |
|--------|-----------|
| Nasofrontal Angle | 116-128° |
| Nasofacial Angle | 31-35° |
| Nasomental Angle | 126-131° |
| Submental Cervical | 94-106° |
| Facial Depth/Height | 1.3-1.44 |
| Anterior Facial Depth | 64.5-67.5° |
| S-Line Lower Lip | -0.4 to 0.4mm |

### New Metrics Added
- Ipsilateral Alar Angle (front)
- Ear Protrusion Angle (front)
- Ear Protrusion Ratio (front)
- Interior Midface Projection Angle (side)
- Recession from Frankfort Plane (side)

---

## Commands Reference

### Run Type Check
```bash
cd /Users/imorgado/LOOKSMAXX/looksmaxx-app && npx tsc --noEmit
```

### Run Lint
```bash
cd /Users/imorgado/LOOKSMAXX/looksmaxx-app && npm run lint
```

### Extract FaceIQ Data
```bash
# Extract metric configs from HTML
cat "/Users/imorgado/Desktop/FACEIQCOPY/FACEIQPAID/FACEIQ-FRONT RATIOS.html" | sed 's/\\"/"/g' | grep -oE '"name":"[^"]+","value":[0-9.-]+.*?"idealMax":[0-9.-]+'

# Extract flaw mappings
cat "/Users/imorgado/Desktop/FACEIQCOPY/FACEIQPAID/FACEIQ-FRONT RATIOS.html" | sed 's/\\"/"/g' | grep -oE '"mayIndicateFlaws":\[\{[^]]+'

# Extract custom curves
cat "/Users/imorgado/Desktop/FACEIQCOPY/FACEIQPAID/FACEIQ-FRONT RATIOS.html" | sed 's/\\"/"/g' | grep -oE '"customPoints":\[[^\]]+\]'
```

---

## Continuation Prompt

Use this prompt to continue this work:

```
Continue work on LOOKSMAXX FaceIQ parity. Read /Users/imorgado/LOOKSMAXX/fixit.md for context.

Current priorities:
1. Add detailed FLAW_MAPPINGS to faceiq-scoring.ts with FaceIQ's structure (category, flawName, confidence, severity, reasoning)
2. Extract and add custom Bezier curves for all metrics from the FaceIQ HTML files
3. Update ResultsContext.tsx to use the new flaw mappings

Reference data is in /Users/imorgado/Desktop/FACEIQCOPY/FACEIQPAID/

Start with the flaw mappings - extract them from FACEIQ-FRONT RATIOS.html and create a comprehensive FLAW_MAPPINGS constant.
```
