#!/bin/bash
# Forum E2E Test Script
# Run this after deploying the forum feature to Railway

API_URL="${API_URL:-https://api-production-6148.up.railway.app}"
AUTH_TOKEN=""  # Set this to a valid JWT token for authenticated tests

echo "=========================================="
echo "FORUM E2E TEST SUITE"
echo "API: $API_URL"
echo "=========================================="
echo ""

PASS=0
FAIL=0

test_endpoint() {
    local method=$1
    local endpoint=$2
    local expected_status=$3
    local description=$4
    local auth=$5
    local data=$6

    local headers="-H 'Content-Type: application/json'"
    if [ "$auth" = "true" ] && [ -n "$AUTH_TOKEN" ]; then
        headers="$headers -H 'Authorization: Bearer $AUTH_TOKEN'"
    fi

    local cmd="curl -s -w '%{http_code}' -o /tmp/response.json"
    if [ "$method" = "POST" ]; then
        cmd="$cmd -X POST -d '$data'"
    elif [ "$method" = "DELETE" ]; then
        cmd="$cmd -X DELETE"
    fi
    cmd="$cmd $headers '$API_URL$endpoint'"

    status=$(eval $cmd)
    body=$(cat /tmp/response.json 2>/dev/null)

    if [ "$status" = "$expected_status" ]; then
        echo "✓ PASS: $description (HTTP $status)"
        PASS=$((PASS + 1))
    else
        echo "✗ FAIL: $description (Expected $expected_status, got $status)"
        echo "  Response: $body"
        FAIL=$((FAIL + 1))
    fi
}

echo "=== PUBLIC ENDPOINTS (No Auth Required) ==="
echo ""

# Categories
test_endpoint "GET" "/forum/categories" "200" "List all categories" "false"
echo "  Checking response structure..."
categories=$(cat /tmp/response.json)
category_count=$(echo "$categories" | jq 'length')
if [ "$category_count" = "12" ]; then
    echo "  ✓ Found 12 categories"
else
    echo "  ✗ Expected 12 categories, found $category_count"
fi

# Single category
test_endpoint "GET" "/forum/categories/weak-bone-structure" "200" "Get single category by slug" "false"

# Category not found
test_endpoint "GET" "/forum/categories/nonexistent" "404" "Category not found" "false"

# Guides section
test_endpoint "GET" "/forum/guides" "200" "Get guides section" "false"

# Recommended forums based on flaws
test_endpoint "GET" "/forum/recommended?flaws=weak_jaw,recessed_chin" "200" "Get recommended forums" "false"
recommended=$(cat /tmp/response.json)
rec_count=$(echo "$recommended" | jq 'length')
if [ "$rec_count" -gt "0" ]; then
    echo "  ✓ Got recommendations for flaws"
else
    echo "  ✗ No recommendations returned"
fi

# Posts in category (empty initially)
test_endpoint "GET" "/forum/categories/weak-bone-structure/posts" "200" "List posts in category" "false"

echo ""
echo "=== AUTHENTICATED ENDPOINTS (Require Auth) ==="
echo ""

if [ -n "$AUTH_TOKEN" ]; then
    # Get a sub-forum ID first
    sf_id=$(curl -s "$API_URL/forum/categories" | jq -r '.[0].sub_forums[0].id')

    # Create post
    test_endpoint "POST" "/forum/posts" "201" "Create new post" "true" '{"title":"Test Post Title","content":"This is test content for the forum post.","sub_forum_id":"'"$sf_id"'"}'
    post_id=$(cat /tmp/response.json | jq -r '.id')

    if [ "$post_id" != "null" ] && [ -n "$post_id" ]; then
        # Get post
        test_endpoint "GET" "/forum/posts/$post_id" "200" "Get created post" "false"

        # Vote on post
        test_endpoint "POST" "/forum/posts/$post_id/vote" "200" "Upvote post" "true" '{"vote_type":"up"}'

        # Create comment
        test_endpoint "POST" "/forum/posts/$post_id/comments" "201" "Create comment" "true" '{"content":"This is a test comment"}'
        comment_id=$(cat /tmp/response.json | jq -r '.id')

        if [ "$comment_id" != "null" ] && [ -n "$comment_id" ]; then
            # Vote on comment
            test_endpoint "POST" "/forum/comments/$comment_id/vote" "200" "Upvote comment" "true" '{"vote_type":"up"}'
        fi

        # Get comments
        test_endpoint "GET" "/forum/posts/$post_id/comments" "200" "Get post comments" "false"

        # Report post
        test_endpoint "POST" "/forum/reports" "201" "Report post" "true" '{"target_type":"post","target_id":"'"$post_id"'","reason":"spam"}'

        # Delete post (cleanup)
        test_endpoint "DELETE" "/forum/posts/$post_id" "200" "Delete test post" "true"
    fi
else
    echo "⚠ Skipping authenticated tests - no AUTH_TOKEN set"
    echo "  To run authenticated tests, set AUTH_TOKEN environment variable"
fi

echo ""
echo "=== MODERATION ENDPOINTS (Require Moderator Role) ==="
echo ""

if [ -n "$AUTH_TOKEN" ]; then
    echo "  Note: These tests require a user with moderator/admin role"
    # These would fail without proper role, but we test the auth check works
    test_endpoint "GET" "/forum/reports" "403" "List reports (requires mod)" "true"
else
    echo "⚠ Skipping moderation tests - no AUTH_TOKEN set"
fi

echo ""
echo "=========================================="
echo "TEST SUMMARY"
echo "=========================================="
echo "Passed: $PASS"
echo "Failed: $FAIL"
echo ""

if [ $FAIL -eq 0 ]; then
    echo "✓ All tests passed!"
    exit 0
else
    echo "✗ Some tests failed"
    exit 1
fi
