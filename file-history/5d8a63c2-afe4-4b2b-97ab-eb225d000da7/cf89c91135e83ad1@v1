-- Migration: Create forum tables
-- Date: 2025-12-25
-- Description: Personalized forum with 12 issue categories, 44 sub-forums, flaw mappings

-- Add role column to users for moderation
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'userrole') THEN
        CREATE TYPE userrole AS ENUM ('user', 'moderator', 'admin');
    END IF;
END $$;

ALTER TABLE users ADD COLUMN IF NOT EXISTS role userrole DEFAULT 'user';

-- Create enum types
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'votetype') THEN
        CREATE TYPE votetype AS ENUM ('up', 'down');
    END IF;
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'targettype') THEN
        CREATE TYPE targettype AS ENUM ('post', 'comment');
    END IF;
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'reportstatus') THEN
        CREATE TYPE reportstatus AS ENUM ('pending', 'reviewed', 'resolved', 'dismissed');
    END IF;
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'reportreason') THEN
        CREATE TYPE reportreason AS ENUM ('spam', 'harassment', 'misinformation', 'off_topic', 'inappropriate', 'other');
    END IF;
END $$;

-- ============== ISSUE CATEGORIES (12 main categories) ==============
CREATE TABLE IF NOT EXISTS forum_issue_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL UNIQUE,
    slug VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    icon VARCHAR(10),
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_issue_categories_slug ON forum_issue_categories(slug);
CREATE INDEX IF NOT EXISTS idx_issue_categories_order ON forum_issue_categories(display_order);

-- Insert 12 issue categories
INSERT INTO forum_issue_categories (name, slug, description, icon, display_order) VALUES
    ('Skinny/Fat (Body Composition)', 'body-composition', 'Improve your physique through nutrition, training, and body recomposition', 'üí™', 1),
    ('Weak Bone Structure', 'weak-bone-structure', 'Improve your jaw, facial structure, and bone development', 'ü¶¥', 2),
    ('Poor Skin Complexion', 'poor-skin', 'Clear skin through nutrition, skincare routines, and treatments', '‚ú®', 3),
    ('Teeth/Smile Issues', 'teeth-smile', 'Perfect your smile with dental care and orthodontics', 'üòÅ', 4),
    ('Weak Eye Area', 'weak-eyes', 'Enhance your eye area appearance and expression', 'üëÅÔ∏è', 5),
    ('Short Height/Narrow Frame', 'height-frame', 'Maximize your height potential and frame development', 'üìè', 6),
    ('Bloated/Face Fat', 'face-fat', 'Reduce facial bloating and achieve a leaner face', 'üíß', 7),
    ('Poor Fashion Sense', 'fashion', 'Develop your personal style and wardrobe', 'üëî', 8),
    ('Hair Thinning/Recession', 'hair-loss', 'Combat hair loss and optimize your hairstyle', 'üíá', 9),
    ('Narrow/Thin Lips', 'thin-lips', 'Enhance lip fullness and appearance', 'üëÑ', 10),
    ('Anxiety/High Inhibition', 'anxiety', 'Build confidence and overcome social barriers', 'üß†', 11),
    ('Low Social Media Presence', 'social-media', 'Build your online presence and social proof', 'üì±', 12)
ON CONFLICT (slug) DO NOTHING;

-- ============== SUB-FORUMS (44 sub-forums) ==============
CREATE TABLE IF NOT EXISTS forum_sub_forums (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    issue_category_id UUID NOT NULL REFERENCES forum_issue_categories(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(50) NOT NULL,
    description TEXT,
    icon VARCHAR(10),
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(issue_category_id, slug)
);

CREATE INDEX IF NOT EXISTS idx_subforums_category ON forum_sub_forums(issue_category_id);

-- Body Composition sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='body-composition'), 'Nutrition', 'nutrition', 'Diet plans, macros, and eating strategies', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='body-composition'), 'Training', 'training', 'Workout routines and exercise programs', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='body-composition'), 'Pharma', 'pharma', 'Supplements and performance enhancers', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='body-composition'), 'Frame', 'frame', 'Building a wider, more imposing frame', 4)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Weak Bone Structure sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 'Teeth', 'teeth', 'Orthodontics and dental alignment', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 'Jawline', 'jawline', 'Mewing, jaw exercises, and jaw development', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 'Sculpting', 'sculpting', 'Facial sculpting techniques and masseter work', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 'Surgery', 'surgery', 'Jaw surgery, implants, and surgical options', 4)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Poor Skin sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='poor-skin'), 'Nutrition', 'nutrition', 'Diet for clear skin', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='poor-skin'), 'Skincare', 'skincare', 'Routines, products, and treatments', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='poor-skin'), 'Pharma', 'pharma', 'Accutane, retinoids, and medical treatments', 3)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Teeth/Smile sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='teeth-smile'), 'Teeth', 'teeth', 'Whitening, veneers, and dental care', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='teeth-smile'), 'Surgery', 'surgery', 'Jaw surgery for bite correction', 2)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Weak Eyes sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 'Eyebrows', 'eyebrows', 'Eyebrow shaping and enhancement', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 'Eyelashes', 'eyelashes', 'Lash growth and enhancement', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 'Eyes', 'eyes', 'Eye area improvement techniques', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 'Aesthetics', 'aesthetics', 'Non-surgical eye enhancements', 4),
    ((SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 'Surgery', 'surgery', 'Blepharoplasty and canthopexy', 5)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Height/Frame sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='height-frame'), 'Frame', 'frame', 'Shoulder and frame development', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='height-frame'), 'Biohacking', 'biohacking', 'Growth optimization strategies', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='height-frame'), 'Pharma', 'pharma', 'HGH and growth-related compounds', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='height-frame'), 'Surgery', 'surgery', 'Limb lengthening surgery', 4)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Face Fat sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='face-fat'), 'Nutrition', 'nutrition', 'Diet for facial leanness', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='face-fat'), 'Sculpting', 'sculpting', 'Facial exercises and massage', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='face-fat'), 'Surgery', 'surgery', 'Buccal fat removal and liposuction', 3)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Fashion sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='fashion'), 'Archetype', 'archetype', 'Finding your style archetype', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='fashion'), 'Styling', 'styling', 'Outfit building and coordination', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='fashion'), 'Appeal', 'appeal', 'Maximizing visual attraction', 3)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Hair Loss sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='hair-loss'), 'Hairstyle', 'hairstyle', 'Styling for thinning hair', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='hair-loss'), 'Pharma', 'pharma', 'Finasteride, minoxidil, and treatments', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='hair-loss'), 'Surgery', 'surgery', 'Hair transplants and restoration', 3)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Thin Lips sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='thin-lips'), 'Lips', 'lips', 'Lip care and natural enhancement', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='thin-lips'), 'Aesthetics', 'aesthetics', 'Lip fillers and injectables', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='thin-lips'), 'Surgery', 'surgery', 'Lip lift and surgical options', 3)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Anxiety sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='anxiety'), 'Charisma', 'charisma', 'Building social confidence', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='anxiety'), 'Aesthetics', 'aesthetics', 'Looking confident through appearance', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='anxiety'), 'Mindset', 'mindset', 'Mental strategies for overcoming inhibition', 3)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- Social Media sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='social-media'), 'Charisma', 'charisma', 'On-camera presence', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='social-media'), 'Appeal', 'appeal', 'Photo and video optimization', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='social-media'), 'Frauding', 'frauding', 'Angles, lighting, and photo techniques', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='social-media'), 'Dynamics', 'dynamics', 'Building engagement and following', 4)
ON CONFLICT (issue_category_id, slug) DO NOTHING;

-- ============== FLAW TO FORUM MAPPING ==============
CREATE TABLE IF NOT EXISTS flaw_to_forum_mapping (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    flaw_id VARCHAR(100) NOT NULL,
    issue_category_id UUID NOT NULL REFERENCES forum_issue_categories(id) ON DELETE CASCADE,
    priority INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(flaw_id, issue_category_id)
);

CREATE INDEX IF NOT EXISTS idx_flaw_mapping_flaw ON flaw_to_forum_mapping(flaw_id);

-- Weak Bone Structure mappings
INSERT INTO flaw_to_forum_mapping (flaw_id, issue_category_id, priority) VALUES
    ('weak_jaw', (SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 1),
    ('narrow_jaw', (SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 1),
    ('recessed_chin', (SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 1),
    ('mandibular_recession', (SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 1),
    ('steep_mandibular_plane', (SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 2),
    ('steep_jaw', (SELECT id FROM forum_issue_categories WHERE slug='weak-bone-structure'), 2)
ON CONFLICT (flaw_id, issue_category_id) DO NOTHING;

-- Weak Eye Area mappings
INSERT INTO flaw_to_forum_mapping (flaw_id, issue_category_id, priority) VALUES
    ('negative_canthal_tilt', (SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 1),
    ('small_eyes', (SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 1),
    ('low_set_eyebrows', (SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 1),
    ('wide_set_eyes', (SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 2),
    ('close_set_eyes', (SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 2),
    ('soft_brow_ridge', (SELECT id FROM forum_issue_categories WHERE slug='weak-eyes'), 2)
ON CONFLICT (flaw_id, issue_category_id) DO NOTHING;

-- Thin Lips mappings
INSERT INTO flaw_to_forum_mapping (flaw_id, issue_category_id, priority) VALUES
    ('thin_lip_profile', (SELECT id FROM forum_issue_categories WHERE slug='thin-lips'), 1),
    ('long_philtrum', (SELECT id FROM forum_issue_categories WHERE slug='thin-lips'), 2)
ON CONFLICT (flaw_id, issue_category_id) DO NOTHING;

-- Face Fat/Bloating mappings
INSERT INTO flaw_to_forum_mapping (flaw_id, issue_category_id, priority) VALUES
    ('flat_midface', (SELECT id FROM forum_issue_categories WHERE slug='face-fat'), 2),
    ('long_face', (SELECT id FROM forum_issue_categories WHERE slug='face-fat'), 2),
    ('long_midface', (SELECT id FROM forum_issue_categories WHERE slug='face-fat'), 2)
ON CONFLICT (flaw_id, issue_category_id) DO NOTHING;

-- ============== POSTS (in sub-forums) ==============
CREATE TABLE IF NOT EXISTS forum_posts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sub_forum_id UUID NOT NULL REFERENCES forum_sub_forums(id) ON DELETE CASCADE,
    author_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    is_pinned BOOLEAN DEFAULT FALSE,
    is_guide BOOLEAN DEFAULT FALSE,
    is_approved BOOLEAN DEFAULT TRUE,
    is_deleted BOOLEAN DEFAULT FALSE,
    vote_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_posts_subforum_pinned ON forum_posts(sub_forum_id, is_pinned, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_posts_subforum_votes ON forum_posts(sub_forum_id, vote_count DESC);
CREATE INDEX IF NOT EXISTS idx_posts_author ON forum_posts(author_id);
CREATE INDEX IF NOT EXISTS idx_posts_created ON forum_posts(created_at DESC);

-- ============== COMMENTS ==============
CREATE TABLE IF NOT EXISTS forum_comments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    content TEXT NOT NULL,
    post_id UUID NOT NULL REFERENCES forum_posts(id) ON DELETE CASCADE,
    author_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    parent_id UUID REFERENCES forum_comments(id) ON DELETE CASCADE,
    is_approved BOOLEAN DEFAULT TRUE,
    is_deleted BOOLEAN DEFAULT FALSE,
    vote_count INTEGER DEFAULT 0,
    depth INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_comments_post ON forum_comments(post_id, created_at);
CREATE INDEX IF NOT EXISTS idx_comments_parent ON forum_comments(parent_id);
CREATE INDEX IF NOT EXISTS idx_comments_author ON forum_comments(author_id);

-- ============== VOTES ==============
CREATE TABLE IF NOT EXISTS forum_votes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    target_type targettype NOT NULL,
    target_id UUID NOT NULL,
    vote_type votetype NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX IF NOT EXISTS idx_votes_user_target ON forum_votes(user_id, target_type, target_id);
CREATE INDEX IF NOT EXISTS idx_votes_target ON forum_votes(target_type, target_id);

-- ============== REPORTS ==============
CREATE TABLE IF NOT EXISTS forum_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    reporter_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    target_type targettype NOT NULL,
    target_id UUID NOT NULL,
    reason reportreason NOT NULL,
    details TEXT,
    status reportstatus DEFAULT 'pending',
    reviewed_by UUID REFERENCES users(id) ON DELETE SET NULL,
    reviewed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_reports_status ON forum_reports(status, created_at);
CREATE INDEX IF NOT EXISTS idx_reports_target ON forum_reports(target_type, target_id);

-- ============== TRIGGERS ==============
CREATE OR REPLACE FUNCTION update_post_comment_count()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE forum_posts SET comment_count = comment_count + 1 WHERE id = NEW.post_id;
    ELSIF TG_OP = 'DELETE' THEN
        UPDATE forum_posts SET comment_count = comment_count - 1 WHERE id = OLD.post_id;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_comment_count ON forum_comments;
CREATE TRIGGER trigger_comment_count
AFTER INSERT OR DELETE ON forum_comments
FOR EACH ROW EXECUTE FUNCTION update_post_comment_count();

-- ============== VERIFY MIGRATION ==============
SELECT 'forum_issue_categories' as table_name, COUNT(*) as count FROM forum_issue_categories
UNION ALL
SELECT 'forum_sub_forums', COUNT(*) FROM forum_sub_forums
UNION ALL
SELECT 'flaw_to_forum_mapping', COUNT(*) FROM flaw_to_forum_mapping;
