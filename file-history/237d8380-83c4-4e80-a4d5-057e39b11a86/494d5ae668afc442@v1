/**
 * Test Bezier fallback to exponential decay for edge cases
 */
import { calculateMetricScore } from './src/lib/scoring/calculator';
import { METRIC_CONFIGS } from './src/lib/data/metric-configs';

console.log('═'.repeat(70));
console.log('BEZIER FALLBACK TO EXPONENTIAL DECAY TEST');
console.log('═'.repeat(70));
console.log('\nTesting that out-of-range values fall back to exponential decay\n');

const testCases = [
  // faceWidthToHeight: Bezier curve range is 1.49-2.47, endpoints have y=0
  { metric: 'faceWidthToHeight', value: 2.5, description: 'Above curve range (2.47 max)' },
  { metric: 'faceWidthToHeight', value: 1.4, description: 'Below curve range (1.49 min)' },
  { metric: 'faceWidthToHeight', value: 3.0, description: 'Far above curve range' },
  { metric: 'faceWidthToHeight', value: 1.0, description: 'Far below curve range' },

  // lowerThirdProportion: Bezier curve range is 25.6-38.9
  { metric: 'lowerThirdProportion', value: 40, description: 'Above curve range (38.9 max)' },
  { metric: 'lowerThirdProportion', value: 24, description: 'Below curve range (25.6 min)' },

  // midfaceRatio: Bezier curve range is 0.59-1.38
  { metric: 'midfaceRatio', value: 1.5, description: 'Above curve range (1.38 max)' },
  { metric: 'midfaceRatio', value: 0.5, description: 'Below curve range (0.59 min)' },

  // Values within curve range (should use Bezier, not fallback)
  { metric: 'faceWidthToHeight', value: 2.0, description: 'Within curve range (ideal)' },
  { metric: 'faceWidthToHeight', value: 2.2, description: 'Within curve range (above ideal)' },
];

let passed = 0;
let failed = 0;

console.log('-'.repeat(70));
console.log('Metric                    Value    Expected    Actual    Status');
console.log('-'.repeat(70));

for (const test of testCases) {
  const config = METRIC_CONFIGS[test.metric];
  if (!config) {
    console.log(`Config not found for ${test.metric}`);
    continue;
  }

  const score = calculateMetricScore(
    test.metric,
    test.value,
    config.idealMin,
    config.idealMax,
    config.decayRate,
    config.maxScore,
    undefined,
    config.customCurve
  );

  // For out-of-range values, score should NOT be 0 (should use exponential decay)
  // For within-range values, score should be from Bezier curve
  const isOutOfRange = test.description.includes('Above') || test.description.includes('Below') || test.description.includes('Far');

  let status: string;
  let expected: string;

  if (isOutOfRange) {
    expected = '> 0';
    status = score > 0 ? '✓ PASS' : '✗ FAIL';
    if (score > 0) passed++; else failed++;
  } else {
    expected = '≥ 0';
    status = score >= 0 ? '✓ PASS' : '✗ FAIL';
    if (score >= 0) passed++; else failed++;
  }

  const metricPadded = test.metric.padEnd(24);
  const valuePadded = test.value.toFixed(2).padStart(6);
  const expectedPadded = expected.padStart(8);
  const scorePadded = score.toFixed(2).padStart(8);

  console.log(`${metricPadded} ${valuePadded}    ${expectedPadded}    ${scorePadded}    ${status}`);
  console.log(`  └─ ${test.description}`);
}

console.log('-'.repeat(70));
console.log(`\nResults: ${passed} passed, ${failed} failed`);

if (failed === 0) {
  console.log('\n✅ All Bezier fallback tests passed!');
  console.log('   Out-of-range values correctly fall back to exponential decay\n');
} else {
  console.log('\n❌ Some tests failed!');
  process.exit(1);
}
