import React, { useState } from "react"
import { vscode } from "../../utils/vscode"

export interface AutomationInfo {
	id: string
	name: string
	enabled: boolean
	isActive: boolean
	triggerType: string
	lastExecution?: {
		status: "success" | "failure" | "running"
		timestamp: number
		duration?: number
	}
}

export interface AutomationStatusProps {
	automations: AutomationInfo[]
	automationsEnabled: boolean
	onToggleEnabled: (enabled: boolean) => void
}

/**
 * AutomationStatus component displays active automations and their status.
 * Shows a collapsible list of automations with their current state.
 */
export const AutomationStatus: React.FC<AutomationStatusProps> = ({
	automations,
	automationsEnabled,
	onToggleEnabled,
}) => {
	const [isExpanded, setIsExpanded] = useState(false)

	const activeCount = automations.filter((a) => a.isActive).length
	const runningCount = automations.filter((a) => a.lastExecution?.status === "running").length

	const handleToggleAutomation = (automationId: string, enabled: boolean) => {
		vscode.postMessage({
			type: "toggleAutomation",
			automationId,
			enabled,
		})
	}

	const handleTriggerManually = (automationId: string) => {
		vscode.postMessage({
			type: "triggerAutomation",
			automationId,
		})
	}

	const getStatusIcon = (automation: AutomationInfo) => {
		if (!automation.enabled) return "$(circle-slash)"
		if (automation.lastExecution?.status === "running") return "$(sync~spin)"
		if (automation.lastExecution?.status === "success") return "$(check)"
		if (automation.lastExecution?.status === "failure") return "$(error)"
		return "$(circle-outline)"
	}

	const getStatusColor = (automation: AutomationInfo) => {
		if (!automation.enabled) return "var(--vscode-disabledForeground)"
		if (automation.lastExecution?.status === "running") return "var(--vscode-charts-blue)"
		if (automation.lastExecution?.status === "success") return "var(--vscode-charts-green)"
		if (automation.lastExecution?.status === "failure") return "var(--vscode-charts-red)"
		return "var(--vscode-foreground)"
	}

	const formatTimestamp = (timestamp: number) => {
		const date = new Date(timestamp)
		const now = new Date()
		const diffMs = now.getTime() - date.getTime()
		const diffMins = Math.floor(diffMs / 60000)

		if (diffMins < 1) return "just now"
		if (diffMins < 60) return `${diffMins}m ago`
		const diffHours = Math.floor(diffMins / 60)
		if (diffHours < 24) return `${diffHours}h ago`
		return date.toLocaleDateString()
	}

	if (automations.length === 0) {
		return null
	}

	return (
		<div
			className="automation-status"
			style={{
				borderBottom: "1px solid var(--vscode-panel-border)",
				fontSize: "12px",
			}}>
			{/* Header */}
			<div
				style={{
					display: "flex",
					alignItems: "center",
					justifyContent: "space-between",
					padding: "6px 10px",
					cursor: "pointer",
					background: isExpanded ? "var(--vscode-list-hoverBackground)" : "transparent",
				}}
				onClick={() => setIsExpanded(!isExpanded)}>
				<div style={{ display: "flex", alignItems: "center", gap: "6px" }}>
					<span className={`codicon codicon-${isExpanded ? "chevron-down" : "chevron-right"}`} />
					<span className="codicon codicon-robot" />
					<span style={{ fontWeight: 500 }}>Automations</span>
					{runningCount > 0 && (
						<span
							style={{
								background: "var(--vscode-charts-blue)",
								color: "var(--vscode-badge-foreground)",
								padding: "0 6px",
								borderRadius: "10px",
								fontSize: "10px",
							}}>
							{runningCount} running
						</span>
					)}
					<span
						style={{
							color: "var(--vscode-descriptionForeground)",
							fontSize: "11px",
						}}>
						({activeCount}/{automations.length} active)
					</span>
				</div>
				<div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
					<label
						style={{
							display: "flex",
							alignItems: "center",
							gap: "4px",
							cursor: "pointer",
							fontSize: "11px",
						}}
						onClick={(e) => e.stopPropagation()}>
						<input
							type="checkbox"
							checked={automationsEnabled}
							onChange={(e) => onToggleEnabled(e.target.checked)}
							style={{ cursor: "pointer" }}
						/>
						Enabled
					</label>
				</div>
			</div>

			{/* Expanded content */}
			{isExpanded && (
				<div style={{ padding: "4px 10px 8px" }}>
					{automations.map((automation) => (
						<div
							key={automation.id}
							style={{
								display: "flex",
								alignItems: "center",
								justifyContent: "space-between",
								padding: "4px 0",
								borderBottom: "1px solid var(--vscode-widget-border)",
							}}>
							<div style={{ display: "flex", alignItems: "center", gap: "8px", flex: 1 }}>
								<span
									className={`codicon ${getStatusIcon(automation).replace("$(", "codicon-").replace(")", "")}`}
									style={{ color: getStatusColor(automation) }}
								/>
								<div style={{ flex: 1 }}>
									<div style={{ fontWeight: 500 }}>{automation.name}</div>
									<div
										style={{
											fontSize: "10px",
											color: "var(--vscode-descriptionForeground)",
										}}>
										{automation.triggerType}
										{automation.lastExecution && (
											<span> - {formatTimestamp(automation.lastExecution.timestamp)}</span>
										)}
									</div>
								</div>
							</div>
							<div style={{ display: "flex", alignItems: "center", gap: "4px" }}>
								<button
									onClick={() => handleTriggerManually(automation.id)}
									disabled={!automation.enabled || automation.lastExecution?.status === "running"}
									style={{
										background: "transparent",
										border: "none",
										color: "var(--vscode-foreground)",
										cursor: automation.enabled ? "pointer" : "not-allowed",
										padding: "2px 4px",
										opacity: automation.enabled ? 1 : 0.5,
									}}
									title="Trigger manually">
									<span className="codicon codicon-play" />
								</button>
								<button
									onClick={() => handleToggleAutomation(automation.id, !automation.enabled)}
									style={{
										background: "transparent",
										border: "none",
										color: "var(--vscode-foreground)",
										cursor: "pointer",
										padding: "2px 4px",
									}}
									title={automation.enabled ? "Disable" : "Enable"}>
									<span
										className={`codicon codicon-${automation.enabled ? "eye" : "eye-closed"}`}
									/>
								</button>
							</div>
						</div>
					))}

					{automations.length === 0 && (
						<div
							style={{
								textAlign: "center",
								padding: "12px",
								color: "var(--vscode-descriptionForeground)",
							}}>
							No automations configured.
							<br />
							<a
								href="#"
								onClick={(e) => {
									e.preventDefault()
									vscode.postMessage({ type: "openAutomationsConfig" })
								}}
								style={{ color: "var(--vscode-textLink-foreground)" }}>
								Create automations.yaml
							</a>
						</div>
					)}
				</div>
			)}
		</div>
	)
}

/**
 * Compact automation indicator for the header area.
 * Shows automation count and status badge.
 */
export const AutomationIndicator: React.FC<{
	automations: AutomationInfo[]
	automationsEnabled: boolean
}> = ({ automations, automationsEnabled }) => {
	const activeCount = automations.filter((a) => a.enabled && a.isActive).length
	const runningCount = automations.filter((a) => a.lastExecution?.status === "running").length

	if (automations.length === 0 || !automationsEnabled) {
		return null
	}

	return (
		<div
			className="automation-indicator"
			style={{
				display: "flex",
				alignItems: "center",
				gap: "4px",
				padding: "2px 6px",
				background: runningCount > 0 ? "var(--vscode-charts-blue)" : "var(--vscode-badge-background)",
				color: "var(--vscode-badge-foreground)",
				borderRadius: "10px",
				fontSize: "10px",
			}}
			title={`${activeCount} active automation${activeCount !== 1 ? "s" : ""}${runningCount > 0 ? `, ${runningCount} running` : ""}`}>
			<span className="codicon codicon-robot" style={{ fontSize: "10px" }} />
			{runningCount > 0 ? (
				<span className="codicon codicon-sync-spin" style={{ fontSize: "8px" }} />
			) : (
				<span>{activeCount}</span>
			)}
		</div>
	)
}

export default AutomationStatus
