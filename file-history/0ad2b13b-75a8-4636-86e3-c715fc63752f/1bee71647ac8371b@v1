'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { X, TrendingDown, TrendingUp, AlertTriangle, CheckCircle, Info, ChevronRight } from 'lucide-react';
import { ScoredRatio } from '@/lib/faceiq-scoring';
import { FlawDetail, generateAIDescription, getSeverityFromScore } from '@/lib/aiDescriptions';
import { getScoreColor, getSeverityColor } from '@/types/results';
import { ScoreBar, CategoryTag, SeverityBadge } from '../shared';
import { useMemo } from 'react';

// ============================================
// TYPES
// ============================================

interface MetricDetailModalProps {
  isOpen: boolean;
  onClose: () => void;
  ratio: ScoredRatio | null;
}

// ============================================
// CONFIDENCE BADGE
// ============================================

function ConfidenceBadge({ confidence }: { confidence: 'confirmed' | 'likely' | 'possible' }) {
  const configs = {
    confirmed: {
      label: 'Confirmed',
      color: '#ef4444',
      bg: 'rgba(239, 68, 68, 0.15)',
      border: 'rgba(239, 68, 68, 0.3)',
    },
    likely: {
      label: 'Likely',
      color: '#f97316',
      bg: 'rgba(249, 115, 22, 0.15)',
      border: 'rgba(249, 115, 22, 0.3)',
    },
    possible: {
      label: 'Possible',
      color: '#fbbf24',
      bg: 'rgba(251, 191, 36, 0.15)',
      border: 'rgba(251, 191, 36, 0.3)',
    },
  };

  const config = configs[confidence];

  return (
    <span
      className="inline-flex items-center px-2 py-0.5 text-[10px] font-medium rounded-full"
      style={{
        color: config.color,
        backgroundColor: config.bg,
        border: `1px solid ${config.border}`,
      }}
    >
      {config.label}
    </span>
  );
}

// ============================================
// DEVIATION BAR
// ============================================

interface DeviationBarProps {
  value: number;
  idealMin: number;
  idealMax: number;
  actualValue: number;
}

function DeviationBar({ value, idealMin, idealMax, actualValue }: DeviationBarProps) {
  // Calculate range for visualization (extend 30% beyond ideal on each side)
  const idealRange = idealMax - idealMin;
  const visualMin = idealMin - idealRange * 0.5;
  const visualMax = idealMax + idealRange * 0.5;
  const totalRange = visualMax - visualMin;

  // Calculate positions as percentages
  const idealMinPos = ((idealMin - visualMin) / totalRange) * 100;
  const idealMaxPos = ((idealMax - visualMin) / totalRange) * 100;
  const actualPos = Math.max(0, Math.min(100, ((actualValue - visualMin) / totalRange) * 100));

  // Determine if value is within range
  const isWithinRange = actualValue >= idealMin && actualValue <= idealMax;
  const markerColor = isWithinRange ? '#22c55e' : actualValue < idealMin ? '#f97316' : '#ef4444';

  return (
    <div className="relative w-full h-8 my-4">
      {/* Background track */}
      <div className="absolute inset-x-0 top-1/2 -translate-y-1/2 h-2 bg-neutral-800 rounded-full">
        {/* Ideal range highlight */}
        <div
          className="absolute top-0 h-full bg-green-500/30 rounded-full"
          style={{
            left: `${idealMinPos}%`,
            width: `${idealMaxPos - idealMinPos}%`,
          }}
        />
      </div>

      {/* Ideal range markers */}
      <div
        className="absolute top-1/2 -translate-y-1/2 w-0.5 h-4 bg-green-500/60"
        style={{ left: `${idealMinPos}%` }}
      />
      <div
        className="absolute top-1/2 -translate-y-1/2 w-0.5 h-4 bg-green-500/60"
        style={{ left: `${idealMaxPos}%` }}
      />

      {/* Actual value marker */}
      <motion.div
        initial={{ scale: 0 }}
        animate={{ scale: 1 }}
        transition={{ delay: 0.3, type: 'spring', stiffness: 200 }}
        className="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-4 rounded-full border-2 border-white shadow-lg"
        style={{
          left: `${actualPos}%`,
          backgroundColor: markerColor,
        }}
      />

      {/* Labels */}
      <div className="absolute top-full mt-1 left-0 text-[10px] text-neutral-500">
        {visualMin.toFixed(1)}
      </div>
      <div
        className="absolute top-full mt-1 text-[10px] text-green-400"
        style={{ left: `${idealMinPos}%`, transform: 'translateX(-50%)' }}
      >
        {idealMin.toFixed(2)}
      </div>
      <div
        className="absolute top-full mt-1 text-[10px] text-green-400"
        style={{ left: `${idealMaxPos}%`, transform: 'translateX(-50%)' }}
      >
        {idealMax.toFixed(2)}
      </div>
      <div className="absolute top-full mt-1 right-0 text-[10px] text-neutral-500">
        {visualMax.toFixed(1)}
      </div>
    </div>
  );
}

// ============================================
// MAIN MODAL COMPONENT
// ============================================

export function MetricDetailModal({ isOpen, onClose, ratio }: MetricDetailModalProps) {
  // Generate AI description from ratio data
  const flawDetail = useMemo<FlawDetail | null>(() => {
    if (!ratio) return null;

    return generateAIDescription(
      ratio.ratioName.toLowerCase().replace(/\s+/g, ''),
      ratio.ratioName,
      ratio.value,
      ratio.idealMin,
      ratio.idealMax,
      ratio.score,
      ratio.unit,
      ratio.category
    );
  }, [ratio]);

  if (!ratio || !flawDetail) return null;

  const color = getScoreColor(ratio.score);
  const isStrength = ratio.score >= 7;
  const severity = getSeverityFromScore(ratio.score);
  const severityColor = getSeverityColor(severity);

  return (
    <AnimatePresence>
      {isOpen && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50"
          />

          {/* Modal */}
          <motion.div
            initial={{ opacity: 0, scale: 0.95, y: 20 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95, y: 20 }}
            transition={{ type: 'spring', damping: 25, stiffness: 300 }}
            className="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-lg max-h-[90vh] overflow-y-auto bg-neutral-900 border border-neutral-700 rounded-2xl shadow-2xl z-50"
          >
            {/* Header */}
            <div className="sticky top-0 bg-neutral-900/95 backdrop-blur-sm border-b border-neutral-800 p-4 z-10">
              <div className="flex items-start justify-between gap-4">
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-1">
                    {isStrength ? (
                      <CheckCircle size={18} className="text-green-400" />
                    ) : (
                      <AlertTriangle size={18} className="text-red-400" />
                    )}
                    <h2 className="text-lg font-bold text-white">{ratio.ratioName}</h2>
                  </div>
                  <div className="flex items-center gap-2 flex-wrap">
                    <CategoryTag category={ratio.category} />
                    <SeverityBadge severity={severity} size="sm" />
                    <ConfidenceBadge confidence={flawDetail.confidence} />
                  </div>
                </div>
                <button
                  onClick={onClose}
                  className="p-2 hover:bg-neutral-800 rounded-lg transition-colors"
                >
                  <X size={20} className="text-neutral-400" />
                </button>
              </div>
            </div>

            {/* Content */}
            <div className="p-4 space-y-6">
              {/* Score Section */}
              <div className="bg-neutral-800/50 rounded-xl p-4">
                <div className="flex items-center justify-between mb-3">
                  <span className="text-sm text-neutral-400">Score</span>
                  <span className="text-2xl font-bold" style={{ color }}>
                    {ratio.score.toFixed(2)}<span className="text-neutral-500 text-base">/10</span>
                  </span>
                </div>
                <ScoreBar score={ratio.score} height={10} />
              </div>

              {/* Value Details */}
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-neutral-800/50 rounded-xl p-3">
                  <p className="text-xs text-neutral-500 mb-1">Actual Value</p>
                  <p className="text-xl font-bold text-white">{flawDetail.actualValue}</p>
                </div>
                <div className="bg-neutral-800/50 rounded-xl p-3">
                  <p className="text-xs text-neutral-500 mb-1">Ideal Range</p>
                  <p className="text-xl font-bold text-green-400">{flawDetail.idealRange}</p>
                </div>
              </div>

              {/* Deviation Bar */}
              <div className="bg-neutral-800/50 rounded-xl p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-neutral-400">Deviation</span>
                  <span
                    className="text-sm font-medium flex items-center gap-1"
                    style={{ color: severityColor }}
                  >
                    {flawDetail.deviationPercent > 0 ? (
                      ratio.value > ratio.idealMax ? (
                        <TrendingUp size={14} />
                      ) : (
                        <TrendingDown size={14} />
                      )
                    ) : null}
                    {flawDetail.deviation}
                  </span>
                </div>
                <DeviationBar
                  value={ratio.value}
                  idealMin={ratio.idealMin}
                  idealMax={ratio.idealMax}
                  actualValue={ratio.value}
                />
              </div>

              {/* AI Analysis */}
              <div className="bg-gradient-to-br from-cyan-500/10 to-blue-500/5 border border-cyan-500/20 rounded-xl p-4">
                <div className="flex items-center gap-2 mb-3">
                  <Info size={16} className="text-cyan-400" />
                  <h3 className="text-sm font-semibold text-cyan-400">AI Analysis</h3>
                </div>
                <p className="text-sm text-neutral-300 leading-relaxed">
                  {flawDetail.reasoning}
                </p>
              </div>

              {/* Flaw Indication */}
              {!isStrength && (
                <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-4">
                  <div className="flex items-center gap-2 mb-2">
                    <AlertTriangle size={16} className="text-red-400" />
                    <h3 className="text-sm font-semibold text-red-400">May Indicate</h3>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <span className="inline-flex items-center px-2.5 py-1 bg-red-500/20 rounded-lg text-sm text-red-300">
                      {flawDetail.flawName}
                    </span>
                  </div>
                </div>
              )}

              {/* Improvement Suggestion */}
              {!isStrength && ratio.score < 7 && (
                <button className="w-full flex items-center justify-between p-4 bg-neutral-800/50 hover:bg-neutral-800 rounded-xl transition-colors group">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                      <TrendingUp size={20} className="text-cyan-400" />
                    </div>
                    <div className="text-left">
                      <p className="font-medium text-white">View Improvement Options</p>
                      <p className="text-sm text-neutral-500">See treatments & recommendations</p>
                    </div>
                  </div>
                  <ChevronRight size={20} className="text-neutral-500 group-hover:text-cyan-400 transition-colors" />
                </button>
              )}
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  );
}

export default MetricDetailModal;
