/**
 * Face Landmark Detection using TensorFlow.js
 * Maps detected landmarks to our custom facial landmarks
 */

// TensorFlow.js landmark indices for MediaPipe Face Mesh model
// Reference: https://github.com/tensorflow/tfjs-models/tree/master/face-landmarks-detection

// Front profile landmark mapping (TensorFlow Face Mesh uses same indices as MediaPipe)
export const TFJS_FRONT_MAPPING: Record<string, number> = {
  // Head
  trichion: 10,

  // Left Eye
  left_pupila: 468,
  left_canthus_medialis: 133,
  left_canthus_lateralis: 33,
  left_palpebra_superior: 159,
  left_palpebra_inferior: 145,
  left_sulcus_palpebralis_lateralis: 130,
  left_pretarsal_skin_crease: 247,

  // Right Eye
  right_pupila: 473,
  right_canthus_medialis: 362,
  right_canthus_lateralis: 263,
  right_palpebra_superior: 386,
  right_palpebra_inferior: 374,
  right_sulcus_palpebralis_lateralis: 359,
  right_pretarsal_skin_crease: 467,

  // Left Brow
  left_supercilium_medialis: 107,
  left_supercilium_medial_corner: 66,
  left_supercilium_superior: 105,
  left_supercilium_apex: 70,
  left_supercilium_lateralis: 46,

  // Right Brow
  right_supercilium_medialis: 336,
  right_supercilium_medial_corner: 296,
  right_supercilium_superior: 334,
  right_supercilium_apex: 300,
  right_supercilium_lateralis: 276,

  // Nose
  nasal_base: 6,
  left_dorsum_nasi: 198,
  right_dorsum_nasi: 420,
  left_ala_nasi: 129,
  right_ala_nasi: 358,
  subnasale: 2,

  // Mouth
  labrale_superius: 0,
  cupids_bow: 13,
  mouth_middle: 14,
  labrale_inferius: 17,
  left_cheilion: 61,
  right_cheilion: 291,

  // Jaw
  left_gonion_superior: 116,
  right_gonion_superior: 345,
  left_gonion_inferior: 172,
  right_gonion_inferior: 397,

  // Chin
  left_mentum_lateralis: 135,
  right_mentum_lateralis: 364,
  menton: 152,

  // Cheeks
  left_zygion: 234,
  right_zygion: 454,
  left_temporal: 127,
  right_temporal: 356,

  // Ears (approximate)
  left_auricular_lateral: 234,
  right_auricular_lateral: 454,

  // Neck (use chin as reference)
  left_cervical_lateralis: 172,
  right_cervical_lateralis: 397,
};

// Side profile landmark mapping
export const TFJS_SIDE_MAPPING: Record<string, number> = {
  vertex: 10,
  external_occipital_region: 10,
  trichion_profile: 10,
  frontalis: 151,
  glabella: 9,
  corneal_apex: 468,
  lateral_eyelid: 33,
  lower_eyelid_profile: 145,
  zygoma_lateralis: 234,
  nasion: 6,
  rhinion: 4,
  supratip: 4,
  pronasale: 1,
  infratip: 2,
  columella: 2,
  subnasale_profile: 2,
  subalare: 129,
  labrale_superius_profile: 0,
  labrale_inferius_profile: 17,
  cheilion_profile: 61,
  sublabiale: 18,
  orbitale: 145,
  gonion_superior_profile: 116,
  gonion_inferior_profile: 172,
  pogonion: 152,
  menton_profile: 152,
  porion: 127,
  tragus: 127,
  intertragic_notch: 127,
  cervical_point: 152,
  neckpoint: 152,
};

export interface DetectedLandmarks {
  landmarks: Array<{ id: string; x: number; y: number }>;
  confidence: number;
  faceBox: { x: number; y: number; width: number; height: number };
}

let detectorPromise: Promise<unknown> | null = null;

async function getDetector() {
  if (detectorPromise) return detectorPromise;

  detectorPromise = (async () => {
    // Dynamic imports for client-side only
    const tf = await import('@tensorflow/tfjs');
    const faceLandmarksDetection = await import('@tensorflow-models/face-landmarks-detection');

    // Set up TensorFlow.js backend
    await tf.setBackend('webgl');
    await tf.ready();

    // Create the detector
    const model = faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh;
    const detector = await faceLandmarksDetection.createDetector(model, {
      runtime: 'tfjs',
      refineLandmarks: true,
      maxFaces: 1,
    });

    return detector;
  })();

  return detectorPromise;
}

/**
 * Detect facial landmarks from an image URL
 */
export async function detectFromImageUrl(
  imageUrl: string,
  mode: 'front' | 'side'
): Promise<DetectedLandmarks | null> {
  try {
    // Load the image
    const img = await loadImage(imageUrl);

    // Get or create the detector
    const detector = await getDetector() as {
      estimateFaces: (img: HTMLImageElement) => Promise<Array<{
        keypoints: Array<{ x: number; y: number; z?: number; name?: string }>;
        box?: { xMin: number; yMin: number; xMax: number; yMax: number };
      }>>;
    };

    // Detect faces
    const faces = await detector.estimateFaces(img);

    if (!faces || faces.length === 0) {
      console.log('No faces detected');
      return null;
    }

    const face = faces[0];
    const keypoints = face.keypoints;

    // Get image dimensions for normalization
    const width = img.naturalWidth || img.width;
    const height = img.naturalHeight || img.height;

    // Select mapping based on mode
    const mapping = mode === 'front' ? TFJS_FRONT_MAPPING : TFJS_SIDE_MAPPING;

    // Map keypoints to our landmarks
    const landmarks = Object.entries(mapping).map(([id, index]) => {
      // Handle index bounds - some indices might be out of range
      const safeIndex = Math.min(index, keypoints.length - 1);
      const kp = keypoints[safeIndex];

      return {
        id,
        x: kp ? kp.x / width : 0.5,
        y: kp ? kp.y / height : 0.5,
      };
    });

    // Calculate face bounding box
    let minX = 1, minY = 1, maxX = 0, maxY = 0;
    keypoints.forEach((kp) => {
      const x = kp.x / width;
      const y = kp.y / height;
      minX = Math.min(minX, x);
      minY = Math.min(minY, y);
      maxX = Math.max(maxX, x);
      maxY = Math.max(maxY, y);
    });

    return {
      landmarks,
      confidence: 0.9,
      faceBox: {
        x: minX,
        y: minY,
        width: maxX - minX,
        height: maxY - minY,
      },
    };
  } catch (error) {
    console.error('Face detection error:', error);
    return null;
  }
}

/**
 * Load an image from URL
 */
function loadImage(url: string): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = (e) => reject(e);
    img.src = url;
  });
}

/**
 * Get the region to zoom into for a specific landmark
 */
export function getLandmarkZoomRegion(
  landmarkId: string
): { centerX: number; centerY: number; zoomLevel: number } {
  const regions: Record<string, { centerX: number; centerY: number; zoomLevel: number }> = {
    // Eyes - zoom in close
    left_pupila: { centerX: 0.35, centerY: 0.35, zoomLevel: 3 },
    left_canthus_medialis: { centerX: 0.4, centerY: 0.35, zoomLevel: 3 },
    left_canthus_lateralis: { centerX: 0.3, centerY: 0.35, zoomLevel: 3 },
    right_pupila: { centerX: 0.65, centerY: 0.35, zoomLevel: 3 },
    right_canthus_medialis: { centerX: 0.6, centerY: 0.35, zoomLevel: 3 },
    right_canthus_lateralis: { centerX: 0.7, centerY: 0.35, zoomLevel: 3 },

    // Brows
    left_supercilium_apex: { centerX: 0.35, centerY: 0.28, zoomLevel: 2.5 },
    right_supercilium_apex: { centerX: 0.65, centerY: 0.28, zoomLevel: 2.5 },

    // Nose
    nasal_base: { centerX: 0.5, centerY: 0.4, zoomLevel: 2 },
    subnasale: { centerX: 0.5, centerY: 0.55, zoomLevel: 2.5 },

    // Mouth
    labrale_superius: { centerX: 0.5, centerY: 0.6, zoomLevel: 2.5 },
    mouth_middle: { centerX: 0.5, centerY: 0.65, zoomLevel: 2 },

    // Chin
    menton: { centerX: 0.5, centerY: 0.85, zoomLevel: 2 },

    // Default for other landmarks
    default: { centerX: 0.5, centerY: 0.5, zoomLevel: 1.5 },
  };

  return regions[landmarkId] || regions.default;
}
