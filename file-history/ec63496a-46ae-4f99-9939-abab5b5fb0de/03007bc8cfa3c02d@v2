/**
 * Tier Simulation Tests
 *
 * Comprehensive tests for all three SPLICE tiers:
 * - Starter ($15/mo): 4 hours, 2 music credits, NO vocal isolation
 * - Pro ($39/mo): 15 hours, 10 music credits, vocal isolation included
 * - Team ($129/mo): 50 hours, 50 music credits, vocal isolation included
 *
 * Tests cover:
 * 1. Credit initialization on subscription creation
 * 2. Usage tracking and deduction
 * 3. Overage calculation ($2/hour, $1/song, $0.10/min vocal)
 * 4. Feature access controls (vocal isolation Pro/Team only)
 * 5. Music credit costs (1/1.5/2.5/3 credits for different features)
 */

// Note: assert module available but custom assertions used for clearer output

// Import the usageTracking service for testing
const usageTracking = require('../services/usageTracking');

// Test configuration - expected values per tier
const TIER_CONFIG = {
  starter: {
    name: 'Starter',
    price: 15,
    hours: 4,
    musicCredits: 2,
    isolationMinutes: 0,
    hasIsolation: false,
    features: ['silence_removal', 'take_detection', 'basic_captions', 'filler_word', 'caption_export']
  },
  pro: {
    name: 'Pro',
    price: 39,
    hours: 15,
    musicCredits: 10,
    isolationMinutes: 45,
    hasIsolation: true,
    features: ['silence_removal', 'take_detection', 'basic_captions', 'filler_word', 'caption_export',
      'vocal_isolation', 'social_reframe', 'text_editing', 'all_captions',
      'profanity_detection', 'chapter_detection']
  },
  team: {
    name: 'Team',
    price: 129,
    hours: 50,
    musicCredits: 50,
    isolationMinutes: 180, // 3 hours
    hasIsolation: true,
    // Team has 16 features: 11 from Pro + 5 Team-exclusive
    features: ['silence_removal', 'take_detection', 'basic_captions', 'filler_word', 'caption_export',
      'vocal_isolation', 'social_reframe', 'text_editing', 'all_captions',
      'profanity_detection', 'chapter_detection', 'multitrack',
      'music_to_cut', 'mood_timeline', 'youtube_metadata', 'profanity_bleeping']
  }
};

// Overage rates
const OVERAGE_RATES = {
  hours: 2.00,       // $2/hour
  music: 1.00,       // $1/song
  isolation: 0.10    // $0.10/minute
};

// Music credit costs for different features
const MUSIC_CREDIT_COSTS = {
  single: 1,
  sceneAware: 1.5,
  variations: 2.5,
  timeline: 3
};

// Test results tracking
const results = {
  passed: 0,
  failed: 0,
  tests: []
};

function test(name, fn) {
  try {
    fn();
    results.passed++;
    results.tests.push({ name, status: 'PASSED' });
    console.log(`  [PASS] ${name}`);
  } catch (err) {
    results.failed++;
    results.tests.push({ name, status: 'FAILED', error: err.message });
    console.log(`  [FAIL] ${name}: ${err.message}`);
  }
}

function assertEqual(actual, expected, message) {
  if (actual !== expected) {
    throw new Error(`${message}: expected ${expected}, got ${actual}`);
  }
}

function assertApproximatelyEqual(actual, expected, tolerance, message) {
  if (Math.abs(actual - expected) > tolerance) {
    throw new Error(`${message}: expected ~${expected}, got ${actual} (tolerance: ${tolerance})`);
  }
}

function assertTrue(condition, message) {
  if (!condition) {
    throw new Error(message);
  }
}

function assertFalse(condition, message) {
  if (condition) {
    throw new Error(message);
  }
}

// =============================================================================
// Test Suite 1: Tier Configuration Validation
// =============================================================================

console.log('\n========================================');
console.log('SPLICE Tier Simulation Tests');
console.log('========================================\n');

console.log('Test Suite 1: Tier Configuration Validation');
console.log('-------------------------------------------');

test('Starter tier hours limit is 4', () => {
  assertEqual(usageTracking.TIER_HOURS.starter, 4, 'Starter hours');
});

test('Pro tier hours limit is 15', () => {
  assertEqual(usageTracking.TIER_HOURS.pro, 15, 'Pro hours');
});

test('Team tier hours limit is 50', () => {
  assertEqual(usageTracking.TIER_HOURS.team, 50, 'Team hours');
});

test('Cancelled tier has 0 hours', () => {
  assertEqual(usageTracking.TIER_HOURS.cancelled, 0, 'Cancelled hours');
});

test('Starter tier music credits is 2', () => {
  assertEqual(usageTracking.TIER_MUSIC_CREDITS.starter, 2, 'Starter music credits');
});

test('Pro tier music credits is 10', () => {
  assertEqual(usageTracking.TIER_MUSIC_CREDITS.pro, 10, 'Pro music credits');
});

test('Team tier music credits is 50', () => {
  assertEqual(usageTracking.TIER_MUSIC_CREDITS.team, 50, 'Team music credits');
});

test('Cancelled tier has 0 music credits', () => {
  assertEqual(usageTracking.TIER_MUSIC_CREDITS.cancelled, 0, 'Cancelled music credits');
});

// =============================================================================
// Test Suite 2: Isolation Hours Configuration
// =============================================================================

console.log('\nTest Suite 2: Isolation Configuration');
console.log('--------------------------------------');

test('Starter tier has 0 isolation minutes', () => {
  assertEqual(usageTracking.TIER_ISOLATION_MINUTES.starter, 0, 'Starter isolation minutes');
});

test('Pro tier has 45 isolation minutes', () => {
  assertEqual(usageTracking.TIER_ISOLATION_MINUTES.pro, 45, 'Pro isolation minutes');
});

test('Team tier has 180 isolation minutes (3 hours)', () => {
  assertEqual(usageTracking.TIER_ISOLATION_MINUTES.team, 180, 'Team isolation minutes');
});

test('Starter isolation hours calculation is 0', () => {
  assertEqual(usageTracking.TIER_ISOLATION_HOURS.starter, 0, 'Starter isolation hours');
});

test('Pro isolation hours calculation is 0.75 (45/60)', () => {
  assertApproximatelyEqual(usageTracking.TIER_ISOLATION_HOURS.pro, 0.75, 0.001, 'Pro isolation hours');
});

test('Team isolation hours calculation is 3 (180/60)', () => {
  assertEqual(usageTracking.TIER_ISOLATION_HOURS.team, 3, 'Team isolation hours');
});

// =============================================================================
// Test Suite 3: Overage Rate Configuration
// =============================================================================

console.log('\nTest Suite 3: Overage Rate Configuration');
console.log('-----------------------------------------');

test('Hours overage rate is $2/hour', () => {
  assertEqual(usageTracking.HOURS_OVERAGE_RATE, 2.00, 'Hours overage rate');
});

test('Music overage rate is $1/song (flat rate)', () => {
  assertEqual(usageTracking.MUSIC_OVERAGE_RATE, 1.00, 'Music overage rate');
});

test('Isolation overage rate is $0.10/minute', () => {
  assertEqual(usageTracking.ISOLATION_OVERAGE_RATE, 0.10, 'Isolation overage rate');
});

// =============================================================================
// Test Suite 4: Music Credit Cost Configuration
// =============================================================================

console.log('\nTest Suite 4: Music Credit Costs');
console.log('---------------------------------');

test('Single song generation costs 1 credit', () => {
  // Verified by deductMusicCredit which deducts 1 credit
  assertEqual(1, MUSIC_CREDIT_COSTS.single, 'Single song credit cost');
});

test('Scene-aware generation costs 1.5 credits', () => {
  assertEqual(usageTracking.SCENE_AWARE_CREDIT_COST, 1.5, 'Scene-aware credit cost');
});

test('Variations generation costs 2.5 credits', () => {
  assertEqual(usageTracking.VARIATIONS_CREDIT_COST, 2.5, 'Variations credit cost');
});

test('Timeline generation costs 3 credits', () => {
  // Timeline is charged by deducting 3 single credits (verified in routes/music.js)
  assertEqual(MUSIC_CREDIT_COSTS.timeline, 3, 'Timeline credit cost');
});

// =============================================================================
// Test Suite 5: Feature Access Control
// =============================================================================

console.log('\nTest Suite 5: Feature Access Control');
console.log('-------------------------------------');

// Test Starter tier features
test('Starter tier has silence_removal access', () => {
  assertTrue(usageTracking.hasFeatureAccess('starter', 'silence_removal'), 'Starter should have silence_removal');
});

test('Starter tier has take_detection access', () => {
  assertTrue(usageTracking.hasFeatureAccess('starter', 'take_detection'), 'Starter should have take_detection');
});

test('Starter tier does NOT have vocal_isolation access', () => {
  assertFalse(usageTracking.hasFeatureAccess('starter', 'vocal_isolation'), 'Starter should NOT have vocal_isolation');
});

test('Starter tier does NOT have social_reframe access', () => {
  assertFalse(usageTracking.hasFeatureAccess('starter', 'social_reframe'), 'Starter should NOT have social_reframe');
});

test('Starter tier does NOT have multitrack access', () => {
  assertFalse(usageTracking.hasFeatureAccess('starter', 'multitrack'), 'Starter should NOT have multitrack');
});

// Test Pro tier features
test('Pro tier has vocal_isolation access', () => {
  assertTrue(usageTracking.hasFeatureAccess('pro', 'vocal_isolation'), 'Pro should have vocal_isolation');
});

test('Pro tier has social_reframe access', () => {
  assertTrue(usageTracking.hasFeatureAccess('pro', 'social_reframe'), 'Pro should have social_reframe');
});

test('Pro tier has text_editing access', () => {
  assertTrue(usageTracking.hasFeatureAccess('pro', 'text_editing'), 'Pro should have text_editing');
});

test('Pro tier has chapter_detection access', () => {
  assertTrue(usageTracking.hasFeatureAccess('pro', 'chapter_detection'), 'Pro should have chapter_detection');
});

test('Pro tier does NOT have multitrack access', () => {
  assertFalse(usageTracking.hasFeatureAccess('pro', 'multitrack'), 'Pro should NOT have multitrack');
});

test('Pro tier does NOT have mood_timeline access', () => {
  assertFalse(usageTracking.hasFeatureAccess('pro', 'mood_timeline'), 'Pro should NOT have mood_timeline');
});

// Test Team tier features
test('Team tier has ALL Pro features', () => {
  const proFeatures = ['vocal_isolation', 'social_reframe', 'text_editing', 'chapter_detection'];
  proFeatures.forEach(feature => {
    assertTrue(usageTracking.hasFeatureAccess('team', feature), `Team should have ${feature}`);
  });
});

test('Team tier has multitrack access', () => {
  assertTrue(usageTracking.hasFeatureAccess('team', 'multitrack'), 'Team should have multitrack');
});

test('Team tier has mood_timeline access', () => {
  assertTrue(usageTracking.hasFeatureAccess('team', 'mood_timeline'), 'Team should have mood_timeline');
});

test('Team tier has youtube_metadata access', () => {
  assertTrue(usageTracking.hasFeatureAccess('team', 'youtube_metadata'), 'Team should have youtube_metadata');
});

test('Team tier has profanity_bleeping access', () => {
  assertTrue(usageTracking.hasFeatureAccess('team', 'profanity_bleeping'), 'Team should have profanity_bleeping');
});

// =============================================================================
// Test Suite 6: Overage Calculation Scenarios
// =============================================================================

console.log('\nTest Suite 6: Overage Calculations');
console.log('-----------------------------------');

test('Processing 5 hours on Starter tier (4h limit) = 1 hour overage = $2', () => {
  const limit = TIER_CONFIG.starter.hours;
  const used = 5;
  const overage = Math.max(0, used - limit);
  const cost = overage * OVERAGE_RATES.hours;
  assertEqual(overage, 1, 'Overage hours');
  assertEqual(cost, 2.00, 'Overage cost');
});

test('Processing 20 hours on Pro tier (15h limit) = 5 hours overage = $10', () => {
  const limit = TIER_CONFIG.pro.hours;
  const used = 20;
  const overage = Math.max(0, used - limit);
  const cost = overage * OVERAGE_RATES.hours;
  assertEqual(overage, 5, 'Overage hours');
  assertEqual(cost, 10.00, 'Overage cost');
});

test('Processing 60 hours on Team tier (50h limit) = 10 hours overage = $20', () => {
  const limit = TIER_CONFIG.team.hours;
  const used = 60;
  const overage = Math.max(0, used - limit);
  const cost = overage * OVERAGE_RATES.hours;
  assertEqual(overage, 10, 'Overage hours');
  assertEqual(cost, 20.00, 'Overage cost');
});

test('Using 5 songs on Starter tier (2 limit) = 3 songs overage = $3', () => {
  const limit = TIER_CONFIG.starter.musicCredits;
  const used = 5;
  const overage = Math.max(0, used - limit);
  const cost = overage * OVERAGE_RATES.music;
  assertEqual(overage, 3, 'Overage songs');
  assertEqual(cost, 3.00, 'Overage cost');
});

test('Using 15 songs on Pro tier (10 limit) = 5 songs overage = $5', () => {
  const limit = TIER_CONFIG.pro.musicCredits;
  const used = 15;
  const overage = Math.max(0, used - limit);
  const cost = overage * OVERAGE_RATES.music;
  assertEqual(overage, 5, 'Overage songs');
  assertEqual(cost, 5.00, 'Overage cost');
});

test('Using 60 minutes isolation on Pro tier (45 limit) = 15 min overage = $1.50', () => {
  const limit = TIER_CONFIG.pro.isolationMinutes;
  const used = 60;
  const overage = Math.max(0, used - limit);
  const cost = overage * OVERAGE_RATES.isolation;
  assertEqual(overage, 15, 'Overage minutes');
  assertApproximatelyEqual(cost, 1.50, 0.001, 'Overage cost');
});

test('Using 240 minutes isolation on Team tier (180 limit) = 60 min overage = $6', () => {
  const limit = TIER_CONFIG.team.isolationMinutes;
  const used = 240;
  const overage = Math.max(0, used - limit);
  const cost = overage * OVERAGE_RATES.isolation;
  assertEqual(overage, 60, 'Overage minutes');
  assertEqual(cost, 6.00, 'Overage cost');
});

// =============================================================================
// Test Suite 7: Tier Lifecycle Simulation
// =============================================================================

console.log('\nTest Suite 7: Tier Lifecycle Simulation');
console.log('----------------------------------------');

test('Starter tier full lifecycle: subscribe -> use -> exceed -> overage', () => {
  // Simulate Starter tier lifecycle
  const tier = 'starter';
  let hoursRemaining = usageTracking.TIER_HOURS[tier];
  let musicCredits = usageTracking.TIER_MUSIC_CREDITS[tier];
  let totalOverageCost = 0;

  // Initial state
  assertEqual(hoursRemaining, 4, 'Initial hours');
  assertEqual(musicCredits, 2, 'Initial music credits');

  // Use 2 hours
  hoursRemaining -= 2;
  assertEqual(hoursRemaining, 2, 'After 2 hours usage');

  // Use another 3 hours (1 hour overage)
  const hoursToUse = 3;
  const overageHours = Math.max(0, hoursToUse - hoursRemaining);
  hoursRemaining = Math.max(0, hoursRemaining - hoursToUse);
  totalOverageCost += overageHours * OVERAGE_RATES.hours;
  assertEqual(hoursRemaining, 0, 'Hours depleted');
  assertEqual(overageHours, 1, 'Overage hours');
  assertEqual(totalOverageCost, 2.00, 'Overage cost');

  // Use all music credits + 1 overage
  musicCredits -= 3;
  const overageMusic = Math.max(0, -musicCredits);
  musicCredits = Math.max(0, musicCredits);
  totalOverageCost += overageMusic * OVERAGE_RATES.music;
  assertEqual(musicCredits, 0, 'Music credits depleted');
  assertEqual(overageMusic, 1, 'Music overage');
  assertEqual(totalOverageCost, 3.00, 'Total overage cost');
});

test('Pro tier full lifecycle: subscribe -> use -> isolation -> overage', () => {
  const tier = 'pro';
  let hoursRemaining = usageTracking.TIER_HOURS[tier];
  let musicCredits = usageTracking.TIER_MUSIC_CREDITS[tier];
  let isolationMinutes = usageTracking.TIER_ISOLATION_MINUTES[tier];
  let totalOverageCost = 0;

  // Initial state
  assertEqual(hoursRemaining, 15, 'Initial hours');
  assertEqual(musicCredits, 10, 'Initial music credits');
  assertEqual(isolationMinutes, 45, 'Initial isolation minutes');

  // Use all included hours + 5 overage
  const hoursUsed = 20;
  const overageHours = Math.max(0, hoursUsed - hoursRemaining);
  hoursRemaining = Math.max(0, hoursRemaining - hoursUsed);
  totalOverageCost += overageHours * OVERAGE_RATES.hours;
  assertEqual(overageHours, 5, 'Overage hours');
  assertEqual(totalOverageCost, 10.00, 'Hours overage cost');

  // Use scene-aware (1.5 credits) + variations (2.5 credits) + single (1 credit) = 5 credits
  const creditsUsed = 5;
  musicCredits -= creditsUsed;
  assertEqual(musicCredits, 5, 'Music credits after usage');

  // Use 60 minutes isolation (15 min overage)
  const isolationUsed = 60;
  const isolationOverage = Math.max(0, isolationUsed - isolationMinutes);
  isolationMinutes = Math.max(0, isolationMinutes - isolationUsed);
  totalOverageCost += isolationOverage * OVERAGE_RATES.isolation;
  assertEqual(isolationOverage, 15, 'Isolation overage minutes');
  assertApproximatelyEqual(totalOverageCost, 11.50, 0.001, 'Total overage cost');
});

test('Team tier full lifecycle: heavy usage with overages', () => {
  const tier = 'team';
  let hoursRemaining = usageTracking.TIER_HOURS[tier];
  let musicCredits = usageTracking.TIER_MUSIC_CREDITS[tier];
  let isolationMinutes = usageTracking.TIER_ISOLATION_MINUTES[tier];
  let totalOverageCost = 0;

  // Initial state
  assertEqual(hoursRemaining, 50, 'Initial hours');
  assertEqual(musicCredits, 50, 'Initial music credits');
  assertEqual(isolationMinutes, 180, 'Initial isolation minutes');

  // Agency scenario: process 70 hours
  const hoursUsed = 70;
  const overageHours = Math.max(0, hoursUsed - hoursRemaining);
  hoursRemaining = Math.max(0, hoursRemaining - hoursUsed);
  totalOverageCost += overageHours * OVERAGE_RATES.hours;
  assertEqual(overageHours, 20, 'Overage hours');
  assertEqual(totalOverageCost, 40.00, 'Hours overage cost');

  // Use 55 music credits (50 included + 5 overage)
  const musicUsed = 55;
  const musicOverage = Math.max(0, musicUsed - musicCredits);
  musicCredits = Math.max(0, musicCredits - musicUsed);
  totalOverageCost += musicOverage * OVERAGE_RATES.music;
  assertEqual(musicOverage, 5, 'Music overage');
  assertEqual(totalOverageCost, 45.00, 'After music overage');

  // Use 200 minutes isolation (20 min overage)
  const isolationUsed = 200;
  const isolationOverage = Math.max(0, isolationUsed - isolationMinutes);
  isolationMinutes = Math.max(0, isolationMinutes - isolationUsed);
  totalOverageCost += isolationOverage * OVERAGE_RATES.isolation;
  assertEqual(isolationOverage, 20, 'Isolation overage');
  assertEqual(totalOverageCost, 47.00, 'Final overage cost');
});

// =============================================================================
// Test Suite 8: TIER_FEATURES Array Validation
// =============================================================================

console.log('\nTest Suite 8: TIER_FEATURES Validation');
console.log('---------------------------------------');

test('Starter tier has exactly 5 features', () => {
  assertEqual(usageTracking.TIER_FEATURES.starter.length, 5, 'Starter feature count');
});

test('Pro tier has exactly 11 features', () => {
  assertEqual(usageTracking.TIER_FEATURES.pro.length, 11, 'Pro feature count');
});

test('Team tier has exactly 16 features', () => {
  assertEqual(usageTracking.TIER_FEATURES.team.length, 16, 'Team feature count');
});

test('Cancelled tier has 0 features', () => {
  assertEqual(usageTracking.TIER_FEATURES.cancelled.length, 0, 'Cancelled feature count');
});

test('Pro tier includes all Starter features', () => {
  const starterFeatures = usageTracking.TIER_FEATURES.starter;
  const proFeatures = usageTracking.TIER_FEATURES.pro;
  starterFeatures.forEach(feature => {
    assertTrue(proFeatures.includes(feature), `Pro should include Starter feature: ${feature}`);
  });
});

test('Team tier includes all Pro features', () => {
  const proFeatures = usageTracking.TIER_FEATURES.pro;
  const teamFeatures = usageTracking.TIER_FEATURES.team;
  proFeatures.forEach(feature => {
    assertTrue(teamFeatures.includes(feature), `Team should include Pro feature: ${feature}`);
  });
});

// =============================================================================
// Test Suite 9: Edge Cases
// =============================================================================

console.log('\nTest Suite 9: Edge Cases');
console.log('-------------------------');

test('Unknown tier defaults to starter features', () => {
  // hasFeatureAccess defaults to starter for unknown tier
  assertTrue(usageTracking.hasFeatureAccess('unknown_tier', 'silence_removal'), 'Unknown tier gets starter features');
  assertFalse(usageTracking.hasFeatureAccess('unknown_tier', 'vocal_isolation'), 'Unknown tier does not get pro features');
});

test('Zero usage results in no overage', () => {
  const hoursUsed = 0;
  const limit = usageTracking.TIER_HOURS.starter;
  const overage = Math.max(0, hoursUsed - limit);
  assertEqual(overage, 0, 'No overage for zero usage');
});

test('Exact limit usage results in no overage', () => {
  const hoursUsed = 4; // Exactly starter limit
  const limit = usageTracking.TIER_HOURS.starter;
  const overage = Math.max(0, hoursUsed - limit);
  assertEqual(overage, 0, 'No overage for exact limit usage');
});

test('Fractional hour overage calculation', () => {
  const hoursUsed = 4.5; // 0.5 hour overage on starter
  const limit = usageTracking.TIER_HOURS.starter;
  const overage = Math.max(0, hoursUsed - limit);
  const cost = overage * OVERAGE_RATES.hours;
  assertApproximatelyEqual(overage, 0.5, 0.001, 'Fractional overage');
  assertApproximatelyEqual(cost, 1.00, 0.001, 'Fractional overage cost');
});

test('Variations credit cost rounds up for deduction (2.5 -> 3)', () => {
  // When deducting 2.5 credits, the system rounds up to 3 for integer deduction
  const creditCost = usageTracking.VARIATIONS_CREDIT_COST;
  const actualDeducted = Math.ceil(creditCost);
  assertEqual(actualDeducted, 3, 'Variations deducts 3 credits (rounded up from 2.5)');
});

test('Scene-aware credit cost rounds up for deduction (1.5 -> 2)', () => {
  // When deducting 1.5 credits, the system rounds up to 2 for integer deduction
  const creditCost = usageTracking.SCENE_AWARE_CREDIT_COST;
  const actualDeducted = Math.ceil(creditCost);
  assertEqual(actualDeducted, 2, 'Scene-aware deducts 2 credits (rounded up from 1.5)');
});

// =============================================================================
// Test Suite 10: Pricing Consistency Validation
// =============================================================================

console.log('\nTest Suite 10: Pricing Consistency');
console.log('-----------------------------------');

test('Starter pricing: $15/mo for 4 hours = $3.75/hour included rate', () => {
  const tier = TIER_CONFIG.starter;
  const includedRate = tier.price / tier.hours;
  assertApproximatelyEqual(includedRate, 3.75, 0.01, 'Starter included rate');
});

test('Pro pricing: $39/mo for 15 hours = $2.60/hour included rate', () => {
  const tier = TIER_CONFIG.pro;
  const includedRate = tier.price / tier.hours;
  assertApproximatelyEqual(includedRate, 2.60, 0.01, 'Pro included rate');
});

test('Team pricing: $129/mo for 50 hours = $2.58/hour included rate', () => {
  const tier = TIER_CONFIG.team;
  const includedRate = tier.price / tier.hours;
  assertApproximatelyEqual(includedRate, 2.58, 0.01, 'Team included rate');
});

test('Overage rate ($2/hr) is cheaper than Starter included rate ($3.75/hr)', () => {
  const starterRate = TIER_CONFIG.starter.price / TIER_CONFIG.starter.hours;
  assertTrue(OVERAGE_RATES.hours < starterRate, 'Overage is cheaper than Starter included rate');
});

test('Music credits scale with tier: Starter(2) < Pro(10) < Team(50)', () => {
  assertTrue(
    TIER_CONFIG.starter.musicCredits < TIER_CONFIG.pro.musicCredits &&
    TIER_CONFIG.pro.musicCredits < TIER_CONFIG.team.musicCredits,
    'Music credits scale correctly'
  );
});

// =============================================================================
// Results Summary
// =============================================================================

console.log('\n========================================');
console.log('Test Results Summary');
console.log('========================================');
console.log(`Total: ${results.passed + results.failed}`);
console.log(`Passed: ${results.passed}`);
console.log(`Failed: ${results.failed}`);
console.log(`Pass Rate: ${((results.passed / (results.passed + results.failed)) * 100).toFixed(1)}%`);

if (results.failed > 0) {
  console.log('\nFailed Tests:');
  results.tests
    .filter(t => t.status === 'FAILED')
    .forEach(t => console.log(`  - ${t.name}: ${t.error}`));
}

console.log('\n========================================');
console.log('Tier Summary');
console.log('========================================');
Object.entries(TIER_CONFIG).forEach(([_tier, config]) => {
  console.log(`\n${config.name} ($${config.price}/mo):`);
  console.log(`  - Processing: ${config.hours} hours`);
  console.log(`  - Music: ${config.musicCredits} credits`);
  console.log(`  - Isolation: ${config.isolationMinutes} minutes ${config.hasIsolation ? '(included)' : '(NOT available)'}`);
  console.log(`  - Features: ${config.features.length}`);
});

console.log('\nOverage Rates:');
console.log(`  - Processing: $${OVERAGE_RATES.hours}/hour`);
console.log(`  - Music: $${OVERAGE_RATES.music}/song`);
console.log(`  - Isolation: $${OVERAGE_RATES.isolation}/minute`);

console.log('\nMusic Credit Costs:');
console.log(`  - Single song: ${MUSIC_CREDIT_COSTS.single} credit`);
console.log(`  - Scene-aware: ${MUSIC_CREDIT_COSTS.sceneAware} credits`);
console.log(`  - Variations: ${MUSIC_CREDIT_COSTS.variations} credits`);
console.log(`  - Timeline: ${MUSIC_CREDIT_COSTS.timeline} credits`);

// Exit with appropriate code
process.exit(results.failed > 0 ? 1 : 0);
