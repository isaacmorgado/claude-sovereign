/**
 * Face Landmark Detection using MediaPipe Tasks Vision
 * Maps detected landmarks to our custom facial landmarks
 *
 * Uses the shared singleton service for optimal performance
 */

import { faceDetectionService } from './faceDetectionService';

// MediaPipe Face Mesh landmark indices (478 landmarks total)
// Reference: https://github.com/google/mediapipe/blob/master/mediapipe/modules/face_geometry/data/canonical_face_model_uv_visualization.png

// Front profile landmark mapping
// NOTE: App uses VIEWER's perspective (left = left side of image)
// MediaPipe uses SUBJECT's perspective (left = subject's left = RIGHT side of image)
// So we map app's "left" to MediaPipe's RIGHT indices and vice versa
export const MEDIAPIPE_FRONT_MAPPING: Record<string, number> = {
  // Head
  trichion: 10,

  // Left Eye (viewer's left = subject's RIGHT eye, MediaPipe indices 473-477 for iris)
  left_pupila: 473,             // subject's RIGHT iris center
  left_canthus_medialis: 362,   // subject's RIGHT inner corner
  left_canthus_lateralis: 263,  // subject's RIGHT outer corner
  left_palpebra_superior: 386,  // subject's RIGHT upper eyelid
  left_palpebra_inferior: 374,  // subject's RIGHT lower eyelid
  left_sulcus_palpebralis_lateralis: 359,  // subject's RIGHT lateral sulcus
  left_pretarsal_skin_crease: 388,  // subject's RIGHT upper eyelid crease area

  // Right Eye (viewer's right = subject's LEFT eye, MediaPipe indices 468-472 for iris)
  right_pupila: 468,            // subject's LEFT iris center
  right_canthus_medialis: 133,  // subject's LEFT inner corner
  right_canthus_lateralis: 33,  // subject's LEFT outer corner
  right_palpebra_superior: 159, // subject's LEFT upper eyelid
  right_palpebra_inferior: 145, // subject's LEFT lower eyelid
  right_sulcus_palpebralis_lateralis: 130,  // subject's LEFT lateral sulcus
  right_pretarsal_skin_crease: 161,  // subject's LEFT upper eyelid crease area

  // Left Brow (viewer's left = subject's RIGHT brow)
  left_supercilium_medialis: 336,
  left_supercilium_medial_corner: 296,
  left_supercilium_superior: 334,
  left_supercilium_apex: 300,
  left_supercilium_lateralis: 276,

  // Right Brow (viewer's right = subject's LEFT brow)
  right_supercilium_medialis: 107,
  right_supercilium_medial_corner: 66,
  right_supercilium_superior: 105,
  right_supercilium_apex: 70,
  right_supercilium_lateralis: 46,

  // Nose (center landmarks stay the same)
  nasal_base: 6,
  left_dorsum_nasi: 420,  // viewer's left = subject's right
  right_dorsum_nasi: 198, // viewer's right = subject's left
  left_ala_nasi: 358,     // viewer's left = subject's right nostril
  right_ala_nasi: 129,    // viewer's right = subject's left nostril
  subnasale: 2,

  // Mouth
  labrale_superius: 0,
  cupids_bow: 13,
  mouth_middle: 14,
  labrale_inferius: 17,
  left_cheilion: 291,   // viewer's left = subject's right mouth corner
  right_cheilion: 61,   // viewer's right = subject's left mouth corner

  // Jaw
  left_gonion_superior: 345,  // viewer's left = subject's right
  right_gonion_superior: 116, // viewer's right = subject's left
  left_gonion_inferior: 397,
  right_gonion_inferior: 172,

  // Chin
  left_mentum_lateralis: 364,  // viewer's left = subject's right
  right_mentum_lateralis: 135, // viewer's right = subject's left
  menton: 152,

  // Cheeks (viewer's perspective: left = left side of image = subject's RIGHT)
  // Zygion (cheekbone) indices from face contour
  left_zygion: 454,    // viewer's left = subject's RIGHT cheekbone (face contour)
  right_zygion: 234,   // viewer's right = subject's LEFT cheekbone (face contour)
  // Temporal (temple) indices from face contour
  left_temporal: 356,  // viewer's left = subject's RIGHT temple area
  right_temporal: 127, // viewer's right = subject's LEFT temple area

  // Ears (using face contour points near ear area - MediaPipe has no true ear landmarks)
  left_auricular_lateral: 356,  // viewer's left = subject's RIGHT ear area
  right_auricular_lateral: 127, // viewer's right = subject's LEFT ear area

  // Neck (using lower jaw angle as reference - MediaPipe has no true neck landmarks)
  left_cervical_lateralis: 397,   // viewer's left = subject's RIGHT lower jaw
  right_cervical_lateralis: 172,  // viewer's right = subject's LEFT lower jaw
};

// Side profile landmark mapping (IDs must match SIDE_PROFILE_LANDMARKS in landmarks.ts)
// NOTE: Side profile assumes LEFT-FACING view (subject looking left, showing their RIGHT side to camera)
// This is the VIEWER's LEFT side of the image, which shows the SUBJECT's RIGHT side
// So we use MediaPipe's RIGHT side indices (subject's perspective)
export const MEDIAPIPE_SIDE_MAPPING: Record<string, number> = {
  // Cranium (center/top landmarks)
  vertex: 10,                    // top of head (center)
  external_occipital_region: 10, // back of skull approximation
  trichion_profile: 10,          // hairline (center)

  // Forehead (center landmarks)
  frontalis: 151,  // forehead center
  glabella: 9,     // between eyebrows (center)

  // Eye Region (subject's RIGHT eye visible in left-facing profile)
  corneal_apex: 473,           // subject's RIGHT iris center
  lateral_eyelid: 263,         // subject's RIGHT eye outer corner
  palpebra_inferior_side: 374, // subject's RIGHT lower eyelid
  orbitale: 374,               // subject's RIGHT infraorbital margin

  // Nose (center/midline landmarks)
  nasion: 6,           // nasal root/bridge (center)
  rhinion: 4,          // bony-cartilaginous junction
  supratip_break: 4,   // above tip
  pronasale: 1,        // nose tip (center)
  infratip_lobule: 2,  // below tip
  columella_nasi: 2,   // columella (center)
  subnasale_side: 2,   // base of columella (center)
  subalare: 358,       // alar base - subject's RIGHT nostril

  // Lips (mostly center landmarks)
  labrale_superius_side: 0,  // upper lip vermilion (center)
  cheilion_side: 291,        // mouth corner - subject's RIGHT
  labrale_inferius_side: 17, // lower lip vermilion (center)
  sublabiale: 18,            // labiomental fold (center)

  // Chin (center landmarks)
  pogonion: 152,    // chin prominence (center)
  menton_side: 152, // chin bottom (center)

  // Jaw (subject's RIGHT side visible in left-facing profile)
  gonion_superior_side: 345,  // subject's RIGHT upper jaw angle
  gonion_inferior_side: 397,  // subject's RIGHT lower jaw angle

  // Cheek (subject's RIGHT side visible)
  zygion_soft_tissue: 454,  // subject's RIGHT cheekbone

  // Ear (subject's RIGHT ear visible in left-facing profile)
  porion: 356,              // subject's RIGHT temple/ear area
  tragion: 356,             // subject's RIGHT tragus area
  incisura_intertragica: 356, // subject's RIGHT ear notch

  // Neck (approximate - MediaPipe has no true neck landmarks)
  cervicale: 152,                   // chin bottom as neck reference
  anterior_cervical_landmark: 152,  // chin bottom as neck reference
};

export interface DetectedLandmarks {
  landmarks: Array<{ id: string; x: number; y: number }>;
  confidence: number;
  faceBox: { x: number; y: number; width: number; height: number };
}

/**
 * Detect facial landmarks from an image URL
 * Uses the singleton FaceDetectionService for optimal performance
 */
export async function detectFromImageUrl(
  imageUrl: string,
  mode: 'front' | 'side'
): Promise<DetectedLandmarks | null> {
  try {
    // Load the image
    const img = await loadImage(imageUrl);

    // Use the singleton service
    const result = await faceDetectionService.detect(img);

    if (!result.faceLandmarks || result.faceLandmarks.length === 0) {
      console.log('No faces detected');
      return null;
    }

    const faceLandmarks = result.faceLandmarks[0];

    // Select mapping based on mode
    const mapping = mode === 'front' ? MEDIAPIPE_FRONT_MAPPING : MEDIAPIPE_SIDE_MAPPING;

    // Map keypoints to our landmarks
    const landmarks = Object.entries(mapping).map(([id, index]) => {
      // Handle index bounds
      const safeIndex = Math.min(index, faceLandmarks.length - 1);
      const landmark = faceLandmarks[safeIndex];

      return {
        id,
        // MediaPipe returns normalized coordinates (0-1)
        x: landmark ? landmark.x : 0.5,
        y: landmark ? landmark.y : 0.5,
      };
    });

    // Calculate face bounding box from all landmarks
    let minX = 1, minY = 1, maxX = 0, maxY = 0;
    faceLandmarks.forEach((lm) => {
      minX = Math.min(minX, lm.x);
      minY = Math.min(minY, lm.y);
      maxX = Math.max(maxX, lm.x);
      maxY = Math.max(maxY, lm.y);
    });

    return {
      landmarks,
      confidence: 0.95, // MediaPipe doesn't return confidence per landmark
      faceBox: {
        x: minX,
        y: minY,
        width: maxX - minX,
        height: maxY - minY,
      },
    };
  } catch (error) {
    console.error('Face detection error:', error);
    return null;
  }
}

/**
 * Load an image from URL
 */
function loadImage(url: string): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = (e) => reject(e);
    img.src = url;
  });
}

/**
 * Get the region to zoom into for a specific landmark
 */
export function getLandmarkZoomRegion(
  landmarkId: string
): { centerX: number; centerY: number; zoomLevel: number } {
  const regions: Record<string, { centerX: number; centerY: number; zoomLevel: number }> = {
    // Eyes - zoom in close
    left_pupila: { centerX: 0.35, centerY: 0.35, zoomLevel: 3 },
    left_canthus_medialis: { centerX: 0.4, centerY: 0.35, zoomLevel: 3 },
    left_canthus_lateralis: { centerX: 0.3, centerY: 0.35, zoomLevel: 3 },
    right_pupila: { centerX: 0.65, centerY: 0.35, zoomLevel: 3 },
    right_canthus_medialis: { centerX: 0.6, centerY: 0.35, zoomLevel: 3 },
    right_canthus_lateralis: { centerX: 0.7, centerY: 0.35, zoomLevel: 3 },

    // Brows
    left_supercilium_apex: { centerX: 0.35, centerY: 0.28, zoomLevel: 2.5 },
    right_supercilium_apex: { centerX: 0.65, centerY: 0.28, zoomLevel: 2.5 },

    // Nose
    nasal_base: { centerX: 0.5, centerY: 0.4, zoomLevel: 2 },
    subnasale: { centerX: 0.5, centerY: 0.55, zoomLevel: 2.5 },

    // Mouth
    labrale_superius: { centerX: 0.5, centerY: 0.6, zoomLevel: 2.5 },
    mouth_middle: { centerX: 0.5, centerY: 0.65, zoomLevel: 2 },

    // Chin
    menton: { centerX: 0.5, centerY: 0.85, zoomLevel: 2 },

    // Default for other landmarks
    default: { centerX: 0.5, centerY: 0.5, zoomLevel: 1.5 },
  };

  return regions[landmarkId] || regions.default;
}
