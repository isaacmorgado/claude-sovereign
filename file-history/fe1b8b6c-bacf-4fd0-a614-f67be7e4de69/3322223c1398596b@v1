#!/bin/bash
#
# SPLICE CEP Extension - Certificate Creation Script
# Creates a self-signed certificate for signing CEP extensions with ZXPSignCmd
#
# Usage: ./create-certificate.sh [--force]
#   --force: Overwrite existing certificate
#
# Environment Variables:
#   ZXP_CERT_PASSWORD - Password for the certificate (will prompt if not set)
#   ZXP_CERT_COUNTRY - Country code (default: US)
#   ZXP_CERT_STATE - State/Province (default: CA)
#   ZXP_CERT_ORG - Organization name (default: SPLICE Inc)
#   ZXP_CERT_NAME - Common name (default: SPLICE)
#

set -e

# Get script directory and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
BUILD_DIR="$PROJECT_ROOT/build"
CERT_DIR="$BUILD_DIR/certificates"
CERT_FILE="$CERT_DIR/splice-cert.p12"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print functions
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check prerequisites
check_prerequisites() {
    print_info "Checking prerequisites..."
    
    # Check for ZXPSignCmd
    if ! command -v ZXPSignCmd &> /dev/null; then
        # Check common installation locations
        local zxp_paths=(
            "$PROJECT_ROOT/tools/ZXPSignCmd"
            "/Applications/Adobe CC/ZXPSignCmd"
            "$HOME/bin/ZXPSignCmd"
            "/usr/local/bin/ZXPSignCmd"
            "./ZXPSignCmd"
        )
        
        local found=false
        for path in "${zxp_paths[@]}"; do
            if [[ -f "$path" ]]; then
                export PATH="$(dirname "$path"):$PATH"
                found=true
                break
            fi
        done
        
        if [[ "$found" == "false" ]]; then
            print_error "ZXPSignCmd not found in PATH"
            echo ""
            echo "Please download ZXPSignCmd from Adobe and add it to your PATH:"
            echo "  - Download: https://github.com/AdobeDocs/adobeio-runtime/blob/master/resources/ZXPSignCmd.md"
            echo "  - Or use: https://partners.adobe.com/exchangeprogram/creativecloud/support/exman-com-line-tool.html"
            echo ""
            echo "After downloading, you can:"
            echo "  1. Add it to /usr/local/bin/: sudo cp ZXPSignCmd /usr/local/bin/ && sudo chmod +x /usr/local/bin/ZXPSignCmd"
            echo "  2. Or add its location to PATH: export PATH=\"\$PATH:/path/to/ZXPSignCmd\""
            exit 1
        fi
    fi
    
    print_success "ZXPSignCmd found: $(which ZXPSignCmd)"
}

# Get or prompt for password
get_password() {
    if [[ -n "$ZXP_CERT_PASSWORD" ]]; then
        PASSWORD="$ZXP_CERT_PASSWORD"
        print_info "Using password from ZXP_CERT_PASSWORD environment variable"
    else
        print_warning "No ZXP_CERT_PASSWORD environment variable set"
        echo ""
        read -s -p "Enter certificate password: " PASSWORD
        echo ""
        read -s -p "Confirm password: " PASSWORD_CONFIRM
        echo ""
        
        if [[ "$PASSWORD" != "$PASSWORD_CONFIRM" ]]; then
            print_error "Passwords do not match"
            exit 1
        fi
        
        if [[ -z "$PASSWORD" ]]; then
            print_error "Password cannot be empty"
            exit 1
        fi
    fi
}

# Create certificate
create_certificate() {
    # Configuration with defaults
    local COUNTRY="${ZXP_CERT_COUNTRY:-US}"
    local STATE="${ZXP_CERT_STATE:-CA}"
    local ORG="${ZXP_CERT_ORG:-SPLICE Inc}"
    local NAME="${ZXP_CERT_NAME:-SPLICE}"
    
    print_info "Creating certificate directory..."
    mkdir -p "$CERT_DIR"
    
    # Check if certificate already exists
    if [[ -f "$CERT_FILE" ]]; then
        if [[ "$1" == "--force" ]]; then
            print_warning "Overwriting existing certificate (--force specified)"
            rm -f "$CERT_FILE"
        else
            print_error "Certificate already exists at: $CERT_FILE"
            echo ""
            echo "Use --force to overwrite, or delete the existing certificate:"
            echo "  rm $CERT_FILE"
            exit 1
        fi
    fi
    
    print_info "Creating self-signed certificate..."
    echo "  Country: $COUNTRY"
    echo "  State: $STATE"
    echo "  Organization: $ORG"
    echo "  Name: $NAME"
    echo "  Output: $CERT_FILE"
    echo ""
    
    # Create the certificate
    ZXPSignCmd -selfSignedCert "$COUNTRY" "$STATE" "$ORG" "$NAME" "$PASSWORD" "$CERT_FILE"
    
    if [[ -f "$CERT_FILE" ]]; then
        print_success "Certificate created successfully!"
        echo ""
        echo "Certificate location: $CERT_FILE"
        echo ""
        print_warning "IMPORTANT: Keep your certificate password secure!"
        echo "For CI/CD, set the ZXP_CERT_PASSWORD environment variable."
        echo ""
        print_info "Next steps:"
        echo "  1. Run ./build/scripts/sign-extension.sh to sign the extension"
        echo "  2. Run ./build/scripts/build-all.sh to build installers"
    else
        print_error "Certificate creation failed"
        exit 1
    fi
}

# Main execution
main() {
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║          SPLICE CEP Certificate Creation Tool              ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""
    
    check_prerequisites
    get_password
    create_certificate "$1"
}

main "$@"
