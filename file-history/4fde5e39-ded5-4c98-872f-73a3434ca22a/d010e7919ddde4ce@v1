-- Add referral tracking and password reset support

-- Add referral_code column to users (the code they used when signing up)
ALTER TABLE users ADD COLUMN IF NOT EXISTS referral_code VARCHAR(50);

-- Add referred_by to track which influencer referred them (Stripe promotion code ID)
ALTER TABLE users ADD COLUMN IF NOT EXISTS referred_by VARCHAR(100);

-- Add password reset token columns
ALTER TABLE users ADD COLUMN IF NOT EXISTS password_reset_token VARCHAR(255);
ALTER TABLE users ADD COLUMN IF NOT EXISTS password_reset_expires TIMESTAMP;

-- Create index on referral_code for analytics
CREATE INDEX IF NOT EXISTS idx_users_referral_code ON users(referral_code);
CREATE INDEX IF NOT EXISTS idx_users_referred_by ON users(referred_by);
CREATE INDEX IF NOT EXISTS idx_users_password_reset_token ON users(password_reset_token);

-- Create referral_codes table for influencer codes (linked to Stripe promotion codes)
CREATE TABLE IF NOT EXISTS referral_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(50) UNIQUE NOT NULL,
    influencer_name VARCHAR(100) NOT NULL,
    stripe_promotion_code_id VARCHAR(100),
    stripe_coupon_id VARCHAR(100),
    discount_percent INTEGER DEFAULT 10,
    is_active BOOLEAN DEFAULT true,
    total_uses INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Create index on code for fast lookups
CREATE INDEX IF NOT EXISTS idx_referral_codes_code ON referral_codes(code);
CREATE INDEX IF NOT EXISTS idx_referral_codes_stripe_promo ON referral_codes(stripe_promotion_code_id);
