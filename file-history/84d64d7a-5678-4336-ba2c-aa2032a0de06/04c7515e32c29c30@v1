/**
 * Unit tests for MediaPipe landmark detection mappings
 * Verifies that the index corrections are valid and no duplicates exist
 */

import { MEDIAPIPE_FRONT_MAPPING, MEDIAPIPE_SIDE_MAPPING } from './mediapipeDetection';

describe('MEDIAPIPE_FRONT_MAPPING', () => {
  test('should have no duplicate indices (excluding intentional aliases)', () => {
    const indices = Object.entries(MEDIAPIPE_FRONT_MAPPING);
    const indexCounts: Record<number, string[]> = {};

    for (const [name, index] of indices) {
      if (!indexCounts[index]) {
        indexCounts[index] = [];
      }
      indexCounts[index].push(name);
    }

    // Check for duplicates (allowing known aliases)
    const allowedAliases = [
      ['nasion', 'nasal_base'], // nasal_base is alias for nasion
    ];

    const duplicates: string[] = [];
    for (const [index, names] of Object.entries(indexCounts)) {
      if (names.length > 1) {
        // Check if this is an allowed alias
        const isAllowed = allowedAliases.some(
          alias => alias.every(a => names.includes(a)) && names.length === alias.length
        );
        if (!isAllowed) {
          duplicates.push(`Index ${index}: ${names.join(', ')}`);
        }
      }
    }

    expect(duplicates).toEqual([]);
  });

  test('should have correct pupil indices', () => {
    expect(MEDIAPIPE_FRONT_MAPPING.left_pupila).toBe(468);
    expect(MEDIAPIPE_FRONT_MAPPING.right_pupila).toBe(473);
  });

  test('should have correct eye corner indices', () => {
    // Left eye (subject's left)
    expect(MEDIAPIPE_FRONT_MAPPING.left_canthus_medialis).toBe(133);
    expect(MEDIAPIPE_FRONT_MAPPING.left_canthus_lateralis).toBe(33);

    // Right eye (subject's right)
    expect(MEDIAPIPE_FRONT_MAPPING.right_canthus_medialis).toBe(362);
    expect(MEDIAPIPE_FRONT_MAPPING.right_canthus_lateralis).toBe(263);
  });

  test('should have distinct eyelid indices (no duplicates)', () => {
    // Left eye - all should be unique
    const leftEyeIndices = [
      MEDIAPIPE_FRONT_MAPPING.left_palpebra_superior,
      MEDIAPIPE_FRONT_MAPPING.left_palpebra_inferior,
      MEDIAPIPE_FRONT_MAPPING.left_sulcus_palpebralis_lateralis,
      MEDIAPIPE_FRONT_MAPPING.left_pretarsal_skin_crease,
    ];
    const uniqueLeft = new Set(leftEyeIndices);
    expect(uniqueLeft.size).toBe(leftEyeIndices.length);

    // Right eye - all should be unique
    const rightEyeIndices = [
      MEDIAPIPE_FRONT_MAPPING.right_palpebra_superior,
      MEDIAPIPE_FRONT_MAPPING.right_palpebra_inferior,
      MEDIAPIPE_FRONT_MAPPING.right_sulcus_palpebralis_lateralis,
      MEDIAPIPE_FRONT_MAPPING.right_pretarsal_skin_crease,
    ];
    const uniqueRight = new Set(rightEyeIndices);
    expect(uniqueRight.size).toBe(rightEyeIndices.length);
  });

  test('should have distinct neck indices from jaw indices', () => {
    // Neck should NOT equal jaw
    expect(MEDIAPIPE_FRONT_MAPPING.left_cervical_lateralis).not.toBe(
      MEDIAPIPE_FRONT_MAPPING.left_gonion_inferior
    );
    expect(MEDIAPIPE_FRONT_MAPPING.right_cervical_lateralis).not.toBe(
      MEDIAPIPE_FRONT_MAPPING.right_gonion_inferior
    );
  });

  test('should have glabella landmark', () => {
    expect(MEDIAPIPE_FRONT_MAPPING.glabella).toBe(9);
  });

  test('should have correct nose indices per TECHNICAL_SPECS', () => {
    expect(MEDIAPIPE_FRONT_MAPPING.nasion).toBe(6);
    expect(MEDIAPIPE_FRONT_MAPPING.nasal_base).toBe(6); // Alias for nasion
    expect(MEDIAPIPE_FRONT_MAPPING.left_ala_nasi).toBe(129);
    expect(MEDIAPIPE_FRONT_MAPPING.right_ala_nasi).toBe(358);
    expect(MEDIAPIPE_FRONT_MAPPING.subnasale).toBe(2);
  });

  test('all indices should be within MediaPipe 478-point range', () => {
    for (const [name, index] of Object.entries(MEDIAPIPE_FRONT_MAPPING)) {
      expect(index).toBeGreaterThanOrEqual(0);
      expect(index).toBeLessThan(478);
    }
  });
});

describe('MEDIAPIPE_SIDE_MAPPING', () => {
  test('all indices should be within MediaPipe 478-point range', () => {
    for (const [name, index] of Object.entries(MEDIAPIPE_SIDE_MAPPING)) {
      expect(index).toBeGreaterThanOrEqual(0);
      expect(index).toBeLessThan(478);
    }
  });

  test('should have glabella for side profile', () => {
    expect(MEDIAPIPE_SIDE_MAPPING.glabella).toBe(9);
  });
});

// Run if executed directly
if (typeof describe === 'undefined') {
  console.log('Running landmark mapping validation...');

  // Check for duplicates
  const indices = Object.entries(MEDIAPIPE_FRONT_MAPPING);
  const indexCounts: Record<number, string[]> = {};

  for (const [name, index] of indices) {
    if (!indexCounts[index]) {
      indexCounts[index] = [];
    }
    indexCounts[index].push(name);
  }

  console.log('\n=== Duplicate Check ===');
  let hasDuplicates = false;
  for (const [index, names] of Object.entries(indexCounts)) {
    if (names.length > 1) {
      // Allow nasion/nasal_base alias
      if (names.includes('nasion') && names.includes('nasal_base') && names.length === 2) {
        console.log(`✓ Index ${index}: ${names.join(', ')} (allowed alias)`);
      } else {
        console.log(`✗ DUPLICATE Index ${index}: ${names.join(', ')}`);
        hasDuplicates = true;
      }
    }
  }

  if (!hasDuplicates) {
    console.log('✓ No unexpected duplicates found!');
  }

  console.log('\n=== Key Landmark Verification ===');
  console.log(`Pupils: left=${MEDIAPIPE_FRONT_MAPPING.left_pupila}, right=${MEDIAPIPE_FRONT_MAPPING.right_pupila}`);
  console.log(`Glabella: ${MEDIAPIPE_FRONT_MAPPING.glabella}`);
  console.log(`Nasion: ${MEDIAPIPE_FRONT_MAPPING.nasion}`);
  console.log(`Nostrils: left=${MEDIAPIPE_FRONT_MAPPING.left_ala_nasi}, right=${MEDIAPIPE_FRONT_MAPPING.right_ala_nasi}`);
}
