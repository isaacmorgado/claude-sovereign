'use client';

import React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';
import { LandmarkPoint } from '@/lib/landmarks';
import {
  analyzeFrontProfile,
  analyzeSideProfile,
  analyzeHarmony,
  HarmonyAnalysis,
  FaceIQScoreResult,
  FACEIQ_METRICS,
  Ethnicity,
  Gender,
} from '@/lib/faceiq-scoring';
import {
  Ratio,
  Strength,
  Flaw,
  Recommendation,
  ResultsTab,
  FullHarmonyAnalysis,
} from '@/types/results';

// ============================================
// CONTEXT TYPES
// ============================================

interface ResultsContextType {
  // Raw data
  frontLandmarks: LandmarkPoint[];
  sideLandmarks: LandmarkPoint[];
  gender: Gender;
  ethnicity: Ethnicity;
  frontPhoto: string;
  sidePhoto: string | null;

  // Computed results
  harmonyAnalysis: FullHarmonyAnalysis | null;
  frontRatios: Ratio[];
  sideRatios: Ratio[];
  strengths: Strength[];
  flaws: Flaw[];
  recommendations: Recommendation[];

  // Scores
  overallScore: number;
  frontScore: number;
  sideScore: number;

  // UI state
  activeTab: ResultsTab;
  setActiveTab: (tab: ResultsTab) => void;
  expandedMeasurementId: string | null;
  setExpandedMeasurementId: (id: string | null) => void;
  selectedVisualizationMetric: string | null;
  setSelectedVisualizationMetric: (id: string | null) => void;
  categoryFilter: string | null;
  setCategoryFilter: (category: string | null) => void;
  showLandmarkOverlay: boolean;
  setShowLandmarkOverlay: (show: boolean) => void;

  // Actions
  setResultsData: (data: ResultsInputData) => void;
}

interface ResultsInputData {
  frontLandmarks: LandmarkPoint[];
  sideLandmarks: LandmarkPoint[];
  frontPhoto: string;
  sidePhoto?: string;
  gender: Gender;
  ethnicity?: Ethnicity;
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {
  switch (unit) {
    case 'ratio': return 'x';
    case 'percent': return '%';
    case 'degrees': return '°';
    case 'mm': return 'mm';
    default: return 'x';
  }
}

function transformToRatio(result: FaceIQScoreResult, landmarks: LandmarkPoint[]): Ratio {
  const metricConfig = FACEIQ_METRICS[result.metricId];

  // Generate illustration based on metric
  const illustration = generateIllustration(result.metricId, landmarks);

  // Get flaw/strength mappings
  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);

  return {
    id: result.metricId,
    name: result.name,
    value: result.value,
    score: result.score,
    standardizedScore: result.standardizedScore,
    unit: convertUnitToRatioUnit(result.unit),
    idealMin: result.idealMin,
    idealMax: result.idealMax,
    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,
    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,
    description: metricConfig?.description || '',
    category: result.category,
    qualityLevel: result.qualityTier,
    severity: result.severity,
    illustration,
    mayIndicateFlaws,
    mayIndicateStrengths,
    usedLandmarks: getUsedLandmarks(result.metricId),
    scoringCurveConfig: metricConfig ? {
      decayRate: metricConfig.decayRate,
      maxScore: metricConfig.maxScore,
    } : undefined,
  };
}

// Enhanced illustration configuration type
interface IllustrationConfig {
  points: string[];
  lines: Array<{
    from: string;
    to: string;
    label?: string;
    color?: string;
    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type
  }>;
}

// Comprehensive illustration configurations for all metrics
const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {
  // ==========================================
  // FACE SHAPE / PROPORTIONS
  // ==========================================
  faceWidthToHeight: {
    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
    lines: [
      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },
      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },
    ],
  },
  totalFacialWidthToHeight: {
    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
    lines: [
      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },
      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },
    ],
  },
  lowerThirdProportion: {
    points: ['subnasale', 'menton', 'trichion'],
    lines: [
      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },
      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
    ],
  },
  middleThirdProportion: {
    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],
    lines: [
      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },
      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
    ],
  },
  upperThirdProportion: {
    points: ['trichion', 'nasal_base', 'menton'],
    lines: [
      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },
      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
    ],
  },
  bitemporalWidth: {
    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },
    ],
  },
  cheekboneHeight: {
    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],
    lines: [
      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },
      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },
    ],
  },
  midfaceRatio: {
    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],
    lines: [
      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },
      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },
    ],
  },

  // ==========================================
  // JAW MEASUREMENTS
  // ==========================================
  jawSlope: {
    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],
    lines: [
      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },
      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },
    ],
  },
  jawFrontalAngle: {
    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],
    lines: [
      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },
      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },
    ],
  },
  bigonialWidth: {
    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },
    ],
  },
  jawWidthRatio: {
    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },
    ],
  },

  // ==========================================
  // EYE MEASUREMENTS
  // ==========================================
  lateralCanthalTilt: {
    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],
    lines: [
      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },
      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },
    ],
  },
  eyeAspectRatio: {
    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],
    lines: [
      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },
      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },
    ],
  },
  eyeSeparationRatio: {
    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
    ],
  },
  interpupillaryRatio: {
    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
    ],
  },
  interpupillaryMouthWidthRatio: {
    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],
    lines: [
      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },
      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
    ],
  },
  oneEyeApartTest: {
    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],
    lines: [
      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },
      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },
    ],
  },

  // ==========================================
  // EYEBROW MEASUREMENTS
  // ==========================================
  browLengthRatio: {
    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
    ],
  },
  eyebrowTilt: {
    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],
    lines: [
      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },
      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },
    ],
  },
  eyebrowLowSetedness: {
    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],
    lines: [
      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },
    ],
  },

  // ==========================================
  // NOSE MEASUREMENTS (FRONT)
  // ==========================================
  nasalIndex: {
    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],
    lines: [
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },
      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },
    ],
  },
  intercanthalNasalRatio: {
    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],
    lines: [
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },
      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },
    ],
  },
  noseBridgeWidth: {
    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],
    lines: [
      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },
    ],
  },
  noseTipPosition: {
    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],
    lines: [
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },
    ],
  },

  // ==========================================
  // MOUTH/LIP MEASUREMENTS
  // ==========================================
  mouthNoseWidthRatio: {
    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],
    lines: [
      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },
    ],
  },
  lowerUpperLipRatio: {
    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],
    lines: [
      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },
      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },
    ],
  },
  chinPhiltrumRatio: {
    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],
    lines: [
      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },
      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },
    ],
  },
  mouthWidth: {
    points: ['left_cheilion', 'right_cheilion'],
    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],
  },

  // ==========================================
  // CHIN MEASUREMENTS
  // ==========================================
  chinHeight: {
    points: ['labrale_inferius', 'menton'],
    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],
  },

  // ==========================================
  // NECK MEASUREMENTS
  // ==========================================
  neckWidthRatio: {
    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],
    lines: [
      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },
      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },
    ],
  },

  // ==========================================
  // SIDE PROFILE MEASUREMENTS
  // ==========================================
  gonialAngle: {
    points: ['tragus', 'gonionBottom', 'menton'],
    lines: [
      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },
      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },
    ],
  },
  nasofrontalAngle: {
    points: ['glabella', 'nasion', 'pronasale'],
    lines: [
      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },
      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },
    ],
  },
  nasofacialAngle: {
    points: ['nasion', 'pronasale', 'pogonion'],
    lines: [
      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },
      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },
    ],
  },
  nasomentaAngle: {
    points: ['nasion', 'pronasale', 'pogonion'],
    lines: [
      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },
      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },
    ],
  },
  submentalCervicalAngle: {
    points: ['menton', 'cervicalPoint', 'neckPoint'],
    lines: [
      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },
      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },
    ],
  },
  facialDepthToHeight: {
    points: ['pronasale', 'tragus', 'nasion', 'menton'],
    lines: [
      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },
      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },
    ],
  },
  anteriorFacialDepth: {
    points: ['glabella', 'pronasale', 'pogonion'],
    lines: [
      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },
      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },
    ],
  },
  mandibularPlaneAngle: {
    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],
    lines: [
      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },
      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },
    ],
  },
  ramusToMandibleRatio: {
    points: ['gonionTop', 'gonionBottom', 'menton'],
    lines: [
      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },
      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },
    ],
  },
  orbitalVector: {
    points: ['cornealApex', 'orbitale', 'cheekbone'],
    lines: [
      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },
    ],
  },
  eLineLowerLip: {
    points: ['pronasale', 'pogonion', 'labraleInferius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },
    ],
  },
  sLineLowerLip: {
    points: ['pronasale', 'pogonion', 'labraleInferius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },
    ],
  },
  holdawayHLine: {
    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },
    ],
  },
  burstoneLowerLip: {
    points: ['subnasale', 'pogonion', 'labraleInferius'],
    lines: [
      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },
    ],
  },

  // ==========================================
  // ADDITIONAL FRONT PROFILE METRICS
  // ==========================================
  cupidsBowDepth: {
    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],
    lines: [
      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },
      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },
    ],
  },
  mouthCornerPosition: {
    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],
    lines: [
      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },
      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },
    ],
  },
  iaaJfaDeviation: {
    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],
    lines: [
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },
      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },
      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },
    ],
  },
  ipsilateralAlarAngle: {
    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],
    lines: [
      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },
      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },
    ],
  },
  earProtrusionAngle: {
    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],
    lines: [
      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },
    ],
  },
  earProtrusionRatio: {
    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],
    lines: [
      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },
      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },
    ],
  },
  mouthWidthToNoseRatio: {
    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],
    lines: [
      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },
    ],
  },
  lowerToUpperLipRatio: {
    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],
    lines: [
      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },
      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },
    ],
  },
  chinToPhiltrumRatio: {
    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],
    lines: [
      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },
      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },
    ],
  },

  // ==========================================
  // ADDITIONAL SIDE PROFILE METRICS
  // ==========================================
  nasolabialAngle: {
    points: ['columella', 'subnasale', 'labraleSuperius'],
    lines: [
      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },
      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },
    ],
  },
  nasalTipAngle: {
    points: ['nasion', 'pronasale', 'columella'],
    lines: [
      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },
      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },
    ],
  },
  nasalProjection: {
    points: ['alar_crease', 'pronasale', 'subnasale'],
    lines: [
      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },
    ],
  },
  nasalWToHRatio: {
    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],
    lines: [
      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },
      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },
    ],
  },
  noseTipRotationAngle: {
    points: ['columella', 'subnasale', 'labraleSuperius'],
    lines: [
      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },
    ],
  },
  frankfortTipAngle: {
    points: ['porion', 'orbitale', 'pronasale'],
    lines: [
      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },
    ],
  },
  mentolabialAngle: {
    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],
    lines: [
      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },
      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },
    ],
  },
  zAngle: {
    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],
    lines: [
      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },
    ],
  },
  facialConvexityGlabella: {
    points: ['glabella', 'subnasale', 'pogonion'],
    lines: [
      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },
      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
    ],
  },
  facialConvexityNasion: {
    points: ['nasion', 'subnasale', 'pogonion'],
    lines: [
      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },
      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
    ],
  },
  totalFacialConvexity: {
    points: ['glabella', 'pronasale', 'pogonion'],
    lines: [
      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },
      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
    ],
  },
  interiorMidfaceProjectionAngle: {
    points: ['orbitale', 'subnasale', 'pronasale'],
    lines: [
      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },
      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },
    ],
  },
  recessionFromFrankfort: {
    points: ['porion', 'orbitale', 'pogonion'],
    lines: [
      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },
    ],
  },
  gonionToMouthLine: {
    points: ['gonionBottom', 'cheilion', 'tragus'],
    lines: [
      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },
    ],
  },
  eLineUpperLip: {
    points: ['pronasale', 'pogonion', 'labraleSuperius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },
    ],
  },
  sLineUpperLip: {
    points: ['pronasale', 'pogonion', 'labraleSuperius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },
    ],
  },
  burstoneUpperLip: {
    points: ['subnasale', 'pogonion', 'labraleSuperius'],
    lines: [
      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },
    ],
  },
  chinProjection: {
    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],
    lines: [
      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },
    ],
  },
  recessionRelativeToFrankfort: {
    points: ['porion', 'orbitale', 'pogonion', 'menton'],
    lines: [
      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },
    ],
  },
  browridgeInclinationAngle: {
    points: ['glabella', 'trichion', 'nasion'],
    lines: [
      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },
      { from: 'glabella', to: 'nasion', color: '#67e8f9' },
    ],
  },
  upperForeheadSlope: {
    points: ['trichion', 'glabella', 'frankfortHorizontal'],
    lines: [
      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },
    ],
  },
  midfaceProjectionAngle: {
    points: ['orbitale', 'subnasale', 'pronasale'],
    lines: [
      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },
      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },
    ],
  },
};

function generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {
  const landmarkMap: Record<string, LandmarkPoint> = {};
  landmarks.forEach(l => { landmarkMap[l.id] = l; });

  const config = ILLUSTRATION_CONFIGS[metricId];
  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};
  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};

  if (config) {
    config.points.forEach((pointId, i) => {
      if (landmarkMap[pointId]) {
        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };
      }
    });
    config.lines.forEach((line, i) => {
      lines[`line_${i}`] = {
        from: line.from,
        to: line.to,
        color: line.color || '#67e8f9',
        label: line.label,
        labelPosition: line.labelPosition,
      };
    });
  }

  return { points, lines };
}

function getUsedLandmarks(metricId: string): string[] {
  const landmarkMappings: Record<string, string[]> = {
    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],
    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],
    ipd: ['left_pupila', 'right_pupila'],
    mouthWidth: ['left_cheilion', 'right_cheilion'],
    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],
    chinHeight: ['labrale_inferius', 'menton'],
    gonialAngle: ['tragus', 'gonionBottom', 'menton'],
  };
  return landmarkMappings[metricId] || [];
}

function getFlawStrengthMappings(result: FaceIQScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {
  const flawMappings: Record<string, { low: string[]; high: string[] }> = {
    faceWidthToHeight: {
      low: ['Narrow face', 'Vertically elongated face'],
      high: ['Wide face', 'Horizontally expanded face'],
    },
    lowerThirdProportion: {
      low: ['Short lower third', 'Deficient mandible'],
      high: ['Long lower third', 'Mandibular excess'],
    },
    lateralCanthalTilt: {
      low: ['Negative canthal tilt', 'Drooping eyes'],
      high: ['Excessive positive canthal tilt'],
    },
    nasalIndex: {
      low: ['Narrow nose', 'Leptorrhine nose'],
      high: ['Wide nose', 'Platyrrhine nose'],
    },
    gonialAngle: {
      low: ['Steep mandibular plane'],
      high: ['Flat mandibular plane', 'Weak jaw definition'],
    },
  };

  const strengthMappings: Record<string, { ideal: string[] }> = {
    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },
    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },
    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },
    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },
  };

  const mapping = flawMappings[result.metricId];
  const strengthMapping = strengthMappings[result.metricId];

  let mayIndicateFlaws: string[] = [];
  let mayIndicateStrengths: string[] = [];

  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {
    mayIndicateStrengths = strengthMapping?.ideal || [];
  } else if (mapping) {
    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;
  }

  return { mayIndicateFlaws, mayIndicateStrengths };
}

function generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {
  const strengths: Strength[] = [];

  analysis.strengths.forEach((s, i) => {
    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);

    strengths.push({
      id: `strength_${i}`,
      strengthName: s.metricName,
      summary: s.reasoning,
      avgScore: matchingMeasurement?.score || 8,
      qualityLevel: s.qualityTier,
      categoryName: s.category,
      responsibleRatios: [{
        ratioName: s.metricName,
        ratioId: s.metricId,
        score: matchingMeasurement?.score || 8,
        value: s.value,
      }],
    });
  });

  return strengths;
}

function generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {
  const flaws: Flaw[] = [];
  let rollingLost = 0;

  analysis.flaws.forEach((f, i) => {
    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);
    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;
    rollingLost += impact;

    flaws.push({
      id: `flaw_${i}`,
      flawName: f.metricName,
      summary: f.reasoning,
      harmonyPercentageLost: impact,
      standardizedImpact: impact / 10,
      categoryName: f.category,
      responsibleRatios: [{
        ratioName: f.metricName,
        ratioId: f.metricId,
        score: matchingMeasurement?.score || 3,
        value: matchingMeasurement?.value || 0,
      }],
      rollingPointsDeducted: rollingLost,
      rollingHarmonyPercentageLost: rollingLost,
      rollingStandardizedImpact: rollingLost / 10,
    });
  });

  return flaws.sort((a, b) => b.harmonyPercentageLost - a.harmonyPercentageLost);
}

// Comprehensive procedure database with metric-specific targeting
interface ProcedureConfig {
  ref_id: string;
  name: string;
  description: string;
  phase: 'Surgical' | 'Minimally Invasive' | 'Foundational';
  baseImpact: number;
  coverage: number;
  percentage: string;
  expectedImprovementRange: { min: number; max: number };
  targetMetrics: string[];  // Specific metric IDs this treatment addresses
  targetCategories: string[];  // Category names this treatment addresses
  targetKeywords: string[];  // Flaw name keywords to match
  timeline: { effect_start: 'immediate' | 'delayed' | 'gradual'; full_results_weeks: number; full_results_weeks_max?: number };
  cost: { type: 'flat' | 'per_session' | 'per_month'; min: number; max: number; currency: string };
  risks_side_effects: string;
  warnings: string[];
  gender: 'male' | 'female' | 'both';
}

const PROCEDURE_DATABASE: ProcedureConfig[] = [
  // ==========================================
  // SURGICAL TREATMENTS
  // ==========================================
  {
    ref_id: 'SUR-01',
    name: 'Sliding Genioplasty',
    description: 'Chin bone repositioning surgery that can move the chin forward, backward, up, or down for optimal projection and facial balance.',
    phase: 'Surgical',
    baseImpact: 0.90,
    coverage: 8,
    percentage: '15-25%',
    expectedImprovementRange: { min: 0.5, max: 1.5 },
    targetMetrics: ['chinPhiltrumRatio', 'facialDepthToHeight', 'anteriorFacialDepth', 'nasomentaAngle'],
    targetCategories: ['Chin', 'Occlusion/Jaw Growth'],
    targetKeywords: ['chin', 'recessed', 'weak', 'short chin', 'long chin', 'pogonion'],
    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },
    cost: { type: 'flat', min: 5000, max: 15000, currency: 'USD' },
    risks_side_effects: 'Temporary numbness, swelling, bruising. Rare: infection, nerve damage, bone resorption.',
    warnings: [],
    gender: 'both',
  },
  {
    ref_id: 'SUR-02',
    name: 'Reduction Rhinoplasty',
    description: 'Surgical reduction of nose size, hump removal, and tip refinement to improve nasal proportions.',
    phase: 'Surgical',
    baseImpact: 0.85,
    coverage: 6,
    percentage: '10-20%',
    expectedImprovementRange: { min: 0.5, max: 1.0 },
    targetMetrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],
    targetCategories: ['Nose'],
    targetKeywords: ['wide nose', 'large nose', 'dorsal hump', 'bulbous', 'nasal', 'nose bridge'],
    timeline: { effect_start: 'delayed', full_results_weeks: 24, full_results_weeks_max: 52 },
    cost: { type: 'flat', min: 7000, max: 20000, currency: 'USD' },
    risks_side_effects: 'Swelling for 6-12 months, numbness, possible revision needed.',
    warnings: [],
    gender: 'both',
  },
  {
    ref_id: 'SUR-03',
    name: 'Jaw Angle Implants',
    description: 'Custom or standard silicone/PEEK implants to enhance jaw width, definition, and angularity.',
    phase: 'Surgical',
    baseImpact: 0.80,
    coverage: 5,
    percentage: '10-15%',
    expectedImprovementRange: { min: 0.4, max: 1.0 },
    targetMetrics: ['bigonialWidth', 'jawFrontalAngle', 'jawWidthRatio', 'jawSlope', 'gonialAngle'],
    targetCategories: ['Jaw Shape'],
    targetKeywords: ['narrow jaw', 'weak jaw', 'soft jaw', 'jaw angle', 'gonial', 'mandible'],
    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },
    cost: { type: 'flat', min: 8000, max: 25000, currency: 'USD' },
    risks_side_effects: 'Swelling, asymmetry risk, implant migration, infection, bone erosion.',
    warnings: [],
    gender: 'both',
  },
  {
    ref_id: 'SUR-04',
    name: 'Bimaxillary Osteotomy (Bimax)',
    description: 'Double jaw surgery to reposition both upper and lower jaws for optimal occlusion and facial balance.',
    phase: 'Surgical',
    baseImpact: 0.95,
    coverage: 12,
    percentage: '20-35%',
    expectedImprovementRange: { min: 1.0, max: 2.0 },
    targetMetrics: ['midfaceRatio', 'facialDepthToHeight', 'mandibularPlaneAngle', 'lowerThirdProportion', 'nasofacialAngle'],
    targetCategories: ['Occlusion/Jaw Growth', 'Midface/Face Shape'],
    targetKeywords: ['maxillary recession', 'mandibular', 'hyper-divergent', 'bite', 'occlusion', 'midface recession'],
    timeline: { effect_start: 'delayed', full_results_weeks: 24, full_results_weeks_max: 52 },
    cost: { type: 'flat', min: 20000, max: 60000, currency: 'USD' },
    risks_side_effects: 'Extended recovery, numbness (temporary to permanent), dietary restrictions.',
    warnings: ['Major surgery - requires orthodontic preparation'],
    gender: 'both',
  },
  {
    ref_id: 'SUR-05',
    name: 'Canthoplasty',
    description: 'Surgical eye corner modification to improve canthal tilt and eye shape.',
    phase: 'Surgical',
    baseImpact: 0.75,
    coverage: 3,
    percentage: '8-15%',
    expectedImprovementRange: { min: 0.3, max: 0.8 },
    targetMetrics: ['lateralCanthalTilt', 'eyeAspectRatio'],
    targetCategories: ['Eyes'],
    targetKeywords: ['canthal tilt', 'negative tilt', 'drooping eyes', 'eye shape', 'eye angle'],
    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },
    cost: { type: 'flat', min: 4000, max: 12000, currency: 'USD' },
    risks_side_effects: 'Scarring, asymmetry, dry eyes, ectropion.',
    warnings: ['Difficult to reverse'],
    gender: 'both',
  },
  {
    ref_id: 'SUR-06',
    name: 'Cheek/Malar Implants',
    description: 'Solid implants placed over the cheekbones to enhance midface projection and width.',
    phase: 'Surgical',
    baseImpact: 0.75,
    coverage: 4,
    percentage: '10-18%',
    expectedImprovementRange: { min: 0.4, max: 0.9 },
    targetMetrics: ['cheekboneHeight', 'midfaceRatio', 'totalFacialWidthToHeight'],
    targetCategories: ['Midface/Face Shape'],
    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface', 'zygomatic', 'malar'],
    timeline: { effect_start: 'delayed', full_results_weeks: 6, full_results_weeks_max: 12 },
    cost: { type: 'flat', min: 6000, max: 15000, currency: 'USD' },
    risks_side_effects: 'Swelling, asymmetry, implant shifting, nerve damage.',
    warnings: [],
    gender: 'both',
  },
  {
    ref_id: 'SUR-07',
    name: 'Neck Liposuction / Submentoplasty',
    description: 'Fat removal and skin tightening under the chin and neck area.',
    phase: 'Surgical',
    baseImpact: 0.65,
    coverage: 3,
    percentage: '8-12%',
    expectedImprovementRange: { min: 0.3, max: 0.7 },
    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],
    targetCategories: ['Neck'],
    targetKeywords: ['round neck', 'double chin', 'submental', 'cervical', 'neck definition'],
    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },
    cost: { type: 'flat', min: 3000, max: 8000, currency: 'USD' },
    risks_side_effects: 'Swelling, bruising, skin irregularity, numbness.',
    warnings: [],
    gender: 'both',
  },
  {
    ref_id: 'SUR-08',
    name: 'Brow Bone Reduction/Augmentation',
    description: 'Surgical reshaping of the brow ridge for improved upper third harmony.',
    phase: 'Surgical',
    baseImpact: 0.70,
    coverage: 3,
    percentage: '8-15%',
    expectedImprovementRange: { min: 0.3, max: 0.7 },
    targetMetrics: ['nasofrontalAngle', 'bitemporalWidth', 'upperThirdProportion'],
    targetCategories: ['Upper Third'],
    targetKeywords: ['brow ridge', 'forehead', 'nasofrontal', 'upper third', 'glabella'],
    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },
    cost: { type: 'flat', min: 8000, max: 20000, currency: 'USD' },
    risks_side_effects: 'Swelling, numbness, scarring (if coronal incision).',
    warnings: [],
    gender: 'both',
  },

  // ==========================================
  // MINIMALLY INVASIVE TREATMENTS
  // ==========================================
  {
    ref_id: 'MIN-01',
    name: 'Chin/Jawline Filler',
    description: 'Hyaluronic acid injections to enhance chin projection and jawline definition. Reversible and temporary.',
    phase: 'Minimally Invasive',
    baseImpact: 0.45,
    coverage: 4,
    percentage: '5-10%',
    expectedImprovementRange: { min: 0.2, max: 0.5 },
    targetMetrics: ['chinPhiltrumRatio', 'jawFrontalAngle', 'bigonialWidth'],
    targetCategories: ['Chin', 'Jaw Shape'],
    targetKeywords: ['weak chin', 'recessed chin', 'soft jaw', 'jawline'],
    timeline: { effect_start: 'immediate', full_results_weeks: 1 },
    cost: { type: 'per_session', min: 800, max: 2500, currency: 'USD' },
    risks_side_effects: 'Bruising, swelling, rare vascular occlusion.',
    warnings: ['Results temporary (12-18 months)', 'Requires maintenance'],
    gender: 'both',
  },
  {
    ref_id: 'MIN-02',
    name: 'Cheek Filler',
    description: 'HA filler to enhance cheekbone projection and midface volume.',
    phase: 'Minimally Invasive',
    baseImpact: 0.40,
    coverage: 3,
    percentage: '5-8%',
    expectedImprovementRange: { min: 0.2, max: 0.4 },
    targetMetrics: ['cheekboneHeight', 'midfaceRatio'],
    targetCategories: ['Midface/Face Shape'],
    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface volume'],
    timeline: { effect_start: 'immediate', full_results_weeks: 1 },
    cost: { type: 'per_session', min: 600, max: 1800, currency: 'USD' },
    risks_side_effects: 'Bruising, swelling, asymmetry.',
    warnings: ['Results temporary (12-18 months)'],
    gender: 'both',
  },
  {
    ref_id: 'MIN-03',
    name: 'Lip Filler',
    description: 'Hyaluronic acid to enhance lip volume and proportions.',
    phase: 'Minimally Invasive',
    baseImpact: 0.35,
    coverage: 2,
    percentage: '3-6%',
    expectedImprovementRange: { min: 0.1, max: 0.3 },
    targetMetrics: ['lowerUpperLipRatio', 'mouthNoseWidthRatio'],
    targetCategories: ['Lips'],
    targetKeywords: ['thin lip', 'lip ratio', 'lip volume', 'upper lip', 'lower lip'],
    timeline: { effect_start: 'immediate', full_results_weeks: 1 },
    cost: { type: 'per_session', min: 400, max: 1200, currency: 'USD' },
    risks_side_effects: 'Bruising, swelling, lumps.',
    warnings: ['Results temporary (6-12 months)'],
    gender: 'both',
  },
  {
    ref_id: 'MIN-04',
    name: 'PDO Thread Lift',
    description: 'Dissolvable threads to lift and tighten skin, particularly for canthal tilt improvement.',
    phase: 'Minimally Invasive',
    baseImpact: 0.35,
    coverage: 3,
    percentage: '4-8%',
    expectedImprovementRange: { min: 0.1, max: 0.4 },
    targetMetrics: ['lateralCanthalTilt', 'eyebrowLowSetedness'],
    targetCategories: ['Eyes', 'Upper Third'],
    targetKeywords: ['canthal tilt', 'drooping', 'sagging', 'eyebrow position'],
    timeline: { effect_start: 'immediate', full_results_weeks: 4, full_results_weeks_max: 12 },
    cost: { type: 'per_session', min: 1500, max: 4000, currency: 'USD' },
    risks_side_effects: 'Bruising, asymmetry, thread visibility, infection.',
    warnings: ['Results temporary (12-18 months)'],
    gender: 'both',
  },
  {
    ref_id: 'MIN-05',
    name: 'Masseter Botox',
    description: 'Botulinum toxin to slim the lower face by relaxing masseter muscles.',
    phase: 'Minimally Invasive',
    baseImpact: 0.40,
    coverage: 2,
    percentage: '4-8%',
    expectedImprovementRange: { min: 0.2, max: 0.4 },
    targetMetrics: ['bigonialWidth', 'jawWidthRatio', 'faceWidthToHeight'],
    targetCategories: ['Jaw Shape', 'Midface/Face Shape'],
    targetKeywords: ['wide jaw', 'square jaw', 'masseter', 'bruxism'],
    timeline: { effect_start: 'delayed', full_results_weeks: 4, full_results_weeks_max: 12 },
    cost: { type: 'per_session', min: 400, max: 1000, currency: 'USD' },
    risks_side_effects: 'Temporary weakness, asymmetry, difficulty chewing.',
    warnings: ['Results temporary (4-6 months)', 'Requires regular maintenance'],
    gender: 'both',
  },
  {
    ref_id: 'MIN-06',
    name: 'Kybella (Submental Fat Dissolving)',
    description: 'Injectable deoxycholic acid to permanently destroy fat cells under the chin.',
    phase: 'Minimally Invasive',
    baseImpact: 0.45,
    coverage: 2,
    percentage: '5-10%',
    expectedImprovementRange: { min: 0.2, max: 0.5 },
    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],
    targetCategories: ['Neck'],
    targetKeywords: ['double chin', 'submental fat', 'neck definition'],
    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },
    cost: { type: 'per_session', min: 1200, max: 1800, currency: 'USD' },
    risks_side_effects: 'Swelling, bruising, numbness, difficulty swallowing (temporary).',
    warnings: ['Requires 2-4 sessions'],
    gender: 'both',
  },

  // ==========================================
  // FOUNDATIONAL TREATMENTS
  // ==========================================
  {
    ref_id: 'FND-01',
    name: 'Mewing / Proper Tongue Posture',
    description: 'Maintaining correct tongue posture on the palate to potentially influence facial development over time.',
    phase: 'Foundational',
    baseImpact: 0.25,
    coverage: 5,
    percentage: '2-5%',
    expectedImprovementRange: { min: 0.1, max: 0.3 },
    targetMetrics: ['midfaceRatio', 'bigonialWidth', 'facialDepthToHeight'],
    targetCategories: ['Midface/Face Shape', 'Jaw Shape', 'Occlusion/Jaw Growth'],
    targetKeywords: ['midface', 'palate', 'recession', 'jaw development'],
    timeline: { effect_start: 'gradual', full_results_weeks: 104, full_results_weeks_max: 260 },
    cost: { type: 'flat', min: 0, max: 0, currency: 'USD' },
    risks_side_effects: 'None if done correctly. Jaw pain if excessive.',
    warnings: ['Results vary significantly', 'Most effective in younger individuals'],
    gender: 'both',
  },
  {
    ref_id: 'FND-02',
    name: 'Body Recomposition (Leanmaxxing)',
    description: 'Reducing body fat percentage to enhance facial definition and reveal underlying bone structure.',
    phase: 'Foundational',
    baseImpact: 0.35,
    coverage: 6,
    percentage: '5-12%',
    expectedImprovementRange: { min: 0.2, max: 0.5 },
    targetMetrics: ['bigonialWidth', 'submentalCervicalAngle', 'cheekboneHeight'],
    targetCategories: ['Jaw Shape', 'Neck', 'Midface/Face Shape'],
    targetKeywords: ['soft jaw', 'undefined', 'round', 'facial definition'],
    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 52 },
    cost: { type: 'per_month', min: 50, max: 200, currency: 'USD' },
    risks_side_effects: 'None if done healthily.',
    warnings: [],
    gender: 'both',
  },
  {
    ref_id: 'FND-03',
    name: 'Posture Correction',
    description: 'Improving head and neck posture to optimize facial appearance and reduce forward head posture effects.',
    phase: 'Foundational',
    baseImpact: 0.20,
    coverage: 3,
    percentage: '2-5%',
    expectedImprovementRange: { min: 0.1, max: 0.2 },
    targetMetrics: ['submentalCervicalAngle', 'anteriorFacialDepth'],
    targetCategories: ['Neck', 'Occlusion/Jaw Growth'],
    targetKeywords: ['neck', 'posture', 'forward head'],
    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 52 },
    cost: { type: 'flat', min: 0, max: 100, currency: 'USD' },
    risks_side_effects: 'None.',
    warnings: [],
    gender: 'both',
  },
  {
    ref_id: 'FND-04',
    name: 'Skincare Routine (Retinoid + SPF)',
    description: 'Medical-grade skincare to improve skin quality, texture, and reduce aging signs.',
    phase: 'Foundational',
    baseImpact: 0.20,
    coverage: 2,
    percentage: '2-5%',
    expectedImprovementRange: { min: 0.1, max: 0.3 },
    targetMetrics: [],
    targetCategories: [],
    targetKeywords: ['skin', 'texture', 'aging'],
    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 26 },
    cost: { type: 'per_month', min: 30, max: 150, currency: 'USD' },
    risks_side_effects: 'Initial irritation, sun sensitivity.',
    warnings: [],
    gender: 'both',
  },
  {
    ref_id: 'FND-05',
    name: 'Eyebrow Grooming / Microblading',
    description: 'Professional shaping or semi-permanent tattooing to optimize eyebrow shape and position.',
    phase: 'Foundational',
    baseImpact: 0.25,
    coverage: 2,
    percentage: '3-6%',
    expectedImprovementRange: { min: 0.1, max: 0.3 },
    targetMetrics: ['eyebrowTilt', 'eyebrowLowSetedness', 'browLengthRatio'],
    targetCategories: ['Upper Third'],
    targetKeywords: ['eyebrow', 'brow', 'upper third'],
    timeline: { effect_start: 'immediate', full_results_weeks: 1 },
    cost: { type: 'flat', min: 20, max: 600, currency: 'USD' },
    risks_side_effects: 'Minimal for grooming. Microblading: infection risk, color fading.',
    warnings: [],
    gender: 'both',
  },
];

// Calculate relevance score based on multiple factors
function calculateRelevanceScore(
  proc: ProcedureConfig,
  flaw: Flaw,
  allFlaws: Flaw[]
): number {
  let score = 0;

  // Check metric ID match (highest priority)
  const metricId = flaw.responsibleRatios[0]?.ratioId || '';
  if (proc.targetMetrics.includes(metricId)) {
    score += 40;
  }

  // Check category match
  if (proc.targetCategories.some(cat =>
    flaw.categoryName.toLowerCase().includes(cat.toLowerCase()) ||
    cat.toLowerCase().includes(flaw.categoryName.toLowerCase())
  )) {
    score += 25;
  }

  // Check keyword match
  const flawLower = flaw.flawName.toLowerCase();
  const summaryLower = flaw.summary.toLowerCase();
  const matchedKeywords = proc.targetKeywords.filter(kw =>
    flawLower.includes(kw.toLowerCase()) || summaryLower.includes(kw.toLowerCase())
  );
  score += matchedKeywords.length * 10;

  // Adjust by flaw severity/impact
  score += Math.min(flaw.harmonyPercentageLost * 3, 15);

  // Bonus if this procedure addresses multiple flaws
  const otherFlawsAddressed = allFlaws.filter(f =>
    f.id !== flaw.id && (
      proc.targetMetrics.includes(f.responsibleRatios[0]?.ratioId || '') ||
      proc.targetCategories.some(cat => f.categoryName.toLowerCase().includes(cat.toLowerCase()))
    )
  );
  score += otherFlawsAddressed.length * 5;

  return Math.min(score, 100);
}

function generateRecommendations(flaws: Flaw[], frontRatios: Ratio[] = [], sideRatios: Ratio[] = []): Recommendation[] {
  const recommendations: Recommendation[] = [];
  const allRatios = [...frontRatios, ...sideRatios];

  // Track which procedures have been added and their matched flaws
  const procMatches: Map<string, { flaws: string[]; ratios: string[]; maxScore: number }> = new Map();

  flaws.forEach(flaw => {
    PROCEDURE_DATABASE.forEach(proc => {
      const relevanceScore = calculateRelevanceScore(proc, flaw, flaws);

      if (relevanceScore >= 25) {  // Minimum threshold
        const existing = procMatches.get(proc.ref_id);
        if (existing) {
          existing.flaws.push(flaw.flawName);
          existing.ratios.push(...flaw.responsibleRatios.map(r => r.ratioName));
          existing.maxScore = Math.max(existing.maxScore, relevanceScore);
        } else {
          procMatches.set(proc.ref_id, {
            flaws: [flaw.flawName],
            ratios: flaw.responsibleRatios.map(r => r.ratioName),
            maxScore: relevanceScore,
          });
        }
      }
    });
  });

  // Build recommendations from matched procedures
  procMatches.forEach((match, procId) => {
    const proc = PROCEDURE_DATABASE.find(p => p.ref_id === procId);
    if (!proc) return;

    // Calculate expected improvement based on severity of matched flaws
    const matchedFlawDetails = flaws.filter(f => match.flaws.includes(f.flawName));
    const avgImpact = matchedFlawDetails.reduce((sum, f) => sum + f.harmonyPercentageLost, 0) / matchedFlawDetails.length;
    const severityMultiplier = Math.min(avgImpact / 3, 1.5);  // More severe = more potential improvement

    // Get affected ratios from the actual data
    const affectedRatios = allRatios.filter(r =>
      proc.targetMetrics.includes(r.id) ||
      match.flaws.some(f => f.toLowerCase().includes(r.category.toLowerCase()))
    );

    const adjustedImpact = proc.baseImpact * (0.8 + (match.maxScore / 500));  // Slight boost for high relevance

    recommendations.push({
      ref_id: proc.ref_id,
      name: proc.name,
      description: proc.description,
      phase: proc.phase,
      impact: adjustedImpact,
      coverage: match.flaws.length + match.ratios.length,
      percentage: proc.percentage,
      expectedImprovementRange: {
        min: proc.expectedImprovementRange.min * severityMultiplier,
        max: proc.expectedImprovementRange.max * severityMultiplier,
      },
      matchedFlaws: Array.from(new Set(match.flaws)),
      matchedRatios: Array.from(new Set(match.ratios)),
      ratios_impacted: affectedRatios.map(r => ({
        ratioId: r.id,
        ratioName: r.name,
        direction: 'both' as const,
        percentageEffect: proc.baseImpact,
      })),
      timeline: proc.timeline,
      cost: proc.cost,
      risks_side_effects: proc.risks_side_effects,
      warnings: proc.warnings,
      gender: proc.gender,
    });
  });

  // Sort by impact (higher = better), then by coverage (more flaws addressed = better)
  return recommendations.sort((a, b) => {
    const impactDiff = b.impact - a.impact;
    if (Math.abs(impactDiff) > 0.1) return impactDiff;
    return b.coverage - a.coverage;
  });
}

// ============================================
// CONTEXT CREATION
// ============================================

const ResultsContext = createContext<ResultsContextType | null>(null);

export function useResults(): ResultsContextType {
  const context = useContext(ResultsContext);
  if (!context) {
    throw new Error('useResults must be used within a ResultsProvider');
  }
  return context;
}

interface ResultsProviderProps {
  children: ReactNode;
  initialData?: ResultsInputData;
}

export function ResultsProvider({ children, initialData }: ResultsProviderProps) {
  // Raw data state
  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);
  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);
  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');
  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');
  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');
  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);

  // UI state
  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');
  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);
  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);
  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);
  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);

  // Compute analysis results (now with demographic-specific scoring)
  const analysisResults = useMemo(() => {
    if (frontLandmarks.length === 0) {
      return null;
    }

    try {
      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);
      const sideAnalysis = sideLandmarks.length > 0
        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)
        : null;
      // analyzeHarmony expects landmarks directly, not analysis results
      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);

      return { frontAnalysis, sideAnalysis, harmony };
    } catch (error) {
      console.error('Analysis error:', error);
      return null;
    }
  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);

  // Transform to Ratio format
  const frontRatios = useMemo(() => {
    if (!analysisResults?.frontAnalysis) return [];
    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));
  }, [analysisResults, frontLandmarks]);

  const sideRatios = useMemo(() => {
    if (!analysisResults?.sideAnalysis) return [];
    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));
  }, [analysisResults, sideLandmarks]);

  // Generate strengths and flaws
  const strengths = useMemo(() => {
    if (!analysisResults?.harmony) return [];
    return generateStrengthsFromAnalysis(analysisResults.harmony);
  }, [analysisResults]);

  const flaws = useMemo(() => {
    if (!analysisResults?.harmony) return [];
    return generateFlawsFromAnalysis(analysisResults.harmony);
  }, [analysisResults]);

  // Generate recommendations with metric-aware matching
  const recommendations = useMemo(() => {
    return generateRecommendations(flaws, frontRatios, sideRatios);
  }, [flaws, frontRatios, sideRatios]);

  // Build full harmony analysis
  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {
    if (!analysisResults?.harmony) return null;

    return {
      standardizedScore: analysisResults.harmony.overallScore,
      front: {
        standardizedScore: analysisResults.harmony.frontScore,
        ratios: frontRatios,
      },
      side: {
        standardizedScore: analysisResults.harmony.sideScore,
        ratios: sideRatios,
      },
      strengths,
      flaws,
    };
  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);

  // Scores
  const overallScore = analysisResults?.harmony?.overallScore || 0;
  const frontScore = analysisResults?.harmony?.frontScore || 0;
  const sideScore = analysisResults?.harmony?.sideScore || 0;

  // Action to set all results data
  const setResultsData = useCallback((data: ResultsInputData) => {
    setFrontLandmarks(data.frontLandmarks);
    setSideLandmarks(data.sideLandmarks);
    setFrontPhoto(data.frontPhoto);
    setSidePhoto(data.sidePhoto || null);
    setGender(data.gender);
    setEthnicity(data.ethnicity || 'other');
  }, []);

  const value: ResultsContextType = {
    frontLandmarks,
    sideLandmarks,
    gender,
    ethnicity,
    frontPhoto,
    sidePhoto,
    harmonyAnalysis,
    frontRatios,
    sideRatios,
    strengths,
    flaws,
    recommendations,
    overallScore,
    frontScore,
    sideScore,
    activeTab,
    setActiveTab,
    expandedMeasurementId,
    setExpandedMeasurementId,
    selectedVisualizationMetric,
    setSelectedVisualizationMetric,
    categoryFilter,
    setCategoryFilter,
    showLandmarkOverlay,
    setShowLandmarkOverlay,
    setResultsData,
  };

  return (
    <ResultsContext.Provider value={value}>
      {children}
    </ResultsContext.Provider>
  );
}
