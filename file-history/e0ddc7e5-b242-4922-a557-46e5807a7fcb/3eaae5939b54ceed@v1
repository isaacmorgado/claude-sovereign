import { query } from '../../config/database.js';
import type { User, UserPublic, CreateUserInput, SubscriptionTier } from '../../types/user.js';

export function toPublicUser(user: User): UserPublic {
  return {
    id: user.id,
    email: user.email,
    name: user.name,
    subscription_tier: user.subscription_tier,
    usage_minutes_used: user.usage_minutes_used,
    usage_reset_at: user.usage_reset_at,
    created_at: user.created_at,
  };
}

export async function findByEmail(email: string): Promise<User | null> {
  const result = await query<User>(
    'SELECT * FROM users WHERE email = $1',
    [email.toLowerCase()]
  );
  return result.rows[0] ?? null;
}

export async function findById(id: string): Promise<User | null> {
  const result = await query<User>(
    'SELECT * FROM users WHERE id = $1',
    [id]
  );
  return result.rows[0] ?? null;
}

export async function create(
  input: CreateUserInput,
  passwordHash: string
): Promise<User> {
  const result = await query<User>(
    `INSERT INTO users (email, password_hash, name, subscription_tier, usage_minutes_used, usage_reset_at)
     VALUES ($1, $2, $3, 'free', 0, NOW() + INTERVAL '30 days')
     RETURNING *`,
    [input.email.toLowerCase(), passwordHash, input.name ?? null]
  );
  return result.rows[0]!;
}

export async function updateSubscription(
  userId: string,
  tier: SubscriptionTier,
  stripeCustomerId: string | null,
  stripeSubscriptionId: string | null
): Promise<User | null> {
  const result = await query<User>(
    `UPDATE users
     SET subscription_tier = $2,
         stripe_customer_id = $3,
         stripe_subscription_id = $4,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,
    [userId, tier, stripeCustomerId, stripeSubscriptionId]
  );
  return result.rows[0] ?? null;
}

export async function incrementUsage(
  userId: string,
  minutes: number
): Promise<User | null> {
  const result = await query<User>(
    `UPDATE users
     SET usage_minutes_used = usage_minutes_used + $2,
         updated_at = NOW()
     WHERE id = $1
     RETURNING *`,
    [userId, minutes]
  );
  return result.rows[0] ?? null;
}

export async function resetUsageIfNeeded(userId: string): Promise<User | null> {
  const result = await query<User>(
    `UPDATE users
     SET usage_minutes_used = 0,
         usage_reset_at = NOW() + INTERVAL '30 days',
         updated_at = NOW()
     WHERE id = $1 AND usage_reset_at < NOW()
     RETURNING *`,
    [userId]
  );
  return result.rows[0] ?? null;
}
