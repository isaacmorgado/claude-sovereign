#!/usr/bin/env node
/**
 * Patch clauded-cli.js to fetch models from proxy instead of using hardcoded list
 * This makes all 15 proxy models appear in /model picker
 */

const fs = require('fs');
const path = require('path');

const CLI_PATH = path.join(process.env.HOME, '.claude/clauded-cli/cli.js');
const BACKUP_PATH = CLI_PATH + '.backup-' + Date.now();

console.log('Patching clauded-cli.js to fetch models from proxy...\n');

// Read CLI file
let content = fs.readFileSync(CLI_PATH, 'utf8');
console.log(`✓ Read CLI file (${(content.length / 1024 / 1024).toFixed(2)} MB)`);

// Backup original
fs.writeFileSync(BACKUP_PATH, content);
console.log(`✓ Created backup: ${BACKUP_PATH}`);

// Find RU3 function - it returns hardcoded model list
const ru3Pattern = /function RU3\(\)\{[^}]+\[[^\]]+Fn\(\)[^\]]+\]/;
const match = content.match(ru3Pattern);

if (!match) {
  console.error('✗ Could not find RU3() function');
  process.exit(1);
}

console.log('✓ Found RU3() function');

// Create the patched function that fetches from proxy
const patchedRU3 = `
function RU3(){
  // PATCHED: Check if using proxy
  if(process.env.ANTHROPIC_BASE_URL && process.env.ANTHROPIC_BASE_URL.includes('127.0.0.1:3000')){
    try{
      // Fetch models from proxy synchronously at startup
      const https=require('http');
      const chunks=[];
      const req=https.get('http://127.0.0.1:3000/v1/models',(res)=>{
        res.on('data',(chunk)=>chunks.push(chunk));
        res.on('end',()=>{
          try{
            const data=JSON.parse(Buffer.concat(chunks).toString());
            if(data.data && Array.isArray(data.data)){
              // Store models globally for use by RU3
              global.__CLAUDED_PROXY_MODELS=data.data.map(m=>({
                value:m.id,
                label:m.display_name || m.name,
                description:m.description || 'Model from proxy'
              }));
            }
          }catch(e){console.error('Failed to parse proxy models:',e)}
        });
      });
      req.on('error',()=>{});
      req.end();
    }catch(e){}
  }

  // If we have proxy models, use them
  if(global.__CLAUDED_PROXY_MODELS && global.__CLAUDED_PROXY_MODELS.length>0){
    // Add default/recommended marker to first model
    const models=global.__CLAUDED_PROXY_MODELS.map((m,i)=>{
      if(i===0)return{...m,label:'Default (recommended)',value:m.value||'sonnet'};
      return m;
    });
    return models;
  }

  // Fallback to original hardcoded models
  let A=LsQ;if(OB()){if(!DR())return[Fn(),QeA];if(yLA()||vLA()){let G=[Fn(),EsQ];if(Vn().hasAccess)G.push(HsQ);return G.push(QeA),G}if(ZeA()&&FJA())return[Fn(),EsQ,QeA];let B=[Fn(),OU3];if(Op1())B.push({value:"sonnet",label:"Sonnet",description:"Sonnet 4.5 with 200K context"});else if(Vn().hasAccess)B.push(HsQ);return B.push(QeA),B}let Q=[Fn(),wsQ()];if(a4()!=="firstParty")Q.push(NU3());if(Vn().hasAccess)Q.push(NsQ);if(A)Q.push(A);return Q
}`.trim();

// Replace RU3 function
const originalRU3 = match[0];
content = content.replace(originalRU3, patchedRU3);

console.log('✓ Patched RU3() function to fetch from proxy');

// Write patched file
fs.writeFileSync(CLI_PATH, content);
console.log(`✓ Wrote patched CLI to ${CLI_PATH}`);

console.log('\n✅ Patch complete!');
console.log('\nChanges:');
console.log('  - RU3() now checks for ANTHROPIC_BASE_URL=http://127.0.0.1:3000');
console.log('  - Fetches models from /v1/models endpoint');
console.log('  - Falls back to hardcoded models if proxy unavailable');
console.log('\nTest with: clauded');
console.log('Then run: /model');
console.log('\nYou should see all 15 models from the proxy!');
