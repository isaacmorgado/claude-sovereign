#!/bin/bash
# Setup script for Qwen XML→JSON Proxy

set -e

echo "========================================"
echo "Qwen XML→JSON Proxy Setup"
echo "========================================"
echo

# Check Python version
if ! command -v python3 &> /dev/null; then
    echo "❌ Python 3 is required but not installed"
    exit 1
fi

PYTHON_VERSION=$(python3 --version | awk '{print $2}')
echo "✓ Python version: $PYTHON_VERSION"

# Create virtual environment
if [ ! -d "venv" ]; then
    echo "Creating virtual environment..."
    python3 -m venv venv
    echo "✓ Virtual environment created"
else
    echo "✓ Virtual environment already exists"
fi

# Activate virtual environment
source venv/bin/activate

# Install dependencies
echo
echo "Installing dependencies..."
pip install --upgrade pip
pip install flask requests

echo
echo "✓ Dependencies installed"

# Create .env file if it doesn't exist
if [ ! -f ".env" ]; then
    echo
    echo "Creating .env file..."
    cat > .env << 'EOF'
# Featherless API Configuration
FEATHERLESS_API_KEY=your_api_key_here

# Proxy Configuration
PROXY_PORT=8000
EOF
    echo "✓ Created .env file"
    echo
    echo "⚠️  IMPORTANT: Edit .env and add your FEATHERLESS_API_KEY"
else
    echo "✓ .env file already exists"
fi

# Create start script
echo
echo "Creating start script..."
cat > start.sh << 'EOF'
#!/bin/bash
# Start Qwen XML→JSON Proxy

# Load environment variables
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

# Check API key
if [ "$FEATHERLESS_API_KEY" = "your_api_key_here" ] || [ -z "$FEATHERLESS_API_KEY" ]; then
    echo "❌ Please set FEATHERLESS_API_KEY in .env file"
    exit 1
fi

# Activate virtual environment
source venv/bin/activate

# Start proxy
echo "Starting Qwen XML→JSON Proxy..."
python3 xml_to_json_proxy.py
EOF

chmod +x start.sh
echo "✓ Created start.sh"

# Create stop script
echo "Creating stop script..."
cat > stop.sh << 'EOF'
#!/bin/bash
# Stop Qwen XML→JSON Proxy

echo "Stopping Qwen XML→JSON Proxy..."
pkill -f "xml_to_json_proxy.py"
echo "✓ Proxy stopped"
EOF

chmod +x stop.sh
echo "✓ Created stop.sh"

# Create systemd service (optional)
echo
echo "Creating systemd service (optional)..."
cat > qwen-proxy.service << EOF
[Unit]
Description=Qwen XML to JSON Proxy
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$(pwd)
Environment="FEATHERLESS_API_KEY=your_api_key_here"
Environment="PROXY_PORT=8000"
ExecStart=$(pwd)/venv/bin/python3 $(pwd)/xml_to_json_proxy.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

echo "✓ Created qwen-proxy.service"
echo
echo "To install as system service:"
echo "  1. Edit qwen-proxy.service and set your FEATHERLESS_API_KEY"
echo "  2. sudo cp qwen-proxy.service /etc/systemd/system/"
echo "  3. sudo systemctl daemon-reload"
echo "  4. sudo systemctl enable qwen-proxy"
echo "  5. sudo systemctl start qwen-proxy"

echo
echo "========================================"
echo "Setup Complete!"
echo "========================================"
echo
echo "Next steps:"
echo "  1. Edit .env and set your FEATHERLESS_API_KEY"
echo "  2. Run ./start.sh to start the proxy"
echo "  3. Update LibreChat to use http://localhost:8000/v1"
echo
echo "Test the proxy:"
echo "  curl http://localhost:8000/health"
echo
