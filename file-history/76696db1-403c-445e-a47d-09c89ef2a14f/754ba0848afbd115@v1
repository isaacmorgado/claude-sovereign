#!/usr/bin/env python3
"""
Test script for Qwen XML‚ÜíJSON Proxy
Tests XML to JSON conversion without needing LibreChat
"""

import json
import requests
from typing import Dict

PROXY_URL = "http://localhost:8000/v1"

def test_health():
    """Test health endpoint"""
    print("Testing health endpoint...")
    try:
        response = requests.get(f"{PROXY_URL.replace('/v1', '')}/health")
        data = response.json()
        print(f"‚úì Health check: {data['status']}")
        print(f"  Service: {data['service']}")
        print(f"  Featherless connected: {data['featherless_connected']}")
        return True
    except Exception as e:
        print(f"‚ùå Health check failed: {e}")
        return False

def test_xml_conversion():
    """Test XML to JSON conversion"""
    print("\nTesting XML to JSON conversion...")

    # Sample request with tool specification
    request_data = {
        "model": "huihui-ai/Qwen2.5-Coder-32B-Instruct-abliterated",
        "messages": [
            {
                "role": "user",
                "content": "Use web search to find the current weather in San Francisco"
            }
        ],
        "tools": [
            {
                "type": "function",
                "function": {
                    "name": "web_search",
                    "description": "Search the web",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "query": {
                                "type": "string",
                                "description": "Search query"
                            }
                        },
                        "required": ["query"]
                    }
                }
            }
        ],
        "max_tokens": 500,
        "temperature": 0.7
    }

    try:
        print("Sending request to proxy...")
        response = requests.post(
            f"{PROXY_URL}/chat/completions",
            json=request_data,
            timeout=60
        )

        if response.status_code != 200:
            print(f"‚ùå Request failed with status {response.status_code}")
            print(f"Response: {response.text}")
            return False

        data = response.json()

        # Check response structure
        if 'choices' not in data or not data['choices']:
            print("‚ùå Response missing 'choices'")
            return False

        message = data['choices'][0].get('message', {})
        content = message.get('content', '')
        tool_calls = message.get('tool_calls', [])

        print("\nüì• Response received:")
        print(f"  Content: {content[:100] if content else 'None'}...")
        print(f"  Tool calls: {len(tool_calls)}")

        if tool_calls:
            print("\n‚úì Tool calls detected (XML‚ÜíJSON conversion successful):")
            for i, tool_call in enumerate(tool_calls):
                print(f"\n  Tool Call #{i+1}:")
                print(f"    ID: {tool_call.get('id')}")
                print(f"    Type: {tool_call.get('type')}")
                print(f"    Function: {tool_call.get('function', {}).get('name')}")
                print(f"    Arguments: {tool_call.get('function', {}).get('arguments')}")

            return True
        else:
            print("\n‚ö†Ô∏è  No tool calls in response")
            print("This might mean:")
            print("  1. Model didn't generate tool calls (try different prompt)")
            print("  2. Model needs explicit tool call instruction")
            print("  3. Tool was already in text format (JSON)")
            return True

    except requests.exceptions.Timeout:
        print("‚ùå Request timed out (>60s)")
        return False
    except Exception as e:
        print(f"‚ùå Test failed: {e}")
        import traceback
        traceback.print_exc()
        return False

def test_manual_xml_parsing():
    """Test XML parsing directly (without API call)"""
    print("\nTesting XML parser directly...")

    from xml_to_json_proxy import QwenXMLToJSONConverter

    converter = QwenXMLToJSONConverter()

    # Sample XML content
    xml_content = """
    Here's how I'll help you:
    <tool_call>
    <function=web_search>
    <parameter=query>weather San Francisco</parameter>
    <parameter=count>5</parameter>
    </function>
    </tool_call>
    """

    tool_calls, clean_content = converter.parse_xml_tool_calls(xml_content)

    print("‚úì Direct XML parsing:")
    print(f"  Tool calls found: {len(tool_calls)}")
    print(f"  Clean content: {clean_content.strip()}")

    if tool_calls:
        for i, tc in enumerate(tool_calls):
            print(f"\n  Tool Call #{i+1}:")
            print(f"    {json.dumps(tc, indent=4)}")
        return True
    else:
        print("‚ùå No tool calls parsed")
        return False

def main():
    """Run all tests"""
    print("="*50)
    print("Qwen XML‚ÜíJSON Proxy Test Suite")
    print("="*50)
    print()

    results = []

    # Test 1: Health check
    results.append(("Health Check", test_health()))

    # Test 2: Direct XML parsing
    results.append(("Direct XML Parsing", test_manual_xml_parsing()))

    # Test 3: Full API test (requires Featherless API key)
    print("\nNote: Full API test requires:")
    print("  - Proxy running (./start.sh)")
    print("  - Valid FEATHERLESS_API_KEY")
    print("  - Internet connection")
    print()
    response = input("Run full API test? (y/n): ")

    if response.lower() == 'y':
        results.append(("Full API Test", test_xml_conversion()))

    # Summary
    print("\n" + "="*50)
    print("Test Results")
    print("="*50)

    for test_name, passed in results:
        status = "‚úì PASS" if passed else "‚ùå FAIL"
        print(f"{status}: {test_name}")

    passed_count = sum(1 for _, passed in results if passed)
    total_count = len(results)

    print()
    print(f"Total: {passed_count}/{total_count} tests passed")

    if passed_count == total_count:
        print("\n‚úì All tests passed!")
        return 0
    else:
        print("\n‚ùå Some tests failed")
        return 1

if __name__ == "__main__":
    exit(main())
