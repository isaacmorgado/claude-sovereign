#!/bin/bash

# LibreChat Launcher Script
LIBRECHAT_DIR="/Users/imorgado/Desktop/LibreChat"
BROWSER_URL="http://localhost:3080"
LOG_FILE="$HOME/Library/Logs/LibreChat.log"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

log "Starting LibreChat launcher..."

# Function to check if Docker Desktop is running
is_docker_running() {
    docker info >/dev/null 2>&1
    return $?
}

# Function to start Docker Desktop
start_docker() {
    log "Docker is not running. Starting Docker Desktop..."
    open -a "Docker"

    # Wait for Docker to start (max 60 seconds)
    log "Waiting for Docker Desktop to start..."
    for i in {1..60}; do
        if is_docker_running; then
            log "Docker Desktop is now running"
            sleep 2  # Give it a moment to fully initialize
            return 0
        fi
        sleep 1
    done

    log "ERROR: Docker Desktop failed to start within 60 seconds"
    osascript -e 'display notification "Failed to start Docker Desktop" with title "LibreChat" sound name "Basso"'
    exit 1
}

# Function to check if LibreChat containers are running
is_librechat_running() {
    docker compose -f "$LIBRECHAT_DIR/docker-compose.yml" ps -q 2>/dev/null | grep -q .
    return $?
}

# Function to wait for LibreChat to be ready
wait_for_librechat() {
    log "Waiting for LibreChat to be ready..."
    for i in {1..30}; do
        if curl -s -o /dev/null -w "%{http_code}" "$BROWSER_URL" | grep -q "200"; then
            log "LibreChat is ready"
            return 0
        fi
        sleep 2
    done
    log "Warning: LibreChat may not be fully ready yet"
    return 1
}

# Function to start LibreChat
start_librechat() {
    log "Starting LibreChat with docker compose..."
    cd "$LIBRECHAT_DIR" || exit 1

    docker compose up -d >> "$LOG_FILE" 2>&1

    if [ $? -eq 0 ]; then
        log "LibreChat started successfully"

        # Wait for the service to be ready
        wait_for_librechat

        # Open browser
        log "Opening browser to $BROWSER_URL"
        open "$BROWSER_URL"

        osascript -e 'display notification "LibreChat is now running" with title "LibreChat" sound name "Glass"'
    else
        log "ERROR: Failed to start LibreChat"
        osascript -e 'display notification "Failed to start LibreChat. Check logs at ~/Library/Logs/LibreChat.log" with title "LibreChat" sound name "Basso"'
        exit 1
    fi
}

# Main execution
log "Checking Docker status..."
if ! is_docker_running; then
    start_docker
fi

log "Checking LibreChat status..."
if is_librechat_running; then
    log "LibreChat is already running"
    open "$BROWSER_URL"
    osascript -e 'display notification "LibreChat is already running" with title "LibreChat"'
else
    start_librechat
fi

log "Launcher completed successfully"
