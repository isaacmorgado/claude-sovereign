#!/usr/bin/env python3
"""
Simple test of XML→JSON conversion without user input
"""

import json
import requests

PROXY_URL = "http://localhost:8000/v1"

# Test 1: Direct XML parsing
print("=" * 50)
print("Test 1: Direct XML Parsing")
print("=" * 50)

from xml_to_json_proxy import QwenXMLToJSONConverter

converter = QwenXMLToJSONConverter()

xml_content = """
Here's the result:
<tool_call>
<function=web_search>
<parameter=query>weather San Francisco</parameter>
<parameter=count>5</parameter>
</function>
</tool_call>
"""

tool_calls, clean_content = converter.parse_xml_tool_calls(xml_content)

print(f"✓ Parsed {len(tool_calls)} tool call(s)")
print(f"✓ Clean content: {clean_content}")
print(f"\n✓ Tool call JSON:")
print(json.dumps(tool_calls[0], indent=2))

# Test 2: Model detection
print("\n" + "=" * 50)
print("Test 2: Model Detection")
print("=" * 50)

test_models = [
    ("huihui-ai/Qwen2.5-Coder-32B-Instruct-abliterated", True),
    ("huihui-ai/QwQ-32B-abliterated", True),
    ("roslein/Qwen3-32B-abliterated", False),
    ("deepseek-ai/DeepSeek-V3-0324", False),
]

for model, should_convert in test_models:
    needs_conversion = converter.needs_conversion(model)
    status = "✓" if needs_conversion == should_convert else "❌"
    action = "convert" if needs_conversion else "pass-through"
    print(f"{status} {model}: {action}")

# Test 3: Health check
print("\n" + "=" * 50)
print("Test 3: Proxy Health Check")
print("=" * 50)

try:
    response = requests.get(f"{PROXY_URL.replace('/v1', '')}/health")
    data = response.json()
    print(f"✓ Status: {data['status']}")
    print(f"✓ Service: {data['service']}")
    print(f"✓ Featherless connected: {data['featherless_connected']}")
except Exception as e:
    print(f"❌ Health check failed: {e}")

print("\n" + "=" * 50)
print("All Tests Complete")
print("=" * 50)
