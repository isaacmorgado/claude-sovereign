#!/usr/bin/env python3
import rumps
import subprocess
import os
import time
import webbrowser

LIBRECHAT_DIR = "/Users/imorgado/Desktop/LibreChat"
BROWSER_URL = "http://localhost:3080"

class LibreChatApp(rumps.App):
    def __init__(self):
        super(LibreChatApp, self).__init__("LibreChat", "ðŸ’¬")
        self.menu = [
            rumps.MenuItem("Start LibreChat", callback=self.start_librechat),
            rumps.MenuItem("Stop LibreChat", callback=self.stop_librechat),
            rumps.MenuItem("Restart LibreChat", callback=self.restart_librechat),
            None,
            rumps.MenuItem("Open in Browser", callback=self.open_browser),
            rumps.MenuItem("View Logs", callback=self.view_logs),
            None,
            rumps.MenuItem("Quit", callback=self.quit_app),
        ]
        # Check status on startup
        rumps.Timer(self.check_status, 5).start()  # Check every 5 seconds
        self.check_status(None)

    def check_status(self, _):
        """Check if LibreChat is running and update menu bar icon"""
        if self.is_docker_running() and self.is_librechat_running():
            self.title = "ðŸ’¬ âœ“"
        else:
            self.title = "ðŸ’¬"

    def is_docker_running(self):
        """Check if Docker Desktop is running"""
        try:
            subprocess.run(["docker", "info"],
                         stdout=subprocess.DEVNULL,
                         stderr=subprocess.DEVNULL,
                         check=True)
            return True
        except:
            return False

    def start_docker(self):
        """Start Docker Desktop"""
        if not self.is_docker_running():
            rumps.notification("LibreChat", "Starting Docker Desktop", "Please wait...")
            subprocess.run(["open", "-a", "Docker"])

            # Wait for Docker to start (max 60 seconds)
            for i in range(60):
                if self.is_docker_running():
                    time.sleep(2)  # Extra time to fully initialize
                    return True
                time.sleep(1)

            rumps.alert("Failed to start Docker Desktop", "Please start Docker manually and try again.")
            return False
        return True

    def is_librechat_running(self):
        """Check if LibreChat containers are running"""
        try:
            result = subprocess.run(
                ["docker", "compose", "ps", "-q"],
                cwd=LIBRECHAT_DIR,
                stdout=subprocess.PIPE,
                stderr=subprocess.DEVNULL
            )
            return len(result.stdout.strip()) > 0
        except:
            return False

    @rumps.clicked("Start LibreChat")
    def start_librechat(self, _):
        """Start LibreChat"""
        if not self.start_docker():
            return

        if self.is_librechat_running():
            rumps.notification("LibreChat", "Already Running", "Opening browser...")
            self.open_browser(None)
            return

        rumps.notification("LibreChat", "Starting", "Please wait...")

        try:
            subprocess.run(
                ["docker", "compose", "up", "-d"],
                cwd=LIBRECHAT_DIR,
                check=True,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL
            )
            time.sleep(5)  # Wait for services to be ready
            rumps.notification("LibreChat", "Started", "Opening browser...")
            self.open_browser(None)
            self.check_status(None)
        except subprocess.CalledProcessError as e:
            rumps.alert("Failed to start LibreChat", f"Error: {str(e)}\nCheck Docker logs for details.")

    @rumps.clicked("Stop LibreChat")
    def stop_librechat(self, _):
        """Stop LibreChat"""
        if not self.is_librechat_running():
            rumps.notification("LibreChat", "Not Running", "")
            return

        rumps.notification("LibreChat", "Stopping", "Please wait...")

        try:
            subprocess.run(
                ["docker", "compose", "down"],
                cwd=LIBRECHAT_DIR,
                check=True,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL
            )
            rumps.notification("LibreChat", "Stopped", "")
            self.check_status(None)
        except subprocess.CalledProcessError as e:
            rumps.alert("Failed to stop LibreChat", f"Error: {str(e)}\nCheck Docker logs for details.")

    @rumps.clicked("Restart LibreChat")
    def restart_librechat(self, _):
        """Restart LibreChat"""
        self.stop_librechat(None)
        time.sleep(2)
        self.start_librechat(None)

    @rumps.clicked("Open in Browser")
    def open_browser(self, _):
        """Open LibreChat in browser"""
        webbrowser.open(BROWSER_URL)

    @rumps.clicked("View Logs")
    def view_logs(self, _):
        """View Docker logs in Terminal"""
        script = f'tell app "Terminal" to do script "cd {LIBRECHAT_DIR} && docker compose logs -f"'
        subprocess.Popen(["osascript", "-e", script])

    @rumps.clicked("Quit")
    def quit_app(self, _):
        """Quit the app"""
        rumps.quit_application()

if __name__ == "__main__":
    LibreChatApp().run()
