#!/usr/bin/env python3
"""Test Featherless API directly (bypass proxy)"""

import json
import requests
import os

# Load API key from .env
FEATHERLESS_API_KEY = os.environ.get("FEATHERLESS_API_KEY")
if not FEATHERLESS_API_KEY:
    # Read from .env file
    with open(".env") as f:
        for line in f:
            if line.startswith("FEATHERLESS_API_KEY="):
                FEATHERLESS_API_KEY = line.split("=")[1].strip()
                break

print(f"API Key loaded: {FEATHERLESS_API_KEY[:20]}...")

FEATHERLESS_BASE_URL = "https://api.featherless.ai/v1"

request_data = {
    "model": "huihui-ai/Qwen2.5-Coder-32B-Instruct-abliterated",
    "messages": [{"role": "user", "content": "Say hello in exactly 5 words"}],
    "max_tokens": 50,
    "temperature": 0.7,
}

print("\nTesting Featherless API directly...")
print(f"URL: {FEATHERLESS_BASE_URL}/chat/completions")
print(f"Model: {request_data['model']}")
print(f"Prompt: {request_data['messages'][0]['content']}\n")

try:
    response = requests.post(
        f"{FEATHERLESS_BASE_URL}/chat/completions",
        headers={
            "Authorization": f"Bearer {FEATHERLESS_API_KEY}",
            "Content-Type": "application/json",
        },
        json=request_data,
        timeout=60,
    )

    print(f"Status code: {response.status_code}\n")

    if response.status_code != 200:
        print("Error response:")
        print(response.text)
    else:
        data = response.json()
        print("Response structure:")
        print(json.dumps(data, indent=2))

        if "choices" in data:
            print("\n✓ Response has 'choices' key")
            if data["choices"]:
                message = data["choices"][0].get("message", {})
                content = message.get("content", "")
                print(f"✓ Content: {content}")
        else:
            print("\n❌ Response missing 'choices' key")
            print("Available keys:", list(data.keys()))

except requests.exceptions.Timeout:
    print("❌ Request timed out after 60 seconds")
except Exception as e:
    print(f"❌ Error: {e}")
    import traceback

    traceback.print_exc()
