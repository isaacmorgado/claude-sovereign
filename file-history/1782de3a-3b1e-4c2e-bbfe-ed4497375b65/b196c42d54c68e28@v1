"""
Supplements Router
API endpoints for supplement recommendations and product data
"""

from typing import Optional, List
from fastapi import APIRouter, HTTPException, status, Query
from pydantic import BaseModel, Field

from app.services.supplement_service import supplement_service
from app.data.supplements import SUPPLEMENTS, PRODUCTS


router = APIRouter(prefix="/supplements", tags=["supplements"])


# ============================================
# SCHEMAS (inline for simplicity)
# ============================================

class CostRange(BaseModel):
    min: int
    max: int


class SupplementResponse(BaseModel):
    id: str
    name: str
    category: str
    description: str
    dosage: str
    frequency: str
    timing: str
    effectiveness: int
    evidenceLevel: str
    costPerMonth: CostRange
    timelineToResults: str
    riskLevel: str
    sideEffects: List[str]
    interactions: List[str]
    contraindications: List[str]
    targetBenefits: List[str]
    requiresPrescription: bool
    notes: List[str]
    sources: List[str]


class ProductResponse(BaseModel):
    id: str
    name: str
    brand: str
    category: str
    affiliateLink: str
    affiliateType: str
    supplementId: str
    priority: int
    baseStackItem: bool


class DailyStackRequest(BaseModel):
    gender: str = Field(..., pattern="^(male|female)$")
    age: Optional[int] = Field(None, ge=13, le=100)


class DailyStackTimingResponse(BaseModel):
    morning: List[ProductResponse]
    evening: List[ProductResponse]
    anytime: List[ProductResponse]


class DailyStackResponse(BaseModel):
    products: List[ProductResponse]
    totalCostPerMonth: CostRange
    timing: DailyStackTimingResponse
    rationale: str


class ProductRecommendationResponse(BaseModel):
    product: ProductResponse
    state: str  # "flaw" or "ideal"
    targetMetric: str
    message: str
    urgency: str  # "high", "medium", "low"
    matchedMetrics: List[str]
    supplement: Optional[SupplementResponse] = None


class RecommendationsRequest(BaseModel):
    metricsDict: dict = Field(..., description="Metric name -> value")
    severityDict: dict = Field(..., description="Metric name -> severity level")
    gender: str = Field(..., pattern="^(male|female)$")
    age: Optional[int] = Field(None, ge=13, le=100)
    ethnicity: Optional[str] = None


class RecommendationsResponse(BaseModel):
    recommendations: List[ProductRecommendationResponse]
    dailyStack: DailyStackResponse
    flawCount: int
    idealCount: int


# ============================================
# ENDPOINTS
# ============================================

@router.get("/supplements", response_model=List[SupplementResponse])
async def get_supplements(
    category: Optional[str] = Query(None, description="Filter by category: skin, hair, anti-aging, hormonal, bone, general")
):
    """
    Get all supplements, optionally filtered by category.

    Returns evidence-based supplement data including dosage, effectiveness,
    and research sources.
    """
    valid_categories = ["skin", "hair", "anti-aging", "hormonal", "bone", "general"]
    if category and category not in valid_categories:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"Invalid category. Must be one of: {', '.join(valid_categories)}"
        )

    supplements = supplement_service.get_all_supplements(category=category)
    return supplements


@router.get("/supplements/{supplement_id}", response_model=SupplementResponse)
async def get_supplement(supplement_id: str):
    """
    Get a specific supplement by ID.
    """
    supplement = next((s for s in SUPPLEMENTS if s["id"] == supplement_id), None)
    if not supplement:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Supplement '{supplement_id}' not found"
        )
    return supplement


@router.get("/products", response_model=List[ProductResponse])
async def get_products(
    category: Optional[str] = Query(None, description="Filter by category"),
    base_stack_only: bool = Query(False, description="Only return base stack items")
):
    """
    Get all products with affiliate links.

    Products are linked to supplements and include affiliate information.
    """
    products = supplement_service.get_all_products(category=category)

    if base_stack_only:
        products = [p for p in products if p.get("baseStackItem", False)]

    return products


@router.get("/products/{product_id}", response_model=ProductResponse)
async def get_product(product_id: str):
    """
    Get a specific product by ID.
    """
    product = next((p for p in PRODUCTS if p["id"] == product_id), None)
    if not product:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Product '{product_id}' not found"
        )
    return product


@router.post("/daily-stack", response_model=DailyStackResponse)
async def generate_daily_stack(request: DailyStackRequest):
    """
    Generate a personalized daily supplement stack.

    The daily stack includes:
    - 6 base products shown to ALL users
    - Gender-specific additions (e.g., Ashwagandha for males)
    - Age-specific additions (e.g., NMN for 30+)
    - Timing recommendations (morning/evening/anytime)
    - Total cost estimate
    """
    stack = supplement_service.generate_daily_stack(
        gender=request.gender,
        age=request.age
    )
    return stack


@router.get("/daily-stack")
async def get_daily_stack(
    gender: str = Query(..., pattern="^(male|female)$"),
    age: Optional[int] = Query(None, ge=13, le=100)
):
    """
    Generate daily stack (GET version for simple requests).
    """
    stack = supplement_service.generate_daily_stack(gender=gender, age=age)
    return stack


@router.post("/recommendations", response_model=RecommendationsResponse)
async def get_recommendations(request: RecommendationsRequest):
    """
    Get personalized product recommendations based on facial metrics.

    This endpoint analyzes the user's metrics and severity levels to generate:
    - Corrective products for weak metrics (flaws)
    - Maintenance products for strong metrics (ideal)
    - A complete daily stack

    The recommendations use metric-to-product mapping to suggest relevant
    supplements for each area of improvement or maintenance.
    """
    result = supplement_service.get_combined_recommendations(
        metrics_dict=request.metricsDict,
        severity_dict=request.severityDict,
        gender=request.gender,
        age=request.age,
        ethnicity=request.ethnicity
    )
    return result


@router.get("/categories")
async def get_categories():
    """
    Get all supplement categories with counts.
    """
    categories = ["skin", "hair", "anti-aging", "hormonal", "bone", "general"]
    result = []

    for cat in categories:
        supplement_count = len([s for s in SUPPLEMENTS if s["category"] == cat])
        product_count = len([p for p in PRODUCTS if p["category"] == cat])
        result.append({
            "category": cat,
            "supplementCount": supplement_count,
            "productCount": product_count,
        })

    return {"categories": result}


@router.get("/stats")
async def get_stats():
    """
    Get supplement system statistics.
    """
    base_stack = [p for p in PRODUCTS if p.get("baseStackItem", False)]

    # Calculate base stack cost
    from app.data.supplements import get_supplement_by_id
    total_min = 0
    total_max = 0
    for product in base_stack:
        supplement = get_supplement_by_id(product["supplementId"])
        if supplement:
            total_min += supplement["costPerMonth"]["min"]
            total_max += supplement["costPerMonth"]["max"]

    return {
        "totalSupplements": len(SUPPLEMENTS),
        "totalProducts": len(PRODUCTS),
        "baseStackProducts": len(base_stack),
        "baseStackCostPerMonth": {
            "min": total_min,
            "max": total_max,
        },
        "categories": {
            "skin": len([s for s in SUPPLEMENTS if s["category"] == "skin"]),
            "hair": len([s for s in SUPPLEMENTS if s["category"] == "hair"]),
            "anti-aging": len([s for s in SUPPLEMENTS if s["category"] == "anti-aging"]),
            "hormonal": len([s for s in SUPPLEMENTS if s["category"] == "hormonal"]),
            "bone": len([s for s in SUPPLEMENTS if s["category"] == "bone"]),
            "general": len([s for s in SUPPLEMENTS if s["category"] == "general"]),
        },
    }
