/**
 * Phase 4 E2E Integration Tests - Full Workflow Validation
 *
 * Tests that Phase 3 features (Auto Zoom, Chapter Detection) are properly
 * integrated into the main GO workflow and work end-to-end.
 *
 * Critical validations:
 * 1. Workflow integration - zoom/chapters called in unified workflow
 * 2. UI wiring - all buttons connected to handlers
 * 3. Error handling - graceful failure doesn't break workflow
 * 4. State management - currentZoomPoints/currentChapters populated
 * 5. Status messages - accurate reporting of results
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

let passed = 0;
let failed = 0;
let skipped = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

function skip(name, reason) {
  console.log(`  ○ ${name} (skipped: ${reason})`);
  skipped++;
}

// ============================================================================
// File Loading
// ============================================================================

const pluginDir = path.join(__dirname, '../../splice-plugin/js');
const backendDir = path.join(__dirname, '../');
const servicesDir = path.join(backendDir, 'services');
const routesDir = path.join(backendDir, 'routes');

// Helper to safely read route file
function readRouteFile(name) {
  const filePath = path.join(routesDir, name);
  return fs.existsSync(filePath) ? fs.readFileSync(filePath, 'utf8') : '';
}

const files = {
  mainJs: fs.readFileSync(path.join(pluginDir, 'main.js'), 'utf8'),
  builderJs: fs.readFileSync(path.join(pluginDir, 'builder.js'), 'utf8'),
  configJs: fs.readFileSync(path.join(pluginDir, 'config.js'), 'utf8'),
  indexHtml: fs.readFileSync(path.join(__dirname, '../../splice-plugin/index.html'), 'utf8'),
  serverJs: fs.readFileSync(path.join(backendDir, 'server.js'), 'utf8'),
  zoomGeneratorJs: fs.readFileSync(path.join(servicesDir, 'zoomGenerator.js'), 'utf8'),
  chapterDetectionJs: fs.readFileSync(path.join(servicesDir, 'chapterDetection.js'), 'utf8'),
  // Route modules
  routesZoom: readRouteFile('zoom.js'),
  routesChapters: readRouteFile('chapters.js')
};

// Combined backend code for pattern matching (server.js + route files)
const allBackendCode = files.serverJs + files.routesZoom + files.routesChapters;

// ============================================================================
// 1. WORKFLOW INTEGRATION - Zoom/Chapters in GO Button
// ============================================================================

console.log('\n=== 1. Workflow Integration ===');

test('GO workflow checks zoom settings', () => {
  assert.ok(
    files.mainJs.includes('getZoomSettings().enabled'),
    'Should check if zoom is enabled in workflow'
  );
});

test('GO workflow checks chapter settings', () => {
  assert.ok(
    files.mainJs.includes('getChapterSettings().enabled'),
    'Should check if chapters are enabled in workflow'
  );
});

test('GO workflow calls fetchZoomPoints when enabled', () => {
  assert.ok(
    files.mainJs.includes('fetchZoomPoints(transcriptResult.transcript)'),
    'Should call fetchZoomPoints with transcript'
  );
});

test('GO workflow calls fetchChapters when enabled', () => {
  assert.ok(
    files.mainJs.includes('fetchChapters(transcriptResult.transcript)'),
    'Should call fetchChapters with transcript'
  );
});

test('Zoom/chapters run in parallel (Promise.all)', () => {
  assert.ok(
    files.mainJs.includes('phase3Promises') && files.mainJs.includes('Promise.all(phase3Promises)'),
    'Should run zoom and chapters in parallel for performance'
  );
});

test('Zoom errors are caught gracefully', () => {
  assert.ok(
    files.mainJs.includes('Zoom detection failed') || files.mainJs.includes('.catch(err =>'),
    'Should catch zoom errors without breaking workflow'
  );
});

test('Chapter errors are caught gracefully', () => {
  assert.ok(
    files.mainJs.includes('Chapter detection failed') || files.mainJs.includes('.catch(err =>'),
    'Should catch chapter errors without breaking workflow'
  );
});

test('Status message includes zoom count', () => {
  assert.ok(
    files.mainJs.includes('zoomCount') && files.mainJs.includes('zoom points'),
    'Status should show zoom point count'
  );
});

test('Status message includes chapter count', () => {
  assert.ok(
    files.mainJs.includes('chapterCount') && files.mainJs.includes('chapters'),
    'Status should show chapter count'
  );
});

// ============================================================================
// 2. UI WIRING - Buttons and Event Listeners
// ============================================================================

console.log('\n=== 2. UI Wiring ===');

test('Zoom enable checkbox exists', () => {
  assert.ok(
    files.indexHtml.includes('id="enableZoom"'),
    'enableZoom checkbox should exist'
  );
});

test('Chapter enable checkbox exists', () => {
  assert.ok(
    files.indexHtml.includes('id="enableChapters"'),
    'enableChapters checkbox should exist'
  );
});

test('Apply zooms button exists', () => {
  assert.ok(
    files.indexHtml.includes('id="applyZoomsBtn"'),
    'applyZoomsBtn should exist'
  );
});

test('Copy YouTube timestamps button exists', () => {
  assert.ok(
    files.indexHtml.includes('id="copyYouTubeBtn"'),
    'copyYouTubeBtn should exist'
  );
});

test('Add chapter markers button exists', () => {
  assert.ok(
    files.indexHtml.includes('id="addChapterMarkersBtn"'),
    'addChapterMarkersBtn should exist'
  );
});

test('initZoomUI function exists', () => {
  assert.ok(
    files.mainJs.includes('function initZoomUI()'),
    'initZoomUI function should be defined'
  );
});

test('initChapterUI function exists', () => {
  assert.ok(
    files.mainJs.includes('function initChapterUI()'),
    'initChapterUI function should be defined'
  );
});

test('Apply zooms button wired to handler', () => {
  assert.ok(
    files.mainJs.includes("applyZoomsBtn.addEventListener('click', applyZoomsToTimeline)"),
    'applyZoomsBtn should be wired to applyZoomsToTimeline'
  );
});

test('Copy timestamps button wired to handler', () => {
  assert.ok(
    files.mainJs.includes("copyYouTubeBtn.addEventListener('click', copyYouTubeTimestamps)"),
    'copyYouTubeBtn should be wired to copyYouTubeTimestamps'
  );
});

test('Add markers button wired to handler', () => {
  assert.ok(
    files.mainJs.includes("addChapterMarkersBtn.addEventListener('click', addChapterMarkers)"),
    'addChapterMarkersBtn should be wired to addChapterMarkers'
  );
});

// ============================================================================
// 3. STATE MANAGEMENT - Variables Populated
// ============================================================================

console.log('\n=== 3. State Management ===');

test('currentZoomPoints variable defined', () => {
  assert.ok(
    files.mainJs.includes('let currentZoomPoints = []'),
    'currentZoomPoints should be defined'
  );
});

test('currentChapters variable defined', () => {
  assert.ok(
    files.mainJs.includes('let currentChapters = []'),
    'currentChapters should be defined'
  );
});

test('currentYouTubeTimestamps variable defined', () => {
  assert.ok(
    files.mainJs.includes("let currentYouTubeTimestamps = ''"),
    'currentYouTubeTimestamps should be defined'
  );
});

test('fetchZoomPoints updates currentZoomPoints', () => {
  assert.ok(
    files.mainJs.includes('currentZoomPoints = data.zoomPoints'),
    'fetchZoomPoints should update currentZoomPoints'
  );
});

test('fetchChapters updates currentChapters', () => {
  assert.ok(
    files.mainJs.includes('currentChapters = data.chapters'),
    'fetchChapters should update currentChapters'
  );
});

test('fetchChapters updates currentYouTubeTimestamps', () => {
  assert.ok(
    files.mainJs.includes('currentYouTubeTimestamps = data.youtubeTimestamps'),
    'fetchChapters should update currentYouTubeTimestamps'
  );
});

// ============================================================================
// 4. BUILDER INTEGRATION - Apply Functions
// ============================================================================

console.log('\n=== 4. Builder Integration ===');

test('applyZoomKeyframes function exists in builder', () => {
  assert.ok(
    files.builderJs.includes('async function applyZoomKeyframes') ||
    files.builderJs.includes('applyZoomKeyframes:'),
    'applyZoomKeyframes should be defined in builder.js'
  );
});

test('applyChapterMarkers function exists in builder', () => {
  assert.ok(
    files.builderJs.includes('async function applyChapterMarkers') ||
    files.builderJs.includes('applyChapterMarkers:'),
    'applyChapterMarkers should be defined in builder.js'
  );
});

test('Builder exports applyZoomKeyframes', () => {
  assert.ok(
    files.builderJs.includes('applyZoomKeyframes') &&
    files.builderJs.includes('window.spliceBuilder'),
    'applyZoomKeyframes should be exported via window.spliceBuilder'
  );
});

test('Builder exports applyChapterMarkers', () => {
  assert.ok(
    files.builderJs.includes('applyChapterMarkers') &&
    files.builderJs.includes('window.spliceBuilder'),
    'applyChapterMarkers should be exported via window.spliceBuilder'
  );
});

test('applyZoomsToTimeline uses builder', () => {
  assert.ok(
    files.mainJs.includes('window.spliceBuilder?.applyZoomKeyframes') ||
    files.mainJs.includes('window.spliceBuilder.applyZoomKeyframes'),
    'applyZoomsToTimeline should call builder.applyZoomKeyframes'
  );
});

test('addChapterMarkers uses builder', () => {
  assert.ok(
    files.mainJs.includes('window.spliceBuilder?.applyChapterMarkers') ||
    files.mainJs.includes('window.spliceBuilder.applyChapterMarkers'),
    'addChapterMarkers should call builder.applyChapterMarkers'
  );
});

// ============================================================================
// 5. API ENDPOINTS - Server Integration
// ============================================================================

console.log('\n=== 5. API Endpoints ===');

test('/zoom endpoint exists with requireCredits', () => {
  assert.ok(
    files.serverJs.includes("app.post('/zoom'") &&
    files.serverJs.includes('requireCredits'),
    '/zoom endpoint should exist with credits protection'
  );
});

test('/zoom/presets endpoint exists', () => {
  assert.ok(
    files.serverJs.includes("app.get('/zoom/presets'"),
    '/zoom/presets endpoint should exist'
  );
});

test('/chapters endpoint exists with requireCredits', () => {
  assert.ok(
    files.serverJs.includes("app.post('/chapters'") &&
    files.serverJs.includes('requireCredits'),
    '/chapters endpoint should exist with credits protection'
  );
});

test('/chapters/fallback endpoint exists', () => {
  assert.ok(
    files.serverJs.includes("app.post('/chapters/fallback'"),
    '/chapters/fallback endpoint should exist'
  );
});

test('Server imports zoomGenerator service', () => {
  assert.ok(
    files.serverJs.includes("require('./services/zoomGenerator')"),
    'Server should import zoomGenerator service'
  );
});

test('Server imports chapterDetection service', () => {
  assert.ok(
    files.serverJs.includes("require('./services/chapterDetection')"),
    'Server should import chapterDetection service'
  );
});

// ============================================================================
// 6. SETTINGS FUNCTIONS - Get/Display
// ============================================================================

console.log('\n=== 6. Settings Functions ===');

test('getZoomSettings function defined', () => {
  assert.ok(
    files.mainJs.includes('function getZoomSettings()'),
    'getZoomSettings should be defined'
  );
});

test('getChapterSettings function defined', () => {
  assert.ok(
    files.mainJs.includes('function getChapterSettings()'),
    'getChapterSettings should be defined'
  );
});

test('displayZoomResults function defined', () => {
  assert.ok(
    files.mainJs.includes('function displayZoomResults'),
    'displayZoomResults should be defined'
  );
});

test('displayChapterResults function defined', () => {
  assert.ok(
    files.mainJs.includes('function displayChapterResults'),
    'displayChapterResults should be defined'
  );
});

test('copyYouTubeTimestamps function defined', () => {
  assert.ok(
    files.mainJs.includes('function copyYouTubeTimestamps') ||
    files.mainJs.includes('async function copyYouTubeTimestamps'),
    'copyYouTubeTimestamps should be defined'
  );
});

// ============================================================================
// 7. DISPLAY RESULTS - UI Updates
// ============================================================================

console.log('\n=== 7. Display Results ===');

test('Zoom results container exists', () => {
  assert.ok(
    files.indexHtml.includes('id="zoomResults"'),
    'zoomResults container should exist'
  );
});

test('Zoom list container exists', () => {
  assert.ok(
    files.indexHtml.includes('id="zoomList"'),
    'zoomList container should exist'
  );
});

test('Chapter results container exists', () => {
  assert.ok(
    files.indexHtml.includes('id="chapterResults"'),
    'chapterResults container should exist'
  );
});

test('Chapter list container exists', () => {
  assert.ok(
    files.indexHtml.includes('id="chapterList"'),
    'chapterList container should exist'
  );
});

test('YouTube timestamps display container exists', () => {
  assert.ok(
    files.indexHtml.includes('id="youtubeTimestamps"'),
    'youtubeTimestamps container should exist'
  );
});

test('displayZoomResults updates zoomResults', () => {
  assert.ok(
    files.mainJs.includes("ui.zoomResults.style.display = 'block'") ||
    files.mainJs.includes('zoomResults.style.display'),
    'displayZoomResults should show zoomResults container'
  );
});

test('displayChapterResults updates chapterResults', () => {
  assert.ok(
    files.mainJs.includes("ui.chapterResults.style.display = 'block'") ||
    files.mainJs.includes('chapterResults.style.display'),
    'displayChapterResults should show chapterResults container'
  );
});

// ============================================================================
// 8. SERVICE FUNCTIONS - Backend Validation
// ============================================================================

console.log('\n=== 8. Service Functions ===');

test('zoomGenerator exports generateZoomPoints', () => {
  assert.ok(
    files.zoomGeneratorJs.includes('module.exports') &&
    files.zoomGeneratorJs.includes('generateZoomPoints'),
    'zoomGenerator should export generateZoomPoints'
  );
});

test('zoomGenerator exports ZOOM_PRESETS', () => {
  assert.ok(
    files.zoomGeneratorJs.includes('ZOOM_PRESETS'),
    'zoomGenerator should export ZOOM_PRESETS'
  );
});

test('zoomGenerator exports ZOOM_FREQUENCIES', () => {
  assert.ok(
    files.zoomGeneratorJs.includes('ZOOM_FREQUENCIES'),
    'zoomGenerator should export ZOOM_FREQUENCIES'
  );
});

test('chapterDetection exports detectChapters', () => {
  assert.ok(
    files.chapterDetectionJs.includes('detectChapters'),
    'chapterDetection should export detectChapters'
  );
});

test('chapterDetection exports detectChaptersFallback', () => {
  assert.ok(
    files.chapterDetectionJs.includes('detectChaptersFallback'),
    'chapterDetection should export detectChaptersFallback'
  );
});

test('chapterDetection exports formatYouTubeTimestamps', () => {
  assert.ok(
    files.chapterDetectionJs.includes('formatYouTubeTimestamps'),
    'chapterDetection should export formatYouTubeTimestamps'
  );
});

// ============================================================================
// 9. ERROR HANDLING - Graceful Failures
// ============================================================================

console.log('\n=== 9. Error Handling ===');

test('fetchZoomPoints has try/catch', () => {
  const fn = files.mainJs.match(/async function fetchZoomPoints[\s\S]*?^}/m);
  assert.ok(fn && fn[0].includes('try') && fn[0].includes('catch'),
    'fetchZoomPoints should have try/catch'
  );
});

test('fetchChapters has try/catch', () => {
  const fn = files.mainJs.match(/async function fetchChapters[\s\S]*?^}/m);
  assert.ok(fn && fn[0].includes('try') && fn[0].includes('catch'),
    'fetchChapters should have try/catch'
  );
});

test('applyZoomsToTimeline has try/catch', () => {
  const fn = files.mainJs.match(/async function applyZoomsToTimeline[\s\S]*?^}/m);
  assert.ok(fn && fn[0].includes('try') && fn[0].includes('catch'),
    'applyZoomsToTimeline should have try/catch'
  );
});

test('Zoom error shows user-friendly message', () => {
  assert.ok(
    files.mainJs.includes('Zoom error:') || files.mainJs.includes('setStatus(`Zoom error'),
    'Zoom errors should show user-friendly message'
  );
});

test('Chapter error shows user-friendly message', () => {
  assert.ok(
    files.mainJs.includes('Chapter error:') || files.mainJs.includes('setStatus(`Chapter error'),
    'Chapter errors should show user-friendly message'
  );
});

// ============================================================================
// 10. UI ELEMENT CACHING - Performance
// ============================================================================

console.log('\n=== 10. UI Element Caching ===');

test('Zoom UI elements cached', () => {
  assert.ok(
    files.mainJs.includes("ui.enableZoom = document.getElementById") &&
    files.mainJs.includes("ui.zoomSettings = document.getElementById"),
    'Zoom UI elements should be cached in ui object'
  );
});

test('Chapter UI elements cached', () => {
  assert.ok(
    files.mainJs.includes("ui.enableChapters = document.getElementById") &&
    files.mainJs.includes("ui.chapterSettings = document.getElementById"),
    'Chapter UI elements should be cached in ui object'
  );
});

test('Apply buttons cached', () => {
  assert.ok(
    files.mainJs.includes("ui.applyZoomsBtn = document.getElementById") &&
    files.mainJs.includes("ui.addChapterMarkersBtn = document.getElementById"),
    'Apply buttons should be cached in ui object'
  );
});

test('Results containers cached', () => {
  assert.ok(
    files.mainJs.includes("ui.zoomResults = document.getElementById") &&
    files.mainJs.includes("ui.chapterResults = document.getElementById"),
    'Results containers should be cached in ui object'
  );
});

// ============================================================================
// SUMMARY
// ============================================================================

console.log('\n' + '='.repeat(60));
console.log('  PHASE 4 E2E INTEGRATION TEST SUMMARY');
console.log('='.repeat(60));
console.log(`  ✓ Passed: ${passed}`);
console.log(`  ✗ Failed: ${failed}`);
console.log(`  ○ Skipped: ${skipped}`);
console.log(`  Total: ${passed + failed + skipped}`);
console.log('='.repeat(60));

if (failed > 0) {
  console.log('\n⚠️  Some tests failed! Review the errors above.');
  process.exit(1);
} else {
  console.log('\n✅ All Phase 4 integration tests passed!');
  process.exit(0);
}
