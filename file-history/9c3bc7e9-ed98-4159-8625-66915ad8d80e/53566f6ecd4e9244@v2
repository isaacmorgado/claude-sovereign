/**
 * Comprehensive Final E2E Test
 *
 * Validates all security and UX fixes are properly implemented:
 * 1. Batch endpoints auth - customer ownership verification
 * 2. /cut-list auth - requireCredits() middleware
 * 3. Credits badge error state - retry UI
 * 4. Offline detection - navigator.onLine checks
 * 5. Credits cache on logout - clearCreditsCache()
 * 6. Builder UXP runtime - proper API usage
 *
 * Also validates:
 * - All modules load correctly
 * - No syntax errors
 * - Functions are exported/available
 * - UI wiring is correct
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

let passed = 0;
let failed = 0;
let skipped = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

function skip(name, reason) {
  console.log(`  ○ ${name} (skipped: ${reason})`);
  skipped++;
}

// ============================================================================
// File Loading
// ============================================================================

const pluginDir = path.join(__dirname, '../../splice-plugin/js');
const backendDir = path.join(__dirname, '../');
const routesDir = path.join(backendDir, 'routes');

// Helper to safely read route file
function readRouteFile(name) {
  const filePath = path.join(routesDir, name);
  return fs.existsSync(filePath) ? fs.readFileSync(filePath, 'utf8') : '';
}

const files = {
  serverJs: fs.readFileSync(path.join(backendDir, 'server.js'), 'utf8'),
  creditsJs: fs.readFileSync(path.join(pluginDir, 'credits.js'), 'utf8'),
  settingsJs: fs.readFileSync(path.join(pluginDir, 'settings.js'), 'utf8'),
  configJs: fs.readFileSync(path.join(pluginDir, 'config.js'), 'utf8'),
  mainJs: fs.readFileSync(path.join(pluginDir, 'main.js'), 'utf8'),
  builderJs: fs.readFileSync(path.join(pluginDir, 'builder.js'), 'utf8'),
  indexHtml: fs.readFileSync(path.join(__dirname, '../../splice-plugin/index.html'), 'utf8'),
  // Route modules (modular server architecture)
  routesIndex: readRouteFile('index.js'),
  routesHealth: readRouteFile('health.js'),
  routesAnalyze: readRouteFile('analyze.js'),
  routesSilences: readRouteFile('silences.js'),
  routesDetection: readRouteFile('detection.js'),
  routesExport: readRouteFile('export.js'),
  routesMultitrack: readRouteFile('multitrack.js'),
  routesCutList: readRouteFile('cutList.js'),
  routesZoom: readRouteFile('zoom.js'),
  routesChapters: readRouteFile('chapters.js'),
  routesYoutube: readRouteFile('youtube.js'),
  routesCaptions: readRouteFile('captions.js'),
  routesTextEdit: readRouteFile('textEdit.js'),
  routesReframe: readRouteFile('reframe.js'),
  routesBatch: readRouteFile('batch.js'),
  routesBilling: readRouteFile('billing.js'),
  routesReferral: readRouteFile('referral.js'),
  routesLicense: readRouteFile('license.js'),
  routesMusic: readRouteFile('music.js'),
  routesAuth: readRouteFile('auth.js')
};

// Combined backend code (server.js + all routes) for pattern matching
const allBackendCode = files.serverJs +
  files.routesIndex + files.routesHealth + files.routesAnalyze + files.routesSilences +
  files.routesDetection + files.routesExport + files.routesMultitrack + files.routesCutList +
  files.routesZoom + files.routesChapters + files.routesYoutube + files.routesCaptions +
  files.routesTextEdit + files.routesReframe + files.routesBatch + files.routesBilling +
  files.routesReferral + files.routesLicense + files.routesMusic + files.routesAuth;

// ============================================================================
// Test Suite 1: Batch Endpoints Auth
// ============================================================================

console.log('\n=== 1. Batch Endpoints Auth ===');

test('GET /batch/status verifies customer ownership', () => {
  // Check in routes/batch.js (modular architecture)
  assert.ok(allBackendCode.includes("router.get('/status/:jobId'") || allBackendCode.includes("app.get('/batch/status/:jobId'"));
  // Check for ownership verification logic
  assert.ok(allBackendCode.includes('stripeCustomerId'), 'Should extract customer ID');
  assert.ok(allBackendCode.includes('403') || allBackendCode.includes('Access denied'), 'Should return 403 for unauthorized');
});

test('GET /batch/results verifies customer ownership', () => {
  const resultsSection = allBackendCode.includes("job.stripeCustomerId !== stripeCustomerId");
  assert.ok(resultsSection, 'Should compare job owner with requesting customer');
});

test('DELETE /batch/:jobId verifies customer ownership', () => {
  // Check for delete endpoint in routes
  assert.ok(allBackendCode.includes("router.delete('/:jobId'") || allBackendCode.includes("app.delete('/batch/:jobId'"), 'DELETE endpoint should exist');
  assert.ok(allBackendCode.includes('Access denied'), 'Should have access denied message');
});

test('GET /batch/jobs filters by customer', () => {
  assert.ok(allBackendCode.includes('.filter(job => !job.stripeCustomerId || job.stripeCustomerId === stripeCustomerId)'),
    'Should filter jobs by customer');
});

// ============================================================================
// Test Suite 2: /cut-list Auth
// ============================================================================

console.log('\n=== 2. /cut-list Auth ===');

test('POST /cut-list has requireCredits middleware', () => {
  // Check in routes/cutList.js (modular architecture) - uses router.post('/', ...) not app.post('/cut-list', ...)
  assert.ok(allBackendCode.includes("requireCredits(") && allBackendCode.includes("router.post('/',"),
    '/cut-list should have requireCredits middleware');
});

test('POST /cut-list/takes has requireCredits middleware', () => {
  // Check in routes/cutList.js (modular architecture)
  assert.ok(allBackendCode.includes("requireCredits(") && allBackendCode.includes("router.post('/takes',"),
    '/cut-list/takes should have requireCredits middleware');
});

// ============================================================================
// Test Suite 3: Credits Badge Error State
// ============================================================================

console.log('\n=== 3. Credits Badge Error State ===');

test('fetchCredits returns error object on failure', () => {
  assert.ok(files.creditsJs.includes('_error: true'), 'Should return error object');
});

test('updateCreditDisplay handles error state', () => {
  assert.ok(files.creditsJs.includes("classList.add('error')"), 'Should add error class');
  assert.ok(files.creditsJs.includes('Retry'), 'Should show Retry text');
});

test('updateCreditDisplay handles login state', () => {
  assert.ok(files.creditsJs.includes("classList.add('login')"), 'Should add login class');
  assert.ok(files.creditsJs.includes("textContent = 'Login'"), 'Should show Login text');
});

test('Badge click retries on error state', () => {
  assert.ok(files.settingsJs.includes("classList.contains('error')"), 'Should check for error class');
  assert.ok(files.settingsJs.includes('refreshCredits'), 'Should call refreshCredits');
});

test('CSS has error badge styles', () => {
  assert.ok(files.indexHtml.includes('.credit-badge.error'), 'Should have error CSS');
  assert.ok(files.indexHtml.includes('ff9800'), 'Should have orange color');
});

test('CSS has login badge styles', () => {
  assert.ok(files.indexHtml.includes('.credit-badge.login'), 'Should have login CSS');
});

// ============================================================================
// Test Suite 4: Offline Detection
// ============================================================================

console.log('\n=== 4. Offline Detection ===');

test('isOnline function exists', () => {
  assert.ok(files.configJs.includes('function isOnline()'), 'Should have isOnline function');
});

test('isOnline checks navigator.onLine', () => {
  assert.ok(files.configJs.includes('navigator.onLine'), 'Should check navigator.onLine');
});

test('initOfflineDetection function exists', () => {
  assert.ok(files.configJs.includes('function initOfflineDetection()'), 'Should have initOfflineDetection');
});

test('Listens for online/offline events', () => {
  assert.ok(files.configJs.includes("addEventListener('online'"), 'Should listen for online');
  assert.ok(files.configJs.includes("addEventListener('offline'"), 'Should listen for offline');
});

test('updateOfflineUI disables GO button', () => {
  assert.ok(files.configJs.includes('goBtn.disabled = true'), 'Should disable GO button');
});

test('main.js initializes offline detection', () => {
  assert.ok(files.mainJs.includes('initOfflineDetection'), 'Should call initOfflineDetection');
});

test('GO button checks online status', () => {
  assert.ok(files.mainJs.includes('isOnline()'), 'Should check isOnline before proceeding');
});

// ============================================================================
// Test Suite 5: Credits Cache on Logout
// ============================================================================

console.log('\n=== 5. Credits Cache on Logout ===');

test('clearCreditsCache function exists', () => {
  assert.ok(files.creditsJs.includes('function clearCreditsCache()'), 'Should have clearCreditsCache');
});

test('clearCreditsCache clears all state', () => {
  assert.ok(files.creditsJs.includes('currentCredits = null'), 'Should clear currentCredits');
  assert.ok(files.creditsJs.includes('lastCreditsError = null'), 'Should clear lastCreditsError');
  assert.ok(files.creditsJs.includes('creditsRetryCount = 0'), 'Should reset retry count');
});

test('logout calls clearCreditsCache', () => {
  assert.ok(files.settingsJs.includes('clearCreditsCache'), 'logout should call clearCreditsCache');
});

test('logout updates credit display', () => {
  assert.ok(files.settingsJs.includes('updateCreditDisplay(null)'), 'logout should update display');
});

// ============================================================================
// Test Suite 6: Builder UXP Runtime
// ============================================================================

console.log('\n=== 6. Builder UXP Runtime ===');

test('Uses TickTime API (not TICKS_PER_SECOND)', () => {
  assert.ok(files.builderJs.includes('TickTime.createWithSeconds'), 'Should use TickTime API');
  // Should NOT have manual tick math
  const hasManualMath = /\*\s*TICKS_PER_SECOND|\bTICKS_PER_SECOND\s*\*/.test(files.builderJs);
  assert.ok(!hasManualMath, 'Should NOT use manual tick conversion');
});

test('Has ProjectItemType fallback', () => {
  assert.ok(files.builderJs.includes('pproBuilder?.Constants?.ProjectItemType'), 'Should have fallback');
});

test('Uses executeTransaction for batch ops', () => {
  const count = (files.builderJs.match(/executeTransaction/g) || []).length;
  assert.ok(count >= 3, 'Should use executeTransaction multiple times');
});

test('Uses lockedAccess for thread safety', () => {
  const count = (files.builderJs.match(/lockedAccess/g) || []).length;
  assert.ok(count >= 3, 'Should use lockedAccess multiple times');
});

test('Exports via window.spliceBuilder', () => {
  assert.ok(files.builderJs.includes('window.spliceBuilder'), 'Should export');
  assert.ok(files.builderJs.includes('buildSequenceFromCutList'), 'Should export buildSequenceFromCutList');
});

// ============================================================================
// Test Suite 7: General Wiring & Integration
// ============================================================================

console.log('\n=== 7. General Wiring & Integration ===');

test('config.js exports getBackendUrl', () => {
  assert.ok(files.configJs.includes('function getBackendUrl()'), 'Should have getBackendUrl');
});

test('config.js exports fetchWithTimeout', () => {
  assert.ok(files.configJs.includes('function fetchWithTimeout'), 'Should have fetchWithTimeout');
});

test('config.js exports parseErrorResponse', () => {
  assert.ok(files.configJs.includes('function parseErrorResponse'), 'Should have parseErrorResponse');
});

test('main.js uses getAuthHeaders', () => {
  assert.ok(files.mainJs.includes('getAuthHeaders'), 'Should use getAuthHeaders');
});

test('main.js uses getBackendUrl', () => {
  assert.ok(files.mainJs.includes('getBackendUrl()'), 'Should use getBackendUrl');
});

test('main.js uses fetchWithTimeout', () => {
  assert.ok(files.mainJs.includes('fetchWithTimeout'), 'Should use fetchWithTimeout');
});

test('main.js uses parseErrorResponse', () => {
  assert.ok(files.mainJs.includes('parseErrorResponse'), 'Should use parseErrorResponse');
});

test('builder.js is loaded in index.html', () => {
  assert.ok(files.indexHtml.includes('builder.js'), 'index.html should load builder.js');
});

test('config.js is loaded in index.html', () => {
  assert.ok(files.indexHtml.includes('config.js'), 'index.html should load config.js');
});

test('credits.js is loaded in index.html', () => {
  assert.ok(files.indexHtml.includes('credits.js'), 'index.html should load credits.js');
});

// ============================================================================
// Test Suite 8: No Hardcoded Values
// ============================================================================

console.log('\n=== 8. No Hardcoded Values ===');

test('No hardcoded localhost in plugin', () => {
  // Should use 127.0.0.1, not localhost (UXP requirement)
  const hasLocalhost = files.mainJs.includes("fetch('http://localhost") ||
                       files.mainJs.includes("fetch('https://localhost");
  assert.ok(!hasLocalhost, 'Should not use localhost in fetch calls');
});

test('Backend URL uses 127.0.0.1', () => {
  assert.ok(files.configJs.includes('127.0.0.1'), 'Should use 127.0.0.1');
});

// ============================================================================
// Test Suite 9: Silence Detection RMS Wiring
// ============================================================================

console.log('\n=== 9. Silence Detection RMS Wiring ===');

test('detectSilences uses /silences-rms endpoint', () => {
  // Should use RMS endpoint, not FFprobe
  const usesRMS = files.mainJs.includes('/silences-rms');
  const notFFprobe = !files.mainJs.includes('/silences-audio');
  assert.ok(usesRMS, 'Should call /silences-rms endpoint');
  assert.ok(notFFprobe, 'Should NOT call /silences-audio endpoint');
});

test('detectSilences passes sensitivity parameter', () => {
  // Should pass sensitivity directly to backend
  const passesSensitivity = files.mainJs.includes('sensitivity: sensitivity') ||
                            files.mainJs.includes('sensitivity:sensitivity');
  assert.ok(passesSensitivity, 'Should pass sensitivity to backend');
});

test('detectSilences supports both sensitivity number and legacy params', () => {
  // Function should handle both cases for backwards compatibility
  const hasTypeCheck = files.mainJs.includes("typeof sensitivityOrParams === 'number'");
  assert.ok(hasTypeCheck, 'Should check if input is number or object');
});

test('Backend has sensitivityToParams function', () => {
  const rmsSource = fs.readFileSync(path.join(backendDir, 'services/rmsSilenceDetection.js'), 'utf-8');
  const hasSensitivityMapping = rmsSource.includes('function sensitivityToParams');
  assert.ok(hasSensitivityMapping, 'Should have sensitivityToParams function');
});

test('RMS detection has chunked processing for long files', () => {
  const rmsSource = fs.readFileSync(path.join(backendDir, 'services/rmsSilenceDetection.js'), 'utf-8');
  const hasChunking = rmsSource.includes('chunkDuration') && rmsSource.includes('detectSilencesRMSChunked');
  assert.ok(hasChunking, 'Should support chunked processing');
});

// ============================================================================
// Test Suite 10: License Key Flow
// ============================================================================

console.log('\n=== 10. License Key Flow ===');

test('POST /license/lookup endpoint exists', () => {
  // Check in routes/license.js (modular architecture)
  assert.ok(allBackendCode.includes("router.post('/lookup'") || allBackendCode.includes("app.post('/license/lookup'"), 'Should have /license/lookup endpoint');
});

test('/license/lookup validates email format', () => {
  assert.ok(allBackendCode.includes('Invalid email format'), 'Should validate email format');
});

test('/license/lookup looks up customer by email in Stripe', () => {
  assert.ok(allBackendCode.includes('stripe.customers.list'), 'Should use Stripe customer lookup');
});

test('Plugin has email lookup UI', () => {
  assert.ok(files.indexHtml.includes('lookupEmailInput'), 'Should have email input');
  assert.ok(files.indexHtml.includes('lookupLicenseBtn'), 'Should have lookup button');
  assert.ok(files.indexHtml.includes('foundLicenseKey'), 'Should have result display');
});

test('Plugin handles license lookup', () => {
  assert.ok(files.settingsJs.includes('/license/lookup'), 'Should call /license/lookup endpoint');
  assert.ok(files.settingsJs.includes('lookupLicenseBtn'), 'Should wire up lookup button');
});

// ============================================================================
// Summary
// ============================================================================

console.log('\n' + '='.repeat(50));
console.log('=== FINAL E2E TEST RESULTS ===');
console.log('='.repeat(50));
console.log(`✓ Passed: ${passed}`);
console.log(`✗ Failed: ${failed}`);
console.log(`○ Skipped: ${skipped}`);
console.log(`─ Total: ${passed + failed + skipped}`);
console.log('='.repeat(50));

if (failed === 0) {
  console.log('\n✅ ALL TESTS PASSED - Ready for production\n');
} else {
  console.log('\n❌ SOME TESTS FAILED - Review and fix before production\n');
}

process.exit(failed > 0 ? 1 : 0);
