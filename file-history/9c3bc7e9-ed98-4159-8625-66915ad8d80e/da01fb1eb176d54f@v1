/**
 * Auth Routes
 *
 * Authentication endpoints (login, refresh, logout)
 */

const express = require('express');

/**
 * Create auth routes
 * @param {Object} options - Route configuration options
 * @param {Object} options.middleware - Shared middleware (authenticateToken)
 * @param {Object} options.services - Shared services (usageTracking, licenseService)
 * @param {Object} options.authHelpers - Auth helper functions
 * @returns {express.Router}
 */
function createAuthRoutes(options = {}) {
  const router = express.Router();
  const { authenticateToken } = options.middleware || {};
  const { generateToken, generateRefreshToken, verifyToken, maskSensitiveData } = options.authHelpers || {};
  const { usageTracking, licenseService } = options.services || {};

  /**
   * POST /login - Authenticate with license key and get JWT token
   *
   * SECURITY: This is the primary authentication endpoint.
   * Validates license key and returns a JWT token for API access.
   */
  router.post('/login', async (req, res) => {
    const { licenseKey } = req.body;

    if (!licenseKey) {
      return res.status(400).json({
        error: 'License key required',
        message: 'Please provide your license key to log in'
      });
    }

    try {
      // Validate and activate the license key
      const licenseResult = await licenseService.activateLicense(licenseKey);

      if (!licenseResult.success) {
        console.log(`[Auth] Failed login attempt with key: ${maskSensitiveData(licenseKey)}`);
        return res.status(401).json({
          error: 'Invalid license key',
          message: licenseResult.error || 'The license key is invalid or expired'
        });
      }

      // Get user's tier and balance
      const balance = await usageTracking.getBalance(licenseResult.customerId);

      // Generate JWT tokens
      const tokenResult = generateToken(licenseResult.customerId, {
        tier: balance.tier,
        email: licenseResult.email
      });
      const refreshResult = generateRefreshToken(licenseResult.customerId);

      console.log(`[Auth] Successful login for ${maskSensitiveData(licenseResult.customerId)}`);

      res.json({
        success: true,
        token: tokenResult.token,
        tokenType: tokenResult.tokenType,
        expiresIn: tokenResult.expiresIn,
        refreshToken: refreshResult.refreshToken,
        customerId: licenseResult.customerId,
        tier: balance.tier,
        hoursRemaining: balance.hoursRemaining
      });
    } catch (err) {
      console.error('[Auth] Login error:', err.message);
      res.status(500).json({ error: 'Authentication failed. Please try again.' });
    }
  });

  /**
   * POST /refresh - Refresh an expired JWT token
   *
   * Uses a refresh token to get a new access token
   */
  router.post('/refresh', async (req, res) => {
    const { refreshToken } = req.body;

    if (!refreshToken) {
      return res.status(400).json({
        error: 'Refresh token required'
      });
    }

    try {
      const decoded = verifyToken(refreshToken);

      if (!decoded || decoded.type !== 'refresh') {
        return res.status(401).json({
          error: 'Invalid refresh token',
          message: 'Please log in again'
        });
      }

      // Get current user info
      const balance = await usageTracking.getBalance(decoded.sub);

      // Generate new access token
      const tokenResult = generateToken(decoded.sub, {
        tier: balance.tier
      });

      console.log(`[Auth] Token refreshed for ${maskSensitiveData(decoded.sub)}`);

      res.json({
        success: true,
        token: tokenResult.token,
        tokenType: tokenResult.tokenType,
        expiresIn: tokenResult.expiresIn
      });
    } catch (err) {
      console.error('[Auth] Token refresh error:', err.message);
      res.status(401).json({
        error: 'Failed to refresh token',
        message: 'Please log in again'
      });
    }
  });

  /**
   * POST /logout - Invalidate tokens (client-side)
   *
   * Note: JWT tokens are stateless, so this is primarily for logging
   * and future token blacklisting if needed.
   */
  router.post('/logout', authenticateToken, (req, res) => {
    console.log(`[Auth] Logout for ${maskSensitiveData(req.stripeCustomerId)}`);

    // TODO: If implementing token blacklisting, add token to blacklist here

    res.json({
      success: true,
      message: 'Logged out successfully'
    });
  });

  return router;
}

module.exports = createAuthRoutes;
