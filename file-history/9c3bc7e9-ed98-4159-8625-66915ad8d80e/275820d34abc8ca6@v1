/**
 * Phase 2: Multitrack UI E2E Tests
 *
 * Tests for:
 * - Multitrack UI components in index.html
 * - Multitrack.js module functionality
 * - Backend multitrack endpoints
 * - Speaker distribution chart rendering
 * - Decision list interactions
 */

const fs = require('fs');
const path = require('path');

// Test results
let passed = 0;
let failed = 0;
const results = [];

function test(name, fn) {
  try {
    fn();
    passed++;
    results.push({ name, status: 'passed' });
    console.log(`  ✓ ${name}`);
  } catch (err) {
    failed++;
    results.push({ name, status: 'failed', error: err.message });
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
  }
}

function assert(condition, message) {
  if (!condition) throw new Error(message || 'Assertion failed');
}

// Load files for testing
const indexPath = path.join(__dirname, '../../splice-plugin/index.html');
const multitrackPath = path.join(__dirname, '../../splice-plugin/js/multitrack.js');
const mainPath = path.join(__dirname, '../../splice-plugin/js/main.js');
const serverPath = path.join(__dirname, '../server.js');
const multitrackAnalysisPath = path.join(__dirname, '../services/multitrackAnalysis.js');
const multitrackRoutePath = path.join(__dirname, '../routes/multitrack.js');

const indexHtml = fs.existsSync(indexPath) ? fs.readFileSync(indexPath, 'utf8') : '';
const multitrackJs = fs.existsSync(multitrackPath) ? fs.readFileSync(multitrackPath, 'utf8') : '';
const mainJs = fs.existsSync(mainPath) ? fs.readFileSync(mainPath, 'utf8') : '';
const serverJs = fs.existsSync(serverPath) ? fs.readFileSync(serverPath, 'utf8') : '';
const multitrackAnalysisJs = fs.existsSync(multitrackAnalysisPath) ? fs.readFileSync(multitrackAnalysisPath, 'utf8') : '';
const multitrackRouteJs = fs.existsSync(multitrackRoutePath) ? fs.readFileSync(multitrackRoutePath, 'utf8') : '';

// Combined backend code for pattern matching (server.js + route files)
const allBackendCode = serverJs + multitrackRouteJs;

console.log('=== Phase 2: Multitrack E2E Tests ===\n');

// 1. HTML Structure Tests
console.log('=== 1. Multitrack HTML Structure ===');

test('Multitrack section exists in index.html', () => {
  assert(indexHtml.includes('id="multitrackSection"'), 'Missing multitrackSection');
});

test('Multitrack toggle button exists', () => {
  assert(indexHtml.includes('id="multitrackToggle"'), 'Missing multitrackToggle');
});

test('Multitrack panel exists', () => {
  assert(indexHtml.includes('id="multitrackPanel"'), 'Missing multitrackPanel');
});

test('Speaker list exists', () => {
  assert(indexHtml.includes('id="speakerList"'), 'Missing speakerList');
});

test('Add speaker button exists', () => {
  assert(indexHtml.includes('id="addSpeakerBtn"'), 'Missing addSpeakerBtn');
});

test('Wide shot track dropdown exists', () => {
  assert(indexHtml.includes('id="wideShotTrack"'), 'Missing wideShotTrack');
});

test('Min shot duration slider exists', () => {
  assert(indexHtml.includes('id="minShotDuration"'), 'Missing minShotDuration');
});

test('Wide shot percentage slider exists', () => {
  assert(indexHtml.includes('id="wideShotPercent"'), 'Missing wideShotPercent');
});

test('Switching frequency slider exists', () => {
  assert(indexHtml.includes('id="switchingFrequency"'), 'Missing switchingFrequency');
});

test('Analyze button exists', () => {
  assert(indexHtml.includes('id="analyzeMultitrackBtn"'), 'Missing analyzeMultitrackBtn');
});

test('Auto-balance button exists', () => {
  assert(indexHtml.includes('id="autoBalanceBtn"'), 'Missing autoBalanceBtn');
});

test('Apply button exists', () => {
  assert(indexHtml.includes('id="applyMultitrackBtn"'), 'Missing applyMultitrackBtn');
});

test('Distribution chart container exists', () => {
  assert(indexHtml.includes('id="distributionChart"'), 'Missing distributionChart');
});

test('Decision list exists', () => {
  assert(indexHtml.includes('id="decisionList"'), 'Missing decisionList');
});

test('Multitrack preview section exists', () => {
  assert(indexHtml.includes('id="multitrackPreview"'), 'Missing multitrackPreview');
});

// 2. CSS Tests
console.log('\n=== 2. Multitrack CSS Styles ===');

test('Multitrack section styles exist', () => {
  assert(indexHtml.includes('.multitrack-section'), 'Missing .multitrack-section styles');
});

test('Speaker configuration styles exist', () => {
  assert(indexHtml.includes('.speaker-config'), 'Missing .speaker-config styles');
});

test('Speaker item styles exist', () => {
  assert(indexHtml.includes('.speaker-item'), 'Missing .speaker-item styles');
});

test('Distribution chart styles exist', () => {
  assert(indexHtml.includes('.distribution-chart'), 'Missing .distribution-chart styles');
});

test('Distribution bar styles exist', () => {
  assert(indexHtml.includes('.distribution-bar'), 'Missing .distribution-bar styles');
});

test('Decision item styles exist', () => {
  assert(indexHtml.includes('.decision-item'), 'Missing .decision-item styles');
});

test('Speaker color classes exist', () => {
  assert(indexHtml.includes('.speaker-0'), 'Missing .speaker-0 color class');
  assert(indexHtml.includes('.speaker-1'), 'Missing .speaker-1 color class');
});

test('Wide shot color class exists', () => {
  assert(indexHtml.includes('.wide-shot'), 'Missing .wide-shot color class');
});

// 3. Multitrack.js Module Tests
console.log('\n=== 3. Multitrack.js Module ===');

test('multitrack.js is loaded in index.html', () => {
  assert(indexHtml.includes('js/multitrack.js'), 'multitrack.js not loaded');
});

test('multitrack.js file exists', () => {
  assert(multitrackJs.length > 0, 'multitrack.js file is empty or missing');
});

test('initMultitrackUI function exists', () => {
  assert(multitrackJs.includes('function initMultitrackUI'), 'Missing initMultitrackUI function');
});

test('cacheMultitrackElements function exists', () => {
  assert(multitrackJs.includes('function cacheMultitrackElements'), 'Missing cacheMultitrackElements function');
});

test('analyzeMultitrack function exists', () => {
  assert(multitrackJs.includes('async function analyzeMultitrack'), 'Missing analyzeMultitrack function');
});

test('autoBalanceMultitrack function exists', () => {
  assert(multitrackJs.includes('async function autoBalanceMultitrack'), 'Missing autoBalanceMultitrack function');
});

test('applyMultitrackCuts function exists', () => {
  assert(multitrackJs.includes('async function applyMultitrackCuts'), 'Missing applyMultitrackCuts function');
});

test('displayMultitrackResults function exists', () => {
  assert(multitrackJs.includes('function displayMultitrackResults'), 'Missing displayMultitrackResults function');
});

test('renderDistributionChart function exists', () => {
  assert(multitrackJs.includes('function renderDistributionChart'), 'Missing renderDistributionChart function');
});

test('renderDecisionList function exists', () => {
  assert(multitrackJs.includes('function renderDecisionList'), 'Missing renderDecisionList function');
});

test('addSpeaker function exists', () => {
  assert(multitrackJs.includes('function addSpeaker'), 'Missing addSpeaker function');
});

test('removeSpeaker function exists', () => {
  assert(multitrackJs.includes('function removeSpeaker'), 'Missing removeSpeaker function');
});

test('getMultitrackSettings function exists', () => {
  assert(multitrackJs.includes('function getMultitrackSettings'), 'Missing getMultitrackSettings function');
});

test('window.spliceMultitrack is exported', () => {
  assert(multitrackJs.includes('window.spliceMultitrack'), 'Missing window.spliceMultitrack export');
});

test('window.initMultitrackUI is exported', () => {
  assert(multitrackJs.includes('window.initMultitrackUI'), 'Missing window.initMultitrackUI export');
});

// 4. Main.js Integration Tests
console.log('\n=== 4. Main.js Integration ===');

test('main.js calls initMultitrackUI', () => {
  assert(mainJs.includes('initMultitrackUI'), 'initMultitrackUI not called in main.js');
});

test('main.js has multitrack workflow code', () => {
  assert(mainJs.includes('multitrack') || mainJs.includes('Multitrack'), 'Missing multitrack workflow code');
});

// 5. Backend Endpoint Tests
console.log('\n=== 5. Backend Endpoints ===');

test('POST /multitrack endpoint exists', () => {
  assert(serverJs.includes("app.post('/multitrack'"), 'Missing POST /multitrack endpoint');
});

test('POST /multitrack/auto-balance endpoint exists', () => {
  assert(serverJs.includes("app.post('/multitrack/auto-balance'"), 'Missing POST /multitrack/auto-balance endpoint');
});

test('/multitrack has requireCredits middleware', () => {
  const multitrackMatch = serverJs.match(/app\.post\('\/multitrack'[^)]+requireCredits/);
  assert(multitrackMatch, '/multitrack missing requireCredits middleware');
});

test('/multitrack/auto-balance has requireCredits middleware', () => {
  const autoBalanceMatch = serverJs.match(/app\.post\('\/multitrack\/auto-balance'[^)]+requireCredits/);
  assert(autoBalanceMatch, '/multitrack/auto-balance missing requireCredits middleware');
});

// 6. multitrackAnalysis.js Tests
console.log('\n=== 6. Multitrack Analysis Service ===');

test('multitrackAnalysis.js exists and has content', () => {
  assert(multitrackAnalysisJs.length > 0, 'multitrackAnalysis.js is empty or missing');
});

test('analyzeMultitrack function exported', () => {
  assert(multitrackAnalysisJs.includes('analyzeMultitrack'), 'Missing analyzeMultitrack export');
});

test('autoBalanceMultitrack function exported', () => {
  assert(multitrackAnalysisJs.includes('autoBalanceMultitrack'), 'Missing autoBalanceMultitrack export');
});

// 7. API Integration Tests
console.log('\n=== 7. API Integration ===');

test('multitrack.js uses getBackendUrl()', () => {
  assert(multitrackJs.includes('getBackendUrl()'), 'Missing getBackendUrl() usage');
});

test('multitrack.js uses getAuthHeaders()', () => {
  assert(multitrackJs.includes('getAuthHeaders()'), 'Missing getAuthHeaders() usage');
});

test('multitrack.js uses fetchWithTimeout()', () => {
  assert(multitrackJs.includes('fetchWithTimeout('), 'Missing fetchWithTimeout() usage');
});

test('multitrack.js uses parseErrorResponse()', () => {
  assert(multitrackJs.includes('parseErrorResponse('), 'Missing parseErrorResponse() usage');
});

test('multitrack.js checks online status', () => {
  assert(multitrackJs.includes('isOnline'), 'Missing isOnline check');
});

// 8. ARIA Accessibility Tests
console.log('\n=== 8. ARIA Accessibility ===');

test('Speaker inputs have aria-labels', () => {
  assert(indexHtml.includes('aria-label="Speaker') && indexHtml.includes('name"'), 'Missing speaker name aria-labels');
});

test('Track dropdowns have aria-labels', () => {
  assert(indexHtml.includes('aria-label="Speaker') && indexHtml.includes('video track"'), 'Missing track dropdown aria-labels');
});

test('Action buttons have aria-labels', () => {
  assert(indexHtml.includes('aria-label="Analyze'), 'Missing analyze button aria-label');
  assert(indexHtml.includes('aria-label="Auto-balance'), 'Missing auto-balance button aria-label');
  assert(indexHtml.includes('aria-label="Apply multitrack'), 'Missing apply button aria-label');
});

test('Sliders have aria-labels', () => {
  assert(indexHtml.includes('aria-label="Minimum shot duration'), 'Missing min shot duration aria-label');
  assert(indexHtml.includes('aria-label="Wide shot percentage'), 'Missing wide shot percentage aria-label');
});

// 9. Event Handler Tests
console.log('\n=== 9. Event Handlers ===');

test('Toggle section click handler', () => {
  assert(multitrackJs.includes('toggleMultitrackSection'), 'Missing toggleMultitrackSection function');
});

test('Speaker list event delegation', () => {
  assert(multitrackJs.includes('handleSpeakerListClick'), 'Missing handleSpeakerListClick function');
});

test('Decision list event delegation', () => {
  assert(multitrackJs.includes('handleDecisionListClick'), 'Missing handleDecisionListClick function');
});

test('Parameter slider listeners', () => {
  assert(multitrackJs.includes('setupParameterListeners'), 'Missing setupParameterListeners function');
});

// 10. UI State Management Tests
console.log('\n=== 10. UI State Management ===');

test('speakerConfig state variable exists', () => {
  assert(multitrackJs.includes('let speakerConfig'), 'Missing speakerConfig state');
});

test('analysisResults state variable exists', () => {
  assert(multitrackJs.includes('let analysisResults'), 'Missing analysisResults state');
});

test('isMultitrackOperationInProgress flag exists', () => {
  assert(multitrackJs.includes('isMultitrackOperationInProgress'), 'Missing operation in progress flag');
});

test('Buttons disabled during operations', () => {
  assert(multitrackJs.includes('analyzeBtn.disabled = true'), 'Analyze button not disabled during operation');
  assert(multitrackJs.includes('autoBalanceBtn.disabled = true'), 'Auto-balance button not disabled during operation');
});

// 11. Distribution Chart Tests
console.log('\n=== 11. Distribution Chart ===');

test('renderDistributionChart handles metadata', () => {
  assert(multitrackJs.includes('speakerPercentages'), 'Missing speakerPercentages handling');
});

test('Wide shot percentage in chart', () => {
  assert(multitrackJs.includes('wideShotPct'), 'Missing wide shot percentage in chart');
});

test('Speaker stats rendering', () => {
  assert(multitrackJs.includes('renderSpeakerStats'), 'Missing renderSpeakerStats function');
});

// 12. Cut List Generation Tests
console.log('\n=== 12. Cut List Generation ===');

test('applyMultitrackCuts creates cut list', () => {
  assert(multitrackJs.includes("version: '3.5'"), 'Missing cut list version');
});

test('Cut list includes speaker info', () => {
  assert(multitrackJs.includes('speaker: d.speakerName'), 'Missing speaker in cut list');
});

test('Cut list includes color hints', () => {
  assert(multitrackJs.includes('colorHint:'), 'Missing colorHint in cut list');
});

test('Uses window.spliceBuilder', () => {
  assert(multitrackJs.includes('window.spliceBuilder'), 'Missing spliceBuilder usage');
});

// Summary
console.log('\n==================================================');
console.log('=== PHASE 2 MULTITRACK TEST RESULTS ===');
console.log('==================================================');
console.log(`✓ Passed: ${passed}`);
console.log(`✗ Failed: ${failed}`);
console.log(`─ Total: ${passed + failed}`);
console.log('==================================================');

if (failed === 0) {
  console.log('\n✅ ALL PHASE 2 MULTITRACK TESTS PASSED');
} else {
  console.log('\n❌ SOME TESTS FAILED - Review and fix issues');
  process.exit(1);
}
