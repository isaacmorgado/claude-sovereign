'use client';

import { useState, useMemo, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Sparkles,
  TrendingUp,
  Target,
  Zap,
  ChevronRight,
  Lock,
  CheckCircle,
  AlertCircle,
  CheckCircle2,
  Scale,
  Dumbbell,
  Salad,
  ArrowDown,
  ArrowUp,
  Minus,
  Package,
  ShoppingCart,
} from 'lucide-react';
import { useResults } from '@/contexts/ResultsContext';
import { useAuth } from '@/contexts/AuthContext';
import { usePhysiqueOptional } from '@/contexts/PhysiqueContext';
import { TabContent } from '../ResultsLayout';
import { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';
import { ScoreCircle, PhaseBadge } from '../shared';
import { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';
import { TreatmentTimeline } from '../visualization/TreatmentTimeline';
import { RecommendationPhase, ProductRecommendation } from '@/types/results';
import { DailyStackCard } from '../cards/DailyStackCard';
import { ProductCard } from '../cards/ProductCard';
import { WeakPointCard } from '../cards/WeakPointCard';
import { ProgressComparisonCard } from '../cards/ProgressComparisonCard';
import { generateDailyStack } from '@/lib/daily-stack';
import { getProductRecommendations } from '@/lib/product-recommendations';
import { SUPPLEMENTS } from '@/lib/recommendations/supplements';

// ============================================
// POTENTIAL SCORE CARD
// ============================================

function PotentialScoreCard() {
  const { overallScore, recommendations } = useResults();
  const numericScore = typeof overallScore === 'number' ? overallScore : 0;

  // Calculate potential improvement
  const potentialImprovement = useMemo(() => {
    if (recommendations.length === 0) return 0;
    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);
    return Math.min(totalImpact * 1.5, 10 - numericScore);
  }, [recommendations, numericScore]);

  const potentialScore = Math.min(10, numericScore + potentialImprovement);

  return (
    <motion.div
      className="bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6"
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
    >
      <div className="flex items-center gap-2 mb-4">
        <Sparkles size={20} className="text-cyan-400" />
        <h3 className="font-semibold text-white">Your Potential</h3>
      </div>

      <div className="flex items-center justify-center gap-8 mb-6">
        {/* Current */}
        <div className="text-center">
          <p className="text-xs text-neutral-500 mb-2">Current</p>
          <ScoreCircle score={overallScore} size="lg" animate={false} />
        </div>

        {/* Arrow */}
        <div className="flex flex-col items-center gap-1">
          <ChevronRight size={24} className="text-cyan-400" />
          <span className="text-xs text-green-400">+{potentialImprovement.toFixed(1)}</span>
        </div>

        {/* Potential */}
        <div className="text-center">
          <p className="text-xs text-neutral-500 mb-2">Potential</p>
          <div className="relative">
            <ScoreCircle score={potentialScore} size="lg" animate={false} />
            <div className="absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
              <TrendingUp size={12} className="text-black" />
            </div>
          </div>
        </div>
      </div>

      <p className="text-sm text-neutral-400 text-center">
        Following our recommendations could improve your harmony score by up to{' '}
        <span className="text-green-400 font-medium">+{potentialImprovement.toFixed(1)} points</span>
      </p>
    </motion.div>
  );
}

// ============================================
// PHASE FILTER
// ============================================

interface PhaseFilterProps {
  selectedPhase: RecommendationPhase | null;
  onSelect: (phase: RecommendationPhase | null) => void;
  counts: Record<RecommendationPhase, number>;
}

function PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {
  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];

  return (
    <div className="flex flex-wrap gap-2">
      <button
        onClick={() => onSelect(null)}
        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
          selectedPhase === null
            ? 'bg-cyan-500 text-black'
            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'
        }`}
      >
        All ({Object.values(counts).reduce((a, b) => a + b, 0)})
      </button>
      {phases.map(phase => (
        <button
          key={phase}
          onClick={() => onSelect(phase)}
          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${
            selectedPhase === phase
              ? 'bg-neutral-700 text-white'
              : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'
          }`}
        >
          <PhaseBadge phase={phase} size="sm" />
          ({counts[phase] || 0})
        </button>
      ))}
    </div>
  );
}

// ============================================
// BEFORE/AFTER PREVIEW SECTION
// ============================================

function BeforeAfterPreviewSection() {
  const { frontPhoto, overallScore, recommendations } = useResults();
  const numericScore = typeof overallScore === 'number' ? overallScore : 0;

  // Calculate potential improvement
  const potentialImprovement = useMemo(() => {
    if (recommendations.length === 0) return 0;
    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);
    return Math.min(totalImpact * 1.5, 10 - numericScore);
  }, [recommendations, numericScore]);

  const potentialScore = Math.min(10, numericScore + potentialImprovement);

  if (!frontPhoto) return null;

  return (
    <BeforeAfterPreview
      photo={frontPhoto}
      currentScore={numericScore}
      potentialScore={potentialScore}
      recommendations={recommendations}
    />
  );
}

// ============================================
// ORDER OF OPERATIONS
// ============================================

function OrderOfOperations() {
  return (
    <div className="bg-neutral-900/50 border border-neutral-800 rounded-xl p-4">
      <h4 className="font-medium text-white mb-3 flex items-center gap-2">
        <Target size={16} className="text-cyan-400" />
        Recommended Order
      </h4>
      <div className="space-y-3">
        <div className="flex items-start gap-3">
          <div className="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
            <span className="text-xs font-bold text-green-400">1</span>
          </div>
          <div>
            <p className="text-sm font-medium text-white">Start with Foundational</p>
            <p className="text-xs text-neutral-500">Low-cost, no-risk improvements that anyone can do</p>
          </div>
        </div>
        <div className="flex items-start gap-3">
          <div className="w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
            <span className="text-xs font-bold text-yellow-400">2</span>
          </div>
          <div>
            <p className="text-sm font-medium text-white">Consider Minimally Invasive</p>
            <p className="text-xs text-neutral-500">Temporary or reversible options with moderate impact</p>
          </div>
        </div>
        <div className="flex items-start gap-3">
          <div className="w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
            <span className="text-xs font-bold text-red-400">3</span>
          </div>
          <div>
            <p className="text-sm font-medium text-white">Evaluate Surgical Options</p>
            <p className="text-xs text-neutral-500">Permanent solutions for significant improvements</p>
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// YOUR PHASE CARD (Body Composition Phase)
// ============================================

type BodyPhase = 'bulk' | 'cut' | 'maintain';

interface YourPhaseCardProps {
  bodyFatPercent?: number;
  gender: 'male' | 'female';
}

function YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {
  // Determine phase based on body fat and gender
  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {
    if (!bodyFatPercent) {
      return {
        phase: 'maintain',
        message: 'Complete your physique analysis to get personalized phase recommendations.',
        color: 'from-neutral-700 to-neutral-800',
        icon: <Scale size={24} className="text-neutral-400" />,
      };
    }

    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut
    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut
    const bulkThreshold = gender === 'male' ? 12 : 18;
    const cutThreshold = gender === 'male' ? 18 : 25;

    if (bodyFatPercent < bulkThreshold) {
      return {
        phase: 'bulk',
        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,
        color: 'from-green-600 to-emerald-700',
        icon: <Dumbbell size={24} className="text-white" />,
      };
    } else if (bodyFatPercent > cutThreshold) {
      return {
        phase: 'cut',
        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,
        color: 'from-orange-600 to-red-700',
        icon: <Salad size={24} className="text-white" />,
      };
    } else {
      return {
        phase: 'maintain',
        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,
        color: 'from-blue-600 to-cyan-700',
        icon: <Scale size={24} className="text-white" />,
      };
    }
  };

  const { phase, message, color, icon } = getPhase();
  const phaseLabels: Record<BodyPhase, string> = {
    bulk: 'Lean Bulk Phase',
    cut: 'Cutting Phase',
    maintain: 'Maintenance Phase',
  };

  return (
    <motion.div
      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
    >
      <div className="flex items-start gap-4">
        <div className="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0">
          {icon}
        </div>
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1">
            <h3 className="font-semibold text-white text-lg">Your Phase</h3>
            <div className="px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white">
              {phaseLabels[phase]}
            </div>
          </div>
          <p className="text-sm text-white/80 mb-4">{message}</p>

          {/* Phase-specific tips */}
          <div className="grid grid-cols-3 gap-2">
            <div className="bg-black/20 rounded-lg p-2 text-center">
              <div className="flex items-center justify-center gap-1 mb-0.5">
                {phase === 'bulk' ? (
                  <ArrowUp size={12} className="text-green-300" />
                ) : phase === 'cut' ? (
                  <ArrowDown size={12} className="text-orange-300" />
                ) : (
                  <Minus size={12} className="text-blue-300" />
                )}
                <span className="text-xs text-white/60">Calories</span>
              </div>
              <span className="text-sm font-medium text-white">
                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : 'Â±0'}
              </span>
            </div>
            <div className="bg-black/20 rounded-lg p-2 text-center">
              <span className="text-xs text-white/60 block mb-0.5">Protein</span>
              <span className="text-sm font-medium text-white">
                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}
              </span>
            </div>
            <div className="bg-black/20 rounded-lg p-2 text-center">
              <span className="text-xs text-white/60 block mb-0.5">Cardio</span>
              <span className="text-sm font-medium text-white">
                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}
              </span>
            </div>
          </div>
        </div>
      </div>
    </motion.div>
  );
}

// ============================================
// PRODUCT BUNDLE CTA
// ============================================

interface ProductBundleCardProps {
  products: ProductRecommendation[];
  title?: string;
}

function ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {
  // Get top 3 most important products
  const bundleProducts = products.slice(0, 3);

  // Calculate total cost
  const totalCost = bundleProducts.reduce((sum, rec) => {
    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);
    return sum + (supplement?.costPerMonth.min || 0);
  }, 0);

  if (bundleProducts.length === 0) return null;

  return (
    <motion.div
      className="bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6"
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
    >
      <div className="flex items-center gap-2 mb-4">
        <Package size={20} className="text-purple-400" />
        <h3 className="font-semibold text-white">{title}</h3>
        <div className="ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full">
          Save 15%
        </div>
      </div>

      <p className="text-sm text-neutral-300 mb-4">
        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.
      </p>

      {/* Bundle Items */}
      <div className="space-y-2 mb-4">
        {bundleProducts.map((rec, index) => (
          <div
            key={rec.product.id}
            className="flex items-center gap-3 p-2 bg-black/20 rounded-lg"
          >
            <div className="w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0">
              <span className="text-xs font-bold text-purple-300">{index + 1}</span>
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-white truncate">{rec.product.name}</p>
              <p className="text-xs text-neutral-400 truncate">Targets: {rec.targetMetric}</p>
            </div>
            <div className="text-right flex-shrink-0">
              <p className="text-sm text-white">
                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo
              </p>
            </div>
          </div>
        ))}
      </div>

      {/* Total & CTA */}
      <div className="border-t border-purple-500/20 pt-4">
        <div className="flex items-center justify-between mb-3">
          <span className="text-neutral-400">Bundle Total</span>
          <div className="text-right">
            <span className="text-lg font-bold text-white">${totalCost}/mo</span>
            <span className="text-xs text-neutral-500 ml-2 line-through">${Math.round(totalCost * 1.15)}/mo</span>
          </div>
        </div>
        <button
          className="w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity"
        >
          <ShoppingCart size={18} />
          Get Your Bundle
        </button>
      </div>
    </motion.div>
  );
}

// ============================================
// PLAN TAB
// ============================================

export function PlanTab() {
  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto } = useResults();
  const { user } = useAuth();
  const physiqueContext = usePhysiqueOptional();
  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());
  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());
  const [previousAnalysis, setPreviousAnalysis] = useState<{
    date: string;
    overallScore: number;
    bodyFatPercent?: number;
    frontPhotoUrl?: string;
  } | null>(null);

  // Convert to number for arithmetic operations
  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;

  // Check if user has a paid plan
  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';

  // Get body fat from physique analysis
  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;

  // Generate Daily Stack for all users
  const dailyStack = useMemo(() => {
    return generateDailyStack(gender);
  }, [gender]);

  // Generate Product Recommendations based on metrics
  const productRecommendations = useMemo(() => {
    // Build metrics and severity dictionaries from ratios
    const metricsDict: Record<string, number> = {};
    const severityDict: Record<string, string> = {};

    [...frontRatios, ...sideRatios].forEach(ratio => {
      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;
      severityDict[ratio.name] = ratio.severity;
    });

    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);
  }, [frontRatios, sideRatios, gender, ethnicity]);

  // Split product recommendations by state
  const { flawProducts, idealProducts } = useMemo(() => {
    const flaw = productRecommendations.filter(r => r.state === 'flaw');
    const ideal = productRecommendations.filter(r => r.state === 'ideal');
    return { flawProducts: flaw, idealProducts: ideal };
  }, [productRecommendations]);

  // Map flaws to products and treatments
  const flawsWithProducts = useMemo(() => {
    return flaws.slice(0, 5).map(flaw => {
      // Find products that target metrics related to this flaw
      const relatedProducts = productRecommendations.filter(rec =>
        flaw.responsibleRatios.some(ratio =>
          rec.matchedMetrics.some(metric =>
            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||
            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())
          )
        )
      );

      // Find treatments that match this flaw
      const relatedTreatments = recommendations.filter(rec =>
        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))
      );

      return {
        flaw,
        products: relatedProducts.slice(0, 2),
        treatments: relatedTreatments.slice(0, 3),
      };
    });
  }, [flaws, productRecommendations, recommendations]);

  // Handle progress photo upload
  const handleProgressPhotoUpload = useCallback(async (file: File) => {
    // Store current analysis as previous before re-analyzing
    const numScore = typeof overallScore === 'number' ? overallScore : 0;
    setPreviousAnalysis({
      date: new Date().toISOString(),
      overallScore: numScore,
      bodyFatPercent,
      frontPhotoUrl: frontPhoto || undefined,
    });

    // In a real implementation, this would upload to API and trigger re-analysis
    console.log('Progress photo uploaded:', file.name);
  }, [overallScore, bodyFatPercent, frontPhoto]);

  // Count recommendations by phase
  const phaseCounts = useMemo(() => {
    const counts: Record<RecommendationPhase, number> = {
      'Foundational': 0,
      'Minimally Invasive': 0,
      'Surgical': 0,
    };
    recommendations.forEach(r => {
      if (!removedIds.has(r.ref_id)) {
        counts[r.phase]++;
      }
    });
    return counts;
  }, [recommendations, removedIds]);

  // Filter recommendations
  const filteredRecommendations = useMemo(() => {
    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));
    if (selectedPhase) {
      filtered = filtered.filter(r => r.phase === selectedPhase);
    }
    return filtered;
  }, [recommendations, selectedPhase, removedIds]);

  const hasRecommendations = filteredRecommendations.length > 0;

  // Handle mark complete
  const handleMarkComplete = useCallback((id: string) => {
    setCompletedIds(prev => {
      const newSet = new Set(prev);
      if (newSet.has(id)) {
        newSet.delete(id);
      } else {
        newSet.add(id);
      }
      return newSet;
    });
  }, []);

  // Handle remove
  const handleRemove = useCallback((id: string) => {
    setRemovedIds(prev => {
      const newSet = new Set(prev);
      newSet.add(id);
      return newSet;
    });
    if (expandedId === id) {
      setExpandedId(null);
    }
  }, [expandedId]);

  return (
    <TabContent
      title="Your Plan & Potential"
      subtitle="Personalized recommendations based on your analysis"
    >
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Main Content */}
        <div className="lg:col-span-2 space-y-6">
          {/* Your Phase Card - Body Composition Phase */}
          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />

          {/* Daily Stack Card - Hero Element for ALL users */}
          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}

          {/* Potential Score */}
          <PotentialScoreCard />

          {/* Fix Your Weak Points Section */}
          {flawsWithProducts.length > 0 && (
            <div className="space-y-4">
              <div className="flex items-center gap-2">
                <AlertCircle size={20} className="text-red-400" />
                <h3 className="text-lg font-semibold text-white">Fix Your Weak Points</h3>
                <span className="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30">
                  {flawsWithProducts.length} Issues
                </span>
              </div>
              <div className="space-y-3">
                {flawsWithProducts.map((item, index) => (
                  <WeakPointCard
                    key={item.flaw.id}
                    flaw={item.flaw}
                    rank={index + 1}
                    products={item.products}
                    treatments={item.treatments}
                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}
                  />
                ))}
              </div>
            </div>
          )}

          {/* Targeted Product Recommendations - Corrective */}
          {flawProducts.length > 0 && (
            <div className="space-y-4">
              <div className="flex items-center gap-2">
                <Package size={20} className="text-cyan-400" />
                <h3 className="text-lg font-semibold text-white">Recommended Products</h3>
                <span className="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30">
                  Corrective
                </span>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {flawProducts.slice(0, 6).map((rec, index) => (
                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />
                ))}
              </div>
            </div>
          )}

          {/* Targeted Product Recommendations - Maintenance */}
          {idealProducts.length > 0 && (
            <div className="space-y-4">
              <div className="flex items-center gap-2">
                <CheckCircle2 size={20} className="text-green-400" />
                <h3 className="text-lg font-semibold text-white">Protect Your Strengths</h3>
                <span className="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30">
                  Maintenance
                </span>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {idealProducts.slice(0, 4).map((rec) => (
                  <ProductCard key={rec.product.id} recommendation={rec} />
                ))}
              </div>
            </div>
          )}

          {/* Treatment Timeline */}
          {recommendations.length > 0 && (
            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />
          )}

          {/* Phase Filter */}
          <PhaseFilter
            selectedPhase={selectedPhase}
            onSelect={setSelectedPhase}
            counts={phaseCounts}
          />

          {/* Recommendations List */}
          {hasRecommendations ? (
            <motion.div className="space-y-4" layout>
              <AnimatePresence mode="popLayout">
                {filteredRecommendations.map((rec, index) => (
                  <motion.div
                    key={rec.ref_id}
                    layout
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -20 }}
                    transition={{ duration: 0.2, delay: index * 0.05 }}
                  >
                    <EnhancedRecommendationCard
                      recommendation={rec}
                      rank={index + 1}
                      isExpanded={expandedId === rec.ref_id}
                      onToggle={() => setExpandedId(
                        expandedId === rec.ref_id ? null : rec.ref_id
                      )}
                      onMarkComplete={handleMarkComplete}
                      onRemove={handleRemove}
                      isCompleted={completedIds.has(rec.ref_id)}
                      gender={gender}
                      ethnicity={ethnicity}
                    />
                  </motion.div>
                ))}
              </AnimatePresence>
            </motion.div>
          ) : (
            <div className="bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center">
              <Sparkles size={48} className="mx-auto text-neutral-700 mb-4" />
              <h3 className="text-lg font-medium text-white mb-2">No Recommendations Yet</h3>
              <p className="text-neutral-500 mb-4">
                Complete a facial analysis to get personalized recommendations
              </p>
            </div>
          )}
        </div>

        {/* Sidebar */}
        <div className="space-y-6">
          {/* Progress Comparison Card */}
          <ProgressComparisonCard
            currentAnalysis={{
              date: new Date().toISOString(),
              overallScore: numericOverallScore,
              bodyFatPercent,
              frontPhotoUrl: frontPhoto || undefined,
            }}
            previousAnalysis={previousAnalysis}
            onUploadNewPhoto={handleProgressPhotoUpload}
          />

          {/* Product Bundle CTA */}
          {flawProducts.length >= 3 && (
            <ProductBundleCard
              products={flawProducts}
              title="Your Fix Bundle"
            />
          )}

          {/* Before/After Preview */}
          <BeforeAfterPreviewSection />

          {/* Order of Operations */}
          <OrderOfOperations />

          {/* My Plan Summary */}
          <div className="bg-neutral-900/50 border border-neutral-800 rounded-xl p-4">
            <h4 className="font-medium text-white mb-3 flex items-center gap-2">
              <Zap size={16} className="text-yellow-400" />
              My Plan
            </h4>
            <div className="text-center py-6">
              <div className="w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center">
                <Lock size={20} className="text-neutral-600" />
              </div>
              <p className="text-sm text-neutral-500 mb-3">
                Add recommendations to build your personalized plan
              </p>
              <p className="text-xs text-neutral-600">
                0 items selected
              </p>
            </div>
          </div>

          {/* Issues Summary */}
          <div className="bg-neutral-900/50 border border-neutral-800 rounded-xl p-4">
            <h4 className="font-medium text-white mb-3">Detected Issues</h4>
            <div className="space-y-2">
              {flaws.slice(0, 5).map(flaw => (
                <div
                  key={flaw.id}
                  className="flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg"
                >
                  <span className="text-sm text-neutral-300 truncate">{flaw.flawName}</span>
                  <span className="text-xs text-red-400 flex-shrink-0">
                    -{flaw.harmonyPercentageLost.toFixed(1)}%
                  </span>
                </div>
              ))}
              {flaws.length === 0 && (
                <p className="text-sm text-neutral-500 text-center py-4">
                  No issues detected
                </p>
              )}
            </div>
          </div>

          {/* Upgrade CTA or Premium Badge */}
          {hasPaidPlan ? (
            <motion.div
              className="bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.3 }}
            >
              <div className="flex items-center gap-2 mb-2">
                <CheckCircle size={16} className="text-green-400" />
                <span className="text-sm font-medium text-white">
                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active
                </span>
              </div>
              <p className="text-xs text-neutral-400">
                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.
              </p>
            </motion.div>
          ) : (
            <motion.div
              className="bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.3 }}
            >
              <div className="flex items-center gap-2 mb-2">
                <Sparkles size={16} className="text-cyan-400" />
                <span className="text-sm font-medium text-white">Unlock Full Plan</span>
              </div>
              <p className="text-xs text-neutral-400 mb-3">
                Get detailed treatment guides, cost estimates, and provider recommendations.
              </p>
              <a
                href="/pricing"
                className="block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors"
              >
                Upgrade Now
              </a>
            </motion.div>
          )}
        </div>
      </div>
    </TabContent>
  );
}
