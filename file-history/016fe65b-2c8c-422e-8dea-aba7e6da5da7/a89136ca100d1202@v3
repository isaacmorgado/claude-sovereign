/* eslint-disable @typescript-eslint/no-unused-vars */
/* eslint-disable @typescript-eslint/no-explicit-any */
'use client';

import React, { createContext, useContext, useState, useMemo, useCallback, useEffect, ReactNode } from 'react';
import { LandmarkPoint } from '@/lib/landmarks';
import {
  MetricScoreResult,
  METRIC_CONFIGS,
  Ethnicity,
  Gender,
} from '@/lib/harmony-scoring';
import {
  calculateHarmonyScore,
  getTopMetrics,
  getBottomMetrics,
  HarmonyScoreResult,
  RankedMetric,
} from '@/lib/looksmax-scoring';
import { harmonyToPSL } from '@/lib/recommendations/severity';
import {
  classifyInsights,
  convertToStrength,
  convertToFlaw,
  INSIGHTS_DEFINITIONS,
} from '@/lib/insights-engine';
import { classifyMetric } from '@/lib/taxonomy';
import {
  Ratio,
  Strength,
  Flaw,
  Recommendation,
  ResultsTab,
  FullHarmonyAnalysis,
  ProfileAnalysis,
} from '@/types/results';
import { generateRecommendations } from '@/lib/results/analysis';
// Import types for the new data
import { PSLResult } from '@/types/psl';
import { ArchetypeClassification } from '@/lib/archetype-classifier';

// ============================================
// CONTEXT TYPES
// ============================================

interface ResultsContextType {
  // Raw data
  frontLandmarks: LandmarkPoint[];
  sideLandmarks: LandmarkPoint[];
  gender: Gender;
  ethnicity: Ethnicity;
  frontPhoto: string;
  sidePhoto: string | null;
  isUnlocked: boolean;

  // Computed results
  harmonyAnalysis: FullHarmonyAnalysis | null;
  frontRatios: Ratio[];
  sideRatios: Ratio[];
  strengths: Strength[];
  flaws: Flaw[];
  recommendations: Recommendation[];

  // Scores
  overallScore: number | string;
  frontScore: number | string;
  sideScore: number | string;

  // Weighted Harmony Score
  harmonyScoreResult: HarmonyScoreResult | null;
  harmonyPercentage: number;  // 0-100% weighted harmony

  // Top 3 strengths and bottom 3 areas to improve with advice
  topMetrics: RankedMetric[];
  bottomMetrics: RankedMetric[];

  // Archetype Analysis
  archetype: ArchetypeClassification | null;

  // PSL Rating (1-10 scale)
  pslRating: {
    psl: number;
    tier: string;
    percentile: number;
    description: string;
  };

  // UI state
  activeTab: ResultsTab;
  setActiveTab: (tab: ResultsTab) => void;
  expandedMeasurementId: string | null;
  setExpandedMeasurementId: (id: string | null) => void;
  selectedVisualizationMetric: string | null;
  setSelectedVisualizationMetric: (id: string | null) => void;
  categoryFilter: string | null;
  setCategoryFilter: (category: string | null) => void;
  showLandmarkOverlay: boolean;
  setShowLandmarkOverlay: (show: boolean) => void;
  isLoading: boolean;
  error: string | null;

  // Actions
  setResultsData: (data: ResultsInputData) => void;
  refetchAnalysis: () => Promise<void>;
}

interface ResultsInputData {
  frontLandmarks: LandmarkPoint[];
  sideLandmarks: LandmarkPoint[];
  frontPhoto: string;
  sidePhoto?: string;
  gender: Gender;
  ethnicity?: Ethnicity;
  isUnlocked?: boolean;
}

// ============================================
// ILLUSTRATION CONFIGURATION
// ============================================

interface IllustrationConfig {
  points: string[];
  lines: Array<{
    from: string;
    to: string;
    label?: string;
    color?: string;
    labelPosition?: 'start' | 'middle' | 'end';
  }>;
}

const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {
  // FACE SHAPE / PROPORTIONS
  faceWidthToHeight: {
    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
    lines: [
      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },
      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },
    ],
  },
  totalFacialWidthToHeight: {
    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
    lines: [
      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },
      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },
    ],
  },
  lowerThirdProportion: {
    points: ['subnasale', 'menton', 'trichion'],
    lines: [
      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },
      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
    ],
  },
  middleThirdProportion: {
    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],
    lines: [
      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },
      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
    ],
  },
  upperThirdProportion: {
    points: ['trichion', 'nasal_base', 'menton'],
    lines: [
      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },
      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
    ],
  },
  bitemporalWidth: {
    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },
    ],
  },
  cheekboneHeight: {
    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],
    lines: [
      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },
      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },
    ],
  },
  midfaceRatio: {
    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],
    lines: [
      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },
      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },
    ],
  },

  // JAW MEASUREMENTS
  jawSlope: {
    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],
    lines: [
      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },
      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },
    ],
  },
  jawFrontalAngle: {
    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],
    lines: [
      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },
      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },
    ],
  },
  bigonialWidth: {
    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },
    ],
  },
  jawWidthRatio: {
    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },
    ],
  },

  // EYE MEASUREMENTS
  lateralCanthalTilt: {
    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],
    lines: [
      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },
      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },
    ],
  },
  eyeAspectRatio: {
    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],
    lines: [
      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },
      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },
    ],
  },
  eyeSeparationRatio: {
    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
    ],
  },
  interpupillaryRatio: {
    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
    ],
  },
  interpupillaryMouthWidthRatio: {
    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],
    lines: [
      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },
      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
    ],
  },
  oneEyeApartTest: {
    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],
    lines: [
      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },
      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },
    ],
  },

  // EYEBROW MEASUREMENTS
  browLengthRatio: {
    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],
    lines: [
      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },
      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
    ],
  },
  eyebrowTilt: {
    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],
    lines: [
      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },
      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },
    ],
  },
  eyebrowLowSetedness: {
    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],
    lines: [
      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },
    ],
  },

  // NOSE MEASUREMENTS (FRONT)
  nasalIndex: {
    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],
    lines: [
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },
      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },
    ],
  },
  intercanthalNasalRatio: {
    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],
    lines: [
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },
      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },
    ],
  },
  noseBridgeWidth: {
    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],
    lines: [
      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },
    ],
  },
  noseTipPosition: {
    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],
    lines: [
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },
    ],
  },

  // MOUTH/LIP MEASUREMENTS
  mouthNoseWidthRatio: {
    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],
    lines: [
      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },
    ],
  },
  lowerUpperLipRatio: {
    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],
    lines: [
      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },
      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },
    ],
  },
  chinPhiltrumRatio: {
    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],
    lines: [
      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },
      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },
    ],
  },
  mouthWidth: {
    points: ['left_cheilion', 'right_cheilion'],
    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],
  },

  // CHIN MEASUREMENTS
  chinHeight: {
    points: ['labrale_inferius', 'menton'],
    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],
  },

  // NECK MEASUREMENTS
  neckWidthRatio: {
    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],
    lines: [
      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },
      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },
    ],
  },

  // SIDE PROFILE MEASUREMENTS
  gonialAngle: {
    points: ['tragus', 'gonionBottom', 'menton'],
    lines: [
      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },
      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },
    ],
  },
  nasofrontalAngle: {
    points: ['glabella', 'nasion', 'pronasale'],
    lines: [
      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },
      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },
    ],
  },
  nasofacialAngle: {
    points: ['nasion', 'pronasale', 'pogonion'],
    lines: [
      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },
      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },
    ],
  },
  nasomentaAngle: {
    points: ['nasion', 'pronasale', 'pogonion'],
    lines: [
      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },
      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },
    ],
  },
  submentalCervicalAngle: {
    points: ['menton', 'cervicalPoint', 'neckPoint'],
    lines: [
      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },
      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },
    ],
  },
  facialDepthToHeight: {
    points: ['pronasale', 'tragus', 'nasion', 'menton'],
    lines: [
      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },
      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },
    ],
  },
  anteriorFacialDepth: {
    points: ['glabella', 'pronasale', 'pogonion'],
    lines: [
      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },
      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },
    ],
  },
  mandibularPlaneAngle: {
    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],
    lines: [
      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },
      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },
    ],
  },
  ramusToMandibleRatio: {
    points: ['gonionTop', 'gonionBottom', 'menton'],
    lines: [
      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },
      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },
    ],
  },
  orbitalVector: {
    points: ['cornealApex', 'orbitale', 'cheekbone'],
    lines: [
      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },
    ],
  },
  eLineLowerLip: {
    points: ['pronasale', 'pogonion', 'labraleInferius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },
    ],
  },
  sLineLowerLip: {
    points: ['pronasale', 'pogonion', 'labraleInferius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },
    ],
  },
  holdawayHLine: {
    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },
    ],
  },
  burstoneLowerLip: {
    points: ['subnasale', 'pogonion', 'labraleInferius'],
    lines: [
      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },
    ],
  },

  // ADDITIONAL FRONT PROFILE METRICS
  cupidsBowDepth: {
    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],
    lines: [
      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },
      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },
    ],
  },
  mouthCornerPosition: {
    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],
    lines: [
      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },
      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },
    ],
  },
  iaaJfaDeviation: {
    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],
    lines: [
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },
      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },
      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },
    ],
  },
  ipsilateralAlarAngle: {
    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],
    lines: [
      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },
      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },
    ],
  },
  earProtrusionAngle: {
    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],
    lines: [
      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },
    ],
  },
  earProtrusionRatio: {
    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],
    lines: [
      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },
      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },
    ],
  },
  mouthWidthToNoseRatio: {
    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],
    lines: [
      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },
    ],
  },
  lowerToUpperLipRatio: {
    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],
    lines: [
      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },
      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },
    ],
  },
  chinToPhiltrumRatio: {
    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],
    lines: [
      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },
      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },
    ],
  },

  // ADDITIONAL SIDE PROFILE METRICS
  nasolabialAngle: {
    points: ['columella', 'subnasale', 'labraleSuperius'],
    lines: [
      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },
      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },
    ],
  },
  nasalTipAngle: {
    points: ['nasion', 'pronasale', 'columella'],
    lines: [
      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },
      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },
    ],
  },
  nasalProjection: {
    points: ['alar_crease', 'pronasale', 'subnasale'],
    lines: [
      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },
    ],
  },
  nasalWToHRatio: {
    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],
    lines: [
      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },
      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },
    ],
  },
  noseTipRotationAngle: {
    points: ['columella', 'subnasale', 'labraleSuperius'],
    lines: [
      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },
    ],
  },
  frankfortTipAngle: {
    points: ['porion', 'orbitale', 'pronasale'],
    lines: [
      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },
    ],
  },
  mentolabialAngle: {
    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],
    lines: [
      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },
      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },
    ],
  },
  zAngle: {
    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],
    lines: [
      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },
    ],
  },
  facialConvexityGlabella: {
    points: ['glabella', 'subnasale', 'pogonion'],
    lines: [
      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },
      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
    ],
  },
  facialConvexityNasion: {
    points: ['nasion', 'subnasale', 'pogonion'],
    lines: [
      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },
      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
    ],
  },
  totalFacialConvexity: {
    points: ['glabella', 'pronasale', 'pogonion'],
    lines: [
      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },
      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
    ],
  },
  interiorMidfaceProjectionAngle: {
    points: ['orbitale', 'subnasale', 'pronasale'],
    lines: [
      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },
      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },
    ],
  },
  recessionFromFrankfort: {
    points: ['porion', 'orbitale', 'pogonion'],
    lines: [
      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },
    ],
  },
  gonionToMouthLine: {
    points: ['gonionBottom', 'cheilion', 'tragus'],
    lines: [
      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },
    ],
  },
  eLineUpperLip: {
    points: ['pronasale', 'pogonion', 'labraleSuperius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },
    ],
  },
  sLineUpperLip: {
    points: ['pronasale', 'pogonion', 'labraleSuperius'],
    lines: [
      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },
    ],
  },
  burstoneUpperLip: {
    points: ['subnasale', 'pogonion', 'labraleSuperius'],
    lines: [
      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },
    ],
  },
  chinProjection: {
    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],
    lines: [
      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },
    ],
  },
  recessionRelativeToFrankfort: {
    points: ['porion', 'orbitale', 'pogonion', 'menton'],
    lines: [
      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },
    ],
  },
  browridgeInclinationAngle: {
    points: ['glabella', 'trichion', 'nasion'],
    lines: [
      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },
      { from: 'glabella', to: 'nasion', color: '#67e8f9' },
    ],
  },
  upperForeheadSlope: {
    points: ['trichion', 'glabella', 'frankfortHorizontal'],
    lines: [
      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },
    ],
  },
  midfaceProjectionAngle: {
    points: ['orbitale', 'subnasale', 'pronasale'],
    lines: [
      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },
      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },
    ],
  },
};

// ============================================
// HELPER FUNCTIONS
// ============================================

function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {
  switch (unit) {
    case 'ratio': return 'x';
    case 'percent': return '%';
    case 'degrees': return '°';
    case 'mm': return 'mm';
    default: return 'x';
  }
}

function transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {
  const metricConfig = METRIC_CONFIGS[result.metricId];

  // Generate illustration based on metric
  const illustration = generateIllustration(result.metricId, landmarks);

  // Get flaw/strength mappings
  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);

  // Classify metric using Harmony taxonomy
  const taxonomyClassification = classifyMetric(result.name, result.category);

  // Clamp scores to valid 0-10 range for display (defense-in-depth)
  const clampedScore = typeof result.standardizedScore === 'number'
    ? Math.max(0, Math.min(10, result.standardizedScore))
    : result.standardizedScore;

  return {
    id: result.metricId,
    name: result.name,
    value: result.value,
    score: clampedScore,  // Use standardized 0-10 score for UI display
    standardizedScore: clampedScore,
    unit: convertUnitToRatioUnit(result.unit),
    idealMin: result.idealMin,
    idealMax: result.idealMax,
    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,
    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,
    description: metricConfig?.description || '',
    category: result.category,
    qualityLevel: result.qualityTier,
    severity: result.severity,
    illustration,
    mayIndicateFlaws,
    mayIndicateStrengths,
    usedLandmarks: getUsedLandmarks(result.metricId),
    scoringCurveConfig: metricConfig ? {
      decayRate: metricConfig.decayRate,
      maxScore: metricConfig.maxScore,
    } : undefined,
    taxonomyPrimary: taxonomyClassification?.primary,
    taxonomySecondary: taxonomyClassification?.secondary,
  };
}

function generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {
  const landmarkMap: Record<string, LandmarkPoint> = {};
  landmarks.forEach(l => { landmarkMap[l.id] = l; });

  const config = ILLUSTRATION_CONFIGS[metricId];
  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};
  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};

  if (config) {
    config.points.forEach((pointId, i) => {
      if (landmarkMap[pointId]) {
        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };
      }
    });
    config.lines.forEach((line, i) => {
      lines[`line_${i}`] = {
        from: line.from,
        to: line.to,
        color: line.color || '#67e8f9',
        label: line.label,
        labelPosition: line.labelPosition,
      };
    });
  }

  return { points, lines };
}

function getUsedLandmarks(metricId: string): string[] {
  const landmarkMappings: Record<string, string[]> = {
    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],
    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],
    ipd: ['left_pupila', 'right_pupila'],
    mouthWidth: ['left_cheilion', 'right_cheilion'],
    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],
    chinHeight: ['labrale_inferius', 'menton'],
    gonialAngle: ['tragus', 'gonionBottom', 'menton'],
  };
  return landmarkMappings[metricId] || [];
}

function getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {
  const flawMappings: Record<string, { low: string[]; high: string[] }> = {
    faceWidthToHeight: {
      low: ['Narrow face', 'Vertically elongated face'],
      high: ['Wide face', 'Horizontally expanded face'],
    },
    lowerThirdProportion: {
      low: ['Short lower third', 'Deficient mandible'],
      high: ['Long lower third', 'Mandibular excess'],
    },
    lateralCanthalTilt: {
      low: ['Negative canthal tilt', 'Drooping eyes'],
      high: ['Excessive positive canthal tilt'],
    },
    nasalIndex: {
      low: ['Narrow nose', 'Leptorrhine nose'],
      high: ['Wide nose', 'Platyrrhine nose'],
    },
    gonialAngle: {
      low: ['Steep mandibular plane'],
      high: ['Flat mandibular plane', 'Weak jaw definition'],
    },
  };

  const strengthMappings: Record<string, { ideal: string[] }> = {
    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },
    lowerThirdProportion: { ideal: ['Ideal lower third height', 'Balanced facial thirds'] },
    lateralCanthalTilt: { ideal: ['Positive canthal tilt', 'Attractive eye tilt'] },
    nasalIndex: { ideal: ['Proportionate nose width', 'Harmonious nose shape'] },
    gonialAngle: { ideal: ['Masculine jaw angle', 'Defined jawline'] },
  };

  const mayIndicateFlaws: string[] = [];
  const mayIndicateStrengths: string[] = [];

  // Very basic mapping logic for now
  if (result.severity !== 'optimal' && result.severity !== 'minor') {
    if (flawMappings[result.metricId]) {
      if (result.deviationDirection === 'below') {
        mayIndicateFlaws.push(...flawMappings[result.metricId].low);
      } else {
        mayIndicateFlaws.push(...flawMappings[result.metricId].high);
      }
    }
  }

  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {
    if (strengthMappings[result.metricId]) {
      mayIndicateStrengths.push(...strengthMappings[result.metricId].ideal);
    }
  }

  return { mayIndicateFlaws, mayIndicateStrengths };
}

// ============================================
// CONTEXT CREATION
// ============================================

const ResultsContext = createContext<ResultsContextType | null>(null);

export function useResults(): ResultsContextType {
  const context = useContext(ResultsContext);
  if (!context) {
    throw new Error('useResults must be used within a ResultsProvider');
  }
  return context;
}

interface ResultsProviderProps {
  children: ReactNode;
  initialData?: ResultsInputData;
}

export function ResultsProvider({ children, initialData }: ResultsProviderProps) {
  // Raw data state
  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);
  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);
  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');
  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');
  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');
  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);
  const [isUnlocked, setIsUnlocked] = useState<boolean>(initialData?.isUnlocked || false);

  // UI state
  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');
  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);
  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);
  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);
  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);

  // API Fetch State
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [analysisResults, setAnalysisResults] = useState<{
    frontAnalysis: { measurements: any[]; standardizedScore: number | string };
    sideAnalysis: { measurements: any[]; standardizedScore: number | string } | null;
    harmony: {
      measurements: any[];
      overallScore: number | string;
      frontScore: number | string;
      sideScore: number | string;
      standardizedScore: number | string;
    };
    psl?: PSLResult;
    archetype?: ArchetypeClassification;
    isObfuscated?: boolean;
  } | null>(null);


  // Fetch analysis from server
  const fetchAnalysis = useCallback(async () => {
    if (frontLandmarks.length === 0) return;

    setIsLoading(true);
    setError(null);
    try {
      const response = await fetch('/api/analyze-face', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          frontLandmarks,
          sideLandmarks,
          gender,
          ethnicity,
          isPaid: isUnlocked
        }),
      });

      if (!response.ok) {
        throw new Error('Analysis failed');
      }

      const data = await response.json();
      setAnalysisResults(data);
    } catch (err) {
      console.error('Fetch analysis error:', err);
      setError('Failed to load analysis. Please try again.');
    } finally {
      setIsLoading(false);
    }
  }, [frontLandmarks, sideLandmarks, gender, ethnicity, isUnlocked]);

  // Trigger fetch when data changes
  useEffect(() => {
    if (frontLandmarks.length > 0) {
      fetchAnalysis();
    }
  }, [fetchAnalysis, frontLandmarks.length]); // Depend on fetchAnalysis which covers dependencies

  // Transform to Ratio format
  const frontRatios = useMemo(() => {
    if (!analysisResults?.frontAnalysis) return [];
    return analysisResults.frontAnalysis.measurements.map((m: any) => transformToRatio(m, frontLandmarks));
  }, [analysisResults, frontLandmarks]);

  const sideRatios = useMemo(() => {
    if (!analysisResults?.sideAnalysis) return [];
    return analysisResults.sideAnalysis.measurements.map((m: any) => transformToRatio(m, sideLandmarks));
  }, [analysisResults, sideLandmarks]);

  // Generate strengths and flaws using INSIGHTS-BASED classification
  const { insightStrengths, insightFlaws } = useMemo(() => {
    if (!analysisResults?.harmony) {
      return { insightStrengths: [], insightFlaws: [] };
    }

    try {
      // Classify using insights engine
      // Note: Cast to any for harmony.measurements because of potential obfuscated strings mismatching pure types
      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =
        classifyInsights(analysisResults.harmony.measurements as any, INSIGHTS_DEFINITIONS);

      // Convert to UI-compatible types
      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));

      let rollingLost = 0;
      const insightFlaws = classifiedWeaknesses.map((w, i) => {
        const flaw = convertToFlaw(w, i, rollingLost);
        rollingLost = flaw.rollingPointsDeducted || 0;
        return flaw;
      });

      return { insightStrengths, insightFlaws };
    } catch (error) {
      console.error('[ResultsContext] Error in insights classification:', error);
      return { insightStrengths: [], insightFlaws: [] };
    }
  }, [analysisResults]);

  // Generate grouping-based strengths/flaws (legacy approach -> we don't have this function imported anymore)
  // Assuming generating strengths purely from insights now to simplify.
  // Or I can re-implement generateStrengthsFromAnalysis if needed, but it was complex.
  // For now, I will stick to insights.

  const strengths = insightStrengths;
  const flaws = useMemo(() => {
    let rollingLost = 0;
    return insightFlaws.map(f => {
      rollingLost += f.harmonyPercentageLost;
      return {
        ...f,
        rollingPointsDeducted: rollingLost,
        rollingHarmonyPercentageLost: rollingLost,
        rollingStandardizedImpact: rollingLost / 10,
      };
    });
  }, [insightFlaws]);


  // Generate recommendations
  const recommendations = useMemo(() => {
    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);
  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);

  // Build full harmony analysis
  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {
    if (!analysisResults?.harmony) return null;

    // We can just construct it from what we have
    // analysisResults.harmony has { overallScore, frontScore, sideScore, measurements, flaws, strengths }
    // But we computed distinct strengths/flaws here.
    return {
      standardizedScore: Number(analysisResults.harmony.standardizedScore) || 0,
      front: {
        standardizedScore: Number(analysisResults.harmony.frontScore) || 0,
        ratios: frontRatios,
      },
      side: {
        standardizedScore: Number(analysisResults.harmony.sideScore) || 0,
        ratios: sideRatios,
      },
      strengths,
      flaws,
    };
  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);


  // Weighted Harmony Score logic (moved to server in analyzeHarmony?)
  // Actually analyzeHarmony returns overallScore. 
  // looksmax-scoring `calculateHarmonyScore` is redundant if logic is on server.
  // We can just use the score from the server.
  // But ResultsContext type expects `harmonyScoreResult` object.
  // I will mock it or adapt it.

  const harmonyScoreResult = null; // Deprecated or handled by server

  // Get top 3 and bottom 3 metrics
  // Using the helper functions on the measurements
  const topMetrics = useMemo((): RankedMetric[] => {
    if (!analysisResults?.harmony) return [];
    return getTopMetrics(analysisResults.harmony.measurements as any, 3);
  }, [analysisResults]);

  const bottomMetrics = useMemo((): RankedMetric[] => {
    if (!analysisResults?.harmony) return [];
    return getBottomMetrics(analysisResults.harmony.measurements as any, 3);
  }, [analysisResults]);

  // Scores
  // Handle string or number
  const harmonyPercentage = analysisResults?.harmony ? (Number(analysisResults.harmony.overallScore) * 10) : 0;
  // Wait, overallScore is 0-10. HarmonyPercentage is usually 0-100.

  const overallScore = analysisResults?.harmony?.overallScore || 0;
  const frontScore = analysisResults?.harmony?.frontScore || 0;
  const sideScore = analysisResults?.harmony?.sideScore || 0;

  // Archetype
  const archetype = analysisResults?.archetype || null;

  // PSL Rating
  const pslRating = useMemo(() => {
    // Priority: Server-side PSL
    if (analysisResults?.psl) {
      return {
        psl: analysisResults.psl.score,
        tier: analysisResults.psl.tier,
        percentile: analysisResults.psl.percentile,
        description: `Your score places you in the ${analysisResults.psl.tier} tier.` // Simple fallback description or fetch via ID mapping if needed
      };
    }

    // Fallback: Legacy client-side calc
    // If obfuscated, we might not have a valid number.
    const scoreNum = Number(overallScore) * 10;
    return harmonyToPSL(isNaN(scoreNum) ? 0 : scoreNum);
  }, [overallScore, analysisResults?.psl]);

  // Action to set all results data
  const setResultsData = useCallback((data: ResultsInputData) => {
    setFrontLandmarks(data.frontLandmarks);
    setSideLandmarks(data.sideLandmarks);
    setFrontPhoto(data.frontPhoto);
    setSidePhoto(data.sidePhoto || null);
    setGender(data.gender);
    setEthnicity(data.ethnicity || 'other');
    if (data.isUnlocked !== undefined) setIsUnlocked(data.isUnlocked);
  }, []);

  const value = useMemo<ResultsContextType>(() => ({
    frontLandmarks,
    sideLandmarks,
    gender,
    ethnicity,
    frontPhoto,
    sidePhoto,
    isUnlocked,
    harmonyAnalysis,
    frontRatios,
    sideRatios,
    strengths,
    flaws,
    recommendations,
    archetype,
    overallScore,
    frontScore,
    sideScore,
    harmonyScoreResult,
    harmonyPercentage: isNaN(harmonyPercentage) ? 0 : harmonyPercentage,
    topMetrics,
    bottomMetrics,
    pslRating,
    activeTab,
    setActiveTab,
    expandedMeasurementId,
    setExpandedMeasurementId,
    selectedVisualizationMetric,
    setSelectedVisualizationMetric,
    categoryFilter,
    setCategoryFilter,
    showLandmarkOverlay,
    setShowLandmarkOverlay,
    isLoading,
    error,
    setResultsData,
    refetchAnalysis: fetchAnalysis,
  }), [
    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto, isUnlocked,
    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations, archetype,
    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,
    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,
    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,
    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,
    showLandmarkOverlay, setShowLandmarkOverlay, isLoading, error, setResultsData, fetchAnalysis
  ]);

  return (
    <ResultsContext.Provider value={value}>
      {children}
    </ResultsContext.Provider>
  );
}
