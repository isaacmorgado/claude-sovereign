#!/usr/bin/env node
/**
 * Verify Test Users Script
 *
 * Tests that all test users can authenticate successfully
 * and their credits are correctly configured.
 *
 * Usage: node scripts/verify-test-users.js [--api-url=http://localhost:3847]
 */

// Using Node.js built-in fetch (available in Node 18+)

const API_URL = process.argv.find(arg => arg.startsWith('--api-url='))?.split('=')[1] || 'http://localhost:3847';

// Test users from create-test-users.js
const TEST_USERS = [
  {
    name: 'Starter',
    licenseKey: 'SPLICE-82CF-4ZAQ-66F6',
    expectedTier: 'starter',
    expectedHours: 4,
    expectedIsolation: 0,
    expectedMusic: 5
  },
  {
    name: 'Pro',
    licenseKey: 'SPLICE-7XWQ-VE7Y-MDJN',
    expectedTier: 'pro',
    expectedHours: 15,
    expectedIsolation: 0.75,
    expectedMusic: 20
  },
  {
    name: 'Team',
    licenseKey: 'SPLICE-7DVR-4AEU-W8BU',
    expectedTier: 'team',
    expectedHours: 50,
    expectedIsolation: 3,
    expectedMusic: 100
  },
  {
    name: 'Empty',
    licenseKey: 'SPLICE-5AUT-NMS8-5SQ8',
    expectedTier: 'starter',
    expectedHours: 0,
    expectedIsolation: 0,
    expectedMusic: 0
  },
  {
    name: 'Cancelled',
    licenseKey: 'SPLICE-9QHU-F74E-5C4R',
    expectedTier: 'cancelled',
    expectedHours: 0,
    expectedIsolation: 0,
    expectedMusic: 0
  }
];

/**
 * Check if backend is running
 */
async function checkBackend() {
  try {
    const response = await axios.get(`${API_URL}/health`, { timeout: 3000 });
    return response.status === 200;
  } catch (error) {
    return false;
  }
}

/**
 * Get CSRF token
 */
async function getCsrfToken() {
  try {
    const response = await axios.get(`${API_URL}/auth/csrf-token`);
    const cookies = response.headers['set-cookie'];
    const csrfToken = response.data.csrfToken;

    return { csrfToken, cookies };
  } catch (error) {
    throw new Error(`Failed to get CSRF token: ${error.message}`);
  }
}

/**
 * Test login with license key
 */
async function testLogin(licenseKey, csrfToken, cookies) {
  try {
    const response = await axios.post(
      `${API_URL}/auth/login`,
      { licenseKey },
      {
        headers: {
          'X-CSRF-Token': csrfToken,
          'Cookie': cookies ? cookies.join('; ') : ''
        }
      }
    );

    if (response.status === 200 && response.data.token) {
      return {
        success: true,
        token: response.data.token,
        user: response.data.user
      };
    } else {
      return { success: false, error: 'No token returned' };
    }
  } catch (error) {
    return {
      success: false,
      error: error.response?.data?.error || error.message
    };
  }
}

/**
 * Get user credits
 */
async function getCredits(token) {
  try {
    const response = await axios.get(`${API_URL}/billing/credits`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    return {
      success: true,
      credits: response.data
    };
  } catch (error) {
    return {
      success: false,
      error: error.response?.data?.error || error.message
    };
  }
}

/**
 * Verify a single test user
 */
async function verifyUser(userData) {
  console.log(`\nüß™ Testing: ${userData.name} Tier`);
  console.log(`   License: ${userData.licenseKey}`);

  // Get CSRF token
  let csrfData;
  try {
    csrfData = await getCsrfToken();
  } catch (error) {
    console.log(`   ‚ùå Failed to get CSRF token: ${error.message}`);
    return false;
  }

  // Test login
  const loginResult = await testLogin(
    userData.licenseKey,
    csrfData.csrfToken,
    csrfData.cookies
  );

  if (!loginResult.success) {
    console.log(`   ‚ùå Login failed: ${loginResult.error}`);
    return false;
  }

  console.log(`   ‚úÖ Login successful`);

  // Verify user data
  const user = loginResult.user;
  const checks = [
    {
      name: 'Tier',
      actual: user.tier,
      expected: userData.expectedTier,
      pass: user.tier === userData.expectedTier
    }
  ];

  // Get credits
  const creditsResult = await getCredits(loginResult.token);

  if (!creditsResult.success) {
    console.log(`   ‚ùå Failed to get credits: ${creditsResult.error}`);
    return false;
  }

  console.log(`   ‚úÖ Credits retrieved`);

  const credits = creditsResult.credits;
  checks.push(
    {
      name: 'Hours',
      actual: credits.hours,
      expected: userData.expectedHours,
      pass: Math.abs(credits.hours - userData.expectedHours) < 0.01
    },
    {
      name: 'Isolation Hours',
      actual: credits.isolationHours,
      expected: userData.expectedIsolation,
      pass: Math.abs(credits.isolationHours - userData.expectedIsolation) < 0.01
    },
    {
      name: 'Music Credits',
      actual: credits.musicCredits,
      expected: userData.expectedMusic,
      pass: credits.musicCredits === userData.expectedMusic
    }
  );

  // Print verification results
  let allPassed = true;
  checks.forEach(check => {
    if (check.pass) {
      console.log(`   ‚úÖ ${check.name}: ${check.actual}`);
    } else {
      console.log(`   ‚ùå ${check.name}: expected ${check.expected}, got ${check.actual}`);
      allPassed = false;
    }
  });

  return allPassed;
}

/**
 * Main function
 */
async function main() {
  console.log('‚îÅ'.repeat(80));
  console.log('üîç SPLICE Test User Verification');
  console.log('‚îÅ'.repeat(80));
  console.log(`\nüåê Testing API: ${API_URL}`);

  // Check if backend is running
  console.log('\n‚è≥ Checking backend status...');
  const isRunning = await checkBackend();

  if (!isRunning) {
    console.error('\n‚ùå Backend is not running!');
    console.error('\nüí° Start the backend first:');
    console.error('   cd splice-backend');
    console.error('   npm run dev\n');
    process.exit(1);
  }

  console.log('‚úÖ Backend is running');

  // Test each user
  const results = [];
  for (const userData of TEST_USERS) {
    const passed = await verifyUser(userData);
    results.push({ name: userData.name, passed });
  }

  // Summary
  console.log('\n' + '‚îÅ'.repeat(80));
  console.log('üìä VERIFICATION SUMMARY');
  console.log('‚îÅ'.repeat(80));

  const passedCount = results.filter(r => r.passed).length;
  const totalCount = results.length;

  results.forEach(result => {
    const icon = result.passed ? '‚úÖ' : '‚ùå';
    console.log(`${icon} ${result.name} Tier`);
  });

  console.log('\n' + '‚îÅ'.repeat(80));

  if (passedCount === totalCount) {
    console.log(`‚úÖ All ${totalCount} test users verified successfully!`);
    console.log('‚îÅ'.repeat(80));
    process.exit(0);
  } else {
    console.log(`‚ùå ${totalCount - passedCount} of ${totalCount} tests failed`);
    console.log('‚îÅ'.repeat(80));
    process.exit(1);
  }
}

// Run verification
if (require.main === module) {
  main().catch(error => {
    console.error('\n‚ùå Verification failed:', error.message);
    process.exit(1);
  });
}

module.exports = { TEST_USERS };
