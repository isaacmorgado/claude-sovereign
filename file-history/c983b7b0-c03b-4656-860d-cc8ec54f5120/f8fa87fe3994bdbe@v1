/**
 * Auto-cutting workflow configuration types
 * Defines settings for silence removal, take detection, and natural pause preservation
 */

// ============================================================================
// Audio Source Settings
// ============================================================================

export type AudioSourceType = 'original' | 'isolated-vocals'

export interface AudioSourceConfig {
  /** Use vocal-isolated audio for more accurate speech detection */
  type: AudioSourceType
  /** Fallback to original if vocal isolation fails */
  fallbackToOriginal: boolean
}

// ============================================================================
// Silence Detection Settings
// ============================================================================

export type CutPosition = 'start' | 'middle' | 'end'

export interface SilenceConfig {
  /** Enable silence-based cutting */
  enabled: boolean
  /** Minimum silence duration to trigger a cut (seconds) */
  minDuration: number
  /** Maximum silence duration to consider (seconds) - longer gaps may indicate scene breaks */
  maxDuration: number
  /** Where to place the cut within the silence gap */
  cutPosition: CutPosition
  /** Audio level threshold for silence detection (dB, negative values) */
  thresholdDb: number
}

// ============================================================================
// Natural Pause Preservation
// ============================================================================

export interface NaturalPauseConfig {
  /** Enable natural pause preservation */
  enabled: boolean
  /** Minimum pause duration to preserve (seconds) - shorter than silence threshold */
  minPreserveDuration: number
  /** Maximum pause duration to preserve (seconds) */
  maxPreserveDuration: number
  /** Preserve pauses at sentence boundaries (detected via transcription) */
  preserveSentenceBoundaries: boolean
  /** Preserve pauses between speaker turns */
  preserveSpeakerTurns: boolean
}

// ============================================================================
// Take Detection Settings
// ============================================================================

export type TakeSensitivity = 'low' | 'medium' | 'high'

export interface TakeDetectionConfig {
  /** Enable take detection */
  enabled: boolean
  /** Detection sensitivity - higher = more takes detected */
  sensitivity: TakeSensitivity
  /** Minimum gap between takes (seconds) */
  minGapBetweenTakes: number
  /** Use transcription similarity to group repeated takes */
  useTranscriptionSimilarity: boolean
  /** Similarity threshold (0-1) for grouping takes */
  similarityThreshold: number
  /** Automatically select best take based on audio quality */
  autoSelectBest: boolean
}

// ============================================================================
// Take Labeling
// ============================================================================

export type TakeLabelFormat =
  | 'numeric'          // "Take 1", "Take 2"
  | 'alphabetic'       // "Take A", "Take B"
  | 'timestamp'        // "Take @00:01:23"
  | 'custom'           // User-defined pattern

export interface TakeLabelingConfig {
  /** Label format for detected takes */
  format: TakeLabelFormat
  /** Custom format pattern (when format is 'custom') - supports {n}, {t}, {d} placeholders */
  customPattern: string
  /** Prefix for take labels */
  prefix: string
  /** Add marker at take start in timeline */
  addTimelineMarkers: boolean
  /** Marker color for takes (hex) */
  markerColor: string
}

// ============================================================================
// Operations Toggle
// ============================================================================

export interface OperationsConfig {
  /** Remove detected silences */
  removeSilences: boolean
  /** Split clips at take boundaries */
  splitAtTakes: boolean
  /** Add markers without cutting */
  addMarkersOnly: boolean
  /** Auto-ripple delete removed sections */
  autoRippleDelete: boolean
  /** Create subclips for each take */
  createSubclips: boolean
  /** Group related takes in project panel */
  groupTakesInBin: boolean
}

// ============================================================================
// Preview & Safety
// ============================================================================

export interface PreviewConfig {
  /** Show preview before applying cuts */
  showPreview: boolean
  /** Highlight sections to be removed */
  highlightRemovals: boolean
  /** Play audio preview of cut points */
  audioPreview: boolean
  /** Preview duration around each cut (seconds) */
  previewPadding: number
}

// ============================================================================
// Main Configuration Interface
// ============================================================================

export interface AutoCuttingConfig {
  /** Audio source settings */
  audioSource: AudioSourceConfig
  /** Silence detection settings */
  silence: SilenceConfig
  /** Natural pause preservation */
  naturalPauses: NaturalPauseConfig
  /** Take detection settings */
  takeDetection: TakeDetectionConfig
  /** Take labeling format */
  takeLabeling: TakeLabelingConfig
  /** Which operations to perform */
  operations: OperationsConfig
  /** Preview settings */
  preview: PreviewConfig
}

// ============================================================================
// Defaults
// ============================================================================

export const DEFAULT_AUDIO_SOURCE_CONFIG: AudioSourceConfig = {
  type: 'original',
  fallbackToOriginal: true,
}

export const DEFAULT_SILENCE_CONFIG: SilenceConfig = {
  enabled: true,
  minDuration: 0.5,
  maxDuration: 10,
  cutPosition: 'middle',
  thresholdDb: -40,
}

export const DEFAULT_NATURAL_PAUSE_CONFIG: NaturalPauseConfig = {
  enabled: true,
  minPreserveDuration: 0.15,
  maxPreserveDuration: 0.4,
  preserveSentenceBoundaries: true,
  preserveSpeakerTurns: true,
}

export const DEFAULT_TAKE_DETECTION_CONFIG: TakeDetectionConfig = {
  enabled: false,
  sensitivity: 'medium',
  minGapBetweenTakes: 2.0,
  useTranscriptionSimilarity: true,
  similarityThreshold: 0.7,
  autoSelectBest: false,
}

export const DEFAULT_TAKE_LABELING_CONFIG: TakeLabelingConfig = {
  format: 'numeric',
  customPattern: 'Take {n}',
  prefix: '',
  addTimelineMarkers: true,
  markerColor: '#FF9500',
}

export const DEFAULT_OPERATIONS_CONFIG: OperationsConfig = {
  removeSilences: true,
  splitAtTakes: false,
  addMarkersOnly: false,
  autoRippleDelete: false,
  createSubclips: false,
  groupTakesInBin: false,
}

export const DEFAULT_PREVIEW_CONFIG: PreviewConfig = {
  showPreview: true,
  highlightRemovals: true,
  audioPreview: false,
  previewPadding: 0.5,
}

export const DEFAULT_AUTO_CUTTING_CONFIG: AutoCuttingConfig = {
  audioSource: DEFAULT_AUDIO_SOURCE_CONFIG,
  silence: DEFAULT_SILENCE_CONFIG,
  naturalPauses: DEFAULT_NATURAL_PAUSE_CONFIG,
  takeDetection: DEFAULT_TAKE_DETECTION_CONFIG,
  takeLabeling: DEFAULT_TAKE_LABELING_CONFIG,
  operations: DEFAULT_OPERATIONS_CONFIG,
  preview: DEFAULT_PREVIEW_CONFIG,
}

// ============================================================================
// Presets
// ============================================================================

export type AutoCuttingPreset = 'podcast' | 'interview' | 'scripted' | 'vlog' | 'custom'

export const AUTO_CUTTING_PRESETS: Record<AutoCuttingPreset, Partial<AutoCuttingConfig>> = {
  /** Podcast: Preserve natural conversation flow, minimal cutting */
  podcast: {
    silence: {
      ...DEFAULT_SILENCE_CONFIG,
      minDuration: 1.5,
      maxDuration: 15,
    },
    naturalPauses: {
      ...DEFAULT_NATURAL_PAUSE_CONFIG,
      preserveSpeakerTurns: true,
      maxPreserveDuration: 0.6,
    },
    takeDetection: {
      ...DEFAULT_TAKE_DETECTION_CONFIG,
      enabled: false,
    },
  },

  /** Interview: Preserve speaker transitions, detect takes for B-roll */
  interview: {
    silence: {
      ...DEFAULT_SILENCE_CONFIG,
      minDuration: 1.0,
      maxDuration: 10,
    },
    naturalPauses: {
      ...DEFAULT_NATURAL_PAUSE_CONFIG,
      preserveSpeakerTurns: true,
    },
    takeDetection: {
      ...DEFAULT_TAKE_DETECTION_CONFIG,
      enabled: true,
      sensitivity: 'low',
    },
  },

  /** Scripted: Aggressive silence removal, take detection enabled */
  scripted: {
    audioSource: {
      type: 'isolated-vocals',
      fallbackToOriginal: true,
    },
    silence: {
      ...DEFAULT_SILENCE_CONFIG,
      minDuration: 0.3,
      maxDuration: 5,
    },
    naturalPauses: {
      ...DEFAULT_NATURAL_PAUSE_CONFIG,
      enabled: false,
    },
    takeDetection: {
      ...DEFAULT_TAKE_DETECTION_CONFIG,
      enabled: true,
      sensitivity: 'high',
      autoSelectBest: true,
    },
    operations: {
      ...DEFAULT_OPERATIONS_CONFIG,
      splitAtTakes: true,
      createSubclips: true,
    },
  },

  /** Vlog: Balanced settings for solo content */
  vlog: {
    silence: {
      ...DEFAULT_SILENCE_CONFIG,
      minDuration: 0.4,
      maxDuration: 8,
    },
    naturalPauses: {
      ...DEFAULT_NATURAL_PAUSE_CONFIG,
      preserveSentenceBoundaries: true,
      preserveSpeakerTurns: false,
    },
    takeDetection: {
      ...DEFAULT_TAKE_DETECTION_CONFIG,
      enabled: true,
      sensitivity: 'medium',
    },
  },

  /** Custom: User-defined settings */
  custom: {},
}

// ============================================================================
// Take Group Types (LLM Output)
// ============================================================================

/** Individual take within a take group */
export interface Take {
  /** Take number within the group (1-based) */
  takeNumber: number
  /** Start time in seconds */
  startTime: number
  /** End time in seconds */
  endTime: number
  /** Transcribed text for this take */
  text: string
  /** Confidence score from transcription (0-1) */
  confidence?: number
  /** Clip ID if associated with a timeline clip */
  clipId?: string
}

/** Group of similar statements (takes) detected by LLM */
export interface TakeGroup {
  /** Unique identifier for this group */
  id: string
  /** Short label for the group (e.g., "Hey Guys Welcome") */
  label: string
  /** Individual takes in this group */
  takes: Take[]
  /** Premiere Pro label color index (0-15) */
  colorIndex: number
}

/** Result from LLM take detection analysis */
export interface TakeDetectionResult {
  /** All detected take groups */
  groups: TakeGroup[]
  /** Total number of takes across all groups */
  totalTakes: number
  /** Segments that don't belong to any take group (unique content) */
  uniqueSegments: {
    startTime: number
    endTime: number
    text: string
  }[]
  /** Processing metadata */
  metadata: {
    /** LLM model used for detection */
    model: string
    /** Processing time in milliseconds */
    processingTimeMs: number
    /** Number of transcription segments analyzed */
    segmentsAnalyzed: number
  }
}

// ============================================================================
// Premiere Pro Label Colors
// ============================================================================

/** Premiere Pro label color indices (0-15) */
export const PREMIERE_LABEL_COLORS = {
  VIOLET: 0,
  IRIS: 1,
  CARIBBEAN: 2,
  LAVENDER: 3,
  CERULEAN: 4,
  FOREST: 5,
  ROSE: 6,
  MANGO: 7,
  PURPLE: 8,
  BLUE: 9,
  TEAL: 10,
  MAGENTA: 11,
  TAN: 12,
  GREEN: 13,
  BROWN: 14,
  YELLOW: 15,
} as const

export type PremiereLabelColor = typeof PREMIERE_LABEL_COLORS[keyof typeof PREMIERE_LABEL_COLORS]

/** Color mapping based on number of takes */
export const TAKE_COUNT_COLORS: Record<number, PremiereLabelColor> = {
  1: PREMIERE_LABEL_COLORS.GREEN,    // Single take (good)
  2: PREMIERE_LABEL_COLORS.YELLOW,   // Minor retry
  3: PREMIERE_LABEL_COLORS.MANGO,    // Multiple attempts
  4: PREMIERE_LABEL_COLORS.MAGENTA,  // Many retakes (4+)
}

/** Get color index for a take group based on take count */
export function getTakeGroupColorIndex(takeCount: number): PremiereLabelColor {
  if (takeCount <= 0) return PREMIERE_LABEL_COLORS.GREEN
  if (takeCount >= 4) return TAKE_COUNT_COLORS[4]
  return TAKE_COUNT_COLORS[takeCount] ?? PREMIERE_LABEL_COLORS.GREEN
}

// ============================================================================
// Utility Types
// ============================================================================

/** Partial config for merging with defaults */
export type PartialAutoCuttingConfig = {
  [K in keyof AutoCuttingConfig]?: Partial<AutoCuttingConfig[K]>
}

/** Create config by merging partial with defaults */
export function createAutoCuttingConfig(
  partial: PartialAutoCuttingConfig = {}
): AutoCuttingConfig {
  return {
    audioSource: { ...DEFAULT_AUDIO_SOURCE_CONFIG, ...partial.audioSource },
    silence: { ...DEFAULT_SILENCE_CONFIG, ...partial.silence },
    naturalPauses: { ...DEFAULT_NATURAL_PAUSE_CONFIG, ...partial.naturalPauses },
    takeDetection: { ...DEFAULT_TAKE_DETECTION_CONFIG, ...partial.takeDetection },
    takeLabeling: { ...DEFAULT_TAKE_LABELING_CONFIG, ...partial.takeLabeling },
    operations: { ...DEFAULT_OPERATIONS_CONFIG, ...partial.operations },
    preview: { ...DEFAULT_PREVIEW_CONFIG, ...partial.preview },
  }
}

/** Apply preset and optionally override with custom settings */
export function createConfigFromPreset(
  preset: AutoCuttingPreset,
  overrides: PartialAutoCuttingConfig = {}
): AutoCuttingConfig {
  const presetConfig = AUTO_CUTTING_PRESETS[preset]
  return createAutoCuttingConfig({
    ...presetConfig,
    ...overrides,
  })
}
