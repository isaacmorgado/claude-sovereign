import { Router } from 'express'
import * as audioController from '../controllers/audio-controller.js'
import { authenticate } from '../middleware/auth.js'
import { checkUsageLimit } from '../middleware/usage-limit.js'
import { audioSubmitRateLimiter } from '../middleware/rate-limit.js'

const router = Router()

// All audio routes require authentication
router.use(authenticate)

// Pre-flight check if user can submit a job
router.get('/check', audioController.canSubmit)

// Get presigned URL for file upload
router.post('/presigned-url', audioController.getPresignedUrl)

// List user's jobs
router.get('/jobs', audioController.listJobs)

// Get specific job status
router.get('/jobs/:jobId', audioController.getJob)

// Submit transcription job (requires usage limit check + rate limiting)
router.post(
  '/transcribe',
  audioSubmitRateLimiter,
  checkUsageLimit,
  audioController.submitTranscription
)

// Submit vocal isolation job (requires usage limit check + rate limiting)
router.post(
  '/isolate-vocals',
  audioSubmitRateLimiter,
  checkUsageLimit,
  audioController.submitVocalIsolation
)

// Detect takes from transcription segments (no usage limit - processes transcript data)
router.post('/detect-takes', audioController.detectTakes)

export default router
