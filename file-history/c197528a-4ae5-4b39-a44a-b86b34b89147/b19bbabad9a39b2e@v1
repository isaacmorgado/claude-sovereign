# SPLICE Phase 3: Unified Transcription Optimization

## Process
Implement → E2E Test → Find Bugs → Fix → Retest → Pass → Next Feature

---

## Feature 3.1: Unified Transcription Function

**Files:**
- `splice-backend/services/transcription.js`

**Problem:** Two separate Whisper calls (`transcribeAudio` + `transcribeWithWords`) double-bill users. Cost: $0.72/hr instead of $0.36/hr.

**Implementation:**
1. Create `transcribeFull(wavPath)` using `timestamp_granularities: ['word', 'segment']`
2. Returns `{ text, segments, words, duration, language }`
3. Single cache key per file
4. Update `transcribeAudio()` to call `transcribeFull()` and extract segments
5. Update `transcribeWithWords()` to call `transcribeFull()` and extract words
6. Both share the same cached result

**E2E Test:**
- Call `/analyze` then `/profanity` on same file
- Verify only ONE Whisper API call (check server logs for "Starting Whisper")
- Verify both endpoints return correct data
- Verify cache hit on second call
- Test `/stutters`, `/fillers`, `/repetitions` use cache

---

## Feature 3.2: Verify All Consumers

**Files:**
- `splice-backend/server.js` (endpoints at lines ~384, 431, 654, 778, 853, 991)

**Verification:**
- `/analyze` → takes with timestamps work
- `/silences` → segment gaps detected
- `/profanity` → word timestamps correct
- `/stutters` → word detection works
- `/fillers` → filler words detected
- `/repetitions` → phrase matching works

**E2E Test:**
```bash
node tests/transcription-e2e.test.js
node tests/phase5-e2e.test.js
```

---

## Feature 3.3: Update Tier Hours for 75%+ Margins

**Files:**
- `CLAUDE.md` - Update pricing table
- `splice-backend/services/usageTracking.js` - If tier limits are enforced here

**New Tiers (single Whisper call @ $0.36/hr):**
| Tier | Price | Hours | Margin |
|------|-------|-------|--------|
| Starter | $19 | 12 hrs | 77.3% |
| Pro | $49 | 30 hrs | 78.0% |
| Team | $149 | 100 hrs | 75.8% |

---

## Final E2E Test

After all features, verify:
1. **Single API Call:** Multiple endpoints on same file = 1 Whisper call
2. **Take Detection:** Valid segment timestamps
3. **Word Features:** All word-level endpoints work
4. **Cache Efficiency:** Log shows cache hits
5. **No Regressions:** All existing tests pass

```bash
node tests/transcription-e2e.test.js
node tests/phase5-e2e.test.js
node tests/phase1-concurrency.test.js
```

---

## Update Documentation

After tests pass, update `CLAUDE.md`:
- Transcription architecture (unified cache)
- New tier hours (12/30/100)
- Margin calculations

---

## Prompt
```
Continue SPLICE Phase 3: Unified Transcription.

Implement transcribeFull() in splice-backend/services/transcription.js that:
- Calls Whisper once with timestamp_granularities: ['word', 'segment']
- Returns { text, segments, words, duration }
- Caches result under wavPath
- transcribeAudio() and transcribeWithWords() both use this cache

After: E2E test, fix bugs, retest, update CLAUDE.md with new tier hours (12/30/100).
```
