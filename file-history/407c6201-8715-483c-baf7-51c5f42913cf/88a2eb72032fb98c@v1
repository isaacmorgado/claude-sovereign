import React from "react"
import { useExtensionState } from "../../context/ExtensionStateContext"
import { vscode } from "../../utils/vscode"

/**
 * WorkspaceSelector component for multi-workspace support.
 * Displays a dropdown when multiple workspaces are available,
 * allowing users to switch the focused workspace.
 */
export const WorkspaceSelector: React.FC = () => {
	const { workspaceSwitcherState } = useExtensionState()

	// Don't render if no workspace state or only one workspace
	if (!workspaceSwitcherState || workspaceSwitcherState.availableWorkspaces.length <= 1) {
		return null
	}

	const { availableWorkspaces, focusedWorkspaceIndex } = workspaceSwitcherState
	const focusedWorkspace = availableWorkspaces[focusedWorkspaceIndex]

	const handleWorkspaceChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
		const selectedPath = e.target.value
		vscode.postMessage({
			type: "switchWorkspace",
			text: selectedPath,
		})
	}

	return (
		<div className="workspace-selector" style={{ padding: "4px 8px", borderBottom: "1px solid var(--vscode-panel-border)" }}>
			<div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
				<span style={{ fontSize: "11px", color: "var(--vscode-descriptionForeground)" }}>
					Workspace:
				</span>
				<select
					value={focusedWorkspace?.path || ""}
					onChange={handleWorkspaceChange}
					style={{
						flex: 1,
						background: "var(--vscode-dropdown-background)",
						color: "var(--vscode-dropdown-foreground)",
						border: "1px solid var(--vscode-dropdown-border)",
						borderRadius: "2px",
						padding: "2px 4px",
						fontSize: "12px",
						cursor: "pointer",
					}}
				>
					{availableWorkspaces.map((ws: any) => (
						<option key={ws.path} value={ws.path}>
							{ws.name}
							{ws.isActive && ws.currentTaskId ? " (active)" : ""}
							{ws.taskCount > 0 ? ` [${ws.taskCount}]` : ""}
						</option>
					))}
				</select>
			</div>
		</div>
	)
}

/**
 * Compact workspace indicator for the header area.
 * Shows current workspace and task count badge.
 */
export const WorkspaceIndicator: React.FC = () => {
	const { workspaceSwitcherState } = useExtensionState()

	// Don't render if no workspace state or only one workspace
	if (!workspaceSwitcherState || workspaceSwitcherState.availableWorkspaces.length <= 1) {
		return null
	}

	const { availableWorkspaces, focusedWorkspaceIndex } = workspaceSwitcherState
	const focusedWorkspace = availableWorkspaces[focusedWorkspaceIndex]
	const totalTasks = availableWorkspaces.reduce((sum, ws) => sum + ws.taskCount, 0)

	if (!focusedWorkspace) {
		return null
	}

	return (
		<div
			className="workspace-indicator"
			style={{
				display: "flex",
				alignItems: "center",
				gap: "4px",
				padding: "2px 6px",
				background: "var(--vscode-badge-background)",
				color: "var(--vscode-badge-foreground)",
				borderRadius: "10px",
				fontSize: "10px",
			}}
			title={`Workspace: ${focusedWorkspace.name}\nPath: ${focusedWorkspace.path}`}
		>
			<span>{focusedWorkspace.name}</span>
			{totalTasks > 0 && (
				<span
					style={{
						background: "var(--vscode-notificationCenterHeader-background)",
						padding: "0 4px",
						borderRadius: "8px",
						fontSize: "9px",
					}}
				>
					{totalTasks}
				</span>
			)}
		</div>
	)
}

export default WorkspaceSelector
