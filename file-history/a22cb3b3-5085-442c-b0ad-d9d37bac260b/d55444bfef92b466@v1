"""
PSL (Pretty Scale Level) Service

Calculates PSL scores based on face, height, and body composition.
Formula: PSL = (Face × 0.75) + (Height × 0.20) + (Body × 0.05) + Bonuses
"""

from typing import Optional, Dict, Any, Tuple, List

# PSL Weights
FACE_WEIGHT = 0.75
HEIGHT_WEIGHT = 0.20
BODY_WEIGHT = 0.05

# Threshold bonuses (apply when component >= 8.5)
THRESHOLD_BONUSES = {
    'face': 0.30,
    'height': 0.20,
    'body': 0.10,
}

# Synergy bonuses (multiple components >= 8.5)
SYNERGY_BONUSES = {
    'face_height': 0.15,
    'face_body': 0.10,
    'height_body': 0.05,
    'triple': 0.35,  # All three >= 8.5 (replaces pair bonuses)
}

# Tier definitions
TIER_DEFINITIONS = [
    {'name': 'Deformity', 'min': 0.0, 'max': 1.0, 'percentile': 0.01},
    {'name': 'Subhuman', 'min': 1.25, 'max': 1.75, 'percentile': 0.1},
    {'name': 'Incel', 'min': 2.0, 'max': 3.0, 'percentile': 2.5},
    {'name': 'LTN', 'min': 3.5, 'max': 4.5, 'percentile': 13.59},
    {'name': 'MTN', 'min': 4.75, 'max': 5.25, 'percentile': 50.0},
    {'name': 'HTN', 'min': 5.5, 'max': 6.5, 'percentile': 86.41},
    {'name': 'Chadlite', 'min': 7.0, 'max': 8.0, 'percentile': 97.5},
    {'name': 'Chad', 'min': 8.25, 'max': 8.75, 'percentile': 99.9},
    {'name': 'Gigachad', 'min': 9.0, 'max': 9.5, 'percentile': 99.99},
    {'name': 'True Mogger', 'min': 9.5, 'max': 10.0, 'percentile': 99.999},
]

# Male height rating table (cm -> rating 0-10)
MALE_HEIGHT_RATINGS = [
    (157, 1.0),
    (160, 2.0),
    (165, 3.0),
    (170, 4.0),
    (175, 5.0),
    (178, 5.5),
    (180, 6.0),
    (183, 7.0),
    (185, 7.5),
    (188, 8.0),
    (190, 8.5),
    (193, 9.0),
    (196, 9.5),
]

# Female height rating table
FEMALE_HEIGHT_RATINGS = [
    (147, 1.0),
    (150, 2.0),
    (155, 3.5),
    (160, 5.0),
    (165, 6.0),
    (168, 6.5),
    (170, 7.0),
    (173, 7.5),
    (175, 8.0),
    (178, 8.5),
    (180, 9.0),
    (183, 9.0),  # Cap at 9.0 for females
]


class PSLService:
    """Service for calculating PSL scores"""

    @staticmethod
    def get_height_rating(height_cm: int, gender: str) -> float:
        """
        Get height rating (0-10) based on height in cm and gender.
        Uses linear interpolation between defined points.
        """
        table = MALE_HEIGHT_RATINGS if gender == 'male' else FEMALE_HEIGHT_RATINGS

        # Below minimum
        if height_cm <= table[0][0]:
            return table[0][1]

        # Above maximum
        if height_cm >= table[-1][0]:
            return table[-1][1]

        # Find interpolation points
        for i in range(len(table) - 1):
            lower_cm, lower_rating = table[i]
            upper_cm, upper_rating = table[i + 1]

            if lower_cm <= height_cm < upper_cm:
                ratio = (height_cm - lower_cm) / (upper_cm - lower_cm)
                return lower_rating + ratio * (upper_rating - lower_rating)

        return 5.0  # Default fallback

    @staticmethod
    def get_body_rating(body_fat_percent: Optional[float] = None, muscle_level: Optional[str] = None) -> float:
        """
        Get body rating (0-10) based on body composition.
        Returns 5.0 (average) if no body analysis available.
        """
        if body_fat_percent is None or muscle_level is None:
            return 5.0

        # Simplified body rating based on body fat
        if body_fat_percent >= 25:
            return 2.5
        elif body_fat_percent >= 20:
            return 4.0
        elif body_fat_percent >= 18:
            return 5.25
        elif body_fat_percent >= 15:
            return 6.25
        elif body_fat_percent >= 12:
            return 7.25
        elif body_fat_percent >= 10:
            return 8.25
        elif body_fat_percent >= 8:
            return 9.25
        else:
            return 9.75

    @staticmethod
    def calculate_threshold_bonuses(face_score: float, height_rating: float, body_rating: float) -> float:
        """Calculate threshold bonuses for scores >= 8.5"""
        bonus = 0.0
        if face_score >= 8.5:
            bonus += THRESHOLD_BONUSES['face']
        if height_rating >= 8.5:
            bonus += THRESHOLD_BONUSES['height']
        if body_rating >= 8.5:
            bonus += THRESHOLD_BONUSES['body']
        return bonus

    @staticmethod
    def calculate_synergy_bonuses(face_score: float, height_rating: float, body_rating: float) -> float:
        """Calculate synergy bonuses for multiple high scores"""
        high_scores = [face_score >= 8.5, height_rating >= 8.5, body_rating >= 8.5]
        high_count = sum(high_scores)

        if high_count == 3:
            return SYNERGY_BONUSES['triple']

        bonus = 0.0
        if high_count >= 2:
            if face_score >= 8.5 and height_rating >= 8.5:
                bonus += SYNERGY_BONUSES['face_height']
            if face_score >= 8.5 and body_rating >= 8.5:
                bonus += SYNERGY_BONUSES['face_body']
            if height_rating >= 8.5 and body_rating >= 8.5:
                bonus += SYNERGY_BONUSES['height_body']

        return bonus

    @staticmethod
    def classify_tier(score: float, height_rating: float, failos: Optional[List[str]] = None) -> Dict[str, Any]:
        """Classify score into PSL tier"""
        effective_score = score

        # Height constraint: Cannot reach Gigachad without height >= 8.0
        if height_rating < 8.0 and score >= 9.0:
            effective_score = min(effective_score, 8.75)

        # Major failo constraint
        major_failos = ['severe_asymmetry', 'deformed', 'major_recession']
        if failos and any(f in major_failos for f in failos):
            if effective_score >= 7.0:
                effective_score = min(effective_score, 6.5)

        # Find matching tier
        for tier in reversed(TIER_DEFINITIONS):
            if effective_score >= tier['min']:
                return tier

        return TIER_DEFINITIONS[0]

    @classmethod
    def calculate_psl(
        cls,
        face_score: float,
        height_cm: int,
        gender: str,
        body_fat_percent: Optional[float] = None,
        muscle_level: Optional[str] = None,
        failos: Optional[List[str]] = None
    ) -> Dict[str, Any]:
        """
        Calculate full PSL score with breakdown.

        Args:
            face_score: Face harmony score (0-10)
            height_cm: Height in centimeters
            gender: 'male' or 'female'
            body_fat_percent: Optional body fat percentage
            muscle_level: Optional muscle level
            failos: Optional list of facial failos

        Returns:
            Dict with score, tier, percentile, and breakdown
        """
        # Get component ratings
        height_rating = cls.get_height_rating(height_cm, gender)
        body_rating = cls.get_body_rating(body_fat_percent, muscle_level)

        # Calculate weighted scores
        face_weighted = face_score * FACE_WEIGHT
        height_weighted = height_rating * HEIGHT_WEIGHT
        body_weighted = body_rating * BODY_WEIGHT
        base_score = face_weighted + height_weighted + body_weighted

        # Calculate bonuses
        threshold_bonus = cls.calculate_threshold_bonuses(face_score, height_rating, body_rating)
        synergy_bonus = cls.calculate_synergy_bonuses(face_score, height_rating, body_rating)
        total_bonus = threshold_bonus + synergy_bonus

        # Calculate penalties
        penalties = 0.0
        if body_rating < 5.0:
            penalties += 0.3
        if failos:
            if 'severe_asymmetry' in failos:
                penalties += 0.5
            if 'negative_canthal_tilt' in failos:
                penalties += 0.3
            if 'receding_chin' in failos:
                penalties += 0.4

        # Final score
        final_score = max(0, min(10, base_score + total_bonus - penalties))

        # Classify tier
        tier_info = cls.classify_tier(final_score, height_rating, failos)

        # Estimate potential
        face_potential = min(10, face_score + 0.4)
        body_potential = max(body_rating, 7.5)
        potential_base = (
            face_potential * FACE_WEIGHT +
            height_rating * HEIGHT_WEIGHT +
            body_potential * BODY_WEIGHT
        )
        potential_bonuses = cls.calculate_threshold_bonuses(face_potential, height_rating, body_potential)
        potential_synergy = cls.calculate_synergy_bonuses(face_potential, height_rating, body_potential)
        potential_score = min(10, potential_base + potential_bonuses + potential_synergy)

        return {
            'score': round(final_score, 2),
            'tier': tier_info['name'],
            'percentile': tier_info['percentile'],
            'breakdown': {
                'face': {'raw': round(face_score, 2), 'weighted': round(face_weighted, 2)},
                'height': {'raw': round(height_rating, 2), 'weighted': round(height_weighted, 2)},
                'body': {'raw': round(body_rating, 2), 'weighted': round(body_weighted, 2)},
                'bonuses': {
                    'threshold': round(threshold_bonus, 2),
                    'synergy': round(synergy_bonus, 2),
                    'total': round(total_bonus, 2),
                },
                'penalties': round(penalties, 2),
            },
            'potential': round(potential_score, 2),
        }


# Singleton instance
psl_service = PSLService()
