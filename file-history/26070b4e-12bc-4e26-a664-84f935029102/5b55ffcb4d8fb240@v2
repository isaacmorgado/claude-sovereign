#!/bin/bash
#
# RunPod + Roo Code + Abliterated Models Setup Script
# ====================================================
# Sets up:
#   - RunPod API configuration
#   - VS Code extension for GPU monitoring
#   - MCP servers (RunPod + Ghidra)
#   - Cost tracking
#   - RE toolkit
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo "========================================"
echo "  RunPod + Roo Code System Setup"
echo "========================================"
echo ""

# Check for required tools
check_dependencies() {
    echo -e "${YELLOW}Checking dependencies...${NC}"

    local missing=()

    command -v python3 >/dev/null 2>&1 || missing+=("python3")
    command -v node >/dev/null 2>&1 || missing+=("node")
    command -v npm >/dev/null 2>&1 || missing+=("npm")
    command -v code >/dev/null 2>&1 || missing+=("code (VS Code)")

    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${RED}Missing dependencies: ${missing[*]}${NC}"
        echo "Please install them first:"
        echo "  brew install python node"
        exit 1
    fi

    echo -e "${GREEN}All core dependencies found${NC}"
}

# Setup RunPod API key
setup_api_key() {
    echo ""
    echo -e "${YELLOW}Step 1: RunPod API Key${NC}"

    if [ -n "$RUNPOD_API_KEY" ]; then
        echo -e "${GREEN}RUNPOD_API_KEY already set${NC}"
        return
    fi

    echo "Get your API key from: https://www.runpod.io/console/user/settings"
    read -p "Enter your RunPod API key (or press Enter to skip): " api_key

    if [ -n "$api_key" ]; then
        # Add to shell config
        SHELL_CONFIG="$HOME/.zshrc"
        [ -f "$HOME/.bashrc" ] && SHELL_CONFIG="$HOME/.bashrc"

        echo "" >> "$SHELL_CONFIG"
        echo "# RunPod API Key" >> "$SHELL_CONFIG"
        echo "export RUNPOD_API_KEY='$api_key'" >> "$SHELL_CONFIG"

        export RUNPOD_API_KEY="$api_key"

        echo -e "${GREEN}API key saved to $SHELL_CONFIG${NC}"
        echo "Run 'source $SHELL_CONFIG' or restart terminal"
    else
        echo -e "${YELLOW}Skipping API key setup${NC}"
    fi
}

# Install Python dependencies
install_python_deps() {
    echo ""
    echo -e "${YELLOW}Step 2: Python Dependencies${NC}"

    pip3 install --quiet runpod requests python-dotenv 2>/dev/null || {
        pip3 install runpod requests python-dotenv
    }

    echo -e "${GREEN}Python packages installed${NC}"
}

# Install RE tools
install_re_tools() {
    echo ""
    echo -e "${YELLOW}Step 3: Reverse Engineering Tools${NC}"

    if command -v brew >/dev/null 2>&1; then
        echo "Installing via Homebrew..."

        # Install if not present
        command -v r2 >/dev/null 2>&1 || brew install radare2
        command -v binwalk >/dev/null 2>&1 || brew install binwalk
        command -v strings >/dev/null 2>&1 || true  # Usually pre-installed

        echo -e "${GREEN}RE tools installed${NC}"
    else
        echo -e "${YELLOW}Homebrew not found, skipping RE tools${NC}"
        echo "To install manually: brew install radare2 binwalk"
    fi

    # Check for Ghidra
    if [ -d "/Applications/ghidra" ] || command -v analyzeHeadless >/dev/null 2>&1; then
        echo -e "${GREEN}Ghidra detected${NC}"
    else
        echo -e "${YELLOW}Ghidra not found${NC}"
        echo "Download from: https://ghidra-sre.org/"
    fi
}

# Build VS Code extension
build_vscode_extension() {
    echo ""
    echo -e "${YELLOW}Step 4: VS Code Extension${NC}"

    cd "$SCRIPT_DIR/vscode-runpod-gpu"

    if [ ! -d "node_modules" ]; then
        echo "Installing npm dependencies..."
        npm install
    fi

    echo "Compiling TypeScript..."
    npm run compile 2>/dev/null || npx tsc -p ./

    echo "Packaging extension..."
    npx @vscode/vsce package --allow-missing-repository 2>/dev/null || {
        echo -e "${YELLOW}VSCE packaging failed, installing manually...${NC}"
    }

    # Install the extension
    if ls *.vsix 1>/dev/null 2>&1; then
        code --install-extension *.vsix --force
        echo -e "${GREEN}VS Code extension installed${NC}"
    else
        echo -e "${YELLOW}Manual installation required${NC}"
        echo "Open VS Code and run 'Developer: Install Extension from Location'"
    fi

    cd "$SCRIPT_DIR"
}

# Setup MCP servers
setup_mcp_servers() {
    echo ""
    echo -e "${YELLOW}Step 5: MCP Servers${NC}"

    # RunPod MCP
    echo "Installing RunPod MCP..."
    npm install -g @runpod/mcp 2>/dev/null || npm install -g @runpod/mcp

    # Ghidra MCP
    echo "Installing Ghidra MCP..."
    pip3 install ghidra-mcp 2>/dev/null || pip3 install ghidra-mcp

    # Claude Code MCP config
    CLAUDE_MCP_DIR="$HOME/.claude"
    mkdir -p "$CLAUDE_MCP_DIR"

    if [ ! -f "$CLAUDE_MCP_DIR/mcp_servers.json" ]; then
        cp "$SCRIPT_DIR/mcp-servers-config.json" "$CLAUDE_MCP_DIR/mcp_servers.json"
        echo -e "${GREEN}Claude Code MCP config created${NC}"
    else
        echo -e "${YELLOW}Claude Code MCP config exists, not overwriting${NC}"
        echo "Merge manually from: $SCRIPT_DIR/mcp-servers-config.json"
    fi

    # Roo Code settings info
    echo ""
    echo "For Roo Code, add MCP servers in VS Code settings:"
    echo "  Settings > Extensions > Roo Code > MCP Servers"
    echo "  Or copy from: $SCRIPT_DIR/roo-code-mcp-settings.json"
}

# Initialize cost tracking database
setup_cost_tracking() {
    echo ""
    echo -e "${YELLOW}Step 6: Cost Tracking${NC}"

    python3 "$SCRIPT_DIR/cost_tracker.py" status 2>/dev/null || {
        echo "Initializing cost tracker..."
        mkdir -p "$HOME/.runpod_automation"
    }

    echo -e "${GREEN}Cost tracking ready${NC}"
}

# Update endpoint IDs
configure_endpoints() {
    echo ""
    echo -e "${YELLOW}Step 7: Endpoint Configuration${NC}"

    if grep -q "YOUR_ENDPOINT_ID" "$SCRIPT_DIR/runpod_api.py" 2>/dev/null; then
        echo -e "${YELLOW}Endpoint IDs not configured in runpod_api.py${NC}"
        echo ""
        echo "To get your endpoint IDs:"
        echo "  1. Go to https://www.runpod.io/console/serverless"
        echo "  2. Copy each endpoint ID"
        echo "  3. Edit $SCRIPT_DIR/runpod_api.py"
        echo ""
        read -p "Enter architect endpoint ID (or skip): " arch_id

        if [ -n "$arch_id" ]; then
            sed -i '' "s/YOUR_ENDPOINT_ID_1/$arch_id/" "$SCRIPT_DIR/runpod_api.py" 2>/dev/null || true
        fi
    else
        echo -e "${GREEN}Endpoints already configured${NC}"
    fi
}

# Print summary
print_summary() {
    echo ""
    echo "========================================"
    echo -e "${GREEN}  Setup Complete!${NC}"
    echo "========================================"
    echo ""
    echo "What's installed:"
    echo "  [x] Cost Tracker: python3 ~/cost_tracker.py status"
    echo "  [x] RE Toolkit:   python3 ~/re_toolkit.py tools"
    echo "  [x] RunPod API:   python3 ~/runpod_api.py"
    echo "  [x] VS Code Extension: RunPod GPU Monitor"
    echo "  [x] MCP Servers: RunPod + Ghidra"
    echo ""
    echo "Quick commands:"
    echo "  cost_tracker.py status     - View current costs"
    echo "  cost_tracker.py daily      - Daily cost breakdown"
    echo "  re_toolkit.py tools        - Check RE tools"
    echo "  re_toolkit.py ai <binary>  - AI-powered binary analysis"
    echo ""
    echo "VS Code commands (Cmd+Shift+P):"
    echo "  RunPod: Show GPU Status"
    echo "  RunPod: Pause All Endpoints"
    echo "  RunPod: Resume All Endpoints"
    echo "  RunPod: Show Cost Report"
    echo ""
    echo "Next steps:"
    echo "  1. Restart VS Code"
    echo "  2. Configure endpoint IDs if needed"
    echo "  3. Set budgets: python3 ~/cost_tracker.py set-budget daily 5.00"
    echo ""
}

# Main
main() {
    check_dependencies
    setup_api_key
    install_python_deps
    install_re_tools
    build_vscode_extension
    setup_mcp_servers
    setup_cost_tracking
    configure_endpoints
    print_summary
}

# Run with options
case "${1:-}" in
    --help|-h)
        echo "Usage: $0 [option]"
        echo ""
        echo "Options:"
        echo "  --help     Show this help"
        echo "  --vscode   Only build VS Code extension"
        echo "  --mcp      Only setup MCP servers"
        echo "  --re       Only install RE tools"
        echo ""
        ;;
    --vscode)
        build_vscode_extension
        ;;
    --mcp)
        setup_mcp_servers
        ;;
    --re)
        install_re_tools
        ;;
    *)
        main
        ;;
esac
