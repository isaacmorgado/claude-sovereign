/**
 * Insights Engine
 *
 * Processes insight definitions from insights.json and classifies them
 * as strengths or areas of improvement based on user's metric scores.
 *
 * Logic:
 * - For each insight definition, calculate average score of affected metrics
 * - Weakness: if avg score < threshold → classify with severity label
 * - Strength: if avg score > threshold → classify with grade label
 *
 * Severity Labels (Weaknesses):
 *   0-3 = "Severe"
 *   3-5 = "Moderate"
 *   5-7 = "Minor"
 *
 * Grade Labels (Strengths):
 *   8-9   = "Good"
 *   9-9.5 = "Excellent"
 *   9.5-10 = "Ideal"
 */

import { Strength, Flaw } from '@/types/results';
import { FaceIQScoreResult, FACEIQ_METRICS, isValueAcceptable } from '@/lib/faceiq-scoring';

// ============================================
// INSIGHT DEFINITION TYPES
// ============================================

export interface InsightSeverityLogic {
  metrics: string[];  // Display names of metrics (e.g., "Face Width to Height Ratio")
  threshold: number;  // Score threshold for classification
}

export interface WeaknessSeverityLabels {
  minor: string;
  moderate: string;
  severe: string;
}

export interface StrengthGradeLabels {
  good: string;
  excellent: string;
  ideal: string;
}

export interface InsightContent {
  description: string;
  severity_labels?: WeaknessSeverityLabels;  // For weaknesses
  grade_labels?: StrengthGradeLabels;        // For strengths
}

export interface InsightDefinition {
  id: string;
  title: string;
  type: 'weakness' | 'strength';
  severity_logic: InsightSeverityLogic;
  content: InsightContent;
}

// ============================================
// CLASSIFICATION RESULT TYPES
// ============================================

export type WeaknessSeverity = 'severe' | 'moderate' | 'minor';
export type StrengthGrade = 'ideal' | 'excellent' | 'good';

export interface ClassifiedWeakness {
  insightId: string;
  title: string;
  description: string;
  severity: WeaknessSeverity;
  severityLabel: string;  // Custom label from definition (e.g., "Extremely Long")
  avgScore: number;
  matchedMetrics: MatchedMetric[];
}

export interface ClassifiedStrength {
  insightId: string;
  title: string;
  description: string;
  grade: StrengthGrade;
  gradeLabel: string;  // Custom label from definition (e.g., "Ideal")
  avgScore: number;
  matchedMetrics: MatchedMetric[];
}

export interface MatchedMetric {
  metricId: string;
  metricName: string;
  score: number;
  value: number;
  idealMin: number;
  idealMax: number;
  unit: string;
  category: string;
}

export interface InsightClassificationResult {
  strengths: ClassifiedStrength[];
  weaknesses: ClassifiedWeakness[];
}

// ============================================
// INSIGHTS DATABASE
// ============================================

export const INSIGHTS_DEFINITIONS: InsightDefinition[] = [
  {
    id: "long_midface",
    title: "Long Midface",
    type: "weakness",
    severity_logic: {
      metrics: ["Face Width to Height Ratio", "Midface Ratio"],
      threshold: 6.0
    },
    content: {
      description: "The middle of the face is elongated, creating an unbalanced vertical proportion.",
      severity_labels: { minor: "Slightly Long", moderate: "Long", severe: "Extremely Long" }
    }
  },
  {
    id: "short_midface",
    title: "Short Midface",
    type: "strength",
    severity_logic: {
      metrics: ["Face Width to Height Ratio", "Midface Ratio"],
      threshold: 8.0
    },
    content: {
      description: "The midface has ideal vertical proportions, contributing to facial harmony.",
      grade_labels: { good: "Proportionate", excellent: "Well-Balanced", ideal: "Ideal" }
    }
  },
  {
    id: "weak_jaw",
    title: "Weak/Soft Jaw Structure",
    type: "weakness",
    severity_logic: {
      metrics: ["Gonial Angle", "Mandibular Plane Angle", "Chin to Philtrum Ratio"],
      threshold: 5.0
    },
    content: {
      description: "The jaw has a softer, rounder shape, often less angular and robust than the ideal.",
      severity_labels: { minor: "Soft", moderate: "Recessed", severe: "Weak" }
    }
  },
  {
    id: "strong_jaw",
    title: "Strong Jaw Definition",
    type: "strength",
    severity_logic: {
      metrics: ["Gonial Angle", "Mandibular Plane Angle", "Jaw Width Ratio", "Bigonial Width"],
      threshold: 8.0
    },
    content: {
      description: "The jaw displays strong definition with well-defined angles and proportionate width.",
      grade_labels: { good: "Defined", excellent: "Strong", ideal: "Ideal Angular" }
    }
  },
  {
    id: "refined_nasal_tip",
    title: "Refined Nasal Tip",
    type: "strength",
    severity_logic: {
      metrics: ["Nasal Tip Angle", "Nose Tip Position", "Frankfort-tip Angle"],
      threshold: 8.5
    },
    content: {
      description: "This contributes to a harmonious nasal profile due to the nasal tip being well-defined and proportionate.",
      grade_labels: { good: "Good", excellent: "Excellent", ideal: "Ideal" }
    }
  },
  {
    id: "bulbous_nose",
    title: "Bulbous Nasal Tip",
    type: "weakness",
    severity_logic: {
      metrics: ["Nasal Index", "Nose Width", "Nasal Tip Angle"],
      threshold: 5.5
    },
    content: {
      description: "The nasal tip appears rounded and less defined, affecting nasal aesthetics.",
      severity_labels: { minor: "Slightly Rounded", moderate: "Rounded", severe: "Bulbous" }
    }
  },
  {
    id: "ideal_upper_lip",
    title: "Well-Positioned Upper Lip",
    type: "strength",
    severity_logic: {
      metrics: ["Upper Lip E-Line Position", "Upper Lip S-Line Position", "Nasolabial Angle"],
      threshold: 9.0
    },
    content: {
      description: "This contributes to a harmonious mouth region due to the upper lip sitting neither too far forward nor too far back.",
      grade_labels: { good: "Good", excellent: "Excellent", ideal: "Ideal" }
    }
  },
  {
    id: "negative_canthal_tilt",
    title: "Negative Canthal Tilt",
    type: "weakness",
    severity_logic: {
      metrics: ["Lateral Canthal Tilt", "Eye Aspect Ratio"],
      threshold: 5.0
    },
    content: {
      description: "The outer corners of the eyes sit lower than the inner corners, creating a downturned appearance.",
      severity_labels: { minor: "Slight Downturn", moderate: "Noticeable", severe: "Pronounced" }
    }
  },
  {
    id: "positive_canthal_tilt",
    title: "Positive Canthal Tilt",
    type: "strength",
    severity_logic: {
      metrics: ["Lateral Canthal Tilt", "Eye Aspect Ratio"],
      threshold: 8.0
    },
    content: {
      description: "The outer corners of the eyes are elevated, creating an attractive upswept eye shape.",
      grade_labels: { good: "Slight Upturn", excellent: "Well-Tilted", ideal: "Hunter Eyes" }
    }
  },
  {
    id: "balanced_facial_thirds",
    title: "Balanced Facial Thirds",
    type: "strength",
    severity_logic: {
      metrics: ["Upper Third Proportion", "Middle Third Proportion", "Lower Third Proportion"],
      threshold: 8.5
    },
    content: {
      description: "The face displays well-balanced vertical proportions across all three facial thirds.",
      grade_labels: { good: "Balanced", excellent: "Harmonious", ideal: "Perfectly Proportioned" }
    }
  },
  {
    id: "imbalanced_thirds",
    title: "Facial Third Imbalance",
    type: "weakness",
    severity_logic: {
      metrics: ["Upper Third Proportion", "Middle Third Proportion", "Lower Third Proportion"],
      threshold: 5.5
    },
    content: {
      description: "The vertical face proportions show imbalance between the three facial thirds.",
      severity_labels: { minor: "Slight Imbalance", moderate: "Noticeable Disproportion", severe: "Significant Imbalance" }
    }
  },
  {
    id: "high_cheekbones",
    title: "High Cheekbones",
    type: "strength",
    severity_logic: {
      metrics: ["Cheekbone Height", "Cheekbone Width", "Midface Ratio"],
      threshold: 8.5
    },
    content: {
      description: "Well-positioned cheekbones that create attractive facial contours and catch light beautifully.",
      grade_labels: { good: "Visible", excellent: "Prominent", ideal: "Model-Tier" }
    }
  },
  {
    id: "flat_midface",
    title: "Flat Midface",
    type: "weakness",
    severity_logic: {
      metrics: ["Cheekbone Height", "Midface Ratio", "Total Facial Width to Height"],
      threshold: 5.0
    },
    content: {
      description: "The midface lacks forward projection, resulting in flatter facial contours.",
      severity_labels: { minor: "Slightly Flat", moderate: "Underprojected", severe: "Recessed" }
    }
  },
  {
    id: "ideal_lip_ratio",
    title: "Ideal Lip Proportions",
    type: "strength",
    severity_logic: {
      metrics: ["Lip Ratio", "Philtrum Length", "Lip Chin Distance"],
      threshold: 8.5
    },
    content: {
      description: "The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio.",
      grade_labels: { good: "Balanced", excellent: "Well-Proportioned", ideal: "Perfect Ratio" }
    }
  },
  {
    id: "thin_lips",
    title: "Thin Lip Profile",
    type: "weakness",
    severity_logic: {
      metrics: ["Lip Ratio", "Upper Lip Projection", "Lower Lip Projection"],
      threshold: 5.0
    },
    content: {
      description: "The lips appear thinner than ideal proportions, affecting lower face harmony.",
      severity_labels: { minor: "Slightly Thin", moderate: "Thin", severe: "Very Thin" }
    }
  },
  {
    id: "ideal_ipd",
    title: "Ideal Eye Spacing",
    type: "strength",
    severity_logic: {
      metrics: ["Interpupillary Ratio", "Eye Separation Ratio", "One Eye Apart Test"],
      threshold: 8.5
    },
    content: {
      description: "The eyes are ideally spaced, creating facial balance and attractiveness.",
      grade_labels: { good: "Good Spacing", excellent: "Ideal Distance", ideal: "Perfect IPD" }
    }
  },
  {
    id: "wide_set_eyes",
    title: "Wide-Set Eyes",
    type: "weakness",
    severity_logic: {
      metrics: ["Interpupillary Ratio", "Eye Separation Ratio", "One Eye Apart Test"],
      threshold: 5.5
    },
    content: {
      description: "The eyes are spaced wider apart than the aesthetic ideal.",
      severity_labels: { minor: "Slightly Wide", moderate: "Noticeably Wide", severe: "Very Wide" }
    }
  },
  {
    id: "close_set_eyes",
    title: "Close-Set Eyes",
    type: "weakness",
    severity_logic: {
      metrics: ["Interpupillary Ratio", "Eye Separation Ratio", "Intercanthal Width"],
      threshold: 5.5
    },
    content: {
      description: "The eyes are positioned closer together than the aesthetic ideal.",
      severity_labels: { minor: "Slightly Close", moderate: "Noticeably Close", severe: "Very Close" }
    }
  },
  {
    id: "ideal_nose_projection",
    title: "Ideal Nasal Projection",
    type: "strength",
    severity_logic: {
      metrics: ["Nasofrontal Angle", "Nasofacial Angle", "Nasomenta Angle"],
      threshold: 8.5
    },
    content: {
      description: "The nose has ideal forward projection relative to the face, creating profile harmony.",
      grade_labels: { good: "Good", excellent: "Well-Projected", ideal: "Perfect Projection" }
    }
  },
  {
    id: "recessed_chin",
    title: "Recessed Chin",
    type: "weakness",
    severity_logic: {
      metrics: ["Chin to Philtrum Ratio", "Chin Height", "Facial Depth to Height"],
      threshold: 5.0
    },
    content: {
      description: "The chin sits behind the ideal position, affecting profile balance.",
      severity_labels: { minor: "Slightly Recessed", moderate: "Recessed", severe: "Severely Recessed" }
    }
  },
  {
    id: "ideal_chin_projection",
    title: "Ideal Chin Projection",
    type: "strength",
    severity_logic: {
      metrics: ["Chin to Philtrum Ratio", "Chin Height", "Anterior Facial Depth"],
      threshold: 8.5
    },
    content: {
      description: "The chin demonstrates ideal projection and proportions relative to the face.",
      grade_labels: { good: "Good", excellent: "Well-Projected", ideal: "Perfect" }
    }
  },
  {
    id: "long_philtrum",
    title: "Long Philtrum",
    type: "weakness",
    severity_logic: {
      metrics: ["Philtrum Length", "Lip Chin Distance", "Upper Lip Height"],
      threshold: 5.5
    },
    content: {
      description: "The distance between nose and upper lip is longer than ideal.",
      severity_labels: { minor: "Slightly Long", moderate: "Long", severe: "Very Long" }
    }
  },
  {
    id: "short_philtrum",
    title: "Short Philtrum",
    type: "strength",
    severity_logic: {
      metrics: ["Philtrum Length", "Upper Lip Height"],
      threshold: 8.0
    },
    content: {
      description: "The philtrum has ideal or shorter length, considered youthful and attractive.",
      grade_labels: { good: "Good Length", excellent: "Short", ideal: "Ideal" }
    }
  },
  {
    id: "wide_nose",
    title: "Wide Nasal Base",
    type: "weakness",
    severity_logic: {
      metrics: ["Nasal Index", "Intercanthal Nasal Ratio", "Nose Bridge Width"],
      threshold: 5.0
    },
    content: {
      description: "The base of the nose is wider than the aesthetic ideal for facial harmony.",
      severity_labels: { minor: "Slightly Wide", moderate: "Wide", severe: "Very Wide" }
    }
  },
  {
    id: "ideal_brow_position",
    title: "Ideal Brow Position",
    type: "strength",
    severity_logic: {
      metrics: ["Eyebrow Height", "Brow Length Ratio"],
      threshold: 8.0
    },
    content: {
      description: "The eyebrows are ideally positioned relative to the eyes and facial structure.",
      grade_labels: { good: "Good Position", excellent: "Well-Arched", ideal: "Perfect Frame" }
    }
  },
  {
    id: "narrow_jaw",
    title: "Narrow Jaw",
    type: "weakness",
    severity_logic: {
      metrics: ["Jaw Width Ratio", "Bigonial Width", "Jaw Frontal Angle"],
      threshold: 5.0
    },
    content: {
      description: "The jaw is narrower than ideal, affecting lower face width and definition.",
      severity_labels: { minor: "Slightly Narrow", moderate: "Narrow", severe: "Very Narrow" }
    }
  },
  {
    id: "steep_mandibular_plane",
    title: "Steep Mandibular Plane",
    type: "weakness",
    severity_logic: {
      metrics: ["Mandibular Plane Angle", "Gonial Angle", "Lower Third Proportion"],
      threshold: 5.0
    },
    content: {
      description: "The mandibular plane angle is steeper than ideal, often indicating vertical growth pattern.",
      severity_labels: { minor: "Slightly Steep", moderate: "Steep", severe: "Very Steep" }
    }
  }
];

// ============================================
// METRIC NAME MAPPING
// ============================================

// Map display names to metric IDs for lookup
const METRIC_NAME_TO_ID: Record<string, string> = {
  // Face Shape/Proportions
  "Face Width to Height Ratio": "faceWidthToHeight",
  "Total Facial Width to Height": "totalFacialWidthToHeight",
  "Midface Ratio": "midfaceRatio",
  "Upper Third Proportion": "upperThirdProportion",
  "Middle Third Proportion": "middleThirdProportion",
  "Lower Third Proportion": "lowerThirdProportion",
  "Cheekbone Height": "cheekboneHeight",
  "Cheekbone Width": "cheekboneWidth",
  "Bitemporal Width": "bitemporalWidth",

  // Jaw
  "Gonial Angle": "gonialAngle",
  "Mandibular Plane Angle": "mandibularPlaneAngle",
  "Jaw Width Ratio": "jawWidthRatio",
  "Bigonial Width": "bigonialWidth",
  "Jaw Frontal Angle": "jawFrontalAngle",
  "Jaw Slope": "jawSlope",

  // Chin
  "Chin to Philtrum Ratio": "chinPhiltrumRatio",
  "Chin Height": "chinHeight",
  "Facial Depth to Height": "facialDepthToHeight",
  "Anterior Facial Depth": "anteriorFacialDepth",

  // Eyes
  "Lateral Canthal Tilt": "lateralCanthalTilt",
  "Eye Aspect Ratio": "eyeAspectRatio",
  "Eye Separation Ratio": "eyeSeparationRatio",
  "Interpupillary Ratio": "interpupillaryRatio",
  "One Eye Apart Test": "oneEyeApartTest",
  "Intercanthal Width": "intercanthalWidth",
  "Eyebrow Height": "eyebrowHeight",
  "Brow Length Ratio": "browLengthRatio",

  // Nose
  "Nasal Index": "nasalIndex",
  "Nasal Tip Angle": "nasalTipAngle",
  "Nose Tip Position": "noseTipPosition",
  "Frankfort-tip Angle": "frankfortTipAngle",
  "Nasofrontal Angle": "nasofrontalAngle",
  "Nasofacial Angle": "nasofacialAngle",
  "Nasomenta Angle": "nasomentaAngle",
  "Intercanthal Nasal Ratio": "intercanthalNasalRatio",
  "Nose Bridge Width": "noseBridgeWidth",
  "Nose Width": "noseWidth",

  // Lips
  "Lip Ratio": "lipRatio",
  "Philtrum Length": "philtrumLength",
  "Upper Lip Projection": "upperLipProjection",
  "Lower Lip Projection": "lowerLipProjection",
  "Lip Chin Distance": "lipChinDistance",
  "Upper Lip Height": "upperLipHeight",
  "Upper Lip E-Line Position": "upperLipELine",
  "Upper Lip S-Line Position": "upperLipSLine",
  "Nasolabial Angle": "nasolabialAngle",
};

// ============================================
// CLASSIFICATION FUNCTIONS
// ============================================

/**
 * Get weakness severity based on average score
 * 0-3 = "Severe", 3-5 = "Moderate", 5-7 = "Minor"
 */
function getWeaknessSeverity(avgScore: number): WeaknessSeverity {
  if (avgScore <= 3) return 'severe';
  if (avgScore <= 5) return 'moderate';
  return 'minor';
}

/**
 * Get strength grade based on average score
 * 8-9 = "Good", 9-9.5 = "Excellent", 9.5-10 = "Ideal"
 */
function getStrengthGrade(avgScore: number): StrengthGrade {
  if (avgScore >= 9.5) return 'ideal';
  if (avgScore >= 9) return 'excellent';
  return 'good';
}

/**
 * Find metric by display name from measurements array
 */
function findMetricByName(
  metricName: string,
  measurements: FaceIQScoreResult[]
): FaceIQScoreResult | undefined {
  // First try direct ID mapping
  const metricId = METRIC_NAME_TO_ID[metricName];
  if (metricId) {
    return measurements.find(m => m.metricId === metricId);
  }

  // Fallback: try fuzzy matching on name
  const normalizedName = metricName.toLowerCase().replace(/[^a-z0-9]/g, '');
  return measurements.find(m => {
    const normalizedMetricName = m.name.toLowerCase().replace(/[^a-z0-9]/g, '');
    return normalizedMetricName.includes(normalizedName) ||
           normalizedName.includes(normalizedMetricName);
  });
}

/**
 * Process all insight definitions against user's measurements
 */
export function classifyInsights(
  measurements: FaceIQScoreResult[],
  insightDefinitions: InsightDefinition[] = INSIGHTS_DEFINITIONS
): InsightClassificationResult {
  const strengths: ClassifiedStrength[] = [];
  const weaknesses: ClassifiedWeakness[] = [];

  for (const insight of insightDefinitions) {
    const { metrics, threshold } = insight.severity_logic;

    // Find matching measurements for this insight
    const matchedMetrics: MatchedMetric[] = [];
    for (const metricName of metrics) {
      const measurement = findMetricByName(metricName, measurements);
      if (measurement) {
        matchedMetrics.push({
          metricId: measurement.metricId,
          metricName: measurement.name,
          score: measurement.score,
          value: measurement.value,
          idealMin: measurement.idealMin,
          idealMax: measurement.idealMax,
          unit: measurement.unit,
          category: measurement.category,
        });
      }
    }

    // Skip if no metrics matched (need at least 1)
    if (matchedMetrics.length === 0) continue;

    // Calculate average score
    const avgScore = matchedMetrics.reduce((sum, m) => sum + m.score, 0) / matchedMetrics.length;

    // Classify based on type and threshold
    if (insight.type === 'weakness') {
      // Weakness: avg < threshold → add to areas of improvement
      if (avgScore < threshold) {
        const severity = getWeaknessSeverity(avgScore);
        const labels = insight.content.severity_labels;
        const severityLabel = labels?.[severity] || severity;

        weaknesses.push({
          insightId: insight.id,
          title: insight.title,
          description: insight.content.description,
          severity,
          severityLabel,
          avgScore,
          matchedMetrics,
        });
      }
    } else {
      // Strength: avg > threshold → add to key strengths
      if (avgScore > threshold) {
        const grade = getStrengthGrade(avgScore);
        const labels = insight.content.grade_labels;
        const gradeLabel = labels?.[grade] || grade;

        strengths.push({
          insightId: insight.id,
          title: insight.title,
          description: insight.content.description,
          grade,
          gradeLabel,
          avgScore,
          matchedMetrics,
        });
      }
    }
  }

  // Sort by score (weaknesses by lowest score first, strengths by highest first)
  weaknesses.sort((a, b) => a.avgScore - b.avgScore);
  strengths.sort((a, b) => b.avgScore - a.avgScore);

  return { strengths, weaknesses };
}

/**
 * Convert ClassifiedStrength to Strength type for UI compatibility
 */
export function convertToStrength(classified: ClassifiedStrength): Strength {
  return {
    id: `insight_strength_${classified.insightId}`,
    strengthName: `${classified.title} (${classified.gradeLabel})`,
    summary: classified.description,
    avgScore: classified.avgScore,
    qualityLevel: classified.grade === 'ideal' ? 'ideal' :
                  classified.grade === 'excellent' ? 'excellent' : 'good',
    categoryName: classified.matchedMetrics[0]?.category || 'General',
    responsibleRatios: classified.matchedMetrics.map(m => ({
      ratioName: m.metricName,
      ratioId: m.metricId,
      score: m.score,
      value: m.value,
      idealMin: m.idealMin,
      idealMax: m.idealMax,
      unit: m.unit,
      category: m.category,
    })),
  };
}

/**
 * Convert ClassifiedWeakness to Flaw type for UI compatibility
 */
export function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {
  const impact = (10 - classified.avgScore) * 0.5 * classified.matchedMetrics.length;
  const newRollingLost = rollingLost + impact;

  return {
    id: `insight_flaw_${classified.insightId}`,
    flawName: `${classified.title} (${classified.severityLabel})`,
    summary: classified.description,
    harmonyPercentageLost: impact,
    standardizedImpact: impact / 10,
    categoryName: classified.matchedMetrics[0]?.category || 'General',
    responsibleRatios: classified.matchedMetrics.map(m => ({
      ratioName: m.metricName,
      ratioId: m.metricId,
      score: m.score,
      value: m.value,
      idealMin: m.idealMin,
      idealMax: m.idealMax,
      unit: m.unit,
      category: m.category,
    })),
    rollingPointsDeducted: newRollingLost,
    rollingHarmonyPercentageLost: newRollingLost,
    rollingStandardizedImpact: newRollingLost / 10,
  };
}

/**
 * Main function: Generate strengths and flaws from measurements using insights
 */
export function generateInsightBasedResults(
  measurements: FaceIQScoreResult[]
): { strengths: Strength[]; flaws: Flaw[] } {
  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);

  // Convert to UI-compatible types
  const strengths = classifiedStrengths.map((s) => convertToStrength(s));

  let rollingLost = 0;
  const flaws = classifiedWeaknesses.map((w, i) => {
    const flaw = convertToFlaw(w, i, rollingLost);
    rollingLost = flaw.rollingPointsDeducted || 0;
    return flaw;
  });

  return { strengths, flaws };
}
