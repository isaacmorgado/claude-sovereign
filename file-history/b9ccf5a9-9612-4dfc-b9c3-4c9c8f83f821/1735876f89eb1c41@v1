"""
Detection router - Landmark detection endpoints
"""

from fastapi import APIRouter, HTTPException, status

from app.schemas.detection import (
    ImageRequest,
    SideLandmarksResponse,
    FrontLandmarksResponse,
    DetectionRequest,
    DetectionResponse,
)
from app.services.detection import detection_service

router = APIRouter(tags=["detection"])


# ============================================
# FACEIQ-COMPATIBLE ENDPOINTS
# ============================================

@router.post("/api/side-landmarks", response_model=SideLandmarksResponse)
async def side_landmarks(request: ImageRequest):
    """
    Detect side profile landmarks - FaceIQ-compatible endpoint

    Accepts: Base64 encoded image
    Returns: 106 InsightFace landmarks in FaceIQ format

    Response includes:
    - rotationAngle: Head rotation in radians
    - direction: "left" or "right" facing
    - center: Face center coordinates
    - crop: Detected face crop region with scale
    - landmarks: Array of 106 {x, y} coordinates (pixel space)
    - bbox: Face bounding box [x1, y1, x2, y2]
    - namedLandmarks: Cephalometric landmarks by name
    - allLandmarks: All 106 landmarks with descriptive names
    """
    result = await detection_service.detect_side_landmarks(request.image)
    return SideLandmarksResponse(**result)


@router.post("/api/front-landmarks", response_model=FrontLandmarksResponse)
async def front_landmarks(request: ImageRequest):
    """
    Detect front profile landmarks

    Note: FaceIQ uses client-side MediaPipe for front profiles.
    This endpoint provides server-side fallback using InsightFace.

    Accepts: Base64 encoded image
    Returns: 106 landmarks normalized to 0-1 range

    Response includes:
    - landmarks: Array of {x, y} coordinates (0-1 normalized)
    - namedLandmarks: Key facial landmarks by name
    - bbox: Normalized bounding box
    - imageWidth/imageHeight: Original image dimensions
    """
    result = await detection_service.detect_front_landmarks(request.image)
    return FrontLandmarksResponse(**result)


# ============================================
# LEGACY ENDPOINTS (backward compatibility)
# ============================================

@router.post("/detection/side", response_model=DetectionResponse)
async def detect_side_profile_legacy(request: DetectionRequest):
    """
    Legacy side profile detection endpoint

    Kept for backward compatibility with existing frontend.
    Prefer using /api/side-landmarks for new implementations.
    """
    result = await detection_service.detect_side_landmarks(request.image)

    if not result.get("success"):
        return DetectionResponse(
            success=False,
            message=result.get("error", "Detection failed")
        )

    data = result.get("data", {})
    return DetectionResponse(
        success=True,
        message=f"Detected {data.get('landmarkCount', 0)} landmarks",
        direction=data.get("direction"),
        rotation_angle=data.get("rotationAngle"),
        raw_landmarks=data.get("landmarks"),
        mapped_landmarks=data.get("namedLandmarks"),
        face_box={
            "x": data.get("crop", {}).get("x", 0),
            "y": data.get("crop", {}).get("y", 0),
            "width": data.get("crop", {}).get("width", 0),
            "height": data.get("crop", {}).get("height", 0),
        } if data.get("crop") else None,
    )


# ============================================
# HEALTH CHECK
# ============================================

@router.get("/api/detection/health")
@router.get("/detection/health")
async def detection_health():
    """Check if detection model is loaded and ready"""
    is_ready = detection_service._face_analyzer is not None
    return {
        "status": "ready" if is_ready else "not_ready",
        "model": "InsightFace buffalo_l" if is_ready else None,
        "landmarks": 106 if is_ready else 0,
        "endpoints": {
            "side": "/api/side-landmarks",
            "front": "/api/front-landmarks",
            "legacy": "/detection/side"
        }
    }
