# LOOKSMAXX

A facial metrics analysis and visualization system with Next.js frontend and MediaPipe-based facial landmark detection. Now with FaceIQ-compatible scoring and results UI.

## Live URLs

- **Frontend**: https://looksmaxx-app.vercel.app
- **API**: https://api-production-6148.up.railway.app

## Tech Stack

- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Animation**: Framer Motion
- **Face Detection**: MediaPipe Tasks Vision (client, 478 landmarks) + InsightFace (server, 106 landmarks)
- **Scoring**: FaceIQ-compatible exponential decay with 70+ measurements
- **Backend**: FastAPI on Railway with PostgreSQL
- **Email**: SendGrid for transactional emails
- **Frontend Hosting**: Vercel

## Code Quality

```bash
cd looksmaxx-app && npm run lint && npx tsc --noEmit
```

## Completed Features

### Username & T&C System (2025-12-23) ✅
Full implementation deployed and tested end-to-end:
- User registration with unique username (3-30 chars, alphanumeric + underscore)
- Terms & Conditions acceptance required for signup
- Leaderboard displays usernames instead of anonymous IDs
- Username availability check endpoint
- DB migrations applied on Railway

### Scoring System - 100% Complete ✅ (Verified 2025-12-25)

| Component | Count | File | Details |
|-----------|-------|------|---------|
| **Bezier Curves** | 67 | `looksmaxx-app/src/lib/bezier-curves.ts` | Complete cubic Bezier interpolation with 10-15 control points |
| **Decay Rates** | 80+ | `looksmaxx-app/src/lib/data/metric-configs.ts` | 0.08-1.0 range (calibrated per metric type - angles use 0.5-1.0, ratios use 0.08-0.30) |
| **Ethnicity Overrides** | 16 demographics | `looksmaxx-app/src/lib/data/demographic-overrides.ts` | 8 ethnicities × 2 genders = 16 combos with 130+ individual metric overrides |
| **Severity Tiers** | 6 + 5 | Two systems: Raw scoring (6-tier: extremely_severe→optimal) + Insights (5-tier: ideal→severe) |
| **Quality Tiers** | 4 | `looksmaxx-app/src/lib/scoring/types.ts` | ideal/excellent/good/below_average |
| **PSL Rating** | 10 tiers | `looksmaxx-app/src/lib/psl-calculator.ts` | 1-10 scale with percentile mapping |
| **Total Metrics** | 80+ | `looksmaxx-app/src/lib/data/metric-configs.ts` | Front + side profile measurements |

### Treatment System - 100% Complete ✅ (Verified 2025-12-25)

| Component | Count | File | Details |
|-----------|-------|------|---------|
| **Procedure Impact Tables** | 30+ | `looksmaxx-app/src/lib/advice-engine.ts` | Quantitative % changes per metric |
| **Treatment Metadata** | Full | `looksmaxx-app/src/lib/advice-engine.ts` | priority_score, effectiveness, ratios_impacted, pillars |
| **Potential Score Prediction** | Yes | `looksmaxx-app/src/lib/recommendations/severity.ts:644-693` | `estimatePotentialPSL()` with 20% diminishing returns |
| **Multi-Procedure Plans** | 5 phases | `looksmaxx-app/src/lib/recommendations/engine.ts` | Lifestyle → Softmaxxing → Non-Surgical → Minimally Invasive → Surgical |
| **Order of Operations** | Yes | `looksmaxx-app/src/lib/recommendations/engine.ts:517-577` | `generateOrderOfOperations()` with prerequisites |
| **Gender-Specific Treatments** | Yes | `looksmaxx-app/src/lib/advice-engine.ts` | V-line Surgery, Masseter Botox (female-only) |

### UI Components ✅

| Component | File | Details |
|-----------|------|---------|
| **Side Profile Depth Validation** | `looksmaxx-app/src/lib/mediapipeDetection.ts` | `validateSideProfileDepth()` validates 3D depth |
| **Before/After Preview** | `looksmaxx-app/src/components/results/visualization/BeforeAfterPreview.tsx` | Visual overlay showing improvements |
| **Treatment Timeline** | `looksmaxx-app/src/components/results/visualization/TreatmentTimeline.tsx` | Phase-based treatment sequencing UI |
| **Error Boundary** | `looksmaxx-app/src/app/results/page.tsx` | Graceful error handling for results page |

### Female Analysis ✅
- 8 ethnicity overrides with distinct ideal ranges
- Sexual dimorphism (narrower jaws, softer angles, larger eyes)
- Female-specific treatments (V-line surgery, Masseter Botox)
- Gender filtering in recommendation engine

## Key Files

### Backend (`looksmaxx-api/`)
- `app/routers/auth.py` - Registration, login, password reset endpoints
- `app/routers/referrals.py` - Influencer referral code management
- `app/routers/leaderboard.py` - Leaderboard with usernames
- `app/routers/physique.py` - Physique upload, body analysis, face extraction
- `app/services/email.py` - SendGrid email service (password reset, welcome emails)
- `app/services/vision_service.py` - Claude Vision face + body analysis
- `app/models/user.py` - User model with username/terms fields
- `app/models/physique.py` - PhysiqueAnalysis + VisionExtraction models
- `app/schemas/user.py` - Validation schemas
- `migrations/006_add_physique_tables.sql` - Physique + vision tables

### Frontend (`looksmaxx-app/`)
- `src/app/signup/page.tsx` - Signup with username, T&C, referral code
- `src/app/terms/page.tsx` - Terms & Conditions page
- `src/app/login/page.tsx` - Email/password login
- `src/app/forgot-password/page.tsx` - Password reset request
- `src/app/reset-password/page.tsx` - Password reset form
- `src/app/analysis/page.tsx` - Face + physique analysis flow
- `src/lib/api.ts` - API client methods
- `src/app/forum/` - Community forum pages
- `src/components/forum/` - Forum components
- `src/contexts/ForumContext.tsx` - Forum state management
- `src/contexts/PhysiqueContext.tsx` - Physique photos + analysis state
- `src/types/forum.ts` - Forum TypeScript types

## PostgreSQL Access (Debug)

```bash
export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"
psql "postgresql://postgres:pCADzvPqsoWVWCozIwkjPybkTRUzwbZu@shortline.proxy.rlwy.net:10999/railway"
```

### Auth System (2025-12-23) ✅
- Email/password login (replaced Google OAuth)
- Forgot password flow with secure token
- SendGrid-powered password reset emails
- Password reset page with token validation
- Referral code field on signup with Stripe promotion code integration

### Referral System (2025-12-23) ✅
- Influencer referral codes stored in `referral_codes` table
- Linked to Stripe promotion codes for automatic discounts
- Validation endpoint for real-time code checking
- Usage tracking and analytics
- Admin endpoints for managing codes

### Infrastructure Fixes (2025-12-24) ✅
- Fixed Railway OOM crashes with lazy-loaded InsightFace model
- SendGrid integration for transactional emails

### Archetype Classification (2025-12-25) ✅
Full archetype classification system:

**Frontend**:
- Archetype data: `looksmaxx-app/src/data/archetypes.json` - 6 categories with sub-archetypes
- Classifier: `looksmaxx-app/src/lib/archetype-classifier.ts` - Scoring using gonialAngle, FWHR, canthalTilt
- Components: `looksmaxx-app/src/components/psl/archetype/` - ArchetypeCard, ArchetypeTraits
- Tab: `looksmaxx-app/src/components/results/tabs/ArchetypeTab.tsx` - Full archetype analysis page
- API methods: `looksmaxx-app/src/lib/api.ts` - classifyArchetype, getArchetypeDefinitions

**Backend**:
- Service: `looksmaxx-api/app/services/archetype_service.py` - Classification logic
- Router: `looksmaxx-api/app/routers/archetype.py` - POST /archetype/classify, GET /archetype/definitions

**Categories**: Softboy, Prettyboy, RobustPrettyboy, Chad, Hypermasculine (Warrior), Exotic

### Claude Vision Feature Extraction (2025-12-25) ✅
Full psl.md spec implementation with E2E tested face + body feature extraction:

**Backend:**
- `app/services/vision_service.py` - **NEW** Unified Claude Vision service
- `app/models/physique.py` - PhysiqueAnalysis + VisionExtraction models
- `app/routers/physique.py` - Photo upload, body analysis, face extraction endpoints
- `migrations/006_add_physique_tables.sql` - Database tables

**Face Features Extracted:**
| Category | Features |
|----------|----------|
| Skin | clarity (0-10), tone, acne_level, acne_scarring, pore_visibility, texture_issues |
| Hair | hairline_nw (0-7 Norwood), density, texture, color |
| Eyes | color, under_eye_darkness (0-10), under_eye_puffiness (0-10) |
| Facial | hollow_cheeks (0-10), eyebrow_density, facial_hair_potential |
| Teeth | color, alignment, visible |

**Body Features Extracted:**
- body_fat_percent (5-45%), muscle_mass, frame_size, shoulder_width, waist_definition, posture

**API Endpoints:**
- `POST /physique/upload` - Upload physique photos to S3
- `POST /physique/analyze` - Claude Vision body analysis
- `POST /physique/extract-face` - Claude Vision face feature extraction
- `GET /physique/my-analysis` - Get stored body analysis
- `GET /physique/my-face-features` - Get stored face extraction

**E2E Testing:** 11 bugs found and fixed (migration, type mismatches, memory leaks, persistence)

### Community Forum (2025-12-25) ✅
Full Reddit-style forum implementation:

**Backend (Phase 1)**:
- 7 database models: ForumIssueCategory, ForumSubForum, FlawToForumMapping, ForumPost, ForumComment, ForumVote, ForumReport
- 21 API endpoints in `app/routers/forum.py`
- 12 categories, 41 sub-forums, 17 flaw mappings seeded
- N+1 query optimization (54 queries → 2 queries)
- Live at: `https://api-production-6148.up.railway.app/forum/`

**Frontend (Phase 2)**:
- TypeScript types: `src/types/forum.ts`
- 16 API methods in `src/lib/api.ts`
- ForumContext: `src/contexts/ForumContext.tsx`
- Pages: `/forum`, `/forum/[categorySlug]`, `/forum/post/[postId]`
- Components: CategoryCard, PostCard, VoteButtons, CommentThread, CreatePostForm

**QA Fixes (Phase 3)**:
- Added try-catch to handleCreatePost
- Fixed duplicate API calls on mount (useRef pattern)
- Added empty subForums warning
- Fixed stale closure in pagination (offsetRef)
- Added loading state to VoteButtons
- Added confirmation dialog for comment deletion

### Archetype → Forum Integration (2025-12-25) ✅
Maps archetypes to relevant forum communities:

**Backend**:
- `migrations/007_add_archetype_forum_mappings.sql` - Table + 22 seed mappings
- `app/models/forum.py` - Added ArchetypeForumMapping model
- `app/schemas/forum.py` - Added ArchetypeForumRecommendation schema
- `app/routers/forum.py` - Added GET /forum/archetype-recommendations?archetype=X

**Frontend**:
- `src/lib/api.ts` - getArchetypeForumRecommendations() method
- `src/components/results/tabs/CommunityTab.tsx` - "Based on Your Archetype" section
- `src/components/results/tabs/ArchetypeTab.tsx` - RecommendedForumsSection component

**Mappings**: Each archetype (Softboy, Prettyboy, RobustPrettyboy, Chad, Hypermasculine, Exotic) → relevant forum categories (Fashion, Body Composition, etc.)

### Stripe Payment System (2025-12-26) ✅
Full payment integration with Stripe:

**Backend:**
- `app/routers/payments.py` - Checkout session creation with StripeClient pattern
- `migrations/008_add_payments_table.sql` - Payments table + Stripe columns
- Environment variable `STRIPE_SECRET_KEY` configured in Railway

**Features:**
- Checkout sessions for Basic ($24.99/mo) and Pro ($49.99/mo) plans
- Stripe customer creation on first purchase
- Referral code discount integration via Stripe promotion codes
- Live checkout URLs generated: `https://checkout.stripe.com/...`

**API Endpoints:**
- `POST /payments/checkout?plan=basic|pro` - Creates Stripe checkout session

### Supplement E-Commerce Layer (2025-12-26) ✅
Affiliate product recommendations based on facial metrics:

**Frontend Files:**
- `src/types/results.ts` - Product, ProductRecommendation, DailyStack types
- `src/lib/product_db.ts` - 15 affiliate products (Amazon + direct links)
- `src/lib/recommendations/supplements.ts` - Supplement database with dosages, costs, timelines
- `src/lib/daily-stack.ts` - Universal daily stack generator (gender/age aware)
- `src/lib/product-recommendations.ts` - Metric-to-product matching engine
- `src/components/results/cards/ProductCard.tsx` - Product card with affiliate CTA
- `src/components/results/cards/DailyStackCard.tsx` - Daily stack hero section
- `src/components/results/tabs/PlanTab.tsx` - Updated with product integration

**Features:**
- 15 affiliate products across 6 categories (skin, bone, hair, anti-aging, hormonal, general)
- Metric-to-supplement mapping (e.g., Gonial Angle → Creatine + Vitamin D3)
- Corrective vs Maintenance product classification
- Gender-specific stacks (Ashwagandha for males)
- Age-aware additions (NMN for 30+)
- Daily timing schedule (morning/evening)
- Cost estimates and timeline to results

### Forum Navigation (2025-12-26) ✅
- Added "Community" link with MessageSquare icon to main header navigation
- Links to `/forum` page
- Vercel environment variable `NEXT_PUBLIC_API_URL` configured for all environments

## Remaining Tasks

### Cleanup (Optional)
1. Remove debug logging from `looksmaxx-api/app/routers/leaderboard.py`
2. Clean up test users from database
3. Remove console.log debugging from results page

## Last Session (2025-12-26)

Completed Sprint 8: Stripe + E-Commerce + Forum Navigation

**Features Implemented:**

1. **Stripe Payment System** ✅
   - Configured `STRIPE_SECRET_KEY` in Railway environment
   - Rewrote `payments.py` to use StripeClient pattern (fixed initialization issues)
   - Created `migrations/008_add_payments_table.sql`
   - Tested live checkout - generates valid Stripe checkout URLs

2. **Supplement E-Commerce Layer** ✅
   - 15 affiliate products in `product_db.ts`
   - Metric-to-product mapping engine in `product-recommendations.ts`
   - Daily stack generator in `daily-stack.ts` (gender/age aware)
   - ProductCard and DailyStackCard UI components
   - Integrated into PlanTab

3. **Forum Navigation** ✅
   - Added "Community" link to main header navigation
   - Configured `NEXT_PUBLIC_API_URL` in Vercel (all environments)

**E2E Test Results:**
| Test | Status |
|------|--------|
| Homepage forum link | ✅ Pass |
| Auth endpoints | ✅ Pass |
| Forum API (12 categories) | ✅ Pass |
| PSL tiers (10) | ✅ Pass |
| Archetypes (6) | ✅ Pass |
| Stripe checkout | ✅ Pass |
| Build verification | ✅ Pass |

**API Status - All Working:**
- `/auth/register`, `/auth/login` ✅
- `/payments/checkout?plan=pro` ✅ (live Stripe URLs)
- `/forum/categories` ✅ (12 categories)
- `/psl/tiers`, `/archetype/definitions` ✅

**All checks pass:** `npm run lint && npx tsc --noEmit` ✅
