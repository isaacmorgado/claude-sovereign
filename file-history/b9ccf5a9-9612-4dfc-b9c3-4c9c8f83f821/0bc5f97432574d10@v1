"""
Detection schemas - Response formats for landmark detection
"""

from pydantic import BaseModel
from typing import Optional, List, Dict, Any


class LandmarkPoint(BaseModel):
    """Single landmark coordinate"""
    x: float
    y: float


class CropRegion(BaseModel):
    """Face crop region with scale"""
    x: int
    y: int
    width: int
    height: int
    scale: float


class CenterPoint(BaseModel):
    """Face center coordinates"""
    x: float
    y: float


# ============================================
# REQUEST SCHEMAS
# ============================================

class ImageRequest(BaseModel):
    """Request with base64 image data"""
    image: str  # base64 encoded image (with or without data URL prefix)


# ============================================
# SIDE LANDMARKS RESPONSE (FaceIQ-compatible)
# ============================================

class SideLandmarksData(BaseModel):
    """FaceIQ-compatible side landmarks data"""
    rotationAngle: float
    direction: str  # "left" or "right"
    center: CenterPoint
    crop: CropRegion
    landmarks: List[LandmarkPoint]  # 106 raw landmarks
    bbox: List[float]  # [x1, y1, x2, y2]
    namedLandmarks: Dict[str, LandmarkPoint]  # Cephalometric named landmarks
    allLandmarks: Optional[Dict[str, LandmarkPoint]] = None  # All 106 with names
    landmarkCount: int


class SideLandmarksResponse(BaseModel):
    """
    FaceIQ-compatible side landmarks response

    Matches: POST /api/side-landmarks
    """
    success: bool
    data: Optional[SideLandmarksData] = None
    error: Optional[str] = None


# ============================================
# FRONT LANDMARKS RESPONSE
# ============================================

class FrontLandmarksData(BaseModel):
    """Front profile landmarks data"""
    landmarks: List[LandmarkPoint]  # Normalized 0-1 coordinates
    namedLandmarks: Dict[str, LandmarkPoint]  # Named facial landmarks
    bbox: List[float]  # Normalized bounding box
    imageWidth: int
    imageHeight: int
    landmarkCount: int


class FrontLandmarksResponse(BaseModel):
    """Front profile landmarks response"""
    success: bool
    data: Optional[FrontLandmarksData] = None
    error: Optional[str] = None


# ============================================
# LEGACY RESPONSE (backward compatibility)
# ============================================

class DetectionRequest(BaseModel):
    """Legacy request format"""
    image: str


class DetectionResponse(BaseModel):
    """Legacy response format (for /detection/side endpoint)"""
    success: bool
    message: str
    direction: Optional[str] = None
    rotation_angle: Optional[float] = None
    raw_landmarks: Optional[List[LandmarkPoint]] = None
    mapped_landmarks: Optional[Dict[str, LandmarkPoint]] = None
    face_box: Optional[Dict[str, float]] = None
    frankfort_plane: Optional[Dict[str, Any]] = None
