// Auth Panel - Login and signup forms for user authentication
import { LitElement, html, css } from 'lit'
import { customElement, state } from 'lit/decorators.js'
import { backendClient, type User } from '@/utils/api/backend-client'
import { logger } from '@/utils/logger'

type AuthView = 'login' | 'signup'

@customElement('auth-panel')
export class AuthPanel extends LitElement {
  static styles = css`
    :host {
      display: block;
    }

    .auth-container {
      max-width: 320px;
      margin: 0 auto;
    }

    .auth-header {
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .auth-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-xs);
    }

    .auth-subtitle {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .auth-tabs {
      display: flex;
      gap: var(--space-xs);
      margin-bottom: var(--space-lg);
    }

    .auth-tab {
      flex: 1;
      padding: var(--space-sm);
      border: none;
      background: var(--bg-layer-1);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: var(--font-size-sm);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }

    .auth-tab:hover {
      background: var(--bg-layer-2);
      color: var(--text-primary);
    }

    .auth-tab.active {
      background: var(--color-primary);
      color: white;
    }

    .form-field {
      margin-bottom: var(--space-md);
    }

    .form-field sp-textfield {
      width: 100%;
    }

    .form-field label {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--space-xs);
    }

    .error-message {
      background: rgba(215, 55, 63, 0.1);
      color: var(--color-negative);
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-md);
    }

    .success-message {
      background: rgba(15, 191, 132, 0.1);
      color: var(--color-accent);
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-md);
    }

    .form-actions {
      margin-top: var(--space-lg);
    }

    .form-actions sp-button {
      width: 100%;
    }

    .logged-in-container {
      text-align: center;
    }

    .user-info {
      background: var(--bg-layer-1);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
    }

    .user-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      margin: 0 auto var(--space-md);
    }

    .user-name {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-xs);
    }

    .user-email {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-sm);
    }

    .user-plan {
      display: inline-block;
      font-size: var(--font-size-xs);
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      text-transform: uppercase;
    }

    .user-plan.free {
      background: var(--bg-layer-2);
      color: var(--text-secondary);
    }

    .user-plan.pro {
      background: linear-gradient(135deg, #ffd700, #ffaa00);
      color: #1a1a1a;
    }

    .user-plan.enterprise {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
    }

    .password-hint {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      margin-top: var(--space-xs);
    }
  `

  @state() private view: AuthView = 'login'
  @state() private user: User | null = null
  @state() private isLoading = false
  @state() private error = ''
  @state() private success = ''

  // Form fields
  @state() private email = ''
  @state() private password = ''
  @state() private name = ''

  private unsubscribeAuth?: () => void

  async connectedCallback(): Promise<void> {
    super.connectedCallback()

    // Wait for client initialization (token loading)
    await backendClient.waitForInit()

    // Subscribe to auth changes
    this.unsubscribeAuth = backendClient.onAuthChange((user) => {
      this.user = user
      this.dispatchAuthEvent(user)
    })

    // Check if already authenticated
    if (backendClient.isAuthenticated()) {
      try {
        this.user = await backendClient.getMe()
      } catch (error) {
        logger.warn('Failed to fetch user on init', error)
      }
    }
  }

  disconnectedCallback(): void {
    super.disconnectedCallback()
    this.unsubscribeAuth?.()
  }

  private dispatchAuthEvent(user: User | null): void {
    this.dispatchEvent(
      new CustomEvent('auth-change', {
        detail: { user },
        bubbles: true,
        composed: true,
      })
    )
  }

  private switchView(view: AuthView): void {
    this.view = view
    this.clearForm()
  }

  private clearForm(): void {
    this.email = ''
    this.password = ''
    this.name = ''
    this.error = ''
    this.success = ''
  }

  private async handleLogin(): Promise<void> {
    if (!this.email.trim() || !this.password) {
      this.error = 'Please enter email and password'
      return
    }

    this.isLoading = true
    this.error = ''

    try {
      const result = await backendClient.login(this.email.trim(), this.password)
      this.user = result.user
      this.clearForm()
      logger.info('User logged in', { email: result.user.email })
    } catch (error) {
      this.error = error instanceof Error ? error.message : 'Login failed'
      logger.error('Login failed', error)
    } finally {
      this.isLoading = false
    }
  }

  private async handleSignup(): Promise<void> {
    if (!this.email.trim() || !this.password) {
      this.error = 'Please enter email and password'
      return
    }

    if (this.password.length < 8) {
      this.error = 'Password must be at least 8 characters'
      return
    }

    this.isLoading = true
    this.error = ''

    try {
      const result = await backendClient.register(
        this.email.trim(),
        this.password,
        this.name.trim() || undefined
      )
      this.user = result.user
      this.clearForm()
      this.success = 'Account created successfully!'
      logger.info('User registered', { email: result.user.email })
    } catch (error) {
      this.error = error instanceof Error ? error.message : 'Registration failed'
      logger.error('Registration failed', error)
    } finally {
      this.isLoading = false
    }
  }

  private async handleLogout(): Promise<void> {
    this.isLoading = true

    try {
      await backendClient.logout()
      this.user = null
      this.success = 'Logged out successfully'
      logger.info('User logged out')
    } catch (error) {
      logger.error('Logout failed', error)
    } finally {
      this.isLoading = false
    }
  }

  private handleKeyDown(e: KeyboardEvent): void {
    if (e.key === 'Enter') {
      if (this.view === 'login') {
        this.handleLogin()
      } else {
        this.handleSignup()
      }
    }
  }

  private getInitials(user: User): string {
    if (user.name) {
      return user.name
        .split(' ')
        .map((n) => n[0])
        .join('')
        .toUpperCase()
        .slice(0, 2)
    }
    return user.email[0].toUpperCase()
  }

  private renderLoginForm() {
    return html`
      <div class="form-field">
        <label>Email</label>
        <sp-textfield
          type="email"
          placeholder="your@email.com"
          .value=${this.email}
          @input=${(e: Event) => (this.email = (e.target as HTMLInputElement).value)}
          @keydown=${this.handleKeyDown}
        ></sp-textfield>
      </div>

      <div class="form-field">
        <label>Password</label>
        <sp-textfield
          type="password"
          placeholder="Enter password"
          .value=${this.password}
          @input=${(e: Event) => (this.password = (e.target as HTMLInputElement).value)}
          @keydown=${this.handleKeyDown}
        ></sp-textfield>
      </div>

      <div class="form-actions">
        <sp-button variant="accent" ?disabled=${this.isLoading} @click=${this.handleLogin}>
          ${this.isLoading ? 'Signing in...' : 'Sign In'}
        </sp-button>
      </div>
    `
  }

  private renderSignupForm() {
    return html`
      <div class="form-field">
        <label>Name (optional)</label>
        <sp-textfield
          type="text"
          placeholder="Your name"
          .value=${this.name}
          @input=${(e: Event) => (this.name = (e.target as HTMLInputElement).value)}
          @keydown=${this.handleKeyDown}
        ></sp-textfield>
      </div>

      <div class="form-field">
        <label>Email</label>
        <sp-textfield
          type="email"
          placeholder="your@email.com"
          .value=${this.email}
          @input=${(e: Event) => (this.email = (e.target as HTMLInputElement).value)}
          @keydown=${this.handleKeyDown}
        ></sp-textfield>
      </div>

      <div class="form-field">
        <label>Password</label>
        <sp-textfield
          type="password"
          placeholder="Create password"
          .value=${this.password}
          @input=${(e: Event) => (this.password = (e.target as HTMLInputElement).value)}
          @keydown=${this.handleKeyDown}
        ></sp-textfield>
        <div class="password-hint">Minimum 8 characters</div>
      </div>

      <div class="form-actions">
        <sp-button variant="accent" ?disabled=${this.isLoading} @click=${this.handleSignup}>
          ${this.isLoading ? 'Creating account...' : 'Create Account'}
        </sp-button>
      </div>
    `
  }

  private renderLoggedIn() {
    if (!this.user) return ''

    return html`
      <div class="logged-in-container">
        <div class="user-info">
          <div class="user-avatar">${this.getInitials(this.user)}</div>
          <div class="user-name">${this.user.name || 'User'}</div>
          <div class="user-email">${this.user.email}</div>
          <span class="user-plan ${this.user.plan}">${this.user.plan}</span>
        </div>

        <sp-button variant="secondary" ?disabled=${this.isLoading} @click=${this.handleLogout}>
          ${this.isLoading ? 'Signing out...' : 'Sign Out'}
        </sp-button>
      </div>
    `
  }

  render() {
    // If logged in, show user info
    if (this.user) {
      return html`
        <div class="auth-container">
          ${this.success ? html`<div class="success-message">${this.success}</div>` : ''}
          ${this.renderLoggedIn()}
        </div>
      `
    }

    // Show login/signup forms
    return html`
      <div class="auth-container">
        <div class="auth-header">
          <div class="auth-title">Welcome to Splice</div>
          <div class="auth-subtitle">Sign in to sync your preferences and unlock all features</div>
        </div>

        <div class="auth-tabs">
          <button
            class="auth-tab ${this.view === 'login' ? 'active' : ''}"
            @click=${() => this.switchView('login')}
          >
            Sign In
          </button>
          <button
            class="auth-tab ${this.view === 'signup' ? 'active' : ''}"
            @click=${() => this.switchView('signup')}
          >
            Create Account
          </button>
        </div>

        ${this.error ? html`<div class="error-message">${this.error}</div>` : ''}
        ${this.success ? html`<div class="success-message">${this.success}</div>` : ''}

        ${this.view === 'login' ? this.renderLoginForm() : this.renderSignupForm()}
      </div>
    `
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'auth-panel': AuthPanel
  }
}
