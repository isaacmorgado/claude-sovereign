# Splice v3

Cloud-powered SaaS for Adobe Premiere Pro with AI-driven auto-cutting, take detection, and subscription billing.

## Monorepo Structure

```
/                         # Root
├── src/                  # Premiere Pro UXP Plugin
│   ├── components/
│   │   ├── panels/       # PluginApp (main container)
│   │   └── common/       # UI: Header, SelectionPanel, AIToolsPanel, AuthPanel, CuttingPanel
│   ├── types/            # TypeScript: plugin, api, premiere, audio, take-detection
│   ├── utils/
│   │   ├── api/          # premiere.ts, backend-client.ts, audio-processor.ts
│   │   └── helpers/      # formatters, validators
│   └── styles/           # Global CSS, Spectrum theming
│
├── backend/              # Node.js + Express API
│   └── src/
│       ├── routes/       # auth, billing, jobs, audio, usage
│       ├── controllers/  # Route handlers
│       ├── services/     # Business logic
│       ├── workers/      # BullMQ job processors (transcription, vocal isolation)
│       ├── db/           # migrations/, repositories/
│       └── middleware/   # auth, rate-limit, usage-limit
│
├── dashboard/            # Next.js Web Dashboard
│   └── app/              # login, signup, dashboard (usage, billing, settings)
│
├── tests/                # Vitest unit + Playwright e2e
└── public/               # manifest.json, icons
```

## Tech Stack

| Layer     | Stack                                                             |
| --------- | ----------------------------------------------------------------- |
| Plugin    | Lit 3.2 + Spectrum Web Components + TypeScript                    |
| Backend   | Node.js + Express + PostgreSQL + BullMQ/Redis                     |
| Dashboard | Next.js + React                                                   |
| Audio     | Whisper/Deepgram (transcription) + Demucs/Dolby (vocal isolation) |
| Payments  | Stripe                                                            |

## Code Quality - Zero Tolerance

After editing ANY file, run:

```bash
npm run lint
npm run typecheck
```

Fix ALL errors/warnings before continuing.

## Current Focus

Section: Phase 2 - Plugin Integration (AuthPanel complete, testing UI)
Files: `src/components/common/AuthPanel.ts`, `src/components/panels/PluginApp.ts`, `src/utils/api/backend-client.ts`

## Last Session (2025-12-16)

### Completed
- Created AuthPanel component with login/signup forms (`src/components/common/AuthPanel.ts`)
- Integrated AuthPanel into PluginApp - shows login when not authenticated
- Ran E2E security analysis with 3 parallel agents, identified and fixed 22+ issues:
  - **Critical fixes**: Double-click prevention, isMounted flag for async safety, refresh token mutex
  - **Security fixes**: Plan enum validation (CSS injection), email validation, password trimming
  - **UX fixes**: Logout error display, ARIA accessibility, clear error on input
  - **Async fixes**: Request timeout (30s), poll cancellation via AbortSignal, corrupted token file handling
- Fixed UXP import for browser dev mode (localStorage fallback)
- Fixed Vite config (root changed from `public` to `.`, added `index.html` at root)
- Fixed Lit class field shadowing (`useDefineForClassFields: false` in tsconfig)
- All 42 backend-client unit tests passing

### Stopped at
Dev server running at `http://localhost:3002/`, AuthPanel UI visible but needs manual testing of login/signup flow

## Next Steps

1. Test AuthPanel login/signup flow with live backend (port 3001)
2. Add logout option to Settings panel for logged-in users
3. Add file upload support for audio (S3 or similar)
4. Add job progress notifications (WebSocket or polling)

## Dev Server Commands

```bash
# Plugin (Vite) - runs on port 3000 (or 3002 if port in use)
npm run dev

# Backend - runs on port 3001
cd backend && npm run dev

# Health check
curl http://localhost:3001/health
```

## Backend Client API

```typescript
import { backendClient } from '@/utils/api/backend-client'

// Auth
backendClient.login(email, password)
backendClient.register(email, password, name?)
backendClient.logout()
backendClient.getMe()
backendClient.isAuthenticated()
backendClient.onAuthChange(callback) // returns unsubscribe fn

// Usage
backendClient.getUsage()
backendClient.checkUsageLimit(minutes)
backendClient.canSubmitAudioJob(minutes)

// Audio Jobs
backendClient.submitTranscription(audioUrl, durationMinutes)
backendClient.submitVocalIsolation(audioUrl, durationMinutes)
backendClient.getJobs(limit?, offset?)
backendClient.getJob(jobId)
backendClient.pollJobUntilComplete(jobId, onProgress?, {intervalMs?, maxAttempts?, signal?})

// Billing
backendClient.createCheckout(tier, interval?)
backendClient.createPortal()
backendClient.getBillingStatus()
```

## Key Fixes Applied This Session

| Area | Fix |
|------|-----|
| AuthPanel | `isMounted` flag prevents async writes on unmounted component |
| AuthPanel | `if (this.isLoading) return` prevents double-submission |
| AuthPanel | `getSafePlanClass()` validates plan enum before CSS class use |
| AuthPanel | ARIA roles for tabs, labels for inputs |
| backend-client | Refresh token mutex prevents concurrent refresh race condition |
| backend-client | `fetchWithTimeout()` with 30s default timeout |
| backend-client | `pollJobUntilComplete()` supports AbortSignal for cancellation |
| backend-client | localStorage fallback for browser dev mode (no UXP) |
| tsconfig | `useDefineForClassFields: false` fixes Lit decorator issue |
| vite.config | Root changed to `.` with `index.html` at project root |
