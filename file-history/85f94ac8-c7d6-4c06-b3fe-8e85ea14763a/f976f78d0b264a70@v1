# SPLICE Phase 6 - License Key Activation System

## Status
Phase 5 done. 187 tests passing. Security fixed. Referral system complete. License key activation needed.

## Key Files
```
splice-backend/server.js                    # Add /license/activate endpoint
splice-backend/services/usageTracking.js    # Has Stripe webhooks, user creation
splice-backend/services/referralService.js  # Reference for key generation pattern
splice-plugin/js/settings.js                # Login modal (change to license key input)
splice-plugin/index.html                    # Modal HTML (customerIdInput → licenseKeyInput)
splice-backend/tests/                       # Add phase6-license.test.js
```

## Tasks

### 1. License Key Service
Create `splice-backend/services/licenseService.js`:
- `license_keys` table: `key VARCHAR(19) UNIQUE, stripe_customer_id, created_at, activated_at, is_active`
- Key format: `SPLICE-XXXX-XXXX-XXXX` (alphanumeric, no confusing chars)
- `generateLicenseKey(stripeCustomerId)` - create key on purchase
- `activateLicenseKey(key)` - validate and return customer ID
- `getLicenseByCustomerId(customerId)` - lookup existing key

### 2. Stripe Webhook Integration
In `server.js` webhook handler (`customer.subscription.created`):
- Generate license key for new customer
- Store in database

### 3. Activation Endpoint
`POST /license/activate` - Body: `{ key: "SPLICE-XXXX-XXXX-XXXX" }`
- Validate key format
- Look up in database
- Return `{ success, customerId, tier, hoursRemaining }`

### 4. Plugin UI Update
In `settings.js` and `index.html`:
- Change "Customer ID" → "License Key"
- Update input validation (SPLICE-XXXX-XXXX-XXXX format)
- Call `/license/activate` instead of directly saving customer ID

## Testing Protocol

After EACH feature:
1. Create E2E test for the feature
2. Run: `node tests/phase6-license.test.js`
3. Check for bugs, bottlenecks (>5ms operations)
4. If bug found → fix → retest until perfect
5. Move to next feature

After ALL features:
1. Run ALL tests: `node tests/*.test.js`
2. Verify UI wiring (modal shows, validates, activates)
3. Check no regressions (187+ tests should pass)

## Commands
```bash
cd /Users/imorgado/SPLICE/splice-backend
node server.js
node tests/phase6-license.test.js
curl -sk https://127.0.0.1:3847/health
```
