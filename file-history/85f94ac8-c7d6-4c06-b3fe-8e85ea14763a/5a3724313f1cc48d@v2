/**
 * Phase 5: Referral System E2E Tests
 *
 * Tests for:
 * 1. Code generation - unique codes per user
 * 2. Code validation - valid/invalid/edge cases
 * 3. Code application - discount/credits
 * 4. Statistics - tracking referrals
 */

const path = require('path');
const fs = require('fs');

// =============================================================================
// TEST FRAMEWORK
// =============================================================================

let passCount = 0;
let failCount = 0;

function test(name, fn) {
  try {
    const result = fn();
    if (result instanceof Promise) {
      return result.then(() => {
        passCount++;
        console.log(`  ✓ ${name}`);
      }).catch(err => {
        failCount++;
        console.log(`  ✗ ${name}`);
        console.log(`    Error: ${err.message}`);
      });
    }
    passCount++;
    console.log(`  ✓ ${name}`);
  } catch (err) {
    failCount++;
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
  }
}

async function asyncTest(name, fn) {
  try {
    await fn();
    passCount++;
    console.log(`  ✓ ${name}`);
  } catch (err) {
    failCount++;
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
  }
}

function assertEqual(actual, expected, message = '') {
  if (actual !== expected) {
    throw new Error(`${message}: Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
  }
}

function assertTrue(condition, message = '') {
  if (!condition) {
    throw new Error(`${message}: Expected true, got false`);
  }
}

function assertFalse(condition, message = '') {
  if (condition) {
    throw new Error(`${message}: Expected false, got true`);
  }
}

// =============================================================================
// REFERRAL SERVICE TESTS
// =============================================================================

console.log('\n=== Phase 5: Referral System E2E Tests ===\n');

// Import the referral service
const referralService = require('../services/referralService');

console.log('1. Code Generation Tests');

test('generateCode should create SPLICE-XXXXXX format', () => {
  const code = referralService.generateCode();
  assertTrue(code.startsWith('SPLICE-'), 'Code should start with SPLICE-');
  assertEqual(code.length, 13, 'Code length should be 13 (SPLICE- + 6 chars)');
});

test('generateCode should use alphanumeric chars only', () => {
  const code = referralService.generateCode();
  const suffix = code.split('-')[1];
  assertTrue(/^[A-Z0-9]+$/.test(suffix), 'Suffix should be alphanumeric');
});

test('generateCode should not use confusing chars (O, I, 0, 1)', () => {
  // Generate many codes and check none have confusing chars
  // The allowed set is: ABCDEFGHJKLMNPQRSTUVWXYZ23456789 (excludes O, I, 0, 1)
  const allowedChars = /^[ABCDEFGHJKLMNPQRSTUVWXYZ23456789]+$/;
  for (let i = 0; i < 100; i++) {
    const code = referralService.generateCode();
    const suffix = code.split('-')[1];
    assertTrue(allowedChars.test(suffix), `Should only contain allowed chars, got: ${suffix}`);
  }
});

test('generateCode should be unique across calls', () => {
  const codes = new Set();
  for (let i = 0; i < 100; i++) {
    codes.add(referralService.generateCode());
  }
  assertEqual(codes.size, 100, 'All 100 codes should be unique');
});

console.log('\n2. Default Values Tests');

test('should have default referee discount of 10%', () => {
  assertEqual(referralService.DEFAULT_REFEREE_DISCOUNT, 10, 'Referee discount');
});

test('should have default referrer credit of 1 hour', () => {
  assertEqual(referralService.DEFAULT_REFERRER_CREDIT, 1.0, 'Referrer credit');
});

console.log('\n3. Server Endpoint Verification Tests');

// Read server.js to verify endpoints are registered
const serverSource = fs.readFileSync(path.join(__dirname, '../server.js'), 'utf8');

test('server should have GET /referral/code endpoint', () => {
  assertTrue(serverSource.includes("app.get('/referral/code'"), 'Should have /referral/code');
});

test('server should have POST /referral/validate endpoint', () => {
  assertTrue(serverSource.includes("app.post('/referral/validate'"), 'Should have /referral/validate');
});

test('server should have POST /referral/apply endpoint', () => {
  assertTrue(serverSource.includes("app.post('/referral/apply'"), 'Should have /referral/apply');
});

test('server should have GET /referral/stats endpoint', () => {
  assertTrue(serverSource.includes("app.get('/referral/stats'"), 'Should have /referral/stats');
});

test('server should initialize referral tables on startup', () => {
  assertTrue(serverSource.includes('initReferralTables'), 'Should initialize referral tables');
});

console.log('\n4. Referral Service Function Tests');

// Read referralService.js to verify functions are exported
const referralSource = fs.readFileSync(path.join(__dirname, '../services/referralService.js'), 'utf8');

test('should export getOrCreateCode function', () => {
  assertTrue(typeof referralService.getOrCreateCode === 'function', 'Should export getOrCreateCode');
});

test('should export validateCode function', () => {
  assertTrue(typeof referralService.validateCode === 'function', 'Should export validateCode');
});

test('should export applyCode function', () => {
  assertTrue(typeof referralService.applyCode === 'function', 'Should export applyCode');
});

test('should export getStats function', () => {
  assertTrue(typeof referralService.getStats === 'function', 'Should export getStats');
});

test('should export initReferralTables function', () => {
  assertTrue(typeof referralService.initReferralTables === 'function', 'Should export initReferralTables');
});

test('should export awardReferrerCredit function', () => {
  assertTrue(typeof referralService.awardReferrerCredit === 'function', 'Should export awardReferrerCredit');
});

test('should export hasUsedReferralCode function', () => {
  assertTrue(typeof referralService.hasUsedReferralCode === 'function', 'Should export hasUsedReferralCode');
});

console.log('\n5. Database Schema Tests');

test('should create referral_codes table', () => {
  assertTrue(referralSource.includes('CREATE TABLE IF NOT EXISTS referral_codes'), 'Should create referral_codes table');
});

test('referral_codes should have required columns', () => {
  assertTrue(referralSource.includes('code VARCHAR(12) UNIQUE NOT NULL'), 'Should have code column');
  assertTrue(referralSource.includes('owner_customer_id VARCHAR(255) NOT NULL'), 'Should have owner column');
  assertTrue(referralSource.includes('referee_discount_percent INTEGER'), 'Should have discount column');
  assertTrue(referralSource.includes('referrer_credit_hours DECIMAL'), 'Should have credit column');
  assertTrue(referralSource.includes('times_used INTEGER'), 'Should have times_used column');
  assertTrue(referralSource.includes('is_active BOOLEAN'), 'Should have is_active column');
});

test('should create referral_uses table', () => {
  assertTrue(referralSource.includes('CREATE TABLE IF NOT EXISTS referral_uses'), 'Should create referral_uses table');
});

test('referral_uses should have required columns', () => {
  assertTrue(referralSource.includes('referee_customer_id VARCHAR(255) NOT NULL'), 'Should have referee column');
  assertTrue(referralSource.includes('credit_awarded BOOLEAN'), 'Should have credit_awarded column');
  assertTrue(referralSource.includes('stripe_coupon_id VARCHAR(255)'), 'Should have stripe_coupon_id column');
});

test('should create indexes for referral tables', () => {
  assertTrue(referralSource.includes('idx_referral_codes_owner'), 'Should index owner');
  assertTrue(referralSource.includes('idx_referral_codes_code'), 'Should index code');
  assertTrue(referralSource.includes('idx_referral_uses_code'), 'Should index code_id');
  assertTrue(referralSource.includes('idx_referral_uses_referee'), 'Should index referee');
});

console.log('\n6. Validation Logic Tests');

test('validateCode should handle null code', async () => {
  const result = await referralService.validateCode(null);
  assertFalse(result.valid, 'Should be invalid');
  assertEqual(result.error, 'Invalid code format', 'Should have format error');
});

test('validateCode should handle empty string', async () => {
  const result = await referralService.validateCode('');
  assertFalse(result.valid, 'Should be invalid');
});

test('validateCode should handle non-string', async () => {
  const result = await referralService.validateCode(123);
  assertFalse(result.valid, 'Should be invalid for number');
});

console.log('\n7. Endpoint Auth Tests');

test('GET /referral/code should require x-stripe-customer-id', () => {
  assertTrue(
    serverSource.includes("app.get('/referral/code'") &&
    serverSource.includes("req.headers['x-stripe-customer-id']"),
    'Should check for customer ID header'
  );
});

test('GET /referral/stats should require x-stripe-customer-id', () => {
  assertTrue(
    serverSource.includes("app.get('/referral/stats'") &&
    serverSource.includes("req.headers['x-stripe-customer-id']"),
    'Should check for customer ID header'
  );
});

test('POST /referral/validate should accept code in body', () => {
  assertTrue(
    serverSource.includes("const { code, customerId } = req.body"),
    'Should extract code from body'
  );
});

test('POST /referral/apply should require code and customerId', () => {
  assertTrue(
    serverSource.includes("if (!code || !customerId)"),
    'Should validate required fields'
  );
});

console.log('\n8. Error Handling Tests');

test('apply endpoint should return user-friendly errors', () => {
  assertTrue(
    serverSource.includes("Cannot use your own") &&
    serverSource.includes("already used") &&
    serverSource.includes("not found"),
    'Should handle validation errors gracefully'
  );
});

console.log('\n9. API Documentation Tests');

test('API root should list referral endpoints', () => {
  assertTrue(serverSource.includes("'GET /referral/code'"), 'Should document /referral/code');
  assertTrue(serverSource.includes("'POST /referral/validate'"), 'Should document /referral/validate');
  assertTrue(serverSource.includes("'POST /referral/apply'"), 'Should document /referral/apply');
  assertTrue(serverSource.includes("'GET /referral/stats'"), 'Should document /referral/stats');
});

// =============================================================================
// SUMMARY
// =============================================================================

console.log('\n=== Test Summary ===');
console.log(`  Passed: ${passCount}`);
console.log(`  Failed: ${failCount}`);
console.log(`  Total: ${passCount + failCount}`);

if (failCount > 0) {
  console.log('\n❌ Some tests failed');
  process.exit(1);
} else {
  console.log('\n✓ All Phase 5 Referral tests passed');
  process.exit(0);
}
