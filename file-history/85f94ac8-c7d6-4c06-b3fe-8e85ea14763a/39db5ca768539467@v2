# SPLICE Phase 5 - Security + Referral System

## Status
Phase 4 done. 177 tests passing. Billing wired. Critical security issues found.

## Key Files
```
splice-backend/server.js          # All endpoints, rate limiting
splice-backend/services/usageTracking.js   # Billing, credits
splice-backend/services/ffprobeSilence.js  # Command injection risk
splice-backend/services/rmsSilenceDetection.js  # Path traversal risk
splice-backend/middleware/rateLimiter.js   # Auth middleware
splice-plugin/js/main.js          # UI orchestration
splice-plugin/js/settings.js      # Login, presets, customer ID
splice-backend/tests/             # All test files
```

## Tasks (Priority Order)

### 1. CRITICAL: Security Fixes
- **Path Traversal**: Validate all `wavPath`, `xmlPath`, `audioPath` params against allowed directories
- **Command Injection**: Use `execFile` with array args instead of string interpolation in ffprobe/ffmpeg calls
- **Auth Verification**: Verify `x-stripe-customer-id` header against Stripe API, not just trust it

### 2. HIGH: DB Performance
- Add pool limits to `usageTracking.js:10-14`: `max: 20, idleTimeoutMillis: 30000`
- Add missing index: `CREATE INDEX idx_usage_log_customer_created ON usage_log(stripe_customer_id, created_at DESC)`
- Fix sync `fs.readFileSync` in `multitrackAnalysis.js:196` → use `fs.promises.readFile`

### 3. MEDIUM: Referral Code System
```sql
CREATE TABLE referral_codes (
  id SERIAL PRIMARY KEY,
  code VARCHAR(12) UNIQUE NOT NULL,
  owner_customer_id VARCHAR(255) NOT NULL,
  referee_discount_percent INTEGER DEFAULT 10,
  referrer_credit_hours DECIMAL(10,2) DEFAULT 1.0,
  times_used INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

Endpoints needed:
- `GET /referral/code` - Get/create user's code
- `POST /referral/validate` - Validate code, return discount
- `POST /referral/apply` - Apply code at signup, create Stripe coupon
- `GET /referral/stats` - User's referral stats

## Testing Protocol

After EACH feature:
1. Create E2E test for the feature
2. Run: `node tests/[test-file].test.js`
3. Check for bottlenecks (>5ms operations)
4. If bug found → fix → retest until perfect
5. Move to next feature

After ALL features:
1. Run ALL tests: `node tests/*.test.js`
2. Run comprehensive E2E validation
3. Check UI wiring and UX flow
4. Verify no regressions

## Commands
```bash
cd /Users/imorgado/SPLICE/splice-backend
node server.js                           # Start server
node tests/phase4-production.test.js     # Phase 4 tests
node tests/custom-presets.test.js        # Preset tests
curl -sk https://127.0.0.1:3847/health   # Health check
```
