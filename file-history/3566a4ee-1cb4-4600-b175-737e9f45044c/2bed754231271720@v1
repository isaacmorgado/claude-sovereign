/**
 * Credits Display Module
 *
 * Fetches and displays user's remaining hours from the billing backend.
 * Requires customerId to be set in settings.
 */

// Production backend URL (Railway deployment)
const CREDITS_BACKEND_URL = 'https://splice-api-production.up.railway.app';

/**
 * Fetch user's credit balance from backend
 * @returns {Promise<{hoursRemaining: number, tierName: string, hoursTotal: number} | null>}
 */
async function fetchCredits() {
  const settings = getSettings();
  const customerId = settings.customerId;

  if (!customerId) {
    console.log('[SPLICE] No customerId configured - credits display disabled');
    return null;
  }

  try {
    const response = await fetch(`${CREDITS_BACKEND_URL}/credits`, {
      method: 'GET',
      headers: {
        'x-stripe-customer-id': customerId
      }
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      console.error('[SPLICE] Credits fetch failed:', err.error || response.status);
      return null;
    }

    const data = await response.json();
    return {
      hoursRemaining: data.hoursRemaining || 0,
      tierName: data.tierName || 'Free',
      hoursTotal: data.hoursTotal || 0
    };
  } catch (err) {
    console.error('[SPLICE] Credits fetch error:', err);
    return null;
  }
}

/**
 * Update the credit display in the UI
 * @param {Object|null} credits - Credit data or null if unavailable
 */
function updateCreditDisplay(credits) {
  const creditBadge = document.getElementById('creditBadge');
  if (!creditBadge) return;

  if (!credits) {
    creditBadge.style.display = 'none';
    return;
  }

  creditBadge.style.display = 'flex';
  creditBadge.textContent = `${credits.hoursRemaining.toFixed(1)} hrs`;
  creditBadge.title = `${credits.tierName}: ${credits.hoursRemaining.toFixed(1)} / ${credits.hoursTotal} hours remaining`;

  // Color based on remaining hours
  if (credits.hoursRemaining <= 1) {
    creditBadge.classList.add('low');
    creditBadge.classList.remove('ok');
  } else {
    creditBadge.classList.add('ok');
    creditBadge.classList.remove('low');
  }
}

/**
 * Initialize credits display
 * Fetches credits on load and sets up periodic refresh
 */
async function initCredits() {
  // Initial fetch
  const credits = await fetchCredits();
  updateCreditDisplay(credits);

  // Refresh credits every 5 minutes
  setInterval(async () => {
    const refreshedCredits = await fetchCredits();
    updateCreditDisplay(refreshedCredits);
  }, 5 * 60 * 1000);
}

/**
 * Manually refresh credits (e.g., after a processing operation)
 */
async function refreshCredits() {
  const credits = await fetchCredits();
  updateCreditDisplay(credits);
  return credits;
}
