/**
 * Music Module E2E Tests for CEP Plugin
 * Tests AI Music Generation, Song Identification, Library Management
 * Phase 8 features: Mureka API, ACRCloud, Beat Alignment, Timeline
 */

const fs = require('fs');
const path = require('path');

// Test configuration
const CEP_ROOT = path.join(__dirname, '..');
const PANEL_ROOT = path.join(CEP_ROOT, 'panel');
const JS_ROOT = path.join(PANEL_ROOT, 'js');

// Test results tracking
let passed = 0;
let failed = 0;
const failures = [];

function test(description, fn) {
    try {
        fn();
        passed++;
        console.log(`  âœ“ ${description}`);
    } catch (error) {
        failed++;
        failures.push({ description, error: error.message });
        console.log(`  âœ— ${description}`);
        console.log(`    Error: ${error.message}`);
    }
}

function assertEqual(actual, expected, message) {
    if (actual !== expected) {
        throw new Error(`${message}: expected ${expected}, got ${actual}`);
    }
}

function assertTrue(condition, message) {
    if (!condition) {
        throw new Error(message || 'Assertion failed');
    }
}

function assertContains(text, substring, message) {
    if (!text.includes(substring)) {
        throw new Error(`${message}: "${substring}" not found in text`);
    }
}

function assertNotContains(text, substring, message) {
    if (text.includes(substring)) {
        throw new Error(`${message}: "${substring}" should not be in text`);
    }
}

// ============================================================================
// FILE STRUCTURE TESTS
// ============================================================================
console.log('\nðŸ“ File Structure Tests');

test('music.js exists in panel/js/', () => {
    const filePath = path.join(JS_ROOT, 'music.js');
    assertTrue(fs.existsSync(filePath), 'music.js not found');
});

test('music.js has substantial content (>500 lines)', () => {
    const content = fs.readFileSync(path.join(JS_ROOT, 'music.js'), 'utf8');
    const lines = content.split('\n').length;
    assertTrue(lines > 500, `Expected >500 lines, got ${lines}`);
});

// ============================================================================
// HTML STRUCTURE TESTS
// ============================================================================
console.log('\nðŸ—ï¸ HTML Structure Tests');

const html = fs.readFileSync(path.join(PANEL_ROOT, 'index.html'), 'utf8');

test('Music section exists', () => {
    assertContains(html, 'id="musicSection"', 'Music section not found');
});

test('Music toggle exists', () => {
    assertContains(html, 'id="musicToggle"', 'Music toggle not found');
});

test('Music panel exists', () => {
    assertContains(html, 'id="music-panel"', 'Music panel not found');
});

test('Music credits badge exists', () => {
    assertContains(html, 'id="music-credits-badge"', 'Music credits badge not found');
});

test('Music tabs exist (Generate, Identify, Library)', () => {
    assertContains(html, 'data-tab="generate"', 'Generate tab not found');
    assertContains(html, 'data-tab="identify"', 'Identify tab not found');
    assertContains(html, 'data-tab="library"', 'Library tab not found');
});

test('Generate tab content exists', () => {
    assertContains(html, 'id="music-tab-generate"', 'Generate tab content not found');
});

test('Identify tab content exists', () => {
    assertContains(html, 'id="music-tab-identify"', 'Identify tab content not found');
});

test('Library tab content exists', () => {
    assertContains(html, 'id="music-tab-library"', 'Library tab content not found');
});

test('Mood selector exists', () => {
    assertContains(html, 'id="music-mood-selector"', 'Mood selector not found');
});

test('Instrument selector exists', () => {
    assertContains(html, 'id="music-instrument-selector"', 'Instrument selector not found');
});

test('Duration slider exists', () => {
    assertContains(html, 'id="music-duration-slider"', 'Duration slider not found');
});

test('Custom prompt textarea exists', () => {
    assertContains(html, 'id="music-custom-prompt"', 'Custom prompt textarea not found');
});

test('Scene-aware checkbox exists', () => {
    assertContains(html, 'id="music-scene-aware"', 'Scene-aware checkbox not found');
});

test('Variations checkbox exists', () => {
    assertContains(html, 'id="music-variations"', 'Variations checkbox not found');
});

test('Generate button exists', () => {
    assertContains(html, 'id="music-generate-btn"', 'Generate button not found');
});

test('Timeline button exists', () => {
    assertContains(html, 'id="music-timeline-btn"', 'Timeline button not found');
});

test('YouTube URL input exists', () => {
    assertContains(html, 'id="music-youtube-url"', 'YouTube URL input not found');
});

test('Identify button exists', () => {
    assertContains(html, 'id="music-identify-btn"', 'Identify button not found');
});

test('Identify result container exists', () => {
    assertContains(html, 'id="music-identify-result"', 'Identify result container not found');
});

test('Library list exists', () => {
    assertContains(html, 'id="music-library-list"', 'Library list not found');
});

test('Music status element exists', () => {
    assertContains(html, 'id="music-status"', 'Music status not found');
});

test('Music progress container exists', () => {
    assertContains(html, 'id="music-progress"', 'Music progress not found');
});

test('Music progress bar exists', () => {
    assertContains(html, 'id="music-progress-bar"', 'Music progress bar not found');
});

test('Variations panel exists', () => {
    assertContains(html, 'id="music-variations-panel"', 'Variations panel not found');
});

test('Variations list exists', () => {
    assertContains(html, 'id="music-variations-list"', 'Variations list not found');
});

test('Audio preview panel exists', () => {
    assertContains(html, 'id="music-preview"', 'Audio preview not found');
});

test('Audio player exists', () => {
    assertContains(html, 'id="music-audio-player"', 'Audio player not found');
});

test('Download button exists', () => {
    assertContains(html, 'id="music-download-btn"', 'Download button not found');
});

test('Import button exists', () => {
    assertContains(html, 'id="music-import-btn"', 'Import button not found');
});

test('Align modal exists', () => {
    assertContains(html, 'id="music-align-modal"', 'Align modal not found');
});

test('Align target input exists', () => {
    assertContains(html, 'id="music-align-target"', 'Align target input not found');
});

test('Match sequence button exists', () => {
    assertContains(html, 'id="music-align-match-seq"', 'Match sequence button not found');
});

test('Fade slider exists', () => {
    assertContains(html, 'id="music-fade-slider"', 'Fade slider not found');
});

test('Beat align checkbox exists', () => {
    assertContains(html, 'id="music-beat-align"', 'Beat align checkbox not found');
});

test('Align button exists', () => {
    assertContains(html, 'id="music-align-btn"', 'Align button not found');
});

test('Timeline modal exists', () => {
    assertContains(html, 'id="music-timeline-modal"', 'Timeline modal not found');
});

test('Timeline max chapters input exists', () => {
    assertContains(html, 'id="music-timeline-max-chapters"', 'Max chapters input not found');
});

test('Timeline min length input exists', () => {
    assertContains(html, 'id="music-timeline-min-length"', 'Min length input not found');
});

test('Crossfade slider exists', () => {
    assertContains(html, 'id="music-crossfade-slider"', 'Crossfade slider not found');
});

test('Timeline generate button exists', () => {
    assertContains(html, 'id="music-timeline-generate-btn"', 'Timeline generate button not found');
});

test('music.js script tag exists', () => {
    assertContains(html, 'src="js/music.js"', 'music.js script tag not found');
});

test('music.js loads before main.js', () => {
    const musicIndex = html.indexOf('src="js/music.js"');
    const mainIndex = html.indexOf('src="js/main.js"');
    assertTrue(musicIndex < mainIndex, 'music.js should load before main.js');
});

// ============================================================================
// CSS TESTS
// ============================================================================
console.log('\nðŸŽ¨ CSS Tests');

const css = fs.readFileSync(path.join(PANEL_ROOT, 'css', 'style.css'), 'utf8');

test('Music section styles exist', () => {
    assertContains(css, '.music-section', 'Music section styles not found');
});

test('Music panel styles exist', () => {
    assertContains(css, '.music-panel', 'Music panel styles not found');
});

test('Music tabs styles exist', () => {
    assertContains(css, '.music-tabs', 'Music tabs styles not found');
});

test('Music tab styles exist', () => {
    assertContains(css, '.music-tab', 'Music tab styles not found');
});

test('Music tab active state exists', () => {
    assertContains(css, '.music-tab.active', 'Music tab active state not found');
});

test('Mood selector styles exist', () => {
    assertContains(css, '.music-mood-selector', 'Mood selector styles not found');
});

test('Mood button styles exist', () => {
    assertContains(css, '.music-mood-btn', 'Mood button styles not found');
});

test('Instrument selector styles exist', () => {
    assertContains(css, '.music-instrument-selector', 'Instrument selector styles not found');
});

test('Instrument button styles exist', () => {
    assertContains(css, '.music-instrument-btn', 'Instrument button styles not found');
});

test('Custom prompt styles exist', () => {
    assertContains(css, '.music-custom-prompt', 'Custom prompt styles not found');
});

test('Music library styles exist', () => {
    assertContains(css, '.music-library-list', 'Music library styles not found');
});

test('Library item styles exist', () => {
    assertContains(css, '.music-library-item', 'Library item styles not found');
});

test('Music status styles exist', () => {
    assertContains(css, '.music-status', 'Music status styles not found');
});

test('Music progress styles exist', () => {
    assertContains(css, '.music-progress', 'Music progress styles not found');
});

test('Music progress bar styles exist', () => {
    assertContains(css, '.music-progress-bar', 'Music progress bar styles not found');
});

test('Variations panel styles exist', () => {
    assertContains(css, '.music-variations-panel', 'Variations panel styles not found');
});

test('Variation card styles exist', () => {
    assertContains(css, '.music-variation-card', 'Variation card styles not found');
});

test('Music preview styles exist', () => {
    assertContains(css, '.music-preview', 'Music preview styles not found');
});

test('Align modal styles exist', () => {
    assertContains(css, '.music-align-modal', 'Align modal styles not found');
});

test('Timeline modal styles exist', () => {
    assertContains(css, '.music-timeline-modal', 'Timeline modal styles not found');
});

test('Music credits badge styles exist', () => {
    assertContains(css, '.music-credits-badge', 'Music credits badge styles not found');
});

test('Mood icons defined via CSS', () => {
    assertContains(css, 'data-mood="upbeat"', 'Mood icons not defined');
});

// ============================================================================
// JAVASCRIPT STRUCTURE TESTS
// ============================================================================
console.log('\nðŸ“œ JavaScript Structure Tests');

const musicJs = fs.readFileSync(path.join(JS_ROOT, 'music.js'), 'utf8');

test('Has file header comment', () => {
    assertContains(musicJs, 'SPLICE CEP', 'Missing file header');
});

test('Has MOOD_PRESETS constant', () => {
    assertContains(musicJs, 'MOOD_PRESETS', 'MOOD_PRESETS constant not found');
});

test('Has INSTRUMENT_PRESETS constant', () => {
    assertContains(musicJs, 'INSTRUMENT_PRESETS', 'INSTRUMENT_PRESETS constant not found');
});

test('Has all mood presets defined', () => {
    const moods = ['upbeat', 'dramatic', 'chill', 'energetic', 'mysterious',
                   'romantic', 'epic', 'playful', 'melancholic', 'peaceful'];
    for (const mood of moods) {
        assertContains(musicJs, `'${mood}'`, `Mood preset ${mood} not found`);
    }
});

test('Has all instrument presets defined', () => {
    const instruments = ['full-band', 'acoustic', 'electronic', 'orchestral',
                        'piano-only', 'guitar-only', 'ambient', 'minimal'];
    for (const inst of instruments) {
        assertContains(musicJs, `'${inst}'`, `Instrument preset ${inst} not found`);
    }
});

test('Has initMusicModule function', () => {
    assertContains(musicJs, 'function initMusicModule', 'initMusicModule function not found');
});

test('Has cacheElements function', () => {
    assertContains(musicJs, 'function cacheElements', 'cacheElements function not found');
});

test('Has initTabHandlers function', () => {
    assertContains(musicJs, 'function initTabHandlers', 'initTabHandlers function not found');
});

test('Has initMoodSelector function', () => {
    assertContains(musicJs, 'function initMoodSelector', 'initMoodSelector function not found');
});

test('Has initInstrumentSelector function', () => {
    assertContains(musicJs, 'function initInstrumentSelector', 'initInstrumentSelector function not found');
});

test('Has identifySong function', () => {
    assertContains(musicJs, 'function identifySong', 'identifySong function not found');
});

test('Has generateMusic function', () => {
    assertContains(musicJs, 'function generateMusic', 'generateMusic function not found');
});

test('Has generateVariations function', () => {
    assertContains(musicJs, 'function generateVariations', 'generateVariations function not found');
});

test('Has generateSceneAware function', () => {
    assertContains(musicJs, 'function generateSceneAware', 'generateSceneAware function not found');
});

test('Has loadMusicLibrary function', () => {
    assertContains(musicJs, 'function loadMusicLibrary', 'loadMusicLibrary function not found');
});

test('Has renderLibraryItem function', () => {
    assertContains(musicJs, 'function renderLibraryItem', 'renderLibraryItem function not found');
});

test('Has previewMusic function', () => {
    assertContains(musicJs, 'function previewMusic', 'previewMusic function not found');
});

test('Has downloadMusic function', () => {
    assertContains(musicJs, 'function downloadMusic', 'downloadMusic function not found');
});

test('Has deleteMusic function', () => {
    assertContains(musicJs, 'function deleteMusic', 'deleteMusic function not found');
});

test('Has importToTimeline function', () => {
    assertContains(musicJs, 'function importToTimeline', 'importToTimeline function not found');
});

test('Has showAlignModal function', () => {
    assertContains(musicJs, 'function showAlignModal', 'showAlignModal function not found');
});

test('Has alignMusic function', () => {
    assertContains(musicJs, 'function alignMusic', 'alignMusic function not found');
});

test('Has showTimelineModal function', () => {
    assertContains(musicJs, 'function showTimelineModal', 'showTimelineModal function not found');
});

test('Has generateTimelineMusic function', () => {
    assertContains(musicJs, 'function generateTimelineMusic', 'generateTimelineMusic function not found');
});

test('Has pollJobStatus function', () => {
    assertContains(musicJs, 'function pollJobStatus', 'pollJobStatus function not found');
});

test('Has updateMusicCredits function', () => {
    assertContains(musicJs, 'function updateMusicCredits', 'updateMusicCredits function not found');
});

test('Has showMusicProgress function', () => {
    assertContains(musicJs, 'function showMusicProgress', 'showMusicProgress function not found');
});

test('Has hideMusicProgress function', () => {
    assertContains(musicJs, 'function hideMusicProgress', 'hideMusicProgress function not found');
});

test('Has setMusicStatus function', () => {
    assertContains(musicJs, 'function setMusicStatus', 'setMusicStatus function not found');
});

test('Has formatDuration function', () => {
    assertContains(musicJs, 'function formatDuration', 'formatDuration function not found');
});

// ============================================================================
// API INTEGRATION TESTS
// ============================================================================
console.log('\nðŸ”Œ API Integration Tests');

test('Uses /music/identify endpoint', () => {
    assertContains(musicJs, '/music/identify', '/music/identify endpoint not found');
});

test('Uses /music/generate endpoint', () => {
    assertContains(musicJs, '/music/generate', '/music/generate endpoint not found');
});

test('Uses /music/status endpoint', () => {
    assertContains(musicJs, '/music/status', '/music/status endpoint not found');
});

test('Uses /music/library endpoint', () => {
    assertContains(musicJs, '/music/library', '/music/library endpoint not found');
});

test('Uses /music/credits endpoint', () => {
    assertContains(musicJs, '/music/credits', '/music/credits endpoint not found');
});

test('Uses /music/generate-variations endpoint', () => {
    assertContains(musicJs, '/music/generate-variations', '/music/generate-variations endpoint not found');
});

test('Uses /music/variations/status endpoint', () => {
    assertContains(musicJs, '/music/variations/status', '/music/variations/status endpoint not found');
});

test('Uses /music/variations select endpoint', () => {
    assertContains(musicJs, '/select', 'Variations select endpoint not found');
});

test('Uses /music/generate-scene-aware endpoint', () => {
    assertContains(musicJs, '/music/generate-scene-aware', '/music/generate-scene-aware endpoint not found');
});

test('Uses /music/align endpoint', () => {
    assertContains(musicJs, '/music/align', '/music/align endpoint not found');
});

test('Uses /music/analyze-beats endpoint', () => {
    assertContains(musicJs, '/music/analyze-beats', '/music/analyze-beats endpoint not found');
});

test('Uses /music/generate-timeline endpoint', () => {
    assertContains(musicJs, '/music/generate-timeline', '/music/generate-timeline endpoint not found');
});

test('Uses getBackendUrl() for API calls', () => {
    assertContains(musicJs, 'getBackendUrl()', 'getBackendUrl() not used');
});

test('Uses getAuthHeaders() for authenticated requests', () => {
    assertContains(musicJs, 'getAuthHeaders()', 'getAuthHeaders() not used');
});

test('Uses fetchWithTimeout() for requests', () => {
    assertContains(musicJs, 'fetchWithTimeout(', 'fetchWithTimeout() not used');
});

test('Uses parseErrorResponse() for error handling', () => {
    assertContains(musicJs, 'parseErrorResponse(', 'parseErrorResponse() not used');
});

// ============================================================================
// CEP PATTERN TESTS
// ============================================================================
console.log('\nðŸ”§ CEP Pattern Tests');

test('Does not use require() for UXP', () => {
    assertNotContains(musicJs, "require('uxp')", 'Should not use UXP require');
    assertNotContains(musicJs, "require('premierepro')", 'Should not use Premiere Pro require');
});

test('Uses jsx.call for Premiere Pro operations', () => {
    assertContains(musicJs, 'jsx.call(', 'Should use jsx.call for Premiere Pro operations');
});

test('Uses DOM caching pattern', () => {
    assertContains(musicJs, 'const elements = {}', 'Should use DOM caching pattern');
});

test('Uses event delegation pattern', () => {
    assertContains(musicJs, 'addEventListener', 'Should use addEventListener');
});

test('Exports via window object', () => {
    assertContains(musicJs, 'window.musicModule', 'Should export via window.musicModule');
});

test('Has proper error handling', () => {
    assertContains(musicJs, 'try {', 'Should have try-catch blocks');
    assertContains(musicJs, 'catch', 'Should have catch blocks');
});

// ============================================================================
// STATE MANAGEMENT TESTS
// ============================================================================
console.log('\nðŸ“Š State Management Tests');

test('Has state object', () => {
    assertContains(musicJs, 'const state = {', 'State object not found');
});

test('Tracks selected mood', () => {
    assertContains(musicJs, 'selectedMood', 'selectedMood state not found');
});

test('Tracks selected instrument', () => {
    assertContains(musicJs, 'selectedInstrument', 'selectedInstrument state not found');
});

test('Tracks current job', () => {
    assertContains(musicJs, 'currentJobId', 'currentJobId state not found');
});

test('Tracks library items', () => {
    assertContains(musicJs, 'libraryItems', 'libraryItems state not found');
});

test('Tracks preview state', () => {
    assertContains(musicJs, 'isPlaying', 'isPlaying state not found');
});

// ============================================================================
// MAIN.JS INTEGRATION TESTS
// ============================================================================
console.log('\nðŸ”— main.js Integration Tests');

const mainJs = fs.readFileSync(path.join(JS_ROOT, 'main.js'), 'utf8');

test('main.js initializes music module', () => {
    assertContains(mainJs, 'initMusicModule', 'Music module initialization not found');
});

test('main.js has music toggle initialization', () => {
    assertContains(mainJs, 'initMusicToggle', 'Music toggle initialization not found');
});

test('initMusicToggle function exists', () => {
    assertContains(mainJs, 'function initMusicToggle', 'initMusicToggle function not found');
});

// ============================================================================
// MUSIC GENERATION FLOW TESTS
// ============================================================================
console.log('\nðŸŽµ Music Generation Flow Tests');

test('Generate button handler exists', () => {
    assertContains(musicJs, 'music-generate-btn', 'Generate button handler not found');
});

test('Validates mood selection', () => {
    assertContains(musicJs, 'selectedMood', 'Mood validation not found');
});

test('Validates instrument selection', () => {
    assertContains(musicJs, 'selectedInstrument', 'Instrument validation not found');
});

test('Gets duration from slider', () => {
    assertContains(musicJs, 'music-duration-slider', 'Duration slider access not found');
});

test('Gets custom prompt', () => {
    assertContains(musicJs, 'music-custom-prompt', 'Custom prompt access not found');
});

test('Handles scene-aware option', () => {
    assertContains(musicJs, 'music-scene-aware', 'Scene-aware option handling not found');
});

test('Handles variations option', () => {
    assertContains(musicJs, 'music-variations', 'Variations option handling not found');
});

test('Shows progress during generation', () => {
    assertContains(musicJs, 'showMusicProgress', 'Progress display not found');
});

test('Polls job status', () => {
    assertContains(musicJs, 'pollJobStatus', 'Job status polling not found');
});

test('Updates progress from poll', () => {
    assertContains(musicJs, 'progress', 'Progress update not found');
});

// ============================================================================
// SONG IDENTIFICATION TESTS
// ============================================================================
console.log('\nðŸ” Song Identification Tests');

test('YouTube URL validation exists', () => {
    assertContains(musicJs, 'youtube', 'YouTube validation not found');
});

test('Identify button handler exists', () => {
    assertContains(musicJs, 'music-identify-btn', 'Identify button handler not found');
});

test('Displays identification results', () => {
    assertContains(musicJs, 'music-identify-result', 'Identification results display not found');
});

// ============================================================================
// LIBRARY MANAGEMENT TESTS
// ============================================================================
console.log('\nðŸ“š Library Management Tests');

test('Library loads on tab switch', () => {
    assertContains(musicJs, 'loadMusicLibrary', 'Library loading not found');
});

test('Library items are rendered', () => {
    assertContains(musicJs, 'renderLibraryItem', 'Library item rendering not found');
});

test('Library has preview functionality', () => {
    assertContains(musicJs, 'previewMusic', 'Preview functionality not found');
});

test('Library has delete functionality', () => {
    assertContains(musicJs, 'deleteMusic', 'Delete functionality not found');
});

test('Library has download functionality', () => {
    assertContains(musicJs, 'downloadMusic', 'Download functionality not found');
});

test('Library has align functionality', () => {
    assertContains(musicJs, 'showAlignModal', 'Align functionality not found');
});

// ============================================================================
// VARIATIONS TESTS
// ============================================================================
console.log('\nðŸŽ­ Variations Tests');

test('Variations panel display', () => {
    assertContains(musicJs, 'music-variations-panel', 'Variations panel not found');
});

test('Variations list rendering', () => {
    assertContains(musicJs, 'music-variations-list', 'Variations list rendering not found');
});

test('Variation selection handling', () => {
    assertContains(musicJs, 'selectVariation', 'Variation selection not found');
});

test('Variation preview functionality', () => {
    assertContains(musicJs, 'variationUrl', 'Variation preview not found');
});

// ============================================================================
// ALIGNMENT TESTS
// ============================================================================
console.log('\nâš¡ Alignment Tests');

test('Align modal display', () => {
    assertContains(musicJs, 'music-align-modal', 'Align modal display not found');
});

test('Beat analysis', () => {
    assertContains(musicJs, 'analyze-beats', 'Beat analysis not found');
});

test('Fade duration handling', () => {
    assertContains(musicJs, 'music-fade-slider', 'Fade duration handling not found');
});

test('Match sequence button handling', () => {
    assertContains(musicJs, 'music-align-match-seq', 'Match sequence button not found');
});

test('Beat align option handling', () => {
    assertContains(musicJs, 'music-beat-align', 'Beat align option not found');
});

// ============================================================================
// TIMELINE TESTS
// ============================================================================
console.log('\nðŸ“… Timeline Tests');

test('Timeline modal display', () => {
    assertContains(musicJs, 'music-timeline-modal', 'Timeline modal display not found');
});

test('Max chapters input', () => {
    assertContains(musicJs, 'music-timeline-max-chapters', 'Max chapters input not found');
});

test('Min length input', () => {
    assertContains(musicJs, 'music-timeline-min-length', 'Min length input not found');
});

test('Crossfade slider', () => {
    assertContains(musicJs, 'music-crossfade-slider', 'Crossfade slider not found');
});

test('Timeline generation', () => {
    assertContains(musicJs, 'generateTimelineMusic', 'Timeline generation not found');
});

// ============================================================================
// AUDIO PREVIEW TESTS
// ============================================================================
console.log('\nðŸ”Š Audio Preview Tests');

test('Audio player element', () => {
    assertContains(musicJs, 'music-audio-player', 'Audio player not found');
});

test('Preview panel display', () => {
    assertContains(musicJs, 'music-preview', 'Preview panel not found');
});

test('Preview close button', () => {
    assertContains(musicJs, 'music-preview-close', 'Preview close button not found');
});

test('Play/pause handling', () => {
    assertContains(musicJs, 'isPlaying', 'Play/pause handling not found');
});

// ============================================================================
// TIMELINE IMPORT TESTS
// ============================================================================
console.log('\nðŸ“¥ Timeline Import Tests');

test('Import to timeline function', () => {
    assertContains(musicJs, 'importToTimeline', 'Import to timeline not found');
});

test('Uses JSX for import', () => {
    assertContains(musicJs, 'jsx.call', 'JSX call for import not found');
});

test('Download handling', () => {
    assertContains(musicJs, 'downloadMusic', 'Download handling not found');
});

// ============================================================================
// ERROR HANDLING TESTS
// ============================================================================
console.log('\nâš ï¸ Error Handling Tests');

test('Has try-catch in main functions', () => {
    const tryCatchCount = (musicJs.match(/try\s*{/g) || []).length;
    assertTrue(tryCatchCount >= 10, `Expected at least 10 try-catch blocks, found ${tryCatchCount}`);
});

test('Displays errors via setMusicStatus', () => {
    assertContains(musicJs, "setMusicStatus(", 'Error status display not found');
});

test('Handles network errors', () => {
    assertContains(musicJs, 'catch', 'Network error handling not found');
});

// ============================================================================
// MODULE EXPORTS TESTS
// ============================================================================
console.log('\nðŸ“¤ Module Exports Tests');

test('Exports musicModule object', () => {
    assertContains(musicJs, 'window.musicModule = {', 'musicModule export not found');
});

test('Exports init function', () => {
    assertContains(musicJs, 'init:', 'init export not found');
});

test('Exports identifySong function', () => {
    assertContains(musicJs, 'identifySong:', 'identifySong export not found');
});

test('Exports generateMusic function', () => {
    assertContains(musicJs, 'generateMusic:', 'generateMusic export not found');
});

test('Exports loadLibrary function', () => {
    assertContains(musicJs, 'loadLibrary:', 'loadLibrary export not found');
});

test('Exports getState function', () => {
    assertContains(musicJs, 'getState:', 'getState export not found');
});

// ============================================================================
// SUMMARY
// ============================================================================
console.log('\n' + '='.repeat(60));
console.log(`ðŸ“Š Test Results: ${passed} passed, ${failed} failed`);
console.log('='.repeat(60));

if (failures.length > 0) {
    console.log('\nâŒ Failures:');
    failures.forEach(({ description, error }) => {
        console.log(`  - ${description}: ${error}`);
    });
}

process.exit(failed > 0 ? 1 : 0);
