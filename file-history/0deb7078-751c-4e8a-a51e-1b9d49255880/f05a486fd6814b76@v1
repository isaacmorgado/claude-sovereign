/**
 * SPLICE CEP Text Editor Module E2E Tests
 * Tests text-based video editing functionality
 */

const fs = require('fs');
const path = require('path');

// Test configuration
const PANEL_PATH = path.join(__dirname, '../panel');
const JS_PATH = path.join(PANEL_PATH, 'js');
const CSS_PATH = path.join(PANEL_PATH, 'css');

// Test counters
let passed = 0;
let failed = 0;
const failures = [];

function test(name, fn) {
    try {
        fn();
        passed++;
        console.log(`  ✓ ${name}`);
    } catch (e) {
        failed++;
        failures.push({ name, error: e.message });
        console.log(`  ✗ ${name}`);
        console.log(`    ${e.message}`);
    }
}

function assertEqual(actual, expected, message = '') {
    if (actual !== expected) {
        throw new Error(`${message}: Expected "${expected}", got "${actual}"`);
    }
}

function assertTrue(value, message = '') {
    if (!value) {
        throw new Error(`${message}: Expected truthy value, got ${value}`);
    }
}

function assertFalse(value, message = '') {
    if (value) {
        throw new Error(`${message}: Expected falsy value, got ${value}`);
    }
}

function assertContains(haystack, needle, message = '') {
    if (!haystack.includes(needle)) {
        throw new Error(`${message}: "${needle}" not found in content`);
    }
}

function assertNotContains(haystack, needle, message = '') {
    if (haystack.includes(needle)) {
        throw new Error(`${message}: "${needle}" should not be in content`);
    }
}

// ============================================================================
// TEST SUITES
// ============================================================================

console.log('\n=== SPLICE CEP Text Editor Module E2E Tests ===\n');

// ----------------------------------------------------------------------------
// 1. File Structure Tests
// ----------------------------------------------------------------------------
console.log('1. File Structure Tests');

test('textEditor.js exists', () => {
    const filePath = path.join(JS_PATH, 'textEditor.js');
    assertTrue(fs.existsSync(filePath), 'File should exist');
});

test('textEditor.js is included in index.html', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'js/textEditor.js', 'Script tag should exist');
});

test('textEditor.js loads after dependencies', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    const configPos = indexHtml.indexOf('js/config.js');
    const textEditorPos = indexHtml.indexOf('js/textEditor.js');
    assertTrue(configPos < textEditorPos, 'config.js should load before textEditor.js');
});

test('textEditor.js loads before main.js', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    const textEditorPos = indexHtml.indexOf('js/textEditor.js');
    const mainPos = indexHtml.indexOf('js/main.js');
    assertTrue(textEditorPos < mainPos, 'textEditor.js should load before main.js');
});

// ----------------------------------------------------------------------------
// 2. HTML Structure Tests
// ----------------------------------------------------------------------------
console.log('\n2. HTML Structure Tests');

test('text editor section exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="textEditorSection"', 'Section should exist');
});

test('text editor toggle exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="textEditorToggle"', 'Toggle should exist');
});

test('text editor panel exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-editor-panel"', 'Panel should exist');
});

test('text editor content textarea exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-editor-content"', 'Content textarea should exist');
});

test('undo button exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-editor-undo-btn"', 'Undo button should exist');
});

test('redo button exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-editor-redo-btn"', 'Redo button should exist');
});

test('reset button exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-editor-reset-btn"', 'Reset button should exist');
});

test('search input exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-search-input"', 'Search input should exist');
});

test('search button exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-search-btn"', 'Search button should exist');
});

test('search navigation buttons exist', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-search-prev-btn"', 'Previous button should exist');
    assertContains(indexHtml, 'id="text-search-next-btn"', 'Next button should exist');
});

test('search results display exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-search-results"', 'Search results display should exist');
});

test('replace input exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-replace-input"', 'Replace input should exist');
});

test('replace buttons exist', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-replace-btn"', 'Replace button should exist');
    assertContains(indexHtml, 'id="text-replace-all-btn"', 'Replace All button should exist');
});

test('preview container exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-editor-preview"', 'Preview container should exist');
});

test('action buttons exist', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="preview-text-edits-btn"', 'Preview button should exist');
    assertContains(indexHtml, 'id="apply-text-edits-btn"', 'Apply button should exist');
    assertContains(indexHtml, 'id="text-editor-build-btn"', 'Build button should exist');
});

test('word count display exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-editor-word-count"', 'Word count display should exist');
});

test('dirty indicator exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-editor-dirty"', 'Dirty indicator should exist');
});

test('status display exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="text-editor-status"', 'Status display should exist');
});

// ----------------------------------------------------------------------------
// 3. CSS Styling Tests
// ----------------------------------------------------------------------------
console.log('\n3. CSS Styling Tests');

test('text editor section styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.text-editor-section', 'Section styles should exist');
});

test('text editor panel styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.text-editor-panel', 'Panel styles should exist');
});

test('text editor collapsed state styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.text-editor-panel.collapsed', 'Collapsed styles should exist');
});

test('text editor bar styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.text-editor-bar', 'Bar styles should exist');
});

test('text editor toolbar styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.text-editor-toolbar', 'Toolbar styles should exist');
});

test('text editor content styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.text-editor-content', 'Content styles should exist');
});

test('search input styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.search-input', 'Search input styles should exist');
});

test('search row styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.search-row', 'Search row styles should exist');
});

test('replace row styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.replace-row', 'Replace row styles should exist');
});

test('preview styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.text-editor-preview', 'Preview styles should exist');
});

test('preview change styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.preview-change', 'Preview change styles should exist');
});

test('preview change type styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.preview-change-deletion', 'Deletion styles should exist');
    assertContains(css, '.preview-change-reorder', 'Reorder styles should exist');
});

test('text editor actions styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.text-editor-actions', 'Actions styles should exist');
});

test('status type styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.text-editor-status-info', 'Info status style should exist');
    assertContains(css, '.text-editor-status-success', 'Success status style should exist');
    assertContains(css, '.text-editor-status-error', 'Error status style should exist');
});

test('icon button styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.btn-icon', 'Icon button styles should exist');
});

test('toolbar divider styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.toolbar-divider', 'Toolbar divider styles should exist');
});

test('ready button animation exists', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.btn.ready', 'Ready button style should exist');
    assertContains(css, '@keyframes pulse', 'Pulse animation should exist');
});

// ----------------------------------------------------------------------------
// 4. JavaScript Module Structure Tests
// ----------------------------------------------------------------------------
console.log('\n4. JavaScript Module Structure Tests');

const textEditorJS = fs.readFileSync(path.join(JS_PATH, 'textEditor.js'), 'utf8');

test('module has state object', () => {
    assertContains(textEditorJS, 'textEditorState', 'State object should exist');
});

test('state has originalTranscript property', () => {
    assertContains(textEditorJS, 'originalTranscript:', 'originalTranscript property should exist');
});

test('state has editableTranscript property', () => {
    assertContains(textEditorJS, 'editableTranscript:', 'editableTranscript property should exist');
});

test('state has currentText property', () => {
    assertContains(textEditorJS, 'currentText:', 'currentText property should exist');
});

test('state has undoStack property', () => {
    assertContains(textEditorJS, 'undoStack:', 'undoStack property should exist');
});

test('state has redoStack property', () => {
    assertContains(textEditorJS, 'redoStack:', 'redoStack property should exist');
});

test('state has searchResults property', () => {
    assertContains(textEditorJS, 'searchResults:', 'searchResults property should exist');
});

test('state has isDirty property', () => {
    assertContains(textEditorJS, 'isDirty:', 'isDirty property should exist');
});

test('module has MAX_UNDO_STACK constant', () => {
    assertContains(textEditorJS, 'MAX_UNDO_STACK', 'MAX_UNDO_STACK constant should exist');
});

// ----------------------------------------------------------------------------
// 5. DOM Element Cache Tests
// ----------------------------------------------------------------------------
console.log('\n5. DOM Element Cache Tests');

test('module has element cache object', () => {
    assertContains(textEditorJS, 'textEditorElements', 'Element cache should exist');
});

test('cache has panel element', () => {
    assertContains(textEditorJS, 'panel:', 'Panel element cache should exist');
});

test('cache has content element', () => {
    assertContains(textEditorJS, 'content:', 'Content element cache should exist');
});

test('cache has status element', () => {
    assertContains(textEditorJS, 'status:', 'Status element cache should exist');
});

test('cacheTextEditorElements function exists', () => {
    assertContains(textEditorJS, 'function cacheTextEditorElements', 'Cache function should exist');
});

// ----------------------------------------------------------------------------
// 6. Initialization Tests
// ----------------------------------------------------------------------------
console.log('\n6. Initialization Tests');

test('initTextEditor function exists', () => {
    assertContains(textEditorJS, 'function initTextEditor', 'Init function should exist');
});

test('setupTextEditorListeners function exists', () => {
    assertContains(textEditorJS, 'function setupTextEditorListeners', 'Listener setup function should exist');
});

test('setupKeyboardShortcuts function exists', () => {
    assertContains(textEditorJS, 'function setupKeyboardShortcuts', 'Keyboard shortcuts function should exist');
});

test('module initializes element cache', () => {
    assertContains(textEditorJS, 'cacheTextEditorElements()', 'Should call cache function');
});

// ----------------------------------------------------------------------------
// 7. Transcript Loading Tests
// ----------------------------------------------------------------------------
console.log('\n7. Transcript Loading Tests');

test('loadTranscriptIntoEditor function exists', () => {
    assertContains(textEditorJS, 'async function loadTranscriptIntoEditor', 'Load function should exist');
});

test('load function calls text-edit/prepare endpoint', () => {
    assertContains(textEditorJS, '/text-edit/prepare', 'Should call prepare endpoint');
});

test('load function handles errors', () => {
    assertContains(textEditorJS, 'Text editor load error', 'Should handle errors');
});

// ----------------------------------------------------------------------------
// 8. Text Editing Tests
// ----------------------------------------------------------------------------
console.log('\n8. Text Editing Tests');

test('handleTextChange function exists', () => {
    assertContains(textEditorJS, 'function handleTextChange', 'Text change handler should exist');
});

test('handleTextChange adds to undo stack', () => {
    assertContains(textEditorJS, 'undoStack.push', 'Should add to undo stack');
});

test('handleTextChange clears redo stack', () => {
    assertContains(textEditorJS, 'redoStack = []', 'Should clear redo stack');
});

test('handleTextChange limits undo stack size', () => {
    assertContains(textEditorJS, 'undoStack.length > MAX_UNDO_STACK', 'Should limit undo stack');
});

// ----------------------------------------------------------------------------
// 9. Undo/Redo Tests
// ----------------------------------------------------------------------------
console.log('\n9. Undo/Redo Tests');

test('undoTextEdit function exists', () => {
    assertContains(textEditorJS, 'function undoTextEdit', 'Undo function should exist');
});

test('redoTextEdit function exists', () => {
    assertContains(textEditorJS, 'function redoTextEdit', 'Redo function should exist');
});

test('undo handles empty stack', () => {
    assertContains(textEditorJS, 'undoStack.length === 0', 'Should check empty undo stack');
});

test('redo handles empty stack', () => {
    assertContains(textEditorJS, 'redoStack.length === 0', 'Should check empty redo stack');
});

test('resetToOriginal function exists', () => {
    assertContains(textEditorJS, 'function resetToOriginal', 'Reset function should exist');
});

// ----------------------------------------------------------------------------
// 10. Preview and Apply Tests
// ----------------------------------------------------------------------------
console.log('\n10. Preview and Apply Tests');

test('previewTextEdits function exists', () => {
    assertContains(textEditorJS, 'async function previewTextEdits', 'Preview function should exist');
});

test('preview calls text-edit/preview endpoint', () => {
    assertContains(textEditorJS, '/text-edit/preview', 'Should call preview endpoint');
});

test('renderPreview function exists', () => {
    assertContains(textEditorJS, 'function renderPreview', 'Render preview function should exist');
});

test('applyTextEdits function exists', () => {
    assertContains(textEditorJS, 'async function applyTextEdits', 'Apply function should exist');
});

test('apply calls text-edit/apply endpoint', () => {
    assertContains(textEditorJS, '/text-edit/apply', 'Should call apply endpoint');
});

test('apply calls text-edit/cut-list endpoint', () => {
    assertContains(textEditorJS, '/text-edit/cut-list', 'Should call cut-list endpoint');
});

test('buildSequenceFromEdits function exists', () => {
    assertContains(textEditorJS, 'async function buildSequenceFromEdits', 'Build sequence function should exist');
});

// ----------------------------------------------------------------------------
// 11. Search and Replace Tests
// ----------------------------------------------------------------------------
console.log('\n11. Search and Replace Tests');

test('searchInTranscript function exists', () => {
    assertContains(textEditorJS, 'async function searchInTranscript', 'Search function should exist');
});

test('search calls text-edit/search endpoint', () => {
    assertContains(textEditorJS, '/text-edit/search', 'Should call search endpoint');
});

test('navigateSearchResult function exists', () => {
    assertContains(textEditorJS, 'function navigateSearchResult', 'Navigate function should exist');
});

test('highlightSearchResults function exists', () => {
    assertContains(textEditorJS, 'function highlightSearchResults', 'Highlight function should exist');
});

test('highlightCurrentResult function exists', () => {
    assertContains(textEditorJS, 'function highlightCurrentResult', 'Highlight current function should exist');
});

test('updateSearchResultsDisplay function exists', () => {
    assertContains(textEditorJS, 'function updateSearchResultsDisplay', 'Update display function should exist');
});

test('replaceInTranscript function exists', () => {
    assertContains(textEditorJS, 'function replaceInTranscript', 'Replace function should exist');
});

test('replaceAllInTranscript function exists', () => {
    assertContains(textEditorJS, 'function replaceAllInTranscript', 'Replace all function should exist');
});

test('escapeRegex function exists', () => {
    assertContains(textEditorJS, 'function escapeRegex', 'Escape regex function should exist');
});

test('search navigation wraps around', () => {
    assertContains(textEditorJS, 'currentSearchIndex = 0', 'Should wrap to start');
    assertContains(textEditorJS, 'searchResults.length - 1', 'Should wrap to end');
});

// ----------------------------------------------------------------------------
// 12. UI Rendering Tests
// ----------------------------------------------------------------------------
console.log('\n12. UI Rendering Tests');

test('renderTextEditor function exists', () => {
    assertContains(textEditorJS, 'function renderTextEditor', 'Render editor function should exist');
});

test('updateEditorStatus function exists', () => {
    assertContains(textEditorJS, 'function updateEditorStatus', 'Update status function should exist');
});

test('updateProcessingState function exists', () => {
    assertContains(textEditorJS, 'function updateProcessingState', 'Update processing function should exist');
});

test('updateBuildButtonState function exists', () => {
    assertContains(textEditorJS, 'function updateBuildButtonState', 'Update build button function should exist');
});

test('showTextEditorStatus function exists', () => {
    assertContains(textEditorJS, 'function showTextEditorStatus', 'Show status function should exist');
});

test('status types are handled', () => {
    assertContains(textEditorJS, 'text-editor-status-${type}', 'Should use type in class name');
});

// ----------------------------------------------------------------------------
// 13. Event Delegation Tests
// ----------------------------------------------------------------------------
console.log('\n13. Event Delegation Tests');

test('uses event delegation for input', () => {
    assertContains(textEditorJS, "document.addEventListener('input'", 'Should use event delegation for input');
});

test('uses event delegation for clicks', () => {
    assertContains(textEditorJS, "document.addEventListener('click'", 'Should use event delegation for clicks');
});

test('uses event delegation for keypress', () => {
    assertContains(textEditorJS, "document.addEventListener('keypress'", 'Should use event delegation for keypress');
});

test('uses event delegation for keydown', () => {
    assertContains(textEditorJS, "document.addEventListener('keydown'", 'Should use event delegation for keydown');
});

test('handles button IDs via switch statement', () => {
    assertContains(textEditorJS, 'switch (id)', 'Should use switch for button IDs');
});

// ----------------------------------------------------------------------------
// 14. Keyboard Shortcuts Tests
// ----------------------------------------------------------------------------
console.log('\n14. Keyboard Shortcuts Tests');

test('handles Ctrl+Z for undo', () => {
    assertContains(textEditorJS, "e.key === 'z'", 'Should handle Z key');
    assertContains(textEditorJS, 'e.ctrlKey || e.metaKey', 'Should handle Ctrl/Cmd');
});

test('handles Ctrl+Shift+Z for redo', () => {
    assertContains(textEditorJS, "e.key === 'Z'", 'Should handle Shift+Z key');
});

test('handles Ctrl+Y for redo', () => {
    assertContains(textEditorJS, "e.key === 'y'", 'Should handle Y key');
});

test('handles Ctrl+F for search', () => {
    assertContains(textEditorJS, "e.key === 'f'", 'Should handle F key');
});

test('prevents default for shortcuts', () => {
    assertContains(textEditorJS, 'e.preventDefault()', 'Should prevent default');
});

// ----------------------------------------------------------------------------
// 15. API Integration Tests
// ----------------------------------------------------------------------------
console.log('\n15. API Integration Tests');

test('uses getBackendUrl for API calls', () => {
    assertContains(textEditorJS, 'getBackendUrl', 'Should use getBackendUrl');
});

test('uses fetchWithTimeout for API calls', () => {
    assertContains(textEditorJS, 'fetchWithTimeout', 'Should use fetchWithTimeout');
});

test('uses getAuthHeaders for API calls', () => {
    assertContains(textEditorJS, 'getAuthHeaders', 'Should use getAuthHeaders');
});

test('handles API fallbacks', () => {
    assertContains(textEditorJS, "typeof getBackendUrl === 'function'", 'Should check getBackendUrl existence');
    assertContains(textEditorJS, "typeof fetchWithTimeout === 'function'", 'Should check fetchWithTimeout existence');
});

// ----------------------------------------------------------------------------
// 16. Builder Integration Tests
// ----------------------------------------------------------------------------
console.log('\n16. Builder Integration Tests');

test('integrates with spliceBuilder', () => {
    assertContains(textEditorJS, 'window.spliceBuilder', 'Should check spliceBuilder');
});

test('uses buildSequence from builder', () => {
    assertContains(textEditorJS, 'buildSequence', 'Should call buildSequence');
});

test('has fallback builder function', () => {
    assertContains(textEditorJS, 'buildSequenceFromCutList', 'Should have fallback builder');
});

// ----------------------------------------------------------------------------
// 17. Exports Tests
// ----------------------------------------------------------------------------
console.log('\n17. Exports Tests');

test('exports window.spliceTextEditor', () => {
    assertContains(textEditorJS, 'window.spliceTextEditor', 'Should export spliceTextEditor');
});

test('exports init function', () => {
    assertContains(textEditorJS, 'init: initTextEditor', 'Should export init');
});

test('exports loadTranscript function', () => {
    assertContains(textEditorJS, 'loadTranscript: loadTranscriptIntoEditor', 'Should export loadTranscript');
});

test('exports applyEdits function', () => {
    assertContains(textEditorJS, 'applyEdits: applyTextEdits', 'Should export applyEdits');
});

test('exports previewEdits function', () => {
    assertContains(textEditorJS, 'previewEdits: previewTextEdits', 'Should export previewEdits');
});

test('exports undo function', () => {
    assertContains(textEditorJS, 'undo: undoTextEdit', 'Should export undo');
});

test('exports redo function', () => {
    assertContains(textEditorJS, 'redo: redoTextEdit', 'Should export redo');
});

test('exports reset function', () => {
    assertContains(textEditorJS, 'reset: resetToOriginal', 'Should export reset');
});

test('exports search function', () => {
    assertContains(textEditorJS, 'search: searchInTranscript', 'Should export search');
});

test('exports buildSequence function', () => {
    assertContains(textEditorJS, 'buildSequence: buildSequenceFromEdits', 'Should export buildSequence');
});

test('exports getState function', () => {
    assertContains(textEditorJS, 'getState:', 'Should export getState');
});

test('exports global initTextEditor', () => {
    assertContains(textEditorJS, 'window.initTextEditor = initTextEditor', 'Should export global init');
});

test('exports global loadTranscriptIntoEditor', () => {
    assertContains(textEditorJS, 'window.loadTranscriptIntoEditor = loadTranscriptIntoEditor', 'Should export global load');
});

// ----------------------------------------------------------------------------
// 18. Main.js Integration Tests
// ----------------------------------------------------------------------------
console.log('\n18. Main.js Integration Tests');

const mainJS = fs.readFileSync(path.join(JS_PATH, 'main.js'), 'utf8');

test('main.js initializes text editor', () => {
    assertContains(mainJS, 'initTextEditor', 'Should call initTextEditor');
});

test('main.js has text editor toggle initialization', () => {
    assertContains(mainJS, 'initTextEditorToggle', 'Should call initTextEditorToggle');
});

test('main.js has initTextEditorToggle function', () => {
    assertContains(mainJS, 'function initTextEditorToggle', 'Should have toggle function');
});

test('text editor toggle targets correct panel', () => {
    assertContains(mainJS, "getElementById('text-editor-panel')", 'Should target text editor panel');
});

test('text editor toggle updates icon', () => {
    assertContains(mainJS, '.toggle-icon', 'Should update toggle icon');
});

// ----------------------------------------------------------------------------
// 19. Error Handling Tests
// ----------------------------------------------------------------------------
console.log('\n19. Error Handling Tests');

test('handles missing transcript in load', () => {
    assertContains(textEditorJS, '!transcript', 'Should check for missing transcript');
    assertContains(textEditorJS, 'No transcript available', 'Should show error for missing transcript');
});

test('handles no changes in preview', () => {
    assertContains(textEditorJS, '!textEditorState.isDirty', 'Should check for changes');
    assertContains(textEditorJS, 'No changes to preview', 'Should show message for no changes');
});

test('handles no changes in apply', () => {
    assertContains(textEditorJS, 'No changes to apply', 'Should show message for no changes to apply');
});

test('handles no cut list in build', () => {
    assertContains(textEditorJS, '!textEditorState.lastCutList', 'Should check for cut list');
    assertContains(textEditorJS, 'No edits to build', 'Should show error for no cut list');
});

test('handles no transcript in search', () => {
    assertContains(textEditorJS, '!textEditorState.editableTranscript', 'Should check for transcript');
    assertContains(textEditorJS, 'No transcript loaded', 'Should show error for no transcript');
});

test('handles empty search text', () => {
    assertContains(textEditorJS, '!searchText', 'Should check for search text');
    assertContains(textEditorJS, 'Enter search text', 'Should show message for empty search');
});

// ----------------------------------------------------------------------------
// 20. Preview Rendering Tests
// ----------------------------------------------------------------------------
console.log('\n20. Preview Rendering Tests');

test('renders preview summary', () => {
    assertContains(textEditorJS, 'preview-summary', 'Should render summary');
});

test('renders preview stats', () => {
    assertContains(textEditorJS, 'preview-stat', 'Should render stats');
    assertContains(textEditorJS, 'preview.summary.deletions', 'Should show deletions');
    assertContains(textEditorJS, 'preview.summary.reorderings', 'Should show reorderings');
    assertContains(textEditorJS, 'preview.impact.percentageRemoved', 'Should show percentage');
});

test('renders preview changes list', () => {
    assertContains(textEditorJS, 'preview-changes', 'Should render changes list');
});

test('renders individual change items', () => {
    assertContains(textEditorJS, 'preview-change-${change.type}', 'Should render change type');
    assertContains(textEditorJS, 'change-type', 'Should render type label');
    assertContains(textEditorJS, 'change-desc', 'Should render description');
    assertContains(textEditorJS, 'change-time', 'Should render time range');
});

test('handles empty preview', () => {
    assertContains(textEditorJS, 'preview-empty', 'Should have empty state class');
    assertContains(textEditorJS, 'No changes detected', 'Should show empty message');
});

// ============================================================================
// RESULTS SUMMARY
// ============================================================================
console.log('\n' + '='.repeat(50));
console.log(`RESULTS: ${passed} passed, ${failed} failed`);
console.log('='.repeat(50));

if (failures.length > 0) {
    console.log('\nFailed tests:');
    failures.forEach(f => {
        console.log(`  - ${f.name}: ${f.error}`);
    });
}

// Exit with appropriate code
process.exit(failed > 0 ? 1 : 0);
