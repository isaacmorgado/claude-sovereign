/**
 * SPLICE CEP Multitrack Module E2E Tests
 * Tests multitrack UI, speaker configuration, API integration, and builder
 * v4.0.0 - CEP Migration
 */

const fs = require('fs');
const path = require('path');

// Test configuration
const CEP_ROOT = path.join(__dirname, '..');
const PANEL_ROOT = path.join(CEP_ROOT, 'panel');
const JSX_ROOT = path.join(CEP_ROOT, 'jsx');

// Test counters
let passed = 0;
let failed = 0;

function test(name, fn) {
    try {
        fn();
        passed++;
        console.log(`  \x1b[32m✓\x1b[0m ${name}`);
    } catch (e) {
        failed++;
        console.log(`  \x1b[31m✗\x1b[0m ${name}`);
        console.log(`    Error: ${e.message}`);
    }
}

function assertEqual(actual, expected, msg = '') {
    if (actual !== expected) {
        throw new Error(`${msg} Expected: ${expected}, Got: ${actual}`);
    }
}

function assertTrue(value, msg = '') {
    if (!value) {
        throw new Error(`${msg} Expected truthy value, got: ${value}`);
    }
}

function assertFalse(value, msg = '') {
    if (value) {
        throw new Error(`${msg} Expected falsy value, got: ${value}`);
    }
}

function assertContains(text, substring, msg = '') {
    if (!text.includes(substring)) {
        throw new Error(`${msg} Expected "${text}" to contain "${substring}"`);
    }
}

function assertNotContains(text, substring, msg = '') {
    if (text.includes(substring)) {
        throw new Error(`${msg} Expected "${text}" to NOT contain "${substring}"`);
    }
}

// ============================================================================
// MULTITRACK MODULE TESTS
// ============================================================================
console.log('\n\x1b[36m=== CEP Multitrack Module E2E Tests ===\x1b[0m\n');

// -----------------------------------------------------------------------------
// File Structure Tests
// -----------------------------------------------------------------------------
console.log('\x1b[33mFile Structure:\x1b[0m');

test('multitrack.js exists', () => {
    const filePath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    assertTrue(fs.existsSync(filePath), 'multitrack.js should exist');
});

test('multitrack.js is not empty', () => {
    const filePath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(filePath, 'utf8');
    assertTrue(content.length > 1000, 'multitrack.js should have substantial content');
});

test('multitrack.js script included in index.html', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'multitrack.js', 'index.html should include multitrack.js');
});

// -----------------------------------------------------------------------------
// HTML Structure Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mHTML Structure:\x1b[0m');

test('multitrack section exists in HTML', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="multitrackSection"', 'Multitrack section should exist');
});

test('multitrack toggle button exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="multitrackToggle"', 'Multitrack toggle should exist');
});

test('multitrack panel exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="multitrackPanel"', 'Multitrack panel should exist');
});

test('speaker list exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="speakerList"', 'Speaker list should exist');
});

test('add speaker button exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="addSpeakerBtn"', 'Add speaker button should exist');
});

test('default speakers (2) are configured', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'Speaker 1', 'Speaker 1 should be pre-configured');
    assertContains(content, 'Speaker 2', 'Speaker 2 should be pre-configured');
});

test('parameter sliders exist', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="minShotDuration"', 'Min shot duration slider should exist');
    assertContains(content, 'id="wideShotPercent"', 'Wide shot percent slider should exist');
    assertContains(content, 'id="switchingFrequency"', 'Switching frequency slider should exist');
});

test('action buttons exist', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="analyzeMultitrackBtn"', 'Analyze button should exist');
    assertContains(content, 'id="autoBalanceBtn"', 'Auto-balance button should exist');
    assertContains(content, 'id="applyMultitrackBtn"', 'Apply button should exist');
});

test('preview elements exist', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="multitrackPreview"', 'Preview container should exist');
    assertContains(content, 'id="distributionChart"', 'Distribution chart should exist');
    assertContains(content, 'id="speakerStats"', 'Speaker stats should exist');
    assertContains(content, 'id="decisionList"', 'Decision list should exist');
});

test('wide shot track selector exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="wideShotTrack"', 'Wide shot track selector should exist');
});

test('wide shot detection checkbox exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="enableWideShotDetection"', 'Wide shot detection checkbox should exist');
});

// -----------------------------------------------------------------------------
// JavaScript Module Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mJavaScript Module:\x1b[0m');

test('multitrack.js exports initMultitrackUI', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'window.initMultitrackUI', 'Should export initMultitrackUI');
});

test('multitrack.js exports spliceMultitrack object', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'window.spliceMultitrack', 'Should export spliceMultitrack');
});

test('spliceMultitrack has required methods', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'init:', 'Should have init method');
    assertContains(content, 'analyze:', 'Should have analyze method');
    assertContains(content, 'autoBalance:', 'Should have autoBalance method');
    assertContains(content, 'apply:', 'Should have apply method');
    assertContains(content, 'getSettings:', 'Should have getSettings method');
    assertContains(content, 'getResults:', 'Should have getResults method');
});

test('multitrack.js has SPEAKER_COLORS constant', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'SPEAKER_COLORS', 'Should have SPEAKER_COLORS constant');
    assertContains(content, '#ff6b6b', 'Should have speaker color 1');
    assertContains(content, '#4ecdc4', 'Should have speaker color 2');
});

test('multitrack.js has DOM element caching', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'cacheMultitrackElements', 'Should cache DOM elements');
    assertContains(content, 'multitrackUI', 'Should have multitrackUI object');
});

test('multitrack.js has speaker management functions', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function addSpeaker', 'Should have addSpeaker');
    assertContains(content, 'function removeSpeaker', 'Should have removeSpeaker');
    assertContains(content, 'function reindexSpeakers', 'Should have reindexSpeakers');
});

test('multitrack.js has speaker limit of 4', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'speakerConfig.length >= 4', 'Should limit to 4 speakers');
});

test('multitrack.js has minimum speaker limit of 2', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'speakerConfig.length <= 2', 'Should require minimum 2 speakers');
});

// -----------------------------------------------------------------------------
// API Integration Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mAPI Integration:\x1b[0m');

test('multitrack.js calls /multitrack endpoint', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '/multitrack', 'Should call /multitrack endpoint');
});

test('multitrack.js calls /multitrack/auto-balance endpoint', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '/multitrack/auto-balance', 'Should call auto-balance endpoint');
});

test('multitrack.js uses fetchWithTimeout', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'fetchWithTimeout', 'Should use fetchWithTimeout');
});

test('multitrack.js uses getAuthHeaders', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'getAuthHeaders()', 'Should use getAuthHeaders');
});

test('multitrack.js uses getBackendUrl', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'getBackendUrl()', 'Should use getBackendUrl');
});

test('multitrack.js uses parseErrorResponse', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'parseErrorResponse', 'Should use parseErrorResponse');
});

test('multitrack.js checks online status', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'isOnline()', 'Should check online status');
});

// -----------------------------------------------------------------------------
// UI Logic Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mUI Logic:\x1b[0m');

test('multitrack.js handles section toggle', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'toggleMultitrackSection', 'Should have toggle function');
    assertContains(content, 'classList.toggle', 'Should toggle CSS class');
});

test('multitrack.js updates parameter values on slider change', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'setupParameterListeners', 'Should setup parameter listeners');
});

test('multitrack.js renders distribution chart', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'renderDistributionChart', 'Should render distribution chart');
    assertContains(content, 'distribution-bar', 'Should create distribution bars');
});

test('multitrack.js renders speaker stats', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'renderSpeakerStats', 'Should render speaker stats');
});

test('multitrack.js renders decision list', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'renderDecisionList', 'Should render decision list');
});

test('multitrack.js limits decision list to 50 items', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'slice(0, 50)', 'Should limit to 50 items for performance');
});

test('multitrack.js handles seek button clicks', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'handleDecisionListClick', 'Should handle decision list clicks');
    assertContains(content, 'decision-seek', 'Should handle seek buttons');
});

// -----------------------------------------------------------------------------
// Builder Integration Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mBuilder Integration:\x1b[0m');

test('multitrack.js uses spliceBuilder', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'window.spliceBuilder', 'Should use spliceBuilder');
});

test('multitrack.js builds cut list v3.5', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, "version: '3.5'", 'Should use v3.5 cut list');
});

test('multitrack.js creates segments with color hints', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'colorHint:', 'Should add color hints to segments');
    assertContains(content, 'mango', 'Should use mango for speaker 0');
    assertContains(content, 'caribbean', 'Should use caribbean for speaker 1');
});

test('multitrack.js uses _MULTITRACK suffix', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '_MULTITRACK', 'Should use _MULTITRACK suffix');
});

// -----------------------------------------------------------------------------
// JSX Host Script Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mJSX Host Script:\x1b[0m');

test('hostScript.jsx has seekToTime function', () => {
    const jsxPath = path.join(JSX_ROOT, 'hostScript.jsx');
    const content = fs.readFileSync(jsxPath, 'utf8');
    assertContains(content, 'function seekToTime', 'Should have seekToTime function');
});

test('seekToTime converts seconds to ticks', () => {
    const jsxPath = path.join(JSX_ROOT, 'hostScript.jsx');
    const content = fs.readFileSync(jsxPath, 'utf8');
    assertContains(content, 'TICKS_PER_SECOND', 'Should use TICKS_PER_SECOND constant');
});

test('hostScript.jsx has getPlayerPosition function', () => {
    const jsxPath = path.join(JSX_ROOT, 'hostScript.jsx');
    const content = fs.readFileSync(jsxPath, 'utf8');
    assertContains(content, 'function getPlayerPosition', 'Should have getPlayerPosition function');
});

// -----------------------------------------------------------------------------
// CSS Style Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mCSS Styles:\x1b[0m');

test('style.css has multitrack section styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.multitrack-section', 'Should have multitrack section styles');
});

test('style.css has section toggle styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.section-toggle', 'Should have section toggle styles');
});

test('style.css has speaker item styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.speaker-item', 'Should have speaker item styles');
});

test('style.css has speaker colors', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.speaker-item.speaker-0', 'Should have speaker-0 color');
    assertContains(content, '.speaker-item.speaker-1', 'Should have speaker-1 color');
    assertContains(content, '.speaker-item.speaker-2', 'Should have speaker-2 color');
    assertContains(content, '.speaker-item.speaker-3', 'Should have speaker-3 color');
});

test('style.css has distribution chart styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.distribution-chart', 'Should have distribution chart styles');
    assertContains(content, '.distribution-bar', 'Should have distribution bar styles');
});

test('style.css has speaker stats styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.speaker-stats', 'Should have speaker stats styles');
    assertContains(content, '.speaker-stat-dot', 'Should have speaker stat dot styles');
});

test('style.css has decision list styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.decision-list', 'Should have decision list styles');
    assertContains(content, '.decision-item', 'Should have decision item styles');
});

test('style.css has distribution bar colors for speakers', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.distribution-bar.speaker-0', 'Should have speaker-0 bar color');
    assertContains(content, '.distribution-bar.wide-shot', 'Should have wide-shot bar color');
});

// -----------------------------------------------------------------------------
// Main.js Integration Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mMain.js Integration:\x1b[0m');

test('main.js initializes multitrack UI', () => {
    const mainPath = path.join(PANEL_ROOT, 'js', 'main.js');
    const content = fs.readFileSync(mainPath, 'utf8');
    assertContains(content, 'initMultitrackUI', 'Should call initMultitrackUI');
});

// -----------------------------------------------------------------------------
// Error Handling Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mError Handling:\x1b[0m');

test('multitrack.js handles operation in progress', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'isMultitrackOperationInProgress', 'Should track operation in progress');
});

test('multitrack.js disables buttons during operation', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '.disabled = true', 'Should disable buttons');
});

test('multitrack.js re-enables buttons after operation', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '.disabled = false', 'Should re-enable buttons');
});

test('multitrack.js has try-catch error handling', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'catch (err)', 'Should catch errors');
    assertContains(content, 'console.error', 'Should log errors');
});

test('multitrack.js uses setStatus for user feedback', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'setStatus(', 'Should use setStatus for feedback');
});

// -----------------------------------------------------------------------------
// ARIA Accessibility Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mARIA Accessibility:\x1b[0m');

test('HTML has aria-labels for speaker inputs', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'aria-label="Speaker 1 name"', 'Should have aria-label for speaker 1');
    assertContains(content, 'aria-label="Speaker 2 name"', 'Should have aria-label for speaker 2');
});

test('HTML has aria-labels for track selects', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'aria-label="Speaker 1 video track"', 'Should have aria-label for track 1');
    assertContains(content, 'aria-label="Speaker 2 video track"', 'Should have aria-label for track 2');
});

test('multitrack.js adds aria-labels to new speakers', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'multitrack.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'aria-label', 'Should add aria-labels to new speakers');
});

// -----------------------------------------------------------------------------
// Summary
// -----------------------------------------------------------------------------
console.log('\n\x1b[36m=== Test Summary ===\x1b[0m');
console.log(`  Passed: \x1b[32m${passed}\x1b[0m`);
console.log(`  Failed: \x1b[31m${failed}\x1b[0m`);
console.log(`  Total:  ${passed + failed}`);

if (failed > 0) {
    process.exit(1);
} else {
    console.log('\n\x1b[32mAll multitrack tests passed!\x1b[0m\n');
}
