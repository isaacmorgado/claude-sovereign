/**
 * SPLICE CEP Animated Captions Module E2E Tests
 * Tests caption templates, generation, export, and timeline integration
 * v4.0.0 - CEP Migration
 */

const fs = require('fs');
const path = require('path');

// Test configuration
const CEP_ROOT = path.join(__dirname, '..');
const PANEL_ROOT = path.join(CEP_ROOT, 'panel');

// Test counters
let passed = 0;
let failed = 0;

function test(name, fn) {
    try {
        fn();
        passed++;
        console.log(`  \x1b[32m✓\x1b[0m ${name}`);
    } catch (e) {
        failed++;
        console.log(`  \x1b[31m✗\x1b[0m ${name}`);
        console.log(`    Error: ${e.message}`);
    }
}

function assertContains(text, substring, msg = '') {
    if (!text.includes(substring)) {
        throw new Error(`${msg} Expected to contain "${substring}"`);
    }
}

function assertTrue(value, msg = '') {
    if (!value) {
        throw new Error(`${msg} Expected truthy value`);
    }
}

// ============================================================================
// ANIMATED CAPTIONS MODULE TESTS
// ============================================================================
console.log('\n\x1b[36m=== CEP Animated Captions E2E Tests ===\x1b[0m\n');

// -----------------------------------------------------------------------------
// File Structure Tests
// -----------------------------------------------------------------------------
console.log('\x1b[33mFile Structure:\x1b[0m');

test('animatedCaptions.js exists', () => {
    const filePath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    assertTrue(fs.existsSync(filePath));
});

test('animatedCaptions.js has substantial content', () => {
    const filePath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(filePath, 'utf8');
    assertTrue(content.length > 5000);
});

test('animatedCaptions.js included in index.html', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'animatedCaptions.js');
});

// -----------------------------------------------------------------------------
// HTML Structure Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mHTML Structure:\x1b[0m');

test('captions section exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionsSection"');
});

test('captions toggle exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionsToggle"');
});

test('captions panel exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionsPanel"');
});

test('template gallery exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionTemplateGallery"');
});

test('generate button exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="generateCaptionsBtn"');
});

test('words per line setting exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionWordsPerLine"');
});

test('highlight keywords checkbox exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionHighlightKeywords"');
});

test('insert emojis checkbox exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionInsertEmojis"');
});

test('emoji frequency setting exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionEmojiFrequency"');
});

test('export SRT button exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="exportCaptionsSrtBtn"');
});

test('export MOGRT button exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="exportCaptionsMogrtBtn"');
});

test('copy captions button exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="copyCaptionsBtn"');
});

test('apply captions button exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="applyCaptionsBtn"');
});

test('preview container exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionPreviewContainer"');
});

test('stats container exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionStats"');
});

test('status container exists', () => {
    const htmlPath = path.join(PANEL_ROOT, 'index.html');
    const content = fs.readFileSync(htmlPath, 'utf8');
    assertContains(content, 'id="captionStatus"');
});

// -----------------------------------------------------------------------------
// JavaScript Module Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mJavaScript Module:\x1b[0m');

test('exports initAnimatedCaptions', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'window.initAnimatedCaptions');
});

test('exports spliceAnimatedCaptions object', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'window.spliceAnimatedCaptions');
});

test('has init method', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'init: initAnimatedCaptions');
});

test('has generate method', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'generate: generateCaptions');
});

test('has setTranscript method', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'setTranscript: setCaptionTranscript');
});

test('has selectTemplate method', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'selectTemplate: selectCaptionTemplate');
});

test('has export method', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'export: exportCaptions');
});

test('has applyToTimeline method', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'applyToTimeline: applyCaptionsToTimeline');
});

test('has animatedCaptionsState object', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'animatedCaptionsState');
});

test('has DOM element caching', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'cacheCaptionElements');
    assertContains(content, 'captionsUI');
});

// -----------------------------------------------------------------------------
// Template System Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mTemplate System:\x1b[0m');

test('has loadCaptionTemplates function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'async function loadCaptionTemplates');
});

test('has fallback templates', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'mrbeast');
    assertContains(content, 'hormozi');
    assertContains(content, 'gaming');
    assertContains(content, 'corporate');
    assertContains(content, 'karaoke');
});

test('has renderTemplateGallery function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function renderTemplateGallery');
});

test('has selectCaptionTemplate function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function selectCaptionTemplate');
});

test('has applyTemplateToExisting function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'async function applyTemplateToExisting');
});

// -----------------------------------------------------------------------------
// API Integration Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mAPI Integration:\x1b[0m');

test('calls /captions/templates endpoint', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '/captions/templates');
});

test('calls /captions/animate endpoint', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '/captions/animate');
});

test('calls /captions/apply-template endpoint', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '/captions/apply-template');
});

test('calls /captions/export/mogrt endpoint', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '/captions/export/mogrt');
});

test('calls /export/captions endpoint', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '/export/captions');
});

test('uses getBackendUrl', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'getBackendUrl()');
});

test('uses fetchWithTimeout', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'fetchWithTimeout');
});

test('uses getAuthHeaders', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'getAuthHeaders()');
});

test('uses parseErrorResponse', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'parseErrorResponse');
});

test('checks online status', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'isOnline()');
});

// -----------------------------------------------------------------------------
// Caption Generation Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mCaption Generation:\x1b[0m');

test('has generateCaptions function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'async function generateCaptions');
});

test('has getLastTranscript function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function getLastTranscript');
});

test('has setCaptionTranscript function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function setCaptionTranscript');
});

test('checks for transcript availability', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'No transcript available');
});

// -----------------------------------------------------------------------------
// Caption Preview Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mCaption Preview:\x1b[0m');

test('has renderCaptionPreview function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function renderCaptionPreview');
});

test('has formatCaptionText function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function formatCaptionText');
});

test('has formatCaptionTime function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function formatCaptionTime');
});

test('limits preview to 10 items', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'slice(0, 10)');
});

test('highlights keywords in preview', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'caption-keyword');
});

test('has updateCaptionStats function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function updateCaptionStats');
});

// -----------------------------------------------------------------------------
// Export Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mExport Functions:\x1b[0m');

test('has exportCaptions function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'async function exportCaptions');
});

test('supports SRT export', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, "format === 'mogrt'");
});

test('supports MOGRT export', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, '/captions/export/mogrt');
});

test('has flattenCaptionWords function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function flattenCaptionWords');
});

test('has copyCaptionsToClipboard function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'async function copyCaptionsToClipboard');
});

test('has downloadJSON helper', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function downloadJSON');
});

test('has downloadText helper', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function downloadText');
});

// -----------------------------------------------------------------------------
// Timeline Integration Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mTimeline Integration:\x1b[0m');

test('has applyCaptionsToTimeline function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'async function applyCaptionsToTimeline');
});

test('uses jsx.call for markers', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, "jsx.call('createMarker'");
});

// -----------------------------------------------------------------------------
// UI Helpers Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mUI Helpers:\x1b[0m');

test('has showCaptionStatus function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function showCaptionStatus');
});

test('supports status types (info, success, error)', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'caption-status-info');
    assertContains(content, 'caption-status-success');
    assertContains(content, 'caption-status-error');
});

test('has updateGenerateButton function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'function updateGenerateButton');
});

test('has section toggle function', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, 'toggleCaptionsSection');
});

test('uses classList.toggle', () => {
    const jsPath = path.join(PANEL_ROOT, 'js', 'animatedCaptions.js');
    const content = fs.readFileSync(jsPath, 'utf8');
    assertContains(content, "classList.toggle('collapsed')");
});

// -----------------------------------------------------------------------------
// CSS Style Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mCSS Styles:\x1b[0m');

test('has captions section styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.captions-section');
});

test('has captions panel styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.captions-panel');
});

test('has template gallery styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.caption-template-gallery');
});

test('has template card styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.caption-template-card');
    assertContains(content, '.caption-template-card.selected');
});

test('has template preview styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.template-preview-mrbeast');
    assertContains(content, '.template-preview-hormozi');
    assertContains(content, '.template-preview-gaming');
    assertContains(content, '.template-preview-corporate');
    assertContains(content, '.template-preview-karaoke');
});

test('has caption preview styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.caption-preview-list');
    assertContains(content, '.caption-preview-item');
});

test('has caption status styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.caption-status-info');
    assertContains(content, '.caption-status-success');
    assertContains(content, '.caption-status-error');
});

test('has keyword highlight styles', () => {
    const cssPath = path.join(PANEL_ROOT, 'css', 'style.css');
    const content = fs.readFileSync(cssPath, 'utf8');
    assertContains(content, '.caption-keyword');
});

// -----------------------------------------------------------------------------
// Main.js Integration Tests
// -----------------------------------------------------------------------------
console.log('\n\x1b[33mMain.js Integration:\x1b[0m');

test('main.js initializes animated captions', () => {
    const mainPath = path.join(PANEL_ROOT, 'js', 'main.js');
    const content = fs.readFileSync(mainPath, 'utf8');
    assertContains(content, 'initAnimatedCaptions');
});

// -----------------------------------------------------------------------------
// Summary
// -----------------------------------------------------------------------------
console.log('\n\x1b[36m=== Test Summary ===\x1b[0m');
console.log(`  Passed: \x1b[32m${passed}\x1b[0m`);
console.log(`  Failed: \x1b[31m${failed}\x1b[0m`);
console.log(`  Total:  ${passed + failed}`);

if (failed > 0) {
    process.exit(1);
} else {
    console.log('\n\x1b[32mAll animated captions tests passed!\x1b[0m\n');
}
