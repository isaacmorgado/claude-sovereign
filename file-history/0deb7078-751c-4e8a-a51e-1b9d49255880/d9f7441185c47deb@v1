/**
 * SPLICE CEP Social Reframe Module E2E Tests
 * Tests social media reframe functionality
 */

const fs = require('fs');
const path = require('path');

// Test configuration
const PANEL_PATH = path.join(__dirname, '../panel');
const JS_PATH = path.join(PANEL_PATH, 'js');
const CSS_PATH = path.join(PANEL_PATH, 'css');

// Test counters
let passed = 0;
let failed = 0;
const failures = [];

function test(name, fn) {
    try {
        fn();
        passed++;
        console.log(`  ✓ ${name}`);
    } catch (e) {
        failed++;
        failures.push({ name, error: e.message });
        console.log(`  ✗ ${name}`);
        console.log(`    ${e.message}`);
    }
}

function assertEqual(actual, expected, message = '') {
    if (actual !== expected) {
        throw new Error(`${message}: Expected "${expected}", got "${actual}"`);
    }
}

function assertTrue(value, message = '') {
    if (!value) {
        throw new Error(`${message}: Expected truthy value, got ${value}`);
    }
}

function assertFalse(value, message = '') {
    if (value) {
        throw new Error(`${message}: Expected falsy value, got ${value}`);
    }
}

function assertContains(haystack, needle, message = '') {
    if (!haystack.includes(needle)) {
        throw new Error(`${message}: "${needle}" not found in content`);
    }
}

function assertNotContains(haystack, needle, message = '') {
    if (haystack.includes(needle)) {
        throw new Error(`${message}: "${needle}" should not be in content`);
    }
}

// ============================================================================
// TEST SUITES
// ============================================================================

console.log('\n=== SPLICE CEP Social Reframe Module E2E Tests ===\n');

// ----------------------------------------------------------------------------
// 1. File Structure Tests
// ----------------------------------------------------------------------------
console.log('1. File Structure Tests');

test('socialReframe.js exists', () => {
    const filePath = path.join(JS_PATH, 'socialReframe.js');
    assertTrue(fs.existsSync(filePath), 'File should exist');
});

test('socialReframe.js is included in index.html', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'js/socialReframe.js', 'Script tag should exist');
});

test('socialReframe.js loads after dependencies', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    const configPos = indexHtml.indexOf('js/config.js');
    const socialReframePos = indexHtml.indexOf('js/socialReframe.js');
    assertTrue(configPos < socialReframePos, 'config.js should load before socialReframe.js');
});

test('socialReframe.js loads before main.js', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    const socialReframePos = indexHtml.indexOf('js/socialReframe.js');
    const mainPos = indexHtml.indexOf('js/main.js');
    assertTrue(socialReframePos < mainPos, 'socialReframe.js should load before main.js');
});

// ----------------------------------------------------------------------------
// 2. HTML Structure Tests
// ----------------------------------------------------------------------------
console.log('\n2. HTML Structure Tests');

test('social reframe section exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="socialReframeSection"', 'Section should exist');
});

test('social reframe toggle exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="socialReframeToggle"', 'Toggle should exist');
});

test('social reframe panel exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="social-reframe-panel"', 'Panel should exist');
});

test('platform selector exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="reframe-platform-selector"', 'Platform selector should exist');
});

test('aspect ratio selector exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="reframe-aspect-selector"', 'Aspect selector should exist');
});

test('motion smoothing slider exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="motion-smoothing-slider"', 'Smoothing slider should exist');
});

test('smoothing value display exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="smoothing-value-display"', 'Value display should exist');
});

test('analyze button exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="analyze-reframe-btn"', 'Analyze button should exist');
});

test('safe zones toggle button exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="toggle-safe-zones-btn"', 'Safe zones button should exist');
});

test('status display exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="reframe-status"', 'Status display should exist');
});

test('analysis results container exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="reframe-analysis-results"', 'Analysis results should exist');
});

test('preview canvas exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="reframe-preview-canvas"', 'Preview canvas should exist');
});

test('export button exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="export-reframe-btn"', 'Export button should exist');
});

test('export all button exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="export-all-formats-btn"', 'Export all button should exist');
});

test('export results container exists', () => {
    const indexHtml = fs.readFileSync(path.join(PANEL_PATH, 'index.html'), 'utf8');
    assertContains(indexHtml, 'id="reframe-export-results"', 'Export results should exist');
});

// ----------------------------------------------------------------------------
// 3. CSS Styling Tests
// ----------------------------------------------------------------------------
console.log('\n3. CSS Styling Tests');

test('social reframe section styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.social-reframe-section', 'Section styles should exist');
});

test('social reframe panel styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.social-reframe-panel', 'Panel styles should exist');
});

test('collapsed state styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.social-reframe-panel.collapsed', 'Collapsed styles should exist');
});

test('platform selector styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-platform-selector', 'Platform selector styles should exist');
});

test('platform button styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-platform-btn', 'Platform button styles should exist');
});

test('platform button selected state exists', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-platform-btn.selected', 'Selected state styles should exist');
});

test('aspect ratio selector styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-aspect-selector', 'Aspect selector styles should exist');
});

test('aspect ratio button styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-aspect-btn', 'Aspect button styles should exist');
});

test('platform icon styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.platform-icon', 'Platform icon styles should exist');
});

test('TikTok platform icon styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.platform-icon-tiktok', 'TikTok icon styles should exist');
});

test('Reels platform icon styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.platform-icon-reels', 'Reels icon styles should exist');
});

test('Shorts platform icon styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.platform-icon-shorts', 'Shorts icon styles should exist');
});

test('aspect preview styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.aspect-preview', 'Aspect preview styles should exist');
});

test('aspect preview portrait styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.aspect-preview-portrait', 'Portrait preview styles should exist');
});

test('aspect preview square styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.aspect-preview-square', 'Square preview styles should exist');
});

test('reframe status styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-status', 'Status styles should exist');
});

test('status type styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-status-info', 'Info status style should exist');
    assertContains(css, '.reframe-status-success', 'Success status style should exist');
    assertContains(css, '.reframe-status-error', 'Error status style should exist');
});

test('analysis results styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-analysis-results', 'Analysis results styles should exist');
});

test('analysis summary styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.analysis-summary', 'Summary styles should exist');
});

test('analysis stat styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.analysis-stat', 'Stat styles should exist');
});

test('format suggestion styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.format-suggestion', 'Format suggestion styles should exist');
});

test('preview canvas styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-preview-canvas', 'Preview canvas styles should exist');
});

test('export results styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.reframe-export-results', 'Export results styles should exist');
});

test('export item styles exist', () => {
    const css = fs.readFileSync(path.join(CSS_PATH, 'style.css'), 'utf8');
    assertContains(css, '.export-item', 'Export item styles should exist');
});

// ----------------------------------------------------------------------------
// 4. JavaScript Module Structure Tests
// ----------------------------------------------------------------------------
console.log('\n4. JavaScript Module Structure Tests');

const socialReframeJS = fs.readFileSync(path.join(JS_PATH, 'socialReframe.js'), 'utf8');

test('module has state object', () => {
    assertContains(socialReframeJS, 'socialReframeState', 'State object should exist');
});

test('state has platforms property', () => {
    assertContains(socialReframeJS, 'platforms:', 'platforms property should exist');
});

test('state has aspectRatios property', () => {
    assertContains(socialReframeJS, 'aspectRatios:', 'aspectRatios property should exist');
});

test('state has selectedPlatform property', () => {
    assertContains(socialReframeJS, 'selectedPlatform:', 'selectedPlatform property should exist');
});

test('state has selectedAspectRatio property', () => {
    assertContains(socialReframeJS, 'selectedAspectRatio:', 'selectedAspectRatio property should exist');
});

test('state has analysis property', () => {
    assertContains(socialReframeJS, 'analysis:', 'analysis property should exist');
});

test('state has isAnalyzing property', () => {
    assertContains(socialReframeJS, 'isAnalyzing:', 'isAnalyzing property should exist');
});

test('state has isExporting property', () => {
    assertContains(socialReframeJS, 'isExporting:', 'isExporting property should exist');
});

test('state has currentVideoPath property', () => {
    assertContains(socialReframeJS, 'currentVideoPath:', 'currentVideoPath property should exist');
});

test('state has safeZones property', () => {
    assertContains(socialReframeJS, 'safeZones:', 'safeZones property should exist');
});

test('state has showSafeZones property', () => {
    assertContains(socialReframeJS, 'showSafeZones:', 'showSafeZones property should exist');
});

// ----------------------------------------------------------------------------
// 5. DOM Element Cache Tests
// ----------------------------------------------------------------------------
console.log('\n5. DOM Element Cache Tests');

test('module has element cache object', () => {
    assertContains(socialReframeJS, 'reframeElements', 'Element cache should exist');
});

test('cacheReframeElements function exists', () => {
    assertContains(socialReframeJS, 'function cacheReframeElements', 'Cache function should exist');
});

// ----------------------------------------------------------------------------
// 6. Initialization Tests
// ----------------------------------------------------------------------------
console.log('\n6. Initialization Tests');

test('initSocialReframe function exists', () => {
    assertContains(socialReframeJS, 'async function initSocialReframe', 'Init function should exist');
});

test('loadPlatformPresets function exists', () => {
    assertContains(socialReframeJS, 'async function loadPlatformPresets', 'Load presets function should exist');
});

test('setupReframeEventListeners function exists', () => {
    assertContains(socialReframeJS, 'function setupReframeEventListeners', 'Event listeners function should exist');
});

test('module initializes element cache', () => {
    assertContains(socialReframeJS, 'cacheReframeElements()', 'Should call cache function');
});

test('module loads platform presets on init', () => {
    assertContains(socialReframeJS, 'await loadPlatformPresets', 'Should load presets');
});

// ----------------------------------------------------------------------------
// 7. Platform Presets Tests
// ----------------------------------------------------------------------------
console.log('\n7. Platform Presets Tests');

test('loads presets from /reframe/platforms endpoint', () => {
    assertContains(socialReframeJS, '/reframe/platforms', 'Should call platforms endpoint');
});

test('has fallback platforms', () => {
    assertContains(socialReframeJS, "'tiktok'", 'Should have TikTok fallback');
    assertContains(socialReframeJS, "'reels'", 'Should have Reels fallback');
    assertContains(socialReframeJS, "'shorts'", 'Should have Shorts fallback');
});

test('has fallback aspect ratios', () => {
    assertContains(socialReframeJS, "'portrait'", 'Should have portrait fallback');
    assertContains(socialReframeJS, "'square'", 'Should have square fallback');
});

// ----------------------------------------------------------------------------
// 8. Platform Selection Tests
// ----------------------------------------------------------------------------
console.log('\n8. Platform Selection Tests');

test('renderPlatformSelector function exists', () => {
    assertContains(socialReframeJS, 'function renderPlatformSelector', 'Render platforms function should exist');
});

test('renderAspectRatioSelector function exists', () => {
    assertContains(socialReframeJS, 'function renderAspectRatioSelector', 'Render aspects function should exist');
});

test('selectPlatform function exists', () => {
    assertContains(socialReframeJS, 'function selectPlatform', 'Select platform function should exist');
});

test('selectAspectRatio function exists', () => {
    assertContains(socialReframeJS, 'function selectAspectRatio', 'Select aspect function should exist');
});

test('platform selection updates state', () => {
    assertContains(socialReframeJS, 'selectedPlatform = platformId', 'Should update selected platform');
});

test('platform selection loads safe zones', () => {
    assertContains(socialReframeJS, 'loadSafeZones(platformId)', 'Should load safe zones on select');
});

// ----------------------------------------------------------------------------
// 9. Safe Zones Tests
// ----------------------------------------------------------------------------
console.log('\n9. Safe Zones Tests');

test('loadSafeZones function exists', () => {
    assertContains(socialReframeJS, 'async function loadSafeZones', 'Load safe zones function should exist');
});

test('loads safe zones from API', () => {
    assertContains(socialReframeJS, '/reframe/safe-zones/', 'Should call safe zones endpoint');
});

test('toggleSafeZones function exists', () => {
    assertContains(socialReframeJS, 'function toggleSafeZones', 'Toggle function should exist');
});

test('toggle updates showSafeZones state', () => {
    assertContains(socialReframeJS, 'showSafeZones = !socialReframeState.showSafeZones', 'Should toggle state');
});

// ----------------------------------------------------------------------------
// 10. Analysis Tests
// ----------------------------------------------------------------------------
console.log('\n10. Analysis Tests');

test('analyzeForReframe function exists', () => {
    assertContains(socialReframeJS, 'async function analyzeForReframe', 'Analyze function should exist');
});

test('analyze calls /reframe/analyze endpoint', () => {
    assertContains(socialReframeJS, '/reframe/analyze', 'Should call analyze endpoint');
});

test('getCurrentVideoPath function exists', () => {
    assertContains(socialReframeJS, 'function getCurrentVideoPath', 'Get video path function should exist');
});

test('setVideoPath function exists', () => {
    assertContains(socialReframeJS, 'function setVideoPath', 'Set video path function should exist');
});

test('renderAnalysisResults function exists', () => {
    assertContains(socialReframeJS, 'function renderAnalysisResults', 'Render results function should exist');
});

test('getAspectRatioName function exists', () => {
    assertContains(socialReframeJS, 'function getAspectRatioName', 'Get aspect name function should exist');
});

// ----------------------------------------------------------------------------
// 11. Preview Tests
// ----------------------------------------------------------------------------
console.log('\n11. Preview Tests');

test('updateCropPreview function exists', () => {
    assertContains(socialReframeJS, 'function updateCropPreview', 'Update preview function should exist');
});

test('renderSafeZoneOnCanvas function exists', () => {
    assertContains(socialReframeJS, 'function renderSafeZoneOnCanvas', 'Render safe zone function should exist');
});

test('renderSafeZoneOverlay function exists', () => {
    assertContains(socialReframeJS, 'function renderSafeZoneOverlay', 'Render overlay function should exist');
});

test('preview uses canvas 2D context', () => {
    assertContains(socialReframeJS, "getContext('2d')", 'Should use 2D context');
});

test('preview draws crop region', () => {
    assertContains(socialReframeJS, 'strokeRect', 'Should draw stroke rectangle');
});

test('preview draws face indicator', () => {
    assertContains(socialReframeJS, 'faceTracking', 'Should reference face tracking');
});

// ----------------------------------------------------------------------------
// 12. Export Tests
// ----------------------------------------------------------------------------
console.log('\n12. Export Tests');

test('exportReframe function exists', () => {
    assertContains(socialReframeJS, 'async function exportReframe', 'Export function should exist');
});

test('exportAllFormats function exists', () => {
    assertContains(socialReframeJS, 'async function exportAllFormats', 'Export all function should exist');
});

test('export calls /reframe/export endpoint', () => {
    assertContains(socialReframeJS, '/reframe/export', 'Should call export endpoint');
});

test('renderExportResults function exists', () => {
    assertContains(socialReframeJS, 'function renderExportResults', 'Render export function should exist');
});

test('export results include FFmpeg copy button', () => {
    assertContains(socialReframeJS, 'copy-ffmpeg-btn', 'Should have copy button');
});

test('copy handler uses clipboard API', () => {
    assertContains(socialReframeJS, 'navigator.clipboard.writeText', 'Should use clipboard API');
});

// ----------------------------------------------------------------------------
// 13. Event Handling Tests
// ----------------------------------------------------------------------------
console.log('\n13. Event Handling Tests');

test('uses event delegation for clicks', () => {
    assertContains(socialReframeJS, "document.addEventListener('click'", 'Should use event delegation');
});

test('handles platform button clicks', () => {
    assertContains(socialReframeJS, '.reframe-platform-btn', 'Should handle platform clicks');
});

test('handles aspect ratio button clicks', () => {
    assertContains(socialReframeJS, '.reframe-aspect-btn', 'Should handle aspect clicks');
});

test('handles analyze button click', () => {
    assertContains(socialReframeJS, "e.target.id === 'analyze-reframe-btn'", 'Should handle analyze click');
});

test('handles export button click', () => {
    assertContains(socialReframeJS, "e.target.id === 'export-reframe-btn'", 'Should handle export click');
});

test('handles export all button click', () => {
    assertContains(socialReframeJS, "e.target.id === 'export-all-formats-btn'", 'Should handle export all click');
});

test('handles safe zones toggle click', () => {
    assertContains(socialReframeJS, "e.target.id === 'toggle-safe-zones-btn'", 'Should handle safe zones click');
});

test('uses event delegation for input', () => {
    assertContains(socialReframeJS, "document.addEventListener('input'", 'Should handle input events');
});

test('handles smoothing slider input', () => {
    assertContains(socialReframeJS, "e.target.id === 'motion-smoothing-slider'", 'Should handle slider input');
});

// ----------------------------------------------------------------------------
// 14. UI Helper Tests
// ----------------------------------------------------------------------------
console.log('\n14. UI Helper Tests');

test('showReframeStatus function exists', () => {
    assertContains(socialReframeJS, 'function showReframeStatus', 'Show status function should exist');
});

test('updateAnalyzeButton function exists', () => {
    assertContains(socialReframeJS, 'function updateAnalyzeButton', 'Update analyze button function should exist');
});

test('updateExportButton function exists', () => {
    assertContains(socialReframeJS, 'function updateExportButton', 'Update export button function should exist');
});

test('updateSmoothingValue function exists', () => {
    assertContains(socialReframeJS, 'function updateSmoothingValue', 'Update smoothing function should exist');
});

test('formatDuration function exists', () => {
    assertContains(socialReframeJS, 'function formatDuration', 'Format duration function should exist');
});

test('status types are handled', () => {
    assertContains(socialReframeJS, 'reframe-status-${type}', 'Should use type in class name');
});

// ----------------------------------------------------------------------------
// 15. API Integration Tests
// ----------------------------------------------------------------------------
console.log('\n15. API Integration Tests');

test('uses getBackendUrl for API calls', () => {
    assertContains(socialReframeJS, 'getBackendUrl', 'Should use getBackendUrl');
});

test('uses fetchWithTimeout for API calls', () => {
    assertContains(socialReframeJS, 'fetchWithTimeout', 'Should use fetchWithTimeout');
});

test('uses getAuthHeaders for authenticated calls', () => {
    assertContains(socialReframeJS, 'getAuthHeaders', 'Should use getAuthHeaders');
});

test('handles API fallbacks', () => {
    assertContains(socialReframeJS, "typeof getBackendUrl === 'function'", 'Should check getBackendUrl existence');
});

// ----------------------------------------------------------------------------
// 16. Exports Tests
// ----------------------------------------------------------------------------
console.log('\n16. Exports Tests');

test('exports window.spliceSocialReframe', () => {
    assertContains(socialReframeJS, 'window.spliceSocialReframe', 'Should export spliceSocialReframe');
});

test('exports init function', () => {
    assertContains(socialReframeJS, 'init: initSocialReframe', 'Should export init');
});

test('exports analyze function', () => {
    assertContains(socialReframeJS, 'analyze: analyzeForReframe', 'Should export analyze');
});

test('exports setVideoPath function', () => {
    assertContains(socialReframeJS, 'setVideoPath: setVideoPath', 'Should export setVideoPath');
});

test('exports selectPlatform function', () => {
    assertContains(socialReframeJS, 'selectPlatform: selectPlatform', 'Should export selectPlatform');
});

test('exports selectAspectRatio function', () => {
    assertContains(socialReframeJS, 'selectAspectRatio: selectAspectRatio', 'Should export selectAspectRatio');
});

test('exports export function', () => {
    assertContains(socialReframeJS, 'export: exportReframe', 'Should export export');
});

test('exports exportAll function', () => {
    assertContains(socialReframeJS, 'exportAll: exportAllFormats', 'Should export exportAll');
});

test('exports toggleSafeZones function', () => {
    assertContains(socialReframeJS, 'toggleSafeZones: toggleSafeZones', 'Should export toggleSafeZones');
});

test('exports getState function', () => {
    assertContains(socialReframeJS, 'getState:', 'Should export getState');
});

test('exports global initSocialReframe', () => {
    assertContains(socialReframeJS, 'window.initSocialReframe = initSocialReframe', 'Should export global init');
});

// ----------------------------------------------------------------------------
// 17. Main.js Integration Tests
// ----------------------------------------------------------------------------
console.log('\n17. Main.js Integration Tests');

const mainJS = fs.readFileSync(path.join(JS_PATH, 'main.js'), 'utf8');

test('main.js initializes social reframe', () => {
    assertContains(mainJS, 'initSocialReframe', 'Should call initSocialReframe');
});

test('main.js has social reframe toggle initialization', () => {
    assertContains(mainJS, 'initSocialReframeToggle', 'Should call initSocialReframeToggle');
});

test('main.js has initSocialReframeToggle function', () => {
    assertContains(mainJS, 'function initSocialReframeToggle', 'Should have toggle function');
});

test('social reframe toggle targets correct panel', () => {
    assertContains(mainJS, "getElementById('social-reframe-panel')", 'Should target reframe panel');
});

test('social reframe toggle updates icon', () => {
    assertContains(mainJS, '.toggle-icon', 'Should update toggle icon');
});

// ----------------------------------------------------------------------------
// 18. Error Handling Tests
// ----------------------------------------------------------------------------
console.log('\n18. Error Handling Tests');

test('handles missing video path', () => {
    assertContains(socialReframeJS, '!videoPath', 'Should check for video path');
    assertContains(socialReframeJS, 'No video selected', 'Should show error for missing video');
});

test('handles analyze before export', () => {
    assertContains(socialReframeJS, '!socialReframeState.analysis', 'Should check for analysis');
    assertContains(socialReframeJS, 'Analyze video first', 'Should show error for no analysis');
});

test('handles API errors', () => {
    assertContains(socialReframeJS, 'Reframe analysis error', 'Should log analysis errors');
    assertContains(socialReframeJS, 'Reframe export error', 'Should log export errors');
});

// ----------------------------------------------------------------------------
// 19. Canvas Drawing Tests
// ----------------------------------------------------------------------------
console.log('\n19. Canvas Drawing Tests');

test('clears canvas before drawing', () => {
    assertContains(socialReframeJS, 'clearRect', 'Should clear canvas');
});

test('draws video background', () => {
    assertContains(socialReframeJS, 'fillRect(videoX, videoY', 'Should draw background');
});

test('draws crop region with stroke', () => {
    assertContains(socialReframeJS, "strokeStyle = '#00ff00'", 'Should use green stroke');
});

test('draws face indicator', () => {
    assertContains(socialReframeJS, 'rgba(255, 0, 0, 0.3)', 'Should draw red face indicator');
});

test('draws safe zones with transparency', () => {
    assertContains(socialReframeJS, 'rgba(255, 0, 0, 0.15)', 'Should draw transparent safe zones');
});

// ============================================================================
// RESULTS SUMMARY
// ============================================================================
console.log('\n' + '='.repeat(50));
console.log(`RESULTS: ${passed} passed, ${failed} failed`);
console.log('='.repeat(50));

if (failures.length > 0) {
    console.log('\nFailed tests:');
    failures.forEach(f => {
        console.log(`  - ${f.name}: ${f.error}`);
    });
}

// Exit with appropriate code
process.exit(failed > 0 ? 1 : 0);
