"""
User database model
"""

import uuid
from datetime import datetime
from sqlalchemy import Column, String, DateTime, Enum, Boolean, Integer, Float
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
import enum

from app.database import Base


class PlanType(str, enum.Enum):
    FREE = "free"
    BASIC = "basic"
    PRO = "pro"


class UserRole(str, enum.Enum):
    USER = "user"
    MODERATOR = "moderator"
    ADMIN = "admin"


class User(Base):
    __tablename__ = "users"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    email = Column(String, unique=True, nullable=False, index=True)
    password_hash = Column(String, nullable=False)
    name = Column(String, nullable=True)
    username = Column(String(30), unique=True, nullable=False, index=True)
    terms_accepted_at = Column(DateTime, nullable=True)
    # Use values_callable to ensure enum VALUES are used (lowercase) instead of NAMES (uppercase)
    plan = Column(Enum(PlanType, values_callable=lambda x: [e.value for e in x]), default=PlanType.FREE)
    stripe_customer_id = Column(String, nullable=True)
    stripe_subscription_id = Column(String, nullable=True)

    # User role for moderation - use values_callable for enum values
    role = Column(Enum(UserRole, values_callable=lambda x: [e.value for e in x]), default=UserRole.USER)

    # Referral tracking
    referral_code = Column(String(50), nullable=True, index=True)  # Code used at signup
    referred_by = Column(String(100), nullable=True, index=True)  # Stripe promo code ID

    # Password reset
    password_reset_token = Column(String(255), nullable=True, index=True)
    password_reset_expires = Column(DateTime, nullable=True)

    # PSL System - Height & Weight
    height_cm = Column(Integer, nullable=True)  # User height in centimeters for PSL calculation
    weight_kg = Column(Float, nullable=True)  # User weight in kilograms for FFMI calculation

    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationships
    analyses = relationship("Analysis", back_populates="user", cascade="all, delete-orphan")
    payments = relationship("Payment", back_populates="user", cascade="all, delete-orphan")

    def __repr__(self):
        return f"<User {self.email}>"


class ReferralCode(Base):
    """Influencer referral codes linked to Stripe promotion codes"""
    __tablename__ = "referral_codes"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    code = Column(String(50), unique=True, nullable=False, index=True)
    influencer_name = Column(String(100), nullable=False)
    stripe_promotion_code_id = Column(String(100), nullable=True)
    stripe_coupon_id = Column(String(100), nullable=True)
    discount_percent = Column(Integer, default=10)
    is_active = Column(Boolean, default=True)
    total_uses = Column(Integer, default=0)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    def __repr__(self):
        return f"<ReferralCode {self.code}>"
