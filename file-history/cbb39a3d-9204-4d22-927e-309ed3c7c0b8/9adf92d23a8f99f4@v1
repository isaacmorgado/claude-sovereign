# LOOKSMAXX

A facial metrics analysis and visualization system with Next.js frontend and MediaPipe-based facial landmark detection. Now with FaceIQ-compatible scoring and results UI.

## Live URLs

- **Frontend**: https://looksmaxx-app.vercel.app
- **API**: https://api-production-6148.up.railway.app

## Tech Stack

- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Animation**: Framer Motion
- **Face Detection**: MediaPipe Tasks Vision (client, 478 landmarks) + InsightFace (server, 106 landmarks)
- **Scoring**: FaceIQ-compatible exponential decay with 70+ measurements
- **Backend**: FastAPI on Railway with PostgreSQL
- **Email**: SendGrid for transactional emails
- **Frontend Hosting**: Vercel

## Code Quality

```bash
cd looksmaxx-app && npm run lint && npx tsc --noEmit
```

## Completed Features

### Username & T&C System (2025-12-23) ✅
Full implementation deployed and tested end-to-end:
- User registration with unique username (3-30 chars, alphanumeric + underscore)
- Terms & Conditions acceptance required for signup
- Leaderboard displays usernames instead of anonymous IDs
- Username availability check endpoint
- DB migrations applied on Railway

### Scoring System - 100% Complete ✅ (Verified 2025-12-25)

| Component | Count | File | Details |
|-----------|-------|------|---------|
| **Bezier Curves** | 67 | `looksmaxx-app/src/lib/bezier-curves.ts` | Complete cubic Bezier interpolation with 10-15 control points |
| **Decay Rates** | 80+ | `looksmaxx-app/src/lib/data/metric-configs.ts` | 0.08-1.0 range (calibrated per metric type - angles use 0.5-1.0, ratios use 0.08-0.30) |
| **Ethnicity Overrides** | 16 demographics | `looksmaxx-app/src/lib/data/demographic-overrides.ts` | 8 ethnicities × 2 genders = 16 combos with 130+ individual metric overrides |
| **Severity Tiers** | 6 + 5 | Two systems: Raw scoring (6-tier: extremely_severe→optimal) + Insights (5-tier: ideal→severe) |
| **Quality Tiers** | 4 | `looksmaxx-app/src/lib/scoring/types.ts` | ideal/excellent/good/below_average |
| **PSL Rating** | 10 tiers | `looksmaxx-app/src/lib/psl-calculator.ts` | 1-10 scale with percentile mapping |
| **Total Metrics** | 80+ | `looksmaxx-app/src/lib/data/metric-configs.ts` | Front + side profile measurements |

### Treatment System - 100% Complete ✅ (Verified 2025-12-25)

| Component | Count | File | Details |
|-----------|-------|------|---------|
| **Procedure Impact Tables** | 30+ | `looksmaxx-app/src/lib/advice-engine.ts` | Quantitative % changes per metric |
| **Treatment Metadata** | Full | `looksmaxx-app/src/lib/advice-engine.ts` | priority_score, effectiveness, ratios_impacted, pillars |
| **Potential Score Prediction** | Yes | `looksmaxx-app/src/lib/recommendations/severity.ts:644-693` | `estimatePotentialPSL()` with 20% diminishing returns |
| **Multi-Procedure Plans** | 5 phases | `looksmaxx-app/src/lib/recommendations/engine.ts` | Lifestyle → Softmaxxing → Non-Surgical → Minimally Invasive → Surgical |
| **Order of Operations** | Yes | `looksmaxx-app/src/lib/recommendations/engine.ts:517-577` | `generateOrderOfOperations()` with prerequisites |
| **Gender-Specific Treatments** | Yes | `looksmaxx-app/src/lib/advice-engine.ts` | V-line Surgery, Masseter Botox (female-only) |

### UI Components ✅

| Component | File | Details |
|-----------|------|---------|
| **Side Profile Depth Validation** | `looksmaxx-app/src/lib/mediapipeDetection.ts` | `validateSideProfileDepth()` validates 3D depth |
| **Before/After Preview** | `looksmaxx-app/src/components/results/visualization/BeforeAfterPreview.tsx` | Visual overlay showing improvements |
| **Treatment Timeline** | `looksmaxx-app/src/components/results/visualization/TreatmentTimeline.tsx` | Phase-based treatment sequencing UI |
| **Error Boundary** | `looksmaxx-app/src/app/results/page.tsx` | Graceful error handling for results page |

### Female Analysis ✅
- 8 ethnicity overrides with distinct ideal ranges
- Sexual dimorphism (narrower jaws, softer angles, larger eyes)
- Female-specific treatments (V-line surgery, Masseter Botox)
- Gender filtering in recommendation engine

## Key Files

### Backend (`looksmaxx-api/`)
- `app/routers/auth.py` - Registration, login, password reset endpoints
- `app/routers/referrals.py` - Influencer referral code management
- `app/routers/leaderboard.py` - Leaderboard with usernames
- `app/routers/physique.py` - Physique upload, body analysis, face extraction
- `app/services/email.py` - SendGrid email service (password reset, welcome emails)
- `app/services/vision_service.py` - Claude Vision face + body analysis
- `app/models/user.py` - User model with username/terms fields
- `app/models/physique.py` - PhysiqueAnalysis + VisionExtraction models
- `app/schemas/user.py` - Validation schemas
- `migrations/006_add_physique_tables.sql` - Physique + vision tables

### Frontend (`looksmaxx-app/`)
- `src/app/signup/page.tsx` - Signup with username, T&C, referral code
- `src/app/terms/page.tsx` - Terms & Conditions page
- `src/app/login/page.tsx` - Email/password login
- `src/app/forgot-password/page.tsx` - Password reset request
- `src/app/reset-password/page.tsx` - Password reset form
- `src/app/analysis/page.tsx` - Face + physique analysis flow
- `src/lib/api.ts` - API client methods
- `src/app/forum/` - Community forum pages
- `src/components/forum/` - Forum components
- `src/contexts/ForumContext.tsx` - Forum state management
- `src/contexts/PhysiqueContext.tsx` - Physique photos + analysis state
- `src/types/forum.ts` - Forum TypeScript types

## PostgreSQL Access (Debug)

```bash
export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"
psql "postgresql://postgres:pCADzvPqsoWVWCozIwkjPybkTRUzwbZu@shortline.proxy.rlwy.net:10999/railway"
```

### Auth System (2025-12-23) ✅
- Email/password login (replaced Google OAuth)
- Forgot password flow with secure token
- SendGrid-powered password reset emails
- Password reset page with token validation
- Referral code field on signup with Stripe promotion code integration

### Referral System (2025-12-23) ✅
- Influencer referral codes stored in `referral_codes` table
- Linked to Stripe promotion codes for automatic discounts
- Validation endpoint for real-time code checking
- Usage tracking and analytics
- Admin endpoints for managing codes

### Infrastructure Fixes (2025-12-24) ✅
- Fixed Railway OOM crashes with lazy-loaded InsightFace model
- SendGrid integration for transactional emails

### Archetype Classification (2025-12-25) ✅
Full archetype classification system:

**Frontend**:
- Archetype data: `looksmaxx-app/src/data/archetypes.json` - 6 categories with sub-archetypes
- Classifier: `looksmaxx-app/src/lib/archetype-classifier.ts` - Scoring using gonialAngle, FWHR, canthalTilt
- Components: `looksmaxx-app/src/components/psl/archetype/` - ArchetypeCard, ArchetypeTraits
- Tab: `looksmaxx-app/src/components/results/tabs/ArchetypeTab.tsx` - Full archetype analysis page
- API methods: `looksmaxx-app/src/lib/api.ts` - classifyArchetype, getArchetypeDefinitions

**Backend**:
- Service: `looksmaxx-api/app/services/archetype_service.py` - Classification logic
- Router: `looksmaxx-api/app/routers/archetype.py` - POST /archetype/classify, GET /archetype/definitions

**Categories**: Softboy, Prettyboy, RobustPrettyboy, Chad, Hypermasculine (Warrior), Exotic

### Claude Vision Feature Extraction (2025-12-25) ✅
Full psl.md spec implementation with E2E tested face + body feature extraction:

**Backend:**
- `app/services/vision_service.py` - **NEW** Unified Claude Vision service
- `app/models/physique.py` - PhysiqueAnalysis + VisionExtraction models
- `app/routers/physique.py` - Photo upload, body analysis, face extraction endpoints
- `migrations/006_add_physique_tables.sql` - Database tables

**Face Features Extracted:**
| Category | Features |
|----------|----------|
| Skin | clarity (0-10), tone, acne_level, acne_scarring, pore_visibility, texture_issues |
| Hair | hairline_nw (0-7 Norwood), density, texture, color |
| Eyes | color, under_eye_darkness (0-10), under_eye_puffiness (0-10) |
| Facial | hollow_cheeks (0-10), eyebrow_density, facial_hair_potential |
| Teeth | color, alignment, visible |

**Body Features Extracted:**
- body_fat_percent (5-45%), muscle_mass, frame_size, shoulder_width, waist_definition, posture

**API Endpoints:**
- `POST /physique/upload` - Upload physique photos to S3
- `POST /physique/analyze` - Claude Vision body analysis
- `POST /physique/extract-face` - Claude Vision face feature extraction
- `GET /physique/my-analysis` - Get stored body analysis
- `GET /physique/my-face-features` - Get stored face extraction

**E2E Testing:** 11 bugs found and fixed (migration, type mismatches, memory leaks, persistence)

### Community Forum (2025-12-25) ✅
Full Reddit-style forum implementation:

**Backend (Phase 1)**:
- 7 database models: ForumIssueCategory, ForumSubForum, FlawToForumMapping, ForumPost, ForumComment, ForumVote, ForumReport
- 21 API endpoints in `app/routers/forum.py`
- 12 categories, 41 sub-forums, 17 flaw mappings seeded
- N+1 query optimization (54 queries → 2 queries)
- Live at: `https://api-production-6148.up.railway.app/forum/`

**Frontend (Phase 2)**:
- TypeScript types: `src/types/forum.ts`
- 16 API methods in `src/lib/api.ts`
- ForumContext: `src/contexts/ForumContext.tsx`
- Pages: `/forum`, `/forum/[categorySlug]`, `/forum/post/[postId]`
- Components: CategoryCard, PostCard, VoteButtons, CommentThread, CreatePostForm

**QA Fixes (Phase 3)**:
- Added try-catch to handleCreatePost
- Fixed duplicate API calls on mount (useRef pattern)
- Added empty subForums warning
- Fixed stale closure in pagination (offsetRef)
- Added loading state to VoteButtons
- Added confirmation dialog for comment deletion

### Archetype → Forum Integration (2025-12-25) ✅
Maps archetypes to relevant forum communities:

**Backend**:
- `migrations/007_add_archetype_forum_mappings.sql` - Table + 22 seed mappings
- `app/models/forum.py` - Added ArchetypeForumMapping model
- `app/schemas/forum.py` - Added ArchetypeForumRecommendation schema
- `app/routers/forum.py` - Added GET /forum/archetype-recommendations?archetype=X

**Frontend**:
- `src/lib/api.ts` - getArchetypeForumRecommendations() method
- `src/components/results/tabs/CommunityTab.tsx` - "Based on Your Archetype" section
- `src/components/results/tabs/ArchetypeTab.tsx` - RecommendedForumsSection component

**Mappings**: Each archetype (Softboy, Prettyboy, RobustPrettyboy, Chad, Hypermasculine, Exotic) → relevant forum categories (Fashion, Body Composition, etc.)

## Remaining Tasks

### Future
1. Implement supplement/product e-commerce layer (see `supplement_implementation.md`)
2. Add forum link to main navigation
3. Configure Stripe API keys in Railway for payment processing

### Cleanup (Optional)
4. Remove debug logging from `looksmaxx-api/app/routers/leaderboard.py`
5. Clean up test users from database
6. Remove console.log debugging from results page

## Last Session (2025-12-26)

Completed Sprint 7: Auth Fix & E2E Testing

**Issues Fixed:**
1. **Auth endpoints 500 errors** - Root cause: Database migration `005_add_height_cm.sql` was never applied, and PostgreSQL enum values were mismatched (DB had uppercase `plantype` but lowercase `userrole`)

**Fixes Applied:**
- Applied missing migration `005_add_height_cm.sql` to add `height_cm` and `weight_kg` columns
- Fixed `PlanType` enum values: changed from lowercase (`free`) to uppercase (`FREE`) to match database
- Optimized auth queries to select only needed columns (`select(User.id)` instead of `select(User)`)
- Added explicit `UserResponse` serialization to avoid enum conversion issues
- Removed `db.refresh(user)` to prevent schema mismatch on new user insert

**Files Modified:**
| Component | File | Changes |
|-----------|------|---------|
| User Model | `looksmaxx-api/app/models/user.py` | Fixed PlanType enum values (uppercase), added `values_callable` for enum columns |
| Auth Router | `looksmaxx-api/app/routers/auth.py` | Optimized queries, explicit UserResponse creation |

**Created Referral Codes:**
- ALEX20 (Alex Johnson, 20% off)
- MIKE25 (Mike Davis, 25% off)
- SARAH30 (Sarah Williams, 30% off)

**API Status:**
| Endpoint | Status | Notes |
|----------|--------|-------|
| `/auth/register` | ✅ Working | User creation with referral codes |
| `/auth/login` | ✅ Working | Returns JWT token |
| `/auth/check-username/{username}` | ✅ Working | Availability check |
| `/auth/validate-referral/{code}` | ✅ Working | 5 codes active |
| `/auth/me` | ✅ Working | Returns user profile |
| `/forum/categories` | ✅ Working | 12 categories |
| `/archetype/definitions` | ✅ Working | 6 archetypes |
| `/psl/tiers` | ✅ Working | 10 PSL tiers |
| `/referrals/list` | ✅ Working | 5 referral codes |
| `/payments/checkout` | ⚠️ Needs Stripe key | Code verified correct |

**Database Status:**
- 11+ users in database
- 5 referral codes configured (NICKJ, TESTINFLUENCER, ALEX20, MIKE25, SARAH30)
- All tables present with correct schema

**All checks pass:** `npm run lint && npx tsc --noEmit` ✅
