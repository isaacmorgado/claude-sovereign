# SPLICE Feature Implementation Plan

Based on comprehensive analysis of Fireside deobfuscated modules.

## Implementation Status

### Priority 1 - Core Improvements

| # | Feature | Status | Files |
|---|---------|--------|-------|
| 1 | RMS-based silence detection | ✅ Complete | `splice-backend/services/rmsSilenceDetection.js` |
| 2 | Profanity detection & bleeping | ✅ Complete | `splice-backend/services/profanityDetection.js` |
| 3 | Padding controls (before/after cuts) | ✅ Complete | Included in rmsSilenceDetection.js |
| 4 | Turbo cutting method (XML-based) | ⏳ Pending | `splice-plugin/js/turbo-cutter.js` |

### Priority 2 - New Features

| # | Feature | Status | Files |
|---|---------|--------|-------|
| 5 | Multitrack/Multicam editing | ✅ Complete | `splice-backend/services/multitrackAnalysis.js` |
| 6 | Repetition/stutter detection | ✅ Complete | `splice-backend/services/repetitionDetection.js` |
| 7 | J-cuts (audio offset) | ⏳ Pending | Cut list generator + builder |
| 8 | Auto-balance optimizer | ✅ Complete | Included in multitrackAnalysis.js |

### Priority 3 - Enhancements

| # | Feature | Status | Files |
|---|---------|--------|-------|
| 9 | Custom profanity blocklist/allowlist | ✅ Complete | Included in profanityDetection.js |
| 10 | Zoom animations with easing | ⏳ Pending | `splice-plugin/js/effects.js` |
| 11 | Chapter markers | ⏳ Pending | Plugin markers API |
| 12 | Advanced threshold auto-detection | ✅ Complete | Included in rmsSilenceDetection.js |

---

## Feature Details

### 1. RMS-Based Silence Detection

**Current SPLICE approach:**
- Uses Whisper transcript gaps (misses actual audio silence)
- OR FFprobe with fixed -30dB threshold

**Fireside approach (to implement):**
- Extract raw audio as WAV
- Calculate RMS (Root Mean Square) values across sliding windows
- Convert to dBFS (decibels relative to full scale)
- Auto-detect threshold from audio histogram
- Configurable: threshold, min duration, padding, seek step

**Parameters:**
```javascript
{
  threshold: -30,           // dBFS (-60 to -20)
  minSilenceLength: 500,    // milliseconds
  seekStep: 100,            // analysis window step (ms)
  paddingStart: 100,        // ms buffer before cut
  paddingEnd: 50,           // ms buffer after cut
  autoThreshold: true       // auto-detect from audio
}
```

**Key algorithms:**
- Gaussian blur for histogram smoothing
- Local maxima detection for speech/silence peaks
- Threshold interpolation between peaks

---

### 2. Profanity Detection & Bleeping

**Features:**
- Word-level profanity identification from transcript
- Mute or bleep options
- Custom blocklist (add words)
- Custom allowlist (exclude words)
- Multiple bleep sounds

**Workflow:**
1. Transcribe audio (existing)
2. Mark profanity words in transcript
3. Group contiguous profanity into segments
4. Apply mute OR insert bleep audio clips

**Bleep sounds:**
- Standard censor beep (1000Hz)
- TV bleep
- Radio bleep
- Custom user sounds

---

### 3. Padding Controls

**Add to settings:**
- Padding before cut (ms): 0-500
- Padding after cut (ms): 0-500

**Implementation:**
- Modify `cutListGenerator.js` to apply padding
- Extend silence start by `paddingStart`
- Reduce silence end by `paddingEnd`
- Merge silences that overlap after padding

---

### 4. Turbo Cutting (XML-Based)

**Current SPLICE approach:**
- UXP DOM manipulation (works but slower for many cuts)

**Fireside turbo approach:**
- Export sequence to FCP XML
- Directly modify XML DOM
- Split clips at cut points
- Remove silence clips
- Reload modified project

**Benefits:**
- 10-100x faster for 2000+ cuts
- Handles transitions correctly
- Preserves clip links

---

### 5. Multitrack/Multicam Editing

**Features:**
- Analyze audio levels per speaker/track
- Auto-select video angle based on loudest speaker
- Wide shot detection (multiple speakers)
- Cutaway insertion for long clips
- Speaker screentime balancing

**Parameters:**
```javascript
{
  speakerNames: ['Host', 'Guest 1', 'Guest 2'],
  videoTrackMapping: {0: [0], 1: [1], 2: [0,1]},  // which speakers on each track
  switchingFrequency: 50,     // 0-100
  minShotDuration: 2.0,       // seconds
  wideShotPercentage: 20,     // target %
  cutawayEnabled: true,
  cutawayDuration: [1.5, 4.0] // min/max seconds
}
```

---

### 6. Repetition/Stutter Detection

**Two modes:**

**Basic Mode:**
- Frequency-based pattern detection
- OpenAI refinement for boundaries
- Returns repeated phrases with timings

**Advanced Mode:**
- Phrase similarity matching (local)
- Configurable tolerance and phrase size
- Real-time preview with highlighting

**Parameters:**
```javascript
{
  mode: 'basic' | 'advanced',
  phraseSize: 5,           // words per window
  tolerance: 0.7,          // similarity threshold
  searchRadius: 100,       // words to search
  extendMode: 'next-punctuation' | 'longest-occurrence'
}
```

---

### 7. J-Cuts

**Implementation:**
- Offset audio from video at cut points
- Audio leads video (L-cut) or video leads audio (J-cut)
- Configurable offset in frames

**Parameters:**
```javascript
{
  jcutEnabled: true,
  jcutOffsetFrames: 6,     // audio leads by 6 frames
  jcutDirection: 'audio-first' | 'video-first'
}
```

---

### 8. Auto-Balance Optimizer

**Algorithm:**
- Target: equal speaker screentime
- Discrete parameter tuning
- Adjusts: speaker boosts, min shot duration, switching frequency
- Convergence: ≤1% error after sweep
- Timeout: 10 seconds

---

### 9. Custom Blocklist/Allowlist

**UI additions:**
- Blocklist textarea (comma-separated words)
- Allowlist textarea (comma-separated words)
- Persist in settings

---

### 10. Zoom Animations

**Features:**
- Start/peak/end scale keyframes
- Custom easing curves
- Center point control
- Asymmetric animation (different in/out curves)

**Easing formula:**
```javascript
function easing(t, power) {
  const coefficient = Math.pow(2, power - 1);
  return (1 - Math.pow(2, -power * t)) / coefficient;
}
```

---

### 11. Chapter Markers

**Features:**
- Insert chapter markers at timecodes
- Custom chapter names
- Export chapter list
- Visual chapter graphics (MOGRT)

---

### 12. Advanced Threshold Auto-Detection

**Algorithm:**
1. Analyze RMS distribution across audio
2. Apply Gaussian blur (σ=10)
3. Find local maxima (speech/silence peaks)
4. Interpolate optimal threshold between peaks
5. Fallback to percentile-based if insufficient peaks

---

## File Structure After Implementation

```
splice-backend/
├── services/
│   ├── rmsSilenceDetection.js      # NEW: RMS-based detection
│   ├── profanityDetection.js       # NEW: Profanity detection
│   ├── repetitionDetection.js      # NEW: Stutter detection
│   ├── multitrackAnalysis.js       # NEW: Multicam analysis
│   ├── silenceDetection.js         # EXISTING: Whisper gaps
│   ├── ffprobeSilence.js           # EXISTING: FFprobe dB
│   ├── transcription.js            # EXISTING
│   ├── takeDetection.js            # EXISTING
│   ├── cutListGenerator.js         # MODIFY: Add padding, J-cuts
│   └── ...

splice-plugin/
├── js/
│   ├── turbo-cutter.js             # NEW: XML turbo method
│   ├── effects.js                  # NEW: Zoom animations
│   ├── profanity-ui.js             # NEW: Profanity UI
│   ├── multitrack-ui.js            # NEW: Multicam UI
│   ├── builder.js                  # EXISTING: v3.5 DOM builder
│   ├── main.js                     # MODIFY: New workflows
│   ├── settings.js                 # MODIFY: New parameters
│   └── ...
```

---

## Implementation Order

1. **RMS Silence Detection** ← STARTING HERE
2. Padding Controls
3. Profanity Detection
4. Turbo Cutting
5. Repetition Detection
6. Multitrack Analysis
7. J-Cuts
8. Auto-Balance
9. Zoom Animations
10. Chapter Markers
11. Threshold Auto-Detection
12. Custom Blocklist/Allowlist

---

*Last updated: 2025-12-25 - Backend services implemented*

---

## New Backend Endpoints

### Silence Detection
- `POST /silences-rms` - Advanced RMS-based silence detection with auto-threshold

### Profanity Detection
- `POST /profanity` - Detect and censor profanity in transcripts
- `GET /profanity/languages` - Get supported languages
- `GET /profanity/bleeps` - Get available bleep sounds
- `GET /profanity/list/:language` - Get profanity word list

### Repetition Detection
- `POST /repetitions` - Detect phrase repetitions and stutters
- `POST /stutters` - Detect single-word stutters only

### Multitrack Analysis
- `POST /multitrack` - Analyze multiple audio tracks for multicam
- `POST /multitrack/auto-balance` - Auto-balance speaker screentime
