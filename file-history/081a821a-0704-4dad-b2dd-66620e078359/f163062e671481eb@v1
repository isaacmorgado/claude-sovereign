import rateLimit from 'express-rate-limit'
import type { Request, Response } from 'express'
import type { ApiResponse } from '../types/api.js'

const createRateLimitHandler = (message: string) => {
  return (_req: Request, res: Response<ApiResponse>): void => {
    res.status(429).json({
      success: false,
      error: 'Too many requests',
      message,
    })
  }
}

/**
 * Strict rate limiter for auth endpoints (login, register, refresh)
 * Prevents brute-force attacks on credentials
 * 10 requests per 15 minutes per IP
 */
export const authRateLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 10,
  standardHeaders: true,
  legacyHeaders: false,
  skipSuccessfulRequests: false,
  handler: createRateLimitHandler('Too many authentication attempts. Please try again in 15 minutes.'),
})

/**
 * Rate limiter for password-sensitive operations (login only)
 * Even stricter to prevent password guessing
 * 5 requests per 15 minutes per IP
 */
export const loginRateLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 5,
  standardHeaders: true,
  legacyHeaders: false,
  skipSuccessfulRequests: true, // Don't count successful logins
  handler: createRateLimitHandler('Too many login attempts. Please try again in 15 minutes.'),
})

/**
 * Rate limiter for audio job submission
 * Prevents abuse of compute-intensive operations
 * 20 submissions per hour per IP
 */
export const audioSubmitRateLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 20,
  standardHeaders: true,
  legacyHeaders: false,
  handler: createRateLimitHandler('Too many audio job submissions. Please try again later.'),
})

/**
 * General API rate limiter
 * Applies to all API routes as a baseline protection
 * 100 requests per minute per IP
 */
export const apiRateLimiter = rateLimit({
  windowMs: 60 * 1000, // 1 minute
  max: 100,
  standardHeaders: true,
  legacyHeaders: false,
  handler: createRateLimitHandler('Too many requests. Please slow down.'),
})
