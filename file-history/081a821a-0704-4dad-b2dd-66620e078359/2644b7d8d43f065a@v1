import express from 'express'
import cors from 'cors'
import helmet from 'helmet'
import { env } from './config/env.js'
import { errorHandler } from './middleware/error-handler.js'
import authRoutes from './routes/auth-routes.js'
import billingRoutes from './routes/billing-routes.js'
import usageRoutes from './routes/usage-routes.js'
import audioRoutes from './routes/audio-routes.js'
import { startAllWorkers } from './workers/index.js'

const app = express()

app.use(helmet())
app.use(
  cors({
    origin:
      env.NODE_ENV === 'production'
        ? ['https://splice.app']
        : ['http://localhost:3000', 'http://localhost:3001', 'http://localhost:3002', 'http://localhost:5173'],
    credentials: true,
  })
)

app.use('/api/billing/webhook', express.raw({ type: 'application/json' }))
app.use(express.json({ limit: '10mb' }))

app.get('/health', (_req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() })
})

app.use('/api/auth', authRoutes)
app.use('/api/billing', billingRoutes)
app.use('/api/usage', usageRoutes)
app.use('/api/audio', audioRoutes)

app.use(errorHandler)

// Start background workers
startAllWorkers()

app.listen(env.PORT, () => {
  console.log(`Server running on port ${String(env.PORT)} in ${env.NODE_ENV} mode`)
})

export default app
