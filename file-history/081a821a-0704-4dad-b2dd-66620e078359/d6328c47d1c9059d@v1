// Main Plugin Application Component
import { LitElement, html, css } from 'lit'
import { customElement, state } from 'lit/decorators.js'
import type { ClipSelection, PricingPlan } from '@/types/plugin'
import { getPluginState, getRemainingOperations } from '@/utils/api/plugin'
import { getSelectedClips } from '@/utils/api/premiere'
import { backendClient, type User } from '@/utils/api/backend-client'
import { logger } from '@/utils/logger'

import '../common/Header'
import '../common/SelectionPanel'
import '../common/AIToolsPanel'
import '../common/SettingsPanel'
import '../common/UpgradePrompt'
import '../common/AuthPanel'

type TabId = 'selection' | 'ai-tools' | 'settings'

@customElement('plugin-app')
export class PluginApp extends LitElement {
  static styles = css`
    :host {
      display: flex;
      flex-direction: column;
      height: 100%;
      background-color: var(--bg-base);
      color: var(--text-primary);
    }

    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-md);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .footer {
      padding: var(--space-sm) var(--space-md);
      border-top: 1px solid var(--border-default);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
    }

    .operations-count {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .operations-count.low {
      color: var(--color-warning);
    }

    .operations-count.depleted {
      color: var(--color-negative);
    }

    .auth-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: var(--space-lg);
    }

    .loading-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  `

  @state() private activeTab: TabId = 'selection'
  @state() private selectedClips: ClipSelection[] = []
  @state() private currentPlan: PricingPlan = 'free'
  @state() private remainingOperations = 0
  @state() private isLoading = false
  @state() private showUpgradePrompt = false
  @state() private user: User | null = null
  @state() private isAuthLoading = true

  private unsubscribeAuth?: () => void

  async connectedCallback(): Promise<void> {
    super.connectedCallback()

    // Wait for backend client to initialize
    await backendClient.waitForInit()

    // Subscribe to auth changes
    this.unsubscribeAuth = backendClient.onAuthChange((user) => {
      this.user = user
      if (user) {
        this.currentPlan = user.plan
      }
    })

    // Check if already authenticated
    if (backendClient.isAuthenticated()) {
      try {
        await backendClient.getMe()
      } catch (error) {
        logger.warn('Failed to fetch user on init', error)
      }
    }

    this.isAuthLoading = false
    this.initializeState()
  }

  disconnectedCallback(): void {
    super.disconnectedCallback()
    this.unsubscribeAuth?.()
  }

  private async initializeState(): Promise<void> {
    try {
      const state = getPluginState()
      // License info available via getUserLicense() for future premium features

      this.currentPlan = this.user?.plan || state.currentPlan
      this.remainingOperations = getRemainingOperations()

      // Get initial selection
      await this.refreshSelection()
    } catch (error) {
      logger.error('Failed to initialize app state', error)
    }
  }

  private async refreshSelection(): Promise<void> {
    this.isLoading = true
    try {
      this.selectedClips = await getSelectedClips()
    } finally {
      this.isLoading = false
    }
  }

  private handleTabChange(tab: TabId): void {
    this.activeTab = tab
  }

  private handleUpgradeClick(): void {
    this.showUpgradePrompt = true
  }

  private handleUpgradeClose(): void {
    this.showUpgradePrompt = false
  }

  private handleAuthChange(e: CustomEvent<{ user: User | null }>): void {
    this.user = e.detail.user
    if (e.detail.user) {
      this.currentPlan = e.detail.user.plan
      // Refresh state when user logs in
      this.initializeState()
    }
  }

  private getOperationsClass(): string {
    if (this.remainingOperations === 0) return 'operations-count depleted'
    if (this.remainingOperations <= 3) return 'operations-count low'
    return 'operations-count'
  }

  render() {
    // Show loading spinner while checking auth
    if (this.isAuthLoading) {
      return html`
        <div class="loading-container">
          <sp-progress-circle indeterminate size="l" label="Loading application"></sp-progress-circle>
        </div>
      `
    }

    // Show auth panel if not logged in
    if (!this.user) {
      return html`
        <div class="auth-container">
          <auth-panel @auth-change=${this.handleAuthChange}></auth-panel>
        </div>
        <div class="footer">
          <span>Splice v3</span>
          <span>Please sign in</span>
        </div>
      `
    }

    // Show main app when logged in
    return html`
      <app-header
        .activeTab=${this.activeTab}
        .currentPlan=${this.currentPlan}
        @tab-change=${(e: CustomEvent) => this.handleTabChange(e.detail)}
        @upgrade-click=${this.handleUpgradeClick}
      ></app-header>

      <div class="main-content">
        <div class="tab-content ${this.activeTab === 'selection' ? 'active' : ''}">
          <selection-panel
            .selectedClips=${this.selectedClips}
            .isLoading=${this.isLoading}
            @refresh=${this.refreshSelection}
          ></selection-panel>
        </div>

        <div class="tab-content ${this.activeTab === 'ai-tools' ? 'active' : ''}">
          <ai-tools-panel
            .selectedClips=${this.selectedClips}
            .remainingOperations=${this.remainingOperations}
            .isPremium=${this.currentPlan !== 'free'}
            @operation-used=${() => this.remainingOperations--}
            @upgrade-needed=${this.handleUpgradeClick}
          ></ai-tools-panel>
        </div>

        <div class="tab-content ${this.activeTab === 'settings' ? 'active' : ''}">
          <settings-panel .currentPlan=${this.currentPlan}></settings-panel>
        </div>
      </div>

      <div class="footer">
        <span>Splice v3</span>
        ${this.currentPlan === 'free'
          ? html`
              <span class=${this.getOperationsClass()}>
                ${this.remainingOperations} operations remaining
              </span>
            `
          : html`<span class="premium-badge">PRO</span>`}
      </div>

      ${this.showUpgradePrompt
        ? html`
            <upgrade-prompt
              .currentPlan=${this.currentPlan}
              @close=${this.handleUpgradeClose}
            ></upgrade-prompt>
          `
        : ''}
    `
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'plugin-app': PluginApp
  }
}
