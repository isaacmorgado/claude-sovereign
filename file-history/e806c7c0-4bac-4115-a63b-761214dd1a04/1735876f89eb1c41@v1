"""
Detection router - side profile landmark detection
"""

from fastapi import APIRouter, HTTPException, status

from app.schemas.detection import DetectionRequest, DetectionResponse
from app.services.detection import detection_service

router = APIRouter(prefix="/detection", tags=["detection"])


@router.post("/side", response_model=DetectionResponse)
async def detect_side_profile(request: DetectionRequest):
    """
    Detect side profile landmarks from image.

    Accepts base64 encoded image, returns:
    - 106 raw InsightFace landmarks
    - 28 mapped cephalometric landmarks
    - Frankfort Plane angle and points
    - Face direction (left/right)
    - Face bounding box
    """
    result = await detection_service.detect_side_profile(request.image)

    if not result["success"]:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=result["message"]
        )

    return DetectionResponse(**result)


@router.get("/health")
async def detection_health():
    """Check if detection model is loaded"""
    is_ready = detection_service._face_analyzer is not None
    return {
        "status": "ready" if is_ready else "not_ready",
        "model": "InsightFace buffalo_l" if is_ready else None
    }
