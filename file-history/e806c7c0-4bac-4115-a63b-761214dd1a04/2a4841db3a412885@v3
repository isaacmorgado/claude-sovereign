# Plan: Complete Human.js Revert + Side Profile Detection Strategy

## Research Summary

### What FaceIQ Does Server-Side

FaceIQ uses a **server-side proprietary model** for side profile detection:

| Aspect | FaceIQ Approach |
|--------|-----------------|
| Endpoint | `POST /api/side-landmarks` |
| Raw Output | **106 landmarks** (not 28) |
| Post-Processing | Maps 106 points → 28 medical landmarks |
| Extra Features | Rotation angle, direction (left/right), face crop/scale |
| Client Fallback | None - always server-side for side profiles |

Their 28-point mapping (vertex, occiput, pronasale, etc.) is derived from the 106 raw server landmarks.

### Client-Side Profile Detection Options

| Model | Profile Support | Browser Ready | Notes |
|-------|-----------------|---------------|-------|
| MediaPipe | ~45° max | Yes (WASM) | **Current** - fails at full profile |
| OpenSeeFace | **Excellent** | Via ONNX Runtime | Best profile support, needs conversion |
| face-api.js | Poor | Yes (TF.js) | Frontal-optimized |
| InsightFace | Good | Via ONNX Runtime | 3D mesh, needs setup |

**Best client-side option:** OpenSeeFace via ONNX Runtime Web

### Cephalometric Industry Standard

- **Frankfort Horizontal Plane** (Porion → Orbitale) is universally used
- Professional tools use 29-38 landmarks for side profile analysis
- Cloud-based AI (CephX, WeDoCeph) achieving <2mm error
- Open datasets: Aariz (1000 images), CL-Detection 2023 (600 images)

---

## Part 1: Complete the Revert (Required)

Remove orphaned Frankfort Plane code from LandmarkAnalysisTool.tsx:

**File:** `src/components/LandmarkAnalysisTool.tsx`
- Lines 87-91: Remove `frankfortPlane` state declaration
- Line 319: Remove `setFrankfortPlane(null)`
- Lines 338-341: Remove Frankfort Plane capture logic
- Lines 755-812: Remove Frankfort Plane SVG visualization

---

## Part 2: Side Profile Detection Options

### Option A: Accept Manual Placement (Simplest)
- Accept that client-side auto-detection is limited for profiles
- Improve UX with better guidance messages
- Keep edge-based detection as "best guess" starting point
- Focus on excellent reference images (already implemented)

**Pros:** No new dependencies, works today
**Cons:** More manual work for users

### Option B: OpenSeeFace via ONNX Runtime Web
- Best client-side profile tracking available
- Deploy ONNX model via ONNX Runtime Web (WASM/WebGL)
- Runs 30-60 fps on CPU

**Pros:** Excellent profile support, truly client-side
**Cons:** Adds ~5-10MB model, requires ONNX Runtime integration

### Option C: Build Your Own Server-Side API
- Similar to FaceIQ's approach
- Use InsightFace or trained cephalometric model server-side
- Return 106+ raw landmarks, map to 28 points

**Pros:** Best accuracy, matches FaceIQ
**Cons:** Requires backend infrastructure, adds latency

### Option D: Use Cephalometric API Service
- Integrate with existing service (CephX, WeDoCeph API)
- Upload image → get landmarks back

**Pros:** Production-proven accuracy
**Cons:** External dependency, potential cost, privacy concerns

---

## Recommended Approach: Server-Side Detection via Railway (SIDE PROFILE ONLY)

**IMPORTANT:** This integration is ONLY for side profile detection.
- Front profile: **NO CHANGES** - continues using MediaPipe exactly as today
- Side profile: Server-side detection via Railway backend

**Why server-side is better:**
- Much higher accuracy (106+ landmarks like FaceIQ)
- No 5-10MB model download for clients
- Users need minimal manual adjustment
- Easier to update/improve model

---

## Implementation Plan

### Step 1: Complete Human.js Revert
**File:** `src/components/LandmarkAnalysisTool.tsx`
- Remove `frankfortPlane` state (lines 87-91)
- Remove `setFrankfortPlane(null)` (line 319)
- Remove Frankfort Plane capture logic (lines 338-341)
- Remove Frankfort Plane SVG visualization (lines 755-812)

### Step 2: Create Railway Python Backend
**New repository:** `looksmaxx-detection-api`

```
looksmaxx-detection-api/
├── main.py              # FastAPI server
├── requirements.txt     # insightface, onnxruntime, opencv-python, fastapi, uvicorn
├── Dockerfile           # Railway deployment
└── railway.json         # Railway config
```

**API Endpoint:** `POST /api/side-landmarks`
- Input: Base64 image or multipart form upload
- Output: 106 raw landmarks + rotation + direction + mapped 28 cephalometric points

### Step 3: Create Next.js API Proxy Route
**New file:** `src/app/api/side-landmarks/route.ts`
- Accepts image from client
- Forwards to Railway backend
- Returns landmarks to client
- Handles errors gracefully

### Step 4: Create Server Detection Service
**New file:** `src/lib/serverSideDetection.ts`
- Call the `/api/side-landmarks` proxy route
- Parse response into our landmark format
- Map 106 points → 28 cephalometric landmarks

### Step 5: Update Detection Hierarchy (Side Profile Only)
**File:** `src/lib/mediapipeDetection.ts`

```typescript
// Detection flow in detectFromImageUrl():
if (mode === 'front') {
  // UNCHANGED - MediaPipe Face Mesh (478 landmarks)
  // Existing code stays exactly the same
}

if (mode === 'side') {
  // NEW - Server-side detection via Railway
  // 1. Try server-side InsightFace detection first
  // 2. Fallback to edge-based detection if server fails
  // 3. Manual placement as last resort
}
```

**Front profile code is NOT touched at all.**

### Step 6: Add Frankfort Plane Visualization
**File:** `src/components/LandmarkAnalysisTool.tsx`
- After server detects orbitale + porion landmarks
- Calculate and display Frankfort Horizontal Plane
- Industry-standard reference line for cephalometric analysis

---

## Railway Setup

1. Create new Railway project
2. Deploy Python FastAPI with InsightFace
3. Add environment variable for API URL to Next.js app
4. Configure CORS for your domain

**Estimated cost:** ~$5-20/month depending on usage

---

## Files to Modify

### Next.js App (looksmaxx-app)
1. `src/components/LandmarkAnalysisTool.tsx` - Remove orphaned code, add Frankfort Plane
2. `src/app/api/side-landmarks/route.ts` - NEW: Proxy to Railway
3. `src/lib/serverSideDetection.ts` - NEW: Server detection client
4. `src/lib/mediapipeDetection.ts` - Update detection hierarchy for side profiles

### Railway Backend (new repo)
1. `main.py` - FastAPI with InsightFace
2. `requirements.txt` - Dependencies
3. `Dockerfile` - Container config
4. `railway.json` - Railway deployment config
