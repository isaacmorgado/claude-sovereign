# Plan: Complete Human.js Revert + Side Profile Detection Strategy

## Research Summary

### What FaceIQ Does Server-Side

FaceIQ uses a **server-side proprietary model** for side profile detection:

| Aspect | FaceIQ Approach |
|--------|-----------------|
| Endpoint | `POST /api/side-landmarks` |
| Raw Output | **106 landmarks** (not 28) |
| Post-Processing | Maps 106 points → 28 medical landmarks |
| Extra Features | Rotation angle, direction (left/right), face crop/scale |
| Client Fallback | None - always server-side for side profiles |

Their 28-point mapping (vertex, occiput, pronasale, etc.) is derived from the 106 raw server landmarks.

### Client-Side Profile Detection Options

| Model | Profile Support | Browser Ready | Notes |
|-------|-----------------|---------------|-------|
| MediaPipe | ~45° max | Yes (WASM) | **Current** - fails at full profile |
| OpenSeeFace | **Excellent** | Via ONNX Runtime | Best profile support, needs conversion |
| face-api.js | Poor | Yes (TF.js) | Frontal-optimized |
| InsightFace | Good | Via ONNX Runtime | 3D mesh, needs setup |

**Best client-side option:** OpenSeeFace via ONNX Runtime Web

### Cephalometric Industry Standard

- **Frankfort Horizontal Plane** (Porion → Orbitale) is universally used
- Professional tools use 29-38 landmarks for side profile analysis
- Cloud-based AI (CephX, WeDoCeph) achieving <2mm error
- Open datasets: Aariz (1000 images), CL-Detection 2023 (600 images)

---

## Part 1: Complete the Revert (Required)

Remove orphaned Frankfort Plane code from LandmarkAnalysisTool.tsx:

**File:** `src/components/LandmarkAnalysisTool.tsx`
- Lines 87-91: Remove `frankfortPlane` state declaration
- Line 319: Remove `setFrankfortPlane(null)`
- Lines 338-341: Remove Frankfort Plane capture logic
- Lines 755-812: Remove Frankfort Plane SVG visualization

---

## Part 2: Side Profile Detection Options

### Option A: Accept Manual Placement (Simplest)
- Accept that client-side auto-detection is limited for profiles
- Improve UX with better guidance messages
- Keep edge-based detection as "best guess" starting point
- Focus on excellent reference images (already implemented)

**Pros:** No new dependencies, works today
**Cons:** More manual work for users

### Option B: OpenSeeFace via ONNX Runtime Web
- Best client-side profile tracking available
- Deploy ONNX model via ONNX Runtime Web (WASM/WebGL)
- Runs 30-60 fps on CPU

**Pros:** Excellent profile support, truly client-side
**Cons:** Adds ~5-10MB model, requires ONNX Runtime integration

### Option C: Build Your Own Server-Side API
- Similar to FaceIQ's approach
- Use InsightFace or trained cephalometric model server-side
- Return 106+ raw landmarks, map to 28 points

**Pros:** Best accuracy, matches FaceIQ
**Cons:** Requires backend infrastructure, adds latency

### Option D: Use Cephalometric API Service
- Integrate with existing service (CephX, WeDoCeph API)
- Upload image → get landmarks back

**Pros:** Production-proven accuracy
**Cons:** External dependency, potential cost, privacy concerns

---

## Recommended Approach: OpenSeeFace via ONNX Runtime Web (SIDE PROFILE ONLY)

**IMPORTANT:** This integration is ONLY for side profile detection.
- Front profile: **NO CHANGES** - continues using MediaPipe exactly as today
- Side profile: New OpenSeeFace ONNX detection

User has frontend-only infrastructure. OpenSeeFace via ONNX is the best fit:
- No server needed
- Best profile tracking available client-side
- Privacy-preserving (images stay on device)
- ~5-10MB model download (cached after first load)

---

## Implementation Plan

### Step 1: Complete Human.js Revert
**File:** `src/components/LandmarkAnalysisTool.tsx`
- Remove `frankfortPlane` state (lines 87-91)
- Remove `setFrankfortPlane(null)` (line 319)
- Remove Frankfort Plane capture logic (lines 338-341)
- Remove Frankfort Plane SVG visualization (lines 755-812)

### Step 2: Install ONNX Runtime Web
```bash
npm install onnxruntime-web
```

### Step 3: Download OpenSeeFace ONNX Model
- Source: https://github.com/emilianavt/OpenSeeFace
- Model: `lm_model*.onnx` (landmark detection model)
- Place in `public/models/` folder

### Step 4: Create ONNX Detection Service
**New file:** `src/lib/onnxFaceDetection.ts`
- Load ONNX model via onnxruntime-web
- Run inference on side profile images
- Return 66 facial landmarks (OpenSeeFace output)
- Map to our 28 cephalometric landmarks

### Step 5: Update Detection Hierarchy (Side Profile Only)
**File:** `src/lib/mediapipeDetection.ts`

```typescript
// Detection flow in detectFromImageUrl():
if (mode === 'front') {
  // UNCHANGED - MediaPipe Face Mesh (478 landmarks)
  // Existing code stays exactly the same
}

if (mode === 'side') {
  // NEW - OpenSeeFace ONNX detection
  // 1. Try OpenSeeFace ONNX first (best profile support)
  // 2. Fallback to edge-based detection if ONNX fails
  // 3. Manual placement as last resort
}
```

**Front profile code is NOT touched at all.**

### Step 6: Add Frankfort Plane Back (properly)
**File:** `src/components/LandmarkAnalysisTool.tsx`
- After OpenSeeFace detects orbitale + porion landmarks
- Calculate and display Frankfort Horizontal Plane
- Industry-standard reference line for cephalometric analysis

---

## Files to Modify

1. `src/components/LandmarkAnalysisTool.tsx` - Remove orphaned code, later add Frankfort Plane
2. `src/lib/onnxFaceDetection.ts` - NEW: OpenSeeFace ONNX integration
3. `src/lib/mediapipeDetection.ts` - Update detection hierarchy for side profiles
4. `public/models/` - NEW: Store ONNX model files
