import { NextRequest, NextResponse } from 'next/server';

/**
 * Proxy route for side profile landmark detection
 * Forwards requests to the Railway-hosted InsightFace API
 */

const DETECTION_API_URL = process.env.DETECTION_API_URL || 'http://localhost:8000';

export interface SideLandmarkResponse {
  success: boolean;
  message: string;
  direction?: 'left' | 'right';
  rotation_angle?: number;
  raw_landmarks?: Array<{ x: number; y: number }>;
  mapped_landmarks?: Record<string, { x: number; y: number }>;
  face_box?: {
    x: number;
    y: number;
    width: number;
    height: number;
  };
}

export async function POST(request: NextRequest) {
  try {
    const contentType = request.headers.get('content-type') || '';

    let response: Response;

    if (contentType.includes('application/json')) {
      // Handle base64 image submission
      const body = await request.json();

      response = await fetch(`${DETECTION_API_URL}/api/side-landmarks/base64`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(body),
      });
    } else if (contentType.includes('multipart/form-data')) {
      // Handle file upload - forward the form data directly
      const formData = await request.formData();

      response = await fetch(`${DETECTION_API_URL}/api/side-landmarks`, {
        method: 'POST',
        body: formData,
      });
    } else {
      return NextResponse.json(
        { success: false, message: 'Unsupported content type' },
        { status: 400 }
      );
    }

    if (!response.ok) {
      const errorText = await response.text();
      console.error('[Side Landmarks API] Error from detection server:', errorText);
      return NextResponse.json(
        { success: false, message: 'Detection server error' },
        { status: response.status }
      );
    }

    const data: SideLandmarkResponse = await response.json();
    return NextResponse.json(data);
  } catch (error) {
    console.error('[Side Landmarks API] Error:', error);

    // Check if it's a connection error (server not running)
    if (error instanceof Error && error.message.includes('fetch failed')) {
      return NextResponse.json(
        {
          success: false,
          message: 'Detection server unavailable. Please try again later.',
        },
        { status: 503 }
      );
    }

    return NextResponse.json(
      { success: false, message: 'Internal server error' },
      { status: 500 }
    );
  }
}
