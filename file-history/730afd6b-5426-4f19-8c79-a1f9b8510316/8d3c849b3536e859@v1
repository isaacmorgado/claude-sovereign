/**
 * Rate Limiter Middleware Test
 *
 * Tests the requireCredits middleware for:
 * - Authentication checking (401)
 * - Credit checking (402)
 * - Atomic reservation
 * - Usage deduction helpers
 * - Auto-release on errors
 */

const assert = require('assert');
const fs = require('fs');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// Read rate limiter code
const rateLimiterCode = fs.readFileSync(__dirname + '/../middleware/rateLimiter.js', 'utf8');
const usageTrackingCode = fs.readFileSync(__dirname + '/../services/usageTracking.js', 'utf8');

console.log('\n=== Rate Limiter Middleware Tests ===\n');

// ============================================================================
// Structure Tests
// ============================================================================

console.log('--- Structure ---');

test('Exports requireCredits function', () => {
  assert.ok(rateLimiterCode.includes('module.exports') && rateLimiterCode.includes('requireCredits'),
    'Missing requireCredits export');
});

test('Exports trackUsage function', () => {
  assert.ok(rateLimiterCode.includes('trackUsage'), 'Missing trackUsage export');
});

test('Imports usageTracking functions', () => {
  assert.ok(rateLimiterCode.includes("require('../services/usageTracking')"),
    'Missing usageTracking import');
});

// ============================================================================
// Authentication Tests
// ============================================================================

console.log('\n--- Authentication ---');

test('Checks for x-stripe-customer-id header', () => {
  assert.ok(rateLimiterCode.includes('x-stripe-customer-id'),
    'Missing customer ID header check');
});

test('Returns 401 for missing auth', () => {
  assert.ok(rateLimiterCode.includes('401') && rateLimiterCode.includes('Authentication required'),
    'Missing 401 response for missing auth');
});

test('Stores customer ID on request', () => {
  assert.ok(rateLimiterCode.includes('req.stripeCustomerId ='),
    'Not storing customer ID on request');
});

// ============================================================================
// Credit Reservation Tests
// ============================================================================

console.log('\n--- Credit Reservation ---');

test('Calls reserveCredits for atomic reservation', () => {
  assert.ok(rateLimiterCode.includes('reserveCredits(stripeCustomerId'),
    'Missing reserveCredits call');
});

test('Returns 402 for insufficient credits', () => {
  assert.ok(rateLimiterCode.includes('402') && rateLimiterCode.includes('Insufficient credits'),
    'Missing 402 response for insufficient credits');
});

test('Stores reservation info on request', () => {
  assert.ok(rateLimiterCode.includes('req.reservation ='),
    'Not storing reservation on request');
});

test('Uses default reservation seconds', () => {
  assert.ok(rateLimiterCode.includes('DEFAULT_RESERVATION_SECONDS'),
    'Missing default reservation duration');
});

// ============================================================================
// Usage Deduction Tests
// ============================================================================

console.log('\n--- Usage Deduction ---');

test('Attaches deductUsage helper to request', () => {
  assert.ok(rateLimiterCode.includes('req.deductUsage ='),
    'Missing deductUsage helper');
});

test('Attaches releaseReservation helper to request', () => {
  assert.ok(rateLimiterCode.includes('req.releaseReservation ='),
    'Missing releaseReservation helper');
});

test('deductUsage calls confirmReservation', () => {
  assert.ok(rateLimiterCode.includes('confirmReservation'),
    'deductUsage not calling confirmReservation');
});

// ============================================================================
// Error Handling Tests
// ============================================================================

console.log('\n--- Error Handling ---');

test('Wraps response.send for error handling', () => {
  assert.ok(rateLimiterCode.includes('res.send =') || rateLimiterCode.includes('originalSend'),
    'Missing response.send override');
});

test('Auto-releases on error responses (4xx/5xx)', () => {
  assert.ok(rateLimiterCode.includes('res.statusCode >= 400'),
    'Not checking for error status codes');
});

test('Catches and handles reservation errors', () => {
  assert.ok(rateLimiterCode.includes('catch') && rateLimiterCode.includes('500'),
    'Missing error handling for reservation failures');
});

// ============================================================================
// Usage Tracking Integration Tests
// ============================================================================

console.log('\n--- Usage Tracking Integration ---');

test('usageTracking has reserveCredits function', () => {
  assert.ok(usageTrackingCode.includes('reserveCredits') ||
            usageTrackingCode.includes('async function reserve'),
    'Missing reserveCredits in usageTracking');
});

test('usageTracking uses SELECT FOR UPDATE', () => {
  assert.ok(usageTrackingCode.includes('FOR UPDATE'),
    'Missing SELECT FOR UPDATE for atomic operations');
});

test('usageTracking has confirmReservation', () => {
  assert.ok(usageTrackingCode.includes('confirmReservation') ||
            usageTrackingCode.includes('confirm'),
    'Missing confirmReservation in usageTracking');
});

test('usageTracking has releaseReservation', () => {
  assert.ok(usageTrackingCode.includes('releaseReservation') ||
            usageTrackingCode.includes('release'),
    'Missing releaseReservation in usageTracking');
});

// ============================================================================
// Logic Simulation Tests
// ============================================================================

console.log('\n--- Logic Simulation ---');

// Simulate requireCredits logic
function simulateRequireCredits(req, reservationSuccess) {
  // Check auth
  if (!req.headers['x-stripe-customer-id']) {
    return { status: 401, error: 'Authentication required' };
  }

  // Simulate reservation
  if (!reservationSuccess) {
    return { status: 402, error: 'Insufficient credits' };
  }

  // Success - attach helpers
  return {
    status: 'next',
    hasDeductUsage: true,
    hasReleaseReservation: true,
    hasReservation: true
  };
}

test('Returns 401 when no customer ID', () => {
  const result = simulateRequireCredits({ headers: {} }, true);
  assert.strictEqual(result.status, 401);
});

test('Returns 402 when reservation fails', () => {
  const result = simulateRequireCredits(
    { headers: { 'x-stripe-customer-id': 'cus_123' } },
    false
  );
  assert.strictEqual(result.status, 402);
});

test('Proceeds when auth and credits OK', () => {
  const result = simulateRequireCredits(
    { headers: { 'x-stripe-customer-id': 'cus_123' } },
    true
  );
  assert.strictEqual(result.status, 'next');
  assert.ok(result.hasDeductUsage);
  assert.ok(result.hasReleaseReservation);
});

// ============================================================================
// Summary
// ============================================================================

console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total: ${passed + failed}`);

if (failed === 0) {
  console.log('\n✅ Rate limiter is properly configured\n');
} else {
  console.log('\n❌ Some tests failed\n');
}

process.exit(failed > 0 ? 1 : 0);
