/**
 * E2E Test: Batch Endpoints Auth
 *
 * Tests that batch endpoints properly verify customer ownership:
 * - GET /batch/status/:jobId - returns 403 for non-owner
 * - GET /batch/results/:jobId - returns 403 for non-owner
 * - DELETE /batch/:jobId - returns 403 for non-owner
 * - GET /batch/jobs - filters by customer
 */

const assert = require('assert');

// Simulate batch job storage
const batchJobs = new Map();

// Mock job for testing
const mockJobCustomerA = {
  id: 'batch_test_123',
  type: 'silences',
  status: 'completed',
  createdAt: new Date().toISOString(),
  completedAt: new Date().toISOString(),
  stripeCustomerId: 'cus_AAAA',
  files: [{ path: '/test/file.wav', status: 'completed', result: { count: 5 } }],
  progress: { total: 1, completed: 1, failed: 0, percentage: 100 },
  results: [{ file: '/test/file.wav', count: 5 }],
  errors: []
};

const mockJobCustomerB = {
  id: 'batch_test_456',
  type: 'silences',
  status: 'completed',
  createdAt: new Date().toISOString(),
  completedAt: new Date().toISOString(),
  stripeCustomerId: 'cus_BBBB',
  files: [{ path: '/test/file2.wav', status: 'completed', result: { count: 3 } }],
  progress: { total: 1, completed: 1, failed: 0, percentage: 100 },
  results: [{ file: '/test/file2.wav', count: 3 }],
  errors: []
};

const mockJobNoCustomer = {
  id: 'batch_test_789',
  type: 'silences',
  status: 'completed',
  createdAt: new Date().toISOString(),
  completedAt: new Date().toISOString(),
  stripeCustomerId: null,  // Legacy job without customer
  files: [],
  progress: { total: 0, completed: 0, failed: 0, percentage: 100 },
  results: [],
  errors: []
};

// Setup
batchJobs.set(mockJobCustomerA.id, mockJobCustomerA);
batchJobs.set(mockJobCustomerB.id, mockJobCustomerB);
batchJobs.set(mockJobNoCustomer.id, mockJobNoCustomer);

// Tests
let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`✗ ${name}`);
    console.log(`  Error: ${err.message}`);
    failed++;
  }
}

// Test helpers that simulate endpoint logic
function simulateGetStatus(jobId, stripeCustomerId) {
  const job = batchJobs.get(jobId);
  if (!job) return { status: 404, body: { error: 'Job not found' } };
  if (job.stripeCustomerId && job.stripeCustomerId !== stripeCustomerId) {
    return { status: 403, body: { error: 'Access denied: Job belongs to another user' } };
  }
  return { status: 200, body: { success: true, job: { id: job.id } } };
}

function simulateGetResults(jobId, stripeCustomerId) {
  const job = batchJobs.get(jobId);
  if (!job) return { status: 404, body: { error: 'Job not found' } };
  if (job.stripeCustomerId && job.stripeCustomerId !== stripeCustomerId) {
    return { status: 403, body: { error: 'Access denied: Job belongs to another user' } };
  }
  return { status: 200, body: { success: true, results: job.results } };
}

function simulateDeleteJob(jobId, stripeCustomerId) {
  const job = batchJobs.get(jobId);
  if (!job) return { status: 404, body: { error: 'Job not found' } };
  if (job.stripeCustomerId && job.stripeCustomerId !== stripeCustomerId) {
    return { status: 403, body: { error: 'Access denied: Job belongs to another user' } };
  }
  return { status: 200, body: { success: true, message: `Job ${jobId} deleted` } };
}

function simulateListJobs(stripeCustomerId) {
  const jobs = Array.from(batchJobs.values())
    .filter(job => !job.stripeCustomerId || job.stripeCustomerId === stripeCustomerId);
  return { status: 200, body: { success: true, count: jobs.length, jobs } };
}

// ============================================================================
// Tests
// ============================================================================

console.log('\n=== Batch Endpoints Auth Tests ===\n');

// GET /batch/status - ownership verification
test('GET /batch/status - owner can access their job', () => {
  const result = simulateGetStatus('batch_test_123', 'cus_AAAA');
  assert.strictEqual(result.status, 200);
  assert.strictEqual(result.body.success, true);
});

test('GET /batch/status - non-owner gets 403', () => {
  const result = simulateGetStatus('batch_test_123', 'cus_BBBB');
  assert.strictEqual(result.status, 403);
  assert.strictEqual(result.body.error, 'Access denied: Job belongs to another user');
});

test('GET /batch/status - job without customer allows anyone', () => {
  const result = simulateGetStatus('batch_test_789', 'cus_AAAA');
  assert.strictEqual(result.status, 200);
});

test('GET /batch/status - missing job returns 404', () => {
  const result = simulateGetStatus('nonexistent', 'cus_AAAA');
  assert.strictEqual(result.status, 404);
});

// GET /batch/results - ownership verification
test('GET /batch/results - owner can access their results', () => {
  const result = simulateGetResults('batch_test_456', 'cus_BBBB');
  assert.strictEqual(result.status, 200);
  assert.strictEqual(result.body.success, true);
});

test('GET /batch/results - non-owner gets 403', () => {
  const result = simulateGetResults('batch_test_456', 'cus_AAAA');
  assert.strictEqual(result.status, 403);
});

// DELETE /batch/:jobId - ownership verification
test('DELETE /batch/:jobId - owner can delete their job', () => {
  const result = simulateDeleteJob('batch_test_123', 'cus_AAAA');
  assert.strictEqual(result.status, 200);
  assert.strictEqual(result.body.success, true);
});

test('DELETE /batch/:jobId - non-owner gets 403', () => {
  const result = simulateDeleteJob('batch_test_456', 'cus_AAAA');
  assert.strictEqual(result.status, 403);
});

// GET /batch/jobs - filtering
test('GET /batch/jobs - filters jobs by customer', () => {
  const result = simulateListJobs('cus_AAAA');
  assert.strictEqual(result.status, 200);
  // Should see own job + legacy job without customer
  assert.ok(result.body.jobs.some(j => j.id === 'batch_test_123'));
  assert.ok(result.body.jobs.some(j => j.id === 'batch_test_789'));
  // Should NOT see customer B's job
  assert.ok(!result.body.jobs.some(j => j.id === 'batch_test_456'));
});

test('GET /batch/jobs - customer B sees only their jobs', () => {
  const result = simulateListJobs('cus_BBBB');
  assert.ok(result.body.jobs.some(j => j.id === 'batch_test_456'));
  assert.ok(result.body.jobs.some(j => j.id === 'batch_test_789'));
  assert.ok(!result.body.jobs.some(j => j.id === 'batch_test_123'));
});

test('GET /batch/jobs - unauthenticated user sees only legacy jobs', () => {
  const result = simulateListJobs(undefined);
  assert.ok(result.body.jobs.some(j => j.id === 'batch_test_789'));
  // Should not see jobs with customer IDs
  assert.ok(!result.body.jobs.some(j => j.id === 'batch_test_123'));
  assert.ok(!result.body.jobs.some(j => j.id === 'batch_test_456'));
});

// Summary
console.log(`\n=== Results ===`);
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total: ${passed + failed}`);

process.exit(failed > 0 ? 1 : 0);
