/**
 * E2E Test: Cut-List Endpoints Auth
 *
 * Tests that cut-list endpoints require authentication:
 * - POST /cut-list - requires x-stripe-customer-id header
 * - POST /cut-list/takes - requires x-stripe-customer-id header
 */

const assert = require('assert');

// Test configuration
const BASE_URL = 'https://127.0.0.1:3847';

// Mock data for testing
const validCutListRequest = {
  sourceName: 'test.mp4',
  sourcePath: '/path/to/test.mp4',
  duration: 60,
  silences: [{ start: 5, end: 10, duration: 5 }],
  takes: [],
  settings: {}
};

const validTakesRequest = {
  sourceName: 'test.mp4',
  sourcePath: '/path/to/test.mp4',
  duration: 60,
  takes: [{ start: 0, end: 5, text: 'Hello world' }],
  settings: {}
};

// Test helpers
let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`✗ ${name}`);
    console.log(`  Error: ${err.message}`);
    failed++;
  }
}

async function testAsync(name, fn) {
  try {
    await fn();
    console.log(`✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`✗ ${name}`);
    console.log(`  Error: ${err.message}`);
    failed++;
  }
}

// Simulate requireCredits middleware behavior
function simulateRequireCredits(headers) {
  const customerId = headers['x-stripe-customer-id'];

  if (!customerId) {
    return {
      allowed: false,
      status: 401,
      body: {
        error: 'Authentication required',
        message: 'Missing x-stripe-customer-id header'
      }
    };
  }

  // In production, this would check database for credits
  // For testing, we simulate a valid customer
  return { allowed: true };
}

function simulateCutListEndpoint(headers, body) {
  const authCheck = simulateRequireCredits(headers);
  if (!authCheck.allowed) {
    return { status: authCheck.status, body: authCheck.body };
  }

  // Validate required fields (simulated endpoint logic)
  if (!body.sourceName && !body.sourcePath) {
    return { status: 400, body: { error: 'sourceName or sourcePath is required' } };
  }
  if (typeof body.duration !== 'number' || body.duration <= 0) {
    return { status: 400, body: { error: 'duration must be a positive number' } };
  }
  if (!body.silences || !Array.isArray(body.silences)) {
    return { status: 400, body: { error: 'silences array is required' } };
  }

  return { status: 200, body: { success: true, cutList: {} } };
}

function simulateCutListTakesEndpoint(headers, body) {
  const authCheck = simulateRequireCredits(headers);
  if (!authCheck.allowed) {
    return { status: authCheck.status, body: authCheck.body };
  }

  // Validate required fields
  if (!body.sourceName && !body.sourcePath) {
    return { status: 400, body: { error: 'sourceName or sourcePath is required' } };
  }
  if (typeof body.duration !== 'number' || body.duration <= 0) {
    return { status: 400, body: { error: 'duration must be a positive number' } };
  }
  if (!body.takes || !Array.isArray(body.takes) || body.takes.length === 0) {
    return { status: 400, body: { error: 'takes array is required and must not be empty' } };
  }

  return { status: 200, body: { success: true, cutList: {} } };
}

// ============================================================================
// Tests
// ============================================================================

console.log('\n=== Cut-List Auth Tests ===\n');

// POST /cut-list - auth tests
test('POST /cut-list - missing customer ID returns 401', () => {
  const result = simulateCutListEndpoint({}, validCutListRequest);
  assert.strictEqual(result.status, 401);
  assert.strictEqual(result.body.error, 'Authentication required');
});

test('POST /cut-list - valid customer ID allows request', () => {
  const result = simulateCutListEndpoint(
    { 'x-stripe-customer-id': 'cus_test123' },
    validCutListRequest
  );
  assert.strictEqual(result.status, 200);
  assert.strictEqual(result.body.success, true);
});

test('POST /cut-list - validation still works after auth', () => {
  const result = simulateCutListEndpoint(
    { 'x-stripe-customer-id': 'cus_test123' },
    { silences: [] }  // Missing required fields
  );
  assert.strictEqual(result.status, 400);
});

// POST /cut-list/takes - auth tests
test('POST /cut-list/takes - missing customer ID returns 401', () => {
  const result = simulateCutListTakesEndpoint({}, validTakesRequest);
  assert.strictEqual(result.status, 401);
  assert.strictEqual(result.body.error, 'Authentication required');
});

test('POST /cut-list/takes - valid customer ID allows request', () => {
  const result = simulateCutListTakesEndpoint(
    { 'x-stripe-customer-id': 'cus_test123' },
    validTakesRequest
  );
  assert.strictEqual(result.status, 200);
  assert.strictEqual(result.body.success, true);
});

test('POST /cut-list/takes - empty customer ID returns 401', () => {
  const result = simulateCutListTakesEndpoint(
    { 'x-stripe-customer-id': '' },
    validTakesRequest
  );
  assert.strictEqual(result.status, 401);
});

// Verify middleware is attached (static analysis)
const fs = require('fs');
const serverCode = fs.readFileSync(__dirname + '/../server.js', 'utf8');

test('server.js has requireCredits on /cut-list', () => {
  const pattern = /app\.post\('\/cut-list',\s*requireCredits/;
  assert.ok(pattern.test(serverCode), 'requireCredits middleware not found on /cut-list');
});

test('server.js has requireCredits on /cut-list/takes', () => {
  const pattern = /app\.post\('\/cut-list\/takes',\s*requireCredits/;
  assert.ok(pattern.test(serverCode), 'requireCredits middleware not found on /cut-list/takes');
});

// Summary
console.log(`\n=== Results ===`);
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total: ${passed + failed}`);

process.exit(failed > 0 ? 1 : 0);
