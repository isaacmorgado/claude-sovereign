/**
 * E2E Test: Offline Detection
 *
 * Tests that the plugin properly handles offline state:
 * - isOnline() function exists and works
 * - initOfflineDetection() is called on plugin load
 * - GO button checks online status before proceeding
 * - updateOfflineUI() disables UI when offline
 */

const assert = require('assert');
const fs = require('fs');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`✗ ${name}`);
    console.log(`  Error: ${err.message}`);
    failed++;
  }
}

// ============================================================================
// Static Code Analysis Tests
// ============================================================================

console.log('\n=== Offline Detection Tests ===\n');

// Read config.js
const configCode = fs.readFileSync(__dirname + '/../../splice-plugin/js/config.js', 'utf8');

test('config.js has isOnline function', () => {
  assert.ok(configCode.includes('function isOnline()'), 'Missing isOnline function');
});

test('config.js has initOfflineDetection function', () => {
  assert.ok(configCode.includes('function initOfflineDetection()'), 'Missing initOfflineDetection function');
});

test('config.js has updateOfflineUI function', () => {
  assert.ok(configCode.includes('function updateOfflineUI'), 'Missing updateOfflineUI function');
});

test('config.js has requireOnline function', () => {
  assert.ok(configCode.includes('function requireOnline()'), 'Missing requireOnline function');
});

test('isOnline checks navigator.onLine', () => {
  assert.ok(configCode.includes('navigator.onLine'), 'Missing navigator.onLine check');
});

test('initOfflineDetection listens for online event', () => {
  assert.ok(configCode.includes("addEventListener('online'"), 'Missing online event listener');
});

test('initOfflineDetection listens for offline event', () => {
  assert.ok(configCode.includes("addEventListener('offline'"), 'Missing offline event listener');
});

test('updateOfflineUI disables goBtn when offline', () => {
  assert.ok(configCode.includes('goBtn.disabled = true'), 'Missing goBtn disable');
});

test('updateOfflineUI shows offline message', () => {
  assert.ok(configCode.includes('Offline'), 'Missing offline message');
});

// Read main.js
const mainCode = fs.readFileSync(__dirname + '/../../splice-plugin/js/main.js', 'utf8');

test('main.js initializes offline detection', () => {
  assert.ok(mainCode.includes('initOfflineDetection'), 'Missing initOfflineDetection call');
});

test('main.js checks online status before GO', () => {
  assert.ok(mainCode.includes('isOnline') && mainCode.includes('Check your connection'),
    'Missing online check before GO button action');
});

// ============================================================================
// Logic Simulation Tests
// ============================================================================

// Simulate isOnline logic
function simulateIsOnline(navigatorOnLine) {
  if (typeof navigatorOnLine === 'boolean') {
    return navigatorOnLine;
  }
  return true;  // Default to online
}

test('isOnline returns true when navigator.onLine is true', () => {
  assert.strictEqual(simulateIsOnline(true), true);
});

test('isOnline returns false when navigator.onLine is false', () => {
  assert.strictEqual(simulateIsOnline(false), false);
});

test('isOnline defaults to true when navigator.onLine undefined', () => {
  assert.strictEqual(simulateIsOnline(undefined), true);
});

// Simulate updateOfflineUI logic
function simulateUpdateOfflineUI(online) {
  const result = {
    statusText: '',
    goBtnDisabled: false,
    goBtnTitle: ''
  };

  if (!online) {
    result.statusText = '⚠ Offline - Check your connection';
    result.goBtnDisabled = true;
    result.goBtnTitle = 'Cannot process while offline';
  } else {
    result.statusText = '';  // Restored to original
    result.goBtnDisabled = false;
    result.goBtnTitle = '';
  }

  return result;
}

test('updateOfflineUI disables GO button when offline', () => {
  const result = simulateUpdateOfflineUI(false);
  assert.strictEqual(result.goBtnDisabled, true);
  assert.ok(result.statusText.includes('Offline'));
});

test('updateOfflineUI enables GO button when online', () => {
  const result = simulateUpdateOfflineUI(true);
  assert.strictEqual(result.goBtnDisabled, false);
});

// Simulate GO button handler
function simulateGoButtonHandler(isOnline, isInProgress) {
  if (isInProgress) {
    return { action: 'blocked', reason: 'in_progress' };
  }
  if (!isOnline) {
    return { action: 'blocked', reason: 'offline' };
  }
  return { action: 'proceed' };
}

test('GO button blocks when offline', () => {
  const result = simulateGoButtonHandler(false, false);
  assert.strictEqual(result.action, 'blocked');
  assert.strictEqual(result.reason, 'offline');
});

test('GO button proceeds when online', () => {
  const result = simulateGoButtonHandler(true, false);
  assert.strictEqual(result.action, 'proceed');
});

test('GO button blocks when in progress', () => {
  const result = simulateGoButtonHandler(true, true);
  assert.strictEqual(result.action, 'blocked');
  assert.strictEqual(result.reason, 'in_progress');
});

// Summary
console.log(`\n=== Results ===`);
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total: ${passed + failed}`);

process.exit(failed > 0 ? 1 : 0);
