/**
 * E2E Test: Credits Cache on Logout
 *
 * Tests that logout properly clears the credits cache:
 * - clearCreditsCache() function exists in credits.js
 * - logout() calls clearCreditsCache()
 * - logout() updates credit badge display
 */

const assert = require('assert');
const fs = require('fs');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`✗ ${name}`);
    console.log(`  Error: ${err.message}`);
    failed++;
  }
}

// ============================================================================
// Static Code Analysis Tests
// ============================================================================

console.log('\n=== Credits Cache Logout Tests ===\n');

// Read credits.js
const creditsCode = fs.readFileSync(__dirname + '/../../splice-plugin/js/credits.js', 'utf8');

test('credits.js has clearCreditsCache function', () => {
  assert.ok(creditsCode.includes('function clearCreditsCache()'), 'Missing clearCreditsCache function');
});

test('clearCreditsCache clears currentCredits', () => {
  assert.ok(creditsCode.includes('currentCredits = null'), 'Missing currentCredits = null in clearCreditsCache');
});

test('clearCreditsCache clears lastCreditsError', () => {
  assert.ok(creditsCode.includes('lastCreditsError = null'), 'Missing lastCreditsError = null');
});

test('clearCreditsCache resets creditsRetryCount', () => {
  assert.ok(creditsCode.includes('creditsRetryCount = 0'), 'Missing creditsRetryCount = 0');
});

// Read settings.js
const settingsCode = fs.readFileSync(__dirname + '/../../splice-plugin/js/settings.js', 'utf8');

test('logout calls clearCreditsCache', () => {
  assert.ok(settingsCode.includes('clearCreditsCache'), 'logout missing clearCreditsCache call');
});

test('logout calls updateCreditDisplay(null)', () => {
  assert.ok(settingsCode.includes('updateCreditDisplay(null)'), 'logout missing updateCreditDisplay(null)');
});

test('logout clears customerId', () => {
  assert.ok(settingsCode.includes('customerId: null'), 'logout missing customerId: null');
});

// ============================================================================
// Logic Simulation Tests
// ============================================================================

// Simulate credits state
let mockCurrentCredits = { hoursRemaining: 5, tier: 'Pro' };
let mockLastCreditsError = 'Some error';
let mockCreditsRetryCount = 2;

function simulateClearCreditsCache() {
  mockCurrentCredits = null;
  mockLastCreditsError = null;
  mockCreditsRetryCount = 0;
}

test('clearCreditsCache resets all credit state', () => {
  // Set up initial state
  mockCurrentCredits = { hoursRemaining: 5 };
  mockLastCreditsError = 'Error';
  mockCreditsRetryCount = 3;

  // Clear cache
  simulateClearCreditsCache();

  // Verify all cleared
  assert.strictEqual(mockCurrentCredits, null);
  assert.strictEqual(mockLastCreditsError, null);
  assert.strictEqual(mockCreditsRetryCount, 0);
});

// Simulate logout flow
let mockSettings = { customerId: 'cus_123' };
let mockCreditBadgeText = '5.0 hrs';

function simulateLogout() {
  // Clear customerId
  mockSettings.customerId = null;

  // Clear credits cache
  simulateClearCreditsCache();

  // Update badge to login state
  mockCreditBadgeText = 'Login';
}

test('logout clears customer ID and updates badge', () => {
  // Set up initial state
  mockSettings.customerId = 'cus_123';
  mockCreditBadgeText = '10.0 hrs';
  mockCurrentCredits = { hoursRemaining: 10 };

  // Logout
  simulateLogout();

  // Verify
  assert.strictEqual(mockSettings.customerId, null);
  assert.strictEqual(mockCreditBadgeText, 'Login');
  assert.strictEqual(mockCurrentCredits, null);
});

// Summary
console.log(`\n=== Results ===`);
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total: ${passed + failed}`);

process.exit(failed > 0 ? 1 : 0);
