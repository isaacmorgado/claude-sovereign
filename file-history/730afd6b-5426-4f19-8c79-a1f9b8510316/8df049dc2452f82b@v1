/**
 * E2E Test: Credits Badge Error State
 *
 * Tests that the credit badge properly handles error states:
 * - Shows "Login" when no customer ID
 * - Shows error state with retry on fetch failure
 * - Retry button works and clears error on success
 */

const assert = require('assert');
const fs = require('fs');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`✗ ${name}`);
    console.log(`  Error: ${err.message}`);
    failed++;
  }
}

// ============================================================================
// Static Code Analysis Tests
// ============================================================================

console.log('\n=== Credits Badge Error State Tests ===\n');

// Read credits.js
const creditsCode = fs.readFileSync(__dirname + '/../../splice-plugin/js/credits.js', 'utf8');

test('credits.js has error tracking variables', () => {
  assert.ok(creditsCode.includes('lastCreditsError'), 'Missing lastCreditsError variable');
  assert.ok(creditsCode.includes('creditsRetryCount'), 'Missing creditsRetryCount variable');
});

test('fetchCredits returns error object on failure', () => {
  assert.ok(creditsCode.includes('_error: true'), 'Missing error object return');
  assert.ok(creditsCode.includes('message: errorMsg') || creditsCode.includes('message: lastCreditsError'), 'Missing error message');
});

test('updateCreditDisplay handles null (login state)', () => {
  assert.ok(creditsCode.includes("textContent = 'Login'"), 'Missing Login text for null credits');
  assert.ok(creditsCode.includes("classList.add('login')"), 'Missing login class addition');
});

test('updateCreditDisplay handles error state', () => {
  assert.ok(creditsCode.includes('_error'), 'Missing error check in updateCreditDisplay');
  assert.ok(creditsCode.includes("'⚠ Retry'") || creditsCode.includes("'Retry'"), 'Missing Retry text');
  assert.ok(creditsCode.includes("classList.add('error')"), 'Missing error class addition');
});

test('updateCreditDisplay clears error classes on success', () => {
  assert.ok(creditsCode.includes("classList.remove('error'"), 'Missing error class removal');
});

// Read settings.js
const settingsCode = fs.readFileSync(__dirname + '/../../splice-plugin/js/settings.js', 'utf8');

test('settings.js handles retry on badge click', () => {
  assert.ok(settingsCode.includes("classList.contains('error')"), 'Missing error class check');
  assert.ok(settingsCode.includes('refreshCredits'), 'Missing refreshCredits call for retry');
});

// Read index.html for CSS
const htmlCode = fs.readFileSync(__dirname + '/../../splice-plugin/index.html', 'utf8');

test('index.html has error badge CSS', () => {
  assert.ok(htmlCode.includes('.credit-badge.error'), 'Missing .credit-badge.error CSS');
  assert.ok(htmlCode.includes('ff9800'), 'Missing orange color for error state');
});

test('index.html has login badge CSS', () => {
  assert.ok(htmlCode.includes('.credit-badge.login'), 'Missing .credit-badge.login CSS');
});

// ============================================================================
// Logic Simulation Tests
// ============================================================================

// Simulate updateCreditDisplay logic
function simulateUpdateCreditDisplay(credits) {
  const result = {
    display: 'flex',
    text: '',
    title: '',
    classes: []
  };

  if (!credits) {
    result.text = 'Login';
    result.title = 'Click to enter license key';
    result.classes = ['login'];
    return result;
  }

  if (credits._error) {
    result.text = '⚠ Retry';
    result.title = `Error: ${credits.message}\nClick to retry`;
    result.classes = ['error'];
    return result;
  }

  result.text = `${credits.hoursRemaining.toFixed(1)} hrs`;
  result.title = `${credits.tierName}: ${credits.hoursRemaining.toFixed(1)} / ${credits.hoursTotal} hours`;

  if (credits.hoursRemaining <= 1) {
    result.classes = ['low'];
  } else {
    result.classes = ['ok'];
  }

  return result;
}

test('updateCreditDisplay shows Login for null', () => {
  const result = simulateUpdateCreditDisplay(null);
  assert.strictEqual(result.text, 'Login');
  assert.ok(result.classes.includes('login'));
});

test('updateCreditDisplay shows Retry for error', () => {
  const result = simulateUpdateCreditDisplay({ _error: true, message: 'Connection failed' });
  assert.strictEqual(result.text, '⚠ Retry');
  assert.ok(result.classes.includes('error'));
  assert.ok(result.title.includes('Connection failed'));
});

test('updateCreditDisplay shows hours for valid credits', () => {
  const result = simulateUpdateCreditDisplay({ hoursRemaining: 5.5, hoursTotal: 12, tierName: 'Pro' });
  assert.strictEqual(result.text, '5.5 hrs');
  assert.ok(result.classes.includes('ok'));
});

test('updateCreditDisplay shows low state for < 1 hour', () => {
  const result = simulateUpdateCreditDisplay({ hoursRemaining: 0.5, hoursTotal: 12, tierName: 'Pro' });
  assert.ok(result.classes.includes('low'));
});

// Summary
console.log(`\n=== Results ===`);
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total: ${passed + failed}`);

process.exit(failed > 0 ? 1 : 0);
