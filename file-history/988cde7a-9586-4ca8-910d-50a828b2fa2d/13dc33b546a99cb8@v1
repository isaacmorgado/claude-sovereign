# FaceIQ Reference Cleanup Plan

**Status:** To Be Completed
**Files Affected:** 21 files
**Estimated Time:** 2-3 hours

---

## Files Requiring Changes

### Priority 1: Core Detection Files (CRITICAL)

1. **src/lib/mediapipeDetection.ts**
   - Line 13: `import { applyFaceIQCorrection, applyFrankfortCorrection, rotateImageFaceIQ } from './sideProfileNormalization';`
   - Line 229-246: Multiple comments mentioning "FaceIQ PARITY FIX"
   - Line 276: `rotatedImageUrl, // FaceIQ parity: rotated image matches rotated landmarks`

   **Changes Needed:**
   - Rename `applyFaceIQCorrection` → `applySideProfileRotation`
   - Rename `rotateImageFaceIQ` → `rotateSideProfileImage`
   - Remove "FaceIQ PARITY" comments, replace with technical descriptions

2. **src/lib/serverSideDetection.ts**
   - Line 1-9: File header mentions "FaceIQ-level accuracy"
   - Line 143-146: "FaceIQ PARITY FIX #1" comment
   - Line 254-256: "FaceIQ PARITY FIX #2" comment

   **Changes Needed:**
   - Replace "FaceIQ-level" → "high-precision"
   - Remove all "PARITY FIX" comments
   - Update to describe WHY changes were made (technical reasons)

3. **src/lib/sideProfileNormalization.ts**
   - Line 1-13: File header "FaceIQ Parity Implementation"
   - Line 7-9: "FaceIQ Algorithm (reverse-engineered)"
   - Line 42-67: `_FACEIQ_INDEX_REFERENCE` constant
   - Lines 70-278: Multiple function names with "FaceIQ"

   **Function Renaming:**
   ```typescript
   // OLD → NEW
   calculateFaceIQRotationAngle() → calculateRotationAngle()
   getFaceIQPivot() → getRotationPivot()
   rotatePointFaceIQ() → rotatePoint()
   calculateFaceIQCropSize() → calculateCropSize()
   applyFaceIQNormalization() → applySideProfileNormalization()
   applyFaceIQCorrection() → applySideProfileRotation()
   rotateImageFaceIQ() → rotateSideProfileImage()
   ```

4. **src/components/LandmarkAnalysisTool.tsx**
   - Line 65-66: "// FaceIQ PARITY: Use rotated image for side profiles"
   - Line 463-467: "FaceIQ PARITY" comment
   - Line 851: "FaceIQ PARITY" comment

   **Changes Needed:**
   - Replace comments with technical explanation
   - Example: "Side profiles use rotated images to match normalized landmark coordinates"

---

### Priority 2: Library Files (HIGH)

5. **src/lib/faceiq-parity/** (RENAME ENTIRE FOLDER)
   - **NEW NAME:** `src/lib/landmark-analysis/`

   Files in folder:
   - `index.ts` → Keep, update imports
   - `categoryScores.ts` → Keep
   - `metricLandmarks.ts` → Keep
   - `scoring.ts` → Keep
   - `sideLandmarks.ts` → Keep
   - `potential.ts` → Keep

   **Update all imports:**
   ```typescript
   // OLD
   import { ... } from '@/lib/faceiq-parity/scoring';

   // NEW
   import { ... } from '@/lib/landmark-analysis/scoring';
   ```

6. **src/lib/advice-engine.ts**
   - Search for "parity" references
   - Update any FaceIQ-specific comments

7. **src/lib/trigger-rules.ts**
   - Search for "parity" references
   - Update any FaceIQ-specific comments

8. **src/lib/landmarks.ts**
   - Search for "FaceIQ" references
   - Update landmark documentation

---

### Priority 3: Component Files (MEDIUM)

9. **src/components/results/visualization/CategoryBreakdown.tsx**
10. **src/components/results/visualization/GradientRangeBar.tsx**
11. **src/components/results/tabs/OverviewTab.tsx**
12. **src/components/SideProfileManualTool.tsx**

   **Changes Needed:**
   - Update import paths if using `faceiq-parity` folder
   - Remove any comments mentioning competitor

---

### Priority 4: Type Definitions (MEDIUM)

13. **src/types/results.ts**
    - Update type names if any reference FaceIQ

14. **src/lib/recommendations/types.ts**
    - Update type names if any reference FaceIQ

15. **src/lib/colors.ts**
    - Update any color system references

---

### Priority 5: Hooks (LOW)

16. **src/hooks/useLandmarkAdjustment.ts**
    - Update any FaceIQ references in comments

---

### Priority 6: Test/Documentation Files (LOW)

17. **test-demographic-scoring.ts**
18. **changes.md**

   **Changes Needed:**
   - Update test file imports
   - Archive changes.md or update references

---

## Specific Code Changes

### 1. Rename Functions (sideProfileNormalization.ts)

```typescript
// BEFORE
export function calculateFaceIQRotationAngle(
    landmarks: Array<{ x: number; y: number }>,
    direction: 'left' | 'right'
): number {
    // FaceIQ algorithm:
    // anchor = (direction === "left") ? landmarks[75] : landmarks[10];
    const anchor = direction === 'left' ? landmarks[75] : landmarks[10];
    // ...
}

// AFTER
export function calculateRotationAngle(
    landmarks: Array<{ x: number; y: number }>,
    direction: 'left' | 'right'
): number {
    // Calculate rotation angle using landmark indices 10, 26, 75
    // This normalizes side profile orientation for consistent measurements
    const anchor = direction === 'left' ? landmarks[75] : landmarks[10];
    // ...
}
```

### 2. Update Comments (mediapipeDetection.ts)

```typescript
// BEFORE
// FaceIQ PARITY FIX: Apply rotation in pixel space FIRST, then normalize to 0-1
// Step 1: Rotate landmarks using FaceIQ algorithm (in pixel coordinates)

// AFTER
// Apply rotation in pixel coordinates before normalization to preserve precision
// Step 1: Rotate landmarks to normalize side profile orientation
```

### 3. Update File Headers

```typescript
// BEFORE
/**
 * Side Profile Normalization Utilities - FaceIQ Parity Implementation
 *
 * This module replicates FaceIQ's exact side profile normalization algorithm
 * for 100% parity with their landmark detection and visualization.
 */

// AFTER
/**
 * Side Profile Normalization Utilities
 *
 * Normalizes side profile images and landmarks using rotation-based alignment.
 * Implements standard cephalometric orientation with landmark indices 10, 26, 75.
 */
```

### 4. Rename Folder

```bash
# Command to run:
mv src/lib/faceiq-parity src/lib/landmark-analysis
```

### 5. Update All Imports

Files importing from `faceiq-parity` folder (estimated 15+ files):

```typescript
// Find all imports:
grep -r "from '@/lib/faceiq-parity" src/ -l

// Replace in each file:
// OLD: from '@/lib/faceiq-parity/scoring'
// NEW: from '@/lib/landmark-analysis/scoring'
```

---

## Automated Cleanup Script

```bash
#!/bin/bash
# cleanup_faceiq.sh

echo "Starting FaceIQ reference cleanup..."

# 1. Rename folder
echo "Renaming faceiq-parity folder..."
mv src/lib/faceiq-parity src/lib/landmark-analysis

# 2. Update all import paths
echo "Updating import paths..."
find src/ -type f \( -name "*.ts" -o -name "*.tsx" \) -exec sed -i '' \
  's|@/lib/faceiq-parity|@/lib/landmark-analysis|g' {} +

# 3. Remove "FaceIQ PARITY" comments
echo "Removing FaceIQ PARITY comments..."
find src/ -type f \( -name "*.ts" -o -name "*.tsx" \) -exec sed -i '' \
  's|// FaceIQ PARITY.*||g' {} +

# 4. Rename function names (requires manual verification)
echo "Function renames require manual review - see CLEANUP_FACEIQ_REFERENCES.md"

# 5. Update file headers (requires manual review)
echo "File header updates require manual review - see CLEANUP_FACEIQ_REFERENCES.md"

echo "Automated cleanup complete. Manual review required for:"
echo "  - Function name changes (sideProfileNormalization.ts)"
echo "  - File header updates"
echo "  - Comment rewrites"
echo ""
echo "Run 'npm run lint' to check for broken imports."
```

---

## Validation Checklist

After cleanup, verify:

- [ ] `npm run lint` passes (no import errors)
- [ ] `npx tsc --noEmit` passes (no type errors)
- [ ] `npm run build` succeeds
- [ ] No grep matches for "FaceIQ|faceiq|FACEIQ"
- [ ] No grep matches for "parity|Parity|PARITY" (except in MATHEMATICAL_ANALYSIS.md)
- [ ] All imports resolve correctly
- [ ] Side profile detection still works
- [ ] Image rotation still works

---

## Post-Cleanup Actions

1. **Update CLAUDE.md**
   - Remove references to "FaceIQ parity"
   - Update function names in documentation

2. **Update Comments in Key Files**
   - Explain WHY rotation happens in pixel space (precision)
   - Explain WHY we use indices 10, 26, 75 (standard reference points)

3. **Add New Documentation**
   - Document the rotation algorithm mathematically
   - Add references to cephalometric standards (Farkas, etc.)

---

## Estimated Time

| Task | Time |
|------|------|
| Automated script | 5 min |
| Manual function renames | 30 min |
| Comment rewrites | 45 min |
| Import path updates | 15 min |
| Validation & testing | 30 min |
| Documentation updates | 15 min |
| **TOTAL** | **~2.5 hours** |

---

## Notes

- Keep MATHEMATICAL_ANALYSIS.md which documents the comparison (for reference)
- Archive changes.md or update it to remove competitor references
- Consider adding badges/metrics to README about mathematical superiority
- All technical improvements (rotation sequence, overlap tracking) should be preserved
- Only remove REFERENCES to competitor, not the actual implementation improvements
