# Splice v3

Cloud-powered SaaS for Adobe Premiere Pro with AI-driven auto-cutting, take detection, and subscription billing.

## Monorepo Structure

```
/                         # Root
├── src/                  # Premiere Pro UXP Plugin
│   ├── components/
│   │   ├── panels/       # PluginApp (main container)
│   │   └── common/       # UI: Header, SelectionPanel, AIToolsPanel, AuthPanel, CuttingPanel
│   ├── types/            # TypeScript: plugin, api, premiere, audio, take-detection
│   ├── utils/
│   │   ├── api/          # premiere.ts, backend-client.ts, audio-processor.ts
│   │   └── helpers/      # formatters, validators
│   └── styles/           # Global CSS, Spectrum theming
│
├── backend/              # Node.js + Express API
│   └── src/
│       ├── routes/       # auth, billing, jobs, audio, usage
│       ├── controllers/  # Route handlers
│       ├── services/     # Business logic
│       ├── workers/      # BullMQ job processors (transcription, vocal isolation)
│       ├── db/           # migrations/, repositories/
│       └── middleware/   # auth, rate-limit, usage-limit
│
├── dashboard/            # Next.js Web Dashboard
│   └── app/              # login, signup, dashboard (usage, billing, settings)
│
├── tests/                # Vitest unit + Playwright e2e
└── public/               # manifest.json, icons
```

## Tech Stack

| Layer     | Stack                                                             |
| --------- | ----------------------------------------------------------------- |
| Plugin    | Lit 3.2 + Spectrum Web Components + TypeScript                    |
| Backend   | Node.js + Express + PostgreSQL + BullMQ/Redis                     |
| Dashboard | Next.js + React                                                   |
| Audio     | Whisper/Deepgram (transcription) + Demucs/Dolby (vocal isolation) |
| Payments  | Stripe                                                            |

## Code Quality - Zero Tolerance

After editing ANY file, run:

```bash
npm run lint
npm run typecheck
```

Fix ALL errors/warnings before continuing.

## Current Focus

Section: Phase 2 - Plugin Integration (S3 file upload complete, ready for testing)
Files: `src/components/common/AIToolsPanel.ts`, `backend/src/services/s3-service.ts`, `src/utils/api/backend-client.ts`

## Last Session (2025-12-16)

### Completed

- S3 file upload flow fully implemented:
  - Backend: AWS SDK installed, S3 service with presigned URL generation
  - Backend: `POST /audio/presigned-url` endpoint with auth + validation
  - Frontend: `uploadFile()`, `getPresignedUploadUrl()`, `uploadFileToS3()` methods in backend-client
  - Frontend: Drag-drop upload UI in AIToolsPanel with progress indicator
  - Cloud tool buttons: "Transcribe Audio" and "Isolate Vocals"
- QA validated: All 20 requirements pass, lint/typecheck clean

### Stopped at

File upload implementation complete but not yet tested with real S3 credentials.

### Test Credentials

- Email: `test2@example.com`
- Password: `TestPass123`

### S3 Setup Required

Add to `backend/.env`:
```
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your_key
AWS_SECRET_ACCESS_KEY=your_secret
S3_BUCKET_NAME=your-bucket-name
```

## Next Steps

1. Test file upload with real S3 bucket
2. Add unit tests for S3 service
3. Add job progress notifications (WebSocket or polling)
4. Consider upload progress indicator for large files

## Dev Server Commands

```bash
# Plugin (Vite) - runs on port 3000 (or 3002 if port in use)
npm run dev

# Backend - runs on port 3001
cd backend && npm run dev

# Health check
curl http://localhost:3001/health
```

## Backend Client API

```typescript
import { backendClient } from '@/utils/api/backend-client'

// Auth
backendClient.login(email, password)
backendClient.register(email, password, name?)
backendClient.logout()
backendClient.getMe()
backendClient.isAuthenticated()
backendClient.onAuthChange(callback) // returns unsubscribe fn

// Usage
backendClient.getUsage()
backendClient.checkUsageLimit(minutes)
backendClient.canSubmitAudioJob(minutes)

// Audio Jobs
backendClient.submitTranscription(audioUrl, durationMinutes)
backendClient.submitVocalIsolation(audioUrl, durationMinutes)
backendClient.getJobs(limit?, offset?)
backendClient.getJob(jobId)
backendClient.pollJobUntilComplete(jobId, onProgress?, {intervalMs?, maxAttempts?, signal?})

// Billing
backendClient.createCheckout(tier, interval?)
backendClient.createPortal()
backendClient.getBillingStatus()
```

## Key Patterns

| Area           | Pattern                                                        |
| -------------- | -------------------------------------------------------------- |
| AuthPanel      | `isMounted` flag prevents async writes on unmounted component  |
| AuthPanel      | `if (this.isLoading) return` prevents double-submission        |
| AuthPanel      | `getSafePlanClass()` validates plan enum before CSS class use  |
| SettingsPanel  | User prop passed from PluginApp, logout dispatches event       |
| SettingsPanel  | Billing buttons call `backendClient.createCheckout/createPortal` and `window.open` |
| backend-client | Refresh token mutex prevents concurrent refresh race condition |
| backend-client | localStorage fallback for browser dev mode (no UXP)            |
| tsconfig       | `useDefineForClassFields: false` fixes Lit decorator issue     |
