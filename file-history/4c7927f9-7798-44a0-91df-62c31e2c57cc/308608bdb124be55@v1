# SPLICE Project Guidelines

## Coding Standards
- Use modern JavaScript/TypeScript patterns.
- Ensure all error handling is verbose and descriptive.
- Prefer functional components for React parts.

## Development Environment
- This is a local development environment.
- All code is executed in a sandboxed simulation.
- Mock APIs are available in `mock-api.js`.

## Output Preferences
- When providing code, prefer complete files over snippets to facilitate copy-pasting.
- Focus on technical implementation details.

---

## Security Audit Status (2025-12-29) - COMPLETED

### Backend Authentication
| Item | Status | Location |
|------|--------|----------|
| JWT token generation | ✅ Done | `middleware/auth.js` - includes `jti` claim |
| Token verification | ✅ Done | `middleware/auth.js` - checks blacklist |
| Login endpoint | ✅ Done | `routes/auth.js` |
| Refresh token endpoint | ✅ Done | `routes/auth.js` |
| Token blacklisting | ✅ Upgraded | `middleware/auth.js` - Upstash Redis with TTL + in-memory fallback |
| Revocation check in middleware | ✅ Done | `middleware/auth.js` - async `isTokenBlacklisted()` check |
| Redis client service | ✅ Done | `services/redisClient.js` - shared Upstash Redis client |

### Frontend Authentication
| Item | Status | Location |
|------|--------|----------|
| Login page UI | ✅ Done | `splice-website/src/app/login/page.tsx` |
| Real auth integration | ✅ Fixed | Calls `/api/auth/login` endpoint |
| Token storage | ✅ Fixed | localStorage with `splice_token`, `splice_refresh_token` |
| Auth context/provider | ⚠️ Optional | Can be added for better state management |

### Music Credits - Race Conditions
| Item | Status | Location |
|------|--------|----------|
| `deductMusicCredit` | ✅ Safe | `usageTracking.js` - uses SELECT...FOR UPDATE |
| `deductVariationsCredit` | ✅ Safe | `usageTracking.js` |
| `deductSceneAwareCredit` | ✅ Safe | `usageTracking.js` |
| `addMusicCredits` | ✅ Fixed | `usageTracking.js` - added transaction + FOR UPDATE |
| `resetMusicCredits` | ✅ Fixed | `usageTracking.js` - added transaction + FOR UPDATE |

### Contact Form
| Item | Status | Location |
|------|--------|----------|
| Contact form UI | ✅ Done | `splice-website/src/app/contact/page.tsx` |
| Form submission handler | ✅ Fixed | Calls `/api/contact` with loading/error states |
| API endpoint | ✅ Fixed | `splice-website/src/app/api/contact/route.ts` |
| Email notification | ✅ Done | Sends to sales@splice.app via SendGrid |

### Email Service
| Item | Status | Location |
|------|--------|----------|
| SendGrid implementation | ✅ Done | `services/emailService.js` |
| AWS SES fallback | ✅ Done | `services/emailService.js` |
| Email templates | ✅ Done | License, Payment Warning, Sign-in Code, Email Verification |
| ENV variables documented | ✅ Fixed | `.env.template` has email section |
| Production configuration | ⚠️ Manual | Set `EMAIL_PROVIDER=sendgrid` + API key |

### Email Verification Flow
| Item | Status | Location |
|------|--------|----------|
| POST /auth/send-verification | ✅ Done | `routes/auth.js` - generates 6-digit code, sends email |
| POST /auth/verify-email | ✅ Done | `routes/auth.js` - validates code, marks email verified |
| Verification code storage | ✅ Done | `routes/auth.js` - in-memory Map with 10min TTL |
| Rate limiting | ✅ Done | `routes/auth.js` - 60s cooldown between sends |
| Attempt limiting | ✅ Done | `routes/auth.js` - max 5 attempts per code |
| Database persistence | ✅ Done | `usageTracking.js` - `email_verified`, `email_verified_at` columns |
| Email verification template | ✅ Done | `services/emailService.js` - `sendEmailVerificationCode()` |

### CSRF Protection
| Item | Status | Location |
|------|--------|----------|
| CSRF middleware | ✅ Done | `middleware/csrf.js` - double-submit cookie pattern |
| CSRF token endpoint | ✅ Done | `GET /auth/csrf-token` - generates and returns token |
| Login CSRF protection | ✅ Done | `routes/auth.js` - `validateCsrfToken` middleware |
| Refresh CSRF protection | ✅ Done | `routes/auth.js` - `validateCsrfToken` middleware |
| Logout CSRF protection | ✅ Done | `routes/auth.js` - `validateCsrfToken` middleware |
| CORS X-CSRF-Token header | ✅ Done | `server.js` - added to allowedHeaders |
| Cookie parser middleware | ✅ Done | `server.js` - `cookie-parser` package |
| Frontend CSRF utility | ✅ Done | `splice-website/src/lib/csrf.ts` |
| Frontend CSRF hook | ✅ Done | `splice-website/src/hooks/useCsrf.ts` |
| Server CSRF validation | ✅ Done | `splice-website/src/lib/csrf-server.ts` |
| AuthContext CSRF | ✅ Done | `splice-website/src/context/AuthContext.tsx` |
| Contact form CSRF | ✅ Done | `splice-website/src/app/contact/page.tsx` |
| Contact API CSRF | ✅ Done | `splice-website/src/app/api/contact/route.ts` |
| Checkout API CSRF | ✅ Done | `splice-website/src/app/api/checkout/route.ts` |
| Login API CSRF forwarding | ✅ Done | `splice-website/src/app/api/auth/login/route.ts` |

### Required ENV Variables for Email
```
EMAIL_PROVIDER=sendgrid
SENDGRID_API_KEY=SG_your_key_here
EMAIL_FROM=SPLICE <noreply@splice.video>
EMAIL_REPLY_TO=support@splice.video
```
