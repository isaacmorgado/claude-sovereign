#!/bin/bash
# Test /auto mode integration for the 4 critical bug fixes

set -e

echo "üß™ Testing /auto Mode Integration"
echo "=================================="
echo ""

PASS=0
FAIL=0

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

pass() {
    echo -e "${GREEN}‚úì${NC} $1"
    PASS=$((PASS + 1))
}

fail() {
    echo -e "${RED}‚úó${NC} $1"
    FAIL=$((FAIL + 1))
}

info() {
    echo -e "${YELLOW}‚Ñπ${NC} $1"
}

echo "Test 1: Validation Gate Integration (Bug #2)"
echo "---------------------------------------------"

# Check if validation-gate.sh is registered in settings.json
if grep -q "validation-gate.sh validate_command" ~/.claude/settings.json; then
    pass "validation-gate.sh registered in PreToolUse hook"
else
    fail "validation-gate.sh NOT registered in settings.json"
fi

# Check if validation-gate.sh is executable
if [[ -x ~/.claude/hooks/validation-gate.sh ]]; then
    pass "validation-gate.sh is executable"
else
    fail "validation-gate.sh is NOT executable"
fi

echo ""
echo "Test 2: Post-Edit Quality Integration (Bug #1)"
echo "-----------------------------------------------"

# Check if post-edit-quality.sh is registered
if grep -q "post-edit-quality.sh" ~/.claude/settings.json; then
    pass "post-edit-quality.sh registered in PostToolUse hook"
else
    fail "post-edit-quality.sh NOT registered in settings.json"
fi

# Check if Phase 1 integration code exists (file caching)
if grep -q "PHASE 1 INTEGRATION" ~/.claude/hooks/post-edit-quality.sh; then
    pass "Phase 1 integration code present (file caching)"
else
    fail "Phase 1 integration code NOT found"
fi

# Check if the early exit at line 191 has been removed
# (The fix was that line 191 had an exit, but Phase 1 code should come BEFORE any exit)
line_101_to_160=$(sed -n '101,160p' ~/.claude/hooks/post-edit-quality.sh)
if echo "$line_101_to_160" | grep -q "PHASE 1 INTEGRATION"; then
    pass "Phase 1 code (lines 101-160) is reachable (no early exit)"
else
    fail "Phase 1 code may be unreachable"
fi

echo ""
echo "Test 3: Coordinator Error Handling (Bug #3)"
echo "--------------------------------------------"

# Check if log_failure function exists
if grep -q "log_failure()" ~/.claude/hooks/coordinator.sh; then
    pass "log_failure() function added to coordinator.sh"
else
    fail "log_failure() function NOT found in coordinator.sh"
fi

# Check if show_advisory function exists
if grep -q "show_advisory()" ~/.claude/hooks/coordinator.sh; then
    pass "show_advisory() function added to coordinator.sh"
else
    fail "show_advisory() function NOT found in coordinator.sh"
fi

# Check if error suppression has been fixed (should NOT have > /dev/null 2>&1 || true anymore)
# Count how many "|| true" patterns remain in learning/memory init
learning_init_lines=$(sed -n '76,94p' ~/.claude/hooks/coordinator.sh)
if echo "$learning_init_lines" | grep -q "log_failure"; then
    pass "System initialization now logs failures (lines 76-94)"
else
    fail "System initialization still suppresses errors"
fi

# Check if audit trail logging uses log_failure
if grep -A 3 'ENHANCED_AUDIT_TRAIL.*log.*reasoning_mode' ~/.claude/hooks/coordinator.sh | grep -q "log_failure"; then
    pass "Audit trail failures are now logged"
else
    fail "Audit trail failures still suppressed"
fi

echo ""
echo "Test 4: Agent Loop Memory Handling (Bug #4)"
echo "--------------------------------------------"

# Check if show_memory_advisory function exists
if grep -q "show_memory_advisory()" ~/.claude/hooks/agent-loop.sh; then
    pass "show_memory_advisory() function added to agent-loop.sh"
else
    fail "show_memory_advisory() function NOT found in agent-loop.sh"
fi

# Check if MEMORY_AVAILABLE flag exists
if grep -q "MEMORY_AVAILABLE=" ~/.claude/hooks/agent-loop.sh; then
    pass "MEMORY_AVAILABLE flag added for tracking"
else
    fail "MEMORY_AVAILABLE flag NOT found"
fi

# Check if memory_init shows advisory on failure
if grep -A 10 "memory_init()" ~/.claude/hooks/agent-loop.sh | grep -q "show_memory_advisory"; then
    pass "memory_init() shows advisory on failure"
else
    fail "memory_init() does NOT show advisory on failure"
fi

# Check if memory_record_success shows advisory on failure
if grep -A 20 "memory_record_success()" ~/.claude/hooks/agent-loop.sh | grep -q "show_memory_advisory"; then
    pass "memory_record_success() shows advisory on failure"
else
    fail "memory_record_success() does NOT show advisory on failure"
fi

echo ""
echo "=================================="
echo "Test Summary"
echo "=================================="
echo -e "${GREEN}Passed: $PASS${NC}"
echo -e "${RED}Failed: $FAIL${NC}"
echo ""

if [[ $FAIL -eq 0 ]]; then
    echo -e "${GREEN}‚úÖ All integration tests passed!${NC}"
    echo ""
    echo "The 4 critical bug fixes are properly integrated into /auto mode:"
    echo "  ‚úì Bug #1: post-edit-quality.sh Phase 1 integration reachable"
    echo "  ‚úì Bug #2: validation-gate.sh registered in PreToolUse hook"
    echo "  ‚úì Bug #3: coordinator.sh error handling with log_failure/show_advisory"
    echo "  ‚úì Bug #4: agent-loop.sh memory advisory with show_memory_advisory"
    echo ""
    exit 0
else
    echo -e "${RED}‚ùå Some tests failed. Check the output above.${NC}"
    exit 1
fi
