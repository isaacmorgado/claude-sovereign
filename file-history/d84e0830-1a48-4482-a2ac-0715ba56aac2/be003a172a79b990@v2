#!/bin/bash

#===============================================================================
#
#   INTRUDER HUNTER - macOS Security Diagnostic & Hardening Tool
#
#   Scans your system for intruders, malware, and vulnerabilities.
#   Then offers to fix issues found.
#
#   Usage: sudo ./intruder-hunter-mac.sh
#
#   Adapted for macOS from: https://github.com/creativeprofit22/intruder-hunter
#
#===============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Symbols
CHECK="${GREEN}✓${NC}"
CROSS="${RED}✗${NC}"
WARN="${YELLOW}!${NC}"
INFO="${BLUE}ℹ${NC}"

# Global counters
ISSUES_FOUND=0
WARNINGS_FOUND=0

#-------------------------------------------------------------------------------
# Helper Functions
#-------------------------------------------------------------------------------

banner() {
    clear
    echo -e "${PURPLE}"
    echo '  ___       _                  _             _   _             _            '
    echo ' |_ _|_ __ | |_ _ __ _   _  __| | ___ _ __  | | | |_   _ _ __ | |_ ___ _ __ '
    echo '  | ||  _ \| __|  __| | | |/ _` |/ _ \  __| | |_| | | | |  _ \| __/ _ \  __|'
    echo '  | || | | | |_| |  | |_| | (_| |  __/ |    |  _  | |_| | | | | ||  __/ |   '
    echo ' |___|_| |_|\__|_|   \__,_|\__,_|\___|_|    |_| |_|\__,_|_| |_|\__\___|_|   '
    echo -e "${NC}"
    echo -e "${WHITE}  macOS Security Diagnostic & Hardening Tool${NC}"
    echo -e "${CYAN}  ─────────────────────────────────────────────────────────────────${NC}"
    echo ""
}

section() {
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${WHITE}  $1${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
}

ok() {
    echo -e "  ${CHECK} $1"
}

fail() {
    echo -e "  ${CROSS} $1"
    ((ISSUES_FOUND++)) || true
}

warn() {
    echo -e "  ${WARN} $1"
    ((WARNINGS_FOUND++)) || true
}

info() {
    echo -e "  ${INFO} $1"
}

ask_yes_no() {
    local prompt="$1"
    local response
    echo ""
    echo -e -n "${YELLOW}  $prompt (y/n): ${NC}"
    read -r response
    [[ "$response" =~ ^[Yy]$ ]]
}

spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while ps -p $pid > /dev/null 2>&1; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "      \b\b\b\b\b\b"
}

#-------------------------------------------------------------------------------
# Check if running as root
#-------------------------------------------------------------------------------

check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}Error: This script must be run as root (use sudo)${NC}"
        echo ""
        echo "  Usage: sudo ./intruder-hunter-mac.sh"
        echo ""
        exit 1
    fi
}

#-------------------------------------------------------------------------------
# System Information (macOS adapted)
#-------------------------------------------------------------------------------

show_system_info() {
    section "SYSTEM INFORMATION"

    local os_name=$(sw_vers -productName 2>/dev/null || echo "macOS")
    local os_version=$(sw_vers -productVersion 2>/dev/null || echo "unknown")
    local build=$(sw_vers -buildVersion 2>/dev/null || echo "unknown")
    local kernel=$(uname -r)
    local hostname=$(hostname)
    local uptime_info=$(uptime | sed 's/.*up/up/' | sed 's/,.*//')

    echo -e "  ${WHITE}Hostname:${NC}    $hostname"
    echo -e "  ${WHITE}OS:${NC}          $os_name $os_version ($build)"
    echo -e "  ${WHITE}Kernel:${NC}      Darwin $kernel"
    echo -e "  ${WHITE}Uptime:${NC}      $uptime_info"
    echo -e "  ${WHITE}Scan Date:${NC}   $(date)"
}

#-------------------------------------------------------------------------------
# 1. Check for suspicious processes (macOS adapted)
#-------------------------------------------------------------------------------

check_processes() {
    section "1. PROCESS ANALYSIS"

    echo -e "  ${WHITE}Checking for suspicious processes...${NC}"
    echo ""

    # Check for crypto miners
    local miners=$(ps aux 2>/dev/null | grep -iE '(miner|xmrig|xmr|monero|coinminer|kdevtmpfsi|kinsing)' | grep -v grep | wc -l | tr -d ' ')
    if [[ $miners -gt 0 ]]; then
        fail "Potential crypto miners detected!"
        ps aux | grep -iE '(miner|xmrig|xmr|monero|coinminer|kdevtmpfsi|kinsing)' | grep -v grep
    else
        ok "No crypto miners detected"
    fi

    # Check for suspicious process names (running from tmp directories)
    local suspicious=$(ps aux 2>/dev/null | awk '{print $11}' | grep -E '^\./|^/tmp/|^/var/tmp/|^/private/tmp/' | wc -l | tr -d ' ')
    if [[ $suspicious -gt 0 ]]; then
        warn "Processes running from suspicious locations (tmp):"
        ps aux | awk '$11 ~ /^\.\/|^\/tmp\/|^\/var\/tmp\/|^\/private\/tmp\//'
    else
        ok "No processes running from suspicious locations"
    fi

    # High CPU processes (macOS compatible - no --sort flag)
    echo ""
    echo -e "  ${WHITE}Top 5 CPU-consuming processes:${NC}"
    ps aux 2>/dev/null | sort -k3 -nr | head -5 | awk '{printf "    %-10s %5s%% CPU  %s\n", $1, $3, $11}'
}

#-------------------------------------------------------------------------------
# 2. Check network connections (macOS adapted - using netstat/lsof)
#-------------------------------------------------------------------------------

check_network() {
    section "2. NETWORK ANALYSIS"

    echo -e "  ${WHITE}Checking listening ports...${NC}"
    echo ""

    # Get listening ports using lsof (more reliable on macOS)
    local listeners=$(lsof -iTCP -sTCP:LISTEN -n -P 2>/dev/null | tail -n +2)

    if [[ -n "$listeners" ]]; then
        echo -e "  ${WHITE}Listening services:${NC}"
        echo "$listeners" | while read line; do
            local process=$(echo "$line" | awk '{print $1}')
            local pid=$(echo "$line" | awk '{print $2}')
            local bind=$(echo "$line" | awk '{print $9}')
            local port=$(echo "$bind" | rev | cut -d: -f1 | rev)

            if [[ "$bind" == "*:"* ]] || [[ "$bind" == "0.0.0.0:"* ]]; then
                if [[ "$port" == "22" ]]; then
                    warn "SSH (port 22) exposed to all interfaces"
                else
                    info "Port $port ($process) - exposed to network"
                fi
            else
                ok "Port $port ($process) - localhost only"
            fi
        done
    else
        ok "No listening services found"
    fi

    echo ""
    echo -e "  ${WHITE}Checking active connections...${NC}"

    # Check for established connections
    local established=$(netstat -an 2>/dev/null | grep ESTABLISHED | wc -l | tr -d ' ')
    echo -e "  ${INFO} Active connections: $established"
}

#-------------------------------------------------------------------------------
# 3. Check users and authentication (macOS adapted - using dscl)
#-------------------------------------------------------------------------------

check_users() {
    section "3. USER & AUTHENTICATION ANALYSIS"

    echo -e "  ${WHITE}Checking user accounts...${NC}"
    echo ""

    # Users with shell access (macOS uses dscl)
    echo -e "  ${WHITE}Users with shell access:${NC}"
    dscl . -list /Users UserShell 2>/dev/null | grep -E '(/bin/bash|/bin/sh|/bin/zsh)' | while read line; do
        local username=$(echo "$line" | awk '{print $1}')
        local shell=$(echo "$line" | awk '{print $2}')
        local uid=$(dscl . -read /Users/"$username" UniqueID 2>/dev/null | awk '{print $2}')
        echo -e "    ${INFO} $username (UID: $uid) - $shell"
    done

    echo ""

    # Check for multiple UID 0 users
    local root_users=$(dscl . -list /Users UniqueID 2>/dev/null | awk '$2 == 0 {print $1}')
    local root_count=$(echo "$root_users" | grep -v "^$" | wc -l | tr -d ' ')

    if [[ $root_count -gt 1 ]]; then
        fail "Multiple users with UID 0 (root privileges):"
        echo "$root_users" | while read user; do
            [[ -n "$user" ]] && echo -e "    ${CROSS} $user"
        done
    else
        ok "Only 'root' has UID 0"
    fi

    # Check admin group (macOS equivalent of sudo group)
    echo ""
    echo -e "  ${WHITE}Admin access:${NC}"
    local admin_users=$(dscl . -read /Groups/admin GroupMembership 2>/dev/null | sed 's/GroupMembership: //')
    if [[ -n "$admin_users" ]]; then
        echo -e "    ${INFO} Users in admin group: $admin_users"
    fi

    # Check for NOPASSWD in sudoers
    local nopasswd=$(grep -r "NOPASSWD" /etc/sudoers /private/etc/sudoers.d/ 2>/dev/null | grep -v "^#" || true)
    if [[ -n "$nopasswd" ]]; then
        warn "NOPASSWD entries found in sudoers (passwordless sudo):"
        echo "$nopasswd" | while read line; do
            echo -e "    ${WARN} $line"
        done
    else
        ok "No dangerous NOPASSWD entries"
    fi

    # Check SSH authorized_keys
    echo ""
    echo -e "  ${WHITE}SSH authorized keys:${NC}"
    local found_keys=0
    for home in /Users/* /var/root; do
        if [[ -f "$home/.ssh/authorized_keys" ]]; then
            local keycount=$(wc -l < "$home/.ssh/authorized_keys" 2>/dev/null | tr -d ' ' || echo 0)
            local username=$(basename "$home")
            if [[ $keycount -gt 0 ]]; then
                info "$username: $keycount authorized key(s)"
                found_keys=1
            fi
        fi
    done
    if [[ $found_keys -eq 0 ]]; then
        ok "No SSH authorized keys found"
    fi
}

#-------------------------------------------------------------------------------
# 4. Check for rootkits and malware indicators (macOS adapted)
#-------------------------------------------------------------------------------

check_malware() {
    section "4. MALWARE & ROOTKIT INDICATORS"

    echo -e "  ${WHITE}Checking for common indicators...${NC}"
    echo ""

    # Check for suspicious files in /tmp (macOS uses /private/tmp)
    local tmp_executables=$(find /tmp /private/tmp /var/tmp 2>/dev/null -type f -perm +111 2>/dev/null | grep -v node_modules | grep -v ".git" | head -20 || true)
    local tmp_exec_count=$(echo "$tmp_executables" | grep -v "^$" | wc -l | tr -d ' ')

    if [[ $tmp_exec_count -gt 0 ]]; then
        warn "Executable files in temp directories: $tmp_exec_count"
        echo -e "    ${INFO} (May include legitimate dev files - review if unsure)"
    else
        ok "No suspicious executables in temp directories"
    fi

    # Check for hidden files in common locations
    local hidden_suspicious=$(find /tmp /private/tmp /var/tmp -name ".*" -type f 2>/dev/null | grep -v ".gitignore" | grep -v ".env" | head -10 || true)
    if [[ -n "$hidden_suspicious" ]]; then
        warn "Hidden files in temp directories:"
        echo "$hidden_suspicious" | head -5 | while read f; do
            echo -e "    ${WARN} $f"
        done
    else
        ok "No suspicious hidden files in temp directories"
    fi

    # Check for suspicious LaunchAgents/LaunchDaemons (macOS specific)
    echo ""
    echo -e "  ${WHITE}Checking Launch Agents/Daemons...${NC}"

    local suspicious_launch=0
    for dir in /Library/LaunchAgents /Library/LaunchDaemons ~/Library/LaunchAgents; do
        if [[ -d "$dir" ]]; then
            local suspicious_plist=$(ls -la "$dir" 2>/dev/null | grep -vE '(com\.apple\.|com\.google\.|com\.microsoft\.)' | tail -n +2 | head -10)
            if [[ -n "$suspicious_plist" ]]; then
                info "Non-Apple items in $dir:"
                echo "$suspicious_plist" | head -5 | while read line; do
                    echo -e "    ${INFO} $(echo $line | awk '{print $NF}')"
                done
                suspicious_launch=1
            fi
        fi
    done

    if [[ $suspicious_launch -eq 0 ]]; then
        ok "No unusual Launch Agents/Daemons detected"
    fi

    # Check cron for suspicious entries
    echo ""
    echo -e "  ${WHITE}Checking scheduled tasks (cron)...${NC}"

    local suspicious_cron=0

    # User crontabs
    for user in $(dscl . -list /Users | grep -v "^_"); do
        local user_cron=$(crontab -u "$user" -l 2>/dev/null | grep -v "^#" | grep -v "^$" || true)
        if [[ -n "$user_cron" ]]; then
            if echo "$user_cron" | grep -qiE '(curl|wget|bash|sh|python).*http'; then
                warn "Suspicious cron entry for $user (downloads and executes):"
                echo "$user_cron" | grep -iE '(curl|wget|bash|sh|python).*http'
                suspicious_cron=1
            fi
        fi
    done

    if [[ $suspicious_cron -eq 0 ]]; then
        ok "No suspicious cron jobs detected"
    fi

    # Check SUID binaries (macOS has different standard binaries)
    echo ""
    echo -e "  ${WHITE}Checking SUID binaries...${NC}"

    local known_suid="/usr/bin/sudo /usr/bin/su /usr/bin/login /usr/bin/passwd /usr/bin/newgrp /usr/sbin/traceroute /usr/sbin/traceroute6 /usr/bin/at /usr/bin/atq /usr/bin/atrm /usr/bin/batch /usr/bin/crontab"

    local suid_files=$(find /usr -perm -4000 -type f 2>/dev/null || true)
    local unknown_suid=0

    while read suid; do
        [[ -z "$suid" ]] && continue
        if [[ ! " $known_suid " =~ " $suid " ]]; then
            warn "Unusual SUID binary: $suid"
            unknown_suid=1
        fi
    done <<< "$suid_files"

    if [[ $unknown_suid -eq 0 ]]; then
        ok "All SUID binaries are standard system files"
    fi

    # Check for XProtect status (macOS built-in malware protection)
    echo ""
    echo -e "  ${WHITE}Checking XProtect (macOS malware protection)...${NC}"
    local xprotect_version=$(defaults read /System/Library/CoreServices/XProtect.bundle/Contents/Info.plist CFBundleShortVersionString 2>/dev/null || echo "unknown")
    info "XProtect version: $xprotect_version"
}

#-------------------------------------------------------------------------------
# 5. Check system vulnerabilities (macOS adapted)
#-------------------------------------------------------------------------------

check_vulnerabilities() {
    section "5. VULNERABILITY ASSESSMENT"

    echo -e "  ${WHITE}Checking for common vulnerabilities...${NC}"
    echo ""

    # Check for pending macOS updates
    echo -e "  ${WHITE}System updates:${NC}"
    local updates=$(softwareupdate -l 2>&1)
    if echo "$updates" | grep -q "No new software available"; then
        ok "System is up to date"
        PENDING_UPDATES=0
    else
        local update_count=$(echo "$updates" | grep -c "\*" || echo 0)
        if [[ $update_count -gt 0 ]]; then
            warn "Pending system updates: $update_count"
            PENDING_UPDATES=$update_count
        else
            ok "System is up to date"
            PENDING_UPDATES=0
        fi
    fi

    # Check Homebrew updates if installed
    if command -v brew &> /dev/null; then
        echo ""
        echo -e "  ${WHITE}Homebrew packages:${NC}"
        local brew_outdated=$(brew outdated 2>/dev/null | wc -l | tr -d ' ')
        if [[ $brew_outdated -gt 10 ]]; then
            warn "Outdated Homebrew packages: $brew_outdated"
        elif [[ $brew_outdated -gt 0 ]]; then
            info "Outdated Homebrew packages: $brew_outdated"
        else
            ok "All Homebrew packages are up to date"
        fi
    fi

    # Firewall status (macOS Application Firewall)
    echo ""
    echo -e "  ${WHITE}Firewall status:${NC}"

    local fw_status=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate 2>/dev/null)
    if echo "$fw_status" | grep -q "enabled"; then
        ok "Application Firewall is enabled"
        FIREWALL_ACTIVE=1
    else
        warn "Application Firewall is disabled"
        FIREWALL_ACTIVE=0
    fi

    # Check stealth mode
    local stealth=$(/usr/libexec/ApplicationFirewall/socketfilterfw --getstealthmode 2>/dev/null)
    if echo "$stealth" | grep -q "enabled"; then
        ok "Stealth mode is enabled"
    else
        info "Stealth mode is disabled"
    fi

    # SIP (System Integrity Protection) status
    echo ""
    echo -e "  ${WHITE}System Integrity Protection:${NC}"
    local sip_status=$(csrutil status 2>/dev/null)
    if echo "$sip_status" | grep -q "enabled"; then
        ok "SIP is enabled"
    else
        fail "SIP is disabled - this is a security risk!"
    fi

    # Gatekeeper status
    echo ""
    echo -e "  ${WHITE}Gatekeeper status:${NC}"
    local gatekeeper=$(spctl --status 2>/dev/null)
    if echo "$gatekeeper" | grep -q "enabled"; then
        ok "Gatekeeper is enabled"
    else
        warn "Gatekeeper is disabled"
    fi

    # FileVault status
    echo ""
    echo -e "  ${WHITE}FileVault (disk encryption):${NC}"
    local filevault=$(fdesetup status 2>/dev/null)
    if echo "$filevault" | grep -q "On"; then
        ok "FileVault is enabled"
    else
        warn "FileVault is disabled - disk is not encrypted"
    fi

    # SSH configuration
    if [[ -f /etc/ssh/sshd_config ]]; then
        echo ""
        echo -e "  ${WHITE}SSH configuration:${NC}"

        local root_login=$(grep -i "^PermitRootLogin" /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}')
        if [[ "$root_login" == "yes" ]]; then
            warn "SSH allows root login"
        else
            ok "SSH root login is restricted"
        fi

        local pass_auth=$(grep -i "^PasswordAuthentication" /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}')
        if [[ "$pass_auth" == "yes" ]]; then
            info "SSH password authentication is enabled"
        fi
    fi
}

#-------------------------------------------------------------------------------
# 6. Check logs for suspicious activity (macOS adapted - unified logging)
#-------------------------------------------------------------------------------

check_logs() {
    section "6. LOG ANALYSIS"

    echo -e "  ${WHITE}Checking authentication logs...${NC}"
    echo ""

    # Failed login attempts (using macOS unified log)
    local failed_logins=$(log show --predicate 'eventMessage contains "failed" AND eventMessage contains "authentication"' --last 1d 2>/dev/null | wc -l | tr -d ' ')

    if [[ $failed_logins -gt 100 ]]; then
        warn "High number of failed login attempts (last 24h): $failed_logins"
    elif [[ $failed_logins -gt 0 ]]; then
        info "Failed login attempts (last 24h): $failed_logins"
    else
        ok "No failed login attempts in recent logs"
    fi

    # Check for sudo usage
    echo ""
    echo -e "  ${WHITE}Recent sudo usage:${NC}"
    log show --predicate 'process == "sudo"' --last 1h 2>/dev/null | head -5 | while read line; do
        echo -e "    ${INFO} $line"
    done

    # Recent logins
    echo ""
    echo -e "  ${WHITE}Recent logins:${NC}"
    last -5 2>/dev/null | head -5 | while read line; do
        [[ -n "$line" ]] && echo -e "    ${INFO} $line"
    done
}

#-------------------------------------------------------------------------------
# Generate Report Summary
#-------------------------------------------------------------------------------

show_summary() {
    section "SCAN COMPLETE - SUMMARY"

    echo ""
    if [[ $ISSUES_FOUND -eq 0 ]] && [[ $WARNINGS_FOUND -eq 0 ]]; then
        echo -e "  ${GREEN}╔══════════════════════════════════════════════╗${NC}"
        echo -e "  ${GREEN}║          SYSTEM APPEARS CLEAN                ║${NC}"
        echo -e "  ${GREEN}╚══════════════════════════════════════════════╝${NC}"
    elif [[ $ISSUES_FOUND -eq 0 ]]; then
        echo -e "  ${YELLOW}╔══════════════════════════════════════════════╗${NC}"
        echo -e "  ${YELLOW}║     CLEAN - BUT SOME WARNINGS FOUND          ║${NC}"
        echo -e "  ${YELLOW}╚══════════════════════════════════════════════╝${NC}"
    else
        echo -e "  ${RED}╔══════════════════════════════════════════════╗${NC}"
        echo -e "  ${RED}║         ISSUES DETECTED - REVIEW BELOW       ║${NC}"
        echo -e "  ${RED}╚══════════════════════════════════════════════╝${NC}"
    fi

    echo ""
    echo -e "  ${WHITE}Results:${NC}"
    echo -e "    ${CROSS} Critical issues: ${RED}$ISSUES_FOUND${NC}"
    echo -e "    ${WARN} Warnings:        ${YELLOW}$WARNINGS_FOUND${NC}"
    echo ""
}

#-------------------------------------------------------------------------------
# Hardening Functions (macOS adapted)
#-------------------------------------------------------------------------------

do_updates() {
    section "APPLYING SYSTEM UPDATES"
    echo -e "  ${INFO} Running softwareupdate..."
    softwareupdate -ia --verbose
    ok "System updates applied"

    if command -v brew &> /dev/null; then
        echo ""
        echo -e "  ${INFO} Updating Homebrew packages..."
        brew update && brew upgrade
        ok "Homebrew packages updated"
    fi
}

do_firewall() {
    section "ENABLING FIREWALL"

    echo -e "  ${INFO} Enabling Application Firewall..."
    /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on

    echo -e "  ${INFO} Enabling stealth mode..."
    /usr/libexec/ApplicationFirewall/socketfilterfw --setstealthmode on

    ok "Firewall enabled and configured"
}

do_security_scan() {
    section "RUNNING SECURITY CHECKS"

    # Check for Malwarebytes if installed
    if [[ -d "/Applications/Malwarebytes.app" ]]; then
        echo -e "  ${INFO} Malwarebytes detected - please run a scan manually"
    fi

    # List potentially unwanted apps
    echo ""
    echo -e "  ${INFO} Checking for potentially unwanted applications..."

    # Check for known adware locations
    local adware_paths=(
        "/Library/Application Support/VSearch"
        "/Library/Application Support/Conduit"
        "/Library/Application Support/Genieo"
        "$HOME/Library/Application Support/Genieo"
    )

    local found_adware=0
    for path in "${adware_paths[@]}"; do
        if [[ -d "$path" ]]; then
            warn "Potential adware found: $path"
            found_adware=1
        fi
    done

    if [[ $found_adware -eq 0 ]]; then
        ok "No common adware detected"
    fi

    # Suggest installing clamav via brew
    if ! command -v clamscan &> /dev/null; then
        echo ""
        info "Consider installing ClamAV for malware scanning:"
        echo "    brew install clamav"
    else
        echo ""
        echo -e "  ${INFO} Running ClamAV scan on /tmp..."
        clamscan -r /tmp 2>/dev/null | tail -5
    fi

    ok "Security check complete"
}

do_enable_filevault() {
    section "ENABLING FILEVAULT"

    local fv_status=$(fdesetup status 2>/dev/null)
    if echo "$fv_status" | grep -q "On"; then
        ok "FileVault is already enabled"
    else
        echo -e "  ${INFO} Enabling FileVault..."
        echo -e "  ${WARN} This will require a restart and you'll need to save your recovery key"
        if ask_yes_no "Proceed with FileVault encryption?"; then
            fdesetup enable
            ok "FileVault enabled - please restart your Mac"
        else
            info "FileVault setup skipped"
        fi
    fi
}

#-------------------------------------------------------------------------------
# Hardening Menu (macOS adapted)
#-------------------------------------------------------------------------------

offer_hardening() {
    section "SYSTEM HARDENING"

    echo -e "  ${WHITE}Based on the scan, the following hardening steps are recommended:${NC}"
    echo ""

    local has_recommendations=0

    if [[ ${PENDING_UPDATES:-0} -gt 0 ]]; then
        echo -e "  ${YELLOW}1.${NC} Apply pending system updates"
        has_recommendations=1
    fi

    if [[ ${FIREWALL_ACTIVE:-1} -eq 0 ]]; then
        echo -e "  ${YELLOW}2.${NC} Enable Application Firewall"
        has_recommendations=1
    fi

    echo -e "  ${YELLOW}3.${NC} Run security scan"
    echo -e "  ${YELLOW}4.${NC} Enable FileVault disk encryption (if not enabled)"

    if [[ $has_recommendations -eq 0 ]]; then
        echo ""
        echo -e "  ${GREEN}Your system is already well-configured!${NC}"
    fi

    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    if ask_yes_no "Apply recommended hardening steps?"; then
        echo ""

        if [[ ${PENDING_UPDATES:-0} -gt 0 ]]; then
            do_updates
        fi

        if [[ ${FIREWALL_ACTIVE:-1} -eq 0 ]]; then
            do_firewall
        fi

        do_security_scan
        do_enable_filevault

        echo ""
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${GREEN}  HARDENING COMPLETE - Your system is now more secure!${NC}"
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    else
        echo ""
        echo -e "  ${INFO} Skipping hardening. You can run these commands manually:"
        echo ""
        echo -e "    ${CYAN}# Apply system updates${NC}"
        echo "    sudo softwareupdate -ia"
        echo ""
        echo -e "    ${CYAN}# Enable firewall${NC}"
        echo "    sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on"
        echo ""
        echo -e "    ${CYAN}# Enable FileVault${NC}"
        echo "    sudo fdesetup enable"
        echo ""
        echo -e "    ${CYAN}# Install malware scanner${NC}"
        echo "    brew install clamav"
        echo ""
    fi
}

#-------------------------------------------------------------------------------
# Main
#-------------------------------------------------------------------------------

main() {
    check_root
    banner

    echo -e "  ${INFO} Starting security scan... This may take a few minutes."
    echo ""

    show_system_info
    check_processes
    check_network
    check_users
    check_malware
    check_vulnerabilities
    check_logs
    show_summary
    offer_hardening

    echo ""
    echo -e "  ${INFO} Scan results saved to: /var/log/intruder-hunter.log"
    echo ""
}

# Run main and log output
main 2>&1 | tee /var/log/intruder-hunter.log
