// Upgrade Prompt - Freemium conversion modal
import { LitElement, html, css } from 'lit'
import { customElement, property, state } from 'lit/decorators.js'
import type { PricingPlan } from '@/types/plugin'
import { backendClient } from '@/utils/api/backend-client'
import { logger } from '@/utils/logger'

@customElement('upgrade-prompt')
export class UpgradePrompt extends LitElement {
  static styles = css`
    :host {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
    }

    .modal {
      background: var(--bg-layer-1);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      max-width: 400px;
      width: 90%;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .modal-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-xs);
    }

    .modal-subtitle {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .plans {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }

    .plan-card {
      background: var(--bg-layer-2);
      border: 2px solid var(--border-default);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .plan-card:hover {
      border-color: var(--color-primary);
    }

    .plan-card.recommended {
      border-color: var(--color-accent);
      background: rgba(15, 191, 132, 0.05);
    }

    .plan-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
    }

    .plan-name {
      font-weight: var(--font-weight-bold);
    }

    .plan-badge {
      font-size: var(--font-size-xs);
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      background: var(--color-accent);
      color: white;
    }

    .plan-price {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-sm);
    }

    .plan-price span {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-normal);
      color: var(--text-secondary);
    }

    .plan-features {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .plan-features li {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      padding: var(--space-xs) 0;
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .plan-features li::before {
      content: '✓';
      color: var(--color-accent);
    }

    .modal-actions {
      display: flex;
      gap: var(--space-sm);
    }

    .modal-actions sp-button {
      flex: 1;
    }

    .close-button {
      position: absolute;
      top: var(--space-sm);
      right: var(--space-sm);
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 20px;
      padding: var(--space-xs);
    }

    .close-button:hover {
      color: var(--text-primary);
    }
  `

  @property({ type: String }) currentPlan: PricingPlan = 'free'

  @state() private isLoading = false
  @state() private errorMessage = ''

  private plans: Array<{
    id: 'creator' | 'pro'
    name: string
    price: number
    period: string
    recommended: boolean
    features: string[]
  }> = [
    {
      id: 'creator',
      name: 'Creator',
      price: 29.99,
      period: 'month',
      recommended: true,
      features: [
        '300 min/month AI processing',
        'Batch processing',
        'Advanced selection tools',
        'Priority support',
      ],
    },
    {
      id: 'pro',
      name: 'Pro',
      price: 69.99,
      period: 'month',
      recommended: false,
      features: [
        '500 min/month AI processing',
        'Cloud sync & backup',
        'Team collaboration',
        'Custom AI models',
        'Dedicated support',
      ],
    },
  ]

  private handleClose(): void {
    this.dispatchEvent(new CustomEvent('close', { bubbles: true, composed: true }))
  }

  private async handleUpgrade(plan: 'creator' | 'pro'): Promise<void> {
    if (this.isLoading) return

    this.isLoading = true
    this.errorMessage = ''

    try {
      const session = await backendClient.createCheckout(plan, 'monthly')
      window.open(session.url, '_blank')
      logger.info('Opened Stripe checkout session', { plan, sessionId: session.sessionId })
      this.handleClose()
    } catch (error) {
      logger.error('Failed to create checkout session', error)
      this.errorMessage = 'Failed to open checkout. Please try again.'
    } finally {
      this.isLoading = false
    }
  }

  render() {
    return html`
      <div class="modal">
        <button class="close-button" @click=${this.handleClose}>×</button>

        <div class="modal-header">
          <div class="modal-title">Upgrade Your Plan</div>
          <div class="modal-subtitle">Unlock the full power of Splice v3</div>
        </div>

        <div class="plans">
          ${this.plans.map(
            (plan) => html`
              <div
                class="plan-card ${plan.recommended ? 'recommended' : ''}"
                @click=${() => this.handleUpgrade(plan.id)}
              >
                <div class="plan-header">
                  <span class="plan-name">${plan.name}</span>
                  ${plan.recommended ? html`<span class="plan-badge">Most Popular</span>` : ''}
                </div>
                <div class="plan-price">$${plan.price} <span>/ ${plan.period}</span></div>
                <ul class="plan-features">
                  ${plan.features.map((feature) => html`<li>${feature}</li>`)}
                </ul>
              </div>
            `
          )}
        </div>

        ${this.errorMessage
          ? html`<div
              style="color: var(--color-negative); text-align: center; margin-bottom: var(--space-md); font-size: var(--font-size-sm);"
            >
              ${this.errorMessage}
            </div>`
          : ''}

        <div class="modal-actions">
          <sp-button variant="secondary" @click=${this.handleClose} ?disabled=${this.isLoading}>
            Maybe Later
          </sp-button>
          <sp-button
            variant="accent"
            @click=${() => this.handleUpgrade('creator')}
            ?disabled=${this.isLoading}
          >
            ${this.isLoading ? 'Loading...' : 'Get Creator'}
          </sp-button>
        </div>
      </div>
    `
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'upgrade-prompt': UpgradePrompt
  }
}
