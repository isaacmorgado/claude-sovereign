/* global fetch */
/**
 * Comprehensive Stutter Detection Tests
 *
 * Tests parity with Firecut's stutter detection behavior:
 * - Single-character word stutters ("I I I think")
 * - Short word stutters ("the the the")
 * - Gap-based detection (maxGapMs)
 * - Filler word handling
 * - Edge cases
 */

// Allow self-signed certificates for local HTTPS testing
process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';

const BASE_URL = 'https://127.0.0.1:3847';

// Helper to make API calls
async function testStutters(transcript, options = {}) {
  const response = await fetch(`${BASE_URL}/stutters`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ transcript, options })
  });
  return response.json();
}

// Helper to create word objects with timing
function makeWords(wordList, startTime = 0, wordDuration = 0.1, gapDuration = 0.05) {
  const words = [];
  let currentTime = startTime;

  for (const word of wordList) {
    words.push({
      word: word,
      start: currentTime,
      end: currentTime + wordDuration
    });
    currentTime += wordDuration + gapDuration;
  }

  return words;
}

// Test results tracking
const results = {
  passed: 0,
  failed: 0,
  tests: []
};

function assert(condition, testName, expected, actual) {
  if (condition) {
    results.passed++;
    results.tests.push({ name: testName, status: 'PASS' });
    console.log(`✓ ${testName}`);
  } else {
    results.failed++;
    results.tests.push({ name: testName, status: 'FAIL', expected, actual });
    console.log(`✗ ${testName}`);
    console.log(`  Expected: ${JSON.stringify(expected)}`);
    console.log(`  Actual: ${JSON.stringify(actual)}`);
  }
}

async function runTests() {
  console.log('='.repeat(60));
  console.log('STUTTER DETECTION TEST SUITE');
  console.log('Testing parity with Firecut behavior');
  console.log('='.repeat(60));
  console.log('');

  // ========================================
  // TEST 1: Single-character word stutters
  // ========================================
  console.log('--- Test Category: Single-Character Words ---');

  // Test 1.1: "I I I think" - should detect "I" repeated 3 times
  {
    const words = makeWords(['I', 'I', 'I', 'think']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1 && result.stutters[0].word === 'i' && result.stutters[0].occurrences === 3,
      'T1.1: Detect "I I I think" as stutter',
      { count: 1, word: 'i', occurrences: 3 },
      { count: result.stutters?.length, word: result.stutters?.[0]?.word, occurrences: result.stutters?.[0]?.occurrences }
    );
  }

  // Test 1.2: "I I think" - should detect with minRepeats=2
  {
    const words = makeWords(['I', 'I', 'think']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1 && result.stutters[0].occurrences === 2,
      'T1.2: Detect "I I think" as stutter (minRepeats=2)',
      { count: 1, occurrences: 2 },
      { count: result.stutters?.length, occurrences: result.stutters?.[0]?.occurrences }
    );
  }

  // Test 1.3: Single "I" - should NOT detect (only 1 occurrence)
  {
    const words = makeWords(['I', 'think']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 0,
      'T1.3: Single "I" should not be detected as stutter',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  // Test 1.4: "a a a cat" - another single char
  {
    const words = makeWords(['a', 'a', 'a', 'cat']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1 && result.stutters[0].word === 'a' && result.stutters[0].occurrences === 3,
      'T1.4: Detect "a a a cat" as stutter',
      { count: 1, word: 'a', occurrences: 3 },
      { count: result.stutters?.length, word: result.stutters?.[0]?.word, occurrences: result.stutters?.[0]?.occurrences }
    );
  }

  console.log('');

  // ========================================
  // TEST 2: Short word stutters
  // ========================================
  console.log('--- Test Category: Short Words ---');

  // Test 2.1: "the the the cat"
  {
    const words = makeWords(['the', 'the', 'the', 'cat']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1 && result.stutters[0].word === 'the' && result.stutters[0].occurrences === 3,
      'T2.1: Detect "the the the cat" as stutter',
      { count: 1, word: 'the', occurrences: 3 },
      { count: result.stutters?.length, word: result.stutters?.[0]?.word, occurrences: result.stutters?.[0]?.occurrences }
    );
  }

  // Test 2.2: "and and and"
  {
    const words = makeWords(['and', 'and', 'and']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1 && result.stutters[0].word === 'and',
      'T2.2: Detect "and and and" as stutter',
      { count: 1, word: 'and' },
      { count: result.stutters?.length, word: result.stutters?.[0]?.word }
    );
  }

  console.log('');

  // ========================================
  // TEST 3: Medium/Long word stutters
  // ========================================
  console.log('--- Test Category: Medium/Long Words ---');

  // Test 3.1: "because because I"
  {
    const words = makeWords(['because', 'because', 'I']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1 && result.stutters[0].word === 'because',
      'T3.1: Detect "because because I" as stutter',
      { count: 1, word: 'because' },
      { count: result.stutters?.length, word: result.stutters?.[0]?.word }
    );
  }

  // Test 3.2: "unfortunately unfortunately unfortunately"
  {
    const words = makeWords(['unfortunately', 'unfortunately', 'unfortunately']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1 && result.stutters[0].word === 'unfortunately' && result.stutters[0].occurrences === 3,
      'T3.2: Detect long word stutter',
      { count: 1, word: 'unfortunately', occurrences: 3 },
      { count: result.stutters?.length, word: result.stutters?.[0]?.word, occurrences: result.stutters?.[0]?.occurrences }
    );
  }

  console.log('');

  // ========================================
  // TEST 4: Gap handling (maxGapMs)
  // ========================================
  console.log('--- Test Category: Gap Handling ---');

  // Test 4.1: Words with gap < 500ms should be detected
  {
    const words = [
      { word: 'I', start: 0.0, end: 0.1 },
      { word: 'I', start: 0.3, end: 0.4 },  // 200ms gap
      { word: 'think', start: 0.5, end: 0.7 }
    ];
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1,
      'T4.1: Detect stutters with gap < 500ms',
      { count: 1 },
      { count: result.stutters?.length }
    );
  }

  // Test 4.2: Words with gap > 500ms should NOT be detected
  {
    const words = [
      { word: 'I', start: 0.0, end: 0.1 },
      { word: 'I', start: 0.7, end: 0.8 },  // 600ms gap - too long
      { word: 'think', start: 1.0, end: 1.2 }
    ];
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 0,
      'T4.2: Gap > 500ms breaks stutter chain',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  // Test 4.3: Custom maxGapMs option
  {
    const words = [
      { word: 'I', start: 0.0, end: 0.1 },
      { word: 'I', start: 0.7, end: 0.8 },  // 600ms gap
      { word: 'think', start: 1.0, end: 1.2 }
    ];
    const result = await testStutters({ words }, { maxGapMs: 700 });
    assert(
      result.stutters?.length === 1,
      'T4.3: Custom maxGapMs=700 detects 600ms gap',
      { count: 1 },
      { count: result.stutters?.length }
    );
  }

  console.log('');

  // ========================================
  // TEST 5: Filler word handling
  // ========================================
  console.log('--- Test Category: Filler Words ---');

  // Test 5.1: "um um um" with ignoreFillers=true (default) - should NOT detect
  {
    const words = makeWords(['um', 'um', 'um']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 0,
      'T5.1: Filler "um um um" ignored by default',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  // Test 5.2: "uh uh uh" ignored
  {
    const words = makeWords(['uh', 'uh', 'uh']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 0,
      'T5.2: Filler "uh uh uh" ignored by default',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  // Test 5.3: "um um um" with ignoreFillers=false - SHOULD detect
  {
    const words = makeWords(['um', 'um', 'um']);
    const result = await testStutters({ words }, { ignoreFillers: false });
    assert(
      result.stutters?.length === 1,
      'T5.3: Filler "um um um" detected with ignoreFillers=false',
      { count: 1 },
      { count: result.stutters?.length }
    );
  }

  // Test 5.4: "like like like" (filler word)
  {
    const words = makeWords(['like', 'like', 'like']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 0,
      'T5.4: Filler "like like like" ignored by default',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  console.log('');

  // ========================================
  // TEST 6: Case insensitivity
  // ========================================
  console.log('--- Test Category: Case Insensitivity ---');

  // Test 6.1: Mixed case "I i I"
  {
    const words = makeWords(['I', 'i', 'I', 'think']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1 && result.stutters[0].occurrences === 3,
      'T6.1: Mixed case "I i I" detected as stutter',
      { count: 1, occurrences: 3 },
      { count: result.stutters?.length, occurrences: result.stutters?.[0]?.occurrences }
    );
  }

  // Test 6.2: "The THE the"
  {
    const words = makeWords(['The', 'THE', 'the']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1,
      'T6.2: Mixed case "The THE the" detected',
      { count: 1 },
      { count: result.stutters?.length }
    );
  }

  console.log('');

  // ========================================
  // TEST 7: Multiple stutters in one transcript
  // ========================================
  console.log('--- Test Category: Multiple Stutters ---');

  // Test 7.1: Two separate stutters
  {
    const words = [
      { word: 'I', start: 0.0, end: 0.1 },
      { word: 'I', start: 0.15, end: 0.25 },
      { word: 'think', start: 0.3, end: 0.5 },
      { word: 'the', start: 0.6, end: 0.7 },
      { word: 'the', start: 0.75, end: 0.85 },
      { word: 'the', start: 0.9, end: 1.0 },
      { word: 'cat', start: 1.1, end: 1.3 }
    ];
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 2,
      'T7.1: Two separate stutters detected',
      { count: 2 },
      { count: result.stutters?.length }
    );
  }

  // Test 7.2: Three stutters in longer transcript
  {
    const words = [
      { word: 'I', start: 0.0, end: 0.1 },
      { word: 'I', start: 0.15, end: 0.25 },
      { word: 'I', start: 0.3, end: 0.4 },
      { word: 'want', start: 0.5, end: 0.7 },
      { word: 'to', start: 0.8, end: 0.9 },
      { word: 'to', start: 0.95, end: 1.05 },
      { word: 'say', start: 1.1, end: 1.3 },
      { word: 'that', start: 1.4, end: 1.5 },
      { word: 'that', start: 1.55, end: 1.65 },
      { word: 'that', start: 1.7, end: 1.8 },
      { word: 'thing', start: 1.9, end: 2.1 }
    ];
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 3,
      'T7.2: Three stutters in transcript',
      { count: 3 },
      { count: result.stutters?.length }
    );
  }

  console.log('');

  // ========================================
  // TEST 8: Removal timing accuracy
  // ========================================
  console.log('--- Test Category: Removal Timing ---');

  // Test 8.1: Keep first, remove rest
  {
    const words = [
      { word: 'I', start: 0.0, end: 0.1 },
      { word: 'I', start: 0.15, end: 0.25 },
      { word: 'I', start: 0.3, end: 0.4 },
      { word: 'think', start: 0.5, end: 0.8 }
    ];
    const result = await testStutters({ words });
    const stutter = result.stutters?.[0];
    assert(
      stutter?.keepStart === 0.0 && stutter?.keepEnd === 0.1 &&
      stutter?.removeStart === 0.15 && stutter?.removeEnd === 0.4,
      'T8.1: Correct keep/remove timing',
      { keepStart: 0.0, keepEnd: 0.1, removeStart: 0.15, removeEnd: 0.4 },
      { keepStart: stutter?.keepStart, keepEnd: stutter?.keepEnd, removeStart: stutter?.removeStart, removeEnd: stutter?.removeEnd }
    );
  }

  console.log('');

  // ========================================
  // TEST 9: Edge cases
  // ========================================
  console.log('--- Test Category: Edge Cases ---');

  // Test 9.1: Empty transcript
  {
    const result = await testStutters({ words: [] });
    assert(
      result.stutters?.length === 0,
      'T9.1: Empty transcript returns no stutters',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  // Test 9.2: Single word transcript
  {
    const result = await testStutters({ words: [{ word: 'hello', start: 0, end: 0.5 }] });
    assert(
      result.stutters?.length === 0,
      'T9.2: Single word returns no stutters',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  // Test 9.3: All same word (extreme stutter)
  {
    const words = makeWords(['I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1 && result.stutters[0].occurrences === 10,
      'T9.3: 10 repeated "I" detected as single stutter',
      { count: 1, occurrences: 10 },
      { count: result.stutters?.length, occurrences: result.stutters?.[0]?.occurrences }
    );
  }

  // Test 9.4: Punctuation in words
  {
    const words = makeWords(["I'm", "I'm", "I'm", 'sure']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 1,
      'T9.4: Words with punctuation detected',
      { count: 1 },
      { count: result.stutters?.length }
    );
  }

  // Test 9.5: minRepeats=3 option
  {
    const words = makeWords(['I', 'I', 'think']);  // Only 2 repeats
    const result = await testStutters({ words }, { minRepeats: 3 });
    assert(
      result.stutters?.length === 0,
      'T9.5: minRepeats=3 ignores 2-repeat stutters',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  // Test 9.6: minWordLength=2 reverts old behavior
  {
    const words = makeWords(['I', 'I', 'I', 'think']);
    const result = await testStutters({ words }, { minWordLength: 2 });
    assert(
      result.stutters?.length === 0,
      'T9.6: minWordLength=2 skips single-char words',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  console.log('');

  // ========================================
  // TEST 10: Real-world examples
  // ========================================
  console.log('--- Test Category: Real-World Examples ---');

  // Test 10.1: Natural speech pattern
  {
    const words = [
      { word: 'So', start: 0.0, end: 0.15 },
      { word: 'I', start: 0.2, end: 0.25 },
      { word: 'I', start: 0.3, end: 0.35 },
      { word: 'I', start: 0.4, end: 0.45 },
      { word: 'was', start: 0.5, end: 0.65 },
      { word: 'thinking', start: 0.7, end: 1.0 },
      { word: 'about', start: 1.1, end: 1.3 },
      { word: 'the', start: 1.4, end: 1.5 },
      { word: 'the', start: 1.55, end: 1.65 },
      { word: 'problem', start: 1.7, end: 2.0 }
    ];
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 2,  // "I I I" and "the the"
      'T10.1: Natural speech with multiple stutters',
      { count: 2 },
      { count: result.stutters?.length }
    );
  }

  // Test 10.2: "So" is a filler but should be detected if repeated
  {
    const words = makeWords(['so', 'so', 'so', 'anyway']);
    const result = await testStutters({ words });
    assert(
      result.stutters?.length === 0,  // "so" is in filler list
      'T10.2: "so so so" treated as filler (ignored)',
      { count: 0 },
      { count: result.stutters?.length }
    );
  }

  console.log('');

  // ========================================
  // SUMMARY
  // ========================================
  console.log('='.repeat(60));
  console.log('TEST SUMMARY');
  console.log('='.repeat(60));
  console.log(`Total Tests: ${results.passed + results.failed}`);
  console.log(`Passed: ${results.passed}`);
  console.log(`Failed: ${results.failed}`);
  console.log(`Success Rate: ${((results.passed / (results.passed + results.failed)) * 100).toFixed(1)}%`);
  console.log('');

  if (results.failed > 0) {
    console.log('FAILED TESTS:');
    results.tests.filter(t => t.status === 'FAIL').forEach(t => {
      console.log(`  - ${t.name}`);
    });
  }

  return results;
}

// Run tests
runTests().then(r => {
  process.exit(r.failed > 0 ? 1 : 0);
}).catch(err => {
  console.error('Test suite error:', err);
  process.exit(1);
});
