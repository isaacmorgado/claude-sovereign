# SPLICE Phase 2 Continuation Prompt

## Context
Phase 1 (Critical Concurrency Fixes) is complete with all 14 tests passing:
- ✓ 1.1 Atomic credit reservation with SELECT...FOR UPDATE
- ✓ 1.2 License key delivery with retry mechanism
- ✓ 1.3 License activation row locking

## Your Task
Execute Phase 2: API Auth Fixes. Follow the process: **Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature**

---

## Feature 2.1: Batch Endpoints Auth

**Files to modify:**
- `splice-backend/server.js` (batch endpoint routes around line 1770-1875)

**Problem:** Batch job endpoints have no ownership verification. Any user can view/delete any job.

**Implementation Steps:**
1. GET `/batch/status/:id` - Add customer ID check against `job.stripeCustomerId`
2. GET `/batch/results/:id` - Add customer ID check
3. GET `/batch/jobs` - Filter results by `x-stripe-customer-id` header
4. DELETE `/batch/:jobId` - Verify ownership before deletion
5. Return 404 (not 403) for non-owned jobs to prevent enumeration

**E2E Tests Required:**
- Create batch job as customer A
- Try to access job as customer B → should return 404
- Try to delete job as customer B → should return 404
- Access job as customer A → should succeed
- GET `/batch/jobs` as customer A → should only show A's jobs
- GET `/batch/jobs` as customer B → should be empty or only B's jobs
- Test without `x-stripe-customer-id` header → should return 401

---

## Feature 2.2: Cut List Endpoints Auth

**Files to modify:**
- `splice-backend/server.js` (cut-list routes around line 1327-1427)

**Problem:** `/cut-list` and `/cut-list/takes` have no authentication or usage tracking.

**Implementation Steps:**
1. Add `requireCredits({ endpoint: 'cut-list' })` middleware to POST `/cut-list`
2. Add `requireCredits({ endpoint: 'cut-list-takes' })` middleware to POST `/cut-list/takes`
3. Add usage deduction based on segments generated (or flat rate)
4. Ensure proper error responses for missing auth

**E2E Tests Required:**
- POST `/cut-list` without auth → should return 401/402
- POST `/cut-list` with valid auth → should succeed
- Verify usage deducted after successful generation
- POST `/cut-list/takes` without auth → should return 401/402
- POST `/cut-list/takes` with valid auth → should succeed
- Test with 0 credits remaining → should return 402
- Verify cut list JSON format unchanged

---

## Phase 2 Complete Checklist
- [ ] 2.1 Batch endpoints require ownership verification
- [ ] 2.2 Cut list endpoints require authentication
- [ ] All endpoints return 401/402/404 appropriately
- [ ] No data leakage between customers
- [ ] All E2E tests passing
- [ ] Ready for Phase 3

---

## Deliverables
1. Modify `server.js` to add auth checks to batch and cut-list endpoints
2. Create `splice-backend/tests/phase2-auth.test.js` with comprehensive E2E tests
3. Run tests and fix any bugs until all pass
4. Update `CLAUDE.md` to reflect Phase 2 completion
5. Update `phases.md` checklist to mark Phase 2 complete

## Important Notes
- Use 404 (not 403) for non-owned jobs to prevent enumeration attacks
- The `requireCredits` middleware from Phase 1 already handles atomic reservation
- Batch jobs store `stripeCustomerId` in `job.stripeCustomerId` - use this for ownership checks
- Test both positive and negative cases (authorized vs unauthorized access)

Begin implementation now. Start with Feature 2.1.
