Phase 1 Prompt

  # SPLICE Phase 1: Critical Concurrency Fixes

  ## Process
  For each feature: Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature

  ---

  ## Feature 1.1: Atomic Credit Reservation

  **Files:**
  - `splice-backend/middleware/rateLimiter.js:32-50`
  - `splice-backend/services/usageTracking.js:321-358`

  **Problem:** Race condition allows concurrent requests to pass credit check before any deduction occurs, enabling unlimited free processing.

  **Implementation:**
  1. Add `reserveCredits()` function using `SELECT ... FOR UPDATE` with transaction
  2. Reserve credits BEFORE processing begins
  3. Add `confirmReservation()` to finalize or `releaseReservation()` on failure
  4. Wrap all credit operations in atomic transactions

  **E2E Test After Implementation:**
  - Send 10 concurrent requests with 0.5hr credits remaining
  - Verify only requests that fit within balance succeed
  - Verify no negative balances or over-usage
  - Verify failed requests return 402 properly
  - Check database for correct final balance
  - Test rollback on processing failure

  **Fix any bugs found, re-test until passing, then proceed to 1.2**

  ---

  ## Feature 1.2: License Key Delivery

  **Files:**
  - `splice-backend/server.js:185-192`
  - `splice-backend/services/licenseService.js:124-177`

  **Problem:** License key generated on purchase but never delivered to user. Users can't activate.

  **Implementation:**
  1. After `generateLicenseKey()` succeeds, send email via Stripe customer email
  2. Use Stripe API to get customer email from subscription
  3. Add retry mechanism (3 attempts) for failed key generation
  4. Store license key in Stripe subscription metadata as backup
  5. Add `/license/resend` endpoint for support cases

  **E2E Test After Implementation:**
  - Simulate Stripe webhook `customer.subscription.created`
  - Verify license key generated in database
  - Verify email sent (check logs or mock)
  - Verify Stripe metadata updated with key
  - Test retry on initial generation failure
  - Test `/license/resend` endpoint

  **Fix any bugs found, re-test until passing, then proceed to 1.3**

  ---

  ## Feature 1.3: License Activation Row Locking

  **Files:**
  - `splice-backend/services/licenseService.js:185-229`

  **Problem:** Race condition allows same license key to be activated on multiple devices simultaneously.

  **Implementation:**
  1. Add `BEGIN` transaction in `activateLicenseKey()`
  2. Use `SELECT * FROM license_keys WHERE key = $1 FOR UPDATE`
  3. Check `activated_at` within transaction
  4. `COMMIT` after successful activation
  5. `ROLLBACK` on any error

  **E2E Test After Implementation:**
  - Send 5 concurrent activation requests for same key
  - Verify only 1 succeeds, others get "already activated" error
  - Verify database shows single `activated_at` timestamp
  - Verify all requests return correct `customerId`
  - Test with invalid key format
  - Test with non-existent key

  **Fix any bugs found, re-test until passing**

  ---

  ## Phase 1 Complete Checklist
  - [x] 1.1 Atomic credit reservation working
  - [x] 1.2 License key delivery working
  - [x] 1.3 License activation row locking working
  - [x] All E2E tests passing (14/14)
  - [x] No race conditions in concurrent tests
  - [x] Ready for Phase 2

  ---
  Phase 2 Prompt

  # SPLICE Phase 2: API Auth Fixes

  ## Process
  For each feature: Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature

  ---

  ## Feature 2.1: Batch Endpoints Auth

  **Files:**
  - `splice-backend/server.js:1770-1875`

  **Problem:** Batch job endpoints have no ownership verification. Any user can view/delete any job.

  **Implementation:**
  1. GET `/batch/status/:id` - Add customer ID check against `job.stripeCustomerId`
  2. GET `/batch/results/:id` - Add customer ID check
  3. GET `/batch/jobs` - Filter results by `x-stripe-customer-id` header
  4. DELETE `/batch/:jobId` - Verify ownership before deletion
  5. Return 404 (not 403) for non-owned jobs to prevent enumeration

  **E2E Test After Implementation:**
  - Create batch job as customer A
  - Try to access job as customer B → should return 404
  - Try to delete job as customer B → should return 404
  - Access job as customer A → should succeed
  - GET `/batch/jobs` as customer A → should only show A's jobs
  - GET `/batch/jobs` as customer B → should be empty or only B's jobs
  - Test without `x-stripe-customer-id` header → should return 401

  **Fix any bugs found, re-test until passing, then proceed to 2.2**

  ---

  ## Feature 2.2: Cut List Endpoints Auth

  **Files:**
  - `splice-backend/server.js:1327-1427`

  **Problem:** `/cut-list` and `/cut-list/takes` have no authentication or usage tracking.

  **Implementation:**
  1. Add `requireCredits({ endpoint: 'cut-list' })` middleware to POST `/cut-list`
  2. Add `requireCredits({ endpoint: 'cut-list-takes' })` middleware to POST `/cut-list/takes`
  3. Add usage deduction based on segments generated (or flat rate)
  4. Ensure proper error responses for missing auth

  **E2E Test After Implementation:**
  - POST `/cut-list` without auth → should return 401/402
  - POST `/cut-list` with valid auth → should succeed
  - Verify usage deducted after successful generation
  - POST `/cut-list/takes` without auth → should return 401/402
  - POST `/cut-list/takes` with valid auth → should succeed
  - Test with 0 credits remaining → should return 402
  - Verify cut list JSON format unchanged

  **Fix any bugs found, re-test until passing**

  ---

  ## Phase 2 Complete Checklist
  - [ ] 2.1 Batch endpoints require ownership verification
  - [ ] 2.2 Cut list endpoints require authentication
  - [ ] All endpoints return 401/402/404 appropriately
  - [ ] No data leakage between customers
  - [ ] All E2E tests passing
  - [ ] Ready for Phase 3

  ---
  Phase 3 Prompt

  # SPLICE Phase 3: Profit Margin Fix

  ## Process
  For each feature: Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature

  ---

  ## Feature 3.1: Switch to GPT-4o-mini Transcription

  **Files:**
  - `splice-backend/services/transcription.js`

  **Problem:** OpenAI Whisper at $0.006/min results in 61-71% margins. Target is 80%+. GPT-4o-mini Transcribe at $0.003/min achieves this.

  **Current Costs:**
  - Starter ($19, 15hrs): 71.1% margin → Target 84.7%
  - Pro ($49, 50hrs): 61.4% margin → Target 80.4%
  - Team ($149, 150hrs): 61.5% margin → Target 79.6%

  **Implementation:**
  1. Update OpenAI client configuration to use GPT-4o-mini audio model
  2. Change API call from Whisper to GPT-4o-mini transcription endpoint
  3. Verify response format compatibility (timestamps, words, segments)
  4. Update any parsing logic if response structure differs
  5. Add fallback to Whisper if GPT-4o-mini fails (optional)
  6. Update cost tracking/logging if present

  **E2E Test After Implementation:**
  - Transcribe short audio file (30 sec) → verify transcript accuracy
  - Transcribe long audio file (10 min) → verify no truncation
  - Verify timestamp format matches expected structure
  - Verify word-level data available if needed
  - Test `/analyze` endpoint end-to-end
  - Test `/silences` endpoint (uses transcript)
  - Compare output quality with previous Whisper output
  - Verify take detection still works with new transcript format
  - Check response times (should be similar or faster)

  **Fix any bugs found, re-test until passing**

  ---

  ## Phase 3 Complete Checklist
  - [ ] 3.1 GPT-4o-mini transcription integrated
  - [ ] Transcript format compatible with all consumers
  - [ ] Take detection works correctly
  - [ ] Silence detection works correctly
  - [ ] No quality regression
  - [ ] All E2E tests passing
  - [ ] Margins now at 80%+ (verify with cost calculation)
  - [ ] Ready for Phase 4

  ---
  Phase 4 Prompt

  # SPLICE Phase 4: UX Fixes

  ## Process
  For each feature: Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature

  ---

  ## Feature 4.1: Credits Badge Error State

  **Files:**
  - `splice-plugin/js/credits.js:73-76`

  **Problem:** Credits badge disappears on network error. Users have no feedback when balance can't be fetched.

  **Implementation:**
  1. Instead of hiding badge on error, show error state (red/warning style)
  2. Add retry button or click-to-retry on error state
  3. Show "?" or error icon instead of hiding completely
  4. Add tooltip explaining the error
  5. Auto-retry after 30 seconds

  **E2E Test After Implementation:**
  - Disconnect network → badge should show error state
  - Click badge in error state → should retry fetch
  - Reconnect network → badge should recover and show balance
  - Verify error state styling is visible and clear
  - Verify tooltip shows helpful message
  - Test rapid network disconnects → no stuck states

  **Fix any bugs found, re-test until passing, then proceed to 4.2**

  ---

  ## Feature 4.2: Button Stuck States

  **Files:**
  - `splice-plugin/js/main.js:1169-1183`

  **Problem:** "Set Media Folder" button shows "Selecting..." but never resets after folder picker error or cancel.

  **Implementation:**
  1. Add `finally` block to restore button text on all code paths
  2. Check all other buttons for similar issues (GO, Build Sequence, etc.)
  3. Ensure button re-enabled after error
  4. Store original text before changing, restore in finally

  **E2E Test After Implementation:**
  - Click "Set Media Folder" then cancel picker → button should reset
  - Click "Set Media Folder" with picker error → button should reset
  - Click "GO" then cancel/error → button should reset
  - Click "Build Sequence" then error → button should reset
  - Rapid-click buttons → no stuck states
  - Test all async button operations

  **Fix any bugs found, re-test until passing, then proceed to 4.3**

  ---

  ## Feature 4.3: Offline Detection

  **Files:**
  - `splice-plugin/js/main.js`
  - `splice-plugin/js/credits.js`

  **Problem:** No `navigator.onLine` checks. Users can trigger actions while offline with no feedback.

  **Implementation:**
  1. Add `window.addEventListener('online/offline')` handlers
  2. Show connection status indicator in UI
  3. Disable GO/Build buttons when offline
  4. Show "You're offline" message when actions attempted
  5. Auto-recover when connection restored

  **E2E Test After Implementation:**
  - Go offline → status indicator shows offline
  - Try to click GO while offline → shows offline message, button disabled
  - Go online → status indicator updates, buttons enabled
  - Verify credits badge shows appropriate state when offline
  - Test offline → online → action works correctly

  **Fix any bugs found, re-test until passing, then proceed to 4.4**

  ---

  ## Feature 4.4: Error Message Improvements

  **Files:**
  - `splice-plugin/js/main.js:1110-1136` (formatBuildError)
  - `splice-plugin/js/main.js:1423`

  **Problem:** Technical errors lack actionable guidance. Users don't know how to recover.

  **Implementation:**
  1. Update `formatBuildError()` to include recovery steps
  2. Add user-friendly messages for common errors:
     - "No project open" → "Open a Premiere Pro project first"
     - "No sequence" → "Create or select a sequence in your project"
     - "Network error" → "Check your internet connection and try again"
     - "Insufficient credits" → "Add more credits in Settings"
  3. Remove technical jargon from user-facing messages
  4. Add "Learn More" links where appropriate

  **E2E Test After Implementation:**
  - Trigger each error condition → verify friendly message shown
  - Verify recovery steps are actionable
  - Verify no raw error objects or stack traces shown to user
  - Test all error paths in GO, Build Sequence, activation flows

  **Fix any bugs found, re-test until passing**

  ---

  ## Phase 4 Complete Checklist
  - [ ] 4.1 Credits badge shows error state (not hidden)
  - [ ] 4.2 No buttons get stuck in loading state
  - [ ] 4.3 Offline detection with status indicator
  - [ ] 4.4 User-friendly error messages with recovery steps
  - [ ] All UI states recoverable
  - [ ] All E2E tests passing
  - [ ] Ready for Phase 5

  ---
  Phase 5 Prompt

  # SPLICE Phase 5: E2E Wiring Fixes

  ## Process
  For each feature: Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature

  ---

  ## Feature 5.1: Credits Cache Invalidation on Logout

  **Files:**
  - `splice-plugin/js/settings.js:1334-1339`
  - `splice-plugin/js/credits.js`

  **Problem:** `currentCredits` variable not cleared on logout. Stale data persists in memory.

  **Implementation:**
  1. Export `clearCredits()` function from `credits.js`
  2. Set `currentCredits = null` in `clearCredits()`
  3. Call `clearCredits()` from `logout()` in `settings.js`
  4. Reset credit badge to default/logged-out state
  5. Clear any cached tier/isolation data

  **E2E Test After Implementation:**
  - Login → verify credits displayed
  - Logout → verify credits badge reset to logged-out state
  - Verify `currentCredits` is null after logout
  - Login as different user → verify new user's credits shown (not cached)
  - Rapid login/logout cycles → no stale data

  **Fix any bugs found, re-test until passing, then proceed to 5.2**

  ---

  ## Feature 5.2: Webhook Idempotency Race

  **Files:**
  - `splice-backend/services/usageTracking.js:437-458`
  - `splice-backend/server.js:157-161`

  **Problem:** Concurrent webhook retries can both pass `isEventProcessed()` check before either records the event.

  **Implementation:**
  1. Replace check-then-insert with atomic INSERT ... ON CONFLICT
  2. Use INSERT as the lock mechanism:
  ```javascript
  const result = await client.query(
    `INSERT INTO webhook_events (event_id, event_type, status)
     VALUES ($1, $2, 'processing')
     ON CONFLICT (event_id) DO NOTHING
     RETURNING id`,
    [eventId, eventType]
  );
  if (result.rows.length === 0) return { skipped: true };
  3. Update status to 'completed' or 'failed' after processing
  4. Add error column for failed event tracking

  E2E Test After Implementation:
  - Send same webhook event 5 times concurrently
  - Verify only 1 processes, others return skipped: true
  - Verify single database entry for event
  - Verify no duplicate tier updates or license keys
  - Test with different event types
  - Verify failed events marked as 'failed' with error

  Fix any bugs found, re-test until passing

  ---
  Phase 5 Complete Checklist

  - 5.1 Credits cleared on logout
  - 5.2 Webhook idempotency atomic
  - No stale data between sessions
  - No duplicate webhook processing
  - All E2E tests passing
  - Ready for Phase 6 (Final Test)

  ---

  ## Phase 6 Prompt

  ```markdown
  # SPLICE Phase 6: Final Comprehensive E2E Test

  ## Purpose
  All features from Phases 1-5 are complete. Run full end-to-end test of entire system to verify everything works together.

  ---

  ## Test 1: Complete Purchase-to-Usage Flow

  **Steps:**
  1. Simulate Stripe `checkout.session.completed` webhook
  2. Verify tier updated in database
  3. Verify license key generated
  4. Verify license key email sent (or metadata updated)
  5. Activate license key in plugin
  6. Verify customer ID stored locally
  7. Verify credits badge shows correct balance
  8. Run `/analyze` on test audio file
  9. Verify usage deducted correctly
  10. Verify credits badge updates

  **Pass Criteria:** All 10 steps succeed without errors

  ---

  ## Test 2: Concurrency Stress Test

  **Steps:**
  1. Set user to 1.0 hours remaining
  2. Send 20 concurrent `/silences-rms` requests (each ~0.1hr)
  3. Verify exactly 10 succeed, 10 fail with 402
  4. Verify final balance is 0.0 (not negative)
  5. Verify no race condition artifacts in database
  6. Send 5 concurrent license activations for same key
  7. Verify only 1 succeeds

  **Pass Criteria:** Atomic operations, no double-spend, correct rejection

  ---

  ## Test 3: API Auth Verification

  **Steps:**
  1. Test all protected endpoints without auth → expect 401/402
  2. Test batch endpoints as wrong customer → expect 404
  3. Test cut-list endpoints without auth → expect 401/402
  4. Test with valid auth → all succeed
  5. Verify usage deducted on billable endpoints

  **Endpoints to test:**
  - POST `/analyze`, `/silences-rms`, `/silences-audio`
  - POST `/profanity`, `/repetitions`, `/fillers`, `/stutters`
  - POST `/cut-list`, `/cut-list/takes`
  - POST `/multitrack`, `/isolate-vocals`
  - GET/DELETE `/batch/*`

  **Pass Criteria:** All auth checks enforced correctly

  ---

  ## Test 4: UI Flow Verification

  **Steps:**
  1. Load plugin with no network → verify offline indicator
  2. Restore network → verify recovery
  3. Click GO with no credits → verify friendly error
  4. Cancel folder picker → verify button resets
  5. Trigger API error → verify user-friendly message
  6. Logout → verify credits badge clears
  7. Login → verify fresh credits loaded

  **Pass Criteria:** All UI states handle gracefully, no stuck states

  ---

  ## Test 5: Webhook Reliability

  **Steps:**
  1. Send duplicate webhook 10 times rapidly
  2. Verify single processing (idempotency)
  3. Kill server mid-webhook → restart
  4. Verify no partial state corruption
  5. Send webhook with invalid signature → verify rejection

  **Pass Criteria:** Webhooks are idempotent and secure

  ---

  ## Test 6: Profit Margin Verification

  **Steps:**
  1. Process 1 hour of audio via `/analyze`
  2. Check OpenAI API logs for actual cost
  3. Verify using GPT-4o-mini (not Whisper)
  4. Calculate: $0.003/min × 60 = $0.18/hr
  5. Verify margin math:
     - Starter: $19 - (15 × $0.18) = $16.30 → 85.8% margin
     - Pro: $49 - (50 × $0.18) = $40 → 81.6% margin
     - Team: $149 - (150 × $0.18) = $122 → 81.9% margin

  **Pass Criteria:** All tiers ≥80% margin

  ---

  ## Final Checklist

  | Test | Status |
  |------|--------|
  | 1. Purchase-to-Usage Flow | ⬜ |
  | 2. Concurrency Stress Test | ⬜ |
  | 3. API Auth Verification | ⬜ |
  | 4. UI Flow Verification | ⬜ |
  | 5. Webhook Reliability | ⬜ |
  | 6. Profit Margin Verification | ⬜ |

  ## If Any Test Fails
  1. Log failure with specific step and error
  2. Trace to root cause (file:line)
  3. Fix the issue
  4. Re-run failed test
  5. If pass, continue
  6. If fail, repeat fix cycle

  ## Completion Criteria
  All 6 tests passing = SPLICE audit fixes complete and verified

  ---
  Each prompt is self-contained. Copy the phase prompt, complete the features with E2E testing, then move to the next phase. Phase 6 is the final comprehensive validation.