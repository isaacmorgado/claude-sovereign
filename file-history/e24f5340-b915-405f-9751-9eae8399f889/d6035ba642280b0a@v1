"""
Leaderboard database model
"""

import uuid
import secrets
from datetime import datetime
from sqlalchemy import Column, String, DateTime, ForeignKey, Numeric, Text
from sqlalchemy.dialects.postgresql import UUID, JSONB

from app.database import Base


def generate_anonymous_name() -> str:
    """Generate anonymous username like 'User_a1b2c3'"""
    return f"User_{secrets.token_hex(3)}"


class LeaderboardScore(Base):
    __tablename__ = "leaderboard_scores"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False, unique=True)
    analysis_id = Column(UUID(as_uuid=True), ForeignKey("analyses.id", ondelete="SET NULL"), nullable=True)
    score = Column(Numeric(4, 2), nullable=False)
    gender = Column(String(10), nullable=False)
    ethnicity = Column(String(30), nullable=True)
    anonymous_name = Column(String(20), nullable=False, default=generate_anonymous_name)
    face_photo_url = Column(Text, nullable=True)
    top_strengths = Column(JSONB, nullable=True)  # ["Jawline", "Eye spacing", "Nose width"]
    top_improvements = Column(JSONB, nullable=True)  # ["Lip fullness", "Brow position", "Chin projection"]
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    def __repr__(self):
        return f"<LeaderboardScore user={self.user_id} score={self.score}>"
