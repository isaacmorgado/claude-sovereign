#!/bin/bash

echo "üîç EXTENSION VERIFICATION CHECK"
echo "================================"
echo ""

EXT_DIR="$HOME/.vscode/extensions/kompletekontrol.komplete-kontrol-3.38.1"

if [ ! -d "$EXT_DIR" ]; then
    echo "‚ùå Extension directory NOT found at:"
    echo "   $EXT_DIR"
    echo ""
    echo "The extension is not installed."
    echo "Run ./DIAGNOSE_AND_FIX.sh to install it."
    echo ""
    exit 1
fi

echo "‚úÖ Extension directory found"
echo ""

# Check package.json
if [ -f "$EXT_DIR/package.json" ]; then
    echo "‚úÖ package.json exists"

    PUBLISHER=$(grep -o '"publisher".*' "$EXT_DIR/package.json" | head -1 | cut -d'"' -f4)
    NAME=$(grep -o '"name".*' "$EXT_DIR/package.json" | head -1 | cut -d'"' -f4)
    VERSION=$(grep -o '"version".*' "$EXT_DIR/package.json" | head -1 | cut -d'"' -f4)
    DISPLAY=$(grep -o '"displayName".*' "$EXT_DIR/package.json" | head -1 | cut -d'"' -f4)

    echo "   Publisher: $PUBLISHER"
    echo "   Name: $NAME"
    echo "   Version: $VERSION"
    echo "   Display: $DISPLAY"
else
    echo "‚ùå package.json MISSING"
    echo ""
    echo "The extension is corrupted."
    exit 1
fi

echo ""

# Check critical files
echo "Checking critical files..."
echo ""

FILES_TO_CHECK=(
    "dist/extension.js:Main extension code"
    "assets/icons/icon.svg:Activity bar icon"
    "webview-ui/build/index.html:Webview UI"
)

ALL_GOOD=true

for item in "${FILES_TO_CHECK[@]}"; do
    file="${item%%:*}"
    desc="${item##*:}"

    if [ -f "$EXT_DIR/$file" ]; then
        size=$(ls -lh "$EXT_DIR/$file" | awk '{print $5}')
        echo "  ‚úÖ $file ($size) - $desc"
    else
        echo "  ‚ùå $file - $desc (MISSING)"
        ALL_GOOD=false
    fi
done

echo ""

if [ "$ALL_GOOD" = true ]; then
    echo "‚úÖ All critical files present"
else
    echo "‚ùå Some files are missing - extension is corrupted"
    echo ""
    echo "Run ./DIAGNOSE_AND_FIX.sh to reinstall"
    exit 1
fi

echo ""

# Check for conflicts
echo "Checking for conflicting extensions..."
echo ""

CONFLICTS=0

if [ -d "$HOME/.vscode/extensions/rooveterinaryinc.roo-cline-3.38.1" ]; then
    echo "  ‚ùå OLD Roo Code extension found (CONFLICT!)"
    CONFLICTS=1
fi

for ext in "$HOME/.vscode/extensions"/*roo* "$HOME/.vscode/extensions"/*cline*; do
    if [ -d "$ext" ]; then
        basename=$(basename "$ext")
        if [[ "$basename" != *"pylance"* ]] && [[ "$basename" != *"python"* ]] && [[ "$basename" != "kompletekontrol.komplete-kontrol-3.38.1" ]]; then
            echo "  ‚ö†Ô∏è  Found: $basename"
            CONFLICTS=1
        fi
    fi
done

if [ $CONFLICTS -eq 0 ]; then
    echo "  ‚úÖ No conflicting extensions found"
else
    echo ""
    echo "  ‚ùå CONFLICTS DETECTED!"
    echo ""
    echo "  This will cause:"
    echo "    - Double UI elements"
    echo "    - Both extensions trying to activate"
    echo "    - MCP servers not loading"
    echo ""
    echo "  Run ./DIAGNOSE_AND_FIX.sh to remove conflicts"
fi

echo ""
echo "================================"
echo "SUMMARY"
echo "================================"
echo ""

if [ "$ALL_GOOD" = true ] && [ $CONFLICTS -eq 0 ]; then
    echo "‚úÖ Extension is correctly installed"
    echo "‚úÖ No conflicts detected"
    echo ""
    echo "If VSCode still doesn't show the extension:"
    echo "1. Fully quit VSCode (Cmd+Q)"
    echo "2. Reopen VSCode"
    echo "3. Check Developer Console for activation errors:"
    echo "   Help ‚Üí Toggle Developer Tools ‚Üí Console tab"
    echo ""
else
    echo "‚ùå Issues detected"
    echo ""
    echo "Run this to fix:"
    echo "  ./DIAGNOSE_AND_FIX.sh"
    echo ""
fi

echo "Extension location: $EXT_DIR"
echo ""
