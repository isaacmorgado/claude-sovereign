#!/bin/bash

echo "üö® EMERGENCY FIX - Removing Old Extension"
echo "=========================================="
echo ""

# The old extension directory
OLD_EXT="$HOME/.vscode/extensions/rooveterinaryinc.roo-cline-3.38.1"

if [ -d "$OLD_EXT" ]; then
    echo "‚ùå FOUND THE PROBLEM: Old extension is still installed!"
    echo "   Location: $OLD_EXT"
    echo ""
    echo "üóëÔ∏è  Removing it now..."
    rm -rf "$OLD_EXT"
    echo "   ‚úÖ Removed!"
    echo ""
else
    echo "‚ÑπÔ∏è  Old extension directory not found (this is good)"
    echo ""
fi

# Also remove any other roo/komplete extensions
echo "üîç Checking for other old extensions..."
echo ""

for ext_dir in ~/.vscode/extensions/*roo* ~/.vscode/extensions/*komplete* ~/.vscode/extensions/*cline*; do
    if [ -d "$ext_dir" ]; then
        basename=$(basename "$ext_dir")
        if [[ "$basename" != *"pylance"* ]] && [[ "$basename" != *"python"* ]]; then
            echo "   Found: $basename"
            echo "   Removing..."
            rm -rf "$ext_dir"
            echo "   ‚úÖ Removed!"
        fi
    fi
done

echo ""
echo "üßπ Clearing VSCode caches..."
echo ""

# Clear caches
rm -rf ~/Library/Application\ Support/Code/CachedExtensionVSIXs/* 2>/dev/null
rm -rf ~/Library/Application\ Support/Code/CachedExtensions/* 2>/dev/null

echo "‚úÖ Caches cleared"
echo ""

# Now install the new one
VSIX_PATH="/Users/imorgado/Projects/Roo-Code/bin/komplete-kontrol-3.38.1.vsix"

if [ ! -f "$VSIX_PATH" ]; then
    echo "‚ùå ERROR: VSIX not found at:"
    echo "   $VSIX_PATH"
    echo ""
    echo "Building it now..."
    cd /Users/imorgado/Projects/Roo-Code
    pnpm run vsix
    echo ""
fi

if command -v code &> /dev/null; then
    echo "üöÄ Installing KOMPLETE-KONTROL extension..."
    echo ""
    code --install-extension "$VSIX_PATH" --force
    echo ""
    echo "‚úÖ Installation complete!"
else
    echo "‚ö†Ô∏è  'code' command not found - please install manually:"
    echo "   1. Open VSCode"
    echo "   2. Extensions panel (Cmd+Shift+X)"
    echo "   3. ... menu ‚Üí Install from VSIX"
    echo "   4. Select: $VSIX_PATH"
fi

echo ""
echo "=========================================="
echo "üéØ CRITICAL NEXT STEP:"
echo "=========================================="
echo ""
echo "1. ‚ö†Ô∏è  FORCE QUIT VISUAL STUDIO CODE NOW!"
echo "   - Press Cmd+Q (or VSCode ‚Üí Quit)"
echo "   - Make sure it's completely closed"
echo ""
echo "2. üîÑ REOPEN VISUAL STUDIO CODE"
echo ""
echo "3. ‚úÖ YOU SHOULD NOW SEE:"
echo "   - KOMPLETE-KONTROL icon in Activity Bar"
echo "   - The extension panel will open"
echo "   - All features available"
echo ""
echo "=========================================="
echo ""
