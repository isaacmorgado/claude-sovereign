# Fixing MCP Server Connection Errors

## The Problem

All MCP servers showing error: **`MCP error -32000: Connection closed`**

## Root Cause

The MCP server configuration needs the **full path** to `npx` on your system. The extension may be trying to use `npx` directly, which doesn't work in VSCode's environment.

## Solution

### Step 1: Find Your npx Path

Run this command in Terminal:
```bash
which npx
```

**Expected output:** `/opt/homebrew/bin/npx` (on M1/M2 Mac) or `/usr/local/bin/npx` (on Intel Mac)

### Step 2: Install the New Extension

1. **Open Visual Studio Code**
2. **Install the VSIX:**
   - Extensions panel (`Cmd+Shift+X`)
   - Click `...` menu → "Install from VSIX..."
   - Select: `/Users/imorgado/Projects/Roo-Code/bin/komplete-kontrol-3.38.1.vsix`
   - Click "Reload Required" when prompted

3. **Completely restart VSCode:**
   - Press `Cmd+Q` to quit completely
   - Reopen VSCode

### Step 3: Configure MCP Servers

After installing the extension:

1. **Open KOMPLETE-KONTROL settings**
   - Click the KOMPLETE-KONTROL icon in the Activity Bar (left sidebar)
   - Click the gear/settings icon
   - Go to "MCP Servers" tab

2. **The MCP servers will be listed but may show connection errors**

3. **Fix each server configuration:**
   - For each server you want to use, click "Edit"
   - Change the `command` field from `npx` to the full path (from Step 1)
   - Example:
     ```json
     {
       "command": "/opt/homebrew/bin/npx",
       "args": ["-y", "@modelcontextprotocol/server-gemini"]
     }
     ```

### Step 4: Enable MCP Servers

Toggle ON the servers you want to use:
- ✅ Gemini (Google AI + search)
- ✅ GitHub Grep (search 1M+ repos)
- ✅ Grep (local code search)
- ✅ Claude-in-Chrome (browser automation)

Leave other servers OFF unless you need them.

### Step 5: Test Connection

1. Create a new task in KOMPLETE-KONTROL
2. Ask something that requires an MCP tool:
   ```
   "Search GitHub for React hooks examples"
   ```
3. The MCP server should activate and return results
4. Check the MCP tab - servers should show "Connected" status

## Alternative: Manual Configuration File

If the UI doesn't work, you can edit the configuration file directly:

**Location:**
```
~/Library/Application Support/Code/User/globalStorage/KompleteKontrol.komplete-kontrol/settings/mcp_settings.json
```

**Template:**
```json
{
  "mcpServers": {
    "gemini": {
      "command": "/opt/homebrew/bin/npx",
      "args": ["-y", "@modelcontextprotocol/server-gemini"],
      "timeout": 60,
      "disabled": false
    },
    "github-grep": {
      "command": "/opt/homebrew/bin/npx",
      "args": ["-y", "@modelcontextprotocol/server-grep"],
      "timeout": 60,
      "disabled": false
    },
    "grep": {
      "command": "/opt/homebrew/bin/npx",
      "args": ["-y", "@roo-code/mcp-server-grep"],
      "timeout": 30,
      "disabled": false
    },
    "claude-in-chrome": {
      "command": "/opt/homebrew/bin/npx",
      "args": ["-y", "@imorgado/mcp-server-claude-in-chrome"],
      "timeout": 60,
      "disabled": false
    }
  }
}
```

**After editing:**
1. Save the file
2. Reload VSCode window: `Cmd+Shift+P` → "Developer: Reload Window"
3. Check MCP servers in KOMPLETE-KONTROL settings

## All 18 Available MCP Servers

### Core AI & Search
1. **gemini** - Google AI with search (`@modelcontextprotocol/server-gemini`)
2. **github-grep** - Search 1M+ GitHub repos (`@modelcontextprotocol/server-grep`)
3. **grep** - Local code search (`@roo-code/mcp-server-grep`)
4. **claude-in-chrome** - Browser automation (`@imorgado/mcp-server-claude-in-chrome`)

### Development Tools
5. **docker** - Container management (`@roo-code/mcp-server-docker`)
6. **github** - Repository operations (`@modelcontextprotocol/server-github`)
7. **railway** - Cloud deployment (`@roo-code/mcp-server-railway`)
8. **stripe** - Payment processing (`@roo-code/mcp-server-stripe`)

### Security & Reverse Engineering
9. **ghidra** - Binary reverse engineering (`@roo-code/mcp-server-ghidra`)
10. **frida** - Dynamic instrumentation (`@roo-code/mcp-server-frida`)
11. **radare2** - Binary analysis (`@roo-code/mcp-server-radare2`)
12. **mitmproxy** - Traffic inspection (`@roo-code/mcp-server-mitmproxy`)
13. **httpie** - HTTP client (`@roo-code/mcp-server-httpie`)
14. **ffuf** - Web fuzzing (`@roo-code/mcp-server-ffuf`)

### Utility Tools
15. **screenshot-to-code** - Screenshot conversion (`@roo-code/mcp-server-screenshot-to-code`)
16. **ffmpeg** - Media processing (`@roo-code/mcp-server-ffmpeg`)
17. **duckdb** - SQL analytics (`@roo-code/mcp-server-duckdb`)
18. **jq** - JSON processing (`@roo-code/mcp-server-jq`)

**Note:** Most servers use `@roo-code/` or `@modelcontextprotocol/` prefixes. Check the package name when configuring.

## Common Issues

### Issue 1: "Command not found: npx"
**Fix:** Use full path `/opt/homebrew/bin/npx` in all MCP server configurations

### Issue 2: "Server timeout"
**Fix:** Increase timeout value to 120 for slow servers:
```json
"timeout": 120
```

### Issue 3: "Package not found"
**Fix:** The package will be auto-installed by npx on first use. Wait 10-30 seconds.

### Issue 4: "Permission denied"
**Fix:** Ensure npx is executable:
```bash
ls -l /opt/homebrew/bin/npx
```
Should show `-rwxr-xr-x` (executable flags)

## Testing

After configuration, test with these prompts:

**Test Gemini:**
```
"Search the web for latest TypeScript 5.8 features"
```

**Test GitHub Grep:**
```
"Find examples of React useEffect cleanup functions on GitHub"
```

**Test Local Grep:**
```
"Search this codebase for all MCP server configurations"
```

**Test Claude-in-Chrome:**
```
"Open https://github.com and take a screenshot"
```

## Success Indicators

✅ MCP servers show "Connected" in settings
✅ No `-32000` errors in the console
✅ MCP tools are available in task execution
✅ Searches return results

---

**Questions?**
- Check VSCode Developer Console: `Help` → `Toggle Developer Tools` → `Console` tab
- Look for MCP-related errors
- Ensure VSCode has been completely restarted
