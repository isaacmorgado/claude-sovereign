#!/bin/bash

echo "üîç DIAGNOSTIC AND FIX - KOMPLETE-KONTROL"
echo "========================================"
echo ""

# Check if VSCode is running
if pgrep -x "Code" > /dev/null; then
    echo "‚ö†Ô∏è  WARNING: VSCode is running. For best results, please quit it first."
    echo ""
    read -p "Continue anyway? (y/n): " choice
    if [[ ! "$choice" =~ ^[Yy]$ ]]; then
        echo "Please quit VSCode (Cmd+Q) and run this script again."
        exit 0
    fi
    echo ""
fi

echo "üìä STEP 1: DIAGNOSING THE PROBLEM"
echo "=================================="
echo ""

# Check installed extensions
echo "Checking installed extensions..."
echo ""

EXTENSIONS_DIR="$HOME/.vscode/extensions"
OLD_EXT=""
NEW_EXT=""

for ext in "$EXTENSIONS_DIR"/*roo* "$EXTENSIONS_DIR"/*komplete*; do
    if [ -d "$ext" ]; then
        basename=$(basename "$ext")

        # Skip Python-related stuff
        if [[ "$basename" == *"pylance"* ]] || [[ "$basename" == *"python"* ]]; then
            continue
        fi

        echo "Found: $basename"

        # Check if it has package.json
        if [ -f "$ext/package.json" ]; then
            PUBLISHER=$(grep -o '"publisher".*' "$ext/package.json" | head -1 | cut -d'"' -f4)
            NAME=$(grep -o '"name".*' "$ext/package.json" | head -1 | cut -d'"' -f4)
            VERSION=$(grep -o '"version".*' "$ext/package.json" | head -1 | cut -d'"' -f4)

            echo "  Publisher: $PUBLISHER"
            echo "  Name: $NAME"
            echo "  Version: $VERSION"

            if [[ "$PUBLISHER" == "rooveterinaryinc" ]]; then
                OLD_EXT="$ext"
                echo "  ‚ùå THIS IS THE OLD EXTENSION"
            elif [[ "$PUBLISHER" == "KompleteKontrol" ]] || [[ "$PUBLISHER" == "kompletekontrol" ]]; then
                NEW_EXT="$ext"
                echo "  ‚úÖ THIS IS THE NEW EXTENSION"
            fi
        else
            echo "  ‚ö†Ô∏è  CORRUPTED - No package.json found"
        fi
        echo ""
    fi
done

# Diagnosis
echo "=================================="
echo "DIAGNOSIS:"
echo "=================================="
echo ""

if [ -n "$OLD_EXT" ] && [ -n "$NEW_EXT" ]; then
    echo "‚ùå PROBLEM: BOTH EXTENSIONS ARE INSTALLED!"
    echo ""
    echo "This is causing:"
    echo "  - Double UI elements (settings bars, containers)"
    echo "  - Conflicts between extensions"
    echo "  - Neither extension working properly"
    echo ""
    echo "Solution: Remove the OLD extension, keep the NEW one"
    echo ""
elif [ -n "$OLD_EXT" ] && [ -z "$NEW_EXT" ]; then
    echo "‚ÑπÔ∏è  FOUND: Only the OLD extension is installed"
    echo ""
    echo "Solution: Install the NEW extension"
    echo ""
elif [ -z "$OLD_EXT" ] && [ -n "$NEW_EXT" ]; then
    echo "‚úÖ GOOD: Only the NEW extension is installed"
    echo ""
    echo "If it's not working, the extension may be corrupted"
    echo ""
else
    echo "‚ö†Ô∏è  FOUND: No extensions installed"
    echo ""
    echo "Solution: Install the NEW extension"
    echo ""
fi

echo "=================================="
echo ""
read -p "Proceed with fix? (y/n): " proceed
if [[ ! "$proceed" =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
fi

echo ""
echo "üîß STEP 2: APPLYING FIX"
echo "======================="
echo ""

# Remove OLD extension if exists
if [ -n "$OLD_EXT" ]; then
    echo "Removing OLD extension..."
    echo "  Location: $OLD_EXT"
    rm -rf "$OLD_EXT"
    echo "  ‚úÖ Removed"
    echo ""
fi

# Remove NEW extension if corrupted
if [ -n "$NEW_EXT" ]; then
    echo "Removing existing NEW extension (will reinstall clean)..."
    echo "  Location: $NEW_EXT"
    rm -rf "$NEW_EXT"
    echo "  ‚úÖ Removed"
    echo ""
fi

# Clear all caches
echo "Clearing VSCode caches..."
rm -rf "$HOME/Library/Application Support/Code/CachedExtensionVSIXs"/* 2>/dev/null
rm -rf "$HOME/Library/Application Support/Code/CachedExtensions"/* 2>/dev/null
rm -rf "$HOME/Library/Application Support/Code/User/workspaceStorage"/*roo* 2>/dev/null
rm -rf "$HOME/Library/Application Support/Code/User/workspaceStorage"/*komplete* 2>/dev/null
echo "  ‚úÖ Caches cleared"
echo ""

# Remove old storage
echo "Clearing old extension data..."
rm -rf "$HOME/Library/Application Support/Code/User/globalStorage/rooveterinaryinc.roo-cline" 2>/dev/null
echo "  ‚úÖ Old data cleared"
echo ""

echo "üöÄ STEP 3: INSTALLING CLEAN EXTENSION"
echo "======================================"
echo ""

VSIX_PATH="/Users/imorgado/Projects/Roo-Code/bin/komplete-kontrol-3.38.1.vsix"

# Verify VSIX exists
if [ ! -f "$VSIX_PATH" ]; then
    echo "VSIX not found, building it..."
    cd /Users/imorgado/Projects/Roo-Code
    pnpm run vsix
    echo ""
fi

# Create extension directory
EXT_DIR="$HOME/.vscode/extensions/kompletekontrol.komplete-kontrol-3.38.1"
echo "Creating extension directory..."
mkdir -p "$EXT_DIR"
echo "  Location: $EXT_DIR"
echo ""

# Extract VSIX
echo "Extracting VSIX..."
cd "$EXT_DIR"
unzip -q "$VSIX_PATH"

# Check if files are in extension/ subdirectory
if [ -d "extension" ]; then
    echo "  Moving files from extension/ subdirectory..."
    mv extension/* .
    mv extension/.[!.]* . 2>/dev/null
    rmdir extension
fi

echo "  ‚úÖ Extracted"
echo ""

# Verify critical files
echo "Verifying installation..."
MISSING=0

CRITICAL_FILES=(
    "package.json"
    "dist/extension.js"
)

for file in "${CRITICAL_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  ‚úÖ $file"
    else
        echo "  ‚ùå $file (MISSING)"
        MISSING=1
    fi
done

echo ""

if [ $MISSING -eq 1 ]; then
    echo "‚ùå ERROR: Installation incomplete!"
    echo ""
    echo "Checking VSIX contents..."
    unzip -l "$VSIX_PATH" | grep -E "package.json|extension.js" | head -10
    echo ""
    exit 1
fi

# Set permissions
echo "Setting permissions..."
chmod -R 755 "$EXT_DIR"
echo "  ‚úÖ Permissions set"
echo ""

echo "======================================"
echo "‚úÖ INSTALLATION COMPLETE!"
echo "======================================"
echo ""
echo "üìã WHAT TO DO NEXT:"
echo ""
echo "1. If VSCode is running:"
echo "   - QUIT VSCode completely (Cmd+Q)"
echo "   - Wait 5 seconds"
echo ""
echo "2. Open VSCode"
echo ""
echo "3. You should see:"
echo "   ‚úÖ Single KOMPLETE-KONTROL icon in Activity Bar"
echo "   ‚úÖ No duplicate UI elements"
echo "   ‚úÖ Extension works properly"
echo ""
echo "4. If it's still loading forever:"
echo "   - Open Developer Tools: Help ‚Üí Toggle Developer Tools"
echo "   - Check Console tab for errors"
echo "   - Look for activation errors"
echo ""
echo "5. Check MCP Servers:"
echo "   - Open KOMPLETE-KONTROL settings"
echo "   - Go to MCP Servers tab"
echo "   - They should appear (but may need configuration)"
echo ""
echo "======================================"
echo ""

# Show installation location
echo "Extension installed at:"
echo "$EXT_DIR"
echo ""
echo "To verify files:"
echo "ls -la $EXT_DIR"
echo ""
