#!/bin/bash

echo "üîß KOMPLETE-KONTROL - Complete Uninstall & Reinstall Script"
echo "==========================================================="
echo ""

# Check if code command exists
if ! command -v code &> /dev/null; then
    echo "‚ùå ERROR: 'code' command not found in PATH"
    echo ""
    echo "To fix this:"
    echo "1. Open Visual Studio Code"
    echo "2. Press Cmd+Shift+P"
    echo "3. Type: Shell Command: Install 'code' command in PATH"
    echo "4. Click it, then run this script again"
    echo ""
    exit 1
fi

echo "‚úÖ Found 'code' command"
echo ""

# Step 1: List currently installed extensions
echo "üìã Step 1: Checking installed extensions..."
echo ""
echo "Extensions with 'roo' or 'komplete':"
code --list-extensions | grep -i "roo\|komplete" || echo "  None found"
echo ""

# Step 2: Uninstall all old versions
echo "üóëÔ∏è  Step 2: Uninstalling old versions..."
echo ""

# Try to uninstall common variants
for ext in \
    "KompleteKontrol.komplete-kontrol" \
    "rooveterinaryinc.roo-cline" \
    "saoudrizwan.claude-dev" \
    "roo-cline.roo-cline" \
    "komplete-kontrol.komplete-kontrol"
do
    echo "  Attempting to uninstall: $ext"
    code --uninstall-extension "$ext" --force 2>/dev/null && echo "    ‚úÖ Uninstalled $ext" || echo "    ‚ÑπÔ∏è  Not installed: $ext"
done

echo ""
echo "‚úÖ Uninstall complete"
echo ""

# Step 3: Clear VSCode caches
echo "üßπ Step 3: Clearing VSCode caches..."
echo ""

CACHE_DIRS=(
    "$HOME/Library/Application Support/Code/CachedExtensionVSIXs"
    "$HOME/Library/Application Support/Code/CachedExtensions"
)

for dir in "${CACHE_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        echo "  Clearing: $dir"
        rm -rf "$dir"/* 2>/dev/null && echo "    ‚úÖ Cleared" || echo "    ‚ÑπÔ∏è  Already empty"
    else
        echo "  ‚ÑπÔ∏è  Directory doesn't exist: $dir"
    fi
done

echo ""
echo "‚úÖ Cache cleared"
echo ""

# Step 4: Verify VSIX exists
echo "üì¶ Step 4: Checking for VSIX package..."
echo ""

VSIX_PATH="/Users/imorgado/Projects/Roo-Code/bin/komplete-kontrol-3.38.1.vsix"

if [ ! -f "$VSIX_PATH" ]; then
    echo "‚ùå ERROR: VSIX file not found at:"
    echo "   $VSIX_PATH"
    echo ""
    echo "You need to build it first:"
    echo "   cd /Users/imorgado/Projects/Roo-Code"
    echo "   pnpm run vsix"
    echo ""
    exit 1
fi

echo "‚úÖ Found VSIX: $VSIX_PATH"
echo "   Size: $(ls -lh "$VSIX_PATH" | awk '{print $5}')"
echo ""

# Step 5: Install new extension
echo "üöÄ Step 5: Installing KOMPLETE-KONTROL extension..."
echo ""

code --install-extension "$VSIX_PATH" --force

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ Installation successful!"
    echo ""
else
    echo ""
    echo "‚ùå Installation failed!"
    echo ""
    exit 1
fi

# Step 6: Verify installation
echo "üîç Step 6: Verifying installation..."
echo ""

sleep 2  # Give it a moment to register

INSTALLED=$(code --list-extensions | grep -i "komplete")

if [ -n "$INSTALLED" ]; then
    echo "‚úÖ KOMPLETE-KONTROL is installed:"
    echo "   $INSTALLED"
    echo ""
else
    echo "‚ö†Ô∏è  WARNING: Extension may not have registered yet"
    echo ""
fi

# Final instructions
echo "=========================================================="
echo "üéØ IMPORTANT NEXT STEPS:"
echo "=========================================================="
echo ""
echo "1. ‚ö†Ô∏è  COMPLETELY QUIT VISUAL STUDIO CODE"
echo "   - Press Cmd+Q (don't just close windows)"
echo "   - Make sure VSCode is fully quit"
echo ""
echo "2. üîÑ REOPEN VISUAL STUDIO CODE"
echo "   - The extension needs a full restart to activate"
echo ""
echo "3. ‚úÖ VERIFY IT APPEARS"
echo "   - Look for 'KOMPLETE-KONTROL' in the Activity Bar (left sidebar)"
echo "   - Click the icon to open the panel"
echo ""
echo "4. üîß IF IT DOESN'T APPEAR:"
echo "   - Press Cmd+Shift+P"
echo "   - Type 'KOMPLETE-KONTROL'"
echo "   - You should see KOMPLETE-KONTROL commands"
echo "   - Try 'View: Show KOMPLETE-KONTROL'"
echo ""
echo "=========================================================="
echo ""
echo "üéâ Script complete! Now quit VSCode and reopen it."
echo ""
