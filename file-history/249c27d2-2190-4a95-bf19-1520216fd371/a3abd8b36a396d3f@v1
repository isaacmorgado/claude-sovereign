// Settings Panel - Plugin configuration and API setup
import { LitElement, html, css } from 'lit'
import { customElement, property, state } from 'lit/decorators.js'
import type { PricingPlan } from '@/types/plugin'
import type { AIProvider } from '@/types/api'
import {
  configureAIService,
  getAvailableProviders,
  isAIServiceConfigured,
} from '@/utils/api/ai-service'
import { isValidApiKey } from '@/utils/helpers/validators'
import { backendClient, type User } from '@/utils/api/backend-client'
import { logger } from '@/utils/logger'

@customElement('settings-panel')
export class SettingsPanel extends LitElement {
  static styles = css`
    :host {
      display: block;
    }

    .section {
      margin-bottom: var(--space-lg);
    }

    .section-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--text-secondary);
      margin-bottom: var(--space-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .setting-card {
      background: var(--bg-layer-1);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
    }

    .setting-row {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .setting-row:last-child {
      margin-bottom: 0;
    }

    .setting-label {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
    }

    .setting-description {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--font-size-sm);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
    }

    .status-indicator.connected {
      background: rgba(15, 191, 132, 0.1);
      color: var(--color-accent);
    }

    .status-indicator.disconnected {
      background: rgba(215, 55, 63, 0.1);
      color: var(--color-negative);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-indicator.connected .status-dot {
      background: var(--color-accent);
    }

    .status-indicator.disconnected .status-dot {
      background: var(--color-negative);
    }

    .form-row {
      display: flex;
      gap: var(--space-sm);
    }

    .form-row sp-picker {
      width: 140px;
    }

    .form-row sp-textfield {
      flex: 1;
    }

    .about-section {
      text-align: center;
      padding: var(--space-md);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .about-section a {
      color: var(--color-primary);
      text-decoration: none;
    }

    .about-section a:hover {
      text-decoration: underline;
    }

    .plan-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .plan-name {
      font-weight: var(--font-weight-bold);
      text-transform: capitalize;
    }

    .account-card {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .account-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      flex-shrink: 0;
    }

    .account-info {
      flex: 1;
      min-width: 0;
    }

    .account-name {
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-md);
      margin-bottom: 2px;
      word-break: break-word;
    }

    .account-email {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      word-break: break-word;
    }

    .account-plan {
      display: inline-block;
      font-size: var(--font-size-xs);
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      text-transform: uppercase;
      margin-top: var(--space-xs);
    }

    .account-plan.free {
      background: var(--bg-layer-2);
      color: var(--text-secondary);
    }

    .account-plan.pro {
      background: linear-gradient(135deg, #ffd700, #ffaa00);
      color: #1a1a1a;
    }

    .account-plan.enterprise {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
    }

    .account-actions {
      margin-top: var(--space-md);
      padding-top: var(--space-md);
      border-top: 1px solid var(--border-default);
    }
  `

  @property({ type: String }) currentPlan: PricingPlan = 'free'
  @property({ attribute: false }) user: User | null = null

  @state() private selectedProvider: AIProvider = 'anthropic'
  @state() private apiKey = ''
  @state() private isSaving = false
  @state() private saveMessage = ''
  @state() private isLoggingOut = false
  @state() private isBillingLoading = false

  private providers = getAvailableProviders()

  // Valid plan values for safe class rendering
  private static readonly VALID_PLANS = ['free', 'pro', 'enterprise'] as const

  private getInitials(user: User): string {
    if (user.name) {
      const parts = user.name
        .trim()
        .split(/\s+/)
        .filter((n) => n.length > 0)
      if (parts.length > 0) {
        return parts
          .map((n) => n[0])
          .join('')
          .toUpperCase()
          .slice(0, 2)
      }
    }
    return (user.email?.[0] || '?').toUpperCase()
  }

  private getSafePlanClass(plan: string): string {
    if (SettingsPanel.VALID_PLANS.includes(plan as (typeof SettingsPanel.VALID_PLANS)[number])) {
      return plan
    }
    return 'free'
  }

  private async handleLogout(): Promise<void> {
    if (this.isLoggingOut) return

    this.isLoggingOut = true
    try {
      await backendClient.logout()
      this.dispatchEvent(
        new CustomEvent('logout', {
          bubbles: true,
          composed: true,
        })
      )
      logger.info('User logged out from settings')
    } catch (error) {
      logger.error('Logout failed', error)
    } finally {
      this.isLoggingOut = false
    }
  }

  private async handleUpgrade(): Promise<void> {
    if (this.isBillingLoading) return

    this.isBillingLoading = true
    try {
      const session = await backendClient.createCheckout('creator', 'monthly')
      window.open(session.url, '_blank')
      logger.info('Opened checkout session', { sessionId: session.sessionId })
    } catch (error) {
      logger.error('Failed to create checkout session', error)
      this.saveMessage = 'Failed to open upgrade page. Please try again.'
    } finally {
      this.isBillingLoading = false
    }
  }

  private async handleManageBilling(): Promise<void> {
    if (this.isBillingLoading) return

    this.isBillingLoading = true
    try {
      const portal = await backendClient.createPortal()
      window.open(portal.url, '_blank')
      logger.info('Opened billing portal')
    } catch (error) {
      logger.error('Failed to create billing portal', error)
      this.saveMessage = 'Failed to open billing portal. Please try again.'
    } finally {
      this.isBillingLoading = false
    }
  }

  private async handleSaveApiKey(): Promise<void> {
    if (!this.apiKey.trim()) {
      this.saveMessage = 'Please enter an API key'
      return
    }

    if (!isValidApiKey(this.apiKey, this.selectedProvider)) {
      this.saveMessage = 'Invalid API key format'
      return
    }

    this.isSaving = true
    this.saveMessage = ''

    try {
      configureAIService({
        provider: this.selectedProvider,
        apiKey: this.apiKey.trim(),
      })

      this.saveMessage = 'API key saved successfully!'
      logger.info('AI service configured', { provider: this.selectedProvider })

      // Clear the input for security
      this.apiKey = ''
    } catch (error) {
      this.saveMessage = 'Failed to save API key'
      logger.error('Failed to configure AI service', error)
    } finally {
      this.isSaving = false
    }
  }

  private handleProviderChange(e: Event): void {
    const picker = e.target as HTMLSelectElement
    this.selectedProvider = picker.value as AIProvider
  }

  private renderAccountSection() {
    if (!this.user) return ''

    const safePlan = this.getSafePlanClass(this.user.plan)

    return html`
      <div class="section">
        <div class="section-title">Account</div>
        <div class="setting-card">
          <div class="account-card">
            <div class="account-avatar">${this.getInitials(this.user)}</div>
            <div class="account-info">
              <div class="account-name">${this.user.name || 'User'}</div>
              <div class="account-email">${this.user.email}</div>
              <span class="account-plan ${safePlan}">${safePlan}</span>
            </div>
          </div>
          <div class="account-actions">
            <sp-button
              variant="secondary"
              ?disabled=${this.isLoggingOut}
              @click=${this.handleLogout}
            >
              ${this.isLoggingOut ? 'Signing out...' : 'Sign Out'}
            </sp-button>
          </div>
        </div>
      </div>
    `
  }

  render() {
    const isConfigured = isAIServiceConfigured()

    return html`
      ${this.renderAccountSection()}

      <div class="section">
        <div class="section-title">AI Service Configuration</div>
        <div class="setting-card">
          <div class="setting-row">
            <div>
              <span class="setting-label">Connection Status</span>
            </div>
            <div class="status-indicator ${isConfigured ? 'connected' : 'disconnected'}">
              <span class="status-dot"></span>
              ${isConfigured ? 'Connected' : 'Not Configured'}
            </div>
          </div>

          <div class="setting-row">
            <span class="setting-label">AI Provider & API Key</span>
            <span class="setting-description">
              Select your AI provider and enter your API key. Keys are stored locally.
            </span>
            <div class="form-row">
              <sp-picker
                label="Provider"
                .value=${this.selectedProvider}
                @change=${this.handleProviderChange}
              >
                ${this.providers.map(
                  (p) => html`
                    <sp-menu-item value=${p.id} ?selected=${this.selectedProvider === p.id}>
                      ${p.name}
                    </sp-menu-item>
                  `
                )}
              </sp-picker>
              <sp-textfield
                type="password"
                placeholder="Enter API key"
                .value=${this.apiKey}
                @input=${(e: Event) => (this.apiKey = (e.target as HTMLInputElement).value)}
              ></sp-textfield>
            </div>
            <sp-button variant="primary" ?disabled=${this.isSaving} @click=${this.handleSaveApiKey}>
              ${this.isSaving ? 'Saving...' : 'Save API Key'}
            </sp-button>
            ${this.saveMessage
              ? html`<span class="setting-description">${this.saveMessage}</span>`
              : ''}
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Subscription</div>
        <div class="setting-card">
          <div class="plan-info">
            <div>
              <span class="setting-label">Current Plan</span>
              <div class="plan-name">${this.currentPlan}</div>
            </div>
            ${this.currentPlan === 'free'
              ? html`<sp-button
                  variant="accent"
                  size="s"
                  ?disabled=${this.isBillingLoading}
                  @click=${this.handleUpgrade}
                >
                  ${this.isBillingLoading ? 'Loading...' : 'Upgrade'}
                </sp-button>`
              : html`<sp-button
                  variant="secondary"
                  size="s"
                  ?disabled=${this.isBillingLoading}
                  @click=${this.handleManageBilling}
                >
                  ${this.isBillingLoading ? 'Loading...' : 'Manage'}
                </sp-button>`}
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">About</div>
        <div class="setting-card about-section">
          <p><strong>Splice v3</strong></p>
          <p>Version 1.0.0</p>
          <p>
            <a href="https://splice.com/help" target="_blank">Help & Support</a> |
            <a href="https://splice.com/privacy" target="_blank">Privacy Policy</a>
          </p>
        </div>
      </div>
    `
  }
}

declare global {
  interface HTMLElementTagNameMap {
    'settings-panel': SettingsPanel
  }
}
