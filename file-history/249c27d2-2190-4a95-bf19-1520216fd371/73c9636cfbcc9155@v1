// Plugin initialization and core API

import type { PluginState, PluginConfig, UserLicense } from '@/types/plugin'
import { logger } from '../logger'

const DEFAULT_CONFIG: PluginConfig = {
  apiEndpoint: 'https://api.splice.com/v3',
  maxFreeOperations: 10,
  features: {
    aiAnalysis: true,
    batchProcessing: false,
    advancedSelection: false,
    cloudSync: false,
  },
}

let pluginState: PluginState = {
  isInitialized: false,
  isPremium: false,
  currentPlan: 'free',
  selectedClips: [],
  aiServiceConnected: false,
}

let userLicense: UserLicense | null = null

export async function initializePlugin(): Promise<void> {
  try {
    logger.info('Initializing plugin...')

    // Load saved state from local storage
    await loadPersistedState()

    // Check license status
    await checkLicenseStatus()

    pluginState.isInitialized = true
    logger.info('Plugin initialized successfully', { plan: pluginState.currentPlan })
  } catch (error) {
    logger.error('Failed to initialize plugin', error)
    throw error
  }
}

async function loadPersistedState(): Promise<void> {
  try {
    // UXP local storage access
    const storage = await getLocalStorage()
    const savedState = storage.getItem('splice-v3-state')
    if (savedState) {
      const parsed = JSON.parse(savedState)
      pluginState = { ...pluginState, ...parsed }
    }
  } catch (error) {
    logger.warn('Could not load persisted state', error)
  }
}

async function checkLicenseStatus(): Promise<void> {
  try {
    // In a real implementation, this would call your licensing API
    // For now, we'll use the freemium free tier
    userLicense = {
      userId: 'local-user',
      plan: 'free',
      expiresAt: null,
      operationsUsed: 0,
      operationsLimit: DEFAULT_CONFIG.maxFreeOperations,
    }

    pluginState.currentPlan = userLicense.plan
    pluginState.isPremium = userLicense.plan !== 'free'

    // Update features based on plan
    updateFeaturesForPlan(userLicense.plan)
  } catch (error) {
    logger.warn('Could not check license status, defaulting to free tier', error)
  }
}

function updateFeaturesForPlan(plan: UserLicense['plan']): void {
  const config = getConfig()

  switch (plan) {
    case 'creator':
      config.features.batchProcessing = true
      config.features.advancedSelection = true
      break
    case 'pro':
      config.features.batchProcessing = true
      config.features.advancedSelection = true
      config.features.cloudSync = true
      break
    default:
      // Free tier - defaults are already set
      break
  }
}

export function getPluginState(): PluginState {
  return { ...pluginState }
}

export function getConfig(): PluginConfig {
  return { ...DEFAULT_CONFIG }
}

export function getUserLicense(): UserLicense | null {
  return userLicense ? { ...userLicense } : null
}

export async function saveState(): Promise<void> {
  try {
    const storage = await getLocalStorage()
    storage.setItem('splice-v3-state', JSON.stringify(pluginState))
    logger.debug('State saved')
  } catch (error) {
    logger.error('Failed to save state', error)
  }
}

export function incrementOperationsUsed(): boolean {
  if (!userLicense) return false

  if (userLicense.plan === 'free' && userLicense.operationsUsed >= userLicense.operationsLimit) {
    logger.warn('Free tier operation limit reached')
    return false
  }

  userLicense.operationsUsed++
  saveState()
  return true
}

export function canPerformOperation(): boolean {
  if (!userLicense) return false
  if (userLicense.plan !== 'free') return true
  return userLicense.operationsUsed < userLicense.operationsLimit
}

export function getRemainingOperations(): number {
  if (!userLicense) return 0
  if (userLicense.plan !== 'free') return Infinity
  return Math.max(0, userLicense.operationsLimit - userLicense.operationsUsed)
}

// UXP storage helper
async function getLocalStorage(): Promise<Storage> {
  // In UXP environment, use the localStorage API
  // This is a simplified version - real UXP plugins use the storage module
  return window.localStorage
}
