# MultiAgent: Full Feature Implementation Plan

## Overview
Comprehensive feature additions to MultiAgent:
1. **Automations** - File watchers, cron, git hooks (Phases 1-2 DONE)
2. **CLI Integrations** - Docker, GitHub, Railway, Stripe via MCP servers
3. **Browser Preview** - Simple Browser + Puppeteer/Playwright
4. **Browser Extension Bridge** - Bidirectional Chrome extension communication
5. **Multi-Project Support** - Parallel workspace agents

## Status Summary

### Completed
- [x] Phase 0: Rebranding
- [x] Phase 1: Foundation (type definitions)
- [x] Phase 2: File Watcher Automation

### In Progress / Planned
- [x] Phase 3: Cron/Scheduled Automation
- [x] Phase 4: Git Hook Integration
- [ ] **Phase 8: CLI MCP Servers** (NEW)
- [ ] **Phase 9: Browser Preview System** (NEW)
- [ ] **Phase 10: Browser Extension Bridge** (NEW)
- [ ] Phase 5: Multi-Project Support
- [ ] Phase 6: Cross-Project Orchestration
- [ ] Phase 7: UI & Integration

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    AutomationManager                         │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        │
│  │FileWatcher   │ │CronScheduler │ │GitHookListener│        │
│  │Trigger ✓     │ │(pending)     │ │(pending)      │        │
│  └──────┬───────┘ └──────┬───────┘ └──────┬───────┘        │
└─────────┼────────────────┼────────────────┼─────────────────┘
          │                │                │
          v                v                v
┌─────────────────────────────────────────────────────────────┐
│                    WorkspaceManager (pending)                │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐ │
│  │ClineProvider   │  │ClineProvider   │  │ClineProvider   │ │
│  │(workspace-1)   │  │(workspace-2)   │  │(workspace-N)   │ │
│  └────────────────┘  └────────────────┘  └────────────────┘ │
└─────────────────────────────────────────────────────────────┘
          │
          v
┌─────────────────────────────────────────────────────────────┐
│              CrossProjectOrchestrator (pending)              │
│  - Coordinates tasks across workspaces                       │
│  - Manages shared context and dependencies                   │
└─────────────────────────────────────────────────────────────┘
```

## Configuration (YAML files)

### `.multiagent/automations.yaml`
```yaml
version: "1.0"
automations:
  - id: auto-test-runner
    name: Auto Test Runner
    trigger:
      type: file_watcher
      patterns: ["**/*.test.ts"]
      events: [save]
      debounceMs: 1000
    action:
      mode: test
      prompt: "Run tests for {{triggerFile}}"
      autoApprove: true

  - id: daily-review
    name: Daily Code Review
    trigger:
      type: cron
      schedule: "0 9 * * 1-5"
    action:
      mode: code
      prompt: "Review uncommitted changes"

  - id: pre-commit-lint
    trigger:
      type: git_hook
      hook: pre-commit
    action:
      mode: code
      prompt: "Lint staged files"
```

---

## Files Created/Modified

### New Files Created ✓

| File | Purpose | Status |
|------|---------|--------|
| `packages/types/src/automation.ts` | Automation type definitions | ✓ Complete |
| `packages/types/src/workspace.ts` | Multi-project types | ✓ Complete |
| `src/services/automation/AutomationManager.ts` | Main automation orchestrator | ✓ Complete |
| `src/services/automation/TriggerRegistry.ts` | Registry for all triggers | ✓ Complete |
| `src/services/automation/triggers/BaseTrigger.ts` | Abstract base class | ✓ Complete |
| `src/services/automation/triggers/FileWatcherTrigger.ts` | File change triggers | ✓ Complete |
| `src/services/automation/AutomationConfigLoader.ts` | YAML config loader | ✓ Complete |
| `src/services/automation/AutomationExecutor.ts` | Executes automation actions | ✓ Complete |
| `src/services/automation/index.ts` | Module exports | ✓ Complete |
| `src/services/automation/triggers/index.ts` | Trigger exports | ✓ Complete |
| `docs/automations.md` | Automation documentation | ✓ Complete |
| `.multiagent/automations.example.yaml` | Sample config | ✓ Complete |

### Files Modified ✓

| File | Changes | Status |
|------|---------|--------|
| `packages/types/src/task.ts` | Extended TaskLike with automation fields | ✓ Complete |
| `packages/types/src/index.ts` | Export new types | ✓ Complete |
| `README.md` | Updated with automation features | ✓ Complete |
| `MULTIAGENT_CONTINUATION.md` | Updated with progress | ✓ Complete |

### Files Pending

| File | Purpose | Status |
|------|---------|--------|
| `src/services/automation/triggers/CronTrigger.ts` | Scheduled triggers | ✓ Complete |
| `src/services/automation/triggers/GitHookTrigger.ts` | Git event triggers | ✓ Complete |
| `src/services/workspace/WorkspaceManager.ts` | Per-workspace providers | ✓ Complete |
| `src/services/workspace/WorkspaceProvider.ts` | Workspace context provider | ✓ Complete |
| `src/services/workspace/index.ts` | Module exports | ✓ Complete |
| `src/services/workspace/CrossProjectOrchestrator.ts` | Multi-project coordination | Pending |
| `src/extension.ts` | Initialize AutomationManager | Pending |

---

## Implementation Phases

### Phase 1: Foundation ✓ COMPLETE
- [x] Create type definitions in `packages/types/src/automation.ts`
- [x] Create type definitions in `packages/types/src/workspace.ts`
- [x] Implement `AutomationConfigLoader.ts` (YAML parsing)
- [x] Add `automationId` and `workspacePath` to Task types

### Phase 2: File Watcher Automation ✓ COMPLETE
- [x] Implement `BaseTrigger.ts` abstract class
- [x] Implement `FileWatcherTrigger.ts` using `vscode.workspace.createFileSystemWatcher`
- [x] Implement `TriggerRegistry.ts`
- [x] Implement `AutomationExecutor.ts`
- [x] Implement `AutomationManager.ts`

### Phase 3: Cron/Scheduled Automation ✓ COMPLETE
- [x] Add `node-cron` dependency
- [x] Implement `CronTrigger.ts`
- [x] Add cron expression validation

### Phase 4: Git Hook Integration ✓ COMPLETE
- [x] Implement `GitHookTrigger.ts`
- [x] Integrate with VS Code Git extension API
- [x] Add branch filtering

### Phase 5: Multi-Project Support (PENDING)
- [ ] Implement `WorkspaceManager.ts`
- [ ] Create per-workspace ClineProvider instances
- [ ] Add workspace selector UI in webview
- [ ] Context isolation between workspaces

### Phase 6: Cross-Project Orchestration (PENDING)
- [ ] Implement `CrossProjectOrchestrator.ts`
- [ ] Task dependency ordering
- [ ] Shared context propagation

### Phase 7: UI & Integration (PENDING)
- [ ] Wire up AutomationManager in extension.ts
- [ ] Add VS Code settings for automation configuration
- [ ] Visual automation builder in webview
- [ ] Automation templates
- [ ] Execution history/logs

---

## Dependencies

### Already Available
- `yaml` - YAML parsing (already in project)
- `zod` - Schema validation (already in project)
- `ignore` - Gitignore-style pattern matching (already in project)

### To Add
```json
{
  "dependencies": {
    "node-cron": "^3.0.3"
  },
  "devDependencies": {
    "@types/node-cron": "^3.0.11"
  }
}
```

## VS Code Settings to Add

```json
{
  "multi-agent.automations.enabled": true,
  "multi-agent.automations.configPath": ".multiagent/automations.yaml",
  "multi-agent.multiProject.enabled": false,
  "multi-agent.multiProject.autoCreateAgents": true
}
```

---

---

## Phase 8: CLI MCP Servers (NEW)

### Architecture
Use MCP servers for Docker, GitHub CLI, Railway, and Stripe - leveraging existing MCP infrastructure.

```
┌─────────────────────────────────────────────────────────────┐
│                      McpHub (existing)                       │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        │
│  │ Docker MCP   │ │ GitHub MCP   │ │ Railway MCP  │        │
│  │ Server       │ │ Server       │ │ Server       │        │
│  └──────────────┘ └──────────────┘ └──────────────┘        │
│  ┌──────────────┐                                          │
│  │ Stripe MCP   │  (bundled, auto-configured)              │
│  │ Server       │                                          │
│  └──────────────┘                                          │
└─────────────────────────────────────────────────────────────┘
```

### Implementation

**Option A: Use existing npm MCP servers (Recommended)**
Reference: [mcp-server-docker-ts](https://github.com/HelloDimension/mcp-server-docker-ts)

```json
// Default MCP config bundled with extension
{
  "mcpServers": {
    "docker": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@anthropic/mcp-server-docker"],
      "disabled": false
    },
    "github": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": { "GITHUB_TOKEN": "${secret:github_token}" }
    },
    "stripe": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "mcp-server-stripe"],
      "env": { "STRIPE_API_KEY": "${secret:stripe_api_key}" }
    }
  }
}
```

**Option B: Bundle custom MCP servers**

### Files to Create
| File | Purpose |
|------|---------|
| `src/services/mcp/bundled/docker-mcp.ts` | Docker MCP server wrapper |
| `src/services/mcp/bundled/github-mcp.ts` | GitHub CLI MCP server |
| `src/services/mcp/bundled/railway-mcp.ts` | Railway deployment MCP |
| `src/services/mcp/bundled/stripe-mcp.ts` | Stripe API MCP server |
| `src/services/mcp/BundledMcpManager.ts` | Manages bundled servers |

### Files to Modify
| File | Changes |
|------|---------|
| `src/services/mcp/McpHub.ts` | Add bundled server auto-registration |
| `src/shared/ExtensionSettings.ts` | Add CLI integration settings |

### MCP Server Tools to Expose

**Docker MCP:**
- `docker_ps` - List containers
- `docker_logs` - Get container logs
- `docker_exec` - Execute command in container
- `docker_build` - Build image
- `docker_compose_up/down` - Compose operations

**GitHub MCP:**
- `gh_repo_list` - List repositories
- `gh_issue_create/list` - Issue management
- `gh_pr_create/list/merge` - PR operations
- `gh_workflow_run` - Trigger workflows
- `gh_release_create` - Create releases

**Railway MCP:**
- `railway_deploy` - Deploy project
- `railway_logs` - Get deployment logs
- `railway_env` - Manage environment variables
- `railway_status` - Check deployment status

**Stripe MCP:**
- `stripe_customers_list/create` - Customer management
- `stripe_payments_list` - Payment history
- `stripe_subscriptions_list` - Subscription management
- `stripe_invoices_list` - Invoice retrieval

---

## Phase 9: Browser Preview System (NEW)

### Architecture
Dual browser modes: Simple Browser (quick localhost preview) + Puppeteer (full automation)

```
┌─────────────────────────────────────────────────────────────┐
│                   BrowserPreviewManager                      │
│  ┌──────────────────────┐  ┌──────────────────────────────┐ │
│  │ SimpleBrowserPanel   │  │ PuppeteerBrowserPanel        │ │
│  │ (vscode.SimpleBrowser)│  │ (headless + screenshots)     │ │
│  └──────────────────────┘  └──────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
          │                            │
          v                            v
┌──────────────────┐        ┌──────────────────────────────┐
│ Quick localhost  │        │ Full automation:              │
│ preview (port    │        │ - Navigate, click, type      │
│ 3000, 5173, etc) │        │ - Screenshot capture         │
│                  │        │ - DOM inspection             │
│                  │        │ - Network monitoring         │
└──────────────────┘        └──────────────────────────────┘
```

### Implementation

**Simple Browser (VS Code built-in)**
```typescript
// Use VS Code's Simple Browser command
vscode.commands.executeCommand('simpleBrowser.show', 'http://localhost:3000')
```

**Puppeteer Integration (enhance existing)**
- Already exists: `src/services/browser/BrowserSession.ts`
- Enhance with dedicated preview panel

### Files to Create
| File | Purpose |
|------|---------|
| `src/services/browser/BrowserPreviewManager.ts` | Manages both browser modes |
| `src/services/browser/SimpleBrowserPanel.ts` | Simple Browser wrapper |
| `src/core/webview/BrowserPreviewPanel.ts` | Puppeteer preview webview |

### Files to Modify
| File | Changes |
|------|---------|
| `src/services/browser/BrowserSession.ts` | Add preview mode |
| `src/core/webview/BrowserSessionPanelManager.ts` | Integrate preview |
| `webview-ui/src/components/chat/BrowserSessionRow.tsx` | Add preview controls |

### Commands to Add
- `multi-agent.openSimpleBrowser` - Quick localhost preview
- `multi-agent.openBrowserPreview` - Full Puppeteer preview
- `multi-agent.captureBrowserScreenshot` - Capture for AI context

---

## Phase 10: Browser Extension Bridge (NEW)

### Architecture
Bidirectional communication between VS Code and Chrome extensions via WebSocket + Native Messaging.

```
┌─────────────────────────────────────────────────────────────┐
│                    VS Code Extension                         │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           BrowserExtensionBridge                      │   │
│  │  - WebSocket server (port 54546)                      │   │
│  │  - Message handlers                                    │   │
│  │  - State sync                                          │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↕ WebSocket
┌─────────────────────────────────────────────────────────────┐
│                  Chrome Extension (companion)                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  - Content script (page context)                      │   │
│  │  - Background service worker                          │   │
│  │  - chrome.debugger API for control                    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### Communication Protocol
Reference: [chrome-native-bridge](https://github.com/JosephusPaye/chrome-native-bridge)

```typescript
// Message types
interface BridgeMessage {
  type: 'page_context' | 'dom_snapshot' | 'screenshot' |
        'navigate' | 'click' | 'type' | 'scroll'
  payload: any
  requestId?: string
}
```

### Files to Create
| File | Purpose |
|------|---------|
| `src/services/browser-bridge/BrowserExtensionBridge.ts` | WebSocket server |
| `src/services/browser-bridge/BridgeMessageHandler.ts` | Message processing |
| `src/services/browser-bridge/types.ts` | Bridge type definitions |
| `chrome-extension/manifest.json` | Companion extension manifest |
| `chrome-extension/background.js` | Service worker |
| `chrome-extension/content.js` | Content script |

### Files to Modify
| File | Changes |
|------|---------|
| `src/extension.ts` | Initialize bridge service |
| `src/services/browser/BrowserSession.ts` | Add bridge integration |

### Capabilities

**Read from Browser:**
- Current page URL and title
- DOM snapshot (serialized)
- Screenshot capture
- Selected text
- Console logs
- Network requests

**Control Browser:**
- Navigate to URL
- Click elements (by selector/coordinates)
- Type text
- Scroll page
- Execute JavaScript
- Take screenshots

### Security
- Origin validation (only allow localhost connections)
- Token-based authentication
- Message signing for sensitive operations

---

## Notes
- All features are opt-in (backward compatible)
- Single-workspace behavior preserved when multi-project disabled
- Existing task history and settings unaffected
- Configuration files are version-controllable
- TypeScript compiles successfully with all changes

## References
- [MCP TypeScript SDK](https://github.com/modelcontextprotocol/typescript-sdk)
- [Docker MCP Server](https://github.com/HelloDimension/mcp-server-docker-ts)
- [Chrome Native Bridge](https://github.com/JosephusPaye/chrome-native-bridge)
- [Puppeteer](https://pptr.dev/)
