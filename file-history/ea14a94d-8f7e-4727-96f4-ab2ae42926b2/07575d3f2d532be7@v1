-- Migration: Add username and terms_accepted_at columns to users table
-- Date: 2025-12-23
-- Description: Adds username requirement and T&C acceptance tracking for leaderboard

-- Step 1: Add columns (nullable initially for existing users)
ALTER TABLE users ADD COLUMN IF NOT EXISTS username VARCHAR(30);
ALTER TABLE users ADD COLUMN IF NOT EXISTS terms_accepted_at TIMESTAMP;

-- Step 2: Generate usernames for existing users based on their ID
-- Uses format 'User_' + first 6 chars of UUID to avoid conflicts
UPDATE users
SET username = 'User_' || SUBSTRING(id::text, 1, 6)
WHERE username IS NULL;

-- Step 3: Make username NOT NULL and UNIQUE
ALTER TABLE users ALTER COLUMN username SET NOT NULL;

-- Step 4: Create unique index (case-insensitive)
CREATE UNIQUE INDEX IF NOT EXISTS idx_users_username_lower ON users(LOWER(username));

-- Step 5: Update leaderboard_scores to use usernames instead of generated names
UPDATE leaderboard_scores ls
SET anonymous_name = u.username
FROM users u
WHERE ls.user_id = u.id;

-- Verify migration
SELECT
    (SELECT COUNT(*) FROM users WHERE username IS NOT NULL) as users_with_username,
    (SELECT COUNT(*) FROM users) as total_users,
    (SELECT COUNT(*) FROM leaderboard_scores) as leaderboard_entries;
