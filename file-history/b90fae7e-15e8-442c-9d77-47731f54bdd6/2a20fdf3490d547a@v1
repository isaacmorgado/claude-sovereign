/**
 * SPLICE CEP Browser Simulation
 * Mocks Adobe CEP environment and Backend APIs for full feature testing in browser.
 */

(function () {
    console.log('%c [SPLICE SIMULATION] Initializing... ', 'background: #00d1b2; color: black; font-weight: bold;');

    // MOCK REQUIRE (Fixes main.js ReferenceError)
    window.require = function (moduleName) {
        console.log(`%c[Mock Require] ${moduleName}`, 'color: #888');
        if (moduleName === 'premierepro') {
            return {
                Project: {
                    getActiveProject: async () => ({
                        getRootItem: async () => ({ children: [] })
                    })
                }
            };
        }
        if (moduleName === 'uxp') {
            return {
                storage: {
                    localFileSystem: {
                        getTemporaryFolder: async () => ({
                            createFile: async () => ({ nativePath: '/tmp/mock_splice_export' })
                        }),
                        getEntryWithUrl: async () => true // Simulate file exists
                    }
                }
            };
        }
        return {};
    };

    // ============================================================================
    // API CALL TRACKING & MOCKING
    // ============================================================================
    const apiCalls = [];

    // Mock fetch for templates and data
    const mockState = {
        vocalIsolation: { status: 'idle', progress: 0 },
        music: { tracks: [] }
    };

    window.fetch = async (url, options) => {
        console.log(`%c[Mock Fetch] ${url}`, 'color: #f39c12');

        await new Promise(r => setTimeout(r, 50));

        // VOCAL ISOLATION
        if (url.includes('/vocal-isolation/process')) {
            mockState.vocalIsolation.status = 'processing';
            mockState.vocalIsolation.progress = 0;
            return {
                ok: true,
                json: async () => ({ jobId: 'job_123' })
            };
        }
        if (url.includes('/vocal-isolation/status')) {
            if (mockState.vocalIsolation.progress < 100) {
                mockState.vocalIsolation.progress += 25;
            } else {
                mockState.vocalIsolation.status = 'completed';
            }
            return {
                ok: true,
                json: async () => ({
                    status: mockState.vocalIsolation.status,
                    progress: mockState.vocalIsolation.progress,
                    downloadUrl: mockState.vocalIsolation.status === 'completed' ? '/tmp/isolated_vocal.wav' : null
                })
            };
        }

        // MULTITRACK ANALYZE
        if (url.includes('/multitrack/analyze')) {
            return {
                ok: true,
                json: async () => ({
                    speakers: [
                        { name: 'Speaker 1', percentage: 45, confidence: 0.98 },
                        { name: 'Speaker 2', percentage: 35, confidence: 0.95 },
                        { name: 'Wide Shot', percentage: 20, confidence: 0.92 }
                    ],
                    decisionList: Array.from({ length: 10 }, (_, i) => ({
                        id: i,
                        start: i * 10,
                        duration: 10,
                        speakerId: i % 2,
                        track: i % 2 === 0 ? 'V1' : 'V2'
                    }))
                })
            };
        }

        // MUSIC MOODS & GENERATION
        if (url.includes('/music/moods')) {
            return {
                ok: true,
                json: async () => ({
                    moods: ['Cinematic', 'Upbeat', 'Chill', 'Aggressive', 'Suspenseful'],
                    genres: ['Electronic', 'Rock', 'Ambient', 'Hip Hop']
                })
            };
        }
        if (url.includes('/music/generate')) {
            return {
                ok: true,
                json: async () => ({
                    id: 'music_999',
                    url: '/tmp/generated_music.mp3',
                    bpm: 120,
                    key: 'C Maj'
                })
            };
        }

        // CAPTIONS TEMPLATES
        if (url.includes('/captions/templates')) {
            return {
                ok: true,
                json: async () => ({
                    templates: [
                        { id: 'mrbeast', name: 'MrBeast', description: 'Bold, uppercase' },
                        { id: 'hormozi', name: 'Hormozi', description: 'Clean, yellow highlight' },
                        { id: 'gaming', name: 'Gaming', description: 'Neon glow' }
                    ]
                })
            };
        }

        // GENERIC SUCCESS
        console.warn(`%c[Fetch Mock] Unhandled URL: ${url}`, 'color: #e74c3c');
        return {
            ok: true,
            status: 200,
            json: async () => ({ status: 'mocked_success', captions: [], keywords: [] })
        };
    };

    // ============================================================================
    // ADOBE JSX CALLS
    // ============================================================================
    window.jsx = {
        call: async (func, ...args) => {
            console.log(`%c[JSX Call] ${func}`, 'color: #3498db', args);

            if (func === 'getActiveSequenceName') return 'SaaS_Release_Final_v1';
            if (func === 'getTrackCount') return 4;
            if (func === 'getSequenceDuration') return '00:05:00:00';
            if (func === 'getMarkers') return [];

            // Simulation of heavy JSX operations
            if (func === 'processMarkers' || func === 'createDecisionList') {
                await new Promise(r => setTimeout(r, 200));
                return true;
            }

            return true;
        }
    };

    // ============================================================================
    // THEME & AUTH STATUS
    // ============================================================================
    window.authStatus = {
        isLoggedIn: true,
        user: { name: 'SaaS Auditor', tier: 'pro' }
    };
    window._apiCallTracker = {
        calls: [],
        clear: function () { this.calls = []; },
        log: function (endpoint, method, body) {
            this.calls.push({
                endpoint,
                method,
                body,
                timestamp: Date.now()
            });
        },
        getCallsTo: function (endpoint) {
            return this.calls.filter(c => c.endpoint.includes(endpoint));
        },
        getLastCall: function () {
            return this.calls[this.calls.length - 1];
        },
        wasCalledWith: function (endpoint, bodyContains) {
            return this.calls.some(c =>
                c.endpoint.includes(endpoint) &&
                (!bodyContains || (c.body && JSON.stringify(c.body).includes(bodyContains)))
            );
        }
    };

    // ============================================================================
    // MODULE INITIALIZATION TRACKING
    // ============================================================================
    window._moduleTracker = {
        initialized: {},
        mark: function (moduleName) {
            this.initialized[moduleName] = Date.now();
        },
        isInitialized: function (moduleName) {
            return !!this.initialized[moduleName];
        },
        getAll: function () {
            return Object.keys(this.initialized);
        },
        reset: function () {
            this.initialized = {};
        }
    };

    // ============================================================================
    // UI STATE TRACKING (for verifying UI updates)
    // ============================================================================
    window._uiStateTracker = {
        events: [],
        log: function (component, action, data) {
            this.events.push({ component, action, data, timestamp: Date.now() });
        },
        getEventsFor: function (component) {
            return this.events.filter(e => e.component === component);
        },
        clear: function () { this.events = []; }
    };

    // ============================================================================
    // 0. MOCK window.__adobe_cep__ (MUST BE FIRST)
    // ============================================================================
    // This enables CSInterface.js to work in browser mode
    if (!window.__adobe_cep__) {
        window.__adobe_cep__ = {
            evalScript: function (script, callback) {
                console.log(`%c[JSX Mock] ${script.substring(0, 60)}${script.length > 60 ? '...' : ''}`, 'color: #aaa');

                const cmd = script.split('(')[0];

                setTimeout(() => {
                    let result = 'true';

                    // Core mocks
                    if (cmd === 'checkSequenceOpen') {
                        result = 'true';
                    } else if (cmd === 'getActiveSequence') {
                        result = JSON.stringify({
                            name: 'Mock Sequence 01',
                            id: 'seq-123',
                            audioPath: '/mock/exported/audio.wav',
                            treePath: '/Mock Project/Mock Sequence 01',
                            duration: 120.0
                        });
                    } else if (cmd === 'exportSequenceAudioForAnalysis') {
                        result = JSON.stringify({
                            outputPath: '/mock/temp/exported_audio.wav',
                            success: true
                        });
                    } else if (cmd === 'getFirstClipAudioPath') {
                        result = JSON.stringify({ path: '/mock/source/clip_01.wav' });
                    } else if (cmd === 'getSequenceDuration') {
                        result = JSON.stringify({ duration: 120.0 });
                    } else if (cmd === 'getVersion') {
                        result = '6.0.8-mock';
                    } else if (cmd === 'buildSequenceFromCutList') {
                        console.log('[JSX Mock] Building sequence from cut list...');
                        result = JSON.stringify({ success: true, stats: { clipsInserted: 15 } });
                    } else if (cmd === 'getSequenceSettings') {
                        result = JSON.stringify({
                            videoFrameRate: 24,
                            videoFrameWidth: 1920,
                            videoFrameHeight: 1080
                        });
                    }

                    if (callback) callback(result);
                }, 50);
            },
            getHostEnvironment: function () {
                return JSON.stringify({
                    appName: 'PPRO',
                    appVersion: '25.0.0',
                    appLocale: 'en_US',
                    isAppOffline: false
                });
            },
            getSystemPath: function () { return '/mock/path'; },
            openURLInDefaultBrowser: function (url) { window.open(url, '_blank'); }
        };
        console.log('[SPLICE SIMULATION] window.__adobe_cep__ mock installed');
    }

    // ============================================================================
    // 1. GLOBAL STATE MOCKS
    // ============================================================================
    window.spliceState = {
        currentVideoPath: '/mock/path/to/video.mp4',
        activeSequence: {
            name: 'Mock Sequence 01',
            id: 'seq-123',
            projectItem: {
                treePath: '/Mock Project/Mock Sequence 01'
            }
        },
        lastTranscript: {
            words: Array.from({ length: 50 }, (_, i) => ({
                word: ['Hello', 'world', 'this', 'is', 'a', 'mock', 'transcript', 'generated', 'for', 'testing'][i % 10],
                start: i * 0.5,
                end: i * 0.5 + 0.4
            })),
            text: "Hello world this is a mock transcript generated for testing. ".repeat(5),
            segments: [
                { start: 0, end: 10, text: "Scene 1: Introduction to the mock video." },
                { start: 10, end: 20, text: "Scene 2: Demonstrating feature capabilities." },
                { start: 20, end: 30, text: "Scene 3: Conclusion and happy ending." }
            ]
        }
    };

    // Helper to get random ID
    const uuid = () => 'mock-' + Math.random().toString(36).substr(2, 9);

    // ============================================================================
    // 2. FAVICON INJECTION
    // ============================================================================
    const link = document.createElement('link');
    link.rel = 'icon';
    link.href = 'data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAA==';
    document.head.appendChild(link);

    // ============================================================================
    // 3. CSINTERFACE & JSX MOCKS
    // ============================================================================
    if (!window.CSInterface) {
        window.CSInterface = function () { };
        window.CSInterface.prototype.evalScript = function (script, callback) {
            console.log(`%c[JSX Mock] ${script.substring(0, 50)}${script.length > 50 ? '...' : ''}`, 'color: #aaa');

            // Normalize script call
            const cmd = script.split('(')[0];

            setTimeout(() => {
                let result = 'true';

                // --- Core Mocks ---
                if (cmd === 'checkSequenceOpen') {
                    // Return 'true' string as expected by main.js checkSequenceOpen()
                    result = 'true';
                } else if (cmd === 'getActiveSequence') {
                    result = JSON.stringify({
                        name: 'Mock Sequence 01',
                        id: 'seq-123',
                        audioPath: '/mock/exported/audio.wav',
                        treePath: '/Mock Project/Mock Sequence 01',
                        duration: 120.0
                    });
                } else if (cmd === 'exportSequenceAudioForAnalysis') {
                    result = JSON.stringify({
                        outputPath: '/mock/temp/exported_audio.wav',
                        success: true
                    });
                } else if (cmd === 'getFirstClipAudioPath') {
                    result = JSON.stringify({ path: '/mock/source/clip_01.wav' });
                } else if (cmd === 'getSequenceDuration') {
                    result = JSON.stringify({ duration: 120.0 });
                }

                // --- Multitrack Mocks ---
                else if (cmd === 'importFiles') {
                    console.log('[JSX Mock] Imported files');
                    result = 'true';
                } else if (cmd === 'buildSequenceFromCutList') {
                    console.log('[JSX Mock] Building sequence from cut list...');
                    result = JSON.stringify({ success: true, stats: { clipsInserted: 15 } });
                }

                // --- Captions Mocks ---
                else if (cmd === 'createMarker') {
                    console.log('[JSX Mock] Created marker');
                    result = 'true';
                }

                // --- System Mocks ---
                else if (cmd === 'getVersion') {
                    result = '1.0.0-mock';
                }

                // --- Missing Mocks Added for Verification ---
                else if (cmd === 'getAllProjectItems') {
                    result = JSON.stringify([
                        { name: 'Mock Sequence 01', type: 1, treePath: '/Mock Project/Mock Sequence 01' },
                        { name: 'Footage.mp4', type: 2, treePath: '/Mock Project/Footage.mp4' }
                    ]);
                } else if (cmd === 'addChapterMarker') {
                    console.log(`[JSX Mock] Added chapter marker`);
                    result = 'true';
                } else if (cmd === 'addZoomMarker') {
                    console.log(`[JSX Mock] Added zoom marker`);
                    result = 'true';
                } else if (cmd === 'deleteMarkersByName') {
                    console.log(`[JSX Mock] Deleted markers`);
                    result = 'true';
                } else if (cmd === 'getVideoFrameRateInSeconds') {
                    result = '0.041666'; // 24fps
                } else if (cmd === 'razorSequenceAtFramesArray') {
                    console.log(`[JSX Mock] Razored sequence at frames`);
                    result = 'true';
                } else if (cmd === 'cloneSequence') {
                    console.log(`[JSX Mock] Cloned sequence`);
                    result = 'true';
                } else if (cmd === 'undo') {
                    console.log(`[JSX Mock] Undo performed`);
                    result = 'true';
                } else if (cmd === 'seekToTime') {
                    console.log(`[JSX Mock] Seek to time`);
                    result = 'true';
                } else if (cmd === 'getSequenceSettings') {
                    result = JSON.stringify({
                        videoFrameRate: 24,
                        videoFrameWidth: 1920,
                        videoFrameHeight: 1080
                    });
                } else if (cmd === 'getNumTracks') {
                    result = '4';
                } else if (cmd === 'razorSequenceAtSeconds') {
                    console.log(`[JSX Mock] Razored sequence at seconds`);
                    result = 'true';
                } else if (cmd === 'getClipsInTrack') {
                    result = JSON.stringify([]);
                } else if (cmd === 'removeClipByIndex') {
                    console.log(`[JSX Mock] Removed clip`);
                    result = 'true';
                }

                if (callback) {
                    // Start of JSON if applicable
                    if (typeof result === 'object') {
                        callback(JSON.stringify(result));
                    } else {
                        callback(result);
                    }
                }
            }, 100);
        };

        window.CSInterface.prototype.getHostEnvironment = function () {
            return JSON.stringify({
                appId: 'PPRO',
                appVersion: '24.0.0',
                appLocale: 'en_US',
                appSkinInfo: {
                    panelBackgroundColor: { color: { red: 30, green: 30, blue: 30 } },
                    baseFontSize: 12
                }
            });
        };

        // Mock active sequence state on window
        window.isSequenceOpen = true;
    }

    // ============================================================================
    // 5. MOCK STATE (MUSIC)
    // ============================================================================
    window.mockMusicLibrary = [
        { id: 'song-1', title: 'Cyberpunk City', style: 'Electronic', duration: 120, mood: 'Energetic' },
        { id: 'song-2', title: 'Summer Breeze', style: 'Acoustic', duration: 180, mood: 'Relaxed' }
    ];
    window.mockJobRegistry = new Map();

    // ============================================================================
    // 6. FETCH API MOCKS (BACKEND)
    // ============================================================================
    const originalFetch = window.fetch;
    window.fetch = async function (url, options) {
        console.log(`%c[Fetch Mock] ${options?.method || 'GET'} ${url}`, 'color: #4ecdc4');

        // Track API call for testing
        let parsedBody = null;
        if (options?.body) {
            try {
                parsedBody = JSON.parse(options.body);
            } catch (e) {
                parsedBody = options.body;
            }
        }
        window._apiCallTracker.log(url, options?.method || 'GET', parsedBody);

        // Helper to delay response
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        await delay(300); // Simulate network latency

        // -------------------------
        // CORE ROUTES
        // -------------------------
        if (url.includes('/silences-rms')) {
            // Check for test scenario override
            if (window._mockScenario === 'empty_sequence') {
                return new Response(JSON.stringify({ silences: [] }), { status: 200 });
            }
            if (window._mockScenario === 'very_long_video') {
                const silences = Array.from({ length: 500 }, (_, i) => ({
                    start: i * 10 + 5,
                    end: i * 10 + 7
                }));
                return new Response(JSON.stringify({ silences }), { status: 200 });
            }
            return new Response(JSON.stringify({
                silences: [
                    { start: 5.5, end: 7.2 },
                    { start: 15.0, end: 16.5 },
                    { start: 45.2, end: 48.0 }
                ]
            }), { status: 200 });
        }

        if (url.includes('/analyze')) { // Takes detection
            // Check for test scenario override
            if (window._mockScenario === 'empty_sequence') {
                return new Response(JSON.stringify({ takes: [] }), { status: 200 });
            }
            return new Response(JSON.stringify({
                takes: [
                    { start: 10, end: 20, score: 0.85, label: 'Take 1' },
                    { start: 22, end: 32, score: 0.92, label: 'Take 2 (Best)' },
                    { start: 35, end: 45, score: 0.76, label: 'Take 3' }
                ]
            }), { status: 200 });
        }

        if (url.includes('/cut-list')) {
            return new Response(JSON.stringify({
                version: '3.5',
                source: {
                    name: 'Mock Sequence 01',
                    path: '/mock/path/to/sequence',
                    duration: 120
                },
                segments: [
                    { type: 'speech', inPoint: 0, outPoint: 5.5, takeNumber: null },
                    { type: 'silence', inPoint: 5.5, outPoint: 7.2 },
                    { type: 'best_take', inPoint: 10, outPoint: 20, takeNumber: 1, colorHint: 'cerulean' },
                    { type: 'speech', inPoint: 20, outPoint: 45.2 },
                    { type: 'silence', inPoint: 45.2, outPoint: 48.0 }
                ]
            }), { status: 200 });
        }

        // -------------------------
        // MULTITRACK
        // -------------------------
        if (url.includes('/multitrack/auto-balance')) {
            return new Response(JSON.stringify({
                metadata: {
                    speakerPercentages: { 'Speaker 1': 45, 'Speaker 2': 55 },
                    averageShotDuration: 3.5
                },
                levels: { 'Speaker 1': -14, 'Speaker 2': -16 },
                finalError: 1.2
            }), { status: 200 });
        }

        if (url.includes('/multitrack')) {
            return new Response(JSON.stringify({
                decisions: Array.from({ length: 20 }, (_, i) => ({
                    startTime: i * 5,
                    endTime: (i + 1) * 5,
                    speakerName: i % 2 === 0 ? 'Speaker 1' : 'Speaker 2',
                    speakerIndex: i % 2,
                    isWideShot: i % 5 === 0,
                    reason: 'Active speaker'
                })),
                metadata: {
                    speakerPercentages: { 'Speaker 1': 40, 'Speaker 2': 40, 'Wide': 20 },
                    wideShotPercentage: 20,
                    averageShotDuration: 5.0
                }
            }), { status: 200 });
        }

        // -------------------------
        // CAPTIONS
        // -------------------------
        if (url.includes('/captions/templates')) {
            return new Response(JSON.stringify({
                templates: [
                    { id: 'mrbeast', name: 'MrBeast', description: 'Bold, uppercase, colorful' },
                    { id: 'hormozi', name: 'Hormozi', description: 'Clean, yellow highlight' },
                    { id: 'gaming', name: 'Gaming', description: 'Neon glow, glitch effects' },
                    { id: 'corporate', name: 'Corporate', description: 'Subtle, professional' },
                    { id: 'karaoke', name: 'Karaoke', description: 'Word-by-word highlight' }
                ]
            }), { status: 200 });
        }

        if (url.includes('/captions/animate')) {
            return new Response(JSON.stringify({
                totalCaptions: 15,
                totalWords: 120,
                duration: 60,
                keywords: ['mock', 'test', 'feature'],
                captions: Array.from({ length: 15 }, (_, i) => ({
                    start: i * 4,
                    end: i * 4 + 3.5,
                    text: `This is mock caption line ${i + 1}`,
                    words: [
                        { word: "This", start: i * 4, end: i * 4 + 0.5 },
                        { word: "is", start: i * 4 + 0.5, end: i * 4 + 1 },
                        { word: "mock", start: i * 4 + 1, end: i * 4 + 2, isKeyword: true },
                        { word: "caption", start: i * 4 + 2, end: i * 4 + 3 }
                    ]
                }))
            }), { status: 200 });
        }

        if (url.includes('/captions/apply-template')) {
            return new Response(JSON.stringify({
                captions: JSON.parse(options.body).captionData.captions
            }), { status: 200 });
        }

        if (url.includes('/captions/export') || url.includes('/export/captions')) {
            return new Response(JSON.stringify({
                content: "Mock Export Content",
                data: { mock: "mogrt data" }
            }), { status: 200 });
        }

        // -------------------------
        // TEXT EDITOR
        // -------------------------
        if (url.includes('/text-edit/prepare')) {
            return new Response(JSON.stringify({
                editableTranscript: {
                    plainText: "Hello world this is a mock transcript.\nIt has multiple lines.\nYou can edit this.",
                    totalWords: 15,
                    duration: 10
                }
            }), { status: 200 });
        }

        if (url.includes('/text-edit/search')) {
            const body = JSON.parse(options.body);
            return new Response(JSON.stringify({
                matches: [{ start: 0, text: body.searchText }],
                totalMatches: 1
            }), { status: 200 });
        }

        if (url.includes('/text-edit/preview')) {
            return new Response(JSON.stringify({
                summary: { deletions: 1, reorderings: 0 },
                impact: { percentageRemoved: 5 },
                changes: [{ type: 'deletion', description: 'Removed text', timeRange: '0:00-0:05' }]
            }), { status: 200 });
        }

        if (url.includes('/text-edit/apply')) {
            return new Response(JSON.stringify({
                stats: { deletions: 1 },
                operations: []
            }), { status: 200 });
        }

        if (url.includes('/text-edit/cut-list')) {
            return new Response(JSON.stringify({
                cutList: { segments: [] },
                summary: { segmentCount: 5 }
            }), { status: 200 });
        }

        // -------------------------
        // SOCIAL REFRAME
        // -------------------------
        if (url.includes('/reframe/platforms')) {
            return new Response(JSON.stringify({
                platforms: [
                    { id: 'tiktok', name: 'TikTok', aspectRatio: 'portrait', maxDuration: 180 },
                    { id: 'reels', name: 'Instagram Reels', aspectRatio: 'portrait', maxDuration: 90 },
                    { id: 'shorts', name: 'YouTube Shorts', aspectRatio: 'portrait', maxDuration: 60 },
                    { id: 'instagram_feed', name: 'Instagram Feed', aspectRatio: 'square', maxDuration: 60 },
                    { id: 'linkedin', name: 'LinkedIn', aspectRatio: 'landscape', maxDuration: 600 },
                    { id: 'twitter', name: 'X/Twitter', aspectRatio: 'landscape', maxDuration: 140 },
                    { id: 'facebook', name: 'Facebook', aspectRatio: 'square', maxDuration: 240 },
                    { id: 'pinterest', name: 'Pinterest', aspectRatio: 'portrait_2_3', maxDuration: 60 }
                ],
                aspectRatios: [
                    { id: 'portrait', name: 'Portrait (9:16)', ratio: 0.5625 },
                    { id: 'square', name: 'Square (1:1)', ratio: 1.0 },
                    { id: 'portrait_4_5', name: 'Portrait (4:5)', ratio: 0.8 },
                    { id: 'portrait_2_3', name: 'Portrait (2:3)', ratio: 0.667 },
                    { id: 'landscape', name: 'Landscape (16:9)', ratio: 1.778 }
                ]
            }), { status: 200 });
        }

        if (url.includes('/reframe/safe-zones')) {
            return new Response(JSON.stringify({
                safeZone: { top: 0.1, bottom: 0.2, left: 0.05, right: 0.15 }
            }), { status: 200 });
        }

        if (url.includes('/reframe/analyze')) {
            return new Response(JSON.stringify({
                status: 'success',
                tracksFound: [{ id: 1, name: 'Main Subject', confidence: 0.95 }],
                best_crop: { x: 100, y: 0, width: 607, height: 1080 }, // Support both formats
                faceTracking: { tracksFound: 1, tracks: [{ positions: [{ x: 0.4, y: 0.3, width: 0.2, height: 0.2 }] }] },
                videoInfo: { width: 1920, height: 1080, duration: 60 },
                suggestions: {
                    portrait: { method: 'face-track', static: true, crop: { x: 0.25, y: 0, width: 0.5625, height: 1 } },
                    square: { method: 'center', static: true, crop: { x: 0.2, y: 0, width: 1, height: 1 } }
                }
            }), { status: 200 });
        }

        if (url.includes('/reframe/export')) {
            return new Response(JSON.stringify({
                status: 'success',
                totalFormats: 1,
                exports: [{
                    name: 'TikTok',
                    platform: 'TikTok',
                    dimensions: { width: 1080, height: 1920 },
                    ffmpegFilter: 'crop=...',
                    status: 'ready',
                    crop: { x: 100, y: 0, width: 607, height: 1080 }
                }]
            }), { status: 200 });
        }

        // -------------------------
        // MUSIC (STATEFUL)
        // -------------------------
        if (url.includes('/music/library')) {
            return new Response(JSON.stringify(window.mockMusicLibrary), { status: 200 });
        }

        if (url.includes('/music/credits')) {
            return new Response(JSON.stringify({
                remaining: 50,
                total: 100
            }), { status: 200 });
        }

        if (url.includes('/music/identify')) {
            return new Response(JSON.stringify({
                identified: true,
                title: 'Never Gonna Give You Up',
                artist: 'Rick Astley',
                bpm: 113,
                key: 'Bb Major',
                mood: 'Happy',
                sourceUrl: 'https://youtube.com/watch?v=dQw4w9WgXcQ'
            }), { status: 200 });
        }

        if (url.includes('/music/generate')) {
            const body = JSON.parse(options.body || '{}');
            const jobId = uuid();
            window.mockJobRegistry.set(jobId, {
                status: 'processing',
                progress: 0,
                details: body, // Store mood, prompt, youtubeUrl
                result: null
            });
            return new Response(JSON.stringify({
                jobId: jobId,
                status: 'queued'
            }), { status: 200 });
        }

        if (url.includes('/music/status') || url.includes('/music/variations/status')) {
            // Extract jobId from URL: /music/status/{jobId}
            const parts = url.split('/');
            const jobId = parts[parts.length - 1];

            const job = window.mockJobRegistry.get(jobId);

            if (job) {
                // Advance progress
                job.progress = Math.min(100, job.progress + 20);

                if (job.progress >= 100 && job.status !== 'completed') {
                    job.status = 'completed';
                    // --- SYNC TO LIBRARY LOGIC ---
                    const newSong = {
                        id: `song-${Date.now()}`,
                        title: job.details.youtubeUrl ? 'Never Gonna Give You Up (AI Version)' : 'Generated Track',
                        style: job.details.instruments?.[0] || 'Electronic',
                        duration: job.details.duration || 60,
                        mood: job.details.mood || 'Neutral',
                        date: new Date().toISOString()
                    };
                    window.mockMusicLibrary.unshift(newSong);
                    // -----------------------------
                }

                return new Response(JSON.stringify({
                    state: job.status === 'completed' ? 'completed' : 'processing',
                    progress: job.progress,
                    result: job.status === 'completed' ? { file: 'mock_music.mp3' } : null
                }), { status: 200 });
            } else {
                return new Response(JSON.stringify({ error: 'Job not found' }), { status: 404 });
            }
        }

        if (url.includes('/music/generate-scene-aware')) {
            return new Response(JSON.stringify({
                jobId: uuid(),
                status: 'queued'
            }), { status: 200 });
        }

        if (url.includes('/music/generate-timeline')) {
            return new Response(JSON.stringify({
                jobId: uuid(),
                status: 'queued'
            }), { status: 200 });
        }

        if (url.includes('/music/timeline-estimate')) {
            return new Response(JSON.stringify({
                estimatedChapters: 5,
                estimatedMinutes: 3,
                estimatedTimeDisplay: '3 minutes'
            }), { status: 200 });
        }

        // --- MUSIC ALIGNMENT MOCKS ---
        if (url.includes('/music/alignment-options')) {
            return new Response(JSON.stringify({
                minAudioDuration: 5,
                fadeDuration: { default: 2.0, min: 0.5, max: 5.0 }
            }), { status: 200 });
        }

        if (url.includes('/music/analyze-beats')) {
            return new Response(JSON.stringify({
                duration: 120,
                bpm: 113,
                beatCount: 226,
                beats: []
            }), { status: 200 });
        }

        if (url.includes('/music/align')) {
            return new Response(JSON.stringify({
                status: 'success',
                message: 'Aligned and trimmed music to sequence.'
            }), { status: 200 });
        }

        // -------------------------
        // LICENSE / AUTH
        // -------------------------
        if (url.includes('/license/activate')) {
            // Check for test scenario override
            if (window._mockScenario === 'invalid_license') {
                return new Response(JSON.stringify({
                    success: false,
                    error: 'Invalid license key'
                }), { status: 401 });
            }
            // Default: successful activation
            return new Response(JSON.stringify({
                success: true,
                customerId: 'cus_mock_' + Date.now(),
                plan: 'pro',
                creditsRemaining: 15
            }), { status: 200 });
        }

        if (url.includes('/credits')) {
            return new Response(JSON.stringify({
                creditsRemaining: 15,
                plan: 'pro',
                musicCredits: 10
            }), { status: 200 });
        }

        // -------------------------
        // HEALTH CHECK
        // -------------------------
        if (url.includes('/health')) {
            return new Response(JSON.stringify({
                status: 'ok',
                version: '6.0.3-mock',
                uptime: 12345
            }), { status: 200 });
        }

        // Default 404 for unhandled mocks
        console.warn(`[Fetch Mock] Unhandled URL: ${url}`);
        return new Response(JSON.stringify({ error: 'Mock endpoint not found' }), { status: 404 });
    };

    console.log('[SPLICE SIMULATION] Ready. "Go" button and all modules should function.');

    // ============================================================================
    // UI TOGGLE & MODAL INITIALIZATION (for browser testing)
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('[SPLICE SIMULATION] Initializing UI toggles and modals...');

        // Generic section toggle handler
        function setupSectionToggle(toggleId, panelId) {
            const toggle = document.getElementById(toggleId);
            const panel = document.getElementById(panelId);

            if (!toggle || !panel) {
                console.warn(`[SPLICE SIMULATION] Toggle setup failed: ${toggleId} or ${panelId} not found`);
                return;
            }

            // Set initial state
            if (panel.classList.contains('collapsed')) {
                panel.style.display = 'none';
            }

            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const isCollapsed = panel.classList.contains('collapsed');
                const icon = toggle.querySelector('.toggle-icon');

                if (isCollapsed) {
                    panel.classList.remove('collapsed');
                    panel.style.display = 'block';
                    if (icon) icon.textContent = '-';
                } else {
                    panel.classList.add('collapsed');
                    panel.style.display = 'none';
                    if (icon) icon.textContent = '+';
                }
                console.log(`[SPLICE SIMULATION] Toggled ${panelId}: ${isCollapsed ? 'expanded' : 'collapsed'}`);
            });

            console.log(`[SPLICE SIMULATION] Toggle setup: ${toggleId} -> ${panelId}`);
        }

        // Generic modal handler
        function setupModal(openBtnId, modalId, closeBtnId) {
            const openBtn = document.getElementById(openBtnId);
            const modal = document.getElementById(modalId);
            const closeBtn = document.getElementById(closeBtnId);

            if (!modal) {
                console.warn(`[SPLICE SIMULATION] Modal setup failed: ${modalId} not found`);
                return;
            }

            // Ensure modal starts hidden
            if (modal.classList.contains('hidden')) {
                modal.style.display = 'none';
            }

            if (openBtn) {
                openBtn.addEventListener('click', () => {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    console.log(`[SPLICE SIMULATION] Opened modal: ${modalId}`);
                });
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                    console.log(`[SPLICE SIMULATION] Closed modal: ${modalId}`);
                });
            }

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }
            });

            console.log(`[SPLICE SIMULATION] Modal setup: ${openBtnId} -> ${modalId}`);
        }

        // Setup all section toggles
        setupSectionToggle('optionsToggle', 'optionsPanel');
        setupSectionToggle('multitrackToggle', 'multitrackPanel');
        setupSectionToggle('captionsToggle', 'captionsPanel');
        setupSectionToggle('textEditorToggle', 'text-editor-panel');
        setupSectionToggle('socialReframeToggle', 'social-reframe-panel');
        setupSectionToggle('musicToggle', 'music-panel');
        setupSectionToggle('textPresetsToggle', 'text-presets-panel');

        // Setup all modals
        setupModal('settingsBtn', 'settingsModal', 'closeSettingsBtn');
        setupModal('creditBadge', 'loginModal', 'closeLoginBtn');
        setupModal('savePresetBtn', 'presetModal', 'closePresetModalBtn');
        setupModal('managePresetsBtn', 'managePresetsModal', 'closeManagePresetsBtn');

        // Setup sub-options toggles (checkboxes that reveal settings)
        const subOptionToggles = [
            { checkbox: 'enableJCut', panel: 'jcutSettings' },
            { checkbox: 'enableZoom', panel: 'zoomSettings' },
            { checkbox: 'enableChapters', panel: 'chapterSettings' },
            { checkbox: 'enableProfanity', panel: 'profanitySettings' },
            { checkbox: 'enableFillerDetection', panel: 'fillerSettings' }
        ];

        subOptionToggles.forEach(({ checkbox, panel }) => {
            const cb = document.getElementById(checkbox);
            const p = document.getElementById(panel);
            if (cb && p) {
                // Set initial state
                p.style.display = cb.checked ? 'block' : 'none';

                cb.addEventListener('change', () => {
                    if (cb.checked) {
                        p.classList.remove('collapsed');
                        p.style.display = 'block';
                    } else {
                        p.classList.add('collapsed');
                        p.style.display = 'none';
                    }
                });
            }
        });

        // Setup slider value displays
        const sliders = [
            { slider: 'sensitivitySlider', display: 'sensitivityValue' },
            { slider: 'jcutLeadIn', display: 'jcutLeadInValue', suffix: 's', decimals: 2 },
            { slider: 'jcutLeadOut', display: 'jcutLeadOutValue', suffix: 's', decimals: 2 },
            { slider: 'minShotDuration', display: 'minShotDurationValue', suffix: 's', decimals: 1 },
            { slider: 'wideShotPercent', display: 'wideShotPercentValue', suffix: '%' },
            { slider: 'switchingFrequency', display: 'switchingFrequencyValue' },
            { slider: 'motion-smoothing-slider', display: 'smoothing-value-display', decimals: 2 },
            { slider: 'music-duration-slider', display: 'music-duration-value', suffix: 's' }
        ];

        sliders.forEach(({ slider, display, suffix = '', decimals = 0 }) => {
            const s = document.getElementById(slider);
            const d = document.getElementById(display);
            if (s && d) {
                s.addEventListener('input', () => {
                    const val = decimals > 0 ? parseFloat(s.value).toFixed(decimals) : s.value;
                    d.textContent = val + suffix;
                });
            }
        });

        // Music tabs
        const musicTabs = document.querySelectorAll('.music-tab');
        musicTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                musicTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.music-tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });

                const activeContent = document.getElementById(`music-tab-${tabName}`);
                if (activeContent) {
                    activeContent.classList.add('active');
                    activeContent.style.display = 'block';
                }
            });
        });

        // Emoji checkbox toggle
        const emojiCheckbox = document.getElementById('captionInsertEmojis');
        const emojiGroup = document.getElementById('emojiFrequencyGroup');
        if (emojiCheckbox && emojiGroup) {
            emojiCheckbox.addEventListener('change', () => {
                emojiGroup.style.display = emojiCheckbox.checked ? 'block' : 'none';
            });
        }

        console.log('[SPLICE SIMULATION] UI toggles and modals initialized');
    });
})();
