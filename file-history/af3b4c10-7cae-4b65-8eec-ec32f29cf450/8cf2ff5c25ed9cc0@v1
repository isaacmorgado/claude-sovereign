# SPLICE Phase 4: Production Blockers

## Phase 1-3 Complete
116 tests passing (83 custom presets + 33 UI E2E). Features implemented:

### Phase 1-3 Summary (Custom Presets)
- Full CRUD: `createCustomPreset`, `updateCustomPreset`, `deleteCustomPreset`
- Query: `getPresetById`, `getAllPresets`, `isBuiltInPreset`
- Duplicate: `duplicatePreset` with "(Copy)" suffix handling
- Settings: Sensitivity/Threshold inputs in modal, preserved through CRUD
- Export/Import: JSON file sharing with merge mode

### Bug Fixed
- `main.js:2001-2004`: Fixed falsy value bug where sensitivity=0 defaulted to 50

## Phase 4 Tasks: Production Blockers (~4 hrs)

| # | Issue | Severity | File | Details |
|---|-------|----------|------|---------|
| 4.1 | Rate limiting | HIGH | `server.js` | 8 endpoints missing `requireCredits()` middleware |
| 4.2 | Auth headers | HIGH | `main.js` | Fetch calls don't send `x-stripe-customer-id` |
| 4.3 | Login/Auth UI | HIGH | `index.html`, `main.js` | No login modal - users can't authenticate |
| 4.4 | Build Sequence errors | MEDIUM | `main.js` | Basic error handling, needs user-facing messages |

## Detailed Requirements

### 4.1 Rate Limiting (1 hr)
Add `requireCredits` middleware to these endpoints in `server.js`:
```javascript
// Endpoints needing rate limiting:
POST /silences-audio      // FFprobe silence detection
POST /repetitions         // Phrase repetition detection
POST /fillers            // Filler word detection
POST /stutters           // Stutter detection
POST /export/captions    // Caption export
POST /multitrack/auto-balance  // Multicam balancing
POST /batch/silences     // Batch silence detection
POST /isolate-vocals     // Vocal isolation (Replicate)
```

### 4.2 Auth Headers (1 hr)
Update fetch calls in `main.js` to include auth header:
```javascript
// Lines to update (approximate):
// - Silence detection fetch
// - Take detection fetch
// - Cut list generation fetch
// - Build sequence fetch

headers: {
  'Content-Type': 'application/json',
  'x-stripe-customer-id': getCustomerId() // Need to implement
}
```

### 4.3 Login/Auth UI (1 hr)
Login modal already exists in `index.html:977-993`. Need to:
1. Wire up save button to store customer ID
2. Show modal on first launch if no ID stored
3. Display logged-in state in header
4. Add logout button

Functions needed in `main.js`:
```javascript
function showLoginModal()
function hideLoginModal()
function saveCustomerId(id)
function getCustomerId()
function validateCustomerId(id)
function updateAuthUI()
```

### 4.4 Build Sequence Error UI (1 hr)
Improve error handling in `buildSequenceFromCutList()`:
```javascript
// Error states to handle:
- No active sequence
- No silences/takes detected
- Cut list generation failed
- UXP API errors
- Network errors

// User-facing messages:
"Please open a sequence first"
"No edits to apply - run detection first"
"Failed to generate cut list: [reason]"
"Premiere Pro version 25.6+ required for this feature"
```

## Protocol
Each feature: implement → test → fix issues → retest → next.
End of phase: comprehensive test → update CLAUDE.md.

## Key Files
- `splice-backend/server.js` - Rate limiting middleware
- `splice-plugin/js/main.js` - Auth headers, login handlers, error UI
- `splice-plugin/js/settings.js` - Customer ID storage
- `splice-plugin/index.html` - Login modal (exists)

## Prompt
```
Continue SPLICE. Phase 3 done (116 tests). Implement Phase 4: Production Blockers.

Priority order:
1. Login/Auth UI - wire up existing modal, store customer ID in localStorage
2. Auth headers - add x-stripe-customer-id to all fetch calls
3. Rate limiting - add requireCredits() to 8 endpoints
4. Build Sequence errors - improve user-facing error messages

After each feature: E2E test, fix, retest. End: comprehensive test + update CLAUDE.md.

These are HIGH severity production blockers - focus on getting them working, not over-engineering.
```

## Implementation Notes

### Customer ID Storage (settings.js)
```javascript
const CUSTOMER_ID_KEY = 'spliceCustomerId';

function getCustomerId() {
  return localStorage.getItem(CUSTOMER_ID_KEY);
}

function setCustomerId(id) {
  localStorage.setItem(CUSTOMER_ID_KEY, id);
}

function clearCustomerId() {
  localStorage.removeItem(CUSTOMER_ID_KEY);
}

function isLoggedIn() {
  return !!getCustomerId();
}
```

### Auth Header Helper (main.js)
```javascript
function getAuthHeaders() {
  const customerId = getCustomerId();
  return {
    'Content-Type': 'application/json',
    ...(customerId && { 'x-stripe-customer-id': customerId })
  };
}
```

### Rate Limiting Pattern (server.js)
```javascript
// Existing middleware:
const requireCredits = async (req, res, next) => {
  const customerId = req.headers['x-stripe-customer-id'];
  if (!customerId) {
    return res.status(401).json({ error: 'Customer ID required' });
  }
  // ... credit validation
  next();
};

// Add to routes:
app.post('/silences-audio', requireCredits, async (req, res) => { ... });
```

## Test Coverage Target
- Add 10-15 tests for auth flows
- Add 5-10 tests for error handling
- Target: 145+ tests total
