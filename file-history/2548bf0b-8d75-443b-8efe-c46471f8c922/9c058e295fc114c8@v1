"""
Forum database models - Issue Categories, Sub-Forums, Posts, Comments, Votes, Reports, Flaw Mappings
"""

import uuid
import enum
from datetime import datetime
from sqlalchemy import (
    Column, String, DateTime, ForeignKey, Text, Integer, Boolean, Enum, Index
)
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship

from app.database import Base


class VoteType(str, enum.Enum):
    UP = "up"
    DOWN = "down"


class TargetType(str, enum.Enum):
    POST = "post"
    COMMENT = "comment"


class ReportStatus(str, enum.Enum):
    PENDING = "pending"
    REVIEWED = "reviewed"
    RESOLVED = "resolved"
    DISMISSED = "dismissed"


class ReportReason(str, enum.Enum):
    SPAM = "spam"
    HARASSMENT = "harassment"
    MISINFORMATION = "misinformation"
    OFF_TOPIC = "off_topic"
    INAPPROPRIATE = "inappropriate"
    OTHER = "other"


# ============== ISSUE CATEGORIES (12 main categories) ==============

class ForumIssueCategory(Base):
    """Main issue categories (e.g., 'Weak Bone Structure', 'Poor Skin Complexion')"""
    __tablename__ = "forum_issue_categories"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(100), nullable=False, unique=True)
    slug = Column(String(50), nullable=False, unique=True, index=True)
    description = Column(Text, nullable=True)
    icon = Column(String(10), nullable=True)  # Emoji icon
    display_order = Column(Integer, default=0)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)

    # Relationships
    sub_forums = relationship("ForumSubForum", back_populates="issue_category", cascade="all, delete-orphan")
    flaw_mappings = relationship("FlawToForumMapping", back_populates="issue_category", cascade="all, delete-orphan")

    def __repr__(self):
        return f"<ForumIssueCategory {self.slug}>"


# ============== SUB-FORUMS (44 sub-forums under categories) ==============

class ForumSubForum(Base):
    """Sub-forums under each issue category (e.g., 'Jawline', 'Nutrition')"""
    __tablename__ = "forum_sub_forums"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    issue_category_id = Column(UUID(as_uuid=True), ForeignKey("forum_issue_categories.id", ondelete="CASCADE"), nullable=False)
    name = Column(String(100), nullable=False)
    slug = Column(String(50), nullable=False)
    description = Column(Text, nullable=True)
    icon = Column(String(10), nullable=True)
    display_order = Column(Integer, default=0)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)

    # Relationships
    issue_category = relationship("ForumIssueCategory", back_populates="sub_forums")
    posts = relationship("ForumPost", back_populates="sub_forum", cascade="all, delete-orphan")

    __table_args__ = (
        Index('idx_subforum_category', 'issue_category_id', 'slug', unique=True),
    )

    def __repr__(self):
        return f"<ForumSubForum {self.slug}>"


# ============== FLAW TO FORUM MAPPING ==============

class FlawToForumMapping(Base):
    """Maps detected analysis flaws to recommended forum categories"""
    __tablename__ = "flaw_to_forum_mapping"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    flaw_id = Column(String(100), nullable=False, index=True)  # e.g., "weak_jaw", "negative_canthal_tilt"
    issue_category_id = Column(UUID(as_uuid=True), ForeignKey("forum_issue_categories.id", ondelete="CASCADE"), nullable=False)
    priority = Column(Integer, default=1)  # 1 = primary, 2 = secondary recommendation
    created_at = Column(DateTime, default=datetime.utcnow)

    # Relationships
    issue_category = relationship("ForumIssueCategory", back_populates="flaw_mappings")

    __table_args__ = (
        Index('idx_flaw_mapping', 'flaw_id', 'issue_category_id', unique=True),
    )

    def __repr__(self):
        return f"<FlawToForumMapping {self.flaw_id} -> {self.issue_category_id}>"


class ArchetypeForumMapping(Base):
    """Maps user archetypes to recommended forum categories"""
    __tablename__ = "archetype_forum_mappings"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    archetype_category = Column(String(50), nullable=False, index=True)  # "Softboy", "Chad", etc.
    issue_category_id = Column(UUID(as_uuid=True), ForeignKey("forum_issue_categories.id", ondelete="CASCADE"), nullable=False)
    priority = Column(Integer, default=0)  # Higher = more relevant
    reason = Column(Text, nullable=True)  # Why this forum is recommended
    created_at = Column(DateTime, default=datetime.utcnow)

    # Relationships
    issue_category = relationship("ForumIssueCategory", backref="archetype_mappings")

    __table_args__ = (
        Index('idx_archetype_mapping', 'archetype_category', 'issue_category_id', unique=True),
    )

    def __repr__(self):
        return f"<ArchetypeForumMapping {self.archetype_category} -> {self.issue_category_id}>"


# ============== POSTS (in sub-forums) ==============

class ForumPost(Base):
    __tablename__ = "forum_posts"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    sub_forum_id = Column(UUID(as_uuid=True), ForeignKey("forum_sub_forums.id", ondelete="CASCADE"), nullable=False)
    author_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    title = Column(String(200), nullable=False)
    content = Column(Text, nullable=False)

    # Status flags
    is_pinned = Column(Boolean, default=False)
    is_guide = Column(Boolean, default=False)  # Marks as "Guide" content
    is_approved = Column(Boolean, default=True)  # For moderation workflow
    is_deleted = Column(Boolean, default=False)

    # Soft delete tracking
    deleted_at = Column(DateTime(timezone=True), nullable=True)
    deleted_by = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=True)

    # Denormalized counts for performance
    vote_count = Column(Integer, default=0)  # net score (ups - downs)
    comment_count = Column(Integer, default=0)

    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationships
    sub_forum = relationship("ForumSubForum", back_populates="posts")
    author = relationship("User", backref="forum_posts", foreign_keys=[author_id])
    comments = relationship("ForumComment", back_populates="post", cascade="all, delete-orphan")

    # Indexes
    __table_args__ = (
        Index('idx_posts_subforum_pinned', 'sub_forum_id', 'is_pinned', 'created_at'),
        Index('idx_posts_subforum_votes', 'sub_forum_id', 'vote_count'),
        Index('idx_posts_author', 'author_id'),
    )

    def __repr__(self):
        return f"<ForumPost {self.title[:30]}>"


class ForumComment(Base):
    __tablename__ = "forum_comments"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    content = Column(Text, nullable=False)
    post_id = Column(UUID(as_uuid=True), ForeignKey("forum_posts.id", ondelete="CASCADE"), nullable=False)
    author_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    parent_id = Column(UUID(as_uuid=True), ForeignKey("forum_comments.id", ondelete="CASCADE"), nullable=True)  # For threading

    # Status
    is_approved = Column(Boolean, default=True)
    is_deleted = Column(Boolean, default=False)

    # Soft delete tracking
    deleted_at = Column(DateTime(timezone=True), nullable=True)
    deleted_by = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=True)

    # Denormalized vote count
    vote_count = Column(Integer, default=0)

    # Depth for limiting nesting (max 5 levels)
    depth = Column(Integer, default=0)

    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationships
    post = relationship("ForumPost", back_populates="comments")
    author = relationship("User", backref="forum_comments", foreign_keys=[author_id])
    parent = relationship("ForumComment", remote_side=[id], backref="replies")

    # Indexes
    __table_args__ = (
        Index('idx_comments_post', 'post_id', 'created_at'),
        Index('idx_comments_parent', 'parent_id'),
        Index('idx_comments_author', 'author_id'),
    )

    def __repr__(self):
        return f"<ForumComment {self.id}>"


class ForumVote(Base):
    __tablename__ = "forum_votes"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    target_type = Column(Enum(TargetType, values_callable=lambda x: [e.value for e in x]), nullable=False)
    target_id = Column(UUID(as_uuid=True), nullable=False)
    vote_type = Column(Enum(VoteType, values_callable=lambda x: [e.value for e in x]), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)

    # Relationships
    user = relationship("User", backref="forum_votes")

    # Unique constraint: one vote per user per target
    __table_args__ = (
        Index('idx_votes_user_target', 'user_id', 'target_type', 'target_id', unique=True),
        Index('idx_votes_target', 'target_type', 'target_id'),
    )

    def __repr__(self):
        return f"<ForumVote {self.vote_type} on {self.target_type}:{self.target_id}>"


class ForumReport(Base):
    __tablename__ = "forum_reports"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    reporter_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    target_type = Column(Enum(TargetType), nullable=False)
    target_id = Column(UUID(as_uuid=True), nullable=False)
    reason = Column(Enum(ReportReason), nullable=False)
    details = Column(Text, nullable=True)  # Additional context
    status = Column(Enum(ReportStatus), default=ReportStatus.PENDING)
    reviewed_by = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    reviewed_at = Column(DateTime, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)

    # Relationships
    reporter = relationship("User", foreign_keys=[reporter_id], backref="reports_filed")
    reviewer = relationship("User", foreign_keys=[reviewed_by], backref="reports_reviewed")

    # Indexes
    __table_args__ = (
        Index('idx_reports_status', 'status', 'created_at'),
        Index('idx_reports_target', 'target_type', 'target_id'),
    )

    def __repr__(self):
        return f"<ForumReport {self.reason} on {self.target_type}:{self.target_id}>"


# ============== BOOKMARKS (saved posts per user) ==============

class ForumBookmark(Base):
    """User-saved forum posts for quick access"""
    __tablename__ = "forum_bookmarks"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
    post_id = Column(UUID(as_uuid=True), ForeignKey("forum_posts.id", ondelete="CASCADE"), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)

    # Relationships
    user = relationship("User", backref="forum_bookmarks")
    post = relationship("ForumPost", backref="bookmarks")

    # Unique constraint: one bookmark per user per post
    __table_args__ = (
        Index('idx_bookmarks_user_post', 'user_id', 'post_id', unique=True),
        Index('idx_bookmarks_user_created', 'user_id', 'created_at'),
    )

    def __repr__(self):
        return f"<ForumBookmark user={self.user_id} post={self.post_id}>"
