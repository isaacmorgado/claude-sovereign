'use client'

import { useEffect, useState } from 'react'
import Link from 'next/link'
import { useAuth } from '@/lib/auth-context'
import { api } from '@/lib/api'
import { TIER_LIMITS, type UsageStats, type SubscriptionStatus } from '@/lib/types'
import styles from './page.module.css'

export default function DashboardPage() {
  const { user } = useAuth()
  const [usage, setUsage] = useState<UsageStats | null>(null)
  const [billing, setBilling] = useState<SubscriptionStatus | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function fetchData() {
      try {
        const [usageData, billingData] = await Promise.all([
          api.getUsage(),
          api.getBillingStatus(),
        ])
        setUsage(usageData)
        setBilling(billingData)
      } catch (err) {
        console.error('Failed to fetch dashboard data:', err)
      } finally {
        setLoading(false)
      }
    }
    fetchData()
  }, [])

  if (loading) {
    return <p className={styles.loading}>Loading dashboard...</p>
  }

  const usagePercent = usage?.percentUsed ?? 0
  const tier = user?.subscription_tier || 'free'
  const limit = usage?.limit ?? TIER_LIMITS[tier]

  return (
    <div className={styles.container}>
      <h1 className={styles.title}>Welcome back{user?.name ? `, ${user.name}` : ''}</h1>

      <div className={styles.grid}>
        <div className={`card ${styles.usageCard}`}>
          <h2>Usage This Month</h2>
          <div className={styles.usageStats}>
            <span className={styles.usageValue}>{usage?.currentUsage.toFixed(1) ?? '0'}</span>
            <span className={styles.usageTotal}>/ {limit} minutes</span>
          </div>
          <div className={styles.progressBar}>
            <div
              className={styles.progressFill}
              style={{ width: `${usagePercent}%` }}
              data-warning={usagePercent > 80}
            />
          </div>
          <p className={styles.usageHint}>
            {usagePercent >= 100
              ? 'You have reached your limit'
              : `${(usage?.remaining ?? limit).toFixed(1)} minutes remaining`}
          </p>
          <Link href="/dashboard/usage" className={styles.cardLink}>
            View details
          </Link>
        </div>

        <div className={`card ${styles.planCard}`}>
          <h2>Current Plan</h2>
          <div className={styles.planInfo}>
            <span className={styles.planName}>{tier}</span>
            {billing?.status && billing.status !== 'none' && (
              <span className={styles.planStatus} data-status={billing.status}>
                {billing.status}
              </span>
            )}
          </div>
          {tier === 'free' && (
            <p className={styles.upgradeHint}>Upgrade for more minutes and features</p>
          )}
          <Link href="/dashboard/billing" className={styles.cardLink}>
            {tier === 'free' ? 'Upgrade plan' : 'Manage billing'}
          </Link>
        </div>

        <div className={`card ${styles.quickActions}`}>
          <h2>Quick Actions</h2>
          <div className={styles.actions}>
            <Link href="/dashboard/usage" className="btn btn-secondary">
              View Usage History
            </Link>
            <Link href="/dashboard/settings" className="btn btn-secondary">
              Account Settings
            </Link>
          </div>
        </div>
      </div>
    </div>
  )
}
