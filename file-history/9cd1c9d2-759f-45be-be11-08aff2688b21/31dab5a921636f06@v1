'use client'

import { useEffect, useState } from 'react'
import { useAuth } from '@/lib/auth-context'
import { api } from '@/lib/api'
import { TIER_LIMITS, TIER_PRICES, type SubscriptionStatus, type SubscriptionTier } from '@/lib/types'
import styles from './page.module.css'

const plans: Array<{ tier: SubscriptionTier; name: string; description: string }> = [
  {
    tier: 'free',
    name: 'Free Trial',
    description: 'Try Splice with limited usage',
  },
  {
    tier: 'pro',
    name: 'Pro',
    description: 'For content creators and editors',
  },
  {
    tier: 'enterprise',
    name: 'Enterprise',
    description: 'For studios and teams',
  },
]

export default function BillingPage() {
  const { user, refreshUser } = useAuth()
  const [billing, setBilling] = useState<SubscriptionStatus | null>(null)
  const [loading, setLoading] = useState(true)
  const [upgradeLoading, setUpgradeLoading] = useState<string | null>(null)

  useEffect(() => {
    async function fetchBilling() {
      try {
        const data = await api.getBillingStatus()
        setBilling(data)
      } catch (err) {
        console.error('Failed to fetch billing:', err)
      } finally {
        setLoading(false)
      }
    }
    fetchBilling()
  }, [])

  const handleUpgrade = async (tier: 'pro' | 'enterprise') => {
    setUpgradeLoading(tier)
    try {
      const { url } = await api.createCheckout(tier)
      window.location.href = url
    } catch (err) {
      console.error('Failed to create checkout:', err)
      alert('Failed to start checkout. Please try again.')
    } finally {
      setUpgradeLoading(null)
    }
  }

  const handleManageBilling = async () => {
    setUpgradeLoading('manage')
    try {
      const { url } = await api.createPortal()
      window.location.href = url
    } catch (err) {
      console.error('Failed to create portal:', err)
      alert('Failed to open billing portal. Please try again.')
    } finally {
      setUpgradeLoading(null)
    }
  }

  if (loading) {
    return <p className={styles.loading}>Loading billing information...</p>
  }

  const currentTier = user?.subscription_tier || 'free'

  return (
    <div className={styles.container}>
      <h1 className={styles.title}>Billing</h1>

      {billing && billing.status !== 'none' && (
        <div className={`card ${styles.currentPlan}`}>
          <h2>Current Subscription</h2>
          <div className={styles.subscriptionInfo}>
            <div className={styles.subscriptionRow}>
              <span>Plan</span>
              <span className={styles.planName}>{currentTier}</span>
            </div>
            <div className={styles.subscriptionRow}>
              <span>Status</span>
              <span className={styles.status} data-status={billing.status}>
                {billing.status}
              </span>
            </div>
            {billing.currentPeriodEnd && (
              <div className={styles.subscriptionRow}>
                <span>{billing.cancelAtPeriodEnd ? 'Ends on' : 'Renews on'}</span>
                <span>{new Date(billing.currentPeriodEnd).toLocaleDateString()}</span>
              </div>
            )}
          </div>
          {currentTier !== 'free' && (
            <button
              className="btn btn-secondary"
              onClick={handleManageBilling}
              disabled={upgradeLoading === 'manage'}
            >
              {upgradeLoading === 'manage' ? 'Loading...' : 'Manage Subscription'}
            </button>
          )}
        </div>
      )}

      <h2 className={styles.sectionTitle}>Available Plans</h2>

      <div className={styles.plansGrid}>
        {plans.map((plan) => {
          const isCurrentPlan = currentTier === plan.tier
          const limit = TIER_LIMITS[plan.tier]
          const price = plan.tier !== 'free' ? TIER_PRICES[plan.tier] : null

          return (
            <div key={plan.tier} className={`card ${styles.planCard}`} data-current={isCurrentPlan}>
              {isCurrentPlan && <span className={styles.currentBadge}>Current</span>}
              <h3 className={styles.planTitle}>{plan.name}</h3>
              <p className={styles.planDescription}>{plan.description}</p>

              <div className={styles.planPrice}>
                {price ? (
                  <>
                    <span className={styles.priceAmount}>${price.monthly}</span>
                    <span className={styles.pricePeriod}>/month</span>
                  </>
                ) : (
                  <span className={styles.priceAmount}>$0</span>
                )}
              </div>

              {price && (
                <p className={styles.yearlyPrice}>
                  or ${price.yearly}/year (save 17%)
                </p>
              )}

              <ul className={styles.features}>
                <li>{limit} minutes per month</li>
                <li>Transcription</li>
                <li>Vocal Isolation</li>
                {plan.tier === 'enterprise' && <li>Priority support</li>}
              </ul>

              {!isCurrentPlan && plan.tier !== 'free' && (
                <button
                  className="btn btn-primary"
                  onClick={() => handleUpgrade(plan.tier as 'pro' | 'enterprise')}
                  disabled={upgradeLoading === plan.tier}
                  style={{ width: '100%' }}
                >
                  {upgradeLoading === plan.tier ? 'Loading...' : `Upgrade to ${plan.name}`}
                </button>
              )}

              {isCurrentPlan && (
                <button className="btn btn-secondary" disabled style={{ width: '100%' }}>
                  Current Plan
                </button>
              )}
            </div>
          )
        })}
      </div>
    </div>
  )
}
