'use client'

import { useEffect, useState } from 'react'
import { useAuth } from '@/lib/auth-context'
import { api } from '@/lib/api'
import { TIER_LIMITS, type UsageStats } from '@/lib/types'
import styles from './page.module.css'

export default function UsagePage() {
  const { user } = useAuth()
  const [usage, setUsage] = useState<UsageStats | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function fetchUsage() {
      try {
        const data = await api.getUsage()
        setUsage(data)
      } catch (err) {
        console.error('Failed to fetch usage:', err)
      } finally {
        setLoading(false)
      }
    }
    fetchUsage()
  }, [])

  if (loading) {
    return <p className={styles.loading}>Loading usage data...</p>
  }

  const tier = usage?.tier || user?.subscription_tier || 'free'
  const limit = usage?.limit ?? TIER_LIMITS[tier]
  const used = usage?.currentUsage ?? 0
  const remaining = usage?.remaining ?? 0
  const usagePercent = usage?.percentUsed ?? 0
  const resetDate = usage?.resetAt ? new Date(usage.resetAt).toLocaleDateString() : 'N/A'

  return (
    <div className={styles.container}>
      <h1 className={styles.title}>Usage</h1>

      <div className={`card ${styles.overviewCard}`}>
        <h2>Monthly Usage Overview</h2>

        <div className={styles.stats}>
          <div className={styles.stat}>
            <span className={styles.statValue}>{used.toFixed(1)}</span>
            <span className={styles.statLabel}>Minutes Used</span>
          </div>
          <div className={styles.stat}>
            <span className={styles.statValue}>{remaining.toFixed(1)}</span>
            <span className={styles.statLabel}>Minutes Remaining</span>
          </div>
          <div className={styles.stat}>
            <span className={styles.statValue}>{limit}</span>
            <span className={styles.statLabel}>Monthly Limit</span>
          </div>
        </div>

        <div className={styles.progressSection}>
          <div className={styles.progressHeader}>
            <span>Usage</span>
            <span>{usagePercent.toFixed(0)}%</span>
          </div>
          <div className={styles.progressBar}>
            <div
              className={styles.progressFill}
              style={{ width: `${usagePercent}%` }}
              data-warning={usagePercent > 80}
              data-critical={usagePercent >= 100}
            />
          </div>
        </div>

        <div className={styles.resetInfo}>
          <span>Usage resets on:</span>
          <span className={styles.resetDate}>{resetDate}</span>
        </div>
      </div>

      <div className={`card ${styles.tierCard}`}>
        <h2>Plan Details</h2>
        <div className={styles.tierInfo}>
          <div className={styles.tierRow}>
            <span>Current Plan</span>
            <span className={styles.tierName}>{tier}</span>
          </div>
          <div className={styles.tierRow}>
            <span>Monthly Allowance</span>
            <span>{limit} minutes</span>
          </div>
          {tier === 'free' && (
            <p className={styles.upgradeNote}>
              Upgrade to Pro for 300 minutes/month or Enterprise for 500 minutes/month.
            </p>
          )}
        </div>
      </div>

      <div className={`card ${styles.infoCard}`}>
        <h2>How Usage is Calculated</h2>
        <ul className={styles.infoList}>
          <li>Usage is measured in minutes of audio processed</li>
          <li>Both transcription and vocal isolation count toward your usage</li>
          <li>Usage resets at the beginning of each billing cycle</li>
          <li>Unused minutes do not roll over to the next month</li>
        </ul>
      </div>
    </div>
  )
}
