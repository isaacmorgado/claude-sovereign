/**
 * Filler Words Accuracy E2E Test
 *
 * Tests Feature 6: Enhanced filler word detection with frame alignment
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// Load files
const serverJs = fs.readFileSync(path.join(__dirname, '../server.js'), 'utf8');
const transcriptionJs = fs.readFileSync(path.join(__dirname, '../services/transcription.js'), 'utf8');

console.log('\n=== Filler Words Accuracy E2E Tests ===\n');

// === 1. Endpoint Tests ===
console.log('=== 1. Endpoint Configuration ===');

test('POST /fillers endpoint exists', () => {
  assert.ok(serverJs.includes("app.post('/fillers'"),
    'POST /fillers endpoint should exist');
});

test('Endpoint requires credits', () => {
  assert.ok(serverJs.includes("requireCredits({ endpoint: 'fillers' })"),
    'Endpoint should require credits');
});

test('Endpoint accepts frameRate parameter', () => {
  assert.ok(serverJs.includes('frameRate = 0'),
    'Should accept frameRate with default 0');
});

test('Endpoint accepts paddingMs parameter', () => {
  assert.ok(serverJs.includes('paddingMs = 50'),
    'Should accept paddingMs with default 50');
});

test('Endpoint accepts customFillers parameter', () => {
  assert.ok(serverJs.includes('customFillers = []'),
    'Should accept customFillers array');
});

// === 2. Word-Level Timestamps ===
console.log('\n=== 2. Word-Level Timestamps ===');

test('Uses transcribeWithWords for word-level timing', () => {
  assert.ok(serverJs.includes('await transcribeWithWords(wavPath)'),
    'Should use transcribeWithWords for word-level timestamps');
});

test('Validates transcript has words', () => {
  assert.ok(serverJs.includes('!transcript.words'),
    'Should validate transcript has words array');
});

test('transcribeWithWords uses transcribeFull', () => {
  assert.ok(transcriptionJs.includes('async function transcribeWithWords'),
    'transcribeWithWords function should exist');
  assert.ok(transcriptionJs.includes('const full = await transcribeFull(wavPath)'),
    'Should use transcribeFull for unified transcription');
});

// === 3. Filler Word Detection ===
console.log('\n=== 3. Filler Word Detection ===');

test('Default filler words include hesitation sounds', () => {
  assert.ok(serverJs.includes("'um', 'uh', 'ah', 'er', 'eh'"),
    'Should include common hesitation sounds');
});

test('Default filler words include discourse markers', () => {
  assert.ok(serverJs.includes("'like', 'so', 'well', 'right'"),
    'Should include discourse markers');
});

test('Default filler words include filler phrases', () => {
  assert.ok(serverJs.includes("'you know', 'i mean', 'basically'"),
    'Should include filler phrases');
});

test('Detects two-word filler phrases', () => {
  assert.ok(serverJs.includes('Check two-word phrases'),
    'Should check for two-word phrases');
  assert.ok(serverJs.includes('twoWordPhrase'),
    'Should create two-word phrase variable');
});

test('Merges custom fillers with defaults', () => {
  assert.ok(serverJs.includes('...customFillers.map'),
    'Should merge custom fillers with defaults');
});

// === 4. Frame Alignment ===
console.log('\n=== 4. Frame Alignment ===');

test('Checks if frame alignment is requested', () => {
  assert.ok(serverJs.includes('hasFrameAlignment = frameRate > 0'),
    'Should check if frame alignment is requested');
});

test('Converts paddingMs to seconds', () => {
  assert.ok(serverJs.includes('paddingSec = paddingMs / 1000'),
    'Should convert padding from ms to seconds');
});

test('Applies padding to start time', () => {
  assert.ok(serverJs.includes('paddedStart = Math.max(0, f.start - paddingSec)'),
    'Should apply padding to start time (with floor at 0)');
});

test('Applies padding to end time', () => {
  assert.ok(serverJs.includes('paddedEnd = f.end + paddingSec'),
    'Should apply padding to end time');
});

test('Uses alignToFrameFloor for start', () => {
  assert.ok(serverJs.includes('alignToFrameFloor(paddedStart, frameRate)'),
    'Should use alignToFrameFloor for start time');
});

test('Uses alignToFrameCeil for end', () => {
  assert.ok(serverJs.includes('alignToFrameCeil(paddedEnd, frameRate)'),
    'Should use alignToFrameCeil for end time');
});

test('Includes aligned timestamps in response', () => {
  assert.ok(serverJs.includes('startAligned:'),
    'Should include startAligned in filler object');
  assert.ok(serverJs.includes('endAligned:'),
    'Should include endAligned in filler object');
  assert.ok(serverJs.includes('durationAligned:'),
    'Should include durationAligned in filler object');
});

// === 5. Response Format ===
console.log('\n=== 5. Response Format ===');

test('Returns filler count', () => {
  assert.ok(serverJs.includes('fillerCount: enhancedFillers.length'),
    'Should return filler count in metadata');
});

test('Returns filler percentage', () => {
  assert.ok(serverJs.includes('fillerPercentage:'),
    'Should return filler percentage');
});

test('Returns fillers per minute', () => {
  assert.ok(serverJs.includes('fillersPerMinute:'),
    'Should return fillers per minute metric');
});

test('Returns frameAligned flag', () => {
  assert.ok(serverJs.includes('frameAligned: hasFrameAlignment'),
    'Should return frameAligned boolean in metadata');
});

test('Returns paddingMs in metadata', () => {
  assert.ok(serverJs.includes('paddingMs'),
    'Should return paddingMs in metadata');
});

test('Returns removal segments with aligned times', () => {
  assert.ok(serverJs.includes('start: f.startAligned'),
    'Removal segments should use aligned start time');
  assert.ok(serverJs.includes('end: f.endAligned'),
    'Removal segments should use aligned end time');
});

// === 6. Enhanced Filler Objects ===
console.log('\n=== 6. Enhanced Filler Objects ===');

test('Filler objects include word', () => {
  assert.ok(serverJs.includes('word: word.word'),
    'Should include original word');
});

test('Filler objects include normalizedWord', () => {
  assert.ok(serverJs.includes('normalizedWord,'),
    'Should include normalized word');
});

test('Filler objects include start/end', () => {
  assert.ok(serverJs.includes('start: word.start'),
    'Should include start time');
  assert.ok(serverJs.includes('end: word.end'),
    'Should include end time');
});

test('Filler objects include type', () => {
  assert.ok(serverJs.includes("type: 'filler'"),
    'Should include filler type');
  assert.ok(serverJs.includes("type: 'filler_phrase'"),
    'Should include filler_phrase type for multi-word');
});

test('Enhanced fillers include padded times', () => {
  assert.ok(serverJs.includes('paddedStart,'),
    'Should include paddedStart');
  assert.ok(serverJs.includes('paddedEnd,'),
    'Should include paddedEnd');
});

// === Summary ===
console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed === 0) {
  console.log('\n✓ All tests passed!');
} else {
  console.log('\n✗ Some tests failed');
}

process.exit(failed > 0 ? 1 : 0);
