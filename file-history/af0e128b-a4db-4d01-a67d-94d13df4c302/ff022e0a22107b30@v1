/**
 * Waveform Visualization E2E Test
 *
 * Tests Feature 9: Waveform visualization with zoom, click-to-seek, silence overlay
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// Load files
const indexHtml = fs.readFileSync(path.join(__dirname, '../../splice-plugin/index.html'), 'utf8');
const mainJs = fs.readFileSync(path.join(__dirname, '../../splice-plugin/js/main.js'), 'utf8');
const serverJs = fs.readFileSync(path.join(__dirname, '../server.js'), 'utf8');
const rmsSilenceJs = fs.readFileSync(path.join(__dirname, '../services/rmsSilenceDetection.js'), 'utf8');

console.log('\n=== Waveform Visualization E2E Tests ===\n');

// === 1. HTML UI Elements ===
console.log('=== 1. HTML UI Elements ===');

test('Waveform container exists', () => {
  assert.ok(indexHtml.includes('id="waveformContainer"'),
    'waveformContainer should exist');
});

test('Waveform canvas exists', () => {
  assert.ok(indexHtml.includes('id="waveformCanvas"'),
    'waveformCanvas should exist');
});

test('Waveform playhead exists', () => {
  assert.ok(indexHtml.includes('id="waveformPlayhead"'),
    'waveformPlayhead should exist');
});

test('Waveform silences overlay exists', () => {
  assert.ok(indexHtml.includes('id="waveformSilences"'),
    'waveformSilences overlay should exist');
});

test('Zoom in button exists', () => {
  assert.ok(indexHtml.includes('id="waveformZoomIn"'),
    'waveformZoomIn button should exist');
});

test('Zoom out button exists', () => {
  assert.ok(indexHtml.includes('id="waveformZoomOut"'),
    'waveformZoomOut button should exist');
});

test('Reset button exists', () => {
  assert.ok(indexHtml.includes('id="waveformReset"'),
    'waveformReset button should exist');
});

test('Duration display exists', () => {
  assert.ok(indexHtml.includes('id="waveformDuration"'),
    'waveformDuration display should exist');
});

test('ARIA labels for accessibility', () => {
  assert.ok(indexHtml.includes('aria-label="Zoom in waveform"'),
    'Zoom in should have ARIA label');
  assert.ok(indexHtml.includes('aria-label="Zoom out waveform"'),
    'Zoom out should have ARIA label');
  assert.ok(indexHtml.includes('aria-label="Reset waveform zoom"'),
    'Reset should have ARIA label');
});

// === 2. JavaScript State Variables ===
console.log('\n=== 2. JavaScript State Variables ===');

test('currentWaveformData state variable exists', () => {
  assert.ok(mainJs.includes('let currentWaveformData = null'),
    'currentWaveformData should be initialized');
});

test('waveformZoom state variable exists', () => {
  assert.ok(mainJs.includes('let waveformZoom = 1'),
    'waveformZoom should be initialized to 1');
});

test('waveformOffset state variable exists', () => {
  assert.ok(mainJs.includes('let waveformOffset = 0'),
    'waveformOffset should be initialized to 0');
});

// === 3. Initialization Function ===
console.log('\n=== 3. Initialization Function ===');

test('initWaveformUI function exists', () => {
  assert.ok(mainJs.includes('function initWaveformUI()'),
    'initWaveformUI function should exist');
});

test('initWaveformUI is called on startup', () => {
  assert.ok(mainJs.includes('initWaveformUI()'),
    'initWaveformUI should be called during initialization');
});

test('Plugin version updated for Feature 9', () => {
  assert.ok(mainJs.includes('v3.9.6') && mainJs.includes('Feature 9'),
    'Version should be updated to v3.9.6 with Feature 9 mention');
});

// === 4. Zoom Controls ===
console.log('\n=== 4. Zoom Controls ===');

test('Zoom in handler wired', () => {
  assert.ok(mainJs.includes("getElementById('waveformZoomIn')"),
    'Should get zoom in button');
  assert.ok(mainJs.includes("waveformZoom = Math.min(waveformZoom * 1.5, 10)"),
    'Should zoom in by 1.5x with max 10');
});

test('Zoom out handler wired', () => {
  assert.ok(mainJs.includes("getElementById('waveformZoomOut')"),
    'Should get zoom out button');
  assert.ok(mainJs.includes("waveformZoom = Math.max(waveformZoom / 1.5, 1)"),
    'Should zoom out by 1.5x with min 1');
});

test('Reset handler wired', () => {
  assert.ok(mainJs.includes("getElementById('waveformReset')"),
    'Should get reset button');
  assert.ok(mainJs.includes('waveformZoom = 1') && mainJs.includes('waveformOffset = 0'),
    'Reset should restore default zoom and offset');
});

// === 5. Fetch Waveform Data ===
console.log('\n=== 5. Fetch Waveform Data ===');

test('fetchWaveformData function exists', () => {
  assert.ok(mainJs.includes('async function fetchWaveformData(wavPath)'),
    'fetchWaveformData function should exist');
});

test('fetchWaveformData calls /waveform endpoint', () => {
  assert.ok(mainJs.includes("getBackendUrl()}/waveform"),
    'Should call /waveform endpoint');
});

test('fetchWaveformData includes auth headers', () => {
  // Check within fetchWaveformData context
  assert.ok(mainJs.includes('...getAuthHeaders()'),
    'Should include auth headers');
});

test('fetchWaveformData passes targetPoints parameter', () => {
  assert.ok(mainJs.includes('targetPoints: 400'),
    'Should pass targetPoints parameter');
});

test('fetchWaveformData passes windowMs parameter', () => {
  assert.ok(mainJs.includes('windowMs: 50'),
    'Should pass windowMs parameter');
});

// === 6. Render Waveform ===
console.log('\n=== 6. Render Waveform ===');

test('renderWaveform function exists', () => {
  assert.ok(mainJs.includes('function renderWaveform(silences = [])'),
    'renderWaveform function should exist');
});

test('renderWaveform gets canvas context', () => {
  assert.ok(mainJs.includes("canvas.getContext('2d')"),
    'Should get 2d canvas context');
});

test('renderWaveform calculates visible range', () => {
  assert.ok(mainJs.includes('visibleStart') && mainJs.includes('visibleEnd'),
    'Should calculate visible range for zoom');
});

test('renderWaveform draws silence regions', () => {
  assert.ok(mainJs.includes("ctx.fillStyle = 'rgba(255, 107, 107, 0.3)'"),
    'Should draw silence regions with red overlay');
});

test('renderWaveform draws waveform bars', () => {
  assert.ok(mainJs.includes("ctx.fillStyle = '#4a9eff'"),
    'Should draw waveform bars in blue');
});

test('renderWaveform updates duration display', () => {
  assert.ok(mainJs.includes('durationEl.textContent = formatTime(duration)'),
    'Should update duration display');
});

// === 7. Click to Seek ===
console.log('\n=== 7. Click to Seek ===');

test('Canvas click handler for seeking', () => {
  assert.ok(mainJs.includes("canvas.addEventListener('click'"),
    'Canvas should have click handler');
});

test('Click handler calculates seek time', () => {
  assert.ok(mainJs.includes('seekPercent') && mainJs.includes('seekTime'),
    'Should calculate seek time from click position');
});

test('Click handler calls seekToTime', () => {
  assert.ok(mainJs.includes('seekToTime(seekTime)'),
    'Should call seekToTime with calculated time');
});

// === 8. Backend Waveform Service ===
console.log('\n=== 8. Backend Waveform Service ===');

test('getWaveformData function exists in service', () => {
  assert.ok(rmsSilenceJs.includes('async function getWaveformData'),
    'getWaveformData should exist in rmsSilenceDetection.js');
});

test('getWaveformData is exported', () => {
  assert.ok(rmsSilenceJs.includes('getWaveformData'),
    'getWaveformData should be exported');
});

test('parseWavBuffer helper exists', () => {
  assert.ok(rmsSilenceJs.includes('function parseWavBuffer'),
    'parseWavBuffer helper should exist');
});

// === 9. Backend Waveform Endpoint ===
console.log('\n=== 9. Backend Waveform Endpoint ===');

test('POST /waveform endpoint exists', () => {
  assert.ok(serverJs.includes("app.post('/waveform'"),
    'POST /waveform endpoint should exist');
});

test('Endpoint requires credits', () => {
  assert.ok(serverJs.includes("requireCredits({ endpoint: 'waveform' })"),
    'Endpoint should require credits');
});

test('Endpoint validates wavPath', () => {
  assert.ok(serverJs.includes("if (!wavPath)") && serverJs.includes("wavPath is required"),
    'Should validate wavPath parameter');
});

test('Endpoint checks file exists', () => {
  assert.ok(serverJs.includes("fileExists(wavPath)") && serverJs.includes("File not found"),
    'Should check if file exists');
});

test('Endpoint validates file size', () => {
  assert.ok(serverJs.includes("validateFileSize(wavPath)"),
    'Should validate file size');
});

test('Endpoint calls getWaveformData', () => {
  assert.ok(serverJs.includes("getWaveformData(wavPath"),
    'Should call getWaveformData service');
});

test('Endpoint returns success response', () => {
  assert.ok(serverJs.includes("success: true") && serverJs.includes("...result"),
    'Should return success with result data');
});

// === 10. Update Waveform with Silences ===
console.log('\n=== 10. Update Waveform with Silences ===');

test('updateWaveformWithSilences function exists', () => {
  assert.ok(mainJs.includes('async function updateWaveformWithSilences'),
    'updateWaveformWithSilences function should exist');
});

test('updateWaveformWithSilences fetches waveform data', () => {
  assert.ok(mainJs.includes('fetchWaveformData(wavPath)'),
    'Should fetch waveform data');
});

test('updateWaveformWithSilences renders with silences', () => {
  assert.ok(mainJs.includes('renderWaveform(silences)'),
    'Should render waveform with silence overlay');
});

// === 11. Integration ===
console.log('\n=== 11. Integration ===');

test('Waveform container starts hidden', () => {
  assert.ok(indexHtml.includes('id="waveformContainer"') &&
            indexHtml.includes('style="display: none;"'),
    'Waveform container should start hidden');
});

test('Canvas has proper dimensions', () => {
  assert.ok(indexHtml.includes('width="400" height="80"'),
    'Canvas should have 400x80 dimensions');
});

test('Waveform wrapper has proper styling', () => {
  assert.ok(indexHtml.includes('class="waveform-wrapper"'),
    'Should have waveform-wrapper class');
});

// === Summary ===
console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed === 0) {
  console.log('\n✓ All tests passed!');
} else {
  console.log('\n✗ Some tests failed');
}

process.exit(failed > 0 ? 1 : 0);
