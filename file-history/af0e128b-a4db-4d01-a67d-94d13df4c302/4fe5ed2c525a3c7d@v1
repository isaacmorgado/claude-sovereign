/**
 * Profanity Custom Lists UI E2E Test
 *
 * Tests Feature 5: Profanity custom blocklist/allowlist UI
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// Load files
const indexHtml = fs.readFileSync(path.join(__dirname, '../../splice-plugin/index.html'), 'utf8');
const settingsJs = fs.readFileSync(path.join(__dirname, '../../splice-plugin/js/settings.js'), 'utf8');
const mainJs = fs.readFileSync(path.join(__dirname, '../../splice-plugin/js/main.js'), 'utf8');
const profanityDetectionJs = fs.readFileSync(path.join(__dirname, '../services/profanityDetection.js'), 'utf8');

console.log('\n=== Profanity Custom Lists UI E2E Tests ===\n');

// === 1. HTML UI Elements ===
console.log('=== 1. HTML UI Elements ===');

test('Enable profanity checkbox exists', () => {
  assert.ok(indexHtml.includes('id="enableProfanity"'),
    'enableProfanity checkbox should exist');
});

test('Profanity settings panel exists', () => {
  assert.ok(indexHtml.includes('id="profanitySettings"'),
    'profanitySettings panel should exist');
});

test('Language selector exists', () => {
  assert.ok(indexHtml.includes('id="profanityLanguage"'),
    'profanityLanguage selector should exist');
});

test('Language options include en, es, fr, de', () => {
  assert.ok(indexHtml.includes('value="en"'), 'Should have English option');
  assert.ok(indexHtml.includes('value="es"'), 'Should have Spanish option');
  assert.ok(indexHtml.includes('value="fr"'), 'Should have French option');
  assert.ok(indexHtml.includes('value="de"'), 'Should have German option');
});

test('Blocklist textarea exists', () => {
  assert.ok(indexHtml.includes('id="profanityBlocklist"'),
    'profanityBlocklist textarea should exist');
});

test('Allowlist textarea exists', () => {
  assert.ok(indexHtml.includes('id="profanityAllowlist"'),
    'profanityAllowlist textarea should exist');
});

test('Bleep type selector exists', () => {
  assert.ok(indexHtml.includes('id="bleepType"'),
    'bleepType selector should exist');
});

test('Bleep type options include standard, soft, silence', () => {
  assert.ok(indexHtml.includes('value="standard">Standard'),
    'Should have standard bleep option');
  assert.ok(indexHtml.includes('value="soft">Soft'),
    'Should have soft bleep option');
  assert.ok(indexHtml.includes('value="silence">Silence'),
    'Should have silence option');
});

test('ARIA labels exist for accessibility', () => {
  assert.ok(indexHtml.includes('aria-label="Profanity detection language"'),
    'Language selector should have aria-label');
  assert.ok(indexHtml.includes('aria-label="Custom profanity blocklist"'),
    'Blocklist should have aria-label');
  assert.ok(indexHtml.includes('aria-label="Custom profanity allowlist"'),
    'Allowlist should have aria-label');
  assert.ok(indexHtml.includes('aria-label="Bleep sound type"'),
    'Bleep type should have aria-label');
});

// === 2. Settings.js Functions ===
console.log('\n=== 2. Settings.js Functions ===');

test('PROFANITY_SETTINGS_KEY constant exists', () => {
  assert.ok(settingsJs.includes("PROFANITY_SETTINGS_KEY = 'spliceProfanitySettings'"),
    'PROFANITY_SETTINGS_KEY should be defined');
});

test('DEFAULT_PROFANITY_SETTINGS exists', () => {
  assert.ok(settingsJs.includes('DEFAULT_PROFANITY_SETTINGS'),
    'DEFAULT_PROFANITY_SETTINGS should exist');
  assert.ok(settingsJs.includes('enabled: false'),
    'Default enabled should be false');
  assert.ok(settingsJs.includes("language: 'en'"),
    'Default language should be en');
  assert.ok(settingsJs.includes('customBlocklist: []'),
    'Default blocklist should be empty');
  assert.ok(settingsJs.includes('customAllowlist: []'),
    'Default allowlist should be empty');
  assert.ok(settingsJs.includes("bleepType: 'standard'"),
    'Default bleep type should be standard');
});

test('getProfanitySettings function exists', () => {
  assert.ok(settingsJs.includes('function getProfanitySettings()'),
    'getProfanitySettings function should exist');
});

test('saveProfanitySettings function exists', () => {
  assert.ok(settingsJs.includes('function saveProfanitySettings(settings)'),
    'saveProfanitySettings function should exist');
});

test('parseWordList function exists', () => {
  assert.ok(settingsJs.includes('function parseWordList(text)'),
    'parseWordList function should exist');
});

test('parseWordList handles comma and newline separators', () => {
  assert.ok(settingsJs.includes(".split(/[,\\n]/)"),
    'Should split on comma or newline');
});

test('formatWordList function exists', () => {
  assert.ok(settingsJs.includes('function formatWordList(words)'),
    'formatWordList function should exist');
});

test('initProfanitySettingsUI function exists', () => {
  assert.ok(settingsJs.includes('function initProfanitySettingsUI()'),
    'initProfanitySettingsUI function should exist');
});

test('initProfanitySettingsUI loads saved settings', () => {
  assert.ok(settingsJs.includes('const saved = getProfanitySettings()'),
    'Should load saved settings on init');
});

test('initProfanitySettingsUI wires enable checkbox', () => {
  assert.ok(settingsJs.includes("enableCheckbox.addEventListener('change'"),
    'Should add change listener to enable checkbox');
});

test('initProfanitySettingsUI saves on textarea blur', () => {
  assert.ok(settingsJs.includes("blocklistTextarea.addEventListener('blur'"),
    'Should save blocklist on blur');
  assert.ok(settingsJs.includes("allowlistTextarea.addEventListener('blur'"),
    'Should save allowlist on blur');
});

test('initProfanitySettingsUI toggles collapsed class', () => {
  assert.ok(settingsJs.includes("settingsPanel.classList.remove('collapsed')"),
    'Should remove collapsed class when enabled');
  assert.ok(settingsJs.includes("settingsPanel.classList.add('collapsed')"),
    'Should add collapsed class when disabled');
});

// === 3. Main.js Integration ===
console.log('\n=== 3. Main.js Integration ===');

test('main.js calls initProfanitySettingsUI', () => {
  assert.ok(mainJs.includes('initProfanitySettingsUI'),
    'Should call initProfanitySettingsUI on init');
});

test('main.js checks if function exists', () => {
  assert.ok(mainJs.includes("typeof initProfanitySettingsUI === 'function'"),
    'Should check if function exists before calling');
});

// === 4. Backend Support ===
console.log('\n=== 4. Backend Support ===');

test('Backend accepts customBlocklist parameter', () => {
  assert.ok(profanityDetectionJs.includes('customBlocklist = []'),
    'Should accept customBlocklist parameter');
});

test('Backend accepts customAllowlist parameter', () => {
  assert.ok(profanityDetectionJs.includes('customAllowlist = []'),
    'Should accept customAllowlist parameter');
});

test('Backend merges custom blocklist with base', () => {
  assert.ok(profanityDetectionJs.includes('...customBlocklist'),
    'Should spread customBlocklist into profanity set');
});

test('Backend removes allowlist items', () => {
  assert.ok(profanityDetectionJs.includes('allowlistSet'),
    'Should create allowlist set');
  assert.ok(profanityDetectionJs.includes('profanitySet.delete(allowed)'),
    'Should delete allowlist items from profanity set');
});

test('Backend metadata includes custom list counts', () => {
  assert.ok(profanityDetectionJs.includes('customBlocklistCount: customBlocklist.length'),
    'Should include blocklist count in metadata');
  assert.ok(profanityDetectionJs.includes('customAllowlistCount: customAllowlist.length'),
    'Should include allowlist count in metadata');
});

// === 5. Chapter Title Style UI (Bonus) ===
console.log('\n=== 5. Chapter Title Style UI ===');

test('Chapter title style selector exists', () => {
  assert.ok(indexHtml.includes('id="chapterTitleStyle"'),
    'chapterTitleStyle selector should exist');
});

test('Chapter title style options include standard, youtube, shorts', () => {
  assert.ok(indexHtml.includes('value="standard">Standard'),
    'Should have standard title style option');
  assert.ok(indexHtml.includes('value="youtube">YouTube SEO'),
    'Should have youtube title style option');
  assert.ok(indexHtml.includes('value="shorts">Shorts/TikTok'),
    'Should have shorts title style option');
});

// === Summary ===
console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed === 0) {
  console.log('\n✓ All tests passed!');
} else {
  console.log('\n✗ Some tests failed');
}

process.exit(failed > 0 ? 1 : 0);
