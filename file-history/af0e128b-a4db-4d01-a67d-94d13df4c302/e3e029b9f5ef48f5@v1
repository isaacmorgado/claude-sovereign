/**
 * Chapter Titles Generation E2E Test
 *
 * Tests Feature 4: Enhanced chapter detection with title styles
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// Load files
const serverJs = fs.readFileSync(path.join(__dirname, '../server.js'), 'utf8');
const chapterDetectionJs = fs.readFileSync(path.join(__dirname, '../services/chapterDetection.js'), 'utf8');

console.log('\n=== Chapter Titles Generation E2E Tests ===\n');

// === 1. Chapter Detection Service Tests ===
console.log('=== 1. Chapter Detection Service ===');

test('detectChapters function exists', () => {
  assert.ok(chapterDetectionJs.includes('async function detectChapters(transcript, settings'),
    'detectChapters function should exist');
});

test('detectChapters accepts titleStyle setting', () => {
  assert.ok(chapterDetectionJs.includes("titleStyle = 'standard'"),
    'Should destructure titleStyle with default');
});

test('buildChapterPrompt accepts titleStyle parameter', () => {
  assert.ok(chapterDetectionJs.includes("function buildChapterPrompt(text, maxChapters, minLength, duration, titleStyle = 'standard')"),
    'buildChapterPrompt should accept titleStyle parameter');
});

test('buildChapterPrompt has youtube title style', () => {
  assert.ok(chapterDetectionJs.includes("case 'youtube':"),
    'Should have youtube case in switch');
  assert.ok(chapterDetectionJs.includes('SEO-optimized'),
    'YouTube style should mention SEO optimization');
});

test('buildChapterPrompt has shorts title style', () => {
  assert.ok(chapterDetectionJs.includes("case 'shorts':"),
    'Should have shorts case in switch');
  assert.ok(chapterDetectionJs.includes('hook-style'),
    'Shorts style should mention hook-style titles');
});

test('buildChapterPrompt has standard title style', () => {
  assert.ok(chapterDetectionJs.includes('default:'),
    'Should have default case for standard style');
});

test('detectChapters passes titleStyle to buildChapterPrompt', () => {
  assert.ok(chapterDetectionJs.includes('buildChapterPrompt(text, maxChapters, minChapterLength, duration, titleStyle)'),
    'Should pass titleStyle to buildChapterPrompt');
});

test('Prompt requests keywords from AI', () => {
  assert.ok(chapterDetectionJs.includes('"keywords"'),
    'Prompt should include keywords in response format');
  assert.ok(chapterDetectionJs.includes('Include 2-3 relevant keywords'),
    'Prompt should request keywords for SEO');
});

// === 2. Keyword Preservation Tests ===
console.log('\n=== 2. Keyword Preservation ===');

test('validateChapters preserves keywords', () => {
  assert.ok(chapterDetectionJs.includes('chapter.keywords'),
    'Should access chapter.keywords');
  assert.ok(chapterDetectionJs.includes('keywords.slice(0, 5)'),
    'Should limit keywords to 5');
});

test('Chapters include keywords field', () => {
  assert.ok(chapterDetectionJs.includes('keywords\n    });'),
    'validChapters.push should include keywords');
});

test('Markers include keywords', () => {
  assert.ok(chapterDetectionJs.includes("keywords: ch.keywords"),
    'Markers should include keywords from chapters');
});

// === 3. Metadata Tests ===
console.log('\n=== 3. Metadata ===');

test('Metadata includes titleStyle', () => {
  assert.ok(chapterDetectionJs.includes('titleStyle\n      }'),
    'Metadata should include titleStyle');
});

test('Metadata includes model info', () => {
  assert.ok(chapterDetectionJs.includes("model: 'gpt-4o-mini'"),
    'Metadata should include model');
});

// === 4. Server Endpoint Tests ===
console.log('\n=== 4. Server Endpoint ===');

test('POST /chapters endpoint exists', () => {
  assert.ok(serverJs.includes("app.post('/chapters'"),
    'POST /chapters endpoint should exist');
});

test('Endpoint requires credits', () => {
  assert.ok(serverJs.includes("requireCredits({ endpoint: 'chapters' })"),
    'Endpoint should require credits');
});

test('Endpoint accepts settings with titleStyle', () => {
  assert.ok(serverJs.includes("titleStyle: 'standard' | 'youtube' | 'shorts'"),
    'Endpoint docs should list titleStyle options');
});

test('Endpoint logs titleStyle', () => {
  assert.ok(serverJs.includes("style: ${settings.titleStyle || 'standard'}"),
    'Should log titleStyle in console');
});

test('Endpoint passes settings to detectChapters', () => {
  assert.ok(serverJs.includes('await detectChapters(transcriptData, settings)'),
    'Should pass settings to detectChapters');
});

// === 5. YouTube Timestamp Format ===
console.log('\n=== 5. YouTube Timestamp Format ===');

test('formatYouTubeTimestamps function exists', () => {
  assert.ok(chapterDetectionJs.includes('function formatYouTubeTimestamps(chapters)'),
    'formatYouTubeTimestamps function should exist');
});

test('formatYouTubeTimestamps handles hours', () => {
  assert.ok(chapterDetectionJs.includes('if (hours > 0)'),
    'Should handle hour-length videos');
  assert.ok(chapterDetectionJs.includes('hours}:${minutes'),
    'Should format hours:minutes:seconds');
});

test('formatYouTubeTimestamps pads minutes and seconds', () => {
  assert.ok(chapterDetectionJs.includes('padStart(2'),
    'Should pad with zeros');
});

test('formatYouTubeTimestamps returns newline-separated', () => {
  assert.ok(chapterDetectionJs.includes(".join('\\n')"),
    'Should join timestamps with newlines');
});

// === 6. Fallback Detection ===
console.log('\n=== 6. Fallback Detection ===');

test('detectChaptersFallback function exists', () => {
  assert.ok(chapterDetectionJs.includes('function detectChaptersFallback(transcript, settings'),
    'detectChaptersFallback function should exist');
});

test('detectChaptersFallback is exported', () => {
  assert.ok(chapterDetectionJs.includes('detectChaptersFallback,'),
    'detectChaptersFallback should be exported');
});

test('Fallback endpoint exists', () => {
  assert.ok(serverJs.includes("app.post('/chapters/fallback'"),
    'POST /chapters/fallback endpoint should exist');
});

// === 7. Module Exports ===
console.log('\n=== 7. Module Exports ===');

test('detectChapters is exported', () => {
  assert.ok(chapterDetectionJs.includes('detectChapters,'),
    'detectChapters should be exported');
});

test('formatYouTubeTimestamps is exported', () => {
  assert.ok(chapterDetectionJs.includes('formatYouTubeTimestamps,'),
    'formatYouTubeTimestamps should be exported');
});

test('extractText is exported', () => {
  assert.ok(chapterDetectionJs.includes('extractText,'),
    'extractText should be exported');
});

test('validateChapters is exported', () => {
  assert.ok(chapterDetectionJs.includes('validateChapters'),
    'validateChapters should be exported');
});

// === Summary ===
console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed === 0) {
  console.log('\n✓ All tests passed!');
} else {
  console.log('\n✗ Some tests failed');
}

process.exit(failed > 0 ? 1 : 0);
