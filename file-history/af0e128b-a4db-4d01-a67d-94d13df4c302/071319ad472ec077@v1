/**
 * Bleep Sound Insertion E2E Test
 *
 * Tests Feature 3: Generate and insert bleep audio into timeline
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// Load files
const serverJs = fs.readFileSync(path.join(__dirname, '../server.js'), 'utf8');
const profanityDetectionJs = fs.readFileSync(path.join(__dirname, '../services/profanityDetection.js'), 'utf8');
const builderJs = fs.readFileSync(path.join(__dirname, '../../splice-plugin/js/builder.js'), 'utf8');

console.log('\n=== Bleep Sound Insertion E2E Tests ===\n');

// === 1. Profanity Detection Service Tests ===
console.log('=== 1. Profanity Detection Service ===');

test('generateBleepAudio function exists', () => {
  assert.ok(profanityDetectionJs.includes('async function generateBleepAudio'),
    'generateBleepAudio function should exist');
});

test('generateBleepsForSegments function exists', () => {
  assert.ok(profanityDetectionJs.includes('async function generateBleepsForSegments'),
    'generateBleepsForSegments function should exist');
});

test('BLEEP_SOUNDS constant exists with types', () => {
  assert.ok(profanityDetectionJs.includes('BLEEP_SOUNDS'),
    'BLEEP_SOUNDS constant should exist');
  assert.ok(profanityDetectionJs.includes('standard'),
    'Should have standard bleep type');
});

test('Generates WAV header correctly', () => {
  assert.ok(profanityDetectionJs.includes("buffer.write('RIFF'"),
    'Should write RIFF header');
  assert.ok(profanityDetectionJs.includes("buffer.write('WAVE'"),
    'Should write WAVE format');
});

test('generateBleepAudio is exported', () => {
  assert.ok(profanityDetectionJs.includes('generateBleepAudio,'),
    'generateBleepAudio should be exported');
});

test('generateBleepsForSegments is exported', () => {
  assert.ok(profanityDetectionJs.includes('generateBleepsForSegments,'),
    'generateBleepsForSegments should be exported');
});

// === 2. Server Endpoint Tests ===
console.log('\n=== 2. Server Endpoint ===');

test('POST /profanity/generate-bleeps endpoint exists', () => {
  assert.ok(serverJs.includes("app.post('/profanity/generate-bleeps'"),
    'POST /profanity/generate-bleeps endpoint should exist');
});

test('Endpoint requires credits', () => {
  assert.ok(serverJs.includes("requireCredits({ endpoint: 'profanity-bleeps' })"),
    'Endpoint should require credits');
});

test('Endpoint accepts segments parameter', () => {
  assert.ok(serverJs.includes('const { segments, bleepType'),
    'Should destructure segments from request body');
});

test('Endpoint validates segments is array', () => {
  assert.ok(serverJs.includes('!Array.isArray(segments)'),
    'Should validate segments is an array');
});

test('Endpoint validates segment start/end', () => {
  assert.ok(serverJs.includes("typeof segments[i].start !== 'number'"),
    'Should validate segment start is a number');
  assert.ok(serverJs.includes("typeof segments[i].end !== 'number'"),
    'Should validate segment end is a number');
});

test('Endpoint calls generateBleepsForSegments', () => {
  assert.ok(serverJs.includes('await generateBleepsForSegments(segments'),
    'Should call generateBleepsForSegments');
});

test('Endpoint returns bleepCount', () => {
  assert.ok(serverJs.includes('bleepCount: bleeps.length'),
    'Should return bleep count');
});

test('Endpoint deducts usage', () => {
  const endpointSection = serverJs.match(/app\.post\('\/profanity\/generate-bleeps'[\s\S]*?catch \(err\)/);
  assert.ok(endpointSection && endpointSection[0].includes('req.deductUsage'),
    'Should deduct usage based on total duration');
});

// === 3. Server Imports ===
console.log('\n=== 3. Server Imports ===');

test('Server imports generateBleepsForSegments', () => {
  assert.ok(serverJs.includes('generateBleepsForSegments'),
    'Should import generateBleepsForSegments from profanityDetection');
});

test('Server imports cleanupBleepFiles', () => {
  assert.ok(serverJs.includes('cleanupBleepFiles'),
    'Should import cleanupBleepFiles from profanityDetection');
});

// === 4. Builder - Bleep Insertion Functions ===
console.log('\n=== 4. Builder Bleep Insertion ===');

test('insertBleepAudio function exists', () => {
  assert.ok(builderJs.includes('async function insertBleepAudio'),
    'insertBleepAudio function should exist');
});

test('applyProfanityBleeps function exists', () => {
  assert.ok(builderJs.includes('async function applyProfanityBleeps'),
    'applyProfanityBleeps function should exist');
});

test('insertBleepAudio gets sequence editor', () => {
  assert.ok(builderJs.includes('SequenceEditor.getEditor(sequence)'),
    'Should get sequence editor for insertion');
});

test('insertBleepAudio imports audio file', () => {
  assert.ok(builderJs.includes('project.importFile(bleep.path)'),
    'Should import bleep audio file into project');
});

test('insertBleepAudio creates insert action', () => {
  assert.ok(builderJs.includes('editor.createInsertProjectItemAction'),
    'Should create insert project item action');
});

test('insertBleepAudio inserts on audio track', () => {
  // Check that it uses audioTrackIndex parameter
  assert.ok(builderJs.includes('audioTrackIndex'),
    'Should use audioTrackIndex for audio track placement');
});

test('insertBleepAudio uses TickTime for timing', () => {
  assert.ok(builderJs.includes('TickTime.createWithSeconds(bleep.segmentStart)'),
    'Should convert segment start to TickTime');
});

test('insertBleepAudio is exported', () => {
  assert.ok(builderJs.includes('insertBleepAudio,'),
    'insertBleepAudio should be exported in spliceBuilder');
});

test('applyProfanityBleeps is exported', () => {
  assert.ok(builderJs.includes('applyProfanityBleeps,'),
    'applyProfanityBleeps should be exported in spliceBuilder');
});

test('applyProfanityBleeps calls generate-bleeps endpoint', () => {
  assert.ok(builderJs.includes('/profanity/generate-bleeps'),
    'Should call the generate-bleeps endpoint');
});

test('applyProfanityBleeps calls insertBleepAudio', () => {
  assert.ok(builderJs.includes('await insertBleepAudio(data.bleeps'),
    'Should call insertBleepAudio with generated bleeps');
});

// === Summary ===
console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed === 0) {
  console.log('\n✓ All tests passed!');
} else {
  console.log('\n✗ Some tests failed');
}

process.exit(failed > 0 ? 1 : 0);
