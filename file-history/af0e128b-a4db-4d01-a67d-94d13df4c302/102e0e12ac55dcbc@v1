/**
 * Word-Level Timestamps E2E Test
 *
 * Tests Feature 2: Word-level timestamps with frame alignment
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${err.message}`);
    failed++;
  }
}

// Load files
const serverJs = fs.readFileSync(path.join(__dirname, '../server.js'), 'utf8');
const transcriptionJs = fs.readFileSync(path.join(__dirname, '../services/transcription.js'), 'utf8');
const cutListGeneratorJs = fs.readFileSync(path.join(__dirname, '../services/cutListGenerator.js'), 'utf8');

console.log('\n=== Word-Level Timestamps E2E Tests ===\n');

// === 1. Transcription Service Tests ===
console.log('=== 1. Transcription Service ===');

test('transcribeFull function exists', () => {
  assert.ok(transcriptionJs.includes('async function transcribeFull(wavPath)'),
    'transcribeFull function should exist');
});

test('transcribeFull requests word-level granularity', () => {
  assert.ok(transcriptionJs.includes("timestamp_granularities: ['word', 'segment']"),
    'Should request both word and segment timestamps');
});

test('transcribeFull returns words array', () => {
  assert.ok(transcriptionJs.includes('words: (transcription.words'),
    'Should return words array');
});

test('Word objects include start and end timestamps', () => {
  assert.ok(transcriptionJs.includes('start: w.start'),
    'Should include start timestamp');
  assert.ok(transcriptionJs.includes('end: w.end'),
    'Should include end timestamp');
});

test('transcribeFull is exported', () => {
  assert.ok(transcriptionJs.includes('transcribeFull') && transcriptionJs.includes('module.exports'),
    'transcribeFull should be exported');
});

// === 2. Frame Alignment Functions ===
console.log('\n=== 2. Frame Alignment Functions ===');

test('alignToFrame function exists', () => {
  assert.ok(cutListGeneratorJs.includes('function alignToFrame(time, frameRate)'),
    'alignToFrame function should exist');
});

test('alignToFrameFloor function exists', () => {
  assert.ok(cutListGeneratorJs.includes('function alignToFrameFloor(time, frameRate)'),
    'alignToFrameFloor function should exist');
});

test('alignToFrameCeil function exists', () => {
  assert.ok(cutListGeneratorJs.includes('function alignToFrameCeil(time, frameRate)'),
    'alignToFrameCeil function should exist');
});

test('Frame alignment functions are exported', () => {
  assert.ok(cutListGeneratorJs.includes('alignToFrame,'),
    'alignToFrame should be exported');
  assert.ok(cutListGeneratorJs.includes('alignToFrameFloor,'),
    'alignToFrameFloor should be exported');
  assert.ok(cutListGeneratorJs.includes('alignToFrameCeil'),
    'alignToFrameCeil should be exported');
});

// === 3. Server Endpoint Tests ===
console.log('\n=== 3. Server Endpoint ===');

test('/transcribe/word-level endpoint exists', () => {
  assert.ok(serverJs.includes("app.post('/transcribe/word-level'"),
    'POST /transcribe/word-level endpoint should exist');
});

test('Endpoint requires credits', () => {
  assert.ok(serverJs.includes("requireCredits({ endpoint: 'transcribe-word-level' })"),
    'Endpoint should require credits');
});

test('Endpoint accepts wavPath parameter', () => {
  const endpointMatch = serverJs.match(/app\.post\('\/transcribe\/word-level'[\s\S]*?const \{ wavPath, frameRate/);
  assert.ok(endpointMatch, 'Should destructure wavPath from request body');
});

test('Endpoint accepts frameRate parameter', () => {
  assert.ok(serverJs.includes('frameRate = 0'),
    'Should accept optional frameRate with default 0');
});

test('Endpoint validates wavPath', () => {
  assert.ok(serverJs.includes("'wavPath is required'"),
    'Should validate wavPath is provided');
});

test('Endpoint checks file exists', () => {
  assert.ok(serverJs.includes('await fileExists(wavPath)'),
    'Should check if file exists');
});

test('Endpoint calls transcribeFull', () => {
  assert.ok(serverJs.includes('await transcribeFull(wavPath)'),
    'Should call transcribeFull for word-level timestamps');
});

test('Endpoint applies frame alignment when frameRate > 0', () => {
  assert.ok(serverJs.includes('hasFrameAlignment = frameRate > 0'),
    'Should check if frame alignment is requested');
  assert.ok(serverJs.includes('alignToFrameFloor(w.start, frameRate)'),
    'Should use alignToFrameFloor for start times');
  assert.ok(serverJs.includes('alignToFrameCeil(w.end, frameRate)'),
    'Should use alignToFrameCeil for end times');
});

test('Endpoint returns startAligned and endAligned', () => {
  assert.ok(serverJs.includes('startAligned:'),
    'Should return startAligned for each word');
  assert.ok(serverJs.includes('endAligned:'),
    'Should return endAligned for each word');
});

test('Endpoint returns wordCount', () => {
  assert.ok(serverJs.includes('wordCount: words.length'),
    'Should return word count');
});

test('Endpoint returns frameAligned flag', () => {
  assert.ok(serverJs.includes('frameAligned: hasFrameAlignment'),
    'Should return frameAligned boolean');
});

test('Endpoint deducts usage', () => {
  const endpointSection = serverJs.match(/app\.post\('\/transcribe\/word-level'[\s\S]*?catch \(err\)/);
  assert.ok(endpointSection && endpointSection[0].includes('req.deductUsage'),
    'Should deduct usage based on audio duration');
});

// === 4. Imports Test ===
console.log('\n=== 4. Server Imports ===');

test('Server imports transcribeFull', () => {
  assert.ok(serverJs.includes('transcribeFull } = require'),
    'Should import transcribeFull from transcription service');
});

test('Server imports frame alignment functions', () => {
  assert.ok(serverJs.includes('alignToFrame, alignToFrameFloor, alignToFrameCeil'),
    'Should import frame alignment functions from cutListGenerator');
});

// === Summary ===
console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed === 0) {
  console.log('\n✓ All tests passed!');
} else {
  console.log('\n✗ Some tests failed');
}

process.exit(failed > 0 ? 1 : 0);
