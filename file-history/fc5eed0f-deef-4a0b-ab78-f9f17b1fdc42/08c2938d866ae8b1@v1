#!/usr/bin/env bun

/**
 * Komplete Kontrol CLI
 * Ultimate AI coding assistant integrating Roo Code, /auto, and advanced autonomous features
 */

import { Command } from 'commander';
import chalk from 'chalk';
import { createLLMClient } from './core/llm';
import type { CommandContext } from './cli/types';
import {
  AutoCommand,
  SPARCCommand,
  SwarmCommand,
  ReflectCommand,
  ResearchCommand,
  RootCauseCommand
} from './cli/commands';

const program = new Command();

program
  .name('komplete')
  .description('Ultimate AI coding assistant with autonomous capabilities')
  .version('1.0.0');

/**
 * Initialize command context
 */
async function initializeContext(): Promise<CommandContext> {
  const llmClient = await createLLMClient();

  return {
    llmRouter: llmClient.router,
    llmRegistry: llmClient.registry,
    workDir: process.cwd(),
    autonomousMode: false,
    verbose: false
  };
}

/**
 * /auto - Autonomous mode
 */
program
  .command('auto')
  .description('Enter autonomous mode with ReAct + Reflexion loop')
  .argument('<goal>', 'Goal to achieve autonomously')
  .option('-m, --model <model>', 'Model to use. Supports provider/model syntax (e.g., "glm/glm-4.7", "dolphin-3"). Default: auto-routed')
  .option('-i, --iterations <number>', 'Max iterations (default: 50)', '50')
  .option('-c, --checkpoint <number>', 'Checkpoint every N iterations (default: 10)', '10')
  .option('-v, --verbose', 'Verbose output', false)
  .action(async (goal: string, options: any) => {
    try {
      const context = await initializeContext();
      context.verbose = options.verbose;
      context.autonomousMode = true;

      const autoCommand = new AutoCommand();
      const result = await autoCommand.execute(context, {
        goal,
        model: options.model,
        maxIterations: parseInt(options.iterations, 10),
        checkpointThreshold: parseInt(options.checkpoint, 10),
        verbose: options.verbose
      });

      if (!result.success) {
        console.error(chalk.red('\nError:'), result.message);
        process.exit(1);
      }
    } catch (error) {
      const err = error as Error;
      console.error(chalk.red('\nFatal error:'), err.message);
      process.exit(1);
    }
  });

/**
 * /init - Initialize project
 */
program
  .command('init')
  .description('Initialize komplete in current project')
  .action(() => {
    console.log(chalk.green('âœ… Komplete initialized'));
    console.log(chalk.gray('Created .komplete/ directory with configuration'));
  });

// Error handling
program.exitOverride((err) => {
  // Help-related errors should exit cleanly
  if (err.code === 'commander.help' || err.code === 'outputHelp' ||
      err.message?.includes('outputHelp') || err.message?.includes('help')) {
    process.exit(0);
  }
  console.error(chalk.red('Error:'), err.message);
  process.exit(1);
});

program.parse();
