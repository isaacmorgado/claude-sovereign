#!/usr/bin/env node
/**
 * SPLICE Beta Tester Account Seeding Script
 *
 * Clears all existing users and license keys, then creates 3 beta tester accounts
 * with full Team tier access and unlimited credits.
 *
 * Usage:
 *   railway run node scripts/seed-beta-testers.js
 */

require('dotenv').config();
const { Pool } = require('pg');

const DATABASE_URL = process.env.DATABASE_URL;

if (!DATABASE_URL) {
  console.error('ERROR: DATABASE_URL environment variable is required');
  process.exit(1);
}

const pool = new Pool({
  connectionString: DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

// Beta tester accounts from BETA TESTERS folder
const BETA_TESTERS = [
  {
    name: 'Josh Irizarry',
    customerId: 'beta_josh_irizarry',
    email: 'josh@splice-beta.test',
    licenseKey: 'SPLICE-GW6N-88DP-5DDD'
  },
  {
    name: 'Danny Isakov',
    customerId: 'beta_danny_isakov',
    email: 'danny@splice-beta.test',
    licenseKey: 'SPLICE-Y2Q9-6G9G-MFQE'
  },
  {
    name: 'Jimmy Nick',
    customerId: 'beta_jimmy_nick',
    email: 'jimmy@splice-beta.test',
    licenseKey: 'SPLICE-UC2G-R5H8-UKHF'
  }
];

async function seedBetaTesters() {
  const client = await pool.connect();

  try {
    console.log('Starting beta tester account seeding...\n');

    await client.query('BEGIN');

    // Step 1: Delete dependent tables first (foreign key constraints)
    console.log('Deleting dependent data...');

    // Helper function to check if table exists
    async function tableExists(tableName) {
      const result = await client.query(`
        SELECT EXISTS (
          SELECT FROM information_schema.tables
          WHERE table_schema = 'public'
          AND table_name = $1
        )
      `, [tableName]);
      return result.rows[0].exists;
    }

    // Helper function to safely delete from a table
    async function safeDelete(tableName) {
      if (await tableExists(tableName)) {
        const result = await client.query(`DELETE FROM ${tableName} RETURNING *`);
        console.log(`  Deleted ${result.rowCount} ${tableName} record(s)`);
        return result.rowCount;
      } else {
        console.log(`  Table ${tableName} does not exist, skipping`);
        return 0;
      }
    }

    await safeDelete('usage_log');
    await safeDelete('generated_music');
    await safeDelete('license_keys');
    await safeDelete('webhook_events');
    console.log('');

    // Step 2: Delete all existing users
    console.log('Deleting existing users...');
    const deletedUsers = await client.query('DELETE FROM users RETURNING *');
    console.log(`  Deleted ${deletedUsers.rowCount} user(s)\n`);

    // Step 3: Insert beta tester users
    console.log('Creating beta tester accounts...');
    for (const tester of BETA_TESTERS) {
      await client.query(`
        INSERT INTO users (
          stripe_customer_id,
          email,
          tier,
          hours_remaining,
          hours_total,
          isolation_hours_remaining,
          isolation_hours_total,
          email_verified,
          created_at,
          updated_at
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW(), NOW())
      `, [
        tester.customerId,
        tester.email,
        'team',           // Highest tier
        999999,           // hours_remaining (unlimited)
        999999,           // hours_total
        999999,           // isolation_hours_remaining (unlimited)
        999999,           // isolation_hours_total
        true              // email_verified
      ]);
      console.log(`  Created user: ${tester.name} (${tester.email})`);
    }
    console.log('');

    // Step 4: Insert pre-activated license keys
    console.log('Creating pre-activated license keys...');
    for (const tester of BETA_TESTERS) {
      await client.query(`
        INSERT INTO license_keys (
          key,
          stripe_customer_id,
          created_at,
          activated_at,
          is_active
        ) VALUES ($1, $2, NOW(), NOW(), $3)
      `, [
        tester.licenseKey,
        tester.customerId,
        true
      ]);
      console.log(`  Created key: ${tester.licenseKey} -> ${tester.name}`);
    }
    console.log('');

    await client.query('COMMIT');

    console.log('='.repeat(60));
    console.log('BETA TESTER SEEDING COMPLETE');
    console.log('='.repeat(60));
    console.log('\nCreated 3 beta tester accounts with Team tier access:\n');

    for (const tester of BETA_TESTERS) {
      console.log(`${tester.name}`);
      console.log(`  Email:       ${tester.email}`);
      console.log(`  License Key: ${tester.licenseKey}`);
      console.log('');
    }

    console.log('All accounts have:');
    console.log('  - Team tier (all features enabled)');
    console.log('  - 999,999 processing hours (unlimited)');
    console.log('  - 999,999 isolation hours (unlimited)');
    console.log('  - Pre-activated license keys (ready to use)');
    console.log('  - Email verified');

  } catch (err) {
    await client.query('ROLLBACK');
    console.error('ERROR:', err.message);
    throw err;
  } finally {
    client.release();
  }
}

async function main() {
  try {
    await seedBetaTesters();
    process.exit(0);
  } catch (err) {
    console.error('Seeding failed:', err.message);
    process.exit(1);
  } finally {
    await pool.end();
  }
}

main();
