import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'

// Mock the AWS SDK before importing the service
vi.mock('@aws-sdk/client-s3', () => ({
  S3Client: vi.fn().mockImplementation(() => ({})),
  PutObjectCommand: vi.fn().mockImplementation((params: unknown) => params as object),
  GetObjectCommand: vi.fn().mockImplementation((params: unknown) => params as object),
}))

vi.mock('@aws-sdk/s3-request-presigner', () => ({
  getSignedUrl: vi.fn().mockResolvedValue('https://signed-url.example.com'),
}))

// Mock crypto.randomUUID for predictable file keys
vi.mock('crypto', async () => {
  const actual = await vi.importActual<typeof import('crypto')>('crypto')
  return {
    ...actual,
    default: {
      ...actual,
      randomUUID: vi.fn().mockReturnValue('test-uuid-1234'),
    },
  }
})

describe('s3Service', () => {
  beforeEach(() => {
    vi.resetModules()
  })

  afterEach(() => {
    vi.clearAllMocks()
  })

  describe('isConfigured', () => {
    it('should return true when all S3 credentials are configured', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      expect(s3Service.isConfigured()).toBe(true)
    })

    it('should return false when S3_BUCKET_NAME is missing', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: undefined,
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      expect(s3Service.isConfigured()).toBe(false)
    })

    it('should return false when AWS_ACCESS_KEY_ID is missing', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: undefined,
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      expect(s3Service.isConfigured()).toBe(false)
    })

    it('should return false when AWS_SECRET_ACCESS_KEY is missing', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: undefined,
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      expect(s3Service.isConfigured()).toBe(false)
    })
  })

  describe('generateUploadUrl', () => {
    it('should generate a presigned upload URL for valid audio file', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
          S3_ENDPOINT: undefined,
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      const result = await s3Service.generateUploadUrl(
        'user-123',
        'audio.mp3',
        'audio/mpeg',
        1024 * 1024 // 1MB
      )

      expect(result).toEqual({
        uploadUrl: 'https://signed-url.example.com',
        fileKey: 'uploads/user-123/test-uuid-1234.mp3',
        publicUrl: 'https://test-bucket.s3.us-east-1.amazonaws.com/uploads/user-123/test-uuid-1234.mp3',
      })
    })

    it('should generate LocalStack-style URL when S3_ENDPOINT is set', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
          S3_ENDPOINT: 'http://localhost:4566',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      const result = await s3Service.generateUploadUrl(
        'user-123',
        'audio.wav',
        'audio/wav',
        1024 * 1024
      )

      expect(result.publicUrl).toBe(
        'http://localhost:4566/test-bucket/uploads/user-123/test-uuid-1234.wav'
      )
    })

    it('should throw error when S3 is not configured', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: undefined,
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      await expect(
        s3Service.generateUploadUrl('user-123', 'audio.mp3', 'audio/mpeg', 1024)
      ).rejects.toThrow('S3 is not configured')
    })

    it('should throw error for invalid content type', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      await expect(
        s3Service.generateUploadUrl('user-123', 'file.txt', 'text/plain', 1024)
      ).rejects.toThrow('Invalid content type: text/plain')
    })

    it('should throw error when file size exceeds maximum', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      const maxSize = 500 * 1024 * 1024 // 500MB
      await expect(
        s3Service.generateUploadUrl('user-123', 'large.mp3', 'audio/mpeg', maxSize + 1)
      ).rejects.toThrow('File too large. Maximum size is 500MB')
    })

    it('should accept all allowed audio content types', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      const allowedTypes = [
        'audio/mpeg',
        'audio/mp3',
        'audio/wav',
        'audio/wave',
        'audio/x-wav',
        'audio/aac',
        'audio/ogg',
        'audio/flac',
        'audio/m4a',
        'audio/x-m4a',
        'video/mp4',
        'video/quicktime',
      ]

      for (const contentType of allowedTypes) {
        const result = await s3Service.generateUploadUrl(
          'user-123',
          'file.audio',
          contentType,
          1024
        )
        expect(result.uploadUrl).toBeDefined()
      }
    })

    it('should extract correct file extension from filename', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      const result = await s3Service.generateUploadUrl(
        'user-123',
        'my.song.recording.flac',
        'audio/flac',
        1024
      )

      expect(result.fileKey).toBe('uploads/user-123/test-uuid-1234.flac')
    })

    it('should use default extension when filename has none', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      const result = await s3Service.generateUploadUrl(
        'user-123',
        'audiofile',
        'audio/mpeg',
        1024
      )

      // When there's no dot, split('.').pop() returns the whole filename
      expect(result.fileKey).toBe('uploads/user-123/test-uuid-1234.audiofile')
    })
  })

  describe('generateDownloadUrl', () => {
    it('should generate a presigned download URL', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: 'test-bucket',
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      const result = await s3Service.generateDownloadUrl('uploads/user-123/file.mp3')

      expect(result).toBe('https://signed-url.example.com')
    })

    it('should throw error when S3 is not configured', async () => {
      vi.doMock('../config/env.js', () => ({
        env: {
          S3_BUCKET_NAME: undefined,
          AWS_ACCESS_KEY_ID: 'test-key',
          AWS_SECRET_ACCESS_KEY: 'test-secret',
          AWS_REGION: 'us-east-1',
        },
      }))

      const { s3Service } = await import('./s3-service.js')
      await expect(
        s3Service.generateDownloadUrl('uploads/user-123/file.mp3')
      ).rejects.toThrow('S3 is not configured')
    })
  })
})
