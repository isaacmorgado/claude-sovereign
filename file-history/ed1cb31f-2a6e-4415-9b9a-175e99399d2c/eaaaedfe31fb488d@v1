/**
 * Phase 5 Feature Validation Script
 *
 * Run with: npx tsx scripts/validate-phase5.ts
 */

import {
  getSeverityFromZScore,
  getSeverityColor,
  getSeverityLabel,
  MasterMetricConfig,
} from '../src/lib/insights-engine';

import {
  validateSideProfileDepth,
} from '../src/lib/mediapipeDetection';

// Test results tracking
let passed = 0;
let failed = 0;

function test(name: string, fn: () => boolean) {
  try {
    if (fn()) {
      console.log(`✅ ${name}`);
      passed++;
    } else {
      console.log(`❌ ${name}`);
      failed++;
    }
  } catch (error) {
    console.log(`❌ ${name} - Error: ${error}`);
    failed++;
  }
}

console.log('\n========================================');
console.log('PHASE 5 FEATURE VALIDATION');
console.log('========================================\n');

// ============================================
// 5-TIER SEVERITY TESTS
// ============================================

console.log('--- 5-Tier Severity System ---\n');

const testConfig: MasterMetricConfig = {
  name: 'Test Metric',
  ideal: [0.9, 1.1],
  mean: 1.0,
  std_dev: 0.2,
  unit: 'ratio',
  weight: 1.0,
  category: 'Test',
};

test('Ideal: value within ideal range', () => {
  const result = getSeverityFromZScore(1.0, testConfig);
  return result.severity === 'ideal' && result.isInIdeal === true;
});

test('Good: z-score < 0.5', () => {
  // Value 1.08 outside ideal [0.9,1.1] -> use different ideal range
  const config = { ...testConfig, ideal: [0.8, 0.85] as [number, number] };
  const result = getSeverityFromZScore(1.08, config);
  return result.severity === 'good' && result.zScore < 0.5;
});

test('Fair: z-score >= 0.5 and < 1', () => {
  const config = { ...testConfig, ideal: [0.8, 0.85] as [number, number] };
  const result = getSeverityFromZScore(1.15, config);
  return result.severity === 'fair' && result.zScore >= 0.5 && result.zScore < 1;
});

test('Moderate: z-score >= 1 and < 2', () => {
  const config = { ...testConfig, ideal: [0.8, 0.85] as [number, number] };
  const result = getSeverityFromZScore(1.3, config);
  return result.severity === 'moderate' && result.zScore >= 1 && result.zScore < 2;
});

test('Severe: z-score >= 2', () => {
  const config = { ...testConfig, ideal: [0.8, 0.85] as [number, number] };
  const result = getSeverityFromZScore(1.5, config);
  return result.severity === 'severe' && result.zScore >= 2;
});

test('Severity colors correct for all 5 tiers', () => {
  return (
    getSeverityColor('ideal') === 'green' &&
    getSeverityColor('good') === 'blue' &&
    getSeverityColor('fair') === 'cyan' &&
    getSeverityColor('moderate') === 'yellow' &&
    getSeverityColor('severe') === 'red'
  );
});

test('Severity labels correct for all 5 tiers', () => {
  return (
    getSeverityLabel('ideal') === 'Ideal' &&
    getSeverityLabel('good') === 'Good' &&
    getSeverityLabel('fair') === 'Fair' &&
    getSeverityLabel('moderate') === 'Moderate' &&
    getSeverityLabel('severe') === 'Severe'
  );
});

// ============================================
// DEPTH VARIANCE TESTS
// ============================================

console.log('\n--- Side Profile Depth Variance ---\n');

function createLandmarks(overrides: Record<string, { x: number; y: number }> = {}) {
  const defaults: Record<string, { x: number; y: number }> = {
    pronasale: { x: 0.2, y: 0.5 },
    nasion: { x: 0.25, y: 0.35 },
    porion: { x: 0.7, y: 0.4 },
    tragus: { x: 0.72, y: 0.42 },
    orbitale: { x: 0.3, y: 0.4 },
    pogonion: { x: 0.35, y: 0.85 },
    subnasale: { x: 0.28, y: 0.55 },
  };
  const merged = { ...defaults, ...overrides };
  return Object.entries(merged).map(([id, coords]) => ({ id, ...coords }));
}

test('Validates proper side profile', () => {
  const landmarks = createLandmarks();
  const result = validateSideProfileDepth(landmarks);
  return result.isValid && result.confidence >= 0.5 && result.issues.length === 0;
});

test('Detects insufficient depth spread', () => {
  const landmarks = createLandmarks({
    pronasale: { x: 0.45, y: 0.5 },
    porion: { x: 0.55, y: 0.4 },
  });
  const result = validateSideProfileDepth(landmarks);
  return !result.isValid && result.depthSpread < 0.15;
});

test('Detects low nasal projection', () => {
  const landmarks = createLandmarks({
    pronasale: { x: 0.27, y: 0.5 },
    subnasale: { x: 0.28, y: 0.55 },
  });
  const result = validateSideProfileDepth(landmarks);
  return result.nosalProjection < 0.05;
});

test('Detects head tilt via Frankfort plane', () => {
  const landmarks = createLandmarks();
  const frankfortPlane = {
    angle: 25,
    orbitale: { x: 0.3, y: 0.4 },
    porion: { x: 0.7, y: 0.55 },
  };
  const result = validateSideProfileDepth(landmarks, frankfortPlane);
  return result.frankfortDeviation > 15 && result.issues.some(i => i.includes('Head tilt'));
});

test('Handles missing landmarks gracefully', () => {
  const landmarks = [{ id: 'nasion', x: 0.25, y: 0.35 }];
  const result = validateSideProfileDepth(landmarks);
  return result.confidence < 1 && result.issues.length > 0;
});

test('Confidence clamped between 0 and 1', () => {
  const landmarks = createLandmarks({
    pronasale: { x: 0.5, y: 0.5 },
    porion: { x: 0.52, y: 0.4 },
    subnasale: { x: 0.5, y: 0.55 },
  });
  const result = validateSideProfileDepth(landmarks);
  return result.confidence >= 0 && result.confidence <= 1;
});

// ============================================
// SUMMARY
// ============================================

console.log('\n========================================');
console.log(`RESULTS: ${passed} passed, ${failed} failed`);
console.log('========================================\n');

if (failed > 0) {
  process.exit(1);
}
