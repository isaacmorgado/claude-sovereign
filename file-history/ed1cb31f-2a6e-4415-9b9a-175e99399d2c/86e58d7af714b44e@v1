/**
 * Phase 5 Feature Tests
 *
 * End-to-end tests for:
 * 1. 5-tier severity system
 * 2. Side profile depth variance validation
 * 3. Component integration checks
 */

import {
  getSeverityFromZScore,
  getSeverityColor,
  getSeverityLabel,
  SeverityLevel,
  MasterMetricConfig,
} from '../insights-engine';

import {
  validateSideProfileDepth,
  DepthVarianceResult,
} from '../mediapipeDetection';

// ============================================
// 5-TIER SEVERITY SYSTEM TESTS
// ============================================

describe('5-Tier Severity System', () => {
  // Sample config for testing
  const testConfig: MasterMetricConfig = {
    name: 'Test Metric',
    ideal: [0.9, 1.1],
    mean: 1.0,
    std_dev: 0.2,
    unit: 'ratio',
    weight: 1.0,
    category: 'Test',
  };

  describe('getSeverityFromZScore', () => {
    test('returns "ideal" when value is within ideal range', () => {
      const result = getSeverityFromZScore(1.0, testConfig);
      expect(result.severity).toBe('ideal');
      expect(result.isInIdeal).toBe(true);
    });

    test('returns "good" when z-score < 0.5', () => {
      // Value at 1.08, z-score = |1.08 - 1.0| / 0.2 = 0.4
      const result = getSeverityFromZScore(1.08, { ...testConfig, ideal: [0.8, 0.85] });
      expect(result.severity).toBe('good');
      expect(result.zScore).toBeLessThan(0.5);
    });

    test('returns "fair" when z-score >= 0.5 and < 1', () => {
      // Value at 1.15, z-score = |1.15 - 1.0| / 0.2 = 0.75
      const result = getSeverityFromZScore(1.15, { ...testConfig, ideal: [0.8, 0.85] });
      expect(result.severity).toBe('fair');
      expect(result.zScore).toBeGreaterThanOrEqual(0.5);
      expect(result.zScore).toBeLessThan(1);
    });

    test('returns "moderate" when z-score >= 1 and < 2', () => {
      // Value at 1.3, z-score = |1.3 - 1.0| / 0.2 = 1.5
      const result = getSeverityFromZScore(1.3, { ...testConfig, ideal: [0.8, 0.85] });
      expect(result.severity).toBe('moderate');
      expect(result.zScore).toBeGreaterThanOrEqual(1);
      expect(result.zScore).toBeLessThan(2);
    });

    test('returns "severe" when z-score >= 2', () => {
      // Value at 1.5, z-score = |1.5 - 1.0| / 0.2 = 2.5
      const result = getSeverityFromZScore(1.5, { ...testConfig, ideal: [0.8, 0.85] });
      expect(result.severity).toBe('severe');
      expect(result.zScore).toBeGreaterThanOrEqual(2);
    });

    test('handles edge case at exact threshold boundaries', () => {
      // z-score = 0.5 exactly
      const value = 1.0 + (0.5 * 0.2); // 1.1
      const result = getSeverityFromZScore(value, { ...testConfig, ideal: [0.8, 0.85] });
      expect(result.severity).toBe('fair'); // 0.5 <= z < 1
    });

    test('handles zero standard deviation', () => {
      const zeroStdConfig = { ...testConfig, std_dev: 0 };
      const result = getSeverityFromZScore(1.5, zeroStdConfig);
      expect(result.zScore).toBe(0);
    });
  });

  describe('getSeverityColor', () => {
    test('returns correct colors for all 5 tiers', () => {
      expect(getSeverityColor('ideal')).toBe('green');
      expect(getSeverityColor('good')).toBe('blue');
      expect(getSeverityColor('fair')).toBe('cyan');
      expect(getSeverityColor('moderate')).toBe('yellow');
      expect(getSeverityColor('severe')).toBe('red');
    });

    test('returns gray for unknown severity', () => {
      expect(getSeverityColor('unknown' as SeverityLevel)).toBe('gray');
    });
  });

  describe('getSeverityLabel', () => {
    test('returns correct labels for all 5 tiers', () => {
      expect(getSeverityLabel('ideal')).toBe('Ideal');
      expect(getSeverityLabel('good')).toBe('Good');
      expect(getSeverityLabel('fair')).toBe('Fair');
      expect(getSeverityLabel('moderate')).toBe('Moderate');
      expect(getSeverityLabel('severe')).toBe('Severe');
    });

    test('returns Unknown for invalid severity', () => {
      expect(getSeverityLabel('invalid' as SeverityLevel)).toBe('Unknown');
    });
  });
});

// ============================================
// SIDE PROFILE DEPTH VARIANCE TESTS
// ============================================

describe('Side Profile Depth Variance Validation', () => {
  // Helper to create landmark array
  const createLandmarks = (overrides: Record<string, { x: number; y: number }> = {}) => {
    const defaults: Record<string, { x: number; y: number }> = {
      pronasale: { x: 0.2, y: 0.5 },      // Nose tip (forward)
      nasion: { x: 0.25, y: 0.35 },       // Nasal root
      porion: { x: 0.7, y: 0.4 },         // Ear opening
      tragus: { x: 0.72, y: 0.42 },       // Ear cartilage
      orbitale: { x: 0.3, y: 0.4 },       // Lowest orbital point
      pogonion: { x: 0.35, y: 0.85 },     // Chin point
      subnasale: { x: 0.28, y: 0.55 },    // Nose base
    };

    const merged = { ...defaults, ...overrides };
    return Object.entries(merged).map(([id, coords]) => ({
      id,
      x: coords.x,
      y: coords.y,
    }));
  };

  describe('validateSideProfileDepth', () => {
    test('validates a proper side profile successfully', () => {
      const landmarks = createLandmarks();
      const result = validateSideProfileDepth(landmarks);

      expect(result.isValid).toBe(true);
      expect(result.confidence).toBeGreaterThanOrEqual(0.5);
      expect(result.depthSpread).toBeGreaterThan(0.15); // Good depth spread
      expect(result.issues).toHaveLength(0);
    });

    test('detects insufficient depth spread', () => {
      // Nose and ear too close together horizontally
      const landmarks = createLandmarks({
        pronasale: { x: 0.45, y: 0.5 },
        porion: { x: 0.55, y: 0.4 },
      });
      const result = validateSideProfileDepth(landmarks);

      expect(result.isValid).toBe(false);
      expect(result.depthSpread).toBeLessThan(0.15);
      expect(result.issues.some(i => i.includes('depth spread'))).toBe(true);
    });

    test('detects low nasal projection', () => {
      // Nose tip and subnasale too close horizontally
      const landmarks = createLandmarks({
        pronasale: { x: 0.27, y: 0.5 },
        subnasale: { x: 0.28, y: 0.55 },
      });
      const result = validateSideProfileDepth(landmarks);

      expect(result.nosalProjection).toBeLessThan(0.05);
      expect(result.issues.some(i => i.includes('nasal projection'))).toBe(true);
    });

    test('detects excessive head tilt via Frankfort plane', () => {
      const landmarks = createLandmarks();
      const frankfortPlane = {
        angle: 25, // More than 15 degrees
        orbitale: { x: 0.3, y: 0.4 },
        porion: { x: 0.7, y: 0.55 }, // Tilted
      };
      const result = validateSideProfileDepth(landmarks, frankfortPlane);

      expect(result.frankfortDeviation).toBeGreaterThan(15);
      expect(result.issues.some(i => i.includes('Head tilt'))).toBe(true);
    });

    test('handles missing landmarks gracefully', () => {
      const landmarks = [
        { id: 'nasion', x: 0.25, y: 0.35 },
        // Missing pronasale and ear landmarks
      ];
      const result = validateSideProfileDepth(landmarks);

      expect(result.confidence).toBeLessThan(1);
      expect(result.issues.some(i => i.includes('Missing key landmarks'))).toBe(true);
    });

    test('validates chin position relative to profile', () => {
      // Very recessed chin (unusually far back)
      const landmarks = createLandmarks({
        pogonion: { x: 0.68, y: 0.85 }, // Almost at ear position
      });
      const result = validateSideProfileDepth(landmarks);

      expect(result.issues.some(i => i.includes('chin position'))).toBe(true);
    });

    test('calculates Frankfort deviation from landmarks when not provided', () => {
      const landmarks = createLandmarks({
        orbitale: { x: 0.3, y: 0.4 },
        porion: { x: 0.7, y: 0.5 }, // Slight tilt
      });
      const result = validateSideProfileDepth(landmarks);

      expect(result.frankfortDeviation).toBeGreaterThan(0);
    });

    test('confidence is clamped between 0 and 1', () => {
      // All bad conditions
      const landmarks = createLandmarks({
        pronasale: { x: 0.5, y: 0.5 },
        porion: { x: 0.52, y: 0.4 },
        subnasale: { x: 0.5, y: 0.55 },
      });
      const result = validateSideProfileDepth(landmarks);

      expect(result.confidence).toBeGreaterThanOrEqual(0);
      expect(result.confidence).toBeLessThanOrEqual(1);
    });
  });
});

// ============================================
// INTEGRATION TESTS
// ============================================

describe('Integration Tests', () => {
  test('severity type includes fair tier', () => {
    const severities: SeverityLevel[] = ['ideal', 'good', 'fair', 'moderate', 'severe'];
    expect(severities).toContain('fair');
    expect(severities.length).toBe(5);
  });

  test('DepthVarianceResult interface is properly structured', () => {
    const mockResult: DepthVarianceResult = {
      isValid: true,
      confidence: 0.85,
      depthSpread: 0.5,
      nosalProjection: 0.08,
      frankfortDeviation: 5,
      issues: [],
    };

    expect(mockResult).toHaveProperty('isValid');
    expect(mockResult).toHaveProperty('confidence');
    expect(mockResult).toHaveProperty('depthSpread');
    expect(mockResult).toHaveProperty('nosalProjection');
    expect(mockResult).toHaveProperty('frankfortDeviation');
    expect(mockResult).toHaveProperty('issues');
  });
});
