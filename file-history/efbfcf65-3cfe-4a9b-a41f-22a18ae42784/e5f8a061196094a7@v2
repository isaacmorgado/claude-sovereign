# LOOKSMAXX E2E Parity Verification

## Context
Major refactoring completed (2025-12-25). Need to verify 95%+ parity with original FaceIQ scoring system.

## Task 1: Run All Tests
```bash
cd looksmaxx-app
npx ts-node test-full-simulation.ts
npx ts-node test-demographic-scoring.ts
npx ts-node scripts/test-male-analysis.ts
npx ts-node scripts/test-female-analysis.ts
npx ts-node scripts/test-all-ethnicities.ts
```

## Task 2: Validate Scoring Algorithm Parity

### 2.1 Exponential Decay (src/lib/scoring/calculator.ts)
Verify `calculateMetricScore()` uses formula:
```
score = maxScore * exp(-decayRate * |deviation|)
```
- Decay rates must be 0.08-0.30 (not 0.5-31.6 like before)
- Test: Value at idealMin/idealMax should score ~10.0
- Test: Value 1 std dev away should score ~7.0-8.0

### 2.2 Bezier Curves (src/lib/bezier-curves.ts)
- Must have exactly 66 curves with 10-24 control points each
- Test: `interpolateCustomCurve()` in calculator.ts
- Verify curves for: nasalTipAngle (128.5-138.5°), gonialAngle, FWHR

### 2.3 Directional Scoring (Polarity)
Check these metrics have correct polarity in `src/lib/data/metric-configs.ts`:
- `canthalTilt`: higher_is_better (positive tilt is good)
- `philtrumLength`: lower_is_better (shorter is better)
- `eLine_upper/lower`: Check sign convention (negative = behind line)

## Task 3: Validate Measurement Parity

### 3.1 Front Profile (src/lib/scoring/analyzer.ts:analyzeFrontProfile)
Must calculate 32+ measurements:
- [ ] Facial thirds (upper/middle/lower proportions)
- [ ] FWHR (face width-to-height ratio)
- [ ] Bigonial width, jaw width ratio
- [ ] Canthal tilt, IPD ratio
- [ ] Eye aspect ratio, eye separation
- [ ] Nasal index, nose width ratio
- [ ] Lip ratio, mouth-to-nose ratio
- [ ] Midface ratio, cheek fullness

### 3.2 Side Profile (src/lib/scoring/analyzer.ts:analyzeSideProfile)
Must calculate 30+ measurements:
- [ ] Gonial angle (ideal: 120-130°)
- [ ] Nasolabial angle (ideal: 90-110°)
- [ ] Nasofrontal angle (ideal: 115-135°)
- [ ] E-line (upper lip -4.7 to -2.3mm, lower -2.8 to -1.2mm)
- [ ] Burstone line, S-line, Holdaway H-line
- [ ] Facial convexity, nasal projection
- [ ] Mandibular plane angle

## Task 4: Validate Demographic Overrides

### 4.1 Check 16 Combinations (src/lib/data/demographic-overrides.ts)
```
Male: white, black, east_asian, south_asian, hispanic, middle_eastern, pacific_islander, native_american
Female: white, black, east_asian, south_asian, hispanic, middle_eastern, pacific_islander, native_american
```

### 4.2 Test Key Differences
- East Asian: wider nasal base ideal (38-48 vs 35-42 for white)
- Black/African: wider bigonial width ideal
- Female: narrower jaw angles, larger eye ratios

## Task 5: Validate Output Parity

### 5.1 Harmony Score (src/lib/scoring/analyzer.ts:analyzeHarmony)
- Weighted average of all metric scores
- Front/side profile split scores
- Category scores (jaw, nose, eyes, etc.)

### 5.2 PSL Rating (src/lib/recommendations/severity.ts:harmonyToPSL)
| Harmony % | PSL | Tier | Percentile |
|-----------|-----|------|------------|
| 100% | 7.5 | Top Model | 99.99% |
| 89% | 7.0 | Chad | 99.87% |
| 78% | 6.5 | Chadlite | 99.0% |
| 67% | 6.0 | HTN+ | 97.25% |
| 56% | 5.5 | HTN | 90.0% |
| 44% | 5.0 | MTN+ | 84.15% |
| 33% | 4.5 | MTN | 65.0% |
| 22% | 4.0 | LTN | 50.0% |
| 11% | 3.5 | Below Avg | 30.0% |
| 0% | 3.0 | Subpar | 15.0% |

### 5.3 Severity Classification (5-tier)
- Optimal: score >= 9.0
- Minor: score >= 7.5
- Moderate: score >= 6.0
- Major: score >= 4.0
- Severe: score < 4.0

### 5.4 Strength/Flaw Detection (src/lib/insights-engine.ts)
- Strengths: metrics with score >= 8.5 (Ideal/Excellent tier)
- Flaws: metrics with score < 6.0 (below Good tier)
- Z-score based severity: |z| > 2σ = Severe, 1-2σ = Moderate

## Task 6: Performance Bottlenecks

### Check These Issues:
1. `/results` page: 380 kB bundle - run `npx next build --analyze`
2. `ResultsContext.tsx`: 13 useMemo hooks - profile with React DevTools
3. `PROCEDURE_DATABASE`: 600+ LOC loaded upfront - consider lazy loading

## Task 7: Live Site Verification

Test at https://looksmaxx-app.vercel.app with real photos:
1. Upload front + side profile photos
2. Compare harmony score to expected range (50-80% typical)
3. Verify PSL rating matches harmony-to-PSL table above
4. Check that strengths show metrics with high scores
5. Check that flaws show metrics with low scores + severity labels
6. Verify recommendations match the detected flaws

## Parity Checklist Summary
- [ ] 66 Bezier curves present and interpolating correctly
- [ ] 70+ metrics with correct ideal ranges
- [ ] Decay rates in 0.08-0.30 range
- [ ] 16 demographic overrides working
- [ ] Harmony → PSL conversion accurate
- [ ] 5-tier severity classification working
- [ ] Strength/flaw detection matches z-score thresholds
- [ ] All tests pass without regressions

## Key Files
```
src/lib/scoring/calculator.ts        # calculateMetricScore, Bezier interpolation
src/lib/scoring/analyzer.ts          # analyzeFrontProfile, analyzeSideProfile, analyzeHarmony
src/lib/data/metric-configs.ts       # METRIC_CONFIGS (70+ metrics, decay rates)
src/lib/data/demographic-overrides.ts # 16 ethnicity/gender overrides
src/lib/bezier-curves.ts             # 66 custom Bezier curves
src/lib/recommendations/severity.ts  # harmonyToPSL, estimatePotentialPSL
src/lib/insights-engine.ts           # classifyInsights, ETHNICITY_OVERRIDES
src/contexts/ResultsContext.tsx      # Results state management
```

## Verification Commands
```bash
npm run lint && npx tsc --noEmit && npm run build
```
