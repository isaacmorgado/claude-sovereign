#!/usr/bin/env node
/**
 * SPLICE Stripe Live Mode Setup Script
 *
 * Creates all products, prices, meters, and coupons in Stripe live mode.
 *
 * Usage:
 *   STRIPE_SECRET_KEY=sk_live_xxx node scripts/setup-stripe-live.js
 *
 * Or set STRIPE_SECRET_KEY in your .env file and run:
 *   node scripts/setup-stripe-live.js
 */

require('dotenv').config();
const Stripe = require('stripe');

const STRIPE_KEY = process.env.STRIPE_SECRET_KEY;

if (!STRIPE_KEY) {
  console.error('ERROR: STRIPE_SECRET_KEY environment variable is required');
  process.exit(1);
}

if (!STRIPE_KEY.startsWith('sk_live_')) {
  console.error('ERROR: This script requires a LIVE mode secret key (sk_live_...)');
  console.error('Current key starts with:', STRIPE_KEY.substring(0, 10) + '...');
  process.exit(1);
}

const stripe = new Stripe(STRIPE_KEY);

async function createProducts() {
  console.log('Creating SPLICE products in Stripe LIVE mode...\n');

  const results = {
    products: {},
    prices: {},
    meters: {},
    coupons: {}
  };

  // 1. Create Starter Product
  console.log('Creating Starter product...');
  const starterProduct = await stripe.products.create({
    name: 'SPLICE Starter',
    description: '4 hours processing, 2 AI music generations per month',
    metadata: { tier: 'starter', hours: '4', music_credits: '2' }
  });
  results.products.starter = starterProduct.id;

  // Starter Monthly Price ($15)
  const starterMonthly = await stripe.prices.create({
    product: starterProduct.id,
    unit_amount: 1500,
    currency: 'usd',
    recurring: { interval: 'month' },
    metadata: { plan: 'starter_monthly' }
  });
  results.prices.starter_monthly = starterMonthly.id;

  // Starter Annual Price ($144)
  const starterAnnual = await stripe.prices.create({
    product: starterProduct.id,
    unit_amount: 14400,
    currency: 'usd',
    recurring: { interval: 'year' },
    metadata: { plan: 'starter_annual' }
  });
  results.prices.starter_annual = starterAnnual.id;
  console.log('  ✓ Starter: $15/mo, $144/yr\n');

  // 2. Create Pro Product
  console.log('Creating Pro product...');
  const proProduct = await stripe.products.create({
    name: 'SPLICE Pro',
    description: '15 hours processing, 10 AI music generations, 45 min vocal isolation per month',
    metadata: { tier: 'pro', hours: '15', music_credits: '10', isolation_minutes: '45' }
  });
  results.products.pro = proProduct.id;

  // Pro Monthly Price ($39)
  const proMonthly = await stripe.prices.create({
    product: proProduct.id,
    unit_amount: 3900,
    currency: 'usd',
    recurring: { interval: 'month' },
    metadata: { plan: 'pro_monthly' }
  });
  results.prices.pro_monthly = proMonthly.id;

  // Pro Annual Price ($374)
  const proAnnual = await stripe.prices.create({
    product: proProduct.id,
    unit_amount: 37400,
    currency: 'usd',
    recurring: { interval: 'year' },
    metadata: { plan: 'pro_annual' }
  });
  results.prices.pro_annual = proAnnual.id;
  console.log('  ✓ Pro: $39/mo, $374/yr\n');

  // 3. Create Team Product
  console.log('Creating Team product...');
  const teamProduct = await stripe.products.create({
    name: 'SPLICE Team',
    description: '50 hours processing, 50 AI music generations, 3 hours vocal isolation per month',
    metadata: { tier: 'team', hours: '50', music_credits: '50', isolation_minutes: '180' }
  });
  results.products.team = teamProduct.id;

  // Team Monthly Price ($129)
  const teamMonthly = await stripe.prices.create({
    product: teamProduct.id,
    unit_amount: 12900,
    currency: 'usd',
    recurring: { interval: 'month' },
    metadata: { plan: 'team_monthly' }
  });
  results.prices.team_monthly = teamMonthly.id;

  // Team Annual Price ($1238)
  const teamAnnual = await stripe.prices.create({
    product: teamProduct.id,
    unit_amount: 123800,
    currency: 'usd',
    recurring: { interval: 'year' },
    metadata: { plan: 'team_annual' }
  });
  results.prices.team_annual = teamAnnual.id;
  console.log('  ✓ Team: $129/mo, $1238/yr\n');

  // 4. Create Overage Products
  console.log('Creating overage products...');

  // Hours Overage Product
  const hoursOverageProduct = await stripe.products.create({
    name: 'SPLICE Hours Overage',
    description: 'Additional processing hours beyond plan limit',
    unit_label: 'hour',
    metadata: { type: 'overage', unit: 'hour' }
  });
  results.products.hours_overage = hoursOverageProduct.id;

  // Music Overage Product
  const musicOverageProduct = await stripe.products.create({
    name: 'SPLICE Music Overage',
    description: 'Additional AI music generations beyond plan limit',
    unit_label: 'song',
    metadata: { type: 'overage', unit: 'song' }
  });
  results.products.music_overage = musicOverageProduct.id;
  console.log('  ✓ Overage products created\n');

  // 5. Create Meters for usage-based billing
  console.log('Creating usage meters...');

  const hoursMeter = await stripe.billing.meters.create({
    display_name: 'Processing Hours',
    event_name: 'splice_hours_usage',
    default_aggregation: { formula: 'sum' }
  });
  results.meters.hours = hoursMeter.id;

  const musicMeter = await stripe.billing.meters.create({
    display_name: 'Music Generations',
    event_name: 'splice_music_usage',
    default_aggregation: { formula: 'sum' }
  });
  results.meters.music = musicMeter.id;
  console.log('  ✓ Usage meters created\n');

  // 6. Create Metered Prices
  console.log('Creating metered prices...');

  // Hours Overage Price ($2/hour)
  const hoursOveragePrice = await stripe.prices.create({
    product: hoursOverageProduct.id,
    unit_amount: 200,
    currency: 'usd',
    recurring: {
      interval: 'month',
      usage_type: 'metered',
      meter: hoursMeter.id
    }
  });
  results.prices.hours_overage = hoursOveragePrice.id;

  // Music Overage Price ($1/song)
  const musicOveragePrice = await stripe.prices.create({
    product: musicOverageProduct.id,
    unit_amount: 100,
    currency: 'usd',
    recurring: {
      interval: 'month',
      usage_type: 'metered',
      meter: musicMeter.id
    }
  });
  results.prices.music_overage = musicOveragePrice.id;
  console.log('  ✓ Metered prices: $2/hr, $1/song\n');

  // 7. Create JIMMYN Affiliate Coupon (30% off forever)
  console.log('Creating JIMMYN affiliate coupon...');
  const jimmynCoupon = await stripe.coupons.create({
    id: 'JIMMYN',
    percent_off: 30,
    duration: 'forever',
    name: 'JIMMYN Affiliate - 30% Off',
    metadata: {
      affiliate: 'JIMMYN',
      type: 'affiliate_discount'
    }
  });
  results.coupons.jimmyn = jimmynCoupon.id;
  console.log('  ✓ JIMMYN coupon: 30% off forever\n');

  // 8. Create Promotion Code for JIMMYN coupon
  console.log('Creating JIMMYN promo code...');
  const jimmynPromo = await stripe.promotionCodes.create({
    coupon: jimmynCoupon.id,
    code: 'JIMMYN',
    metadata: {
      affiliate: 'JIMMYN'
    }
  });
  results.coupons.jimmyn_promo = jimmynPromo.id;
  console.log('  ✓ JIMMYN promo code active\n');

  return results;
}

async function main() {
  try {
    const results = await createProducts();

    console.log('='.repeat(60));
    console.log('STRIPE LIVE MODE SETUP COMPLETE');
    console.log('='.repeat(60));
    console.log('\nAdd these to your .env file:\n');

    console.log('# Stripe Price IDs (LIVE MODE)');
    console.log(`STRIPE_PRICE_STARTER=${results.prices.starter_monthly}`);
    console.log(`STRIPE_PRICE_PRO=${results.prices.pro_monthly}`);
    console.log(`STRIPE_PRICE_TEAM=${results.prices.team_monthly}`);
    console.log('');
    console.log(`STRIPE_PRICE_STARTER_ANNUAL=${results.prices.starter_annual}`);
    console.log(`STRIPE_PRICE_PRO_ANNUAL=${results.prices.pro_annual}`);
    console.log(`STRIPE_PRICE_TEAM_ANNUAL=${results.prices.team_annual}`);
    console.log('');
    console.log(`STRIPE_PRICE_OVERAGE_HOURS=${results.prices.hours_overage}`);
    console.log(`STRIPE_PRICE_OVERAGE_MUSIC=${results.prices.music_overage}`);
    console.log('');
    console.log(`STRIPE_METER_HOURS=${results.meters.hours}`);
    console.log(`STRIPE_METER_MUSIC=${results.meters.music}`);
    console.log('');
    console.log('# JIMMYN Affiliate Coupon');
    console.log(`# Coupon ID: ${results.coupons.jimmyn}`);
    console.log(`# Promo Code: JIMMYN (30% off forever)`);
    console.log('');
    console.log('='.repeat(60));
    console.log('Users can enter "JIMMYN" at checkout for 30% off!');
    console.log('='.repeat(60));

  } catch (err) {
    console.error('ERROR:', err.message);
    if (err.raw) {
      console.error('Details:', err.raw.message);
    }
    process.exit(1);
  }
}

main();
