#!/bin/bash
# Strategy Selector - Chooses optimal strategy based on task characteristics

set -uo pipefail

STRATEGY_DIR="${HOME}/.claude/strategies"
SELECTION_LOG="$STRATEGY_DIR/selections.jsonl"
LOG_FILE="${HOME}/.claude/strategy-selector.log"

LEARNING_ENGINE="${HOME}/.claude/hooks/learning-engine.sh"
RISK_PREDICTOR="${HOME}/.claude/hooks/risk-predictor.sh"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

init_strategies() {
    mkdir -p "$STRATEGY_DIR"
    [[ -f "$SELECTION_LOG" ]] || touch "$SELECTION_LOG"
}

# Select best strategy for task
select_strategy() {
    local task="$1"
    local task_type="${2:-general}"
    local context="${3:-}"

    init_strategies

    # Get recommendation from learning engine
    local recommendation='{"strategy":"default","confidence":0}'
    [[ -x "$LEARNING_ENGINE" ]] && \
        recommendation=$("$LEARNING_ENGINE" recommend "$task_type" "$context" 2>/dev/null || echo "$recommendation")

    # Get risk assessment
    local risk='{"riskScore":10,"riskLevel":"low"}'
    [[ -x "$RISK_PREDICTOR" ]] && \
        risk=$("$RISK_PREDICTOR" assess "$task" "$task_type" "" "$context" 2>/dev/null | jq '.components.historicalFailures' || echo "$risk")

    local strategy
    strategy=$(echo "$recommendation" | jq -r '.strategy')
    local confidence
    confidence=$(echo "$recommendation" | jq -r '.confidence')
    local risk_level
    risk_level=$(echo "$risk" | jq -r '.riskLevel')

    # Adjust strategy based on risk
    if [[ "$risk_level" == "high" && "$strategy" == "default" ]]; then
        strategy="incremental"  # Safer approach for high risk
    fi

    # Log selection
    local timestamp
    timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    local selection
    selection=$(jq -n \
        --arg task "$task" \
        --arg type "$task_type" \
        --arg strategy "$strategy" \
        --argjson confidence "$confidence" \
        --arg risk "$risk_level" \
        --arg ts "$timestamp" \
        '{task: $task, taskType: $type, strategy: $strategy, confidence: $confidence, risk: $risk, timestamp: $ts}')
    echo "$selection" >> "$SELECTION_LOG"

    echo "{\"strategy\":\"$strategy\",\"confidence\":$confidence,\"riskLevel\":\"$risk_level\",\"reasoning\":\"Based on historical success rate and risk assessment\"}"
}

case "${1:-help}" in
    select) select_strategy "${2:-task}" "${3:-general}" "${4:-}" ;;
    *) echo "Usage: $0 select <task> [type] [context]" ;;
esac
