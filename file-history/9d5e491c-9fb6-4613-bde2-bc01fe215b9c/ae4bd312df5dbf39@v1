/**
 * Phase 1 E2E Tests - UI Critical Fixes
 * Tests: Confirmation Modal, UXP File Import, Batch Event Delegation
 */

const fs = require('fs');
const path = require('path');

const PLUGIN_DIR = path.join(__dirname, '../../splice-plugin');
const mainJs = fs.readFileSync(path.join(PLUGIN_DIR, 'js/main.js'), 'utf8');
const indexHtml = fs.readFileSync(path.join(PLUGIN_DIR, 'index.html'), 'utf8');

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`✓ ${name}`);
    passed++;
  } catch (err) {
    console.log(`✗ ${name}`);
    console.log(`  Error: ${err.message}`);
    failed++;
  }
}

function assert(condition, message) {
  if (!condition) throw new Error(message);
}

console.log('\n=== Phase 1 E2E Tests ===\n');

// ============================================================================
// TEST 1.1: Confirmation Modal
// ============================================================================
console.log('--- Test 1.1: Confirmation Modal ---');

test('Modal HTML elements exist', () => {
  const elements = [
    'confirmModal', 'confirmModalTitle', 'confirmModalMessage',
    'confirmModalConfirmBtn', 'confirmModalCancelBtn', 'closeConfirmModalBtn'
  ];
  elements.forEach(el => {
    assert(indexHtml.includes(`id="${el}"`), `Missing element: ${el}`);
  });
});

test('Modal has ARIA attributes', () => {
  assert(indexHtml.includes('role="dialog"'), 'Missing role="dialog"');
  assert(indexHtml.includes('aria-modal="true"'), 'Missing aria-modal');
  assert(indexHtml.includes('aria-labelledby="confirmModalTitle"'), 'Missing aria-labelledby');
});

test('UI cache includes modal elements', () => {
  const elements = [
    'confirmModal', 'confirmModalTitle', 'confirmModalMessage',
    'confirmModalConfirmBtn', 'confirmModalCancelBtn', 'closeConfirmModalBtn'
  ];
  elements.forEach(el => {
    assert(mainJs.includes(`ui.${el} = document.getElementById`), `Missing UI cache: ${el}`);
  });
});

test('initConfirmModal() is called in DOMContentLoaded', () => {
  assert(mainJs.includes('initConfirmModal()'), 'initConfirmModal() not called');
});

test('showConfirmModal() has correct signature', () => {
  assert(
    mainJs.includes('function showConfirmModal(title, message, onConfirm'),
    'showConfirmModal missing or wrong signature'
  );
});

test('hideConfirmModal() handles callbacks', () => {
  assert(mainJs.includes('function hideConfirmModal(confirmed'), 'hideConfirmModal missing');
  assert(mainJs.includes('confirmModalCallback.onConfirm()'), 'Missing onConfirm callback');
});

test('deletePresetWithConfirm uses showConfirmModal (not confirm())', () => {
  const funcMatch = mainJs.match(/function deletePresetWithConfirm[\s\S]*?^\}/m);
  assert(funcMatch, 'deletePresetWithConfirm not found');
  assert(!funcMatch[0].includes('confirm('), 'Still uses confirm()');
  assert(funcMatch[0].includes('showConfirmModal'), 'Does not use showConfirmModal');
});

test('Modal keyboard handlers exist', () => {
  assert(mainJs.includes("e.key === 'Escape'"), 'Missing Escape handler');
  assert(mainJs.includes("e.key === 'Enter'"), 'Missing Enter handler');
});

test('Modal backdrop click closes modal', () => {
  assert(mainJs.includes('e.target === ui.confirmModal'), 'Missing backdrop click handler');
});

// ============================================================================
// TEST 1.2 + 1.4: UXP File Import
// ============================================================================
console.log('\n--- Test 1.2 + 1.4: UXP File Import ---');

test('FileReader is not used (only in comments)', () => {
  const lines = mainJs.split('\n');
  lines.forEach((line, i) => {
    if (line.includes('new FileReader') && !line.trim().startsWith('*') && !line.trim().startsWith('//')) {
      throw new Error(`FileReader used at line ${i + 1}`);
    }
  });
});

test('importPresetsFromFile uses UXP file API', () => {
  const funcMatch = mainJs.match(/async function importPresetsFromFile[\s\S]*?^}/m);
  assert(funcMatch, 'importPresetsFromFile not found');
  assert(funcMatch[0].includes('getFileForOpening'), 'Missing getFileForOpening');
  assert(funcMatch[0].includes('file.read()'), 'Missing file.read()');
});

test('importPresetsFromFile has no file parameter (uses picker)', () => {
  assert(mainJs.includes('async function importPresetsFromFile()'), 'Should have no parameters');
});

test('Hidden file input removed from HTML', () => {
  assert(!indexHtml.includes('importPresetsFile'), 'importPresetsFile still in HTML');
  assert(!indexHtml.includes('type="file"'), 'type="file" input still exists');
});

test('Import button directly calls importPresetsFromFile', () => {
  assert(mainJs.includes('importPresetsBtn.addEventListener'), 'Missing event listener');
  assert(!mainJs.includes('importPresetsFile.click()'), 'Still clicking file input');
});

test('Import handles empty/cancelled file picker', () => {
  const funcMatch = mainJs.match(/async function importPresetsFromFile[\s\S]*?^}/m);
  assert(funcMatch[0].includes('if (!file)'), 'Missing null file check');
});

test('Import has error handling', () => {
  const funcMatch = mainJs.match(/async function importPresetsFromFile[\s\S]*?^}/m);
  assert(funcMatch[0].includes('catch (err)'), 'Missing error handling');
  assert(funcMatch[0].includes('setStatus'), 'Missing status feedback');
});

// ============================================================================
// TEST 1.3: Batch Event Delegation
// ============================================================================
console.log('\n--- Test 1.3: Batch Event Delegation ---');

test('No inline onclick in batch list', () => {
  const lines = mainJs.split('\n');
  lines.forEach((line, i) => {
    if (line.includes('onclick=') && line.includes('removeBatchItem')) {
      throw new Error(`Inline onclick at line ${i + 1}`);
    }
  });
});

test('Batch items use data-index attribute', () => {
  assert(mainJs.includes('data-index="${i}"'), 'Missing data-index attribute');
  assert(mainJs.includes('class="batch-remove-btn"'), 'Missing batch-remove-btn class');
});

test('Event delegation in initBatchHandlers', () => {
  assert(mainJs.includes("batchList.addEventListener('click'"), 'Missing event delegation');
  assert(mainJs.includes(".closest('.batch-remove-btn')"), 'Missing closest() check');
});

test('Data-index is parsed correctly', () => {
  assert(mainJs.includes('parseInt(removeBtn.dataset.index, 10)'), 'Missing parseInt for index');
});

test('Batch remove has bounds checking', () => {
  assert(mainJs.includes('index >= 0 && index < batchQueue.length'), 'Missing bounds check');
});

test('Batch remove buttons have aria-label', () => {
  assert(mainJs.includes('aria-label="Remove'), 'Missing aria-label on remove buttons');
});

// ============================================================================
// INTEGRATION CHECKS
// ============================================================================
console.log('\n--- Integration Checks ---');

test('No confirm() calls in plugin code', () => {
  const lines = mainJs.split('\n');
  lines.forEach((line, i) => {
    // Skip comments and the replacement function
    if (line.trim().startsWith('//') || line.trim().startsWith('*')) return;
    if (line.includes('replacement for confirm()')) return;
    if (line.includes('confirm(') && !line.includes('showConfirmModal') && !line.includes('Confirm')) {
      throw new Error(`confirm() used at line ${i + 1}: ${line.trim()}`);
    }
  });
});

test('All UI elements cached before use', () => {
  // Check that cacheUIElements is called first in DOMContentLoaded handler
  // Use the final "Plugin initialized" log as end marker (not earlier logs)
  const domContentLoaded = mainJs.match(/DOMContentLoaded[^{]*\{([\s\S]*?)\[SPLICE\] Plugin initialized/);
  assert(domContentLoaded, 'DOMContentLoaded block not found');
  const initOrder = domContentLoaded[1];
  const cachePos = initOrder.indexOf('cacheUIElements()');
  const confirmPos = initOrder.indexOf('initConfirmModal()');
  assert(cachePos !== -1, 'cacheUIElements() not found in init block');
  assert(confirmPos !== -1, 'initConfirmModal() not found in init block');
  assert(cachePos < confirmPos, 'cacheUIElements must be called before initConfirmModal');
});

test('No JavaScript syntax errors (basic check)', () => {
  // Check for common issues
  assert(!mainJs.includes('function function'), 'Double function keyword');
  assert(!mainJs.includes('const const'), 'Double const keyword');
  assert(!mainJs.includes('let let'), 'Double let keyword');
});

// ============================================================================
// SUMMARY
// ============================================================================
console.log('\n=== Summary ===');
console.log(`Passed: ${passed}`);
console.log(`Failed: ${failed}`);
console.log(`Total:  ${passed + failed}`);

if (failed > 0) {
  console.log('\n❌ SOME TESTS FAILED - Fix issues and re-run');
  process.exit(1);
} else {
  console.log('\n✅ ALL TESTS PASSED');
  process.exit(0);
}
