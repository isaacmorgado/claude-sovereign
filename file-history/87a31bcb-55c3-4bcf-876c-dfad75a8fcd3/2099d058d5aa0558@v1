-- Migration: Reddit-style forum restructure
-- Date: 2025-12-26
-- Description: Reorganizes forums into proper subreddit-style communities
--
-- New Structure:
-- - Categories are now like subreddit groups (Physique, Face, Lifestyle, Medical, Meta)
-- - Sub-forums are renamed with r/ prefix naming convention
-- - Added missing communities: r/progress, r/questions, r/ratings, r/neck, r/posture

-- ============== STEP 1: Add new categories for better Reddit-style grouping ==============

-- Insert new meta categories
INSERT INTO forum_issue_categories (name, slug, description, icon, display_order) VALUES
    ('General Discussion', 'general', 'Questions, progress updates, and community discussion', 'üí≠', 0),
    ('Physique & Frame', 'physique-frame', 'Body composition, training, and frame development', 'üí™', 1),
    ('Facial Structure', 'facial-structure', 'Jawline, bone structure, and facial development', 'ü¶¥', 2),
    ('Skin & Hair', 'skin-hair', 'Skincare routines, hair care, and treatments', '‚ú®', 3),
    ('Medical & Procedures', 'medical', 'Surgery, injectables, and medical treatments', 'üè•', 4),
    ('Lifestyle & Style', 'lifestyle-style', 'Fashion, confidence, dating, and social skills', 'üëî', 5)
ON CONFLICT (slug) DO UPDATE SET
    name = EXCLUDED.name,
    description = EXCLUDED.description,
    icon = EXCLUDED.icon,
    display_order = EXCLUDED.display_order;

-- ============== STEP 2: Add Reddit-style sub-forums to new categories ==============

-- General Discussion sub-forums (Meta)
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, icon, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='general'), 'r/questions', 'questions', 'Ask anything - get help from the community', '‚ùì', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='general'), 'r/progress', 'progress', 'Share your transformation and progress pics', 'üìà', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='general'), 'r/ratings', 'ratings', 'Get honest feedback and rate my face threads', '‚≠ê', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='general'), 'r/guides', 'guides', 'Pinned guides, resources, and FAQs', 'üìö', 4),
    ((SELECT id FROM forum_issue_categories WHERE slug='general'), 'r/introductions', 'introductions', 'Introduce yourself to the community', 'üëã', 5)
ON CONFLICT (issue_category_id, slug) DO UPDATE SET
    name = EXCLUDED.name,
    description = EXCLUDED.description,
    icon = EXCLUDED.icon;

-- Physique & Frame sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, icon, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 'r/frame', 'frame', 'Shoulder width, clavicle length, and frame building', 'ü¶¥', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 'r/neck', 'neck', 'Neck training, thickness, and development', 'üí™', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 'r/posture', 'posture', 'Posture correction and forward head posture fixes', 'üßç', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 'r/gym', 'gym', 'Training programs, lifts, and gym advice', 'üèãÔ∏è', 4),
    ((SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 'r/nutrition', 'nutrition', 'Diet, macros, and cutting/bulking strategies', 'ü•ó', 5),
    ((SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 'r/height', 'height', 'Height optimization and maximization', 'üìè', 6),
    ((SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 'r/supplements', 'supplements', 'Creatine, vitamins, and supplement stacks', 'üíä', 7)
ON CONFLICT (issue_category_id, slug) DO UPDATE SET
    name = EXCLUDED.name,
    description = EXCLUDED.description,
    icon = EXCLUDED.icon;

-- Facial Structure sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, icon, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 'r/jawline', 'jawline', 'Mewing, jaw exercises, gonial angle, and jaw development', 'üò¨', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 'r/chin', 'chin', 'Chin projection, genioplasty discussion', 'üó£Ô∏è', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 'r/cheekbones', 'cheekbones', 'Midface projection and cheekbone enhancement', 'üíé', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 'r/nose', 'nose', 'Rhinoplasty, nose shaping, and nasal aesthetics', 'üëÉ', 4),
    ((SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 'r/eyes', 'eyes', 'Eye area, canthal tilt, and orbital aesthetics', 'üëÅÔ∏è', 5),
    ((SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 'r/teeth', 'teeth', 'Orthodontics, veneers, and smile aesthetics', 'üòÅ', 6),
    ((SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 'r/lips', 'lips', 'Lip enhancement, vermillion, and philtrum', 'üëÑ', 7),
    ((SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 'r/forehead', 'forehead', 'Brow ridge, hairline, and forehead aesthetics', 'üß†', 8)
ON CONFLICT (issue_category_id, slug) DO UPDATE SET
    name = EXCLUDED.name,
    description = EXCLUDED.description,
    icon = EXCLUDED.icon;

-- Skin & Hair sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, icon, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 'r/skincare', 'skincare', 'Routines, products, and skin improvement', 'üß¥', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 'r/acne', 'acne', 'Acne treatment, accutane, and scarring', 'üíä', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 'r/hairloss', 'hairloss', 'Finasteride, minoxidil, and hair restoration', 'üíá', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 'r/beard', 'beard', 'Beard growth, minoxidil for beard, grooming', 'üßî', 4),
    ((SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 'r/grooming', 'grooming', 'General grooming, hygiene, and maintenance', '‚úÇÔ∏è', 5),
    ((SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 'r/sunexposure', 'sunexposure', 'Tanning, sun protection, and vitamin D', '‚òÄÔ∏è', 6)
ON CONFLICT (issue_category_id, slug) DO UPDATE SET
    name = EXCLUDED.name,
    description = EXCLUDED.description,
    icon = EXCLUDED.icon;

-- Medical & Procedures sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, icon, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='medical'), 'r/surgery', 'surgery', 'Surgical procedures, surgeons, and experiences', 'üî™', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='medical'), 'r/fillers', 'fillers', 'Hyaluronic acid, chin/jaw/cheek fillers', 'üíâ', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='medical'), 'r/botox', 'botox', 'Botox, masseter reduction, and neuromodulators', 'üíÜ', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='medical'), 'r/hairtransplant', 'hairtransplant', 'FUE, FUT, and hair transplant experiences', 'üßë‚Äç‚öïÔ∏è', 4),
    ((SELECT id FROM forum_issue_categories WHERE slug='medical'), 'r/orthodontics', 'orthodontics', 'Braces, Invisalign, and jaw alignment', 'ü¶∑', 5),
    ((SELECT id FROM forum_issue_categories WHERE slug='medical'), 'r/medicaltourism', 'medicaltourism', 'Turkey, Korea, and international procedures', '‚úàÔ∏è', 6),
    ((SELECT id FROM forum_issue_categories WHERE slug='medical'), 'r/recovery', 'recovery', 'Post-procedure recovery and healing', 'üè•', 7)
ON CONFLICT (issue_category_id, slug) DO UPDATE SET
    name = EXCLUDED.name,
    description = EXCLUDED.description,
    icon = EXCLUDED.icon;

-- Lifestyle & Style sub-forums
INSERT INTO forum_sub_forums (issue_category_id, name, slug, description, icon, display_order) VALUES
    ((SELECT id FROM forum_issue_categories WHERE slug='lifestyle-style'), 'r/fashion', 'fashion', 'Style, fits, and wardrobe building', 'üëî', 1),
    ((SELECT id FROM forum_issue_categories WHERE slug='lifestyle-style'), 'r/confidence', 'confidence', 'Mindset, social skills, and overcoming anxiety', 'üß†', 2),
    ((SELECT id FROM forum_issue_categories WHERE slug='lifestyle-style'), 'r/dating', 'dating', 'Dating advice, apps, and social dynamics', '‚ù§Ô∏è', 3),
    ((SELECT id FROM forum_issue_categories WHERE slug='lifestyle-style'), 'r/photogenic', 'photogenic', 'Photography, angles, and looking good in photos', 'üì∏', 4),
    ((SELECT id FROM forum_issue_categories WHERE slug='lifestyle-style'), 'r/cologne', 'cologne', 'Fragrances, scent profiles, and recommendations', 'üå∏', 5),
    ((SELECT id FROM forum_issue_categories WHERE slug='lifestyle-style'), 'r/archetypes', 'archetypes', 'Style archetypes, softboy to chad transitions', 'üé≠', 6)
ON CONFLICT (issue_category_id, slug) DO UPDATE SET
    name = EXCLUDED.name,
    description = EXCLUDED.description,
    icon = EXCLUDED.icon;

-- ============== STEP 3: Update flaw-to-forum mappings for new structure ==============

-- Clear old mappings that reference old categories
DELETE FROM flaw_to_forum_mapping
WHERE issue_category_id IN (
    SELECT id FROM forum_issue_categories
    WHERE slug IN ('body-composition', 'weak-bone-structure', 'poor-skin', 'teeth-smile',
                   'weak-eyes', 'height-frame', 'face-fat', 'fashion', 'hair-loss',
                   'thin-lips', 'anxiety', 'social-media')
);

-- Add new mappings to proper Reddit-style categories
-- Physique/Frame related flaws
INSERT INTO flaw_to_forum_mapping (flaw_id, issue_category_id, priority) VALUES
    ('narrow_frame', (SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 1),
    ('short_clavicle', (SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 1),
    ('poor_posture', (SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 1),
    ('forward_head', (SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 1),
    ('thin_neck', (SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 2),
    ('narrow_shoulders', (SELECT id FROM forum_issue_categories WHERE slug='physique-frame'), 1)
ON CONFLICT (flaw_id, issue_category_id) DO NOTHING;

-- Facial structure flaws
INSERT INTO flaw_to_forum_mapping (flaw_id, issue_category_id, priority) VALUES
    ('weak_jaw', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('narrow_jaw', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('recessed_chin', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('mandibular_recession', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('steep_mandibular_plane', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2),
    ('steep_jaw', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2),
    ('negative_canthal_tilt', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('small_eyes', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('low_set_eyebrows', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('wide_set_eyes', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2),
    ('close_set_eyes', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2),
    ('soft_brow_ridge', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2),
    ('thin_lip_profile', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('long_philtrum', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2),
    ('flat_midface', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('flat_cheekbones', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 1),
    ('asymmetric_nose', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2),
    ('wide_nose', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2),
    ('long_face', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2),
    ('long_midface', (SELECT id FROM forum_issue_categories WHERE slug='facial-structure'), 2)
ON CONFLICT (flaw_id, issue_category_id) DO NOTHING;

-- Skin/Hair flaws
INSERT INTO flaw_to_forum_mapping (flaw_id, issue_category_id, priority) VALUES
    ('acne', (SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 1),
    ('acne_scarring', (SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 1),
    ('hair_loss', (SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 1),
    ('receding_hairline', (SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 1),
    ('poor_skin', (SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 1),
    ('dark_circles', (SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 2),
    ('patchy_beard', (SELECT id FROM forum_issue_categories WHERE slug='skin-hair'), 2)
ON CONFLICT (flaw_id, issue_category_id) DO NOTHING;

-- ============== STEP 4: Soft-deprecate old categories (keep for backward compat) ==============
UPDATE forum_issue_categories
SET display_order = display_order + 100, is_active = FALSE
WHERE slug IN ('body-composition', 'weak-bone-structure', 'poor-skin', 'teeth-smile',
               'weak-eyes', 'height-frame', 'face-fat', 'fashion', 'hair-loss',
               'thin-lips', 'anxiety', 'social-media');

-- ============== VERIFY MIGRATION ==============
SELECT 'New forum_issue_categories' as info, COUNT(*) as count
FROM forum_issue_categories WHERE is_active = TRUE
UNION ALL
SELECT 'New forum_sub_forums', COUNT(*)
FROM forum_sub_forums sf
JOIN forum_issue_categories c ON sf.issue_category_id = c.id
WHERE c.is_active = TRUE
UNION ALL
SELECT 'flaw_to_forum_mapping', COUNT(*)
FROM flaw_to_forum_mapping;
