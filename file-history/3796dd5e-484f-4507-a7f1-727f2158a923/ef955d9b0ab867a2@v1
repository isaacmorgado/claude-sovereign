#!/bin/bash
# Constitutional AI - Ethical guardrails and principles
# Based on: LangChain Constitutional AI, Anthropic Constitutional AI papers
# Ensures agent behavior aligns with defined principles

set -eo pipefail

CLAUDE_DIR="${HOME}/.claude"
LOG_FILE="${CLAUDE_DIR}/constitutional-ai.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Define constitutional principles
get_principles() {
    cat << 'EOF'
{
    "principles": [
        {
            "name": "code_quality",
            "critique": "Identify ways the code could be improved for readability, maintainability, or performance",
            "revision": "Revise the code to be more readable, maintainable, and performant"
        },
        {
            "name": "security_first",
            "critique": "Identify potential security vulnerabilities such as XSS, SQL injection, command injection, or exposed secrets",
            "revision": "Revise to eliminate security vulnerabilities and follow security best practices"
        },
        {
            "name": "test_coverage",
            "critique": "Identify missing test cases, edge cases not covered, or inadequate assertions",
            "revision": "Revise to include comprehensive test coverage for all scenarios"
        },
        {
            "name": "error_handling",
            "critique": "Identify missing error handling, uncaught exceptions, or inadequate error messages",
            "revision": "Revise to include proper error handling with clear, actionable error messages"
        },
        {
            "name": "backwards_compatibility",
            "critique": "Identify changes that could break existing functionality or APIs",
            "revision": "Revise to maintain backwards compatibility or clearly document breaking changes"
        },
        {
            "name": "documentation",
            "critique": "Identify missing documentation, unclear explanations, or outdated comments",
            "revision": "Revise to include clear, accurate documentation"
        },
        {
            "name": "simplicity",
            "critique": "Identify over-engineering, unnecessary complexity, or premature optimization",
            "revision": "Revise to use the simplest approach that meets requirements"
        },
        {
            "name": "no_data_loss",
            "critique": "Identify operations that could result in data loss or corruption",
            "revision": "Revise to protect against data loss with appropriate safeguards"
        }
    ]
}
EOF
}

# Critique output against principles
critique_output() {
    local output="$1"
    local principles="${2:-all}"

    log "Critiquing output against principles: $principles"

    local principles_json
    principles_json=$(get_principles)

    if [[ "$principles" != "all" ]]; then
        principles_json=$(echo "$principles_json" | jq --arg p "$principles" '{principles: [.principles[] | select(.name == $p)]}')
    fi

    cat << EOF
{
    "critique_prompt": "Review this output against our constitutional principles:

**Output to Review:**
\`\`\`
$output
\`\`\`

**Principles to Check:**
$(echo "$principles_json" | jq -r '.principles[] | "**\(.name)**: \(.critique)"')

For each principle, provide:
1. **Violations Found**: Specific issues (or \"None\")
2. **Severity**: low/medium/high
3. **Location**: Where in the output
4. **Recommendation**: How to fix

Format as JSON:
{
    \"critiques\": [
        {
            \"principle\": \"security_first\",
            \"violations\": [\"SQL injection risk in query builder\"],
            \"severity\": \"high\",
            \"locations\": [\"line 42\"],
            \"recommendations\": [\"Use parameterized queries\"]
        }
    ],
    \"overall_assessment\": \"safe|needs_revision|unsafe\",
    \"revision_required\": false
}",
    "principles": $(echo "$principles_json" | jq -c '.')
}
EOF
}

# Generate revision prompt
generate_revision_prompt() {
    local output="$1"
    local critique="$2"

    log "Generating revision prompt"

    cat << EOF
{
    "revision_prompt": "Revise this output to address the constitutional violations:

**Original Output:**
\`\`\`
$output
\`\`\`

**Violations to Address:**
$(echo "$critique" | jq -r '.critiques[] | "**\(.principle)**: \(.violations | join(", "))"')

**Revision Instructions:**
$(echo "$critique" | jq -r '.critiques[] | "- \(.recommendations | join(". "))"')

Provide the complete revised version that addresses ALL violations while maintaining functionality.",
    "critique": $(echo "$critique" | jq -c '.')
}
EOF
}

case "${1:-help}" in
    principles)
        get_principles
        ;;
    critique)
        critique_output "${2:-output}" "${3:-all}"
        ;;
    revise)
        generate_revision_prompt "${2:-output}" "${3:-{}}"
        ;;
    help|*)
        echo "Constitutional AI - Ethical Guardrails"
        echo "Usage: $0 <command> [args]"
        echo "  principles                - List all principles"
        echo "  critique <output> [principle] - Critique against principles"
        echo "  revise <output> <critique> - Generate revision prompt"
        ;;
esac
