"""
Archetype Classification Service

Classifies facial features into archetype categories based on facial metrics.
Categories: Softboy, Prettyboy, RobustPrettyboy, Chad, Hypermasculine, Exotic
"""

from typing import Dict, Any, List, Optional, Tuple

# ============================================
# ARCHETYPE DEFINITIONS
# ============================================

ARCHETYPE_DEFINITIONS = {
    "Softboy": {
        "id": "softboy",
        "name": "Softboy",
        "description": "Low dimorphism with ectomorphic build and youthful, delicate features",
        "traits": ["Youthful", "Delicate features", "Slim build", "Low brow ridge", "Soft jawline"],
        "ideal_metrics": {
            "gonial_angle": (125, 145),
            "fwhr": (1.7, 2.0),
            "canthal_tilt": (3, 8),
        },
    },
    "Prettyboy": {
        "id": "prettyboy",
        "name": "Prettyboy",
        "description": "Balanced dimorphism with excellent facial harmony and symmetry",
        "traits": ["Symmetrical face", "Harmonious proportions", "Classic beauty", "Athletic lean"],
        "ideal_metrics": {
            "gonial_angle": (118, 130),
            "fwhr": (1.8, 2.1),
            "canthal_tilt": (4, 10),
        },
    },
    "RobustPrettyboy": {
        "id": "robust_prettyboy",
        "name": "Robust Prettyboy",
        "description": "Pretty features combined with intensity and edge",
        "traits": ["Pretty features", "Intense gaze", "Mysterious aura", "Defined structure"],
        "ideal_metrics": {
            "gonial_angle": (115, 125),
            "fwhr": (1.85, 2.15),
            "canthal_tilt": (5, 12),
        },
    },
    "Chad": {
        "id": "chad",
        "name": "Chad",
        "description": "High dimorphism with strong masculine features and defined structure",
        "traits": ["Strong jaw", "High brow ridge", "Defined cheekbones", "Masculine presence"],
        "ideal_metrics": {
            "gonial_angle": (105, 120),
            "fwhr": (1.9, 2.2),
            "canthal_tilt": (4, 10),
        },
    },
    "Hypermasculine": {
        "id": "hypermasculine",
        "name": "Warrior",
        "description": "Extreme masculine features with dominant physical presence",
        "traits": ["Heavy brow ridge", "Very defined jaw", "Large frame", "Imposing presence"],
        "ideal_metrics": {
            "gonial_angle": (95, 115),
            "fwhr": (2.0, 2.3),
            "canthal_tilt": (2, 8),
        },
    },
    "Exotic": {
        "id": "exotic",
        "name": "Exotic",
        "description": "Unique and striking features that stand out from conventional beauty standards",
        "traits": ["Distinctive features", "Unique appeal", "Memorable face", "Non-conventional beauty"],
        "ideal_metrics": {
            "gonial_angle": (110, 135),
            "fwhr": (1.7, 2.2),
            "canthal_tilt": (0, 12),
        },
    },
}

# Dimorphism level mappings
DIMORPHISM_LEVELS = {
    "low": {"gonial_angle_min": 130, "description": "Neotenous, youthful features"},
    "low_balanced": {"gonial_angle_min": 125, "gonial_angle_max": 130, "description": "Balanced but softer"},
    "balanced": {"gonial_angle_min": 118, "gonial_angle_max": 125, "description": "Neither masculine nor feminine"},
    "above_average": {"gonial_angle_min": 115, "gonial_angle_max": 120, "description": "Leaning masculine"},
    "high": {"gonial_angle_min": 110, "gonial_angle_max": 118, "description": "Strongly masculine"},
    "very_high": {"gonial_angle_max": 110, "description": "Hypermasculine"},
}

# Sub-archetype styles
SUB_ARCHETYPE_STYLES = {
    "Softboy": {
        "kpop": {
            "clothing": ["Slim tailored fits", "High contrast colors", "Statement pieces"],
            "hair": ["Layered cuts", "Side parts", "Fringe styles"],
            "colors": ["Black", "White", "Bold accents"],
        },
        "academic": {
            "clothing": ["Preppy", "Tailored casual", "Oxford shirts"],
            "hair": ["Side parts", "Clean cuts"],
            "colors": ["Navy", "Burgundy", "Earth tones"],
        },
    },
    "Prettyboy": {
        "default": {
            "clothing": ["Clean fitted", "Minimal", "Quality basics"],
            "hair": ["Classic cuts", "Well-groomed"],
            "colors": ["Black", "White", "Navy"],
        },
    },
    "RobustPrettyboy": {
        "default": {
            "clothing": ["Dark romantic", "Leather accents", "All black"],
            "hair": ["Styled dark", "Slightly messy"],
            "colors": ["Black", "Dark gray", "Deep burgundy"],
        },
    },
    "Chad": {
        "default": {
            "clothing": ["Classic American", "Clean-cut", "Well-fitted"],
            "hair": ["Classic side part", "Well-groomed"],
            "colors": ["Navy", "Red accents", "Neutrals"],
        },
    },
    "Hypermasculine": {
        "default": {
            "clothing": ["Minimalist masculine", "Basics", "Fitted"],
            "hair": ["Short efficient", "Low maintenance"],
            "colors": ["Black", "Gray", "Neutrals"],
        },
    },
    "Exotic": {
        "default": {
            "clothing": ["Rugged", "Fur accents", "Leather", "Minimalist"],
            "hair": ["Long or tied back", "Braided optional"],
            "colors": ["Brown", "Gray", "Black"],
        },
    },
}


class ArchetypeService:
    """Service for classifying facial archetypes"""

    @staticmethod
    def get_dimorphism_level(gonial_angle: Optional[float]) -> str:
        """Determine dimorphism level based on gonial angle"""
        if gonial_angle is None:
            return "balanced"

        if gonial_angle >= 130:
            return "low"
        if gonial_angle >= 125:
            return "low_balanced"
        if gonial_angle >= 118:
            return "balanced"
        if gonial_angle >= 115:
            return "above_average"
        if gonial_angle >= 110:
            return "high"
        return "very_high"

    @staticmethod
    def calculate_range_score(
        value: Optional[float],
        ideal_range: Tuple[float, float]
    ) -> float:
        """Calculate how close a value is to ideal range (0-1)"""
        if value is None:
            return 0.5  # Neutral if unknown

        ideal_min, ideal_max = ideal_range
        ideal_mid = (ideal_min + ideal_max) / 2
        ideal_width = ideal_max - ideal_min

        if ideal_min <= value <= ideal_max:
            # Inside range: score based on distance from center
            dist_from_center = abs(value - ideal_mid)
            return 1 - (dist_from_center / ideal_width) * 0.2  # 0.8-1.0 within range

        # Outside range: penalize based on distance
        if value < ideal_min:
            dist_from_range = ideal_min - value
        else:
            dist_from_range = value - ideal_max

        return max(0, 0.8 - (dist_from_range / ideal_width) * 0.5)

    def score_archetype(
        self,
        category: str,
        gonial_angle: Optional[float],
        fwhr: Optional[float],
        canthal_tilt: Optional[float],
        ethnicity: str = "other"
    ) -> Dict[str, Any]:
        """Score a single archetype category"""
        archetype = ARCHETYPE_DEFINITIONS.get(category)
        if not archetype:
            return {"category": category, "score": 0, "confidence": 0, "matched_traits": []}

        score = 0
        matched_traits = []
        ideal = archetype["ideal_metrics"]

        # Gonial angle score
        gonial_score = self.calculate_range_score(gonial_angle, ideal["gonial_angle"])
        score += gonial_score * 30
        if gonial_score > 0.8:
            matched_traits.append(f"Ideal jaw angle ({gonial_angle:.0f}°)")

        # FWHR score
        fwhr_score = self.calculate_range_score(fwhr, ideal["fwhr"])
        score += fwhr_score * 25
        if fwhr_score > 0.8:
            matched_traits.append(f"Good FWHR ({fwhr:.2f})")

        # Canthal tilt score
        tilt_score = self.calculate_range_score(canthal_tilt, ideal["canthal_tilt"])
        score += tilt_score * 20
        if tilt_score > 0.8:
            matched_traits.append(f"Ideal canthal tilt ({canthal_tilt:.1f}°)")

        # Dimorphism level check
        dimorphism = self.get_dimorphism_level(gonial_angle)
        if category == "Softboy" and dimorphism in ("low", "low_balanced"):
            score += 15
            matched_traits.append("Low dimorphism")
        elif category == "Prettyboy" and dimorphism in ("balanced", "low_balanced"):
            score += 10
            matched_traits.append("Balanced dimorphism")
        elif category == "Chad" and dimorphism in ("high", "above_average"):
            score += 15
            matched_traits.append("High dimorphism")
        elif category == "Hypermasculine" and dimorphism in ("very_high", "high"):
            score += 20
            matched_traits.append("Very high dimorphism")

        # Ethnicity bonuses
        if category == "Softboy" and ethnicity in ("east_asian", "south_asian"):
            score += 10
            matched_traits.append("K-pop aesthetic potential")
        if category == "Exotic" and ethnicity == "white":
            score += 5
            matched_traits.append("Norse potential")

        # Base traits from definition
        matched_traits.extend(archetype["traits"][:2])

        return {
            "category": category,
            "score": min(100, score),
            "confidence": min(1.0, score / 100),
            "matched_traits": matched_traits,
        }

    def classify(
        self,
        gonial_angle: Optional[float] = None,
        fwhr: Optional[float] = None,
        canthal_tilt: Optional[float] = None,
        cheekbone_height: Optional[float] = None,
        brow_ridge: Optional[float] = None,
        jaw_width_ratio: Optional[float] = None,
        gender: str = "male",
        ethnicity: str = "other"
    ) -> Dict[str, Any]:
        """
        Classify facial metrics into archetype categories.

        Args:
            gonial_angle: Jaw angle in degrees
            fwhr: Face width-height ratio
            canthal_tilt: Eye canthal tilt in degrees
            cheekbone_height: Cheekbone height score (0-10)
            brow_ridge: Brow ridge prominence score (0-10)
            jaw_width_ratio: Jaw to face width ratio
            gender: 'male' or 'female'
            ethnicity: Ethnicity code

        Returns:
            Classification result with primary/secondary archetypes
        """
        # Score all categories
        all_scores = []
        for category in ARCHETYPE_DEFINITIONS.keys():
            result = self.score_archetype(
                category, gonial_angle, fwhr, canthal_tilt, ethnicity
            )
            all_scores.append(result)

        # Sort by score
        all_scores.sort(key=lambda x: x["score"], reverse=True)

        primary = all_scores[0]
        secondary = all_scores[1] if all_scores[1]["score"] >= 30 else None

        # Get dimorphism level
        dimorphism_level = self.get_dimorphism_level(gonial_angle)

        # Get style guide
        category_styles = SUB_ARCHETYPE_STYLES.get(primary["category"], {})
        style_key = "default"
        if primary["category"] == "Softboy":
            if ethnicity in ("east_asian", "south_asian"):
                style_key = "kpop"
            else:
                style_key = "academic"
        style_guide = category_styles.get(style_key, category_styles.get("default", {}))

        # Calculate transition path
        transition_path = None
        transitions = {
            "Softboy": ("Prettyboy", ["Build more jaw definition", "Slightly increase muscularity"]),
            "Prettyboy": ("RobustPrettyboy", ["Increase muscularity", "Develop more intensity"]),
            "RobustPrettyboy": ("Chad", ["Build more muscle mass", "Maximize jaw definition"]),
            "Chad": ("Hypermasculine", ["Significant muscle gain", "Frame maximization"]),
            "Hypermasculine": ("Exotic", ["Unique styling", "Distinctive grooming"]),
        }
        if primary["category"] in transitions:
            target, requirements = transitions[primary["category"]]
            target_score = next((s for s in all_scores if s["category"] == target), None)
            if target_score and target_score["score"] >= 40:
                transition_path = {
                    "target": target,
                    "requirements": requirements,
                }

        return {
            "primary": {
                "category": primary["category"],
                "sub_archetype": ARCHETYPE_DEFINITIONS[primary["category"]]["name"],
                "confidence": primary["confidence"],
                "traits": primary["matched_traits"],
            },
            "secondary": {
                "category": secondary["category"],
                "sub_archetype": ARCHETYPE_DEFINITIONS[secondary["category"]]["name"],
                "confidence": secondary["confidence"],
                "traits": secondary["matched_traits"],
            } if secondary else None,
            "all_scores": [
                {
                    "category": s["category"],
                    "score": s["score"],
                    "confidence": s["confidence"],
                }
                for s in all_scores
            ],
            "dimorphism_level": dimorphism_level,
            "style_guide": style_guide,
            "transition_path": transition_path,
        }


# Singleton instance
archetype_service = ArchetypeService()
