'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { ArrowLeft, Scale, ChevronUp, ChevronDown } from 'lucide-react';
import { useWeight } from '@/contexts/WeightContext';
import { useHeight } from '@/contexts/HeightContext';

// Convert kg to lbs
function kgToLbs(kg: number): number {
  return Math.round(kg * 2.20462);
}

// Convert lbs to kg
function lbsToKg(lbs: number): number {
  return Math.round(lbs / 2.20462 * 10) / 10;
}

// Calculate BMI
function calculateBMI(weightKg: number, heightCm: number): number {
  const heightM = heightCm / 100;
  return Math.round((weightKg / (heightM * heightM)) * 10) / 10;
}

// Get BMI category and color
function getBMIInfo(bmi: number): { category: string; color: string; description: string } {
  if (bmi < 18.5) {
    return { category: 'Underweight', color: 'text-yellow-400', description: 'Below healthy range' };
  }
  if (bmi < 25) {
    return { category: 'Normal', color: 'text-green-400', description: 'Healthy weight range' };
  }
  if (bmi < 30) {
    return { category: 'Overweight', color: 'text-orange-400', description: 'Above healthy range' };
  }
  return { category: 'Obese', color: 'text-red-400', description: 'Well above healthy range' };
}

export default function WeightPage() {
  const router = useRouter();
  const { weightKg, setWeightKg, setWeightLbs, inputMode, setInputMode } = useWeight();
  const { heightCm } = useHeight();

  // Local state for input
  const [localKg, setLocalKg] = useState<number>(75);
  const [localLbs, setLocalLbs] = useState<number>(165);

  // Sync from context on mount
  useEffect(() => {
    if (weightKg) {
      setLocalKg(weightKg);
      setLocalLbs(kgToLbs(weightKg));
    }
  }, [weightKg]);

  // Update weight when inputs change
  useEffect(() => {
    if (inputMode === 'imperial') {
      setWeightLbs(localLbs);
    } else {
      setWeightKg(localKg);
    }
  }, [localKg, localLbs, inputMode, setWeightKg, setWeightLbs]);

  const handleKgChange = (delta: number) => {
    const newKg = Math.min(200, Math.max(40, localKg + delta));
    setLocalKg(newKg);
    setLocalLbs(kgToLbs(newKg));
  };

  const handleLbsChange = (delta: number) => {
    const newLbs = Math.min(440, Math.max(88, localLbs + delta));
    setLocalLbs(newLbs);
    setLocalKg(lbsToKg(newLbs));
  };

  const handleContinue = () => {
    if (weightKg) {
      router.push('/upload');
    }
  };

  const handleBack = () => {
    router.push('/height');
  };

  // Calculate BMI preview
  const currentWeightKg = inputMode === 'imperial' ? lbsToKg(localLbs) : localKg;
  const bmi = heightCm ? calculateBMI(currentWeightKg, heightCm) : null;
  const bmiInfo = bmi ? getBMIInfo(bmi) : null;

  // Number spinner component
  const NumberSpinner = ({
    value,
    onIncrease,
    onDecrease,
    label,
    suffix,
  }: {
    value: number;
    onIncrease: () => void;
    onDecrease: () => void;
    label: string;
    suffix: string;
  }) => (
    <div className="flex flex-col items-center">
      <span className="text-xs text-neutral-500 mb-2">{label}</span>
      <div className="flex flex-col items-center bg-neutral-900 rounded-xl border border-neutral-800 p-2">
        <button
          onClick={onIncrease}
          className="p-2 hover:bg-neutral-800 rounded-lg transition-colors"
        >
          <ChevronUp className="w-6 h-6 text-neutral-400" />
        </button>
        <div className="flex items-baseline py-3">
          <span className="text-4xl font-bold text-white tabular-nums">{value}</span>
          <span className="text-lg text-neutral-500 ml-1">{suffix}</span>
        </div>
        <button
          onClick={onDecrease}
          className="p-2 hover:bg-neutral-800 rounded-lg transition-colors"
        >
          <ChevronDown className="w-6 h-6 text-neutral-400" />
        </button>
      </div>
      <div className="flex gap-2 mt-2">
        <button
          onClick={() => {
            for (let i = 0; i < 5; i++) onDecrease();
          }}
          className="px-2 py-1 text-xs text-neutral-500 hover:text-white hover:bg-neutral-800 rounded transition-colors"
        >
          -5
        </button>
        <button
          onClick={() => {
            for (let i = 0; i < 5; i++) onIncrease();
          }}
          className="px-2 py-1 text-xs text-neutral-500 hover:text-white hover:bg-neutral-800 rounded transition-colors"
        >
          +5
        </button>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-black px-4">
      {/* Back button */}
      <button
        onClick={handleBack}
        className="absolute top-6 left-6 flex items-center gap-2 text-neutral-400 hover:text-white transition-colors text-sm"
      >
        <ArrowLeft className="w-4 h-4" />
        Back
      </button>

      <div className="w-full max-w-sm">
        {/* Header */}
        <div className="mb-8">
          <div className="flex justify-center mb-6">
            <div className="h-12 w-12 rounded-xl bg-[#00f3ff]/20 flex items-center justify-center">
              <Scale className="w-6 h-6 text-[#00f3ff]" />
            </div>
          </div>
          <h1 className="text-2xl font-semibold tracking-tight text-center text-white mb-2">
            Enter Your Weight
          </h1>
          <p className="text-sm text-neutral-400 text-center">
            Used for FFMI calculation and body composition analysis
          </p>
        </div>

        {/* Unit Toggle */}
        <div className="flex justify-center mb-6">
          <div className="flex bg-neutral-900 rounded-lg p-1 border border-neutral-800">
            <button
              onClick={() => setInputMode('imperial')}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                inputMode === 'imperial'
                  ? 'bg-[#00f3ff] text-black'
                  : 'text-neutral-400 hover:text-white'
              }`}
            >
              lbs
            </button>
            <button
              onClick={() => setInputMode('metric')}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                inputMode === 'metric'
                  ? 'bg-[#00f3ff] text-black'
                  : 'text-neutral-400 hover:text-white'
              }`}
            >
              kg
            </button>
          </div>
        </div>

        {/* Weight Input */}
        <div className="flex justify-center gap-4 mb-8">
          {inputMode === 'imperial' ? (
            <NumberSpinner
              value={localLbs}
              onIncrease={() => handleLbsChange(1)}
              onDecrease={() => handleLbsChange(-1)}
              label="POUNDS"
              suffix="lbs"
            />
          ) : (
            <NumberSpinner
              value={localKg}
              onIncrease={() => handleKgChange(1)}
              onDecrease={() => handleKgChange(-1)}
              label="KILOGRAMS"
              suffix="kg"
            />
          )}
        </div>

        {/* BMI Preview */}
        {heightCm && bmi && bmiInfo && (
          <div className="bg-neutral-900/50 rounded-xl border border-neutral-800 p-4 mb-6">
            <div className="flex items-center justify-between mb-3">
              <span className="text-sm text-neutral-400">Body Mass Index (BMI)</span>
              <span className="text-sm text-neutral-500">
                {inputMode === 'imperial'
                  ? `${localLbs} lbs (${currentWeightKg.toFixed(1)} kg)`
                  : `${localKg} kg`}
              </span>
            </div>

            {/* BMI bar */}
            <div className="relative h-3 bg-neutral-800 rounded-full overflow-hidden mb-2">
              {/* Healthy range indicator */}
              <div
                className="absolute inset-y-0 bg-green-500/30"
                style={{ left: '18.5%', width: '21.5%' }}
              />
              {/* BMI marker */}
              <div
                className="absolute inset-y-0 w-1 bg-white rounded-full transition-all duration-300"
                style={{
                  left: `${Math.min(100, Math.max(0, (bmi / 40) * 100))}%`,
                }}
              />
            </div>

            <div className="flex items-center justify-between">
              <span className="text-lg font-bold text-white">{bmi}</span>
              <span className={`text-sm font-medium ${bmiInfo.color}`}>
                {bmiInfo.category}
              </span>
            </div>
            <p className="text-xs text-neutral-500 mt-1">{bmiInfo.description}</p>
          </div>
        )}

        {/* Height warning if not set */}
        {!heightCm && (
          <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-4 mb-6">
            <p className="text-sm text-yellow-400 text-center">
              Go back to set your height to see BMI calculation
            </p>
          </div>
        )}

        {/* Reference info */}
        <div className="bg-neutral-900/30 rounded-lg p-3 mb-6">
          <p className="text-xs text-neutral-500 text-center mb-2">
            Weight will be used for FFMI calculation
          </p>
          <div className="flex justify-between text-xs text-neutral-400">
            <span>Healthy BMI: 18.5-24.9</span>
            <span>Athletic: 22-25</span>
          </div>
        </div>

        {/* Continue Button */}
        <button
          onClick={handleContinue}
          disabled={!weightKg}
          className={`
            w-full h-12 rounded-xl font-medium text-sm
            transition-all duration-200
            ${weightKg
              ? 'bg-[#00f3ff] text-black hover:shadow-[0_0_20px_rgba(0,243,255,0.3)] cursor-pointer'
              : 'bg-neutral-800 text-neutral-500 cursor-not-allowed'
            }
          `}
        >
          Continue
        </button>
      </div>
    </div>
  );
}
