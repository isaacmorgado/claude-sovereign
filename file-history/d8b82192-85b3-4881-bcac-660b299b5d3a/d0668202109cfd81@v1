"""
Archetype Classification Router

Endpoints for classifying facial archetypes based on metrics.
"""

from typing import Optional, List, Dict, Any
from fastapi import APIRouter, HTTPException, status
from pydantic import BaseModel, Field

from app.services.archetype_service import archetype_service, ARCHETYPE_DEFINITIONS


router = APIRouter(prefix="/archetype", tags=["archetype"])


# ============================================
# SCHEMAS
# ============================================

class ArchetypeClassifyRequest(BaseModel):
    """Request to classify facial archetype"""
    gonial_angle: Optional[float] = Field(None, ge=80, le=160, description="Gonial angle in degrees")
    fwhr: Optional[float] = Field(None, ge=1.0, le=3.0, description="Face width-height ratio")
    canthal_tilt: Optional[float] = Field(None, ge=-15, le=20, description="Canthal tilt in degrees")
    cheekbone_height: Optional[float] = Field(None, ge=0, le=10, description="Cheekbone height score")
    brow_ridge: Optional[float] = Field(None, ge=0, le=10, description="Brow ridge prominence score")
    jaw_width_ratio: Optional[float] = Field(None, ge=0.5, le=1.5, description="Jaw width ratio")
    gender: str = Field("male", pattern="^(male|female)$")
    ethnicity: str = Field("other", description="Ethnicity code")


class StyleGuide(BaseModel):
    """Style recommendations"""
    clothing: List[str] = []
    hair: List[str] = []
    colors: List[str] = []


class TransitionPath(BaseModel):
    """Transition to adjacent archetype"""
    target: str
    requirements: List[str]


class ArchetypeMatch(BaseModel):
    """Archetype match result"""
    category: str
    sub_archetype: str
    confidence: float
    traits: List[str]


class CategoryScore(BaseModel):
    """Score for a single category"""
    category: str
    score: float
    confidence: float


class ArchetypeClassifyResponse(BaseModel):
    """Archetype classification response"""
    primary: ArchetypeMatch
    secondary: Optional[ArchetypeMatch]
    all_scores: List[CategoryScore]
    dimorphism_level: str
    style_guide: StyleGuide
    transition_path: Optional[TransitionPath]


class ArchetypeDefinitionResponse(BaseModel):
    """Archetype definition"""
    id: str
    name: str
    description: str
    traits: List[str]
    ideal_metrics: Dict[str, Any]


# ============================================
# ENDPOINTS
# ============================================

@router.post("/classify", response_model=ArchetypeClassifyResponse)
async def classify_archetype(request: ArchetypeClassifyRequest):
    """
    Classify facial metrics into archetype categories.

    Returns primary and secondary archetype matches with confidence scores,
    style recommendations, and potential transition paths.

    No authentication required - this is a public calculation endpoint.
    """
    result = archetype_service.classify(
        gonial_angle=request.gonial_angle,
        fwhr=request.fwhr,
        canthal_tilt=request.canthal_tilt,
        cheekbone_height=request.cheekbone_height,
        brow_ridge=request.brow_ridge,
        jaw_width_ratio=request.jaw_width_ratio,
        gender=request.gender,
        ethnicity=request.ethnicity,
    )
    return result


@router.get("/definitions")
async def get_archetype_definitions():
    """
    Get all archetype definitions.

    Returns the archetype categories with their traits and ideal metrics.
    """
    return {
        "archetypes": [
            {
                "id": archetype["id"],
                "name": archetype["name"],
                "description": archetype["description"],
                "traits": archetype["traits"],
                "ideal_metrics": {
                    "gonial_angle": {
                        "min": archetype["ideal_metrics"]["gonial_angle"][0],
                        "max": archetype["ideal_metrics"]["gonial_angle"][1],
                    },
                    "fwhr": {
                        "min": archetype["ideal_metrics"]["fwhr"][0],
                        "max": archetype["ideal_metrics"]["fwhr"][1],
                    },
                    "canthal_tilt": {
                        "min": archetype["ideal_metrics"]["canthal_tilt"][0],
                        "max": archetype["ideal_metrics"]["canthal_tilt"][1],
                    },
                },
            }
            for archetype in ARCHETYPE_DEFINITIONS.values()
        ]
    }


@router.get("/definitions/{archetype_id}")
async def get_archetype_definition(archetype_id: str):
    """
    Get a specific archetype definition.

    Returns the archetype details including traits and ideal metrics.
    """
    # Find archetype by id
    for category, archetype in ARCHETYPE_DEFINITIONS.items():
        if archetype["id"] == archetype_id or category.lower() == archetype_id.lower():
            return {
                "id": archetype["id"],
                "name": archetype["name"],
                "description": archetype["description"],
                "traits": archetype["traits"],
                "ideal_metrics": {
                    "gonial_angle": {
                        "min": archetype["ideal_metrics"]["gonial_angle"][0],
                        "max": archetype["ideal_metrics"]["gonial_angle"][1],
                    },
                    "fwhr": {
                        "min": archetype["ideal_metrics"]["fwhr"][0],
                        "max": archetype["ideal_metrics"]["fwhr"][1],
                    },
                    "canthal_tilt": {
                        "min": archetype["ideal_metrics"]["canthal_tilt"][0],
                        "max": archetype["ideal_metrics"]["canthal_tilt"][1],
                    },
                },
            }

    raise HTTPException(
        status_code=status.HTTP_404_NOT_FOUND,
        detail=f"Archetype '{archetype_id}' not found"
    )


@router.get("/dimorphism")
async def get_dimorphism_info():
    """
    Get dimorphism level definitions.

    Returns the dimorphism levels with their gonial angle ranges.
    """
    from app.services.archetype_service import DIMORPHISM_LEVELS
    return {"levels": DIMORPHISM_LEVELS}
