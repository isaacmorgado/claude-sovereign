/**
 * SPLICE Email Service
 *
 * Handles email delivery for license keys, payment notifications, etc.
 * Supports multiple providers: SendGrid (primary), AWS SES (fallback)
 *
 * Required env vars:
 * - EMAIL_PROVIDER: 'sendgrid' | 'ses' | 'console' (default: 'console' for dev)
 * - SENDGRID_API_KEY: SendGrid API key
 * - SENDGRID_TEMPLATE_SIGNIN_CODE: SendGrid dynamic template ID for sign-in codes
 * - SENDGRID_TEMPLATE_EMAIL_VERIFICATION: SendGrid dynamic template ID for email verification
 * - AWS_SES_REGION: AWS SES region (default: 'us-east-1')
 * - AWS_ACCESS_KEY_ID: AWS access key (for SES)
 * - AWS_SECRET_ACCESS_KEY: AWS secret (for SES)
 * - EMAIL_FROM: Sender email address (default: 'noreply@splice.video')
 */

const { circuitBreakers } = require('../config/circuitBreakers');

// CRITICAL-002: Email validation using validator library
let validator;
try {
  validator = require('validator');
} catch (_err) {
  console.warn('[SPLICE Email] validator package not installed. Using fallback email validation.');
  // Fallback email validation function
  validator = {
    isEmail: (email) => {
      if (!email || typeof email !== 'string') return false;
      // RFC 5322 compliant email regex (simplified)
      const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
      return emailRegex.test(email) && email.length <= 254;
    },
    normalizeEmail: (email, options = {}) => {
      if (!email || typeof email !== 'string') return false;
      return email.toLowerCase().trim();
    }
  };
}

// CRITICAL-002: Helper function to validate and normalize email before API calls
/**
 * Validate and normalize an email address before sending to external APIs
 * @param {string} email - Email address to validate
 * @returns {{ valid: boolean, email: string|null, error: string|null }}
 */
function validateAndNormalizeEmail(email) {
  if (!email || typeof email !== 'string') {
    return { valid: false, email: null, error: 'Email is required and must be a string' };
  }

  // Trim and normalize
  const normalized = email.toLowerCase().trim();

  // Validate email format
  if (!validator.isEmail(normalized)) {
    console.warn('[SPLICE Email] Invalid email format rejected:', email);
    return { valid: false, email: null, error: `Invalid email format: ${email}` };
  }

  // Additional security checks
  if (normalized.length > 254) {
    return { valid: false, email: null, error: 'Email address exceeds maximum length' };
  }

  // Check for potentially malicious patterns
  if (normalized.includes('..') || normalized.startsWith('.') || normalized.endsWith('.')) {
    return { valid: false, email: null, error: 'Email contains invalid dot pattern' };
  }

  return { valid: true, email: normalized, error: null };
}

/**
 * Extract and validate email from text using regex
 * Used for parsing emails from user input or external sources
 * @param {string} text - Text containing an email address
 * @returns {string|null} - Validated email or null if invalid
 */
function extractAndValidateEmail(text) {
  if (!text || typeof text !== 'string') return null;

  // Extract email using regex
  const emailMatch = text.match(/[\w.-]+@[\w.-]+\.\w+/);
  if (!emailMatch) return null;

  // Validate the extracted email
  const result = validateAndNormalizeEmail(emailMatch[0]);
  return result.valid ? result.email : null;
}

// ============================================================================
// CONFIGURATION
// ============================================================================

const EMAIL_CONFIG = {
  provider: process.env.EMAIL_PROVIDER || 'console',
  from: process.env.EMAIL_FROM || 'SPLICE <noreply@splice.video>',
  replyTo: process.env.EMAIL_REPLY_TO || 'support@splice.video',
  sendgrid: {
    apiKey: process.env.SENDGRID_API_KEY
  },
  ses: {
    region: process.env.AWS_SES_REGION || 'us-east-1'
  }
};

// SendGrid Dynamic Template IDs (configured via environment variables)
const TEMPLATE_IDS = {
  signinCode: process.env.SENDGRID_TEMPLATE_SIGNIN_CODE || null,
  emailVerification: process.env.SENDGRID_TEMPLATE_EMAIL_VERIFICATION || null
};

// Email templates
const TEMPLATES = {
  licenseKey: {
    subject: 'Welcome to SPLICE! Your License Key + Quick Start Guide',
    html: (data) => `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; margin: 0; padding: 0; }
    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; background: white; }
    .header { text-align: center; margin-bottom: 30px; }
    .logo { font-size: 32px; font-weight: bold; color: #00D4FF; }
    .tagline { color: #6b7280; font-size: 14px; margin-top: 5px; }
    .hero-cta { background: linear-gradient(135deg, #00D4FF, #00A8CC); border-radius: 12px; padding: 30px; text-align: center; margin: 30px 0; }
    .hero-cta h2 { color: white; margin: 0 0 15px 0; font-size: 22px; }
    .hero-cta p { color: rgba(255,255,255,0.9); margin: 0 0 20px 0; }
    .button-primary { display: inline-block; background: white; color: #00A8CC; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
    .button-primary:hover { background: #f0f0f0; }
    .license-box { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }
    .license-key { font-family: monospace; font-size: 22px; font-weight: bold; color: #1e293b; letter-spacing: 2px; }
    .tier-badge { display: inline-block; background: #00D4FF; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-top: 10px; }
    .quick-wins { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px; margin: 20px 0; }
    .quick-wins h3 { color: #166534; margin-top: 0; }
    .quick-wins ul { margin: 0; padding-left: 20px; }
    .quick-wins li { margin: 8px 0; color: #15803d; }
    .instructions { background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; }
    .instructions h3 { margin-top: 0; color: #374151; }
    .instructions ol { margin: 0; padding-left: 20px; }
    .instructions li { margin: 8px 0; }
    .resources { display: table; width: 100%; margin: 20px 0; }
    .resource-item { display: table-cell; text-align: center; padding: 15px; width: 33%; }
    .resource-item a { display: block; color: #00A8CC; text-decoration: none; font-weight: 500; }
    .resource-item span { display: block; font-size: 12px; color: #6b7280; margin-top: 5px; }
    .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px; }
    .button { display: inline-block; background: #00D4FF; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">SPLICE</div>
      <p class="tagline">Cut Your Editing Time in Half. Automatically.</p>
    </div>

    <div class="hero-cta">
      <h2>üéâ You're In! Let's Get Started</h2>
      <p>Download SPLICE and make your first AI-powered edit in under 2 minutes.</p>
      <a href="https://splice.video/download" class="button-primary">Download SPLICE ‚Üí</a>
    </div>

    <div class="license-box">
      <p style="margin: 0 0 10px; color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Your License Key</p>
      <div class="license-key">${escapeHtml(data.licenseKey)}</div>
      <div class="tier-badge">${escapeHtml(data.tier.toUpperCase())} Plan</div>
    </div>

    <div class="quick-wins">
      <h3>‚ö° Your First 5-Minute Win</h3>
      <ul>
        <li><strong>Open any project</strong> in Premiere Pro</li>
        <li><strong>Click GO</strong> in the SPLICE panel</li>
        <li><strong>Watch silences vanish</strong> automatically</li>
      </ul>
      <p style="margin-bottom: 0; font-size: 14px;">Most editors save <strong>2+ hours per video</strong> on their first use!</p>
    </div>

    <div class="instructions">
      <h3>üìã Setup Instructions</h3>
      <ol>
        <li>Open Adobe Premiere Pro (2023 or later)</li>
        <li>Go to <strong>Window ‚Üí Extensions ‚Üí SPLICE</strong></li>
        <li>Click the Login button and enter your license key</li>
        <li>You're ready! Open any sequence and hit <strong>GO</strong></li>
      </ol>
    </div>

    <p>Your ${escapeHtml(data.tier)} plan includes:</p>
    <ul>
      <li><strong>${escapeHtml(String(data.hours))} hours</strong> of AI processing per month</li>
      <li><strong>${escapeHtml(String(data.musicCredits))} music credits</strong> per month</li>
      <li>14-day free trial - cancel anytime</li>
    </ul>

    <div class="resources">
      <div class="resource-item">
        <a href="https://splice.video/docs/tutorials">üìö Tutorials</a>
        <span>Step-by-step guides</span>
      </div>
      <div class="resource-item">
        <a href="https://splice.video/docs/faq">‚ùì FAQ</a>
        <span>Common questions</span>
      </div>
      <div class="resource-item">
        <a href="mailto:support@splice.video">üí¨ Support</a>
        <span>We're here to help</span>
      </div>
    </div>

    <div class="footer">
      <p>Questions? Just reply to this email - we read every message!</p>
      <p style="font-size: 12px;">&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
    `,
    text: (data) => `
SPLICE - Welcome! Your License Key + Quick Start Guide
=======================================================

üéâ YOU'RE IN! LET'S GET STARTED

Download SPLICE: https://splice.video/download

YOUR LICENSE KEY:
${data.licenseKey}
Plan: ${data.tier.toUpperCase()}

‚ö° YOUR FIRST 5-MINUTE WIN:
1. Open any project in Premiere Pro
2. Click GO in the SPLICE panel
3. Watch silences vanish automatically

Most editors save 2+ hours per video on their first use!

üìã SETUP INSTRUCTIONS:
1. Open Adobe Premiere Pro (2023 or later)
2. Go to Window ‚Üí Extensions ‚Üí SPLICE
3. Click the Login button and enter your license key
4. You're ready! Open any sequence and hit GO

YOUR ${data.tier.toUpperCase()} PLAN INCLUDES:
- ${data.hours} hours of AI processing per month
- ${data.musicCredits} music credits per month
- 14-day free trial - cancel anytime

HELPFUL RESOURCES:
üìö Tutorials: https://splice.video/docs/tutorials
‚ùì FAQ: https://splice.video/docs/faq
üí¨ Support: support@splice.video

Questions? Just reply to this email - we read every message!

¬© ${new Date().getFullYear()} SPLICE. All rights reserved.
    `
  },

  paymentWarning: {
    subject: 'Action Required: Payment Failed for SPLICE',
    html: (data) => `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }
    .warning-box { background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; padding: 20px; margin: 20px 0; }
    .warning-icon { font-size: 48px; text-align: center; }
    .button { display: inline-block; background: #7c3aed; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }
    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">SPLICE</div>
    </div>

    <div class="warning-box">
      <div class="warning-icon">‚ö†Ô∏è</div>
      <h2 style="text-align: center; color: #dc2626; margin: 10px 0;">Payment Failed</h2>
      <p>We were unable to process your payment for your SPLICE subscription. This was attempt ${escapeHtml(String(data.attemptCount))} of 3.</p>
    </div>

    <p>To keep your subscription active and avoid interruption to your service, please update your payment method:</p>

    <p style="text-align: center;">
      <a href="https://splice.video/account/billing" class="button">Update Payment Method</a>
    </p>

    <p><strong>What happens next?</strong></p>
    <ul>
      <li>We'll automatically retry the payment in a few days</li>
      <li>If all payment attempts fail, your subscription will be cancelled</li>
      <li>You'll lose access to premium features</li>
    </ul>

    <p>If you have any questions or need assistance, please don't hesitate to reach out.</p>

    <div class="footer">
      <p>Need help? Reply to this email or visit <a href="https://splice.video/support">splice.video/support</a></p>
      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
    `,
    text: (data) => `
SPLICE - Payment Failed

We were unable to process your payment for your SPLICE subscription.
This was attempt ${data.attemptCount} of 3.

To keep your subscription active, please update your payment method:
https://splice.video/account/billing

WHAT HAPPENS NEXT:
- We'll automatically retry the payment in a few days
- If all payment attempts fail, your subscription will be cancelled
- You'll lose access to premium features

If you have any questions, please reply to this email.

¬© ${new Date().getFullYear()} SPLICE. All rights reserved.
    `
  },

  licenseLookup: {
    subject: 'Your SPLICE License Key',
    html: (data) => `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }
    .license-box { background: #f8f5ff; border: 2px solid #7c3aed; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }
    .license-key { font-family: monospace; font-size: 24px; font-weight: bold; color: #7c3aed; letter-spacing: 2px; }
    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">SPLICE</div>
    </div>

    <h2>License Key Lookup</h2>
    <p>You requested your SPLICE license key. Here it is:</p>

    <div class="license-box">
      <div class="license-key">${escapeHtml(data.licenseKey)}</div>
    </div>

    <p>If you didn't request this, you can safely ignore this email.</p>

    <div class="footer">
      <p>Need help? Reply to this email or visit <a href="https://splice.video/support">splice.video/support</a></p>
      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
    `,
    text: (data) => `
SPLICE - License Key Lookup

You requested your SPLICE license key. Here it is:

${data.licenseKey}

If you didn't request this, you can safely ignore this email.

Need help? Visit https://splice.video/support

¬© ${new Date().getFullYear()} SPLICE. All rights reserved.
    `
  },

  // Sign-in code email (passwordless auth)
  signinCode: {
    subject: 'Your SPLICE Sign-In Code: {{code}}',
    html: (data) => `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Your SPLICE Sign-In Code</title>
  <!--[if mso]>
  <noscript>
    <xml>
      <o:OfficeDocumentSettings>
        <o:PixelsPerInch>96</o:PixelsPerInch>
      </o:OfficeDocumentSettings>
    </xml>
  </noscript>
  <![endif]-->
  <style>
    body, table, td, p, a, li { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }
    table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; }
    img { -ms-interpolation-mode: bicubic; border: 0; outline: none; text-decoration: none; }
    body { margin: 0; padding: 0; width: 100%; background-color: #060b14; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    @media only screen and (max-width: 600px) {
      .container { width: 100% !important; padding: 16px !important; }
      .code-box { font-size: 28px !important; letter-spacing: 6px !important; }
    }
  </style>
</head>
<body style="margin: 0; padding: 0; background-color: #060b14;">
  <div style="display: none; max-height: 0; overflow: hidden; font-size: 1px; line-height: 1px; color: #060b14;">Your SPLICE sign-in code is inside. Start editing 10x faster today!</div>
  <table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="background-color: #060b14;">
    <tr>
      <td align="center" style="padding: 40px 20px;">
        <table role="presentation" class="container" cellpadding="0" cellspacing="0" width="560" style="max-width: 560px;">
          <tr>
            <td align="center" style="padding-bottom: 32px;">
              <table role="presentation" cellpadding="0" cellspacing="0">
                <tr>
                  <td style="vertical-align: middle; padding-right: 10px;">
                    <img src="https://splice.video/images/logo.jpg" alt="SPLICE" width="40" height="40" style="display: block; border-radius: 8px;">
                  </td>
                  <td style="vertical-align: middle;">
                    <span style="font-size: 26px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px;">SPLICE</span>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td>
              <table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="background: linear-gradient(180deg, #0f1629 0%, #0a0f1a 100%); border-radius: 16px; border: 1px solid rgba(0, 212, 255, 0.15); box-shadow: 0 0 40px rgba(0, 212, 255, 0.08);">
                <tr>
                  <td align="center" style="padding: 40px 40px 24px 40px;">
                    <h1 style="margin: 0; font-size: 28px; font-weight: 600; color: #ffffff; line-height: 1.3;">Welcome to the future of editing ‚ú®</h1>
                  </td>
                </tr>
                <tr>
                  <td align="center" style="padding: 0 40px 32px 40px;">
                    <p style="margin: 0; font-size: 16px; color: #94a3b8; line-height: 1.6;">You're one step away from editing 10x faster. Use this code to sign in:</p>
                  </td>
                </tr>
                <tr>
                  <td align="center" style="padding: 0 40px 32px 40px;">
                    <table role="presentation" cellpadding="0" cellspacing="0" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 168, 204, 0.05) 100%); border-radius: 12px; border: 2px solid #00D4FF; box-shadow: 0 0 24px rgba(0, 212, 255, 0.25);">
                      <tr>
                        <td align="center" style="padding: 24px 48px;">
                          <span class="code-box" style="font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 36px; font-weight: 700; color: #00D4FF; letter-spacing: 10px; text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);">${escapeHtml(data.code)}</span>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td align="center" style="padding: 0 40px 40px 40px;">
                    <p style="margin: 0; font-size: 14px; color: #64748b;">‚è±Ô∏è This code expires in <strong style="color: #ffffff;">10 minutes</strong></p>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 0 40px;">
                    <table role="presentation" cellpadding="0" cellspacing="0" width="100%">
                      <tr><td style="border-top: 1px solid rgba(148, 163, 184, 0.1);"></td></tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 40px;">
                    <h2 style="margin: 0 0 24px 0; font-size: 18px; font-weight: 600; color: #ffffff;">üöÄ What you'll unlock:</h2>
                    <table role="presentation" cellpadding="0" cellspacing="0" width="100%">
                      <tr>
                        <td width="50%" style="padding: 8px 8px 8px 0; vertical-align: top;">
                          <table role="presentation" cellpadding="0" cellspacing="0">
                            <tr>
                              <td style="padding-right: 12px; vertical-align: top;"><span style="font-size: 20px;">‚ö°</span></td>
                              <td style="vertical-align: top;">
                                <p style="margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;">AI Silence Removal</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Auto-trim dead air</p>
                              </td>
                            </tr>
                          </table>
                        </td>
                        <td width="50%" style="padding: 8px 0 8px 8px; vertical-align: top;">
                          <table role="presentation" cellpadding="0" cellspacing="0">
                            <tr>
                              <td style="padding-right: 12px; vertical-align: top;"><span style="font-size: 20px;">üé¨</span></td>
                              <td style="vertical-align: top;">
                                <p style="margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;">Smart Take Detection</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Find best takes fast</p>
                              </td>
                            </tr>
                          </table>
                        </td>
                      </tr>
                      <tr>
                        <td width="50%" style="padding: 8px 8px 8px 0; vertical-align: top;">
                          <table role="presentation" cellpadding="0" cellspacing="0">
                            <tr>
                              <td style="padding-right: 12px; vertical-align: top;"><span style="font-size: 20px;">üéµ</span></td>
                              <td style="vertical-align: top;">
                                <p style="margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;">AI Music Generation</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Royalty-free tracks</p>
                              </td>
                            </tr>
                          </table>
                        </td>
                        <td width="50%" style="padding: 8px 0 8px 8px; vertical-align: top;">
                          <table role="presentation" cellpadding="0" cellspacing="0">
                            <tr>
                              <td style="padding-right: 12px; vertical-align: top;"><span style="font-size: 20px;">üì±</span></td>
                              <td style="vertical-align: top;">
                                <p style="margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;">Social Reframe</p>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Export to any platform</p>
                              </td>
                            </tr>
                          </table>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td align="center" style="padding: 0 40px 40px 40px;">
                    <table role="presentation" cellpadding="0" cellspacing="0">
                      <tr>
                        <td align="center" style="background: linear-gradient(135deg, #00D4FF 0%, #0099CC 100%); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);">
                          <a href="https://splice.video/download" target="_blank" style="display: inline-block; padding: 16px 40px; font-size: 16px; font-weight: 600; color: #060b14; text-decoration: none; letter-spacing: -0.3px;">Download SPLICE Now ‚Üí</a>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td align="center" style="padding: 40px 0 24px 0;">
              <p style="margin: 0; font-size: 14px; color: #64748b;">Need help getting started?</p>
            </td>
          </tr>
          <tr>
            <td align="center" style="padding-bottom: 40px;">
              <table role="presentation" cellpadding="0" cellspacing="0">
                <tr>
                  <td style="padding: 0 12px;"><a href="https://splice.video/docs/quickstart" style="font-size: 14px; color: #00D4FF; text-decoration: none;">Quick Start Guide</a></td>
                  <td style="color: #334155;">|</td>
                  <td style="padding: 0 12px;"><a href="https://discord.gg/splice" style="font-size: 14px; color: #00D4FF; text-decoration: none;">Join Discord</a></td>
                  <td style="color: #334155;">|</td>
                  <td style="padding: 0 12px;"><a href="mailto:support@splice.video" style="font-size: 14px; color: #00D4FF; text-decoration: none;">Contact Support</a></td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td align="center" style="padding: 24px 0; border-top: 1px solid rgba(148, 163, 184, 0.1);">
              <p style="margin: 0 0 8px 0; font-size: 13px; color: #475569;">You received this email because you signed up for SPLICE.</p>
              <p style="margin: 0; font-size: 13px; color: #475569;">¬© ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>
    `,
    text: (data) => `
Welcome to SPLICE!

Your sign-in code is: ${data.code}

This code expires in 10 minutes.

What you'll unlock:
- ‚ö° AI Silence Removal - Auto-trim dead air
- üé¨ Smart Take Detection - Find best takes fast
- üéµ AI Music Generation - Royalty-free tracks
- üì± Social Reframe - Export to any platform

Download SPLICE: https://splice.video/download

Need help?
- Quick Start Guide: https://splice.video/docs/quickstart
- Join Discord: https://discord.gg/splice
- Contact Support: support@splice.video

¬© ${new Date().getFullYear()} SPLICE. All rights reserved.
    `
  },

  // Email verification template
  emailVerification: {
    subject: 'Verify Your SPLICE Email: {{code}}',
    html: (data) => `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Verify Your SPLICE Email</title>
  <!--[if mso]>
  <noscript>
    <xml>
      <o:OfficeDocumentSettings>
        <o:PixelsPerInch>96</o:PixelsPerInch>
      </o:OfficeDocumentSettings>
    </xml>
  </noscript>
  <![endif]-->
  <style>
    body, table, td, p, a, li { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }
    table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; }
    img { -ms-interpolation-mode: bicubic; border: 0; outline: none; text-decoration: none; }
    body { margin: 0; padding: 0; width: 100%; background-color: #060b14; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    @media only screen and (max-width: 600px) {
      .container { width: 100% !important; padding: 16px !important; }
      .code-box { font-size: 28px !important; letter-spacing: 6px !important; }
    }
  </style>
</head>
<body style="margin: 0; padding: 0; background-color: #060b14;">
  <div style="display: none; max-height: 0; overflow: hidden; font-size: 1px; line-height: 1px; color: #060b14;">Verify your email to complete your SPLICE account setup.</div>
  <table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="background-color: #060b14;">
    <tr>
      <td align="center" style="padding: 40px 20px;">
        <table role="presentation" class="container" cellpadding="0" cellspacing="0" width="560" style="max-width: 560px;">
          <tr>
            <td align="center" style="padding-bottom: 32px;">
              <table role="presentation" cellpadding="0" cellspacing="0">
                <tr>
                  <td style="vertical-align: middle; padding-right: 10px;">
                    <img src="https://splice.video/images/logo.jpg" alt="SPLICE" width="40" height="40" style="display: block; border-radius: 8px;">
                  </td>
                  <td style="vertical-align: middle;">
                    <span style="font-size: 26px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px;">SPLICE</span>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td>
              <table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="background: linear-gradient(180deg, #0f1629 0%, #0a0f1a 100%); border-radius: 16px; border: 1px solid rgba(0, 212, 255, 0.15); box-shadow: 0 0 40px rgba(0, 212, 255, 0.08);">
                <tr>
                  <td align="center" style="padding: 40px 40px 24px 40px;">
                    <h1 style="margin: 0; font-size: 28px; font-weight: 600; color: #ffffff; line-height: 1.3;">Verify Your Email</h1>
                  </td>
                </tr>
                <tr>
                  <td align="center" style="padding: 0 40px 32px 40px;">
                    <p style="margin: 0; font-size: 16px; color: #94a3b8; line-height: 1.6;">Enter this verification code to confirm your email address:</p>
                  </td>
                </tr>
                <tr>
                  <td align="center" style="padding: 0 40px 32px 40px;">
                    <table role="presentation" cellpadding="0" cellspacing="0" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(22, 163, 74, 0.05) 100%); border-radius: 12px; border: 2px solid #22c55e; box-shadow: 0 0 24px rgba(34, 197, 94, 0.25);">
                      <tr>
                        <td align="center" style="padding: 24px 48px;">
                          <span class="code-box" style="font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 36px; font-weight: 700; color: #22c55e; letter-spacing: 10px; text-shadow: 0 0 20px rgba(34, 197, 94, 0.5);">${escapeHtml(data.code)}</span>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td align="center" style="padding: 0 40px 40px 40px;">
                    <p style="margin: 0; font-size: 14px; color: #64748b;">This code expires in <strong style="color: #ffffff;">${escapeHtml(String(data.expiresInMinutes || 10))} minutes</strong></p>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 0 40px;">
                    <table role="presentation" cellpadding="0" cellspacing="0" width="100%">
                      <tr><td style="border-top: 1px solid rgba(148, 163, 184, 0.1);"></td></tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td align="center" style="padding: 32px 40px;">
                    <p style="margin: 0; font-size: 14px; color: #64748b; line-height: 1.6;">If you didn't request this verification, you can safely ignore this email.</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td align="center" style="padding: 24px 0; border-top: 1px solid rgba(148, 163, 184, 0.1);">
              <p style="margin: 0 0 8px 0; font-size: 13px; color: #475569;">You received this email because someone used this address to sign up for SPLICE.</p>
              <p style="margin: 0; font-size: 13px; color: #475569;">&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>
    `,
    text: (data) => `
Verify Your SPLICE Email

Your verification code is: ${data.code}

This code expires in ${data.expiresInMinutes || 10} minutes.

If you didn't request this verification, you can safely ignore this email.

¬© ${new Date().getFullYear()} SPLICE. All rights reserved.
    `
  }
};

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Escape HTML to prevent XSS in email content
 */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  if (typeof str !== 'string') str = String(str);

  const escapeMap = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;'
  };

  return str.replace(/[&<>"']/g, char => escapeMap[char]);
}

/**
 * Get tier details for email
 */
function getTierDetails(tier) {
  const tiers = {
    starter: { hours: 4, musicCredits: 2 },
    pro: { hours: 15, musicCredits: 10 },
    team: { hours: 50, musicCredits: 50 }
  };
  return tiers[tier] || tiers.starter;
}

// ============================================================================
// EMAIL PROVIDERS
// ============================================================================

/**
 * Send email via SendGrid
 */
async function sendViaSendGrid(to, subject, html, text) {
  // CRITICAL-002: Validate email before API call
  const emailValidation = validateAndNormalizeEmail(to);
  if (!emailValidation.valid) {
    throw new Error(`Invalid recipient email: ${emailValidation.error}`);
  }
  const validatedTo = emailValidation.email;

  if (!EMAIL_CONFIG.sendgrid.apiKey) {
    throw new Error('SENDGRID_API_KEY not configured');
  }

  // Wrap SendGrid API call in circuit breaker
  return circuitBreakers.sendgrid.execute(async () => {
    const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${EMAIL_CONFIG.sendgrid.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        personalizations: [{ to: [{ email: validatedTo }] }],
        from: { email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || EMAIL_CONFIG.from, name: 'SPLICE' },
        reply_to: { email: EMAIL_CONFIG.replyTo },
        subject,
        content: [
          { type: 'text/plain', value: text },
          { type: 'text/html', value: html }
        ]
      })
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`SendGrid error: ${response.status} - ${error}`);
    }

    return { provider: 'sendgrid', messageId: response.headers.get('x-message-id') };
  }).catch((err) => {
    // Circuit breaker fallback: Log email and return deferred status
    console.warn('[SPLICE Email] SendGrid circuit breaker OPEN - Email deferred');
    console.log('[SPLICE Email] Deferred email:', { to, subject });
    
    // Log email content to console for dev environments
    if (EMAIL_CONFIG.provider === 'console') {
      console.log('--- EMAIL CONTENT (Circuit Breaker Fallback) ---');
      console.log(text);
      console.log('------------------------------------------------');
    }
    
    // Return success with deferred flag (email should be queued for retry in production)
    return {
      provider: 'sendgrid-deferred',
      messageId: `deferred-${Date.now()}`,
      deferred: true,
      circuitBreakerActive: true,
      reason: err.message
    };
  });
}

/**
 * Send email via SendGrid Dynamic Template
 * @param {string} to - Recipient email
 * @param {string} templateId - SendGrid dynamic template ID
 * @param {Object} dynamicData - Template variables
 */
async function sendViaSendGridTemplate(to, templateId, dynamicData = {}) {
  // CRITICAL-002: Validate email before API call
  const emailValidation = validateAndNormalizeEmail(to);
  if (!emailValidation.valid) {
    throw new Error(`Invalid recipient email: ${emailValidation.error}`);
  }
  const validatedTo = emailValidation.email;

  if (!EMAIL_CONFIG.sendgrid.apiKey) {
    throw new Error('SENDGRID_API_KEY not configured');
  }

  // Wrap SendGrid template API call in circuit breaker
  return circuitBreakers.sendgrid.execute(async () => {
    const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${EMAIL_CONFIG.sendgrid.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        personalizations: [{
          to: [{ email: validatedTo }],
          dynamic_template_data: dynamicData
        }],
        from: { email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || EMAIL_CONFIG.from, name: 'SPLICE' },
        reply_to: { email: EMAIL_CONFIG.replyTo },
        template_id: templateId
      })
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`SendGrid error: ${response.status} - ${error}`);
    }

    return { provider: 'sendgrid-template', messageId: response.headers.get('x-message-id'), templateId };
  }).catch((err) => {
    // Circuit breaker fallback: Log template email and return deferred status
    console.warn('[SPLICE Email] SendGrid circuit breaker OPEN - Template email deferred');
    console.log('[SPLICE Email] Deferred template email:', { to, templateId, dynamicData });
    
    // Log template data to console for dev environments
    if (EMAIL_CONFIG.provider === 'console') {
      console.log('--- TEMPLATE DATA (Circuit Breaker Fallback) ---');
      console.log(JSON.stringify(dynamicData, null, 2));
      console.log('------------------------------------------------');
    }
    
    // Return success with deferred flag (email should be queued for retry in production)
    return {
      provider: 'sendgrid-template-deferred',
      messageId: `deferred-template-${Date.now()}`,
      templateId,
      deferred: true,
      circuitBreakerActive: true,
      reason: err.message
    };
  });
}

/**
 * Send email via AWS SES
 */
async function sendViaSES(to, subject, html, text) {
  // Dynamically import AWS SDK to avoid loading if not needed
  try {
    const { SESClient, SendEmailCommand } = await import('@aws-sdk/client-ses');

    const client = new SESClient({ region: EMAIL_CONFIG.ses.region });

    const command = new SendEmailCommand({
      Source: EMAIL_CONFIG.from,
      Destination: { ToAddresses: [to] },
      ReplyToAddresses: [EMAIL_CONFIG.replyTo],
      Message: {
        Subject: { Data: subject, Charset: 'UTF-8' },
        Body: {
          Html: { Data: html, Charset: 'UTF-8' },
          Text: { Data: text, Charset: 'UTF-8' }
        }
      }
    });

    const result = await client.send(command);
    return { provider: 'ses', messageId: result.MessageId };
  } catch (err) {
    if (err.code === 'ERR_MODULE_NOT_FOUND') {
      throw new Error('AWS SDK not installed. Run: npm install @aws-sdk/client-ses');
    }
    throw err;
  }
}

/**
 * Log email to console (development mode)
 */
function sendViaConsole(to, subject, html, text) {
  console.log('\n========== EMAIL (CONSOLE MODE) ==========');
  console.log(`To: ${to}`);
  console.log(`Subject: ${subject}`);
  console.log(`From: ${EMAIL_CONFIG.from}`);
  console.log('--- TEXT VERSION ---');
  console.log(text);
  console.log('==========================================\n');

  return { provider: 'console', messageId: `console-${Date.now()}` };
}

// ============================================================================
// PUBLIC API
// ============================================================================

/**
 * Send an email using the configured provider
 * @param {string} to - Recipient email
 * @param {string} subject - Email subject
 * @param {string} html - HTML content
 * @param {string} text - Plain text content
 * @returns {Promise<{provider: string, messageId: string}>}
 */
async function sendEmail(to, subject, html, text) {
  const provider = EMAIL_CONFIG.provider.toLowerCase();

  console.log(`[SPLICE Email] Sending to ${to} via ${provider}`);

  try {
    let result;

    switch (provider) {
      case 'sendgrid':
        result = await sendViaSendGrid(to, subject, html, text);
        break;
      case 'ses':
        result = await sendViaSES(to, subject, html, text);
        break;
      case 'console':
      default:
        result = sendViaConsole(to, subject, html, text);
        break;
    }

    console.log(`[SPLICE Email] Sent successfully via ${result.provider}: ${result.messageId}`);
    return result;
  } catch (err) {
    console.error(`[SPLICE Email] Failed to send via ${provider}:`, err.message);
    throw err;
  }
}

/**
 * Send license key email to customer
 * @param {string} email - Customer email
 * @param {string} licenseKey - The license key
 * @param {string} tier - Subscription tier (starter/pro/team)
 */
async function sendLicenseKeyEmail(email, licenseKey, tier) {
  const tierDetails = getTierDetails(tier);
  const template = TEMPLATES.licenseKey;

  const data = {
    licenseKey,
    tier,
    hours: tierDetails.hours,
    musicCredits: tierDetails.musicCredits
  };

  return sendEmail(
    email,
    template.subject,
    template.html(data),
    template.text(data)
  );
}

/**
 * Send payment warning email to customer
 * @param {string} email - Customer email
 * @param {number} attemptCount - Which payment attempt failed (1-3)
 */
async function sendPaymentWarningEmail(email, attemptCount) {
  const template = TEMPLATES.paymentWarning;
  const data = { attemptCount };

  return sendEmail(
    email,
    template.subject,
    template.html(data),
    template.text(data)
  );
}

/**
 * Send license key lookup email
 * @param {string} email - Customer email
 * @param {string} licenseKey - The license key
 */
async function sendLicenseLookupEmail(email, licenseKey) {
  const template = TEMPLATES.licenseLookup;
  const data = { licenseKey };

  return sendEmail(
    email,
    template.subject,
    template.html(data),
    template.text(data)
  );
}

/**
 * Send sign-in code email (passwordless authentication)
 * @param {string} email - User email
 * @param {string} code - The sign-in code (e.g., 6-digit code)
 * @param {number} expiresInMinutes - How long until the code expires (default: 10)
 */
async function sendSignInCodeEmail(email, code, expiresInMinutes = 10) {
  const provider = EMAIL_CONFIG.provider.toLowerCase();

  // Use SendGrid Dynamic Template when available
  if (provider === 'sendgrid' && TEMPLATE_IDS.signinCode && EMAIL_CONFIG.sendgrid.apiKey) {
    console.log(`[SPLICE Email] Sending sign-in code to ${email} via SendGrid Dynamic Template`);
    return sendViaSendGridTemplate(email, TEMPLATE_IDS.signinCode, {
      code: code,
      expiresInMinutes: expiresInMinutes
    });
  }

  // Fallback to inline template
  const template = TEMPLATES.signinCode;
  const data = { code, expiresInMinutes };
  const subject = template.subject.replace('{{code}}', code);

  return sendEmail(
    email,
    subject,
    template.html(data),
    template.text(data)
  );
}

/**
 * Send email verification code
 * @param {string} email - User email
 * @param {string} code - The 6-digit verification code
 * @param {number} expiresInMinutes - How long until the code expires (default: 10)
 */
async function sendEmailVerificationCode(email, code, expiresInMinutes = 10) {
  const provider = EMAIL_CONFIG.provider.toLowerCase();

  // Use SendGrid Dynamic Template when available
  if (provider === 'sendgrid' && TEMPLATE_IDS.emailVerification && EMAIL_CONFIG.sendgrid.apiKey) {
    console.log(`[SPLICE Email] Sending verification code to ${email} via SendGrid Dynamic Template`);
    return sendViaSendGridTemplate(email, TEMPLATE_IDS.emailVerification, {
      code: code,
      expiresInMinutes: expiresInMinutes
    });
  }

  // Fallback to inline template
  const template = TEMPLATES.emailVerification;
  const data = { code, expiresInMinutes };
  const subject = template.subject.replace('{{code}}', code);

  return sendEmail(
    email,
    subject,
    template.html(data),
    template.text(data)
  );
}

/**
 * Check if email service is configured for production use
 */
function isEmailConfigured() {
  const provider = EMAIL_CONFIG.provider.toLowerCase();

  if (provider === 'sendgrid') {
    return !!EMAIL_CONFIG.sendgrid.apiKey;
  }

  if (provider === 'ses') {
    return !!(process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY);
  }

  // Console mode is always "configured" (for dev)
  return true;
}

// ============================================================================
// EXPORTS
// ============================================================================

module.exports = {
  sendEmail,
  sendLicenseKeyEmail,
  sendPaymentWarningEmail,
  sendLicenseLookupEmail,
  sendSignInCodeEmail,
  sendEmailVerificationCode,
  isEmailConfigured,
  EMAIL_CONFIG,
  // CRITICAL-002: Exported email validation helpers
  validateAndNormalizeEmail,
  extractAndValidateEmail
};
