#!/usr/bin/env node
/**
 * SPLICE Beta Tester Setup Script
 * 
 * Creates beta tester accounts through Stripe TEST mode with legitimate
 * license keys generated by the existing license service.
 * 
 * This script:
 * 1. Creates customers in Stripe TEST mode
 * 2. Creates subscriptions with 100% discount (free beta access)
 * 3. Generates license keys via the existing licenseService
 * 4. Sets up "team" tier for full feature access
 * 
 * Usage:
 *   STRIPE_SECRET_KEY=sk_test_xxx DATABASE_URL=xxx node scripts/setup-beta-testers.js
 * 
 * Or with .env file:
 *   node scripts/setup-beta-testers.js
 */

require('dotenv').config();
const Stripe = require('stripe');
const { Pool } = require('pg');
const crypto = require('crypto');
const fs = require('fs');
const path = require('path');
const os = require('os');

// =============================================================================
// Configuration
// =============================================================================

const STRIPE_KEY = process.env.STRIPE_SECRET_KEY;

if (!STRIPE_KEY) {
  console.error('ERROR: STRIPE_SECRET_KEY environment variable is required');
  process.exit(1);
}

// Require TEST mode key for safety
if (!STRIPE_KEY.startsWith('sk_test_')) {
  console.error('ERROR: This script requires a TEST mode secret key (sk_test_...)');
  console.error('Current key starts with:', STRIPE_KEY.substring(0, 10) + '...');
  console.error('\nFor safety, beta tester setup should use Stripe test mode.');
  process.exit(1);
}

const stripe = new Stripe(STRIPE_KEY);

// Database configuration (same as licenseService)
const sslConfig = process.env.NODE_ENV === 'production' ? {
  rejectUnauthorized: process.env.DATABASE_SSL_REJECT_UNAUTHORIZED === 'true',
  ca: process.env.DATABASE_SSL_CA || undefined
} : false;

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: sslConfig,
  max: 5,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000
});

// =============================================================================
// Beta Testers Configuration
// =============================================================================

const BETA_TESTERS = [
  {
    name: 'Josh Irizarry',
    email: 'josh.irizarry@beta.spliceclips.com',
    filename: 'Josh Irizarry'
  },
  {
    name: 'Danny Isakov',
    email: 'danny.isakov@beta.spliceclips.com',
    filename: 'Danny Isakov'
  },
  {
    name: 'Jimmy Nick',
    email: 'jimmy.nick@beta.spliceclips.com',
    filename: 'Jimmy Nick'
  }
];

// Team tier limits (full access)
const TEAM_TIER_CONFIG = {
  tier: 'team',
  hours: 50,
  isolationHours: 3, // 180 minutes
  musicCredits: 50
};

// =============================================================================
// License Key Generation (from licenseService)
// =============================================================================

const KEY_CHARS = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';

function generateSegment() {
  let segment = '';
  for (let i = 0; i < 4; i++) {
    segment += KEY_CHARS.charAt(crypto.randomInt(KEY_CHARS.length));
  }
  return segment;
}

function generateKeyString() {
  return `SPLICE-${generateSegment()}-${generateSegment()}-${generateSegment()}`;
}

// =============================================================================
// Database Functions
// =============================================================================

async function initTables(client) {
  // Ensure license_keys table exists
  await client.query(`
    CREATE TABLE IF NOT EXISTS license_keys (
      id SERIAL PRIMARY KEY,
      key VARCHAR(21) UNIQUE NOT NULL,
      stripe_customer_id VARCHAR(255) NOT NULL,
      created_at TIMESTAMP DEFAULT NOW(),
      activated_at TIMESTAMP,
      is_active BOOLEAN DEFAULT TRUE
    )
  `);
  
  // Ensure users table has all required columns
  await client.query(`
    CREATE TABLE IF NOT EXISTS users (
      id SERIAL PRIMARY KEY,
      stripe_customer_id VARCHAR(255) UNIQUE NOT NULL,
      email VARCHAR(255),
      tier VARCHAR(50) DEFAULT 'team',
      hours_remaining DECIMAL(10,4) DEFAULT 50,
      hours_total DECIMAL(10,4) DEFAULT 50,
      isolation_hours_remaining DECIMAL(10,4) DEFAULT 3,
      isolation_hours_total DECIMAL(10,4) DEFAULT 3,
      music_credits_remaining INTEGER DEFAULT 50,
      music_credits_total INTEGER DEFAULT 50,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
  `);
}

async function createLicenseKey(client, stripeCustomerId) {
  // Check if customer already has a key
  const existing = await client.query(
    'SELECT key FROM license_keys WHERE stripe_customer_id = $1',
    [stripeCustomerId]
  );
  
  if (existing.rows.length > 0) {
    return { key: existing.rows[0].key, existing: true };
  }
  
  // Generate unique key with retry logic
  let key;
  let attempts = 0;
  const maxAttempts = 10;
  
  while (attempts < maxAttempts) {
    key = generateKeyString();
    try {
      await client.query(
        `INSERT INTO license_keys (key, stripe_customer_id)
         VALUES ($1, $2)`,
        [key, stripeCustomerId]
      );
      break;
    } catch (err) {
      if (err.code === '23505') { // Unique violation
        attempts++;
        continue;
      }
      throw err;
    }
  }
  
  if (attempts >= maxAttempts) {
    throw new Error('Failed to generate unique license key');
  }
  
  return { key, existing: false };
}

async function createUserRecord(client, stripeCustomerId, email) {
  await client.query(
    `INSERT INTO users (
      stripe_customer_id, email, tier,
      hours_remaining, hours_total,
      isolation_hours_remaining, isolation_hours_total,
      music_credits_remaining, music_credits_total
    ) VALUES ($1, $2, $3, $4, $4, $5, $5, $6, $6)
     ON CONFLICT (stripe_customer_id) DO UPDATE
     SET tier = $3,
         hours_remaining = $4, hours_total = $4,
         isolation_hours_remaining = $5, isolation_hours_total = $5,
         music_credits_remaining = $6, music_credits_total = $6,
         updated_at = CURRENT_TIMESTAMP`,
    [
      stripeCustomerId,
      email,
      TEAM_TIER_CONFIG.tier,
      TEAM_TIER_CONFIG.hours,
      TEAM_TIER_CONFIG.isolationHours,
      TEAM_TIER_CONFIG.musicCredits
    ]
  );
}

// =============================================================================
// Stripe Functions
// =============================================================================

async function getOrCreateBetaCoupon() {
  const couponId = 'BETA_TESTER_100_OFF';
  
  try {
    // Check if coupon exists
    const existing = await stripe.coupons.retrieve(couponId);
    console.log('  ✓ Using existing beta tester coupon');
    return existing;
  } catch (err) {
    if (err.code === 'resource_missing') {
      // Create the coupon
      const coupon = await stripe.coupons.create({
        id: couponId,
        percent_off: 100,
        duration: 'forever',
        name: 'Beta Tester - 100% Off',
        metadata: {
          type: 'beta_tester',
          created_by: 'setup-beta-testers.js'
        }
      });
      console.log('  ✓ Created beta tester coupon (100% off forever)');
      return coupon;
    }
    throw err;
  }
}

async function getOrCreateTeamProduct() {
  // Search for existing team product
  const products = await stripe.products.search({
    query: 'metadata["tier"]:"team"'
  });
  
  if (products.data.length > 0) {
    const product = products.data[0];
    // Get prices for this product
    const prices = await stripe.prices.list({ product: product.id, active: true });
    const monthlyPrice = prices.data.find(p => p.recurring?.interval === 'month');
    
    if (monthlyPrice) {
      console.log('  ✓ Using existing Team product');
      return { product, price: monthlyPrice };
    }
  }
  
  // Create Team product (for test mode)
  console.log('  Creating Team product in test mode...');
  const product = await stripe.products.create({
    name: 'SPLICE Team (Beta)',
    description: 'Full access for beta testers - 50 hours, 50 music credits, 3hr vocal isolation',
    metadata: { tier: 'team', beta: 'true' }
  });
  
  const price = await stripe.prices.create({
    product: product.id,
    unit_amount: 12900, // $129
    currency: 'usd',
    recurring: { interval: 'month' },
    metadata: { plan: 'team_monthly_beta' }
  });
  
  console.log('  ✓ Created Team product and price');
  return { product, price };
}

async function createBetaTesterCustomer(tester, coupon, price) {
  // Check if customer already exists
  const existing = await stripe.customers.search({
    query: `email:"${tester.email}"`
  });
  
  let customer;
  if (existing.data.length > 0) {
    customer = existing.data[0];
    console.log(`  ℹ Using existing customer: ${customer.id}`);
  } else {
    customer = await stripe.customers.create({
      email: tester.email,
      name: tester.name,
      metadata: {
        type: 'beta_tester',
        created_by: 'setup-beta-testers.js',
        created_at: new Date().toISOString()
      }
    });
    console.log(`  ✓ Created customer: ${customer.id}`);
  }
  
  // Check for existing subscription
  const subscriptions = await stripe.subscriptions.list({
    customer: customer.id,
    status: 'all'
  });
  
  let subscription;
  const activeSubscription = subscriptions.data.find(s => 
    s.status === 'active' || s.status === 'trialing'
  );
  
  if (activeSubscription) {
    subscription = activeSubscription;
    console.log(`  ℹ Using existing subscription: ${subscription.id}`);
  } else {
    subscription = await stripe.subscriptions.create({
      customer: customer.id,
      items: [{ price: price.id }],
      coupon: coupon.id,
      metadata: {
        type: 'beta_tester',
        tier: 'team'
      }
    });
    console.log(`  ✓ Created subscription with 100% discount: ${subscription.id}`);
  }
  
  return { customer, subscription };
}

// =============================================================================
// Output File Generation
// =============================================================================

function generateBetaTesterFile(tester, customerId, licenseKey, subscriptionId) {
  const timestamp = new Date().toISOString();
  
  return `================================================================================
SPLICE BETA TESTER CREDENTIALS
================================================================================

Name: ${tester.name}
Email: ${tester.email}

--------------------------------------------------------------------------------
LICENSE KEY (for plugin activation)
--------------------------------------------------------------------------------

${licenseKey}

--------------------------------------------------------------------------------
ACCOUNT DETAILS
--------------------------------------------------------------------------------

Customer ID: ${customerId}
Subscription: ${subscriptionId}
Account Type: BETA TESTER (Team Tier - Full Access)

--------------------------------------------------------------------------------
TIER & LIMITS
--------------------------------------------------------------------------------

Plan: Team (Beta)
Monthly Processing Hours: 50 hours
Vocal Isolation: 3 hours/month (180 minutes)
AI Music Credits: 50/month

--------------------------------------------------------------------------------
FEATURE ACCESS (All Features Enabled)
--------------------------------------------------------------------------------

✅ Silence Removal
✅ Take Detection
✅ Filler Word Detection
✅ Caption Export (All Formats)
✅ Vocal Isolation
✅ Social Reframe (9:16, 1:1, etc.)
✅ Text-Based Editing
✅ Animated Captions (All Styles)
✅ Profanity Detection & Bleeping
✅ Chapter Detection
✅ Multi-track Analysis
✅ AI Music Generation
✅ Music to Cut
✅ Mood Timeline
✅ YouTube Metadata Generation

--------------------------------------------------------------------------------
HOW TO ACTIVATE
--------------------------------------------------------------------------------

1. Install the SPLICE plugin from the provided installer
2. Open Premiere Pro
3. Go to Window > Extensions > SPLICE
4. Click "Enter License Key"
5. Paste your license key: ${licenseKey}
6. Click "Activate"

--------------------------------------------------------------------------------
SUPPORT
--------------------------------------------------------------------------------

For technical issues: support@spliceclips.com
Website: https://spliceclips.com

--------------------------------------------------------------------------------
NOTES
--------------------------------------------------------------------------------

- This is a BETA account with full Team tier access
- No charges will be made during the beta period
- Please report any bugs or issues to support
- Beta period: Until further notice

================================================================================
Generated: ${timestamp}
================================================================================
`;
}

// =============================================================================
// Main Setup Function
// =============================================================================

async function setupBetaTesters() {
  console.log('='.repeat(60));
  console.log('SPLICE BETA TESTER SETUP');
  console.log('Mode: Stripe TEST');
  console.log('='.repeat(60));
  console.log('');
  
  const results = [];
  const client = await pool.connect();
  
  try {
    // Initialize database tables
    console.log('1. Initializing database tables...');
    await initTables(client);
    console.log('  ✓ Database tables ready\n');
    
    // Get or create coupon
    console.log('2. Setting up Stripe coupon...');
    const coupon = await getOrCreateBetaCoupon();
    console.log('');
    
    // Get or create team product
    console.log('3. Setting up Team product...');
    const { product: _product, price: _price } = await getOrCreateTeamProduct();
    console.log('');
    
    // Create beta testers
    console.log('4. Creating beta tester accounts...\n');
    
    for (let i = 0; i < BETA_TESTERS.length; i++) {
      const tester = BETA_TESTERS[i];
      console.log(`--- ${tester.name} ---`);
      
      // Create Stripe customer and subscription
      const { customer, subscription } = await createBetaTesterCustomer(tester, coupon, price);
      
      // Create user record in database
      await createUserRecord(client, customer.id, tester.email);
      console.log(`  ✓ Created user record with Team tier`);
      
      // Generate license key
      const { key, existing } = await createLicenseKey(client, customer.id);
      console.log(`  ✓ ${existing ? 'Retrieved' : 'Generated'} license key: ${key.substring(0, 10)}****`);
      
      results.push({
        tester,
        customerId: customer.id,
        subscriptionId: subscription.id,
        licenseKey: key
      });
      
      console.log('');
    }
    
    // Create output directory and files
    console.log('5. Creating beta tester files...');
    const betaDir = path.join(os.homedir(), 'Desktop', 'BETA TESTERS');
    
    if (!fs.existsSync(betaDir)) {
      fs.mkdirSync(betaDir, { recursive: true });
      console.log(`  ✓ Created directory: ${betaDir}`);
    } else {
      console.log(`  ℹ Directory exists: ${betaDir}`);
    }
    
    for (const result of results) {
      const fileContent = generateBetaTesterFile(
        result.tester,
        result.customerId,
        result.licenseKey,
        result.subscriptionId
      );
      
      const filePath = path.join(betaDir, `${result.tester.filename}.txt`);
      fs.writeFileSync(filePath, fileContent, 'utf8');
      console.log(`  ✓ Created: ${result.tester.filename}.txt`);
    }
    
    // Summary
    console.log('\n' + '='.repeat(60));
    console.log('SETUP COMPLETE');
    console.log('='.repeat(60));
    console.log('');
    console.log('Beta Tester Accounts Created:');
    console.log('');
    
    for (const result of results) {
      console.log(`  ${result.tester.name}`);
      console.log(`    Email: ${result.tester.email}`);
      console.log(`    Customer ID: ${result.customerId}`);
      console.log(`    License Key: ${result.licenseKey}`);
      console.log('');
    }
    
    console.log(`Files created in: ${betaDir}`);
    console.log('');
    console.log('='.repeat(60));
    console.log('IMPORTANT: These are TEST mode accounts!');
    console.log('To use in production, run setup with sk_live_ key.');
    console.log('='.repeat(60));
    
  } catch (err) {
    console.error('\nERROR:', err.message);
    if (err.raw) {
      console.error('Details:', err.raw.message);
    }
    throw err;
  } finally {
    client.release();
    await pool.end();
  }
  
  return results;
}

// Run the setup
setupBetaTesters()
  .then(() => process.exit(0))
  .catch(() => process.exit(1));
