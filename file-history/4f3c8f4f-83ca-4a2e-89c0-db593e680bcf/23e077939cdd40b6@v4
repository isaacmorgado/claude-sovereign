#!/bin/bash
# Suno AI Music Generation Prompt Creator
# Analyzes songs and creates optimized prompts for Suno

set -euo pipefail

# Check if URL/file provided
if [[ -z "${1:-}" ]]; then
    echo "Usage: /suno <youtube-url|file-path> [topic]"
    echo ""
    echo "Analyzes a song and generates Suno AI prompts:"
    echo "  - Style prompt: Musical attributes, BPM, key, instrumentation (<1000 chars)"
    echo "  - Lyrics prompt: Similar vibe/structure with new lyrics (<5000 chars)"
    echo ""
    echo "Examples:"
    echo "  /suno https://youtube.com/watch?v=..."
    echo "  /suno https://youtube.com/watch?v=... \"a song about summer love\""
    echo "  /suno ~/Music/song.mp3 \"a song about overcoming challenges\""
    exit 0
fi

INPUT="$1"
TOPIC="${2:-similar theme}"

# Temporary directory for downloads
TEMP_DIR="/tmp/claude/-Users-imorgado/4f3c8f4f-83ca-4a2e-89c0-db593e680bcf/scratchpad"
mkdir -p "$TEMP_DIR"

AUDIO_FILE=""
DOWNLOADED=false

# Determine if input is URL or file
if [[ "$INPUT" =~ ^https?:// ]]; then
    echo "üì° Fetching YouTube video information..."

    # Get video metadata
    TITLE=$(yt-dlp --print "%(title)s" "$INPUT" 2>/dev/null || echo "Unknown")
    ARTIST=$(yt-dlp --print "%(uploader)s" "$INPUT" 2>/dev/null || echo "Unknown")
    DURATION=$(yt-dlp --print "%(duration)s" "$INPUT" 2>/dev/null || echo "0")

    echo "üéµ Song: $TITLE"
    echo "üé§ Artist: $ARTIST"
    echo "‚è±Ô∏è  Duration: ${DURATION}s"
    echo ""

    # Download audio for analysis
    echo "‚¨áÔ∏è  Downloading audio for analysis..."
    AUDIO_FILE="$TEMP_DIR/suno_audio_$(date +%s).m4a"
    if yt-dlp -f 'bestaudio[ext=m4a]' -o "$AUDIO_FILE" "$INPUT" 2>/dev/null; then
        echo "‚úÖ Audio downloaded successfully"
        DOWNLOADED=true
    else
        echo "‚ö†Ô∏è  Download failed, will use web search fallback"
        AUDIO_FILE=""
    fi
    echo ""
elif [[ -f "$INPUT" ]]; then
    TITLE=$(basename "$INPUT" .mp3 .m4a .flac .wav)
    ARTIST="Unknown"
    AUDIO_FILE="$INPUT"
    echo "üéµ Analyzing file: $TITLE"
    echo ""
else
    echo "‚ùå Error: Input must be a valid URL or file path"
    exit 1
fi

# Run audio analysis if we have an audio file
AUDIO_ANALYSIS=""
ANALYSIS_METHOD="web_search"
if [[ -n "$AUDIO_FILE" && -f "$AUDIO_FILE" ]]; then
    echo "üî¨ Running audio analysis..."
    ANALYSIS_SCRIPT="$HOME/.claude/scripts/analyze-audio.py"

    if [[ -x "$ANALYSIS_SCRIPT" ]]; then
        AUDIO_ANALYSIS=$(python3 "$ANALYSIS_SCRIPT" "$AUDIO_FILE" 2>/dev/null || echo "")

        if [[ -n "$AUDIO_ANALYSIS" ]]; then
            # Check if analysis was successful
            if echo "$AUDIO_ANALYSIS" | grep -q '"success": true'; then
                echo "‚úÖ Audio analysis complete"
                ANALYSIS_METHOD="audio_analysis"

                # Extract key values for display
                BPM_DETECTED=$(echo "$AUDIO_ANALYSIS" | grep -o '"bpm": [0-9.]*' | cut -d' ' -f2)
                KEY_DETECTED=$(echo "$AUDIO_ANALYSIS" | grep -o '"key": "[^"]*"' | cut -d'"' -f4)
                SCALE_DETECTED=$(echo "$AUDIO_ANALYSIS" | grep -o '"scale": "[^"]*"' | cut -d'"' -f4)

                echo "  BPM: $BPM_DETECTED"
                echo "  Key: $KEY_DETECTED $SCALE_DETECTED"
            else
                echo "‚ö†Ô∏è  Audio analysis failed, will use web search fallback"
                ERROR_MSG=$(echo "$AUDIO_ANALYSIS" | grep -o '"message": "[^"]*"' | cut -d'"' -f4)
                echo "  Reason: $ERROR_MSG"
                AUDIO_ANALYSIS=""
            fi
        else
            echo "‚ö†Ô∏è  Audio analysis produced no output, will use web search fallback"
        fi
    else
        echo "‚ö†Ô∏è  Audio analysis script not found or not executable"
        echo "  Expected: $ANALYSIS_SCRIPT"
    fi
    echo ""
fi

# Clean up downloaded file if needed
cleanup() {
    if [[ "$DOWNLOADED" == "true" && -f "$AUDIO_FILE" ]]; then
        rm -f "$AUDIO_FILE"
    fi
}
trap cleanup EXIT

# Output the analysis prompt for Claude
if [[ "$ANALYSIS_METHOD" == "audio_analysis" ]]; then
    cat << ANALYSIS_PROMPT

# Suno AI Prompt Generation Task

## AUDIO ANALYSIS DATA AVAILABLE

The song has been analyzed using professional audio analysis software (Essentia/Librosa).
Here is the ACCURATE audio analysis data:

\`\`\`json
$AUDIO_ANALYSIS
\`\`\`

You MUST use this data for BPM, key, and mood instead of web searching.

## 1. STYLE PROMPT (strictly <1000 characters)

**Step 1: Use Provided Audio Analysis**
- BPM: Use the "bpm" value from analysis data
- Key: Use the "key" and "scale" values from analysis data
- Mood: Incorporate the "mood" description from analysis data
- Energy: Reference "avg_energy" and "dynamics" for intensity descriptions

**Step 2: Analyze Vocal Characteristics**
- Search for: "$TITLE $ARTIST vocal style tone delivery voice characteristics"
- Identify vocal elements:
  * **Vocal Range:** (tenor, baritone, alto, soprano, bass)
  * **Vocal Tone:** (smooth, raspy, breathy, crisp, warm, cold, robotic)
  * **Vocal Texture:** (clean, gritty, airy, compressed, lo-fi, polished)
  * **Delivery Style:** (laid-back, aggressive, confident, vulnerable, melodic, rhythmic)
  * **Vocal Effects:** (autotune level, reverb, delay, distortion, pitch correction)
  * **Unique Characteristics:** (falsetto, vocal fry, runs, ad-libs, melisma)
  * **Similar Artists:** (voice comparisons 4 reference)

**Step 3: Research Genre and Instrumentation**
- Search for: "$TITLE $ARTIST genre instrumentation production"
- Look for: genre classification, instrument breakdown, production style
- Identify: bass style, drums/percussion, melodic elements, synths, guitars, etc.
- Note: texture (dreamy, aggressive, clean, distorted), layering

**Step 3: Describe Beat/Rhythm**
- Use the detected BPM to inform rhythm description
- Identify rhythm pattern (Afrobeat, trap, boom-bap, etc.)
- Note: groove feel (laid-back, driving, syncopated)
- Percussion details: hi-hats, snares, kicks, shakers, cowbells, etc.

**Step 4: Create Voice Persona & Style Prompt**

First, create a voice persona summary:
\`\`\`
PERSONA NAME: [Artist name or creative alias]

STYLES: [Genre 1], [Genre 2], [Genre 3], [Genre 4]

DESCRIPTION:
[Gender] vocalist with [range] range. Voice is [tone qualities] with [texture description]. Delivery is [style characteristics] with [unique elements]. Uses [effects] & [techniques]. Tone is [overall quality]. Similar 2: [Artist 1] meets [Artist 2] meets [Artist 3].
\`\`\`

Then create the full style prompt:
\`\`\`
A [mood from analysis] [genre from research] song at [BPM from analysis] bpm in the key of [Key from analysis] sung by [vocal description from persona]. Features [instrumentation from research]. Vocals use [vocal techniques]. The mood is [mood + energy description] with [delivery style].

[Intro] [description including vocal elements]

[Verse] [description with vocal delivery notes]

[Chorus] [description with vocal techniques]

[Verse 2] [description with vocal variations]

[Bridge] [description highlighting vocal showcase]

[Outro] [description with vocal fade elements]
\`\`\`

**CRITICAL: Keep total under 1000 characters**
**IMPORTANT: Use ONLY the BPM and key from the audio analysis data - do NOT search for or guess these values**
ANALYSIS_PROMPT
else
    cat << 'ANALYSIS_PROMPT'

# Suno AI Prompt Generation Task

## NO AUDIO ANALYSIS AVAILABLE

Audio analysis could not be performed. You will need to research the song details manually.

You need to analyze the song and create TWO optimized prompts for Suno AI music generation:

## 1. STYLE PROMPT (strictly <1000 characters)

Follow this process to extract musical attributes:

**Step 1: Research Song Details**
- Search for: "[SONG_TITLE] [ARTIST] BPM key genre"
- Look for music databases (MusicStax, Tunebat, Song BPM, etc.)
- Find: BPM, Key, Genre, Mood

**Step 2: Analyze Instrumentation**
- Search for: "[SONG_TITLE] instrumental breakdown" or "production analysis"
- Identify: bass style, drums/percussion, melodic elements, synths, guitars, etc.
- Note: texture (dreamy, aggressive, clean, distorted), layering

**Step 3: Describe Beat/Rhythm**
- Identify rhythm pattern (Afrobeat, trap, boom-bap, etc.)
- Note: groove feel (laid-back, driving, syncopated)
- Percussion details: hi-hats, snares, kicks, shakers, cowbells, etc.

**Step 4: Create Structured Style Prompt**
Format:
```
A [mood] [genre] song at [BPM] bpm in the key of [Key]. Features [instrumentation list]. The mood is [emotional description] with [vocal style].

[Intro] [description]

[Verse] [description]

[Chorus] [description]

[Verse 2] [description]

[Bridge] [description]

[Outro] [description]
```

**CRITICAL: Keep total under 1000 characters**
ANALYSIS_PROMPT
fi

---

## 2. LYRICS PROMPT (strictly <5000 characters)

**Step 1: Get Original Lyrics**
- Search for: "[SONG_TITLE] [ARTIST] lyrics"
- Read full lyrics carefully

**Step 2: Analyze Structure**
- Identify: intro, verses, pre-chorus, chorus, bridge, outro
- Note: rhyme scheme, line length, syllable patterns
- Observe: repetition patterns, hooks, ad-libs

**Step 3: Extract Vibe/Essence**
- Theme: What is the song about? (love, loss, celebration, struggle, etc.)
- Tone: Emotional quality (melancholic, upbeat, introspective, confident, etc.)
- Imagery: Visual/sensory language used
- Voice: Perspective (first person, storytelling, conversational, poetic)

**Step 4: Generate New Lyrics**
Based on topic: "TOPIC_PLACEHOLDER"

Rules:
- DO NOT copy original lyrics - create NEW content
- CAPTURE the vibe, tone, and emotional essence
- MATCH the structure (verse/chorus/bridge layout)
- USE similar rhyme schemes and line patterns
- MAINTAIN similar syllable counts per line
- KEEP total under 5000 characters

Format with clear sections:
```
[Intro]
(lyrics or description)

[Verse 1]
(lyrics)

[Pre-Chorus] (if applicable)
(lyrics)

[Chorus]
(lyrics)

[Verse 2]
(lyrics)

[Chorus]
(lyrics)

[Bridge]
(lyrics)

[Chorus]
(lyrics)

[Outro]
(lyrics or description)
```

---

## Output Format

Present voice persona & both prompts clearly:

```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SUNO AI PROMPTS FOR: [Song Title]
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä SONG ANALYSIS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Title: [title]
Artist: [artist]
Genre: [genre]
BPM: [bpm]
Key: [key]
Mood: [mood description]

üé§ VOICE PERSONA (for Suno Persona feature)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
PERSONA NAME: [name]

STYLES: [style 1], [style 2], [style 3], [style 4]

DESCRIPTION:
[Full vocal description with range, tone, texture, delivery, effects, & artist comparisons]

üéπ STYLE PROMPT (for Suno "Style of Music" field)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
[Character count: XXX/1000]

[Full style prompt with integrated vocal characteristics]

‚úçÔ∏è LYRICS PROMPT (for Suno "Lyrics" field)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
[Character count: XXXX/5000]

[Full structured lyrics here]

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
```

**IMPORTANT REMINDERS:**
- Style prompt MUST be <1000 characters (strictly enforce)
- Lyrics prompt MUST be <5000 characters (strictly enforce)
- Show character counts for both
- Lyrics must be ORIGINAL, not copied
- Capture the VIBE/ESSENCE, not literal content
- Match the STRUCTURE and FLOW of the original

---

## SUNO AI CENSORSHIP BYPASS TECHNIQUES

Apply these lyrical loopholes to avoid Suno's content filters:

**Common Word Replacements:**
- Be ‚Üí b
- For ‚Üí 4
- To/too ‚Üí 2
- Die ‚Üí dye
- No ‚Üí know
- Know ‚Üí no
- You ‚Üí u
- Dead ‚Üí ded
- Baby ‚Üí baybay/baybee
- Come ‚Üí cum
- Love ‚Üí luv
- High ‚Üí hi
- Hi ‚Üí high
- Deaf ‚Üí def
- Fuck ‚Üí phuck (any F word can use PH)
- Blood ‚Üí blud
- See ‚Üí c
- Read ‚Üí reed/red
- Red ‚Üí read
- Lead ‚Üí led
- And ‚Üí &
- Not ‚Üí knot
- I ‚Üí eye
- Hurt ‚Üí hirt
- Lie ‚Üí lye
- Dark ‚Üí darc
- Random ‚Üí randum
- Hey ‚Üí hay

**Advanced Techniques:**
- Swap F for PH, I for Y and vice versa
- Use phonetic spelling (sh*t ‚Üí ship, fuhk)
- Use homophones (words that sound the same but different spelling)
- Remove pronouns to de-escalate phrases ("I hope you choke" ‚Üí "hope choke")
- Alter sentence structure to avoid context triggers
- Keep overall theme non-violent/non-explicit to pass context analysis

**Audio Bypass (for reference tracks):**
- Change BPM/TEMPO in your DAW
- Change PITCH, KEY or OCTAVE to avoid copyright detection

**Apply bypasses naturally** - don't overdo it or lyrics become unreadable. Use strategically for words that might trigger filters.

ANALYSIS_PROMPT

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "üéº Suno AI Analysis Ready"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
echo "Input Information:"
echo "  Source: $INPUT"
echo "  Title: $TITLE"
echo "  Artist: $ARTIST"
echo "  Topic for lyrics: \"$TOPIC\""
echo ""
echo "Analysis Method: $ANALYSIS_METHOD"
if [[ "$ANALYSIS_METHOD" == "audio_analysis" ]]; then
    echo "‚úÖ Using accurate audio analysis data (Essentia/Librosa)"
    echo "   - BPM and key detection performed on actual audio"
    echo "   - Energy, dynamics, and spectral analysis available"
    echo "   - Mood automatically determined from audio features"
else
    echo "‚ö†Ô∏è  Using web search fallback"
    echo "   - Audio analysis unavailable (install: pip install essentia-tensorflow)"
    echo "   - Will search for BPM, key, and genre online"
fi
echo ""
echo "Next: Claude will generate optimized Suno AI prompts"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
