#!/usr/bin/env node

/**
 * Process Capture Bundle
 *
 * Takes the JSON file downloaded from the browser console capture script
 * and processes it: extracts files, beautifies JS/CSS, deobfuscates.
 *
 * Usage: node process-capture.js <capture-file.json> [output-dir]
 */

const fs = require('fs').promises;
const path = require('path');
const Deobfuscator = require('./lib/deobfuscator');

// Simple JS beautifier (no external deps)
function beautifyJS(code) {
  try {
    // Basic formatting
    let result = code;

    // Add newlines after semicolons (but not in strings or for loops)
    result = result.replace(/;(?=\s*[^\s])/g, ';\n');

    // Add newlines after opening braces
    result = result.replace(/\{(?=\s*[^\s\}])/g, '{\n');

    // Add newlines before closing braces
    result = result.replace(/(?<=\S)\}/g, '\n}');

    // Add newlines after closing braces
    result = result.replace(/\}(?=\s*[a-zA-Z])/g, '}\n');

    // Indent (simple)
    const lines = result.split('\n');
    let indent = 0;
    const indented = lines.map(line => {
      const trimmed = line.trim();
      if (!trimmed) return '';

      // Decrease indent for closing braces
      if (trimmed.startsWith('}') || trimmed.startsWith(']')) {
        indent = Math.max(0, indent - 1);
      }

      const indentedLine = '  '.repeat(indent) + trimmed;

      // Increase indent for opening braces
      if (trimmed.endsWith('{') || trimmed.endsWith('[')) {
        indent++;
      }

      return indentedLine;
    });

    return indented.join('\n');
  } catch (e) {
    return code;
  }
}

// Simple CSS beautifier
function beautifyCSS(code) {
  try {
    let result = code;

    // Add newline after {
    result = result.replace(/\{/g, '{\n');

    // Add newline after }
    result = result.replace(/\}/g, '\n}\n');

    // Add newline after ;
    result = result.replace(/;/g, ';\n');

    // Remove multiple newlines
    result = result.replace(/\n\s*\n/g, '\n');

    // Indent properties
    const lines = result.split('\n');
    let inBlock = false;
    const indented = lines.map(line => {
      const trimmed = line.trim();
      if (!trimmed) return '';

      if (trimmed.includes('{')) {
        inBlock = true;
        return trimmed;
      }
      if (trimmed.includes('}')) {
        inBlock = false;
        return trimmed;
      }

      return inBlock ? '  ' + trimmed : trimmed;
    });

    return indented.join('\n');
  } catch (e) {
    return code;
  }
}

async function processCapture(inputFile, outputDir) {
  console.log('\n╔═══════════════════════════════════════════╗');
  console.log('║      Process Capture Bundle               ║');
  console.log('╚═══════════════════════════════════════════╝\n');

  // Read input file
  console.log(`[INFO] Reading: ${inputFile}`);
  const content = await fs.readFile(inputFile, 'utf-8');
  const bundle = JSON.parse(content);

  console.log(`[INFO] Site: ${bundle.site}`);
  console.log(`[INFO] Captured: ${bundle.capturedAt}`);

  // Create output directories
  const dirs = ['html', 'js', 'js-beautified', 'js-deobfuscated', 'css', 'css-beautified', 'api'];
  for (const dir of dirs) {
    await fs.mkdir(path.join(outputDir, dir), { recursive: true });
  }

  const stats = {
    pages: 0,
    scripts: 0,
    scriptsBeautified: 0,
    scriptsDeobfuscated: 0,
    styles: 0,
    stylesBeautified: 0,
    api: 0
  };

  // Process HTML pages
  console.log('\n[STEP] Processing HTML pages...');
  for (const [filename, page] of Object.entries(bundle.data.pages || {})) {
    const outPath = path.join(outputDir, 'html', filename);
    await fs.writeFile(outPath, page.content);
    console.log(`  - ${filename} (${(page.size / 1024).toFixed(1)} KB)`);
    stats.pages++;
  }

  // Process JavaScript
  console.log('\n[STEP] Processing JavaScript...');
  const deobfuscator = new Deobfuscator();

  for (const [filename, script] of Object.entries(bundle.data.scripts || {})) {
    // Save original
    const origPath = path.join(outputDir, 'js', filename);
    await fs.writeFile(origPath, script.content);
    stats.scripts++;

    // Beautify
    try {
      const beautified = beautifyJS(script.content);
      const beautPath = path.join(outputDir, 'js-beautified', filename);
      await fs.writeFile(beautPath, beautified);
      stats.scriptsBeautified++;
    } catch (e) {}

    // Deobfuscate if needed
    if (Deobfuscator.isObfuscated(script.content)) {
      try {
        const result = deobfuscator.deobfuscate(script.content);
        const deobPath = path.join(outputDir, 'js-deobfuscated', filename);
        await fs.writeFile(deobPath, result.code);
        console.log(`  - ${filename} [DEOBFUSCATED] (${result.stats.stringsDecoded} strings decoded)`);
        stats.scriptsDeobfuscated++;
      } catch (e) {
        console.log(`  - ${filename} (deobfuscation failed: ${e.message})`);
      }
    } else {
      console.log(`  - ${filename}`);
    }
  }

  // Process CSS
  console.log('\n[STEP] Processing CSS...');
  for (const [filename, style] of Object.entries(bundle.data.styles || {})) {
    // Save original
    const origPath = path.join(outputDir, 'css', filename);
    await fs.writeFile(origPath, style.content);
    stats.styles++;

    // Beautify
    try {
      const beautified = beautifyCSS(style.content);
      const beautPath = path.join(outputDir, 'css-beautified', filename);
      await fs.writeFile(beautPath, beautified);
      stats.stylesBeautified++;
    } catch (e) {}

    console.log(`  - ${filename}`);
  }

  // Process API responses
  console.log('\n[STEP] Processing API responses...');
  for (const [filename, api] of Object.entries(bundle.data.api || {})) {
    const outPath = path.join(outputDir, 'api', filename);
    const content = JSON.stringify({
      url: api.url,
      method: api.method,
      status: api.status,
      timestamp: api.timestamp,
      response: api.data
    }, null, 2);
    await fs.writeFile(outPath, content);
    console.log(`  - ${api.method} ${api.url}`);
    stats.api++;
  }

  // Generate summary
  const summary = `# Processed Capture Summary

**Source:** ${bundle.site}
**Captured:** ${bundle.capturedAt}
**Processed:** ${new Date().toISOString()}

## Statistics
- HTML Pages: ${stats.pages}
- JavaScript Files: ${stats.scripts}
  - Beautified: ${stats.scriptsBeautified}
  - Deobfuscated: ${stats.scriptsDeobfuscated}
- CSS Files: ${stats.styles}
  - Beautified: ${stats.stylesBeautified}
- API Responses: ${stats.api}

## Directory Structure
\`\`\`
${outputDir}/
├── html/            # HTML pages
├── js/              # Original JavaScript
├── js-beautified/   # Beautified JavaScript
├── js-deobfuscated/ # Deobfuscated JavaScript
├── css/             # Original CSS
├── css-beautified/  # Beautified CSS
└── api/             # API responses (JSON)
\`\`\`

## API Endpoints Captured
${Object.values(bundle.data.api || {}).map(a => `- ${a.method} ${a.url}`).join('\n')}
`;

  await fs.writeFile(path.join(outputDir, 'SUMMARY.md'), summary);

  // Print summary
  console.log('\n╔═══════════════════════════════════════════╗');
  console.log('║           Processing Complete!            ║');
  console.log('╚═══════════════════════════════════════════╝');
  console.log(`
  Pages:              ${stats.pages}
  Scripts:            ${stats.scripts}
    Beautified:       ${stats.scriptsBeautified}
    Deobfuscated:     ${stats.scriptsDeobfuscated}
  Styles:             ${stats.styles}
    Beautified:       ${stats.stylesBeautified}
  API Responses:      ${stats.api}

  Output: ${path.resolve(outputDir)}
`);
}

// CLI
const args = process.argv.slice(2);
if (args.length < 1) {
  console.log(`
Usage: node process-capture.js <capture-file.json> [output-dir]

Examples:
  node process-capture.js site-capture-1234567890.json
  node process-capture.js site-capture-1234567890.json ./faceiq-processed
`);
  process.exit(1);
}

const inputFile = args[0];
const outputDir = args[1] || './processed-capture';

processCapture(inputFile, outputDir).catch(err => {
  console.error(`Error: ${err.message}`);
  process.exit(1);
});
