/**
 * AUTO-CAPTURE OFFLINE - Paste in browser console
 * Automatically captures HTML, JS, CSS, API calls as you browse
 * When done, run: capture.save()
 */
(function(){
const D={pages:{},scripts:{},styles:{},api:{}};
let F=window.fetch,X=XMLHttpRequest.prototype.open,CS=new Set(),CY=new Set();

function N(u){try{const p=new URL(u);let n=p.pathname.replace(/^\//,'').replace(/\//g,'_')||'index';if(p.search)n+='_'+p.search.slice(1).replace(/[=&]/g,'-').replace(/[^a-zA-Z0-9_-]/g,'');return n.slice(0,100)}catch{return'f_'+Math.random().toString(36).slice(2,8)}}

window.fetch=async function(...a){
  const r=await F.apply(this,a);
  try{
    const u=typeof a[0]==='string'?a[0]:a[0].url,c=r.clone(),t=c.headers.get('content-type')||'';
    if(t.includes('json')||u.includes('/api/')){
      const j=await c.json();
      D.api[N(u)+'.json']={url:u,method:a[1]?.method||'GET',status:r.status,data:j,ts:new Date().toISOString()};
      console.log('%c[CAP] API: '+u,'color:#4CAF50');
    }
  }catch{}
  return r;
};

XMLHttpRequest.prototype.open=function(m,u,...r){
  this._u=u;this._m=m;
  this.addEventListener('load',function(){
    try{
      const t=this.getResponseHeader('content-type')||'';
      if(t.includes('json')||this._u.includes('/api/')){
        D.api[N(this._u)+'.json']={url:this._u,method:this._m,status:this.status,data:JSON.parse(this.responseText),ts:new Date().toISOString()};
        console.log('%c[CAP] XHR: '+this._u,'color:#4CAF50');
      }
    }catch{}
  });
  return X.apply(this,[m,u,...r]);
};

async function cap(){
  const u=window.location.href,fn=N(u)+'.html';
  D.pages[fn]={url:u,title:document.title,content:document.documentElement.outerHTML,ts:new Date().toISOString()};
  console.log('%c[CAP] Page: '+fn,'color:#FF9800');

  for(const s of document.querySelectorAll('script[src]')){
    if(CS.has(s.src))continue;CS.add(s.src);
    try{const r=await F(s.src),t=await r.text();D.scripts[N(s.src)+'.js']={url:s.src,content:t};console.log('%c[CAP] JS: '+s.src.split('/').pop(),'color:#2196F3');}catch{}
  }

  document.querySelectorAll('script:not([src])').forEach((s,i)=>{
    if(s.textContent.length>100)D.scripts['inline_'+N(u)+'_'+i+'.js']={url:u+'#inline-'+i,content:s.textContent,inline:true};
  });

  for(const l of document.querySelectorAll('link[rel="stylesheet"]')){
    if(CY.has(l.href))continue;CY.add(l.href);
    try{const r=await F(l.href),t=await r.text();D.styles[N(l.href)+'.css']={url:l.href,content:t};console.log('%c[CAP] CSS: '+l.href.split('/').pop(),'color:#9C27B0');}catch{}
  }

  document.querySelectorAll('style').forEach((s,i)=>{
    if(s.textContent.length>50)D.styles['inline_'+N(u)+'_'+i+'.css']={url:u+'#style-'+i,content:s.textContent,inline:true};
  });
}

let last=location.href;
new MutationObserver(()=>{if(location.href!==last){last=location.href;setTimeout(cap,1000);}}).observe(document,{subtree:true,childList:true});
window.addEventListener('popstate',()=>setTimeout(cap,1000));
setTimeout(cap,500);

window.capture={
  status(){console.log(`Pages:${Object.keys(D.pages).length} Scripts:${Object.keys(D.scripts).length} Styles:${Object.keys(D.styles).length} API:${Object.keys(D.api).length}`);},
  save(){
    const b=new Blob([JSON.stringify({site:location.origin,ts:new Date().toISOString(),data:D},null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='capture-'+Date.now()+'.json';a.click();
    console.log('%c[CAP] Downloaded!','color:#4CAF50;font-weight:bold');
  },
  snap(){cap();},
  data:D
};

console.log('%câ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—','color:#4CAF50');
console.log('%câ•‘  ğŸ”´ AUTO-CAPTURE ACTIVE                â•‘','color:#4CAF50');
console.log('%câ•‘  Browse normally - all captured!       â•‘','color:#4CAF50');
console.log('%câ•‘  When done: capture.save()             â•‘','color:#4CAF50');
console.log('%câ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','color:#4CAF50');
})();
