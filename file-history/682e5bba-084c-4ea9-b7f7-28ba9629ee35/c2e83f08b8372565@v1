/**
 * PERSISTENT AUTO-CAPTURE
 *
 * Data stored in localStorage - survives page navigations!
 *
 * SETUP: Create a bookmark with this as the URL (bookmarklet)
 * Then just click the bookmark on any page to activate/reactivate
 */
javascript:(function(){if(window.__CAPTURE_ACTIVE__){console.log('%câš¡ Capture already running!','color:#FF9800;font-weight:bold');return}window.__CAPTURE_ACTIVE__=true;const STORAGE_KEY='__SITE_CAPTURE__';let DATA;try{DATA=JSON.parse(localStorage.getItem(STORAGE_KEY))||{pages:{},scripts:{},styles:{},api:{},started:new Date().toISOString()}}catch{DATA={pages:{},scripts:{},styles:{},api:{},started:new Date().toISOString()}}const save=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(DATA));const origFetch=window.fetch;const origXHR=XMLHttpRequest.prototype.open;const capturedScripts=new Set(Object.values(DATA.scripts).map(s=>s.url));const capturedStyles=new Set(Object.values(DATA.styles).map(s=>s.url));function safeName(url){try{const u=new URL(url);let name=u.pathname.replace(/^\//,'').replace(/\//g,'_')||'index';if(u.search)name+='_'+u.search.slice(1).replace(/[=&]/g,'-').replace(/[^a-zA-Z0-9_-]/g,'');return name.slice(0,120)}catch{return'f_'+Math.random().toString(36).slice(2,8)}}function uniqueName(base,ext,col){let name=base+ext;let i=1;while(col[name]){name=base+'_'+i+ext;i++}return name}window.fetch=async function(...args){const response=await origFetch.apply(this,args);try{const url=typeof args[0]==='string'?args[0]:args[0]?.url;if(!url)return response;const clone=response.clone();const ct=clone.headers.get('content-type')||'';if(ct.includes('application/json')||url.includes('/api/')){const json=await clone.json();const fn=uniqueName(safeName(url),'.json',DATA.api);DATA.api[fn]={url,method:args[1]?.method||'GET',status:response.status,data:json,ts:new Date().toISOString()};save();console.log('%câœ“ API: '+url.split('?')[0],'color:#4CAF50;font-weight:bold')}}catch{}return response};XMLHttpRequest.prototype.open=function(method,url,...rest){this._url=url;this._method=method;this.addEventListener('load',function(){try{const ct=this.getResponseHeader('content-type')||'';if(ct.includes('application/json')||this._url.includes('/api/')){const json=JSON.parse(this.responseText);const fn=uniqueName(safeName(this._url),'.json',DATA.api);DATA.api[fn]={url:this._url,method:this._method,status:this.status,data:json,ts:new Date().toISOString()};save();console.log('%câœ“ XHR: '+this._url.split('?')[0],'color:#4CAF50;font-weight:bold')}}catch{}});return origXHR.apply(this,[method,url,...rest])};async function capturePage(){const url=window.location.href;const pageKey=uniqueName(safeName(url),'.html',DATA.pages);DATA.pages[pageKey]={url,title:document.title,content:document.documentElement.outerHTML,ts:new Date().toISOString()};console.log('%câœ“ PAGE: '+document.title,'color:#FF9800;font-weight:bold');for(const script of document.querySelectorAll('script[src]')){const src=script.src;if(capturedScripts.has(src))continue;capturedScripts.add(src);try{const resp=await origFetch(src);const text=await resp.text();const fn=uniqueName(safeName(src),'.js',DATA.scripts);DATA.scripts[fn]={url:src,content:text,size:text.length};console.log('%câœ“ JS: '+src.split('/').pop().slice(0,40),'color:#2196F3')}catch{}}document.querySelectorAll('script:not([src])').forEach((s,i)=>{if(s.textContent.trim().length>100){const fn=uniqueName('inline_'+safeName(url)+'_'+i,'.js',DATA.scripts);DATA.scripts[fn]={url:url+'#inline-'+i,content:s.textContent,size:s.textContent.length,inline:true}}});for(const link of document.querySelectorAll('link[rel="stylesheet"]')){const href=link.href;if(capturedStyles.has(href))continue;capturedStyles.add(href);try{const resp=await origFetch(href);const text=await resp.text();const fn=uniqueName(safeName(href),'.css',DATA.styles);DATA.styles[fn]={url:href,content:text,size:text.length};console.log('%câœ“ CSS: '+href.split('/').pop().slice(0,40),'color:#9C27B0')}catch{}}document.querySelectorAll('style').forEach((s,i)=>{if(s.textContent.trim().length>50){const fn=uniqueName('inline_style_'+i,'.css',DATA.styles);DATA.styles[fn]={url:url+'#style-'+i,content:s.textContent,size:s.textContent.length,inline:true}}});save();status()}function status(){const p=Object.keys(DATA.pages).length;const s=Object.keys(DATA.scripts).length;const c=Object.keys(DATA.styles).length;const a=Object.keys(DATA.api).length;console.log(`%cğŸ“Š Total: ${p} pages, ${s} scripts, ${c} styles, ${a} API calls`,'color:#00BCD4;font-weight:bold')}window.done=function(){console.log('%c\\nğŸ FINISHING CAPTURE...','color:#4CAF50;font-weight:bold;font-size:16px');status();const bundle={site:window.location.origin,capturedAt:DATA.started,finishedAt:new Date().toISOString(),stats:{pages:Object.keys(DATA.pages).length,scripts:Object.keys(DATA.scripts).length,styles:Object.keys(DATA.styles).length,api:Object.keys(DATA.api).length},data:DATA};const blob=new Blob([JSON.stringify(bundle,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='faceiq-capture-'+Date.now()+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);console.log('%c\\nâœ… DOWNLOAD COMPLETE!','color:#4CAF50;font-weight:bold;font-size:16px');console.log('%cTell Claude: "Process the capture"','color:#FF9800;font-size:14px');localStorage.removeItem(STORAGE_KEY);window.__CAPTURE_ACTIVE__=false;return'âœ… Done!'};window.status=status;window.snap=capturePage;window.clearCapture=function(){localStorage.removeItem(STORAGE_KEY);DATA={pages:{},scripts:{},styles:{},api:{},started:new Date().toISOString()};console.log('%cğŸ—‘ï¸ Cleared!','color:#f44336')};let lastUrl=location.href;new MutationObserver(()=>{if(location.href!==lastUrl){lastUrl=location.href;console.log('%cğŸ”„ SPA Navigation...','color:#FFC107');setTimeout(capturePage,1500)}}).observe(document,{subtree:true,childList:true});window.addEventListener('popstate',()=>setTimeout(capturePage,1500));setTimeout(capturePage,500);console.clear();console.log('%câ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—','color:#4CAF50;font-size:14px');console.log('%câ•‘  ğŸ”´ CAPTURE ACTIVE - Data persists across pages!      â•‘','color:#4CAF50;font-size:14px');console.log('%câ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£','color:#4CAF50;font-size:14px');console.log('%câ•‘  âš¡ Click bookmark again after full page navigation   â•‘','color:#4CAF50;font-size:14px');console.log('%câ•‘                                                       â•‘','color:#4CAF50;font-size:14px');console.log('%câ•‘  Commands: status() | snap() | done()                â•‘','color:#4CAF50;font-size:14px');console.log('%câ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','color:#4CAF50;font-size:14px');status()})();
