/**
 * Browser Console Capture Script
 *
 * Paste this into the browser console while on the site.
 * It will capture HTML, CSS, JS, and API responses as you navigate.
 *
 * Commands:
 *   capture.start()     - Start capturing (run once)
 *   capture.snapshot()  - Capture current page state
 *   capture.download()  - Download all captured data as ZIP
 *   capture.status()    - Show what's been captured
 *   capture.clear()     - Clear all captured data
 */

window.capture = (function() {
  const data = {
    pages: {},
    scripts: {},
    styles: {},
    api: {},
    images: {},
    fonts: {},
    other: {}
  };

  let isCapturing = false;
  let originalFetch = null;
  let originalXHR = null;

  // Helper to generate safe filenames
  function safeFilename(url) {
    try {
      const u = new URL(url);
      let name = u.pathname.replace(/^\//, '').replace(/\//g, '_') || 'index';
      if (u.search) {
        name += '_' + u.search.slice(1).replace(/[=&]/g, '-').replace(/[^a-zA-Z0-9_-]/g, '');
      }
      return name.slice(0, 100);
    } catch {
      return 'file_' + Math.random().toString(36).slice(2, 10);
    }
  }

  // Intercept fetch requests
  function interceptFetch() {
    originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const response = await originalFetch.apply(this, args);

      try {
        const url = typeof args[0] === 'string' ? args[0] : args[0].url;
        const clone = response.clone();
        const contentType = clone.headers.get('content-type') || '';

        if (contentType.includes('application/json') || url.includes('/api/')) {
          const json = await clone.json();
          const filename = safeFilename(url) + '.json';
          data.api[filename] = {
            url,
            method: args[1]?.method || 'GET',
            status: response.status,
            data: json,
            timestamp: new Date().toISOString()
          };
          console.log(`%c[CAPTURE] API: ${url}`, 'color: #4CAF50');
        }
      } catch (e) {}

      return response;
    };
  }

  // Intercept XMLHttpRequest
  function interceptXHR() {
    originalXHR = window.XMLHttpRequest.prototype.open;
    window.XMLHttpRequest.prototype.open = function(method, url, ...rest) {
      this._captureUrl = url;
      this._captureMethod = method;

      this.addEventListener('load', function() {
        try {
          const contentType = this.getResponseHeader('content-type') || '';
          if (contentType.includes('application/json') || this._captureUrl.includes('/api/')) {
            const json = JSON.parse(this.responseText);
            const filename = safeFilename(this._captureUrl) + '.json';
            data.api[filename] = {
              url: this._captureUrl,
              method: this._captureMethod,
              status: this.status,
              data: json,
              timestamp: new Date().toISOString()
            };
            console.log(`%c[CAPTURE] XHR API: ${this._captureUrl}`, 'color: #4CAF50');
          }
        } catch (e) {}
      });

      return originalXHR.apply(this, [method, url, ...rest]);
    };
  }

  // Capture all scripts from the page
  async function captureScripts() {
    const scripts = document.querySelectorAll('script[src]');
    for (const script of scripts) {
      const url = script.src;
      if (data.scripts[url]) continue;

      try {
        const response = await originalFetch(url);
        const text = await response.text();
        const filename = safeFilename(url) + '.js';
        data.scripts[filename] = {
          url,
          content: text,
          size: text.length
        };
        console.log(`%c[CAPTURE] Script: ${filename}`, 'color: #2196F3');
      } catch (e) {
        console.warn(`Failed to capture script: ${url}`);
      }
    }

    // Also capture inline scripts
    const inlineScripts = document.querySelectorAll('script:not([src])');
    let inlineCount = 0;
    for (const script of inlineScripts) {
      if (script.textContent.trim().length > 50) {
        const filename = `inline_script_${inlineCount++}.js`;
        data.scripts[filename] = {
          url: window.location.href + '#inline-' + inlineCount,
          content: script.textContent,
          size: script.textContent.length,
          inline: true
        };
      }
    }
  }

  // Capture all stylesheets
  async function captureStyles() {
    const links = document.querySelectorAll('link[rel="stylesheet"]');
    for (const link of links) {
      const url = link.href;
      if (data.styles[url]) continue;

      try {
        const response = await originalFetch(url);
        const text = await response.text();
        const filename = safeFilename(url) + '.css';
        data.styles[filename] = {
          url,
          content: text,
          size: text.length
        };
        console.log(`%c[CAPTURE] Style: ${filename}`, 'color: #9C27B0');
      } catch (e) {
        console.warn(`Failed to capture style: ${url}`);
      }
    }

    // Capture inline styles
    const inlineStyles = document.querySelectorAll('style');
    let inlineCount = 0;
    for (const style of inlineStyles) {
      if (style.textContent.trim().length > 50) {
        const filename = `inline_style_${inlineCount++}.css`;
        data.styles[filename] = {
          url: window.location.href + '#inline-' + inlineCount,
          content: style.textContent,
          size: style.textContent.length,
          inline: true
        };
      }
    }
  }

  // Capture current page HTML
  function captureHTML() {
    const url = window.location.href;
    const filename = safeFilename(url) + '.html';
    const html = document.documentElement.outerHTML;

    data.pages[filename] = {
      url,
      title: document.title,
      content: html,
      size: html.length,
      timestamp: new Date().toISOString()
    };

    console.log(`%c[CAPTURE] Page: ${filename}`, 'color: #FF9800');
    return filename;
  }

  // Download everything as a JSON bundle
  function downloadJSON() {
    const bundle = {
      capturedAt: new Date().toISOString(),
      site: window.location.origin,
      data
    };

    const blob = new Blob([JSON.stringify(bundle, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `site-capture-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);

    console.log('%c[CAPTURE] Downloaded capture bundle!', 'color: #4CAF50; font-weight: bold');
  }

  // Show status
  function showStatus() {
    console.log('%c=== Capture Status ===', 'color: #FF9800; font-weight: bold; font-size: 14px');
    console.log(`Pages: ${Object.keys(data.pages).length}`);
    console.log(`Scripts: ${Object.keys(data.scripts).length}`);
    console.log(`Styles: ${Object.keys(data.styles).length}`);
    console.log(`API Responses: ${Object.keys(data.api).length}`);
    console.log('');

    if (Object.keys(data.pages).length > 0) {
      console.log('%cPages:', 'font-weight: bold');
      Object.keys(data.pages).forEach(f => console.log(`  - ${f}`));
    }
    if (Object.keys(data.api).length > 0) {
      console.log('%cAPI Endpoints:', 'font-weight: bold');
      Object.keys(data.api).forEach(f => console.log(`  - ${f}`));
    }
  }

  return {
    start() {
      if (isCapturing) {
        console.log('%c[CAPTURE] Already running!', 'color: #FF9800');
        return;
      }

      interceptFetch();
      interceptXHR();
      isCapturing = true;

      console.log('%c[CAPTURE] Started! API requests will be captured automatically.', 'color: #4CAF50; font-weight: bold');
      console.log('%cCommands:', 'font-weight: bold');
      console.log('  capture.snapshot() - Capture current page');
      console.log('  capture.download() - Download all data');
      console.log('  capture.status()   - Show captured items');
    },

    async snapshot() {
      if (!isCapturing) {
        console.log('%c[CAPTURE] Call capture.start() first!', 'color: #f44336');
        return;
      }

      console.log('%c[CAPTURE] Taking snapshot...', 'color: #2196F3');

      captureHTML();
      await captureScripts();
      await captureStyles();

      console.log('%c[CAPTURE] Snapshot complete!', 'color: #4CAF50; font-weight: bold');
      showStatus();
    },

    download() {
      downloadJSON();
    },

    status() {
      showStatus();
    },

    clear() {
      data.pages = {};
      data.scripts = {};
      data.styles = {};
      data.api = {};
      data.images = {};
      data.fonts = {};
      data.other = {};
      console.log('%c[CAPTURE] Cleared all data', 'color: #FF9800');
    },

    // Get raw data (for debugging)
    getData() {
      return data;
    }
  };
})();

// Auto-start
capture.start();

console.log('%c╔═══════════════════════════════════════════╗', 'color: #4CAF50');
console.log('%c║     Browser Capture Script Loaded!        ║', 'color: #4CAF50');
console.log('%c╠═══════════════════════════════════════════╣', 'color: #4CAF50');
console.log('%c║  capture.snapshot() - Capture this page   ║', 'color: #4CAF50');
console.log('%c║  capture.download() - Download all data   ║', 'color: #4CAF50');
console.log('%c║  capture.status()   - Show status         ║', 'color: #4CAF50');
console.log('%c╚═══════════════════════════════════════════╝', 'color: #4CAF50');
