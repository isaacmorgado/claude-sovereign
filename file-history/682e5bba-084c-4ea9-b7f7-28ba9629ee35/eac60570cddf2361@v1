/**
 * CONNECTED AUTO-CAPTURE
 *
 * Paste this in browser console. Browse all pages you want.
 * When finished, type: done()
 *
 * The JSON file will download to your Downloads folder.
 * Then drag it into the terminal window or tell Claude you're done.
 */
(function(){
  // Use sessionStorage to persist across SPA navigations
  const STORAGE_KEY = 'SITE_CAPTURE_DATA';

  // Initialize or load existing data
  let DATA;
  try {
    DATA = JSON.parse(sessionStorage.getItem(STORAGE_KEY)) || {pages:{},scripts:{},styles:{},api:{},started:new Date().toISOString()};
  } catch {
    DATA = {pages:{},scripts:{},styles:{},api:{},started:new Date().toISOString()};
  }

  const save = () => sessionStorage.setItem(STORAGE_KEY, JSON.stringify(DATA));

  // Original functions
  const origFetch = window._origFetch || window.fetch;
  const origXHR = window._origXHR || XMLHttpRequest.prototype.open;
  window._origFetch = origFetch;
  window._origXHR = origXHR;

  // Track what's captured
  const capturedScripts = new Set(Object.values(DATA.scripts).map(s => s.url));
  const capturedStyles = new Set(Object.values(DATA.styles).map(s => s.url));

  // Safe filename generator
  function safeName(url) {
    try {
      const u = new URL(url);
      let name = u.pathname.replace(/^\//, '').replace(/\//g, '_') || 'index';
      if (u.search) {
        name += '_' + u.search.slice(1).replace(/[=&]/g, '-').replace(/[^a-zA-Z0-9_-]/g, '');
      }
      return name.slice(0, 120);
    } catch {
      return 'file_' + Math.random().toString(36).slice(2, 10);
    }
  }

  // Unique filename
  function uniqueName(base, ext, collection) {
    let name = base + ext;
    let i = 1;
    while (collection[name]) {
      name = base + '_' + i + ext;
      i++;
    }
    return name;
  }

  // Intercept fetch for API calls
  window.fetch = async function(...args) {
    const response = await origFetch.apply(this, args);
    try {
      const url = typeof args[0] === 'string' ? args[0] : args[0]?.url;
      if (!url) return response;

      const clone = response.clone();
      const contentType = clone.headers.get('content-type') || '';

      if (contentType.includes('application/json') || url.includes('/api/')) {
        const json = await clone.json();
        const filename = uniqueName(safeName(url), '.json', DATA.api);
        DATA.api[filename] = {
          url: url,
          method: args[1]?.method || 'GET',
          status: response.status,
          data: json,
          timestamp: new Date().toISOString()
        };
        save();
        console.log('%câœ“ API: ' + url.split('?')[0], 'color:#4CAF50;font-weight:bold');
      }
    } catch (e) {}
    return response;
  };

  // Intercept XHR for API calls
  XMLHttpRequest.prototype.open = function(method, url, ...rest) {
    this._captureUrl = url;
    this._captureMethod = method;

    this.addEventListener('load', function() {
      try {
        const contentType = this.getResponseHeader('content-type') || '';
        if (contentType.includes('application/json') || this._captureUrl.includes('/api/')) {
          const json = JSON.parse(this.responseText);
          const filename = uniqueName(safeName(this._captureUrl), '.json', DATA.api);
          DATA.api[filename] = {
            url: this._captureUrl,
            method: this._captureMethod,
            status: this.status,
            data: json,
            timestamp: new Date().toISOString()
          };
          save();
          console.log('%câœ“ XHR: ' + this._captureUrl.split('?')[0], 'color:#4CAF50;font-weight:bold');
        }
      } catch (e) {}
    });

    return origXHR.apply(this, [method, url, ...rest]);
  };

  // Capture current page fully
  async function capturePage() {
    const url = window.location.href;
    const pageKey = uniqueName(safeName(url), '.html', DATA.pages);

    // Capture HTML
    DATA.pages[pageKey] = {
      url: url,
      title: document.title,
      content: document.documentElement.outerHTML,
      timestamp: new Date().toISOString()
    };
    console.log('%câœ“ PAGE: ' + document.title, 'color:#FF9800;font-weight:bold');

    // Capture external scripts
    const scripts = document.querySelectorAll('script[src]');
    for (const script of scripts) {
      const src = script.src;
      if (capturedScripts.has(src)) continue;
      capturedScripts.add(src);

      try {
        const resp = await origFetch(src);
        const text = await resp.text();
        const filename = uniqueName(safeName(src), '.js', DATA.scripts);
        DATA.scripts[filename] = {
          url: src,
          content: text,
          size: text.length
        };
        console.log('%câœ“ JS: ' + src.split('/').pop().slice(0, 50), 'color:#2196F3');
      } catch (e) {
        console.warn('Could not fetch:', src);
      }
    }

    // Capture inline scripts
    const inlineScripts = document.querySelectorAll('script:not([src])');
    inlineScripts.forEach((script, idx) => {
      if (script.textContent.trim().length > 100) {
        const filename = uniqueName('inline_' + safeName(url) + '_' + idx, '.js', DATA.scripts);
        DATA.scripts[filename] = {
          url: url + '#inline-script-' + idx,
          content: script.textContent,
          size: script.textContent.length,
          inline: true
        };
      }
    });

    // Capture external stylesheets
    const links = document.querySelectorAll('link[rel="stylesheet"]');
    for (const link of links) {
      const href = link.href;
      if (capturedStyles.has(href)) continue;
      capturedStyles.add(href);

      try {
        const resp = await origFetch(href);
        const text = await resp.text();
        const filename = uniqueName(safeName(href), '.css', DATA.styles);
        DATA.styles[filename] = {
          url: href,
          content: text,
          size: text.length
        };
        console.log('%câœ“ CSS: ' + href.split('/').pop().slice(0, 50), 'color:#9C27B0');
      } catch (e) {
        console.warn('Could not fetch:', href);
      }
    }

    // Capture inline styles
    const inlineStyles = document.querySelectorAll('style');
    inlineStyles.forEach((style, idx) => {
      if (style.textContent.trim().length > 50) {
        const filename = uniqueName('inline_' + safeName(url) + '_' + idx, '.css', DATA.styles);
        DATA.styles[filename] = {
          url: url + '#inline-style-' + idx,
          content: style.textContent,
          size: style.textContent.length,
          inline: true
        };
      }
    });

    save();
    printStatus();
  }

  // Print current status
  function printStatus() {
    const p = Object.keys(DATA.pages).length;
    const s = Object.keys(DATA.scripts).length;
    const c = Object.keys(DATA.styles).length;
    const a = Object.keys(DATA.api).length;
    console.log(`%cğŸ“Š Captured: ${p} pages, ${s} scripts, ${c} styles, ${a} API calls`, 'color:#00BCD4;font-weight:bold');
  }

  // Auto-capture on URL change (SPA navigation)
  let lastUrl = location.href;
  const observer = new MutationObserver(() => {
    if (location.href !== lastUrl) {
      lastUrl = location.href;
      console.log('%cğŸ”„ Navigation detected...', 'color:#FFC107');
      setTimeout(capturePage, 1500); // Wait for page to render
    }
  });
  observer.observe(document, { subtree: true, childList: true });

  // Also capture on popstate (back/forward)
  window.addEventListener('popstate', () => {
    console.log('%cğŸ”„ History navigation...', 'color:#FFC107');
    setTimeout(capturePage, 1500);
  });

  // Download function
  function downloadCapture() {
    const bundle = {
      site: window.location.origin,
      capturedAt: DATA.started,
      finishedAt: new Date().toISOString(),
      stats: {
        pages: Object.keys(DATA.pages).length,
        scripts: Object.keys(DATA.scripts).length,
        styles: Object.keys(DATA.styles).length,
        api: Object.keys(DATA.api).length
      },
      data: DATA
    };

    const blob = new Blob([JSON.stringify(bundle, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'faceiq-capture-' + Date.now() + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    return a.download;
  }

  // DONE command - finish and download
  window.done = function() {
    console.log('%c\nğŸ FINISHING CAPTURE...', 'color:#4CAF50;font-weight:bold;font-size:16px');
    printStatus();

    const filename = downloadCapture();

    console.log('%c\nâœ… DOWNLOAD COMPLETE!', 'color:#4CAF50;font-weight:bold;font-size:16px');
    console.log('%c\nFile saved: ' + filename, 'color:#2196F3;font-size:14px');
    console.log('%c\nNow go back to Claude and say:', 'color:#FF9800;font-size:14px');
    console.log('%c"Process the capture"', 'color:#fff;background:#333;padding:5px 10px;font-size:14px');

    // Clear session storage
    sessionStorage.removeItem(STORAGE_KEY);

    return 'âœ… Capture complete! Tell Claude to process it.';
  };

  // Manual snapshot command
  window.snap = capturePage;

  // Status command
  window.status = function() {
    printStatus();
    console.log('\nPages:', Object.keys(DATA.pages));
    console.log('API Endpoints:', Object.keys(DATA.api));
  };

  // Clear command
  window.clearCapture = function() {
    sessionStorage.removeItem(STORAGE_KEY);
    DATA.pages = {};
    DATA.scripts = {};
    DATA.styles = {};
    DATA.api = {};
    console.log('%cğŸ—‘ï¸ Capture cleared', 'color:#f44336');
  };

  // Capture initial page
  setTimeout(capturePage, 500);

  // Welcome message
  console.clear();
  console.log('%câ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'color:#4CAF50;font-size:14px');
  console.log('%câ•‘         ğŸ”´ AUTO-CAPTURE RUNNING                  â•‘', 'color:#4CAF50;font-size:14px');
  console.log('%câ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'color:#4CAF50;font-size:14px');
  console.log('%câ•‘  Browse all pages you want to capture.           â•‘', 'color:#4CAF50;font-size:14px');
  console.log('%câ•‘  HTML, JS, CSS & API calls captured auto.        â•‘', 'color:#4CAF50;font-size:14px');
  console.log('%câ•‘                                                  â•‘', 'color:#4CAF50;font-size:14px');
  console.log('%câ•‘  Commands:                                       â•‘', 'color:#4CAF50;font-size:14px');
  console.log('%câ•‘    status()  - Show what\'s captured              â•‘', 'color:#4CAF50;font-size:14px');
  console.log('%câ•‘    snap()    - Manually capture current page     â•‘', 'color:#4CAF50;font-size:14px');
  console.log('%câ•‘    done()    - Finish & download                 â•‘', 'color:#4CAF50;font-size:14px');
  console.log('%câ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color:#4CAF50;font-size:14px');
  console.log('');
})();
