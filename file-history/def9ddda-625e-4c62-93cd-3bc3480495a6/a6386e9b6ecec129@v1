#!/usr/bin/env node
// Simple, reliable patch for clauded model picker
const fs = require('fs');
const path = require('path');

const CLI_PATH = path.join(process.env.HOME, '.claude/clauded-cli/cli.js');
const BACKUP_PATH = CLI_PATH + '.backup-simple-' + Date.now();

console.log('Applying simple model picker patch...\n');

let content = fs.readFileSync(CLI_PATH, 'utf8');
fs.writeFileSync(BACKUP_PATH, content);
console.log(`✓ Backup: ${BACKUP_PATH}`);

// Find RU3 function
const ru3Match = content.match(/function RU3\(\)\{[^}]*\}/);
if (!ru3Match) {
  console.error('✗ Could not find RU3()');
  process.exit(1);
}

const originalRU3 = ru3Match[0];

// Simple patched version - just check env var and return models if available
const patchedRU3 = `function RU3(){
  // Check if proxy models are available via environment variable
  if(process.env.ANTHROPIC_BASE_URL && process.env.ANTHROPIC_BASE_URL.includes('127.0.0.1:3000')){
    try{
      const http=require('http');
      let data='';
      const req=http.get('http://127.0.0.1:3000/v1/models',{timeout:2000},(res)=>{
        res.on('data',d=>data+=d);
        res.on('end',()=>{
          try{
            const j=JSON.parse(data);
            if(j.data){
              global.__PROXY_MODELS=j.data.map(m=>({value:m.id,label:m.display_name||m.name,description:''}));
            }
          }catch(e){}
        });
      });
      req.on('error',()=>{});
      req.on('timeout',()=>req.destroy());

      // Wait briefly for response
      const start=Date.now();
      while(!global.__PROXY_MODELS&&Date.now()-start<2500){}

      if(global.__PROXY_MODELS&&global.__PROXY_MODELS.length>0){
        return global.__PROXY_MODELS;
      }
    }catch(e){}
  }

  // Original RU3 code as fallback
  ${originalRU3.replace('function RU3(){', '')}`;

content = content.replace(originalRU3, patchedRU3);
fs.writeFileSync(CLI_PATH, content);

console.log('✓ Patch applied');
console.log('\nTest with:');
console.log('  ANTHROPIC_BASE_URL=http://127.0.0.1:3000 clauded');
