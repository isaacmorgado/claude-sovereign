#!/usr/bin/env node
/**
 * Debug wrapper for clauded-cli to trace RU3() execution
 * This will show us EXACTLY why proxy models aren't being returned
 */

const fs = require('fs');
const path = require('path');

// Set environment variable
process.env.ANTHROPIC_BASE_URL = 'http://127.0.0.1:3000';

console.error('\n=== CLAUDED DEBUG MODE ===');
console.error('ANTHROPIC_BASE_URL:', process.env.ANTHROPIC_BASE_URL);
console.error('');

// Intercept global.__CLAUDED_PROXY_MODELS
let modelsSet = false;
Object.defineProperty(global, '__CLAUDED_PROXY_MODELS', {
  set: function(value) {
    console.error('[DEBUG] âœ“ Models being SET in global');
    console.error('[DEBUG]   Count:', value.length);
    console.error('[DEBUG]   First model:', value[0]?.label);
    modelsSet = true;
    this._CLAUDED_PROXY_MODELS = value;
  },
  get: function() {
    console.error('[DEBUG] Models being READ from global');
    console.error('[DEBUG]   Value:', this._CLAUDED_PROXY_MODELS ? this._CLAUDED_PROXY_MODELS.length + ' models' : 'undefined');
    return this._CLAUDED_PROXY_MODELS;
  },
  configurable: true
});

console.error('[DEBUG] Loading CLI file...');
const CLI_PATH = path.join(process.env.HOME, '.claude/clauded-cli/cli.js');

// Load and patch the CLI to add debug logging to RU3
let cliContent = fs.readFileSync(CLI_PATH, 'utf8');

// Find RU3 function and add logging
const originalRU3Start = cliContent.indexOf('function RU3(){');
if (originalRU3Start !== -1) {
  // Insert logging right after function RU3(){
  const insertPoint = originalRU3Start + 'function RU3(){'.length;
  const debugLog = `
  console.error('[RU3 DEBUG] Function called');
  console.error('[RU3 DEBUG] global.__CLAUDED_PROXY_MODELS exists?', typeof global.__CLAUDED_PROXY_MODELS);
  console.error('[RU3 DEBUG] Length:', global.__CLAUDED_PROXY_MODELS?.length);
  console.error('[RU3 DEBUG] Condition check:', global.__CLAUDED_PROXY_MODELS && global.__CLAUDED_PROXY_MODELS.length>0);
  `;

  cliContent = cliContent.slice(0, insertPoint) + debugLog + cliContent.slice(insertPoint);

  // Write to temp file
  const tempCLI = '/tmp/clauded-cli-debug.js';
  fs.writeFileSync(tempCLI, cliContent);
  console.error('[DEBUG] Created instrumented CLI at:', tempCLI);
  console.error('');

  // Load the instrumented version
  require(tempCLI);
} else {
  console.error('[DEBUG] ERROR: Could not find RU3 function!');
  process.exit(1);
}

// Check if models were set during load
setTimeout(() => {
  console.error('');
  console.error('[DEBUG] === POST-LOAD CHECK ===');
  console.error('[DEBUG] Models were set during load?', modelsSet);
  console.error('[DEBUG] global.__CLAUDED_PROXY_MODELS:', global.__CLAUDED_PROXY_MODELS?.length || 'undefined');
  console.error('[DEBUG] ======================');
  console.error('');
}, 500);
