/**
 * Security Test: Input Validation
 *
 * Tests that input validation is properly implemented
 * to prevent type confusion and DoS attacks.
 */

const fs = require('fs');
const path = require('path');

// Test counters
let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    passed++;
    console.log(`  ✓ ${name}`);
  } catch (error) {
    failed++;
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
  }
}

function assertIncludes(source, pattern, message) {
  if (!source.includes(pattern)) {
    throw new Error(message || `Expected source to include: ${pattern}`);
  }
}

function assertEqual(actual, expected, message) {
  if (actual !== expected) {
    throw new Error(message || `Expected ${expected}, got ${actual}`);
  }
}

function assertTrue(value, message) {
  if (!value) {
    throw new Error(message || 'Expected true');
  }
}

function assertFalse(value, message) {
  if (value) {
    throw new Error(message || 'Expected false');
  }
}

// Read source files
const serverPath = path.join(__dirname, '../server.js');
const serverSource = fs.readFileSync(serverPath, 'utf8');

const inputValidationPath = path.join(__dirname, '../middleware/inputValidation.js');
const inputValidationSource = fs.readFileSync(inputValidationPath, 'utf8');

console.log('\n╔═══════════════════════════════════════════════════════════════════╗');
console.log('║         SPLICE Security Test: Input Validation                    ║');
console.log('╚═══════════════════════════════════════════════════════════════════╝\n');

console.log('1. JSON Body Limit');
console.log('─'.repeat(50));

test('server should set JSON body size limit', () => {
  assertIncludes(serverSource, "express.json({ limit:", 'Should set JSON limit');
  assertIncludes(serverSource, "SECURITY:", 'Should have security comment');
});

test('JSON body limit should be 10mb', () => {
  assertIncludes(serverSource, "limit: '10mb'", 'Should set 10mb limit');
});

console.log('\n2. Input Validation Module');
console.log('─'.repeat(50));

test('should export validateString function', () => {
  assertIncludes(inputValidationSource, 'function validateString', 'Should have validateString');
  assertIncludes(inputValidationSource, 'validateString,', 'Should export validateString');
});

test('should export validateNumber function', () => {
  assertIncludes(inputValidationSource, 'function validateNumber', 'Should have validateNumber');
  assertIncludes(inputValidationSource, 'validateNumber,', 'Should export validateNumber');
});

test('should export validateBoolean function', () => {
  assertIncludes(inputValidationSource, 'function validateBoolean', 'Should have validateBoolean');
  assertIncludes(inputValidationSource, 'validateBoolean,', 'Should export validateBoolean');
});

test('should export validateArray function', () => {
  assertIncludes(inputValidationSource, 'function validateArray', 'Should have validateArray');
  assertIncludes(inputValidationSource, 'validateArray,', 'Should export validateArray');
});

test('should export createValidator function', () => {
  assertIncludes(inputValidationSource, 'function createValidator', 'Should have createValidator');
  assertIncludes(inputValidationSource, 'createValidator,', 'Should export createValidator');
});

console.log('\n3. Validation Functions Tests');
console.log('─'.repeat(50));

const {
  validateString,
  validateNumber,
  validateBoolean,
  validateArray,
  validateEnum
} = require('../middleware/inputValidation');

// String validation tests
test('validateString should accept valid strings', () => {
  const result = validateString('hello', 'test');
  assertTrue(result.valid, 'Should be valid');
  assertEqual(result.value, 'hello', 'Should return trimmed value');
});

test('validateString should reject null', () => {
  const result = validateString(null, 'test');
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'required', 'Should mention required');
});

test('validateString should reject non-strings', () => {
  const result = validateString(123, 'test');
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'must be a string', 'Should mention type');
});

test('validateString should reject empty strings', () => {
  const result = validateString('', 'test');
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'cannot be empty', 'Should mention empty');
});

test('validateString should enforce maxLength', () => {
  const result = validateString('a'.repeat(100), 'test', { maxLength: 50 });
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'exceeds maximum', 'Should mention length');
});

// Number validation tests
test('validateNumber should accept valid numbers', () => {
  const result = validateNumber(42, 'test');
  assertTrue(result.valid, 'Should be valid');
  assertEqual(result.value, 42, 'Should return number');
});

test('validateNumber should parse string numbers', () => {
  const result = validateNumber('42.5', 'test');
  assertTrue(result.valid, 'Should be valid');
  assertEqual(result.value, 42.5, 'Should parse string to number');
});

test('validateNumber should reject NaN', () => {
  const result = validateNumber('not a number', 'test');
  assertFalse(result.valid, 'Should be invalid');
});

test('validateNumber should enforce min/max', () => {
  const result = validateNumber(150, 'test', { min: 0, max: 100 });
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'must be between', 'Should mention range');
});

test('validateNumber should reject negative when not allowed', () => {
  const result = validateNumber(-5, 'test', { allowNegative: false });
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'cannot be negative', 'Should mention negative');
});

// Boolean validation tests
test('validateBoolean should accept true/false', () => {
  assertTrue(validateBoolean(true, 'test').valid);
  assertTrue(validateBoolean(false, 'test').valid);
});

test('validateBoolean should parse string booleans', () => {
  assertEqual(validateBoolean('true', 'test').value, true);
  assertEqual(validateBoolean('false', 'test').value, false);
  assertEqual(validateBoolean('1', 'test').value, true);
  assertEqual(validateBoolean('0', 'test').value, false);
});

test('validateBoolean should default to false for null/undefined', () => {
  assertEqual(validateBoolean(null, 'test').value, false);
  assertEqual(validateBoolean(undefined, 'test').value, false);
});

// Array validation tests
test('validateArray should accept valid arrays', () => {
  const result = validateArray([1, 2, 3], 'test');
  assertTrue(result.valid, 'Should be valid');
  assertEqual(result.value.length, 3, 'Should return array');
});

test('validateArray should reject non-arrays', () => {
  const result = validateArray('not array', 'test');
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'must be an array', 'Should mention type');
});

test('validateArray should enforce maxItems', () => {
  const result = validateArray([1, 2, 3, 4, 5], 'test', { maxItems: 3 });
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'exceeds maximum', 'Should mention max');
});

test('validateArray should enforce minItems', () => {
  const result = validateArray([], 'test', { minItems: 1 });
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'at least', 'Should mention min');
});

// Enum validation tests
test('validateEnum should accept valid values', () => {
  const result = validateEnum('podcast', 'preset', ['podcast', 'interview', 'vlog']);
  assertTrue(result.valid, 'Should be valid');
  assertEqual(result.value, 'podcast', 'Should return value');
});

test('validateEnum should reject invalid values', () => {
  const result = validateEnum('invalid', 'preset', ['podcast', 'interview', 'vlog']);
  assertFalse(result.valid, 'Should be invalid');
  assertIncludes(result.error, 'must be one of', 'Should list allowed values');
});

console.log('\n4. Validation Schemas');
console.log('─'.repeat(50));

test('should have validation schema for analyze endpoint', () => {
  assertIncludes(inputValidationSource, 'analyze:', 'Should have analyze schema');
  assertIncludes(inputValidationSource, 'wavPath:', 'Should validate wavPath');
});

test('should have validation schema for silences endpoint', () => {
  assertIncludes(inputValidationSource, 'silences:', 'Should have silences schema');
  assertIncludes(inputValidationSource, 'sensitivity:', 'Should validate sensitivity');
});

test('should have validation schema for cutList endpoint', () => {
  assertIncludes(inputValidationSource, 'cutList:', 'Should have cutList schema');
  assertIncludes(inputValidationSource, 'duration:', 'Should validate duration');
});

test('should have validation schema for music generation', () => {
  assertIncludes(inputValidationSource, 'musicGenerate:', 'Should have musicGenerate schema');
  assertIncludes(inputValidationSource, 'mood:', 'Should validate mood');
});

// Summary
console.log('\n' + '═'.repeat(55));
console.log(`Results: ${passed} passed, ${failed} failed`);
console.log('═'.repeat(55));

if (failed > 0) {
  console.log('\n❌ SECURITY TEST FAILED - Input validation issues exist!\n');
  process.exit(1);
} else {
  console.log('\n✅ SECURITY TEST PASSED - Input validation verified!\n');
  process.exit(0);
}
