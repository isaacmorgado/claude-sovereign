/**
 * Security Test: XSS Prevention in CEP Panel
 *
 * Tests that XSS vulnerabilities are properly mitigated
 * by using escapeHtml for all user-provided content in innerHTML.
 */

const fs = require('fs');
const path = require('path');

// Test counters
let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    passed++;
    console.log(`  ✓ ${name}`);
  } catch (error) {
    failed++;
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
  }
}

function assertIncludes(source, pattern, message) {
  if (!source.includes(pattern)) {
    throw new Error(message || `Expected source to include: ${pattern}`);
  }
}

// Read source files
const configPath = path.join(__dirname, '../panel/js/config.js');
const configSource = fs.readFileSync(configPath, 'utf8');

const mainPath = path.join(__dirname, '../panel/js/main.js');
const mainSource = fs.readFileSync(mainPath, 'utf8');

const textEditorPath = path.join(__dirname, '../panel/js/textEditor.js');
const textEditorSource = fs.readFileSync(textEditorPath, 'utf8');

const musicPath = path.join(__dirname, '../panel/js/music.js');
const musicSource = fs.readFileSync(musicPath, 'utf8');

const multitrackPath = path.join(__dirname, '../panel/js/multitrack.js');
const multitrackSource = fs.readFileSync(multitrackPath, 'utf8');

console.log('\n╔═══════════════════════════════════════════════════════════════════╗');
console.log('║         SPLICE Security Test: XSS Prevention (CEP Panel)         ║');
console.log('╚═══════════════════════════════════════════════════════════════════╝\n');

console.log('1. config.js Security Utilities');
console.log('─'.repeat(50));

test('should define escapeHtml function', () => {
  assertIncludes(configSource, 'function escapeHtml(str)', 'Should have escapeHtml function');
});

test('escapeHtml should handle null/undefined', () => {
  assertIncludes(configSource, "if (str === null || str === undefined)", 'Should handle null/undefined');
});

test('escapeHtml should escape all dangerous characters', () => {
  assertIncludes(configSource, "'&': '&amp;'", 'Should escape ampersand');
  assertIncludes(configSource, "'<': '&lt;'", 'Should escape less-than');
  assertIncludes(configSource, "'>': '&gt;'", 'Should escape greater-than');
  assertIncludes(configSource, "'\"': '&quot;'", 'Should escape double quote');
});

test('escapeHtml should be exported globally', () => {
  assertIncludes(configSource, 'window.escapeHtml = escapeHtml', 'Should export escapeHtml');
});

test('should define safeHtml template function', () => {
  assertIncludes(configSource, 'function safeHtml(strings, ...values)', 'Should have safeHtml function');
  assertIncludes(configSource, 'window.safeHtml = safeHtml', 'Should export safeHtml');
});

console.log('\n2. main.js XSS Prevention');
console.log('─'.repeat(50));

test('renderPreviewList should escape take labels', () => {
  assertIncludes(mainSource, "escapeHtml(take.label", 'Should escape take labels');
  assertIncludes(mainSource, 'SECURITY:', 'Should have security comment');
});

test('renderChapterList should escape chapter titles', () => {
  assertIncludes(mainSource, "escapeHtml(chapter.title)", 'Should escape chapter titles');
});

console.log('\n3. textEditor.js XSS Prevention');
console.log('─'.repeat(50));

test('renderPreview should escape change descriptions', () => {
  assertIncludes(textEditorSource, 'escapeHtml(change.description)', 'Should escape change descriptions');
  assertIncludes(textEditorSource, 'escapeHtml(change.type)', 'Should escape change types');
  assertIncludes(textEditorSource, 'escapeHtml(change.timeRange)', 'Should escape time ranges');
});

console.log('\n4. music.js XSS Prevention');
console.log('─'.repeat(50));

test('renderJobsList should escape job data', () => {
  assertIncludes(musicSource, 'escapeHtml(job.status)', 'Should escape job status');
  assertIncludes(musicSource, 'escapeHtml(job.mood', 'Should escape job mood');
  assertIncludes(musicSource, 'escapeHtml(job.jobId)', 'Should escape job ID');
});

test('loadMusicLibrary should escape library item data', () => {
  assertIncludes(musicSource, "escapeHtml(item.title", 'Should escape item titles');
  assertIncludes(musicSource, "escapeHtml(item.mood", 'Should escape item mood');
});

test('showTimelineResult should escape chapter data', () => {
  assertIncludes(musicSource, 'escapeHtml(ch.title)', 'Should escape chapter title');
  assertIncludes(musicSource, 'escapeHtml(ch.mood', 'Should escape chapter mood');
});

test('alignment info should escape beat analysis data', () => {
  assertIncludes(musicSource, 'escapeHtml(beatAnalysis.bpm', 'Should escape BPM');
  assertIncludes(musicSource, 'escapeHtml(beatAnalysis.beatCount)', 'Should escape beat count');
});

console.log('\n5. multitrack.js XSS Prevention');
console.log('─'.repeat(50));

test('addSpeaker should escape speaker names', () => {
  assertIncludes(multitrackSource, 'escapeHtml(defaultName)', 'Should escape speaker names');
});

test('decision list should escape speaker names and reasons', () => {
  assertIncludes(multitrackSource, 'escapeHtml(decision.speakerName)', 'Should escape speaker names');
  assertIncludes(multitrackSource, 'escapeHtml(decision.reason', 'Should escape decision reasons');
});

console.log('\n6. escapeHtml Function Tests');
console.log('─'.repeat(50));

// Test escapeHtml implementation by extracting and evaluating it
const escapeHtmlMatch = configSource.match(/function escapeHtml\(str\)\s*\{[\s\S]*?return str\.replace\([^)]+\);?\s*\}/);
if (escapeHtmlMatch) {
  // Create a test version of escapeHtml
  const escapeHtml = eval('(' + escapeHtmlMatch[0] + ')');

  test('escapeHtml should escape < character', () => {
    const result = escapeHtml('<script>');
    if (result.includes('<')) {
      throw new Error(`Should escape <: got ${result}`);
    }
  });

  test('escapeHtml should escape > character', () => {
    const result = escapeHtml('</script>');
    if (result.includes('>')) {
      throw new Error(`Should escape >: got ${result}`);
    }
  });

  test('escapeHtml should escape & character', () => {
    const result = escapeHtml('&test');
    if (result === '&test') {
      throw new Error('Should escape &');
    }
  });

  test('escapeHtml should escape quotes', () => {
    const result = escapeHtml('"test"');
    if (result.includes('"')) {
      throw new Error('Should escape double quotes');
    }
  });

  test('escapeHtml should handle XSS attack payloads', () => {
    const attacks = [
      '<script>alert("xss")</script>',
      '<img src=x onerror=alert(1)>',
      '"><script>alert(document.cookie)</script>',
      "javascript:alert('XSS')"
    ];

    for (const attack of attacks) {
      const result = escapeHtml(attack);
      if (result.includes('<') || result.includes('>') || result.includes('"')) {
        throw new Error(`Should escape attack: ${attack}`);
      }
    }
  });

  test('escapeHtml should handle null', () => {
    const result = escapeHtml(null);
    if (result !== '') {
      throw new Error(`Expected empty string for null, got: ${result}`);
    }
  });

  test('escapeHtml should handle undefined', () => {
    const result = escapeHtml(undefined);
    if (result !== '') {
      throw new Error(`Expected empty string for undefined, got: ${result}`);
    }
  });

  test('escapeHtml should convert numbers to strings', () => {
    const result = escapeHtml(123);
    if (result !== '123') {
      throw new Error(`Expected '123', got: ${result}`);
    }
  });
} else {
  console.log('  ⚠ Could not extract escapeHtml function for testing');
}

// Summary
console.log('\n' + '═'.repeat(55));
console.log(`Results: ${passed} passed, ${failed} failed`);
console.log('═'.repeat(55));

if (failed > 0) {
  console.log('\n❌ SECURITY TEST FAILED - XSS vulnerabilities may exist!\n');
  process.exit(1);
} else {
  console.log('\n✅ SECURITY TEST PASSED - XSS protections verified!\n');
  process.exit(0);
}
