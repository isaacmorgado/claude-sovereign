/**
 * FaceIQ-Parity Trigger Rules
 *
 * Comprehensive flawâ†’treatment mappings with calibrated metric impacts.
 * Based on FaceIQ's 43 trigger scenarios with our calibrated percentages.
 *
 * Key differences from FaceIQ:
 * - We use calibrated impact percentages (0.5-5%) instead of uniform 2%
 * - Primary impacts get higher percentages than secondary effects
 * - Impact direction is explicit (increase/decrease/normalize)
 */

// ============================================
// TYPES
// ============================================

export type ImpactDirection = 'increase' | 'decrease' | 'normalize';

export interface MetricImpact {
  direction: ImpactDirection;
  percentage: number;  // Calibrated: primary 2-5%, secondary 0.5-1.5%
  isPrimary?: boolean; // Primary target vs secondary effect
}

export interface FlawTrigger {
  flawId: string;
  flawName: string;
  description: string;
  // Metric conditions that indicate this flaw
  conditions: {
    metric: string;
    operator: '<' | '>' | 'between';
    value: number;
    valueMax?: number; // For 'between' operator
  }[];
  conditionLogic: 'AND' | 'OR';
}

export interface TreatmentTriggerRule {
  treatmentId: string;
  treatmentName: string;
  category: 'NST' | 'Surgical' | 'Lifestyle';
  // Flaws that trigger this treatment
  triggers: FlawTrigger[];
  // All metrics impacted by this treatment
  metricImpacts: Record<string, MetricImpact>;
}

// ============================================
// FLAW DEFINITIONS
// Maps text-based flaws to metric thresholds
// ============================================

export const FLAW_DEFINITIONS: Record<string, FlawTrigger> = {
  // ============================================
  // JAW FLAWS
  // ============================================
  'weak_jaw_structure': {
    flawId: 'weak_jaw_structure',
    flawName: 'Weak/soft jaw structure',
    description: 'Lack of defined mandibular border and gonial angle prominence',
    conditions: [
      { metric: 'Gonial Angle', operator: '>', value: 128 },
      { metric: 'Bigonial Width', operator: '<', value: 95 },
    ],
    conditionLogic: 'OR'
  },
  'narrow_jaw': {
    flawId: 'narrow_jaw',
    flawName: 'Narrow jaw',
    description: 'Bigonial width below ideal proportions',
    conditions: [
      { metric: 'Bigonial Width', operator: '<', value: 90 },
      { metric: 'Jaw Frontal Angle', operator: '<', value: 88 },
    ],
    conditionLogic: 'OR'
  },
  'flat_jaw': {
    flawId: 'flat_jaw',
    flawName: 'Flat jaw',
    description: 'Insufficient mandibular plane angulation',
    conditions: [
      { metric: 'Mandibular Plane Angle', operator: '<', value: 20 },
      { metric: 'Gonial Angle', operator: '>', value: 130 },
    ],
    conditionLogic: 'OR'
  },
  'undefined_jawline': {
    flawId: 'undefined_jawline',
    flawName: 'Undefined jawline',
    description: 'Lack of clear mandibular border definition',
    conditions: [
      { metric: 'Jaw Slope', operator: '>', value: 145 },
      { metric: 'Submental Cervical Angle', operator: '>', value: 125 },
    ],
    conditionLogic: 'OR'
  },
  'mandibular_recession': {
    flawId: 'mandibular_recession',
    flawName: 'Mandibular recession',
    description: 'Retrognathic mandible relative to facial profile',
    conditions: [
      { metric: 'Recession Relative to Frankfort Plane', operator: '>', value: 12 },
      { metric: 'Facial Convexity (Nasion)', operator: '<', value: 165 },
    ],
    conditionLogic: 'OR'
  },
  'convex_profile': {
    flawId: 'convex_profile',
    flawName: 'Rounder convex facial profile',
    description: 'Excessive facial convexity indicating mandibular deficiency',
    conditions: [
      { metric: 'Facial Convexity (Glabella)', operator: '<', value: 165 },
      { metric: 'Total Facial Convexity', operator: '<', value: 160 },
    ],
    conditionLogic: 'OR'
  },
  'underprojected_chin': {
    flawId: 'underprojected_chin',
    flawName: 'Underprojected chin',
    description: 'Insufficient chin projection relative to facial profile',
    conditions: [
      { metric: 'Chin to Philtrum Ratio', operator: '<', value: 1.6 },
      { metric: 'Recession Relative to Frankfort Plane', operator: '>', value: 15 },
    ],
    conditionLogic: 'OR'
  },
  'steep_jaw': {
    flawId: 'steep_jaw',
    flawName: 'Steep jaw',
    description: 'Excessive mandibular plane angle',
    conditions: [
      { metric: 'Mandibular Plane Angle', operator: '>', value: 32 },
      { metric: 'Gonial Angle', operator: '>', value: 135 },
    ],
    conditionLogic: 'OR'
  },
  'short_ramus': {
    flawId: 'short_ramus',
    flawName: 'Short ramus',
    description: 'Insufficient ramus height relative to mandible',
    conditions: [
      { metric: 'Ramus to Mandible Ratio', operator: '<', value: 0.5 },
      { metric: 'Gonion to Mouth Line', operator: '<', value: 35 },
    ],
    conditionLogic: 'OR'
  },
  'short_lower_third': {
    flawId: 'short_lower_third',
    flawName: 'Short lower third',
    description: 'Vertical deficiency in lower facial third',
    conditions: [
      { metric: 'Lower Third Proportion', operator: '<', value: 0.30 },
      { metric: 'Lower Third', operator: '<', value: 65 },
    ],
    conditionLogic: 'OR'
  },
  'disproportionate_lower_face_short': {
    flawId: 'disproportionate_lower_face_short',
    flawName: 'Disproportionate lower face (short chin or long philtrum)',
    description: 'Chin-philtrum imbalance with short chin',
    conditions: [
      { metric: 'Chin to Philtrum Ratio', operator: '<', value: 1.8 },
      { metric: 'Philtrum Length', operator: '>', value: 16 },
    ],
    conditionLogic: 'OR'
  },
  'disproportionate_lower_face_long': {
    flawId: 'disproportionate_lower_face_long',
    flawName: 'Disproportionate lower face (long chin or short philtrum)',
    description: 'Chin-philtrum imbalance with long chin',
    conditions: [
      { metric: 'Chin to Philtrum Ratio', operator: '>', value: 2.5 },
      { metric: 'Philtrum Length', operator: '<', value: 11 },
    ],
    conditionLogic: 'OR'
  },

  // ============================================
  // NECK/SUBMENTAL FLAWS
  // ============================================
  'double_chin': {
    flawId: 'double_chin',
    flawName: 'Double chin',
    description: 'Excess submental fat creating double chin appearance',
    conditions: [
      { metric: 'Submental Cervical Angle', operator: '>', value: 130 },
    ],
    conditionLogic: 'OR'
  },
  'high_submental_fat': {
    flawId: 'high_submental_fat',
    flawName: 'High submental fat',
    description: 'Excessive fat deposits in submental region',
    conditions: [
      { metric: 'Submental Cervical Angle', operator: '>', value: 125 },
      { metric: 'Neck Width', operator: '>', value: 95 },
    ],
    conditionLogic: 'OR'
  },
  'round_neck': {
    flawId: 'round_neck',
    flawName: 'Round neck region',
    description: 'Lack of cervicomental definition',
    conditions: [
      { metric: 'Submental Cervical Angle', operator: '>', value: 135 },
      { metric: 'Neck Width', operator: '>', value: 100 },
    ],
    conditionLogic: 'OR'
  },

  // ============================================
  // CHEEKBONE FLAWS
  // ============================================
  'flat_small_cheekbones': {
    flawId: 'flat_small_cheekbones',
    flawName: 'Flat & small cheekbones',
    description: 'Insufficient zygomatic prominence and projection',
    conditions: [
      { metric: 'Cheekbone Height', operator: '<', value: 60 },
      { metric: 'Face Width to Height Ratio', operator: '<', value: 1.75 },
    ],
    conditionLogic: 'OR'
  },
  'lacking_ogee': {
    flawId: 'lacking_ogee',
    flawName: 'Lacking Ogee curve',
    description: 'Insufficient cheek-to-midface S-curve transition',
    conditions: [
      { metric: 'Cheekbone Height', operator: '<', value: 65 },
      { metric: 'Midface Ratio', operator: '>', value: 1.05 },
    ],
    conditionLogic: 'AND'
  },
  'low_set_cheekbones': {
    flawId: 'low_set_cheekbones',
    flawName: 'Low-set cheekbones',
    description: 'Zygomatic arch positioned below ideal height',
    conditions: [
      { metric: 'Cheekbone Height', operator: '<', value: 55 },
    ],
    conditionLogic: 'OR'
  },
  'medium_set_cheekbones': {
    flawId: 'medium_set_cheekbones',
    flawName: 'Medium-set cheekbones',
    description: 'Zygomatic arch at average height, could benefit from enhancement',
    conditions: [
      { metric: 'Cheekbone Height', operator: 'between', value: 55, valueMax: 65 },
    ],
    conditionLogic: 'OR'
  },
  'long_face': {
    flawId: 'long_face',
    flawName: 'Overly long face shape',
    description: 'Excessive vertical facial length relative to width',
    conditions: [
      { metric: 'Total Facial Width to Height Ratio', operator: '<', value: 1.25 },
      { metric: 'Face Width to Height Ratio', operator: '<', value: 1.6 },
    ],
    conditionLogic: 'OR'
  },
  'long_midface': {
    flawId: 'long_midface',
    flawName: 'Long midface',
    description: 'Excessive vertical distance from eyes to mouth',
    conditions: [
      { metric: 'Midface Ratio', operator: '>', value: 1.1 },
    ],
    conditionLogic: 'OR'
  },
  'wide_set_eyes': {
    flawId: 'wide_set_eyes',
    flawName: 'Wide-set eyes',
    description: 'Excessive intercanthal distance',
    conditions: [
      { metric: 'Eye Separation Ratio', operator: '>', value: 0.35 },
    ],
    conditionLogic: 'OR'
  },

  // ============================================
  // LIP FLAWS
  // ============================================
  'thin_upper_lip': {
    flawId: 'thin_upper_lip',
    flawName: 'Thin upper lip',
    description: 'Insufficient upper lip vermilion height',
    conditions: [
      { metric: 'Upper Lip Vermilion Height', operator: '<', value: 7 },
      { metric: 'Lower Lip to Upper Lip Ratio', operator: '>', value: 1.8 },
    ],
    conditionLogic: 'OR'
  },
  'thin_lower_lip': {
    flawId: 'thin_lower_lip',
    flawName: 'Thin lower lip',
    description: 'Insufficient lower lip vermilion height',
    conditions: [
      { metric: 'Lower Lip to Upper Lip Ratio', operator: '<', value: 1.2 },
    ],
    conditionLogic: 'OR'
  },
  'lacking_cupids_bow': {
    flawId: 'lacking_cupids_bow',
    flawName: "Lacking cupid's bow",
    description: 'Insufficient definition in upper lip philtral columns',
    conditions: [
      { metric: "Cupid's Bow Depth", operator: '<', value: 2 },
    ],
    conditionLogic: 'OR'
  },
  'retruded_upper_lip': {
    flawId: 'retruded_upper_lip',
    flawName: 'Overly retruded upper lip',
    description: 'Upper lip positioned too far posterior',
    conditions: [
      { metric: 'Upper Lip E-Line Position', operator: '>', value: 2 },
      { metric: 'Upper Lip S-Line Position', operator: '>', value: 3 },
    ],
    conditionLogic: 'OR'
  },
  'retruded_lower_lip': {
    flawId: 'retruded_lower_lip',
    flawName: 'Overly retruded lower lip',
    description: 'Lower lip positioned too far posterior',
    conditions: [
      { metric: 'Lower Lip E-Line Position', operator: '>', value: 1 },
      { metric: 'Lower Lip S-Line Position', operator: '>', value: 2 },
    ],
    conditionLogic: 'OR'
  },
  'mouth_asymmetry': {
    flawId: 'mouth_asymmetry',
    flawName: 'Mouth asymmetry',
    description: 'Asymmetric lip shape or position',
    conditions: [
      { metric: 'Mouth Symmetry', operator: '<', value: 0.92 },
    ],
    conditionLogic: 'OR'
  },

  // ============================================
  // NOSE FLAWS
  // ============================================
  'overprojected_nose': {
    flawId: 'overprojected_nose',
    flawName: 'Overprojected nose',
    description: 'Excessive nasal projection from facial plane',
    conditions: [
      { metric: 'Nasal Projection', operator: '>', value: 0.75 },
    ],
    conditionLogic: 'OR'
  },
  'wide_nose': {
    flawId: 'wide_nose',
    flawName: 'Wide nose',
    description: 'Excessive alar base width',
    conditions: [
      { metric: 'Nasal W to H Ratio', operator: '>', value: 0.85 },
      { metric: 'Nasal Index', operator: '>', value: 75 },
    ],
    conditionLogic: 'OR'
  },
  'acute_nasolabial': {
    flawId: 'acute_nasolabial',
    flawName: 'Acute nasolabial angle',
    description: 'Nasolabial angle below ideal range',
    conditions: [
      { metric: 'Nasolabial Angle', operator: '<', value: 90 },
    ],
    conditionLogic: 'OR'
  },

  // ============================================
  // EYE FLAWS
  // ============================================
  'negative_canthal_tilt': {
    flawId: 'negative_canthal_tilt',
    flawName: 'Negative canthal tilt',
    description: 'Lateral canthus below medial canthus level',
    conditions: [
      { metric: 'Lateral Canthal Tilt', operator: '<', value: 4 },
    ],
    conditionLogic: 'OR'
  },
  'small_eyes': {
    flawId: 'small_eyes',
    flawName: 'Small palpebral fissure',
    description: 'Insufficient eye opening height or width',
    conditions: [
      { metric: 'Eye Aspect Ratio', operator: '<', value: 2.8 },
    ],
    conditionLogic: 'OR'
  },
  'low_brows': {
    flawId: 'low_brows',
    flawName: 'Low-set brows',
    description: 'Eyebrows positioned below ideal height',
    conditions: [
      { metric: 'Eyebrow Low Setedness', operator: '>', value: 2 },
    ],
    conditionLogic: 'OR'
  },
  'flat_browridge': {
    flawId: 'flat_browridge',
    flawName: 'Flat browridge',
    description: 'Insufficient supraorbital rim projection',
    conditions: [
      { metric: 'Browridge Inclination Angle', operator: '<', value: 10 },
    ],
    conditionLogic: 'OR'
  },
};

// ============================================
// TREATMENT TRIGGER RULES
// Full FaceIQ parity with calibrated impacts
// ============================================

export const TREATMENT_TRIGGER_RULES: TreatmentTriggerRule[] = [
  // ============================================
  // JAW FILLERS (NST-05)
  // ============================================
  {
    treatmentId: 'jaw_fillers',
    treatmentName: 'Jaw Fillers',
    category: 'NST',
    triggers: [
      FLAW_DEFINITIONS['weak_jaw_structure'],
      FLAW_DEFINITIONS['narrow_jaw'],
      FLAW_DEFINITIONS['flat_jaw'],
      FLAW_DEFINITIONS['undefined_jawline'],
      FLAW_DEFINITIONS['mandibular_recession'],
      FLAW_DEFINITIONS['convex_profile'],
      FLAW_DEFINITIONS['underprojected_chin'],
      FLAW_DEFINITIONS['steep_jaw'],
      FLAW_DEFINITIONS['short_ramus'],
      FLAW_DEFINITIONS['short_lower_third'],
      FLAW_DEFINITIONS['disproportionate_lower_face_short'],
    ],
    metricImpacts: {
      // Primary impacts (2-4%)
      'Bigonial Width': { direction: 'increase', percentage: 2.5, isPrimary: true },
      'Ramus to Mandible Ratio': { direction: 'increase', percentage: 2, isPrimary: true },
      'Gonial Angle': { direction: 'decrease', percentage: 2, isPrimary: true },
      'Jaw Frontal Angle': { direction: 'normalize', percentage: 1.8, isPrimary: true },
      // Secondary impacts (0.5-1.5%)
      'Recession Relative to Frankfort Plane': { direction: 'increase', percentage: 1.5 },
      'Lower Third': { direction: 'increase', percentage: 1.2 },
      'Lower Third Proportion': { direction: 'increase', percentage: 1 },
      'Chin to Philtrum Ratio': { direction: 'increase', percentage: 1.2 },
      'Total Facial Width to Height Ratio': { direction: 'increase', percentage: 0.8 },
      'Facial Convexity (Glabella)': { direction: 'increase', percentage: 1 },
      'Facial Convexity (Nasion)': { direction: 'increase', percentage: 1 },
      'Total Facial Convexity': { direction: 'increase', percentage: 1 },
      'Nasofacial Angle': { direction: 'decrease', percentage: 0.8 },
      'Nasomental Angle': { direction: 'increase', percentage: 0.8 },
      'Mentolabial Angle': { direction: 'decrease', percentage: 0.8 },
      'Gonion to Mouth Line': { direction: 'increase', percentage: 1 },
      'Upper Lip S-Line Position': { direction: 'normalize', percentage: 0.6 },
      'Lower Lip S-Line Position': { direction: 'normalize', percentage: 0.6 },
      'Upper Lip E-Line Position': { direction: 'normalize', percentage: 0.6 },
      'Lower Lip E-Line Position': { direction: 'normalize', percentage: 0.6 },
      'Upper Lip Burstone Line': { direction: 'normalize', percentage: 0.5 },
      'Lower Lip Burstone Line': { direction: 'normalize', percentage: 0.5 },
      'Holdaway H Line': { direction: 'normalize', percentage: 0.5 },
      'Jaw Slope': { direction: 'decrease', percentage: 1.2 },
      'Neck Width': { direction: 'decrease', percentage: 0.5 },
    }
  },

  // ============================================
  // KYBELLA (NST-01)
  // ============================================
  {
    treatmentId: 'kybella',
    treatmentName: 'Kybella (Double Chin Removal)',
    category: 'NST',
    triggers: [
      FLAW_DEFINITIONS['double_chin'],
      FLAW_DEFINITIONS['high_submental_fat'],
      FLAW_DEFINITIONS['undefined_jawline'],
    ],
    metricImpacts: {
      // Primary impacts
      'Submental Cervical Angle': { direction: 'decrease', percentage: 4, isPrimary: true },
      'Neck Width': { direction: 'decrease', percentage: 3, isPrimary: true },
      // Secondary impacts
      'Jaw Slope': { direction: 'decrease', percentage: 1 },
      'Gonion to Mouth Line': { direction: 'increase', percentage: 0.8 },
    }
  },

  // ============================================
  // CHEEKBONE FILLERS (NST-06)
  // ============================================
  {
    treatmentId: 'cheekbone_fillers',
    treatmentName: 'Cheekbone Fillers',
    category: 'NST',
    triggers: [
      FLAW_DEFINITIONS['flat_small_cheekbones'],
      FLAW_DEFINITIONS['lacking_ogee'],
      FLAW_DEFINITIONS['low_set_cheekbones'],
      FLAW_DEFINITIONS['medium_set_cheekbones'],
      FLAW_DEFINITIONS['long_face'],
      FLAW_DEFINITIONS['long_midface'],
      FLAW_DEFINITIONS['wide_set_eyes'],
    ],
    metricImpacts: {
      // Primary impacts
      'Cheekbone Height': { direction: 'increase', percentage: 3, isPrimary: true },
      'Face Width to Height Ratio': { direction: 'increase', percentage: 2.5, isPrimary: true },
      'Midface Ratio': { direction: 'decrease', percentage: 2, isPrimary: true },
      // Secondary impacts
      'Total Facial Width to Height Ratio': { direction: 'increase', percentage: 1.2 },
      'Bigonial Width': { direction: 'decrease', percentage: 0.8 },
      'Eye Separation Ratio': { direction: 'decrease', percentage: 0.8 },
      'Bitemporal Width': { direction: 'decrease', percentage: 0.6 },
    }
  },

  // ============================================
  // CRYOLIPOLYSIS (NST-04)
  // ============================================
  {
    treatmentId: 'cryolipolysis',
    treatmentName: 'Cryolipolysis (Fat Freezing)',
    category: 'NST',
    triggers: [
      FLAW_DEFINITIONS['double_chin'],
      FLAW_DEFINITIONS['high_submental_fat'],
      FLAW_DEFINITIONS['undefined_jawline'],
      FLAW_DEFINITIONS['round_neck'],
    ],
    metricImpacts: {
      // Primary impacts
      'Submental Cervical Angle': { direction: 'decrease', percentage: 3.5, isPrimary: true },
      'Neck Width': { direction: 'decrease', percentage: 2.5, isPrimary: true },
      // Secondary impacts
      'Jaw Slope': { direction: 'decrease', percentage: 0.8 },
    }
  },

  // ============================================
  // LIP FILLER (NST-08)
  // ============================================
  {
    treatmentId: 'lip_filler',
    treatmentName: 'Lip Filler',
    category: 'NST',
    triggers: [
      FLAW_DEFINITIONS['thin_upper_lip'],
      FLAW_DEFINITIONS['thin_lower_lip'],
      FLAW_DEFINITIONS['lacking_cupids_bow'],
      FLAW_DEFINITIONS['retruded_upper_lip'],
      FLAW_DEFINITIONS['retruded_lower_lip'],
      FLAW_DEFINITIONS['mouth_asymmetry'],
      FLAW_DEFINITIONS['disproportionate_lower_face_short'],
      FLAW_DEFINITIONS['disproportionate_lower_face_long'],
      FLAW_DEFINITIONS['long_midface'],
    ],
    metricImpacts: {
      // Primary impacts - Upper lip triggers
      'Lip Thickness': { direction: 'increase', percentage: 4, isPrimary: true },
      'Lower Lip to Upper Lip Ratio': { direction: 'normalize', percentage: 3, isPrimary: true },
      "Cupid's Bow Depth": { direction: 'increase', percentage: 3, isPrimary: true },
      // Primary impacts - Position
      'Upper Lip S-Line Position': { direction: 'decrease', percentage: 2.5, isPrimary: true },
      'Upper Lip E-Line Position': { direction: 'decrease', percentage: 2.5, isPrimary: true },
      'Lower Lip S-Line Position': { direction: 'decrease', percentage: 2, isPrimary: true },
      'Lower Lip E-Line Position': { direction: 'decrease', percentage: 2, isPrimary: true },
      // Secondary impacts
      'Upper Lip Burstone Line': { direction: 'decrease', percentage: 1.5 },
      'Lower Lip Burstone Line': { direction: 'decrease', percentage: 1.5 },
      'Holdaway H Line': { direction: 'normalize', percentage: 1.2 },
      'Nasolabial Angle': { direction: 'decrease', percentage: 1 },
      'Chin to Philtrum Ratio': { direction: 'increase', percentage: 1.2 },
      'Midface Ratio': { direction: 'decrease', percentage: 0.8 },
      'Facial Width to Height Ratio': { direction: 'increase', percentage: 0.6 },
      'Z Angle': { direction: 'decrease', percentage: 0.8 },
      'Mentolabial Angle': { direction: 'decrease', percentage: 0.8 },
    }
  },

  // ============================================
  // GENIOPLASTY (SUR-20)
  // ============================================
  {
    treatmentId: 'genioplasty',
    treatmentName: 'Sliding Genioplasty',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['underprojected_chin'],
      FLAW_DEFINITIONS['mandibular_recession'],
      FLAW_DEFINITIONS['convex_profile'],
      FLAW_DEFINITIONS['short_lower_third'],
      FLAW_DEFINITIONS['disproportionate_lower_face_short'],
    ],
    metricImpacts: {
      // Primary impacts
      'Chin to Philtrum Ratio': { direction: 'increase', percentage: 5, isPrimary: true },
      'Recession Relative to Frankfort Plane': { direction: 'decrease', percentage: 4.5, isPrimary: true },
      'Facial Convexity (Nasion)': { direction: 'increase', percentage: 3.5, isPrimary: true },
      // Secondary impacts
      'Facial Convexity (Glabella)': { direction: 'increase', percentage: 2 },
      'Total Facial Convexity': { direction: 'increase', percentage: 2 },
      'Lower Third': { direction: 'increase', percentage: 2.5 },
      'Lower Third Proportion': { direction: 'increase', percentage: 2 },
      'Nasofacial Angle': { direction: 'decrease', percentage: 1.5 },
      'Nasomental Angle': { direction: 'increase', percentage: 1.5 },
      'Mentolabial Angle': { direction: 'decrease', percentage: 1.5 },
      'Upper Lip E-Line Position': { direction: 'normalize', percentage: 1 },
      'Lower Lip E-Line Position': { direction: 'normalize', percentage: 1 },
      'Holdaway H Line': { direction: 'normalize', percentage: 1 },
      'Z Angle': { direction: 'increase', percentage: 1.2 },
    }
  },

  // ============================================
  // CHIN IMPLANT (SUR-07)
  // ============================================
  {
    treatmentId: 'chin_implant',
    treatmentName: 'Chin Implant',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['underprojected_chin'],
      FLAW_DEFINITIONS['mandibular_recession'],
      FLAW_DEFINITIONS['convex_profile'],
    ],
    metricImpacts: {
      // Primary impacts
      'Chin to Philtrum Ratio': { direction: 'increase', percentage: 4.5, isPrimary: true },
      'Recession Relative to Frankfort Plane': { direction: 'decrease', percentage: 4, isPrimary: true },
      'Facial Convexity (Nasion)': { direction: 'increase', percentage: 3, isPrimary: true },
      // Secondary impacts
      'Facial Convexity (Glabella)': { direction: 'increase', percentage: 1.8 },
      'Total Facial Convexity': { direction: 'increase', percentage: 1.8 },
      'Nasofacial Angle': { direction: 'decrease', percentage: 1.2 },
      'Nasomental Angle': { direction: 'increase', percentage: 1.2 },
      'Mentolabial Angle': { direction: 'decrease', percentage: 1.2 },
      'Holdaway H Line': { direction: 'normalize', percentage: 1 },
      'Z Angle': { direction: 'increase', percentage: 1 },
    }
  },

  // ============================================
  // JAW IMPLANTS (SUR-17)
  // ============================================
  {
    treatmentId: 'jaw_implants',
    treatmentName: 'Jaw Implants',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['weak_jaw_structure'],
      FLAW_DEFINITIONS['narrow_jaw'],
      FLAW_DEFINITIONS['flat_jaw'],
      FLAW_DEFINITIONS['short_ramus'],
    ],
    metricImpacts: {
      // Primary impacts
      'Bigonial Width': { direction: 'increase', percentage: 4, isPrimary: true },
      'Gonial Angle': { direction: 'decrease', percentage: 3.5, isPrimary: true },
      'Ramus to Mandible Ratio': { direction: 'increase', percentage: 3, isPrimary: true },
      'Jaw Frontal Angle': { direction: 'normalize', percentage: 2.5, isPrimary: true },
      // Secondary impacts
      'Mandibular Plane Angle': { direction: 'decrease', percentage: 2 },
      'Jaw Slope': { direction: 'decrease', percentage: 2 },
      'Face Width to Height Ratio': { direction: 'increase', percentage: 1.5 },
      'Total Facial Width to Height Ratio': { direction: 'increase', percentage: 1 },
      'Gonion to Mouth Line': { direction: 'increase', percentage: 1.5 },
    }
  },

  // ============================================
  // RHINOPLASTY (SUR-XX)
  // ============================================
  {
    treatmentId: 'rhinoplasty',
    treatmentName: 'Rhinoplasty',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['overprojected_nose'],
      FLAW_DEFINITIONS['wide_nose'],
      FLAW_DEFINITIONS['acute_nasolabial'],
    ],
    metricImpacts: {
      // Primary impacts
      'Nasal Projection': { direction: 'decrease', percentage: 4, isPrimary: true },
      'Nasal W to H Ratio': { direction: 'decrease', percentage: 3.5, isPrimary: true },
      'Nasolabial Angle': { direction: 'increase', percentage: 4, isPrimary: true },
      'Nasal Index': { direction: 'decrease', percentage: 3, isPrimary: true },
      // Secondary impacts
      'Nasofrontal Angle': { direction: 'normalize', percentage: 2 },
      'Nasofacial Angle': { direction: 'normalize', percentage: 1.5 },
      'Nasomental Angle': { direction: 'normalize', percentage: 1.2 },
    }
  },

  // ============================================
  // CANTHOPLASTY (SUR-25)
  // ============================================
  {
    treatmentId: 'canthoplasty',
    treatmentName: 'Canthoplasty',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['negative_canthal_tilt'],
      FLAW_DEFINITIONS['small_eyes'],
    ],
    metricImpacts: {
      // Primary impacts
      'Lateral Canthal Tilt': { direction: 'increase', percentage: 5, isPrimary: true },
      'Eye Aspect Ratio': { direction: 'increase', percentage: 3.5, isPrimary: true },
      // Secondary impacts
      'Palpebral Fissure Height': { direction: 'increase', percentage: 1.5 },
      'Eye Width': { direction: 'increase', percentage: 1 },
    }
  },

  // ============================================
  // BROW LIFT (SUR-XX)
  // ============================================
  {
    treatmentId: 'brow_lift',
    treatmentName: 'Brow Lift',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['low_brows'],
      FLAW_DEFINITIONS['flat_browridge'],
    ],
    metricImpacts: {
      // Primary impacts
      'Eyebrow Low Setedness': { direction: 'decrease', percentage: 4.5, isPrimary: true },
      'Browridge Inclination Angle': { direction: 'increase', percentage: 4, isPrimary: true },
      // Secondary impacts
      'Upper Eyelid Exposure': { direction: 'increase', percentage: 2 },
      'Brow Height': { direction: 'increase', percentage: 2 },
    }
  },

  // ============================================
  // MIDFACE IMPLANTS (SUR-06)
  // ============================================
  {
    treatmentId: 'midface_implants',
    treatmentName: 'Midface Implants',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['flat_small_cheekbones'],
      FLAW_DEFINITIONS['low_set_cheekbones'],
      FLAW_DEFINITIONS['long_midface'],
    ],
    metricImpacts: {
      // Primary impacts
      'Cheekbone Height': { direction: 'increase', percentage: 4, isPrimary: true },
      'Midface Ratio': { direction: 'decrease', percentage: 3.5, isPrimary: true },
      'Face Width to Height Ratio': { direction: 'increase', percentage: 3, isPrimary: true },
      // Secondary impacts
      'Total Facial Width to Height Ratio': { direction: 'increase', percentage: 1.5 },
      'Infraorbital Rim Projection': { direction: 'increase', percentage: 2 },
    }
  },

  // ============================================
  // LIP LIFT (SUR-29)
  // ============================================
  {
    treatmentId: 'lip_lift',
    treatmentName: 'Lip Lift',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['thin_upper_lip'],
      FLAW_DEFINITIONS['long_midface'],
      FLAW_DEFINITIONS['disproportionate_lower_face_short'],
    ],
    metricImpacts: {
      // Primary impacts
      'Philtrum Length': { direction: 'decrease', percentage: 4.5, isPrimary: true },
      'Upper Lip Vermilion Height': { direction: 'increase', percentage: 4, isPrimary: true },
      'Chin to Philtrum Ratio': { direction: 'increase', percentage: 3.5, isPrimary: true },
      // Secondary impacts
      'Midface Ratio': { direction: 'decrease', percentage: 2 },
      'Upper Lip S-Line Position': { direction: 'decrease', percentage: 1.5 },
      'Nasolabial Angle': { direction: 'decrease', percentage: 1 },
    }
  },

  // ============================================
  // NECK LIFT (SUR-21)
  // ============================================
  {
    treatmentId: 'neck_lift',
    treatmentName: 'Neck Lift',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['double_chin'],
      FLAW_DEFINITIONS['high_submental_fat'],
      FLAW_DEFINITIONS['round_neck'],
    ],
    metricImpacts: {
      // Primary impacts
      'Submental Cervical Angle': { direction: 'decrease', percentage: 5, isPrimary: true },
      'Neck Width': { direction: 'decrease', percentage: 4, isPrimary: true },
      // Secondary impacts
      'Jaw Slope': { direction: 'decrease', percentage: 1.5 },
      'Gonion to Mouth Line': { direction: 'increase', percentage: 1 },
    }
  },

  // ============================================
  // SUBMENTAL LIPOSUCTION (SUR-38)
  // ============================================
  {
    treatmentId: 'submental_liposuction',
    treatmentName: 'Submental Liposuction',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['double_chin'],
      FLAW_DEFINITIONS['high_submental_fat'],
      FLAW_DEFINITIONS['undefined_jawline'],
    ],
    metricImpacts: {
      // Primary impacts
      'Submental Cervical Angle': { direction: 'decrease', percentage: 4, isPrimary: true },
      'Neck Width': { direction: 'decrease', percentage: 3, isPrimary: true },
      // Secondary impacts
      'Jaw Slope': { direction: 'decrease', percentage: 1 },
    }
  },

  // ============================================
  // BIMAXILLARY OSTEOTOMY (SUR-13)
  // ============================================
  {
    treatmentId: 'bimaxillary_osteotomy',
    treatmentName: 'Bimaxillary Osteotomy',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['mandibular_recession'],
      FLAW_DEFINITIONS['convex_profile'],
      FLAW_DEFINITIONS['long_midface'],
    ],
    metricImpacts: {
      // Primary impacts
      'Facial Convexity (Nasion)': { direction: 'increase', percentage: 5, isPrimary: true },
      'Recession Relative to Frankfort Plane': { direction: 'decrease', percentage: 5, isPrimary: true },
      'Midface Ratio': { direction: 'decrease', percentage: 4, isPrimary: true },
      'Total Facial Convexity': { direction: 'increase', percentage: 4, isPrimary: true },
      // Secondary impacts
      'Facial Convexity (Glabella)': { direction: 'increase', percentage: 3 },
      'Chin to Philtrum Ratio': { direction: 'increase', percentage: 2.5 },
      'Lower Third': { direction: 'increase', percentage: 2 },
      'Nasofacial Angle': { direction: 'decrease', percentage: 2 },
      'Nasomental Angle': { direction: 'increase', percentage: 2 },
      'Upper Lip E-Line Position': { direction: 'normalize', percentage: 1.5 },
      'Lower Lip E-Line Position': { direction: 'normalize', percentage: 1.5 },
      'Holdaway H Line': { direction: 'normalize', percentage: 1.5 },
      'Z Angle': { direction: 'increase', percentage: 1.5 },
      'Mentolabial Angle': { direction: 'normalize', percentage: 1.2 },
    }
  },

  // ============================================
  // ALARPLASTY (SUR-XX)
  // ============================================
  {
    treatmentId: 'alarplasty',
    treatmentName: 'Alarplasty',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['wide_nose'],
    ],
    metricImpacts: {
      // Primary impacts
      'Nasal W to H Ratio': { direction: 'decrease', percentage: 4, isPrimary: true },
      'Nasal Index': { direction: 'decrease', percentage: 3.5, isPrimary: true },
      'Alar Base Width': { direction: 'decrease', percentage: 4, isPrimary: true },
    }
  },

  // ============================================
  // SUPRAORBITAL IMPLANTS (SUR-22)
  // ============================================
  {
    treatmentId: 'supraorbital_implants',
    treatmentName: 'Supraorbital Rim Implants',
    category: 'Surgical',
    triggers: [
      FLAW_DEFINITIONS['flat_browridge'],
    ],
    metricImpacts: {
      // Primary impacts
      'Browridge Inclination Angle': { direction: 'increase', percentage: 5, isPrimary: true },
      'Supraorbital Projection': { direction: 'increase', percentage: 4, isPrimary: true },
      // Secondary impacts
      'Upper Orbital Depth': { direction: 'increase', percentage: 2 },
    }
  },

  // ============================================
  // LIFESTYLE - WEIGHT LOSS
  // ============================================
  {
    treatmentId: 'weight_loss_protocol',
    treatmentName: 'Fat Loss Protocol',
    category: 'Lifestyle',
    triggers: [
      FLAW_DEFINITIONS['undefined_jawline'],
      FLAW_DEFINITIONS['flat_small_cheekbones'],
      FLAW_DEFINITIONS['high_submental_fat'],
    ],
    metricImpacts: {
      // Primary impacts
      'Cheekbone Height': { direction: 'increase', percentage: 3, isPrimary: true },
      'Jaw Slope': { direction: 'decrease', percentage: 2.5, isPrimary: true },
      'Submental Cervical Angle': { direction: 'decrease', percentage: 2, isPrimary: true },
      // Secondary impacts
      'Bigonial Width': { direction: 'increase', percentage: 1.5 },
      'Face Width to Height Ratio': { direction: 'increase', percentage: 1 },
      'Neck Width': { direction: 'decrease', percentage: 1.5 },
    }
  },

  // ============================================
  // LIFESTYLE - MEWING
  // ============================================
  {
    treatmentId: 'mewing_posture',
    treatmentName: 'Mewing & Posture Correction',
    category: 'Lifestyle',
    triggers: [
      FLAW_DEFINITIONS['long_midface'],
      FLAW_DEFINITIONS['acute_nasolabial'],
      FLAW_DEFINITIONS['weak_jaw_structure'],
    ],
    metricImpacts: {
      // Primary impacts (lower effectiveness)
      'Midface Ratio': { direction: 'decrease', percentage: 1.2, isPrimary: true },
      'Nasolabial Angle': { direction: 'increase', percentage: 1.5, isPrimary: true },
      // Secondary impacts
      'Gonial Angle': { direction: 'decrease', percentage: 0.8 },
      'Face Width to Height Ratio': { direction: 'increase', percentage: 0.5 },
      'Maxillary Projection': { direction: 'increase', percentage: 0.8 },
    }
  },

  // ============================================
  // LIFESTYLE - BEARD GROWTH
  // ============================================
  {
    treatmentId: 'beard_growth',
    treatmentName: 'Beard / Stubble Growth',
    category: 'Lifestyle',
    triggers: [
      FLAW_DEFINITIONS['weak_jaw_structure'],
      FLAW_DEFINITIONS['underprojected_chin'],
      FLAW_DEFINITIONS['narrow_jaw'],
    ],
    metricImpacts: {
      // Camouflage effects (perceived improvement)
      'Chin to Philtrum Ratio': { direction: 'increase', percentage: 2, isPrimary: true },
      'Gonial Angle': { direction: 'decrease', percentage: 1.5, isPrimary: true },
      // Secondary (visual illusion)
      'Bigonial Width': { direction: 'increase', percentage: 1 },
      'Jaw Slope': { direction: 'decrease', percentage: 1 },
    }
  },
];

// ============================================
// HELPER FUNCTIONS
// ============================================

/**
 * Get all triggers for a specific treatment
 */
export function getTreatmentTriggers(treatmentId: string): FlawTrigger[] {
  const rule = TREATMENT_TRIGGER_RULES.find(r => r.treatmentId === treatmentId);
  return rule?.triggers || [];
}

/**
 * Get all metric impacts for a specific treatment
 */
export function getTreatmentImpacts(treatmentId: string): Record<string, MetricImpact> {
  const rule = TREATMENT_TRIGGER_RULES.find(r => r.treatmentId === treatmentId);
  return rule?.metricImpacts || {};
}

/**
 * Get only primary impacts for a treatment
 */
export function getPrimaryImpacts(treatmentId: string): Record<string, MetricImpact> {
  const impacts = getTreatmentImpacts(treatmentId);
  return Object.fromEntries(
    Object.entries(impacts).filter(([, impact]) => impact.isPrimary)
  );
}

/**
 * Get treatments triggered by a specific flaw
 */
export function getTreatmentsForFlaw(flawId: string): TreatmentTriggerRule[] {
  return TREATMENT_TRIGGER_RULES.filter(rule =>
    rule.triggers.some(trigger => trigger.flawId === flawId)
  );
}

/**
 * Check if a flaw condition is met
 */
export function isFlawConditionMet(
  condition: FlawTrigger['conditions'][0],
  metricValue: number
): boolean {
  switch (condition.operator) {
    case '<':
      return metricValue < condition.value;
    case '>':
      return metricValue > condition.value;
    case 'between':
      return metricValue >= condition.value && metricValue <= (condition.valueMax || condition.value);
    default:
      return false;
  }
}

/**
 * Evaluate all flaws against user metrics
 */
export function evaluateFlaws(
  metricsDict: Record<string, number>
): { flawId: string; flaw: FlawTrigger; triggeredConditions: FlawTrigger['conditions'] }[] {
  const triggeredFlaws: { flawId: string; flaw: FlawTrigger; triggeredConditions: FlawTrigger['conditions'] }[] = [];

  for (const [flawId, flaw] of Object.entries(FLAW_DEFINITIONS)) {
    const triggeredConditions = flaw.conditions.filter(condition => {
      const metricValue = metricsDict[condition.metric];
      if (metricValue === undefined) return false;
      return isFlawConditionMet(condition, metricValue);
    });

    const isTriggered = flaw.conditionLogic === 'AND'
      ? triggeredConditions.length === flaw.conditions.length
      : triggeredConditions.length > 0;

    if (isTriggered) {
      triggeredFlaws.push({ flawId, flaw, triggeredConditions });
    }
  }

  return triggeredFlaws;
}

/**
 * Get recommended treatments based on detected flaws
 */
export function getRecommendedTreatments(
  metricsDict: Record<string, number>
): { treatment: TreatmentTriggerRule; matchedFlaws: FlawTrigger[] }[] {
  const flaws = evaluateFlaws(metricsDict);
  const flawIds = new Set(flaws.map(f => f.flawId));

  const recommendations: { treatment: TreatmentTriggerRule; matchedFlaws: FlawTrigger[] }[] = [];

  for (const rule of TREATMENT_TRIGGER_RULES) {
    const matchedFlaws = rule.triggers.filter(trigger => flawIds.has(trigger.flawId));
    if (matchedFlaws.length > 0) {
      recommendations.push({ treatment: rule, matchedFlaws });
    }
  }

  // Sort by number of matched flaws (most relevant first)
  return recommendations.sort((a, b) => b.matchedFlaws.length - a.matchedFlaws.length);
}

/**
 * Calculate estimated improvement for a metric after treatment
 */
export function calculateEstimatedImprovement(
  treatmentId: string,
  metricId: string,
  currentValue: number,
  idealValue: number
): { newValue: number; improvement: number } {
  const impacts = getTreatmentImpacts(treatmentId);
  const impact = impacts[metricId];

  if (!impact) {
    return { newValue: currentValue, improvement: 0 };
  }

  const percentageChange = impact.percentage / 100;
  let newValue: number;

  switch (impact.direction) {
    case 'increase':
      newValue = currentValue * (1 + percentageChange);
      break;
    case 'decrease':
      newValue = currentValue * (1 - percentageChange);
      break;
    case 'normalize':
      // Move towards ideal
      const diff = idealValue - currentValue;
      newValue = currentValue + (diff * percentageChange * 10); // Scale for normalize
      break;
    default:
      newValue = currentValue;
  }

  const improvement = Math.abs(newValue - currentValue);
  return { newValue, improvement };
}

// ============================================
// STATISTICS
// ============================================

export const TRIGGER_STATS = {
  totalFlaws: Object.keys(FLAW_DEFINITIONS).length,
  totalTreatments: TREATMENT_TRIGGER_RULES.length,
  totalTriggerMappings: TREATMENT_TRIGGER_RULES.reduce((sum, r) => sum + r.triggers.length, 0),
  avgImpactsPerTreatment: Math.round(
    TREATMENT_TRIGGER_RULES.reduce((sum, r) => sum + Object.keys(r.metricImpacts).length, 0) /
    TREATMENT_TRIGGER_RULES.length
  ),
};
