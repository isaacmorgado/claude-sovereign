/**
 * SPLICE Website E2E Tests - Checkout Flow
 * Tests for checkout page, API, and success page
 */

const fs = require("fs");
const path = require("path");

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (error) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
    failed++;
  }
}

function assert(condition, message) {
  if (!condition) {
    throw new Error(message || "Assertion failed");
  }
}

console.log("\n=== Checkout E2E Tests ===\n");

// ============================================
// Checkout Page Tests
// ============================================
console.log("Checkout Page:");

const checkoutPage = fs.readFileSync(
  path.join(__dirname, "..", "src", "app", "checkout", "page.tsx"),
  "utf8"
);

test("Has email input", () => {
  assert(checkoutPage.includes('type="email"'), "Missing email input");
  assert(checkoutPage.includes("email"), "Missing email field");
});

test("Has order summary", () => {
  assert(checkoutPage.includes("Order Summary"), "Missing order summary");
});

test("Shows plan details", () => {
  assert(checkoutPage.includes("plans"), "Missing plan details");
  assert(checkoutPage.includes("Starter"), "Missing Starter plan");
  assert(checkoutPage.includes("Pro"), "Missing Pro plan");
  assert(checkoutPage.includes("Team"), "Missing Team plan");
});

test("Has Start Free Trial button", () => {
  assert(checkoutPage.includes("Start Free Trial"), "Missing trial button");
});

test("Shows $0 due today for trial", () => {
  assert(checkoutPage.includes("$0.00"), "Missing $0 due today");
  assert(checkoutPage.includes("Due today"), "Missing due today label");
});

test("Has terms and privacy links", () => {
  assert(checkoutPage.includes("/terms"), "Missing terms link");
  assert(checkoutPage.includes("/privacy"), "Missing privacy link");
});

test("Has trust badges", () => {
  assert(checkoutPage.includes("SSL") || checkoutPage.includes("Secured"), "Missing SSL badge");
  assert(checkoutPage.includes("Stripe"), "Missing Stripe badge");
});

test("Has loading state", () => {
  assert(checkoutPage.includes("isLoading"), "Missing loading state");
  assert(checkoutPage.includes("Processing"), "Missing processing text");
});

test("Has error handling", () => {
  assert(checkoutPage.includes("error"), "Missing error state");
  assert(checkoutPage.includes("setError"), "Missing error setter");
});

test("Validates email format", () => {
  assert(
    checkoutPage.includes("@") && checkoutPage.includes("valid email"),
    "Missing email validation"
  );
});

// ============================================
// Checkout API Tests
// ============================================
console.log("\nCheckout API:");

const checkoutApi = fs.readFileSync(
  path.join(__dirname, "..", "src", "app", "api", "checkout", "route.ts"),
  "utf8"
);

test("API has POST handler", () => {
  assert(checkoutApi.includes("export async function POST"), "Missing POST handler");
});

test("API has GET handler for session retrieval", () => {
  assert(checkoutApi.includes("export async function GET"), "Missing GET handler");
});

test("API validates plan parameter", () => {
  assert(checkoutApi.includes("Invalid plan"), "Missing plan validation");
});

test("API creates Stripe checkout session", () => {
  assert(checkoutApi.includes("checkout.sessions.create"), "Missing session creation");
});

test("API sets trial period", () => {
  assert(checkoutApi.includes("trial_period_days"), "Missing trial period");
  assert(checkoutApi.includes("14"), "Trial should be 14 days");
});

test("API has success and cancel URLs", () => {
  assert(checkoutApi.includes("success_url"), "Missing success URL");
  assert(checkoutApi.includes("cancel_url"), "Missing cancel URL");
});

test("API allows promotion codes", () => {
  assert(checkoutApi.includes("allow_promotion_codes"), "Missing promotion codes");
});

test("API has proper error handling", () => {
  assert(checkoutApi.includes("catch"), "Missing error handling");
  assert(checkoutApi.includes("500"), "Missing 500 status");
});

// ============================================
// Success Page Tests
// ============================================
console.log("\nSuccess Page:");

const successPage = fs.readFileSync(
  path.join(__dirname, "..", "src", "app", "checkout", "success", "page.tsx"),
  "utf8"
);

test("Has welcome message", () => {
  assert(successPage.includes("Welcome"), "Missing welcome message");
});

test("Shows trial started confirmation", () => {
  assert(
    successPage.includes("trial has started") || successPage.includes("14-day"),
    "Missing trial confirmation"
  );
});

test("Has email confirmation section", () => {
  assert(successPage.includes("Check your email"), "Missing email section");
  assert(successPage.includes("license key"), "Missing license key mention");
});

test("Has download link", () => {
  assert(successPage.includes("/download"), "Missing download link");
  assert(successPage.includes("Download"), "Missing download button");
});

test("Has docs link", () => {
  assert(successPage.includes("/docs"), "Missing docs link");
});

test("Fetches session data", () => {
  assert(successPage.includes("session_id"), "Missing session ID parameter");
  assert(successPage.includes("/api/checkout"), "Missing API fetch");
});

test("Shows plan info", () => {
  assert(successPage.includes("plan"), "Missing plan display");
});

test("Has loading state", () => {
  assert(successPage.includes("isLoading"), "Missing loading state");
  assert(successPage.includes("Loader2"), "Missing loader component");
});

// ============================================
// Webhook API Tests
// ============================================
console.log("\nWebhook API:");

const webhookApi = fs.readFileSync(
  path.join(__dirname, "..", "src", "app", "api", "webhook", "route.ts"),
  "utf8"
);

test("Webhook has POST handler", () => {
  assert(webhookApi.includes("export async function POST"), "Missing POST handler");
});

test("Webhook verifies signature", () => {
  assert(webhookApi.includes("stripe-signature"), "Missing signature check");
  assert(webhookApi.includes("constructEvent"), "Missing event construction");
});

test("Webhook handles checkout.session.completed", () => {
  assert(webhookApi.includes("checkout.session.completed"), "Missing checkout event");
});

test("Webhook handles subscription events", () => {
  assert(webhookApi.includes("customer.subscription"), "Missing subscription events");
});

test("Webhook handles invoice events", () => {
  assert(webhookApi.includes("invoice.payment_succeeded"), "Missing invoice success");
  assert(webhookApi.includes("invoice.payment_failed"), "Missing invoice failure");
});

test("Webhook forwards to backend", () => {
  assert(webhookApi.includes("forwardToBackend"), "Missing backend forwarding");
  assert(webhookApi.includes("BACKEND_API_URL"), "Missing backend URL");
});

test("Webhook has proper error responses", () => {
  assert(webhookApi.includes("400"), "Missing 400 response");
  assert(webhookApi.includes("500"), "Missing 500 response");
});

// ============================================
// Results
// ============================================
console.log("\n========================================");
console.log(`Checkout Tests: ${passed} passed, ${failed} failed`);
console.log("========================================\n");

process.exit(failed > 0 ? 1 : 0);
