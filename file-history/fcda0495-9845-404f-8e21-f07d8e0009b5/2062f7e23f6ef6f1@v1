"""
Forum schemas for request/response validation
"""

from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import datetime
from uuid import UUID
from enum import Enum


# === ENUMS ===

class VoteType(str, Enum):
    UP = "up"
    DOWN = "down"


class TargetType(str, Enum):
    POST = "post"
    COMMENT = "comment"


class ReportReason(str, Enum):
    SPAM = "spam"
    HARASSMENT = "harassment"
    MISINFORMATION = "misinformation"
    OFF_TOPIC = "off_topic"
    INAPPROPRIATE = "inappropriate"
    OTHER = "other"


class SortOrder(str, Enum):
    HOT = "hot"  # vote_count DESC, recent bias
    NEW = "new"  # created_at DESC
    TOP = "top"  # vote_count DESC


# === SUB-FORUM SCHEMAS ===

class SubForumResponse(BaseModel):
    id: UUID
    name: str
    slug: str
    description: Optional[str]
    icon: Optional[str]
    display_order: int
    post_count: int = 0

    class Config:
        from_attributes = True


# === CATEGORY SCHEMAS ===

class CategoryResponse(BaseModel):
    id: UUID
    name: str
    slug: str
    description: Optional[str]
    icon: Optional[str]
    display_order: int
    post_count: int = 0
    sub_forums: List[SubForumResponse] = []

    class Config:
        from_attributes = True


class CategoryListResponse(BaseModel):
    id: UUID
    name: str
    slug: str
    description: Optional[str]
    icon: Optional[str]
    display_order: int
    post_count: int = 0

    class Config:
        from_attributes = True


# === POST SCHEMAS ===

class PostCreate(BaseModel):
    title: str = Field(..., min_length=5, max_length=200)
    content: str = Field(..., min_length=10, max_length=10000)
    sub_forum_id: UUID


class PostUpdate(BaseModel):
    title: Optional[str] = Field(None, min_length=5, max_length=200)
    content: Optional[str] = Field(None, min_length=10, max_length=10000)


class PostAuthor(BaseModel):
    id: UUID
    username: str

    class Config:
        from_attributes = True


class PostResponse(BaseModel):
    id: UUID
    title: str
    content: str
    sub_forum_id: UUID
    sub_forum_slug: str
    category_slug: str
    author: PostAuthor
    is_pinned: bool
    is_guide: bool
    vote_count: int
    comment_count: int
    user_vote: Optional[VoteType] = None  # Current user's vote
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True


class PostListItem(BaseModel):
    """Lighter version for list views"""
    id: UUID
    title: str
    content_preview: str  # First 200 chars
    sub_forum_slug: str
    category_slug: str
    author: PostAuthor
    is_pinned: bool
    is_guide: bool
    vote_count: int
    comment_count: int
    user_vote: Optional[VoteType] = None
    created_at: datetime

    class Config:
        from_attributes = True


class PostListResponse(BaseModel):
    posts: List[PostListItem]
    total_count: int
    has_more: bool


# === COMMENT SCHEMAS ===

class CommentCreate(BaseModel):
    content: str = Field(..., min_length=1, max_length=5000)
    parent_id: Optional[UUID] = None


class CommentUpdate(BaseModel):
    content: str = Field(..., min_length=1, max_length=5000)


class CommentResponse(BaseModel):
    id: UUID
    content: str
    post_id: UUID
    author: PostAuthor
    parent_id: Optional[UUID]
    vote_count: int
    user_vote: Optional[VoteType] = None
    depth: int
    replies: List["CommentResponse"] = []
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True


# Needed for self-referential model
CommentResponse.model_rebuild()


# === VOTE SCHEMAS ===

class VoteRequest(BaseModel):
    vote_type: VoteType


class VoteResponse(BaseModel):
    success: bool
    new_vote_count: int
    user_vote: Optional[VoteType]


# === REPORT SCHEMAS ===

class ReportCreate(BaseModel):
    target_type: TargetType
    target_id: UUID
    reason: ReportReason
    details: Optional[str] = Field(None, max_length=1000)


class ReportResponse(BaseModel):
    id: UUID
    target_type: TargetType
    target_id: UUID
    reason: ReportReason
    status: str
    created_at: datetime

    class Config:
        from_attributes = True


# === GUIDE SECTION ===

class GuideSectionResponse(BaseModel):
    """Guides grouped by category for the top section"""
    category: CategoryListResponse
    guides: List[PostListItem]


# === RECOMMENDED FORUMS ===

class RecommendedForumResponse(BaseModel):
    """Forums recommended based on user's detected flaws"""
    category: CategoryListResponse
    matched_flaws: List[str]  # Which flaws matched this category
    priority: int  # 1 = primary, 2 = secondary


class ArchetypeForumRecommendation(BaseModel):
    """Forums recommended based on user's archetype"""
    category: CategoryListResponse
    archetype: str  # The archetype that triggered this recommendation
    reason: Optional[str]  # Why this forum is relevant
    priority: int  # Higher = more relevant
