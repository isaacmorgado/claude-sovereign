# LOOKSMAXX

A facial metrics analysis and visualization system with Next.js frontend and MediaPipe-based facial landmark detection. Now with FaceIQ-compatible scoring and results UI.

## Live URLs

- **Frontend**: https://looksmaxx-app.vercel.app
- **API**: https://api-production-6148.up.railway.app

## Tech Stack

- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Animation**: Framer Motion
- **Face Detection**: MediaPipe Tasks Vision (client, 478 landmarks) + InsightFace (server, 106 landmarks)
- **Scoring**: FaceIQ-compatible exponential decay with 70+ measurements
- **Backend**: FastAPI on Railway with PostgreSQL
- **Email**: SendGrid for transactional emails
- **Frontend Hosting**: Vercel

## Code Quality

```bash
cd looksmaxx-app && npm run lint && npx tsc --noEmit
```

## Completed Features

### Username & T&C System (2025-12-23) ✅
Full implementation deployed and tested end-to-end:
- User registration with unique username (3-30 chars, alphanumeric + underscore)
- Terms & Conditions acceptance required for signup
- Leaderboard displays usernames instead of anonymous IDs
- Username availability check endpoint
- DB migrations applied on Railway

### FaceIQ Parity ✅ (Phase 1-5 Complete)
| Feature | File | Details |
|---------|------|---------|
| **All 66 Bezier Curves** | `looksmaxx-app/src/lib/faceiq-bezier-curves.ts` | Complete cubic Bezier interpolation |
| **Decay Rates Fixed** | `looksmaxx-app/src/lib/faceiq-scoring.ts` | 0.08-0.30 range (was 0.5-31.6) |
| **30 Procedure Impact Tables** | `looksmaxx-app/src/lib/advice-engine.ts` | Quantitative % changes per metric |
| **Treatment Metadata** | `looksmaxx-app/src/lib/advice-engine.ts` | priority_score, effectiveness, ratios_impacted, pillars |
| **Potential Score Prediction** | `looksmaxx-app/src/lib/recommendations/severity.ts` | `estimatePotentialPSL()` with diminishing returns |
| **Multi-Procedure Plans** | `looksmaxx-app/src/lib/recommendations/engine.ts` | `generateRecommendationPlan()` with 3-phase ordering |
| **Order of Operations** | `looksmaxx-app/src/lib/recommendations/engine.ts` | `generateOrderOfOperations()` with prerequisites |
| **16 Ethnicity Overrides** | `looksmaxx-app/src/lib/insights-engine.ts` | 8 male + 8 female with full scoring params |
| **5-Tier Severity** | `looksmaxx-app/src/lib/insights-engine.ts` | Z-score based (Ideal/Good/Fair/Moderate/Severe) |
| **Side Profile Depth Validation** | `looksmaxx-app/src/lib/mediapipeDetection.ts` | `validateSideProfileDepth()` validates 3D depth |
| **Before/After Preview** | `looksmaxx-app/src/components/results/visualization/BeforeAfterPreview.tsx` | Visual overlay showing improvements |
| **Treatment Timeline** | `looksmaxx-app/src/components/results/visualization/TreatmentTimeline.tsx` | Phase-based treatment sequencing UI |

### Female Analysis ✅
- 8 ethnicity overrides with distinct ideal ranges
- Sexual dimorphism (narrower jaws, softer angles, larger eyes)
- Female-specific treatments (V-line surgery, Masseter Botox)
- Gender filtering in recommendation engine

## Key Files

### Backend (`looksmaxx-api/`)
- `app/routers/auth.py` - Registration, login, password reset endpoints
- `app/routers/referrals.py` - Influencer referral code management
- `app/routers/leaderboard.py` - Leaderboard with usernames
- `app/routers/physique.py` - Physique upload, body analysis, face extraction
- `app/services/email.py` - SendGrid email service (password reset, welcome emails)
- `app/services/vision_service.py` - Claude Vision face + body analysis
- `app/models/user.py` - User model with username/terms fields
- `app/models/physique.py` - PhysiqueAnalysis + VisionExtraction models
- `app/schemas/user.py` - Validation schemas
- `migrations/006_add_physique_tables.sql` - Physique + vision tables

### Frontend (`looksmaxx-app/`)
- `src/app/signup/page.tsx` - Signup with username, T&C, referral code
- `src/app/terms/page.tsx` - Terms & Conditions page
- `src/app/login/page.tsx` - Email/password login
- `src/app/forgot-password/page.tsx` - Password reset request
- `src/app/reset-password/page.tsx` - Password reset form
- `src/app/analysis/page.tsx` - Face + physique analysis flow
- `src/lib/api.ts` - API client methods
- `src/app/forum/` - Community forum pages
- `src/components/forum/` - Forum components
- `src/contexts/ForumContext.tsx` - Forum state management
- `src/contexts/PhysiqueContext.tsx` - Physique photos + analysis state
- `src/types/forum.ts` - Forum TypeScript types

## PostgreSQL Access (Debug)

```bash
export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"
psql "postgresql://postgres:pCADzvPqsoWVWCozIwkjPybkTRUzwbZu@shortline.proxy.rlwy.net:10999/railway"
```

### Auth System (2025-12-23) ✅
- Email/password login (replaced Google OAuth)
- Forgot password flow with secure token
- SendGrid-powered password reset emails
- Password reset page with token validation
- Referral code field on signup with Stripe promotion code integration

### Referral System (2025-12-23) ✅
- Influencer referral codes stored in `referral_codes` table
- Linked to Stripe promotion codes for automatic discounts
- Validation endpoint for real-time code checking
- Usage tracking and analytics
- Admin endpoints for managing codes

### Infrastructure Fixes (2025-12-24) ✅
- Fixed Railway OOM crashes with lazy-loaded InsightFace model
- SendGrid integration for transactional emails

### Archetype Classification (2025-12-25) ✅
Full archetype classification system:

**Frontend**:
- Archetype data: `looksmaxx-app/src/data/archetypes.json` - 6 categories with sub-archetypes
- Classifier: `looksmaxx-app/src/lib/archetype-classifier.ts` - Scoring using gonialAngle, FWHR, canthalTilt
- Components: `looksmaxx-app/src/components/psl/archetype/` - ArchetypeCard, ArchetypeTraits
- Tab: `looksmaxx-app/src/components/results/tabs/ArchetypeTab.tsx` - Full archetype analysis page
- API methods: `looksmaxx-app/src/lib/api.ts` - classifyArchetype, getArchetypeDefinitions

**Backend**:
- Service: `looksmaxx-api/app/services/archetype_service.py` - Classification logic
- Router: `looksmaxx-api/app/routers/archetype.py` - POST /archetype/classify, GET /archetype/definitions

**Categories**: Softboy, Prettyboy, RobustPrettyboy, Chad, Hypermasculine (Warrior), Exotic

### Claude Vision Feature Extraction (2025-12-25) ✅
Full psl.md spec implementation with E2E tested face + body feature extraction:

**Backend:**
- `app/services/vision_service.py` - **NEW** Unified Claude Vision service
- `app/models/physique.py` - PhysiqueAnalysis + VisionExtraction models
- `app/routers/physique.py` - Photo upload, body analysis, face extraction endpoints
- `migrations/006_add_physique_tables.sql` - Database tables

**Face Features Extracted:**
| Category | Features |
|----------|----------|
| Skin | clarity (0-10), tone, acne_level, acne_scarring, pore_visibility, texture_issues |
| Hair | hairline_nw (0-7 Norwood), density, texture, color |
| Eyes | color, under_eye_darkness (0-10), under_eye_puffiness (0-10) |
| Facial | hollow_cheeks (0-10), eyebrow_density, facial_hair_potential |
| Teeth | color, alignment, visible |

**Body Features Extracted:**
- body_fat_percent (5-45%), muscle_mass, frame_size, shoulder_width, waist_definition, posture

**API Endpoints:**
- `POST /physique/upload` - Upload physique photos to S3
- `POST /physique/analyze` - Claude Vision body analysis
- `POST /physique/extract-face` - Claude Vision face feature extraction
- `GET /physique/my-analysis` - Get stored body analysis
- `GET /physique/my-face-features` - Get stored face extraction

**E2E Testing:** 11 bugs found and fixed (migration, type mismatches, memory leaks, persistence)

### Community Forum (2025-12-25) ✅
Full Reddit-style forum implementation:

**Backend (Phase 1)**:
- 7 database models: ForumIssueCategory, ForumSubForum, FlawToForumMapping, ForumPost, ForumComment, ForumVote, ForumReport
- 21 API endpoints in `app/routers/forum.py`
- 12 categories, 41 sub-forums, 17 flaw mappings seeded
- N+1 query optimization (54 queries → 2 queries)
- Live at: `https://api-production-6148.up.railway.app/forum/`

**Frontend (Phase 2)**:
- TypeScript types: `src/types/forum.ts`
- 16 API methods in `src/lib/api.ts`
- ForumContext: `src/contexts/ForumContext.tsx`
- Pages: `/forum`, `/forum/[categorySlug]`, `/forum/post/[postId]`
- Components: CategoryCard, PostCard, VoteButtons, CommentThread, CreatePostForm

**QA Fixes (Phase 3)**:
- Added try-catch to handleCreatePost
- Fixed duplicate API calls on mount (useRef pattern)
- Added empty subForums warning
- Fixed stale closure in pagination (offsetRef)
- Added loading state to VoteButtons
- Added confirmation dialog for comment deletion

### Archetype → Forum Integration (2025-12-25) ✅
Maps archetypes to relevant forum communities:

**Backend**:
- `migrations/007_add_archetype_forum_mappings.sql` - Table + 22 seed mappings
- `app/models/forum.py` - Added ArchetypeForumMapping model
- `app/schemas/forum.py` - Added ArchetypeForumRecommendation schema
- `app/routers/forum.py` - Added GET /forum/archetype-recommendations?archetype=X

**Frontend**:
- `src/lib/api.ts` - getArchetypeForumRecommendations() method
- `src/components/results/tabs/CommunityTab.tsx` - "Based on Your Archetype" section
- `src/components/results/tabs/ArchetypeTab.tsx` - RecommendedForumsSection component

**Mappings**: Each archetype (Softboy, Prettyboy, RobustPrettyboy, Chad, Hypermasculine, Exotic) → relevant forum categories (Fashion, Body Composition, etc.)

## Remaining Tasks

### High Priority
1. Deploy forum frontend to Vercel (push changes)
2. Debug blank results page issue
3. Create influencer referral codes via `/referrals/create` endpoint (requires Stripe promo code IDs)
4. Wire up welcome email on signup (`email_service.send_welcome_email` exists but not called)
5. Test full payment flow with referral discount applied

### Future
6. Implement supplement/product e-commerce layer (see `supplement_implementation.md`)
7. Add forum link to main navigation

### Cleanup (Optional)
8. Remove debug logging from `looksmaxx-api/app/routers/leaderboard.py`
9. Clean up test users from database

## Last Session (2025-12-25)

Completed Sprint 5: Archetype → Forum Integration

**What was done:**
- Created `archetype_forum_mappings` table with 22 seeded mappings (6 archetypes → multiple forums each)
- Added `ArchetypeForumMapping` model and `ArchetypeForumRecommendation` schema
- Added `GET /forum/archetype-recommendations?archetype=X` endpoint to backend
- Added "Based on Your Archetype" section to CommunityTab with dedupe logic
- Added `RecommendedForumsSection` component to ArchetypeTab
- Migration applied to Railway database

**Files Modified:**
| Component | File | Changes |
|-----------|------|---------|
| Migration | `looksmaxx-api/migrations/007_add_archetype_forum_mappings.sql` | Table + 22 seed mappings |
| Model | `looksmaxx-api/app/models/forum.py` | ArchetypeForumMapping model |
| Schema | `looksmaxx-api/app/schemas/forum.py` | ArchetypeForumRecommendation response |
| Router | `looksmaxx-api/app/routers/forum.py` | archetype-recommendations endpoint |
| API Client | `looksmaxx-app/src/lib/api.ts` | getArchetypeForumRecommendations() |
| CommunityTab | `looksmaxx-app/src/components/results/tabs/CommunityTab.tsx` | Archetype section |
| ArchetypeTab | `looksmaxx-app/src/components/results/tabs/ArchetypeTab.tsx` | RecommendedForumsSection |

**All checks pass:** `npm run lint && npx tsc --noEmit && npm run build` ✅

Stopped at: Sprint 5 complete, ready for Sprint 6 (Final E2E Test)
