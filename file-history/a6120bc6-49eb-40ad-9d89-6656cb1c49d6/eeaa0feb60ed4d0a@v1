'use client';

import { useState, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  ChevronDown,
  Clock,
  DollarSign,
  AlertTriangle,
  Target,
  Info,
  BookOpen,
  CheckCircle,
  Trash2,
  Plus,
  Sparkles,
} from 'lucide-react';
import { Recommendation } from '@/types/results';

// ============================================
// TYPES
// ============================================

interface EnhancedRecommendationCardProps {
  recommendation: Recommendation;
  isExpanded?: boolean;
  onToggle?: () => void;
  rank?: number;
  onMarkComplete?: (id: string) => void;
  onRemove?: (id: string) => void;
  isCompleted?: boolean;
}

interface TrackerState {
  notes: string;
  checklist: Array<{ id: string; text: string; completed: boolean }>;
}

// ============================================
// PHASE BADGE (Dark Theme)
// ============================================

function PhaseBadge({ phase }: { phase: string }) {
  const getPhaseConfig = () => {
    switch (phase) {
      case 'Foundational':
        return {
          bg: 'bg-emerald-500/20',
          text: 'text-emerald-400',
          border: 'border-emerald-500/30',
        };
      case 'Minimally Invasive':
        return {
          bg: 'bg-blue-500/20',
          text: 'text-blue-400',
          border: 'border-blue-500/30',
        };
      case 'Surgical':
        return {
          bg: 'bg-purple-500/20',
          text: 'text-purple-400',
          border: 'border-purple-500/30',
        };
      default:
        return {
          bg: 'bg-neutral-500/20',
          text: 'text-neutral-400',
          border: 'border-neutral-500/30',
        };
    }
  };

  const config = getPhaseConfig();

  return (
    <span
      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}
    >
      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}
    </span>
  );
}

// ============================================
// IMPACT BADGE
// ============================================

function ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {
  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);

  return (
    <div className="flex items-center gap-1.5 sm:gap-2 flex-wrap">
      <span className="flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0">
        <Sparkles className="w-2.5 h-2.5 sm:w-3 sm:h-3" />
        {formattedImpact}
      </span>
      {(frontImpact !== undefined || sideImpact !== undefined) && (
        <span className="hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0">
          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>
            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}
          </span>
          <span className="text-neutral-600">|</span>
          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>
            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}
          </span>
        </span>
      )}
    </div>
  );
}

// ============================================
// IMPROVEMENT TAG
// ============================================

function ImprovementTag({ text }: { text: string }) {
  return (
    <div className="inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm">
      <CheckCircle className="w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0" />
      <span className="truncate">{text}</span>
    </div>
  );
}

// ============================================
// SECTION HEADER
// ============================================

function SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {
  return (
    <h4 className="flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3">
      <Icon className="w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400" />
      {title}
    </h4>
  );
}

// ============================================
// MY TRACKER SECTION
// ============================================

function MyTracker({
  tracker,
  onNotesChange,
  onAddChecklistItem,
  onToggleChecklistItem,
  onRemoveChecklistItem
}: {
  tracker: TrackerState;
  onNotesChange: (notes: string) => void;
  onAddChecklistItem: () => void;
  onToggleChecklistItem: (id: string) => void;
  onRemoveChecklistItem: (id: string) => void;
}) {
  return (
    <div className="md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full">
      <h4 className="flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4">
        <BookOpen className="w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400" />
        My Tracker
      </h4>
      <div className="space-y-3 sm:space-y-4">
        {/* Personal Notes */}
        <div className="space-y-1 sm:space-y-1.5">
          <label className="text-[11px] sm:text-xs font-medium text-neutral-400">Personal Notes</label>
          <textarea
            value={tracker.notes}
            onChange={(e) => onNotesChange(e.target.value)}
            className="w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all"
            placeholder="Track progress, questions, dates..."
          />
        </div>

        {/* Checklist */}
        <div className="space-y-1.5 sm:space-y-2 pt-1 sm:pt-2">
          <label className="text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center">
            <span>Checklist</span>
            <button
              onClick={onAddChecklistItem}
              className="text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors"
            >
              <Plus className="w-2.5 h-2.5 sm:w-3 sm:h-3" />
              Add
            </button>
          </label>
          <div className="space-y-1.5 sm:space-y-2">
            {tracker.checklist.length === 0 ? (
              <div className="text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50">
                No tasks yet
              </div>
            ) : (
              tracker.checklist.map((item) => (
                <div
                  key={item.id}
                  className="flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg"
                >
                  <button
                    onClick={() => onToggleChecklistItem(item.id)}
                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${
                      item.completed
                        ? 'bg-emerald-500 border-emerald-500'
                        : 'border-neutral-600 hover:border-neutral-500'
                    }`}
                  >
                    {item.completed && <CheckCircle className="w-3 h-3 text-black" />}
                  </button>
                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>
                    {item.text}
                  </span>
                  <button
                    onClick={() => onRemoveChecklistItem(item.id)}
                    className="text-neutral-600 hover:text-red-400 transition-colors"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// MAIN ENHANCED RECOMMENDATION CARD
// ============================================

export function EnhancedRecommendationCard({
  recommendation,
  isExpanded = false,
  onToggle,
  rank,
  onMarkComplete,
  onRemove,
  isCompleted = false,
}: EnhancedRecommendationCardProps) {
  // Tracker state (would be persisted in real app)
  const [tracker, setTracker] = useState<TrackerState>({
    notes: '',
    checklist: [],
  });

  const handleNotesChange = useCallback((notes: string) => {
    setTracker(prev => ({ ...prev, notes }));
  }, []);

  const handleAddChecklistItem = useCallback(() => {
    const text = window.prompt('Enter task:');
    if (text) {
      setTracker(prev => ({
        ...prev,
        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],
      }));
    }
  }, []);

  const handleToggleChecklistItem = useCallback((id: string) => {
    setTracker(prev => ({
      ...prev,
      checklist: prev.checklist.map(item =>
        item.id === id ? { ...item, completed: !item.completed } : item
      ),
    }));
  }, []);

  const handleRemoveChecklistItem = useCallback((id: string) => {
    setTracker(prev => ({
      ...prev,
      checklist: prev.checklist.filter(item => item.id !== id),
    }));
  }, []);

  // Format cost
  const formatCost = () => {
    const { min, max, type } = recommendation.cost;
    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';
    if (min === max) {
      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;
    }
    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;
  };

  // Format timeline
  const formatTimeline = () => {
    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;
    if (full_results_weeks_max) {
      return `${full_results_weeks}-${full_results_weeks_max} weeks`;
    }
    if (full_results_weeks >= 52) {
      const months = Math.round(full_results_weeks / 4);
      return `${months} months`;
    }
    return `${full_results_weeks} weeks`;
  };

  // Get effectiveness level
  const getEffectiveness = () => {
    if (recommendation.impact >= 0.7) return 'high';
    if (recommendation.impact >= 0.4) return 'moderate';
    return 'low';
  };

  return (
    <motion.div
      layout
      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${
        isExpanded
          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'
          : 'border-neutral-800 hover:border-neutral-700'
      } ${isCompleted ? 'opacity-60' : ''}`}
    >
      {/* Header - Clickable */}
      <div className="p-3.5 sm:p-5 cursor-pointer" onClick={onToggle}>
        <div className="space-y-3 sm:space-y-4">
          <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4">
            <div className="flex-1 min-w-0">
              <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2">
                <h3 className="text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white">
                  {recommendation.name}
                </h3>
                <div className="flex items-center gap-1.5 sm:gap-2 flex-wrap">
                  <PhaseBadge phase={recommendation.phase} />
                  <ImpactBadge impact={recommendation.impact} />
                </div>
              </div>
              <p className="text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none">
                {recommendation.description}
              </p>
            </div>

            {/* Action buttons */}
            <div className="flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto">
              {onMarkComplete && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onMarkComplete(recommendation.ref_id);
                  }}
                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${
                    isCompleted
                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'
                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'
                  }`}
                  title="Mark as complete"
                >
                  <CheckCircle className="w-4 h-4" />
                </button>
              )}
              {onRemove && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onRemove(recommendation.ref_id);
                  }}
                  className="p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10"
                  title="Remove action"
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              )}
            </div>
          </div>

          {/* Quick stats row */}
          <div className="flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400">
            <div className="flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5">
              <div className="flex items-center gap-1 sm:gap-1.5" title="Estimated Cost">
                <DollarSign className="w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500" />
                <span className="font-medium text-neutral-300">{formatCost()}</span>
              </div>
              {recommendation.timeline.full_results_weeks > 0 && (
                <div className="flex items-center gap-1 sm:gap-1.5">
                  <Clock className="w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500" />
                  <span className="font-medium text-neutral-300">{formatTimeline()}</span>
                </div>
              )}
            </div>
            <button
              className="flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white"
            >
              {isExpanded ? 'Less' : 'More'}
              <ChevronDown
                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}
              />
            </button>
          </div>
        </div>
      </div>

      {/* Expanded Content */}
      <AnimatePresence initial={false}>
        {isExpanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="overflow-hidden"
          >
            <div className="border-t border-neutral-800 bg-neutral-900/50">
              <div className="grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800">
                {/* Main Content */}
                <div className="md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6">
                  {/* Improvements */}
                  <div>
                    <SectionHeader icon={Target} title="Improvements" />
                    <div className="space-y-2 sm:space-y-3">
                      <div className="flex flex-wrap gap-1.5 sm:gap-2">
                        {recommendation.matchedFlaws.map((flaw, i) => (
                          <ImprovementTag key={i} text={flaw} />
                        ))}
                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (
                          <ImprovementTag key={i} text={ratio} />
                        ))}
                      </div>
                      <div className="bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm">
                        <div className="flex items-center gap-2 mb-1.5 sm:mb-2">
                          <div className="text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase">Effectiveness</div>
                          <div className="h-1 w-1 rounded-full bg-neutral-600" />
                          <div className="font-medium text-white capitalize text-xs sm:text-sm">{getEffectiveness()}</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* How It Helps */}
                  <div>
                    <SectionHeader icon={Info} title="How It Helps" />
                    <div className="space-y-1.5 sm:space-y-2">
                      <div className="bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm">
                        <p className="text-neutral-300 text-[11px] sm:text-xs leading-relaxed">
                          {recommendation.description}
                        </p>
                      </div>
                      {recommendation.ratios_impacted.length > 0 && (
                        <div className="bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm">
                          <p className="text-neutral-300 text-[11px] sm:text-xs leading-relaxed">
                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}
                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.
                          </p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Logistics & Timeline */}
                  {recommendation.timeline.full_results_weeks > 0 && (
                    <div>
                      <SectionHeader icon={Clock} title="Logistics & Timeline" />
                      <div className="grid grid-cols-2 gap-2 sm:gap-3">
                        <div className="bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700">
                          <span className="text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1">
                            Effect Starts
                          </span>
                          <span className="text-xs sm:text-sm font-medium text-white capitalize">
                            {recommendation.timeline.effect_start}
                          </span>
                        </div>
                        <div className="bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700">
                          <span className="text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1">
                            Full Results
                          </span>
                          <span className="text-xs sm:text-sm font-medium text-white">
                            {formatTimeline()}
                          </span>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Considerations */}
                  <div>
                    <SectionHeader icon={AlertTriangle} title="Considerations" />
                    <div className="space-y-2 sm:space-y-3">
                      {/* Prerequisites */}
                      {recommendation.warnings.length > 0 && (
                        <div className="bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm">
                          <span className="font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm">Prerequisites</span>
                          <p className="text-blue-300/80 text-[11px] sm:text-xs leading-relaxed">
                            {recommendation.warnings[0]}
                          </p>
                        </div>
                      )}

                      {/* Risks & Side Effects */}
                      {recommendation.risks_side_effects && (
                        <div className="bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm">
                          <span className="font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm">
                            Risks & Side Effects
                          </span>
                          <p className="text-amber-300/80 text-[11px] sm:text-xs leading-relaxed">
                            {recommendation.risks_side_effects}
                          </p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Notes & Research */}
                  <div className="space-y-1.5 sm:space-y-2">
                    {recommendation.warnings.length > 1 && (
                      <div className="text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic">
                        {recommendation.warnings.slice(1).join(' ')}
                      </div>
                    )}
                    <div className="text-[11px] sm:text-xs text-neutral-400 bg-cyan-500/10 p-2.5 sm:p-3 rounded-lg border border-cyan-500/30">
                      <span className="font-semibold text-cyan-400">Research:</span>{' '}
                      <span className="text-cyan-300/80">
                        {recommendation.matchedFlaws.length > 0
                          ? 'Based on facial analysis and established aesthetic research'
                          : 'N/A'}
                      </span>
                    </div>
                  </div>
                </div>

                {/* My Tracker Sidebar */}
                <MyTracker
                  tracker={tracker}
                  onNotesChange={handleNotesChange}
                  onAddChecklistItem={handleAddChecklistItem}
                  onToggleChecklistItem={handleToggleChecklistItem}
                  onRemoveChecklistItem={handleRemoveChecklistItem}
                />
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
}

export default EnhancedRecommendationCard;
