#!/usr/bin/env python3
"""
Free Face Generator using Artguru AI Face Generator
No login required, free to use
"""

import asyncio
from pathlib import Path
from playwright.async_api import async_playwright
import time

OUTPUT_DIR = Path("/Users/imorgado/Desktop/face_generation/generated_faces")
ARTGURU_URL = "https://www.artguru.ai/ai-face-generator/"

# Prompts for each face we need
FACES = [
    {"prompt": "professional headshot portrait of attractive young white European man, clean white background, studio lighting, symmetrical face, neutral expression, short hair, clear skin", "filename": "male_white_front.png"},
    {"prompt": "professional headshot portrait of attractive young white European woman, clean white background, studio lighting, symmetrical face, neutral expression, hair pulled back, clear skin", "filename": "female_white_front.png"},
    {"prompt": "professional headshot portrait of attractive young Black African man, clean white background, studio lighting, symmetrical face, neutral expression, short hair, clear skin", "filename": "male_black_front.png"},
    {"prompt": "professional headshot portrait of attractive young Black African woman, clean white background, studio lighting, symmetrical face, neutral expression, hair pulled back, clear skin", "filename": "female_black_front.png"},
    {"prompt": "professional headshot portrait of attractive young East Asian Japanese man, clean white background, studio lighting, symmetrical face, neutral expression, short hair, clear skin", "filename": "male_east_asian_front.png"},
    {"prompt": "professional headshot portrait of attractive young East Asian Japanese woman, clean white background, studio lighting, symmetrical face, neutral expression, hair pulled back, clear skin", "filename": "female_east_asian_front.png"},
    {"prompt": "professional headshot portrait of attractive young Hispanic Latino man, clean white background, studio lighting, symmetrical face, neutral expression, short hair, clear skin", "filename": "male_hispanic_front.png"},
    {"prompt": "professional headshot portrait of attractive young Hispanic Latina woman, clean white background, studio lighting, symmetrical face, neutral expression, hair pulled back, clear skin", "filename": "female_hispanic_front.png"},
    {"prompt": "professional headshot portrait of attractive young South Asian Indian man, clean white background, studio lighting, symmetrical face, neutral expression, short hair, clear skin", "filename": "male_south_asian_front.png"},
    {"prompt": "professional headshot portrait of attractive young South Asian Indian woman, clean white background, studio lighting, symmetrical face, neutral expression, hair pulled back, clear skin", "filename": "female_south_asian_front.png"},
    {"prompt": "professional headshot portrait of attractive young Middle Eastern Arab man, clean white background, studio lighting, symmetrical face, neutral expression, short hair, clear skin, clean shaven", "filename": "male_middle_eastern_front.png"},
    {"prompt": "professional headshot portrait of attractive young Middle Eastern Arab woman, clean white background, studio lighting, symmetrical face, neutral expression, hair pulled back, clear skin", "filename": "female_middle_eastern_front.png"},
    {"prompt": "professional headshot portrait of attractive young Pacific Islander Polynesian man, clean white background, studio lighting, symmetrical face, neutral expression, short hair, clear skin", "filename": "male_pacific_islander_front.png"},
    {"prompt": "professional headshot portrait of attractive young Pacific Islander Polynesian woman, clean white background, studio lighting, symmetrical face, neutral expression, hair pulled back, clear skin", "filename": "female_pacific_islander_front.png"},
    {"prompt": "professional headshot portrait of attractive young Native American Indigenous man, clean white background, studio lighting, symmetrical face, neutral expression, short hair, clear skin", "filename": "male_native_american_front.png"},
    {"prompt": "professional headshot portrait of attractive young Native American Indigenous woman, clean white background, studio lighting, symmetrical face, neutral expression, hair pulled back, clear skin", "filename": "female_native_american_front.png"},
]


async def generate_face(page, prompt: str, filename: str, output_dir: Path) -> bool:
    """Generate a face using the text prompt"""
    print(f"\n{'='*50}")
    print(f"Generating: {filename}")
    print(f"Prompt: {prompt[:60]}...")

    try:
        # Go to page
        await page.goto(ARTGURU_URL, wait_until="networkidle", timeout=60000)
        await asyncio.sleep(3)

        # Find text input for prompt
        prompt_input = None
        selectors = [
            'textarea',
            'input[type="text"]',
            '[contenteditable="true"]',
            '.prompt-input',
            '#prompt',
        ]

        for sel in selectors:
            try:
                elem = page.locator(sel).first
                if await elem.is_visible(timeout=3000):
                    prompt_input = elem
                    break
            except:
                continue

        if not prompt_input:
            print("  ✗ Could not find prompt input")
            await page.screenshot(path=output_dir / f"debug_{filename}")
            return False

        # Enter prompt
        await prompt_input.click()
        await prompt_input.fill(prompt)
        print("  ✓ Entered prompt")
        await asyncio.sleep(1)

        # Find and click generate button
        gen_btn = None
        btn_selectors = [
            'button:has-text("Generate")',
            'button:has-text("Create")',
            'button[type="submit"]',
            '.generate-btn',
        ]

        for sel in btn_selectors:
            try:
                elem = page.locator(sel).first
                if await elem.is_visible(timeout=3000):
                    gen_btn = elem
                    break
            except:
                continue

        if not gen_btn:
            print("  ✗ Could not find generate button")
            return False

        await gen_btn.click()
        print("  ⏳ Generating... (30-60 seconds)")
        await asyncio.sleep(45)

        # Find result image
        img_selectors = [
            '.result img',
            '.generated img',
            '.output img',
            'img[src*="generated"]',
            'img[src*="result"]',
            'img[src*="output"]',
        ]

        for sel in img_selectors:
            try:
                imgs = await page.locator(sel).all()
                for img in imgs:
                    if await img.is_visible():
                        save_path = output_dir / filename
                        await img.screenshot(path=save_path)
                        print(f"  ✓ Saved: {save_path}")
                        return True
            except:
                continue

        # Try download button
        try:
            dl_btn = page.locator('button:has-text("Download"), a[download]').first
            if await dl_btn.is_visible(timeout=5000):
                async with page.expect_download(timeout=30000) as dl_info:
                    await dl_btn.click()
                download = await dl_info.value
                save_path = output_dir / filename
                await download.save_as(save_path)
                print(f"  ✓ Downloaded: {save_path}")
                return True
        except:
            pass

        print("  ✗ Could not capture image")
        await page.screenshot(path=output_dir / f"debug_{filename}")
        return False

    except Exception as e:
        print(f"  ✗ Error: {e}")
        return False


async def main():
    OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

    results = {"success": [], "failed": []}

    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=False, slow_mo=200)
        context = await browser.new_context(
            viewport={"width": 1920, "height": 1080},
            accept_downloads=True
        )
        page = await context.new_page()

        # Test with first 2 faces
        test_faces = FACES[:2]

        for i, face in enumerate(test_faces):
            print(f"\n[{i+1}/{len(test_faces)}]")
            success = await generate_face(page, face["prompt"], face["filename"], OUTPUT_DIR)

            if success:
                results["success"].append(face["filename"])
            else:
                results["failed"].append(face["filename"])

            await asyncio.sleep(3)

        print("\n" + "="*50)
        print(f"Success: {len(results['success'])}/{len(test_faces)}")
        print(f"Failed: {len(results['failed'])}/{len(test_faces)}")
        print("="*50)

        print("\nKeeping browser open for 30s...")
        await asyncio.sleep(30)
        await browser.close()


if __name__ == "__main__":
    asyncio.run(main())
