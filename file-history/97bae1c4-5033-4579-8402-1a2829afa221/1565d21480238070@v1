#!/usr/bin/env python3
"""
Generated.photos API Script
Uses the Generated.photos API (requires API key)
Get your API key at: https://generated.photos/account#apikey

This is the CLEANEST option if you have an API key.
"""

import requests
import json
from pathlib import Path
import time

API_KEY = "YOUR_API_KEY_HERE"  # Get from https://generated.photos/account#apikey
BASE_URL = "https://api.generated.photos/api/v1/faces"
OUTPUT_DIR = Path("/Users/imorgado/Desktop/face_generation/generated_faces")

# Mapping our ethnicities to Generated.photos API parameters
ETHNICITY_MAP = {
    "black": "black",
    "hispanic": "latino_hispanic",
    "pacific_islander": "asian",  # Closest available
    "south_asian": "asian",
    "east_asian": "asian",
    "native_american": "latino_hispanic",  # Closest available
    "middle_eastern": "middle_eastern",
    "white": "white",
}

# Faces to generate
FACES = [
    # Black
    {"ethnicity": "black", "gender": "male", "filename": "male_black_front.jpg"},
    {"ethnicity": "black", "gender": "female", "filename": "female_black_front.jpg"},
    # Hispanic
    {"ethnicity": "hispanic", "gender": "male", "filename": "male_hispanic_front.jpg"},
    {"ethnicity": "hispanic", "gender": "female", "filename": "female_hispanic_front.jpg"},
    # South Asian
    {"ethnicity": "south_asian", "gender": "male", "filename": "male_south_asian_front.jpg"},
    {"ethnicity": "south_asian", "gender": "female", "filename": "female_south_asian_front.jpg"},
    # East Asian
    {"ethnicity": "east_asian", "gender": "male", "filename": "male_east_asian_front.jpg"},
    {"ethnicity": "east_asian", "gender": "female", "filename": "female_east_asian_front.jpg"},
    # Middle Eastern
    {"ethnicity": "middle_eastern", "gender": "male", "filename": "male_middle_eastern_front.jpg"},
    {"ethnicity": "middle_eastern", "gender": "female", "filename": "female_middle_eastern_front.jpg"},
]


def generate_face(ethnicity: str, gender: str) -> str:
    """Generate a face using the API and return the image URL"""

    params = {
        "api_key": API_KEY,
        "ethnicity": ETHNICITY_MAP.get(ethnicity, ethnicity),
        "gender": gender,
        "age": "young-adult",  # Options: infant, child, young-adult, adult, elderly
        "hair_length": "short" if gender == "male" else "medium",
        "emotion": "neutral",
        "per_page": 1,
    }

    response = requests.get(BASE_URL, params=params)

    if response.status_code == 200:
        data = response.json()
        if data.get("faces") and len(data["faces"]) > 0:
            return data["faces"][0]["urls"][4]["512"]  # 512px version
    else:
        print(f"API Error: {response.status_code} - {response.text}")

    return None


def download_image(url: str, filepath: Path) -> bool:
    """Download an image from URL to filepath"""
    try:
        response = requests.get(url, stream=True)
        if response.status_code == 200:
            with open(filepath, 'wb') as f:
                for chunk in response.iter_content(1024):
                    f.write(chunk)
            return True
    except Exception as e:
        print(f"Download error: {e}")
    return False


def main():
    if API_KEY == "YOUR_API_KEY_HERE":
        print("="*60)
        print("ERROR: Please set your API key!")
        print("1. Go to https://generated.photos/account#apikey")
        print("2. Sign up / login and get your API key")
        print("3. Replace 'YOUR_API_KEY_HERE' with your actual key")
        print("="*60)
        return

    OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

    print(f"Generating {len(FACES)} faces...")

    for i, face in enumerate(FACES):
        print(f"\n[{i+1}/{len(FACES)}] {face['ethnicity']} {face['gender']}")

        url = generate_face(face['ethnicity'], face['gender'])

        if url:
            filepath = OUTPUT_DIR / face['filename']
            if download_image(url, filepath):
                print(f"  ✓ Saved to {filepath}")
            else:
                print(f"  ✗ Failed to download")
        else:
            print(f"  ✗ Failed to generate")

        # Rate limiting
        time.sleep(1)

    print("\n" + "="*60)
    print("COMPLETE!")
    print(f"Faces saved to: {OUTPUT_DIR}")
    print("="*60)
    print("\nNOTE: Generated.photos only provides FRONT views.")
    print("For SIDE PROFILE views, use Somake AI or stock photos.")


if __name__ == "__main__":
    main()
