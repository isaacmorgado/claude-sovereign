#!/usr/bin/env python3
"""
Interactive Face Generator - Waits for manual login, then automates generation
"""

import asyncio
import json
from pathlib import Path
from playwright.async_api import async_playwright

OUTPUT_DIR = Path("/Users/imorgado/Desktop/face_generation/generated_faces")
SOMAKE_URL = "https://www.somake.ai/tools/face-generator"

# Faces to generate - front views
FACES_TO_GENERATE = [
    # Preset ethnicities
    {"ethnicity": "European", "gender": "Male", "filename": "male_white_front.png", "custom": None},
    {"ethnicity": "European", "gender": "Female", "filename": "female_white_front.png", "custom": None},
    {"ethnicity": "Japanese", "gender": "Male", "filename": "male_east_asian_front.png", "custom": None},
    {"ethnicity": "Japanese", "gender": "Female", "filename": "female_east_asian_front.png", "custom": None},
    {"ethnicity": "Latino", "gender": "Male", "filename": "male_hispanic_front.png", "custom": None},
    {"ethnicity": "Latino", "gender": "Female", "filename": "female_hispanic_front.png", "custom": None},
    # Custom ethnicities
    {"ethnicity": "Custom", "gender": "Male", "filename": "male_black_front.png", "custom": "Black African man"},
    {"ethnicity": "Custom", "gender": "Female", "filename": "female_black_front.png", "custom": "Black African woman"},
    {"ethnicity": "Custom", "gender": "Male", "filename": "male_south_asian_front.png", "custom": "South Asian Indian man"},
    {"ethnicity": "Custom", "gender": "Female", "filename": "female_south_asian_front.png", "custom": "South Asian Indian woman"},
    {"ethnicity": "Custom", "gender": "Male", "filename": "male_middle_eastern_front.png", "custom": "Middle Eastern Arab man"},
    {"ethnicity": "Custom", "gender": "Female", "filename": "female_middle_eastern_front.png", "custom": "Middle Eastern Arab woman"},
    {"ethnicity": "Custom", "gender": "Male", "filename": "male_pacific_islander_front.png", "custom": "Pacific Islander Polynesian man"},
    {"ethnicity": "Custom", "gender": "Female", "filename": "female_pacific_islander_front.png", "custom": "Pacific Islander Polynesian woman"},
    {"ethnicity": "Custom", "gender": "Male", "filename": "male_native_american_front.png", "custom": "Native American Indigenous man"},
    {"ethnicity": "Custom", "gender": "Female", "filename": "female_native_american_front.png", "custom": "Native American Indigenous woman"},
]


async def wait_for_login(page):
    """Wait for user to log in manually"""
    print("\n" + "="*60)
    print("MANUAL LOGIN REQUIRED")
    print("="*60)
    print("1. Log in with Google in the browser window")
    print("2. Once logged in, you should see the Face Generator page")
    print("3. Press ENTER here when ready to continue...")
    print("="*60)

    input("\nPress ENTER after logging in...")

    # Give a moment for page to stabilize
    await asyncio.sleep(2)

    # Navigate back to generator if needed
    if "face-generator" not in page.url:
        await page.goto(SOMAKE_URL, wait_until="networkidle")
        await asyncio.sleep(3)


async def generate_single_face(page, face: dict, output_dir: Path) -> bool:
    """Generate a single face"""
    print(f"\n--- Generating: {face['filename']} ---")
    print(f"    Gender: {face['gender']}, Ethnicity: {face['ethnicity']}")

    try:
        # Refresh page for clean state
        await page.goto(SOMAKE_URL, wait_until="networkidle")
        await asyncio.sleep(2)

        # Accept cookies if present
        try:
            cookie_btn = page.locator('button:has-text("Accept"), button:has-text("OK"), button:has-text("Got it")').first
            if await cookie_btn.is_visible(timeout=2000):
                await cookie_btn.click()
                await asyncio.sleep(0.5)
        except:
            pass

        # Click on Gender option
        try:
            gender_btn = page.locator(f'button:has-text("{face["gender"]}"), label:has-text("{face["gender"]}")').first
            if await gender_btn.is_visible(timeout=3000):
                await gender_btn.click()
                print(f"    ✓ Selected gender: {face['gender']}")
                await asyncio.sleep(0.5)
        except Exception as e:
            print(f"    ! Gender selection: {e}")

        # Click on Ethnicity option
        try:
            eth_btn = page.locator(f'button:has-text("{face["ethnicity"]}"), label:has-text("{face["ethnicity"]}")').first
            if await eth_btn.is_visible(timeout=3000):
                await eth_btn.click()
                print(f"    ✓ Selected ethnicity: {face['ethnicity']}")
                await asyncio.sleep(0.5)
        except Exception as e:
            print(f"    ! Ethnicity selection: {e}")

        # If custom, enter custom text
        if face['custom']:
            try:
                custom_input = page.locator('input[placeholder*="custom"], input[placeholder*="ethnicity"], textarea').first
                if await custom_input.is_visible(timeout=2000):
                    await custom_input.fill(face['custom'])
                    print(f"    ✓ Entered custom: {face['custom']}")
                    await asyncio.sleep(0.5)
            except:
                print(f"    ! Could not enter custom ethnicity")

        # Select white background
        try:
            bg_btn = page.locator('button:has-text("High-Key White"), button:has-text("White")').first
            if await bg_btn.is_visible(timeout=2000):
                await bg_btn.click()
                print(f"    ✓ Selected white background")
                await asyncio.sleep(0.5)
        except:
            pass

        # Click Generate button
        try:
            gen_btn = page.locator('button:has-text("Generate")').first
            await gen_btn.wait_for(state="visible", timeout=5000)
            await gen_btn.click()
            print(f"    ✓ Clicked Generate - waiting for image...")
        except Exception as e:
            print(f"    ✗ Could not click Generate: {e}")
            return False

        # Wait for generation (30-60 seconds)
        await asyncio.sleep(30)

        # Look for result image
        try:
            # Wait for results panel
            results = page.locator('#results-panel img, .result img, .generated img, .output img')
            await results.first.wait_for(state="visible", timeout=60000)

            # Find all images in results
            images = await results.all()
            for img in images:
                src = await img.get_attribute('src')
                if src and ('http' in src or 'blob:' in src or 'data:' in src):
                    # Screenshot the image
                    save_path = output_dir / face['filename']
                    await img.screenshot(path=save_path)
                    print(f"    ✓ SAVED: {save_path}")
                    return True
        except Exception as e:
            print(f"    ! Image capture error: {e}")

        # Try download button
        try:
            dl_btn = page.locator('button:has-text("Download"), a:has-text("Download")').first
            if await dl_btn.is_visible(timeout=5000):
                async with page.expect_download(timeout=30000) as dl_info:
                    await dl_btn.click()
                download = await dl_info.value
                save_path = output_dir / face['filename']
                await download.save_as(save_path)
                print(f"    ✓ DOWNLOADED: {save_path}")
                return True
        except:
            pass

        # Fallback: full page screenshot
        save_path = output_dir / f"fullpage_{face['filename']}"
        await page.screenshot(path=save_path, full_page=True)
        print(f"    ? Saved full page screenshot: {save_path}")
        return False

    except Exception as e:
        print(f"    ✗ ERROR: {e}")
        return False


async def main():
    OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

    print("="*60)
    print("FACE GENERATOR - Interactive Mode")
    print("="*60)

    results = {"success": [], "failed": []}

    async with async_playwright() as p:
        browser = await p.chromium.launch(
            headless=False,
            slow_mo=200
        )

        context = await browser.new_context(
            viewport={"width": 1920, "height": 1080},
            accept_downloads=True
        )

        page = await context.new_page()

        # Go to Somake
        await page.goto(SOMAKE_URL, wait_until="networkidle")
        await asyncio.sleep(2)

        # Wait for manual login
        await wait_for_login(page)

        # Generate faces
        for i, face in enumerate(FACES_TO_GENERATE):
            print(f"\n[{i+1}/{len(FACES_TO_GENERATE)}]")

            success = await generate_single_face(page, face, OUTPUT_DIR)

            if success:
                results["success"].append(face["filename"])
            else:
                results["failed"].append(face["filename"])

            # Pause between generations
            await asyncio.sleep(3)

        print("\n" + "="*60)
        print("COMPLETE!")
        print(f"Success: {len(results['success'])}/{len(FACES_TO_GENERATE)}")
        print(f"Failed: {len(results['failed'])}/{len(FACES_TO_GENERATE)}")
        print("="*60)

        if results["failed"]:
            print("\nFailed:")
            for f in results["failed"]:
                print(f"  - {f}")

        print("\nBrowser stays open for 60 seconds...")
        await asyncio.sleep(60)

        await browser.close()

    with open(OUTPUT_DIR / "results.json", "w") as f:
        json.dump(results, f, indent=2)

    print(f"\nImages saved to: {OUTPUT_DIR}")


if __name__ == "__main__":
    asyncio.run(main())
