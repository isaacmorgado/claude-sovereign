#!/bin/bash
#
# SPLICE Installer Deployment Script
# Copies built installers to the website's public downloads folder
#

set -e

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Source and destination directories
BUILD_DIR="$PROJECT_ROOT/build/output"
WEBSITE_PUBLIC="$PROJECT_ROOT/splice-website/public"
DOWNLOADS_DIR="$WEBSITE_PUBLIC/downloads"

# Version info
VERSION_FILE="$PROJECT_ROOT/installer/shared/version.json"
if [ -f "$VERSION_FILE" ]; then
    VERSION=$(grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' "$VERSION_FILE" | cut -d'"' -f4)
else
    VERSION="6.0.3"
fi

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Create downloads directory if it doesn't exist
mkdir -p "$DOWNLOADS_DIR"

# Check if build directory exists
if [ ! -d "$BUILD_DIR" ]; then
    log_error "Build directory not found: $BUILD_DIR"
    log_error "Please run the build script first: ./build/scripts/build-all.sh"
    exit 1
fi

# Check if website directory exists
if [ ! -d "$WEBSITE_PUBLIC" ]; then
    log_error "Website public directory not found: $WEBSITE_PUBLIC"
    exit 1
fi

echo "========================================"
echo "SPLICE Installer Deployment"
echo "Version: $VERSION"
echo "========================================"
echo ""

# Copy CEP ZXP (signed extension)
if [ -f "$BUILD_DIR/splice-v$VERSION.zxp" ]; then
    cp "$BUILD_DIR/splice-v$VERSION.zxp" "$DOWNLOADS_DIR/"
    log_info "Copied CEP ZXP: splice-v$VERSION.zxp"
else
    log_warn "CEP ZXP not found: splice-v$VERSION.zxp"
fi

# Copy CEP macOS installer
if [ -f "$BUILD_DIR/SPLICE-v$VERSION.pkg" ]; then
    cp "$BUILD_DIR/SPLICE-v$VERSION.pkg" "$DOWNLOADS_DIR/"
    log_info "Copied CEP macOS installer: SPLICE-v$VERSION.pkg"
else
    log_warn "CEP macOS installer not found: SPLICE-v$VERSION.pkg"
fi

# Copy CEP Windows installer
if [ -f "$BUILD_DIR/SPLICE-v$VERSION-Setup.exe" ]; then
    cp "$BUILD_DIR/SPLICE-v$VERSION-Setup.exe" "$DOWNLOADS_DIR/"
    log_info "Copied CEP Windows installer: SPLICE-v$VERSION-Setup.exe"
else
    log_warn "CEP Windows installer not found: SPLICE-v$VERSION-Setup.exe"
fi

# Copy UXP CCX file
if [ -f "$BUILD_DIR/SPLICE-v$VERSION.ccx" ]; then
    cp "$BUILD_DIR/SPLICE-v$VERSION.ccx" "$DOWNLOADS_DIR/"
    log_info "Copied UXP CCX: SPLICE-v$VERSION.ccx"
else
    log_warn "UXP CCX not found: SPLICE-v$VERSION.ccx"
fi

# Copy UXP macOS installer (optional)
if [ -f "$BUILD_DIR/SPLICE-UXP-v$VERSION.pkg" ]; then
    cp "$BUILD_DIR/SPLICE-UXP-v$VERSION.pkg" "$DOWNLOADS_DIR/"
    log_info "Copied UXP macOS installer: SPLICE-UXP-v$VERSION.pkg"
fi

# Copy UXP Windows installer (optional)
if [ -f "$BUILD_DIR/SPLICE-UXP-v$VERSION.exe" ]; then
    cp "$BUILD_DIR/SPLICE-UXP-v$VERSION.exe" "$DOWNLOADS_DIR/"
    log_info "Copied UXP Windows installer: SPLICE-UXP-v$VERSION.exe"
fi

# Copy dev ZIP (optional)
if [ -f "$BUILD_DIR/splice-v$VERSION-dev.zip" ]; then
    cp "$BUILD_DIR/splice-v$VERSION-dev.zip" "$DOWNLOADS_DIR/SPLICE-v$VERSION-macOS.zip"
    log_info "Copied dev ZIP as: SPLICE-v$VERSION-macOS.zip"
fi

echo ""
echo "========================================"
log_info "Deployment complete!"
echo ""
echo "Files deployed to: $DOWNLOADS_DIR"
echo ""
echo "Next steps:"
echo "  1. Commit the changes: git add splice-website/public/downloads/"
echo "  2. Push to trigger Vercel deployment"
echo "========================================"
