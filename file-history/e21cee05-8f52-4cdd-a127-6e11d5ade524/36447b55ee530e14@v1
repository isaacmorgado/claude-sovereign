;========================================================================
; SPLICE CEP Extension - Windows NSIS Installer Script
; Creates a professional Windows installer for the SPLICE extension
;========================================================================

;------------------------------------------------------------------------
; Compiler Flags
;------------------------------------------------------------------------
Unicode True
SetCompressor /SOLID lzma
SetCompressorDictSize 64
RequestExecutionLevel admin

;------------------------------------------------------------------------
; Includes
;------------------------------------------------------------------------
!include "MUI2.nsh"
!include "FileFunc.nsh"
!include "LogicLib.nsh"
!include "WinVer.nsh"
!include "x64.nsh"

;------------------------------------------------------------------------
; Defines - These can be overridden from command line
;------------------------------------------------------------------------
!ifndef VERSION
    !define VERSION "1.0.0"
!endif

!ifndef SOURCE_DIR
    !define SOURCE_DIR "..\..\..\.staging-win\extension"
!endif

!ifndef OUTPUT_FILE
    !define OUTPUT_FILE "..\output\SPLICE-v${VERSION}-Setup.exe"
!endif

!define PRODUCT_NAME "SPLICE"
!define PRODUCT_PUBLISHER "SPLICE Inc"
!define PRODUCT_WEB_SITE "https://splice.video"
!define PRODUCT_UNINST_KEY "Software\Microsoft\Windows\CurrentVersion\Uninstall\${PRODUCT_NAME}"
!define PRODUCT_UNINST_ROOT_KEY "HKLM"

; Installation paths
!define CEP_INSTALL_PATH "$PROGRAMFILES\Common Files\Adobe\CEP\extensions\com.splice.panel"
!define CEP_INSTALL_PATH_X86 "$PROGRAMFILES32\Common Files\Adobe\CEP\extensions\com.splice.panel"

;------------------------------------------------------------------------
; General Settings
;------------------------------------------------------------------------
Name "${PRODUCT_NAME} ${VERSION}"
OutFile "${OUTPUT_FILE}"
InstallDir "${CEP_INSTALL_PATH}"
ShowInstDetails show
ShowUnInstDetails show
BrandingText "${PRODUCT_NAME} v${VERSION} - ${PRODUCT_PUBLISHER}"

;------------------------------------------------------------------------
; MUI Settings
;------------------------------------------------------------------------
!define MUI_ABORTWARNING
!define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"
!define MUI_UNICON "${NSISDIR}\Contrib\Graphics\Icons\modern-uninstall.ico"

; Welcome page
!define MUI_WELCOMEPAGE_TITLE "Welcome to ${PRODUCT_NAME} Setup"
!define MUI_WELCOMEPAGE_TEXT "This wizard will guide you through the installation of ${PRODUCT_NAME} v${VERSION}.$\r$\n$\r$\nSPLICE is an AI-powered video editing extension for Adobe Premiere Pro.$\r$\n$\r$\nPlease close Adobe Premiere Pro and After Effects before continuing.$\r$\n$\r$\nClick Next to continue."

; Finish page
!define MUI_FINISHPAGE_TITLE "Installation Complete"
!define MUI_FINISHPAGE_TEXT "${PRODUCT_NAME} has been installed on your computer.$\r$\n$\r$\nTo use SPLICE, open Adobe Premiere Pro and go to:$\r$\nWindow > Extensions > SPLICE$\r$\n$\r$\nClick Finish to exit the installer."
!define MUI_FINISHPAGE_LINK "Visit ${PRODUCT_WEB_SITE}"
!define MUI_FINISHPAGE_LINK_LOCATION "${PRODUCT_WEB_SITE}"

;------------------------------------------------------------------------
; Installer Pages
;------------------------------------------------------------------------
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "license.txt"
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

; Uninstaller pages
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

;------------------------------------------------------------------------
; Language
;------------------------------------------------------------------------
!insertmacro MUI_LANGUAGE "English"

;------------------------------------------------------------------------
; Installer Sections
;------------------------------------------------------------------------
Section "SPLICE Extension" SEC01
    SectionIn RO  ; Read-only, always installed
    
    SetShellVarContext all
    SetOverwrite on
    
    ; Kill Adobe CEF processes to ensure clean installation
    DetailPrint "Closing Adobe CEF processes..."
    nsExec::ExecToLog 'taskkill /F /IM "CEPHtmlEngine.exe"'
    
    ; Determine installation path based on architecture
    ${If} ${RunningX64}
        DetailPrint "Detected 64-bit Windows"
        SetRegView 64
        StrCpy $INSTDIR "${CEP_INSTALL_PATH}"
    ${Else}
        DetailPrint "Detected 32-bit Windows"
        SetRegView 32
        StrCpy $INSTDIR "${CEP_INSTALL_PATH_X86}"
    ${EndIf}
    
    ; Remove old installation if exists
    DetailPrint "Removing previous installation..."
    RMDir /r "$INSTDIR"
    
    ; Also check user-level installation
    SetShellVarContext current
    RMDir /r "$APPDATA\Adobe\CEP\extensions\com.splice.panel"
    SetShellVarContext all
    
    ; Create installation directory
    DetailPrint "Creating installation directory..."
    CreateDirectory "$INSTDIR"
    
    ; Install files
    DetailPrint "Installing SPLICE extension files..."
    SetOutPath "$INSTDIR"
    
    ; Copy all extension files
    File /r "${SOURCE_DIR}\*.*"
    
    ; Verify installation
    ${If} ${FileExists} "$INSTDIR\CSXS\manifest.xml"
        DetailPrint "Extension files installed successfully"
    ${Else}
        DetailPrint "Warning: manifest.xml not found"
    ${EndIf}
    
    ; Create uninstaller
    DetailPrint "Creating uninstaller..."
    WriteUninstaller "$INSTDIR\uninstall.exe"
    
    ; Register with Windows Add/Remove Programs
    DetailPrint "Registering with Windows..."
    WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "DisplayName" "${PRODUCT_NAME}"
    WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "DisplayVersion" "${VERSION}"
    WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "Publisher" "${PRODUCT_PUBLISHER}"
    WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "URLInfoAbout" "${PRODUCT_WEB_SITE}"
    WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "UninstallString" '"$INSTDIR\uninstall.exe"'
    WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "QuietUninstallString" '"$INSTDIR\uninstall.exe" /S'
    WriteRegStr ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "InstallLocation" "$INSTDIR"
    WriteRegDWORD ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "NoModify" 1
    WriteRegDWORD ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "NoRepair" 1
    
    ; Calculate installed size
    ${GetSize} "$INSTDIR" "/S=0K" $0 $1 $2
    IntFmt $0 "0x%08X" $0
    WriteRegDWORD ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}" "EstimatedSize" "$0"

    ; Enable CEP debug mode (required for extensions not from Adobe Exchange)
    DetailPrint "Enabling CEP debug mode..."
    WriteRegStr HKCU "Software\Adobe\CSXS.11" "PlayerDebugMode" "1"
    WriteRegStr HKCU "Software\Adobe\CSXS.10" "PlayerDebugMode" "1"
    WriteRegStr HKCU "Software\Adobe\CSXS.9" "PlayerDebugMode" "1"
    WriteRegStr HKCU "Software\Adobe\CSXS.8" "PlayerDebugMode" "1"
    DetailPrint "CEP debug mode enabled"

    DetailPrint "Installation complete!"
SectionEnd

;------------------------------------------------------------------------
; Uninstaller Section
;------------------------------------------------------------------------
Section "Uninstall"
    SetShellVarContext all
    
    ; Kill Adobe CEF processes
    DetailPrint "Closing Adobe CEF processes..."
    nsExec::ExecToLog 'taskkill /F /IM "CEPHtmlEngine.exe"'
    
    ; Determine paths based on architecture
    ${If} ${RunningX64}
        SetRegView 64
        StrCpy $INSTDIR "${CEP_INSTALL_PATH}"
    ${Else}
        SetRegView 32
        StrCpy $INSTDIR "${CEP_INSTALL_PATH_X86}"
    ${EndIf}
    
    ; Remove installation directory
    DetailPrint "Removing SPLICE extension..."
    RMDir /r "$INSTDIR"
    
    ; Also remove user-level installation
    SetShellVarContext current
    RMDir /r "$APPDATA\Adobe\CEP\extensions\com.splice.panel"
    SetShellVarContext all
    
    ; Remove registry entries
    DetailPrint "Removing registry entries..."
    DeleteRegKey ${PRODUCT_UNINST_ROOT_KEY} "${PRODUCT_UNINST_KEY}"
    
    DetailPrint "Uninstallation complete!"
SectionEnd

;------------------------------------------------------------------------
; Installer Functions
;------------------------------------------------------------------------
Function .onInit
    ; Check for admin rights
    UserInfo::GetAccountType
    Pop $0
    ${If} $0 != "admin"
        MessageBox MB_ICONSTOP "Administrator rights required. Please run this installer as Administrator."
        Abort
    ${EndIf}
    
    ; Check Windows version (Vista or later required)
    ${IfNot} ${AtLeastWinVista}
        MessageBox MB_ICONSTOP "Windows Vista or later is required."
        Abort
    ${EndIf}
FunctionEnd

Function .onInstSuccess
    ; Optional: Launch Adobe Premiere Pro after installation
    ; MessageBox MB_YESNO "Would you like to open Adobe Premiere Pro now?" IDNO +2
    ; Exec "path\to\premiere.exe"
FunctionEnd

;------------------------------------------------------------------------
; Uninstaller Functions
;------------------------------------------------------------------------
Function un.onInit
    MessageBox MB_ICONQUESTION|MB_YESNO "Are you sure you want to uninstall ${PRODUCT_NAME}?" IDYES +2
    Abort
FunctionEnd

Function un.onUninstSuccess
    MessageBox MB_ICONINFORMATION "$(^Name) was successfully removed from your computer."
FunctionEnd

;------------------------------------------------------------------------
; Version Information
;------------------------------------------------------------------------
VIProductVersion "${VERSION}.0"
VIAddVersionKey "ProductName" "${PRODUCT_NAME}"
VIAddVersionKey "CompanyName" "${PRODUCT_PUBLISHER}"
VIAddVersionKey "LegalCopyright" "Copyright Â© 2024 ${PRODUCT_PUBLISHER}"
VIAddVersionKey "FileDescription" "${PRODUCT_NAME} Installer"
VIAddVersionKey "FileVersion" "${VERSION}"
VIAddVersionKey "ProductVersion" "${VERSION}"
