#!/bin/bash
#
# SPLICE Plugin - macOS Postinstall Script
# This script runs after the package files are installed
#

set -e

# Configuration
PLUGIN_NAME="com.splice.panel"
CEP_SOURCE="/tmp/splice-installer/cep"
UXP_CCX="/tmp/splice-installer/splice-uxp.ccx"
LOG_FILE="/tmp/splice-installer.log"

# Installation paths
CEP_SYSTEM_PATH="/Library/Application Support/Adobe/CEP/extensions"
CEP_USER_PATH="$HOME/Library/Application Support/Adobe/CEP/extensions"
UPIA_PATH="/Library/Application Support/Adobe/Adobe Desktop Common/RemoteComponents/UPI/UnifiedPluginInstallerAgent/UnifiedPluginInstallerAgent.app/Contents/MacOS/UnifiedPluginInstallerAgent"

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

log "=== SPLICE Plugin Installation Started ==="

# Kill Premiere Pro if running (with user prompt would be handled by preflight check)
if pgrep -x "Adobe Premiere Pro" > /dev/null 2>&1; then
    log "Premiere Pro is running. Attempting to close..."
    osascript -e 'tell application "Adobe Premiere Pro" to quit' 2>/dev/null || true
    sleep 2
fi

# Function to install CEP extension
install_cep() {
    log "Installing CEP extension..."
    
    # Try system-wide first (requires admin), fall back to user directory
    if [ -d "$CEP_SOURCE" ]; then
        TARGET_PATH="$CEP_SYSTEM_PATH/$PLUGIN_NAME"
        
        # Create the extensions directory if it doesn't exist
        mkdir -p "$CEP_SYSTEM_PATH" 2>/dev/null || true
        
        # Remove old installation if exists
        if [ -d "$TARGET_PATH" ]; then
            log "Removing previous CEP installation..."
            rm -rf "$TARGET_PATH"
        fi
        
        # Copy new extension
        log "Copying CEP extension to $TARGET_PATH..."
        cp -R "$CEP_SOURCE" "$TARGET_PATH"
        
        # Set permissions
        chmod -R 755 "$TARGET_PATH"
        
        log "CEP extension installed successfully"
    else
        log "WARNING: CEP source not found at $CEP_SOURCE"
    fi
}

# Function to install UXP plugin
install_uxp() {
    log "Installing UXP plugin..."
    
    if [ -f "$UXP_CCX" ]; then
        if [ -f "$UPIA_PATH" ]; then
            log "Using UnifiedPluginInstallerAgent to install UXP..."
            "$UPIA_PATH" --install "$UXP_CCX" 2>&1 | tee -a "$LOG_FILE" || {
                log "WARNING: UPIA installation failed, UXP may need manual installation"
            }
            log "UXP plugin installation attempted via UPIA"
        else
            log "WARNING: UnifiedPluginInstallerAgent not found at $UPIA_PATH"
            log "UXP plugin may need manual installation via Creative Cloud Desktop"
            
            # Copy CCX to user's Downloads for manual installation
            DOWNLOADS_PATH="$HOME/Downloads"
            if [ -d "$DOWNLOADS_PATH" ]; then
                cp "$UXP_CCX" "$DOWNLOADS_PATH/SPLICE-Plugin.ccx"
                log "CCX file copied to Downloads folder for manual installation"
            fi
        fi
    else
        log "No UXP plugin found at $UXP_CCX, skipping UXP installation"
    fi
}

# Function to enable CEP debug mode (required for extensions not from Adobe Exchange)
enable_debug_mode() {
    log "Enabling CEP debug mode for SPLICE extension..."
    # Enable for all CSXS versions (Premiere Pro 2020-2025+)
    defaults write com.adobe.CSXS.11 PlayerDebugMode 1 2>/dev/null || true
    defaults write com.adobe.CSXS.10 PlayerDebugMode 1 2>/dev/null || true
    defaults write com.adobe.CSXS.9 PlayerDebugMode 1 2>/dev/null || true
    defaults write com.adobe.CSXS.8 PlayerDebugMode 1 2>/dev/null || true
    log "CEP debug mode enabled for all Adobe CC versions"
}

# Function to cleanup temporary files
cleanup() {
    log "Cleaning up temporary files..."
    rm -rf /tmp/splice-installer 2>/dev/null || true
    log "Cleanup complete"
}

# Main installation sequence
main() {
    # Install CEP extension
    install_cep
    
    # Install UXP plugin
    install_uxp
    
    # Enable debug mode if requested
    enable_debug_mode
    
    # Cleanup
    cleanup
    
    log "=== SPLICE Plugin Installation Complete ==="
    log "Please restart Adobe Premiere Pro to use SPLICE"
    log ""
    log "Find SPLICE at:"
    log "  - Premiere Pro 14-24: Window > Extensions > SPLICE"
    log "  - Premiere Pro 25+: Window > UXP Plugins > SPLICE"
}

# Run main installation
main

exit 0
