/**
 * SPLICE Phase 3 E2E Tests - Auto Zoom & Chapter Detection
 *
 * Tests:
 * 1. Zoom Generator Service
 *    - Zoom point generation from transcript
 *    - Frequency settings (low/medium/high)
 *    - Intensity presets (subtle/medium/dramatic)
 *    - Placement strategies (sentence_start/keywords/random)
 *
 * 2. Chapter Detection Service
 *    - AI-based chapter detection
 *    - Fallback gap-based detection
 *    - YouTube timestamp generation
 *    - Marker data format
 *
 * 3. API Endpoints
 *    - POST /zoom
 *    - GET /zoom/presets
 *    - POST /chapters
 *    - POST /chapters/fallback
 *
 * 4. UI Integration
 *    - Zoom settings toggle
 *    - Chapter settings toggle
 *    - Results display
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');

// Test utilities
function describe(name, fn) {
  console.log(`\n${'='.repeat(60)}\n  ${name}\n${'='.repeat(60)}`);
  fn();
}

function it(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    return true;
  } catch (err) {
    console.error(`  ✗ ${name}`);
    console.error(`    Error: ${err.message}`);
    return false;
  }
}

async function asyncIt(name, fn) {
  try {
    await fn();
    console.log(`  ✓ ${name}`);
    return true;
  } catch (err) {
    console.error(`  ✗ ${name}`);
    console.error(`    Error: ${err.message}`);
    return false;
  }
}

// Load services
const {
  generateZoomPoints,
  generateZoomKeyframes,
  addZoomsToCutList,
  easingCurve,
  ZOOM_PRESETS,
  ZOOM_FREQUENCIES
} = require('../services/zoomGenerator');

const {
  detectChaptersFallback,
  formatYouTubeTimestamps,
  extractText,
  validateChapters
} = require('../services/chapterDetection');

// Test data
const sampleTranscript = {
  duration: 300,
  text: 'Hello everyone. Welcome to today\'s tutorial. First, we\'ll cover the basics. This is important. Next, we\'ll dive into advanced topics. Finally, let\'s wrap up with a summary.',
  words: [
    { word: 'Hello', start: 0.5, end: 0.8 },
    { word: 'everyone.', start: 0.9, end: 1.3 },
    { word: 'Welcome', start: 1.5, end: 1.8 },
    { word: 'to', start: 1.9, end: 2.0 },
    { word: 'today\'s', start: 2.1, end: 2.5 },
    { word: 'tutorial.', start: 2.6, end: 3.1 },
    { word: 'First,', start: 5.0, end: 5.3 },
    { word: 'we\'ll', start: 5.4, end: 5.6 },
    { word: 'cover', start: 5.7, end: 6.0 },
    { word: 'the', start: 6.1, end: 6.2 },
    { word: 'basics.', start: 6.3, end: 6.8 },
    { word: 'This', start: 10.0, end: 10.2 },
    { word: 'is', start: 10.3, end: 10.4 },
    { word: 'important.', start: 10.5, end: 11.0 },
    { word: 'Next,', start: 60.0, end: 60.3 },
    { word: 'we\'ll', start: 60.4, end: 60.6 },
    { word: 'dive', start: 60.7, end: 60.9 },
    { word: 'into', start: 61.0, end: 61.2 },
    { word: 'advanced', start: 61.3, end: 61.7 },
    { word: 'topics.', start: 61.8, end: 62.3 },
    { word: 'Finally,', start: 180.0, end: 180.5 },
    { word: 'let\'s', start: 180.6, end: 180.8 },
    { word: 'wrap', start: 180.9, end: 181.1 },
    { word: 'up', start: 181.2, end: 181.3 },
    { word: 'with', start: 181.4, end: 181.6 },
    { word: 'a', start: 181.7, end: 181.8 },
    { word: 'summary.', start: 181.9, end: 182.5 }
  ],
  segments: [
    { start: 0, end: 5, text: 'Hello everyone. Welcome to today\'s tutorial.' },
    { start: 5, end: 12, text: 'First, we\'ll cover the basics. This is important.' },
    { start: 60, end: 65, text: 'Next, we\'ll dive into advanced topics.' },
    { start: 180, end: 185, text: 'Finally, let\'s wrap up with a summary.' }
  ]
};

const sampleTranscriptWithGaps = {
  duration: 300,
  segments: [
    { start: 0, end: 50, text: 'Introduction content here.' },
    { start: 55, end: 100, text: 'First main topic discussion.' },
    { start: 110, end: 180, text: 'Second main topic content.' },
    { start: 190, end: 295, text: 'Conclusion and summary.' }
  ]
};

// Test counters
let passed = 0;
let failed = 0;

// ============================================================================
// ZOOM GENERATOR TESTS
// ============================================================================
describe('Zoom Generator Service', () => {

  it('should export all required functions', () => {
    assert(typeof generateZoomPoints === 'function');
    assert(typeof generateZoomKeyframes === 'function');
    assert(typeof addZoomsToCutList === 'function');
    assert(typeof easingCurve === 'function');
    passed++;
  });

  it('should have correct zoom presets', () => {
    assert(ZOOM_PRESETS.subtle);
    assert(ZOOM_PRESETS.medium);
    assert(ZOOM_PRESETS.dramatic);
    assert.strictEqual(ZOOM_PRESETS.subtle.scale, 110);
    assert.strictEqual(ZOOM_PRESETS.medium.scale, 120);
    assert.strictEqual(ZOOM_PRESETS.dramatic.scale, 140);
    passed++;
  });

  it('should have correct zoom frequencies', () => {
    assert(ZOOM_FREQUENCIES.low);
    assert(ZOOM_FREQUENCIES.medium);
    assert(ZOOM_FREQUENCIES.high);
    assert.strictEqual(ZOOM_FREQUENCIES.low, 60);
    assert.strictEqual(ZOOM_FREQUENCIES.medium, 30);
    assert.strictEqual(ZOOM_FREQUENCIES.high, 15);
    passed++;
  });

  it('should generate zoom points from transcript', () => {
    const points = generateZoomPoints(sampleTranscript, { frequency: 'medium', preset: 'medium' });
    assert(Array.isArray(points));
    assert(points.length > 0);
    passed++;
  });

  it('should return empty array for empty transcript', () => {
    const points = generateZoomPoints({}, {});
    assert(Array.isArray(points));
    assert.strictEqual(points.length, 0);
    passed++;
  });

  it('should respect frequency setting', () => {
    const lowPoints = generateZoomPoints(sampleTranscript, { frequency: 'low' });
    const highPoints = generateZoomPoints(sampleTranscript, { frequency: 'high', minGap: 10 });
    // High frequency should generate more points (with reasonable minGap)
    assert(lowPoints.length <= highPoints.length || lowPoints.length === highPoints.length);
    passed++;
  });

  it('should apply correct preset values to zoom points', () => {
    const points = generateZoomPoints(sampleTranscript, { preset: 'dramatic' });
    if (points.length > 0) {
      assert.strictEqual(points[0].scale, ZOOM_PRESETS.dramatic.scale);
      assert.strictEqual(points[0].duration, ZOOM_PRESETS.dramatic.duration);
    }
    passed++;
  });

  it('should use sentence_start placement by default', () => {
    const points = generateZoomPoints(sampleTranscript, {});
    if (points.length > 0) {
      assert(points[0].reason.includes('sentence_start') || points[0].reason === 'emphasis');
    }
    passed++;
  });

  it('should exclude zoom points near start and end', () => {
    const settings = { excludeFirstSeconds: 3, excludeLastSeconds: 2 };
    const points = generateZoomPoints(sampleTranscript, settings);
    for (const point of points) {
      assert(point.startTime >= 3);
      assert(point.startTime <= sampleTranscript.duration - 2);
    }
    passed++;
  });

  it('should generate keyframes for zoom animation', () => {
    const zoom = {
      startTime: 10,
      duration: 0.8,
      scale: 120,
      easing: 3,
      centerPoint: { x: 0.5, y: 0.5 }
    };
    const keyframes = generateZoomKeyframes(zoom, 30);
    assert(Array.isArray(keyframes));
    assert(keyframes.length > 0);
    // First keyframe should start at zoom startTime
    assert(keyframes[0].time >= zoom.startTime);
    passed++;
  });

  it('should add zooms to cut list', () => {
    const cutList = { version: '3.5', segments: [] };
    const zoomPoints = [{ startTime: 5, scale: 120, duration: 0.8 }];
    const result = addZoomsToCutList(cutList, zoomPoints);
    assert(result.zooms);
    assert.strictEqual(result.zooms.length, 1);
    assert(result.metadata.hasZooms);
    assert.strictEqual(result.metadata.zoomCount, 1);
    passed++;
  });

  it('should calculate easing curve correctly', () => {
    // t=0 should return 0-ish, t=1 should return close to 1
    const start = easingCurve(0, 3);
    const end = easingCurve(1, 3);
    assert(start >= 0 && start < 0.1);
    assert(end > 0.9);
    passed++;
  });
});

// ============================================================================
// CHAPTER DETECTION TESTS
// ============================================================================
describe('Chapter Detection Service', () => {

  it('should export all required functions', () => {
    assert(typeof detectChaptersFallback === 'function');
    assert(typeof formatYouTubeTimestamps === 'function');
    assert(typeof extractText === 'function');
    assert(typeof validateChapters === 'function');
    passed++;
  });

  it('should extract text from transcript object', () => {
    const text1 = extractText({ text: 'Hello world' });
    assert.strictEqual(text1, 'Hello world');

    const text2 = extractText({ segments: [{ text: 'Part 1' }, { text: 'Part 2' }] });
    assert(text2.includes('Part 1'));
    assert(text2.includes('Part 2'));

    const text3 = extractText({ words: [{ word: 'Hello' }, { word: 'there' }] });
    assert(text3.includes('Hello'));
    assert(text3.includes('there'));
    passed++;
  });

  it('should detect chapters using fallback method', () => {
    const result = detectChaptersFallback(sampleTranscriptWithGaps, { minChapterLength: 30, gapThreshold: 3 });
    assert(result.chapters);
    assert(result.chapters.length >= 1);
    assert(result.youtubeTimestamps);
    assert(result.markers);
    assert(result.metadata.method === 'fallback');
    passed++;
  });

  it('should format YouTube timestamps correctly', () => {
    const chapters = [
      { startTime: 0, title: 'Intro' },
      { startTime: 65, title: 'Main Topic' },
      { startTime: 3700, title: 'Long Video Section' }
    ];
    const timestamps = formatYouTubeTimestamps(chapters);
    assert(timestamps.includes('0:00 Intro'));
    assert(timestamps.includes('1:05 Main Topic'));
    assert(timestamps.includes('1:01:40 Long Video Section'));
    passed++;
  });

  it('should validate chapters and ensure first starts at 0', () => {
    const rawChapters = [
      { startTime: 30, title: 'First Topic' },
      { startTime: 90, title: 'Second Topic' }
    ];
    const validated = validateChapters(rawChapters, 300, 30);
    assert.strictEqual(validated[0].startTime, 0);
    assert(validated.length >= 2);
    passed++;
  });

  it('should filter out chapters too close together', () => {
    const rawChapters = [
      { startTime: 0, title: 'Intro' },
      { startTime: 10, title: 'Too Close' },
      { startTime: 120, title: 'Valid' }
    ];
    const validated = validateChapters(rawChapters, 300, 60);
    // Should have intro and valid, but not "Too Close"
    assert(validated.length <= 3);
    const titles = validated.map(c => c.title);
    assert(titles.includes('Intro') || validated[0].startTime === 0);
    passed++;
  });

  it('should handle empty transcript gracefully', () => {
    const result = detectChaptersFallback({ segments: [] }, {});
    assert(result.chapters.length >= 1);
    assert.strictEqual(result.chapters[0].startTime, 0);
    passed++;
  });

  it('should generate marker data for timeline', () => {
    const result = detectChaptersFallback(sampleTranscriptWithGaps, {});
    assert(result.markers);
    assert(result.markers.length === result.chapters.length);
    for (const marker of result.markers) {
      assert(marker.time !== undefined);
      assert(marker.name);
    }
    passed++;
  });

  it('should truncate long chapter titles', () => {
    const rawChapters = [
      {
        startTime: 0,
        title: 'This is a very long chapter title that exceeds the maximum allowed length and should be truncated'
      }
    ];
    const validated = validateChapters(rawChapters, 300, 30);
    assert(validated[0].title.length <= 50);
    passed++;
  });
});

// ============================================================================
// UI INTEGRATION TESTS (Static Analysis)
// ============================================================================
describe('UI Integration (Static Analysis)', () => {

  it('should have zoom UI elements in index.html', () => {
    const htmlPath = path.join(__dirname, '../../splice-plugin/index.html');
    const html = fs.readFileSync(htmlPath, 'utf8');
    assert(html.includes('id="enableZoom"'));
    assert(html.includes('id="zoomSettings"'));
    assert(html.includes('id="zoomFrequency"'));
    assert(html.includes('id="zoomPreset"'));
    assert(html.includes('id="zoomPlacement"'));
    assert(html.includes('id="zoomResults"'));
    assert(html.includes('id="applyZoomsBtn"'));
    passed++;
  });

  it('should have chapter UI elements in index.html', () => {
    const htmlPath = path.join(__dirname, '../../splice-plugin/index.html');
    const html = fs.readFileSync(htmlPath, 'utf8');
    assert(html.includes('id="enableChapters"'));
    assert(html.includes('id="chapterSettings"'));
    assert(html.includes('id="maxChapters"'));
    assert(html.includes('id="minChapterLength"'));
    assert(html.includes('id="chapterResults"'));
    assert(html.includes('id="copyYouTubeBtn"'));
    assert(html.includes('id="addChapterMarkersBtn"'));
    passed++;
  });

  it('should have YouTube timestamps display area', () => {
    const htmlPath = path.join(__dirname, '../../splice-plugin/index.html');
    const html = fs.readFileSync(htmlPath, 'utf8');
    assert(html.includes('id="youtubeTimestamps"'));
    assert(html.includes('id="timestampText"'));
    passed++;
  });

  it('should cache zoom UI elements in main.js', () => {
    const mainPath = path.join(__dirname, '../../splice-plugin/js/main.js');
    const main = fs.readFileSync(mainPath, 'utf8');
    assert(main.includes("ui.enableZoom = document.getElementById('enableZoom')"));
    assert(main.includes("ui.zoomSettings = document.getElementById('zoomSettings')"));
    assert(main.includes("ui.zoomFrequency = document.getElementById('zoomFrequency')"));
    passed++;
  });

  it('should cache chapter UI elements in main.js', () => {
    const mainPath = path.join(__dirname, '../../splice-plugin/js/main.js');
    const main = fs.readFileSync(mainPath, 'utf8');
    assert(main.includes("ui.enableChapters = document.getElementById('enableChapters')"));
    assert(main.includes("ui.chapterSettings = document.getElementById('chapterSettings')"));
    assert(main.includes("ui.maxChapters = document.getElementById('maxChapters')"));
    passed++;
  });

  it('should have initZoomUI and initChapterUI functions', () => {
    const mainPath = path.join(__dirname, '../../splice-plugin/js/main.js');
    const main = fs.readFileSync(mainPath, 'utf8');
    assert(main.includes('function initZoomUI()'));
    assert(main.includes('function initChapterUI()'));
    assert(main.includes('initZoomUI();'));
    assert(main.includes('initChapterUI();'));
    passed++;
  });

  it('should have getZoomSettings and getChapterSettings functions', () => {
    const mainPath = path.join(__dirname, '../../splice-plugin/js/main.js');
    const main = fs.readFileSync(mainPath, 'utf8');
    assert(main.includes('function getZoomSettings()'));
    assert(main.includes('function getChapterSettings()'));
    passed++;
  });

  it('should have fetchZoomPoints and fetchChapters functions', () => {
    const mainPath = path.join(__dirname, '../../splice-plugin/js/main.js');
    const main = fs.readFileSync(mainPath, 'utf8');
    assert(main.includes('async function fetchZoomPoints('));
    assert(main.includes('async function fetchChapters('));
    passed++;
  });

  it('should have copyYouTubeTimestamps function', () => {
    const mainPath = path.join(__dirname, '../../splice-plugin/js/main.js');
    const main = fs.readFileSync(mainPath, 'utf8');
    assert(main.includes('async function copyYouTubeTimestamps()'));
    passed++;
  });

  it('should have addChapterMarkers function', () => {
    const mainPath = path.join(__dirname, '../../splice-plugin/js/main.js');
    const main = fs.readFileSync(mainPath, 'utf8');
    assert(main.includes('async function addChapterMarkers()'));
    passed++;
  });
});

// ============================================================================
// BUILDER INTEGRATION TESTS (Static Analysis)
// ============================================================================
describe('Builder Integration (Static Analysis)', () => {

  it('should have applyZoomKeyframes function in builder.js', () => {
    const builderPath = path.join(__dirname, '../../splice-plugin/js/builder.js');
    const builder = fs.readFileSync(builderPath, 'utf8');
    assert(builder.includes('async function applyZoomKeyframes('));
    passed++;
  });

  it('should have applyChapterMarkers function in builder.js', () => {
    const builderPath = path.join(__dirname, '../../splice-plugin/js/builder.js');
    const builder = fs.readFileSync(builderPath, 'utf8');
    assert(builder.includes('async function applyChapterMarkers('));
    passed++;
  });

  it('should export applyZoomKeyframes in window.spliceBuilder', () => {
    const builderPath = path.join(__dirname, '../../splice-plugin/js/builder.js');
    const builder = fs.readFileSync(builderPath, 'utf8');
    assert(builder.includes('applyZoomKeyframes,'));
    passed++;
  });

  it('should export applyChapterMarkers in window.spliceBuilder', () => {
    const builderPath = path.join(__dirname, '../../splice-plugin/js/builder.js');
    const builder = fs.readFileSync(builderPath, 'utf8');
    assert(builder.includes('applyChapterMarkers,'));
    passed++;
  });
});

// ============================================================================
// SERVER ENDPOINT TESTS (Static Analysis)
// ============================================================================
describe('Server Endpoints (Static Analysis)', () => {

  it('should import zoom and chapter services', () => {
    const serverPath = path.join(__dirname, '../server.js');
    const server = fs.readFileSync(serverPath, 'utf8');
    assert(server.includes("require('./services/zoomGenerator')"));
    assert(server.includes("require('./services/chapterDetection')"));
    passed++;
  });

  it('should have POST /zoom endpoint', () => {
    const serverPath = path.join(__dirname, '../server.js');
    const server = fs.readFileSync(serverPath, 'utf8');
    assert(server.includes("app.post('/zoom'"));
    passed++;
  });

  it('should have GET /zoom/presets endpoint', () => {
    const serverPath = path.join(__dirname, '../server.js');
    const server = fs.readFileSync(serverPath, 'utf8');
    assert(server.includes("app.get('/zoom/presets'"));
    passed++;
  });

  it('should have POST /chapters endpoint', () => {
    const serverPath = path.join(__dirname, '../server.js');
    const server = fs.readFileSync(serverPath, 'utf8');
    assert(server.includes("app.post('/chapters'"));
    passed++;
  });

  it('should have POST /chapters/fallback endpoint', () => {
    const serverPath = path.join(__dirname, '../server.js');
    const server = fs.readFileSync(serverPath, 'utf8');
    assert(server.includes("app.post('/chapters/fallback'"));
    passed++;
  });

  it('should document zoom endpoints in API list', () => {
    const serverPath = path.join(__dirname, '../server.js');
    const server = fs.readFileSync(serverPath, 'utf8');
    assert(server.includes("'POST /zoom'"));
    assert(server.includes("'GET /zoom/presets'"));
    passed++;
  });

  it('should document chapter endpoints in API list', () => {
    const serverPath = path.join(__dirname, '../server.js');
    const server = fs.readFileSync(serverPath, 'utf8');
    assert(server.includes("'POST /chapters'"));
    assert(server.includes("'POST /chapters/fallback'"));
    passed++;
  });

  it('should protect zoom endpoint with requireCredits', () => {
    const serverPath = path.join(__dirname, '../server.js');
    const server = fs.readFileSync(serverPath, 'utf8');
    // Check that /zoom has requireCredits middleware
    assert(server.includes("app.post('/zoom', requireCredits"));
    passed++;
  });

  it('should protect chapters endpoint with requireCredits', () => {
    const serverPath = path.join(__dirname, '../server.js');
    const server = fs.readFileSync(serverPath, 'utf8');
    // Check that /chapters has requireCredits middleware
    assert(server.includes("app.post('/chapters', requireCredits"));
    passed++;
  });
});

// ============================================================================
// SUMMARY
// ============================================================================
console.log('\n' + '='.repeat(60));
console.log('  PHASE 3 E2E TEST RESULTS');
console.log('='.repeat(60));
console.log(`  Passed: ${passed}`);
console.log(`  Failed: ${failed}`);
console.log(`  Total:  ${passed + failed}`);
console.log('='.repeat(60));

if (failed > 0) {
  process.exit(1);
} else {
  console.log('\n  All Phase 3 tests passed!\n');
}
