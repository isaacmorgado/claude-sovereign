/**
 * Gets chapter detection parameters from UI settings
 * @returns {Object} Chapter detection parameters including scope, language, and marker settings
 */
async function test_45_get_chapters_params() {
    detect_chapters_params = {};
    console.log('test_45');

    try {
        // Get scope setting (in/out points vs full sequence)
        if ($('#setting-detect-chapters-scope-inout').is(':checked')) {
            detect_chapters_params.scope = 'inout';
        } else {
            detect_chapters_params.scope = 'full';
        }

        // Get titles/descriptions checkbox setting
        if ($('#checkbox-chapters-titles-descriptions').is(':checked')) {
            detect_chapters_params.titlesDescription = true;
        } else {
            detect_chapters_params.titlesDescription = false;
        }

        // Get language setting
        detect_chapters_params.language = 'en';
        detect_chapters_params.language = $('[name=\'setting-detect-chapters-language\']').val();

        // Get mark regions setting
        detect_chapters_params.mark_regions = $('#chapter-markers-region').is(':checked');

        // Get chapter count range settings
        const rangeElement = $('#range-chapters-count');
        const minBound = parseInt(rangeElement.attr('data-min'));
        const maxBound = parseInt(rangeElement.attr('data-max'));
        const currentMin = parseInt(rangeElement.attr('data-value-min'));
        const currentMax = parseInt(rangeElement.attr('data-value-max'));

        const isAtMinBound = currentMin === minBound;
        const isAtMaxBound = currentMax === maxBound;

        detect_chapters_params.chaptersMin = isAtMinBound ? null : currentMin;
        detect_chapters_params.chaptersMax = isAtMaxBound ? null : currentMax;

    } catch (error) {
        console.log('error while getting chapters parameters', error);
    }

    // Get in/out points based on scope
    if (detect_chapters_params.scope == 'inout') {
        detect_chapters_params.inPoint = await jsxExecute('app.project.activeSequence.getInPoint()');
        detect_chapters_params.outPoint = await jsxExecute('app.project.activeSequence.getOutPoint()');
    } else {
        detect_chapters_params.inPoint = await jsxExecute('app.project.activeSequence.getWorkAreaInPoint()');
        detect_chapters_params.outPoint = await jsxExecute('app.project.activeSequence.getWorkAreaOutPoint()');
    }

    // Ensure inPoint is not negative
    detect_chapters_params.inPoint = Math.max(detect_chapters_params.inPoint, 0);

    // Validate scope
    detect_chapters_params.scopeValid = true;

    if (detect_chapters_params.scope == 'inout') {
        // Check if in/out points are equal
        if (detect_chapters_params.inPoint == detect_chapters_params.outPoint) {
            detect_chapters_params.scopeValid = false;
        }
        // Check for negative values
        if (detect_chapters_params.inPoint < 0 || detect_chapters_params.outPoint < 0) {
            detect_chapters_params.scopeValid = false;
        }
        // Check if inPoint is after outPoint
        if (detect_chapters_params.inPoint > detect_chapters_params.outPoint) {
            detect_chapters_params.scopeValid = false;
        }
    }

    console.log(detect_chapters_params);
    return detect_chapters_params;
}

/**
 * Reads chapter data from HTML inputs
 * @returns {Array} Array of chapter objects with name and time properties
 */
function chapter_markers_read_HTML() {
    chapters = [];

    $('.chapter').each(function(index) {
        let chapter = {
            'name': $(this).find('.chapter-name').val(),
            'time': parseInt(timeConversion($(this).find('.chapter-time').val(), 'hh:mm:ss', 's'))
        };

        console.log('chapter parsed as: ', chapter);

        if (isNaN(chapter.time)) {
            throw new Error('Chapter time is NaN');
        }

        chapters.push(chapter);
    });

    return chapters;
}

/**
 * Gets the selected MOGRT template from the chapter clip selection grid
 * @returns {string|null} The MOGRT attribute value or null if none selected
 */
function chaptersGetSelectedMogrt() {
    const clips = $('.chapters-add-clips-selection-grid-element');
    console.log('clips', clips);

    const selectedClip = Array.from(clips).find(clip => {
        return !$(clip).find('div div').hasClass('hidden');
    });

    if (selectedClip) {
        return selectedClip.getAttribute('mogrt');
    }

    return null;
}

/**
 * Writes chapter data to HTML table
 * @param {Array} chapters - Array of chapter objects
 */
function chapter_markers_write_HTML(chapters) {
    const tableBody = $('#chapters-result div tbody');
    tableBody.html('');

    // Sort chapters by time, with newly added chapters at the end
    chapters.sort(function(chapterA, chapterB) {
        if (chapterA.hasOwnProperty('newly_added_chapter_tag')) {
            return 1;
        } else if (chapterB.hasOwnProperty('newly_added_chapter_tag')) {
            return -1;
        } else if (chapterA.hasOwnProperty('time') && chapterB.hasOwnProperty('time')) {
            return chapterA.time - chapterB.time;
        } else if (chapterA.hasOwnProperty('time')) {
            return -1;
        } else {
            return chapterB.hasOwnProperty('time') ? 1 : 0;
        }
    });

    let html = '';

    for (let i = 0; i < chapters.length; i++) {
        let chapter = chapters[i];

        console.log('chapter number (i+1):', i + 1);
        console.log('chapter:', chapter);

        if (!chapter.hasOwnProperty('name')) {
            console.log('Chapter data is missing name (and maybe even time). Skipping.');
            continue;
        }

        if (!chapter.hasOwnProperty('time')) {
            console.log('Chapter data has name but is missing time. Skipping.');
            continue;
        }

        html += `
          <tr class="chapter" chapter-number="${i + 1}">
              <td class="p-1 text-left">
                  ${i + 1}
              </td>
              <td class="px-1 font-medium text-gray-900 whitespace-nowrap">
                  <input class="chapter-name h-6 px-1 w-full rounded-md bg-shorts-500 text-sm leading-tight text-white active:text-white focus:text-white hover:bg-shorts-400 focus:border-shorts-600 focus:bg-shorts-400 focus:outline-none" type="text" value="${chapter.name}" />
              </td>
              <td class="p-1 flex justify-end">
                  <input class="chapter-time px-1 w-16 h-6 text-right rounded-md bg-shorts-500 text-sm leading-tight text-white active:text-white focus:text-white hover:bg-shorts-400 focus:border-shorts-600 focus:bg-shorts-400 focus:outline-none" type="text" value="${timeConversion(chapter.time, 's', 'hh:mm:ss')}" />
              </td>
              <td class="ps-1 w-7">
                <button class="button-chapter-delete m-0 h-6 rounded-md w-full px-1 text-white border border-shorts-400 bg-shorts-500 transition-colors duration-100 hover:border-shorts-300 hover:bg-shorts-400 active:border-shorts-500 active:bg-shorts-600 disabled:opacity-50"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAx0lEQVR4nO3Vu05CQRCA4X0aQgtiARIK0UgCvv8T2HGJBlCrz2y45CCXAOfW7F9tMdl/ZzKzE0IikagKNDG4If4B7bzSBj6wwvCK+BZmWKCTRzzA0oYof74Q+7gVRn4wulscwRO+theu8RJOlzdmGvnFeyg Ch/KYzfifdF64dAd6+MzIJ6VLz2T+nXlIPL+FMkE3I9xnX6r0RMmrEauj1I47u/zmcjzLr1XMcD8jXZ35QNqFytX1ZbpvSUxzL4na1mIikQg38Adi/+ESgabdTwAAAABJRU5ErkJggg==" alt="multiply" class="w-6"></button>
              </td>
          </tr>
          `;
    }

    tableBody.html(html);

    // Add click listener to chapter names to set midpoint
    $('.chapter-name').on('click', function() {
        const timeValue = $(this).closest('.chapter').find('.chapter-time').val();

        if (!isValidTimeFormat(timeValue, 'hh:mm:ss')) {
            return;
        }

        let timeInSeconds = parseInt(timeConversion(timeValue, 'hh:mm:ss', 's'));
        set_midpoint(timeInSeconds);
    });

    $('#chapters-result').removeClass('hidden');
    place_colour_select_circle();
    set_chapter_delete_listeners();
}

/**
 * Renders chapter clip selection grid with video previews
 * @param {Array} clips - Array of clip objects with mogrt, name, and preview properties
 */
function renderChapterClips(clips) {
    const grid = $('#chapters-add-clips-selection-grid');

    grid.html(clips.map((clip, index) => {
        const { mogrt, name, preview } = clip;

        return `
        <div mogrt="${mogrt}" class="chapters-add-clips-selection-grid-element flex flex-col justify-center hover:brightness-125 bg-shorts-700 rounded-lg cursor-pointer">
          <div class="relative">
            <video autoplay loop muted class="rounded-lg w-full" style={{ maxWidth: "unset" }}>
              <source src="${preview}" type="video/mp4" />
            </video>
            <div class="${index === 0 ? '' : 'hidden'} border-8 border-green-500 top-0 left-0 absolute w-full h-full rounded-lg" style=""></div>
          </div>
          <span class="text-center text-white">${name}</span>
        </div>
      `;
    }));

    $('#chapters-add-clips-selection-spinner').addClass('hidden');

    const addButton = $('#chapters-add-clips-button');
    addButton.removeAttr('disabled');
    addButton.removeClass('bg-gray-500');
    addButton.addClass('bg-purple-500 hover:bg-purple-400 active:bg-purple-600 ');

    set_chapter_clip_selection_listeners();
}

/**
 * Updates chapter titles and descriptions in the UI
 * @param {string} chapterType - The type of chapter (long/short)
 * @param {Object} response - Response containing titles and descriptions data
 */
function updateChaptersTitlesDescription(chapterType, response) {
    const titles = response.data.titles;
    const description = response.data.descriptions[0].description;

    titles.forEach((titleData, index) => {
        const titleElement = $('#chapters-title-option-' + chapterType + '-' + index);
        titleElement.html(titleData.title);

        // Filter for positive sentiment indicators
        const positiveSentiments = titleData.sentiment.filter(sentiment => {
            return Object.values(sentiment)[0] === true;
        });

        if (positiveSentiments.length > 0) {
            titleElement.siblings('hr').removeClass('hidden');
            titleElement.siblings('div').removeClass('hidden');
            titleElement.siblings('div').children().addClass('hidden');

            positiveSentiments.forEach(sentiment => {
                const sentimentKey = Object.keys(sentiment)[0];
                titleElement.siblings('div').children('.sentiment-' + sentimentKey).removeClass('hidden');
            });
        } else {
            titleElement.siblings('hr').addClass('hidden');
            titleElement.siblings('div').addClass('hidden');
        }
    });

    $('#chapters-description-' + chapterType).html(description);

    try {
        g_title_desc[chapterType] = response.data;
    } catch (error) {
        console.log('Error in updateChaptersTitlesDescription', error);
    }
}
