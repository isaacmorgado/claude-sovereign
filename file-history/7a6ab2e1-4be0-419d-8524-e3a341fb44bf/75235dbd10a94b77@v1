#!/usr/bin/env python3
"""
Create NICKJ referral code: 40% off first month
Run with: python scripts/create_nickj_code.py
"""

import asyncio
import sys
sys.path.insert(0, '.')

from uuid import uuid4
from sqlalchemy import select
from app.database import async_session
from app.models.user import ReferralCode
from app.config import get_settings

# Optional: Create Stripe promo if configured
try:
    import stripe
    settings = get_settings()
    stripe.api_key = settings.stripe_secret_key
    HAS_STRIPE = bool(settings.stripe_secret_key)
except:
    HAS_STRIPE = False


async def create_nickj_code():
    async with async_session() as db:
        # Check if code already exists
        result = await db.execute(
            select(ReferralCode).where(ReferralCode.code == "NICKJ")
        )
        existing = result.scalar_one_or_none()

        if existing:
            print(f"Code NICKJ already exists! ID: {existing.id}")
            print(f"  Discount: {existing.discount_percent}%")
            print(f"  Active: {existing.is_active}")
            print(f"  Uses: {existing.total_uses}")
            return

        stripe_coupon_id = None
        stripe_promo_id = None

        # Create Stripe coupon and promo code
        if HAS_STRIPE:
            try:
                # Create coupon (40% off, once = first payment only)
                coupon = stripe.Coupon.create(
                    percent_off=40,
                    duration="once",
                    name="NICKJ - 40% Off First Month",
                    metadata={
                        "influencer": "Nick J",
                        "referral_code": "NICKJ",
                    }
                )
                stripe_coupon_id = coupon.id
                print(f"Created Stripe coupon: {coupon.id}")

                # Create promotion code
                promo = stripe.PromotionCode.create(
                    coupon=coupon.id,
                    code="NICKJ",
                    metadata={"influencer": "Nick J"}
                )
                stripe_promo_id = promo.id
                print(f"Created Stripe promo: {promo.id}")

            except stripe.error.StripeError as e:
                print(f"Stripe error (continuing without): {e}")
        else:
            print("Stripe not configured, creating DB entry only")

        # Create database entry
        referral = ReferralCode(
            id=uuid4(),
            code="NICKJ",
            influencer_name="Nick J",
            discount_percent=40,
            stripe_coupon_id=stripe_coupon_id,
            stripe_promotion_code_id=stripe_promo_id,
            is_active=True,
            total_uses=0,
        )

        db.add(referral)
        await db.commit()
        await db.refresh(referral)

        print(f"\nâœ… Created NICKJ referral code!")
        print(f"  ID: {referral.id}")
        print(f"  Discount: {referral.discount_percent}% off first month")
        print(f"  Stripe Coupon: {stripe_coupon_id or 'N/A'}")
        print(f"  Stripe Promo: {stripe_promo_id or 'N/A'}")


if __name__ == "__main__":
    asyncio.run(create_nickj_code())
