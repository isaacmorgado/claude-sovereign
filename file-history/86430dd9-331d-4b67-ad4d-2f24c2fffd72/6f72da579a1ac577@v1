/**
 * Settings Management
 *
 * Persists user preferences to localStorage
 * v3.5: Added Persistent Token support for media folder access
 */

const uxpFs = require('uxp').storage.localFileSystem;

const DEFAULT_SETTINGS = {
  sensitivity: 50,
  audioSource: 'original',
  autoMarkBest: true,
  enableTakesDetection: true,
  rememberOptions: false,
  optionsExpanded: false,
  customerId: null,          // Stripe customer ID for billing
  mediaFolderToken: null,    // Persistent token for media folder access
  mediaFolderPath: null      // Path to the media folder (for display)
};

let currentSettings = { ...DEFAULT_SETTINGS };

/**
 * Load settings from localStorage
 */
function loadSettings() {
  try {
    const saved = localStorage.getItem('spliceSettings');
    if (saved) {
      currentSettings = { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
    }
  } catch (e) {
    console.warn('[SPLICE] Could not load settings:', e);
    currentSettings = { ...DEFAULT_SETTINGS };
  }
  return currentSettings;
}

/**
 * Save settings to localStorage
 */
function saveSettings(settings) {
  try {
    currentSettings = { ...currentSettings, ...settings };
    localStorage.setItem('spliceSettings', JSON.stringify(currentSettings));
  } catch (e) {
    console.warn('[SPLICE] Could not save settings:', e);
  }
}

/**
 * Get current settings
 */
function getSettings() {
  return { ...currentSettings };
}

/**
 * Reset settings to defaults
 */
function resetSettings() {
  currentSettings = { ...DEFAULT_SETTINGS };
  try {
    localStorage.removeItem('spliceSettings');
  } catch (e) {
    console.warn('[SPLICE] Could not clear settings:', e);
  }
}

/**
 * Initialize settings UI components
 */
function initSettingsUI() {
  const settings = loadSettings();

  // Apply saved sensitivity to slider
  const sensitivitySlider = document.getElementById('sensitivitySlider');
  if (sensitivitySlider) {
    sensitivitySlider.value = settings.sensitivity;
  }

  // Apply saved audio source
  const sourceOriginal = document.getElementById('sourceOriginal');
  const sourceIsolated = document.getElementById('sourceIsolated');
  if (sourceOriginal && sourceIsolated) {
    sourceOriginal.checked = settings.audioSource === 'original' || settings.audioSource === 'both';
    sourceIsolated.checked = settings.audioSource === 'isolated' || settings.audioSource === 'both';
  }

  // Apply auto-mark best setting
  const autoMarkBest = document.getElementById('autoMarkBest');
  if (autoMarkBest) {
    autoMarkBest.checked = settings.autoMarkBest;
  }

  // Apply takes detection setting
  const enableTakesDetection = document.getElementById('enableTakesDetection');
  if (enableTakesDetection) {
    enableTakesDetection.checked = settings.enableTakesDetection;
  }

  // Apply remember options setting
  const rememberOptions = document.getElementById('rememberOptions');
  if (rememberOptions) {
    rememberOptions.checked = settings.rememberOptions;
  }

  // Restore expanded state if remember is enabled
  if (settings.rememberOptions && settings.optionsExpanded) {
    toggleOptionsPanel(true);
  }
}

/**
 * Toggle options panel visibility (unified panel)
 */
function toggleOptionsPanel(forceState) {
  const toggle = document.getElementById('optionsToggle');
  const panel = document.getElementById('optionsPanel');

  if (!toggle || !panel) return;

  const shouldExpand = forceState !== undefined ? forceState : panel.classList.contains('collapsed');

  if (shouldExpand) {
    panel.classList.remove('collapsed');
    toggle.classList.add('expanded');
  } else {
    panel.classList.add('collapsed');
    toggle.classList.remove('expanded');
  }

  // Save state if remember is enabled
  const settings = getSettings();
  if (settings.rememberOptions) {
    saveSettings({ optionsExpanded: shouldExpand });
  }
}

/**
 * Initialize settings modal
 */
function initSettingsModal() {
  const settingsBtn = document.getElementById('settingsBtn');
  const modal = document.getElementById('settingsModal');
  const closeBtn = document.getElementById('closeSettingsBtn');
  const defaultSensitivity = document.getElementById('defaultSensitivity');
  const rememberOptions = document.getElementById('rememberOptions');

  if (settingsBtn && modal) {
    settingsBtn.addEventListener('click', () => {
      modal.classList.remove('hidden');
      // Sync modal values with current settings
      const settings = getSettings();
      if (defaultSensitivity) defaultSensitivity.value = settings.sensitivity;
      if (rememberOptions) rememberOptions.checked = settings.rememberOptions;
    });
  }

  if (closeBtn && modal) {
    closeBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
  }

  // Close on backdrop click
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  }

  // Save default sensitivity when changed
  if (defaultSensitivity) {
    defaultSensitivity.addEventListener('change', () => {
      saveSettings({ sensitivity: parseInt(defaultSensitivity.value) });
      // Also update the main slider
      const mainSlider = document.getElementById('sensitivitySlider');
      if (mainSlider) mainSlider.value = defaultSensitivity.value;
    });
  }

  // Save remember options when changed
  if (rememberOptions) {
    rememberOptions.addEventListener('change', () => {
      saveSettings({ rememberOptions: rememberOptions.checked });
    });
  }
}

/**
 * Initialize options toggle (unified panel)
 */
function initOptionsToggles() {
  const toggle = document.getElementById('optionsToggle');

  if (toggle) {
    toggle.addEventListener('click', () => toggleOptionsPanel());
  }
}

/**
 * Initialize help button
 */
function initHelpButton() {
  const helpBtn = document.getElementById('helpBtn');
  if (helpBtn) {
    helpBtn.addEventListener('click', () => {
      setStatus('Silence: removes quiet gaps | Takes: detects repeated content');
    });
  }
}

// Load settings on script load
loadSettings();
