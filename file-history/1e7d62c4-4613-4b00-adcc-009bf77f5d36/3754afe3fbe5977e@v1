/**
 * Test Danny's license key login and update his hours
 */

require('dotenv').config();
const { Pool } = require('pg');

const sslConfig = process.env.NODE_ENV === 'production' ? {
  rejectUnauthorized: process.env.DATABASE_SSL_REJECT_UNAUTHORIZED === 'true',
  ca: process.env.DATABASE_SSL_CA || undefined
} : false;

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: sslConfig
});

async function main() {
  const client = await pool.connect();
  try {
    const DANNY_KEY = 'SPLICE-Y2Q9-6G9G-MFQE';
    const DANNY_CUSTOMER = 'cus_beta_danny_isakov';

    console.log('\n=== Danny Current Status ===');
    const current = await client.query(`
      SELECT
        stripe_customer_id,
        tier,
        hours_remaining,
        hours_total,
        isolation_hours_remaining,
        isolation_hours_total,
        email,
        email_verified
      FROM users
      WHERE stripe_customer_id = $1
    `, [DANNY_CUSTOMER]);

    if (current.rows.length === 0) {
      console.log('ERROR: Danny not found in database!');
      return;
    }

    const danny = current.rows[0];
    console.log(`Customer: ${danny.stripe_customer_id}`);
    console.log(`Tier: ${danny.tier}`);
    console.log(`Email: ${danny.email || 'Not set'}`);
    console.log(`Email Verified: ${danny.email_verified || false}`);
    console.log(`Hours: ${danny.hours_remaining || 0}/${danny.hours_total || 0}`);
    console.log(`Isolation Hours: ${danny.isolation_hours_remaining || 0}/${danny.isolation_hours_total || 0}`);

    // Update Danny with proper hours for team tier (unlimited)
    console.log('\n=== Updating Danny to Team Tier (Unlimited Hours) ===');
    await client.query(`
      UPDATE users
      SET
        tier = 'team',
        hours_remaining = 999999,
        hours_total = 999999,
        isolation_hours_remaining = 999999,
        isolation_hours_total = 999999,
        updated_at = NOW()
      WHERE stripe_customer_id = $1
    `, [DANNY_CUSTOMER]);

    console.log('✅ Danny updated with unlimited hours (team tier)');

    // Verify update
    const updated = await client.query(`
      SELECT
        stripe_customer_id,
        tier,
        hours_remaining,
        hours_total
      FROM users
      WHERE stripe_customer_id = $1
    `, [DANNY_CUSTOMER]);

    const danny2 = updated.rows[0];
    console.log(`\nVerified: ${danny2.tier} tier with ${danny2.hours_remaining}/${danny2.hours_total} hours`);

    // Check license key is still active
    console.log('\n=== License Key Status ===');
    const license = await client.query(`
      SELECT key, is_active, created_at
      FROM license_keys
      WHERE stripe_customer_id = $1
    `, [DANNY_CUSTOMER]);

    if (license.rows.length > 0) {
      const lic = license.rows[0];
      console.log(`Key: ${lic.key}`);
      console.log(`Active: ${lic.is_active}`);
      console.log(`Created: ${lic.created_at}`);
    }

    console.log('\n✅ Danny is ready to test!');
    console.log(`\nGive Danny this license key: ${DANNY_KEY}`);
    console.log('He should have unlimited access to all features.');

  } catch (err) {
    console.error('Error:', err);
  } finally {
    client.release();
    await pool.end();
  }
}

main();
