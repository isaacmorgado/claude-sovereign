#!/bin/bash
#
# Easy Vocal Separation Script with Smart Naming
# Usage: ./separate.sh <audio_file> [song_name]
#
# Examples:
#   ./separate.sh song.mp3
#   ./separate.sh song.mp3 "Artist - Song Title"
#   ./separate.sh https://youtu.be/VIDEO_ID "Artist - Song Title"
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_PYTHON="$SCRIPT_DIR/ultimatevocalremovergui/venv/bin/python"
INPUT="${1:-}"
CUSTOM_NAME="${2:-}"
MEDIAVAULT="$HOME/Desktop/MediaVault_v2"
OUTPUT_BASE="$MEDIAVAULT/separated_vocals"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘   Automated Vocal Separation Tool             â•‘${NC}"
echo -e "${BLUE}â•‘   Powered by Demucs AI                         â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Check if input is provided
if [ -z "$INPUT" ]; then
    echo -e "${RED}Error: No input file provided${NC}"
    echo
    echo "Usage: $0 <audio_file|youtube_url> [song_name]"
    echo
    echo "Examples:"
    echo "  $0 song.mp3"
    echo "  $0 song.mp3 \"Artist - Song Title\""
    echo "  $0 https://youtu.be/VIDEO_ID \"Artist - Song Title\""
    exit 1
fi

# Create MediaVault directory if it doesn't exist
mkdir -p "$OUTPUT_BASE"

# Generate timestamp and date
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
DATE_DIR=$(date +"%Y-%m-%d")

# Check if input is a YouTube URL
if [[ "$INPUT" =~ ^https?://(www\.)?(youtube\.com|youtu\.be) ]]; then
    echo -e "${YELLOW}ğŸ“¥ Downloading from YouTube...${NC}"
    TEMP_FILE="$SCRIPT_DIR/temp_download_${TIMESTAMP}.wav"

    # Try to get video title if no custom name provided
    if [ -z "$CUSTOM_NAME" ]; then
        VIDEO_TITLE=$(yt-dlp --get-title "$INPUT" 2>/dev/null || echo "youtube_download")
        # Clean up the title for use as filename
        CUSTOM_NAME=$(echo "$VIDEO_TITLE" | sed 's/[^a-zA-Z0-9 -]//g' | sed 's/  */ /g')
    fi

    yt-dlp -x --audio-format wav --audio-quality 0 -o "$TEMP_FILE" "$INPUT"
    INPUT="$TEMP_FILE"
    echo -e "${GREEN}âœ“ Download complete${NC}"
    echo
fi

# Check if input file exists
if [ ! -f "$INPUT" ]; then
    echo -e "${RED}Error: File not found: $INPUT${NC}"
    exit 1
fi

# Determine the song name for folder
if [ -n "$CUSTOM_NAME" ]; then
    # Use custom name, clean it up for filename
    SONG_NAME=$(echo "$CUSTOM_NAME" | sed 's/[^a-zA-Z0-9 _-]//g' | sed 's/  */ /g' | sed 's/^ *//;s/ *$//')
else
    # Use original filename without extension
    SONG_NAME=$(basename "$INPUT" | sed 's/\.[^.]*$//')
fi

# Create organized output structure
OUTPUT_DIR="$OUTPUT_BASE/$DATE_DIR/$SONG_NAME"
mkdir -p "$OUTPUT_DIR"

# Display info
echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${PURPLE}â•‘   Processing Configuration                     â•‘${NC}"
echo -e "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}Song Name:${NC}  $SONG_NAME"
echo -e "${BLUE}Input:${NC}     $(basename "$INPUT")"
echo -e "${BLUE}Date:${NC}      $DATE_DIR"
echo -e "${BLUE}Output:${NC}    $OUTPUT_DIR"
echo

# Run demucs to temp location first
echo -e "${YELLOW}ğŸµ Processing audio with AI (this may take 2-5 minutes)...${NC}"
echo

TEMP_OUTPUT="$SCRIPT_DIR/.temp_separation_$$"
"$VENV_PYTHON" -m demucs --two-stems=vocals -o "$TEMP_OUTPUT" "$INPUT" 2>&1 | grep -E "Separating|%|Downloading" || true

# Find the demucs output
INPUT_BASENAME=$(basename "$INPUT" | sed 's/\.[^.]*$//')
DEMUCS_OUTPUT="$TEMP_OUTPUT/htdemucs/$INPUT_BASENAME"

# Move and rename files with better names
if [ -d "$DEMUCS_OUTPUT" ]; then
    # Create organized output with better naming
    VOCALS_FILE="$OUTPUT_DIR/${SONG_NAME} - Vocals.wav"
    INSTRUMENTAL_FILE="$OUTPUT_DIR/${SONG_NAME} - Instrumental.wav"
    ORIGINAL_FILE="$OUTPUT_DIR/${SONG_NAME} - Original.wav"

    # Copy/move files with new names
    if [ -f "$DEMUCS_OUTPUT/vocals.wav" ]; then
        mv "$DEMUCS_OUTPUT/vocals.wav" "$VOCALS_FILE"
    fi

    if [ -f "$DEMUCS_OUTPUT/no_vocals.wav" ]; then
        mv "$DEMUCS_OUTPUT/no_vocals.wav" "$INSTRUMENTAL_FILE"
    fi

    # Copy original file for reference
    cp "$INPUT" "$ORIGINAL_FILE"

    # Clean up temp directory
    rm -rf "$TEMP_OUTPUT"

    # Create a metadata file
    cat > "$OUTPUT_DIR/info.txt" << EOF
Song: $SONG_NAME
Processed: $TIMESTAMP
Original File: $(basename "$INPUT")
AI Model: Demucs htdemucs
Quality: 44.1kHz, 16-bit stereo
EOF

    echo
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘   âœ“ Separation Complete!                      â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo -e "${BLUE}ğŸ“ Files saved to MediaVault_v2:${NC}"
    echo -e "   ğŸ“‚ Location:      ${PURPLE}$OUTPUT_DIR${NC}"
    echo -e "   ğŸ¤ Vocals:        ${GREEN}${SONG_NAME} - Vocals.wav${NC}"
    echo -e "   ğŸ¹ Instrumental:  ${GREEN}${SONG_NAME} - Instrumental.wav${NC}"
    echo -e "   ğŸµ Original:      ${GREEN}${SONG_NAME} - Original.wav${NC}"
    echo -e "   ğŸ“ Info:          ${GREEN}info.txt${NC}"
    echo

    # Show file sizes
    echo -e "${BLUE}ğŸ“Š File Sizes:${NC}"
    ls -lh "$OUTPUT_DIR" | tail -n +2 | awk '{printf "   %-30s %5s\n", $9, $5}'
    echo
else
    echo -e "${RED}Error: Demucs output not found${NC}"
    exit 1
fi

# Clean up temp file if it was a YouTube download
if [ -f "$SCRIPT_DIR"/temp_download_*.wav ]; then
    rm "$SCRIPT_DIR"/temp_download_*.wav
fi

echo -e "${BLUE}ğŸ’¡ Quick Actions:${NC}"
echo -e "   Open folder:  ${YELLOW}open \"$OUTPUT_DIR\"${NC}"
echo -e "   Play vocals:  ${YELLOW}open \"$VOCALS_FILE\"${NC}"
echo -e "   Play inst.:   ${YELLOW}open \"$INSTRUMENTAL_FILE\"${NC}"
echo
