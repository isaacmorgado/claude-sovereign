#!/usr/bin/env python3
"""
Automated Vocal Separation with Smart Naming
Extracts vocals and instrumentals from audio files
Saves to MediaVault_v2 with organized structure
"""

import os
import sys
import subprocess
import shutil
from pathlib import Path
from datetime import datetime


def separate_vocals(input_file, custom_name=None):
    """
    Separate vocals from music using demucs

    Args:
        input_file: Path to input audio file
        custom_name: Optional custom name for the song
    """
    input_path = Path(input_file).resolve()

    if not input_path.exists():
        print(f"‚ùå Error: Input file not found: {input_path}")
        sys.exit(1)

    # Setup paths
    script_dir = Path(__file__).parent
    venv_python = script_dir / "ultimatevocalremovergui" / "venv" / "bin" / "python"
    mediavault = Path.home() / "Desktop" / "MediaVault_v2"
    output_base = mediavault / "separated_vocals"

    # Generate timestamp and date
    timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    date_dir = datetime.now().strftime("%Y-%m-%d")

    # Determine song name
    if custom_name:
        # Clean up custom name
        song_name = "".join(
            c for c in custom_name if c.isalnum() or c in (" ", "-", "_")
        ).strip()
    else:
        # Use filename without extension
        song_name = input_path.stem

    # Create output directory structure
    output_dir = output_base / date_dir / song_name
    output_dir.mkdir(parents=True, exist_ok=True)

    print("=" * 60)
    print("Automated Vocal Separation with Smart Naming")
    print("=" * 60)
    print(f"Song Name:  {song_name}")
    print(f"Input:      {input_path.name}")
    print(f"Date:       {date_dir}")
    print(f"Output:     {output_dir}")
    print("=" * 60)
    print()

    # Create temp output directory
    temp_output = script_dir / f".temp_separation_{os.getpid()}"

    print("üéµ Processing audio with AI (this may take 2-5 minutes)...")
    print()

    # Run demucs
    try:
        cmd = [
            str(venv_python),
            "-m",
            "demucs",
            "--two-stems=vocals",
            "-o",
            str(temp_output),
            str(input_path),
        ]

        subprocess.run(cmd, check=True, capture_output=False, text=True)

        # Find demucs output
        input_basename = input_path.stem
        demucs_output = temp_output / "htdemucs" / input_basename

        if not demucs_output.exists():
            print(f"‚ùå Error: Demucs output not found at {demucs_output}")
            sys.exit(1)

        # Define final filenames with better naming
        vocals_file = output_dir / f"{song_name} - Vocals.wav"
        instrumental_file = output_dir / f"{song_name} - Instrumental.wav"
        original_file = output_dir / f"{song_name} - Original.wav"

        # Move and rename files
        vocals_src = demucs_output / "vocals.wav"
        instrumental_src = demucs_output / "no_vocals.wav"

        if vocals_src.exists():
            shutil.move(str(vocals_src), str(vocals_file))

        if instrumental_src.exists():
            shutil.move(str(instrumental_src), str(instrumental_file))

        # Copy original file
        shutil.copy2(str(input_path), str(original_file))

        # Clean up temp directory
        shutil.rmtree(temp_output)

        # Create metadata file
        info_file = output_dir / "info.txt"
        with open(info_file, "w") as f:
            f.write(f"Song: {song_name}\n")
            f.write(f"Processed: {timestamp}\n")
            f.write(f"Original File: {input_path.name}\n")
            f.write("AI Model: Demucs htdemucs\n")
            f.write("Quality: 44.1kHz, 16-bit stereo\n")

        print()
        print("=" * 60)
        print("‚úì Separation Complete!")
        print("=" * 60)
        print()
        print("üìÅ Files saved to MediaVault_v2:")
        print(f"   üìÇ Location:      {output_dir}")
        print(f"   üé§ Vocals:        {vocals_file.name}")
        print(f"   üéπ Instrumental:  {instrumental_file.name}")
        print(f"   üéµ Original:      {original_file.name}")
        print("   üìù Info:          info.txt")
        print()

        # Show file sizes
        print("üìä File Sizes:")
        for file in output_dir.iterdir():
            if file.is_file():
                size = file.stat().st_size
                size_mb = size / (1024 * 1024)
                print(f"   {file.name:<30} {size_mb:>6.1f} MB")
        print()

        print("üí° Quick Actions:")
        print(f'   Open folder:  open "{output_dir}"')
        print(f'   Play vocals:  open "{vocals_file}"')
        print(f'   Play inst.:   open "{instrumental_file}"')
        print()

    except subprocess.CalledProcessError as e:
        print(f"\n‚ùå Error during separation: {e}")
        if temp_output.exists():
            shutil.rmtree(temp_output)
        sys.exit(1)
    except Exception as e:
        print(f"\n‚ùå Unexpected error: {e}")
        if temp_output.exists():
            shutil.rmtree(temp_output)
        sys.exit(1)


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 auto_separate.py <audio_file> [song_name]")
        print()
        print("Examples:")
        print("  python3 auto_separate.py song.mp3")
        print('  python3 auto_separate.py song.mp3 "Artist - Song Title"')
        sys.exit(1)

    input_file = sys.argv[1]
    custom_name = sys.argv[2] if len(sys.argv) > 2 else None

    separate_vocals(input_file, custom_name)
