#!/bin/bash
#
# HIGH QUALITY Vocal Separation Script
# Uses BEST AI models for maximum quality
#
# Usage: ./separate_hq.sh <audio_file> [song_name]
#
# Models Used:
# - BS-Roformer-Viperx-1296 (12.1 SDR vocals, 16.3 SDR instrumental)
# - Best available models as of 2026
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_PYTHON="$SCRIPT_DIR/ultimatevocalremovergui/venv/bin/python"
AUDIO_SEP="$VENV_PYTHON -m audio_separator.separator"
INPUT="${1:-}"
CUSTOM_NAME="${2:-}"
MEDIAVAULT="$HOME/Desktop/MediaVault_v2"
OUTPUT_BASE="$MEDIAVAULT/separated_vocals_HQ"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘   HIGH QUALITY Vocal Separation Tool          â•‘${NC}"
echo -e "${CYAN}â•‘   BS-Roformer + MelBand Roformer               â•‘${NC}"
echo -e "${CYAN}â•‘   Maximum Quality AI Models                    â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Check if input is provided
if [ -z "$INPUT" ]; then
    echo -e "${RED}Error: No input file provided${NC}"
    echo
    echo "Usage: $0 <audio_file|youtube_url> [song_name]"
    echo
    echo "Examples:"
    echo "  $0 song.mp3"
    echo "  $0 song.mp3 \"Artist - Song Title\""
    echo "  $0 https://youtu.be/VIDEO_ID \"Artist - Song Title\""
    exit 1
fi

# Create MediaVault directory if it doesn't exist
mkdir -p "$OUTPUT_BASE"

# Generate timestamp and date
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
DATE_DIR=$(date +"%Y-%m-%d")

# Check if input is a YouTube URL
if [[ "$INPUT" =~ ^https?://(www\.)?(youtube\.com|youtu\.be) ]]; then
    echo -e "${YELLOW}ğŸ“¥ Downloading from YouTube...${NC}"
    TEMP_FILE="$SCRIPT_DIR/temp_download_${TIMESTAMP}.wav"

    # Try to get video title if no custom name provided
    if [ -z "$CUSTOM_NAME" ]; then
        VIDEO_TITLE=$(yt-dlp --get-title "$INPUT" 2>/dev/null || echo "youtube_download")
        # Clean up the title for use as filename
        CUSTOM_NAME=$(echo "$VIDEO_TITLE" | sed 's/[^a-zA-Z0-9 -]//g' | sed 's/  */ /g')
    fi

    yt-dlp -x --audio-format wav --audio-quality 0 -o "$TEMP_FILE" "$INPUT"
    INPUT="$TEMP_FILE"
    echo -e "${GREEN}âœ“ Download complete${NC}"
    echo
fi

# Check if input file exists
if [ ! -f "$INPUT" ]; then
    echo -e "${RED}Error: File not found: $INPUT${NC}"
    exit 1
fi

# Determine the song name for folder
if [ -n "$CUSTOM_NAME" ]; then
    # Use custom name, clean it up for filename
    SONG_NAME=$(echo "$CUSTOM_NAME" | sed 's/[^a-zA-Z0-9 _-]//g' | sed 's/  */ /g' | sed 's/^ *//;s/ *$//')
else
    # Use original filename without extension
    SONG_NAME=$(basename "$INPUT" | sed 's/\.[^.]*$//')
fi

# Create organized output structure
OUTPUT_DIR="$OUTPUT_BASE/$DATE_DIR/$SONG_NAME"
mkdir -p "$OUTPUT_DIR"

# Display info
echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${PURPLE}â•‘   Processing Configuration                     â•‘${NC}"
echo -e "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}Song Name:${NC}  $SONG_NAME"
echo -e "${BLUE}Input:${NC}     $(basename "$INPUT")"
echo -e "${BLUE}Date:${NC}      $DATE_DIR"
echo -e "${BLUE}Output:${NC}    $OUTPUT_DIR"
echo -e "${CYAN}Quality:${NC}   ${GREEN}MAXIMUM${NC} (BS-Roformer + MelBand)"
echo

echo -e "${YELLOW}ğŸµ Processing with HIGH QUALITY AI models...${NC}"
echo -e "${CYAN}   This will take longer but produce the cleanest results!${NC}"
echo -e "${CYAN}   Expected time: 5-10 minutes for a 3-4 min song${NC}"
echo

# Step 1: BS-Roformer-Viperx-1296 (Best Overall Quality)
echo -e "${YELLOW}[1/2] Running BS-Roformer-Viperx-1296 (Best Overall)...${NC}"
"$VENV_PYTHON" -m audio_separator.separator \
    --model_name "model_bs_roformer_ep_368_sdr_12.9628.ckpt" \
    --output_dir "$OUTPUT_DIR/temp_bs_roformer" \
    --output_format WAV \
    "$INPUT" 2>&1 | grep -E "Separating|Downloaded|Processing|completed" || true

echo -e "${GREEN}âœ“ BS-Roformer separation complete${NC}"
echo

# Step 2: MelBand Roformer for ultra-clean vocals
echo -e "${YELLOW}[2/2] Running MelBand Roformer (Best Vocals)...${NC}"
"$VENV_PYTHON" -m audio_separator.separator \
    --model_name "vocals_mel_band_roformer.ckpt" \
    --output_dir "$OUTPUT_DIR/temp_melband" \
    --output_format WAV \
    "$INPUT" 2>&1 | grep -E "Separating|Downloaded|Processing|completed" || true

echo -e "${GREEN}âœ“ MelBand Roformer separation complete${NC}"
echo

# Organize and rename files
echo -e "${YELLOW}Organizing files...${NC}"

# Define final filenames
VOCALS_BS="$OUTPUT_DIR/${SONG_NAME} - Vocals (BS-Roformer).wav"
INSTRUMENTAL_BS="$OUTPUT_DIR/${SONG_NAME} - Instrumental (BS-Roformer).wav"
VOCALS_MELBAND="$OUTPUT_DIR/${SONG_NAME} - Vocals (MelBand).wav"
ORIGINAL_FILE="$OUTPUT_DIR/${SONG_NAME} - Original.wav"

# Move BS-Roformer files
if [ -f "$OUTPUT_DIR/temp_bs_roformer"/*_Vocals.wav ]; then
    mv "$OUTPUT_DIR/temp_bs_roformer"/*_Vocals.wav "$VOCALS_BS"
fi

if [ -f "$OUTPUT_DIR/temp_bs_roformer"/*_Instrumental.wav ]; then
    mv "$OUTPUT_DIR/temp_bs_roformer"/*_Instrumental.wav "$INSTRUMENTAL_BS"
fi

# Move MelBand files
if [ -f "$OUTPUT_DIR/temp_melband"/*_Vocals.wav ]; then
    mv "$OUTPUT_DIR/temp_melband"/*_Vocals.wav "$VOCALS_MELBAND"
fi

# Copy original file
cp "$INPUT" "$ORIGINAL_FILE"

# Clean up temp directories
rm -rf "$OUTPUT_DIR/temp_bs_roformer" "$OUTPUT_DIR/temp_melband"

# Create a metadata file
cat > "$OUTPUT_DIR/info.txt" << EOF
Song: $SONG_NAME
Processed: $TIMESTAMP
Original File: $(basename "$INPUT")

AI Models Used:
- BS-Roformer-Viperx-1296 (SDR: Vocals 12.1, Instrumental 16.3)
- MelBand Roformer Vocals (SDR: Vocals 12.6)

Quality: MAXIMUM - Best available models as of 2026
Output Format: WAV, 44.1kHz, 16-bit stereo

Files Generated:
- Vocals (BS-Roformer): Excellent balanced quality
- Instrumental (BS-Roformer): Ultra-clean instrumental
- Vocals (MelBand): Maximum vocal clarity

Recommendation: Compare both vocal tracks and use whichever sounds better for your use case!
EOF

echo
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘   âœ“ HIGH QUALITY Separation Complete!         â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo
echo -e "${BLUE}ğŸ“ Files saved to MediaVault_v2:${NC}"
echo -e "   ğŸ“‚ Location:      ${PURPLE}$OUTPUT_DIR${NC}"
echo -e "   ğŸ¤ Vocals (BS):   ${GREEN}${SONG_NAME} - Vocals (BS-Roformer).wav${NC}"
echo -e "   ğŸ¤ Vocals (MB):   ${GREEN}${SONG_NAME} - Vocals (MelBand).wav${NC}"
echo -e "   ğŸ¹ Instrumental:  ${GREEN}${SONG_NAME} - Instrumental (BS-Roformer).wav${NC}"
echo -e "   ğŸµ Original:      ${GREEN}${SONG_NAME} - Original.wav${NC}"
echo -e "   ğŸ“ Info:          ${GREEN}info.txt${NC}"
echo

# Show file sizes
echo -e "${BLUE}ğŸ“Š File Sizes:${NC}"
ls -lh "$OUTPUT_DIR" | tail -n +2 | awk '{printf "   %-50s %5s\n", $9, $5}'
echo

# Clean up temp file if it was a YouTube download
if [ -f "$SCRIPT_DIR"/temp_download_*.wav ]; then
    rm "$SCRIPT_DIR"/temp_download_*.wav
fi

echo -e "${CYAN}ğŸ’¡ Quality Notes:${NC}"
echo -e "   â€¢ ${GREEN}BS-Roformer${NC} - Best overall balance (vocals + instrumental)"
echo -e "   â€¢ ${GREEN}MelBand${NC} - Maximum vocal clarity and detail"
echo -e "   â€¢ Compare both vocal tracks to choose your favorite!"
echo
echo -e "${BLUE}ğŸ¯ Quick Actions:${NC}"
echo -e "   Open folder:      ${YELLOW}open \"$OUTPUT_DIR\"${NC}"
echo -e "   Play BS vocals:   ${YELLOW}open \"$VOCALS_BS\"${NC}"
echo -e "   Play MB vocals:   ${YELLOW}open \"$VOCALS_MELBAND\"${NC}"
echo -e "   Play inst.:       ${YELLOW}open \"$INSTRUMENTAL_BS\"${NC}"
echo
