#!/bin/bash
#
# Easy Vocal Separation Script
# Usage: ./separate.sh <audio_file> [output_directory]
#
# Examples:
#   ./separate.sh song.mp3
#   ./separate.sh song.mp3 my_output
#   ./separate.sh https://youtu.be/VIDEO_ID
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_PYTHON="$SCRIPT_DIR/ultimatevocalremovergui/venv/bin/python"
INPUT="${1:-}"
OUTPUT_DIR="${2:-$SCRIPT_DIR/separated_output}"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘   Automated Vocal Separation Tool             â•‘${NC}"
echo -e "${BLUE}â•‘   Powered by Demucs AI                         â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Check if input is provided
if [ -z "$INPUT" ]; then
    echo -e "${RED}Error: No input file provided${NC}"
    echo
    echo "Usage: $0 <audio_file|youtube_url> [output_directory]"
    echo
    echo "Examples:"
    echo "  $0 song.mp3"
    echo "  $0 song.mp3 my_output"
    echo "  $0 https://youtu.be/VIDEO_ID"
    exit 1
fi

# Check if input is a YouTube URL
if [[ "$INPUT" =~ ^https?://(www\.)?(youtube\.com|youtu\.be) ]]; then
    echo -e "${YELLOW}ğŸ“¥ Downloading from YouTube...${NC}"
    TEMP_FILE="$SCRIPT_DIR/temp_download.wav"
    yt-dlp -x --audio-format wav --audio-quality 0 -o "$TEMP_FILE" "$INPUT"
    INPUT="$TEMP_FILE"
    echo -e "${GREEN}âœ“ Download complete${NC}"
    echo
fi

# Check if input file exists
if [ ! -f "$INPUT" ]; then
    echo -e "${RED}Error: File not found: $INPUT${NC}"
    exit 1
fi

# Display info
echo -e "${BLUE}Input:${NC}  $INPUT"
echo -e "${BLUE}Output:${NC} $OUTPUT_DIR"
echo

# Run demucs
echo -e "${YELLOW}ğŸµ Processing audio (this may take 2-5 minutes)...${NC}"
echo

"$VENV_PYTHON" -m demucs --two-stems=vocals -o "$OUTPUT_DIR" "$INPUT"

# Find output files
SONG_NAME=$(basename "$INPUT" | sed 's/\.[^.]*$//')
OUTPUT_PATH="$OUTPUT_DIR/htdemucs/$SONG_NAME"

echo
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘   âœ“ Separation Complete!                      â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo
echo -e "${BLUE}ğŸ“ Output files:${NC}"
echo -e "   ğŸ¤ Vocals:        ${GREEN}$OUTPUT_PATH/vocals.wav${NC}"
echo -e "   ğŸ¹ Instrumental:  ${GREEN}$OUTPUT_PATH/no_vocals.wav${NC}"
echo

# Clean up temp file if it was a YouTube download
if [ -f "$SCRIPT_DIR/temp_download.wav" ]; then
    rm "$SCRIPT_DIR/temp_download.wav"
fi

echo -e "${BLUE}ğŸ’¡ Tip:${NC} You can play these files with: open \"$OUTPUT_PATH/vocals.wav\""
echo
