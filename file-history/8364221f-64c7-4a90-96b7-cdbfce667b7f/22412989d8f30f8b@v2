#!/usr/bin/env python3
"""
Automated Vocal Separation using Demucs
Extracts vocals and instrumentals from audio files
"""

import sys
import subprocess
from pathlib import Path


def separate_vocals(input_file, output_dir):
    """
    Separate vocals from music using demucs

    Args:
        input_file: Path to input audio file
        output_dir: Path to output directory
    """
    input_path = Path(input_file).resolve()
    output_path = Path(output_dir).resolve()

    if not input_path.exists():
        print(f"Error: Input file not found: {input_path}")
        sys.exit(1)

    # Create output directory
    output_path.mkdir(parents=True, exist_ok=True)

    print("=" * 60)
    print("Automated Vocal Separation with Demucs")
    print("=" * 60)
    print(f"Input:  {input_path}")
    print(f"Output: {output_path}")
    print("=" * 60)
    print()

    # Get the venv python path
    script_dir = Path(__file__).parent
    venv_python = script_dir / "ultimatevocalremovergui" / "venv" / "bin" / "python"

    # Install demucs if not already installed
    print("Checking demucs installation...")
    try:
        result = subprocess.run(
            [str(venv_python), "-m", "demucs", "--help"], capture_output=True, text=True
        )
        if result.returncode != 0:
            print("Installing demucs...")
            subprocess.run(
                [str(venv_python), "-m", "pip", "install", "demucs"], check=True
            )
    except Exception as e:
        print(f"Error installing demucs: {e}")
        sys.exit(1)

    print("\nStarting separation process...")
    print("This may take 2-5 minutes depending on your Mac's speed...")
    print()

    # Run demucs
    try:
        cmd = [
            str(venv_python),
            "-m",
            "demucs",
            "--two-stems=vocals",  # Only separate vocals and instrumental
            "-o",
            str(output_path),
            str(input_path),
        ]

        print(f"Running: {' '.join(cmd)}")
        print()

        result = subprocess.run(cmd, check=True, text=True)

        print()
        print("=" * 60)
        print("âœ“ Separation complete!")
        print("=" * 60)
        print()
        print("Output files:")

        # Find and list output files
        for file in output_path.rglob("*"):
            if file.is_file() and file.suffix in [".wav", ".mp3"]:
                print(f"  {file}")

        print()

    except subprocess.CalledProcessError as e:
        print(f"\nError during separation: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"\nUnexpected error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    # Default to the downloaded YouTube song
    script_dir = Path(__file__).parent
    default_input = script_dir / "youtube_song.wav"
    default_output = script_dir / "separated_output"

    input_file = sys.argv[1] if len(sys.argv) > 1 else default_input
    output_dir = sys.argv[2] if len(sys.argv) > 2 else default_output

    separate_vocals(input_file, output_dir)
