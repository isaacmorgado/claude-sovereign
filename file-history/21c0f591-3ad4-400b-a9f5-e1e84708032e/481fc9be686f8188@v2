#!/bin/bash
# CEP Sequence Detection Audit Script
# Verifies all fixes for "Please Open a sequence in the timeline first" error

echo "=========================================="
echo "CEP Sequence Detection Fixes - Audit"
echo "=========================================="
echo ""

SPLICE_DIR="/Users/imorgado/SPLICE"
PASS=0
FAIL=0
WARN=0

# Color codes
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

check_pass() {
    echo -e "${GREEN}✓${NC} $1"
    ((PASS++))
}

check_fail() {
    echo -e "${RED}✗${NC} $1"
    ((FAIL++))
}

check_warn() {
    echo -e "${YELLOW}⚠${NC} $1"
    ((WARN++))
}

echo "==========  JSX FIXES (hostScript.jsx) =========="
echo ""

# Check 1: storeDefaultTimecode has null checks
echo "CHECK 1: storeDefaultTimecode has null checks and error handling"
if grep -q "if (!app || !app.project || !app.project.activeSequence)" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" && \
   grep -A 5 "function storeDefaultTimecode" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" | grep -q "try {"; then
    check_pass "storeDefaultTimecode has proper null checks and try-catch"
else
    check_fail "storeDefaultTimecode missing null checks or error handling"
fi

# Check 2: checkPremiereReady function exists
echo "CHECK 2: checkPremiereReady function exists"
if grep -q "function checkPremiereReady()" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx"; then
    check_pass "checkPremiereReady function exists"

    # Verify it checks app, app.project, and app.project.sequences
    if grep -A 20 "function checkPremiereReady()" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" | \
       grep -q "if (!app || typeof app" && \
       grep -A 20 "function checkPremiereReady()" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" | \
       grep -q "if (!app.project || typeof app.project"; then
        check_pass "checkPremiereReady validates app, project, and sequences"
    else
        check_warn "checkPremiereReady exists but validation incomplete"
    fi
else
    check_fail "checkPremiereReady function not found"
fi

# Check 3: razorSequenceAtSeconds has null checks
echo "CHECK 3: razorSequenceAtSeconds has null checks"
if grep -A 10 "function razorSequenceAtSeconds" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" | \
   grep -q "if (!app || !app.project || !app.project.activeSequence)"; then
    check_pass "razorSequenceAtSeconds has null checks"
else
    check_fail "razorSequenceAtSeconds missing null checks"
fi

# Check 4: razorTrackAtSeconds has null checks
echo "CHECK 4: razorTrackAtSeconds has null checks"
if grep -A 10 "function razorTrackAtSeconds" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" | \
   grep -q "if (!app || !app.project || !app.project.activeSequence)"; then
    check_pass "razorTrackAtSeconds has null checks"
else
    check_fail "razorTrackAtSeconds missing null checks"
fi

echo ""
echo "==========  MAIN.JS FIXES =========="
echo ""

# Check 5: waitForPremiereReady function exists
echo "CHECK 5: waitForPremiereReady function exists in main.js"
if grep -q "async function waitForPremiereReady" "$SPLICE_DIR/splice-cep/panel/js/main.js"; then
    check_pass "waitForPremiereReady function exists"

    # Verify it has retry logic
    if grep -A 30 "async function waitForPremiereReady" "$SPLICE_DIR/splice-cep/panel/js/main.js" | \
       grep -q "for (let i = 0; i < maxAttempts; i++)"; then
        check_pass "waitForPremiereReady has retry loop"
    else
        check_warn "waitForPremiereReady missing retry logic"
    fi

    # Verify it calls checkPremiereReady
    if grep -A 30 "async function waitForPremiereReady" "$SPLICE_DIR/splice-cep/panel/js/main.js" | \
       grep -q "jsx.call('checkPremiereReady')"; then
        check_pass "waitForPremiereReady calls checkPremiereReady"
    else
        check_fail "waitForPremiereReady doesn't call checkPremiereReady"
    fi
else
    check_fail "waitForPremiereReady function not found"
fi

# Check 6: waitForPremiereReady is called during initialization
echo "CHECK 6: waitForPremiereReady is called during initialization"
if grep -B 5 -A 5 "await waitForPremiereReady" "$SPLICE_DIR/splice-cep/panel/js/main.js" | \
   grep -q "await jsx.init()"; then
    check_pass "waitForPremiereReady called during initialization"
else
    check_warn "waitForPremiereReady call location unclear"
fi

# Check 7: getActiveSequenceWithRetry function exists
echo "CHECK 7: getActiveSequenceWithRetry function exists"
if grep -q "async function getActiveSequenceWithRetry" "$SPLICE_DIR/splice-cep/panel/js/main.js"; then
    check_pass "getActiveSequenceWithRetry function exists"

    # Verify it has retry logic
    if grep -A 30 "async function getActiveSequenceWithRetry" "$SPLICE_DIR/splice-cep/panel/js/main.js" | \
       grep -q "for (let attempt = 0; attempt <= retries; attempt++)"; then
        check_pass "getActiveSequenceWithRetry has retry loop"
    else
        check_warn "getActiveSequenceWithRetry missing retry logic"
    fi
else
    check_fail "getActiveSequenceWithRetry function not found"
fi

# Check 8: runDetection uses getActiveSequenceWithRetry
echo "CHECK 8: runDetection uses getActiveSequenceWithRetry"
if grep -A 200 "async function runDetection" "$SPLICE_DIR/splice-cep/panel/js/main.js" | \
   head -50 | grep -q "await getActiveSequenceWithRetry"; then
    check_pass "runDetection uses getActiveSequenceWithRetry"
else
    check_warn "runDetection may not use getActiveSequenceWithRetry (check manually)"
fi

# Check 9: Operation lock is used in GO button handler
echo "CHECK 9: Operation lock is used in GO button handler"
if grep -A 10 "ui.goBtn.addEventListener" "$SPLICE_DIR/splice-cep/panel/js/main.js" | \
   grep -q "await operationLock.acquire()"; then
    check_pass "Operation lock is acquired in GO button handler"

    # Verify release in finally block
    if grep -A 10 "ui.goBtn.addEventListener" "$SPLICE_DIR/splice-cep/panel/js/main.js" | \
       grep -q "finally {" && \
       grep -A 10 "ui.goBtn.addEventListener" "$SPLICE_DIR/splice-cep/panel/js/main.js" | \
       grep -q "operationLock.release()"; then
        check_pass "Operation lock is released in finally block"
    else
        check_fail "Operation lock not properly released"
    fi
else
    check_fail "Operation lock not used in GO button handler"
fi

# Check 10: Operation lock definition exists
echo "CHECK 10: Operation lock definition exists"
if grep -q "let operationLock = {" "$SPLICE_DIR/splice-cep/panel/js/main.js"; then
    check_pass "Operation lock object is defined"
else
    check_fail "Operation lock object not found"
fi

echo ""
echo "==========  ADDITIONAL VERIFICATION =========="
echo ""

# Check 11: Verify no syntax errors in JSX file
echo "CHECK 11: Basic syntax check for hostScript.jsx"
if [ -f "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" ]; then
    # Check for unmatched braces (simple check)
    OPEN_BRACES=$(grep -o "{" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" | wc -l)
    CLOSE_BRACES=$(grep -o "}" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" | wc -l)
    if [ "$OPEN_BRACES" -eq "$CLOSE_BRACES" ]; then
        check_pass "Brace count matches in hostScript.jsx"
    else
        check_warn "Brace count mismatch (open: $OPEN_BRACES, close: $CLOSE_BRACES)"
    fi
else
    check_fail "hostScript.jsx not found"
fi

# Check 12: Verify no syntax errors in main.js
echo "CHECK 12: Basic syntax check for main.js"
if [ -f "$SPLICE_DIR/splice-cep/panel/js/main.js" ]; then
    OPEN_BRACES=$(grep -o "{" "$SPLICE_DIR/splice-cep/panel/js/main.js" | wc -l)
    CLOSE_BRACES=$(grep -o "}" "$SPLICE_DIR/splice-cep/panel/js/main.js" | wc -l)
    if [ "$OPEN_BRACES" -eq "$CLOSE_BRACES" ]; then
        check_pass "Brace count matches in main.js"
    else
        check_warn "Brace count mismatch (open: $OPEN_BRACES, close: $CLOSE_BRACES)"
    fi
else
    check_fail "main.js not found"
fi

# Check 13: Logging added for diagnostics
echo "CHECK 13: Enhanced logging for sequence detection"
if grep -q "\[SPLICE\] checkPremiereReady:" "$SPLICE_DIR/splice-cep/jsx/hostScript.jsx" && \
   grep -q "\[SPLICE\] getActiveSequenceWithRetry:" "$SPLICE_DIR/splice-cep/panel/js/main.js"; then
    check_pass "Enhanced logging added for debugging"
else
    check_warn "Some logging may be missing"
fi

echo ""
echo "=========================================="
echo "AUDIT SUMMARY"
echo "=========================================="
echo -e "${GREEN}Passed: $PASS${NC}"
echo -e "${YELLOW}Warnings: $WARN${NC}"
echo -e "${RED}Failed: $FAIL${NC}"
echo ""

if [ $FAIL -eq 0 ]; then
    echo -e "${GREEN}✓ All critical checks passed!${NC}"
    echo "The fixes are ready for testing in Premiere Pro."
    exit 0
else
    echo -e "${RED}✗ Some checks failed. Review the output above.${NC}"
    exit 1
fi
