const puppeteer = require('puppeteer');
const fs = require('fs');

const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

async function crawl() {
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });

  const page = await browser.newPage();
  const allContent = [];

  console.log('Navigating to https://www.kenkais.com/exclusive...');

  try {
    await page.goto('https://www.kenkais.com/exclusive', {
      waitUntil: 'networkidle2',
      timeout: 30000
    });

    await delay(3000);

    // Enter code 9111
    console.log('Entering code 9111...');
    const inputBoxes = await page.$$('input');
    if (inputBoxes.length > 0) {
      await inputBoxes[0].click();
      await delay(500);
    }
    await page.keyboard.type('9111', { delay: 200 });
    await delay(3000);

    // Focus on Prompting courses - the key content the user wants
    const targetCourses = [
      'SIMPLE PROMPTING',
      'DESIGN SPEAK',
      'CODE SPEAK'
    ];

    const tabs = ['INTRO', 'STEPS', 'TESTING', 'TROUBLESHOOT', 'PREREQUISITES', 'RESOURCES', 'FAQ'];

    for (const courseName of targetCourses) {
      console.log(`\n=== Processing: ${courseName} ===`);

      // Click on Prompting filter first
      const filterButtons = await page.$$('button');
      for (const btn of filterButtons) {
        const text = await btn.evaluate(el => el.innerText.trim());
        if (text.toUpperCase() === 'PROMPTING') {
          await btn.click();
          await delay(1500);
          break;
        }
      }

      // Find and click the course
      const allButtons = await page.$$('button');
      const startButtons = [];
      for (const btn of allButtons) {
        const text = await btn.evaluate(el => el.innerText);
        if (text.includes('Start Course') || text.includes('START COURSE')) {
          startButtons.push(btn);
        }
      }

      // Get course titles to find the right one
      const courseCards = await page.evaluate((target) => {
        const cards = document.querySelectorAll('[class*="group block"]');
        for (let i = 0; i < cards.length; i++) {
          const title = cards[i].querySelector('h3')?.innerText || '';
          if (title.toUpperCase().includes(target.toUpperCase())) {
            return i;
          }
        }
        return -1;
      }, courseName);

      if (courseCards >= 0 && startButtons[courseCards]) {
        await startButtons[courseCards].click();
        await delay(2000);

        const courseContent = { name: courseName, tabs: {} };

        // Click through each tab
        for (const tabName of tabs) {
          try {
            const tabButtons = await page.$$('button');
            for (const btn of tabButtons) {
              const text = await btn.evaluate(el => el.innerText.trim());
              if (text.toUpperCase() === tabName) {
                await btn.click();
                await delay(1000);

                const tabContent = await page.evaluate(() => {
                  // Get the main content area
                  const mainContent = document.querySelector('[class*="space-y"]') ||
                                     document.querySelector('main') ||
                                     document.body;
                  return mainContent.innerText;
                });

                courseContent.tabs[tabName] = tabContent;
                console.log(`  ${tabName}: ${tabContent.length} chars`);
                break;
              }
            }
          } catch (e) {
            console.log(`  ${tabName}: Error - ${e.message}`);
          }
        }

        allContent.push(courseContent);

        // Go back
        await page.goBack();
        await delay(2000);

        // Re-enter code if needed
        const currentText = await page.evaluate(() => document.body.innerText);
        if (currentText.includes('RESTRICTED ACCESS')) {
          const inputs = await page.$$('input');
          if (inputs.length > 0) {
            await inputs[0].click();
            await delay(300);
          }
          await page.keyboard.type('9111', { delay: 150 });
          await delay(2000);
        }
      }
    }

    // Save all collected content
    fs.writeFileSync('/tmp/crawler/prompting-content.json', JSON.stringify(allContent, null, 2));

    let combinedText = '';
    for (const course of allContent) {
      combinedText += '\n\n' + '='.repeat(80) + '\n';
      combinedText += `COURSE: ${course.name}\n`;
      combinedText += '='.repeat(80) + '\n\n';

      for (const [tabName, content] of Object.entries(course.tabs)) {
        combinedText += `\n--- ${tabName} ---\n`;
        combinedText += content;
        combinedText += '\n';
      }
    }
    fs.writeFileSync('/tmp/crawler/prompting-guide.txt', combinedText);

    console.log('\n\nContent saved to /tmp/crawler/prompting-guide.txt');

  } catch (error) {
    console.error('Error:', error);
  }

  await browser.close();
}

crawl().catch(console.error);
