const puppeteer = require('puppeteer');
const fs = require('fs');

const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

async function crawl() {
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });

  const page = await browser.newPage();
  const allContent = [];
  const visitedUrls = new Set();

  console.log('Navigating to https://www.kenkais.com/exclusive...');

  try {
    await page.goto('https://www.kenkais.com/exclusive', {
      waitUntil: 'networkidle2',
      timeout: 30000
    });

    await delay(3000);
    await page.screenshot({ path: '/tmp/crawler/page1.png', fullPage: true });

    // Close any modal that might be open (like the "What's New" modal)
    try {
      const closeBtn = await page.$('button:has(svg.lucide-x)');
      if (closeBtn) {
        console.log('Closing modal...');
        await closeBtn.click();
        await delay(1000);
      }
    } catch (e) {}

    // Use keyboard to enter digits directly (virtual keypad)
    console.log('Entering code 5010 via keyboard...');
    await page.keyboard.press('Digit5');
    await delay(300);
    await page.keyboard.press('Digit0');
    await delay(300);
    await page.keyboard.press('Digit1');
    await delay(300);
    await page.keyboard.press('Digit0');
    await delay(2000);

    await page.screenshot({ path: '/tmp/crawler/page2_after_5010.png', fullPage: true });

    let html = await page.content();
    let textContent = await page.evaluate(() => document.body.innerText);
    console.log('After 5010:', textContent.substring(0, 300));

    // Check if still showing error
    if (textContent.includes('Incorrect') || textContent.includes('RESTRICTED')) {
      console.log('5010 failed, refreshing and trying 5020...');
      await page.goto('https://www.kenkais.com/exclusive', { waitUntil: 'networkidle2' });
      await delay(3000);

      // Close modal again
      try {
        const closeBtn = await page.$('button:has(svg.lucide-x)');
        if (closeBtn) await closeBtn.click();
        await delay(1000);
      } catch (e) {}

      // Try 5020
      await page.keyboard.press('Digit5');
      await delay(300);
      await page.keyboard.press('Digit0');
      await delay(300);
      await page.keyboard.press('Digit2');
      await delay(300);
      await page.keyboard.press('Digit0');
      await delay(2000);

      await page.screenshot({ path: '/tmp/crawler/page3_after_5020.png', fullPage: true });
      textContent = await page.evaluate(() => document.body.innerText);
      console.log('After 5020:', textContent.substring(0, 300));
    }

    // If still restricted, try other common codes
    const codesToTry = ['2025', '2026', '1234', '0000', '1111'];
    for (const code of codesToTry) {
      if (!textContent.includes('Incorrect') && !textContent.includes('RESTRICTED')) break;

      console.log(`Trying code ${code}...`);
      await page.goto('https://www.kenkais.com/exclusive', { waitUntil: 'networkidle2' });
      await delay(2000);

      try {
        const closeBtn = await page.$('button:has(svg.lucide-x)');
        if (closeBtn) await closeBtn.click();
        await delay(500);
      } catch (e) {}

      for (const digit of code) {
        await page.keyboard.press(`Digit${digit}`);
        await delay(200);
      }
      await delay(2000);

      textContent = await page.evaluate(() => document.body.innerText);
      console.log(`After ${code}:`, textContent.substring(0, 200));
    }

    html = await page.content();
    fs.writeFileSync('/tmp/crawler/final.html', html);
    fs.writeFileSync('/tmp/crawler/final_text.txt', textContent);

    console.log('\n=== FINAL PAGE CONTENT ===\n');
    console.log(textContent);

    // Get all links
    const links = await page.evaluate(() => {
      return Array.from(document.querySelectorAll('a[href]'))
        .map(a => ({ href: a.href, text: a.innerText.trim() }))
        .filter(l => l.href.includes('kenkais.com'));
    });

    console.log('\nLinks found:', links);

    allContent.push({ url: page.url(), content: textContent });
    visitedUrls.add(page.url());

    // Visit internal links if we got past the login
    if (!textContent.includes('RESTRICTED')) {
      for (const link of links) {
        if (visitedUrls.has(link.href)) continue;
        if (link.href.includes('#')) continue;

        try {
          console.log('Visiting:', link.href);
          visitedUrls.add(link.href);

          await page.goto(link.href, { waitUntil: 'networkidle2', timeout: 15000 });
          await delay(2000);

          const pageText = await page.evaluate(() => document.body.innerText);
          allContent.push({ url: link.href, content: pageText });

          // Get more links
          const moreLinks = await page.evaluate(() => {
            return Array.from(document.querySelectorAll('a[href]'))
              .map(a => a.href)
              .filter(href => href.includes('kenkais.com'));
          });

          for (const newLink of moreLinks) {
            if (!visitedUrls.has(newLink)) {
              links.push({ href: newLink, text: '' });
            }
          }
        } catch (e) {
          console.log('Error:', e.message);
        }
      }
    }

    // Save everything
    fs.writeFileSync('/tmp/crawler/content.json', JSON.stringify(allContent, null, 2));

    let combinedText = '';
    for (const item of allContent) {
      combinedText += `\n\n${'='.repeat(80)}\nURL: ${item.url}\n${'='.repeat(80)}\n\n${item.content}`;
    }
    fs.writeFileSync('/tmp/crawler/all_content.txt', combinedText);

    console.log('\n\nCrawled', allContent.length, 'pages');

  } catch (error) {
    console.error('Error:', error);
  }

  await browser.close();
}

crawl().catch(console.error);
