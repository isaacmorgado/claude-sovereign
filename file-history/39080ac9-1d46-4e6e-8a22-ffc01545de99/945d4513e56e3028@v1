const puppeteer = require('puppeteer');
const fs = require('fs');

async function crawl() {
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });

  const page = await browser.newPage();
  const allContent = [];
  const visitedUrls = new Set();

  console.log('Navigating to https://www.kenkais.com/exclusive...');

  try {
    await page.goto('https://www.kenkais.com/exclusive', {
      waitUntil: 'networkidle2',
      timeout: 30000
    });

    // Wait for page to load
    await page.waitForTimeout(2000);

    // Take screenshot to see what's there
    await page.screenshot({ path: '/tmp/crawler/page1.png', fullPage: true });

    // Get page content first
    let html = await page.content();
    console.log('Initial page HTML length:', html.length);

    // Look for password input
    const passwordInput = await page.$('input[type="password"], input[type="text"], input[name="password"], input[placeholder*="password" i], input[placeholder*="code" i]');

    if (passwordInput) {
      console.log('Found password input, trying 5010...');
      await passwordInput.type('5010');

      // Look for submit button
      const submitBtn = await page.$('button[type="submit"], input[type="submit"], button:not([type]), .submit, [class*="submit"]');
      if (submitBtn) {
        await submitBtn.click();
      } else {
        await page.keyboard.press('Enter');
      }

      await page.waitForTimeout(3000);
      await page.screenshot({ path: '/tmp/crawler/page2.png', fullPage: true });

      // Check if we need to try 5020
      html = await page.content();
      if (html.includes('incorrect') || html.includes('wrong') || html.includes('invalid') || html.length < 1000) {
        console.log('5010 might have failed, trying 5020...');
        await page.goto('https://www.kenkais.com/exclusive', { waitUntil: 'networkidle2' });
        await page.waitForTimeout(2000);

        const passwordInput2 = await page.$('input[type="password"], input[type="text"], input[name="password"], input[placeholder*="password" i], input[placeholder*="code" i]');
        if (passwordInput2) {
          await passwordInput2.type('5020');
          const submitBtn2 = await page.$('button[type="submit"], input[type="submit"], button:not([type])');
          if (submitBtn2) await submitBtn2.click();
          else await page.keyboard.press('Enter');
          await page.waitForTimeout(3000);
        }
      }
    }

    // Now crawl the content
    console.log('Extracting content...');

    // Get all text content
    const textContent = await page.evaluate(() => {
      return document.body.innerText;
    });

    // Get all links on the page
    const links = await page.evaluate(() => {
      return Array.from(document.querySelectorAll('a[href]'))
        .map(a => a.href)
        .filter(href => href.includes('kenkais.com'));
    });

    console.log('Found links:', links.length);
    allContent.push({ url: 'https://www.kenkais.com/exclusive', content: textContent });
    visitedUrls.add('https://www.kenkais.com/exclusive');

    // Visit each link
    for (const link of links) {
      if (visitedUrls.has(link)) continue;
      if (link.includes('#')) continue;

      try {
        console.log('Visiting:', link);
        visitedUrls.add(link);

        await page.goto(link, { waitUntil: 'networkidle2', timeout: 15000 });
        await page.waitForTimeout(1000);

        const pageText = await page.evaluate(() => document.body.innerText);
        allContent.push({ url: link, content: pageText });

        // Get more links from this page
        const moreLinks = await page.evaluate(() => {
          return Array.from(document.querySelectorAll('a[href]'))
            .map(a => a.href)
            .filter(href => href.includes('kenkais.com'));
        });

        for (const newLink of moreLinks) {
          if (!visitedUrls.has(newLink) && !links.includes(newLink)) {
            links.push(newLink);
          }
        }
      } catch (e) {
        console.log('Error visiting', link, e.message);
      }
    }

    // Save all content
    fs.writeFileSync('/tmp/crawler/content.json', JSON.stringify(allContent, null, 2));

    // Create a combined text file
    let combinedText = '';
    for (const item of allContent) {
      combinedText += `\n\n========== ${item.url} ==========\n\n${item.content}`;
    }
    fs.writeFileSync('/tmp/crawler/all_content.txt', combinedText);

    console.log('Crawled', allContent.length, 'pages');
    console.log('Content saved to /tmp/crawler/all_content.txt');

  } catch (error) {
    console.error('Error:', error.message);

    // Still save what we have
    const html = await page.content();
    fs.writeFileSync('/tmp/crawler/raw.html', html);
    console.log('Saved raw HTML to /tmp/crawler/raw.html');
  }

  await browser.close();
}

crawl().catch(console.error);
