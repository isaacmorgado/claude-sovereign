const puppeteer = require('puppeteer');
const fs = require('fs');

const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

async function crawl() {
  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });

  const page = await browser.newPage();
  const allContent = [];

  console.log('Navigating to https://www.kenkais.com/exclusive...');

  try {
    await page.goto('https://www.kenkais.com/exclusive', {
      waitUntil: 'networkidle2',
      timeout: 30000
    });

    await delay(3000);

    // Close any modal
    try {
      const closeBtn = await page.$('button:has(svg.lucide-x)');
      if (closeBtn) {
        console.log('Closing modal...');
        await closeBtn.click();
        await delay(1000);
      }
    } catch (e) {}

    // Click on the first input box to focus and enter code
    console.log('Entering code 9111...');
    const inputBoxes = await page.$$('input');
    if (inputBoxes.length > 0) {
      await inputBoxes[0].click();
      await delay(500);
    }
    await page.keyboard.type('9111', { delay: 200 });
    await delay(3000);

    // Save main page overview
    let mainPageText = await page.evaluate(() => document.body.innerText);
    allContent.push({ section: 'Main Page Overview', content: mainPageText });
    console.log('Main page captured');

    // Get all "Start Course" buttons and their associated card info
    const courseCards = await page.evaluate(() => {
      const cards = document.querySelectorAll('[class*="group block"]');
      const info = [];
      cards.forEach((card, index) => {
        const title = card.querySelector('h3')?.innerText || '';
        const description = card.querySelector('p')?.innerText || '';
        const category = card.querySelector('[class*="tracking-widest"]')?.innerText || '';
        info.push({ index, title, description, category });
      });
      return info;
    });

    console.log('Found', courseCards.length, 'course cards');

    // Click through each course and extract content
    for (let i = 0; i < courseCards.length; i++) {
      const card = courseCards[i];
      console.log(`\nProcessing ${i + 1}/${courseCards.length}: ${card.title}`);

      try {
        // Re-query buttons since DOM may have changed
        const buttons = await page.$$('button');
        let startButton = null;

        for (const btn of buttons) {
          const text = await btn.evaluate(el => el.innerText);
          if (text.includes('Start Course') || text.includes('START COURSE')) {
            startButton = btn;
            break;
          }
        }

        // Find the i-th card's start button
        const allStartButtons = await page.$$('button');
        const startButtons = [];
        for (const btn of allStartButtons) {
          const text = await btn.evaluate(el => el.innerText);
          if (text.includes('Start Course') || text.includes('START COURSE')) {
            startButtons.push(btn);
          }
        }

        if (startButtons[i]) {
          await startButtons[i].click();
          await delay(2000);

          // Extract course content
          const courseContent = await page.evaluate(() => document.body.innerText);
          const courseUrl = page.url();

          allContent.push({
            section: card.title,
            category: card.category,
            description: card.description,
            url: courseUrl,
            content: courseContent
          });

          console.log(`  Captured ${courseContent.length} chars`);

          // Take screenshot
          const filename = card.title.replace(/[^a-z0-9]/gi, '_').substring(0, 50);
          await page.screenshot({ path: `/tmp/crawler/pages/${filename}.png`, fullPage: true });

          // Go back to main page
          await page.goBack();
          await delay(2000);

          // Re-enter code if needed
          const currentText = await page.evaluate(() => document.body.innerText);
          if (currentText.includes('RESTRICTED ACCESS')) {
            console.log('  Re-entering code...');
            const inputs = await page.$$('input');
            if (inputs.length > 0) {
              await inputs[0].click();
              await delay(300);
            }
            await page.keyboard.type('9111', { delay: 150 });
            await delay(2000);
          }
        }
      } catch (e) {
        console.log(`  Error: ${e.message}`);
      }
    }

    // Also click through category filters to make sure we get all content
    const categories = ['Prompting', 'First Project', 'Backend', 'Security', 'Deployment', 'Boilerplates', 'Hacker'];

    for (const cat of categories) {
      console.log(`\nChecking category: ${cat}`);
      try {
        const catButton = await page.$(`button:has-text("${cat}")`);
        if (catButton) {
          await catButton.click();
          await delay(1500);

          const categoryContent = await page.evaluate(() => document.body.innerText);
          allContent.push({
            section: `Category: ${cat}`,
            content: categoryContent
          });
          console.log(`  Captured ${categoryContent.length} chars`);
        }
      } catch (e) {
        console.log(`  Error: ${e.message}`);
      }
    }

    // Save all collected content
    fs.writeFileSync('/tmp/crawler/content.json', JSON.stringify(allContent, null, 2));

    let combinedText = '';
    for (const item of allContent) {
      combinedText += '\n\n' + '='.repeat(80) + '\n';
      combinedText += `SECTION: ${item.section}\n`;
      if (item.category) combinedText += `CATEGORY: ${item.category}\n`;
      if (item.url) combinedText += `URL: ${item.url}\n`;
      combinedText += '='.repeat(80) + '\n\n';
      combinedText += item.content;
    }
    fs.writeFileSync('/tmp/crawler/all_content.txt', combinedText);

    console.log('\n\nCrawled', allContent.length, 'sections total');
    console.log('Content saved to /tmp/crawler/all_content.txt');

  } catch (error) {
    console.error('Error:', error);
  }

  await browser.close();
}

// Create pages directory
fs.mkdirSync('/tmp/crawler/pages', { recursive: true });

crawl().catch(console.error);
