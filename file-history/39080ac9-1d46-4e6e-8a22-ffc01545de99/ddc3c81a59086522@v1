#!/bin/bash
# Auto-Continue Hook - Fully automated context management
# When context hits threshold, automatically:
# 1. Saves state to CLAUDE.md
# 2. Creates continuation prompt
# 3. Triggers compaction
# 4. Feeds continuation prompt back to keep running

set -euo pipefail

THRESHOLD=${CLAUDE_CONTEXT_THRESHOLD:-40}
LOG_FILE="${HOME}/.claude/auto-continue.log"
STATE_FILE=".claude/auto-continue.local.md"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Read hook input
HOOK_INPUT=$(cat)

# Extract context info
CONTEXT_SIZE=$(echo "$HOOK_INPUT" | jq -r '.context_window.context_window_size // 200000')
USAGE=$(echo "$HOOK_INPUT" | jq '.context_window.current_usage // null')
TRANSCRIPT_PATH=$(echo "$HOOK_INPUT" | jq -r '.transcript_path // ""')

if [[ "$USAGE" == "null" ]]; then
    log "No usage data - allowing stop"
    exit 0
fi

# Calculate percentage
INPUT_TOKENS=$(echo "$USAGE" | jq -r '.input_tokens // 0')
CACHE_CREATE=$(echo "$USAGE" | jq -r '.cache_creation_input_tokens // 0')
CACHE_READ=$(echo "$USAGE" | jq -r '.cache_read_input_tokens // 0')
CURRENT_TOKENS=$((INPUT_TOKENS + CACHE_CREATE + CACHE_READ))
PERCENT=$((CURRENT_TOKENS * 100 / CONTEXT_SIZE))

log "Context: ${PERCENT}% (${CURRENT_TOKENS}/${CONTEXT_SIZE})"

# Check if auto-continue is disabled
if [[ -f ".claude/auto-continue-disabled" ]]; then
    log "Auto-continue disabled - allowing stop"
    exit 0
fi

# Below threshold - allow normal stop
if [[ $PERCENT -lt $THRESHOLD ]]; then
    exit 0
fi

log "Threshold reached (${PERCENT}% >= ${THRESHOLD}%) - triggering auto-continue"

# Get current working directory info
PROJECT_NAME=$(basename "$(pwd)")
PROJECT_DIR=$(pwd)

# Extract what Claude was working on from transcript
LAST_WORK=""
if [[ -n "$TRANSCRIPT_PATH" ]] && [[ -f "$TRANSCRIPT_PATH" ]]; then
    # Get last few assistant messages to understand context
    LAST_WORK=$(grep '"role":"assistant"' "$TRANSCRIPT_PATH" | tail -3 | jq -rs '
        [.[] | .message.content[] | select(.type == "text") | .text] |
        join("\n") |
        .[0:500]
    ' 2>/dev/null || echo "")
fi

# Read CLAUDE.md if exists
CLAUDE_MD_CONTENT=""
if [[ -f "CLAUDE.md" ]]; then
    CLAUDE_MD_CONTENT=$(head -50 CLAUDE.md 2>/dev/null || echo "")
fi

# Read buildguide.md next section if exists
NEXT_SECTION=""
if [[ -f "buildguide.md" ]]; then
    NEXT_SECTION=$(grep -A 2 '^\- \[ \]' buildguide.md 2>/dev/null | head -5 || echo "")
fi

# Build continuation prompt
CONTINUATION_PROMPT="Continue work on ${PROJECT_NAME} at ${PROJECT_DIR}.

Context was at ${PERCENT}% - auto-compacted.

Read CLAUDE.md for session state. Key context:
${CLAUDE_MD_CONTENT:0:300}

${NEXT_SECTION:+Next from buildguide.md: $NEXT_SECTION}

Continue where you left off. Do NOT re-explore the codebase - use the context above."

# Track iteration
ITERATION=1
if [[ -f "$STATE_FILE" ]]; then
    ITERATION=$(grep '^iteration:' "$STATE_FILE" | sed 's/iteration: *//' || echo "1")
    ITERATION=$((ITERATION + 1))
fi

# Create/update state file
mkdir -p .claude
cat > "$STATE_FILE" <<EOF
---
active: true
iteration: $ITERATION
threshold: $THRESHOLD
last_percent: $PERCENT
last_compact: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
---

Auto-continue active. Iteration ${ITERATION}.
EOF

# Output JSON to block stop and feed continuation prompt
jq -n \
    --arg prompt "$CONTINUATION_PROMPT" \
    --arg msg "ðŸ”„ Auto-continue: Context was ${PERCENT}% - compacted and continuing (iteration ${ITERATION})" \
    '{
        "decision": "block",
        "reason": $prompt,
        "systemMessage": $msg
    }'

log "Auto-continue triggered - iteration $ITERATION"
exit 0
