#!/usr/bin/env python3
"""
Specialized crawler for Ken Kai's site with PIN code auth.
"""

import asyncio
import sys
from pathlib import Path

try:
    from playwright.async_api import async_playwright
except ImportError:
    import subprocess
    subprocess.run([sys.executable, "-m", "pip", "install", "playwright"], check=True)
    subprocess.run([sys.executable, "-m", "playwright", "install", "chromium"], check=True)
    from playwright.async_api import async_playwright

try:
    from markdownify import markdownify as md
except ImportError:
    import subprocess
    subprocess.run([sys.executable, "-m", "pip", "install", "markdownify"], check=True)
    from markdownify import markdownify as md


async def crawl_kenkai(password: str = "9111", output_file: str = None):
    """Crawl Ken Kai's exclusive content."""

    async with async_playwright() as p:
        # Launch with persistent context to maintain auth
        browser = await p.chromium.launch(headless=False, slow_mo=100)
        context = await browser.new_context(
            viewport={'width': 1920, 'height': 1080},
        )
        page = await context.new_page()

        print("Navigating to Ken Kai's exclusive page...")
        await page.goto("https://www.kenkais.com/exclusive", wait_until='networkidle')
        await asyncio.sleep(2)

        # Check if we're on the restricted page
        content = await page.content()
        if 'Restricted Access' in content:
            print(f"Found restricted access page. Entering code: {password}")

            # Try multiple methods to enter the PIN

            # Method 1: Direct keyboard input (site listens for keydown)
            print("Method 1: Keyboard input...")
            await page.keyboard.press("Escape")  # Clear any modals
            await asyncio.sleep(0.3)

            for digit in password:
                await page.keyboard.press(digit)
                print(f"  Pressed: {digit}")
                await asyncio.sleep(0.4)

            await asyncio.sleep(3)

            # Check if auth worked
            content = await page.content()
            if 'Restricted Access' not in content:
                print("Successfully authenticated!")
            else:
                # Method 2: Click and type
                print("Method 2: Click body and type...")
                await page.click('body', position={'x': 960, 'y': 540})
                await asyncio.sleep(0.5)

                for digit in password:
                    await page.keyboard.type(digit)
                    await asyncio.sleep(0.3)

                await asyncio.sleep(3)
                content = await page.content()

                if 'Restricted Access' not in content:
                    print("Successfully authenticated!")
                else:
                    # Method 3: Try dispatching keyboard events via JS
                    print("Method 3: JavaScript keyboard events...")
                    for digit in password:
                        await page.evaluate(f'''() => {{
                            const event = new KeyboardEvent('keydown', {{
                                key: '{digit}',
                                code: 'Digit{digit}',
                                keyCode: {48 + int(digit)},
                                which: {48 + int(digit)},
                                bubbles: true
                            }});
                            document.dispatchEvent(event);
                            document.body.dispatchEvent(event);
                        }}''')
                        await asyncio.sleep(0.3)

                    await asyncio.sleep(3)
                    content = await page.content()

                    if 'Restricted Access' not in content:
                        print("Successfully authenticated!")
                    else:
                        print("Authentication failed. Taking screenshot for debugging...")
                        await page.screenshot(path='/tmp/kenkai-auth-fail.png')
                        print("Screenshot saved to /tmp/kenkai-auth-fail.png")

        # Now crawl the content
        print("\nExtracting page content...")

        # Get the main content
        main_content = await page.evaluate('''() => {
            // Remove navigation elements
            const nav = document.querySelector('nav');
            if (nav) nav.remove();

            const sidebar = document.querySelector('.sidebar, [class*="sidebar"]');
            if (sidebar) sidebar.remove();

            // Get main content
            const main = document.querySelector('main') || document.body;
            return main.innerHTML;
        }''')

        title = await page.title()
        url = page.url

        # Convert to markdown
        markdown_content = md(main_content, heading_style="ATX", strip=['script', 'style'])

        # Clean up
        import re
        markdown_content = re.sub(r'\n{3,}', '\n\n', markdown_content)

        result = f"# {title}\n\n**Source:** {url}\n\n{markdown_content}"

        if output_file:
            Path(output_file).write_text(result)
            print(f"\nSaved to: {output_file}")
        else:
            print(result)

        # Get list of course links for further crawling
        links = await page.evaluate('''() => {
            return Array.from(document.querySelectorAll('a[href*="/exclusive/"]'))
                .map(a => ({href: a.href, text: a.innerText}))
                .filter((v, i, a) => a.findIndex(t => t.href === v.href) === i);
        }''')

        print(f"\nFound {len(links)} course links:")
        for link in links[:20]:
            print(f"  - {link.get('text', '').strip()[:50]}: {link.get('href', '')}")

        # Auto-close after extraction
        await asyncio.sleep(2)
        await browser.close()

        return result


if __name__ == '__main__':
    password = sys.argv[1] if len(sys.argv) > 1 else "9111"
    output = sys.argv[2] if len(sys.argv) > 2 else "/Users/imorgado/.claude/docs/kenkai-exclusive.md"

    asyncio.run(crawl_kenkai(password, output))
