#!/bin/bash
# PostToolUse Hook: Auto-lint and typecheck after file edits
# Runs silently, fixes what it can, reports issues

set -euo pipefail

LOG_FILE="${HOME}/.claude/quality.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Read hook input
HOOK_INPUT=$(cat)

# Extract tool info
TOOL_NAME=$(echo "$HOOK_INPUT" | jq -r '.tool_name // ""')
TOOL_INPUT=$(echo "$HOOK_INPUT" | jq -r '.tool_input // {}')

# Only run for file modification tools
case "$TOOL_NAME" in
    Write|Edit|MultiEdit|NotebookEdit)
        ;;
    *)
        exit 0
        ;;
esac

# Extract file path
FILE_PATH=$(echo "$TOOL_INPUT" | jq -r '.file_path // .path // ""')

if [[ -z "$FILE_PATH" ]] || [[ ! -f "$FILE_PATH" ]]; then
    exit 0
fi

# Get file extension
EXT="${FILE_PATH##*.}"

log "Quality check triggered for: $FILE_PATH (.$EXT)"

# Run appropriate linter based on file type
case "$EXT" in
    ts|tsx|js|jsx|mjs|cjs)
        # TypeScript/JavaScript - run eslint fix
        if command -v npx &> /dev/null && [[ -f "package.json" ]]; then
            # Check if eslint is available
            if npx eslint --version &> /dev/null 2>&1; then
                LINT_OUTPUT=$(npx eslint --fix "$FILE_PATH" 2>&1) || true
                if [[ -n "$LINT_OUTPUT" ]]; then
                    log "ESLint output: $LINT_OUTPUT"
                    # Return lint issues as advisory (don't block)
                    echo "{\"advisory\": \"ESLint: $(echo "$LINT_OUTPUT" | head -5 | tr '\n' ' ')\"}"
                fi
            fi
        fi
        ;;

    py)
        # Python - run ruff or black
        if command -v ruff &> /dev/null; then
            ruff check --fix "$FILE_PATH" 2>&1 || true
            ruff format "$FILE_PATH" 2>&1 || true
            log "Ruff applied to $FILE_PATH"
        elif command -v black &> /dev/null; then
            black "$FILE_PATH" 2>&1 || true
            log "Black applied to $FILE_PATH"
        fi
        ;;

    go)
        # Go - run gofmt
        if command -v gofmt &> /dev/null; then
            gofmt -w "$FILE_PATH" 2>&1 || true
            log "gofmt applied to $FILE_PATH"
        fi
        ;;

    rs)
        # Rust - run rustfmt
        if command -v rustfmt &> /dev/null; then
            rustfmt "$FILE_PATH" 2>&1 || true
            log "rustfmt applied to $FILE_PATH"
        fi
        ;;

    json)
        # JSON - validate and format with jq
        if command -v jq &> /dev/null; then
            if ! jq empty "$FILE_PATH" 2>&1; then
                log "Invalid JSON in $FILE_PATH"
                echo "{\"advisory\": \"Invalid JSON syntax in $FILE_PATH\"}"
            fi
        fi
        ;;

    *)
        # Unknown file type - skip
        ;;
esac

exit 0
