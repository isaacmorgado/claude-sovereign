/**
 * Product Recommendation Engine
 * Maps specific user flaws to high-ticket affiliate products ("Prescriptions")
 */

import { Flaw, ProductRecommendation } from '@/types/results';
import { getLegacyProductById as getProductById } from '@/data/guides/products-registry';

// Vision data from Claude Vision analysis
interface ProductVisionData {
    skin?: { clarity?: number };
    hair?: { hairline_nw?: number };
    teeth?: { status?: string; alignment?: string };
}

export function generateProductRecommendations(flaws: Flaw[], vision?: ProductVisionData): ProductRecommendation[] {
    const recommendations: ProductRecommendation[] = [];
    const addedProductIds = new Set<string>();

    // Helper to add recommendation
    const addRec = (productId: string, flaw: Flaw | null, message: string, urgency: 'high' | 'medium' | 'low', targetMetric?: string) => {
        if (addedProductIds.has(productId)) return;

        const product = getProductById(productId);
        if (!product) return;

        recommendations.push({
            product,
            state: 'flaw',
            targetMetric: targetMetric || (flaw?.responsibleRatios[0]?.ratioId) || 'general',
            message: message,
            urgency,
            matchedMetrics: flaw ? flaw.responsibleRatios.map(r => r.ratioId) : []
        });
        addedProductIds.add(productId);
    };

    // 1. Jawline / Masseter Issues -> Jawliner
    const jawFlaw = flaws.find(f =>
        f.categoryName.includes('Jaw') ||
        f.flawName.toLowerCase().includes('jaw') ||
        f.flawName.toLowerCase().includes('gonial')
    );

    if (jawFlaw) {
        addRec(
            'jawliner_medium',
            jawFlaw,
            "Your jawline definition is lacking masseter volume. Clinical hypertrophy training is recommended.",
            'high'
        );
    }

    // 2. Puffiness / Midface -> Gua Sha / Ice Roller
    const puffyFlaw = flaws.find(f =>
        f.categoryName.includes('Midface') ||
        f.flawName.toLowerCase().includes('cheek') ||
        f.flawName.toLowerCase().includes('bloat')
    );

    if (puffyFlaw) {
        addRec(
            'gua_sha_set',
            puffyFlaw,
            "Facial puffiness is masking your bone structure. Lymphatic drainage is required.",
            'medium'
        );
    }

    // 3. Skin Texture / Aging / Acne -> Red Light Mask
    // Use vision data for skin clarity
    const skinClarity = vision?.skin?.clarity;
    const hasSkinIssues = skinClarity !== undefined && skinClarity < 7;
    const skinFlaw = flaws.find(f =>
        f.categoryName.includes('Skin') ||
        f.flawName.toLowerCase().includes('texture') ||
        f.flawName.toLowerCase().includes('wrinkle')
    );

    if (hasSkinIssues || skinFlaw) {
        const severity = (skinClarity !== undefined && skinClarity < 4) ? 'high' : 'medium';
        const msg = hasSkinIssues
            ? `Vision analysis detected skin clarity issues (${skinClarity}/10). LED therapy accelerates skin repair.`
            : "Skin texture irregularities detected. Clinical LED therapy prevents collagen degradation.";
        addRec(
            'red_light_mask',
            skinFlaw || null,
            msg,
            severity,
            'Skin Clarity'
        );
    }

    // 4. Hair / Forehead -> Derma Roller
    // Use vision data for hairline
    const hairlineNW = vision?.hair?.hairline_nw;
    const hairFlaw = flaws.find(f =>
        f.categoryName.includes('Hair') ||
        f.categoryName.includes('Upper Third') ||
        f.flawName.toLowerCase().includes('forehead')
    );

    const hasHairlineRecession = hairlineNW !== undefined && hairlineNW >= 2;
    if (hasHairlineRecession || hairFlaw) {
        const msg = hasHairlineRecession
            ? `Hairline recession (NW${hairlineNW}) detected. Microneedling combined with clinical topicals is advised.`
            : "Upper third proportions risk being compromised by hairline density. Collagen induction therapy advised.";
        addRec(
            'derma_roller_15',
            hairFlaw || null,
            msg,
            'high',
            'Hairline'
        );
    }

    // 5. Dental -> Whitening Strips (New)
    const teethStatus = vision?.teeth?.status;
    const teethAlignment = vision?.teeth?.alignment;
    if (teethStatus === 'yellow' || teethAlignment === 'crowded') {
        addRec(
            'teeth_whitening_kit', // Assuming this exists in product_db or will be added
            null,
            `Dental irregularities detected (${teethStatus}). Clinical grade whitening strips will improve smile harmony.`,
            'medium',
            'Dental Harmony'
        );
    }

    return recommendations;
}
