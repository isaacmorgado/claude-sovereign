import { z } from "zod"

/**
 * Workspace Agent Configuration Schema
 * Defines how an agent should operate within a specific workspace folder
 */
export const workspaceAgentConfigSchema = z.object({
	workspacePath: z.string(), // Path to workspace folder (supports ${workspaceFolder} variable)
	enabled: z.boolean().default(true),
	defaultMode: z.string().optional(), // Default mode slug for this workspace
	defaultProviderProfile: z.string().optional(), // Default API provider profile
	isolatedContext: z.boolean().default(true), // Whether to isolate context from other workspaces
	maxConcurrentTasks: z.number().default(1), // Max parallel tasks for this workspace
})

export type WorkspaceAgentConfig = z.infer<typeof workspaceAgentConfigSchema>

/**
 * Project Dependencies for Orchestration
 * Maps project paths to their dependencies
 */
export const projectDependenciesSchema = z.record(z.array(z.string()))

export type ProjectDependencies = z.infer<typeof projectDependenciesSchema>

/**
 * Cross-Project Orchestration Configuration Schema
 */
export const orchestrationConfigSchema = z.object({
	enabled: z.boolean().default(false),
	orchestratorMode: z.string().optional(), // Custom mode for orchestrator agent
	projectDependencies: projectDependenciesSchema.optional(), // project -> dependencies mapping
	sharedContext: z.array(z.string()).optional(), // Shared context file patterns (e.g., "**/*.d.ts")
})

export type OrchestrationConfig = z.infer<typeof orchestrationConfigSchema>

/**
 * Multi-Project Configuration File Schema
 */
export const multiProjectConfigSchema = z.object({
	version: z.literal("1.0"),
	workspaces: z.array(workspaceAgentConfigSchema),
	orchestration: orchestrationConfigSchema.optional(),
})

export type MultiProjectConfig = z.infer<typeof multiProjectConfigSchema>

/**
 * Workspace Agent State (runtime)
 */
export interface WorkspaceAgentState {
	workspacePath: string
	workspaceFolderIndex: number
	providerId: string // Unique ID for the ClineProvider instance
	isActive: boolean
	isFocused: boolean
	currentTaskId?: string
	taskQueue: string[]
	config: WorkspaceAgentConfig
}

/**
 * Workspace Context for task execution
 */
export interface WorkspaceContext {
	workspacePath: string
	workspaceFolderIndex: number
	workspaceName: string
	isMultiRoot: boolean
	relatedWorkspaces?: string[]
}

/**
 * Orchestration Task - represents a coordinated cross-project task
 */
export interface OrchestrationTask {
	id: string
	name: string
	prompt: string
	targetWorkspaces: string[]
	dependencies: ProjectDependencies
	status: "pending" | "running" | "completed" | "failed"
	subtasks: OrchestrationSubtask[]
	startTime?: number
	endTime?: number
}

/**
 * Orchestration Subtask - a task within an orchestration
 */
export interface OrchestrationSubtask {
	id: string
	workspacePath: string
	taskId?: string
	prompt: string
	status: "pending" | "waiting_dependency" | "running" | "completed" | "failed"
	dependsOn: string[] // IDs of subtasks this depends on
	result?: string
}

/**
 * Workspace Switcher State
 */
export interface WorkspaceSwitcherState {
	availableWorkspaces: WorkspaceInfo[]
	activeWorkspaceIndex: number
	focusedWorkspaceIndex: number
}

/**
 * Workspace Info for UI
 */
export interface WorkspaceInfo {
	path: string
	name: string
	folderIndex: number
	hasAgent: boolean
	isActive: boolean
	isFocused: boolean
	currentTaskId?: string
	taskCount: number
}
