import { z } from "zod"

/**
 * Automation Trigger Types
 */
export enum AutomationTriggerType {
	FileWatcher = "file_watcher",
	Cron = "cron",
	GitHook = "git_hook",
	Manual = "manual",
	Event = "event",
}

/**
 * File Watcher Event Types
 */
export type FileWatcherEvent = "create" | "change" | "delete" | "save"

/**
 * Git Hook Types
 */
export type GitHookType =
	| "pre-commit"
	| "post-commit"
	| "pre-push"
	| "post-checkout"
	| "post-merge"
	| "branch-change"

/**
 * File Watcher Trigger Schema
 */
export const fileWatcherTriggerSchema = z.object({
	type: z.literal(AutomationTriggerType.FileWatcher),
	patterns: z.array(z.string()), // glob patterns like "*.test.ts", "src/**/*.ts"
	events: z.array(z.enum(["create", "change", "delete", "save"])),
	debounceMs: z.number().optional().default(500),
	excludePatterns: z.array(z.string()).optional(),
})

export type FileWatcherTrigger = z.infer<typeof fileWatcherTriggerSchema>

/**
 * Cron/Scheduled Trigger Schema
 */
export const cronTriggerSchema = z.object({
	type: z.literal(AutomationTriggerType.Cron),
	schedule: z.string(), // cron expression: "0 9 * * *" (9am daily)
	timezone: z.string().optional().default("UTC"),
})

export type CronTrigger = z.infer<typeof cronTriggerSchema>

/**
 * Git Hook Trigger Schema
 */
export const gitHookTriggerSchema = z.object({
	type: z.literal(AutomationTriggerType.GitHook),
	hook: z.enum(["pre-commit", "post-commit", "pre-push", "post-checkout", "post-merge", "branch-change"]),
	branches: z.array(z.string()).optional(), // filter by branch pattern
})

export type GitHookTrigger = z.infer<typeof gitHookTriggerSchema>

/**
 * Manual Trigger Schema (for on-demand execution)
 */
export const manualTriggerSchema = z.object({
	type: z.literal(AutomationTriggerType.Manual),
})

export type ManualTrigger = z.infer<typeof manualTriggerSchema>

/**
 * Event Trigger Schema (for cross-project orchestration)
 */
export const eventTriggerSchema = z.object({
	type: z.literal(AutomationTriggerType.Event),
	eventName: z.string(),
	source: z.enum(["task", "automation", "external"]),
})

export type EventTrigger = z.infer<typeof eventTriggerSchema>

/**
 * Union of all trigger types
 */
export const automationTriggerSchema = z.discriminatedUnion("type", [
	fileWatcherTriggerSchema,
	cronTriggerSchema,
	gitHookTriggerSchema,
	manualTriggerSchema,
	eventTriggerSchema,
])

export type AutomationTrigger = z.infer<typeof automationTriggerSchema>

/**
 * Automation Condition Schema
 */
export const automationConditionSchema = z.object({
	type: z.enum(["file_exists", "branch_matches", "env_var", "time_range"]),
	value: z.string(),
	negate: z.boolean().optional().default(false),
})

export type AutomationCondition = z.infer<typeof automationConditionSchema>

/**
 * Automation Action Schema
 */
export const automationActionSchema = z.object({
	mode: z.string(), // mode slug to use
	prompt: z.string(), // task prompt/instruction (supports {{variables}})
	workspacePath: z.string().optional(), // specific workspace folder
	providerProfile: z.string().optional(), // API provider profile to use
	autoApprove: z.boolean().optional().default(false),
	timeout: z.number().optional(), // max execution time in ms
	retryCount: z.number().optional().default(0),
	variables: z.record(z.string()).optional(), // custom template variables
})

export type AutomationAction = z.infer<typeof automationActionSchema>

/**
 * Automation Metadata Schema
 */
export const automationMetadataSchema = z.object({
	createdAt: z.string(),
	updatedAt: z.string(),
	lastTriggered: z.string().optional(),
	executionCount: z.number().default(0),
})

export type AutomationMetadata = z.infer<typeof automationMetadataSchema>

/**
 * Complete Automation Definition Schema
 */
export const automationDefinitionSchema = z.object({
	id: z.string(),
	name: z.string(),
	description: z.string().optional(),
	enabled: z.boolean().default(true),
	trigger: automationTriggerSchema,
	action: automationActionSchema,
	conditions: z.array(automationConditionSchema).optional(),
	metadata: automationMetadataSchema.optional(),
})

export type AutomationDefinition = z.infer<typeof automationDefinitionSchema>

/**
 * Automation Configuration File Schema
 */
export const automationConfigSchema = z.object({
	version: z.literal("1.0"),
	automations: z.array(automationDefinitionSchema),
})

export type AutomationConfig = z.infer<typeof automationConfigSchema>

/**
 * Trigger Context - passed to automation executor
 */
export interface TriggerContext {
	triggerId: string
	automationId: string
	triggerType: AutomationTriggerType
	timestamp: number
	workspacePath: string
	// File watcher specific
	file?: string
	event?: FileWatcherEvent
	// Git hook specific
	branch?: string
	commit?: string
	// Cron specific
	scheduledTime?: string
	// Event specific
	eventData?: Record<string, unknown>
}

/**
 * Automation Execution Result
 */
export interface AutomationExecutionResult {
	automationId: string
	taskId?: string
	success: boolean
	error?: string
	startTime: number
	endTime: number
	triggerContext: TriggerContext
}

/**
 * Automation State (runtime)
 */
export interface AutomationState {
	id: string
	definition: AutomationDefinition
	isActive: boolean
	lastExecution?: AutomationExecutionResult
	nextScheduledRun?: number // for cron triggers
}
