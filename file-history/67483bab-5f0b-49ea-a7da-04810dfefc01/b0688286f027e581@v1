# MultiAgent: Automations & Multi-Project Support

## Overview
Add automation triggers (file watchers, cron, git hooks) and multi-project support (parallel agents, cross-project orchestration, project switching) to MultiAgent.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    AutomationManager                         │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        │
│  │FileWatcher   │ │CronScheduler │ │GitHookListener│        │
│  │Trigger       │ │              │ │              │        │
│  └──────┬───────┘ └──────┬───────┘ └──────┬───────┘        │
└─────────┼────────────────┼────────────────┼─────────────────┘
          │                │                │
          v                v                v
┌─────────────────────────────────────────────────────────────┐
│                    WorkspaceManager                          │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐ │
│  │ClineProvider   │  │ClineProvider   │  │ClineProvider   │ │
│  │(workspace-1)   │  │(workspace-2)   │  │(workspace-N)   │ │
│  └────────────────┘  └────────────────┘  └────────────────┘ │
└─────────────────────────────────────────────────────────────┘
          │
          v
┌─────────────────────────────────────────────────────────────┐
│              CrossProjectOrchestrator                        │
│  - Coordinates tasks across workspaces                       │
│  - Manages shared context and dependencies                   │
└─────────────────────────────────────────────────────────────┘
```

## Configuration (Recommended: YAML files)

### `.multiagent/automations.yaml`
```yaml
version: "1.0"
automations:
  - id: auto-test-runner
    name: Auto Test Runner
    trigger:
      type: file_watcher
      patterns: ["**/*.test.ts"]
      events: [save]
      debounceMs: 1000
    action:
      mode: test
      prompt: "Run tests for {{triggerFile}}"
      autoApprove: true

  - id: daily-review
    name: Daily Code Review
    trigger:
      type: cron
      schedule: "0 9 * * 1-5"
    action:
      mode: code
      prompt: "Review uncommitted changes"

  - id: pre-commit-lint
    trigger:
      type: git_hook
      hook: pre-commit
    action:
      mode: code
      prompt: "Lint staged files"
```

### `.multiagent/workspaces.yaml`
```yaml
version: "1.0"
workspaces:
  - workspacePath: "${workspaceFolder}/packages/frontend"
    defaultMode: design-engineer
    maxConcurrentTasks: 1
  - workspacePath: "${workspaceFolder}/packages/backend"
    defaultMode: code

orchestration:
  enabled: true
  orchestratorMode: architect
```

---

## New Files to Create

| File | Purpose |
|------|---------|
| `src/services/automation/AutomationManager.ts` | Main automation orchestrator |
| `src/services/automation/TriggerRegistry.ts` | Registry for all triggers |
| `src/services/automation/triggers/BaseTrigger.ts` | Abstract base class |
| `src/services/automation/triggers/FileWatcherTrigger.ts` | File change triggers |
| `src/services/automation/triggers/CronTrigger.ts` | Scheduled triggers |
| `src/services/automation/triggers/GitHookTrigger.ts` | Git event triggers |
| `src/services/automation/AutomationConfigLoader.ts` | YAML config loader |
| `src/services/automation/AutomationExecutor.ts` | Executes automation actions |
| `src/services/workspace/WorkspaceManager.ts` | Per-workspace providers |
| `src/services/workspace/CrossProjectOrchestrator.ts` | Multi-project coordination |
| `packages/types/src/automation.ts` | Automation type definitions |
| `packages/types/src/workspace.ts` | Multi-project types |

## Files to Modify

| File | Changes |
|------|---------|
| `src/core/webview/ClineProvider.ts` | Add `workspaceFolderIndex` param, support multiple instances |
| `src/core/task/Task.ts` | Add `automationId`, `automationSource`, `workspacePath` |
| `packages/types/src/task.ts` | Extend TaskLike with automation fields |
| `src/utils/path.ts` | Add `getAllWorkspacePaths()`, modify `getWorkspacePath()` |
| `src/extension.ts` | Initialize AutomationManager, WorkspaceManager |
| `src/package.json` | Add automation settings to contributes.configuration |

---

## Implementation Phases

### Phase 1: Foundation (Priority: HIGH)
- [ ] Create type definitions in `packages/types/src/automation.ts`
- [ ] Create type definitions in `packages/types/src/workspace.ts`
- [ ] Implement `AutomationConfigLoader.ts` (YAML parsing)
- [ ] Modify `ClineProvider` to accept `workspaceFolderIndex`
- [ ] Add `automationId` and `workspacePath` to Task class

### Phase 2: File Watcher Automation (Priority: HIGH)
- [ ] Implement `BaseTrigger.ts` abstract class
- [ ] Implement `FileWatcherTrigger.ts` using `vscode.workspace.createFileSystemWatcher`
- [ ] Implement `TriggerRegistry.ts`
- [ ] Implement `AutomationExecutor.ts`
- [ ] Implement `AutomationManager.ts`
- [ ] Wire up in `extension.ts`

### Phase 3: Cron/Scheduled Automation (Priority: MEDIUM)
- [ ] Add `node-cron` dependency
- [ ] Implement `CronTrigger.ts`
- [ ] Add cron expression validation

### Phase 4: Git Hook Integration (Priority: MEDIUM)
- [ ] Implement `GitHookTrigger.ts`
- [ ] Integrate with VS Code Git extension API
- [ ] Add branch filtering

### Phase 5: Multi-Project Support (Priority: MEDIUM)
- [ ] Implement `WorkspaceManager.ts`
- [ ] Create per-workspace ClineProvider instances
- [ ] Add workspace selector UI in webview
- [ ] Context isolation between workspaces

### Phase 6: Cross-Project Orchestration (Priority: LOW)
- [ ] Implement `CrossProjectOrchestrator.ts`
- [ ] Task dependency ordering
- [ ] Shared context propagation

### Phase 7: UI & Polish (Priority: LOW)
- [ ] Visual automation builder in webview
- [ ] Automation templates
- [ ] Execution history/logs

---

## Key Code Patterns

### FileWatcherTrigger (based on existing WorkspaceTracker)
```typescript
export class FileWatcherTrigger extends BaseTrigger {
  private watcher?: vscode.FileSystemWatcher

  async start(): Promise<void> {
    const pattern = new vscode.RelativePattern(
      this.workspacePath,
      this.config.patterns.join(",")
    )
    this.watcher = vscode.workspace.createFileSystemWatcher(pattern)
    this.watcher.onDidChange((uri) => this.handleEvent("change", uri))
    this.watcher.onDidCreate((uri) => this.handleEvent("create", uri))
  }
}
```

### Workspace-Scoped ClineProvider
```typescript
// Modified constructor
constructor(
  context: vscode.ExtensionContext,
  outputChannel: vscode.OutputChannel,
  renderContext: "sidebar" | "editor",
  contextProxy: ContextProxy,
  mdmService?: MdmService,
  workspaceFolderIndex?: number  // NEW
) {
  this.currentWorkspacePath = workspaceFolderIndex !== undefined
    ? vscode.workspace.workspaceFolders?.[workspaceFolderIndex]?.uri.fsPath
    : getWorkspacePath()
}
```

---

## Dependencies to Add

```json
{
  "dependencies": {
    "node-cron": "^3.0.3"
  },
  "devDependencies": {
    "@types/node-cron": "^3.0.11"
  }
}
```

## VS Code Settings to Add

```json
{
  "multi-agent.automations.enabled": true,
  "multi-agent.automations.configPath": ".multiagent/automations.yaml",
  "multi-agent.multiProject.enabled": false,
  "multi-agent.multiProject.autoCreateAgents": true
}
```

---

## Notes
- All features are opt-in (backward compatible)
- Single-workspace behavior preserved when multi-project disabled
- Existing task history and settings unaffected
- Configuration files are version-controllable
