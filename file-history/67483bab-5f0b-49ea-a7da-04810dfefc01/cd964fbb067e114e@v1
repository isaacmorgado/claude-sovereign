# MultiAgent Automations

Automations allow you to configure AI tasks that trigger automatically based on file changes, schedules, or git events. This enables powerful workflows like auto-running tests, linting on save, or daily code reviews.

## Quick Start

1. Create `.multiagent/automations.yaml` in your workspace root
2. Define your automations with triggers and actions
3. The extension will automatically load and activate them

```yaml
version: "1.0"
automations:
  - id: my-first-automation
    name: Auto Test on Save
    enabled: true
    trigger:
      type: file_watcher
      patterns: ["**/*.test.ts"]
      events: [save]
    action:
      prompt: "Run tests for {{triggerFile}}"
      mode: test
```

## Configuration File

The automation configuration file should be placed at `.multiagent/automations.yaml` in your workspace root.

### Schema

```yaml
version: "1.0"  # Configuration version
automations:    # List of automation definitions
  - id: string              # Unique identifier (required)
    name: string            # Human-readable name (required)
    enabled: boolean        # Whether automation is active (default: true)
    trigger: TriggerConfig  # What triggers the automation
    action: ActionConfig    # What to do when triggered
    conditions: Conditions  # Optional execution conditions
```

## Trigger Types

### File Watcher Trigger

Watches for file system changes matching specified patterns.

```yaml
trigger:
  type: file_watcher
  patterns:                    # Glob patterns to watch (required)
    - "**/*.ts"
    - "**/*.tsx"
    - "src/**/*.js"
  events:                      # Events to listen for (required)
    - create                   # File created
    - change                   # File modified
    - delete                   # File deleted
    - save                     # File saved (VS Code save event)
  debounceMs: 500              # Debounce delay in milliseconds (default: 500)
  excludePatterns:             # Patterns to exclude (optional)
    - "**/node_modules/**"
    - "**/dist/**"
    - "**/.git/**"
```

**Pattern Examples:**
- `**/*.ts` - All TypeScript files
- `src/**/*.tsx` - All TSX files under src/
- `*.json` - JSON files in root only
- `{src,lib}/**/*.js` - JS files in src/ or lib/

### Cron Trigger (Coming Soon)

Schedule automations using cron expressions.

```yaml
trigger:
  type: cron
  schedule: "0 9 * * 1-5"      # Run at 9am weekdays
  timezone: "America/New_York" # Optional timezone
```

**Cron Expression Format:**
```
┌───────────── minute (0-59)
│ ┌───────────── hour (0-23)
│ │ ┌───────────── day of month (1-31)
│ │ │ ┌───────────── month (1-12)
│ │ │ │ ┌───────────── day of week (0-6, Sun=0)
│ │ │ │ │
* * * * *
```

**Common Schedules:**
- `0 9 * * 1-5` - 9am weekdays
- `0 */2 * * *` - Every 2 hours
- `30 8 * * 1` - 8:30am every Monday
- `0 0 1 * *` - First day of each month

### Git Hook Trigger (Coming Soon)

Trigger on git events.

```yaml
trigger:
  type: git_hook
  hook: pre-commit             # Git hook type
  branches:                    # Optional branch filter
    - main
    - develop
```

**Supported Hooks:**
- `pre-commit` - Before commit
- `post-commit` - After commit
- `pre-push` - Before push
- `post-merge` - After merge
- `post-checkout` - After checkout

## Action Configuration

Define what happens when the trigger fires.

```yaml
action:
  prompt: string               # The prompt to send to the AI (required)
  mode: string                 # Agent mode to use (optional)
  providerProfile: string      # API profile to use (optional)
  autoApprove: boolean         # Auto-approve tool usage (default: false)
```

### Template Variables

Use these variables in your prompt to include trigger context:

| Variable | Description | Example |
|----------|-------------|---------|
| `{{triggerFile}}` | Full path to triggered file | `/path/to/file.ts` |
| `{{triggerEvent}}` | Event type | `save`, `create`, `change`, `delete` |
| `{{triggerTime}}` | ISO timestamp | `2024-01-15T10:30:00.000Z` |
| `{{workspacePath}}` | Workspace root path | `/path/to/workspace` |
| `{{branch}}` | Current git branch | `main` |
| `{{commit}}` | Latest commit hash | `abc123` |

### Examples

**Run tests on file save:**
```yaml
action:
  prompt: "Run the test file {{triggerFile}} and fix any failing tests"
  mode: test
  autoApprove: true
```

**Lint and format on change:**
```yaml
action:
  prompt: "Run linting and formatting on {{triggerFile}}. Fix any issues found."
  mode: code
```

**Code review:**
```yaml
action:
  prompt: "Review the changes in {{triggerFile}} for potential issues, security concerns, and code quality. Provide suggestions for improvement."
  mode: architect
```

## Conditions (Optional)

Add conditions to control when automations execute.

```yaml
conditions:
  branchPattern: "^(main|develop)$"  # Regex for allowed branches
  maxExecutionsPerHour: 10           # Rate limiting
  workingHoursOnly: true             # Only during work hours
  workingHours:
    start: "09:00"
    end: "17:00"
    timezone: "America/New_York"
```

## Complete Examples

### Auto Test Runner

```yaml
version: "1.0"
automations:
  - id: auto-test-runner
    name: Auto Test Runner
    enabled: true
    trigger:
      type: file_watcher
      patterns:
        - "**/*.test.ts"
        - "**/*.spec.ts"
        - "**/*.test.tsx"
        - "**/*.spec.tsx"
      events: [save]
      debounceMs: 1000
      excludePatterns:
        - "**/node_modules/**"
    action:
      prompt: |
        Run the tests in {{triggerFile}}.
        If any tests fail, analyze the failure and fix the issue.
        Ensure all tests pass before completing.
      mode: test
      autoApprove: true
```

### Lint on Save

```yaml
version: "1.0"
automations:
  - id: lint-on-save
    name: Lint on Save
    enabled: true
    trigger:
      type: file_watcher
      patterns: ["**/*.ts", "**/*.tsx", "**/*.js", "**/*.jsx"]
      events: [save]
      debounceMs: 300
      excludePatterns:
        - "**/node_modules/**"
        - "**/dist/**"
        - "**/*.d.ts"
    action:
      prompt: "Run ESLint on {{triggerFile}} and fix any auto-fixable issues"
      mode: code
```

### Documentation Generator

```yaml
version: "1.0"
automations:
  - id: doc-generator
    name: Documentation Generator
    enabled: true
    trigger:
      type: file_watcher
      patterns: ["src/**/*.ts"]
      events: [create]
      excludePatterns:
        - "**/*.test.ts"
        - "**/*.spec.ts"
    action:
      prompt: |
        A new file was created at {{triggerFile}}.
        Add appropriate JSDoc comments to all exported functions and classes.
        Follow the existing documentation style in the project.
      mode: code
```

### Daily Code Review

```yaml
version: "1.0"
automations:
  - id: daily-review
    name: Daily Code Review
    enabled: true
    trigger:
      type: cron
      schedule: "0 9 * * 1-5"
    action:
      prompt: |
        Review all uncommitted changes in the repository.
        Check for:
        - Code quality issues
        - Potential bugs
        - Security concerns
        - Missing tests
        - Documentation gaps

        Provide a summary and suggestions for improvement.
      mode: architect
    conditions:
      branchPattern: "^(main|develop|feature/.*)$"
```

### Pre-commit Check

```yaml
version: "1.0"
automations:
  - id: pre-commit-check
    name: Pre-commit Check
    enabled: true
    trigger:
      type: git_hook
      hook: pre-commit
    action:
      prompt: |
        Check all staged files for:
        - TypeScript errors
        - ESLint violations
        - Formatting issues
        - Missing imports

        Fix any issues found before allowing the commit.
      mode: code
      autoApprove: true
```

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    AutomationManager                         │
│  - Coordinates all components                                │
│  - Handles lifecycle (init, start, stop, dispose)           │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          │                   │                   │
          ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│AutomationConfig │ │TriggerRegistry  │ │AutomationExecutor│
│Loader           │ │                 │ │                 │
│- YAML parsing   │ │- Manages all    │ │- Creates tasks  │
│- File watching  │ │  trigger        │ │- Interpolates   │
│- Validation     │ │  instances      │ │  variables      │
└─────────────────┘ └─────────────────┘ └─────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          │                   │                   │
          ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│FileWatcherTrigger│ │CronTrigger     │ │GitHookTrigger   │
│(implemented)    │ │(coming soon)   │ │(coming soon)    │
│                 │ │                 │ │                 │
│Uses VS Code     │ │Uses node-cron  │ │Uses VS Code Git │
│FileSystemWatcher│ │                │ │Extension API    │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

## Troubleshooting

### Automation Not Triggering

1. Check that the automation is enabled (`enabled: true`)
2. Verify the file patterns match your files
3. Check the debounce timing (rapid changes may be debounced)
4. Look at the VS Code output panel for errors

### Config Not Loading

1. Ensure the file is at `.multiagent/automations.yaml`
2. Check YAML syntax is valid
3. Verify the version field is `"1.0"`
4. Check for validation errors in the output panel

### Too Many Triggers

1. Increase `debounceMs` value
2. Add more specific `excludePatterns`
3. Use `conditions.maxExecutionsPerHour` to rate limit

## API Reference

### AutomationManager

```typescript
import { AutomationManager } from './services/automation'

const manager = new AutomationManager({
  workspacePath: '/path/to/workspace',
  taskProvider: clineProvider,
  enabled: true
})

await manager.initialize()

// Events
manager.onAutomationTriggered((event) => {
  console.log('Triggered:', event.automation.name)
})

manager.onAutomationExecuted((result) => {
  console.log('Executed:', result.success)
})

// Manual trigger
await manager.triggerManually('automation-id')

// Cleanup
await manager.dispose()
```

### Creating Custom Triggers

```typescript
import { BaseTrigger, BaseTriggerOptions } from './services/automation/triggers'

export class CustomTrigger extends BaseTrigger {
  constructor(options: BaseTriggerOptions) {
    super(options)
  }

  get type(): string {
    return 'custom'
  }

  async start(): Promise<void> {
    // Set up your trigger logic
    this.isRunning = true
  }

  async stop(): Promise<void> {
    // Clean up resources
    this.isRunning = false
  }
}
```
