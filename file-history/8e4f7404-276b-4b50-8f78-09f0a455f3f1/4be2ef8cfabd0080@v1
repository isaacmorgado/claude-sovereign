#!/usr/bin/env python3
"""
Image Replacement Script

This script replaces the original male_white landmark images with the new
accurate images generated using dlib (front) and FAN (side profiles).

It only replaces landmarks that exist in BOTH the original and new sets.
"""

import shutil
from pathlib import Path

# Base directory
BASE_DIR = Path(__file__).parent

# Source directories (new accurate images)
FRONT_SOURCES = {
    "blonde_front": BASE_DIR / "output_accurate" / "front" / "blonde_front",
    "brown_front": BASE_DIR / "output_accurate" / "front" / "brown_front",
}

SIDE_SOURCES = {
    "blonde_side_left": BASE_DIR / "output_fan" / "blonde_side_left",
    "blonde_side_right": BASE_DIR / "output_fan" / "blonde_side_right",
    "brown_side_left": BASE_DIR / "output_fan" / "brown_side_left",
    "brown_side_right": BASE_DIR / "output_fan" / "brown_side_right",
}

# Destination directories (project public/landmarks)
PROJECT_DIR = Path("/Users/imorgado/LOOKSMAXX/looksmaxx-app/public/landmarks")
FRONT_DEST = PROJECT_DIR / "front"
SIDE_DEST = PROJECT_DIR / "side"

# FRONT landmarks that match between original (male_white) and new (dlib)
FRONT_MATCHING_LANDMARKS = [
    "chinBottom",
    "chinLeft",
    "chinRight",
    "cupidsBow",
    "innerCupidsBow",
    "leftBottomGonion",
    "leftBrowArch",
    "leftBrowHead",
    "leftBrowInnerCorner",
    "leftBrowPeak",
    "leftBrowTail",
    "leftEyeLateralCanthus",
    "leftEyeLowerEyelid",
    "leftEyeMedialCanthus",
    "leftEyePupil",
    "leftEyeUpperEyelid",
    "leftNoseBridge",
    "leftTopGonion",
    "lowerLip",
    "mouthLeft",
    "mouthMiddle",
    "mouthRight",
    "nasalBase",
    "noseBottom",
    "noseLeft",
    "noseRight",
    "rightBottomGonion",
    "rightBrowArch",
    "rightBrowHead",
    "rightBrowInnerCorner",
    "rightBrowPeak",
    "rightBrowTail",
    "rightEyeLateralCanthus",
    "rightEyeLowerEyelid",
    "rightEyeMedialCanthus",
    "rightEyePupil",
    "rightEyeUpperEyelid",
    "rightNoseBridge",
    "rightTopGonion",
]

# SIDE landmarks that match between original (male_white) and new (FAN)
SIDE_MATCHING_LANDMARKS = [
    "cervicalPoint",
    "cheekbone",
    "cheilion",
    "columella",
    "cornealApex",
    "forehead",
    "glabella",
    "gonionBottom",
    "gonionTop",
    "intertragicNotch",
    "labraleInferius",
    "labraleSuperius",
    "lowerEyelid",
    "menton",
    "nasion",
    "orbitale",
    "pogonion",
    "pronasale",
    "subnasale",
]

# Mapping from new output prefixes to target prefixes
# Format: source_prefix -> target_prefix
FRONT_PREFIX_MAP = {
    "blonde_front": "female_white",      # blonde front -> female_white
    "brown_front": "male_brown",         # brown front -> male_brown
}

SIDE_PREFIX_MAP = {
    "blonde_side_left": "female_white",  # blonde side -> female_white
    "blonde_side_right": "female_white",
    "brown_side_left": "male_brown",     # brown side -> male_brown
    "brown_side_right": "male_brown",
}


def replace_front_images(source_name: str, source_dir: Path, target_prefix: str, dry_run: bool = True):
    """Replace front-facing landmark images."""
    replaced = 0
    skipped = 0

    for landmark in FRONT_MATCHING_LANDMARKS:
        source_file = source_dir / f"{source_name}_{landmark}.webp"
        target_file = FRONT_DEST / f"{target_prefix}_{landmark}.webp"

        if source_file.exists():
            if dry_run:
                print(f"  [DRY RUN] Would copy: {source_file.name} -> {target_file.name}")
            else:
                shutil.copy2(source_file, target_file)
                print(f"  Replaced: {target_file.name}")
            replaced += 1
        else:
            skipped += 1

    return replaced, skipped


def replace_side_images(source_name: str, source_dir: Path, target_prefix: str, dry_run: bool = True):
    """Replace side profile landmark images."""
    replaced = 0
    skipped = 0

    for landmark in SIDE_MATCHING_LANDMARKS:
        source_file = source_dir / f"{source_name}_{landmark}.webp"
        target_file = SIDE_DEST / f"{target_prefix}_{landmark}.webp"

        if source_file.exists():
            if dry_run:
                print(f"  [DRY RUN] Would copy: {source_file.name} -> {target_file.name}")
            else:
                shutil.copy2(source_file, target_file)
                print(f"  Replaced: {target_file.name}")
            replaced += 1
        else:
            skipped += 1

    return replaced, skipped


def main():
    import argparse

    parser = argparse.ArgumentParser(description="Replace landmark images with accurate versions")
    parser.add_argument("--dry-run", action="store_true", default=True,
                        help="Show what would be replaced without actually replacing (default: True)")
    parser.add_argument("--execute", action="store_true",
                        help="Actually replace the files")
    parser.add_argument("--target-prefix", type=str, default=None,
                        help="Custom target prefix for output files (e.g., 'female_white', 'male_brown')")

    args = parser.parse_args()
    dry_run = not args.execute

    if dry_run:
        print("=" * 60)
        print("DRY RUN MODE - No files will be modified")
        print("Use --execute to actually replace files")
        print("=" * 60)
    else:
        print("=" * 60)
        print("EXECUTING - Files will be replaced")
        print("=" * 60)

    total_replaced = 0
    total_skipped = 0

    # Process front images
    print("\n=== FRONT IMAGES ===")
    for source_name, source_dir in FRONT_SOURCES.items():
        target_prefix = args.target_prefix or FRONT_PREFIX_MAP.get(source_name, source_name)
        print(f"\nSource: {source_name} -> Target prefix: {target_prefix}")

        if source_dir.exists():
            replaced, skipped = replace_front_images(source_name, source_dir, target_prefix, dry_run)
            total_replaced += replaced
            total_skipped += skipped
            print(f"  Total: {replaced} replaced, {skipped} skipped")
        else:
            print(f"  Source directory not found: {source_dir}")

    # Process side images
    print("\n=== SIDE IMAGES ===")
    for source_name, source_dir in SIDE_SOURCES.items():
        target_prefix = args.target_prefix or SIDE_PREFIX_MAP.get(source_name, source_name)
        print(f"\nSource: {source_name} -> Target prefix: {target_prefix}")

        if source_dir.exists():
            replaced, skipped = replace_side_images(source_name, source_dir, target_prefix, dry_run)
            total_replaced += replaced
            total_skipped += skipped
            print(f"  Total: {replaced} replaced, {skipped} skipped")
        else:
            print(f"  Source directory not found: {source_dir}")

    print("\n" + "=" * 60)
    print(f"SUMMARY: {total_replaced} files {'would be ' if dry_run else ''}replaced, {total_skipped} skipped")
    print("=" * 60)

    if dry_run:
        print("\nTo execute the replacement, run:")
        print("  python replace_images.py --execute")


if __name__ == "__main__":
    main()
