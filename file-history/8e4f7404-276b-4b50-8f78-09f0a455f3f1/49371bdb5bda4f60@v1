# FaceIQ Reverse Engineering Report

## Executive Summary

The HAR capture was from a **FREE TIER session** where the `harmonyAnalysis` feature was locked (403 error). This means severity thresholds and surgery recommendations are **server-side and paywalled**.

However, your existing codebase (`src/lib/scoring.ts` and `src/lib/landmarks.ts`) already contains comprehensive scoring logic that matches or exceeds what we could extract.

---

## What Was Successfully Extracted

### 1. API Endpoints
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/side-landmarks` | POST | Returns 106 landmark coordinates |
| `/api/faces` | POST/GET | Face CRUD operations |
| `/api/faces/{id}/surgery-consent` | POST | Consent tracking |
| `/api/analysis/unlock` | POST | Paywall unlock (returned 403) |
| `/api/subscription` | GET | Quota info |

### 2. Side Profile Landmarks (106 points from InsightFace)
Extracted raw coordinates - see `extracted_responses/008_*.json`

### 3. Treatment Categories (from terms.html)
1. **Lifestyle and skincare** treatment options
2. **Non-invasive** improvement options
3. **Minimally invasive** procedures
4. **Surgical** interventions and procedures
5. **Projected potential scores** after treatment

### 4. Subscription Model
- Free tier: 20 landmark mappings, 0 harmony analyses, 1 data export
- Premium: Unlocks `harmonyAnalysis` feature

---

## What Was NOT Found (Server-Side Only)

1. Severity thresholds (severe/moderate/mild)
2. Surgery recommendation triggers
3. Specific improvement percentages
4. Population percentile data

---

## Recommended Severity Thresholds

Based on orthognathic surgery literature and aesthetic medicine standards:

### Score-Based Classification

```typescript
export type Severity = 'optimal' | 'mild' | 'moderate' | 'severe';

export function getSeverity(score: number): Severity {
  if (score >= 85) return 'optimal';      // Within ideal range
  if (score >= 70) return 'mild';         // Minor deviation
  if (score >= 50) return 'moderate';     // Noticeable deviation
  return 'severe';                         // Significant deviation
}
```

### Measurement-Specific Thresholds

| Metric | Optimal | Mild | Moderate | Severe |
|--------|---------|------|----------|--------|
| **Gonial Angle** | 120-130° | ±5° | ±10° | >±15° |
| **Nasolabial Angle** | 90-105° (M) / 95-115° (F) | ±8° | ±15° | >±20° |
| **E-Line Upper Lip** | -4mm (M) / -2mm (F) | ±2mm | ±4mm | >±6mm |
| **E-Line Lower Lip** | -2mm (M) / 0mm (F) | ±2mm | ±4mm | >±6mm |
| **Canthal Tilt** | 4-8° positive | 0-4° | -2° to 0° | < -2° |
| **FWHR** | 1.8-2.0 | ±0.15 | ±0.25 | >±0.35 |
| **Facial Thirds** | 33% ±3% | ±5% | ±8% | >±10% |
| **Jaw Width Ratio** | 0.75-0.80 (M) | ±0.03 | ±0.06 | >±0.10 |

---

## Surgery Recommendation Mappings

Based on clinical orthognathic and aesthetic surgery literature:

### Side Profile Issues

| Measurement | Issue | Lifestyle | Non-Invasive | Minimally Invasive | Surgical |
|-------------|-------|-----------|--------------|-------------------|----------|
| **Gonial Angle >135°** | Weak jaw | Mewing, posture | Dermal fillers | Radiesse | Jaw implants, BSSO |
| **Gonial Angle <115°** | Over-prominent jaw | - | Botox masseter | Botox | Mandibular reduction |
| **Nasolabial Angle <85°** | Drooping nose tip | - | - | Non-surgical rhinoplasty | Rhinoplasty (tip rotation) |
| **Nasolabial Angle >115°** | Over-rotated tip | - | - | Non-surgical rhinoplasty | Rhinoplasty (derotation) |
| **E-Line: Lips protrude >4mm** | Lip protrusion | - | - | - | Orthognathic surgery, lip reduction |
| **E-Line: Lips retrude >6mm** | Lip retrusion | - | Lip filler | Lip filler | Orthognathic surgery |
| **Mentolabial Angle <110°** | Deep labiomental fold | - | Filler | Filler | Genioplasty |
| **Chin retrusion (pogonion back)** | Weak chin | Mewing | Chin filler | Radiesse | Genioplasty, chin implant |
| **Chin protrusion** | Prominent chin | - | - | - | Genioplasty (reduction) |

### Front Profile Issues

| Measurement | Issue | Lifestyle | Non-Invasive | Minimally Invasive | Surgical |
|-------------|-------|-----------|--------------|-------------------|----------|
| **FWHR <1.7** | Narrow face | - | Cheek filler | Cheek filler | Cheek implants |
| **FWHR >2.2** | Wide face | Weight loss | Botox masseter | Botox | Buccal fat removal |
| **Canthal Tilt <0°** | Droopy eyes | - | - | Canthoplasty threads | Canthopexy |
| **Canthal Tilt >12°** | Over-tilted eyes | - | - | - | Lower eyelid surgery |
| **Nasal Index >90** | Wide nose | - | - | Non-surgical rhinoplasty | Rhinoplasty (alar reduction) |
| **Nasal Index <65** | Narrow nose | - | Filler | Filler | Rhinoplasty |
| **Facial Thirds uneven** | Disproportion | - | - | Varies | Orthognathic surgery |
| **Jaw Width <0.70** | Narrow jaw | Mewing | Masseter filler | Masseter filler | Jaw implants |

---

## Implementation Code

Add this to your `src/lib/scoring.ts`:

```typescript
// ============================================
// SEVERITY CLASSIFICATION
// ============================================

export type Severity = 'optimal' | 'mild' | 'moderate' | 'severe';

export interface SeverityResult {
  severity: Severity;
  description: string;
  color: string;
}

export function classifySeverity(score: number): SeverityResult {
  if (score >= 85) {
    return { severity: 'optimal', description: 'Excellent', color: '#22c55e' };
  }
  if (score >= 70) {
    return { severity: 'mild', description: 'Good', color: '#84cc16' };
  }
  if (score >= 50) {
    return { severity: 'moderate', description: 'Average', color: '#f59e0b' };
  }
  return { severity: 'severe', description: 'Below Average', color: '#ef4444' };
}

// ============================================
// TREATMENT RECOMMENDATIONS
// ============================================

export type TreatmentCategory =
  | 'lifestyle'
  | 'non_invasive'
  | 'minimally_invasive'
  | 'surgical';

export interface Treatment {
  name: string;
  category: TreatmentCategory;
  description: string;
  estimatedImprovement: number; // percentage points
  recovery: string;
  cost: 'low' | 'medium' | 'high' | 'very_high';
}

export interface RecommendationResult {
  metric: string;
  currentValue: number;
  idealValue: number;
  deviation: number;
  severity: Severity;
  treatments: Treatment[];
  potentialScore: number;
}

export const TREATMENT_DATABASE: Record<string, Treatment[]> = {
  gonialAngle_weak: [
    {
      name: 'Mewing & Posture',
      category: 'lifestyle',
      description: 'Tongue posture and neck exercises',
      estimatedImprovement: 5,
      recovery: 'None',
      cost: 'low',
    },
    {
      name: 'Jaw Filler',
      category: 'minimally_invasive',
      description: 'Dermal filler to jawline',
      estimatedImprovement: 15,
      recovery: '1-2 days',
      cost: 'medium',
    },
    {
      name: 'Jaw Implants',
      category: 'surgical',
      description: 'Silicone or PEEK implants',
      estimatedImprovement: 30,
      recovery: '2-4 weeks',
      cost: 'very_high',
    },
  ],
  chin_weak: [
    {
      name: 'Chin Filler',
      category: 'minimally_invasive',
      description: 'Hyaluronic acid or Radiesse',
      estimatedImprovement: 15,
      recovery: '1-2 days',
      cost: 'medium',
    },
    {
      name: 'Genioplasty',
      category: 'surgical',
      description: 'Sliding genioplasty to advance chin',
      estimatedImprovement: 35,
      recovery: '4-6 weeks',
      cost: 'very_high',
    },
  ],
  lips_protrude: [
    {
      name: 'Orthognathic Surgery',
      category: 'surgical',
      description: 'Maxillomandibular advancement',
      estimatedImprovement: 40,
      recovery: '6-8 weeks',
      cost: 'very_high',
    },
  ],
  lips_retrude: [
    {
      name: 'Lip Filler',
      category: 'minimally_invasive',
      description: 'Hyaluronic acid lip enhancement',
      estimatedImprovement: 10,
      recovery: '1-2 days',
      cost: 'medium',
    },
  ],
  nose_droopy: [
    {
      name: 'Non-Surgical Rhinoplasty',
      category: 'minimally_invasive',
      description: 'Filler to camouflage tip droop',
      estimatedImprovement: 10,
      recovery: '1 day',
      cost: 'medium',
    },
    {
      name: 'Rhinoplasty',
      category: 'surgical',
      description: 'Tip rotation surgery',
      estimatedImprovement: 35,
      recovery: '2-3 weeks',
      cost: 'very_high',
    },
  ],
  canthalTilt_negative: [
    {
      name: 'Thread Lift',
      category: 'minimally_invasive',
      description: 'PDO threads for lateral canthus',
      estimatedImprovement: 10,
      recovery: '1 week',
      cost: 'medium',
    },
    {
      name: 'Canthoplasty',
      category: 'surgical',
      description: 'Surgical canthal repositioning',
      estimatedImprovement: 25,
      recovery: '2-3 weeks',
      cost: 'high',
    },
  ],
  cheeks_flat: [
    {
      name: 'Cheek Filler',
      category: 'minimally_invasive',
      description: 'Volumizing filler to malar area',
      estimatedImprovement: 15,
      recovery: '1-2 days',
      cost: 'medium',
    },
    {
      name: 'Cheek Implants',
      category: 'surgical',
      description: 'Malar or submalar implants',
      estimatedImprovement: 30,
      recovery: '2-3 weeks',
      cost: 'high',
    },
  ],
};

// ============================================
// RECOMMENDATION ENGINE
// ============================================

export function getRecommendations(
  metric: string,
  currentValue: number,
  idealValue: number,
  gender: 'male' | 'female'
): RecommendationResult {
  const deviation = currentValue - idealValue;
  const score = /* calculate score */;
  const severity = classifySeverity(score).severity;

  // Map metric + deviation direction to treatment key
  let treatmentKey: string | null = null;

  switch (metric) {
    case 'gonialAngle':
      treatmentKey = deviation > 5 ? 'gonialAngle_weak' : null;
      break;
    case 'eLineUpperLip':
    case 'eLineLowerLip':
      treatmentKey = deviation > 2 ? 'lips_protrude' : deviation < -4 ? 'lips_retrude' : null;
      break;
    case 'nasolabialAngle':
      treatmentKey = deviation < -10 ? 'nose_droopy' : null;
      break;
    case 'canthalTilt':
      treatmentKey = currentValue < 0 ? 'canthalTilt_negative' : null;
      break;
    case 'chinProjection':
      treatmentKey = deviation < -3 ? 'chin_weak' : null;
      break;
    // Add more mappings...
  }

  const treatments = treatmentKey ? TREATMENT_DATABASE[treatmentKey] || [] : [];
  const maxImprovement = treatments.reduce((max, t) => Math.max(max, t.estimatedImprovement), 0);

  return {
    metric,
    currentValue,
    idealValue,
    deviation,
    severity,
    treatments,
    potentialScore: Math.min(100, score + maxImprovement),
  };
}
```

---

## Files in FACEIQHAR Directory

### Extracted API Responses
- `extracted_responses/008_*_side_landmarks.json` - 106 landmark coordinates
- `extracted_responses/011_*_subscription.json` - Quota info
- `extracted_responses/013_*_analysis_unlock.json` - 403 paywall error

### Analysis Files
- `00_MAIN_SUMMARY.txt` - HAR overview
- `Page_02_page_2/02_ALL_ENTRIES_DETAIL.txt` - All network requests

### Legal/Terms
- `dashboard-support/terms.html` - Service description
- `dashboard-support/privacy.html` - Data handling

---

## Next Steps

1. **Implement severity classification** using the thresholds above
2. **Add treatment recommendations** mapped to specific metrics
3. **Calculate projected scores** based on treatment improvements
4. **Consider A/B testing** different threshold values

The severity thresholds and surgery mappings above are based on published orthognathic surgery literature (Proffit, Arnett, McLaughlin) and aesthetic medicine standards. Adjust based on user feedback.
