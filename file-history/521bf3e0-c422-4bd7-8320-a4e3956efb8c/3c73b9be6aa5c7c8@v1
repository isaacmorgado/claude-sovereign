/**
 * SPLICE Plugin Configuration
 *
 * Constants and configuration values used across all slices.
 */

// Backend API configuration
const BACKEND_URL_DEV = 'https://127.0.0.1:3847';
const BACKEND_URL_PROD = 'https://splice-api-production.up.railway.app';

// Default to dev URL - production detection handled by getBackendUrl()
const BACKEND_URL = BACKEND_URL_DEV;

/**
 * Get the backend URL with consistent fallback logic.
 * Used across all plugin modules for API calls.
 * @returns {string} Backend API base URL
 */
function getBackendUrl() {
  // Check if explicitly defined
  if (typeof BACKEND_URL !== 'undefined' && BACKEND_URL) {
    return BACKEND_URL;
  }
  // Fallback to dev URL (use 127.0.0.1, not localhost - UXP requirement)
  return BACKEND_URL_DEV;
}

const WAV_PATH = '/tmp/splice_audio_export.wav';
const XML_PATH = '/tmp/splice_export.xml';

// WAV export preset path (Premiere Pro Beta)
const WAV_PRESET_PATH = '/Applications/Adobe Premiere Pro (Beta)/Adobe Premiere Pro (Beta).app/Contents/Settings/EncoderPresets/Wave48mono16.epr';

// Premiere Pro timebase (ticks per second)
const TICKS_PER_SECOND = 254016000000;

// Fetch timeout configuration (milliseconds)
const FETCH_TIMEOUT_DEFAULT = 30000;      // 30 seconds for most requests
const FETCH_TIMEOUT_HEALTH = 5000;        // 5 seconds for health checks
const FETCH_TIMEOUT_PROCESSING = 120000;  // 2 minutes for processing endpoints

/**
 * Fetch with timeout support (AbortController-based).
 * Prevents UI from freezing if server hangs.
 * @param {string} url - URL to fetch
 * @param {Object} options - Fetch options
 * @param {number} [timeout] - Timeout in milliseconds (default: FETCH_TIMEOUT_DEFAULT)
 * @returns {Promise<Response>} Fetch response
 * @throws {Error} 'Request timed out' if timeout exceeded
 */
async function fetchWithTimeout(url, options = {}, timeout = FETCH_TIMEOUT_DEFAULT) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeout);

  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal
    });
    clearTimeout(timeoutId);
    return response;
  } catch (err) {
    clearTimeout(timeoutId);
    if (err.name === 'AbortError') {
      throw new Error('Request timed out');
    }
    throw err;
  }
}

/**
 * Parse error response from API with consistent fallback.
 * Handles various error response formats gracefully.
 * @param {Response} response - Fetch response object
 * @returns {Promise<string>} Error message string
 */
async function parseErrorResponse(response) {
  try {
    const data = await response.json();
    return data.error || data.message || `Error ${response.status}`;
  } catch {
    return `Error ${response.status}: ${response.statusText || 'Unknown error'}`;
  }
}
