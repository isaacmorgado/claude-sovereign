#!/bin/bash
#
# SPLICE Installation Verification Script
# Run this after installing SPLICE to verify everything is working
#

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo "========================================"
echo "SPLICE Installation Verification"
echo "========================================"
echo ""

# Test counters
TESTS_PASSED=0
TESTS_FAILED=0
TESTS_TOTAL=0

# Test result tracking
FAILED_TESTS=()

run_test() {
    local test_name="$1"
    local test_command="$2"

    TESTS_TOTAL=$((TESTS_TOTAL + 1))
    echo -n "[$TESTS_TOTAL] Testing: $test_name... "

    if eval "$test_command" > /dev/null 2>&1; then
        echo -e "${GREEN}‚úì PASS${NC}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        return 0
    else
        echo -e "${RED}‚úó FAIL${NC}"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        FAILED_TESTS+=("$test_name")
        return 1
    fi
}

run_test_with_output() {
    local test_name="$1"
    local test_command="$2"
    local expected="$3"

    TESTS_TOTAL=$((TESTS_TOTAL + 1))
    echo -n "[$TESTS_TOTAL] Testing: $test_name... "

    local output=$(eval "$test_command" 2>&1)
    if [[ "$output" == *"$expected"* ]]; then
        echo -e "${GREEN}‚úì PASS${NC}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        return 0
    else
        echo -e "${RED}‚úó FAIL${NC}"
        echo "  Expected: $expected"
        echo "  Got: $output"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        FAILED_TESTS+=("$test_name")
        return 1
    fi
}

echo -e "${BLUE}=== File Existence Tests ===${NC}"
echo ""

# CEP Extension Files
run_test "CEP Extension directory exists" \
    "test -d '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel'"

run_test "CEP manifest.xml exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/CSXS/manifest.xml'"

run_test "CEP index.html exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/panel/index.html'"

run_test "CEP hostScript.jsx exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/jsx/hostScript.jsx'"

run_test "CEP main.js exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/panel/js/main.js'"

run_test "CEP config.js exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/panel/js/config.js'"

# JavaScript modules
run_test "Music module exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/panel/js/music.js'"

run_test "Animated Captions module exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/panel/js/animatedCaptions.js'"

run_test "Text Editor module exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/panel/js/textEditor.js'"

run_test "Social Reframe module exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/panel/js/socialReframe.js'"

echo ""
echo -e "${BLUE}=== Content Validation Tests ===${NC}"
echo ""

# Check manifest version
run_test_with_output "CEP manifest version" \
    "grep 'ExtensionBundleVersion' '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/CSXS/manifest.xml'" \
    "6.0.8"

# Check backend URL in config
run_test_with_output "Backend URL configuration" \
    "grep 'BACKEND_PROD' '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/panel/js/config.js'" \
    "splice-api-production.up.railway.app"

# Check AccessList in manifest
run_test_with_output "Network AccessList configured" \
    "grep 'AccessList' '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/CSXS/manifest.xml'" \
    "AccessList"

# Check for required CEF flags
run_test_with_output "CEF flags configured" \
    "grep 'allow-file-access' '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/CSXS/manifest.xml'" \
    "allow-file-access"

echo ""
echo -e "${BLUE}=== CEP Debug Mode Tests ===${NC}"
echo ""

# Check if .debug file exists
run_test ".debug file exists" \
    "test -f '/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/.debug'"

# Check debug mode is enabled in preferences
for VERSION in 12 11 10 9 8; do
    DEBUG_MODE=$(defaults read com.adobe.CSXS.$VERSION PlayerDebugMode 2>/dev/null || echo "0")
    if [ "$DEBUG_MODE" == "1" ]; then
        run_test "CEP debug mode enabled (CSXS $VERSION)" "true"
        break
    fi
done

echo ""
echo -e "${BLUE}=== File Permissions Tests ===${NC}"
echo ""

# Check file permissions
PERMISSIONS=$(stat -f "%Lp" "/Library/Application Support/Adobe/CEP/extensions/com.splice.panel" 2>/dev/null)
run_test "Extension directory has correct permissions (755)" \
    "[ '$PERMISSIONS' == '755' ]"

echo ""
echo -e "${BLUE}=== Backend Connectivity Tests ===${NC}"
echo ""

# Test backend health endpoint
if command -v curl &> /dev/null; then
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://splice-api-production.up.railway.app/health 2>&1)
    if [ "$HTTP_CODE" == "200" ]; then
        run_test "Backend health check" "true"
    else
        run_test "Backend health check (got HTTP $HTTP_CODE)" "false"
    fi
else
    echo "  ${YELLOW}‚ö† curl not found - skipping backend test${NC}"
fi

# Test CSRF endpoint
if command -v curl &> /dev/null; then
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://splice-api-production.up.railway.app/auth/csrf-token 2>&1)
    if [ "$HTTP_CODE" == "200" ]; then
        run_test "Backend CSRF endpoint" "true"
    else
        run_test "Backend CSRF endpoint (got HTTP $HTTP_CODE)" "false"
    fi
fi

echo ""
echo -e "${BLUE}=== File Size Sanity Checks ===${NC}"
echo ""

# Check that main.js is not empty
MAIN_SIZE=$(stat -f%z "/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/panel/js/main.js" 2>/dev/null || echo "0")
run_test "main.js is not empty (>50KB)" \
    "[ $MAIN_SIZE -gt 51200 ]"

# Check that hostScript.jsx is not empty
JSX_SIZE=$(stat -f%z "/Library/Application Support/Adobe/CEP/extensions/com.splice.panel/jsx/hostScript.jsx" 2>/dev/null || echo "0")
run_test "hostScript.jsx is not empty (>50KB)" \
    "[ $JSX_SIZE -gt 51200 ]"

echo ""
echo "========================================"
echo -e "${BLUE}Test Results Summary${NC}"
echo "========================================"
echo ""
echo "Total Tests:  $TESTS_TOTAL"
echo -e "${GREEN}Passed:       $TESTS_PASSED${NC}"

if [ $TESTS_FAILED -gt 0 ]; then
    echo -e "${RED}Failed:       $TESTS_FAILED${NC}"
    echo ""
    echo "Failed tests:"
    for test in "${FAILED_TESTS[@]}"; do
        echo "  ‚úó $test"
    done
else
    echo -e "${GREEN}Failed:       0${NC}"
fi

echo ""
echo "========================================"

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úì ALL TESTS PASSED!${NC}"
    echo ""
    echo "Installation verified successfully!"
    echo ""
    echo "Next steps:"
    echo "1. Open Adobe Premiere Pro"
    echo "2. Go to Window > Extensions > SPLICE"
    echo "3. Panel should load within 2 seconds"
    echo "4. Click Debug button (üîç) and run diagnostics"
    echo "5. Follow DANNY_COMPLETE_TEST_GUIDE.md for feature testing"
    echo ""
    exit 0
else
    echo -e "${RED}‚úó SOME TESTS FAILED${NC}"
    echo ""
    echo "Installation may have issues. Common solutions:"
    echo ""
    if [[ " ${FAILED_TESTS[@]} " =~ "Backend" ]]; then
        echo "Backend connectivity issues:"
        echo "  - Check internet connection"
        echo "  - Verify backend is running: https://splice-api-production.up.railway.app/health"
        echo "  - Check firewall settings"
        echo ""
    fi
    if [[ " ${FAILED_TESTS[@]} " =~ "CEP" ]] || [[ " ${FAILED_TESTS[@]} " =~ "exists" ]]; then
        echo "Installation issues:"
        echo "  - Run installer again"
        echo "  - Check if installer completed without errors"
        echo "  - Verify admin privileges during installation"
        echo ""
    fi
    if [[ " ${FAILED_TESTS[@]} " =~ "debug" ]]; then
        echo "Debug mode issues:"
        echo "  - Enable debug mode manually:"
        echo "    defaults write com.adobe.CSXS.12 PlayerDebugMode 1"
        echo "  - Restart Premiere Pro after enabling"
        echo ""
    fi
    echo "For support, run this script and send output to: support@splice.video"
    echo ""
    exit 1
fi
