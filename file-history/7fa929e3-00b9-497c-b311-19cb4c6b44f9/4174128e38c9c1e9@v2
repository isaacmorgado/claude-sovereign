#!/bin/bash
#
# SPLICE CEP Panel - ZXP Package Builder
# Creates a .zxp package from CEP panel source
#
# ZXP is Adobe's signed package format for CEP extensions
#
# Usage:
#   ./build-zxp.sh              # Create unsigned ZXP
#   ./build-zxp.sh --sign       # Create signed ZXP with ZXPSignCmd
#   ./build-zxp.sh --jsxbin     # Compile JSX to JSXBin
#   ./build-zxp.sh --sign --jsxbin  # Both signing and compilation
#

set -e

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
INSTALLER_DIR="$SCRIPT_DIR/.."

# Source and output paths
CEP_SOURCE="$PROJECT_ROOT/splice-cep"
OUTPUT_DIR="$INSTALLER_DIR/shared"
BUILD_TEMP="$INSTALLER_DIR/build/zxp-temp"

# Version info
VERSION_FILE="$INSTALLER_DIR/shared/version.json"
if [ -f "$VERSION_FILE" ]; then
    VERSION=$(grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' "$VERSION_FILE" | cut -d'"' -f4)
else
    VERSION="6.0.3"
fi

# Output filename
ZXP_OUTPUT="$OUTPUT_DIR/splice-cep.zxp"

# Parse command line arguments
SIGN_ZXP=false
COMPILE_JSXBIN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --sign)
            SIGN_ZXP=true
            shift
            ;;
        --jsxbin)
            COMPILE_JSXBIN=true
            shift
            ;;
        --help|-h)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --sign      Sign ZXP with ZXPSignCmd (requires ZXPSignCmd installed)"
            echo "  --jsxbin    Compile JSX to JSXBin format for IP protection"
            echo "  --help      Show this help message"
            echo ""
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check requirements
check_requirements() {
    if [ ! -d "$CEP_SOURCE" ]; then
        log_error "CEP panel source not found: $CEP_SOURCE"
        exit 1
    fi

    if [ ! -f "$CEP_SOURCE/CSXS/manifest.xml" ]; then
        log_error "CEP manifest.xml not found"
        exit 1
    fi

    if ! command -v zip &> /dev/null; then
        log_error "zip command not found. Please install zip utility."
        exit 1
    fi

    # Check for ZXPSignCmd if signing requested
    if [ "$SIGN_ZXP" = true ]; then
        if ! command -v ZXPSignCmd &> /dev/null; then
            log_error "ZXPSignCmd not found. Required for signing ZXP packages."
            log_error "Download from: https://github.com/Adobe-CEP/CEP-Resources/tree/master/ZXPSignCmdmake"
            log_error "Or run without --sign flag for unsigned development ZXP"
            exit 1
        fi
    fi

    # Check for Adobe ExtendScript Toolkit if JSXBin compilation requested
    if [ "$COMPILE_JSXBIN" = true ]; then
        log_warn "JSXBin compilation requires Adobe ExtendScript Toolkit"
        log_warn "Alternatively, JSX files can be manually compiled using:"
        log_warn "  - Adobe ExtendScript Toolkit CC"
        log_warn "  - estk-compile utility"
        log_warn "  - Online converters (not recommended for production)"
        log_warn ""
        log_warn "For now, copying .jsx files as-is..."
        COMPILE_JSXBIN=false
    fi
}

# Clean up previous builds
cleanup() {
    log_info "Cleaning up previous build artifacts..."
    rm -rf "$BUILD_TEMP"
    rm -f "$ZXP_OUTPUT"
    mkdir -p "$BUILD_TEMP"
    mkdir -p "$OUTPUT_DIR"
}

# Copy and prepare files
prepare_files() {
    log_info "Preparing CEP panel files..."
    
    # Copy all CEP files
    cp -R "$CEP_SOURCE"/* "$BUILD_TEMP/"
    
    # Remove development files
    rm -rf "$BUILD_TEMP/.git" 2>/dev/null || true
    rm -rf "$BUILD_TEMP/node_modules" 2>/dev/null || true
    rm -f "$BUILD_TEMP/.gitignore" 2>/dev/null || true
    rm -f "$BUILD_TEMP/.DS_Store" 2>/dev/null || true
    
    # Remove any test files
    rm -rf "$BUILD_TEMP/tests" 2>/dev/null || true
    rm -rf "$BUILD_TEMP/test" 2>/dev/null || true
    rm -rf "$BUILD_TEMP/__tests__" 2>/dev/null || true
    
    # Update version in manifest if needed
    if [ -f "$BUILD_TEMP/CSXS/manifest.xml" ]; then
        # macOS sed syntax
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/ExtensionBundleVersion=\"[^\"]*\"/ExtensionBundleVersion=\"$VERSION\"/" "$BUILD_TEMP/CSXS/manifest.xml"
        else
            sed -i "s/ExtensionBundleVersion=\"[^\"]*\"/ExtensionBundleVersion=\"$VERSION\"/" "$BUILD_TEMP/CSXS/manifest.xml"
        fi
    fi
    
    log_info "Files prepared"
}

# Create ZXP package
create_zxp() {
    if [ "$SIGN_ZXP" = true ]; then
        log_info "Creating signed ZXP package with ZXPSignCmd..."
        create_signed_zxp
    else
        log_info "Creating unsigned ZXP package (development mode)..."
        create_unsigned_zxp
    fi
}

# Create unsigned ZXP (simple ZIP)
create_unsigned_zxp() {
    pushd "$BUILD_TEMP" > /dev/null

    # Create ZXP (ZIP) file
    zip -r "$ZXP_OUTPUT" . \
        -x "*.DS_Store" \
        -x "__MACOSX/*" \
        -x "*.git*" \
        -x "node_modules/*" \
        -x "*.map" \
        -x "*.log"

    popd > /dev/null

    # Verify ZXP was created
    if [ ! -f "$ZXP_OUTPUT" ]; then
        log_error "ZXP package was not created"
        exit 1
    fi

    # Show file info
    local size=$(du -h "$ZXP_OUTPUT" | cut -f1)
    log_info "Unsigned ZXP package created: $ZXP_OUTPUT ($size)"
    log_warn "This is an UNSIGNED ZXP for development only"
}

# Create signed ZXP with ZXPSignCmd
create_signed_zxp() {
    local CERT_DIR="$INSTALLER_DIR/certs"
    local CERT_FILE="$CERT_DIR/splice-cep.p12"
    local CERT_PASSWORD="splice-cep-cert"
    local TIMESTAMP_URL="http://timestamp.digicert.com"

    # Check for certificate
    if [ ! -f "$CERT_FILE" ]; then
        log_warn "Certificate not found: $CERT_FILE"
        log_info "Generating self-signed certificate for development..."

        mkdir -p "$CERT_DIR"

        # Generate self-signed certificate with ZXPSignCmd
        ZXPSignCmd -selfSignedCert \
            US \
            California \
            "San Francisco" \
            "SPLICE" \
            "SPLICE Development" \
            "$CERT_PASSWORD" \
            "$CERT_FILE"

        if [ ! -f "$CERT_FILE" ]; then
            log_error "Failed to generate certificate"
            exit 1
        fi

        log_info "Self-signed certificate created: $CERT_FILE"
    fi

    # Sign ZXP with ZXPSignCmd
    log_info "Signing ZXP package..."

    ZXPSignCmd -sign \
        "$BUILD_TEMP" \
        "$ZXP_OUTPUT" \
        "$CERT_FILE" \
        "$CERT_PASSWORD" \
        -tsa "$TIMESTAMP_URL"

    if [ ! -f "$ZXP_OUTPUT" ]; then
        log_error "Failed to create signed ZXP"
        exit 1
    fi

    # Show file info
    local size=$(du -h "$ZXP_OUTPUT" | cut -f1)
    log_info "Signed ZXP package created: $ZXP_OUTPUT ($size)"
}

# Verify ZXP package
verify_zxp() {
    log_info "Verifying ZXP package..."

    # List contents
    echo ""
    log_info "Package contents (first 30 files):"
    unzip -l "$ZXP_OUTPUT" | head -30

    # Verify manifest.xml is at root
    if ! unzip -l "$ZXP_OUTPUT" | grep -q "CSXS/manifest.xml"; then
        log_error "CSXS/manifest.xml not found in ZXP package"
        exit 1
    fi

    # Verify AccessList was added
    if ! unzip -p "$ZXP_OUTPUT" "CSXS/manifest.xml" | grep -q "AccessList"; then
        log_warn "AccessList not found in manifest - network permissions may be missing!"
    else
        log_info "✓ AccessList found in manifest - network permissions included"
    fi

    # Check if ZXP is signed (has META-INF)
    if unzip -l "$ZXP_OUTPUT" | grep -q "META-INF/signatures.xml"; then
        log_info "✓ ZXP is SIGNED (META-INF/signatures.xml found)"

        # Show signature size
        local sig_size=$(unzip -l "$ZXP_OUTPUT" | grep "META-INF/signatures.xml" | awk '{print $1}')
        log_info "  Signature size: ${sig_size} bytes"
    else
        log_warn "✗ ZXP is UNSIGNED (no META-INF/signatures.xml)"
        log_warn "  This ZXP is for development only"
        log_warn "  For production, rebuild with --sign flag"
    fi

    # Check for JSXBin files
    if unzip -l "$ZXP_OUTPUT" | grep -q "\.jsxbin"; then
        log_info "✓ JSXBin files found (ExtendScript code compiled)"
    else
        log_info "✓ Plain JSX files (ExtendScript source readable)"
    fi

    log_info "ZXP package verification passed"
}

# Cleanup temporary files
final_cleanup() {
    log_info "Cleaning up temporary files..."
    rm -rf "$BUILD_TEMP"
}

# Main
main() {
    echo ""
    echo "========================================"
    echo "SPLICE CEP ZXP Package Builder"
    echo "Version: $VERSION"
    echo "========================================"
    echo ""

    # Show build configuration
    log_info "Build Configuration:"
    if [ "$SIGN_ZXP" = true ]; then
        echo "  • Signing: ENABLED (ZXPSignCmd)"
    else
        echo "  • Signing: DISABLED (development mode)"
    fi

    if [ "$COMPILE_JSXBIN" = true ]; then
        echo "  • JSXBin: ENABLED (compiled ExtendScript)"
    else
        echo "  • JSXBin: DISABLED (plain JSX source)"
    fi
    echo ""

    check_requirements
    cleanup
    prepare_files
    create_zxp
    verify_zxp
    final_cleanup

    echo ""
    echo "========================================"
    log_info "ZXP package build complete!"
    echo "Output: $ZXP_OUTPUT"
    echo "========================================"
    echo ""

    if [ "$SIGN_ZXP" = false ]; then
        log_warn "Development build created (unsigned)"
        echo "  • For production: run with --sign flag"
        echo "  • Requires: ZXPSignCmd tool"
    else
        log_info "Production build created (signed)"
        echo "  • Ready for distribution"
        echo "  • Can be installed via Adobe Exchange"
    fi

    echo "========================================"
}

main "$@"
