#!/bin/bash
#
# SPLICE Installer Dry Run Test
# Simulates installation without requiring sudo
#

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo "========================================"
echo "SPLICE Installer Dry Run Test"
echo "========================================"
echo ""

# Test counters
TESTS_PASSED=0
TESTS_FAILED=0
FAILED_TESTS=()

# Source paths
SOURCE_CEP="splice-cep"
SOURCE_PLUGIN="splice-plugin"
PKG_FILE="dist/SPLICE-Installer-6.0.8.pkg"

# Test installation paths
TEST_ROOT="/tmp/splice-dry-run-test"
TEST_CEP="$TEST_ROOT/Library/Application Support/Adobe/CEP/extensions/com.splice.panel"

echo -e "${BLUE}=== Pre-Flight Checks ===${NC}"
echo ""

# Test 1: Check source directories exist
echo -n "[1] Checking CEP source directory... "
if [ -d "$SOURCE_CEP" ]; then
    echo -e "${GREEN}✓ PASS${NC}"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("CEP source directory missing")
fi

# Test 2: Check PKG exists
echo -n "[2] Checking PKG file exists... "
if [ -f "$PKG_FILE" ]; then
    echo -e "${GREEN}✓ PASS${NC}"
    echo "    Size: $(du -h "$PKG_FILE" | cut -f1)"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("PKG file missing")
    exit 1
fi

# Test 3: Check critical source files
echo -n "[3] Checking critical source files... "
CRITICAL_FILES=(
    "$SOURCE_CEP/CSXS/manifest.xml"
    "$SOURCE_CEP/panel/index.html"
    "$SOURCE_CEP/panel/js/main.js"
    "$SOURCE_CEP/panel/js/config.js"
    "$SOURCE_CEP/jsx/hostScript.jsx"
)

MISSING_FILES=()
for file in "${CRITICAL_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        MISSING_FILES+=("$file")
    fi
done

if [ ${#MISSING_FILES[@]} -eq 0 ]; then
    echo -e "${GREEN}✓ PASS${NC}"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}"
    echo "    Missing files:"
    for file in "${MISSING_FILES[@]}"; do
        echo "      - $file"
    done
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("Critical source files missing")
fi

echo ""
echo -e "${BLUE}=== Simulating Installation ===${NC}"
echo ""

# Clean up previous test
rm -rf "$TEST_ROOT"

# Create test directory structure
echo "[4] Creating test directory structure..."
mkdir -p "$TEST_CEP"
echo -e "    ${GREEN}✓ Created${NC}"

# Copy CEP extension files (simulating postinstall)
echo "[5] Copying CEP extension files..."
cp -R "$SOURCE_CEP"/* "$TEST_CEP/"
echo -e "    ${GREEN}✓ Copied${NC}"

# Set permissions (simulating chmod in postinstall)
echo "[6] Setting permissions..."
chmod -R 755 "$TEST_CEP"
echo -e "    ${GREEN}✓ Set${NC}"

echo ""
echo -e "${BLUE}=== Verification Tests ===${NC}"
echo ""

# Test 4: Verify manifest.xml
echo -n "[7] Verifying manifest.xml... "
if [ -f "$TEST_CEP/CSXS/manifest.xml" ]; then
    VERSION=$(grep "ExtensionBundleVersion" "$TEST_CEP/CSXS/manifest.xml" | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
    if [ "$VERSION" == "6.0.8" ]; then
        echo -e "${GREEN}✓ PASS${NC} (version $VERSION)"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        echo -e "${RED}✗ FAIL${NC} (version $VERSION, expected 6.0.8)"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        FAILED_TESTS+=("Manifest version incorrect")
    fi
else
    echo -e "${RED}✗ FAIL${NC} (file not found)"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("Manifest not installed")
fi

# Test 5: Verify index.html
echo -n "[8] Verifying panel/index.html... "
if [ -f "$TEST_CEP/panel/index.html" ]; then
    SIZE=$(stat -f%z "$TEST_CEP/panel/index.html")
    if [ $SIZE -gt 30000 ]; then
        echo -e "${GREEN}✓ PASS${NC} (${SIZE} bytes)"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        echo -e "${RED}✗ FAIL${NC} (too small: ${SIZE} bytes)"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        FAILED_TESTS+=("index.html size incorrect")
    fi
else
    echo -e "${RED}✗ FAIL${NC} (file not found)"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("index.html not installed")
fi

# Test 6: Verify main.js
echo -n "[9] Verifying panel/js/main.js... "
if [ -f "$TEST_CEP/panel/js/main.js" ]; then
    SIZE=$(stat -f%z "$TEST_CEP/panel/js/main.js")
    if [ $SIZE -gt 50000 ]; then
        # Check for DOMContentLoaded listener
        if grep -q "DOMContentLoaded" "$TEST_CEP/panel/js/main.js"; then
            echo -e "${GREEN}✓ PASS${NC} (${SIZE} bytes, has initialization)"
            TESTS_PASSED=$((TESTS_PASSED + 1))
        else
            echo -e "${RED}✗ FAIL${NC} (missing DOMContentLoaded)"
            TESTS_FAILED=$((TESTS_FAILED + 1))
            FAILED_TESTS+=("main.js missing initialization")
        fi
    else
        echo -e "${RED}✗ FAIL${NC} (too small: ${SIZE} bytes)"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        FAILED_TESTS+=("main.js size incorrect")
    fi
else
    echo -e "${RED}✗ FAIL${NC} (file not found)"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("main.js not installed")
fi

# Test 7: Verify config.js
echo -n "[10] Verifying panel/js/config.js... "
if [ -f "$TEST_CEP/panel/js/config.js" ]; then
    # Check for correct backend URL
    if grep -q "splice-api-production.up.railway.app" "$TEST_CEP/panel/js/config.js"; then
        echo -e "${GREEN}✓ PASS${NC} (production backend configured)"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        echo -e "${RED}✗ FAIL${NC} (backend URL not found)"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        FAILED_TESTS+=("config.js backend URL incorrect")
    fi
else
    echo -e "${RED}✗ FAIL${NC} (file not found)"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("config.js not installed")
fi

# Test 8: Verify hostScript.jsx
echo -n "[11] Verifying jsx/hostScript.jsx... "
if [ -f "$TEST_CEP/jsx/hostScript.jsx" ]; then
    SIZE=$(stat -f%z "$TEST_CEP/jsx/hostScript.jsx")
    if [ $SIZE -gt 50000 ]; then
        # Check for getVersion function
        if grep -q "function getVersion" "$TEST_CEP/jsx/hostScript.jsx"; then
            echo -e "${GREEN}✓ PASS${NC} (${SIZE} bytes, has getVersion)"
            TESTS_PASSED=$((TESTS_PASSED + 1))
        else
            echo -e "${RED}✗ FAIL${NC} (missing getVersion function)"
            TESTS_FAILED=$((TESTS_FAILED + 1))
            FAILED_TESTS+=("hostScript.jsx missing getVersion")
        fi
    else
        echo -e "${RED}✗ FAIL${NC} (too small: ${SIZE} bytes)"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        FAILED_TESTS+=("hostScript.jsx size incorrect")
    fi
else
    echo -e "${RED}✗ FAIL${NC} (file not found)"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("hostScript.jsx not installed")
fi

# Test 9: Count JavaScript modules
echo -n "[12] Counting JavaScript modules... "
JS_COUNT=$(find "$TEST_CEP/panel/js" -name "*.js" -type f | wc -l | tr -d ' ')
if [ $JS_COUNT -ge 16 ]; then
    echo -e "${GREEN}✓ PASS${NC} ($JS_COUNT modules found)"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC} (only $JS_COUNT modules, expected 16+)"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("Insufficient JavaScript modules")
fi

# Test 10: Verify all AI feature modules exist
echo -n "[13] Verifying AI feature modules... "
AI_MODULES=(
    "music.js"
    "animatedCaptions.js"
    "textEditor.js"
    "socialReframe.js"
    "multitrack.js"
)

MISSING_MODULES=()
for module in "${AI_MODULES[@]}"; do
    if [ ! -f "$TEST_CEP/panel/js/$module" ]; then
        MISSING_MODULES+=("$module")
    fi
done

if [ ${#MISSING_MODULES[@]} -eq 0 ]; then
    echo -e "${GREEN}✓ PASS${NC} (all AI modules present)"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}"
    echo "    Missing modules:"
    for module in "${MISSING_MODULES[@]}"; do
        echo "      - $module"
    done
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("Missing AI feature modules")
fi

# Test 11: Verify icons
echo -n "[14] Verifying panel icons... "
if [ -f "$TEST_CEP/panel/icons/icon-light.png" ] && [ -f "$TEST_CEP/panel/icons/icon-dark.png" ]; then
    echo -e "${GREEN}✓ PASS${NC}"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC} (icons missing)"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("Panel icons missing")
fi

# Test 12: Verify CSS
echo -n "[15] Verifying panel CSS... "
if [ -f "$TEST_CEP/panel/css/style.css" ]; then
    SIZE=$(stat -f%z "$TEST_CEP/panel/css/style.css")
    if [ $SIZE -gt 40000 ]; then
        echo -e "${GREEN}✓ PASS${NC} (${SIZE} bytes)"
        TESTS_PASSED=$((TESTS_PASSED + 1))
    else
        echo -e "${RED}✗ FAIL${NC} (too small: ${SIZE} bytes)"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        FAILED_TESTS+=("CSS file size incorrect")
    fi
else
    echo -e "${RED}✗ FAIL${NC} (file not found)"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("CSS file not installed")
fi

echo ""
echo -e "${BLUE}=== PKG Content Verification ===${NC}"
echo ""

# Test 13: Verify PKG contains correct files
echo -n "[16] Verifying PKG payload contains manifest... "
if pkgutil --payload-files "$PKG_FILE" | grep -q "manifest.xml"; then
    echo -e "${GREEN}✓ PASS${NC}"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("PKG missing manifest.xml")
fi

echo -n "[17] Verifying PKG contains main.js... "
if pkgutil --payload-files "$PKG_FILE" | grep -q "main.js"; then
    echo -e "${GREEN}✓ PASS${NC}"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("PKG missing main.js")
fi

echo -n "[18] Verifying PKG contains hostScript.jsx... "
if pkgutil --payload-files "$PKG_FILE" | grep -q "hostScript.jsx"; then
    echo -e "${GREEN}✓ PASS${NC}"
    TESTS_PASSED=$((TESTS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}"
    TESTS_FAILED=$((TESTS_FAILED + 1))
    FAILED_TESTS+=("PKG missing hostScript.jsx")
fi

echo ""
echo "========================================"
echo -e "${BLUE}Dry Run Test Results${NC}"
echo "========================================"
echo ""
echo "Total Tests:  $((TESTS_PASSED + TESTS_FAILED))"
echo -e "${GREEN}Passed:       $TESTS_PASSED${NC}"

if [ $TESTS_FAILED -gt 0 ]; then
    echo -e "${RED}Failed:       $TESTS_FAILED${NC}"
    echo ""
    echo "Failed tests:"
    for test in "${FAILED_TESTS[@]}"; do
        echo "  ✗ $test"
    done
else
    echo -e "${GREEN}Failed:       0${NC}"
fi

echo ""
echo "========================================"

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "${GREEN}✓ ALL DRY RUN TESTS PASSED!${NC}"
    echo ""
    echo "The installer package is correctly structured and contains all required files."
    echo ""
    echo "Test installation created at:"
    echo "  $TEST_CEP"
    echo ""
    echo "To install for real, run:"
    echo "  sudo installer -pkg $PKG_FILE -target /"
    echo ""
    echo "Or double-click the PKG file and follow the prompts."
    echo ""
    exit 0
else
    echo -e "${RED}✗ SOME TESTS FAILED${NC}"
    echo ""
    echo "The installer may have issues. Review failed tests above."
    echo ""
    exit 1
fi
