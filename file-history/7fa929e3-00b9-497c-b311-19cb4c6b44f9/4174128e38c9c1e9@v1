#!/bin/bash
#
# SPLICE CEP Panel - ZXP Package Builder
# Creates a .zxp package from CEP panel source
#
# ZXP is Adobe's signed package format for CEP extensions
#
# Usage:
#   ./build-zxp.sh              # Create unsigned ZXP
#   ./build-zxp.sh --sign       # Create signed ZXP with ZXPSignCmd
#   ./build-zxp.sh --jsxbin     # Compile JSX to JSXBin
#   ./build-zxp.sh --sign --jsxbin  # Both signing and compilation
#

set -e

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
INSTALLER_DIR="$SCRIPT_DIR/.."

# Source and output paths
CEP_SOURCE="$PROJECT_ROOT/splice-cep"
OUTPUT_DIR="$INSTALLER_DIR/shared"
BUILD_TEMP="$INSTALLER_DIR/build/zxp-temp"

# Version info
VERSION_FILE="$INSTALLER_DIR/shared/version.json"
if [ -f "$VERSION_FILE" ]; then
    VERSION=$(grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' "$VERSION_FILE" | cut -d'"' -f4)
else
    VERSION="6.0.3"
fi

# Output filename
ZXP_OUTPUT="$OUTPUT_DIR/splice-cep.zxp"

# Parse command line arguments
SIGN_ZXP=false
COMPILE_JSXBIN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --sign)
            SIGN_ZXP=true
            shift
            ;;
        --jsxbin)
            COMPILE_JSXBIN=true
            shift
            ;;
        --help|-h)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --sign      Sign ZXP with ZXPSignCmd (requires ZXPSignCmd installed)"
            echo "  --jsxbin    Compile JSX to JSXBin format for IP protection"
            echo "  --help      Show this help message"
            echo ""
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check requirements
check_requirements() {
    if [ ! -d "$CEP_SOURCE" ]; then
        log_error "CEP panel source not found: $CEP_SOURCE"
        exit 1
    fi
    
    if [ ! -f "$CEP_SOURCE/CSXS/manifest.xml" ]; then
        log_error "CEP manifest.xml not found"
        exit 1
    fi
    
    if ! command -v zip &> /dev/null; then
        log_error "zip command not found. Please install zip utility."
        exit 1
    fi
}

# Clean up previous builds
cleanup() {
    log_info "Cleaning up previous build artifacts..."
    rm -rf "$BUILD_TEMP"
    rm -f "$ZXP_OUTPUT"
    mkdir -p "$BUILD_TEMP"
    mkdir -p "$OUTPUT_DIR"
}

# Copy and prepare files
prepare_files() {
    log_info "Preparing CEP panel files..."
    
    # Copy all CEP files
    cp -R "$CEP_SOURCE"/* "$BUILD_TEMP/"
    
    # Remove development files
    rm -rf "$BUILD_TEMP/.git" 2>/dev/null || true
    rm -rf "$BUILD_TEMP/node_modules" 2>/dev/null || true
    rm -f "$BUILD_TEMP/.gitignore" 2>/dev/null || true
    rm -f "$BUILD_TEMP/.DS_Store" 2>/dev/null || true
    
    # Remove any test files
    rm -rf "$BUILD_TEMP/tests" 2>/dev/null || true
    rm -rf "$BUILD_TEMP/test" 2>/dev/null || true
    rm -rf "$BUILD_TEMP/__tests__" 2>/dev/null || true
    
    # Update version in manifest if needed
    if [ -f "$BUILD_TEMP/CSXS/manifest.xml" ]; then
        # macOS sed syntax
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/ExtensionBundleVersion=\"[^\"]*\"/ExtensionBundleVersion=\"$VERSION\"/" "$BUILD_TEMP/CSXS/manifest.xml"
        else
            sed -i "s/ExtensionBundleVersion=\"[^\"]*\"/ExtensionBundleVersion=\"$VERSION\"/" "$BUILD_TEMP/CSXS/manifest.xml"
        fi
    fi
    
    log_info "Files prepared"
}

# Create ZXP package (unsigned for development)
create_zxp() {
    log_info "Creating ZXP package..."
    
    pushd "$BUILD_TEMP" > /dev/null
    
    # Create ZXP (ZIP) file
    # Note: For production, this should be signed using ZXPSignCmd
    zip -r "$ZXP_OUTPUT" . \
        -x "*.DS_Store" \
        -x "__MACOSX/*" \
        -x "*.git*" \
        -x "node_modules/*" \
        -x "*.map" \
        -x "*.log"
    
    popd > /dev/null
    
    # Verify ZXP was created
    if [ ! -f "$ZXP_OUTPUT" ]; then
        log_error "ZXP package was not created"
        exit 1
    fi
    
    # Show file info
    local size=$(du -h "$ZXP_OUTPUT" | cut -f1)
    log_info "ZXP package created: $ZXP_OUTPUT ($size)"
}

# Verify ZXP package
verify_zxp() {
    log_info "Verifying ZXP package..."
    
    # List contents
    unzip -l "$ZXP_OUTPUT" | head -20
    
    # Verify manifest.xml is at root
    if ! unzip -l "$ZXP_OUTPUT" | grep -q "CSXS/manifest.xml"; then
        log_error "CSXS/manifest.xml not found in ZXP package"
        exit 1
    fi
    
    # Verify AccessList was added
    if ! unzip -p "$ZXP_OUTPUT" "CSXS/manifest.xml" | grep -q "AccessList"; then
        log_warn "AccessList not found in manifest - network permissions may be missing!"
    else
        log_info "AccessList found in manifest - network permissions included"
    fi
    
    log_info "ZXP package verification passed"
}

# Cleanup temporary files
final_cleanup() {
    log_info "Cleaning up temporary files..."
    rm -rf "$BUILD_TEMP"
}

# Main
main() {
    echo ""
    echo "========================================"
    echo "SPLICE CEP ZXP Package Builder"
    echo "Version: $VERSION"
    echo "========================================"
    echo ""
    
    check_requirements
    cleanup
    prepare_files
    create_zxp
    verify_zxp
    final_cleanup
    
    echo ""
    echo "========================================"
    log_info "ZXP package build complete!"
    echo "Output: $ZXP_OUTPUT"
    echo "========================================"
    echo ""
    echo "NOTE: For production, sign the ZXP using ZXPSignCmd"
    echo "      For development, you can install unsigned ZXP directly"
    echo "========================================"
}

main "$@"
