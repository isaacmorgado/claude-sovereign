/**
 * SPLICE Website E2E Tests - Pricing Page
 * Tests for tier display, overage rates, and Stripe integration
 */

const fs = require("fs");
const path = require("path");

let passed = 0;
let failed = 0;

function test(name, fn) {
  try {
    fn();
    console.log(`  ✓ ${name}`);
    passed++;
  } catch (error) {
    console.log(`  ✗ ${name}`);
    console.log(`    Error: ${error.message}`);
    failed++;
  }
}

function assert(condition, message) {
  if (!condition) {
    throw new Error(message || "Assertion failed");
  }
}

const pricingPage = fs.readFileSync(
  path.join(__dirname, "..", "src", "app", "pricing", "page.tsx"),
  "utf8"
);

console.log("\n=== Pricing Page E2E Tests ===\n");

// ============================================
// Tier Tests
// ============================================
console.log("Pricing Tiers:");

test("Has all 3 pricing tiers", () => {
  assert(pricingPage.includes('name: "Starter"'), "Missing Starter tier");
  assert(pricingPage.includes('name: "Pro"'), "Missing Pro tier");
  assert(pricingPage.includes('name: "Team"'), "Missing Team tier");
});

test("Tiers have correct prices", () => {
  assert(pricingPage.includes('price: "$15"'), "Starter should be $15");
  assert(pricingPage.includes('price: "$39"'), "Pro should be $39");
  assert(pricingPage.includes('price: "$129"'), "Team should be $129");
});

test("Tiers have processing hours", () => {
  assert(pricingPage.includes("4 hours"), "Starter should have 4 hours");
  assert(pricingPage.includes("15 hours"), "Pro should have 15 hours");
  assert(pricingPage.includes("50 hours"), "Team should have 50 hours");
});

test("Pro tier is marked as popular", () => {
  const proTier = pricingPage.match(/name:\s*"Pro"[\s\S]*?popular:\s*(true|false)/);
  assert(proTier && proTier[1] === "true", "Pro tier should be popular");
});

test("Tiers have music credits", () => {
  assert(pricingPage.includes("2 AI music"), "Starter should have 2 music credits");
  assert(pricingPage.includes("10 AI music"), "Pro should have 10 music credits");
  assert(pricingPage.includes("50 AI music"), "Team should have 50 music credits");
});

test("Tiers have vocal isolation info", () => {
  assert(pricingPage.includes("45 min vocal isolation"), "Pro should have 45 min");
  assert(pricingPage.includes("3 hours vocal isolation"), "Team should have 3 hours");
});

// ============================================
// Overage Tests
// ============================================
console.log("\nOverage Rates:");

test("Shows processing overage rate", () => {
  assert(pricingPage.includes("$2.00/hour"), "Missing processing overage rate");
});

test("Shows vocal isolation overage rate", () => {
  assert(pricingPage.includes("$0.10/minute"), "Missing isolation overage rate");
});

test("Shows music generation overage rates", () => {
  // Single unified rate: $1.00/song for all tiers
  assert(pricingPage.includes("$1.00/song"), "Missing music overage rate");
});

// ============================================
// Stripe Integration Tests
// ============================================
console.log("\nStripe Integration:");

test("Has Stripe price IDs", () => {
  assert(pricingPage.includes("price_"), "Missing Stripe price IDs");
});

test("Has checkout links", () => {
  assert(pricingPage.includes("/checkout?plan="), "Missing checkout links");
});

// ============================================
// FAQ Tests
// ============================================
console.log("\nPricing FAQ:");

test("Has processing hours FAQ", () => {
  assert(
    pricingPage.includes("processing hour") || pricingPage.includes("processing hour"),
    "Missing processing hours FAQ"
  );
});

test("Has plan switching FAQ", () => {
  assert(
    pricingPage.includes("switch plan") || pricingPage.includes("upgrade"),
    "Missing plan switching FAQ"
  );
});

test("Has overage FAQ", () => {
  assert(
    pricingPage.includes("exceed") || pricingPage.includes("limit"),
    "Missing overage FAQ"
  );
});

test("Has trial FAQ", () => {
  assert(pricingPage.includes("free tier") || pricingPage.includes("free trial"), "Missing trial FAQ");
});

// ============================================
// CTA Tests
// ============================================
console.log("\nCTAs:");

test("Has Start Free Trial buttons", () => {
  assert(pricingPage.includes("Start Free Trial"), "Missing trial CTAs");
});

test("Has Contact Sales for Team tier", () => {
  assert(pricingPage.includes("Contact Sales"), "Missing Contact Sales CTA");
});

// ============================================
// Billing Toggle Tests (Pricing Component)
// ============================================
console.log("\nBilling Toggle:");

const pricingComponent = fs.readFileSync(
  path.join(__dirname, "..", "src", "components", "landing", "Pricing.tsx"),
  "utf8"
);

test("Has isAnnual state with true default", () => {
  assert(
    pricingComponent.includes("useState(true)") ||
    pricingComponent.includes("useState<boolean>(true)"),
    "isAnnual should default to true"
  );
});

test("Has billing toggle button", () => {
  assert(
    pricingComponent.includes('setIsAnnual(!isAnnual)') ||
    pricingComponent.includes("setIsAnnual("),
    "Missing billing toggle handler"
  );
});

test("Shows annual prices when isAnnual is true", () => {
  assert(pricingComponent.includes("yearlyPrice"), "Missing yearlyPrice display");
  assert(pricingComponent.includes("yearlyPeriod"), "Missing yearlyPeriod display");
});

test("Shows monthly prices when isAnnual is false", () => {
  assert(pricingComponent.includes("{plan.price}"), "Missing monthly price display");
  assert(pricingComponent.includes("{plan.period}"), "Missing monthly period display");
});

test("Checkout link includes billing parameter", () => {
  assert(
    pricingComponent.includes("billing=${isAnnual ? 'annual' : 'monthly'}") ||
    pricingComponent.includes("billing="),
    "Checkout link should include billing period"
  );
});

test("Has Save 20% badge for annual", () => {
  assert(pricingComponent.includes("Save 20%"), "Missing Save 20% badge");
});

test("Has annual pricing data for all tiers", () => {
  assert(pricingComponent.includes('yearlyPrice: "$144"'), "Starter missing annual price");
  assert(pricingComponent.includes('yearlyPrice: "$374"'), "Pro missing annual price");
  assert(pricingComponent.includes('yearlyPrice: "$1,238"'), "Team missing annual price");
});

// ============================================
// Results
// ============================================
console.log("\n========================================");
console.log(`Pricing Page Tests: ${passed} passed, ${failed} failed`);
console.log("========================================\n");

process.exit(failed > 0 ? 1 : 0);
