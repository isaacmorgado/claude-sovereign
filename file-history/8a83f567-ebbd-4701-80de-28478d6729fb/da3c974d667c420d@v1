# HTTPS Proxy Interception Setup Guide

This guide covers setting up Charles Proxy or mitmproxy to intercept HTTPS traffic and capture FaceIQ API responses.

---

## Option 1: mitmproxy (Free, Command-Line)

### Step 1: Install mitmproxy

```bash
# Using Homebrew
brew install mitmproxy

# Or using pip
pip3 install mitmproxy
```

### Step 2: Start mitmproxy

```bash
# Interactive terminal UI
mitmproxy

# Or web interface (recommended)
mitmweb

# Or dump to file
mitmdump -w faceiq_traffic.flow
```

Default proxy runs on `localhost:8080`

### Step 3: Install SSL Certificate (macOS)

```bash
# 1. Start mitmproxy first (it generates certs on first run)
mitmproxy

# 2. The certificate is at:
# ~/.mitmproxy/mitmproxy-ca-cert.pem

# 3. Install to macOS Keychain
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ~/.mitmproxy/mitmproxy-ca-cert.pem
```

**Or manually:**
1. Open Keychain Access
2. File → Import Items
3. Select `~/.mitmproxy/mitmproxy-ca-cert.pem`
4. Find "mitmproxy" in Keychain
5. Double-click → Trust → "Always Trust"

### Step 4: Configure Browser Proxy

**Chrome:**
```bash
# Launch Chrome with proxy
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --proxy-server="localhost:8080"
```

**Or system-wide (macOS):**
1. System Settings → Network → Wi-Fi → Details
2. Proxies → Web Proxy (HTTP) → `localhost:8080`
3. Proxies → Secure Web Proxy (HTTPS) → `localhost:8080`

### Step 5: Capture FaceIQ Traffic

```bash
# Filter only FaceIQ API calls
mitmproxy --set flow_detail=3 -w faceiq.flow

# Or with filtering
mitmdump -w faceiq.flow "~d faceiqlabs.com"
```

### Step 6: Export Captured Data

```bash
# Convert to HAR
mitmdump -nr faceiq.flow -w faceiq.har --set hardump=faceiq.har

# Or use Python script (see below)
```

---

## Option 2: Charles Proxy (GUI, Paid but 30-day trial)

### Step 1: Download & Install

1. Download from: https://www.charlesproxy.com/download/
2. Install the .dmg
3. Launch Charles

### Step 2: Install SSL Certificate (macOS)

1. In Charles: **Help → SSL Proxying → Install Charles Root Certificate**
2. Keychain Access opens automatically
3. Find "Charles Proxy CA" certificate
4. Double-click → Trust → "Always Trust"
5. Enter password to confirm

### Step 3: Enable SSL Proxying

1. **Proxy → SSL Proxying Settings**
2. Check "Enable SSL Proxying"
3. Add location: `*.faceiqlabs.com` port `443`
4. Or add `*` to intercept everything

### Step 4: Configure Browser

Charles usually auto-configures. If not:
- Proxy: `localhost:8888` (Charles default port)

### Step 5: Capture Traffic

1. Visit https://beta.faceiqlabs.com
2. Use the site normally
3. Watch requests appear in Charles
4. Right-click requests → Save Response

### Step 6: Export

- File → Export Session → HAR format
- Or right-click specific requests → Save All

---

## Browser-Specific Setup

### Chrome with Proxy Extension (Alternative)

Install "Proxy SwitchyOmega" extension:
1. Add proxy profile: `localhost:8080` (mitmproxy) or `localhost:8888` (Charles)
2. Enable when needed

### Firefox (Separate Proxy Settings)

1. Settings → Network Settings → Settings
2. Manual proxy: `localhost` port `8080`
3. Check "Use this proxy for HTTPS"
4. Firefox also needs the cert installed in its own store:
   - Settings → Privacy & Security → Certificates → View Certificates
   - Import `mitmproxy-ca-cert.pem`

---

## Capturing FaceIQ Calculations

### What to Capture

1. **Login** - `/api/auth/session`
2. **Upload front face** - Watch for MediaPipe processing
3. **Upload side profile** - `/api/side-landmarks`
4. **View results** - **THIS IS THE KEY** - `/api/analysis/*` endpoints
5. **Premium features** - `/api/analysis/unlock` (if you have subscription)

### Key Endpoints to Watch

```
POST /api/side-landmarks     → 106 landmark coordinates
GET  /api/subscription       → Quota info
POST /api/analysis/unlock    → Premium calculations (need subscription)
GET  /api/faces              → Face data
```

### Filtering in mitmproxy

```bash
# Only show FaceIQ API calls
mitmdump "~d faceiqlabs.com & ~u /api/"

# Show request and response bodies
mitmproxy --set flow_detail=3

# Save only API responses
mitmdump -w api_only.flow "~d faceiqlabs.com & ~u /api/ & ~s"
```

---

## Python Script to Parse mitmproxy Flows

Save this to extract API responses:

```python
#!/usr/bin/env python3
"""Extract FaceIQ API responses from mitmproxy flow file"""

from mitmproxy import io as mitmio
from mitmproxy.exceptions import FlowReadException
import json
import os

FLOW_FILE = "faceiq.flow"
OUTPUT_DIR = "captured_api"

os.makedirs(OUTPUT_DIR, exist_ok=True)

with open(FLOW_FILE, "rb") as f:
    reader = mitmio.FlowReader(f)

    for i, flow in enumerate(reader.stream()):
        try:
            if "faceiqlabs.com/api" in flow.request.pretty_url:
                url = flow.request.pretty_url
                method = flow.request.method

                # Get endpoint name
                endpoint = url.split("faceiqlabs.com")[1].split("?")[0]
                safe_name = endpoint.replace("/", "_").strip("_")

                print(f"[{i}] {method} {endpoint}")

                # Get response
                if flow.response:
                    content_type = flow.response.headers.get("content-type", "")

                    if "json" in content_type:
                        try:
                            body = json.loads(flow.response.content)

                            # Save to file
                            filename = f"{i:03d}_{method}_{safe_name}.json"
                            with open(os.path.join(OUTPUT_DIR, filename), "w") as out:
                                json.dump({
                                    "url": url,
                                    "method": method,
                                    "status": flow.response.status_code,
                                    "response": body
                                }, out, indent=2)

                            print(f"  → Saved: {filename}")

                            # Check for calculation data
                            if "score" in str(body).lower():
                                print(f"  ⭐ CONTAINS SCORE DATA!")
                            if "ratio" in str(body).lower():
                                print(f"  ⭐ CONTAINS RATIO DATA!")
                            if "calculation" in str(body).lower():
                                print(f"  ⭐ CONTAINS CALCULATION DATA!")

                        except json.JSONDecodeError:
                            print(f"  → Non-JSON response")

        except FlowReadException as e:
            print(f"Error reading flow: {e}")

print(f"\nAll responses saved to: {OUTPUT_DIR}/")
```

---

## Troubleshooting

### Certificate Not Trusted

```bash
# Check if cert is installed
security find-certificate -c "mitmproxy" /Library/Keychains/System.keychain

# Remove and reinstall
sudo security delete-certificate -c "mitmproxy" /Library/Keychains/System.keychain
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ~/.mitmproxy/mitmproxy-ca-cert.pem
```

### Chrome Ignoring Proxy

```bash
# Kill all Chrome processes first
pkill -9 "Google Chrome"

# Then launch with proxy flag
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --proxy-server="localhost:8080"
```

### macOS Ventura+ Security

You may need to:
1. System Settings → Privacy & Security
2. Allow the proxy app (Charles/mitmproxy)
3. May need to disable SIP for some operations (not recommended)

### HSTS / Certificate Pinning

Some sites use certificate pinning. FaceIQ likely doesn't, but if you see SSL errors:
- Try Firefox (more lenient)
- Use `--ignore-certificate-errors` flag for Chrome (risky!)

---

## Quick Start Commands

```bash
# Install
brew install mitmproxy

# Start web UI
mitmweb

# Install cert (after starting mitmproxy once)
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ~/.mitmproxy/mitmproxy-ca-cert.pem

# Set system proxy (or use browser extension)
networksetup -setwebproxy Wi-Fi localhost 8080
networksetup -setsecurewebproxy Wi-Fi localhost 8080

# Capture traffic
# Now visit https://beta.faceiqlabs.com in your browser

# When done, disable proxy
networksetup -setwebproxystate Wi-Fi off
networksetup -setsecurewebproxystate Wi-Fi off
```

---

## Security Warning

⚠️ **While proxy is active:**
- All HTTPS traffic is decrypted through your proxy
- Don't do banking/sensitive activities
- Disable proxy when done
- Remove the CA certificate when finished with research

---

*Guide created: 2025-12-18*
