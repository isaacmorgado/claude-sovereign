#!/usr/bin/env python3
"""Extract FaceIQ API responses from HAR file"""

import json
import os

HAR_PATH = os.path.expanduser("~/Desktop/FACEIQ.har")
OUTPUT_DIR = os.path.expanduser("~/Desktop/reverse-engineer/extracted-api")

os.makedirs(OUTPUT_DIR, exist_ok=True)

print(f"Loading HAR file: {HAR_PATH}")
with open(HAR_PATH, 'r') as f:
    har = json.load(f)

print(f"Total entries: {len(har['log']['entries'])}")

# Find all FaceIQ API calls
api_calls = []
for entry in har['log']['entries']:
    url = entry['request']['url']
    if 'beta.faceiqlabs.com/api/' in url:
        api_calls.append(entry)

print(f"Found {len(api_calls)} FaceIQ API calls\n")

# Extract each API call
for i, entry in enumerate(api_calls):
    method = entry['request']['method']
    url = entry['request']['url']

    # Get endpoint name
    endpoint = url.split('beta.faceiqlabs.com')[1].split('?')[0]
    safe_name = endpoint.replace('/', '_').strip('_')

    print(f"=== {method} {endpoint} ===")

    # Get response
    response = entry.get('response', {})
    content = response.get('content', {})

    # Save request info
    output = {
        'method': method,
        'url': url,
        'status': response.get('status'),
        'request_headers': {h['name']: h['value'] for h in entry['request'].get('headers', [])},
        'request_body': None,
        'response_headers': {h['name']: h['value'] for h in response.get('headers', [])},
        'response_body': None
    }

    # Get request body if POST
    if method == 'POST':
        post_data = entry['request'].get('postData', {})
        if 'text' in post_data:
            try:
                output['request_body'] = json.loads(post_data['text'])
            except:
                output['request_body'] = post_data.get('text', '')[:1000]

    # Get response body
    if 'text' in content:
        try:
            body = json.loads(content['text'])
            output['response_body'] = body

            # Pretty print key data
            if 'data' in body and 'landmarks' in str(body.get('data', {})):
                print(f"  → Contains landmark data!")
                if isinstance(body.get('data'), dict):
                    data = body['data']
                    print(f"     rotationAngle: {data.get('rotationAngle')}")
                    print(f"     direction: {data.get('direction')}")
                    print(f"     landmarks count: {len(data.get('landmarks', []))}")
            elif 'faces' in body:
                print(f"  → Contains {len(body.get('faces', []))} face(s)")
            elif 'quotaUsage' in body:
                print(f"  → Subscription/quota info")
            elif 'error' in body:
                print(f"  → Error: {body.get('error')}")
            else:
                print(f"  → Response keys: {list(body.keys())}")

        except json.JSONDecodeError:
            output['response_body'] = content.get('text', '')[:500]
            print(f"  → Non-JSON response")

    # Save to file
    filename = f"{i:02d}_{method}_{safe_name}.json"
    filepath = os.path.join(OUTPUT_DIR, filename)
    with open(filepath, 'w') as f:
        json.dump(output, f, indent=2)
    print(f"  → Saved to {filename}\n")

print(f"\nAll API responses saved to: {OUTPUT_DIR}")

# Create summary
summary_path = os.path.join(OUTPUT_DIR, "00_SUMMARY.md")
with open(summary_path, 'w') as f:
    f.write("# FaceIQ API Endpoints Summary\n\n")
    f.write("| # | Method | Endpoint | Status |\n")
    f.write("|---|--------|----------|--------|\n")
    for i, entry in enumerate(api_calls):
        method = entry['request']['method']
        url = entry['request']['url']
        endpoint = url.split('beta.faceiqlabs.com')[1].split('?')[0]
        status = entry.get('response', {}).get('status', '?')
        f.write(f"| {i} | {method} | {endpoint} | {status} |\n")

print(f"Summary saved to: {summary_path}")
