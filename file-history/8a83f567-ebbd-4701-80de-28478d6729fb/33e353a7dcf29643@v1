#!/usr/bin/env python3
"""Extract FaceIQ API responses from mitmproxy flow file"""

from mitmproxy import io as mitmio
from mitmproxy.exceptions import FlowReadException
import json
import os

FLOW_FILE = os.path.expanduser("~/Desktop/reverse-engineer/captured_flows.flow")
OUTPUT_DIR = os.path.expanduser("~/Desktop/reverse-engineer/captured_api")

os.makedirs(OUTPUT_DIR, exist_ok=True)

print(f"Reading: {FLOW_FILE}")
print(f"Output: {OUTPUT_DIR}\n")

faceiq_responses = []
all_hosts = set()

with open(FLOW_FILE, "rb") as f:
    reader = mitmio.FlowReader(f)

    for i, flow in enumerate(reader.stream()):
        try:
            url = flow.request.pretty_url
            host = flow.request.host
            all_hosts.add(host)

            # Check for FaceIQ API calls
            if "faceiqlabs.com" in url and "/api/" in url:
                method = flow.request.method
                endpoint = url.split("faceiqlabs.com")[1].split("?")[0]

                print(f"[{i}] {method} {endpoint}")

                if flow.response:
                    status = flow.response.status_code
                    content_type = flow.response.headers.get("content-type", "")

                    response_data = {
                        "index": i,
                        "method": method,
                        "url": url,
                        "endpoint": endpoint,
                        "status": status,
                        "request_body": None,
                        "response_body": None
                    }

                    # Get request body
                    if flow.request.content:
                        try:
                            response_data["request_body"] = json.loads(flow.request.content)
                        except:
                            response_data["request_body"] = flow.request.content.decode('utf-8', errors='ignore')[:1000]

                    # Get response body
                    if flow.response.content and "json" in content_type:
                        try:
                            body = json.loads(flow.response.content)
                            response_data["response_body"] = body

                            # Check for important data
                            body_str = str(body).lower()
                            if "landmark" in body_str:
                                print(f"  ⭐ CONTAINS LANDMARKS!")
                            if "score" in body_str:
                                print(f"  ⭐ CONTAINS SCORE DATA!")
                            if "ratio" in body_str:
                                print(f"  ⭐ CONTAINS RATIO DATA!")
                            if "calculation" in body_str:
                                print(f"  ⭐ CONTAINS CALCULATIONS!")
                            if "harmony" in body_str:
                                print(f"  ⭐ CONTAINS HARMONY DATA!")
                            if "analysis" in body_str:
                                print(f"  ⭐ CONTAINS ANALYSIS DATA!")

                        except json.JSONDecodeError:
                            response_data["response_body"] = flow.response.content.decode('utf-8', errors='ignore')[:2000]

                    faceiq_responses.append(response_data)

                    # Save individual file
                    safe_name = endpoint.replace("/", "_").strip("_")
                    filename = f"{i:03d}_{method}_{safe_name}.json"
                    filepath = os.path.join(OUTPUT_DIR, filename)

                    with open(filepath, "w") as out:
                        json.dump(response_data, out, indent=2)
                    print(f"  → Saved: {filename}")

        except Exception as e:
            print(f"Error processing flow {i}: {e}")

# Save all responses to one file
all_responses_file = os.path.join(OUTPUT_DIR, "ALL_FACEIQ_RESPONSES.json")
with open(all_responses_file, "w") as f:
    json.dump(faceiq_responses, f, indent=2)

print(f"\n{'='*60}")
print(f"SUMMARY")
print(f"{'='*60}")
print(f"Total FaceIQ API calls captured: {len(faceiq_responses)}")
print(f"\nAll hosts seen:")
for host in sorted(all_hosts):
    print(f"  - {host}")
print(f"\nAll responses saved to: {OUTPUT_DIR}")
print(f"Combined file: {all_responses_file}")
