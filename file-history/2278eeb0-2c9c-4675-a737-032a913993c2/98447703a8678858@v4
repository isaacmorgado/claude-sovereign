'use client';

import { useState, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { useDropzone } from 'react-dropzone';
import { motion, AnimatePresence } from 'framer-motion';
import { Upload, X, Image as ImageIcon, ArrowRight, ArrowLeft, User, UserCircle } from 'lucide-react';
import { useUpload } from '@/contexts/UploadContext';

type UploadStep = 'front' | 'side';

export default function UploadPage() {
  const router = useRouter();
  const { frontPhoto, sidePhoto, setFrontPhoto, setSidePhoto } = useUpload();
  const [currentStep, setCurrentStep] = useState<UploadStep>('front');

  const currentPhoto = currentStep === 'front' ? frontPhoto : sidePhoto;
  const setCurrentPhoto = currentStep === 'front' ? setFrontPhoto : setSidePhoto;

  const onDrop = useCallback((acceptedFiles: File[]) => {
    const selectedFile = acceptedFiles[0];
    if (selectedFile) {
      const objectUrl = URL.createObjectURL(selectedFile);
      setCurrentPhoto({ file: selectedFile, preview: objectUrl });
    }
  }, [setCurrentPhoto]);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      'image/*': ['.jpeg', '.jpg', '.png', '.webp']
    },
    maxFiles: 1,
    multiple: false
  });

  const removeImage = () => {
    if (currentPhoto?.preview) {
      URL.revokeObjectURL(currentPhoto.preview);
    }
    setCurrentPhoto(null);
  };

  const handleNext = () => {
    if (currentStep === 'front' && frontPhoto) {
      setCurrentStep('side');
    } else if (currentStep === 'side' && sidePhoto) {
      router.push('/analysis');
    }
  };

  const handleBack = () => {
    if (currentStep === 'side') {
      setCurrentStep('front');
    } else {
      router.push('/ethnicity');
    }
  };

  const stepConfig = {
    front: {
      title: 'Upload Front-Facing Photo',
      subtitle: 'Upload a clear, front-facing photo looking straight at the camera',
      icon: User,
      stepNumber: 1,
    },
    side: {
      title: 'Upload Side Profile Photo',
      subtitle: 'Upload a clear side profile photo showing your facial structure',
      icon: UserCircle,
      stepNumber: 2,
    },
  };

  const config = stepConfig[currentStep];
  const StepIcon = config.icon;

  return (
    <main className="min-h-screen bg-black flex flex-col items-center justify-center px-4 py-12">
      {/* Progress Steps */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="flex items-center gap-4 mb-8"
      >
        {/* Step 1 */}
        <div className="flex items-center gap-2">
          <div className={`
            w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold
            transition-all duration-300
            ${currentStep === 'front' || frontPhoto
              ? 'bg-accent text-black shadow-[0_0_15px_rgba(0,243,255,0.5)]'
              : 'bg-background-tertiary text-foreground-dim'
            }
          `}>
            {frontPhoto ? '✓' : '1'}
          </div>
          <span className={`text-sm hidden sm:block ${currentStep === 'front' ? 'text-white' : 'text-foreground-dim'}`}>
            Front Photo
          </span>
        </div>

        {/* Connector */}
        <div className={`w-12 h-0.5 ${frontPhoto ? 'bg-accent' : 'bg-border'} transition-colors duration-300`} />

        {/* Step 2 */}
        <div className="flex items-center gap-2">
          <div className={`
            w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold
            transition-all duration-300
            ${currentStep === 'side'
              ? 'bg-accent text-black shadow-[0_0_15px_rgba(0,243,255,0.5)]'
              : sidePhoto
                ? 'bg-accent text-black'
                : 'bg-background-tertiary text-foreground-dim'
            }
          `}>
            {sidePhoto ? '✓' : '2'}
          </div>
          <span className={`text-sm hidden sm:block ${currentStep === 'side' ? 'text-white' : 'text-foreground-dim'}`}>
            Side Profile
          </span>
        </div>
      </motion.div>

      {/* Header */}
      <AnimatePresence mode="wait">
        <motion.div
          key={currentStep}
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: 20 }}
          transition={{ duration: 0.3 }}
          className="text-center mb-10"
        >
          <div className="flex items-center justify-center gap-3 mb-4">
            <StepIcon className="w-8 h-8 text-accent" />
            <h1 className="text-3xl md:text-4xl font-bold text-white">
              {config.title}
            </h1>
          </div>
          <p className="text-foreground-dim text-lg max-w-md mx-auto">
            {config.subtitle}
          </p>
        </motion.div>
      </AnimatePresence>

      {/* Upload Container */}
      <motion.div
        initial={{ opacity: 0, scale: 0.95 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{ duration: 0.5, delay: 0.1 }}
        className="w-full max-w-xl"
      >
        <AnimatePresence mode="wait">
          {!currentPhoto ? (
            /* Dropzone */
            <motion.div
              key={`dropzone-${currentStep}`}
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
            >
              <div
                {...getRootProps()}
                className={`
                  relative w-full aspect-[4/3] rounded-2xl border-2 border-dashed
                  flex flex-col items-center justify-center gap-4
                  cursor-pointer transition-all duration-300
                  ${isDragActive
                    ? 'border-accent bg-accent/10 shadow-[0_0_40px_rgba(0,243,255,0.3)]'
                    : 'border-border bg-background-secondary hover:border-accent/50 hover:bg-background-tertiary'
                  }
                `}
              >
                <input {...getInputProps()} />

                {/* Upload Icon */}
                <motion.div
                  animate={isDragActive ? { scale: 1.1, y: -5 } : { scale: 1, y: 0 }}
                  transition={{ duration: 0.2 }}
                  className={`
                    p-6 rounded-full
                    ${isDragActive ? 'bg-accent/20' : 'bg-background-tertiary'}
                    transition-colors duration-300
                  `}
                >
                  <Upload
                    className={`
                      w-12 h-12 transition-colors duration-300
                      ${isDragActive ? 'text-accent' : 'text-foreground-dim'}
                    `}
                  />
                </motion.div>

                {/* Text */}
                <div className="text-center px-4">
                  <p className={`
                    text-lg font-medium transition-colors duration-300
                    ${isDragActive ? 'text-accent' : 'text-white'}
                  `}>
                    {isDragActive ? 'Drop your image here' : 'Drag & drop your image here'}
                  </p>
                  <p className="text-foreground-dim mt-2">
                    or <span className="text-accent hover:text-accent-hover underline">browse</span> to upload
                  </p>
                </div>

                {/* Supported formats */}
                <div className="flex items-center gap-2 text-sm text-foreground-dim mt-2">
                  <ImageIcon className="w-4 h-4" />
                  <span>JPG, PNG, WEBP supported</span>
                </div>

                {/* Photo guide hint */}
                <div className="absolute bottom-4 left-4 right-4 text-center">
                  <p className="text-xs text-foreground-dim">
                    {currentStep === 'front'
                      ? 'Tip: Face the camera directly with neutral expression'
                      : 'Tip: Turn 90° to show your side profile clearly'
                    }
                  </p>
                </div>

                {/* Decorative corners */}
                <div className="absolute top-4 left-4 w-8 h-8 border-l-2 border-t-2 border-border-light rounded-tl-lg" />
                <div className="absolute top-4 right-4 w-8 h-8 border-r-2 border-t-2 border-border-light rounded-tr-lg" />
                <div className="absolute bottom-12 left-4 w-8 h-8 border-l-2 border-b-2 border-border-light rounded-bl-lg" />
                <div className="absolute bottom-12 right-4 w-8 h-8 border-r-2 border-b-2 border-border-light rounded-br-lg" />
              </div>
            </motion.div>
          ) : (
            /* Preview */
            <motion.div
              key={`preview-${currentStep}`}
              initial={{ opacity: 0, scale: 0.95 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.95 }}
              className="relative w-full aspect-[4/3] rounded-2xl overflow-hidden bg-black border border-border"
            >
              {/* Image */}
              <Image
                src={currentPhoto.preview}
                alt={`${currentStep} preview`}
                fill
                className="object-contain bg-black"
                unoptimized
              />

              {/* Photo type badge */}
              <div className="absolute top-4 left-4 px-3 py-1.5 rounded-full bg-accent/20 border border-accent/50 z-10">
                <span className="text-accent text-sm font-medium flex items-center gap-2">
                  <StepIcon className="w-4 h-4" />
                  {currentStep === 'front' ? 'Front Photo' : 'Side Profile'}
                </span>
              </div>

              {/* Remove button */}
              <motion.button
                initial={{ opacity: 0, scale: 0 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{ delay: 0.2 }}
                onClick={removeImage}
                className="
                  absolute top-4 right-4 p-2 rounded-full
                  bg-black/80 border border-border hover:border-error
                  text-white hover:text-error
                  transition-all duration-200
                  hover:shadow-[0_0_15px_rgba(239,68,68,0.5)]
                  z-10
                "
              >
                <X className="w-5 h-5" />
              </motion.button>

              {/* File info */}
              <div className="absolute bottom-4 left-4 right-4 px-4 py-3 rounded-lg bg-black/80 border border-border z-10">
                <p className="text-white font-medium truncate">{currentPhoto.file.name}</p>
                <p className="text-foreground-dim text-sm">
                  {(currentPhoto.file.size / 1024 / 1024).toFixed(2)} MB
                </p>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </motion.div>

      {/* Navigation Buttons */}
      <div className="flex items-center gap-4 mt-10">
        {/* Back Button */}
        <motion.button
          initial={{ opacity: 0, x: -20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.3, delay: 0.2 }}
          onClick={handleBack}
          className="
            px-6 py-4 rounded-lg font-semibold
            flex items-center gap-2
            bg-background-tertiary text-foreground-dim
            hover:text-white hover:border-accent/50
            border border-border
            transition-all duration-300
          "
        >
          <ArrowLeft className="w-5 h-5" />
          Back
        </motion.button>

        {/* Next Button */}
        <motion.button
          initial={{ opacity: 0, x: 20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.3, delay: 0.2 }}
          onClick={handleNext}
          disabled={!currentPhoto}
          className={`
            px-8 py-4 rounded-lg font-semibold text-lg
            flex items-center gap-3
            transition-all duration-300
            ${currentPhoto
              ? 'bg-accent text-black hover:bg-accent-hover hover:shadow-[0_0_30px_rgba(0,243,255,0.5)] cursor-pointer'
              : 'bg-background-tertiary text-foreground-dim cursor-not-allowed'
            }
          `}
        >
          {currentStep === 'front' ? 'Next: Side Profile' : 'Start Analysis'}
          <ArrowRight className="w-5 h-5" />
        </motion.button>
      </div>

      {/* Thumbnails for both photos when on step 2 */}
      {currentStep === 'side' && frontPhoto && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="mt-8 flex items-center gap-4"
        >
          <div className="text-foreground-dim text-sm">Uploaded:</div>
          <div
            className="relative w-16 h-16 rounded-lg overflow-hidden border-2 border-accent cursor-pointer hover:scale-105 transition-transform"
            onClick={() => setCurrentStep('front')}
          >
            <Image
              src={frontPhoto.preview}
              alt="Front photo thumbnail"
              fill
              className="object-cover"
              unoptimized
            />
            <div className="absolute inset-0 bg-black/40 flex items-center justify-center">
              <User className="w-5 h-5 text-white" />
            </div>
          </div>
          {sidePhoto && (
            <div className="relative w-16 h-16 rounded-lg overflow-hidden border-2 border-accent">
              <Image
                src={sidePhoto.preview}
                alt="Side photo thumbnail"
                fill
                className="object-cover"
                unoptimized
              />
              <div className="absolute inset-0 bg-black/40 flex items-center justify-center">
                <UserCircle className="w-5 h-5 text-white" />
              </div>
            </div>
          )}
        </motion.div>
      )}
    </main>
  );
}
