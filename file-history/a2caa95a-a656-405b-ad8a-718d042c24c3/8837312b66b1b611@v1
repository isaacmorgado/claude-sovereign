#!/bin/bash
# Fix debugLog is not defined - Emergency Patch
# Run with: bash fix-debuglog-danny.sh

set -e

CEP_DIR="/Library/Application Support/Adobe/CEP/extensions/com.splice.panel"
PANEL_DIR="$CEP_DIR/panel"

echo ""
echo "=== SPLICE debugLog Emergency Fix ==="
echo ""

# Check if extension exists
if [ ! -d "$CEP_DIR" ]; then
    echo "ERROR: SPLICE not found at: $CEP_DIR"
    exit 1
fi

echo "Found SPLICE extension"

# Backup
BACKUP="$CEP_DIR/backup-debuglog-fix-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP"
sudo cp "$PANEL_DIR/index.html" "$BACKUP/"
echo "Backup created: $BACKUP"

# Fix: Add emergency debugLog definition at the TOP of index.html
echo ""
echo "Patching index.html..."

# Create the emergency script tag
EMERGENCY_SCRIPT='<script>
// EMERGENCY FIX: Define debugLog BEFORE any other scripts
window.debugLog = function(...args) {
    if (localStorage.getItem('"'"'spliceDebugMode'"'"') === '"'"'true'"'"') {
        console.log('"'"'[SPLICE DEBUG]'"'"', ...args);
    } else {
        console.log('"'"'[SPLICE]'"'"', ...args);
    }
};
window.debugFetch = function(...args) {
    if (localStorage.getItem('"'"'spliceDebugMode'"'"') === '"'"'true'"'"') {
        console.log('"'"'[SPLICE FETCH]'"'"', ...args);
    }
};
console.log('"'"'[SPLICE] Emergency debugLog/debugFetch defined (patch applied)'"'"');
</script>'

# Insert EMERGENCY_SCRIPT right after <head> tag
sudo perl -i -pe 's|(<head>)|$1\n'"$EMERGENCY_SCRIPT"'|' "$PANEL_DIR/index.html"

echo "✅ Patch applied!"

# Verify
if grep -q "Emergency debugLog" "$PANEL_DIR/index.html"; then
    echo "✅ Verification: Emergency script found in index.html"
else
    echo "❌ ERROR: Patch verification failed"
    exit 1
fi

echo ""
echo "=== FIX COMPLETE ==="
echo ""
echo "Next steps:"
echo "  1. QUIT Premiere Pro completely (Cmd+Q)"
echo "  2. Reopen Premiere Pro"
echo "  3. Open SPLICE panel"
echo "  4. Check DevTools console for:"
echo "     '[SPLICE] Emergency debugLog/debugFetch defined (patch applied)'"
echo ""
echo "UI should now work!"
echo ""
