# SPLICE

AI-powered Premiere Pro UXP plugin for detecting takes, removing silences, and accelerating video editing workflows.

## Current Focus
**95% FIRECUT Parity** - All core features implemented

## Quick Reference

### Pricing Tiers
| Tier | Price | Hours | Isolation | Stripe Price ID |
|------|-------|-------|-----------|-----------------|
| Starter | $19/mo | 15 hrs | ❌ None | price_1SgH4m2L5BseYEbCih347qfr |
| Pro | $49/mo | 50 hrs | 45 min included | price_1SgH4o2L5BseYEbCIoR19lhQ |
| Team | $149/mo | 150 hrs | 3 hrs included | price_1SgH4q2L5BseYEbCYTlimb5M |
| Overage | $1/hr | - | $0.10/min | price_1SgH4y2L5BseYEbClZuxNRu8 |

### Isolation Pricing (v3.4)
- **Starter**: No access (upgrade required)
- **Pro**: 45 min included, then $0.10/min overage
- **Team**: 3 hrs included, then $0.10/min overage
- **Our cost**: $0.015/min → **85% margin on overage**
- **Worst-case margin**: 80%+ (sized to maintain margins at full utilization)

### Key Constraints
- UXP requires Premiere Pro 25.6+
- Use `127.0.0.1` not `localhost` in fetch URLs
- Backend (prod): https://splice-api-production.up.railway.app

## Key Files

| File | Purpose |
|------|---------|
| `splice-backend/server.js` | Express + all endpoints + webhook handler |
| `splice-backend/services/transcription.js` | Whisper transcription + retry + cache |
| `splice-backend/services/usageTracking.js` | Credit balance, usage logging |
| `splice-backend/services/cutListGenerator.js` | v3.5 JSON cut list generator |
| `splice-backend/services/captionExporter.js` | SRT/VTT/TXT caption export |
| `splice-plugin/js/main.js` | Plugin initialization + workflows |
| `splice-plugin/js/builder.js` | v3.5 Direct DOM sequence builder |
| `splice-plugin/js/settings.js` | Settings + Presets + Persistent Token |
| `splice-plugin/js/credits.js` | Fetch/display credit balance |
| `splice-plugin/index.html` | UI with credit badge in header |

## Implementation Phases

- Phase 1: Backend billing ✅
- Phase 2: Frontend credits ✅
- Phase 3: Preview Mode ✅
- Phase 4: v3.5 Direct DOM Reconstruction ✅
- Phase 5: 95% FIRECUT Parity ✅

## v3.5 Architecture (Implemented)

**Zero-manual-step workflow using UXP DOM APIs:**

1. Detect silences/takes (existing workflow)
2. Backend generates JSON cut list via `/cut-list` endpoint
3. Plugin builds sequence directly using `builder.js`
4. New sequence created with `_SPLICE` suffix

**Core UXP APIs:**
- `SequenceEditor.createInsertProjectItemAction()` - Insert clips at timecode
- `ProjectItem.createSetColorLabelAction(index)` - Color clips (set BEFORE insert)
- `TrackItem.createSetInPointAction/OutPointAction()` - Set in/out points
- `project.executeTransaction(actions)` - Batch execute atomically
- `fs.createPersistentToken(folder)` - Silent file access

**New Endpoints:**
- `POST /cut-list` - Generate JSON cut list from silences/takes
- `POST /cut-list/takes` - Generate cut list keeping only takes

**Key Functions:**
- `buildSequenceFromCutList(cutList)` - Build sequence from backend cut list
- `buildSequenceFromDetection(silences, takes, source)` - Direct build from detection
- `setupMediaFolder()` - Set up persistent token for media access
- `generateCutList(options)` - Backend cut list generation

**Legacy (Deprecated):**
- `splice-plugin/js/slice9-razor.js` - Old XML workflow (still available)
- `splice-backend/services/xmlProcessor.js` - Old XML processor

## Phase 5 Features (95% Parity)

### New Endpoints
| Endpoint | Purpose |
|----------|---------|
| `POST /fillers` | Detect filler words (um, uh, like, etc.) |
| `POST /export/captions` | Export to SRT/VTT/TXT/JSON |
| `GET /export/formats` | List supported export formats |
| `POST /batch/silences` | Batch process multiple files |
| `GET /batch/status/:id` | Get batch job status |
| `GET /batch/results/:id` | Get batch job results |
| `GET /batch/jobs` | List all batch jobs |

### Transcription Improvements
- **Retry Logic**: Exponential backoff (3 retries) for 429/5xx errors
- **Cache Limit**: LRU eviction at 50 entries max
- **Error Handling**: Clear messages for quota/connection errors

### Preset Profiles (settings.js)
| Preset | Sensitivity | Min Silence | Use Case |
|--------|-------------|-------------|----------|
| `podcast` | 35 | 0.8s | Natural pauses, conversational |
| `interview` | 50 | 0.5s | Balanced Q&A rhythm |
| `reaction` | 70 | 0.3s | Fast-paced, tight cuts |
| `tutorial` | 30 | 1.0s | Preserve teaching pace |
| `vlog` | 65 | 0.35s | Punchy YouTube edits |
| `custom` | - | - | User-defined settings |

### Caption Export Formats
- **SRT**: SubRip (widely supported)
- **VTT**: WebVTT (web standard, styling)
- **TXT**: Plain text with timestamps
- **JSON**: Full transcript for programmatic use

## Last Session (2025-12-25)

Implemented Phase 5: 95% FIRECUT parity features.

**What was done:**
- Added `/fillers` endpoint for filler word detection
- Added OpenAI API retry logic with exponential backoff
- Added LRU cache eviction (50 entry limit)
- Created `captionExporter.js` service (SRT/VTT/TXT/JSON)
- Added `/export/captions` and `/export/formats` endpoints
- Added preset profiles (podcast, interview, reaction, tutorial, vlog)
- Added batch processing (`/batch/silences`, status, results)

**Files modified:**
- `splice-backend/server.js` - Added 7 new endpoints
- `splice-backend/services/transcription.js` - Retry logic + cache limit
- `splice-backend/services/captionExporter.js` - New file
- `splice-plugin/js/settings.js` - Added preset profiles

**Stopped at:** All Phase 5 features implemented. Ready for testing.

## Next Steps

1. Test all new endpoints with sample audio
2. Add preset selector UI to plugin
3. Add batch processing UI to plugin
4. Deploy to Railway production

## Quick Commands
```bash
cd /Users/imorgado/SPLICE/splice-backend
node server.js                         # Start server
curl -sk https://127.0.0.1:3847/health # Health check
```

---
*Last updated: 2025-12-25*
