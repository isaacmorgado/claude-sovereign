'use client';

import { useMemo, useEffect, useState } from 'react';
import { motion } from 'framer-motion';
import Link from 'next/link';
import {
  Info,
  Target,
  Palette,
  TrendingUp,
  Users,
  ArrowRight,
  BookOpen,
  Clock,
  Brain,
  Wrench,
  TrendingDown,
  Dumbbell,
  Calendar,
  Heart,
  Utensils,
  Droplet,
  User,
  Sparkles,
  ChevronRight,
  Globe,
  Lock,
} from 'lucide-react';
import { useResults } from '@/contexts/ResultsContext';
import { usePricing } from '@/contexts/PricingContext';
import { Guide } from '@/types/guides';
import { getGuideById } from '@/data/guides';
import { TabContent } from '../ResultsLayout';
import {
  ARCHETYPE_COLORS,
  ConfidenceBar,
  DimorphismBadge,
  ArchetypeTraits,
  CategoryIcon,
} from '@/components/psl/archetype/ArchetypeTraits';
import {
  classifyFromRatios,
  ArchetypeClassification,
  ArchetypeCategory,
} from '@/lib/archetype-classifier';
import { api, ArchetypeForumRecommendation } from '@/lib/api';

const LockedOverlay = ({ onUnlock }: { onUnlock?: () => void }) => (
  <div
    onClick={onUnlock}
    className="absolute inset-0 z-20 flex flex-col items-center justify-center bg-black/40 backdrop-blur-[2px] cursor-pointer group transition-colors hover:bg-black/50 rounded-[inherit]"
  >
    <div className="w-12 h-12 rounded-full bg-cyan-500/20 border border-cyan-500/50 flex items-center justify-center mb-3 backdrop-blur-md shadow-[0_0_20px_rgba(34,211,238,0.3)] group-hover:scale-110 transition-transform">
      <Lock className="w-5 h-5 text-cyan-400" />
    </div>
    <p className="text-xs font-black uppercase tracking-widest text-white drop-shadow-md">Unlock Full Profile</p>
  </div>
);

// ============================================
// SECTION HEADER COMPONENT
// ============================================

function SectionHeader({ title }: { title: string }) {
  return (
    <h2 className="text-[10px] font-black uppercase tracking-[0.4em] text-neutral-600 mb-6 flex items-center gap-4">
      {title}
      <div className="flex-1 h-px bg-neutral-800" />
    </h2>
  );
}

// ============================================
// PREMIUM ARCHETYPE HERO CARD
// ============================================

function PremiumArchetypeCard({
  classification,
}: {
  classification: ArchetypeClassification;
}) {
  const { primary, secondary, dimorphismLevel } = classification;
  const colors = ARCHETYPE_COLORS[primary.category];

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="rounded-[2rem] bg-neutral-900/40 border border-white/5 p-8 relative overflow-hidden"
    >
      {/* Background decoration */}
      <div className="absolute top-0 right-0 p-8 opacity-5">
        <User size={180} />
      </div>

      {/* Header */}
      <div className="flex items-center justify-between mb-8 relative z-10">
        <div>
          <span className="text-[10px] font-black uppercase tracking-[0.3em] text-neutral-500 block mb-2">
            PRIMARY CLASSIFICATION
          </span>
          <h2 className="text-3xl font-black tracking-tighter italic uppercase text-white">
            {primary.subArchetype}
          </h2>
        </div>
        <DimorphismBadge level={dimorphismLevel} size="sm" />
      </div>

      {/* Main content grid */}
      <div className="grid md:grid-cols-2 gap-8 relative z-10">
        {/* Left: Primary archetype info */}
        <div>
          <div className="flex items-start gap-5 mb-6">
            <motion.div
              initial={{ scale: 0.8 }}
              animate={{ scale: 1 }}
              transition={{ type: 'spring', stiffness: 200 }}
              className="w-16 h-16 rounded-2xl flex items-center justify-center border"
              style={{
                background: `linear-gradient(135deg, ${colors.primary}20 0%, ${colors.primary}05 100%)`,
                borderColor: `${colors.primary}30`,
              }}
            >
              <CategoryIcon category={primary.category} />
            </motion.div>

            <div className="flex-1">
              <span
                className="inline-block px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider mb-2"
                style={{
                  backgroundColor: `${colors.primary}15`,
                  color: colors.primary,
                  border: `1px solid ${colors.primary}30`,
                }}
              >
                {primary.category}
              </span>
              <div className="flex items-baseline gap-3">
                <span
                  className="text-4xl font-black"
                  style={{ color: colors.primary }}
                >
                  {Math.round(primary.confidence * 100)}%
                </span>
                <span className="text-[10px] font-bold uppercase tracking-wider text-neutral-500">
                  MATCH
                </span>
              </div>
            </div>
          </div>

          {/* Confidence bar */}
          <div className="mb-6">
            <ConfidenceBar
              confidence={primary.confidence}
              label="MATCH STRENGTH"
              color={colors.primary}
            />
          </div>

          {/* Traits */}
          <div>
            <span className="text-[10px] font-bold uppercase tracking-wider text-neutral-600 block mb-3">
              DEFINING TRAITS
            </span>
            <ArchetypeTraits traits={primary.traits} />
          </div>
        </div>

        {/* Right: Secondary archetype */}
        {secondary && (
          <div className="rounded-2xl bg-neutral-900/50 border border-white/5 p-5">
            <div className="flex items-center justify-between mb-4">
              <span className="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-500">
                SECONDARY MATCH
              </span>
              <span
                className="px-2.5 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider"
                style={{
                  backgroundColor: `${ARCHETYPE_COLORS[secondary.category].primary}15`,
                  color: ARCHETYPE_COLORS[secondary.category].primary,
                  border: `1px solid ${ARCHETYPE_COLORS[secondary.category].primary}30`,
                }}
              >
                {Math.round(secondary.confidence * 100)}%
              </span>
            </div>

            <div className="flex items-center gap-4 mb-4">
              <div
                className="w-12 h-12 rounded-xl flex items-center justify-center border"
                style={{
                  background: `linear-gradient(135deg, ${ARCHETYPE_COLORS[secondary.category].primary}15 0%, transparent 100%)`,
                  borderColor: `${ARCHETYPE_COLORS[secondary.category].primary}20`,
                }}
              >
                <CategoryIcon category={secondary.category} />
              </div>
              <div>
                <h3
                  className="text-xl font-black italic uppercase"
                  style={{ color: ARCHETYPE_COLORS[secondary.category].primary }}
                >
                  {secondary.subArchetype}
                </h3>
                <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-500">
                  {secondary.category}
                </p>
              </div>
            </div>

            {secondary.traits.length > 0 && (
              <ArchetypeTraits traits={secondary.traits.slice(0, 3)} compact />
            )}
          </div>
        )}
      </div>
    </motion.div>
  );
}

// ============================================
// ALL SCORES - COMPACT GRID
// ============================================

function AllArchetypeScores({
  classification,
  isUnlocked,
  onUnlock,
}: {
  classification: ArchetypeClassification;
  isUnlocked?: boolean;
  onUnlock?: () => void;
}) {
  const sortedScores = [...classification.allScores].sort((a, b) => b.score - a.score);

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ delay: 0.2 }}
      className="relative"
    >
      {!isUnlocked && <LockedOverlay onUnlock={onUnlock} />}
      <div className={!isUnlocked ? 'blur-md opacity-50 pointer-events-none select-none' : ''}>
        <SectionHeader title="Category Breakdown" />

        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
          {sortedScores.map((score, index) => {
            const colors = ARCHETYPE_COLORS[score.category as ArchetypeCategory];
            const isPrimary = index === 0;

            return (
              <div
                key={score.category}
                className={`relative p-4 rounded-2xl border transition-all ${isPrimary
                  ? 'bg-neutral-900/60 border-cyan-500/30'
                  : 'bg-neutral-900/40 border-white/5 hover:border-white/10'
                  }`}
              >
                {isPrimary && (
                  <div className="absolute -top-2.5 left-3 px-2 py-0.5 bg-cyan-500 rounded-lg text-[9px] font-black uppercase tracking-wider text-black">
                    PRIMARY
                  </div>
                )}
                <div
                  className="text-2xl font-black mb-1"
                  style={{ color: colors?.primary || '#6b7280' }}
                >
                  {score.score}%
                </div>
                <div className="text-[10px] font-bold uppercase tracking-wider text-neutral-500 truncate">
                  {score.category}
                </div>
                {/* Progress bar */}
                <div className="mt-3 h-1.5 bg-neutral-800 rounded-full overflow-hidden">
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${score.score}%` }}
                    transition={{ duration: 0.8, delay: 0.3 + index * 0.05 }}
                    className="h-full rounded-full"
                    style={{ backgroundColor: colors?.primary || '#6b7280' }}
                  />
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </motion.div>
  );
}

// ============================================
// STYLE RECOMMENDATIONS - PREMIUM CARDS
// ============================================

function StyleRecommendations({
  classification,
}: {
  classification: ArchetypeClassification;
  isUnlocked?: boolean;
  onUnlock?: () => void;
}) {
  const { styleGuide, primary } = classification;

  const sections = [
    { key: 'clothing', label: 'CLOTHING', items: styleGuide.clothing, icon: Sparkles },
    { key: 'hair', label: 'HAIR', items: styleGuide.hair, icon: User },
    { key: 'colors', label: 'COLORS', items: styleGuide.colors, icon: Palette },
  ];

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ delay: 0.3 }}
      className="relative rounded-3xl"
    >
      {!isUnlocked && <LockedOverlay onUnlock={onUnlock} />}
      <div className={!isUnlocked ? 'blur-md opacity-50 pointer-events-none select-none' : ''}>
        <SectionHeader title="Style Recommendations" />

        <div className="rounded-[2rem] bg-neutral-900/40 border border-white/5 p-6 relative overflow-hidden">
          {/* Background decoration */}
          <div className="absolute top-0 right-0 p-6 opacity-5">
            <Palette size={100} />
          </div>

          <div className="flex items-center gap-3 mb-6 relative z-10">
            <div className="w-10 h-10 rounded-xl bg-neutral-900 border border-white/10 flex items-center justify-center">
              <Palette size={18} className="text-purple-400" />
            </div>
            <div>
              <h3 className="text-lg font-black italic uppercase text-white">
                {primary.subArchetype} <span className="text-purple-400">Style</span>
              </h3>
              <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-500">
                CURATED FOR YOUR ARCHETYPE
              </p>
            </div>
          </div>

          <div className="grid md:grid-cols-3 gap-4 relative z-10">
            {sections.map((section) => (
              <div
                key={section.key}
                className="rounded-2xl bg-neutral-900/50 border border-white/5 p-4"
              >
                <div className="flex items-center gap-2 mb-3">
                  <section.icon size={14} className="text-neutral-500" />
                  <span className="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-500">
                    {section.label}
                  </span>
                </div>
                <div className="flex flex-wrap gap-2">
                  {section.items.slice(0, 4).map((item) => (
                    <span
                      key={item}
                      className="px-3 py-1.5 rounded-xl text-xs font-bold uppercase tracking-wider bg-neutral-800/80 text-neutral-300 border border-white/5"
                    >
                      {item}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </motion.div>
  );
}

// ============================================
// TRANSITION OPPORTUNITIES
// ============================================

function TransitionOpportunities({
  classification,
}: {
  classification: ArchetypeClassification;
  isUnlocked?: boolean;
  onUnlock?: () => void;
}) {
  const { transitionPath, primary, allScores } = classification;

  if (!transitionPath) return null;

  const targetScore = allScores.find((s) => s.category === transitionPath.target);
  const primaryColors = ARCHETYPE_COLORS[primary.category];
  const targetColors = ARCHETYPE_COLORS[transitionPath.target as ArchetypeCategory];

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ delay: 0.4 }}
      className="relative"
    >
      {!isUnlocked && <LockedOverlay onUnlock={onUnlock} />}
      <div className={!isUnlocked ? 'blur-md opacity-50 pointer-events-none select-none' : ''}>
        <SectionHeader title="Transition Potential" />

        <div className="rounded-[2rem] bg-gradient-to-br from-cyan-500/10 via-transparent to-purple-500/10 border border-cyan-500/20 p-6">
          <div className="flex items-center gap-3 mb-6">
            <div className="w-10 h-10 rounded-xl bg-neutral-900 border border-cyan-500/30 flex items-center justify-center">
              <TrendingUp size={18} className="text-green-400" />
            </div>
            <div>
              <h3 className="text-lg font-black italic uppercase text-white">
                ARCHETYPE <span className="text-cyan-400">EVOLUTION</span>
              </h3>
              <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-500">
                YOUR PATH TO OPTIMIZATION
              </p>
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-6 mb-6">
            {/* Current */}
            <div className="rounded-2xl bg-neutral-900/60 border border-white/5 p-5">
              <span className="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-500 block mb-3">
                CURRENT
              </span>
              <h4
                className="text-2xl font-black italic uppercase mb-1"
                style={{ color: primaryColors.primary }}
              >
                {primary.subArchetype}
              </h4>
              <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-500 mb-4">
                {primary.category}
              </p>
              <ConfidenceBar
                confidence={primary.confidence}
                label="MATCH"
                color={primaryColors.primary}
              />
            </div>

            {/* Target */}
            <div className="rounded-2xl bg-neutral-900/60 border border-cyan-500/20 p-5">
              <span className="text-[10px] font-black uppercase tracking-[0.2em] text-cyan-500 block mb-3">
                TARGET
              </span>
              <h4
                className="text-2xl font-black italic uppercase mb-1"
                style={{ color: targetColors?.primary || '#67e8f9' }}
              >
                {transitionPath.target}
              </h4>
              <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-500 mb-4">
                {targetScore ? `${targetScore.score}% CURRENT MATCH` : 'NEW CATEGORY'}
              </p>
              {targetScore && (
                <ConfidenceBar
                  confidence={targetScore.confidence}
                  label="PROXIMITY"
                  color={targetColors?.primary}
                />
              )}
            </div>
          </div>

          {/* Requirements */}
          <div>
            <span className="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-500 block mb-4">
              REQUIREMENTS
            </span>
            <div className="grid md:grid-cols-2 gap-3">
              {transitionPath.requirements.map((req, i) => (
                <div
                  key={i}
                  className="flex items-center gap-3 p-4 rounded-2xl bg-neutral-900/50 border border-white/5"
                >
                  <span className="w-7 h-7 rounded-lg bg-cyan-500/20 text-cyan-400 flex items-center justify-center text-xs font-black">
                    {i + 1}
                  </span>
                  <span className="text-sm text-neutral-300 font-medium">{req}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </motion.div>
  );
}

// ============================================
// RECOMMENDED FORUMS SECTION
// ============================================

function RecommendedForumsSection({
  classification,
}: {
  classification: ArchetypeClassification;
}) {
  const [forums, setForums] = useState<ArchetypeForumRecommendation[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  const archetype = classification.primary.category;
  const colors = ARCHETYPE_COLORS[archetype];

  useEffect(() => {
    let isMounted = true;

    async function fetchForums() {
      setIsLoading(true);
      try {
        const recommendations = await api.getArchetypeForumRecommendations(archetype);
        if (isMounted) {
          setForums(recommendations.slice(0, 3));
        }
      } catch (error) {
        if (isMounted) {
          console.error('[ArchetypeTab] Failed to fetch forum recommendations:', error);
        }
      } finally {
        if (isMounted) {
          setIsLoading(false);
        }
      }
    }

    fetchForums();

    return () => {
      isMounted = false;
    };
  }, [archetype]);

  if (isLoading) {
    return (
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.35 }}
      >
        <SectionHeader title="Community Forums" />
        <div className="grid gap-4 md:grid-cols-3">
          {[1, 2, 3].map((i) => (
            <div key={i} className="animate-pulse rounded-2xl bg-neutral-900/40 border border-white/5 h-32" />
          ))}
        </div>
      </motion.div>
    );
  }

  if (forums.length === 0) return null;

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ delay: 0.35 }}
    >
      <SectionHeader title="Community Forums" />

      <div className="rounded-[2rem] bg-neutral-900/40 border border-white/5 p-6">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-neutral-900 border border-white/10 flex items-center justify-center">
              <Users size={18} className="text-amber-400" />
            </div>
            <div>
              <h3 className="text-lg font-black italic uppercase text-white">
                RECOMMENDED <span className="text-amber-400">FORUMS</span>
              </h3>
              <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-500">
                BASED ON YOUR ARCHETYPE
              </p>
            </div>
          </div>
          <span
            className="px-3 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-wider"
            style={{
              backgroundColor: `${colors.primary}15`,
              color: colors.primary,
              border: `1px solid ${colors.primary}30`,
            }}
          >
            {archetype}
          </span>
        </div>

        <div className="grid gap-4 md:grid-cols-3 mb-6">
          {forums.map((forum) => (
            <Link key={forum.category.id} href={`/forum/${forum.category.slug}`}>
              <div className="group rounded-2xl bg-neutral-900/50 border border-white/5 hover:border-amber-500/30 p-5 transition-all cursor-pointer h-full">
                <div className="flex items-center gap-3 mb-3">
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/20 flex items-center justify-center text-xl flex-shrink-0">
                    {forum.category.icon || ''}
                  </div>
                  <h4 className="font-black uppercase tracking-tight text-white group-hover:text-amber-400 transition-colors text-sm">
                    {forum.category.name}
                  </h4>
                </div>
                <p className="text-xs text-neutral-400 leading-relaxed line-clamp-2 mb-3">
                  {forum.reason || forum.category.description}
                </p>
                <div className="flex items-center justify-end">
                  <span className="text-[10px] font-black uppercase tracking-wider text-amber-400 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                    VISIT
                    <ChevronRight size={12} />
                  </span>
                </div>
              </div>
            </Link>
          ))}
        </div>

        <Link href="/forum">
          <div className="flex items-center justify-center gap-2 py-3 rounded-2xl bg-neutral-900/50 border border-white/5 hover:border-white/10 text-sm text-neutral-400 hover:text-white transition-all">
            <Globe size={14} />
            <span className="font-bold uppercase tracking-wider text-xs">EXPLORE ALL FORUMS</span>
            <ArrowRight size={14} />
          </div>
        </Link>
      </div>
    </motion.div>
  );
}

// ============================================
// RECOMMENDED GUIDES SECTION
// ============================================

const GUIDE_ICON_MAP: Record<string, React.ReactNode> = {
  BookOpen: <BookOpen size={18} />,
  Dumbbell: <Dumbbell size={18} />,
  Brain: <Brain size={18} />,
  Wrench: <Wrench size={18} />,
  TrendingDown: <TrendingDown size={18} />,
  Calendar: <Calendar size={18} />,
  Target: <Target size={18} />,
  Heart: <Heart size={18} />,
  Utensils: <Utensils size={18} />,
  Droplet: <Droplet size={18} />,
};

const ARCHETYPE_GUIDES: Record<string, string[]> = {
  Softboy: ['skincare', 'mindset', 'diet', 'maintenance'],
  Prettyboy: ['skincare', 'maintenance', 'diet', 'body-fat'],
  RobustPrettyboy: ['v-taper', 'training', 'skincare', 'diet'],
  Chad: ['v-taper', 'training', 'core-neck', 'body-fat'],
  Hypermasculine: ['v-taper', 'training', 'core-neck', 'cardio'],
  Exotic: ['skincare', 'mindset', 'maintenance', 'diet'],
};

function RecommendedGuidesSection({
  classification,
  onOpenGuide,
}: {
  classification: ArchetypeClassification;
  onOpenGuide: (guide: Guide) => void;
}) {
  const archetype = classification.primary.category;
  const colors = ARCHETYPE_COLORS[archetype];
  const guideIds = ARCHETYPE_GUIDES[archetype] || ARCHETYPE_GUIDES.Softboy;

  const guides = guideIds
    .map((id) => getGuideById(id))
    .filter((g): g is Guide => g !== undefined)
    .slice(0, 3);

  if (guides.length === 0) return null;

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ delay: 0.35 }}
    >
      <SectionHeader title="Recommended Guides" />

      <div className="rounded-[2rem] bg-neutral-900/40 border border-white/5 p-6">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-neutral-900 border border-white/10 flex items-center justify-center">
              <BookOpen size={18} className="text-cyan-400" />
            </div>
            <div>
              <h3 className="text-lg font-black italic uppercase text-white">
                PROTOCOL <span className="text-cyan-400">GUIDES</span>
              </h3>
              <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-500">
                OPTIMIZED FOR YOUR ARCHETYPE
              </p>
            </div>
          </div>
          <span
            className="px-3 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-wider"
            style={{
              backgroundColor: `${colors.primary}15`,
              color: colors.primary,
              border: `1px solid ${colors.primary}30`,
            }}
          >
            {archetype}
          </span>
        </div>

        <div className="grid gap-4 md:grid-cols-3 mb-6">
          {guides.map((guide) => (
            <div
              key={guide.id}
              onClick={() => onOpenGuide(guide)}
              className="group rounded-2xl bg-neutral-900/50 border border-white/5 hover:border-cyan-500/30 p-5 transition-all cursor-pointer"
            >
              <div className="flex items-center gap-3 mb-3">
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border border-cyan-500/20 flex items-center justify-center text-cyan-400 flex-shrink-0">
                  {GUIDE_ICON_MAP[guide.icon] || <BookOpen size={18} />}
                </div>
                <h4 className="font-black uppercase tracking-tight text-white group-hover:text-cyan-400 transition-colors text-sm">
                  {guide.title}
                </h4>
              </div>
              <p className="text-xs text-neutral-400 leading-relaxed line-clamp-2 mb-3">
                {guide.description}
              </p>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-1.5 text-neutral-500">
                  <Clock size={12} />
                  <span className="text-[10px] font-bold uppercase tracking-wider">
                    {guide.estimatedReadTime} MIN
                  </span>
                </div>
                <span className="text-[10px] font-black uppercase tracking-wider text-cyan-400 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                  READ
                  <ChevronRight size={12} />
                </span>
              </div>
            </div>
          ))}
        </div>

        <Link href="/results?tab=guides">
          <div className="flex items-center justify-center gap-2 py-3 rounded-2xl bg-neutral-900/50 border border-white/5 hover:border-white/10 text-sm text-neutral-400 hover:text-white transition-all">
            <BookOpen size={14} />
            <span className="font-bold uppercase tracking-wider text-xs">VIEW ALL GUIDES</span>
            <ArrowRight size={14} />
          </div>
        </Link>
      </div>
    </motion.div>
  );
}

// ============================================
// MAIN ARCHETYPE TAB
// ============================================

export function ArchetypeTab() {
  const { frontRatios, sideRatios, gender, ethnicity, setActiveTab, isUnlocked } = useResults();
  const { openPricingModal } = usePricing();

  const classification = useMemo((): ArchetypeClassification | null => {
    if (!frontRatios || frontRatios.length === 0) return null;

    try {
      return classifyFromRatios(frontRatios, sideRatios || [], gender, ethnicity);
    } catch (error) {
      console.error('[ArchetypeTab] Classification error:', error);
      return null;
    }
  }, [frontRatios, sideRatios, gender, ethnicity]);

  const handleOpenGuide = () => {
    setActiveTab('guides');
  };

  if (!classification) {
    return (
      <TabContent
        title="Archetype Classification"
        subtitle="Determining your facial archetype based on your metrics"
      >
        <div className="rounded-[2rem] bg-neutral-900/40 border border-white/5 p-12 text-center">
          <div className="w-16 h-16 rounded-2xl bg-neutral-900 border border-white/10 flex items-center justify-center mx-auto mb-6">
            <User size={32} className="text-neutral-600" />
          </div>
          <h3 className="text-xl font-black italic uppercase text-neutral-400 mb-2">
            CLASSIFICATION PENDING
          </h3>
          <p className="text-neutral-500 text-sm max-w-md mx-auto">
            Unable to classify archetype. Please ensure your analysis is complete.
          </p>
        </div>
      </TabContent>
    );
  }

  return (
    <TabContent
      title=""
      subtitle=""
    >
      <div className="space-y-10">
        {/* Page header */}
        <header>
          <h1 className="text-3xl font-black tracking-tighter italic uppercase mb-2">
            Archetype <span className="text-cyan-400">Classification</span>
          </h1>
          <p className="text-neutral-500 font-medium uppercase text-[10px] tracking-[0.2em]">
            FACIAL AESTHETIC PROFILE BASED ON BONE STRUCTURE & PROPORTIONS
          </p>
        </header>

        {/* Premium Archetype Card */}
        <PremiumArchetypeCard classification={classification} />

        {/* All Scores Breakdown */}
        <AllArchetypeScores classification={classification} isUnlocked={isUnlocked} onUnlock={openPricingModal} />

        {/* Style Recommendations */}
        <StyleRecommendations classification={classification} isUnlocked={isUnlocked} onUnlock={openPricingModal} />

        {/* Recommended Guides */}
        <RecommendedGuidesSection
          classification={classification}
          onOpenGuide={handleOpenGuide}
        />

        {/* Recommended Forums */}
        <RecommendedForumsSection classification={classification} />

        {/* Transition Opportunities */}
        <TransitionOpportunities classification={classification} isUnlocked={isUnlocked} onUnlock={openPricingModal} />

        {/* Info footer */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5 }}
          className="rounded-2xl bg-neutral-900/40 border border-white/5 p-6"
        >
          <div className="flex items-start gap-4">
            <div className="w-10 h-10 rounded-xl bg-neutral-900 border border-white/10 flex items-center justify-center flex-shrink-0">
              <Info size={18} className="text-neutral-500" />
            </div>
            <div>
              <h4 className="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-500 mb-2">
                METHODOLOGY
              </h4>
              <p className="text-sm text-neutral-400 leading-relaxed">
                Archetype classification analyzes your facial structure including gonial angle,
                face width-height ratio, canthal tilt, and cheekbone position. Your primary archetype
                represents your dominant aesthetic, while your secondary shows traits you also exhibit.
                Style recommendations are tailored to complement your natural features.
              </p>
            </div>
          </div>
        </motion.div>
      </div>
    </TabContent>
  );
}
