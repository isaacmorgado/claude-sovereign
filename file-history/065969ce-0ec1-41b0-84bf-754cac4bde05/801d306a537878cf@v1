#!/usr/bin/env python3
"""
Complete kenkais.com scraper with ALL ACCESS CODES
Exclusive: 9111, Agency: 9111, Projects: 8222, Resources: 8222
"""

import asyncio
import time
import json
from playwright.async_api import async_playwright

# Section configurations with their passwords
SECTIONS = [
    {
        "name": "Exclusive",
        "url": "https://www.kenkais.com/exclusive",
        "password": "9111"
    },
    {
        "name": "Agency",
        "url": "https://www.kenkais.com/agency",
        "password": "9111"
    },
    {
        "name": "Projects",
        "url": "https://www.kenkais.com/projects",
        "password": "8222"
    },
    {
        "name": "Resources",
        "url": "https://www.kenkais.com/resources",
        "password": "8222"
    }
]


async def enter_password(page, password):
    """Enter password and submit"""
    try:
        # Wait for password input
        code_input = await page.wait_for_selector('input[type="text"]', timeout=5000, state="visible")
        if code_input:
            # Enter password digit by digit
            for digit in password:
                await code_input.type(digit)
                await page.wait_for_timeout(200)

            print(f"    ‚úì Entered password: {password}")

            # Submit (try Enter key first)
            await page.keyboard.press("Enter")
            await page.wait_for_timeout(3000)

            return True
    except Exception as e:
        print(f"    ‚ö†Ô∏è  No password prompt or error: {e}")
        return False


async def expand_all_dropdowns(page):
    """Expand all collapsed elements on the page"""
    expanded = await page.evaluate("""
        () => {
            let count = 0;
            const selectors = [
                '[aria-expanded="false"]',
                '.collapsed',
                'details:not([open])',
                '[data-state="closed"]',
                'button[aria-expanded="false"]',
            ];

            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    try {
                        if (el.tagName === 'DETAILS') {
                            el.open = true;
                        } else {
                            el.click();
                        }
                        count++;
                    } catch(e) {
                        // Ignore click errors
                    }
                });
            });

            return count;
        }
    """)

    if expanded > 0:
        print(f"    ‚úì Expanded {expanded} dropdowns/accordions")
        await page.wait_for_timeout(1500)
        return True
    return False


async def extract_modal_content(page):
    """Extract content from What's New modal if present"""
    try:
        # Check if modal exists
        modal_content = await page.evaluate("""
            () => {
                const modal = document.querySelector('.modal, [role="dialog"]');
                if (modal) {
                    return modal.innerText;
                }
                return null;
            }
        """)

        if modal_content:
            print(f"    ‚úì Found modal content: {len(modal_content)} characters")
            return modal_content
        return None
    except:
        return None


async def close_modal(page):
    """Try to close any open modals"""
    try:
        # Try clicking close button
        close_btn = page.locator('button:has-text("√ó")')
        if await close_btn.count() > 0:
            await close_btn.first.click()
            await page.wait_for_timeout(1000)
            print("    ‚úì Closed modal")
            return True
    except:
        pass

    # Try ESC key as fallback
    try:
        await page.keyboard.press("Escape")
        await page.wait_for_timeout(1000)
        return True
    except:
        return False


async def scrape_section(page, section):
    """Scrape a single section with its password"""
    print("\n" + "=" * 70)
    print(f"SECTION: {section['name']}")
    print(f"URL: {section['url']}")
    print(f"Password: {section['password']}")
    print("=" * 70)

    try:
        # Navigate to section
        print("[1/5] Navigating...")
        await page.goto(section['url'])
        await page.wait_for_timeout(3000)

        # Take initial screenshot
        screenshot_initial = f"kenkais_all_{section['name'].lower()}_01_initial.png"
        await page.screenshot(path=screenshot_initial)
        print(f"    ‚úì Screenshot: {screenshot_initial}")

        # Enter password
        print("[2/5] Entering password...")
        await enter_password(page, section['password'])

        # Take post-auth screenshot
        screenshot_auth = f"kenkais_all_{section['name'].lower()}_02_auth.png"
        await page.screenshot(path=screenshot_auth)
        print(f"    ‚úì Screenshot: {screenshot_auth}")

        # Extract modal content first (before closing)
        print("[3/5] Extracting modal content...")
        modal_content = await extract_modal_content(page)

        # Close modal to see underlying page
        await close_modal(page)
        await page.wait_for_timeout(1000)

        # Expand dropdowns
        print("[4/5] Expanding dropdowns...")
        await expand_all_dropdowns(page)

        # Take final screenshot
        screenshot_final = f"kenkais_all_{section['name'].lower()}_03_final.png"
        await page.screenshot(path=screenshot_final)
        print(f"    ‚úì Screenshot: {screenshot_final}")

        # Extract page content
        print("[5/5] Extracting content...")
        page_content = await page.evaluate("() => document.body.innerText")

        total_content = ""
        if modal_content:
            total_content += "=== MODAL CONTENT (What's New) ===\n\n" + modal_content + "\n\n"
        total_content += "=== PAGE CONTENT ===\n\n" + page_content

        print(f"    ‚úì Modal content: {len(modal_content) if modal_content else 0} chars")
        print(f"    ‚úì Page content: {len(page_content)} chars")
        print(f"    ‚úì Total: {len(total_content)} chars")

        # Save to file
        filename = f"kenkais_all_{section['name'].lower()}.txt"
        with open(filename, "w", encoding="utf-8") as f:
            f.write(f"# {section['name']} - Kenkais.com\n\n")
            f.write(f"**URL**: {section['url']}\n")
            f.write(f"**Password**: {section['password']}\n")
            f.write(f"**Extracted**: {time.strftime('%Y-%m-%d %H:%M:%S')}\n\n")
            f.write("---\n\n")
            f.write(total_content)

        print(f"    ‚úì Saved: {filename}")

        return {
            'section': section['name'],
            'url': section['url'],
            'password': section['password'],
            'file': filename,
            'screenshots': [screenshot_initial, screenshot_auth, screenshot_final],
            'modal_chars': len(modal_content) if modal_content else 0,
            'page_chars': len(page_content),
            'total_chars': len(total_content),
            'success': True
        }

    except Exception as e:
        print(f"\n    ‚ùå ERROR: {e}")
        import traceback
        traceback.print_exc()

        return {
            'section': section['name'],
            'url': section['url'],
            'password': section['password'],
            'success': False,
            'error': str(e)
        }


async def scrape_all_sections():
    """Scrape all sections with full access"""
    print("=" * 70)
    print("KENKAIS.COM - COMPLETE ACCESS SCRAPER")
    print("=" * 70)
    print()
    print("üîì Access Codes:")
    for section in SECTIONS:
        print(f"   - {section['name']}: {section['password']}")
    print()

    async with async_playwright() as p:
        print("[SETUP] Launching browser...")
        browser = await p.chromium.launch(
            headless=False,
            args=[
                "--disable-blink-features=AutomationControlled",
                "--disable-dev-shm-usage",
                "--no-sandbox",
            ],
        )

        context = await browser.new_context(
            viewport={"width": 1920, "height": 1080},
            user_agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        )

        page = await context.new_page()

        # Apply stealth
        await page.add_init_script("""
            Object.defineProperty(navigator, 'webdriver', {get: () => undefined});
            window.chrome = {runtime: {}};
        """)

        all_results = []

        try:
            # Scrape each section
            for idx, section in enumerate(SECTIONS, 1):
                print(f"\n{'#' * 70}")
                print(f"# SECTION {idx}/4: {section['name']}")
                print(f"{'#' * 70}")

                result = await scrape_section(page, section)
                all_results.append(result)

                # Brief pause between sections
                if idx < len(SECTIONS):
                    print("\n‚è≥ Pausing 2 seconds before next section...")
                    await page.wait_for_timeout(2000)

            # Create comprehensive summary
            print("\n" + "=" * 70)
            print("CREATING COMPREHENSIVE SUMMARY")
            print("=" * 70)

            with open("KENKAIS_COMPLETE_EXTRACTION.md", "w", encoding="utf-8") as f:
                f.write("# Kenkais.com - Complete Extraction Report\n\n")
                f.write(f"**Date**: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"**Sections Scraped**: {len(SECTIONS)}\n")
                f.write(f"**Method**: Native Playwright + Stealth Mode\n\n")
                f.write("---\n\n")

                f.write("## Access Codes Used\n\n")
                f.write("| Section | URL | Password |\n")
                f.write("|---------|-----|----------|\n")
                for section in SECTIONS:
                    f.write(f"| {section['name']} | {section['url']} | {section['password']} |\n")
                f.write("\n---\n\n")

                f.write("## Extraction Results\n\n")

                successful = sum(1 for r in all_results if r.get('success'))
                total_chars = sum(r.get('total_chars', 0) for r in all_results if r.get('success'))

                f.write(f"**Success Rate**: {successful}/{len(SECTIONS)} sections\n")
                f.write(f"**Total Content**: {total_chars:,} characters\n\n")

                for result in all_results:
                    f.write(f"### {result['section']}\n\n")

                    if result.get('success'):
                        f.write(f"‚úÖ **Status**: Success\n\n")
                        f.write(f"- **URL**: {result['url']}\n")
                        f.write(f"- **Password**: `{result['password']}`\n")
                        f.write(f"- **Modal Content**: {result['modal_chars']:,} characters\n")
                        f.write(f"- **Page Content**: {result['page_chars']:,} characters\n")
                        f.write(f"- **Total**: {result['total_chars']:,} characters\n")
                        f.write(f"- **File**: `{result['file']}`\n")
                        f.write(f"- **Screenshots**: {len(result['screenshots'])} captured\n\n")
                    else:
                        f.write(f"‚ùå **Status**: Failed\n\n")
                        f.write(f"- **Error**: {result.get('error', 'Unknown')}\n\n")

                f.write("---\n\n")
                f.write("## Files Created\n\n")
                for result in all_results:
                    if result.get('success'):
                        f.write(f"### {result['section']}\n\n")
                        f.write(f"- `{result['file']}`\n")
                        for screenshot in result.get('screenshots', []):
                            f.write(f"- `{screenshot}`\n")
                        f.write("\n")

            print("\n‚úÖ Summary saved: KENKAIS_COMPLETE_EXTRACTION.md")

            # Also save JSON for easy parsing
            with open("kenkais_all_results.json", "w") as f:
                json.dump(all_results, f, indent=2)
            print("‚úÖ JSON saved: kenkais_all_results.json")

            # Final statistics
            print("\n" + "=" * 70)
            print("üéâ COMPLETE EXTRACTION FINISHED!")
            print("=" * 70)
            print()
            print(f"‚úÖ Sections scraped: {successful}/{len(SECTIONS)}")
            print(f"üìä Total content: {total_chars:,} characters")
            print()
            print("üìÅ Main files:")
            print("   - KENKAIS_COMPLETE_EXTRACTION.md (summary)")
            print("   - kenkais_all_results.json (data)")
            for result in all_results:
                if result.get('success'):
                    print(f"   - {result['file']}")
            print()

            return all_results

        except Exception as e:
            print(f"\n‚ùå Fatal error: {e}")
            import traceback
            traceback.print_exc()
            return all_results

        finally:
            print("\n‚è∞ Closing browser in 20 seconds...")
            await asyncio.sleep(20)
            await browser.close()


if __name__ == "__main__":
    print()
    results = asyncio.run(scrape_all_sections())
    print()

    if results:
        successful = sum(1 for r in results if r.get('success'))
        print("=" * 70)
        if successful == len(SECTIONS):
            print("üèÜ PERFECT! All sections extracted successfully!")
        elif successful > 0:
            print(f"‚úÖ PARTIAL SUCCESS! {successful}/{len(SECTIONS)} sections extracted")
        else:
            print("‚ùå FAILED! No sections were extracted")
        print("=" * 70)
