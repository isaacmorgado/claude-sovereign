#!/usr/bin/env python3
"""
Final kenkais.com scraper - closes modal properly, finds actual course pages
"""

import asyncio
from playwright.async_api import async_playwright

SITE_URL = "https://www.kenkais.com/agency"
ACCESS_CODE = "9111"


async def scrape_kenkais_final():
    print("=" * 70)
    print("Kenkais.com Final Course Scraper")
    print("=" * 70)
    print()

    async with async_playwright() as p:
        print("[1/6] Launching browser...")
        browser = await p.chromium.launch(
            headless=False,
            args=["--disable-blink-features=AutomationControlled"],
        )

        context = await browser.new_context(
            viewport={"width": 1920, "height": 1080},
            user_agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
        )

        page = await context.new_page()

        await page.add_init_script("""
            Object.defineProperty(navigator, 'webdriver', {get: () => undefined});
        """)

        try:
            print("[2/6] Navigating...")
            await page.goto(SITE_URL)
            await page.wait_for_timeout(3000)

            await page.screenshot(path="kenkais_final_01.png")

            # Enter code
            print("[3/6] Entering access code...")
            try:
                code_input = await page.wait_for_selector(
                    'input[type="text"]', timeout=3000
                )
                if code_input:
                    for digit in ACCESS_CODE:
                        await code_input.type(digit)
                        await page.wait_for_timeout(200)
                    await page.keyboard.press("Enter")
                    await page.wait_for_timeout(2000)
                    print("    ✓ Code entered")
            except:
                print("    ℹ️  No code prompt")

            await page.screenshot(path="kenkais_final_02.png")

            # Close the modal by clicking the X button
            print("[4/6] Closing What's New modal...")
            try:
                # Look for close button with × symbol
                close_button = page.locator('button:has-text("×")')
                if await close_button.count() > 0:
                    await close_button.first.click()
                    await page.wait_for_timeout(1500)
                    print("    ✓ Modal closed")
                else:
                    print("    ⚠️  No X button found, trying other methods...")
                    # Try ESC key
                    await page.keyboard.press("Escape")
                    await page.wait_for_timeout(1000)
            except Exception as e:
                print(f"    ⚠️  Could not close modal: {e}")

            await page.screenshot(path="kenkais_final_03_modal_closed.png")

            # NOW look for actual course content
            print("[5/6] Finding course links on main page...")

            # Extract all visible text to see what's on the page
            page_text = await page.evaluate("() => document.body.innerText")
            print(f"    Page has {len(page_text)} characters")

            # Save what we see
            with open("kenkais_final_after_modal.txt", "w") as f:
                f.write(page_text)
            print("    ✓ Saved page content")

            # Look for ALL links on the page
            all_links = await page.evaluate("""
                () => {
                    return Array.from(document.querySelectorAll('a[href]')).map(a => ({
                        text: a.textContent.trim(),
                        href: a.href,
                        visible: a.offsetParent !== null
                    })).filter(link => link.visible && link.text);
                }
            """)

            print(f"    ✓ Found {len(all_links)} visible links")

            # Save links
            import json

            with open("kenkais_final_all_links.json", "w") as f:
                json.dump(all_links, f, indent=2)

            # Look for course-related links
            course_links = [
                link
                for link in all_links
                if "course" in link["text"].lower()
                or "course" in link["href"].lower()
                or "agency" in link["href"].lower()
            ]

            print(f"    ✓ {len(course_links)} potential course links")

            # If we have links, navigate to each
            all_courses = []

            for idx, link in enumerate(course_links[:10], 1):  # Limit to first 10
                try:
                    print(f"\n    [{idx}] {link['text'][:50]}")
                    print(f"        URL: {link['href']}")

                    await page.goto(link["href"])
                    await page.wait_for_timeout(2000)

                    # Expand dropdowns
                    expanded = await page.evaluate("""
                        () => {
                            let count = 0;
                            ['[aria-expanded="false"]', 'details:not([open])'].forEach(sel => {
                                document.querySelectorAll(sel).forEach(el => {
                                    try {
                                        if (el.tagName === 'DETAILS') el.open = true;
                                        else el.click();
                                        count++;
                                    } catch(e) {}
                                });
                            });
                            return count;
                        }
                    """)

                    if expanded > 0:
                        await page.wait_for_timeout(1000)

                    content = await page.evaluate("() => document.body.innerText")

                    safe_name = "".join(
                        c for c in link["text"] if c.isalnum() or c in (" ", "-")
                    )[:40]
                    safe_name = safe_name.replace(" ", "_")
                    filename = f"kenkais_final_course_{idx}_{safe_name}.txt"

                    with open(filename, "w") as f:
                        f.write(f"# {link['text']}\n\n")
                        f.write(f"URL: {link['href']}\n\n")
                        f.write("---\n\n")
                        f.write(content)

                    await page.screenshot(path=f"kenkais_final_course_{idx}.png")

                    all_courses.append(
                        {
                            "title": link["text"],
                            "url": link["href"],
                            "file": filename,
                            "chars": len(content),
                        }
                    )

                    print(f"        ✓ Extracted {len(content)} chars")

                except Exception as e:
                    print(f"        ❌ Error: {e}")

            # Summary
            print("\n[6/6] Creating summary...")
            with open("kenkais_final_summary.md", "w") as f:
                f.write("# Kenkais.com Final Extraction\n\n")
                f.write(f"**Courses found**: {len(all_courses)}\n\n")
                for c in all_courses:
                    f.write(f"- {c['title']}: {c['chars']} chars\n")

            print(f"\n✅ Extracted {len(all_courses)} courses")
            print("Check kenkais_final_*.txt files")

            return all_courses

        except Exception as e:
            print(f"\n❌ Error: {e}")
            import traceback

            traceback.print_exc()

        finally:
            print("\nClosing in 15 seconds...")
            await asyncio.sleep(15)
            await browser.close()


if __name__ == "__main__":
    asyncio.run(scrape_kenkais_final())
