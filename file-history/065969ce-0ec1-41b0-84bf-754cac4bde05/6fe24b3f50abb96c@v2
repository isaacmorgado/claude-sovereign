#!/usr/bin/env python3
"""
Extract Design Speak & Code Speak prompting courses from kenkais.com
Creates a dedicated reference guide for Claude Code
"""

import asyncio
import time
from playwright.async_api import async_playwright

EXCLUSIVE_URL = "https://www.kenkais.com/exclusive"
PASSWORD = "9111"


async def extract_prompting_courses():
    print("=" * 70)
    print("Kenkais.com - Prompting Courses Extractor")
    print("Design Speak & Code Speak")
    print("=" * 70)
    print()

    async with async_playwright() as p:
        print("[1/5] Launching browser...")
        browser = await p.chromium.launch(
            headless=False,
            args=["--disable-blink-features=AutomationControlled"],
        )

        context = await browser.new_context(
            viewport={"width": 1920, "height": 1080},
            user_agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
        )

        page = await context.new_page()

        await page.add_init_script("""
            Object.defineProperty(navigator, 'webdriver', {get: () => undefined});
        """)

        try:
            print("[2/5] Navigating to Exclusive section...")
            await page.goto(EXCLUSIVE_URL)
            await page.wait_for_timeout(3000)

            # Enter password
            print("[3/5] Entering password...")
            try:
                code_input = await page.wait_for_selector(
                    'input[type="text"]', timeout=5000
                )
                if code_input:
                    for digit in PASSWORD:
                        await code_input.type(digit)
                        await page.wait_for_timeout(200)
                    await page.keyboard.press("Enter")
                    await page.wait_for_timeout(3000)
                    print("    ‚úì Access granted")
            except:
                print("    ‚ÑπÔ∏è  No password prompt")

            # Take screenshot showing modal
            await page.screenshot(path="prompting_courses_modal.png")
            print("    ‚úì Screenshot saved")

            # Look for "Design Speak & Code Speak" in the modal
            print("[4/5] Searching for prompting courses...")

            # Try to click on the course card
            course_clicked = False
            course_selectors = [
                'text="Design Speak & Code Speak"',
                'text="Design Speak"',
                'text="Code Speak"',
                ':text("prompting")',
                ':text("terminology")',
            ]

            for selector in course_selectors:
                try:
                    element = page.locator(selector).first
                    if await element.count() > 0:
                        print(f"    ‚úì Found course element: {selector}")
                        await element.click()
                        course_clicked = True
                        print("    ‚úì Clicked on course")
                        await page.wait_for_timeout(3000)
                        break
                except Exception as e:
                    print(f"    ‚ö†Ô∏è  Selector {selector} failed: {e}")
                    continue

            if not course_clicked:
                print("    ‚ö†Ô∏è  Could not click course card, extracting from modal...")

            # Extract all content
            print("[5/5] Extracting prompting course content...")

            # Scroll through page to load all content
            await page.evaluate("""
                () => {
                    window.scrollTo(0, document.body.scrollHeight);
                }
            """)
            await page.wait_for_timeout(2000)

            # Get full page content
            full_content = await page.evaluate("() => document.body.innerText")

            await page.screenshot(path="prompting_courses_content.png")
            print(f"    ‚úì Extracted {len(full_content)} characters")

            # Save raw content
            with open("prompting_courses_raw.txt", "w", encoding="utf-8") as f:
                f.write("# Design Speak & Code Speak - Raw Extraction\n\n")
                f.write(f"**Source**: {EXCLUSIVE_URL}\n")
                f.write(f"**Extracted**: {time.strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                f.write("---\n\n")
                f.write(full_content)

            print("    ‚úì Saved: prompting_courses_raw.txt")

            # Parse and structure the content
            print("\n‚úÖ Extraction complete!")
            print("üìÑ Files created:")
            print("   - prompting_courses_raw.txt")
            print("   - prompting_courses_modal.png")
            print("   - prompting_courses_content.png")

            return full_content

        except Exception as e:
            print(f"\n‚ùå Error: {e}")
            import traceback

            traceback.print_exc()
            return None

        finally:
            print("\n‚è∞ Closing in 15 seconds...")
            await asyncio.sleep(15)
            await browser.close()


if __name__ == "__main__":
    print()
    result = asyncio.run(extract_prompting_courses())

    if result and len(result) > 500:
        print("\n" + "=" * 70)
        print("‚úÖ SUCCESS! Prompting courses extracted")
        print("=" * 70)
        print()
        print("Next: Review prompting_courses_raw.txt and structure it")
        print("      into a Claude Code reference guide")
        print()
    else:
        print("\n" + "=" * 70)
        print("‚ö†Ô∏è  Limited content extracted")
        print("=" * 70)
        print()
        print("The course content may require:")
        print("- Clicking into individual course pages")
        print("- Navigating through course modules")
        print("- Manual exploration")
        print()
