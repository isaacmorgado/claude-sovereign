#!/usr/bin/env python3
"""
Test GLM integration with user's Z.ai API key
"""

import asyncio
import os
from crawl4ai import AsyncWebCrawler, CrawlerRunConfig, LLMExtractionStrategy, LLMConfig

# Set API key
ZHIPUAI_API_KEY = "9a58c7331504f3cbaef3f2f95cb375b.BrfNpV8TbeF5tCaK"
os.environ["ZHIPUAI_API_KEY"] = ZHIPUAI_API_KEY


async def test_glm_models():
    """Test all GLM models with the user's API key"""

    print("=" * 70)
    print("Testing ZhipuAI GLM Models with Your API Key")
    print("=" * 70)
    print()
    print(f"API Key: {ZHIPUAI_API_KEY[:15]}...")
    print()

    # Test URL
    test_url = "https://example.com"
    extraction_instruction = (
        "Extract the main heading and explain the purpose of this domain"
    )

    # Models to test
    models_to_test = [
        ("glm-4-flash", "zhipu/glm-4-flash"),  # Fastest
        ("glm-4", "zhipu/glm-4"),  # Balanced
        ("glm-4-long", "zhipu/glm-4-long"),  # 1M context
        ("glm-4-plus", "zhipu/glm-4-plus"),  # Best reasoning
    ]

    for model_name, model_provider in models_to_test:
        print("-" * 70)
        print(f"Testing {model_name.upper()}")
        print(f"Provider: {model_provider}")
        print("-" * 70)
        print()

        try:
            # Configure LLM
            llm_config = LLMConfig(
                provider=model_provider,
                api_token=ZHIPUAI_API_KEY,
                temperature=0.7,
            )

            extraction = LLMExtractionStrategy(
                llm_config=llm_config, instruction=extraction_instruction
            )

            print(f"üöÄ Starting scrape with {model_name}...")
            print(f"üìç URL: {test_url}")
            print()

            async with AsyncWebCrawler(verbose=False) as crawler:
                result = await crawler.arun(
                    url=test_url,
                    config=CrawlerRunConfig(
                        extraction_strategy=extraction,
                        word_count_threshold=10,
                        verbose=False,
                    ),
                )

                print(f"‚úÖ {model_name.upper()} - SUCCESS!")
                print(f"üìä Extracted: {len(result.markdown)} characters")
                print()
                print("--- Extracted Content (first 300 chars) ---")
                print(result.markdown[:300])
                print("--- End ---")
                print()

                # Save output
                filename = f"test_{model_name}_output.md"
                with open(filename, "w", encoding="utf-8") as f:
                    f.write(f"# Test: {model_name.upper()}\n\n")
                    f.write(f"**URL**: {test_url}\n")
                    f.write(f"**Model**: {model_provider}\n")
                    f.write(f"**Extraction**: {extraction_instruction}\n\n")
                    f.write("---\n\n")
                    f.write(result.markdown)

                print(f"üíæ Saved to: {filename}")
                print()

        except Exception as e:
            print(f"‚ùå {model_name.upper()} - FAILED")
            print(f"Error: {e}")
            print()

            # Check if it's an API error
            if "API" in str(e) or "auth" in str(e).lower():
                print("‚ö†Ô∏è  This looks like an API authentication issue.")
                print("   Please verify:")
                print("   1. API key is correct")
                print("   2. Z.ai subscription is active")
                print("   3. API key has proper permissions")
                print()

        # Rate limit safety
        await asyncio.sleep(2)

    print("=" * 70)
    print("Testing Complete!")
    print("=" * 70)
    print()
    print("Summary:")
    print("- Tested 4 GLM models")
    print("- API Key configured successfully")
    print("- Check test_*_output.md files for full results")
    print()
    print("üí° Tips:")
    print("  - GLM-4-Long is best for large pages (1M context)")
    print("  - GLM-4-Flash is fastest and cheapest")
    print("  - GLM-4-Plus is best for complex reasoning")
    print()


if __name__ == "__main__":
    asyncio.run(test_glm_models())
