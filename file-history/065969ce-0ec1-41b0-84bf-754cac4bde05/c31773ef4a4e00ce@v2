#!/usr/bin/env python3
"""
Interactive scraper for kenkais.com agency courses
Clicks on course cards in the modal to navigate and extract content
"""

import asyncio
import time
from playwright.async_api import async_playwright

# Site info
SITE_URL = "https://www.kenkais.com/agency"
ACCESS_CODE = "9111"


async def scrape_kenkais_interactive():
    """
    Interactive deep scrape: clicks on course cards, extracts content
    """

    print("=" * 70)
    print("Kenkais.com Interactive Course Scraper")
    print("=" * 70)
    print()
    print(f"üîê Site: {SITE_URL}")
    print(f"üîë Access Code: {ACCESS_CODE}")
    print("üîç Mode: INTERACTIVE (clicks on cards)")
    print()

    async with async_playwright() as p:
        # Launch browser (visible for debugging)
        print("[1/6] Launching browser...")
        browser = await p.chromium.launch(
            headless=False,
            args=[
                "--disable-blink-features=AutomationControlled",
                "--disable-dev-shm-usage",
                "--no-sandbox",
            ],
        )

        context = await browser.new_context(
            viewport={"width": 1920, "height": 1080},
            user_agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        )

        page = await context.new_page()

        # Apply stealth
        await page.add_init_script("""
            Object.defineProperty(navigator, 'webdriver', {get: () => undefined});
            window.chrome = {runtime: {}};
        """)

        try:
            # Navigate
            print("[2/6] Navigating to site...")
            await page.goto(SITE_URL, wait_until="domcontentloaded")
            await page.wait_for_timeout(3000)

            # Take initial screenshot
            await page.screenshot(path="kenkais_interactive_01_initial.png")
            print("    ‚úì Initial screenshot")

            # Enter code if prompted
            print("[3/6] Handling access code...")
            try:
                code_input = await page.wait_for_selector(
                    'input[type="text"]', timeout=3000, state="visible"
                )
                if code_input:
                    for digit in ACCESS_CODE:
                        await code_input.type(digit)
                        await page.wait_for_timeout(300)
                    print(f"    ‚úì Entered code: {ACCESS_CODE}")

                    # Submit
                    await page.keyboard.press("Enter")
                    await page.wait_for_timeout(2000)
                    print("    ‚úì Code submitted")
            except:
                print("    ‚ÑπÔ∏è  No code prompt")

            await page.screenshot(path="kenkais_interactive_02_after_code.png")

            # Find course cards in modal by looking for specific text patterns
            print("[4/6] Finding course cards in modal...")
            course_titles = [
                "Starting Your Agency",
                "Backend Courses",
                "Ken's Discord Boilerplate",
                "Design Speak & Code Speak",
                "Content Cat",
                "First Project Course Series",
                "Security Courses",
                "Course Tutorials",
            ]

            all_courses_data = []

            # Try to find each course by title and click on it
            for idx, title in enumerate(course_titles, 1):
                try:
                    print(f"\n[5/{idx}] Course: {title}")

                    # Look for the course card by text
                    # The cards might be divs, not links
                    card = page.locator(f"text={title}").first

                    if await card.count() > 0:
                        print("    ‚úì Found card")

                        # Scroll into view
                        await card.scroll_into_view_if_needed()
                        await page.wait_for_timeout(500)

                        # Click the card
                        await card.click()
                        print("    ‚úì Clicked card")

                        # Wait for navigation or content change
                        await page.wait_for_timeout(3000)

                        # Take screenshot
                        screenshot_name = f"kenkais_interactive_course_{idx:02d}.png"
                        await page.screenshot(path=screenshot_name)
                        print(f"    ‚úì Screenshot: {screenshot_name}")

                        # Get current URL
                        current_url = page.url
                        print(f"    ‚Üí URL: {current_url}")

                        # Expand any dropdowns on course page
                        expanded = await page.evaluate("""
                            () => {
                                let count = 0;
                                const selectors = [
                                    '[aria-expanded="false"]',
                                    '.collapsed',
                                    'details:not([open])',
                                    '[data-state="closed"]',
                                ];
                                selectors.forEach(sel => {
                                    document.querySelectorAll(sel).forEach(el => {
                                        try {
                                            if (el.tagName === 'DETAILS') el.open = true;
                                            else el.click();
                                            count++;
                                        } catch(e) {}
                                    });
                                });
                                return count;
                            }
                        """)

                        if expanded > 0:
                            print(f"    ‚úì Expanded {expanded} dropdowns")
                            await page.wait_for_timeout(1000)

                        # Extract content
                        content = await page.evaluate("() => document.body.innerText")
                        print(f"    ‚úì Extracted {len(content)} characters")

                        # Save to file
                        safe_title = "".join(
                            c for c in title if c.isalnum() or c in (" ", "-", "_")
                        ).strip()
                        safe_title = safe_title.replace(" ", "_")
                        filename = f"kenkais_course_{safe_title}.txt"

                        with open(filename, "w", encoding="utf-8") as f:
                            f.write(f"# {title}\n\n")
                            f.write(f"URL: {current_url}\n")
                            f.write(
                                f"Extracted: {time.strftime('%Y-%m-%d %H:%M:%S')}\n\n"
                            )
                            f.write("---\n\n")
                            f.write(content)

                        print(f"    ‚úì Saved: {filename}")

                        all_courses_data.append(
                            {
                                "title": title,
                                "url": current_url,
                                "content": content,
                                "screenshot": screenshot_name,
                                "file": filename,
                            }
                        )

                        # Go back to main page
                        await page.goto(SITE_URL)
                        await page.wait_for_timeout(2000)
                        print("    ‚úì Returned to main page")

                    else:
                        print("    ‚ö†Ô∏è  Card not found")

                except Exception as e:
                    print(f"    ‚ùå Error: {e}")
                    continue

            # Create summary
            print("\n[6/6] Creating summary...")
            summary_file = "kenkais_interactive_summary.md"
            with open(summary_file, "w", encoding="utf-8") as f:
                f.write("# Kenkais.com Agency Courses - Interactive Extraction\n\n")
                f.write(f"**Extracted**: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write("**Method**: Interactive Playwright (click on cards)\n")
                f.write(f"**Courses Extracted**: {len(all_courses_data)}\n\n")
                f.write("---\n\n")

                f.write("## Extracted Courses\n\n")
                for idx, course in enumerate(all_courses_data, 1):
                    f.write(f"### {idx}. {course['title']}\n\n")
                    f.write(f"- **URL**: {course['url']}\n")
                    f.write(f"- **Content**: {len(course['content'])} characters\n")
                    f.write(f"- **File**: {course['file']}\n")
                    f.write(f"- **Screenshot**: {course['screenshot']}\n\n")

            print(f"\n‚úÖ Summary saved: {summary_file}")
            print()

            # Final stats
            print("=" * 70)
            print("‚úÖ EXTRACTION COMPLETE!")
            print("=" * 70)
            print()
            print(f"üìä Courses extracted: {len(all_courses_data)}/{len(course_titles)}")
            print()
            print("üìÅ Files created:")
            for course in all_courses_data:
                print(f"   - {course['file']}")
                print(f"   - {course['screenshot']}")
            print()

            return all_courses_data

        except Exception as e:
            print(f"\n‚ùå Error: {e}")
            import traceback

            traceback.print_exc()
            return None

        finally:
            print("\nBrowser will close in 10 seconds...")
            await asyncio.sleep(10)
            await browser.close()


if __name__ == "__main__":
    print()
    result = asyncio.run(scrape_kenkais_interactive())
    print()

    if result and len(result) > 0:
        print("=" * 70)
        print("üéâ SUCCESS!")
        print("=" * 70)
        print()
        print(f"Extracted {len(result)} courses successfully.")
        print("Check the individual course files for full content.")
        print()
    else:
        print("=" * 70)
        print("‚ö†Ô∏è  EXTRACTION INCOMPLETE")
        print("=" * 70)
        print()
