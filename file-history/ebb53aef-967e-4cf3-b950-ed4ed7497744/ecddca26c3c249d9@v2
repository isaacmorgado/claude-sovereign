#!/usr/bin/env python3
"""
Reddit Looksmaxx Research Scraper - COMPREHENSIVE VERSION
100 subreddits covering men AND women
Uses Reddit's public JSON endpoints - no API key required
"""

import requests
import pandas as pd
import time
import json
import re
from collections import Counter
from datetime import datetime
from pathlib import Path

# =============================================================================
# 100 TARGET SUBREDDITS - COMPREHENSIVE MALE & FEMALE COVERAGE
# =============================================================================

SUBREDDITS = [
    # =========================================================================
    # CORE LOOKSMAXXING (10)
    # =========================================================================
    # 'looksmaxxing',         # BANNED - removed
    'orthotropics',           # Mewing, facial development
    'mewing',                 # Tongue posture
    'Splendida',              # Female beauty optimization (private backup)
    'TheGlowUp',              # Glow up transformations
    'uglyduckling',           # Before/after transformations
    'progresspics',           # Weight loss/gain transformations
    'Rateme',                 # Rating requests
    'amiugly',                # Honest appearance feedback
    'truerateme',             # PSL-style ratings

    # =========================================================================
    # FEMALE-SPECIFIC BEAUTY (15)
    # =========================================================================
    'Vindicta',               # Female looksmaxxing (main)
    'VindictaRateCelebs',     # Female beauty analysis
    'beauty',                 # General beauty discussion
    'MakeupAddiction',        # Makeup techniques
    'SkincareAddiction',      # Skincare (heavily female)
    'AsianBeauty',            # K-beauty, J-beauty
    '30PlusSkinCare',         # Anti-aging skincare
    'tretinoin',              # Tretinoin users
    'HaircareScience',        # Hair health
    'femalehairadvice',       # Women's hair
    'FancyFollicles',         # Hair color/styling
    'curlyhair',              # Curly hair care
    'TheGirlSurvivalGuide',   # General female advice
    'XXFitness',              # Female fitness
    'PetiteFashionAdvice',    # Petite women style

    # =========================================================================
    # MALE-SPECIFIC (15)
    # =========================================================================
    'malehairadvice',         # Men's hair
    'malegrooming',           # Men's grooming
    'beards',                 # Beard growth/care
    'Minoxbeards',            # Minoxidil for beards
    'tressless',              # Male hair loss
    'HairTransplants',        # Hair transplant discussion
    'bald',                   # Bald acceptance/style
    'FierceFlow',             # Long hair men
    'malefashionadvice',      # Men's fashion
    'frugalmalefashion',      # Budget men's fashion
    'gainit',                 # Weight gain (skinny guys)
    'BulkOrCut',              # Body composition decisions
    'Brogress',               # Male fitness progress
    'nattyorjuice',           # Natty physique discussion
    'moreplatesmoredates',    # Derek/MPMD community

    # =========================================================================
    # PLASTIC SURGERY & PROCEDURES (20)
    # =========================================================================
    'PlasticSurgery',         # Main plastic surgery sub
    'cosmeticsurgery',        # Cosmetic procedures
    'Rhinoplasty',            # Nose jobs
    'jawsurgery',             # Orthognathic surgery
    'doublejaw',              # Bimax surgery
    'PlasticSurgeryBeforeAfter',  # Results
    'botox',                  # Botox users
    'Fillers',                # Dermal fillers
    'coolsculpting',          # Non-surgical fat removal
    'liposuction',            # Lipo discussion
    'blepharoplasty',         # Eyelid surgery
    'FacialFeminizationSurgery',  # FFS (trans/cis women)
    'Transgender_Surgeries',  # Trans surgery experiences
    'reduction',              # Breast reduction
    'augmentation',           # Breast augmentation
    'brachioplasty',          # Arm lift
    'tummytuck',              # Abdominoplasty
    'BBL',                    # Brazilian butt lift
    'gynecomastia',           # Male breast reduction
    'otoplasty',              # Ear surgery

    # =========================================================================
    # SKINCARE & DERMATOLOGY (12)
    # =========================================================================
    'acne',                   # Acne struggles
    'Accutane',               # Isotretinoin users
    'Rosacea',                # Rosacea management
    'eczema',                 # Eczema/dermatitis
    'Psoriasis',              # Psoriasis
    'popping',                # Skin issues (extractions)
    'Dermatology',            # Skin conditions
    'hyperhidrosis',          # Excessive sweating
    'scars',                  # Scar treatment
    'microneedling',          # Dermarolling
    'chemicalpeels',          # Chemical peels
    'EuroSkincare',           # European skincare

    # =========================================================================
    # DENTAL & ORAL (8)
    # =========================================================================
    'braces',                 # Braces wearers
    'Invisalign',             # Clear aligners
    'orthodontics',           # Orthodontic treatment
    'Dentistry',              # Dental health
    'TeethWhitening',         # Whitening methods
    'jawbone',                # Jaw health
    'TMJ',                    # TMJ disorders
    'Dentistrystudents',      # Dental insights

    # =========================================================================
    # FITNESS & BODY (12)
    # =========================================================================
    'Fitness',                # General fitness
    'bodybuilding',           # Bodybuilding
    'GYM',                    # Gym culture
    'StrongCurves',           # Female glute building
    'flexibility',            # Stretching/mobility
    'Posture',                # Posture correction
    'yoga',                   # Yoga practice
    'loseit',                 # Weight loss
    'CICO',                   # Calorie counting
    'intermittentfasting',    # IF for fat loss
    'leangains',              # Lean muscle building
    'bodyweightfitness',      # Calisthenics

    # =========================================================================
    # FASHION & STYLE (8)
    # =========================================================================
    'femalefashionadvice',    # Women's fashion
    'streetwear',             # Street style
    'sneakers',               # Sneaker culture
    'Watches',                # Watch style
    'ColorAnalysis',          # Personal color analysis
    'Kibbe',                  # Body type styling
    'VindictaFashion',        # Female style optimization
    'DarkAcademia',           # Aesthetic fashion

    # =========================================================================
    # DATING & ATTRACTION (10)
    # =========================================================================
    'dating',                 # Dating general
    'dating_advice',          # Dating help
    'Tinder',                 # Dating apps
    'Bumble',                 # Bumble users
    'hingeapp',               # Hinge users
    'seduction',              # Male dating strategy
    'socialskills',           # Social improvement
    'confidence',             # Building confidence
    'ForeverAlone',           # Struggles with dating
    'IncelExit',              # Leaving incel mindset

    # =========================================================================
    # SELF-IMPROVEMENT GENERAL (10)
    # =========================================================================
    'selfimprovement',        # General self-improvement
    'DecidingToBeBetter',     # Life improvement
    'getdisciplined',         # Discipline/habits
    'Healthygamergg',         # Dr K community
    'BettermentBookClub',     # Self-help books
    'productivity',           # Productivity
    'Meditation',             # Meditation practice
    'nosurf',                 # Digital detox
    'stopdrinking',           # Sobriety (affects appearance)
    'stopsmoking',            # Quit smoking (skin health)
]

# =============================================================================
# COMPREHENSIVE KEYWORD TRACKING
# =============================================================================

PAIN_POINT_KEYWORDS = [
    # Frustration
    'frustrating', 'annoying', 'hate', 'sucks', 'terrible', 'awful',
    'disappointed', 'depressed', 'hopeless', 'desperate', 'insecure',
    'ugly', 'hideous', 'deformed', 'asymmetric', 'ruined',

    # Confusion
    'confused', 'don\'t understand', 'makes no sense', 'contradicting',
    'overwhelmed', 'information overload', 'where do i start',

    # Failed attempts
    'doesn\'t work', 'didn\'t work', 'no results', 'waste of money',
    'waste of time', 'scam', 'snake oil', 'placebo', 'cope',
    'tried everything', 'nothing works', 'given up',

    # Seeking help
    'help me', 'please help', 'desperate', 'what should i do',
    'any advice', 'need advice', 'recommendations', 'suggestions',
    'how do i fix', 'how can i improve', 'is there hope',

    # Comparison/self-doubt
    'compared to', 'worse than', 'not good enough', 'below average',
    'genetic', 'genetics', 'unfair', 'lottery', 'lucky',

    # Money concerns
    'too expensive', 'can\'t afford', 'cost', 'cheap alternative',
    'budget', 'worth it', 'waste of money', 'save money',

    # Time concerns
    'how long', 'takes forever', 'no patience', 'quick fix',
    'instant results', 'when will i see', 'timeline',

    # Side effects/risks
    'side effects', 'complications', 'botched', 'regret',
    'wish i hadn\'t', 'made it worse', 'damaged', 'permanent damage',

    # Age concerns
    'too old', 'too young', 'age limit', 'starting late',
    'missed window', 'too late', 'prime', 'wall',

    # Gender-specific
    'masculine', 'feminine', 'manly', 'womanly', 'androgynous',
    'baby face', 'mature face', 'aging', 'wrinkles', 'sagging',
]

FEATURE_REQUEST_KEYWORDS = [
    # Tools/technology
    'app', 'tool', 'software', 'website', 'calculator', 'analyzer',
    'ai', 'artificial intelligence', 'machine learning', 'algorithm',
    'automatic', 'automated', 'scan', 'detector', 'measure',

    # Analysis
    'ratio', 'ratios', 'proportion', 'proportions', 'measurement',
    'score', 'rating', 'rate me', 'analysis', 'assessment',
    'evaluate', 'objective', 'quantify', 'compare',

    # Features wanted
    'wish there was', 'would be nice', 'someone should make',
    'is there an app', 'does anyone know', 'looking for',
    'recommend', 'suggestion', 'alternative to',

    # Tracking
    'track', 'tracking', 'progress', 'before after', 'timeline',
    'journey', 'log', 'diary', 'journal', 'document',

    # Personalization
    'personalized', 'customized', 'tailored', 'specific to me',
    'my face', 'my features', 'individual', 'unique',

    # Simulation/preview
    'simulate', 'simulation', 'preview', 'visualize', 'morph',
    'photoshop', 'edit', 'what would i look like', 'before after',
]

TREATMENT_KEYWORDS_COMPREHENSIVE = [
    # =========================================================================
    # SURGICAL - FACE
    # =========================================================================
    'rhinoplasty', 'nose job', 'septoplasty', 'alarplasty', 'nostril reduction',
    'tip plasty', 'dorsal hump', 'nose bridge', 'ethnic rhinoplasty',
    'revision rhinoplasty', 'open rhinoplasty', 'closed rhinoplasty',

    'genioplasty', 'chin surgery', 'sliding genioplasty', 'chin implant',
    'chin reduction', 'chin augmentation', 'mentoplasty',

    'jaw surgery', 'orthognathic', 'bimax', 'bimaxillary', 'lefort',
    'bsso', 'mandibular', 'maxillary', 'double jaw', 'jaw implant',
    'jaw reduction', 'jaw shaving', 'v-line', 'square jaw',
    'mandibular angle reduction', 'gonial angle',

    'cheek implant', 'malar implant', 'submalar implant', 'zygomatic',
    'cheekbone', 'midface implant', 'paranasal implant',

    'blepharoplasty', 'eyelid surgery', 'upper bleph', 'lower bleph',
    'asian eyelid', 'double eyelid', 'ptosis correction', 'eye bag removal',
    'canthoplasty', 'canthopexy', 'lateral canthoplasty', 'cat eye surgery',
    'fox eye', 'almond eye',

    'brow lift', 'forehead lift', 'temporal lift', 'endoscopic brow lift',
    'brow bone reduction', 'forehead reduction', 'forehead contouring',

    'facelift', 'mini facelift', 'deep plane facelift', 'smas facelift',
    'neck lift', 'lower facelift', 'jowl lift', 'thread lift',

    'lip lift', 'lip reduction', 'lip augmentation', 'corner lip lift',
    'vermillion advancement', 'philtrum reduction',

    'otoplasty', 'ear pinning', 'ear reduction', 'earlobe repair',

    'buccal fat removal', 'bichectomy', 'cheek hollowing',

    'facial feminization', 'ffs', 'facial masculinization',

    # =========================================================================
    # SURGICAL - BODY
    # =========================================================================
    'liposuction', 'lipo', 'vaser lipo', 'smartlipo', 'tumescent',
    'submental lipo', 'chin lipo', 'neck lipo', 'body contouring',

    'tummy tuck', 'abdominoplasty', 'mini tummy tuck',

    'bbl', 'brazilian butt lift', 'fat transfer', 'butt implant',

    'breast augmentation', 'boob job', 'breast implant', 'breast lift',
    'breast reduction', 'mastopexy', 'gynecomastia surgery',

    'arm lift', 'brachioplasty', 'thigh lift', 'body lift',

    'calf implant', 'pec implant', 'ab etching', 'six pack surgery',

    # =========================================================================
    # SURGICAL - HAIR
    # =========================================================================
    'hair transplant', 'fue', 'fut', 'dhi', 'sapphire fue',
    'hairline lowering', 'forehead reduction', 'scalp advancement',
    'eyebrow transplant', 'beard transplant', 'body hair transplant',

    # =========================================================================
    # INJECTABLES & NON-SURGICAL
    # =========================================================================
    'filler', 'dermal filler', 'hyaluronic acid', 'ha filler',
    'juvederm', 'restylane', 'radiesse', 'sculptra', 'bellafill',
    'chin filler', 'jaw filler', 'cheek filler', 'lip filler',
    'under eye filler', 'tear trough', 'temple filler', 'nose filler',

    'botox', 'botulinum', 'dysport', 'xeomin', 'jeuveau',
    'masseter botox', 'forehead botox', 'crow\'s feet', 'lip flip',
    'brow botox', 'bunny lines', 'gummy smile botox',

    'kybella', 'double chin injection', 'fat dissolving',

    'prp', 'platelet rich plasma', 'vampire facial', 'prp hair',

    'thread lift', 'pdo threads', 'cog threads', 'nose threads',

    # =========================================================================
    # SKIN TREATMENTS
    # =========================================================================
    'laser', 'laser resurfacing', 'co2 laser', 'fraxel', 'ipl',
    'laser hair removal', 'electrolysis',

    'chemical peel', 'tca peel', 'glycolic peel', 'jessner peel',
    'phenol peel', 'vi peel',

    'microneedling', 'dermaroller', 'dermapen', 'rf microneedling',
    'morpheus8', 'scarlet rf',

    'microdermabrasion', 'dermabrasion', 'hydrafacial',

    'photofacial', 'bbl broadband light', 'red light therapy',
    'led therapy', 'blue light',

    'coolsculpting', 'cryolipolysis', 'emsculpt', 'body sculpting',

    # =========================================================================
    # TOPICALS & MEDICATIONS
    # =========================================================================
    'tretinoin', 'retinol', 'retinoid', 'retin-a', 'adapalene', 'differin',
    'tazarotene', 'tazorac', 'azelaic acid', 'bakuchiol',

    'minoxidil', 'rogaine', 'finasteride', 'propecia', 'dutasteride',
    'spironolactone', 'oral minoxidil', 'topical finasteride',
    'ketoconazole', 'nizoral', 'ru58841', 'pyrilutamide',

    'accutane', 'isotretinoin', 'roaccutane',

    'hydroquinone', 'kojic acid', 'tranexamic acid', 'arbutin',
    'niacinamide', 'vitamin c', 'alpha arbutin',

    'sunscreen', 'spf', 'sun protection', 'uva uvb',

    'hyaluronic acid', 'peptides', 'ceramides', 'squalane',

    # =========================================================================
    # NATURAL/LIFESTYLE
    # =========================================================================
    'mewing', 'tongue posture', 'orthotropics', 'mike mew', 'john mew',
    'proper swallowing', 'nasal breathing', 'mouth breathing',

    'chewing', 'falim', 'mastic gum', 'jawzrsize', 'jaw exerciser',
    'hard chewing', 'gum chewing',

    'bone smashing', 'bonesmashing',

    'thumb pulling', 'face pulling', 'palate expansion',

    'posture', 'forward head posture', 'neck posture', 'chin tuck',
    'mckenzie chin tuck', 'anterior pelvic tilt',

    'neck training', 'neck exercises', 'neck curls', 'iron neck',

    'body recomposition', 'body fat', 'lean', 'bulk', 'cut',
    'calorie deficit', 'calorie surplus', 'macros',

    'sleep', 'sleep position', 'mouth taping', 'cpap',

    'collagen', 'collagen supplement', 'bone broth',

    'dermarolling', 'beard roller', 'minox beard',

    # =========================================================================
    # DENTAL/ORAL
    # =========================================================================
    'braces', 'invisalign', 'clear aligners', 'retainer',
    'palate expander', 'mse', 'marpe', 'sarpe', 'ease',
    'mewing appliance', 'myobrace', 'alf appliance',

    'teeth whitening', 'bleaching', 'veneers', 'composite bonding',
    'dental implant', 'crown', 'bridge',

    'jaw alignment', 'bite correction', 'overbite', 'underbite',
    'crossbite', 'open bite', 'class 2', 'class 3',

    # =========================================================================
    # EYES
    # =========================================================================
    'colored contacts', 'color contacts', 'eye color', 'limbal ring',
    'sclera whitening', 'eye drops', 'lumify',
    'lash extensions', 'lash lift', 'lash serum', 'latisse',
    'eyebrow microblading', 'brow lamination', 'brow tinting',

    # =========================================================================
    # SUPPLEMENTS
    # =========================================================================
    'vitamin d', 'vitamin d3', 'vitamin k2', 'magnesium',
    'zinc', 'omega 3', 'fish oil', 'collagen peptides',
    'biotin', 'msm', 'silica', 'hyaluronic acid supplement',
    'ashwagandha', 'tongkat ali', 'fadogia', 'turkesterone',
    'creatine', 'protein', 'bcaa',
    'nmn', 'nad', 'resveratrol', 'quercetin', 'fisetin',
]

METRIC_KEYWORDS_COMPREHENSIVE = [
    # Facial ratios
    'fwhr', 'face width height ratio', 'facial width',
    'ipd', 'interpupillary distance', 'eye spacing',
    'es ratio', 'eye separation',
    'midface ratio', 'midface length', 'long midface', 'short midface',
    'lower third', 'upper third', 'middle third', 'facial thirds',
    'bigonial', 'bizygomatic', 'facial width',
    'mandibular width', 'jaw width',

    # Angles
    'gonial angle', 'jaw angle', 'mandibular angle',
    'canthal tilt', 'positive canthal tilt', 'negative canthal tilt', 'pct', 'nct',
    'nasofrontal angle', 'nasolabial angle', 'nasal tip',
    'facial convexity', 'profile angle',
    'chin projection', 'chin position',

    # Eye measurements
    'pfl', 'palpebral fissure', 'eye width', 'eye length',
    'scleral show', 'upper eyelid exposure', 'hooded eyes',
    'eye area', 'orbital', 'infraorbital',
    'brow position', 'brow bone', 'supraorbital',

    # Nose measurements
    'nose width', 'nasal width', 'alar width',
    'nose length', 'nasal length', 'nose height',
    'nasal projection', 'nasal tip projection',
    'dorsum', 'nasal bridge', 'nose bridge',
    'columella', 'nostril', 'alar',

    # Lip/mouth
    'philtrum', 'philtrum length', 'long philtrum', 'short philtrum',
    'lip ratio', 'vermillion', 'cupid\'s bow',
    'mouth width', 'lip width',

    # Jaw/chin
    'chin height', 'chin length', 'chin width',
    'ramus height', 'ramus length',
    'jaw definition', 'jawline',
    'masseter', 'masseter size',

    # Symmetry
    'symmetry', 'asymmetry', 'facial asymmetry',
    'crooked', 'uneven', 'lopsided',

    # Overall scores
    'psl', 'psl rating', 'lookism scale',
    'rating', 'rate', 'score', 'out of 10',
    'harmony', 'facial harmony', 'balance',
    'golden ratio', 'phi', 'divine proportion',

    # Aesthetic concepts
    'masculine', 'feminine', 'dimorphism', 'sexual dimorphism',
    'hunter eyes', 'prey eyes', 'almond eyes',
    'forward growth', 'recessed', 'protruding',
    'compact midface', 'ogee curve',
    'hollow cheeks', 'buccal fat', 'face fat',
    'skull', 'bone structure', 'skeletal',
    'soft tissue', 'skin quality', 'collagen',

    # Body
    'shoulder width', 'bideltoid', 'clavicle length',
    'waist', 'hip ratio', 'v taper',
    'body fat percentage', 'bf%', 'lean mass',
    'frame', 'bone frame', 'wrist size',
    'height', 'heightmaxx', 'leg lengthening',
]

# Gender-specific concerns
FEMALE_SPECIFIC = [
    'feminine', 'softer features', 'delicate', 'petite',
    'v-line jaw', 'small face', 'aegyo sal',
    'glass skin', 'dewy skin', 'gradient lip',
    'lash extensions', 'microblading', 'lip blush',
    'breast', 'hips', 'waist', 'hourglass', 'bbl',
    'cellulite', 'stretch marks',
    'pregnancy', 'postpartum', 'mommy makeover',
    'hormonal acne', 'pcos', 'hirsutism',
    'aging', 'wrinkles', 'sagging', 'jowls', 'turkey neck',
]

MALE_SPECIFIC = [
    'masculine', 'rugged', 'chiseled', 'angular',
    'square jaw', 'strong jaw', 'chad jaw',
    'beard', 'facial hair', 'stubble', 'minox beard',
    'receding hairline', 'balding', 'norwood', 'diffuse thinning',
    'gyno', 'gynecomastia', 'puffy nipples',
    'shoulder width', 'v taper', 'lats', 'traps',
    'neck thickness', 'thick neck', 'pencil neck',
    'hunter eyes', 'hooded eyes', 'brow ridge',
    'height', 'manlet', 'heightcel', 'leg lengthening',
]


class RedditScraper:
    """Scrapes Reddit using public JSON endpoints"""

    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        })
        self.data_dir = Path(__file__).parent / 'data'
        self.data_dir.mkdir(exist_ok=True)
        self.failed_subs = []

    def fetch_posts(self, subreddit: str, sort: str = 'top', time_filter: str = 'year', limit: int = 100) -> list:
        """Fetch posts from a subreddit using public JSON endpoint"""
        posts = []
        after = None
        retries = 0
        max_retries = 3

        while len(posts) < limit and retries < max_retries:
            url = f"https://www.reddit.com/r/{subreddit}/{sort}.json"
            params = {
                't': time_filter,
                'limit': min(100, limit - len(posts)),
                'raw_json': 1,
            }
            if after:
                params['after'] = after

            try:
                response = self.session.get(url, params=params, timeout=30)

                if response.status_code == 403:
                    print(f"    r/{subreddit}: Private/quarantined - skipping")
                    self.failed_subs.append((subreddit, 'private'))
                    return posts
                elif response.status_code == 404:
                    print(f"    r/{subreddit}: Not found - skipping")
                    self.failed_subs.append((subreddit, 'not_found'))
                    return posts
                elif response.status_code == 429:
                    print(f"    Rate limited, waiting 60s...")
                    time.sleep(60)
                    retries += 1
                    continue

                response.raise_for_status()
                data = response.json()

                children = data.get('data', {}).get('children', [])
                if not children:
                    break

                for child in children:
                    post_data = child.get('data', {})
                    posts.append({
                        'id': post_data.get('id'),
                        'title': post_data.get('title', ''),
                        'selftext': post_data.get('selftext', ''),
                        'score': post_data.get('score', 0),
                        'num_comments': post_data.get('num_comments', 0),
                        'created_utc': post_data.get('created_utc', 0),
                        'subreddit': subreddit,
                        'url': f"https://reddit.com{post_data.get('permalink', '')}",
                        'flair': post_data.get('link_flair_text', ''),
                        'author': post_data.get('author', '[deleted]'),
                        'upvote_ratio': post_data.get('upvote_ratio', 0),
                    })

                after = data.get('data', {}).get('after')
                if not after:
                    break

                # Rate limiting
                time.sleep(1.5)

            except requests.exceptions.RequestException as e:
                print(f"    Error r/{subreddit}: {e}")
                retries += 1
                time.sleep(5)

        return posts

    def scrape_all_subreddits(self, posts_per_sub: int = 100) -> pd.DataFrame:
        """Scrape all target subreddits"""
        all_posts = []

        print("\n" + "=" * 60)
        print("COMPREHENSIVE REDDIT SCRAPER - 100 SUBREDDITS")
        print("=" * 60)
        print(f"Target: {len(SUBREDDITS)} subreddits, {posts_per_sub} posts each")
        print("=" * 60 + "\n")

        for i, sub in enumerate(SUBREDDITS, 1):
            print(f"[{i}/{len(SUBREDDITS)}] Scraping r/{sub}...")

            # Get top posts from past year
            top_posts = self.fetch_posts(sub, sort='top', time_filter='year', limit=posts_per_sub)
            all_posts.extend(top_posts)
            print(f"    Got {len(top_posts)} top posts")

            # Also get controversial posts (often contain pain points)
            if len(top_posts) > 0:
                controversial = self.fetch_posts(sub, sort='controversial', time_filter='year', limit=30)
                all_posts.extend(controversial)
                print(f"    Got {len(controversial)} controversial posts")

            time.sleep(2)  # Rate limiting between subreddits

            # Save progress every 10 subreddits
            if i % 10 == 0:
                temp_df = pd.DataFrame(all_posts)
                temp_df.to_csv(self.data_dir / 'raw_posts_progress.csv', index=False)
                print(f"\n    [Progress saved: {len(all_posts)} posts]\n")

        # Deduplicate by ID
        seen_ids = set()
        unique_posts = []
        for post in all_posts:
            if post['id'] not in seen_ids:
                seen_ids.add(post['id'])
                unique_posts.append(post)

        df = pd.DataFrame(unique_posts)

        # Save raw data
        df.to_csv(self.data_dir / 'raw_posts.csv', index=False)
        print(f"\n{'=' * 60}")
        print(f"SCRAPING COMPLETE")
        print(f"{'=' * 60}")
        print(f"Total unique posts: {len(df)}")
        print(f"Failed subreddits: {len(self.failed_subs)}")
        if self.failed_subs:
            for sub, reason in self.failed_subs:
                print(f"  - r/{sub}: {reason}")

        return df


class FeatureGapAnalyzer:
    """Deep analysis of scraped data to identify feature gaps"""

    def __init__(self, df: pd.DataFrame):
        self.df = df
        self.results = {
            'pain_points': Counter(),
            'feature_requests': Counter(),
            'treatments_mentioned': Counter(),
            'metrics_mentioned': Counter(),
            'female_concerns': Counter(),
            'male_concerns': Counter(),
            'top_questions': [],
            'top_complaints': [],
            'emerging_trends': [],
            'high_engagement_topics': [],
            'subreddit_themes': {},
        }

    def analyze_text(self, text: str) -> dict:
        """Analyze a single piece of text for keywords"""
        text_lower = text.lower()

        return {
            'pain_points': [kw for kw in PAIN_POINT_KEYWORDS if kw in text_lower],
            'feature_requests': [kw for kw in FEATURE_REQUEST_KEYWORDS if kw in text_lower],
            'treatments': [kw for kw in TREATMENT_KEYWORDS_COMPREHENSIVE if kw in text_lower],
            'metrics': [kw for kw in METRIC_KEYWORDS_COMPREHENSIVE if kw in text_lower],
            'female': [kw for kw in FEMALE_SPECIFIC if kw in text_lower],
            'male': [kw for kw in MALE_SPECIFIC if kw in text_lower],
        }

    def extract_questions(self, df: pd.DataFrame) -> list:
        """Extract question posts (high engagement)"""
        questions = []
        question_indicators = ['?', 'how do', 'how can', 'what', 'why', 'should i',
                               'is it', 'can i', 'help', 'advice', 'recommend', 'suggest']

        for _, row in df.iterrows():
            title = row.get('title', '')
            if any(q in title.lower() for q in question_indicators):
                questions.append({
                    'title': title,
                    'score': row.get('score', 0),
                    'comments': row.get('num_comments', 0),
                    'subreddit': row.get('subreddit', ''),
                    'url': row.get('url', ''),
                    'engagement': row.get('score', 0) + row.get('num_comments', 0) * 3,
                })

        questions.sort(key=lambda x: x['engagement'], reverse=True)
        return questions[:100]

    def extract_complaints(self, df: pd.DataFrame) -> list:
        """Extract complaint/frustration posts"""
        complaints = []
        complaint_indicators = [
            'rant', 'frustrated', 'disappointed', 'waste', 'scam', 'doesn\'t work',
            'not working', 'failed', 'regret', 'botched', 'ruined', 'hate',
            'depressed', 'hopeless', 'given up', 'nothing works', 'tried everything'
        ]

        for _, row in df.iterrows():
            title = row.get('title', '').lower()
            text = row.get('selftext', '').lower()
            combined = title + ' ' + text

            matches = [ind for ind in complaint_indicators if ind in combined]
            if matches:
                complaints.append({
                    'title': row.get('title', ''),
                    'score': row.get('score', 0),
                    'comments': row.get('num_comments', 0),
                    'subreddit': row.get('subreddit', ''),
                    'url': row.get('url', ''),
                    'indicators': matches,
                    'snippet': text[:300] if text else '',
                })

        complaints.sort(key=lambda x: len(x['indicators']) * 10 + x['score'], reverse=True)
        return complaints[:75]

    def analyze_by_subreddit(self, df: pd.DataFrame) -> dict:
        """Analyze themes by subreddit"""
        themes = {}

        for sub in df['subreddit'].unique():
            sub_df = df[df['subreddit'] == sub]
            sub_treatments = Counter()
            sub_metrics = Counter()

            for _, row in sub_df.iterrows():
                combined = f"{row.get('title', '')} {row.get('selftext', '')}"
                analysis = self.analyze_text(combined)

                for t in analysis['treatments']:
                    sub_treatments[t] += 1
                for m in analysis['metrics']:
                    sub_metrics[m] += 1

            themes[sub] = {
                'post_count': len(sub_df),
                'avg_score': sub_df['score'].mean(),
                'top_treatments': sub_treatments.most_common(10),
                'top_metrics': sub_metrics.most_common(10),
            }

        return themes

    def find_high_engagement_topics(self, df: pd.DataFrame) -> list:
        """Find topics with unusually high engagement"""
        topics = []

        # Calculate engagement score
        df_copy = df.copy()
        df_copy['engagement'] = df_copy['score'] + df_copy['num_comments'] * 3

        # Top 1% by engagement
        threshold = df_copy['engagement'].quantile(0.99)
        high_engagement = df_copy[df_copy['engagement'] >= threshold]

        for _, row in high_engagement.iterrows():
            combined = f"{row.get('title', '')} {row.get('selftext', '')}"
            analysis = self.analyze_text(combined)

            topics.append({
                'title': row.get('title', ''),
                'score': row.get('score', 0),
                'comments': row.get('num_comments', 0),
                'subreddit': row.get('subreddit', ''),
                'url': row.get('url', ''),
                'treatments': analysis['treatments'][:5],
                'metrics': analysis['metrics'][:5],
            })

        return topics

    def run_analysis(self) -> dict:
        """Run comprehensive analysis on scraped data"""
        print("\n" + "=" * 60)
        print("ANALYZING DATA")
        print("=" * 60 + "\n")

        # Analyze all posts
        print("Processing posts...")
        for idx, row in self.df.iterrows():
            if idx % 1000 == 0:
                print(f"  Processed {idx}/{len(self.df)} posts...")

            combined_text = f"{row.get('title', '')} {row.get('selftext', '')}"
            analysis = self.analyze_text(combined_text)

            # Weight by engagement
            weight = 1 + (row.get('score', 0) / 50) + (row.get('num_comments', 0) / 25)

            for kw in analysis['pain_points']:
                self.results['pain_points'][kw] += weight
            for kw in analysis['feature_requests']:
                self.results['feature_requests'][kw] += weight
            for kw in analysis['treatments']:
                self.results['treatments_mentioned'][kw] += weight
            for kw in analysis['metrics']:
                self.results['metrics_mentioned'][kw] += weight
            for kw in analysis['female']:
                self.results['female_concerns'][kw] += weight
            for kw in analysis['male']:
                self.results['male_concerns'][kw] += weight

        # Extract specific content
        print("Extracting questions...")
        self.results['top_questions'] = self.extract_questions(self.df)

        print("Extracting complaints...")
        self.results['top_complaints'] = self.extract_complaints(self.df)

        print("Analyzing by subreddit...")
        self.results['subreddit_themes'] = self.analyze_by_subreddit(self.df)

        print("Finding high-engagement topics...")
        self.results['high_engagement_topics'] = self.find_high_engagement_topics(self.df)

        # Find emerging trends (recent posts)
        print("Identifying trends...")
        recent = self.df[self.df['created_utc'] > (time.time() - 30*24*60*60)]
        if len(recent) > 0:
            recent_sorted = recent.sort_values('score', ascending=False)
            self.results['emerging_trends'] = recent_sorted.head(30)[
                ['title', 'score', 'num_comments', 'subreddit', 'url']
            ].to_dict('records')

        print("\nAnalysis complete!")
        return self.results


def generate_feature_gaps_report(results: dict, df: pd.DataFrame, output_path: Path):
    """Generate comprehensive feature-gaps.md report"""

    report = f"""# Looksmaxx Feature Gap Analysis - COMPREHENSIVE REPORT
Generated: {datetime.now().strftime('%Y-%m-%d %H:%M')}

## Executive Summary

**Scope**: Analyzed {len(df)} posts from {df['subreddit'].nunique()} subreddits
**Period**: Top posts from past year + recent hot/controversial posts
**Coverage**: Male AND female communities across looksmaxxing, plastic surgery, skincare, fitness, dating

---

## TABLE OF CONTENTS

1. [Pain Points & Frustrations](#1-pain-points--frustrations)
2. [Feature Requests](#2-feature-requests-what-users-want)
3. [Treatment Analysis](#3-treatment-analysis)
4. [Metrics Users Care About](#4-metrics-users-care-about)
5. [Gender-Specific Concerns](#5-gender-specific-concerns)
6. [Top Questions (Unmet Needs)](#6-top-questions-unmet-needs)
7. [Common Complaints](#7-common-complaints)
8. [High-Engagement Topics](#8-high-engagement-topics)
9. [Subreddit Themes](#9-subreddit-themes)
10. [Emerging Trends](#10-emerging-trends)
11. [Prioritized Recommendations](#11-prioritized-recommendations)
12. [Gaps vs Our Current Features](#12-gaps-vs-our-current-features)

---

## 1. Pain Points & Frustrations

These keywords appeared most frequently in high-engagement posts, weighted by upvotes and comments:

### Top 30 Pain Points

| Rank | Pain Point | Weighted Score |
|------|------------|----------------|
"""

    for i, (kw, score) in enumerate(results['pain_points'].most_common(30), 1):
        report += f"| {i} | {kw} | {score:.1f} |\n"

    report += """

### Key Insights from Pain Points:

**Confusion & Information Overload**
- Users are overwhelmed by contradicting information
- "Where do I start?" is a constant theme
- Need for clear, personalized roadmaps

**Failed Attempts & Wasted Money**
- Many have tried multiple treatments with no results
- Frustration with "scam" products and services
- Want objective validation before spending money

**Self-Image Issues**
- Deep insecurity about specific features
- Comparison with others causing distress
- Need for objective assessment, not just opinions

**Time & Age Concerns**
- "Am I too old/young for this?"
- Impatience for results
- Fear of "missing the window"

---

## 2. Feature Requests (What Users Want)

| Rank | Feature Type | Weighted Score |
|------|--------------|----------------|
"""

    for i, (kw, score) in enumerate(results['feature_requests'].most_common(25), 1):
        report += f"| {i} | {kw} | {score:.1f} |\n"

    report += """

### High-Priority Feature Gaps Identified:

1. **AI-Powered Analysis**
   - Automated facial ratio measurement
   - Objective scoring without human bias
   - Instant feedback vs waiting for "rate me" responses

2. **Progress Tracking**
   - Before/after comparison tools
   - Timeline visualization
   - Measurement logging over time

3. **Personalized Recommendations**
   - "What should I specifically do for MY face?"
   - Treatment prioritization based on individual features
   - Budget-aware suggestions

4. **Simulation/Morphing**
   - "What would I look like after X procedure?"
   - Virtual try-on for procedures
   - Setting realistic expectations

5. **Treatment Research Tools**
   - Surgeon/provider database with reviews
   - Cost comparison by location
   - Risk/benefit calculators

---

## 3. Treatment Analysis

### Most Discussed Treatments (Top 50)

| Rank | Treatment | Weighted Score | Category |
|------|-----------|----------------|----------|
"""

    # Categorize treatments
    surgical = ['rhinoplasty', 'genioplasty', 'jaw surgery', 'bimax', 'implant', 'blepharoplasty',
                'facelift', 'liposuction', 'bbl', 'breast', 'otoplasty', 'canthoplasty']
    injectable = ['filler', 'botox', 'kybella', 'prp', 'thread']
    topical = ['tretinoin', 'minoxidil', 'retinol', 'accutane', 'sunscreen', 'vitamin']
    natural = ['mewing', 'chewing', 'posture', 'neck training', 'body fat', 'sleep']

    for i, (treatment, score) in enumerate(results['treatments_mentioned'].most_common(50), 1):
        t_lower = treatment.lower()
        if any(s in t_lower for s in surgical):
            cat = "Surgical"
        elif any(s in t_lower for s in injectable):
            cat = "Injectable"
        elif any(s in t_lower for s in topical):
            cat = "Topical/Rx"
        elif any(s in t_lower for s in natural):
            cat = "Natural/Lifestyle"
        else:
            cat = "Other"
        report += f"| {i} | {treatment} | {score:.1f} | {cat} |\n"

    report += """

### Treatment Categories by Volume

"""

    # Calculate category totals
    categories = {
        'Surgical': 0, 'Injectable': 0, 'Topical/Rx': 0,
        'Natural/Lifestyle': 0, 'Dental': 0, 'Hair': 0
    }

    for treatment, score in results['treatments_mentioned'].items():
        t_lower = treatment.lower()
        if any(x in t_lower for x in ['surgery', 'plasty', 'implant', 'lift', 'reduction', 'lipo']):
            categories['Surgical'] += score
        elif any(x in t_lower for x in ['filler', 'botox', 'injection', 'kybella']):
            categories['Injectable'] += score
        elif any(x in t_lower for x in ['tretinoin', 'minoxidil', 'retinol', 'accutane', 'topical']):
            categories['Topical/Rx'] += score
        elif any(x in t_lower for x in ['mewing', 'chewing', 'posture', 'exercise', 'diet']):
            categories['Natural/Lifestyle'] += score
        elif any(x in t_lower for x in ['braces', 'invisalign', 'teeth', 'dental', 'palate']):
            categories['Dental'] += score
        elif any(x in t_lower for x in ['hair', 'minox', 'transplant', 'finasteride', 'bald']):
            categories['Hair'] += score

    report += "| Category | Total Score |\n|----------|-------------|\n"
    for cat, score in sorted(categories.items(), key=lambda x: x[1], reverse=True):
        report += f"| {cat} | {score:.0f} |\n"

    report += """

---

## 4. Metrics Users Care About

| Rank | Metric/Concept | Weighted Score |
|------|----------------|----------------|
"""

    for i, (metric, score) in enumerate(results['metrics_mentioned'].most_common(40), 1):
        report += f"| {i} | {metric} | {score:.1f} |\n"

    report += """

### Key Metric Categories:

**Most Discussed Facial Ratios:**
- FWHR (Face Width to Height Ratio)
- Midface ratio
- Facial thirds proportions
- Bigonial/bizygomatic width

**Most Discussed Angles:**
- Gonial angle (jaw angle)
- Canthal tilt (eye angle)
- Nasolabial angle
- Profile/facial convexity

**Aesthetic Concepts:**
- Facial harmony
- Sexual dimorphism
- Forward growth vs recession
- Hunter eyes vs prey eyes

---

## 5. Gender-Specific Concerns

### Female-Specific (Top 25)

| Rank | Concern | Weighted Score |
|------|---------|----------------|
"""

    for i, (concern, score) in enumerate(results['female_concerns'].most_common(25), 1):
        report += f"| {i} | {concern} | {score:.1f} |\n"

    report += """

### Male-Specific (Top 25)

| Rank | Concern | Weighted Score |
|------|---------|----------------|
"""

    for i, (concern, score) in enumerate(results['male_concerns'].most_common(25), 1):
        report += f"| {i} | {concern} | {score:.1f} |\n"

    report += """

### Gender Gap Analysis:

**Unique Female Concerns:**
- V-line jaw (smaller jaw desired vs males wanting larger)
- Glass/dewy skin aesthetic
- Body contouring (BBL, waist)
- Anti-aging focus (earlier than males)
- Hormonal skin issues (PCOS, cycle-related)

**Unique Male Concerns:**
- Hair loss (overwhelming #1 male concern)
- Jaw/chin prominence (want MORE, not less)
- Height/frame concerns
- Neck thickness
- Beard growth ability

**Overlapping Concerns (Both Genders):**
- Nose shape
- Eye area
- Skin quality
- Body fat distribution
- Facial symmetry

---

## 6. Top Questions (Unmet Needs)

These high-engagement questions reveal what users can't find answers to:

"""

    for i, q in enumerate(results['top_questions'][:40], 1):
        report += f"### {i}. {q['title']}\n"
        report += f"- **Subreddit**: r/{q['subreddit']}\n"
        report += f"- **Engagement**: {q['score']} upvotes, {q['comments']} comments\n"
        report += f"- **URL**: {q['url']}\n\n"

    report += """

---

## 7. Common Complaints

Direct user complaints revealing pain points:

"""

    for i, c in enumerate(results['top_complaints'][:40], 1):
        report += f"### {i}. {c['title']}\n"
        report += f"- **Subreddit**: r/{c['subreddit']}\n"
        report += f"- **Score**: {c['score']} upvotes\n"
        report += f"- **Frustration Indicators**: {', '.join(c['indicators'])}\n"
        if c['snippet']:
            report += f"- **Snippet**: _{c['snippet'][:200]}..._\n"
        report += f"- **URL**: {c['url']}\n\n"

    report += """

---

## 8. High-Engagement Topics

Posts in the top 1% of engagement - these topics resonate most:

"""

    for i, topic in enumerate(results['high_engagement_topics'][:30], 1):
        report += f"### {i}. {topic['title']}\n"
        report += f"- **Subreddit**: r/{topic['subreddit']}\n"
        report += f"- **Score**: {topic['score']} upvotes, {topic['comments']} comments\n"
        if topic['treatments']:
            report += f"- **Treatments mentioned**: {', '.join(topic['treatments'])}\n"
        if topic['metrics']:
            report += f"- **Metrics mentioned**: {', '.join(topic['metrics'])}\n"
        report += f"- **URL**: {topic['url']}\n\n"

    report += """

---

## 9. Subreddit Themes

Analysis of what each community focuses on:

"""

    # Sort by post count
    sorted_themes = sorted(
        results['subreddit_themes'].items(),
        key=lambda x: x[1]['post_count'],
        reverse=True
    )

    for sub, data in sorted_themes[:30]:
        report += f"### r/{sub}\n"
        report += f"- **Posts analyzed**: {data['post_count']}\n"
        report += f"- **Avg score**: {data['avg_score']:.1f}\n"
        if data['top_treatments']:
            treatments = ', '.join([f"{t[0]} ({t[1]})" for t in data['top_treatments'][:5]])
            report += f"- **Top treatments**: {treatments}\n"
        if data['top_metrics']:
            metrics = ', '.join([f"{m[0]} ({m[1]})" for m in data['top_metrics'][:5]])
            report += f"- **Top metrics**: {metrics}\n"
        report += "\n"

    report += """

---

## 10. Emerging Trends (Last 30 Days)

Recent hot topics that may indicate new trends:

"""

    for i, t in enumerate(results.get('emerging_trends', [])[:25], 1):
        report += f"{i}. **{t['title']}**\n"
        report += f"   - r/{t['subreddit']} | {t['score']} upvotes | {t['num_comments']} comments\n\n"

    report += """

---

## 11. Prioritized Recommendations

Based on comprehensive analysis across 100 subreddits:

### P0 - CRITICAL (Implement Immediately)

These features have massive demand and are clear gaps:

| Feature | Evidence | Estimated Impact |
|---------|----------|------------------|
| **Hair Loss Module** | #1 male concern, 10+ dedicated subs | High - captures huge male audience |
| **Teeth/Smile Analysis** | Braces/Invisalign constantly discussed | High - affects both genders |
| **Budget Tier System** | "Cost" and "afford" are top pain points | High - makes app accessible |
| **Before/After Timeline** | "Progress" in top 10 feature requests | High - increases retention |

### P1 - HIGH PRIORITY (Next Sprint)

| Feature | Evidence | Estimated Impact |
|---------|----------|------------------|
| **Female-Specific Mode** | V-line, glass skin, different ideals | High - doubles addressable market |
| **Palate/Bite Analysis** | MSE, MARPE, palate expander discussions | Medium-High - orthotropics crowd |
| **Body Fat Calculator** | Top 5 in both male/female concerns | Medium - complements face analysis |
| **Surgeon Database** | "Where to go" is constant question | Medium-High - monetization opportunity |

### P2 - MEDIUM PRIORITY (This Quarter)

| Feature | Evidence | Estimated Impact |
|---------|----------|------------------|
| **Eye Color Simulation** | Colored contacts popular topic | Medium - fun feature, engagement |
| **Beard Potential Predictor** | Minoxbeards has 100k+ users | Medium - male-specific value |
| **Aging Simulation** | Anti-aging huge for females | Medium - premium feature |
| **Treatment Risk Calculator** | "Botched" fear is real | Medium - builds trust |

### P3 - LOWER PRIORITY (Future)

| Feature | Evidence | Estimated Impact |
|---------|----------|------------------|
| **Height Analysis** | Discussed but controversial | Low - outside facial focus |
| **Voice Analysis** | Occasionally mentioned | Low - different product |
| **Style Recommendations** | Fashion subs discuss | Low - many competitors |

---

## 12. Gaps vs Our Current Features

### What We Have vs What They Want

| User Need | Our Current Feature | Gap |
|-----------|--------------------|----|
| Facial ratio analysis | ✅ 70+ metrics | None |
| PSL rating | ✅ 10-tier system | None |
| Treatment recommendations | ✅ 118 treatments | None |
| Before/after visualization | ✅ Face morphing | None |
| **Hair loss analysis** | ❌ Not covered | **CRITICAL GAP** |
| **Teeth/smile metrics** | ❌ Not covered | **CRITICAL GAP** |
| **Female-specific ideals** | ⚠️ Basic only | **NEEDS EXPANSION** |
| **Budget-based recommendations** | ⚠️ Has costs, not tiers | Minor gap |
| **Surgeon database** | ❌ Not covered | Future opportunity |
| Progress tracking | ✅ Analysis history | None |
| Cost estimates | ✅ 9 regions | None |

### Missing Treatments Identified

These treatments are highly discussed but not in our system:

1. **Hair Treatments**: FUE, FUT, DHI, scalp micropigmentation, hair systems
2. **Dental**: MSE, MARPE, palate expanders, veneers, composite bonding
3. **Body**: BBL, arm lift, thigh lift, ab etching
4. **Skin**: Morpheus8, Scarlet RF, specific laser types
5. **Eyes**: Limbal ring enhancement, scleral lens options

### Missing Metrics Identified

1. **Hair**: Norwood scale, density mapping, hairline shape
2. **Teeth**: Smile line, tooth show, gum show, bite classification
3. **Body**: Shoulder-to-waist ratio, body fat distribution
4. **Hands**: Not currently tracked, occasionally discussed

---

## Appendix: Raw Data Files

- `data/raw_posts.csv` - All scraped posts
- `data/analysis_results.json` - Structured analysis data

---

## Next Steps

1. **Review P0 items** with product team
2. **Validate with user interviews** - Are these gaps real?
3. **Competitive analysis** - Do competitors have these features?
4. **Technical feasibility** - Can we detect hair/teeth with MediaPipe?
5. **Prioritization meeting** - Finalize roadmap

"""

    output_path.write_text(report)
    print(f"\nReport saved to: {output_path}")


def main():
    """Main entry point"""
    print("=" * 60)
    print("LOOKSMAXX REDDIT RESEARCH - COMPREHENSIVE SCRAPER")
    print("100 Subreddits | Male + Female | Deep Pain Point Analysis")
    print("=" * 60)

    scraper = RedditScraper()

    # Scrape all subreddits
    df = scraper.scrape_all_subreddits(posts_per_sub=100)

    if len(df) == 0:
        print("No posts scraped. Check your internet connection.")
        return

    # Deep analysis
    analyzer = FeatureGapAnalyzer(df)
    results = analyzer.run_analysis()

    # Save analysis results
    data_dir = Path(__file__).parent / 'data'
    with open(data_dir / 'analysis_results.json', 'w') as f:
        json_results = {
            'pain_points': dict(results['pain_points'].most_common(100)),
            'feature_requests': dict(results['feature_requests'].most_common(100)),
            'treatments_mentioned': dict(results['treatments_mentioned'].most_common(200)),
            'metrics_mentioned': dict(results['metrics_mentioned'].most_common(100)),
            'female_concerns': dict(results['female_concerns'].most_common(50)),
            'male_concerns': dict(results['male_concerns'].most_common(50)),
            'top_questions': results['top_questions'],
            'top_complaints': results['top_complaints'],
            'emerging_trends': results['emerging_trends'],
            'high_engagement_topics': results['high_engagement_topics'],
        }
        json.dump(json_results, f, indent=2)
    print(f"Analysis saved to data/analysis_results.json")

    # Generate the comprehensive report
    output_path = Path(__file__).parent / 'feature-gaps.md'
    generate_feature_gaps_report(results, df, output_path)

    # Print summary
    print("\n" + "=" * 60)
    print("FINAL SUMMARY")
    print("=" * 60)
    print(f"Posts analyzed: {len(df)}")
    print(f"Subreddits covered: {df['subreddit'].nunique()}")
    print(f"\nTop 10 treatments:")
    for t, s in results['treatments_mentioned'].most_common(10):
        print(f"  - {t}: {s:.0f}")
    print(f"\nTop 10 pain points:")
    for p, s in results['pain_points'].most_common(10):
        print(f"  - {p}: {s:.0f}")
    print(f"\nQuestions found: {len(results['top_questions'])}")
    print(f"Complaints found: {len(results['top_complaints'])}")
    print(f"\nReport: {output_path}")


if __name__ == '__main__':
    main()
