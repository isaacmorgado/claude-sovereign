#!/bin/bash

# MediaVault v2 - Smart Download Script
# Category + Date Hybrid Organization

VAULT_DIR="$HOME/Desktop/MediaVault_v2"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    echo "üé¨ MediaVault v2 - Smart Downloader"
    echo ""
    echo "Usage: ./download.sh [URL] [category] [type]"
    echo ""
    echo "Categories:"
    echo "  music        - Music videos, albums, songs"
    echo "  podcast      - Podcast episodes"
    echo "  tutorial     - How-to videos, courses"
    echo "  entertainment - Movies, TV, comedy"
    echo "  educational  - Lectures, documentaries"
    echo "  documentary  - Documentary films"
    echo "  interview    - Interviews, talks"
    echo "  other        - Everything else"
    echo ""
    echo "Types:"
    echo "  mp3          - Audio only (default)"
    echo "  mp4          - Video only"
    echo "  both         - Both audio and video"
    echo ""
    echo "Examples:"
    echo "  ./download.sh 'https://youtube.com/watch?v=...' music mp3"
    echo "  ./download.sh 'https://youtube.com/watch?v=...' podcast"
    echo "  ./download.sh 'https://youtube.com/watch?v=...' tutorial both"
    exit 0
}

# Check for help flag
if [ "$1" == "-h" ] || [ "$1" == "--help" ] || [ -z "$1" ]; then
    show_help
fi

URL=$1
CATEGORY=${2:-other}
TYPE=${3:-mp3}
DATE=$(date +%Y-%m-%d)

# Normalize category name
case $CATEGORY in
    music|Music|MUSIC)
        CATEGORY_DIR="Music"
        ;;
    podcast|Podcast|PODCAST|podcasts)
        CATEGORY_DIR="Podcasts"
        ;;
    tutorial|Tutorial|TUTORIAL|tutorials)
        CATEGORY_DIR="Tutorials"
        ;;
    entertainment|Entertainment|ENTERTAINMENT)
        CATEGORY_DIR="Entertainment"
        ;;
    educational|Educational|EDUCATIONAL|education)
        CATEGORY_DIR="Educational"
        ;;
    documentary|Documentary|DOCUMENTARY|documentaries)
        CATEGORY_DIR="Documentaries"
        ;;
    interview|Interview|INTERVIEW|interviews)
        CATEGORY_DIR="Interviews"
        ;;
    *)
        CATEGORY_DIR="Other"
        ;;
esac

echo -e "${BLUE}üé¨ MediaVault v2 Downloader${NC}"
echo "=========================="
echo -e "${YELLOW}URL:${NC} $URL"
echo -e "${YELLOW}Category:${NC} $CATEGORY_DIR"
echo -e "${YELLOW}Type:${NC} $TYPE"
echo -e "${YELLOW}Date:${NC} $DATE"
echo ""

# First, get video info to create proper folder name
echo -e "${BLUE}üì° Fetching video info...${NC}"
VIDEO_TITLE=$(yt-dlp --get-title "$URL" 2>/dev/null | head -n 1)

if [ -z "$VIDEO_TITLE" ]; then
    echo -e "${RED}‚ùå Error: Could not fetch video information${NC}"
    exit 1
fi

# Clean title for folder name (remove special chars)
CLEAN_TITLE=$(echo "$VIDEO_TITLE" | sed 's/[^a-zA-Z0-9 &-]//g' | sed 's/  */ /g')
FOLDER_NAME="$DATE - $CLEAN_TITLE"
OUTPUT_DIR="$VAULT_DIR/$CATEGORY_DIR/$FOLDER_NAME"

echo -e "${GREEN}‚úì Video:${NC} $VIDEO_TITLE"
echo -e "${GREEN}‚úì Folder:${NC} $FOLDER_NAME"
echo ""

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Download based on type
if [ "$TYPE" == "mp3" ] || [ "$TYPE" == "both" ]; then
    echo -e "${BLUE}üéµ Downloading MP3...${NC}"
    yt-dlp -x --audio-format mp3 \
        -o "$OUTPUT_DIR/%(title)s.%(ext)s" \
        --write-auto-sub --write-sub \
        --sub-format srt --convert-subs srt \
        --write-description \
        --write-info-json \
        --write-thumbnail \
        --embed-thumbnail \
        "$URL"

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úì MP3 downloaded successfully${NC}"
    else
        echo -e "${RED}‚úó MP3 download failed${NC}"
    fi
    echo ""
fi

if [ "$TYPE" == "mp4" ] || [ "$TYPE" == "both" ]; then
    echo -e "${BLUE}üé• Downloading MP4...${NC}"
    yt-dlp -f "bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]" \
        -o "$OUTPUT_DIR/%(title)s.%(ext)s" \
        --write-auto-sub --write-sub \
        --sub-format srt --convert-subs srt \
        --write-description \
        --write-info-json \
        --write-thumbnail \
        --embed-thumbnail \
        --embed-subs \
        "$URL"

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úì MP4 downloaded successfully${NC}"
    else
        echo -e "${RED}‚úó MP4 download failed${NC}"
    fi
    echo ""
fi

# Summary
echo ""
echo -e "${GREEN}‚úÖ Download complete!${NC}"
echo -e "${BLUE}üìÅ Location:${NC} $OUTPUT_DIR"
echo ""
echo -e "${YELLOW}üìã Downloaded files:${NC}"
ls -lh "$OUTPUT_DIR" | tail -n +2 | awk '{print "   " $9 " (" $5 ")"}'
echo ""
