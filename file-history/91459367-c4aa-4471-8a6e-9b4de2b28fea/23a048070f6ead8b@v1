# ✅ Test Users Setup Complete

## What Was Created

### 1. Test Users in Database

Five authenticated test users have been created with different tier configurations:

| User Type | License Key | Purpose |
|-----------|-------------|---------|
| **Starter** | `SPLICE-82CF-4ZAQ-66F6` | Full starter credits (4h, 5 music) |
| **Pro** | `SPLICE-7XWQ-VE7Y-MDJN` | Full pro credits (15h + isolation, 20 music) |
| **Team** | `SPLICE-7DVR-4AEU-W8BU` | Full team credits (50h + isolation, 100 music) |
| **Empty** | `SPLICE-5AUT-NMS8-5SQ8` | Zero credits (test exhaustion) |
| **Cancelled** | `SPLICE-9QHU-F74E-5C4R` | Cancelled subscription state |

### 2. Created Scripts

#### `/splice-backend/scripts/create-test-users.js`
- Creates or updates all 5 test users in the database
- Generates license keys automatically
- Handles database migrations for music credits columns
- Idempotent (safe to run multiple times)

**Usage:**
```bash
cd splice-backend
npm run test:users:create
```

#### `/splice-backend/scripts/verify-test-users.js`
- Tests authentication flow for all test users
- Verifies credits are correctly configured
- Tests CSRF token handling
- Tests JWT token generation and protected endpoints

**Usage:**
```bash
cd splice-backend
npm run test:users  # Requires backend to be running
```

### 3. Documentation

#### `/TEST_USERS.md` (Complete Documentation)
- Full credentials for all test users
- API authentication examples (cURL)
- 7 comprehensive test scenarios
- Jest/Supertest testing examples
- Troubleshooting guide
- Production cleanup instructions

#### `/TEST_USERS_QUICK_REFERENCE.md` (Quick Reference)
- Quick lookup table of all license keys
- Fast copy-paste for testing
- Common test scenarios

#### Updated `/CLAUDE.md`
- Added test users section
- Added npm scripts documentation
- Reference to TEST_USERS.md

### 4. NPM Scripts Added

```json
{
  "test:users:create": "node scripts/create-test-users.js",
  "test:users": "node scripts/verify-test-users.js"
}
```

---

## How to Use

### Quick Start

1. **Start the backend:**
   ```bash
   cd splice-backend
   npm run dev
   ```

2. **Verify test users work:**
   ```bash
   npm run test:users
   ```

3. **Login via frontend:**
   - Navigate to: `http://localhost:3000/login`
   - Enter: `SPLICE-82CF-4ZAQ-66F6`
   - Click Login

### API Testing Example

```bash
# 1. Get CSRF token
curl http://localhost:3847/auth/csrf-token -c cookies.txt

# 2. Login (replace YOUR_CSRF_TOKEN from step 1)
curl -X POST http://localhost:3847/auth/login \
  -H "Content-Type: application/json" \
  -H "X-CSRF-Token: YOUR_CSRF_TOKEN" \
  -b cookies.txt \
  -d '{"licenseKey": "SPLICE-82CF-4ZAQ-66F6"}'

# 3. Get credits (replace YOUR_JWT_TOKEN from step 2)
curl http://localhost:3847/billing/credits \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

## Test Scenarios Covered

✅ **Successful authentication** - All tiers can login
✅ **Invalid license key** - Returns 401 error
✅ **Credit exhaustion** - Empty user can't process
✅ **Tier-specific features** - Starter can't use isolation
✅ **Token refresh** - Refresh tokens work
✅ **Logout & blacklist** - Tokens are revoked on logout
✅ **Cancelled subscription** - Login works, paid features blocked

---

## Files Created

```
/SPLICE/
├── TEST_USERS.md                                    # Complete documentation
├── TEST_USERS_QUICK_REFERENCE.md                    # Quick reference card
├── TEST_USERS_SETUP_COMPLETE.md                     # This file
├── CLAUDE.md                                        # Updated with test users
└── splice-backend/
    ├── package.json                                 # Updated with npm scripts
    └── scripts/
        ├── create-test-users.js                     # User creation script
        └── verify-test-users.js                     # Verification script
```

---

## Database State

The following tables now contain test data:

### `users` table
- 5 test users with `stripe_customer_id` like `cus_test_*`
- Each has appropriate tier, hours, and music credits

### `license_keys` table
- 5 license keys linked to test users
- Format: `SPLICE-XXXX-XXXX-XXXX`
- All marked as active

---

## Next Steps

### Development Testing
1. Test login flows with different tiers
2. Test credit deduction and exhaustion
3. Test tier-based feature access
4. Test logout and token blacklisting

### Integration Testing
1. Add test users to Jest/Supertest test suites
2. Test webhook handling with test customer IDs
3. Test upgrade/downgrade flows
4. Test referral system with test users

### Production Preparation
- Remove test users before going live
- Use cleanup SQL from TEST_USERS.md
- Ensure test customer IDs don't exist in Stripe

---

## Maintenance

### Recreate Users After Database Reset
```bash
cd splice-backend
npm run test:users:create
```

### Reset User Credits
```sql
-- Reset starter user to full credits
UPDATE users
SET
  hours_remaining = 4,
  isolation_hours_remaining = 0,
  music_credits_remaining = 5
WHERE stripe_customer_id = 'cus_test_starter_001';
```

### Delete All Test Users
```sql
-- Delete test users and their license keys
DELETE FROM users WHERE stripe_customer_id LIKE 'cus_test_%';
DELETE FROM license_keys WHERE stripe_customer_id LIKE 'cus_test_%';
```

---

## Verification Checklist

- [x] Test users created in database
- [x] License keys generated
- [x] Credits correctly configured
- [x] Scripts created and executable
- [x] NPM scripts added
- [x] Documentation complete
- [x] CLAUDE.md updated
- [ ] Backend running (required for verification)
- [ ] Verification script tested
- [ ] Frontend login tested
- [ ] API authentication tested

---

**Created:** 2026-01-12
**Status:** ✅ Setup Complete - Ready for Testing
