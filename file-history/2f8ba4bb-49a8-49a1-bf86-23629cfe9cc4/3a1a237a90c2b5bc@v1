# Splice v3

Cloud-powered SaaS for Adobe Premiere Pro with AI-driven auto-cutting, take detection, and subscription billing.

## Monorepo Structure

```
/                         # Root
├── src/                  # Premiere Pro UXP Plugin
│   ├── components/
│   │   ├── panels/       # PluginApp (main container)
│   │   └── common/       # UI: Header, SelectionPanel, AIToolsPanel, AuthPanel, CuttingPanel
│   ├── types/            # TypeScript: plugin, api, premiere, audio, take-detection
│   ├── utils/
│   │   ├── api/          # premiere.ts, backend-client.ts, audio-processor.ts
│   │   └── helpers/      # formatters, validators
│   └── styles/           # Global CSS, Spectrum theming
│
├── backend/              # Node.js + Express API
│   └── src/
│       ├── routes/       # auth, billing, jobs, audio, usage
│       ├── controllers/  # Route handlers
│       ├── services/     # Business logic
│       ├── workers/      # BullMQ job processors (transcription, vocal isolation)
│       ├── db/           # migrations/, repositories/
│       └── middleware/   # auth, rate-limit, usage-limit
│
├── dashboard/            # Next.js Web Dashboard
│   └── app/              # login, signup, dashboard (usage, billing, settings)
│
├── tests/                # Vitest unit + Playwright e2e
└── public/               # manifest.json, icons
```

## Tech Stack

| Layer     | Stack                                                             |
| --------- | ----------------------------------------------------------------- |
| Plugin    | Lit 3.2 + Spectrum Web Components + TypeScript                    |
| Backend   | Node.js + Express + PostgreSQL + BullMQ/Redis                     |
| Dashboard | Next.js + React                                                   |
| Audio     | Whisper/Deepgram (transcription) + Demucs/Dolby (vocal isolation) |
| Payments  | Stripe                                                            |

## Code Quality - Zero Tolerance

After editing ANY file, run:

```bash
npm run lint
npm run typecheck
```

Fix ALL errors/warnings before continuing.

## Organization Rules

- **Plugin components** → `src/components/`, one per file
- **Backend routes** → `backend/src/routes/`, one per resource
- **Types** → `src/types/` or `backend/src/types/`, grouped by domain
- **Tests** → `tests/unit/` and `tests/e2e/`
- **Max file length: 300 lines** — Split into separate modules when exceeded

## UXP API Constraints

**Available:** `createSetNameAction`, `createInsertProjectItemAction`, `createRemoveItemsAction`, `createSetInPointAction/OutPointAction`, `ProjectItem.setColorLabel`

**NOT Available:** Razor/split (use remove+re-insert workaround), TrackItem colors (set on ProjectItem before insert), Audio waveforms (use FFmpeg externally)

## Pricing Tiers

| Plan       | Monthly   | Yearly (17% off) | Limit        |
| ---------- | --------- | ---------------- | ------------ |
| Free Trial | $0        | —                | 10 min total |
| Pro        | $29.99/mo | $298.70/yr       | 300 min/mo   |
| Enterprise | $69.99/mo | $697.10/yr       | 500 min/mo   |

## Stripe Configuration

| Item               | Value                            |
| ------------------ | -------------------------------- |
| Pro Monthly        | `price_1Sf3te2L5BseYEbCr6dUdwrD` |
| Pro Yearly         | `price_1Sf3vE2L5BseYEbC2v1whC72` |
| Enterprise Monthly | `price_1Sf3tg2L5BseYEbCMkv9AgVD` |
| Enterprise Yearly  | `price_1Sf3vG2L5BseYEbCkACPluoj` |

## Current Focus

Section: Phase 1 - Backend (usage tracking complete, audio processing next)
Files: `backend/src/routes/audio-routes.ts`, `backend/src/workers/`

## Last Session (2025-12-16)

- Created usage tracking middleware (`backend/src/middleware/usage-limit.ts`)
- Created usage controller and routes (`GET /api/usage`, `GET /api/usage/check`)
- Updated lint-staged config for monorepo (backend uses separate ESLint)
- Tested all usage endpoints: stats, pre-flight checks, auth guards all working
- Committed and pushed: `6ee8f1f`
- Stopped at: Usage tracking complete, ready for audio processing jobs

## Next Steps

1. Build audio processing job routes (`backend/src/routes/audio-routes.ts`)
2. Create BullMQ workers for transcription and vocal isolation
3. Add `invoice.paid` webhook handler to reset usage on billing renewal
4. Integrate `recordUsage()` calls after audio job completion
