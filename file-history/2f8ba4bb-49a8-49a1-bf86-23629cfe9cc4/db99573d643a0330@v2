import type { Request, Response, NextFunction } from 'express'
import * as authService from '../services/auth-service.js'
import type { AuthenticatedRequest, ApiResponse } from '../types/api.js'
import type { UserPublic } from '../types/user.js'
import type { TokenPair } from '../types/auth.js'

type AuthResponse = ApiResponse<{ user: UserPublic; tokens: TokenPair }>
type TokenResponse = ApiResponse<TokenPair>
type MessageResponse = ApiResponse<{ message: string }>

export async function register(
  req: Request,
  res: Response<AuthResponse>,
  next: NextFunction
): Promise<void> {
  try {
    const validated = authService.registerSchema.parse(req.body)
    const result = await authService.register(validated.email, validated.password, validated.name)

    res.status(201).json({
      success: true,
      data: result,
    })
  } catch (error) {
    next(error)
  }
}

export async function login(
  req: Request,
  res: Response<AuthResponse>,
  next: NextFunction
): Promise<void> {
  try {
    const validated = authService.loginSchema.parse(req.body)
    const result = await authService.login(validated.email, validated.password)

    res.json({
      success: true,
      data: result,
    })
  } catch (error) {
    next(error)
  }
}

export async function refresh(
  req: Request,
  res: Response<TokenResponse>,
  next: NextFunction
): Promise<void> {
  try {
    const validated = authService.refreshSchema.parse(req.body)
    const tokens = await authService.refresh(validated.refreshToken)

    res.json({
      success: true,
      data: tokens,
    })
  } catch (error) {
    next(error)
  }
}

export async function logout(
  req: Request,
  res: Response<MessageResponse>,
  next: NextFunction
): Promise<void> {
  try {
    const { refreshToken } = req.body as { refreshToken?: string }
    if (refreshToken) {
      await authService.logout(refreshToken)
    }

    res.json({
      success: true,
      data: { message: 'Logged out successfully' },
    })
  } catch (error) {
    next(error)
  }
}

export async function logoutAll(
  req: Request,
  res: Response<MessageResponse>,
  next: NextFunction
): Promise<void> {
  try {
    const authReq = req as AuthenticatedRequest
    await authService.logoutAll(authReq.user.id)

    res.json({
      success: true,
      data: { message: 'Logged out from all devices' },
    })
  } catch (error) {
    next(error)
  }
}

export function me(req: Request, res: Response<ApiResponse<UserPublic>>): void {
  const authReq = req as AuthenticatedRequest
  res.json({
    success: true,
    data: authReq.user,
  })
}
