   320→  'bolt://'
   321→];
   322→
   323→const corsOptions = {
   324→  origin: function (origin, callback) {
   325→    // Allow requests with no origin (like mobile apps, Postman, or Adobe plugins)
   326→    if (!origin) {
   327→      return callback(null, true);
   328→    }
   329→    // Check if origin is in whitelist
   330→    if (CORS_WHITELIST.some(allowed => origin.startsWith(allowed) || origin === allowed)) {
   331→      return callback(null, true);
   332→    }
   333→    // In development, allow all origins with warning
   334→    if (!isProduction) {
   335→      console.warn(`[CORS] Non-whitelisted origin in dev: ${origin}`);
   336→      return callback(null, true);
   337→    }
   338→    // In production, reject non-whitelisted origins
   339→    console.error(`[CORS] Blocked request from: ${origin}`);
   340→    return callback(new Error('Not allowed by CORS'));
   341→  },
   342→  credentials: true,
   343→  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
   344→  allowedHeaders: ['Content-Type', 'Authorization', 'x-stripe-customer-id', 'stripe-signature', 'x-csrf-token']
   345→};
   346→
   347→app.use(cors(corsOptions));
   348→
   349→// SECURITY: Trust proxy for accurate client IP behind Railway/load balancers
   350→// This ensures rate limiting and logging use the correct client IP
   351→if (isProduction) {
   352→  app.set('trust proxy', 1);
   353→}
   354→
   355→// IP-based rate limiting (100 requests/minute per IP)
   356→app.use(ipRateLimit);
   357→
   358→// Security headers via helmet
   359→app.use(helmet({
   360→  contentSecurityPolicy: {
   361→    directives: {
   362→      defaultSrc: ["'self'"],
   363→      scriptSrc: ["'self'"],
   364→      styleSrc: ["'self'", "'unsafe-inline'"],
   365→      imgSrc: ["'self'", 'data:', 'https:'],
   366→      connectSrc: ["'self'", 'https://api.stripe.com', 'https://api.openai.com', 'https://api.replicate.com'],
   367→      fontSrc: ["'self'"],
   368→      objectSrc: ["'none'"],
   369→      mediaSrc: ["'self'"],
   370→      frameSrc: ["'none'"]
   371→    }
   372→  },
   373→  hsts: {
   374→    maxAge: 31536000,
   375→    includeSubDomains: true,
   376→    preload: true
   377→  },
   378→  referrerPolicy: { policy: 'strict-origin-when-cross-origin' },
   379→  noSniff: true,
   380→  xssFilter: true,
   381→  hidePoweredBy: true
   382→}));
   383→
   384→// Helper to determine tier from price ID with logging
   385→// Supports both monthly and annual pricing
   386→function getTierFromPriceId(priceId) {
   387→  // Monthly prices
   388→  if (priceId === process.env.STRIPE_PRICE_STARTER) return 'starter';
   389→  if (priceId === process.env.STRIPE_PRICE_PRO) return 'pro';
   390→  if (priceId === process.env.STRIPE_PRICE_TEAM) return 'team';
   391→
   392→  // Annual prices (same tier, just different billing period)
   393→  if (priceId === process.env.STRIPE_PRICE_STARTER_ANNUAL) return 'starter';
   394→  if (priceId === process.env.STRIPE_PRICE_PRO_ANNUAL) return 'pro';
   395→  if (priceId === process.env.STRIPE_PRICE_TEAM_ANNUAL) return 'team';
   396→
   397→  // Log unknown price ID for debugging
   398→  console.warn(`[SPLICE] Unknown price ID: ${priceId} - defaulting to starter tier`);
   399→  return 'starter';
   400→}
   401→
   402→// =============================================================================
   403→// Stripe Webhook (must be before express.json())
   404→// =============================================================================
   405→
   406→app.post('/webhooks/stripe', express.raw({ type: 'application/json' }), async (req, res) => {
   407→  const sig = req.headers['stripe-signature'];
   408→  const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;
   409→
   410→  let event;
   411→
   412→  try {
   413→    if (webhookSecret) {
   414→      event = stripe.webhooks.constructEvent(req.body, sig, webhookSecret);
   415→    } else if (isProduction) {
   416→      // SECURITY: Reject unsigned webhooks in production
   417→      console.error('[SPLICE] CRITICAL: STRIPE_WEBHOOK_SECRET not set in production');
   418→      return res.status(500).json({ error: 'Webhook configuration error: secret not configured' });
   419→    } else {

</system-reminder>
