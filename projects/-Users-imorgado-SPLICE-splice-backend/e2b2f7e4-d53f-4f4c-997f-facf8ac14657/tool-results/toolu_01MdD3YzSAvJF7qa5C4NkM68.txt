     1→import { NextRequest, NextResponse } from "next/server";
     2→import { CSRF_HEADER_NAME } from "@/lib/csrf-server";
     3→
     4→// Backend API URL for authentication
     5→const BACKEND_API_URL =
     6→  process.env.BACKEND_API_URL || "https://splice-api-production.up.railway.app";
     7→
     8→// Cookie configuration
     9→const isProduction = process.env.NODE_ENV === "production";
    10→const COOKIE_OPTIONS = {
    11→  httpOnly: true,
    12→  secure: isProduction, // Only secure in production (allows localhost in dev)
    13→  sameSite: "lax" as const, // Use "lax" to allow cookies on top-level navigations
    14→  path: "/",
    15→};
    16→
    17→// Token expiry times
    18→const ACCESS_TOKEN_MAX_AGE = 60 * 60; // 1 hour in seconds
    19→const REFRESH_TOKEN_MAX_AGE = 7 * 24 * 60 * 60; // 7 days in seconds
    20→
    21→export async function POST(request: NextRequest) {
    22→  try {
    23→    const body = await request.json();
    24→    const { licenseKey } = body;
    25→
    26→    if (!licenseKey) {
    27→      return NextResponse.json(
    28→        { error: "License key is required" },
    29→        { status: 400 }
    30→      );
    31→    }
    32→
    33→    // Get CSRF token from request to forward to backend
    34→    const csrfToken = request.headers.get(CSRF_HEADER_NAME);
    35→    const backendHeaders: Record<string, string> = {
    36→      "Content-Type": "application/json",
    37→    };
    38→    if (csrfToken) {
    39→      backendHeaders[CSRF_HEADER_NAME] = csrfToken;
    40→    }
    41→
    42→    // Get CSRF cookie to forward to backend
    43→    const csrfCookie = request.cookies.get("splice_csrf")?.value;
    44→    if (csrfCookie) {
    45→      backendHeaders["Cookie"] = `splice_csrf=${csrfCookie}`;
    46→    }
    47→
    48→    // Forward the login request to the backend
    49→    const response = await fetch(`${BACKEND_API_URL}/auth/login`, {
    50→      method: "POST",
    51→      headers: backendHeaders,
    52→      body: JSON.stringify({ licenseKey }),
    53→    });
    54→
    55→    const data = await response.json();
    56→
    57→    if (!response.ok) {
    58→      return NextResponse.json(
    59→        {
    60→          error: data.error || "Authentication failed",
    61→          message: data.message || "Please check your license key and try again",
    62→        },
    63→        { status: response.status }
    64→      );
    65→    }
    66→
    67→    // Create the response with user data (excluding tokens)
    68→    const jsonResponse = NextResponse.json({
    69→      success: true,
    70→      customerId: data.customerId,
    71→      tier: data.tier,
    72→      hoursRemaining: data.hoursRemaining,
    73→    });
    74→
    75→    // Set HttpOnly cookies for tokens
    76→    jsonResponse.cookies.set("splice_token", data.token, {
    77→      ...COOKIE_OPTIONS,
    78→      maxAge: ACCESS_TOKEN_MAX_AGE,
    79→    });
    80→
    81→    jsonResponse.cookies.set("splice_refresh_token", data.refreshToken, {
    82→      ...COOKIE_OPTIONS,
    83→      maxAge: REFRESH_TOKEN_MAX_AGE,
    84→    });
    85→
    86→    // Set a non-HttpOnly cookie for client-side auth state check
    87→    // This doesn't contain sensitive data, just indicates logged-in status
    88→    jsonResponse.cookies.set("splice_auth_status", "authenticated", {
    89→      httpOnly: false,
    90→      secure: isProduction,
    91→      sameSite: "lax" as const, // Use "lax" to allow cookies on top-level navigations
    92→      path: "/",
    93→      maxAge: ACCESS_TOKEN_MAX_AGE,
    94→    });
    95→
    96→    // Store user metadata in a separate cookie for client access
    97→    jsonResponse.cookies.set(
    98→      "splice_user",
    99→      JSON.stringify({
   100→        customerId: data.customerId,
   101→        tier: data.tier,
   102→        hoursRemaining: data.hoursRemaining,
   103→      }),
   104→      {
   105→        httpOnly: false,
   106→        secure: isProduction,
   107→        sameSite: "lax" as const, // Use "lax" to allow cookies on top-level navigations
   108→        path: "/",
   109→        maxAge: ACCESS_TOKEN_MAX_AGE,
   110→      }
   111→    );
   112→
   113→    return jsonResponse;
   114→  } catch (error) {
   115→    console.error("[Auth] Login error:", error);
   116→    return NextResponse.json(
   117→      {
   118→        error: "Authentication failed",
   119→        message: "Unable to connect to the authentication server. Please try again later.",
   120→      },
   121→      { status: 500 }
   122→    );
   123→  }
   124→}
   125→

</system-reminder>
