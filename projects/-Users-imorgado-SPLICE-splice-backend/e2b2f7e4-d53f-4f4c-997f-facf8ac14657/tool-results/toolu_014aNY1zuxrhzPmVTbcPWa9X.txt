     1→/**
     2→ * SPLICE CEP Host Script
     3→ * ExtendScript for Premiere Pro
     4→ *
     5→ * Provides all Premiere Pro API functions called via jsx.evalScript()
     6→ * Based on proven patterns from FireCut and SPLICE UXP builder
     7→ */
     8→
     9→// ============================================================================
    10→// GLOBAL CONSTANTS & STATE
    11→// ============================================================================
    12→var SPLICE_VERSION = "6.0.3";
    13→var TICKS_PER_SECOND = 254016000000;
    14→var time_tolerance = 0.01; // 10ms tolerance for clip matching
    15→var temp_bin = null;
    16→var sequence_default_timecode = null;
    17→
    18→// Color label indices (Premiere Pro standard)
    19→var COLOR_LABELS = {
    20→    NONE: 0,
    21→    VIOLET: 1,
    22→    IRIS: 2,
    23→    CARIBBEAN: 3,
    24→    LAVENDER: 4,
    25→    CERULEAN: 5,
    26→    FOREST: 6,
    27→    ROSE: 7,
    28→    MANGO: 8,
    29→    PURPLE: 9,
    30→    BLUE: 10,
    31→    TEAL: 11,
    32→    MAGENTA: 12,
    33→    TAN: 13,
    34→    GREEN: 14,
    35→    BROWN: 15,
    36→    YELLOW: 16
    37→};
    38→
    39→// Segment type to color mapping
    40→var SEGMENT_COLORS = {
    41→    speech: COLOR_LABELS.FOREST,
    42→    take: COLOR_LABELS.LAVENDER,
    43→    best_take: COLOR_LABELS.CERULEAN,
    44→    silence: COLOR_LABELS.VIOLET,
    45→    wide_shot: COLOR_LABELS.YELLOW,
    46→    speaker_a: COLOR_LABELS.MANGO,
    47→    speaker_b: COLOR_LABELS.CARIBBEAN
    48→};
    49→
    50→// Timecode display formats
    51→var TIMECODES = {
    52→    TIMEDISPLAY_Frames: 4
    53→};
    54→
    55→// Translation map for localized effect names
    56→var translations = {
    57→    "Motion": ["Motion", "Mouvement", "Bewegung", "Movimiento", "Movimento"],
    58→    "Transform": ["Transform", "Transformation", "Transformieren", "Transformar"],
    59→    "Scale": ["Scale", "Echelle", "Skalierung", "Escala"],
    60→    "Scale Height": ["Scale Height", "Hauteur de l'echelle", "Skalierungshoehe"],
    61→    "Scale Width": ["Scale Width", "Largeur de l'echelle", "Skalierungsbreite"],
    62→    "Position": ["Position", "Posicion", "Posicao"],
    63→    "Anchor Point": ["Anchor Point", "Point d'ancrage", "Ankerpunkt"],
    64→    "Rotation": ["Rotation", "Rotacion", "Rotacao"],
    65→    "Opacity": ["Opacity", "Opacite", "Deckkraft", "Opacidad"]
    66→};
    67→
    68→// Project item types
    69→var project_item_type = {
    70→    "clip": 1,
    71→    "bin": 2,
    72→    "root": 3,
    73→    "file": 4
    74→};
    75→
    76→// ============================================================================
    77→// INITIALIZATION
    78→// ============================================================================
    79→
    80→/**
    81→ * Check if QE (Quality Engine) DOM is available
    82→ * QE provides extended functionality not available in standard DOM
    83→ */
    84→function isQEAvailable() {
    85→    try {
    86→        return typeof qe !== 'undefined' && qe !== null && qe.project;
    87→    } catch (e) {
    88→        return false;
    89→    }
    90→}
    91→
    92→/**
    93→ * Enable QE DOM if not already enabled
    94→ * @returns {boolean} true if QE is now available
    95→ */
    96→function enableQE() {
    97→    try {
    98→        if (isQEAvailable()) return true;
    99→        app.enableQE();
   100→        return isQEAvailable();
   101→    } catch (e) {
   102→        $.writeln('[SPLICE] enableQE failed: ' + e.message);
   103→        return false;
   104→    }
   105→}
   106→
   107→/**
   108→ * Safe wrapper for QE operations
   109→ * @param {Function} operation - The QE operation to execute
   110→ * @param {string} operationName - Name for error reporting
   111→ * @returns {Object} Result or error object
   112→ */
   113→function safeQEOperation(operation, operationName) {
   114→    try {
   115→        if (!isQEAvailable()) {
   116→            if (!enableQE()) {
   117→                return { error: "QE not available. Please ensure Premiere Pro supports QE DOM." };
   118→            }
   119→        }
   120→        return operation();
   121→    } catch (e) {
   122→        return { error: operationName + " failed: " + e.message };
   123→    }
   124→}
   125→
   126→function initialise() {
   127→    storeDefaultTimecode();
   128→    // Try to enable QE on startup
   129→    var qeStatus = enableQE();
   130→    return JSON.stringify({ success: true, version: SPLICE_VERSION, qeAvailable: qeStatus });
   131→}
   132→
   133→function storeDefaultTimecode() {
   134→    if (app.project.activeSequence) {
   135→        sequence_default_timecode = app.project.activeSequence.getSettings().videoDisplayFormat;
   136→    }
   137→}
   138→
   139→/**
   140→ * Check if a sequence is currently open/active in the Timeline
   141→ * Uses multiple fallbacks to ensure accurate detection
   142→ * @returns {boolean} true if a sequence is open
   143→ */
   144→function checkSequenceOpen() {
   145→    try {
   146→        $.writeln('[SPLICE] ========== checkSequenceOpen DIAGNOSTIC START ==========');
   147→        
   148→        // Check if app exists
   149→        if (!app) {
   150→            $.writeln('[SPLICE] checkSequenceOpen: ERROR - app object does not exist');
   151→            return false;
   152→        }
   153→        $.writeln('[SPLICE] checkSequenceOpen: app object exists');
   154→        
   155→        // Check if project exists
   156→        if (!app.project) {
   157→            $.writeln('[SPLICE] checkSequenceOpen: ERROR - app.project does not exist');
   158→            return false;
   159→        }
   160→        $.writeln('[SPLICE] checkSequenceOpen: app.project exists');
   161→        
   162→        // Check if sequences collection exists
   163→        if (!app.project.sequences) {
   164→            $.writeln('[SPLICE] checkSequenceOpen: ERROR - app.project.sequences does not exist');
   165→            return false;
   166→        }
   167→        $.writeln('[SPLICE] checkSequenceOpen: app.project.sequences exists');
   168→        
   169→        // Log total number of sequences
   170→        var numSequences = app.project.sequences.numSequences;
   171→        $.writeln('[SPLICE] checkSequenceOpen: Total sequences in project: ' + numSequences);
   172→        
   173→        // List all sequences with their details
   174→        for (var i = 0; i < numSequences; i++) {
   175→            var seq = app.project.sequences[i];
   176→            if (seq) {
   177→                $.writeln('[SPLICE] checkSequenceOpen:   - Sequence ' + i + ': name="' + seq.name + '", id=' + seq.sequenceID);
   178→            }
   179→        }
   180→        
   181→        // Primary check: Standard DOM - Check for activeSequence
   182→        $.writeln('[SPLICE] checkSequenceOpen: Checking app.project.activeSequence...');
   183→        if (app.project.activeSequence) {
   184→            var activeSeq = app.project.activeSequence;
   185→            $.writeln('[SPLICE] checkSequenceOpen: SUCCESS - Found active sequence via DOM');
   186→            $.writeln('[SPLICE] checkSequenceOpen:   - name: ' + activeSeq.name);
   187→            $.writeln('[SPLICE] checkSequenceOpen:   - sequenceID: ' + activeSeq.sequenceID);
   188→            $.writeln('[SPLICE] checkSequenceOpen:   - videoTracks: ' + activeSeq.videoTracks.numTracks);
   189→            $.writeln('[SPLICE] checkSequenceOpen:   - audioTracks: ' + activeSeq.audioTracks.numTracks);
   190→            $.writeln('[SPLICE] checkSequenceOpen:   - frameSize: ' + activeSeq.frameSizeHorizontal + 'x' + activeSeq.frameSizeVertical);
   191→            $.writeln('[SPLICE] checkSequenceOpen: ========== checkSequenceOpen DIAGNOSTIC END (TRUE) ==========');
   192→            return true;
   193→        }
   194→        $.writeln('[SPLICE] checkSequenceOpen: app.project.activeSequence is null/undefined');
   195→
   196→        // Fallback: Try QE DOM (requires enableQE first)
   197→        $.writeln('[SPLICE] checkSequenceOpen: Trying QE DOM fallback...');
   198→        if (enableQE()) {
   199→            try {
   200→                $.writeln('[SPLICE] checkSequenceOpen: QE DOM is enabled');

</system-reminder>
