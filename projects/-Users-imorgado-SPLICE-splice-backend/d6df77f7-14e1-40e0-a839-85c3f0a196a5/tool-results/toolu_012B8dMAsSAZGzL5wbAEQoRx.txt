     1→/**
     2→ * SPLICE CEP Host Script
     3→ * ExtendScript for Premiere Pro
     4→ *
     5→ * Provides all Premiere Pro API functions called via jsx.evalScript()
     6→ * Based on proven patterns from FireCut and SPLICE UXP builder
     7→ */
     8→
     9→// ============================================================================
    10→// GLOBAL CONSTANTS & STATE
    11→// ============================================================================
    12→var SPLICE_VERSION = "4.0.0";
    13→var TICKS_PER_SECOND = 254016000000;
    14→var time_tolerance = 0.01; // 10ms tolerance for clip matching
    15→var temp_bin = null;
    16→var sequence_default_timecode = null;
    17→
    18→// Color label indices (Premiere Pro standard)
    19→var COLOR_LABELS = {
    20→    NONE: 0,
    21→    VIOLET: 1,
    22→    IRIS: 2,
    23→    CARIBBEAN: 3,
    24→    LAVENDER: 4,
    25→    CERULEAN: 5,
    26→    FOREST: 6,
    27→    ROSE: 7,
    28→    MANGO: 8,
    29→    PURPLE: 9,
    30→    BLUE: 10,
    31→    TEAL: 11,
    32→    MAGENTA: 12,
    33→    TAN: 13,
    34→    GREEN: 14,
    35→    BROWN: 15,
    36→    YELLOW: 16
    37→};
    38→
    39→// Segment type to color mapping
    40→var SEGMENT_COLORS = {
    41→    speech: COLOR_LABELS.FOREST,
    42→    take: COLOR_LABELS.LAVENDER,
    43→    best_take: COLOR_LABELS.CERULEAN,
    44→    silence: COLOR_LABELS.VIOLET,
    45→    wide_shot: COLOR_LABELS.YELLOW,
    46→    speaker_a: COLOR_LABELS.MANGO,
    47→    speaker_b: COLOR_LABELS.CARIBBEAN
    48→};
    49→
    50→// Timecode display formats
    51→var TIMECODES = {
    52→    TIMEDISPLAY_Frames: 4
    53→};
    54→
    55→// Translation map for localized effect names
    56→var translations = {
    57→    "Motion": ["Motion", "Mouvement", "Bewegung", "Movimiento", "Movimento"],
    58→    "Transform": ["Transform", "Transformation", "Transformieren", "Transformar"],
    59→    "Scale": ["Scale", "Echelle", "Skalierung", "Escala"],
    60→    "Scale Height": ["Scale Height", "Hauteur de l'echelle", "Skalierungshoehe"],
    61→    "Scale Width": ["Scale Width", "Largeur de l'echelle", "Skalierungsbreite"],
    62→    "Position": ["Position", "Posicion", "Posicao"],
    63→    "Anchor Point": ["Anchor Point", "Point d'ancrage", "Ankerpunkt"],
    64→    "Rotation": ["Rotation", "Rotacion", "Rotacao"],
    65→    "Opacity": ["Opacity", "Opacite", "Deckkraft", "Opacidad"]
    66→};
    67→
    68→// Project item types
    69→var project_item_type = {
    70→    "clip": 1,
    71→    "bin": 2,
    72→    "root": 3,
    73→    "file": 4
    74→};
    75→
    76→// ============================================================================
    77→// INITIALIZATION
    78→// ============================================================================
    79→
    80→function initialise() {
    81→    storeDefaultTimecode();
    82→    return JSON.stringify({ success: true, version: SPLICE_VERSION });
    83→}
    84→
    85→function storeDefaultTimecode() {
    86→    if (app.project.activeSequence) {
    87→        sequence_default_timecode = app.project.activeSequence.getSettings().videoDisplayFormat;
    88→    }
    89→}
    90→
    91→function checkSequenceOpen() {
    92→    return app.project.activeSequence ? true : false;
    93→}
    94→
    95→function getVersion() {
    96→    return SPLICE_VERSION;
    97→}
    98→
    99→// ============================================================================
   100→// TIME CONVERSION UTILITIES
   101→// ============================================================================
   102→
   103→/**
   104→ * Get the actual frames per second from the sequence
   105→ * videoFrameRate.seconds gives seconds per frame, so we need to invert it
   106→ */
   107→function getActualFrameRate() {
   108→    var secsPerFrame = app.project.activeSequence.getSettings().videoFrameRate.seconds;
   109→    // secsPerFrame is e.g., 0.03333... for 30fps, so 1/secsPerFrame = 30
   110→    return 1 / secsPerFrame;
   111→}
   112→
   113→function quantise_time(time_seconds) {
   114→    // Get seconds per frame (e.g., 0.0333 for 30fps)
   115→    var secsPerFrame = app.project.activeSequence.getSettings().videoFrameRate.seconds;
   116→    // Round to nearest frame boundary
   117→    return secsPerFrame * Math.round(time_seconds / secsPerFrame);
   118→}
   119→
   120→function frames_to_time(number_of_frames) {
   121→    // seconds per frame * number of frames = total seconds
   122→    var secsPerFrame = app.project.activeSequence.getSettings().videoFrameRate.seconds;
   123→    return number_of_frames * secsPerFrame;
   124→}
   125→
   126→function frames_to_ticks(number_of_frames) {
   127→    // Convert frames to ticks: frames * seconds_per_frame * ticks_per_second
   128→    var secsPerFrame = app.project.activeSequence.getSettings().videoFrameRate.seconds;
   129→    return number_of_frames * secsPerFrame * TICKS_PER_SECOND;
   130→}
   131→
   132→function seconds_to_ticks(seconds) {
   133→    return seconds * TICKS_PER_SECOND;
   134→}
   135→
   136→function ticks_to_seconds(ticks) {
   137→    return ticks / TICKS_PER_SECOND;
   138→}
   139→
   140→function getVideoFrameRateInSeconds() {
   141→    return app.project.activeSequence.getSettings().videoFrameRate.seconds;
   142→}
   143→
   144→function secondsToCurrentTimecode(seconds) {
   145→    var seq = app.project.activeSequence;
   146→    if (seq) {
   147→        var t = new Time();
   148→        t.seconds = parseFloat(seconds);
   149→        var settings = app.project.activeSequence.getSettings();
   150→        return t.getFormatted(settings.videoFrameRate, settings.videoDisplayFormat);
   151→    }
   152→    return false;
   153→}
   154→
   155→// ============================================================================
   156→// TIMECODE FORMAT
   157→// ============================================================================
   158→
   159→function setTimecodeToFrames() {
   160→    var seq = app.project.activeSequence;
   161→    if (seq) {
   162→        var currentSeqSettings = app.project.activeSequence.getSettings();
   163→        if (currentSeqSettings.videoDisplayFormat != TIMECODES.TIMEDISPLAY_Frames) {
   164→            currentSeqSettings.videoDisplayFormat = TIMECODES.TIMEDISPLAY_Frames;
   165→            app.project.activeSequence.setSettings(currentSeqSettings);
   166→        }
   167→    }
   168→}
   169→
   170→function setTimecodeToDefault() {
   171→    var seq = app.project.activeSequence;
   172→    if (seq && sequence_default_timecode) {
   173→        var currentSeqSettings = app.project.activeSequence.getSettings();
   174→        currentSeqSettings.videoDisplayFormat = sequence_default_timecode;
   175→        app.project.activeSequence.setSettings(currentSeqSettings);
   176→    }
   177→}
   178→
   179→function getTimecodeFormat() {
   180→    return app.project.activeSequence.getSettings().videoDisplayFormat;
   181→}
   182→
   183→function setTimecodeFormat(format) {
   184→    format = parseInt(format);
   185→    var seq = app.project.activeSequence;
   186→    if (seq) {
   187→        var currentSeqSettings = app.project.activeSequence.getSettings();
   188→        currentSeqSettings.videoDisplayFormat = format;
   189→        app.project.activeSequence.setSettings(currentSeqSettings);
   190→    }
   191→    return true;
   192→}
   193→
   194→// ============================================================================
   195→// SEQUENCE & PROJECT OPERATIONS
   196→// ============================================================================
   197→
   198→function getActiveSequence() {
   199→    var seq = app.project.activeSequence;
   200→    if (!seq) return JSON.stringify({ error: "No active sequence" });
   201→
   202→    return JSON.stringify({
   203→        name: seq.name,
   204→        id: seq.sequenceID,
   205→        duration: seq.end,
   206→        videoTrackCount: seq.videoTracks.numTracks,
   207→        audioTrackCount: seq.audioTracks.numTracks,
   208→        frameRate: seq.getSettings().videoFrameRate.seconds,
   209→        width: seq.frameSizeHorizontal,
   210→        height: seq.frameSizeVertical
   211→    });
   212→}
   213→
   214→function getSequenceSettings() {
   215→    var seq = app.project.activeSequence;
   216→    if (!seq) return JSON.stringify({ error: "No active sequence" });
   217→
   218→    var settings = seq.getSettings();
   219→    return JSON.stringify({
   220→        frameRate: settings.videoFrameRate.seconds,
   221→        width: settings.videoFrameWidth,
   222→        height: settings.videoFrameHeight,
   223→        displayFormat: settings.videoDisplayFormat
   224→    });
   225→}
   226→
   227→function cloneSequence(newName) {
   228→    var seq = app.project.activeSequence;
   229→    if (!seq) return JSON.stringify({ error: "No active sequence" });
   230→
   231→    try {
   232→        // Clone the sequence
   233→        seq.clone();
   234→
   235→        // Find the cloned sequence (last one with matching name pattern)
   236→        var clonedSeq = null;
   237→        for (var i = app.project.sequences.numSequences - 1; i >= 0; i--) {
   238→            var s = app.project.sequences[i];
   239→            if (s.name.indexOf(seq.name) === 0 && s.sequenceID !== seq.sequenceID) {
   240→                clonedSeq = s;
   241→                break;
   242→            }
   243→        }
   244→
   245→        if (clonedSeq && newName) {
   246→            clonedSeq.name = newName;
   247→        }
   248→
   249→        return JSON.stringify({
   250→            success: true,
   251→            sequenceId: clonedSeq ? clonedSeq.sequenceID : null,
   252→            name: clonedSeq ? clonedSeq.name : newName
   253→        });
   254→    } catch (e) {
   255→        return JSON.stringify({ error: e.message });
   256→    }
   257→}
   258→
   259→function createNewSequence(name) {
   260→    try {
   261→        app.project.createNewSequence(name);
   262→        var seq = app.project.activeSequence;
   263→        return JSON.stringify({
   264→            success: true,
   265→            sequenceId: seq.sequenceID,
   266→            name: seq.name
   267→        });
   268→    } catch (e) {
   269→        return JSON.stringify({ error: e.message });
   270→    }
   271→}
   272→
   273→function setActiveSequence(sequenceId) {
   274→    for (var i = 0; i < app.project.sequences.numSequences; i++) {
   275→        if (app.project.sequences[i].sequenceID === sequenceId) {
   276→            app.project.activeSequence = app.project.sequences[i];
   277→            return JSON.stringify({ success: true });
   278→        }
   279→    }
   280→    return JSON.stringify({ error: "Sequence not found" });
   281→}
   282→
   283→/**
   284→ * Seek playhead to a specific time in seconds
   285→ */
   286→function seekToTime(seconds) {
   287→    var seq = app.project.activeSequence;
   288→    if (!seq) return JSON.stringify({ error: "No active sequence" });
   289→
   290→    try {
   291→        // Convert seconds to ticks
   292→        var ticks = seconds * TICKS_PER_SECOND;
   293→
   294→        // Create a Time object and set position
   295→        var playerPos = seq.getPlayerPosition();
   296→        playerPos.seconds = seconds;
   297→        seq.setPlayerPosition(playerPos.ticks.toString());
   298→
   299→        return JSON.stringify({ success: true, position: seconds });
   300→    } catch (e) {
   301→        return JSON.stringify({ error: e.message });
   302→    }
   303→}
   304→
   305→/**
   306→ * Get current playhead position in seconds
   307→ */
   308→function getPlayerPosition() {
   309→    var seq = app.project.activeSequence;
   310→    if (!seq) return JSON.stringify({ error: "No active sequence" });
   311→
   312→    try {
   313→        var pos = seq.getPlayerPosition();
   314→        return JSON.stringify({
   315→            ticks: pos.ticks,
   316→            seconds: pos.seconds
   317→        });
   318→    } catch (e) {
   319→        return JSON.stringify({ error: e.message });
   320→    }
   321→}
   322→
   323→// ============================================================================
   324→// RAZOR OPERATIONS
   325→// ============================================================================
   326→
   327→function razorSequenceAtFrames(frames) {
   328→    frames = String(frames);
   329→    setTimecodeToFrames();
   330→    qe.project.getActiveSequence().razor(frames);
   331→    return true;
   332→}
   333→
   334→function razorSequenceAtSeconds(seconds) {
   335→    var frames = parseInt(Math.round(seconds / app.project.activeSequence.getSettings().videoFrameRate.seconds)).toString();
   336→    razorSequenceAtFrames(frames);
   337→    return true;
   338→}
   339→
   340→function razorSequenceAtFramesArray(silences_array) {
   341→    setTimecodeToFrames();
   342→    silences_array = JSON.parse(silences_array);
   343→    for (var i = 0; i < silences_array.length; i++) {
   344→        for (var j = 0; j < silences_array[i].length; j++) {
   345→            var frames = String(silences_array[i][j]);
   346→            qe.project.getActiveSequence().razor(frames);
   347→        }
   348→    }
   349→    return true;
   350→}
   351→
   352→function razorTrackAtFrames(trackType, trackIndex, frames) {
   353→    frames = String(frames);
   354→    setTimecodeToFrames();
   355→    if (trackType == "video") {
   356→        qe.project.getActiveSequence().getVideoTrackAt(trackIndex).razor(frames);
   357→    } else if (trackType == "audio") {
   358→        qe.project.getActiveSequence().getAudioTrackAt(trackIndex).razor(frames);
   359→    }
   360→    return true;
   361→}
   362→
   363→function razorTrackAtSeconds(trackType, trackIndex, seconds) {
   364→    var frames = parseInt(Math.round(seconds / app.project.activeSequence.getSettings().videoFrameRate.seconds)).toString();
   365→    razorTrackAtFrames(trackType, trackIndex, frames);
   366→    return true;
   367→}
   368→
   369→// ============================================================================
   370→// CLIP OPERATIONS
   371→// ============================================================================
   372→
   373→function getClipsInTrack(trackIndex, trackType) {
   374→    var clips = [];
   375→    if (trackType == "audio") {
   376→        for (var i = 0; i < app.project.activeSequence.audioTracks[trackIndex].clips.numItems; i++) {
   377→            var clip = app.project.activeSequence.audioTracks[trackIndex].clips[i];
   378→            clips.push({
   379→                index: i,
   380→                name: clip.name,
   381→                start: clip.start.seconds,
   382→                end: clip.end.seconds,
   383→                duration: clip.duration.seconds,
   384→                inPoint: clip.inPoint.seconds,
   385→                outPoint: clip.outPoint.seconds,
   386→                mediaPath: clip.projectItem ? clip.projectItem.getMediaPath() : null
   387→            });
   388→        }
   389→    } else if (trackType == "video") {
   390→        for (var i = 0; i < app.project.activeSequence.videoTracks[trackIndex].clips.numItems; i++) {
   391→            var clip = app.project.activeSequence.videoTracks[trackIndex].clips[i];
   392→            clips.push({
   393→                index: i,
   394→                name: clip.name,
   395→                start: clip.start.seconds,
   396→                end: clip.end.seconds,
   397→                duration: clip.duration.seconds,
   398→                inPoint: clip.inPoint.seconds,
   399→                outPoint: clip.outPoint.seconds,
   400→                mediaPath: clip.projectItem ? clip.projectItem.getMediaPath() : null
   401→            });
   402→        }
   403→    }
   404→    return JSON.stringify(clips);
   405→}
   406→
   407→function getClipsInTrack_Timings_Seconds(trackIndex, trackType) {
   408→    var clips = [];
   409→    if (trackType == "audio") {
   410→        for (var i = 0; i < app.project.activeSequence.audioTracks[trackIndex].clips.numItems; i++) {
   411→            clips.push([
   412→                app.project.activeSequence.audioTracks[trackIndex].clips[i].start.seconds,
   413→                app.project.activeSequence.audioTracks[trackIndex].clips[i].end.seconds
   414→            ]);
   415→        }
   416→    } else if (trackType == "video") {
   417→        for (var i = 0; i < app.project.activeSequence.videoTracks[trackIndex].clips.numItems; i++) {
   418→            clips.push([
   419→                app.project.activeSequence.videoTracks[trackIndex].clips[i].start.seconds,
   420→                app.project.activeSequence.videoTracks[trackIndex].clips[i].end.seconds
   421→            ]);
   422→        }
   423→    }
   424→    return JSON.stringify(clips);
   425→}
   426→
   427→function deleteClipsAtSilencePointsInTrack(silences, trackType, trackIndex) {
   428→    silences = JSON.parse(silences);
   429→    var clips;
   430→    if (trackType == "video") {
   431→        clips = app.project.activeSequence.videoTracks[trackIndex].clips;
   432→    } else if (trackType == "audio") {
   433→        clips = app.project.activeSequence.audioTracks[trackIndex].clips;
   434→    }
   435→
   436→    var deleted = 0;
   437→    for (var i = clips.length - 1; i >= 0; i--) {
   438→        var clip = clips[i];
   439→        var start = clip.start.seconds;
   440→        var end = clip.end.seconds;
   441→        var center = (start + end) / 2;
   442→
   443→        for (var j = 0; j < silences.length; j++) {
   444→            var silence = silences[j];
   445→            var silenceCenter = (silence[0] + silence[1]) / 2;
   446→            if (silenceCenter > start && silenceCenter < end) {
   447→                clip.remove(false, false);
   448→                deleted++;
   449→                break;
   450→            }
   451→        }
   452→    }
   453→    return JSON.stringify({ deleted: deleted });
   454→}
   455→
   456→function makeRemainingClipsContiguousInTrack(silences, deltas, trackType, trackIndex) {
   457→    silences = JSON.parse(silences);
   458→    deltas = JSON.parse(deltas);
   459→
   460→    var clips;
   461→    if (trackType == "video") {
   462→        clips = app.project.activeSequence.videoTracks[trackIndex].clips;
   463→    } else if (trackType == "audio") {
   464→        clips = app.project.activeSequence.audioTracks[trackIndex].clips;
   465→    }
   466→
   467→    for (var i = 0; i < clips.length; i++) {
   468→        var clip = clips[i];
   469→        var end = clip.end.seconds;
   470→        var num_silences = -1;
   471→
   472→        for (var j = 0; j < silences.length; j++) {
   473→            if (end > silences[j][1]) {
   474→                num_silences++;
   475→            }
   476→        }
   477→
   478→        if (num_silences > -1 && num_silences < deltas.length) {
   479→            var delta = deltas[num_silences];
   480→            var t_start = clip.start;
   481→            t_start.seconds = t_start.seconds - delta;
   482→            clip.start = t_start;
   483→            var t_end = clip.end;
   484→            t_end.seconds = t_end.seconds - delta;
   485→            clip.end = t_end;
   486→        }
   487→    }
   488→    return JSON.stringify({ success: true });
   489→}
   490→
   491→function removeClipByIndex(trackType, trackIndex, clipIndex) {
   492→    try {
   493→        if (trackType == "video") {
   494→            app.project.activeSequence.videoTracks[trackIndex].clips[clipIndex].remove(false, false);
   495→        } else if (trackType == "audio") {
   496→            app.project.activeSequence.audioTracks[trackIndex].clips[clipIndex].remove(false, false);
   497→        }
   498→        return JSON.stringify({ success: true });
   499→    } catch (e) {
   500→        return JSON.stringify({ error: e.message });
   501→    }
   502→}
   503→
   504→function setClipInOutPoints(trackType, trackIndex, clipIndex, inPoint, outPoint) {
   505→    try {
   506→        var clip;
   507→        if (trackType == "video") {
   508→            clip = app.project.activeSequence.videoTracks[trackIndex].clips[clipIndex];
   509→        } else if (trackType == "audio") {
   510→            clip = app.project.activeSequence.audioTracks[trackIndex].clips[clipIndex];
   511→        }
   512→
   513→        if (inPoint !== null) {
   514→            var inTime = new Time();
   515→            inTime.seconds = inPoint;
   516→            clip.inPoint = inTime;
   517→        }
   518→        if (outPoint !== null) {
   519→            var outTime = new Time();
   520→            outTime.seconds = outPoint;
   521→            clip.outPoint = outTime;
   522→        }
   523→        return JSON.stringify({ success: true });
   524→    } catch (e) {
   525→        return JSON.stringify({ error: e.message });
   526→    }
   527→}
   528→
   529→function setClipStartEnd(trackType, trackIndex, clipIndex, startSeconds, endSeconds) {
   530→    try {
   531→        var clip;
   532→        if (trackType == "video") {
   533→            clip = app.project.activeSequence.videoTracks[trackIndex].clips[clipIndex];
   534→        } else if (trackType == "audio") {
   535→            clip = app.project.activeSequence.audioTracks[trackIndex].clips[clipIndex];
   536→        }
   537→
   538→        if (startSeconds !== null) {
   539→            var startTime = clip.start;
   540→            startTime.seconds = startSeconds;
   541→            clip.start = startTime;
   542→        }
   543→        if (endSeconds !== null) {
   544→            var endTime = clip.end;
   545→            endTime.seconds = endSeconds;
   546→            clip.end = endTime;
   547→        }
   548→        return JSON.stringify({ success: true });
   549→    } catch (e) {
   550→        return JSON.stringify({ error: e.message });
   551→    }
   552→}
   553→
   554→// ============================================================================
   555→// TRACK OPERATIONS
   556→// ============================================================================
   557→
   558→function getTrackNames(trackType) {
   559→    var ret = [];
   560→    if (trackType == "video") {
   561→        for (var i = 0; i < qe.project.getActiveSequence().numVideoTracks; i++) {
   562→            ret.push(qe.project.getActiveSequence().getVideoTrackAt(i).name);
   563→        }
   564→    } else if (trackType == "audio") {
   565→        for (var i = 0; i < qe.project.getActiveSequence().numAudioTracks; i++) {
   566→            ret.push(qe.project.getActiveSequence().getAudioTrackAt(i).name);
   567→        }
   568→    }
   569→    return JSON.stringify(ret);
   570→}
   571→
   572→function getNumTracks(trackType) {
   573→    if (trackType == "video") {
   574→        return app.project.activeSequence.videoTracks.numTracks;
   575→    } else if (trackType == "audio") {
   576→        return app.project.activeSequence.audioTracks.numTracks;
   577→    }
   578→    return 0;
   579→}
   580→
   581→function addVideoTrack() {
   582→    var trackId = qe.project.getActiveSequence().numVideoTracks;
   583→    qe.project.getActiveSequence().addTracks(1, trackId, 0, 0);
   584→    return trackId;
   585→}
   586→
   587→function addAudioTrack() {
   588→    var trackId = qe.project.getActiveSequence().numAudioTracks;
   589→    qe.project.getActiveSequence().addTracks(0, 0, 1, 1, trackId);
   590→    return trackId;
   591→}
   592→
   593→function removeVideoTrack(trackIndex) {
   594→    qe.project.getActiveSequence().removeVideoTrack(trackIndex);
   595→    return true;
   596→}
   597→
   598→function removeAudioTrack(trackIndex) {
   599→    qe.project.getActiveSequence().removeAudioTrack(trackIndex);
   600→    return true;
   601→}
   602→
   603→// ============================================================================
   604→// MUTE STATE
   605→// ============================================================================
   606→
   607→function getMuteState() {
   608→    var mute_state_video = [];
   609→    for (var i = 0; i < app.project.activeSequence.videoTracks.numTracks; i++) {
   610→        mute_state_video.push(app.project.activeSequence.videoTracks[i].isMuted());
   611→    }
   612→    var mute_state_audio = [];
   613→    for (var i = 0; i < app.project.activeSequence.audioTracks.numTracks; i++) {
   614→        mute_state_audio.push(app.project.activeSequence.audioTracks[i].isMuted());
   615→    }
   616→    return JSON.stringify({ audio: mute_state_audio, video: mute_state_video });
   617→}
   618→
   619→function setMuteState(mute_state) {
   620→    mute_state = JSON.parse(mute_state);
   621→    for (var i = 0; i < app.project.activeSequence.videoTracks.numTracks; i++) {
   622→        if (i < mute_state.video.length) {
   623→            app.project.activeSequence.videoTracks[i].setMute(mute_state.video[i]);
   624→        }
   625→    }
   626→    for (var i = 0; i < app.project.activeSequence.audioTracks.numTracks; i++) {
   627→        if (i < mute_state.audio.length) {
   628→            app.project.activeSequence.audioTracks[i].setMute(mute_state.audio[i]);
   629→        }
   630→    }
   631→    return true;
   632→}
   633→
   634→// ============================================================================
   635→// PROJECT ITEM OPERATIONS
   636→// ============================================================================
   637→
   638→function findItemByName(bin, name) {
   639→    for (var i = 0; i < bin.children.numItems; i++) {
   640→        if (bin.children[i].name === name) {
   641→            return bin.children[i];
   642→        }
   643→        if (bin.children[i].children !== undefined) {
   644→            var item = findItemByName(bin.children[i], name);
   645→            if (item) return item;
   646→        }
   647→    }
   648→    return null;
   649→}
   650→
   651→function findItemByPath(bin, path) {
   652→    for (var i = 0; i < bin.children.numItems; i++) {
   653→        var item = bin.children[i];
   654→        if (item.getMediaPath && item.getMediaPath() === path) {
   655→            return item;
   656→        }
   657→        if (item.children !== undefined) {
   658→            var found = findItemByPath(item, path);
   659→            if (found) return found;
   660→        }
   661→    }
   662→    return null;
   663→}
   664→
   665→function importFile(filePath) {
   666→    try {
   667→        var success = app.project.importFiles([filePath], true, app.project.rootItem, false);
   668→        if (success) {
   669→            // Find the imported item
   670→            var item = findItemByPath(app.project.rootItem, filePath);
   671→            return JSON.stringify({
   672→                success: true,
   673→                nodeId: item ? item.nodeId : null
   674→            });
   675→        }
   676→        return JSON.stringify({ error: "Import failed" });
   677→    } catch (e) {
   678→        return JSON.stringify({ error: e.message });
   679→    }
   680→}
   681→
   682→function getSpliceBin() {
   683→    var rootItemChildren = app.project.rootItem.children;
   684→    var spliceBin = null;
   685→
   686→    for (var i = 0; i < rootItemChildren.numItems; i++) {
   687→        if (rootItemChildren[i].name === "SPLICE" && rootItemChildren[i].type === 2) {
   688→            spliceBin = rootItemChildren[i];
   689→            break;
   690→        }
   691→    }
   692→
   693→    if (!spliceBin) {
   694→        app.project.rootItem.createBin("SPLICE");
   695→        return getSpliceBin();
   696→    }
   697→
   698→    return spliceBin;
   699→}
   700→
   701→function getAllProjectItems() {
   702→    var items = [];
   703→
   704→    function collectItems(bin, path) {
   705→        for (var i = 0; i < bin.children.numItems; i++) {
   706→            var item = bin.children[i];
   707→            var itemPath = path + "/" + item.name;
   708→
   709→            items.push({
   710→                nodeId: item.nodeId,
   711→                name: item.name,
   712→                type: item.type,
   713→                treePath: itemPath,
   714→                mediaPath: item.getMediaPath ? item.getMediaPath() : null
   715→            });
   716→
   717→            if (item.children !== undefined && item.type === 2) {
   718→                collectItems(item, itemPath);
   719→            }
   720→        }
   721→    }
   722→
   723→    collectItems(app.project.rootItem, "");
   724→    return JSON.stringify(items);
   725→}
   726→
   727→// ============================================================================
   728→// CLIP INSERTION
   729→// ============================================================================
   730→
   731→function insertClipAtTime(projectItemNodeId, trackIndex, startSeconds, trackType) {
   732→    try {
   733→        var item = findItemByNodeId(app.project.rootItem, projectItemNodeId);
   734→        if (!item) {
   735→            return JSON.stringify({ error: "Project item not found" });
   736→        }
   737→
   738→        var targetTime = new Time();
   739→        targetTime.seconds = startSeconds;
   740→
   741→        if (trackType === "video") {
   742→            app.project.activeSequence.videoTracks[trackIndex].insertClip(item, targetTime);
   743→        } else if (trackType === "audio") {
   744→            app.project.activeSequence.audioTracks[trackIndex].insertClip(item, targetTime);
   745→        }
   746→
   747→        return JSON.stringify({ success: true });
   748→    } catch (e) {
   749→        return JSON.stringify({ error: e.message });
   750→    }
   751→}
   752→
   753→function findItemByNodeId(bin, nodeId) {
   754→    for (var i = 0; i < bin.children.numItems; i++) {
   755→        if (bin.children[i].nodeId === nodeId) {
   756→            return bin.children[i];
   757→        }
   758→        if (bin.children[i].children !== undefined) {
   759→            var found = findItemByNodeId(bin.children[i], nodeId);
   760→            if (found) return found;
   761→        }
   762→    }
   763→    return null;
   764→}
   765→
   766→// ============================================================================
   767→// MARKER OPERATIONS
   768→// ============================================================================
   769→
   770→function createMarker(timeSeconds, name, duration, comments, colorIndex) {
   771→    try {
   772→        var seq = app.project.activeSequence;
   773→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   774→
   775→        var markers = seq.markers;
   776→        var marker = markers.createMarker(timeSeconds);
   777→
   778→        if (name) marker.name = name;
   779→        if (comments) marker.comments = comments;
   780→        if (colorIndex !== undefined) marker.setColorByIndex(colorIndex);
   781→        if (duration && duration > 0) {
   782→            // Set marker end time properly using a Time object
   783→            var endTime = new Time();
   784→            endTime.seconds = marker.start.seconds + duration;
   785→            marker.end = endTime;
   786→        }
   787→
   788→        return JSON.stringify({
   789→            success: true,
   790→            guid: marker.guid
   791→        });
   792→    } catch (e) {
   793→        return JSON.stringify({ error: e.message });
   794→    }
   795→}
   796→
   797→function getMarkers() {
   798→    try {
   799→        var seq = app.project.activeSequence;
   800→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   801→
   802→        var markers = seq.markers;
   803→        var result = [];
   804→
   805→        for (var i = 0; i < markers.numMarkers; i++) {
   806→            var marker = markers[i];
   807→            result.push({
   808→                guid: marker.guid,
   809→                name: marker.name,
   810→                comments: marker.comments,
   811→                start: marker.start.seconds,
   812→                end: marker.end.seconds,
   813→                type: marker.type
   814→            });
   815→        }
   816→
   817→        return JSON.stringify(result);
   818→    } catch (e) {
   819→        return JSON.stringify({ error: e.message });
   820→    }
   821→}
   822→
   823→function deleteMarker(markerGuid) {
   824→    try {
   825→        var seq = app.project.activeSequence;
   826→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   827→
   828→        var markers = seq.markers;
   829→        for (var i = 0; i < markers.numMarkers; i++) {
   830→            if (markers[i].guid === markerGuid) {
   831→                markers[i].remove();
   832→                return JSON.stringify({ success: true });
   833→            }
   834→        }
   835→        return JSON.stringify({ error: "Marker not found" });
   836→    } catch (e) {
   837→        return JSON.stringify({ error: e.message });
   838→    }
   839→}
   840→
   841→function deleteAllMarkers() {
   842→    try {
   843→        var seq = app.project.activeSequence;
   844→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   845→
   846→        var markers = seq.markers;
   847→        var count = markers.numMarkers;
   848→
   849→        // Delete from end to beginning to avoid index shifting
   850→        for (var i = count - 1; i >= 0; i--) {
   851→            markers[i].remove();
   852→        }
   853→
   854→        return JSON.stringify({ success: true, deleted: count });
   855→    } catch (e) {
   856→        return JSON.stringify({ error: e.message });
   857→    }
   858→}
   859→
   860→function deleteMarkersByName(namePattern) {
   861→    try {
   862→        var seq = app.project.activeSequence;
   863→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   864→
   865→        var markers = seq.markers;
   866→        var deleted = 0;
   867→
   868→        for (var i = markers.numMarkers - 1; i >= 0; i--) {
   869→            if (markers[i].name && markers[i].name.indexOf(namePattern) !== -1) {
   870→                markers[i].remove();
   871→                deleted++;
   872→            }
   873→        }
   874→
   875→        return JSON.stringify({ success: true, deleted: deleted });
   876→    } catch (e) {
   877→        return JSON.stringify({ error: e.message });
   878→    }
   879→}
   880→
   881→// ============================================================================
   882→// COLOR LABEL OPERATIONS
   883→// ============================================================================
   884→
   885→function setClipColorLabel(trackType, trackIndex, clipIndex, colorIndex) {
   886→    try {
   887→        var clip;
   888→        if (trackType == "video") {
   889→            clip = app.project.activeSequence.videoTracks[trackIndex].clips[clipIndex];
   890→        } else if (trackType == "audio") {
   891→            clip = app.project.activeSequence.audioTracks[trackIndex].clips[clipIndex];
   892→        }
   893→
   894→        if (clip && clip.projectItem) {
   895→            clip.projectItem.setColorLabel(colorIndex);
   896→        }
   897→        return JSON.stringify({ success: true });
   898→    } catch (e) {
   899→        return JSON.stringify({ error: e.message });
   900→    }
   901→}
   902→
   903→function setProjectItemColorLabel(nodeId, colorIndex) {
   904→    try {
   905→        var item = findItemByNodeId(app.project.rootItem, nodeId);
   906→        if (item) {
   907→            item.setColorLabel(colorIndex);
   908→            return JSON.stringify({ success: true });
   909→        }
   910→        return JSON.stringify({ error: "Item not found" });
   911→    } catch (e) {
   912→        return JSON.stringify({ error: e.message });
   913→    }
   914→}
   915→
   916→// ============================================================================
   917→// SEQUENCE BUILDING (CORE v3.5 FUNCTIONALITY)
   918→// ============================================================================
   919→
   920→function buildSequenceFromCutList(cutListJson) {
   921→    try {
   922→        var cutList = JSON.parse(cutListJson);
   923→        var seq = app.project.activeSequence;
   924→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   925→
   926→        // Clone the sequence
   927→        var newSequenceName = seq.name + "_SPLICE";
   928→        seq.clone();
   929→
   930→        // Find the cloned sequence
   931→        var newSeq = null;
   932→        for (var i = app.project.sequences.numSequences - 1; i >= 0; i--) {
   933→            var s = app.project.sequences[i];
   934→            if (s.name.indexOf(seq.name) === 0 && s.sequenceID !== seq.sequenceID) {
   935→                newSeq = s;
   936→                break;
   937→            }
   938→        }
   939→
   940→        if (!newSeq) {
   941→            return JSON.stringify({ error: "Failed to clone sequence" });
   942→        }
   943→
   944→        newSeq.name = newSequenceName;
   945→        app.project.activeSequence = newSeq;
   946→
   947→        // Clear all clips from the new sequence
   948→        clearSequence();
   949→
   950→        // Insert segments
   951→        var currentPosition = 0;
   952→        var stats = {
   953→            segmentsInserted: 0,
   954→            totalDuration: 0
   955→        };
   956→
   957→        for (var i = 0; i < cutList.segments.length; i++) {
   958→            var segment = cutList.segments[i];
   959→
   960→            // Find the source project item
   961→            var sourceItem = null;
   962→            if (segment.sourcePath) {
   963→                sourceItem = findItemByPath(app.project.rootItem, segment.sourcePath);
   964→            }
   965→            if (!sourceItem && segment.sourceName) {
   966→                sourceItem = findItemByName(app.project.rootItem, segment.sourceName);
   967→            }
   968→
   969→            if (!sourceItem) continue;
   970→
   971→            // Set color label
   972→            if (segment.colorHint && SEGMENT_COLORS[segment.colorHint]) {
   973→                sourceItem.setColorLabel(SEGMENT_COLORS[segment.colorHint]);
   974→            } else if (segment.type && SEGMENT_COLORS[segment.type]) {
   975→                sourceItem.setColorLabel(SEGMENT_COLORS[segment.type]);
   976→            }
   977→
   978→            // Insert clip at current position
   979→            var targetTime = new Time();
   980→            targetTime.seconds = currentPosition;
   981→
   982→            newSeq.videoTracks[0].insertClip(sourceItem, targetTime);
   983→
   984→            // Set in/out points
   985→            var clipDuration = segment.outPoint - segment.inPoint;
   986→            var videoClips = newSeq.videoTracks[0].clips;
   987→            var insertedClip = videoClips[videoClips.numItems - 1];
   988→
   989→            if (insertedClip) {
   990→                var inTime = new Time();
   991→                inTime.seconds = segment.inPoint;
   992→                insertedClip.inPoint = inTime;
   993→
   994→                var outTime = new Time();
   995→                outTime.seconds = segment.outPoint;
   996→                insertedClip.outPoint = outTime;
   997→
   998→                // Set clip name if takeLabel provided
   999→                if (segment.takeLabel) {
  1000→                    insertedClip.name = segment.takeLabel;
  1001→                }
  1002→            }
  1003→
  1004→            currentPosition += clipDuration;
  1005→            stats.segmentsInserted++;
  1006→            stats.totalDuration += clipDuration;
  1007→        }
  1008→
  1009→        return JSON.stringify({
  1010→            success: true,
  1011→            sequenceName: newSequenceName,
  1012→            stats: stats
  1013→        });
  1014→    } catch (e) {
  1015→        return JSON.stringify({ error: e.message });
  1016→    }
  1017→}
  1018→
  1019→function clearSequence() {
  1020→    var seq = app.project.activeSequence;
  1021→    if (!seq) return false;
  1022→
  1023→    // Remove all video clips
  1024→    for (var t = 0; t < seq.videoTracks.numTracks; t++) {
  1025→        var clips = seq.videoTracks[t].clips;
  1026→        for (var i = clips.numItems - 1; i >= 0; i--) {
  1027→            clips[i].remove(false, false);
  1028→        }
  1029→    }
  1030→
  1031→    // Remove all audio clips
  1032→    for (var t = 0; t < seq.audioTracks.numTracks; t++) {
  1033→        var clips = seq.audioTracks[t].clips;
  1034→        for (var i = clips.numItems - 1; i >= 0; i--) {
  1035→            clips[i].remove(false, false);
  1036→        }
  1037→    }
  1038→
  1039→    return true;
  1040→}
  1041→
  1042→// ============================================================================
  1043→// WORK AREA
  1044→// ============================================================================
  1045→
  1046→function getWorkArea() {
  1047→    var seq = app.project.activeSequence;
  1048→    if (!seq) return JSON.stringify({ error: "No active sequence" });
  1049→
  1050→    return JSON.stringify({
  1051→        inPoint: seq.getInPoint(),
  1052→        outPoint: seq.getOutPoint()
  1053→    });
  1054→}
  1055→
  1056→function setWorkArea(inPoint, outPoint) {
  1057→    var seq = app.project.activeSequence;
  1058→    if (!seq) return JSON.stringify({ error: "No active sequence" });
  1059→
  1060→    seq.setInPoint(inPoint);
  1061→    seq.setOutPoint(outPoint);
  1062→    return JSON.stringify({ success: true });
  1063→}
  1064→
  1065→// ============================================================================
  1066→// AUDIO EXPORT
  1067→// ============================================================================
  1068→
  1069→function exportSequenceAudio(outputPath, inPoint, outPoint) {
  1070→    try {
  1071→        var seq = app.project.activeSequence;
  1072→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1073→
  1074→        // Use the AME (Adobe Media Encoder) for export
  1075→        var encoder = app.encoder;
  1076→        if (!encoder) {
  1077→            return JSON.stringify({ error: "Media Encoder not available" });
  1078→        }
  1079→
  1080→        // Create export preset for WAV
  1081→        var presetPath = encoder.getDefaultPresetPath();
  1082→
  1083→        // Queue the export
  1084→        encoder.encodeSequence(
  1085→            seq,
  1086→            outputPath,
  1087→            presetPath,
  1088→            0, // WorkAreaType: 0 = entire, 1 = work area
  1089→            false // removeOnCompletion
  1090→        );
  1091→
  1092→        return JSON.stringify({ success: true, outputPath: outputPath });
  1093→    } catch (e) {
  1094→        return JSON.stringify({ error: e.message });
  1095→    }
  1096→}
  1097→
  1098→/**
  1099→ * Export sequence audio for SPLICE analysis
  1100→ * Uses AME to export WAV audio to temp folder
  1101→ * @returns {Object} { success, outputPath } or { error }
  1102→ */
  1103→function exportSequenceAudioForAnalysis() {
  1104→    try {
  1105→        var seq = app.project.activeSequence;
  1106→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1107→
  1108→        // Generate temp file path
  1109→        var tempFolder = Folder.temp.fsName;
  1110→        var timestamp = new Date().getTime();
  1111→        var outputPath = tempFolder + "/splice_audio_" + timestamp + ".wav";
  1112→
  1113→        // Check if we have audio tracks with content
  1114→        var hasAudio = false;
  1115→        for (var i = 0; i < seq.audioTracks.numTracks; i++) {
  1116→            if (seq.audioTracks[i].clips.numItems > 0) {
  1117→                hasAudio = true;
  1118→                break;
  1119→            }
  1120→        }
  1121→
  1122→        if (!hasAudio) {
  1123→            return JSON.stringify({ error: "Sequence has no audio clips" });
  1124→        }
  1125→
  1126→        // Use AME for export if available
  1127→        if (app.encoder && app.encoder.encodeSequence) {
  1128→            // Find audio-only preset or use default
  1129→            var presetPath = null;
  1130→            try {
  1131→                // Try to find WAV preset in common locations
  1132→                var presetFolders = [
  1133→                    Folder.appData.fsName + "/Adobe/Common/AME/15.0/Presets",
  1134→                    Folder.appData.fsName + "/Adobe/Common/AME/14.0/Presets",
  1135→                    app.path + "/MediaIO/systempresets/58534430_4d756c74-6962697400000000/WAV 48kHz.epr"
  1136→                ];
  1137→
  1138→                for (var i = 0; i < presetFolders.length; i++) {
  1139→                    var presetFile = new File(presetFolders[i]);
  1140→                    if (presetFile.exists) {
  1141→                        presetPath = presetFile.fsName;
  1142→                        break;
  1143→                    }
  1144→                }
  1145→
  1146→                // Fall back to default preset
  1147→                if (!presetPath) {
  1148→                    presetPath = app.encoder.getDefaultPresetPath();
  1149→                }
  1150→            } catch (e) {
  1151→                presetPath = app.encoder.getDefaultPresetPath();
  1152→            }
  1153→
  1154→            // Start the encode
  1155→            var success = app.encoder.encodeSequence(
  1156→                seq,
  1157→                outputPath,
  1158→                presetPath,
  1159→                0, // WorkAreaType: 0 = entire sequence
  1160→                false // removeOnCompletion
  1161→            );
  1162→
  1163→            if (success) {
  1164→                return JSON.stringify({ success: true, outputPath: outputPath, method: "ame" });
  1165→            }
  1166→        }
  1167→
  1168→        // Fallback: Try to get the source audio path from first clip
  1169→        return getFirstClipAudioPath();
  1170→
  1171→    } catch (e) {
  1172→        return JSON.stringify({ error: e.message });
  1173→    }
  1174→}
  1175→
  1176→/**
  1177→ * Get the audio/video file path from the first clip in the timeline
  1178→ * Used as fallback when AME export is not available
  1179→ * @returns {Object} { success, path } or { error }
  1180→ */
  1181→function getFirstClipAudioPath() {
  1182→    try {
  1183→        var seq = app.project.activeSequence;
  1184→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1185→
  1186→        // First try audio tracks
  1187→        for (var i = 0; i < seq.audioTracks.numTracks; i++) {
  1188→            var track = seq.audioTracks[i];
  1189→            if (track.clips.numItems > 0) {
  1190→                var clip = track.clips[0];
  1191→                if (clip.projectItem && clip.projectItem.getMediaPath) {
  1192→                    var mediaPath = clip.projectItem.getMediaPath();
  1193→                    if (mediaPath && mediaPath.length > 0) {
  1194→                        return JSON.stringify({ success: true, path: mediaPath, method: "audio_track" });
  1195→                    }
  1196→                }
  1197→            }
  1198→        }
  1199→
  1200→        // Fall back to video tracks (which may have linked audio)
  1201→        for (var i = 0; i < seq.videoTracks.numTracks; i++) {
  1202→            var track = seq.videoTracks[i];
  1203→            if (track.clips.numItems > 0) {
  1204→                var clip = track.clips[0];
  1205→                if (clip.projectItem && clip.projectItem.getMediaPath) {
  1206→                    var mediaPath = clip.projectItem.getMediaPath();
  1207→                    if (mediaPath && mediaPath.length > 0) {
  1208→                        return JSON.stringify({ success: true, path: mediaPath, method: "video_track" });
  1209→                    }
  1210→                }
  1211→            }
  1212→        }
  1213→
  1214→        return JSON.stringify({ error: "No clips with media paths found in sequence" });
  1215→    } catch (e) {
  1216→        return JSON.stringify({ error: e.message });
  1217→    }
  1218→}
  1219→
  1220→// ============================================================================
  1221→// UTILITY FUNCTIONS
  1222→// ============================================================================
  1223→
  1224→function moveClipByNTracks(currentTrackId, clipStartTime, nTracksToMove, trackType) {
  1225→    var accuracy = 3;
  1226→    var search_start_time = clipStartTime.toFixed(accuracy);
  1227→
  1228→    if (trackType == "audio") {
  1229→        var numClipsInTrack = qe.project.getActiveSequence().getAudioTrackAt(currentTrackId).numItems;
  1230→        for (var j = 0; j < numClipsInTrack; j++) {
  1231→            if (qe.project.getActiveSequence().getAudioTrackAt(currentTrackId).getItemAt(j).start.secs.toFixed(accuracy) == search_start_time) {
  1232→                qe.project.getActiveSequence().getAudioTrackAt(currentTrackId).getItemAt(j).moveToTrack(0, nTracksToMove, "0");
  1233→                return true;
  1234→            }
  1235→        }
  1236→    } else if (trackType == "video") {
  1237→        var numClipsInTrack = qe.project.getActiveSequence().getVideoTrackAt(currentTrackId).numItems;
  1238→        for (var j = 0; j < numClipsInTrack; j++) {
  1239→            if (qe.project.getActiveSequence().getVideoTrackAt(currentTrackId).getItemAt(j).start.secs.toFixed(accuracy) == search_start_time) {
  1240→                qe.project.getActiveSequence().getVideoTrackAt(currentTrackId).getItemAt(j).moveToTrack(nTracksToMove, 0, "0");
  1241→                return true;
  1242→            }
  1243→        }
  1244→    }
  1245→    return false;
  1246→}
  1247→
  1248→function linkIdenticalClipsInTracks(videoTrackIndex, audioTrackIndex) {
  1249→    var selected_clips = app.project.activeSequence.getSelection();
  1250→    for (var i = 0; i < selected_clips.length; i++) {
  1251→        selected_clips[i].setSelected(false, false);
  1252→    }
  1253→
  1254→    var video_clips = app.project.activeSequence.videoTracks[videoTrackIndex].clips;
  1255→    var audio_clips = app.project.activeSequence.audioTracks[audioTrackIndex].clips;
  1256→
  1257→    for (var i = 0; i < video_clips.numItems; i++) {
  1258→        var video_clip = video_clips[i];
  1259→        var video_start = video_clip.start.seconds;
  1260→
  1261→        for (var j = 0; j < audio_clips.numItems; j++) {
  1262→            var audio_clip = audio_clips[j];
  1263→            var audio_start = audio_clip.start.seconds;
  1264→
  1265→            if (Math.abs(video_start - audio_start) < time_tolerance) {
  1266→                video_clip.setSelected(true, false);
  1267→                audio_clip.setSelected(true, false);
  1268→                app.project.activeSequence.linkSelection();
  1269→                video_clip.setSelected(false, false);
  1270→                audio_clip.setSelected(false, false);
  1271→                break;
  1272→            }
  1273→        }
  1274→    }
  1275→    return true;
  1276→}
  1277→
  1278→// ============================================================================
  1279→// ZOOM OPERATIONS (Phase 3)
  1280→// ============================================================================
  1281→
  1282→function addZoomMarker(startSeconds, scale, duration, easing) {
  1283→    try {
  1284→        var name = "ZOOM: " + scale + "%";
  1285→        var comments = "Duration: " + duration + "s | Easing: " + (easing || "ease-in-out");
  1286→        return createMarker(startSeconds, name, duration, comments, COLOR_LABELS.YELLOW);
  1287→    } catch (e) {
  1288→        return JSON.stringify({ error: e.message });
  1289→    }
  1290→}
  1291→
  1292→// ============================================================================
  1293→// CHAPTER OPERATIONS (Phase 3)
  1294→// ============================================================================
  1295→
  1296→function addChapterMarker(timeSeconds, title, description) {
  1297→    try {
  1298→        var seq = app.project.activeSequence;
  1299→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1300→
  1301→        var markers = seq.markers;
  1302→        var marker = markers.createMarker(timeSeconds);
  1303→
  1304→        marker.name = title;
  1305→        if (description) marker.comments = description;
  1306→        marker.setColorByIndex(COLOR_LABELS.BLUE);
  1307→        marker.setTypeAsChapter();
  1308→
  1309→        return JSON.stringify({
  1310→            success: true,
  1311→            guid: marker.guid
  1312→        });
  1313→    } catch (e) {
  1314→        return JSON.stringify({ error: e.message });
  1315→    }
  1316→}
  1317→
  1318→function getChapterMarkers() {
  1319→    try {
  1320→        var seq = app.project.activeSequence;
  1321→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1322→
  1323→        var markers = seq.markers;
  1324→        var chapters = [];
  1325→
  1326→        for (var i = 0; i < markers.numMarkers; i++) {
  1327→            var marker = markers[i];
  1328→            if (marker.type === "Chapter") {
  1329→                chapters.push({
  1330→                    guid: marker.guid,
  1331→                    name: marker.name,
  1332→                    comments: marker.comments,
  1333→                    start: marker.start.seconds
  1334→                });
  1335→            }
  1336→        }
  1337→
  1338→        return JSON.stringify(chapters);
  1339→    } catch (e) {
  1340→        return JSON.stringify({ error: e.message });
  1341→    }
  1342→}
  1343→
  1344→// ============================================================================
  1345→// UNDO OPERATIONS
  1346→// ============================================================================
  1347→
  1348→function undo() {
  1349→    app.project.undo();
  1350→    return true;
  1351→}
  1352→
  1353→function redo() {
  1354→    app.project.redo();
  1355→    return true;
  1356→}
  1357→
  1358→// ============================================================================
  1359→// DEBUG / LOGGING
  1360→// ============================================================================
  1361→
  1362→function log(message) {
  1363→    $.writeln("[SPLICE] " + message);
  1364→}
  1365→
  1366→function getDebugInfo() {
  1367→    return JSON.stringify({
  1368→        version: SPLICE_VERSION,
  1369→        hasActiveSequence: app.project.activeSequence ? true : false,
  1370→        sequenceName: app.project.activeSequence ? app.project.activeSequence.name : null,
  1371→        numSequences: app.project.sequences.numSequences,
  1372→        numProjectItems: app.project.rootItem.children.numItems
  1373→    });
  1374→}
  1375→
  1376→// Initialize on load
  1377→initialise();
  1378→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
