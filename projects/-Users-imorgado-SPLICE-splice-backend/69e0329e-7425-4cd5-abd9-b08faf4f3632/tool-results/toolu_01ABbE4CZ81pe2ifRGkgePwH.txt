     1→/**
     2→ * SPLICE CEP Host Script
     3→ * ExtendScript for Premiere Pro
     4→ *
     5→ * Provides all Premiere Pro API functions called via jsx.evalScript()
     6→ * Based on proven patterns from FireCut and SPLICE UXP builder
     7→ */
     8→
     9→// ============================================================================
    10→// GLOBAL CONSTANTS & STATE
    11→// ============================================================================
    12→var SPLICE_VERSION = "4.0.0";
    13→var TICKS_PER_SECOND = 254016000000;
    14→var time_tolerance = 0.01; // 10ms tolerance for clip matching
    15→var temp_bin = null;
    16→var sequence_default_timecode = null;
    17→
    18→// Color label indices (Premiere Pro standard)
    19→var COLOR_LABELS = {
    20→    NONE: 0,
    21→    VIOLET: 1,
    22→    IRIS: 2,
    23→    CARIBBEAN: 3,
    24→    LAVENDER: 4,
    25→    CERULEAN: 5,
    26→    FOREST: 6,
    27→    ROSE: 7,
    28→    MANGO: 8,
    29→    PURPLE: 9,
    30→    BLUE: 10,
    31→    TEAL: 11,
    32→    MAGENTA: 12,
    33→    TAN: 13,
    34→    GREEN: 14,
    35→    BROWN: 15,
    36→    YELLOW: 16
    37→};
    38→
    39→// Segment type to color mapping
    40→var SEGMENT_COLORS = {
    41→    speech: COLOR_LABELS.FOREST,
    42→    take: COLOR_LABELS.LAVENDER,
    43→    best_take: COLOR_LABELS.CERULEAN,
    44→    silence: COLOR_LABELS.VIOLET,
    45→    wide_shot: COLOR_LABELS.YELLOW,
    46→    speaker_a: COLOR_LABELS.MANGO,
    47→    speaker_b: COLOR_LABELS.CARIBBEAN
    48→};
    49→
    50→// Timecode display formats
    51→var TIMECODES = {
    52→    TIMEDISPLAY_Frames: 4
    53→};
    54→
    55→// Translation map for localized effect names
    56→var translations = {
    57→    "Motion": ["Motion", "Mouvement", "Bewegung", "Movimiento", "Movimento"],
    58→    "Transform": ["Transform", "Transformation", "Transformieren", "Transformar"],
    59→    "Scale": ["Scale", "Echelle", "Skalierung", "Escala"],
    60→    "Scale Height": ["Scale Height", "Hauteur de l'echelle", "Skalierungshoehe"],
    61→    "Scale Width": ["Scale Width", "Largeur de l'echelle", "Skalierungsbreite"],
    62→    "Position": ["Position", "Posicion", "Posicao"],
    63→    "Anchor Point": ["Anchor Point", "Point d'ancrage", "Ankerpunkt"],
    64→    "Rotation": ["Rotation", "Rotacion", "Rotacao"],
    65→    "Opacity": ["Opacity", "Opacite", "Deckkraft", "Opacidad"]
    66→};
    67→
    68→// Project item types
    69→var project_item_type = {
    70→    "clip": 1,
    71→    "bin": 2,
    72→    "root": 3,
    73→    "file": 4
    74→};
    75→
    76→// ============================================================================
    77→// INITIALIZATION
    78→// ============================================================================
    79→
    80→function initialise() {
    81→    storeDefaultTimecode();
    82→    return JSON.stringify({ success: true, version: SPLICE_VERSION });
    83→}
    84→
    85→function storeDefaultTimecode() {
    86→    if (app.project.activeSequence) {
    87→        sequence_default_timecode = app.project.activeSequence.getSettings().videoDisplayFormat;
    88→    }
    89→}
    90→
    91→function checkSequenceOpen() {
    92→    return app.project.activeSequence ? true : false;
    93→}
    94→
    95→function getVersion() {
    96→    return SPLICE_VERSION;
    97→}
    98→
    99→// ============================================================================
   100→// TIME CONVERSION UTILITIES
   101→// ============================================================================
   102→
   103→/**
   104→ * Get the actual frames per second from the sequence
   105→ * videoFrameRate.seconds gives seconds per frame, so we need to invert it
   106→ */
   107→function getActualFrameRate() {
   108→    var secsPerFrame = app.project.activeSequence.getSettings().videoFrameRate.seconds;
   109→    // secsPerFrame is e.g., 0.03333... for 30fps, so 1/secsPerFrame = 30
   110→    return 1 / secsPerFrame;
   111→}
   112→
   113→function quantise_time(time_seconds) {
   114→    // Get seconds per frame (e.g., 0.0333 for 30fps)
   115→    var secsPerFrame = app.project.activeSequence.getSettings().videoFrameRate.seconds;
   116→    // Round to nearest frame boundary
   117→    return secsPerFrame * Math.round(time_seconds / secsPerFrame);
   118→}
   119→
   120→function frames_to_time(number_of_frames) {
   121→    // seconds per frame * number of frames = total seconds
   122→    var secsPerFrame = app.project.activeSequence.getSettings().videoFrameRate.seconds;
   123→    return number_of_frames * secsPerFrame;
   124→}
   125→
   126→function frames_to_ticks(number_of_frames) {
   127→    // Convert frames to ticks: frames * seconds_per_frame * ticks_per_second
   128→    var secsPerFrame = app.project.activeSequence.getSettings().videoFrameRate.seconds;
   129→    return number_of_frames * secsPerFrame * TICKS_PER_SECOND;
   130→}
   131→
   132→function seconds_to_ticks(seconds) {
   133→    return seconds * TICKS_PER_SECOND;
   134→}
   135→
   136→function ticks_to_seconds(ticks) {
   137→    return ticks / TICKS_PER_SECOND;
   138→}
   139→
   140→function getVideoFrameRateInSeconds() {
   141→    return app.project.activeSequence.getSettings().videoFrameRate.seconds;
   142→}
   143→
   144→function secondsToCurrentTimecode(seconds) {
   145→    var seq = app.project.activeSequence;
   146→    if (seq) {
   147→        var t = new Time();
   148→        t.seconds = parseFloat(seconds);
   149→        var settings = app.project.activeSequence.getSettings();
   150→        return t.getFormatted(settings.videoFrameRate, settings.videoDisplayFormat);
   151→    }
   152→    return false;
   153→}
   154→
   155→// ============================================================================
   156→// TIMECODE FORMAT
   157→// ============================================================================
   158→
   159→function setTimecodeToFrames() {
   160→    var seq = app.project.activeSequence;
   161→    if (seq) {
   162→        var currentSeqSettings = app.project.activeSequence.getSettings();
   163→        if (currentSeqSettings.videoDisplayFormat != TIMECODES.TIMEDISPLAY_Frames) {
   164→            currentSeqSettings.videoDisplayFormat = TIMECODES.TIMEDISPLAY_Frames;
   165→            app.project.activeSequence.setSettings(currentSeqSettings);
   166→        }
   167→    }
   168→}
   169→
   170→function setTimecodeToDefault() {
   171→    var seq = app.project.activeSequence;
   172→    if (seq && sequence_default_timecode) {
   173→        var currentSeqSettings = app.project.activeSequence.getSettings();
   174→        currentSeqSettings.videoDisplayFormat = sequence_default_timecode;
   175→        app.project.activeSequence.setSettings(currentSeqSettings);
   176→    }
   177→}
   178→
   179→function getTimecodeFormat() {
   180→    return app.project.activeSequence.getSettings().videoDisplayFormat;
   181→}
   182→
   183→function setTimecodeFormat(format) {
   184→    format = parseInt(format);
   185→    var seq = app.project.activeSequence;
   186→    if (seq) {
   187→        var currentSeqSettings = app.project.activeSequence.getSettings();
   188→        currentSeqSettings.videoDisplayFormat = format;
   189→        app.project.activeSequence.setSettings(currentSeqSettings);
   190→    }
   191→    return true;
   192→}
   193→
   194→// ============================================================================
   195→// SEQUENCE & PROJECT OPERATIONS
   196→// ============================================================================
   197→
   198→function getActiveSequence() {
   199→    var seq = app.project.activeSequence;
   200→    if (!seq) return JSON.stringify({ error: "No active sequence" });
   201→
   202→    return JSON.stringify({
   203→        name: seq.name,
   204→        id: seq.sequenceID,
   205→        duration: seq.end,
   206→        videoTrackCount: seq.videoTracks.numTracks,
   207→        audioTrackCount: seq.audioTracks.numTracks,
   208→        frameRate: seq.getSettings().videoFrameRate.seconds,
   209→        width: seq.frameSizeHorizontal,
   210→        height: seq.frameSizeVertical
   211→    });
   212→}
   213→
   214→function getSequenceSettings() {
   215→    var seq = app.project.activeSequence;
   216→    if (!seq) return JSON.stringify({ error: "No active sequence" });
   217→
   218→    var settings = seq.getSettings();
   219→    return JSON.stringify({
   220→        frameRate: settings.videoFrameRate.seconds,
   221→        width: settings.videoFrameWidth,
   222→        height: settings.videoFrameHeight,
   223→        displayFormat: settings.videoDisplayFormat
   224→    });
   225→}
   226→
   227→function cloneSequence(newName) {
   228→    var seq = app.project.activeSequence;
   229→    if (!seq) return JSON.stringify({ error: "No active sequence" });
   230→
   231→    try {
   232→        // Clone the sequence
   233→        seq.clone();
   234→
   235→        // Find the cloned sequence (last one with matching name pattern)
   236→        var clonedSeq = null;
   237→        for (var i = app.project.sequences.numSequences - 1; i >= 0; i--) {
   238→            var s = app.project.sequences[i];
   239→            if (s.name.indexOf(seq.name) === 0 && s.sequenceID !== seq.sequenceID) {
   240→                clonedSeq = s;
   241→                break;
   242→            }
   243→        }
   244→
   245→        if (clonedSeq && newName) {
   246→            clonedSeq.name = newName;
   247→        }
   248→
   249→        return JSON.stringify({
   250→            success: true,
   251→            sequenceId: clonedSeq ? clonedSeq.sequenceID : null,
   252→            name: clonedSeq ? clonedSeq.name : newName
   253→        });
   254→    } catch (e) {
   255→        return JSON.stringify({ error: e.message });
   256→    }
   257→}
   258→
   259→function createNewSequence(name) {
   260→    try {
   261→        app.project.createNewSequence(name);
   262→        var seq = app.project.activeSequence;
   263→        return JSON.stringify({
   264→            success: true,
   265→            sequenceId: seq.sequenceID,
   266→            name: seq.name
   267→        });
   268→    } catch (e) {
   269→        return JSON.stringify({ error: e.message });
   270→    }
   271→}
   272→
   273→function setActiveSequence(sequenceId) {
   274→    for (var i = 0; i < app.project.sequences.numSequences; i++) {
   275→        if (app.project.sequences[i].sequenceID === sequenceId) {
   276→            app.project.activeSequence = app.project.sequences[i];
   277→            return JSON.stringify({ success: true });
   278→        }
   279→    }
   280→    return JSON.stringify({ error: "Sequence not found" });
   281→}
   282→
   283→// ============================================================================
   284→// RAZOR OPERATIONS
   285→// ============================================================================
   286→
   287→function razorSequenceAtFrames(frames) {
   288→    frames = String(frames);
   289→    setTimecodeToFrames();
   290→    qe.project.getActiveSequence().razor(frames);
   291→    return true;
   292→}
   293→
   294→function razorSequenceAtSeconds(seconds) {
   295→    var frames = parseInt(Math.round(seconds / app.project.activeSequence.getSettings().videoFrameRate.seconds)).toString();
   296→    razorSequenceAtFrames(frames);
   297→    return true;
   298→}
   299→
   300→function razorSequenceAtFramesArray(silences_array) {
   301→    setTimecodeToFrames();
   302→    silences_array = JSON.parse(silences_array);
   303→    for (var i = 0; i < silences_array.length; i++) {
   304→        for (var j = 0; j < silences_array[i].length; j++) {
   305→            var frames = String(silences_array[i][j]);
   306→            qe.project.getActiveSequence().razor(frames);
   307→        }
   308→    }
   309→    return true;
   310→}
   311→
   312→function razorTrackAtFrames(trackType, trackIndex, frames) {
   313→    frames = String(frames);
   314→    setTimecodeToFrames();
   315→    if (trackType == "video") {
   316→        qe.project.getActiveSequence().getVideoTrackAt(trackIndex).razor(frames);
   317→    } else if (trackType == "audio") {
   318→        qe.project.getActiveSequence().getAudioTrackAt(trackIndex).razor(frames);
   319→    }
   320→    return true;
   321→}
   322→
   323→function razorTrackAtSeconds(trackType, trackIndex, seconds) {
   324→    var frames = parseInt(Math.round(seconds / app.project.activeSequence.getSettings().videoFrameRate.seconds)).toString();
   325→    razorTrackAtFrames(trackType, trackIndex, frames);
   326→    return true;
   327→}
   328→
   329→// ============================================================================
   330→// CLIP OPERATIONS
   331→// ============================================================================
   332→
   333→function getClipsInTrack(trackIndex, trackType) {
   334→    var clips = [];
   335→    if (trackType == "audio") {
   336→        for (var i = 0; i < app.project.activeSequence.audioTracks[trackIndex].clips.numItems; i++) {
   337→            var clip = app.project.activeSequence.audioTracks[trackIndex].clips[i];
   338→            clips.push({
   339→                index: i,
   340→                name: clip.name,
   341→                start: clip.start.seconds,
   342→                end: clip.end.seconds,
   343→                duration: clip.duration.seconds,
   344→                inPoint: clip.inPoint.seconds,
   345→                outPoint: clip.outPoint.seconds,
   346→                mediaPath: clip.projectItem ? clip.projectItem.getMediaPath() : null
   347→            });
   348→        }
   349→    } else if (trackType == "video") {
   350→        for (var i = 0; i < app.project.activeSequence.videoTracks[trackIndex].clips.numItems; i++) {
   351→            var clip = app.project.activeSequence.videoTracks[trackIndex].clips[i];
   352→            clips.push({
   353→                index: i,
   354→                name: clip.name,
   355→                start: clip.start.seconds,
   356→                end: clip.end.seconds,
   357→                duration: clip.duration.seconds,
   358→                inPoint: clip.inPoint.seconds,
   359→                outPoint: clip.outPoint.seconds,
   360→                mediaPath: clip.projectItem ? clip.projectItem.getMediaPath() : null
   361→            });
   362→        }
   363→    }
   364→    return JSON.stringify(clips);
   365→}
   366→
   367→function getClipsInTrack_Timings_Seconds(trackIndex, trackType) {
   368→    var clips = [];
   369→    if (trackType == "audio") {
   370→        for (var i = 0; i < app.project.activeSequence.audioTracks[trackIndex].clips.numItems; i++) {
   371→            clips.push([
   372→                app.project.activeSequence.audioTracks[trackIndex].clips[i].start.seconds,
   373→                app.project.activeSequence.audioTracks[trackIndex].clips[i].end.seconds
   374→            ]);
   375→        }
   376→    } else if (trackType == "video") {
   377→        for (var i = 0; i < app.project.activeSequence.videoTracks[trackIndex].clips.numItems; i++) {
   378→            clips.push([
   379→                app.project.activeSequence.videoTracks[trackIndex].clips[i].start.seconds,
   380→                app.project.activeSequence.videoTracks[trackIndex].clips[i].end.seconds
   381→            ]);
   382→        }
   383→    }
   384→    return JSON.stringify(clips);
   385→}
   386→
   387→function deleteClipsAtSilencePointsInTrack(silences, trackType, trackIndex) {
   388→    silences = JSON.parse(silences);
   389→    var clips;
   390→    if (trackType == "video") {
   391→        clips = app.project.activeSequence.videoTracks[trackIndex].clips;
   392→    } else if (trackType == "audio") {
   393→        clips = app.project.activeSequence.audioTracks[trackIndex].clips;
   394→    }
   395→
   396→    var deleted = 0;
   397→    for (var i = clips.length - 1; i >= 0; i--) {
   398→        var clip = clips[i];
   399→        var start = clip.start.seconds;
   400→        var end = clip.end.seconds;
   401→        var center = (start + end) / 2;
   402→
   403→        for (var j = 0; j < silences.length; j++) {
   404→            var silence = silences[j];
   405→            var silenceCenter = (silence[0] + silence[1]) / 2;
   406→            if (silenceCenter > start && silenceCenter < end) {
   407→                clip.remove(false, false);
   408→                deleted++;
   409→                break;
   410→            }
   411→        }
   412→    }
   413→    return JSON.stringify({ deleted: deleted });
   414→}
   415→
   416→function makeRemainingClipsContiguousInTrack(silences, deltas, trackType, trackIndex) {
   417→    silences = JSON.parse(silences);
   418→    deltas = JSON.parse(deltas);
   419→
   420→    var clips;
   421→    if (trackType == "video") {
   422→        clips = app.project.activeSequence.videoTracks[trackIndex].clips;
   423→    } else if (trackType == "audio") {
   424→        clips = app.project.activeSequence.audioTracks[trackIndex].clips;
   425→    }
   426→
   427→    for (var i = 0; i < clips.length; i++) {
   428→        var clip = clips[i];
   429→        var end = clip.end.seconds;
   430→        var num_silences = -1;
   431→
   432→        for (var j = 0; j < silences.length; j++) {
   433→            if (end > silences[j][1]) {
   434→                num_silences++;
   435→            }
   436→        }
   437→
   438→        if (num_silences > -1 && num_silences < deltas.length) {
   439→            var delta = deltas[num_silences];
   440→            var t_start = clip.start;
   441→            t_start.seconds = t_start.seconds - delta;
   442→            clip.start = t_start;
   443→            var t_end = clip.end;
   444→            t_end.seconds = t_end.seconds - delta;
   445→            clip.end = t_end;
   446→        }
   447→    }
   448→    return JSON.stringify({ success: true });
   449→}
   450→
   451→function removeClipByIndex(trackType, trackIndex, clipIndex) {
   452→    try {
   453→        if (trackType == "video") {
   454→            app.project.activeSequence.videoTracks[trackIndex].clips[clipIndex].remove(false, false);
   455→        } else if (trackType == "audio") {
   456→            app.project.activeSequence.audioTracks[trackIndex].clips[clipIndex].remove(false, false);
   457→        }
   458→        return JSON.stringify({ success: true });
   459→    } catch (e) {
   460→        return JSON.stringify({ error: e.message });
   461→    }
   462→}
   463→
   464→function setClipInOutPoints(trackType, trackIndex, clipIndex, inPoint, outPoint) {
   465→    try {
   466→        var clip;
   467→        if (trackType == "video") {
   468→            clip = app.project.activeSequence.videoTracks[trackIndex].clips[clipIndex];
   469→        } else if (trackType == "audio") {
   470→            clip = app.project.activeSequence.audioTracks[trackIndex].clips[clipIndex];
   471→        }
   472→
   473→        if (inPoint !== null) {
   474→            var inTime = new Time();
   475→            inTime.seconds = inPoint;
   476→            clip.inPoint = inTime;
   477→        }
   478→        if (outPoint !== null) {
   479→            var outTime = new Time();
   480→            outTime.seconds = outPoint;
   481→            clip.outPoint = outTime;
   482→        }
   483→        return JSON.stringify({ success: true });
   484→    } catch (e) {
   485→        return JSON.stringify({ error: e.message });
   486→    }
   487→}
   488→
   489→function setClipStartEnd(trackType, trackIndex, clipIndex, startSeconds, endSeconds) {
   490→    try {
   491→        var clip;
   492→        if (trackType == "video") {
   493→            clip = app.project.activeSequence.videoTracks[trackIndex].clips[clipIndex];
   494→        } else if (trackType == "audio") {
   495→            clip = app.project.activeSequence.audioTracks[trackIndex].clips[clipIndex];
   496→        }
   497→
   498→        if (startSeconds !== null) {
   499→            var startTime = clip.start;
   500→            startTime.seconds = startSeconds;
   501→            clip.start = startTime;
   502→        }
   503→        if (endSeconds !== null) {
   504→            var endTime = clip.end;
   505→            endTime.seconds = endSeconds;
   506→            clip.end = endTime;
   507→        }
   508→        return JSON.stringify({ success: true });
   509→    } catch (e) {
   510→        return JSON.stringify({ error: e.message });
   511→    }
   512→}
   513→
   514→// ============================================================================
   515→// TRACK OPERATIONS
   516→// ============================================================================
   517→
   518→function getTrackNames(trackType) {
   519→    var ret = [];
   520→    if (trackType == "video") {
   521→        for (var i = 0; i < qe.project.getActiveSequence().numVideoTracks; i++) {
   522→            ret.push(qe.project.getActiveSequence().getVideoTrackAt(i).name);
   523→        }
   524→    } else if (trackType == "audio") {
   525→        for (var i = 0; i < qe.project.getActiveSequence().numAudioTracks; i++) {
   526→            ret.push(qe.project.getActiveSequence().getAudioTrackAt(i).name);
   527→        }
   528→    }
   529→    return JSON.stringify(ret);
   530→}
   531→
   532→function getNumTracks(trackType) {
   533→    if (trackType == "video") {
   534→        return app.project.activeSequence.videoTracks.numTracks;
   535→    } else if (trackType == "audio") {
   536→        return app.project.activeSequence.audioTracks.numTracks;
   537→    }
   538→    return 0;
   539→}
   540→
   541→function addVideoTrack() {
   542→    var trackId = qe.project.getActiveSequence().numVideoTracks;
   543→    qe.project.getActiveSequence().addTracks(1, trackId, 0, 0);
   544→    return trackId;
   545→}
   546→
   547→function addAudioTrack() {
   548→    var trackId = qe.project.getActiveSequence().numAudioTracks;
   549→    qe.project.getActiveSequence().addTracks(0, 0, 1, 1, trackId);
   550→    return trackId;
   551→}
   552→
   553→function removeVideoTrack(trackIndex) {
   554→    qe.project.getActiveSequence().removeVideoTrack(trackIndex);
   555→    return true;
   556→}
   557→
   558→function removeAudioTrack(trackIndex) {
   559→    qe.project.getActiveSequence().removeAudioTrack(trackIndex);
   560→    return true;
   561→}
   562→
   563→// ============================================================================
   564→// MUTE STATE
   565→// ============================================================================
   566→
   567→function getMuteState() {
   568→    var mute_state_video = [];
   569→    for (var i = 0; i < app.project.activeSequence.videoTracks.numTracks; i++) {
   570→        mute_state_video.push(app.project.activeSequence.videoTracks[i].isMuted());
   571→    }
   572→    var mute_state_audio = [];
   573→    for (var i = 0; i < app.project.activeSequence.audioTracks.numTracks; i++) {
   574→        mute_state_audio.push(app.project.activeSequence.audioTracks[i].isMuted());
   575→    }
   576→    return JSON.stringify({ audio: mute_state_audio, video: mute_state_video });
   577→}
   578→
   579→function setMuteState(mute_state) {
   580→    mute_state = JSON.parse(mute_state);
   581→    for (var i = 0; i < app.project.activeSequence.videoTracks.numTracks; i++) {
   582→        if (i < mute_state.video.length) {
   583→            app.project.activeSequence.videoTracks[i].setMute(mute_state.video[i]);
   584→        }
   585→    }
   586→    for (var i = 0; i < app.project.activeSequence.audioTracks.numTracks; i++) {
   587→        if (i < mute_state.audio.length) {
   588→            app.project.activeSequence.audioTracks[i].setMute(mute_state.audio[i]);
   589→        }
   590→    }
   591→    return true;
   592→}
   593→
   594→// ============================================================================
   595→// PROJECT ITEM OPERATIONS
   596→// ============================================================================
   597→
   598→function findItemByName(bin, name) {
   599→    for (var i = 0; i < bin.children.numItems; i++) {
   600→        if (bin.children[i].name === name) {
   601→            return bin.children[i];
   602→        }
   603→        if (bin.children[i].children !== undefined) {
   604→            var item = findItemByName(bin.children[i], name);
   605→            if (item) return item;
   606→        }
   607→    }
   608→    return null;
   609→}
   610→
   611→function findItemByPath(bin, path) {
   612→    for (var i = 0; i < bin.children.numItems; i++) {
   613→        var item = bin.children[i];
   614→        if (item.getMediaPath && item.getMediaPath() === path) {
   615→            return item;
   616→        }
   617→        if (item.children !== undefined) {
   618→            var found = findItemByPath(item, path);
   619→            if (found) return found;
   620→        }
   621→    }
   622→    return null;
   623→}
   624→
   625→function importFile(filePath) {
   626→    try {
   627→        var success = app.project.importFiles([filePath], true, app.project.rootItem, false);
   628→        if (success) {
   629→            // Find the imported item
   630→            var item = findItemByPath(app.project.rootItem, filePath);
   631→            return JSON.stringify({
   632→                success: true,
   633→                nodeId: item ? item.nodeId : null
   634→            });
   635→        }
   636→        return JSON.stringify({ error: "Import failed" });
   637→    } catch (e) {
   638→        return JSON.stringify({ error: e.message });
   639→    }
   640→}
   641→
   642→function getSpliceBin() {
   643→    var rootItemChildren = app.project.rootItem.children;
   644→    var spliceBin = null;
   645→
   646→    for (var i = 0; i < rootItemChildren.numItems; i++) {
   647→        if (rootItemChildren[i].name === "SPLICE" && rootItemChildren[i].type === 2) {
   648→            spliceBin = rootItemChildren[i];
   649→            break;
   650→        }
   651→    }
   652→
   653→    if (!spliceBin) {
   654→        app.project.rootItem.createBin("SPLICE");
   655→        return getSpliceBin();
   656→    }
   657→
   658→    return spliceBin;
   659→}
   660→
   661→function getAllProjectItems() {
   662→    var items = [];
   663→
   664→    function collectItems(bin, path) {
   665→        for (var i = 0; i < bin.children.numItems; i++) {
   666→            var item = bin.children[i];
   667→            var itemPath = path + "/" + item.name;
   668→
   669→            items.push({
   670→                nodeId: item.nodeId,
   671→                name: item.name,
   672→                type: item.type,
   673→                treePath: itemPath,
   674→                mediaPath: item.getMediaPath ? item.getMediaPath() : null
   675→            });
   676→
   677→            if (item.children !== undefined && item.type === 2) {
   678→                collectItems(item, itemPath);
   679→            }
   680→        }
   681→    }
   682→
   683→    collectItems(app.project.rootItem, "");
   684→    return JSON.stringify(items);
   685→}
   686→
   687→// ============================================================================
   688→// CLIP INSERTION
   689→// ============================================================================
   690→
   691→function insertClipAtTime(projectItemNodeId, trackIndex, startSeconds, trackType) {
   692→    try {
   693→        var item = findItemByNodeId(app.project.rootItem, projectItemNodeId);
   694→        if (!item) {
   695→            return JSON.stringify({ error: "Project item not found" });
   696→        }
   697→
   698→        var targetTime = new Time();
   699→        targetTime.seconds = startSeconds;
   700→
   701→        if (trackType === "video") {
   702→            app.project.activeSequence.videoTracks[trackIndex].insertClip(item, targetTime);
   703→        } else if (trackType === "audio") {
   704→            app.project.activeSequence.audioTracks[trackIndex].insertClip(item, targetTime);
   705→        }
   706→
   707→        return JSON.stringify({ success: true });
   708→    } catch (e) {
   709→        return JSON.stringify({ error: e.message });
   710→    }
   711→}
   712→
   713→function findItemByNodeId(bin, nodeId) {
   714→    for (var i = 0; i < bin.children.numItems; i++) {
   715→        if (bin.children[i].nodeId === nodeId) {
   716→            return bin.children[i];
   717→        }
   718→        if (bin.children[i].children !== undefined) {
   719→            var found = findItemByNodeId(bin.children[i], nodeId);
   720→            if (found) return found;
   721→        }
   722→    }
   723→    return null;
   724→}
   725→
   726→// ============================================================================
   727→// MARKER OPERATIONS
   728→// ============================================================================
   729→
   730→function createMarker(timeSeconds, name, duration, comments, colorIndex) {
   731→    try {
   732→        var seq = app.project.activeSequence;
   733→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   734→
   735→        var markers = seq.markers;
   736→        var marker = markers.createMarker(timeSeconds);
   737→
   738→        if (name) marker.name = name;
   739→        if (comments) marker.comments = comments;
   740→        if (colorIndex !== undefined) marker.setColorByIndex(colorIndex);
   741→        if (duration && duration > 0) {
   742→            // Set marker end time properly using a Time object
   743→            var endTime = new Time();
   744→            endTime.seconds = marker.start.seconds + duration;
   745→            marker.end = endTime;
   746→        }
   747→
   748→        return JSON.stringify({
   749→            success: true,
   750→            guid: marker.guid
   751→        });
   752→    } catch (e) {
   753→        return JSON.stringify({ error: e.message });
   754→    }
   755→}
   756→
   757→function getMarkers() {
   758→    try {
   759→        var seq = app.project.activeSequence;
   760→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   761→
   762→        var markers = seq.markers;
   763→        var result = [];
   764→
   765→        for (var i = 0; i < markers.numMarkers; i++) {
   766→            var marker = markers[i];
   767→            result.push({
   768→                guid: marker.guid,
   769→                name: marker.name,
   770→                comments: marker.comments,
   771→                start: marker.start.seconds,
   772→                end: marker.end.seconds,
   773→                type: marker.type
   774→            });
   775→        }
   776→
   777→        return JSON.stringify(result);
   778→    } catch (e) {
   779→        return JSON.stringify({ error: e.message });
   780→    }
   781→}
   782→
   783→function deleteMarker(markerGuid) {
   784→    try {
   785→        var seq = app.project.activeSequence;
   786→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   787→
   788→        var markers = seq.markers;
   789→        for (var i = 0; i < markers.numMarkers; i++) {
   790→            if (markers[i].guid === markerGuid) {
   791→                markers[i].remove();
   792→                return JSON.stringify({ success: true });
   793→            }
   794→        }
   795→        return JSON.stringify({ error: "Marker not found" });
   796→    } catch (e) {
   797→        return JSON.stringify({ error: e.message });
   798→    }
   799→}
   800→
   801→function deleteAllMarkers() {
   802→    try {
   803→        var seq = app.project.activeSequence;
   804→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   805→
   806→        var markers = seq.markers;
   807→        var count = markers.numMarkers;
   808→
   809→        // Delete from end to beginning to avoid index shifting
   810→        for (var i = count - 1; i >= 0; i--) {
   811→            markers[i].remove();
   812→        }
   813→
   814→        return JSON.stringify({ success: true, deleted: count });
   815→    } catch (e) {
   816→        return JSON.stringify({ error: e.message });
   817→    }
   818→}
   819→
   820→function deleteMarkersByName(namePattern) {
   821→    try {
   822→        var seq = app.project.activeSequence;
   823→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   824→
   825→        var markers = seq.markers;
   826→        var deleted = 0;
   827→
   828→        for (var i = markers.numMarkers - 1; i >= 0; i--) {
   829→            if (markers[i].name && markers[i].name.indexOf(namePattern) !== -1) {
   830→                markers[i].remove();
   831→                deleted++;
   832→            }
   833→        }
   834→
   835→        return JSON.stringify({ success: true, deleted: deleted });
   836→    } catch (e) {
   837→        return JSON.stringify({ error: e.message });
   838→    }
   839→}
   840→
   841→// ============================================================================
   842→// COLOR LABEL OPERATIONS
   843→// ============================================================================
   844→
   845→function setClipColorLabel(trackType, trackIndex, clipIndex, colorIndex) {
   846→    try {
   847→        var clip;
   848→        if (trackType == "video") {
   849→            clip = app.project.activeSequence.videoTracks[trackIndex].clips[clipIndex];
   850→        } else if (trackType == "audio") {
   851→            clip = app.project.activeSequence.audioTracks[trackIndex].clips[clipIndex];
   852→        }
   853→
   854→        if (clip && clip.projectItem) {
   855→            clip.projectItem.setColorLabel(colorIndex);
   856→        }
   857→        return JSON.stringify({ success: true });
   858→    } catch (e) {
   859→        return JSON.stringify({ error: e.message });
   860→    }
   861→}
   862→
   863→function setProjectItemColorLabel(nodeId, colorIndex) {
   864→    try {
   865→        var item = findItemByNodeId(app.project.rootItem, nodeId);
   866→        if (item) {
   867→            item.setColorLabel(colorIndex);
   868→            return JSON.stringify({ success: true });
   869→        }
   870→        return JSON.stringify({ error: "Item not found" });
   871→    } catch (e) {
   872→        return JSON.stringify({ error: e.message });
   873→    }
   874→}
   875→
   876→// ============================================================================
   877→// SEQUENCE BUILDING (CORE v3.5 FUNCTIONALITY)
   878→// ============================================================================
   879→
   880→function buildSequenceFromCutList(cutListJson) {
   881→    try {
   882→        var cutList = JSON.parse(cutListJson);
   883→        var seq = app.project.activeSequence;
   884→        if (!seq) return JSON.stringify({ error: "No active sequence" });
   885→
   886→        // Clone the sequence
   887→        var newSequenceName = seq.name + "_SPLICE";
   888→        seq.clone();
   889→
   890→        // Find the cloned sequence
   891→        var newSeq = null;
   892→        for (var i = app.project.sequences.numSequences - 1; i >= 0; i--) {
   893→            var s = app.project.sequences[i];
   894→            if (s.name.indexOf(seq.name) === 0 && s.sequenceID !== seq.sequenceID) {
   895→                newSeq = s;
   896→                break;
   897→            }
   898→        }
   899→
   900→        if (!newSeq) {
   901→            return JSON.stringify({ error: "Failed to clone sequence" });
   902→        }
   903→
   904→        newSeq.name = newSequenceName;
   905→        app.project.activeSequence = newSeq;
   906→
   907→        // Clear all clips from the new sequence
   908→        clearSequence();
   909→
   910→        // Insert segments
   911→        var currentPosition = 0;
   912→        var stats = {
   913→            segmentsInserted: 0,
   914→            totalDuration: 0
   915→        };
   916→
   917→        for (var i = 0; i < cutList.segments.length; i++) {
   918→            var segment = cutList.segments[i];
   919→
   920→            // Find the source project item
   921→            var sourceItem = null;
   922→            if (segment.sourcePath) {
   923→                sourceItem = findItemByPath(app.project.rootItem, segment.sourcePath);
   924→            }
   925→            if (!sourceItem && segment.sourceName) {
   926→                sourceItem = findItemByName(app.project.rootItem, segment.sourceName);
   927→            }
   928→
   929→            if (!sourceItem) continue;
   930→
   931→            // Set color label
   932→            if (segment.colorHint && SEGMENT_COLORS[segment.colorHint]) {
   933→                sourceItem.setColorLabel(SEGMENT_COLORS[segment.colorHint]);
   934→            } else if (segment.type && SEGMENT_COLORS[segment.type]) {
   935→                sourceItem.setColorLabel(SEGMENT_COLORS[segment.type]);
   936→            }
   937→
   938→            // Insert clip at current position
   939→            var targetTime = new Time();
   940→            targetTime.seconds = currentPosition;
   941→
   942→            newSeq.videoTracks[0].insertClip(sourceItem, targetTime);
   943→
   944→            // Set in/out points
   945→            var clipDuration = segment.outPoint - segment.inPoint;
   946→            var videoClips = newSeq.videoTracks[0].clips;
   947→            var insertedClip = videoClips[videoClips.numItems - 1];
   948→
   949→            if (insertedClip) {
   950→                var inTime = new Time();
   951→                inTime.seconds = segment.inPoint;
   952→                insertedClip.inPoint = inTime;
   953→
   954→                var outTime = new Time();
   955→                outTime.seconds = segment.outPoint;
   956→                insertedClip.outPoint = outTime;
   957→
   958→                // Set clip name if takeLabel provided
   959→                if (segment.takeLabel) {
   960→                    insertedClip.name = segment.takeLabel;
   961→                }
   962→            }
   963→
   964→            currentPosition += clipDuration;
   965→            stats.segmentsInserted++;
   966→            stats.totalDuration += clipDuration;
   967→        }
   968→
   969→        return JSON.stringify({
   970→            success: true,
   971→            sequenceName: newSequenceName,
   972→            stats: stats
   973→        });
   974→    } catch (e) {
   975→        return JSON.stringify({ error: e.message });
   976→    }
   977→}
   978→
   979→function clearSequence() {
   980→    var seq = app.project.activeSequence;
   981→    if (!seq) return false;
   982→
   983→    // Remove all video clips
   984→    for (var t = 0; t < seq.videoTracks.numTracks; t++) {
   985→        var clips = seq.videoTracks[t].clips;
   986→        for (var i = clips.numItems - 1; i >= 0; i--) {
   987→            clips[i].remove(false, false);
   988→        }
   989→    }
   990→
   991→    // Remove all audio clips
   992→    for (var t = 0; t < seq.audioTracks.numTracks; t++) {
   993→        var clips = seq.audioTracks[t].clips;
   994→        for (var i = clips.numItems - 1; i >= 0; i--) {
   995→            clips[i].remove(false, false);
   996→        }
   997→    }
   998→
   999→    return true;
  1000→}
  1001→
  1002→// ============================================================================
  1003→// WORK AREA
  1004→// ============================================================================
  1005→
  1006→function getWorkArea() {
  1007→    var seq = app.project.activeSequence;
  1008→    if (!seq) return JSON.stringify({ error: "No active sequence" });
  1009→
  1010→    return JSON.stringify({
  1011→        inPoint: seq.getInPoint(),
  1012→        outPoint: seq.getOutPoint()
  1013→    });
  1014→}
  1015→
  1016→function setWorkArea(inPoint, outPoint) {
  1017→    var seq = app.project.activeSequence;
  1018→    if (!seq) return JSON.stringify({ error: "No active sequence" });
  1019→
  1020→    seq.setInPoint(inPoint);
  1021→    seq.setOutPoint(outPoint);
  1022→    return JSON.stringify({ success: true });
  1023→}
  1024→
  1025→// ============================================================================
  1026→// AUDIO EXPORT
  1027→// ============================================================================
  1028→
  1029→function exportSequenceAudio(outputPath, inPoint, outPoint) {
  1030→    try {
  1031→        var seq = app.project.activeSequence;
  1032→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1033→
  1034→        // Use the AME (Adobe Media Encoder) for export
  1035→        var encoder = app.encoder;
  1036→        if (!encoder) {
  1037→            return JSON.stringify({ error: "Media Encoder not available" });
  1038→        }
  1039→
  1040→        // Create export preset for WAV
  1041→        var presetPath = encoder.getDefaultPresetPath();
  1042→
  1043→        // Queue the export
  1044→        encoder.encodeSequence(
  1045→            seq,
  1046→            outputPath,
  1047→            presetPath,
  1048→            0, // WorkAreaType: 0 = entire, 1 = work area
  1049→            false // removeOnCompletion
  1050→        );
  1051→
  1052→        return JSON.stringify({ success: true, outputPath: outputPath });
  1053→    } catch (e) {
  1054→        return JSON.stringify({ error: e.message });
  1055→    }
  1056→}
  1057→
  1058→/**
  1059→ * Export sequence audio for SPLICE analysis
  1060→ * Uses AME to export WAV audio to temp folder
  1061→ * @returns {Object} { success, outputPath } or { error }
  1062→ */
  1063→function exportSequenceAudioForAnalysis() {
  1064→    try {
  1065→        var seq = app.project.activeSequence;
  1066→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1067→
  1068→        // Generate temp file path
  1069→        var tempFolder = Folder.temp.fsName;
  1070→        var timestamp = new Date().getTime();
  1071→        var outputPath = tempFolder + "/splice_audio_" + timestamp + ".wav";
  1072→
  1073→        // Check if we have audio tracks with content
  1074→        var hasAudio = false;
  1075→        for (var i = 0; i < seq.audioTracks.numTracks; i++) {
  1076→            if (seq.audioTracks[i].clips.numItems > 0) {
  1077→                hasAudio = true;
  1078→                break;
  1079→            }
  1080→        }
  1081→
  1082→        if (!hasAudio) {
  1083→            return JSON.stringify({ error: "Sequence has no audio clips" });
  1084→        }
  1085→
  1086→        // Use AME for export if available
  1087→        if (app.encoder && app.encoder.encodeSequence) {
  1088→            // Find audio-only preset or use default
  1089→            var presetPath = null;
  1090→            try {
  1091→                // Try to find WAV preset in common locations
  1092→                var presetFolders = [
  1093→                    Folder.appData.fsName + "/Adobe/Common/AME/15.0/Presets",
  1094→                    Folder.appData.fsName + "/Adobe/Common/AME/14.0/Presets",
  1095→                    app.path + "/MediaIO/systempresets/58534430_4d756c74-6962697400000000/WAV 48kHz.epr"
  1096→                ];
  1097→
  1098→                for (var i = 0; i < presetFolders.length; i++) {
  1099→                    var presetFile = new File(presetFolders[i]);
  1100→                    if (presetFile.exists) {
  1101→                        presetPath = presetFile.fsName;
  1102→                        break;
  1103→                    }
  1104→                }
  1105→
  1106→                // Fall back to default preset
  1107→                if (!presetPath) {
  1108→                    presetPath = app.encoder.getDefaultPresetPath();
  1109→                }
  1110→            } catch (e) {
  1111→                presetPath = app.encoder.getDefaultPresetPath();
  1112→            }
  1113→
  1114→            // Start the encode
  1115→            var success = app.encoder.encodeSequence(
  1116→                seq,
  1117→                outputPath,
  1118→                presetPath,
  1119→                0, // WorkAreaType: 0 = entire sequence
  1120→                false // removeOnCompletion
  1121→            );
  1122→
  1123→            if (success) {
  1124→                return JSON.stringify({ success: true, outputPath: outputPath, method: "ame" });
  1125→            }
  1126→        }
  1127→
  1128→        // Fallback: Try to get the source audio path from first clip
  1129→        return getFirstClipAudioPath();
  1130→
  1131→    } catch (e) {
  1132→        return JSON.stringify({ error: e.message });
  1133→    }
  1134→}
  1135→
  1136→/**
  1137→ * Get the audio/video file path from the first clip in the timeline
  1138→ * Used as fallback when AME export is not available
  1139→ * @returns {Object} { success, path } or { error }
  1140→ */
  1141→function getFirstClipAudioPath() {
  1142→    try {
  1143→        var seq = app.project.activeSequence;
  1144→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1145→
  1146→        // First try audio tracks
  1147→        for (var i = 0; i < seq.audioTracks.numTracks; i++) {
  1148→            var track = seq.audioTracks[i];
  1149→            if (track.clips.numItems > 0) {
  1150→                var clip = track.clips[0];
  1151→                if (clip.projectItem && clip.projectItem.getMediaPath) {
  1152→                    var mediaPath = clip.projectItem.getMediaPath();
  1153→                    if (mediaPath && mediaPath.length > 0) {
  1154→                        return JSON.stringify({ success: true, path: mediaPath, method: "audio_track" });
  1155→                    }
  1156→                }
  1157→            }
  1158→        }
  1159→
  1160→        // Fall back to video tracks (which may have linked audio)
  1161→        for (var i = 0; i < seq.videoTracks.numTracks; i++) {
  1162→            var track = seq.videoTracks[i];
  1163→            if (track.clips.numItems > 0) {
  1164→                var clip = track.clips[0];
  1165→                if (clip.projectItem && clip.projectItem.getMediaPath) {
  1166→                    var mediaPath = clip.projectItem.getMediaPath();
  1167→                    if (mediaPath && mediaPath.length > 0) {
  1168→                        return JSON.stringify({ success: true, path: mediaPath, method: "video_track" });
  1169→                    }
  1170→                }
  1171→            }
  1172→        }
  1173→
  1174→        return JSON.stringify({ error: "No clips with media paths found in sequence" });
  1175→    } catch (e) {
  1176→        return JSON.stringify({ error: e.message });
  1177→    }
  1178→}
  1179→
  1180→// ============================================================================
  1181→// UTILITY FUNCTIONS
  1182→// ============================================================================
  1183→
  1184→function moveClipByNTracks(currentTrackId, clipStartTime, nTracksToMove, trackType) {
  1185→    var accuracy = 3;
  1186→    var search_start_time = clipStartTime.toFixed(accuracy);
  1187→
  1188→    if (trackType == "audio") {
  1189→        var numClipsInTrack = qe.project.getActiveSequence().getAudioTrackAt(currentTrackId).numItems;
  1190→        for (var j = 0; j < numClipsInTrack; j++) {
  1191→            if (qe.project.getActiveSequence().getAudioTrackAt(currentTrackId).getItemAt(j).start.secs.toFixed(accuracy) == search_start_time) {
  1192→                qe.project.getActiveSequence().getAudioTrackAt(currentTrackId).getItemAt(j).moveToTrack(0, nTracksToMove, "0");
  1193→                return true;
  1194→            }
  1195→        }
  1196→    } else if (trackType == "video") {
  1197→        var numClipsInTrack = qe.project.getActiveSequence().getVideoTrackAt(currentTrackId).numItems;
  1198→        for (var j = 0; j < numClipsInTrack; j++) {
  1199→            if (qe.project.getActiveSequence().getVideoTrackAt(currentTrackId).getItemAt(j).start.secs.toFixed(accuracy) == search_start_time) {
  1200→                qe.project.getActiveSequence().getVideoTrackAt(currentTrackId).getItemAt(j).moveToTrack(nTracksToMove, 0, "0");
  1201→                return true;
  1202→            }
  1203→        }
  1204→    }
  1205→    return false;
  1206→}
  1207→
  1208→function linkIdenticalClipsInTracks(videoTrackIndex, audioTrackIndex) {
  1209→    var selected_clips = app.project.activeSequence.getSelection();
  1210→    for (var i = 0; i < selected_clips.length; i++) {
  1211→        selected_clips[i].setSelected(false, false);
  1212→    }
  1213→
  1214→    var video_clips = app.project.activeSequence.videoTracks[videoTrackIndex].clips;
  1215→    var audio_clips = app.project.activeSequence.audioTracks[audioTrackIndex].clips;
  1216→
  1217→    for (var i = 0; i < video_clips.numItems; i++) {
  1218→        var video_clip = video_clips[i];
  1219→        var video_start = video_clip.start.seconds;
  1220→
  1221→        for (var j = 0; j < audio_clips.numItems; j++) {
  1222→            var audio_clip = audio_clips[j];
  1223→            var audio_start = audio_clip.start.seconds;
  1224→
  1225→            if (Math.abs(video_start - audio_start) < time_tolerance) {
  1226→                video_clip.setSelected(true, false);
  1227→                audio_clip.setSelected(true, false);
  1228→                app.project.activeSequence.linkSelection();
  1229→                video_clip.setSelected(false, false);
  1230→                audio_clip.setSelected(false, false);
  1231→                break;
  1232→            }
  1233→        }
  1234→    }
  1235→    return true;
  1236→}
  1237→
  1238→// ============================================================================
  1239→// ZOOM OPERATIONS (Phase 3)
  1240→// ============================================================================
  1241→
  1242→function addZoomMarker(startSeconds, scale, duration, easing) {
  1243→    try {
  1244→        var name = "ZOOM: " + scale + "%";
  1245→        var comments = "Duration: " + duration + "s | Easing: " + (easing || "ease-in-out");
  1246→        return createMarker(startSeconds, name, duration, comments, COLOR_LABELS.YELLOW);
  1247→    } catch (e) {
  1248→        return JSON.stringify({ error: e.message });
  1249→    }
  1250→}
  1251→
  1252→// ============================================================================
  1253→// CHAPTER OPERATIONS (Phase 3)
  1254→// ============================================================================
  1255→
  1256→function addChapterMarker(timeSeconds, title, description) {
  1257→    try {
  1258→        var seq = app.project.activeSequence;
  1259→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1260→
  1261→        var markers = seq.markers;
  1262→        var marker = markers.createMarker(timeSeconds);
  1263→
  1264→        marker.name = title;
  1265→        if (description) marker.comments = description;
  1266→        marker.setColorByIndex(COLOR_LABELS.BLUE);
  1267→        marker.setTypeAsChapter();
  1268→
  1269→        return JSON.stringify({
  1270→            success: true,
  1271→            guid: marker.guid
  1272→        });
  1273→    } catch (e) {
  1274→        return JSON.stringify({ error: e.message });
  1275→    }
  1276→}
  1277→
  1278→function getChapterMarkers() {
  1279→    try {
  1280→        var seq = app.project.activeSequence;
  1281→        if (!seq) return JSON.stringify({ error: "No active sequence" });
  1282→
  1283→        var markers = seq.markers;
  1284→        var chapters = [];
  1285→
  1286→        for (var i = 0; i < markers.numMarkers; i++) {
  1287→            var marker = markers[i];
  1288→            if (marker.type === "Chapter") {
  1289→                chapters.push({
  1290→                    guid: marker.guid,
  1291→                    name: marker.name,
  1292→                    comments: marker.comments,
  1293→                    start: marker.start.seconds
  1294→                });
  1295→            }
  1296→        }
  1297→
  1298→        return JSON.stringify(chapters);
  1299→    } catch (e) {
  1300→        return JSON.stringify({ error: e.message });
  1301→    }
  1302→}
  1303→
  1304→// ============================================================================
  1305→// UNDO OPERATIONS
  1306→// ============================================================================
  1307→
  1308→function undo() {
  1309→    app.project.undo();
  1310→    return true;
  1311→}
  1312→
  1313→function redo() {
  1314→    app.project.redo();
  1315→    return true;
  1316→}
  1317→
  1318→// ============================================================================
  1319→// DEBUG / LOGGING
  1320→// ============================================================================
  1321→
  1322→function log(message) {
  1323→    $.writeln("[SPLICE] " + message);
  1324→}
  1325→
  1326→function getDebugInfo() {
  1327→    return JSON.stringify({
  1328→        version: SPLICE_VERSION,
  1329→        hasActiveSequence: app.project.activeSequence ? true : false,
  1330→        sequenceName: app.project.activeSequence ? app.project.activeSequence.name : null,
  1331→        numSequences: app.project.sequences.numSequences,
  1332→        numProjectItems: app.project.rootItem.children.numItems
  1333→    });
  1334→}
  1335→
  1336→// Initialize on load
  1337→initialise();
  1338→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
