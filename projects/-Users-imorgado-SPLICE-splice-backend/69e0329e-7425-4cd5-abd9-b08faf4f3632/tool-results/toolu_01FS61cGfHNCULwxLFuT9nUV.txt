     1â†’/**
     2â†’ * SPLICE CEP Panel - Main Entry Point
     3â†’ * v4.0.0 - CEP Migration
     4â†’ */
     5â†’
     6â†’// ============================================================================
     7â†’// CACHED DOM ELEMENTS
     8â†’// ============================================================================
     9â†’const ui = {};
    10â†’
    11â†’function cacheUIElements() {
    12â†’    ui.status = document.getElementById('status');
    13â†’    ui.goBtn = document.getElementById('goBtn');
    14â†’    ui.optionsToggle = document.getElementById('optionsToggle');
    15â†’    ui.optionsPanel = document.getElementById('optionsPanel');
    16â†’
    17â†’    // Sliders and options
    18â†’    ui.sensitivitySlider = document.getElementById('sensitivitySlider');
    19â†’    ui.sensitivityValue = document.getElementById('sensitivityValue');
    20â†’    ui.sourceOriginal = document.getElementById('sourceOriginal');
    21â†’    ui.sourceIsolated = document.getElementById('sourceIsolated');
    22â†’
    23â†’    // Feature toggles
    24â†’    ui.enableTakesDetection = document.getElementById('enableTakesDetection');
    25â†’    ui.enableJCut = document.getElementById('enableJCut');
    26â†’    ui.jcutSettings = document.getElementById('jcutSettings');
    27â†’    ui.jcutLeadIn = document.getElementById('jcutLeadIn');
    28â†’    ui.jcutLeadInValue = document.getElementById('jcutLeadInValue');
    29â†’    ui.jcutLeadOut = document.getElementById('jcutLeadOut');
    30â†’    ui.jcutLeadOutValue = document.getElementById('jcutLeadOutValue');
    31â†’
    32â†’    // Zoom settings
    33â†’    ui.enableZoom = document.getElementById('enableZoom');
    34â†’    ui.zoomSettings = document.getElementById('zoomSettings');
    35â†’    ui.zoomFrequency = document.getElementById('zoomFrequency');
    36â†’    ui.zoomPreset = document.getElementById('zoomPreset');
    37â†’    ui.zoomPlacement = document.getElementById('zoomPlacement');
    38â†’
    39â†’    // Chapter settings
    40â†’    ui.enableChapters = document.getElementById('enableChapters');
    41â†’    ui.chapterSettings = document.getElementById('chapterSettings');
    42â†’    ui.maxChapters = document.getElementById('maxChapters');
    43â†’    ui.minChapterLength = document.getElementById('minChapterLength');
    44â†’
    45â†’    // Progress
    46â†’    ui.progressContainer = document.getElementById('progressContainer');
    47â†’    ui.progressBar = document.getElementById('progressBar');
    48â†’    ui.progressText = document.getElementById('progressText');
    49â†’    ui.resultsEmpty = document.getElementById('resultsEmpty');
    50â†’
    51â†’    // Preview
    52â†’    ui.combinedPreview = document.getElementById('combinedPreview');
    53â†’    ui.previewList = document.getElementById('previewList');
    54â†’    ui.silenceCount = document.getElementById('silenceCount');
    55â†’    ui.takeCount = document.getElementById('takeCount');
    56â†’    ui.selectedCount = document.getElementById('selectedCount');
    57â†’    ui.selectAllSilences = document.getElementById('selectAllSilences');
    58â†’    ui.applyPreviewBtn = document.getElementById('applyPreviewBtn');
    59â†’    ui.cancelPreviewBtn = document.getElementById('cancelPreviewBtn');
    60â†’    ui.buildSequenceBtn = document.getElementById('buildSequenceBtn');
    61â†’
    62â†’    // Results
    63â†’    ui.zoomResults = document.getElementById('zoomResults');
    64â†’    ui.zoomList = document.getElementById('zoomList');
    65â†’    ui.chapterResults = document.getElementById('chapterResults');
    66â†’    ui.chapterList = document.getElementById('chapterList');
    67â†’    ui.copyYouTubeBtn = document.getElementById('copyYouTubeBtn');
    68â†’    ui.addChapterMarkersBtn = document.getElementById('addChapterMarkersBtn');
    69â†’
    70â†’    // Modals
    71â†’    ui.settingsBtn = document.getElementById('settingsBtn');
    72â†’    ui.settingsModal = document.getElementById('settingsModal');
    73â†’    ui.closeSettingsBtn = document.getElementById('closeSettingsBtn');
    74â†’    ui.loginModal = document.getElementById('loginModal');
    75â†’    ui.closeLoginBtn = document.getElementById('closeLoginBtn');
    76â†’    ui.licenseKeyInput = document.getElementById('licenseKeyInput');
    77â†’    ui.saveLoginBtn = document.getElementById('saveLoginBtn');
    78â†’
    79â†’    // Credit badge
    80â†’    ui.creditBadge = document.getElementById('creditBadge');
    81â†’
    82â†’    // Preset selector
    83â†’    ui.presetSelector = document.getElementById('presetSelector');
    84â†’}
    85â†’
    86â†’// ============================================================================
    87â†’// STATE MANAGEMENT
    88â†’// ============================================================================
    89â†’let previewSilences = [];
    90â†’let previewTakes = [];
    91â†’let currentChapters = [];
    92â†’let currentZooms = [];
    93â†’let selectedSilenceIndices = new Set();
    94â†’let isOperationInProgress = false;
    95â†’let lastDetectionResult = null;
    96â†’
    97â†’// ============================================================================
    98â†’// INITIALIZATION
    99â†’// ============================================================================
   100â†’document.addEventListener('DOMContentLoaded', async () => {
   101â†’    console.log('[SPLICE] Initializing CEP panel...');
   102â†’
   103â†’    // Cache DOM elements
   104â†’    cacheUIElements();
   105â†’
   106â†’    // Load settings
   107â†’    loadSettingsToUI();
   108â†’
   109â†’    // Initialize UI handlers
   110â†’    initOptionsToggle();
   111â†’    initSliders();
   112â†’    initFeatureToggles();
   113â†’    initPresetSelector();
   114â†’    initGoButton();
   115â†’    initPreviewHandlers();
   116â†’    initModals();
   117â†’    initCredits();
   118â†’    initHelpButton();
   119â†’
   120â†’    // Initialize offline detection
   121â†’    if (typeof initOfflineDetection === 'function') {
   122â†’        initOfflineDetection();
   123â†’    }
   124â†’
   125â†’    // Check JSX connection
   126â†’    await checkJSXConnection();
   127â†’
   128â†’    setStatus('Ready');
   129â†’    console.log('[SPLICE] CEP panel initialized');
   130â†’});
   131â†’
   132â†’// ============================================================================
   133â†’// JSX CONNECTION CHECK
   134â†’// ============================================================================
   135â†’async function checkJSXConnection() {
   136â†’    try {
   137â†’        const result = await jsx.call('getVersion');
   138â†’        console.log('[SPLICE] JSX connection OK, version:', result);
   139â†’        return true;
   140â†’    } catch (e) {
   141â†’        console.warn('[SPLICE] JSX connection failed:', e.message);
   142â†’        setStatus('Premiere Pro connection failed', true);
   143â†’        return false;
   144â†’    }
   145â†’}
   146â†’
   147â†’async function checkSequenceOpen() {
   148â†’    try {
   149â†’        const result = await jsx.call('checkSequenceOpen');
   150â†’        return result === true || result === 'true';
   151â†’    } catch {
   152â†’        return false;
   153â†’    }
   154â†’}
   155â†’
   156â†’// ============================================================================
   157â†’// OPTIONS TOGGLE
   158â†’// ============================================================================
   159â†’function initOptionsToggle() {
   160â†’    if (ui.optionsToggle && ui.optionsPanel) {
   161â†’        ui.optionsToggle.addEventListener('click', () => {
   162â†’            const isExpanded = ui.optionsPanel.classList.toggle('collapsed');
   163â†’            ui.optionsToggle.classList.toggle('expanded', !isExpanded);
   164â†’            saveSettings({ expandedOptions: !isExpanded });
   165â†’        });
   166â†’
   167â†’        // Restore state
   168â†’        const settings = getSettings();
   169â†’        if (!settings.expandedOptions) {
   170â†’            ui.optionsPanel.classList.add('collapsed');
   171â†’        } else {
   172â†’            ui.optionsToggle.classList.add('expanded');
   173â†’        }
   174â†’    }
   175â†’}
   176â†’
   177â†’// ============================================================================
   178â†’// SLIDERS
   179â†’// ============================================================================
   180â†’function initSliders() {
   181â†’    // Sensitivity slider
   182â†’    if (ui.sensitivitySlider && ui.sensitivityValue) {
   183â†’        ui.sensitivitySlider.addEventListener('input', () => {
   184â†’            ui.sensitivityValue.textContent = ui.sensitivitySlider.value;
   185â†’            saveSettings({ sensitivity: parseInt(ui.sensitivitySlider.value) });
   186â†’        });
   187â†’    }
   188â†’
   189â†’    // J-Cut sliders
   190â†’    if (ui.jcutLeadIn && ui.jcutLeadInValue) {
   191â†’        ui.jcutLeadIn.addEventListener('input', () => {
   192â†’            const val = (ui.jcutLeadIn.value / 100).toFixed(2);
   193â†’            ui.jcutLeadInValue.textContent = val + 's';
   194â†’            saveSettings({ jcutLeadIn: parseFloat(val) });
   195â†’        });
   196â†’    }
   197â†’
   198â†’    if (ui.jcutLeadOut && ui.jcutLeadOutValue) {
   199â†’        ui.jcutLeadOut.addEventListener('input', () => {
   200â†’            const val = (ui.jcutLeadOut.value / 100).toFixed(2);
   201â†’            ui.jcutLeadOutValue.textContent = val + 's';
   202â†’            saveSettings({ jcutLeadOut: parseFloat(val) });
   203â†’        });
   204â†’    }
   205â†’}
   206â†’
   207â†’// ============================================================================
   208â†’// FEATURE TOGGLES
   209â†’// ============================================================================
   210â†’function initFeatureToggles() {
   211â†’    // J-Cut toggle
   212â†’    if (ui.enableJCut && ui.jcutSettings) {
   213â†’        ui.enableJCut.addEventListener('change', () => {
   214â†’            ui.jcutSettings.classList.toggle('collapsed', !ui.enableJCut.checked);
   215â†’            saveSettings({ enableJCut: ui.enableJCut.checked });
   216â†’        });
   217â†’    }
   218â†’
   219â†’    // Zoom toggle
   220â†’    if (ui.enableZoom && ui.zoomSettings) {
   221â†’        ui.enableZoom.addEventListener('change', () => {
   222â†’            ui.zoomSettings.classList.toggle('collapsed', !ui.enableZoom.checked);
   223â†’            saveSettings({ enableZoom: ui.enableZoom.checked });
   224â†’        });
   225â†’    }
   226â†’
   227â†’    // Chapters toggle
   228â†’    if (ui.enableChapters && ui.chapterSettings) {
   229â†’        ui.enableChapters.addEventListener('change', () => {
   230â†’            ui.chapterSettings.classList.toggle('collapsed', !ui.enableChapters.checked);
   231â†’            saveSettings({ enableChapters: ui.enableChapters.checked });
   232â†’        });
   233â†’    }
   234â†’
   235â†’    // Takes detection toggle
   236â†’    if (ui.enableTakesDetection) {
   237â†’        ui.enableTakesDetection.addEventListener('change', () => {
   238â†’            saveSettings({ enableTakesDetection: ui.enableTakesDetection.checked });
   239â†’        });
   240â†’    }
   241â†’}
   242â†’
   243â†’// ============================================================================
   244â†’// PRESET SELECTOR
   245â†’// ============================================================================
   246â†’const PRESETS = {
   247â†’    podcast: { name: 'Podcast', sensitivity: 35, minSilence: 0.8, jcut: true, jcutLeadIn: 0.3, jcutLeadOut: 0.2 },
   248â†’    interview: { name: 'Interview', sensitivity: 50, minSilence: 0.5, jcut: true, jcutLeadIn: 0.25, jcutLeadOut: 0.15 },
   249â†’    reaction: { name: 'Reaction', sensitivity: 70, minSilence: 0.3, jcut: false },
   250â†’    tutorial: { name: 'Tutorial', sensitivity: 30, minSilence: 1.0, jcut: true, jcutLeadIn: 0.35, jcutLeadOut: 0.25 },
   251â†’    vlog: { name: 'Vlog', sensitivity: 65, minSilence: 0.35, jcut: false },
   252â†’    custom: { name: 'Custom', sensitivity: 50, minSilence: 0.5, jcut: false }
   253â†’};
   254â†’
   255â†’function initPresetSelector() {
   256â†’    if (!ui.presetSelector) return;
   257â†’
   258â†’    ui.presetSelector.addEventListener('change', () => {
   259â†’        const presetId = ui.presetSelector.value;
   260â†’        applyPreset(presetId);
   261â†’    });
   262â†’
   263â†’    // Load current preset
   264â†’    const settings = getSettings();
   265â†’    if (settings.activePreset) {
   266â†’        ui.presetSelector.value = settings.activePreset;
   267â†’    }
   268â†’}
   269â†’
   270â†’function applyPreset(presetId) {
   271â†’    const preset = PRESETS[presetId];
   272â†’    if (!preset) return;
   273â†’
   274â†’    // Apply to UI
   275â†’    if (ui.sensitivitySlider) {
   276â†’        ui.sensitivitySlider.value = preset.sensitivity;
   277â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = preset.sensitivity;
   278â†’    }
   279â†’
   280â†’    if (ui.enableJCut) {
   281â†’        ui.enableJCut.checked = preset.jcut || false;
   282â†’        if (ui.jcutSettings) {
   283â†’            ui.jcutSettings.classList.toggle('collapsed', !preset.jcut);
   284â†’        }
   285â†’    }
   286â†’
   287â†’    if (preset.jcutLeadIn && ui.jcutLeadIn) {
   288â†’        ui.jcutLeadIn.value = Math.round(preset.jcutLeadIn * 100);
   289â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = preset.jcutLeadIn + 's';
   290â†’    }
   291â†’
   292â†’    if (preset.jcutLeadOut && ui.jcutLeadOut) {
   293â†’        ui.jcutLeadOut.value = Math.round(preset.jcutLeadOut * 100);
   294â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = preset.jcutLeadOut + 's';
   295â†’    }
   296â†’
   297â†’    // Save
   298â†’    saveSettings({
   299â†’        activePreset: presetId,
   300â†’        sensitivity: preset.sensitivity,
   301â†’        enableJCut: preset.jcut || false,
   302â†’        jcutLeadIn: preset.jcutLeadIn || 0.3,
   303â†’        jcutLeadOut: preset.jcutLeadOut || 0.2
   304â†’    });
   305â†’
   306â†’    setStatus(`Applied ${preset.name} preset`);
   307â†’}
   308â†’
   309â†’// ============================================================================
   310â†’// LOAD SETTINGS TO UI
   311â†’// ============================================================================
   312â†’function loadSettingsToUI() {
   313â†’    const settings = getSettings();
   314â†’
   315â†’    if (ui.sensitivitySlider) {
   316â†’        ui.sensitivitySlider.value = settings.sensitivity;
   317â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = settings.sensitivity;
   318â†’    }
   319â†’
   320â†’    if (ui.enableTakesDetection) ui.enableTakesDetection.checked = settings.enableTakesDetection;
   321â†’    if (ui.enableJCut) ui.enableJCut.checked = settings.enableJCut;
   322â†’    if (ui.enableZoom) ui.enableZoom.checked = settings.enableZoom;
   323â†’    if (ui.enableChapters) ui.enableChapters.checked = settings.enableChapters;
   324â†’
   325â†’    if (ui.jcutSettings) ui.jcutSettings.classList.toggle('collapsed', !settings.enableJCut);
   326â†’    if (ui.zoomSettings) ui.zoomSettings.classList.toggle('collapsed', !settings.enableZoom);
   327â†’    if (ui.chapterSettings) ui.chapterSettings.classList.toggle('collapsed', !settings.enableChapters);
   328â†’
   329â†’    if (ui.jcutLeadIn) {
   330â†’        ui.jcutLeadIn.value = Math.round(settings.jcutLeadIn * 100);
   331â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = settings.jcutLeadIn + 's';
   332â†’    }
   333â†’    if (ui.jcutLeadOut) {
   334â†’        ui.jcutLeadOut.value = Math.round(settings.jcutLeadOut * 100);
   335â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = settings.jcutLeadOut + 's';
   336â†’    }
   337â†’
   338â†’    if (ui.presetSelector && settings.activePreset) {
   339â†’        ui.presetSelector.value = settings.activePreset;
   340â†’    }
   341â†’}
   342â†’
   343â†’// ============================================================================
   344â†’// GO BUTTON - MAIN WORKFLOW
   345â†’// ============================================================================
   346â†’function initGoButton() {
   347â†’    if (!ui.goBtn) return;
   348â†’
   349â†’    ui.goBtn.addEventListener('click', async () => {
   350â†’        if (isOperationInProgress) return;
   351â†’        await runDetection();
   352â†’    });
   353â†’}
   354â†’
   355â†’async function runDetection() {
   356â†’    if (isOperationInProgress) return;
   357â†’
   358â†’    // Check sequence
   359â†’    const hasSequence = await checkSequenceOpen();
   360â†’    if (!hasSequence) {
   361â†’        setStatus('Please open a sequence first', true);
   362â†’        return;
   363â†’    }
   364â†’
   365â†’    // Check online
   366â†’    if (!isOnline()) {
   367â†’        setStatus('Offline - Check your connection', true);
   368â†’        return;
   369â†’    }
   370â†’
   371â†’    isOperationInProgress = true;
   372â†’    ui.goBtn.disabled = true;
   373â†’    showProgress('Detecting silences...');
   374â†’
   375â†’    try {
   376â†’        const settings = getSettings();
   377â†’
   378â†’        // Get sequence info
   379â†’        const seqInfo = await jsx.call('getActiveSequence');
   380â†’        console.log('[SPLICE] Sequence info:', seqInfo);
   381â†’
   382â†’        // Export audio via JSX for silence detection
   383â†’        updateProgress(10, 'Exporting audio...');
   384â†’
   385â†’        let audioFilePath = null;
   386â†’        try {
   387â†’            // Get sequence info for audio export
   388â†’            const exportResult = await jsx.call('exportSequenceAudioForAnalysis');
   389â†’            if (exportResult && exportResult.success && exportResult.outputPath) {
   390â†’                audioFilePath = exportResult.outputPath;
   391â†’                console.log('[SPLICE] Audio exported to:', audioFilePath);
   392â†’            } else if (exportResult && exportResult.error) {
   393â†’                throw new Error(exportResult.error);
   394â†’            }
   395â†’        } catch (exportError) {
   396â†’            console.warn('[SPLICE] Audio export failed, trying fallback:', exportError.message);
   397â†’            // Try to get audio from first clip in timeline
   398â†’            try {
   399â†’                const clipInfo = await jsx.call('getFirstClipAudioPath');
   400â†’                if (clipInfo && clipInfo.path) {
   401â†’                    audioFilePath = clipInfo.path;
   402â†’                    console.log('[SPLICE] Using clip audio path:', audioFilePath);
   403â†’                }
   404â†’            } catch (clipError) {
   405â†’                console.warn('[SPLICE] Fallback audio path failed:', clipError.message);
   406â†’            }
   407â†’        }
   408â†’
   409â†’        if (!audioFilePath) {
   410â†’            throw new Error('Could not export or locate audio file. Please ensure sequence has audio tracks.');
   411â†’        }
   412â†’
   413â†’        // Call backend for silence detection with audio file path
   414â†’        updateProgress(30, 'Detecting silences...');
   415â†’        const silenceResponse = await fetchWithTimeout(
   416â†’            `${getBackendUrl()}/silences-rms`,
   417â†’            {
   418â†’                method: 'POST',
   419â†’                headers: getAuthHeaders(),
   420â†’                body: JSON.stringify({
   421â†’                    audioPath: audioFilePath,
   422â†’                    sensitivity: settings.sensitivity,
   423â†’                    minSilenceLength: settings.minSilenceLength || 0.5
   424â†’                })
   425â†’            }
   426â†’        );
   427â†’
   428â†’        if (!silenceResponse.ok) {
   429â†’            throw new Error(await parseErrorResponse(silenceResponse));
   430â†’        }
   431â†’
   432â†’        const silenceData = await silenceResponse.json();
   433â†’        previewSilences = silenceData.silences || [];
   434â†’
   435â†’        // Detect takes if enabled
   436â†’        if (settings.enableTakesDetection) {
   437â†’            updateProgress(60, 'Detecting takes...');
   438â†’            const analyzeResponse = await fetchWithTimeout(
   439â†’                `${getBackendUrl()}/analyze`,
   440â†’                {
   441â†’                    method: 'POST',
   442â†’                    headers: getAuthHeaders(),
   443â†’                    body: JSON.stringify({
   444â†’                        detectTakes: true
   445â†’                    })
   446â†’                }
   447â†’            );
   448â†’
   449â†’            if (analyzeResponse.ok) {
   450â†’                const analyzeData = await analyzeResponse.json();
   451â†’                previewTakes = analyzeData.takes || [];
   452â†’            }
   453â†’        }
   454â†’
   455â†’        // Detect chapters if enabled
   456â†’        if (settings.enableChapters) {
   457â†’            updateProgress(80, 'Detecting chapters...');
   458â†’            try {
   459â†’                const chapterResponse = await fetchWithTimeout(
   460â†’                    `${getBackendUrl()}/chapters`,
   461â†’                    {
   462â†’                        method: 'POST',
   463â†’                        headers: getAuthHeaders(),
   464â†’                        body: JSON.stringify({
   465â†’                            maxChapters: settings.maxChapters || 10,
   466â†’                            minChapterLength: settings.minChapterLength || 60
   467â†’                        })
   468â†’                    }
   469â†’                );
   470â†’
   471â†’                if (chapterResponse.ok) {
   472â†’                    const chapterData = await chapterResponse.json();
   473â†’                    currentChapters = chapterData.chapters || [];
   474â†’                }
   475â†’            } catch (e) {
   476â†’                console.warn('[SPLICE] Chapter detection failed:', e);
   477â†’            }
   478â†’        }
   479â†’
   480â†’        // Detect zoom points if enabled
   481â†’        if (settings.enableZoom) {
   482â†’            updateProgress(90, 'Detecting zoom points...');
   483â†’            try {
   484â†’                const zoomResponse = await fetchWithTimeout(
   485â†’                    `${getBackendUrl()}/zoom`,
   486â†’                    {
   487â†’                        method: 'POST',
   488â†’                        headers: getAuthHeaders(),
   489â†’                        body: JSON.stringify({
   490â†’                            frequency: settings.zoomFrequency || 'medium',
   491â†’                            preset: settings.zoomPreset || 'medium',
   492â†’                            placement: settings.zoomPlacement || 'sentence_start'
   493â†’                        })
   494â†’                    }
   495â†’                );
   496â†’
   497â†’                if (zoomResponse.ok) {
   498â†’                    const zoomData = await zoomResponse.json();
   499â†’                    currentZooms = zoomData.zoomPoints || [];
   500â†’                }
   501â†’            } catch (e) {
   502â†’                console.warn('[SPLICE] Zoom detection failed:', e);
   503â†’            }
   504â†’        }
   505â†’
   506â†’        // Store results
   507â†’        lastDetectionResult = {
   508â†’            silences: previewSilences,
   509â†’            takes: previewTakes,
   510â†’            chapters: currentChapters,
   511â†’            zooms: currentZooms
   512â†’        };
   513â†’
   514â†’        // Show preview
   515â†’        hideProgress();
   516â†’        showCombinedPreview();
   517â†’        setStatus(`Found ${previewSilences.length} silences, ${previewTakes.length} takes`);
   518â†’
   519â†’    } catch (error) {
   520â†’        console.error('[SPLICE] Detection error:', error);
   521â†’        setStatus('Detection failed: ' + error.message, true);
   522â†’        hideProgress();
   523â†’    } finally {
   524â†’        isOperationInProgress = false;
   525â†’        ui.goBtn.disabled = false;
   526â†’    }
   527â†’}
   528â†’
   529â†’// ============================================================================
   530â†’// PROGRESS UI
   531â†’// ============================================================================
   532â†’function showProgress(message) {
   533â†’    if (ui.progressContainer) ui.progressContainer.classList.remove('hidden');
   534â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   535â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
   536â†’    updateProgress(0, message);
   537â†’}
   538â†’
   539â†’function updateProgress(percent, message) {
   540â†’    if (ui.progressBar) ui.progressBar.style.width = percent + '%';
   541â†’    if (ui.progressText) ui.progressText.textContent = message || '';
   542â†’}
   543â†’
   544â†’function hideProgress() {
   545â†’    if (ui.progressContainer) ui.progressContainer.classList.add('hidden');
   546â†’}
   547â†’
   548â†’// ============================================================================
   549â†’// COMBINED PREVIEW
   550â†’// ============================================================================
   551â†’function showCombinedPreview() {
   552â†’    if (!ui.combinedPreview) return;
   553â†’
   554â†’    ui.combinedPreview.classList.remove('hidden');
   555â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   556â†’
   557â†’    // Update counts
   558â†’    if (ui.silenceCount) ui.silenceCount.textContent = previewSilences.length;
   559â†’    if (ui.takeCount) ui.takeCount.textContent = previewTakes.length;
   560â†’
   561â†’    // Select all by default
   562â†’    selectedSilenceIndices.clear();
   563â†’    previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
   564â†’    updateSelectedCount();
   565â†’
   566â†’    // Render preview list
   567â†’    renderPreviewList();
   568â†’
   569â†’    // Show chapter results if available
   570â†’    if (currentChapters.length > 0 && ui.chapterResults) {
   571â†’        ui.chapterResults.classList.remove('hidden');
   572â†’        renderChapterList();
   573â†’    }
   574â†’
   575â†’    // Show zoom results if available
   576â†’    if (currentZooms.length > 0 && ui.zoomResults) {
   577â†’        ui.zoomResults.classList.remove('hidden');
   578â†’    }
   579â†’}
   580â†’
   581â†’function renderPreviewList() {
   582â†’    if (!ui.previewList) return;
   583â†’
   584â†’    const html = [];
   585â†’
   586â†’    // Render silences
   587â†’    previewSilences.forEach((silence, i) => {
   588â†’        const isSelected = selectedSilenceIndices.has(i);
   589â†’        const duration = silence.end - silence.start;
   590â†’        html.push(`
   591â†’            <div class="preview-item ${isSelected ? '' : 'excluded'}" data-index="${i}" data-type="silence">
   592â†’                <input type="checkbox" class="preview-item-check" ${isSelected ? 'checked' : ''}>
   593â†’                <div class="preview-item-info">
   594â†’                    <div class="preview-item-time">${formatTime(silence.start)} - ${formatTime(silence.end)}</div>
   595â†’                    <div class="preview-item-duration">${duration.toFixed(2)}s silence</div>
   596â†’                </div>
   597â†’            </div>
   598â†’        `);
   599â†’    });
   600â†’
   601â†’    // Render takes
   602â†’    previewTakes.forEach((take, i) => {
   603â†’        html.push(`
   604â†’            <div class="preview-item take-item" data-index="${i}" data-type="take">
   605â†’                <div class="preview-item-icon">ðŸŽ¬</div>
   606â†’                <div class="preview-item-info">
   607â†’                    <div class="preview-item-time">${formatTime(take.start)} - ${formatTime(take.end)}</div>
   608â†’                    <div class="preview-item-label">${take.label || 'Take ' + (take.takeNumber || i + 1)}</div>
   609â†’                </div>
   610â†’            </div>
   611â†’        `);
   612â†’    });
   613â†’
   614â†’    ui.previewList.innerHTML = html.join('');
   615â†’
   616â†’    // Add click handlers
   617â†’    ui.previewList.querySelectorAll('.preview-item').forEach(item => {
   618â†’        item.addEventListener('click', (e) => {
   619â†’            const index = parseInt(item.dataset.index);
   620â†’            const type = item.dataset.type;
   621â†’
   622â†’            if (e.target.classList.contains('preview-item-check')) {
   623â†’                // Checkbox clicked
   624â†’                toggleSilenceSelection(index);
   625â†’            } else {
   626â†’                // Item clicked - seek to time
   627â†’                const data = type === 'silence' ? previewSilences[index] : previewTakes[index];
   628â†’                seekToTime(data.start);
   629â†’            }
   630â†’        });
   631â†’    });
   632â†’}
   633â†’
   634â†’function toggleSilenceSelection(index) {
   635â†’    if (selectedSilenceIndices.has(index)) {
   636â†’        selectedSilenceIndices.delete(index);
   637â†’    } else {
   638â†’        selectedSilenceIndices.add(index);
   639â†’    }
   640â†’    updateSelectedCount();
   641â†’    renderPreviewList();
   642â†’}
   643â†’
   644â†’function updateSelectedCount() {
   645â†’    if (ui.selectedCount) {
   646â†’        ui.selectedCount.textContent = selectedSilenceIndices.size;
   647â†’    }
   648â†’    if (ui.selectAllSilences) {
   649â†’        ui.selectAllSilences.checked = selectedSilenceIndices.size === previewSilences.length;
   650â†’    }
   651â†’}
   652â†’
   653â†’async function seekToTime(seconds) {
   654â†’    try {
   655â†’        // Use JSX to set playhead position
   656â†’        // Note: setPlayerPosition expects ticks as a string without quotes around the number value
   657â†’        const ticks = Math.round(seconds * 254016000000);
   658â†’        await jsx.evalScript(`app.project.activeSequence.setPlayerPosition(${ticks})`);
   659â†’    } catch (e) {
   660â†’        console.warn('[SPLICE] Seek failed:', e);
   661â†’    }
   662â†’}
   663â†’
   664â†’// ============================================================================
   665â†’// CHAPTER LIST
   666â†’// ============================================================================
   667â†’function renderChapterList() {
   668â†’    if (!ui.chapterList) return;
   669â†’
   670â†’    const html = currentChapters.map((chapter, i) => `
   671â†’        <div class="chapter-item" data-index="${i}">
   672â†’            <div class="chapter-time">${formatTime(chapter.startTime)}</div>
   673â†’            <div class="chapter-title">${chapter.title}</div>
   674â†’        </div>
   675â†’    `).join('');
   676â†’
   677â†’    ui.chapterList.innerHTML = html;
   678â†’
   679â†’    // Add click handlers
   680â†’    ui.chapterList.querySelectorAll('.chapter-item').forEach(item => {
   681â†’        item.addEventListener('click', () => {
   682â†’            const index = parseInt(item.dataset.index);
   683â†’            seekToTime(currentChapters[index].startTime);
   684â†’        });
   685â†’    });
   686â†’}
   687â†’
   688â†’// ============================================================================
   689â†’// PREVIEW HANDLERS
   690â†’// ============================================================================
   691â†’function initPreviewHandlers() {
   692â†’    // Select all checkbox
   693â†’    if (ui.selectAllSilences) {
   694â†’        ui.selectAllSilences.addEventListener('change', () => {
   695â†’            if (ui.selectAllSilences.checked) {
   696â†’                previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
   697â†’            } else {
   698â†’                selectedSilenceIndices.clear();
   699â†’            }
   700â†’            updateSelectedCount();
   701â†’            renderPreviewList();
   702â†’        });
   703â†’    }
   704â†’
   705â†’    // Apply button
   706â†’    if (ui.applyPreviewBtn) {
   707â†’        ui.applyPreviewBtn.addEventListener('click', applyPreviewAndMarkers);
   708â†’    }
   709â†’
   710â†’    // Cancel button
   711â†’    if (ui.cancelPreviewBtn) {
   712â†’        ui.cancelPreviewBtn.addEventListener('click', hidePreview);
   713â†’    }
   714â†’
   715â†’    // Build sequence button
   716â†’    if (ui.buildSequenceBtn) {
   717â†’        ui.buildSequenceBtn.addEventListener('click', buildSequence);
   718â†’    }
   719â†’
   720â†’    // Copy YouTube timestamps
   721â†’    if (ui.copyYouTubeBtn) {
   722â†’        ui.copyYouTubeBtn.addEventListener('click', copyYouTubeTimestamps);
   723â†’    }
   724â†’
   725â†’    // Add chapter markers
   726â†’    if (ui.addChapterMarkersBtn) {
   727â†’        ui.addChapterMarkersBtn.addEventListener('click', addChapterMarkers);
   728â†’    }
   729â†’
   730â†’    // Apply zoom markers
   731â†’    const applyZoomsBtn = document.getElementById('applyZoomsBtn');
   732â†’    if (applyZoomsBtn) {
   733â†’        applyZoomsBtn.addEventListener('click', applyZoomMarkers);
   734â†’    }
   735â†’}
   736â†’
   737â†’async function applyPreviewAndMarkers() {
   738â†’    if (isOperationInProgress) return;
   739â†’
   740â†’    isOperationInProgress = true;
   741â†’    setStatus('Adding markers...');
   742â†’
   743â†’    try {
   744â†’        // Add silence markers
   745â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
   746â†’        for (const silence of selectedSilences) {
   747â†’            await jsx.call('createMarker', silence.start, 'SPLICE: Silence', silence.end - silence.start, null, 1);
   748â†’        }
   749â†’
   750â†’        // Add take markers
   751â†’        for (const take of previewTakes) {
   752â†’            await jsx.call('createMarker', take.start, take.label || `Take ${take.takeNumber}`, take.end - take.start, null, 5);
   753â†’        }
   754â†’
   755â†’        setStatus(`Added ${selectedSilences.length + previewTakes.length} markers`);
   756â†’    } catch (error) {
   757â†’        setStatus('Failed to add markers: ' + error.message, true);
   758â†’    } finally {
   759â†’        isOperationInProgress = false;
   760â†’    }
   761â†’}
   762â†’
   763â†’function hidePreview() {
   764â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
   765â†’    if (ui.chapterResults) ui.chapterResults.classList.add('hidden');
   766â†’    if (ui.zoomResults) ui.zoomResults.classList.add('hidden');
   767â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.remove('hidden');
   768â†’    previewSilences = [];
   769â†’    previewTakes = [];
   770â†’    selectedSilenceIndices.clear();
   771â†’}
   772â†’
   773â†’async function buildSequence() {
   774â†’    if (isOperationInProgress) return;
   775â†’
   776â†’    isOperationInProgress = true;
   777â†’    setStatus('Building sequence...');
   778â†’
   779â†’    try {
   780â†’        const settings = getSettings();
   781â†’
   782â†’        // Create cut list from selected silences
   783â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
   784â†’
   785â†’        // Call backend to generate cut list
   786â†’        const cutListResponse = await fetchWithTimeout(
   787â†’            `${getBackendUrl()}/cut-list`,
   788â†’            {
   789â†’                method: 'POST',
   790â†’                headers: getAuthHeaders(),
   791â†’                body: JSON.stringify({
   792â†’                    silences: selectedSilences,
   793â†’                    takes: previewTakes,
   794â†’                    enableTakes: settings.enableTakesDetection,
   795â†’                    jCutOffset: settings.enableJCut ? settings.jcutLeadIn : 0,
   796â†’                    lCutOffset: settings.enableJCut ? settings.jcutLeadOut : 0
   797â†’                })
   798â†’            }
   799â†’        );
   800â†’
   801â†’        if (!cutListResponse.ok) {
   802â†’            throw new Error(await parseErrorResponse(cutListResponse));
   803â†’        }
   804â†’
   805â†’        const cutList = await cutListResponse.json();
   806â†’
   807â†’        // Build sequence via JSX
   808â†’        const result = await jsx.call('buildSequenceFromCutList', JSON.stringify(cutList));
   809â†’
   810â†’        if (result.success) {
   811â†’            setStatus(`Built sequence: ${result.sequenceName}`);
   812â†’            hidePreview();
   813â†’        } else {
   814â†’            throw new Error(result.error || 'Build failed');
   815â†’        }
   816â†’    } catch (error) {
   817â†’        setStatus('Build failed: ' + error.message, true);
   818â†’    } finally {
   819â†’        isOperationInProgress = false;
   820â†’    }
   821â†’}
   822â†’
   823â†’function copyYouTubeTimestamps() {
   824â†’    if (currentChapters.length === 0) return;
   825â†’
   826â†’    const timestamps = currentChapters.map(ch =>
   827â†’        `${formatTime(ch.startTime)} ${ch.title}`
   828â†’    ).join('\n');
   829â†’
   830â†’    navigator.clipboard.writeText(timestamps).then(() => {
   831â†’        setStatus('Copied YouTube timestamps');
   832â†’    }).catch(() => {
   833â†’        setStatus('Failed to copy', true);
   834â†’    });
   835â†’}
   836â†’
   837â†’async function addChapterMarkers() {
   838â†’    if (isOperationInProgress || currentChapters.length === 0) return;
   839â†’
   840â†’    isOperationInProgress = true;
   841â†’    setStatus('Adding chapter markers...');
   842â†’
   843â†’    try {
   844â†’        for (const chapter of currentChapters) {
   845â†’            await jsx.call('addChapterMarker', chapter.startTime, chapter.title, chapter.description);
   846â†’        }
   847â†’        setStatus(`Added ${currentChapters.length} chapter markers`);
   848â†’    } catch (error) {
   849â†’        setStatus('Failed to add markers: ' + error.message, true);
   850â†’    } finally {
   851â†’        isOperationInProgress = false;
   852â†’    }
   853â†’}
   854â†’
   855â†’/**
   856â†’ * Apply zoom point markers to the timeline
   857â†’ */
   858â†’async function applyZoomMarkers() {
   859â†’    if (isOperationInProgress || currentZooms.length === 0) return;
   860â†’
   861â†’    isOperationInProgress = true;
   862â†’    setStatus('Adding zoom markers...');
   863â†’
   864â†’    try {
   865â†’        for (const zoom of currentZooms) {
   866â†’            // Create a marker for each zoom point with zoom intensity info
   867â†’            const comment = `Zoom ${zoom.intensity || 'medium'} - ${zoom.reason || 'emphasis'}`;
   868â†’            await jsx.call('createMarker', zoom.time, 'SPLICE: Zoom', 0.5, comment, 3);
   869â†’        }
   870â†’        setStatus(`Added ${currentZooms.length} zoom markers`);
   871â†’    } catch (error) {
   872â†’        setStatus('Failed to add zoom markers: ' + error.message, true);
   873â†’    } finally {
   874â†’        isOperationInProgress = false;
   875â†’    }
   876â†’}
   877â†’
   878â†’// ============================================================================
   879â†’// MODALS
   880â†’// ============================================================================
   881â†’function initModals() {
   882â†’    // Settings modal
   883â†’    if (ui.settingsBtn && ui.settingsModal) {
   884â†’        ui.settingsBtn.addEventListener('click', () => {
   885â†’            ui.settingsModal.classList.remove('hidden');
   886â†’            // Sync remember options checkbox with current settings
   887â†’            const rememberOptions = document.getElementById('rememberOptions');
   888â†’            if (rememberOptions) {
   889â†’                rememberOptions.checked = getSettings().rememberOptions;
   890â†’            }
   891â†’        });
   892â†’    }
   893â†’
   894â†’    if (ui.closeSettingsBtn && ui.settingsModal) {
   895â†’        ui.closeSettingsBtn.addEventListener('click', () => {
   896â†’            ui.settingsModal.classList.add('hidden');
   897â†’        });
   898â†’    }
   899â†’
   900â†’    // Remember options checkbox
   901â†’    const rememberOptions = document.getElementById('rememberOptions');
   902â†’    if (rememberOptions) {
   903â†’        rememberOptions.addEventListener('change', () => {
   904â†’            saveSettings({ rememberOptions: rememberOptions.checked });
   905â†’            if (rememberOptions.checked) {
   906â†’                setStatus('Options will be remembered');
   907â†’            } else {
   908â†’                setStatus('Options will reset to defaults');
   909â†’            }
   910â†’        });
   911â†’    }
   912â†’
   913â†’    // Login modal
   914â†’    if (ui.creditBadge) {
   915â†’        ui.creditBadge.addEventListener('click', () => {
   916â†’            const settings = getSettings();
   917â†’            if (!settings.customerId) {
   918â†’                showLoginModal();
   919â†’            }
   920â†’        });
   921â†’    }
   922â†’
   923â†’    if (ui.closeLoginBtn && ui.loginModal) {
   924â†’        ui.closeLoginBtn.addEventListener('click', () => {
   925â†’            ui.loginModal.classList.add('hidden');
   926â†’        });
   927â†’    }
   928â†’
   929â†’    if (ui.saveLoginBtn) {
   930â†’        ui.saveLoginBtn.addEventListener('click', activateLicense);
   931â†’    }
   932â†’
   933â†’    // License lookup button
   934â†’    const lookupLicenseBtn = document.getElementById('lookupLicenseBtn');
   935â†’    if (lookupLicenseBtn) {
   936â†’        lookupLicenseBtn.addEventListener('click', lookupLicense);
   937â†’    }
   938â†’
   939â†’    // Close modals on backdrop click
   940â†’    document.querySelectorAll('.modal').forEach(modal => {
   941â†’        modal.addEventListener('click', (e) => {
   942â†’            if (e.target === modal) {
   943â†’                modal.classList.add('hidden');
   944â†’            }
   945â†’        });
   946â†’    });
   947â†’}
   948â†’
   949â†’function showLoginModal() {
   950â†’    if (ui.loginModal) ui.loginModal.classList.remove('hidden');
   951â†’}
   952â†’
   953â†’async function activateLicense() {
   954â†’    if (!ui.licenseKeyInput) return;
   955â†’
   956â†’    const licenseKey = ui.licenseKeyInput.value.trim();
   957â†’    if (!licenseKey) {
   958â†’        setStatus('Please enter a license key', true);
   959â†’        return;
   960â†’    }
   961â†’
   962â†’    try {
   963â†’        const response = await fetchWithTimeout(
   964â†’            `${getBackendUrl()}/license/activate`,
   965â†’            {
   966â†’                method: 'POST',
   967â†’                headers: { 'Content-Type': 'application/json' },
   968â†’                body: JSON.stringify({ key: licenseKey })
   969â†’            }
   970â†’        );
   971â†’
   972â†’        if (!response.ok) {
   973â†’            throw new Error(await parseErrorResponse(response));
   974â†’        }
   975â†’
   976â†’        const data = await response.json();
   977â†’        saveSettings({
   978â†’            customerId: data.customerId,
   979â†’            licenseKey: licenseKey
   980â†’        });
   981â†’
   982â†’        if (ui.loginModal) ui.loginModal.classList.add('hidden');
   983â†’        setStatus('License activated');
   984â†’        updateCredits();
   985â†’    } catch (error) {
   986â†’        setStatus('Activation failed: ' + error.message, true);
   987â†’    }
   988â†’}
   989â†’
   990â†’/**
   991â†’ * Look up license key by email address
   992â†’ */
   993â†’async function lookupLicense() {
   994â†’    const lookupEmailInput = document.getElementById('lookupEmailInput');
   995â†’    const licenseKeyInput = document.getElementById('licenseKeyInput');
   996â†’
   997â†’    if (!lookupEmailInput) return;
   998â†’
   999â†’    const email = lookupEmailInput.value.trim().toLowerCase();
  1000â†’    if (!email) {
  1001â†’        setStatus('Please enter your email address', true);
  1002â†’        return;
  1003â†’    }
  1004â†’
  1005â†’    // Basic email validation
  1006â†’    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  1007â†’    if (!emailRegex.test(email)) {
  1008â†’        setStatus('Please enter a valid email address', true);
  1009â†’        return;
  1010â†’    }
  1011â†’
  1012â†’    const lookupBtn = document.getElementById('lookupLicenseBtn');
  1013â†’    if (lookupBtn) {
  1014â†’        lookupBtn.disabled = true;
  1015â†’        lookupBtn.textContent = 'Looking up...';
  1016â†’    }
  1017â†’
  1018â†’    try {
  1019â†’        const response = await fetchWithTimeout(
  1020â†’            `${getBackendUrl()}/license/lookup`,
  1021â†’            {
  1022â†’                method: 'POST',
  1023â†’                headers: { 'Content-Type': 'application/json' },
  1024â†’                body: JSON.stringify({ email })
  1025â†’            },
  1026â†’            30000
  1027â†’        );
  1028â†’
  1029â†’        const result = await response.json();
  1030â†’
  1031â†’        if (result.success && result.key) {
  1032â†’            // Auto-fill the license key input
  1033â†’            if (licenseKeyInput) {
  1034â†’                licenseKeyInput.value = result.key;
  1035â†’            }
  1036â†’            setStatus('License found! Click Activate to continue.');
  1037â†’        } else {
  1038â†’            setStatus(result.error || result.message || 'No license found for this email', true);
  1039â†’        }
  1040â†’    } catch (error) {
  1041â†’        setStatus('Lookup failed: ' + error.message, true);
  1042â†’    } finally {
  1043â†’        if (lookupBtn) {
  1044â†’            lookupBtn.disabled = false;
  1045â†’            lookupBtn.textContent = 'Lookup';
  1046â†’        }
  1047â†’    }
  1048â†’}
  1049â†’
  1050â†’// ============================================================================
  1051â†’// CREDITS
  1052â†’// ============================================================================
  1053â†’function initCredits() {
  1054â†’    updateCredits();
  1055â†’}
  1056â†’
  1057â†’async function updateCredits() {
  1058â†’    if (!ui.creditBadge) return;
  1059â†’
  1060â†’    const settings = getSettings();
  1061â†’    if (!settings.customerId) {
  1062â†’        ui.creditBadge.className = 'credit-badge login';
  1063â†’        ui.creditBadge.textContent = 'Login';
  1064â†’        ui.creditBadge.style.display = 'flex';
  1065â†’        return;
  1066â†’    }
  1067â†’
  1068â†’    try {
  1069â†’        const response = await fetchWithTimeout(
  1070â†’            `${getBackendUrl()}/credits`,
  1071â†’            {
  1072â†’                method: 'GET',
  1073â†’                headers: getAuthHeaders()
  1074â†’            }
  1075â†’        );
  1076â†’
  1077â†’        if (response.ok) {
  1078â†’            const data = await response.json();
  1079â†’            const hours = (data.remainingMinutes / 60).toFixed(1);
  1080â†’            ui.creditBadge.textContent = `${hours}h`;
  1081â†’            ui.creditBadge.className = data.remainingMinutes < 60 ? 'credit-badge low' : 'credit-badge ok';
  1082â†’            ui.creditBadge.style.display = 'flex';
  1083â†’        } else {
  1084â†’            ui.creditBadge.className = 'credit-badge error';
  1085â†’            ui.creditBadge.textContent = 'Error';
  1086â†’            ui.creditBadge.style.display = 'flex';
  1087â†’        }
  1088â†’    } catch {
  1089â†’        ui.creditBadge.className = 'credit-badge error';
  1090â†’        ui.creditBadge.textContent = 'Offline';
  1091â†’        ui.creditBadge.style.display = 'flex';
  1092â†’    }
  1093â†’}
  1094â†’
  1095â†’// ============================================================================
  1096â†’// HELP BUTTON
  1097â†’// ============================================================================
  1098â†’function initHelpButton() {
  1099â†’    const helpBtn = document.getElementById('helpBtn');
  1100â†’    if (helpBtn) {
  1101â†’        helpBtn.addEventListener('click', () => {
  1102â†’            setStatus('Silence: removes quiet gaps | Takes: detects repeated content | Chapters: AI topic segmentation');
  1103â†’        });
  1104â†’    }
  1105â†’}
  1106â†’
  1107â†’// Export for debugging
  1108â†’window.spliceDebug = {
  1109â†’    getState: () => ({
  1110â†’        silences: previewSilences,
  1111â†’        takes: previewTakes,
  1112â†’        chapters: currentChapters,
  1113â†’        zooms: currentZooms,
  1114â†’        selected: Array.from(selectedSilenceIndices)
  1115â†’    }),
  1116â†’    jsx,
  1117â†’    runDetection
  1118â†’};
  1119â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
