     1→     1→/**
     2→     2→ * End-to-End License Flow Test
     3→     3→ *
     4→     4→ * Tests the complete flow:
     5→     5→ * 1. License key is generated for a customer (simulates webhook result)
     6→     6→ * 2. User enters license key in plugin
     7→     7→ * 3. Plugin activates key and gets customer ID
     8→     8→ * 4. Subsequent API calls work with customer ID
     9→     9→ *
    10→    10→ * NOTE: The actual Stripe webhook is tested in production with real Stripe events.
    11→    11→ * This test verifies the license service and API endpoints work correctly.
    12→    12→ */
    13→    13→
    14→    14→require('dotenv').config();
    15→    15→
    16→    16→const https = require('https');
    17→    17→const licenseService = require('../services/licenseService');
    18→    18→const usageTracking = require('../services/usageTracking');
    19→    19→
    20→    20→const BASE_URL = 'https://127.0.0.1:3847';
    21→    21→const agent = new https.Agent({ rejectUnauthorized: false });
    22→    22→
    23→    23→function request(method, path, body = null, headers = {}) {
    24→    24→  return new Promise((resolve, reject) => {
    25→    25→    const url = new URL(path, BASE_URL);
    26→    26→    const options = {
    27→    27→      method,
    28→    28→      hostname: url.hostname,
    29→    29→      port: url.port,
    30→    30→      path: url.pathname,
    31→    31→      headers: {
    32→    32→        'Content-Type': 'application/json',
    33→    33→        ...headers
    34→    34→      },
    35→    35→      agent
    36→    36→    };
    37→    37→
    38→    38→    const req = https.request(options, (res) => {
    39→    39→      let data = '';
    40→    40→      res.on('data', (chunk) => data += chunk);
    41→    41→      res.on('end', () => {
    42→    42→        try {
    43→    43→          resolve({ status: res.statusCode, data: JSON.parse(data) });
    44→    44→        } catch (e) {
    45→    45→          resolve({ status: res.statusCode, data: data });
    46→    46→        }
    47→    47→      });
    48→    48→    });
    49→    49→
    50→    50→    req.on('error', reject);
    51→    51→    if (body) req.write(JSON.stringify(body));
    52→    52→    req.end();
    53→    53→  });
    54→    54→}
    55→    55→
    56→    56→async function testFullFlow() {
    57→    57→  console.log('╔════════════════════════════════════════════════════════════════╗');
    58→    58→  console.log('║          SPLICE E2E License Flow Test                          ║');
    59→    59→  console.log('╚════════════════════════════════════════════════════════════════╝\n');
    60→    60→
    61→    61→  const testCustomerId = `cus_e2e_test_${Date.now()}`;
    62→    62→  let generatedKey = null;
    63→    63→
    64→    64→  // Step 1: Generate license key directly (simulates what webhook does)
    65→    65→  console.log('Step 1: Generating license key (simulates Stripe webhook)...');
    66→    66→
    67→    67→  try {
    68→    68→    // Create user first (as webhook would do via updateTier)
    69→    69→    await usageTracking.updateTier(testCustomerId, 'starter');
    70→    70→    console.log(`  ✓ Created user with starter tier`);
    71→    71→
    72→    72→    // Generate license key (as webhook would do)
    73→    73→    const keyResult = await licenseService.generateLicenseKey(testCustomerId);
    74→    74→    if (keyResult.success) {
    75→    75→      generatedKey = keyResult.key;
    76→    76→      console.log(`  ✓ License key generated: ${generatedKey}`);
    77→    77→    } else {
    78→    78→      console.log(`  ✗ Failed to generate key: ${keyResult.error}`);
    79→    79→      return false;
    80→    80→    }
    81→    81→  } catch (err) {
    82→    82→    console.log(`  ✗ Error: ${err.message}`);
    83→    83→    return false;
    84→    84→  }
    85→    85→
    86→    86→  // Step 2: Get the generated license key via API
    87→    87→  console.log('\nStep 2: Retrieving license key via API...');
    88→    88→
    89→    89→  try {
    90→    90→    const keyRes = await request('GET', '/license/key', null, {
    91→    91→      'x-stripe-customer-id': testCustomerId
    92→    92→    });
    93→    93→
    94→    94→    if (keyRes.status === 200 && keyRes.data.success && keyRes.data.key) {
    95→    95→      generatedKey = keyRes.data.key;
    96→    96→      console.log(`  ✓ License key retrieved: ${generatedKey}`);
    97→    97→    } else {
    98→    98→      console.log(`  ✗ Failed to retrieve key: ${JSON.stringify(keyRes.data)}`);
    99→    99→      return false;
   100→   100→    }
   101→   101→  } catch (err) {
   102→   102→    console.log(`  ✗ Key retrieval error: ${err.message}`);
   103→   103→    return false;
   104→   104→  }
   105→   105→
   106→   106→  // Step 3: Activate the license key (as the plugin would)
   107→   107→  console.log('\nStep 3: Activating license key (simulating plugin)...');
   108→   108→
   109→   109→  try {
   110→   110→    const activateRes = await request('POST', '/license/activate', {
   111→   111→      key: generatedKey
   112→   112→    });
   113→   113→
   114→   114→    if (activateRes.status === 200 && activateRes.data.success) {
   115→   115→      console.log(`  ✓ License activated successfully`);
   116→   116→      console.log(`    - Customer ID: ${activateRes.data.customerId}`);
   117→   117→      console.log(`    - Tier: ${activateRes.data.tierName} (${activateRes.data.tier})`);
   118→   118→      console.log(`    - Hours Remaining: ${activateRes.data.hoursRemaining}`);
   119→   119→      console.log(`    - Hours Total: ${activateRes.data.hoursTotal}`);
   120→   120→
   121→   121→      // Verify the customer ID matches
   122→   122→      if (activateRes.data.customerId !== testCustomerId) {
   123→   123→        console.log(`  ✗ Customer ID mismatch! Expected ${testCustomerId}, got ${activateRes.data.customerId}`);
   124→   124→        return false;
   125→   125→      }
   126→   126→    } else {
   127→   127→      console.log(`  ✗ Activation failed: ${JSON.stringify(activateRes.data)}`);
   128→   128→      return false;
   129→   129→    }
   130→   130→  } catch (err) {
   131→   131→    console.log(`  ✗ Activation error: ${err.message}`);
   132→   132→    return false;
   133→   133→  }
   134→   134→
   135→   135→  // Step 4: Verify credits endpoint works with customer ID
   136→   136→  console.log('\nStep 4: Verifying credits endpoint with customer ID...');
   137→   137→
   138→   138→  try {
   139→   139→    const creditsRes = await request('GET', '/credits', null, {
   140→   140→      'x-stripe-customer-id': testCustomerId
   141→   141→    });
   142→   142→
   143→   143→    if (creditsRes.status === 200 && creditsRes.data.success) {
   144→   144→      console.log(`  ✓ Credits retrieved successfully`);
   145→   145→      console.log(`    - Hours Remaining: ${creditsRes.data.hoursRemaining}`);
   146→   146→      console.log(`    - Tier: ${creditsRes.data.tierName}`);
   147→   147→    } else {
   148→   148→      console.log(`  ✗ Credits failed: ${JSON.stringify(creditsRes.data)}`);
   149→   149→      return false;
   150→   150→    }
   151→   151→  } catch (err) {
   152→   152→    console.log(`  ✗ Credits error: ${err.message}`);
   153→   153→    return false;
   154→   154→  }
   155→   155→
   156→   156→  // Step 5: Test that an invalid key is rejected
   157→   157→  console.log('\nStep 5: Verifying invalid key rejection...');
   158→   158→
   159→   159→  try {
   160→   160→    const invalidRes = await request('POST', '/license/activate', {
   161→   161→      key: 'SPLICE-FAKE-FAKE-FAKE'
   162→   162→    });
   163→   163→
   164→   164→    if (invalidRes.status === 400 && invalidRes.data.error) {
   165→   165→      console.log(`  ✓ Invalid key correctly rejected: ${invalidRes.data.error}`);
   166→   166→    } else {
   167→   167→      console.log(`  ✗ Invalid key was not rejected!`);
   168→   168→      return false;
   169→   169→    }
   170→   170→  } catch (err) {
   171→   171→    console.log(`  ✗ Error: ${err.message}`);
   172→   172→    return false;
   173→   173→  }
   174→   174→
   175→   175→  // Step 6: Test that lowercase key works (normalization)
   176→   176→  console.log('\nStep 6: Verifying key normalization (lowercase)...');
   177→   177→
   178→   178→  try {
   179→   179→    const lowercaseRes = await request('POST', '/license/activate', {
   180→   180→      key: generatedKey.toLowerCase()
   181→   181→    });
   182→   182→
   183→   183→    if (lowercaseRes.status === 200 && lowercaseRes.data.success) {
   184→   184→      console.log(`  ✓ Lowercase key normalized and accepted`);
   185→   185→    } else {
   186→   186→      console.log(`  ✗ Lowercase key rejected: ${JSON.stringify(lowercaseRes.data)}`);
   187→   187→      return false;
   188→   188→    }
   189→   189→  } catch (err) {
   190→   190→    console.log(`  ✗ Error: ${err.message}`);
   191→   191→    return false;
   192→   192→  }
   193→   193→
   194→   194→  return true;
   195→   195→}
   196→   196→
   197→   197→async function main() {
   198→   198→  try {
   199→   199→    const success = await testFullFlow();
   200→   200→
   201→   201→    console.log('\n╔════════════════════════════════════════════════════════════════╗');
   202→   202→    if (success) {
   203→   203→      console.log('║  ✓ ALL E2E TESTS PASSED - Full license flow working!          ║');
   204→   204→    } else {
   205→   205→      console.log('║  ✗ SOME TESTS FAILED - Check output above                     ║');
   206→   206→    }
   207→   207→    console.log('╚════════════════════════════════════════════════════════════════╝');
   208→   208→
   209→   209→    process.exit(success ? 0 : 1);
   210→   210→  } catch (err) {
   211→   211→    console.error('Test error:', err);
   212→   212→    process.exit(1);
   213→   213→  }
   214→   214→}
   215→   215→
   216→   216→main();
   217→   217→
   218→
   219→<system-reminder>
   220→Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
   221→</system-reminder>
   222→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
