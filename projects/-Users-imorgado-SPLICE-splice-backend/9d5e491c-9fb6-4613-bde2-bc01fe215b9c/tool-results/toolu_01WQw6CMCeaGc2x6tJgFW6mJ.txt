     1→/**
     2→ * Comprehensive Stutter Detection Tests
     3→ *
     4→ * Tests parity with Firecut's stutter detection behavior:
     5→ * - Single-character word stutters ("I I I think")
     6→ * - Short word stutters ("the the the")
     7→ * - Gap-based detection (maxGapMs)
     8→ * - Filler word handling
     9→ * - Edge cases
    10→ */
    11→
    12→const BASE_URL = 'https://127.0.0.1:3847';
    13→
    14→// Helper to make API calls
    15→async function testStutters(transcript, options = {}) {
    16→  const response = await fetch(`${BASE_URL}/stutters`, {
    17→    method: 'POST',
    18→    headers: { 'Content-Type': 'application/json' },
    19→    body: JSON.stringify({ transcript, options })
    20→  });
    21→  return response.json();
    22→}
    23→
    24→// Helper to create word objects with timing
    25→function makeWords(wordList, startTime = 0, wordDuration = 0.1, gapDuration = 0.05) {
    26→  const words = [];
    27→  let currentTime = startTime;
    28→
    29→  for (const word of wordList) {
    30→    words.push({
    31→      word: word,
    32→      start: currentTime,
    33→      end: currentTime + wordDuration
    34→    });
    35→    currentTime += wordDuration + gapDuration;
    36→  }
    37→
    38→  return words;
    39→}
    40→
    41→// Test results tracking
    42→const results = {
    43→  passed: 0,
    44→  failed: 0,
    45→  tests: []
    46→};
    47→
    48→function assert(condition, testName, expected, actual) {
    49→  if (condition) {
    50→    results.passed++;
    51→    results.tests.push({ name: testName, status: 'PASS' });
    52→    console.log(`✓ ${testName}`);
    53→  } else {
    54→    results.failed++;
    55→    results.tests.push({ name: testName, status: 'FAIL', expected, actual });
    56→    console.log(`✗ ${testName}`);
    57→    console.log(`  Expected: ${JSON.stringify(expected)}`);
    58→    console.log(`  Actual: ${JSON.stringify(actual)}`);
    59→  }
    60→}
    61→
    62→async function runTests() {
    63→  console.log('='.repeat(60));
    64→  console.log('STUTTER DETECTION TEST SUITE');
    65→  console.log('Testing parity with Firecut behavior');
    66→  console.log('='.repeat(60));
    67→  console.log('');
    68→
    69→  // ========================================
    70→  // TEST 1: Single-character word stutters
    71→  // ========================================
    72→  console.log('--- Test Category: Single-Character Words ---');
    73→
    74→  // Test 1.1: "I I I think" - should detect "I" repeated 3 times
    75→  {
    76→    const words = makeWords(['I', 'I', 'I', 'think']);
    77→    const result = await testStutters({ words });
    78→    assert(
    79→      result.stutters?.length === 1 && result.stutters[0].word === 'i' && result.stutters[0].occurrences === 3,
    80→      'T1.1: Detect "I I I think" as stutter',
    81→      { count: 1, word: 'i', occurrences: 3 },
    82→      { count: result.stutters?.length, word: result.stutters?.[0]?.word, occurrences: result.stutters?.[0]?.occurrences }
    83→    );
    84→  }
    85→
    86→  // Test 1.2: "I I think" - should detect with minRepeats=2
    87→  {
    88→    const words = makeWords(['I', 'I', 'think']);
    89→    const result = await testStutters({ words });
    90→    assert(
    91→      result.stutters?.length === 1 && result.stutters[0].occurrences === 2,
    92→      'T1.2: Detect "I I think" as stutter (minRepeats=2)',
    93→      { count: 1, occurrences: 2 },
    94→      { count: result.stutters?.length, occurrences: result.stutters?.[0]?.occurrences }
    95→    );
    96→  }
    97→
    98→  // Test 1.3: Single "I" - should NOT detect (only 1 occurrence)
    99→  {
   100→    const words = makeWords(['I', 'think']);
   101→    const result = await testStutters({ words });
   102→    assert(
   103→      result.stutters?.length === 0,
   104→      'T1.3: Single "I" should not be detected as stutter',
   105→      { count: 0 },
   106→      { count: result.stutters?.length }
   107→    );
   108→  }
   109→
   110→  // Test 1.4: "a a a cat" - another single char
   111→  {
   112→    const words = makeWords(['a', 'a', 'a', 'cat']);
   113→    const result = await testStutters({ words });
   114→    assert(
   115→      result.stutters?.length === 1 && result.stutters[0].word === 'a' && result.stutters[0].occurrences === 3,
   116→      'T1.4: Detect "a a a cat" as stutter',
   117→      { count: 1, word: 'a', occurrences: 3 },
   118→      { count: result.stutters?.length, word: result.stutters?.[0]?.word, occurrences: result.stutters?.[0]?.occurrences }
   119→    );
   120→  }
   121→
   122→  console.log('');
   123→
   124→  // ========================================
   125→  // TEST 2: Short word stutters
   126→  // ========================================
   127→  console.log('--- Test Category: Short Words ---');
   128→
   129→  // Test 2.1: "the the the cat"
   130→  {
   131→    const words = makeWords(['the', 'the', 'the', 'cat']);
   132→    const result = await testStutters({ words });
   133→    assert(
   134→      result.stutters?.length === 1 && result.stutters[0].word === 'the' && result.stutters[0].occurrences === 3,
   135→      'T2.1: Detect "the the the cat" as stutter',
   136→      { count: 1, word: 'the', occurrences: 3 },
   137→      { count: result.stutters?.length, word: result.stutters?.[0]?.word, occurrences: result.stutters?.[0]?.occurrences }
   138→    );
   139→  }
   140→
   141→  // Test 2.2: "and and and"
   142→  {
   143→    const words = makeWords(['and', 'and', 'and']);
   144→    const result = await testStutters({ words });
   145→    assert(
   146→      result.stutters?.length === 1 && result.stutters[0].word === 'and',
   147→      'T2.2: Detect "and and and" as stutter',
   148→      { count: 1, word: 'and' },
   149→      { count: result.stutters?.length, word: result.stutters?.[0]?.word }
   150→    );
   151→  }
   152→
   153→  console.log('');
   154→
   155→  // ========================================
   156→  // TEST 3: Medium/Long word stutters
   157→  // ========================================
   158→  console.log('--- Test Category: Medium/Long Words ---');
   159→
   160→  // Test 3.1: "because because I"
   161→  {
   162→    const words = makeWords(['because', 'because', 'I']);
   163→    const result = await testStutters({ words });
   164→    assert(
   165→      result.stutters?.length === 1 && result.stutters[0].word === 'because',
   166→      'T3.1: Detect "because because I" as stutter',
   167→      { count: 1, word: 'because' },
   168→      { count: result.stutters?.length, word: result.stutters?.[0]?.word }
   169→    );
   170→  }
   171→
   172→  // Test 3.2: "unfortunately unfortunately unfortunately"
   173→  {
   174→    const words = makeWords(['unfortunately', 'unfortunately', 'unfortunately']);
   175→    const result = await testStutters({ words });
   176→    assert(
   177→      result.stutters?.length === 1 && result.stutters[0].word === 'unfortunately' && result.stutters[0].occurrences === 3,
   178→      'T3.2: Detect long word stutter',
   179→      { count: 1, word: 'unfortunately', occurrences: 3 },
   180→      { count: result.stutters?.length, word: result.stutters?.[0]?.word, occurrences: result.stutters?.[0]?.occurrences }
   181→    );
   182→  }
   183→
   184→  console.log('');
   185→
   186→  // ========================================
   187→  // TEST 4: Gap handling (maxGapMs)
   188→  // ========================================
   189→  console.log('--- Test Category: Gap Handling ---');
   190→
   191→  // Test 4.1: Words with gap < 500ms should be detected
   192→  {
   193→    const words = [
   194→      { word: 'I', start: 0.0, end: 0.1 },
   195→      { word: 'I', start: 0.3, end: 0.4 },  // 200ms gap
   196→      { word: 'think', start: 0.5, end: 0.7 }
   197→    ];
   198→    const result = await testStutters({ words });
   199→    assert(
   200→      result.stutters?.length === 1,
   201→      'T4.1: Detect stutters with gap < 500ms',
   202→      { count: 1 },
   203→      { count: result.stutters?.length }
   204→    );
   205→  }
   206→
   207→  // Test 4.2: Words with gap > 500ms should NOT be detected
   208→  {
   209→    const words = [
   210→      { word: 'I', start: 0.0, end: 0.1 },
   211→      { word: 'I', start: 0.7, end: 0.8 },  // 600ms gap - too long
   212→      { word: 'think', start: 1.0, end: 1.2 }
   213→    ];
   214→    const result = await testStutters({ words });
   215→    assert(
   216→      result.stutters?.length === 0,
   217→      'T4.2: Gap > 500ms breaks stutter chain',
   218→      { count: 0 },
   219→      { count: result.stutters?.length }
   220→    );
   221→  }
   222→
   223→  // Test 4.3: Custom maxGapMs option
   224→  {
   225→    const words = [
   226→      { word: 'I', start: 0.0, end: 0.1 },
   227→      { word: 'I', start: 0.7, end: 0.8 },  // 600ms gap
   228→      { word: 'think', start: 1.0, end: 1.2 }
   229→    ];
   230→    const result = await testStutters({ words }, { maxGapMs: 700 });
   231→    assert(
   232→      result.stutters?.length === 1,
   233→      'T4.3: Custom maxGapMs=700 detects 600ms gap',
   234→      { count: 1 },
   235→      { count: result.stutters?.length }
   236→    );
   237→  }
   238→
   239→  console.log('');
   240→
   241→  // ========================================
   242→  // TEST 5: Filler word handling
   243→  // ========================================
   244→  console.log('--- Test Category: Filler Words ---');
   245→
   246→  // Test 5.1: "um um um" with ignoreFillers=true (default) - should NOT detect
   247→  {
   248→    const words = makeWords(['um', 'um', 'um']);
   249→    const result = await testStutters({ words });
   250→    assert(
   251→      result.stutters?.length === 0,
   252→      'T5.1: Filler "um um um" ignored by default',
   253→      { count: 0 },
   254→      { count: result.stutters?.length }
   255→    );
   256→  }
   257→
   258→  // Test 5.2: "uh uh uh" ignored
   259→  {
   260→    const words = makeWords(['uh', 'uh', 'uh']);
   261→    const result = await testStutters({ words });
   262→    assert(
   263→      result.stutters?.length === 0,
   264→      'T5.2: Filler "uh uh uh" ignored by default',
   265→      { count: 0 },
   266→      { count: result.stutters?.length }
   267→    );
   268→  }
   269→
   270→  // Test 5.3: "um um um" with ignoreFillers=false - SHOULD detect
   271→  {
   272→    const words = makeWords(['um', 'um', 'um']);
   273→    const result = await testStutters({ words }, { ignoreFillers: false });
   274→    assert(
   275→      result.stutters?.length === 1,
   276→      'T5.3: Filler "um um um" detected with ignoreFillers=false',
   277→      { count: 1 },
   278→      { count: result.stutters?.length }
   279→    );
   280→  }
   281→
   282→  // Test 5.4: "like like like" (filler word)
   283→  {
   284→    const words = makeWords(['like', 'like', 'like']);
   285→    const result = await testStutters({ words });
   286→    assert(
   287→      result.stutters?.length === 0,
   288→      'T5.4: Filler "like like like" ignored by default',
   289→      { count: 0 },
   290→      { count: result.stutters?.length }
   291→    );
   292→  }
   293→
   294→  console.log('');
   295→
   296→  // ========================================
   297→  // TEST 6: Case insensitivity
   298→  // ========================================
   299→  console.log('--- Test Category: Case Insensitivity ---');
   300→
   301→  // Test 6.1: Mixed case "I i I"
   302→  {
   303→    const words = makeWords(['I', 'i', 'I', 'think']);
   304→    const result = await testStutters({ words });
   305→    assert(
   306→      result.stutters?.length === 1 && result.stutters[0].occurrences === 3,
   307→      'T6.1: Mixed case "I i I" detected as stutter',
   308→      { count: 1, occurrences: 3 },
   309→      { count: result.stutters?.length, occurrences: result.stutters?.[0]?.occurrences }
   310→    );
   311→  }
   312→
   313→  // Test 6.2: "The THE the"
   314→  {
   315→    const words = makeWords(['The', 'THE', 'the']);
   316→    const result = await testStutters({ words });
   317→    assert(
   318→      result.stutters?.length === 1,
   319→      'T6.2: Mixed case "The THE the" detected',
   320→      { count: 1 },
   321→      { count: result.stutters?.length }
   322→    );
   323→  }
   324→
   325→  console.log('');
   326→
   327→  // ========================================
   328→  // TEST 7: Multiple stutters in one transcript
   329→  // ========================================
   330→  console.log('--- Test Category: Multiple Stutters ---');
   331→
   332→  // Test 7.1: Two separate stutters
   333→  {
   334→    const words = [
   335→      { word: 'I', start: 0.0, end: 0.1 },
   336→      { word: 'I', start: 0.15, end: 0.25 },
   337→      { word: 'think', start: 0.3, end: 0.5 },
   338→      { word: 'the', start: 0.6, end: 0.7 },
   339→      { word: 'the', start: 0.75, end: 0.85 },
   340→      { word: 'the', start: 0.9, end: 1.0 },
   341→      { word: 'cat', start: 1.1, end: 1.3 }
   342→    ];
   343→    const result = await testStutters({ words });
   344→    assert(
   345→      result.stutters?.length === 2,
   346→      'T7.1: Two separate stutters detected',
   347→      { count: 2 },
   348→      { count: result.stutters?.length }
   349→    );
   350→  }
   351→
   352→  // Test 7.2: Three stutters in longer transcript
   353→  {
   354→    const words = [
   355→      { word: 'I', start: 0.0, end: 0.1 },
   356→      { word: 'I', start: 0.15, end: 0.25 },
   357→      { word: 'I', start: 0.3, end: 0.4 },
   358→      { word: 'want', start: 0.5, end: 0.7 },
   359→      { word: 'to', start: 0.8, end: 0.9 },
   360→      { word: 'to', start: 0.95, end: 1.05 },
   361→      { word: 'say', start: 1.1, end: 1.3 },
   362→      { word: 'that', start: 1.4, end: 1.5 },
   363→      { word: 'that', start: 1.55, end: 1.65 },
   364→      { word: 'that', start: 1.7, end: 1.8 },
   365→      { word: 'thing', start: 1.9, end: 2.1 }
   366→    ];
   367→    const result = await testStutters({ words });
   368→    assert(
   369→      result.stutters?.length === 3,
   370→      'T7.2: Three stutters in transcript',
   371→      { count: 3 },
   372→      { count: result.stutters?.length }
   373→    );
   374→  }
   375→
   376→  console.log('');
   377→
   378→  // ========================================
   379→  // TEST 8: Removal timing accuracy
   380→  // ========================================
   381→  console.log('--- Test Category: Removal Timing ---');
   382→
   383→  // Test 8.1: Keep first, remove rest
   384→  {
   385→    const words = [
   386→      { word: 'I', start: 0.0, end: 0.1 },
   387→      { word: 'I', start: 0.15, end: 0.25 },
   388→      { word: 'I', start: 0.3, end: 0.4 },
   389→      { word: 'think', start: 0.5, end: 0.8 }
   390→    ];
   391→    const result = await testStutters({ words });
   392→    const stutter = result.stutters?.[0];
   393→    assert(
   394→      stutter?.keepStart === 0.0 && stutter?.keepEnd === 0.1 &&
   395→      stutter?.removeStart === 0.15 && stutter?.removeEnd === 0.4,
   396→      'T8.1: Correct keep/remove timing',
   397→      { keepStart: 0.0, keepEnd: 0.1, removeStart: 0.15, removeEnd: 0.4 },
   398→      { keepStart: stutter?.keepStart, keepEnd: stutter?.keepEnd, removeStart: stutter?.removeStart, removeEnd: stutter?.removeEnd }
   399→    );
   400→  }
   401→
   402→  console.log('');
   403→
   404→  // ========================================
   405→  // TEST 9: Edge cases
   406→  // ========================================
   407→  console.log('--- Test Category: Edge Cases ---');
   408→
   409→  // Test 9.1: Empty transcript
   410→  {
   411→    const result = await testStutters({ words: [] });
   412→    assert(
   413→      result.stutters?.length === 0,
   414→      'T9.1: Empty transcript returns no stutters',
   415→      { count: 0 },
   416→      { count: result.stutters?.length }
   417→    );
   418→  }
   419→
   420→  // Test 9.2: Single word transcript
   421→  {
   422→    const result = await testStutters({ words: [{ word: 'hello', start: 0, end: 0.5 }] });
   423→    assert(
   424→      result.stutters?.length === 0,
   425→      'T9.2: Single word returns no stutters',
   426→      { count: 0 },
   427→      { count: result.stutters?.length }
   428→    );
   429→  }
   430→
   431→  // Test 9.3: All same word (extreme stutter)
   432→  {
   433→    const words = makeWords(['I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I', 'I']);
   434→    const result = await testStutters({ words });
   435→    assert(
   436→      result.stutters?.length === 1 && result.stutters[0].occurrences === 10,
   437→      'T9.3: 10 repeated "I" detected as single stutter',
   438→      { count: 1, occurrences: 10 },
   439→      { count: result.stutters?.length, occurrences: result.stutters?.[0]?.occurrences }
   440→    );
   441→  }
   442→
   443→  // Test 9.4: Punctuation in words
   444→  {
   445→    const words = makeWords(["I'm", "I'm", "I'm", 'sure']);
   446→    const result = await testStutters({ words });
   447→    assert(
   448→      result.stutters?.length === 1,
   449→      'T9.4: Words with punctuation detected',
   450→      { count: 1 },
   451→      { count: result.stutters?.length }
   452→    );
   453→  }
   454→
   455→  // Test 9.5: minRepeats=3 option
   456→  {
   457→    const words = makeWords(['I', 'I', 'think']);  // Only 2 repeats
   458→    const result = await testStutters({ words }, { minRepeats: 3 });
   459→    assert(
   460→      result.stutters?.length === 0,
   461→      'T9.5: minRepeats=3 ignores 2-repeat stutters',
   462→      { count: 0 },
   463→      { count: result.stutters?.length }
   464→    );
   465→  }
   466→
   467→  // Test 9.6: minWordLength=2 reverts old behavior
   468→  {
   469→    const words = makeWords(['I', 'I', 'I', 'think']);
   470→    const result = await testStutters({ words }, { minWordLength: 2 });
   471→    assert(
   472→      result.stutters?.length === 0,
   473→      'T9.6: minWordLength=2 skips single-char words',
   474→      { count: 0 },
   475→      { count: result.stutters?.length }
   476→    );
   477→  }
   478→
   479→  console.log('');
   480→
   481→  // ========================================
   482→  // TEST 10: Real-world examples
   483→  // ========================================
   484→  console.log('--- Test Category: Real-World Examples ---');
   485→
   486→  // Test 10.1: Natural speech pattern
   487→  {
   488→    const words = [
   489→      { word: 'So', start: 0.0, end: 0.15 },
   490→      { word: 'I', start: 0.2, end: 0.25 },
   491→      { word: 'I', start: 0.3, end: 0.35 },
   492→      { word: 'I', start: 0.4, end: 0.45 },
   493→      { word: 'was', start: 0.5, end: 0.65 },
   494→      { word: 'thinking', start: 0.7, end: 1.0 },
   495→      { word: 'about', start: 1.1, end: 1.3 },
   496→      { word: 'the', start: 1.4, end: 1.5 },
   497→      { word: 'the', start: 1.55, end: 1.65 },
   498→      { word: 'problem', start: 1.7, end: 2.0 }
   499→    ];
   500→    const result = await testStutters({ words });
   501→    assert(
   502→      result.stutters?.length === 2,  // "I I I" and "the the"
   503→      'T10.1: Natural speech with multiple stutters',
   504→      { count: 2 },
   505→      { count: result.stutters?.length }
   506→    );
   507→  }
   508→
   509→  // Test 10.2: "So" is a filler but should be detected if repeated
   510→  {
   511→    const words = makeWords(['so', 'so', 'so', 'anyway']);
   512→    const result = await testStutters({ words });
   513→    assert(
   514→      result.stutters?.length === 0,  // "so" is in filler list
   515→      'T10.2: "so so so" treated as filler (ignored)',
   516→      { count: 0 },
   517→      { count: result.stutters?.length }
   518→    );
   519→  }
   520→
   521→  console.log('');
   522→
   523→  // ========================================
   524→  // SUMMARY
   525→  // ========================================
   526→  console.log('='.repeat(60));
   527→  console.log('TEST SUMMARY');
   528→  console.log('='.repeat(60));
   529→  console.log(`Total Tests: ${results.passed + results.failed}`);
   530→  console.log(`Passed: ${results.passed}`);
   531→  console.log(`Failed: ${results.failed}`);
   532→  console.log(`Success Rate: ${((results.passed / (results.passed + results.failed)) * 100).toFixed(1)}%`);
   533→  console.log('');
   534→
   535→  if (results.failed > 0) {
   536→    console.log('FAILED TESTS:');
   537→    results.tests.filter(t => t.status === 'FAIL').forEach(t => {
   538→      console.log(`  - ${t.name}`);
   539→    });
   540→  }
   541→
   542→  return results;
   543→}
   544→
   545→// Run tests
   546→runTests().then(r => {
   547→  process.exit(r.failed > 0 ? 1 : 0);
   548→}).catch(err => {
   549→  console.error('Test suite error:', err);
   550→  process.exit(1);
   551→});
   552→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
