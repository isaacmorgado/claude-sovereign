     1â†’/**
     2â†’ * Custom Presets E2E Tests
     3â†’ *
     4â†’ * Tests for Phase 1: Custom Presets Foundation
     5â†’ * Each feature is tested individually then together.
     6â†’ */
     7â†’
     8â†’// Simulate localStorage for Node.js testing - using object wrapper for proper reset
     9â†’const storage = { data: {} };
    10â†’global.localStorage = {
    11â†’  getItem: (key) => storage.data[key] || null,
    12â†’  setItem: (key, value) => { storage.data[key] = value; },
    13â†’  removeItem: (key) => { delete storage.data[key]; },
    14â†’  clear: () => { storage.data = {}; }
    15â†’};
    16â†’
    17â†’// Helper to reset localStorage
    18â†’function resetLocalStorage() {
    19â†’  storage.data = {};
    20â†’}
    21â†’
    22â†’// Mock console.warn to avoid noise
    23â†’const originalWarn = console.warn;
    24â†’console.warn = () => {};
    25â†’
    26â†’// =============================================================================
    27â†’// COPY OF FUNCTIONS FROM settings.js (for testing without UXP)
    28â†’// =============================================================================
    29â†’
    30â†’const CUSTOM_PRESETS_KEY = 'spliceCustomPresets';
    31â†’
    32â†’const DEFAULT_CUSTOM_PRESETS = {
    33â†’  version: 1,
    34â†’  presets: {},
    35â†’  order: []
    36â†’};
    37â†’
    38â†’function loadCustomPresets() {
    39â†’  try {
    40â†’    const saved = localStorage.getItem(CUSTOM_PRESETS_KEY);
    41â†’    if (saved) {
    42â†’      const parsed = JSON.parse(saved);
    43â†’      if (parsed && typeof parsed === 'object' && parsed.version && parsed.presets) {
    44â†’        return {
    45â†’          version: parsed.version || 1,
    46â†’          presets: { ...parsed.presets } || {},
    47â†’          order: [...(parsed.order || [])]
    48â†’        };
    49â†’      }
    50â†’    }
    51â†’  } catch (e) {
    52â†’    // Silently handle parse errors
    53â†’  }
    54â†’  // Return a DEEP copy of defaults to avoid mutation issues
    55â†’  return {
    56â†’    version: 1,
    57â†’    presets: {},
    58â†’    order: []
    59â†’  };
    60â†’}
    61â†’
    62â†’function saveCustomPresets(data) {
    63â†’  try {
    64â†’    if (!data || typeof data !== 'object') {
    65â†’      return false;
    66â†’    }
    67â†’    const toSave = {
    68â†’      version: data.version || DEFAULT_CUSTOM_PRESETS.version,
    69â†’      presets: data.presets || {},
    70â†’      order: data.order || []
    71â†’    };
    72â†’    localStorage.setItem(CUSTOM_PRESETS_KEY, JSON.stringify(toSave));
    73â†’    return true;
    74â†’  } catch (e) {
    75â†’    return false;
    76â†’  }
    77â†’}
    78â†’
    79â†’// Slugify function
    80â†’function slugifyPresetName(name) {
    81â†’  return name
    82â†’    .toLowerCase()
    83â†’    .trim()
    84â†’    .replace(/[^a-z0-9]+/g, '-')
    85â†’    .replace(/^-+|-+$/g, '')
    86â†’    .substring(0, 50) || 'preset';
    87â†’}
    88â†’
    89â†’// Generate unique ID
    90â†’function generateUniquePresetId(baseName, existingPresets) {
    91â†’  const baseId = slugifyPresetName(baseName);
    92â†’  let id = baseId;
    93â†’  let counter = 1;
    94â†’
    95â†’  while (existingPresets[id]) {
    96â†’    id = `${baseId}-${counter}`;
    97â†’    counter++;
    98â†’  }
    99â†’
   100â†’  return id;
   101â†’}
   102â†’
   103â†’// Get current preset settings (mock for testing)
   104â†’function getCurrentPresetSettings() {
   105â†’  return {
   106â†’    sensitivity: 50,
   107â†’    threshold: -32,
   108â†’    minSilenceLength: 0.5,
   109â†’    paddingStart: 0.1,
   110â†’    paddingEnd: 0.1,
   111â†’    autoMarkBest: true,
   112â†’    enableTakesDetection: true
   113â†’  };
   114â†’}
   115â†’
   116â†’// Create custom preset
   117â†’function createCustomPreset(preset) {
   118â†’  if (!preset || typeof preset !== 'object') {
   119â†’    return { success: false, error: 'Invalid preset data' };
   120â†’  }
   121â†’
   122â†’  if (!preset.name || typeof preset.name !== 'string' || !preset.name.trim()) {
   123â†’    return { success: false, error: 'Preset name is required' };
   124â†’  }
   125â†’
   126â†’  const name = preset.name.trim();
   127â†’  const data = loadCustomPresets();
   128â†’  const id = generateUniquePresetId(name, data.presets);
   129â†’
   130â†’  const settings = preset.settings && typeof preset.settings === 'object'
   131â†’    ? { ...preset.settings }
   132â†’    : getCurrentPresetSettings();
   133â†’
   134â†’  if (!settings || typeof settings !== 'object') {
   135â†’    return { success: false, error: 'Invalid settings' };
   136â†’  }
   137â†’
   138â†’  const newPreset = {
   139â†’    id,
   140â†’    name,
   141â†’    description: preset.description || '',
   142â†’    icon: preset.icon || 'settings',
   143â†’    createdAt: new Date().toISOString(),
   144â†’    settings
   145â†’  };
   146â†’
   147â†’  data.presets[id] = newPreset;
   148â†’  data.order.push(id);
   149â†’
   150â†’  const saved = saveCustomPresets(data);
   151â†’  if (!saved) {
   152â†’    return { success: false, error: 'Failed to save preset' };
   153â†’  }
   154â†’
   155â†’  return { success: true, id };
   156â†’}
   157â†’
   158â†’// Update custom preset
   159â†’function updateCustomPreset(id, updates) {
   160â†’  if (!id || typeof id !== 'string') {
   161â†’    return { success: false, error: 'Preset ID is required' };
   162â†’  }
   163â†’
   164â†’  if (!updates || typeof updates !== 'object') {
   165â†’    return { success: false, error: 'Updates must be an object' };
   166â†’  }
   167â†’
   168â†’  const data = loadCustomPresets();
   169â†’
   170â†’  if (!data.presets[id]) {
   171â†’    return { success: false, error: 'Preset not found' };
   172â†’  }
   173â†’
   174â†’  const existing = data.presets[id];
   175â†’
   176â†’  const updated = {
   177â†’    ...existing,
   178â†’    updatedAt: new Date().toISOString()
   179â†’  };
   180â†’
   181â†’  if (updates.name !== undefined) {
   182â†’    if (typeof updates.name !== 'string' || !updates.name.trim()) {
   183â†’      return { success: false, error: 'Name must be a non-empty string' };
   184â†’    }
   185â†’    updated.name = updates.name.trim();
   186â†’  }
   187â†’
   188â†’  if (updates.description !== undefined) {
   189â†’    updated.description = String(updates.description);
   190â†’  }
   191â†’
   192â†’  if (updates.icon !== undefined) {
   193â†’    updated.icon = String(updates.icon);
   194â†’  }
   195â†’
   196â†’  if (updates.settings !== undefined) {
   197â†’    if (typeof updates.settings !== 'object') {
   198â†’      return { success: false, error: 'Settings must be an object' };
   199â†’    }
   200â†’    updated.settings = {
   201â†’      ...existing.settings,
   202â†’      ...updates.settings
   203â†’    };
   204â†’  }
   205â†’
   206â†’  data.presets[id] = updated;
   207â†’
   208â†’  const saved = saveCustomPresets(data);
   209â†’  if (!saved) {
   210â†’    return { success: false, error: 'Failed to save preset' };
   211â†’  }
   212â†’
   213â†’  return { success: true };
   214â†’}
   215â†’
   216â†’// Get custom preset by ID
   217â†’function getCustomPreset(id) {
   218â†’  if (!id || typeof id !== 'string') {
   219â†’    return null;
   220â†’  }
   221â†’  const data = loadCustomPresets();
   222â†’  return data.presets[id] || null;
   223â†’}
   224â†’
   225â†’// Delete custom preset
   226â†’function deleteCustomPreset(id) {
   227â†’  if (!id || typeof id !== 'string') {
   228â†’    return { success: false, error: 'Preset ID is required' };
   229â†’  }
   230â†’
   231â†’  const data = loadCustomPresets();
   232â†’
   233â†’  if (!data.presets[id]) {
   234â†’    return { success: false, error: 'Preset not found' };
   235â†’  }
   236â†’
   237â†’  delete data.presets[id];
   238â†’
   239â†’  const orderIndex = data.order.indexOf(id);
   240â†’  if (orderIndex !== -1) {
   241â†’    data.order.splice(orderIndex, 1);
   242â†’  }
   243â†’
   244â†’  const saved = saveCustomPresets(data);
   245â†’  if (!saved) {
   246â†’    return { success: false, error: 'Failed to save after deletion' };
   247â†’  }
   248â†’
   249â†’  return { success: true };
   250â†’}
   251â†’
   252â†’// Mock built-in presets (matching settings.js)
   253â†’const PRESETS = {
   254â†’  custom: { name: 'Custom', description: 'Your custom settings', icon: 'settings', settings: null },
   255â†’  podcast: { name: 'Podcast', description: 'Natural pauses', icon: 'mic', settings: { sensitivity: 35 } },
   256â†’  interview: { name: 'Interview', description: 'Q&A rhythm', icon: 'people', settings: { sensitivity: 50 } },
   257â†’  reaction: { name: 'Reaction', description: 'Fast-paced', icon: 'bolt', settings: { sensitivity: 70 } },
   258â†’  tutorial: { name: 'Tutorial', description: 'Teaching pace', icon: 'school', settings: { sensitivity: 30 } },
   259â†’  vlog: { name: 'Vlog', description: 'Punchy edits', icon: 'videocam', settings: { sensitivity: 65 } }
   260â†’};
   261â†’
   262â†’const BUILT_IN_PRESET_IDS = ['custom', 'podcast', 'interview', 'reaction', 'tutorial', 'vlog'];
   263â†’
   264â†’// Is built-in preset
   265â†’function isBuiltInPreset(id) {
   266â†’  return BUILT_IN_PRESET_IDS.includes(id);
   267â†’}
   268â†’
   269â†’// Get all presets (built-in + custom)
   270â†’function getAllPresets() {
   271â†’  const builtInPresets = BUILT_IN_PRESET_IDS.map(id => {
   272â†’    const preset = PRESETS[id];
   273â†’    return {
   274â†’      id,
   275â†’      name: preset.name,
   276â†’      description: preset.description,
   277â†’      icon: preset.icon,
   278â†’      settings: preset.settings,
   279â†’      isBuiltIn: true
   280â†’    };
   281â†’  });
   282â†’
   283â†’  const customData = loadCustomPresets();
   284â†’  const customPresets = customData.order.map(id => {
   285â†’    const preset = customData.presets[id];
   286â†’    if (!preset) return null;
   287â†’    return { ...preset, isBuiltIn: false };
   288â†’  }).filter(Boolean);
   289â†’
   290â†’  return [...builtInPresets, ...customPresets];
   291â†’}
   292â†’
   293â†’// Get all preset IDs
   294â†’function getAllPresetIds() {
   295â†’  const customData = loadCustomPresets();
   296â†’  return [...BUILT_IN_PRESET_IDS, ...customData.order];
   297â†’}
   298â†’
   299â†’// Get preset by ID
   300â†’function getPresetById(id) {
   301â†’  if (!id || typeof id !== 'string') return null;
   302â†’
   303â†’  if (isBuiltInPreset(id)) {
   304â†’    const preset = PRESETS[id];
   305â†’    return { id, name: preset.name, description: preset.description, icon: preset.icon, settings: preset.settings, isBuiltIn: true };
   306â†’  }
   307â†’
   308â†’  const custom = getCustomPreset(id);
   309â†’  if (custom) return { ...custom, isBuiltIn: false };
   310â†’
   311â†’  return null;
   312â†’}
   313â†’
   314â†’// =============================================================================
   315â†’// TEST UTILITIES
   316â†’// =============================================================================
   317â†’
   318â†’let testsPassed = 0;
   319â†’let testsFailed = 0;
   320â†’const startTime = Date.now();
   321â†’
   322â†’function assert(condition, message) {
   323â†’  if (!condition) {
   324â†’    throw new Error(message);
   325â†’  }
   326â†’}
   327â†’
   328â†’function assertEqual(actual, expected, message) {
   329â†’  if (JSON.stringify(actual) !== JSON.stringify(expected)) {
   330â†’    throw new Error(`${message}\n  Expected: ${JSON.stringify(expected)}\n  Actual: ${JSON.stringify(actual)}`);
   331â†’  }
   332â†’}
   333â†’
   334â†’async function runTest(name, testFn) {
   335â†’  const testStart = Date.now();
   336â†’  try {
   337â†’    // Clear localStorage before each test
   338â†’    storage.data = {};
   339â†’
   340â†’    await testFn();
   341â†’
   342â†’    const elapsed = Date.now() - testStart;
   343â†’    console.log(`  âœ“ ${name} (${elapsed}ms)`);
   344â†’    testsPassed++;
   345â†’
   346â†’    // Check for performance bottleneck
   347â†’    if (elapsed > 5) {
   348â†’      console.log(`    âš  Performance warning: ${elapsed}ms > 5ms threshold`);
   349â†’    }
   350â†’  } catch (err) {
   351â†’    console.log(`  âœ— ${name}`);
   352â†’    console.log(`    Error: ${err.message}`);
   353â†’    testsFailed++;
   354â†’  }
   355â†’}
   356â†’
   357â†’// =============================================================================
   358â†’// FEATURE 1.1 TESTS: localStorage Schema
   359â†’// =============================================================================
   360â†’
   361â†’async function testFeature1_1() {
   362â†’  console.log('\nðŸ“¦ Feature 1.1: localStorage Schema');
   363â†’  console.log('=' .repeat(50));
   364â†’
   365â†’  // Test 1: Load returns default when empty
   366â†’  await runTest('loadCustomPresets returns default when empty', async () => {
   367â†’    const result = loadCustomPresets();
   368â†’    assertEqual(result.version, 1, 'Version should be 1');
   369â†’    assertEqual(result.presets, {}, 'Presets should be empty object');
   370â†’    assertEqual(result.order, [], 'Order should be empty array');
   371â†’  });
   372â†’
   373â†’  // Test 2: Save and load round-trip
   374â†’  await runTest('Save and load round-trip works', async () => {
   375â†’    const testData = {
   376â†’      version: 1,
   377â†’      presets: {
   378â†’        'test-preset': {
   379â†’          id: 'test-preset',
   380â†’          name: 'Test Preset',
   381â†’          settings: { sensitivity: 50 }
   382â†’        }
   383â†’      },
   384â†’      order: ['test-preset']
   385â†’    };
   386â†’
   387â†’    const saveResult = saveCustomPresets(testData);
   388â†’    assert(saveResult === true, 'Save should return true');
   389â†’
   390â†’    const loaded = loadCustomPresets();
   391â†’    assertEqual(loaded.version, 1, 'Version should match');
   392â†’    assertEqual(loaded.order, ['test-preset'], 'Order should match');
   393â†’    assertEqual(loaded.presets['test-preset'].name, 'Test Preset', 'Preset name should match');
   394â†’  });
   395â†’
   396â†’  // Test 3: Handle corrupt data gracefully
   397â†’  await runTest('Handle corrupt JSON gracefully', async () => {
   398â†’    localStorage.setItem(CUSTOM_PRESETS_KEY, 'not valid json{{{');
   399â†’    const result = loadCustomPresets();
   400â†’    assertEqual(result.version, 1, 'Should return default version');
   401â†’    assertEqual(result.presets, {}, 'Should return empty presets');
   402â†’  });
   403â†’
   404â†’  // Test 4: Handle invalid structure gracefully
   405â†’  await runTest('Handle invalid structure gracefully', async () => {
   406â†’    localStorage.setItem(CUSTOM_PRESETS_KEY, JSON.stringify({ foo: 'bar' }));
   407â†’    const result = loadCustomPresets();
   408â†’    assertEqual(result.version, 1, 'Should return default version');
   409â†’    assertEqual(result.presets, {}, 'Should return empty presets');
   410â†’  });
   411â†’
   412â†’  // Test 5: Save rejects invalid data
   413â†’  await runTest('Save rejects null/undefined data', async () => {
   414â†’    const result1 = saveCustomPresets(null);
   415â†’    assert(result1 === false, 'Should return false for null');
   416â†’
   417â†’    const result2 = saveCustomPresets(undefined);
   418â†’    assert(result2 === false, 'Should return false for undefined');
   419â†’
   420â†’    const result3 = saveCustomPresets('string');
   421â†’    assert(result3 === false, 'Should return false for string');
   422â†’  });
   423â†’
   424â†’  // Test 6: Multiple save/load cycles
   425â†’  await runTest('Multiple save/load cycles work correctly', async () => {
   426â†’    for (let i = 0; i < 100; i++) {
   427â†’      const data = {
   428â†’        version: 1,
   429â†’        presets: { [`preset-${i}`]: { id: `preset-${i}`, name: `Preset ${i}` } },
   430â†’        order: [`preset-${i}`]
   431â†’      };
   432â†’      saveCustomPresets(data);
   433â†’    }
   434â†’
   435â†’    const final = loadCustomPresets();
   436â†’    assertEqual(final.order, ['preset-99'], 'Should have last preset');
   437â†’  });
   438â†’
   439â†’  // Test 7: Preserves version when saving
   440â†’  await runTest('Preserves version field', async () => {
   441â†’    const data = {
   442â†’      version: 1,
   443â†’      presets: {},
   444â†’      order: []
   445â†’    };
   446â†’    saveCustomPresets(data);
   447â†’    const loaded = loadCustomPresets();
   448â†’    assertEqual(loaded.version, 1, 'Version should be preserved');
   449â†’  });
   450â†’}
   451â†’
   452â†’// =============================================================================
   453â†’// FEATURE 1.2 TESTS: createCustomPreset Function
   454â†’// =============================================================================
   455â†’
   456â†’async function testFeature1_2() {
   457â†’  console.log('\nðŸ“¦ Feature 1.2: createCustomPreset Function');
   458â†’  console.log('=' .repeat(50));
   459â†’
   460â†’  // Test 1: Create preset with name only
   461â†’  await runTest('Create preset with name only', async () => {
   462â†’    const result = createCustomPreset({ name: 'My Podcast Style' });
   463â†’    assert(result.success === true, 'Should succeed');
   464â†’    assert(result.id === 'my-podcast-style', 'ID should be slugified');
   465â†’
   466â†’    const data = loadCustomPresets();
   467â†’    assert(data.presets['my-podcast-style'], 'Preset should exist');
   468â†’    assertEqual(data.presets['my-podcast-style'].name, 'My Podcast Style', 'Name should match');
   469â†’  });
   470â†’
   471â†’  // Test 2: Create preset with all fields
   472â†’  await runTest('Create preset with all fields', async () => {
   473â†’    const result = createCustomPreset({
   474â†’      name: 'Full Preset',
   475â†’      description: 'A complete preset',
   476â†’      icon: 'mic',
   477â†’      settings: { sensitivity: 75, threshold: -28 }
   478â†’    });
   479â†’
   480â†’    assert(result.success === true, 'Should succeed');
   481â†’    const data = loadCustomPresets();
   482â†’    const preset = data.presets[result.id];
   483â†’    assertEqual(preset.description, 'A complete preset', 'Description should match');
   484â†’    assertEqual(preset.icon, 'mic', 'Icon should match');
   485â†’    assertEqual(preset.settings.sensitivity, 75, 'Settings should match');
   486â†’  });
   487â†’
   488â†’  // Test 3: Slugify special characters
   489â†’  await runTest('Slugify handles special characters', async () => {
   490â†’    const result = createCustomPreset({ name: 'My (Special) Preset!!!' });
   491â†’    assertEqual(result.id, 'my-special-preset', 'ID should be slugified correctly');
   492â†’  });
   493â†’
   494â†’  // Test 4: Handle duplicate names
   495â†’  await runTest('Handle duplicate names with unique IDs', async () => {
   496â†’    createCustomPreset({ name: 'Podcast' });
   497â†’    const result2 = createCustomPreset({ name: 'Podcast' });
   498â†’    const result3 = createCustomPreset({ name: 'Podcast' });
   499â†’
   500â†’    assertEqual(result2.id, 'podcast-1', 'Second should have -1 suffix');
   501â†’    assertEqual(result3.id, 'podcast-2', 'Third should have -2 suffix');
   502â†’
   503â†’    const data = loadCustomPresets();
   504â†’    assertEqual(data.order.length, 3, 'Should have 3 presets');
   505â†’  });
   506â†’
   507â†’  // Test 5: Reject empty name
   508â†’  await runTest('Reject empty name', async () => {
   509â†’    const result1 = createCustomPreset({ name: '' });
   510â†’    assert(result1.success === false, 'Should fail for empty string');
   511â†’    assertEqual(result1.error, 'Preset name is required', 'Should have correct error');
   512â†’
   513â†’    const result2 = createCustomPreset({ name: '   ' });
   514â†’    assert(result2.success === false, 'Should fail for whitespace');
   515â†’  });
   516â†’
   517â†’  // Test 6: Reject invalid input
   518â†’  await runTest('Reject invalid input', async () => {
   519â†’    const result1 = createCustomPreset(null);
   520â†’    assert(result1.success === false, 'Should fail for null');
   521â†’
   522â†’    const result2 = createCustomPreset('string');
   523â†’    assert(result2.success === false, 'Should fail for string');
   524â†’
   525â†’    const result3 = createCustomPreset({ name: 123 });
   526â†’    assert(result3.success === false, 'Should fail for non-string name');
   527â†’  });
   528â†’
   529â†’  // Test 7: Uses default settings when not provided
   530â†’  await runTest('Uses default settings when not provided', async () => {
   531â†’    const result = createCustomPreset({ name: 'Default Settings Test' });
   532â†’    const data = loadCustomPresets();
   533â†’    const preset = data.presets[result.id];
   534â†’
   535â†’    assertEqual(preset.settings.sensitivity, 50, 'Should have default sensitivity');
   536â†’    assert(preset.settings.autoMarkBest === true, 'Should have default autoMarkBest');
   537â†’  });
   538â†’
   539â†’  // Test 8: Preset has createdAt timestamp
   540â†’  await runTest('Preset has createdAt timestamp', async () => {
   541â†’    const before = new Date().toISOString();
   542â†’    const result = createCustomPreset({ name: 'Timestamped' });
   543â†’    const after = new Date().toISOString();
   544â†’
   545â†’    const data = loadCustomPresets();
   546â†’    const preset = data.presets[result.id];
   547â†’
   548â†’    assert(preset.createdAt >= before, 'CreatedAt should be after test start');
   549â†’    assert(preset.createdAt <= after, 'CreatedAt should be before test end');
   550â†’  });
   551â†’
   552â†’  // Test 9: Order array is updated
   553â†’  await runTest('Order array is updated correctly', async () => {
   554â†’    createCustomPreset({ name: 'First' });
   555â†’    createCustomPreset({ name: 'Second' });
   556â†’    createCustomPreset({ name: 'Third' });
   557â†’
   558â†’    const data = loadCustomPresets();
   559â†’    assertEqual(data.order, ['first', 'second', 'third'], 'Order should match creation order');
   560â†’  });
   561â†’
   562â†’  // Test 10: Performance test - create many presets
   563â†’  await runTest('Performance: create 100 presets < 50ms', async () => {
   564â†’    const start = Date.now();
   565â†’    for (let i = 0; i < 100; i++) {
   566â†’      createCustomPreset({ name: `Preset ${i}` });
   567â†’    }
   568â†’    const elapsed = Date.now() - start;
   569â†’    assert(elapsed < 50, `Should complete in < 50ms (was ${elapsed}ms)`);
   570â†’
   571â†’    const data = loadCustomPresets();
   572â†’    assertEqual(Object.keys(data.presets).length, 100, 'Should have 100 presets');
   573â†’  });
   574â†’}
   575â†’
   576â†’// =============================================================================
   577â†’// FEATURE 1.3 TESTS: updateCustomPreset Function
   578â†’// =============================================================================
   579â†’
   580â†’async function testFeature1_3() {
   581â†’  console.log('\nðŸ“¦ Feature 1.3: updateCustomPreset Function');
   582â†’  console.log('=' .repeat(50));
   583â†’
   584â†’  // Test 1: Update preset name
   585â†’  await runTest('Update preset name', async () => {
   586â†’    const create = createCustomPreset({ name: 'Original Name' });
   587â†’    assert(create.success, 'Should create preset');
   588â†’
   589â†’    const result = updateCustomPreset(create.id, { name: 'Updated Name' });
   590â†’    assert(result.success, 'Should update successfully');
   591â†’
   592â†’    const preset = getCustomPreset(create.id);
   593â†’    assertEqual(preset.name, 'Updated Name', 'Name should be updated');
   594â†’  });
   595â†’
   596â†’  // Test 2: Update preserves unchanged fields
   597â†’  await runTest('Update preserves unchanged fields', async () => {
   598â†’    const create = createCustomPreset({
   599â†’      name: 'My Preset',
   600â†’      description: 'Original description',
   601â†’      icon: 'mic',
   602â†’      settings: { sensitivity: 75 }
   603â†’    });
   604â†’
   605â†’    updateCustomPreset(create.id, { name: 'New Name' });
   606â†’
   607â†’    const preset = getCustomPreset(create.id);
   608â†’    assertEqual(preset.description, 'Original description', 'Description preserved');
   609â†’    assertEqual(preset.icon, 'mic', 'Icon preserved');
   610â†’    assertEqual(preset.settings.sensitivity, 75, 'Settings preserved');
   611â†’  });
   612â†’
   613â†’  // Test 3: Update settings merges with existing
   614â†’  await runTest('Update settings merges with existing', async () => {
   615â†’    const create = createCustomPreset({
   616â†’      name: 'Settings Test',
   617â†’      settings: { sensitivity: 50, threshold: -30 }
   618â†’    });
   619â†’
   620â†’    updateCustomPreset(create.id, {
   621â†’      settings: { sensitivity: 80 }
   622â†’    });
   623â†’
   624â†’    const preset = getCustomPreset(create.id);
   625â†’    assertEqual(preset.settings.sensitivity, 80, 'Sensitivity should be updated');
   626â†’    assertEqual(preset.settings.threshold, -30, 'Threshold should be preserved');
   627â†’  });
   628â†’
   629â†’  // Test 4: Update adds updatedAt timestamp
   630â†’  await runTest('Update adds updatedAt timestamp', async () => {
   631â†’    const create = createCustomPreset({ name: 'Timestamp Test' });
   632â†’    const before = new Date().toISOString();
   633â†’
   634â†’    updateCustomPreset(create.id, { description: 'Updated' });
   635â†’
   636â†’    const after = new Date().toISOString();
   637â†’    const preset = getCustomPreset(create.id);
   638â†’
   639â†’    assert(preset.updatedAt >= before, 'UpdatedAt should be after update start');
   640â†’    assert(preset.updatedAt <= after, 'UpdatedAt should be before update end');
   641â†’  });
   642â†’
   643â†’  // Test 5: Update non-existent preset fails
   644â†’  await runTest('Update non-existent preset fails', async () => {
   645â†’    const result = updateCustomPreset('non-existent-id', { name: 'New Name' });
   646â†’    assert(result.success === false, 'Should fail');
   647â†’    assertEqual(result.error, 'Preset not found', 'Should have correct error');
   648â†’  });
   649â†’
   650â†’  // Test 6: Update with invalid ID fails
   651â†’  await runTest('Update with invalid ID fails', async () => {
   652â†’    const result1 = updateCustomPreset(null, { name: 'Test' });
   653â†’    assert(result1.success === false, 'Should fail for null');
   654â†’
   655â†’    const result2 = updateCustomPreset('', { name: 'Test' });
   656â†’    assert(result2.success === false, 'Should fail for empty string');
   657â†’
   658â†’    const result3 = updateCustomPreset(123, { name: 'Test' });
   659â†’    assert(result3.success === false, 'Should fail for number');
   660â†’  });
   661â†’
   662â†’  // Test 7: Update with invalid updates object fails
   663â†’  await runTest('Update with invalid updates object fails', async () => {
   664â†’    const create = createCustomPreset({ name: 'Test' });
   665â†’
   666â†’    const result1 = updateCustomPreset(create.id, null);
   667â†’    assert(result1.success === false, 'Should fail for null');
   668â†’
   669â†’    const result2 = updateCustomPreset(create.id, 'string');
   670â†’    assert(result2.success === false, 'Should fail for string');
   671â†’  });
   672â†’
   673â†’  // Test 8: Update with empty name fails
   674â†’  await runTest('Update with empty name fails', async () => {
   675â†’    const create = createCustomPreset({ name: 'Test' });
   676â†’
   677â†’    const result = updateCustomPreset(create.id, { name: '' });
   678â†’    assert(result.success === false, 'Should fail for empty name');
   679â†’    assertEqual(result.error, 'Name must be a non-empty string', 'Should have correct error');
   680â†’  });
   681â†’
   682â†’  // Test 9: Update persists across reload
   683â†’  await runTest('Update persists across reload', async () => {
   684â†’    const create = createCustomPreset({ name: 'Persist Test' });
   685â†’    updateCustomPreset(create.id, { name: 'New Name', description: 'New Desc' });
   686â†’
   687â†’    // Reload from storage
   688â†’    const reloaded = loadCustomPresets();
   689â†’    const preset = reloaded.presets[create.id];
   690â†’
   691â†’    assertEqual(preset.name, 'New Name', 'Name should persist');
   692â†’    assertEqual(preset.description, 'New Desc', 'Description should persist');
   693â†’  });
   694â†’
   695â†’  // Test 10: Performance - update 100 presets
   696â†’  await runTest('Performance: update 100 presets < 50ms', async () => {
   697â†’    // Create 100 presets
   698â†’    const ids = [];
   699â†’    for (let i = 0; i < 100; i++) {
   700â†’      const result = createCustomPreset({ name: `Preset ${i}` });
   701â†’      ids.push(result.id);
   702â†’    }
   703â†’
   704â†’    const start = Date.now();
   705â†’    for (const id of ids) {
   706â†’      updateCustomPreset(id, { description: 'Updated' });
   707â†’    }
   708â†’    const elapsed = Date.now() - start;
   709â†’    assert(elapsed < 100, `Should complete in < 100ms (was ${elapsed}ms)`);
   710â†’  });
   711â†’}
   712â†’
   713â†’// =============================================================================
   714â†’// FEATURE 1.4 TESTS: deleteCustomPreset Function
   715â†’// =============================================================================
   716â†’
   717â†’async function testFeature1_4() {
   718â†’  console.log('\nðŸ“¦ Feature 1.4: deleteCustomPreset Function');
   719â†’  console.log('=' .repeat(50));
   720â†’
   721â†’  // Test 1: Delete existing preset
   722â†’  await runTest('Delete existing preset', async () => {
   723â†’    const create = createCustomPreset({ name: 'To Delete' });
   724â†’    assert(create.success, 'Should create preset');
   725â†’
   726â†’    const result = deleteCustomPreset(create.id);
   727â†’    assert(result.success, 'Should delete successfully');
   728â†’
   729â†’    const preset = getCustomPreset(create.id);
   730â†’    assert(preset === null, 'Preset should no longer exist');
   731â†’  });
   732â†’
   733â†’  // Test 2: Delete removes from order array
   734â†’  await runTest('Delete removes from order array', async () => {
   735â†’    createCustomPreset({ name: 'First' });
   736â†’    const second = createCustomPreset({ name: 'Second' });
   737â†’    createCustomPreset({ name: 'Third' });
   738â†’
   739â†’    const data1 = loadCustomPresets();
   740â†’    assertEqual(data1.order.length, 3, 'Should have 3 presets initially');
   741â†’
   742â†’    deleteCustomPreset(second.id);
   743â†’
   744â†’    const data2 = loadCustomPresets();
   745â†’    assertEqual(data2.order.length, 2, 'Should have 2 presets after delete');
   746â†’    assert(!data2.order.includes(second.id), 'Deleted ID should not be in order');
   747â†’    assertEqual(data2.order, ['first', 'third'], 'Order should have remaining presets');
   748â†’  });
   749â†’
   750â†’  // Test 3: Delete non-existent preset fails gracefully
   751â†’  await runTest('Delete non-existent preset fails gracefully', async () => {
   752â†’    const result = deleteCustomPreset('non-existent-id');
   753â†’    assert(result.success === false, 'Should fail');
   754â†’    assertEqual(result.error, 'Preset not found', 'Should have correct error');
   755â†’  });
   756â†’
   757â†’  // Test 4: Delete with invalid ID fails
   758â†’  await runTest('Delete with invalid ID fails', async () => {
   759â†’    const result1 = deleteCustomPreset(null);
   760â†’    assert(result1.success === false, 'Should fail for null');
   761â†’
   762â†’    const result2 = deleteCustomPreset('');
   763â†’    assert(result2.success === false, 'Should fail for empty string');
   764â†’
   765â†’    const result3 = deleteCustomPreset(123);
   766â†’    assert(result3.success === false, 'Should fail for number');
   767â†’  });
   768â†’
   769â†’  // Test 5: Delete persists across reload
   770â†’  await runTest('Delete persists across reload', async () => {
   771â†’    const create = createCustomPreset({ name: 'Persist Delete Test' });
   772â†’    deleteCustomPreset(create.id);
   773â†’
   774â†’    const reloaded = loadCustomPresets();
   775â†’    assert(!reloaded.presets[create.id], 'Preset should not exist after reload');
   776â†’    assert(!reloaded.order.includes(create.id), 'ID should not be in order after reload');
   777â†’  });
   778â†’
   779â†’  // Test 6: Can delete and recreate with same name
   780â†’  await runTest('Can delete and recreate with same name', async () => {
   781â†’    const create1 = createCustomPreset({ name: 'Recyclable' });
   782â†’    assertEqual(create1.id, 'recyclable', 'First should have expected ID');
   783â†’
   784â†’    deleteCustomPreset(create1.id);
   785â†’
   786â†’    const create2 = createCustomPreset({ name: 'Recyclable' });
   787â†’    assertEqual(create2.id, 'recyclable', 'Second should reuse the same ID');
   788â†’  });
   789â†’
   790â†’  // Test 7: Delete all presets
   791â†’  await runTest('Delete all presets', async () => {
   792â†’    const ids = [];
   793â†’    for (let i = 0; i < 5; i++) {
   794â†’      const result = createCustomPreset({ name: `Preset ${i}` });
   795â†’      ids.push(result.id);
   796â†’    }
   797â†’
   798â†’    for (const id of ids) {
   799â†’      deleteCustomPreset(id);
   800â†’    }
   801â†’
   802â†’    const data = loadCustomPresets();
   803â†’    assertEqual(Object.keys(data.presets).length, 0, 'Should have no presets');
   804â†’    assertEqual(data.order.length, 0, 'Should have empty order');
   805â†’  });
   806â†’
   807â†’  // Test 8: Performance - delete 100 presets
   808â†’  await runTest('Performance: delete 100 presets < 50ms', async () => {
   809â†’    const ids = [];
   810â†’    for (let i = 0; i < 100; i++) {
   811â†’      const result = createCustomPreset({ name: `Preset ${i}` });
   812â†’      ids.push(result.id);
   813â†’    }
   814â†’
   815â†’    const start = Date.now();
   816â†’    for (const id of ids) {
   817â†’      deleteCustomPreset(id);
   818â†’    }
   819â†’    const elapsed = Date.now() - start;
   820â†’    assert(elapsed < 100, `Should complete in < 100ms (was ${elapsed}ms)`);
   821â†’
   822â†’    const data = loadCustomPresets();
   823â†’    assertEqual(Object.keys(data.presets).length, 0, 'Should have no presets');
   824â†’  });
   825â†’}
   826â†’
   827â†’// =============================================================================
   828â†’// FEATURE 1.5 TESTS: isBuiltInPreset and getAllPresets
   829â†’// =============================================================================
   830â†’
   831â†’async function testFeature1_5() {
   832â†’  console.log('\nðŸ“¦ Feature 1.5: isBuiltInPreset & getAllPresets');
   833â†’  console.log('=' .repeat(50));
   834â†’
   835â†’  // Test 1: isBuiltInPreset identifies built-in presets
   836â†’  await runTest('isBuiltInPreset identifies built-in presets', async () => {
   837â†’    assert(isBuiltInPreset('custom') === true, 'custom should be built-in');
   838â†’    assert(isBuiltInPreset('podcast') === true, 'podcast should be built-in');
   839â†’    assert(isBuiltInPreset('interview') === true, 'interview should be built-in');
   840â†’    assert(isBuiltInPreset('reaction') === true, 'reaction should be built-in');
   841â†’    assert(isBuiltInPreset('tutorial') === true, 'tutorial should be built-in');
   842â†’    assert(isBuiltInPreset('vlog') === true, 'vlog should be built-in');
   843â†’  });
   844â†’
   845â†’  // Test 2: isBuiltInPreset returns false for custom presets
   846â†’  await runTest('isBuiltInPreset returns false for custom presets', async () => {
   847â†’    const create = createCustomPreset({ name: 'My Custom' });
   848â†’    assert(isBuiltInPreset(create.id) === false, 'Custom preset should not be built-in');
   849â†’    assert(isBuiltInPreset('random-id') === false, 'Random ID should not be built-in');
   850â†’  });
   851â†’
   852â†’  // Test 3: getAllPresets returns built-in presets when no custom
   853â†’  await runTest('getAllPresets returns built-in presets when no custom', async () => {
   854â†’    const all = getAllPresets();
   855â†’    assertEqual(all.length, 6, 'Should have 6 built-in presets');
   856â†’    assertEqual(all[0].id, 'custom', 'First should be custom');
   857â†’    assertEqual(all[5].id, 'vlog', 'Last should be vlog');
   858â†’    assert(all.every(p => p.isBuiltIn === true), 'All should be built-in');
   859â†’  });
   860â†’
   861â†’  // Test 4: getAllPresets includes custom presets after built-in
   862â†’  await runTest('getAllPresets includes custom presets after built-in', async () => {
   863â†’    createCustomPreset({ name: 'First Custom' });
   864â†’    createCustomPreset({ name: 'Second Custom' });
   865â†’
   866â†’    const all = getAllPresets();
   867â†’    assertEqual(all.length, 8, 'Should have 6 built-in + 2 custom');
   868â†’    assertEqual(all[6].name, 'First Custom', 'Custom should come after built-in');
   869â†’    assertEqual(all[7].name, 'Second Custom', 'Second custom after first');
   870â†’    assert(all[6].isBuiltIn === false, 'Custom should have isBuiltIn = false');
   871â†’  });
   872â†’
   873â†’  // Test 5: getAllPresets preserves custom order
   874â†’  await runTest('getAllPresets preserves custom order', async () => {
   875â†’    createCustomPreset({ name: 'Alpha' });
   876â†’    createCustomPreset({ name: 'Beta' });
   877â†’    createCustomPreset({ name: 'Gamma' });
   878â†’
   879â†’    const all = getAllPresets();
   880â†’    const customPresets = all.filter(p => !p.isBuiltIn);
   881â†’    assertEqual(customPresets.map(p => p.name), ['Alpha', 'Beta', 'Gamma'], 'Order preserved');
   882â†’  });
   883â†’
   884â†’  // Test 6: getAllPresets adds isBuiltIn flag correctly
   885â†’  await runTest('getAllPresets adds isBuiltIn flag correctly', async () => {
   886â†’    createCustomPreset({ name: 'Test' });
   887â†’
   888â†’    const all = getAllPresets();
   889â†’    const builtIn = all.filter(p => p.isBuiltIn);
   890â†’    const custom = all.filter(p => !p.isBuiltIn);
   891â†’
   892â†’    assertEqual(builtIn.length, 6, 'Should have 6 built-in');
   893â†’    assertEqual(custom.length, 1, 'Should have 1 custom');
   894â†’  });
   895â†’
   896â†’  // Test 7: getAllPresetIds returns combined IDs
   897â†’  await runTest('getAllPresetIds returns combined IDs', async () => {
   898â†’    createCustomPreset({ name: 'Custom One' });
   899â†’
   900â†’    const ids = getAllPresetIds();
   901â†’    assertEqual(ids.length, 7, 'Should have 6 built-in + 1 custom');
   902â†’    assert(ids.includes('podcast'), 'Should include built-in');
   903â†’    assert(ids.includes('custom-one'), 'Should include custom');
   904â†’  });
   905â†’
   906â†’  // Test 8: getPresetById returns built-in preset
   907â†’  await runTest('getPresetById returns built-in preset', async () => {
   908â†’    const preset = getPresetById('podcast');
   909â†’    assert(preset !== null, 'Should find preset');
   910â†’    assertEqual(preset.name, 'Podcast', 'Name should match');
   911â†’    assertEqual(preset.isBuiltIn, true, 'Should be built-in');
   912â†’  });
   913â†’
   914â†’  // Test 9: getPresetById returns custom preset
   915â†’  await runTest('getPresetById returns custom preset', async () => {
   916â†’    const create = createCustomPreset({ name: 'Find Me', description: 'Test' });
   917â†’
   918â†’    const preset = getPresetById(create.id);
   919â†’    assert(preset !== null, 'Should find preset');
   920â†’    assertEqual(preset.name, 'Find Me', 'Name should match');
   921â†’    assertEqual(preset.description, 'Test', 'Description should match');
   922â†’    assertEqual(preset.isBuiltIn, false, 'Should not be built-in');
   923â†’  });
   924â†’
   925â†’  // Test 10: getPresetById returns null for non-existent
   926â†’  await runTest('getPresetById returns null for non-existent', async () => {
   927â†’    const preset = getPresetById('non-existent-id');
   928â†’    assert(preset === null, 'Should return null');
   929â†’  });
   930â†’
   931â†’  // Test 11: Built-in presets cannot be deleted via deleteCustomPreset
   932â†’  await runTest('Built-in presets cannot be deleted via deleteCustomPreset', async () => {
   933â†’    const result = deleteCustomPreset('podcast');
   934â†’    assert(result.success === false, 'Should fail to delete built-in');
   935â†’    assertEqual(result.error, 'Preset not found', 'Should have correct error');
   936â†’
   937â†’    // Verify it still exists
   938â†’    const preset = getPresetById('podcast');
   939â†’    assert(preset !== null, 'Built-in should still exist');
   940â†’  });
   941â†’}
   942â†’
   943â†’// =============================================================================
   944â†’// PHASE 1 INTEGRATION TESTS
   945â†’// =============================================================================
   946â†’
   947â†’async function testPhase1Integration() {
   948â†’  console.log('\nðŸ“¦ Phase 1 Integration Tests');
   949â†’  console.log('=' .repeat(50));
   950â†’
   951â†’  // Test 1: Full CRUD workflow
   952â†’  await runTest('Full CRUD workflow', async () => {
   953â†’    // Create
   954â†’    const create = createCustomPreset({
   955â†’      name: 'Workflow Test',
   956â†’      description: 'Testing full workflow',
   957â†’      settings: { sensitivity: 60 }
   958â†’    });
   959â†’    assert(create.success, 'Create should succeed');
   960â†’    assertEqual(create.id, 'workflow-test', 'ID should be slugified');
   961â†’
   962â†’    // Read
   963â†’    let preset = getPresetById(create.id);
   964â†’    assertEqual(preset.name, 'Workflow Test', 'Read should return created preset');
   965â†’
   966â†’    // Update
   967â†’    const update = updateCustomPreset(create.id, {
   968â†’      name: 'Updated Workflow',
   969â†’      settings: { sensitivity: 80 }
   970â†’    });
   971â†’    assert(update.success, 'Update should succeed');
   972â†’
   973â†’    preset = getPresetById(create.id);
   974â†’    assertEqual(preset.name, 'Updated Workflow', 'Name should be updated');
   975â†’    assertEqual(preset.settings.sensitivity, 80, 'Settings should be updated');
   976â†’
   977â†’    // Delete
   978â†’    const del = deleteCustomPreset(create.id);
   979â†’    assert(del.success, 'Delete should succeed');
   980â†’
   981â†’    preset = getPresetById(create.id);
   982â†’    assert(preset === null, 'Preset should be gone after delete');
   983â†’  });
   984â†’
   985â†’  // Test 2: Mixed built-in and custom operations
   986â†’  await runTest('Mixed built-in and custom operations', async () => {
   987â†’    // Create some custom presets
   988â†’    createCustomPreset({ name: 'Custom A' });
   989â†’    createCustomPreset({ name: 'Custom B' });
   990â†’
   991â†’    // Get all presets
   992â†’    const all = getAllPresets();
   993â†’    assertEqual(all.length, 8, 'Should have 6 built-in + 2 custom');
   994â†’
   995â†’    // Verify built-in are first
   996â†’    assert(all.slice(0, 6).every(p => p.isBuiltIn), 'First 6 should be built-in');
   997â†’    assert(all.slice(6).every(p => !p.isBuiltIn), 'Last 2 should be custom');
   998â†’
   999â†’    // Try to delete built-in (should fail)
  1000â†’    const delBuiltIn = deleteCustomPreset('vlog');
  1001â†’    assert(delBuiltIn.success === false, 'Cannot delete built-in');
  1002â†’
  1003â†’    // Delete custom (should succeed)
  1004â†’    const delCustom = deleteCustomPreset('custom-a');
  1005â†’    assert(delCustom.success, 'Can delete custom');
  1006â†’
  1007â†’    // Verify list updated
  1008â†’    const updated = getAllPresets();
  1009â†’    assertEqual(updated.length, 7, 'Should have 6 built-in + 1 custom');
  1010â†’  });
  1011â†’
  1012â†’  // Test 3: Backward compatibility with existing settings
  1013â†’  await runTest('Backward compatibility with existing settings', async () => {
  1014â†’    // Simulate existing localStorage data (no custom presets)
  1015â†’    storage.data = {};
  1016â†’
  1017â†’    // Load should return defaults
  1018â†’    const data = loadCustomPresets();
  1019â†’    assertEqual(data.version, 1, 'Version should be 1');
  1020â†’    assertEqual(Object.keys(data.presets).length, 0, 'Should have no presets');
  1021â†’    assertEqual(data.order.length, 0, 'Order should be empty');
  1022â†’
  1023â†’    // Built-in presets should still work
  1024â†’    const all = getAllPresets();
  1025â†’    assertEqual(all.length, 6, 'Built-in presets should be available');
  1026â†’  });
  1027â†’
  1028â†’  // Test 4: No localStorage corruption under stress
  1029â†’  await runTest('No localStorage corruption under stress', async () => {
  1030â†’    // Create, update, delete rapidly
  1031â†’    const ids = [];
  1032â†’    for (let i = 0; i < 50; i++) {
  1033â†’      const create = createCustomPreset({ name: `Stress ${i}` });
  1034â†’      ids.push(create.id);
  1035â†’    }
  1036â†’
  1037â†’    // Update half
  1038â†’    for (let i = 0; i < 25; i++) {
  1039â†’      updateCustomPreset(ids[i], { description: `Updated ${i}` });
  1040â†’    }
  1041â†’
  1042â†’    // Delete quarter
  1043â†’    for (let i = 0; i < 12; i++) {
  1044â†’      deleteCustomPreset(ids[i]);
  1045â†’    }
  1046â†’
  1047â†’    // Verify data integrity
  1048â†’    const data = loadCustomPresets();
  1049â†’    assertEqual(Object.keys(data.presets).length, 38, 'Should have 50-12=38 presets');
  1050â†’    assertEqual(data.order.length, 38, 'Order should match preset count');
  1051â†’
  1052â†’    // Each order entry should exist in presets
  1053â†’    for (const id of data.order) {
  1054â†’      assert(data.presets[id], `Preset ${id} should exist`);
  1055â†’    }
  1056â†’  });
  1057â†’
  1058â†’  // Test 5: Performance - full workflow 100 times
  1059â†’  await runTest('Performance: full CRUD cycle 100 times < 100ms', async () => {
  1060â†’    const start = Date.now();
  1061â†’
  1062â†’    for (let i = 0; i < 100; i++) {
  1063â†’      const create = createCustomPreset({ name: `Perf ${i}` });
  1064â†’      updateCustomPreset(create.id, { description: 'Updated' });
  1065â†’      deleteCustomPreset(create.id);
  1066â†’    }
  1067â†’
  1068â†’    const elapsed = Date.now() - start;
  1069â†’    assert(elapsed < 200, `Should complete in < 200ms (was ${elapsed}ms)`);
  1070â†’
  1071â†’    // Verify clean state
  1072â†’    const data = loadCustomPresets();
  1073â†’    assertEqual(Object.keys(data.presets).length, 0, 'Should have no presets');
  1074â†’  });
  1075â†’}
  1076â†’
  1077â†’// =============================================================================
  1078â†’// PHASE 2 TESTS: UI Functions (simulated)
  1079â†’// =============================================================================
  1080â†’
  1081â†’/**
  1082â†’ * Simulate the refreshPresetDropdown() function from main.js
  1083â†’ * Returns the data that would populate the dropdown
  1084â†’ */
  1085â†’function simulateRefreshDropdown() {
  1086â†’  const presets = getAllPresets();
  1087â†’  return presets.map(preset => ({
  1088â†’    value: preset.id,
  1089â†’    label: preset.name + (preset.description ? ` - ${preset.description}` : ''),
  1090â†’    isBuiltIn: preset.isBuiltIn
  1091â†’  }));
  1092â†’}
  1093â†’
  1094â†’/**
  1095â†’ * Simulate the savePresetFromModal() function from main.js
  1096â†’ * @param {string} name - Preset name
  1097â†’ * @param {string} description - Preset description
  1098â†’ * @param {string} icon - Preset icon
  1099â†’ * @param {string|null} editId - If editing, the preset ID to edit
  1100â†’ * @returns {Object} Result with success and id/error
  1101â†’ */
  1102â†’function simulateSavePreset(name, description, icon, editId = null) {
  1103â†’  if (!name || !name.trim()) {
  1104â†’    return { success: false, error: 'Please enter a preset name' };
  1105â†’  }
  1106â†’
  1107â†’  if (editId) {
  1108â†’    // Update existing preset
  1109â†’    return updateCustomPreset(editId, {
  1110â†’      name: name.trim(),
  1111â†’      description: description || '',
  1112â†’      icon: icon || 'settings'
  1113â†’    });
  1114â†’  } else {
  1115â†’    // Create new preset
  1116â†’    return createCustomPreset({
  1117â†’      name: name.trim(),
  1118â†’      description: description || '',
  1119â†’      icon: icon || 'settings'
  1120â†’    });
  1121â†’  }
  1122â†’}
  1123â†’
  1124â†’/**
  1125â†’ * Simulate the renderPresetsList() function from main.js
  1126â†’ * Returns the data that would be rendered in the manage modal
  1127â†’ */
  1128â†’function simulateRenderPresetsList() {
  1129â†’  const presets = getAllPresets();
  1130â†’  return presets.map(preset => ({
  1131â†’    id: preset.id,
  1132â†’    name: preset.name,
  1133â†’    description: preset.description || (preset.isBuiltIn ? 'Built-in preset' : 'Custom preset'),
  1134â†’    icon: preset.icon,
  1135â†’    isBuiltIn: preset.isBuiltIn,
  1136â†’    hasEditButton: !preset.isBuiltIn,
  1137â†’    hasDeleteButton: !preset.isBuiltIn
  1138â†’  }));
  1139â†’}
  1140â†’
  1141â†’async function testPhase2UI() {
  1142â†’  console.log('\nðŸ“¦ Phase 2: UI Functions (Simulated)');
  1143â†’  console.log('=' .repeat(50));
  1144â†’
  1145â†’  // Test 1: Dropdown shows built-in presets initially
  1146â†’  await runTest('Dropdown shows 6 built-in presets initially', async () => {
  1147â†’    const options = simulateRefreshDropdown();
  1148â†’    assertEqual(options.length, 6, 'Should have 6 options');
  1149â†’    assert(options.every(o => o.isBuiltIn), 'All should be built-in');
  1150â†’    assertEqual(options[0].value, 'custom', 'First should be custom');
  1151â†’    assertEqual(options[5].value, 'vlog', 'Last should be vlog');
  1152â†’  });
  1153â†’
  1154â†’  // Test 2: Dropdown includes custom presets after creation
  1155â†’  await runTest('Dropdown includes custom presets after creation', async () => {
  1156â†’    createCustomPreset({ name: 'My Test Preset', description: 'Test desc' });
  1157â†’
  1158â†’    const options = simulateRefreshDropdown();
  1159â†’    assertEqual(options.length, 7, 'Should have 7 options');
  1160â†’    assertEqual(options[6].value, 'my-test-preset', 'Custom preset should be last');
  1161â†’    assertEqual(options[6].label, 'My Test Preset - Test desc', 'Label should include description');
  1162â†’    assert(!options[6].isBuiltIn, 'Custom preset should not be built-in');
  1163â†’  });
  1164â†’
  1165â†’  // Test 3: Save preset modal - create new preset
  1166â†’  await runTest('Save preset modal creates new preset', async () => {
  1167â†’    const result = simulateSavePreset('New Modal Preset', 'Created via modal', 'mic', null);
  1168â†’    assert(result.success, 'Should succeed');
  1169â†’    assertEqual(result.id, 'new-modal-preset', 'ID should be slugified');
  1170â†’
  1171â†’    const preset = getPresetById(result.id);
  1172â†’    assertEqual(preset.name, 'New Modal Preset', 'Name should match');
  1173â†’    assertEqual(preset.description, 'Created via modal', 'Description should match');
  1174â†’    assertEqual(preset.icon, 'mic', 'Icon should match');
  1175â†’  });
  1176â†’
  1177â†’  // Test 4: Save preset modal - edit existing preset
  1178â†’  await runTest('Save preset modal edits existing preset', async () => {
  1179â†’    const create = createCustomPreset({ name: 'Edit Me', description: 'Original' });
  1180â†’
  1181â†’    const result = simulateSavePreset('Edited Name', 'Updated description', 'star', create.id);
  1182â†’    assert(result.success, 'Should succeed');
  1183â†’
  1184â†’    const preset = getPresetById(create.id);
  1185â†’    assertEqual(preset.name, 'Edited Name', 'Name should be updated');
  1186â†’    assertEqual(preset.description, 'Updated description', 'Description should be updated');
  1187â†’    assertEqual(preset.icon, 'star', 'Icon should be updated');
  1188â†’  });
  1189â†’
  1190â†’  // Test 5: Save preset modal - reject empty name
  1191â†’  await runTest('Save preset modal rejects empty name', async () => {
  1192â†’    const result1 = simulateSavePreset('', '', 'settings', null);
  1193â†’    assert(!result1.success, 'Should fail for empty name');
  1194â†’    assertEqual(result1.error, 'Please enter a preset name', 'Should have correct error');
  1195â†’
  1196â†’    const result2 = simulateSavePreset('   ', '', 'settings', null);
  1197â†’    assert(!result2.success, 'Should fail for whitespace name');
  1198â†’  });
  1199â†’
  1200â†’  // Test 6: Manage presets list shows all presets
  1201â†’  await runTest('Manage presets list shows all presets', async () => {
  1202â†’    createCustomPreset({ name: 'Custom A' });
  1203â†’    createCustomPreset({ name: 'Custom B' });
  1204â†’
  1205â†’    const items = simulateRenderPresetsList();
  1206â†’    const builtIn = items.filter(i => i.isBuiltIn);
  1207â†’    const custom = items.filter(i => !i.isBuiltIn);
  1208â†’
  1209â†’    assertEqual(builtIn.length, 6, 'Should have 6 built-in');
  1210â†’    assert(builtIn.every(i => !i.hasEditButton), 'Built-in should not have edit button');
  1211â†’    assert(builtIn.every(i => !i.hasDeleteButton), 'Built-in should not have delete button');
  1212â†’
  1213â†’    assert(custom.length >= 2, 'Should have at least 2 custom');
  1214â†’    assert(custom.every(i => i.hasEditButton), 'Custom should have edit button');
  1215â†’    assert(custom.every(i => i.hasDeleteButton), 'Custom should have delete button');
  1216â†’  });
  1217â†’
  1218â†’  // Test 7: Delete from manage modal updates list
  1219â†’  await runTest('Delete from manage modal updates list', async () => {
  1220â†’    const create = createCustomPreset({ name: 'Delete From Modal' });
  1221â†’
  1222â†’    let items = simulateRenderPresetsList();
  1223â†’    const beforeCount = items.length;
  1224â†’
  1225â†’    deleteCustomPreset(create.id);
  1226â†’
  1227â†’    items = simulateRenderPresetsList();
  1228â†’    assertEqual(items.length, beforeCount - 1, 'Should have one less item');
  1229â†’    assert(!items.some(i => i.id === create.id), 'Deleted preset should not appear');
  1230â†’  });
  1231â†’
  1232â†’  // Test 8: Dropdown preserves selection after refresh
  1233â†’  await runTest('Dropdown preserves selection after refresh', async () => {
  1234â†’    const create = createCustomPreset({ name: 'Selected Preset' });
  1235â†’
  1236â†’    // Simulate: user selects this preset
  1237â†’    let currentSelection = create.id;
  1238â†’
  1239â†’    // Create another preset (would trigger refresh in UI)
  1240â†’    createCustomPreset({ name: 'Another Preset' });
  1241â†’
  1242â†’    const options = simulateRefreshDropdown();
  1243â†’    const selectedExists = options.some(o => o.value === currentSelection);
  1244â†’
  1245â†’    assert(selectedExists, 'Previously selected preset should still exist');
  1246â†’  });
  1247â†’
  1248â†’  // Test 9: Preset selection applies settings correctly
  1249â†’  await runTest('Preset selection applies custom settings', async () => {
  1250â†’    const create = createCustomPreset({
  1251â†’      name: 'Settings Test',
  1252â†’      settings: { sensitivity: 75, enableTakesDetection: false }
  1253â†’    });
  1254â†’
  1255â†’    const preset = getPresetById(create.id);
  1256â†’    assertEqual(preset.settings.sensitivity, 75, 'Should have custom sensitivity');
  1257â†’    assertEqual(preset.settings.enableTakesDetection, false, 'Should have custom takes setting');
  1258â†’  });
  1259â†’
  1260â†’  // Test 10: Full UI workflow simulation
  1261â†’  await runTest('Full UI workflow: create, edit, delete', async () => {
  1262â†’    // 1. User clicks "+" to save current settings
  1263â†’    const create = simulateSavePreset('Workflow Preset', 'Initial', 'bolt', null);
  1264â†’    assert(create.success, 'Create should succeed');
  1265â†’
  1266â†’    // 2. Dropdown is refreshed
  1267â†’    let options = simulateRefreshDropdown();
  1268â†’    assert(options.some(o => o.value === create.id), 'New preset should appear in dropdown');
  1269â†’
  1270â†’    // 3. User opens manage modal and clicks edit
  1271â†’    let items = simulateRenderPresetsList();
  1272â†’    const presetItem = items.find(i => i.id === create.id);
  1273â†’    assert(presetItem.hasEditButton, 'Preset should have edit button');
  1274â†’
  1275â†’    // 4. User edits the preset
  1276â†’    const edit = simulateSavePreset('Renamed Preset', 'Updated', 'heart', create.id);
  1277â†’    assert(edit.success, 'Edit should succeed');
  1278â†’
  1279â†’    // 5. Verify changes
  1280â†’    const updated = getPresetById(create.id);
  1281â†’    assertEqual(updated.name, 'Renamed Preset', 'Name should be updated');
  1282â†’
  1283â†’    // 6. User deletes the preset
  1284â†’    deleteCustomPreset(create.id);
  1285â†’
  1286â†’    // 7. Verify deletion
  1287â†’    options = simulateRefreshDropdown();
  1288â†’    assert(!options.some(o => o.value === create.id), 'Deleted preset should not appear');
  1289â†’  });
  1290â†’}
  1291â†’
  1292â†’// =============================================================================
  1293â†’// PHASE 3 TESTS: Duplicate, Settings, Export/Import
  1294â†’// =============================================================================
  1295â†’
  1296â†’/**
  1297â†’ * Duplicate a custom preset
  1298â†’ */
  1299â†’function duplicatePreset(id) {
  1300â†’  if (!id || typeof id !== 'string') {
  1301â†’    return { success: false, error: 'Preset ID is required' };
  1302â†’  }
  1303â†’
  1304â†’  const original = getPresetById(id);
  1305â†’  if (!original) {
  1306â†’    return { success: false, error: 'Preset not found' };
  1307â†’  }
  1308â†’
  1309â†’  let copyName = `${original.name} (Copy)`;
  1310â†’  const data = loadCustomPresets();
  1311â†’  let copyNumber = 1;
  1312â†’  let testId = slugifyPresetName(copyName);
  1313â†’  while (data.presets[testId]) {
  1314â†’    copyNumber++;
  1315â†’    copyName = `${original.name} (Copy ${copyNumber})`;
  1316â†’    testId = slugifyPresetName(copyName);
  1317â†’  }
  1318â†’
  1319â†’  return createCustomPreset({
  1320â†’    name: copyName,
  1321â†’    description: original.description || '',
  1322â†’    icon: original.icon || 'settings',
  1323â†’    settings: original.settings ? { ...original.settings } : getCurrentPresetSettings()
  1324â†’  });
  1325â†’}
  1326â†’
  1327â†’/**
  1328â†’ * Export all custom presets to JSON string
  1329â†’ */
  1330â†’function exportPresets() {
  1331â†’  try {
  1332â†’    const data = loadCustomPresets();
  1333â†’    const customPresets = data.order.map(id => data.presets[id]).filter(Boolean);
  1334â†’
  1335â†’    if (customPresets.length === 0) {
  1336â†’      return { success: false, error: 'No custom presets to export' };
  1337â†’    }
  1338â†’
  1339â†’    const exportData = {
  1340â†’      version: 1,
  1341â†’      exportedAt: new Date().toISOString(),
  1342â†’      presets: customPresets
  1343â†’    };
  1344â†’
  1345â†’    return {
  1346â†’      success: true,
  1347â†’      data: JSON.stringify(exportData, null, 2),
  1348â†’      count: customPresets.length
  1349â†’    };
  1350â†’  } catch (e) {
  1351â†’    return { success: false, error: 'Failed to export presets: ' + e.message };
  1352â†’  }
  1353â†’}
  1354â†’
  1355â†’/**
  1356â†’ * Import presets from JSON string
  1357â†’ */
  1358â†’function importPresets(jsonString, merge = true) {
  1359â†’  try {
  1360â†’    const imported = JSON.parse(jsonString);
  1361â†’
  1362â†’    if (!imported || !imported.presets || !Array.isArray(imported.presets)) {
  1363â†’      return { success: false, error: 'Invalid preset file format' };
  1364â†’    }
  1365â†’
  1366â†’    let importedCount = 0;
  1367â†’    let skippedCount = 0;
  1368â†’
  1369â†’    for (const preset of imported.presets) {
  1370â†’      if (!preset.name || typeof preset.name !== 'string') {
  1371â†’        skippedCount++;
  1372â†’        continue;
  1373â†’      }
  1374â†’
  1375â†’      const existingId = slugifyPresetName(preset.name);
  1376â†’      const existing = getCustomPreset(existingId);
  1377â†’
  1378â†’      if (existing && !merge) {
  1379â†’        skippedCount++;
  1380â†’        continue;
  1381â†’      }
  1382â†’
  1383â†’      if (existing && merge) {
  1384â†’        let newName = `${preset.name} (Imported)`;
  1385â†’        let counter = 1;
  1386â†’        while (getCustomPreset(slugifyPresetName(newName))) {
  1387â†’          counter++;
  1388â†’          newName = `${preset.name} (Imported ${counter})`;
  1389â†’        }
  1390â†’        preset.name = newName;
  1391â†’      }
  1392â†’
  1393â†’      const result = createCustomPreset({
  1394â†’        name: preset.name,
  1395â†’        description: preset.description || '',
  1396â†’        icon: preset.icon || 'settings',
  1397â†’        settings: preset.settings || getCurrentPresetSettings()
  1398â†’      });
  1399â†’
  1400â†’      if (result.success) {
  1401â†’        importedCount++;
  1402â†’      } else {
  1403â†’        skippedCount++;
  1404â†’      }
  1405â†’    }
  1406â†’
  1407â†’    if (importedCount === 0 && skippedCount > 0) {
  1408â†’      return { success: false, error: 'All presets already exist or were invalid', skipped: skippedCount };
  1409â†’    }
  1410â†’
  1411â†’    return { success: true, imported: importedCount, skipped: skippedCount };
  1412â†’  } catch (e) {
  1413â†’    if (e instanceof SyntaxError) {
  1414â†’      return { success: false, error: 'Invalid JSON format' };
  1415â†’    }
  1416â†’    return { success: false, error: 'Failed to import presets: ' + e.message };
  1417â†’  }
  1418â†’}
  1419â†’
  1420â†’async function testPhase3Duplicate() {
  1421â†’  console.log('\nðŸ“¦ Phase 3.1: Duplicate Preset');
  1422â†’  console.log('=' .repeat(50));
  1423â†’
  1424â†’  // Test 1: Duplicate a custom preset
  1425â†’  await runTest('Duplicate custom preset creates copy', async () => {
  1426â†’    const create = createCustomPreset({
  1427â†’      name: 'Original',
  1428â†’      description: 'Original desc',
  1429â†’      icon: 'mic',
  1430â†’      settings: { sensitivity: 75 }
  1431â†’    });
  1432â†’    assert(create.success, 'Should create original');
  1433â†’
  1434â†’    const duplicate = duplicatePreset(create.id);
  1435â†’    assert(duplicate.success, 'Should duplicate successfully');
  1436â†’    assert(duplicate.id !== create.id, 'Should have different ID');
  1437â†’
  1438â†’    const copy = getPresetById(duplicate.id);
  1439â†’    assertEqual(copy.name, 'Original (Copy)', 'Copy should have (Copy) suffix');
  1440â†’    assertEqual(copy.description, 'Original desc', 'Description should be copied');
  1441â†’    assertEqual(copy.icon, 'mic', 'Icon should be copied');
  1442â†’    assertEqual(copy.settings.sensitivity, 75, 'Settings should be copied');
  1443â†’  });
  1444â†’
  1445â†’  // Test 2: Duplicate with existing copy creates numbered suffix
  1446â†’  await runTest('Duplicate existing copy increments number', async () => {
  1447â†’    createCustomPreset({ name: 'Multi' });
  1448â†’    duplicatePreset('multi');
  1449â†’    const third = duplicatePreset('multi');
  1450â†’
  1451â†’    assert(third.success, 'Should duplicate again');
  1452â†’    const copy = getPresetById(third.id);
  1453â†’    assertEqual(copy.name, 'Multi (Copy 2)', 'Should have numbered suffix');
  1454â†’  });
  1455â†’
  1456â†’  // Test 3: Duplicate built-in preset
  1457â†’  await runTest('Duplicate built-in preset works', async () => {
  1458â†’    const result = duplicatePreset('podcast');
  1459â†’    assert(result.success, 'Should duplicate built-in');
  1460â†’
  1461â†’    const copy = getPresetById(result.id);
  1462â†’    assertEqual(copy.name, 'Podcast (Copy)', 'Should have built-in name with copy suffix');
  1463â†’    assert(!copy.isBuiltIn, 'Copy should not be built-in');
  1464â†’  });
  1465â†’
  1466â†’  // Test 4: Duplicate non-existent preset fails
  1467â†’  await runTest('Duplicate non-existent preset fails', async () => {
  1468â†’    const result = duplicatePreset('non-existent');
  1469â†’    assert(!result.success, 'Should fail');
  1470â†’    assertEqual(result.error, 'Preset not found', 'Should have correct error');
  1471â†’  });
  1472â†’
  1473â†’  // Test 5: Duplicate with invalid ID fails
  1474â†’  await runTest('Duplicate with invalid ID fails', async () => {
  1475â†’    const result = duplicatePreset(null);
  1476â†’    assert(!result.success, 'Should fail for null');
  1477â†’    assertEqual(result.error, 'Preset ID is required', 'Should have correct error');
  1478â†’  });
  1479â†’}
  1480â†’
  1481â†’async function testPhase3Settings() {
  1482â†’  console.log('\nðŸ“¦ Phase 3.2: Settings in Preset Modal');
  1483â†’  console.log('=' .repeat(50));
  1484â†’
  1485â†’  // Test 1: Create preset with custom settings
  1486â†’  await runTest('Create preset with custom sensitivity and threshold', async () => {
  1487â†’    const result = createCustomPreset({
  1488â†’      name: 'Custom Settings Test',
  1489â†’      settings: { sensitivity: 80, threshold: -25 }
  1490â†’    });
  1491â†’    assert(result.success, 'Should create preset');
  1492â†’
  1493â†’    const preset = getPresetById(result.id);
  1494â†’    assertEqual(preset.settings.sensitivity, 80, 'Sensitivity should be 80');
  1495â†’    assertEqual(preset.settings.threshold, -25, 'Threshold should be -25');
  1496â†’  });
  1497â†’
  1498â†’  // Test 2: Update preset settings
  1499â†’  await runTest('Update preset settings', async () => {
  1500â†’    const create = createCustomPreset({
  1501â†’      name: 'Settings Update Test',
  1502â†’      settings: { sensitivity: 50, threshold: -32 }
  1503â†’    });
  1504â†’
  1505â†’    const update = updateCustomPreset(create.id, {
  1506â†’      settings: { sensitivity: 90, threshold: -20 }
  1507â†’    });
  1508â†’    assert(update.success, 'Should update successfully');
  1509â†’
  1510â†’    const preset = getPresetById(create.id);
  1511â†’    assertEqual(preset.settings.sensitivity, 90, 'Sensitivity should be updated');
  1512â†’    assertEqual(preset.settings.threshold, -20, 'Threshold should be updated');
  1513â†’  });
  1514â†’
  1515â†’  // Test 3: Partial settings update preserves other settings
  1516â†’  await runTest('Partial settings update preserves other fields', async () => {
  1517â†’    const create = createCustomPreset({
  1518â†’      name: 'Partial Update Test',
  1519â†’      settings: { sensitivity: 60, threshold: -30, minSilenceLength: 0.5 }
  1520â†’    });
  1521â†’
  1522â†’    updateCustomPreset(create.id, {
  1523â†’      settings: { sensitivity: 70 }
  1524â†’    });
  1525â†’
  1526â†’    const preset = getPresetById(create.id);
  1527â†’    assertEqual(preset.settings.sensitivity, 70, 'Sensitivity should be updated');
  1528â†’    assertEqual(preset.settings.threshold, -30, 'Threshold should be preserved');
  1529â†’    assertEqual(preset.settings.minSilenceLength, 0.5, 'Other settings should be preserved');
  1530â†’  });
  1531â†’
  1532â†’  // Test 4: Settings are applied when preset is selected (simulated)
  1533â†’  await runTest('Preset settings can be retrieved correctly', async () => {
  1534â†’    const create = createCustomPreset({
  1535â†’      name: 'Apply Test',
  1536â†’      settings: { sensitivity: 85, threshold: -28 }
  1537â†’    });
  1538â†’
  1539â†’    const preset = getPresetById(create.id);
  1540â†’    assertEqual(preset.settings.sensitivity, 85, 'Should retrieve sensitivity');
  1541â†’    assertEqual(preset.settings.threshold, -28, 'Should retrieve threshold');
  1542â†’  });
  1543â†’}
  1544â†’
  1545â†’async function testPhase3ExportImport() {
  1546â†’  console.log('\nðŸ“¦ Phase 3.3: Export/Import Presets');
  1547â†’  console.log('=' .repeat(50));
  1548â†’
  1549â†’  // Test 1: Export single preset
  1550â†’  await runTest('Export single preset', async () => {
  1551â†’    createCustomPreset({
  1552â†’      name: 'Export Test',
  1553â†’      description: 'For export',
  1554â†’      settings: { sensitivity: 55 }
  1555â†’    });
  1556â†’
  1557â†’    const result = exportPresets();
  1558â†’    assert(result.success, 'Should export successfully');
  1559â†’    assertEqual(result.count, 1, 'Should have 1 preset');
  1560â†’    assert(result.data.includes('Export Test'), 'Should contain preset name');
  1561â†’    assert(result.data.includes('"sensitivity": 55'), 'Should contain settings');
  1562â†’  });
  1563â†’
  1564â†’  // Test 2: Export multiple presets
  1565â†’  await runTest('Export multiple presets', async () => {
  1566â†’    createCustomPreset({ name: 'Export A' });
  1567â†’    createCustomPreset({ name: 'Export B' });
  1568â†’    createCustomPreset({ name: 'Export C' });
  1569â†’
  1570â†’    const result = exportPresets();
  1571â†’    assert(result.success, 'Should export successfully');
  1572â†’    assertEqual(result.count, 3, 'Should have 3 presets');
  1573â†’  });
  1574â†’
  1575â†’  // Test 3: Export with no presets fails
  1576â†’  await runTest('Export with no presets fails', async () => {
  1577â†’    const result = exportPresets();
  1578â†’    assert(!result.success, 'Should fail');
  1579â†’    assertEqual(result.error, 'No custom presets to export', 'Should have correct error');
  1580â†’  });
  1581â†’
  1582â†’  // Test 4: Import valid JSON
  1583â†’  await runTest('Import valid JSON creates presets', async () => {
  1584â†’    const json = JSON.stringify({
  1585â†’      version: 1,
  1586â†’      presets: [
  1587â†’        { name: 'Imported A', description: 'From file', settings: { sensitivity: 65 } },
  1588â†’        { name: 'Imported B', description: 'From file 2', settings: { sensitivity: 45 } }
  1589â†’      ]
  1590â†’    });
  1591â†’
  1592â†’    const result = importPresets(json, true);
  1593â†’    assert(result.success, 'Should import successfully');
  1594â†’    assertEqual(result.imported, 2, 'Should import 2 presets');
  1595â†’
  1596â†’    const presetA = getPresetById('imported-a');
  1597â†’    assert(presetA, 'Preset A should exist');
  1598â†’    assertEqual(presetA.settings.sensitivity, 65, 'Settings should be imported');
  1599â†’  });
  1600â†’
  1601â†’  // Test 5: Import with merge mode renames duplicates
  1602â†’  await runTest('Import merge mode renames duplicates', async () => {
  1603â†’    createCustomPreset({ name: 'Exists' });
  1604â†’
  1605â†’    const json = JSON.stringify({
  1606â†’      version: 1,
  1607â†’      presets: [{ name: 'Exists', settings: { sensitivity: 99 } }]
  1608â†’    });
  1609â†’
  1610â†’    const result = importPresets(json, true);
  1611â†’    assert(result.success, 'Should import successfully');
  1612â†’    assertEqual(result.imported, 1, 'Should import 1 preset');
  1613â†’
  1614â†’    const imported = getPresetById('exists-imported');
  1615â†’    assert(imported, 'Imported preset should exist with renamed ID');
  1616â†’  });
  1617â†’
  1618â†’  // Test 6: Import without merge skips duplicates
  1619â†’  await runTest('Import without merge skips duplicates', async () => {
  1620â†’    createCustomPreset({ name: 'Skip Test' });
  1621â†’
  1622â†’    const json = JSON.stringify({
  1623â†’      version: 1,
  1624â†’      presets: [{ name: 'Skip Test' }]
  1625â†’    });
  1626â†’
  1627â†’    const result = importPresets(json, false);
  1628â†’    assert(!result.success, 'Should fail when all skipped');
  1629â†’    assertEqual(result.skipped, 1, 'Should skip 1 preset');
  1630â†’  });
  1631â†’
  1632â†’  // Test 7: Import invalid JSON fails
  1633â†’  await runTest('Import invalid JSON fails', async () => {
  1634â†’    const result = importPresets('not valid json{{{');
  1635â†’    assert(!result.success, 'Should fail');
  1636â†’    assertEqual(result.error, 'Invalid JSON format', 'Should have correct error');
  1637â†’  });
  1638â†’
  1639â†’  // Test 8: Import invalid structure fails
  1640â†’  await runTest('Import invalid structure fails', async () => {
  1641â†’    const json = JSON.stringify({ foo: 'bar' });
  1642â†’    const result = importPresets(json);
  1643â†’    assert(!result.success, 'Should fail');
  1644â†’    assertEqual(result.error, 'Invalid preset file format', 'Should have correct error');
  1645â†’  });
  1646â†’
  1647â†’  // Test 9: Round-trip export/import
  1648â†’  await runTest('Round-trip export then import', async () => {
  1649â†’    // Create presets
  1650â†’    createCustomPreset({ name: 'Round Trip A', settings: { sensitivity: 77 } });
  1651â†’    createCustomPreset({ name: 'Round Trip B', settings: { threshold: -22 } });
  1652â†’
  1653â†’    // Export
  1654â†’    const exported = exportPresets();
  1655â†’    assert(exported.success, 'Should export');
  1656â†’
  1657â†’    // Clear and reimport
  1658â†’    storage.data = {};
  1659â†’    const imported = importPresets(exported.data);
  1660â†’    assert(imported.success, 'Should import');
  1661â†’    assertEqual(imported.imported, 2, 'Should import both');
  1662â†’
  1663â†’    // Verify
  1664â†’    const presetA = getPresetById('round-trip-a');
  1665â†’    assertEqual(presetA.settings.sensitivity, 77, 'Settings should survive round-trip');
  1666â†’  });
  1667â†’
  1668â†’  // Test 10: Import skips presets with missing name
  1669â†’  await runTest('Import skips presets with missing name', async () => {
  1670â†’    const json = JSON.stringify({
  1671â†’      version: 1,
  1672â†’      presets: [
  1673â†’        { name: 'Valid' },
  1674â†’        { description: 'No name' },
  1675â†’        { name: '' }
  1676â†’      ]
  1677â†’    });
  1678â†’
  1679â†’    const result = importPresets(json);
  1680â†’    assert(result.success, 'Should succeed with partial import');
  1681â†’    assertEqual(result.imported, 1, 'Should import 1 valid preset');
  1682â†’    assertEqual(result.skipped, 2, 'Should skip 2 invalid presets');
  1683â†’  });
  1684â†’}
  1685â†’
  1686â†’async function testPhase3Integration() {
  1687â†’  console.log('\nðŸ“¦ Phase 3 Integration Tests');
  1688â†’  console.log('=' .repeat(50));
  1689â†’
  1690â†’  // Test 1: Full workflow: create, duplicate, edit settings, export
  1691â†’  await runTest('Full Phase 3 workflow', async () => {
  1692â†’    // Create a preset
  1693â†’    const create = createCustomPreset({
  1694â†’      name: 'Workflow Preset',
  1695â†’      settings: { sensitivity: 60, threshold: -30 }
  1696â†’    });
  1697â†’    assert(create.success, 'Should create preset');
  1698â†’
  1699â†’    // Duplicate it
  1700â†’    const duplicate = duplicatePreset(create.id);
  1701â†’    assert(duplicate.success, 'Should duplicate');
  1702â†’
  1703â†’    // Edit the copy's settings
  1704â†’    updateCustomPreset(duplicate.id, {
  1705â†’      settings: { sensitivity: 80 }
  1706â†’    });
  1707â†’
  1708â†’    // Verify both exist with correct settings
  1709â†’    const original = getPresetById(create.id);
  1710â†’    const copy = getPresetById(duplicate.id);
  1711â†’    assertEqual(original.settings.sensitivity, 60, 'Original unchanged');
  1712â†’    assertEqual(copy.settings.sensitivity, 80, 'Copy updated');
  1713â†’
  1714â†’    // Export both
  1715â†’    const exported = exportPresets();
  1716â†’    assert(exported.success, 'Should export');
  1717â†’    assertEqual(exported.count, 2, 'Should have 2 presets');
  1718â†’  });
  1719â†’
  1720â†’  // Test 2: Duplicate, modify, delete original
  1721â†’  await runTest('Duplicate then delete original', async () => {
  1722â†’    const create = createCustomPreset({ name: 'To Delete' });
  1723â†’    const duplicate = duplicatePreset(create.id);
  1724â†’
  1725â†’    deleteCustomPreset(create.id);
  1726â†’
  1727â†’    assert(!getPresetById(create.id), 'Original should be gone');
  1728â†’    assert(getPresetById(duplicate.id), 'Copy should remain');
  1729â†’  });
  1730â†’
  1731â†’  // Test 3: Import with settings, then duplicate
  1732â†’  await runTest('Import then duplicate', async () => {
  1733â†’    const json = JSON.stringify({
  1734â†’      version: 1,
  1735â†’      presets: [{ name: 'Imported For Dup', settings: { sensitivity: 88 } }]
  1736â†’    });
  1737â†’
  1738â†’    importPresets(json);
  1739â†’    const dup = duplicatePreset('imported-for-dup');
  1740â†’    assert(dup.success, 'Should duplicate imported preset');
  1741â†’
  1742â†’    const copy = getPresetById(dup.id);
  1743â†’    assertEqual(copy.settings.sensitivity, 88, 'Settings should be duplicated from import');
  1744â†’  });
  1745â†’}
  1746â†’
  1747â†’// =============================================================================
  1748â†’// MAIN TEST RUNNER
  1749â†’// =============================================================================
  1750â†’
  1751â†’async function runAllTests() {
  1752â†’  console.log('\n' + '='.repeat(60));
  1753â†’  console.log('ðŸ§ª Custom Presets E2E Tests - Phase 1, 2 & 3');
  1754â†’  console.log('='.repeat(60));
  1755â†’
  1756â†’  await testFeature1_1();
  1757â†’  await testFeature1_2();
  1758â†’  await testFeature1_3();
  1759â†’  await testFeature1_4();
  1760â†’  await testFeature1_5();
  1761â†’  await testPhase1Integration();
  1762â†’  await testPhase2UI();
  1763â†’  await testPhase3Duplicate();
  1764â†’  await testPhase3Settings();
  1765â†’  await testPhase3ExportImport();
  1766â†’  await testPhase3Integration();
  1767â†’
  1768â†’  // Summary
  1769â†’  console.log('\n' + '='.repeat(60));
  1770â†’  console.log('ðŸ“Š Test Summary');
  1771â†’  console.log('='.repeat(60));
  1772â†’  console.log(`  Total: ${testsPassed + testsFailed}`);
  1773â†’  console.log(`  Passed: ${testsPassed}`);
  1774â†’  console.log(`  Failed: ${testsFailed}`);
  1775â†’  console.log(`  Duration: ${Date.now() - startTime}ms`);
  1776â†’
  1777â†’  if (testsFailed > 0) {
  1778â†’    console.log('\nâŒ Some tests failed!');
  1779â†’    process.exit(1);
  1780â†’  } else {
  1781â†’    console.log('\nâœ… All tests passed!');
  1782â†’    process.exit(0);
  1783â†’  }
  1784â†’}
  1785â†’
  1786â†’// Restore console.warn at the end
  1787â†’process.on('exit', () => {
  1788â†’  console.warn = originalWarn;
  1789â†’});
  1790â†’
  1791â†’runAllTests().catch(err => {
  1792â†’  console.error('Test runner error:', err);
  1793â†’  process.exit(1);
  1794â†’});
  1795â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
