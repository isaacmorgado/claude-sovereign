     1→     1→/**
     2→     2→ * Phase 1 E2E Tests - UI Critical Fixes
     3→     3→ * Tests: Confirmation Modal, UXP File Import, Batch Event Delegation
     4→     4→ */
     5→     5→
     6→     6→const fs = require('fs');
     7→     7→const path = require('path');
     8→     8→
     9→     9→const PLUGIN_DIR = path.join(__dirname, '../../splice-plugin');
    10→    10→const mainJs = fs.readFileSync(path.join(PLUGIN_DIR, 'js/main.js'), 'utf8');
    11→    11→const indexHtml = fs.readFileSync(path.join(PLUGIN_DIR, 'index.html'), 'utf8');
    12→    12→
    13→    13→let passed = 0;
    14→    14→let failed = 0;
    15→    15→
    16→    16→function test(name, fn) {
    17→    17→  try {
    18→    18→    fn();
    19→    19→    console.log(`✓ ${name}`);
    20→    20→    passed++;
    21→    21→  } catch (err) {
    22→    22→    console.log(`✗ ${name}`);
    23→    23→    console.log(`  Error: ${err.message}`);
    24→    24→    failed++;
    25→    25→  }
    26→    26→}
    27→    27→
    28→    28→function assert(condition, message) {
    29→    29→  if (!condition) throw new Error(message);
    30→    30→}
    31→    31→
    32→    32→console.log('\n=== Phase 1 E2E Tests ===\n');
    33→    33→
    34→    34→// ============================================================================
    35→    35→// TEST 1.1: Confirmation Modal
    36→    36→// ============================================================================
    37→    37→console.log('--- Test 1.1: Confirmation Modal ---');
    38→    38→
    39→    39→test('Modal HTML elements exist', () => {
    40→    40→  const elements = [
    41→    41→    'confirmModal', 'confirmModalTitle', 'confirmModalMessage',
    42→    42→    'confirmModalConfirmBtn', 'confirmModalCancelBtn', 'closeConfirmModalBtn'
    43→    43→  ];
    44→    44→  elements.forEach(el => {
    45→    45→    assert(indexHtml.includes(`id="${el}"`), `Missing element: ${el}`);
    46→    46→  });
    47→    47→});
    48→    48→
    49→    49→test('Modal has ARIA attributes', () => {
    50→    50→  assert(indexHtml.includes('role="dialog"'), 'Missing role="dialog"');
    51→    51→  assert(indexHtml.includes('aria-modal="true"'), 'Missing aria-modal');
    52→    52→  assert(indexHtml.includes('aria-labelledby="confirmModalTitle"'), 'Missing aria-labelledby');
    53→    53→});
    54→    54→
    55→    55→test('UI cache includes modal elements', () => {
    56→    56→  const elements = [
    57→    57→    'confirmModal', 'confirmModalTitle', 'confirmModalMessage',
    58→    58→    'confirmModalConfirmBtn', 'confirmModalCancelBtn', 'closeConfirmModalBtn'
    59→    59→  ];
    60→    60→  elements.forEach(el => {
    61→    61→    assert(mainJs.includes(`ui.${el} = document.getElementById`), `Missing UI cache: ${el}`);
    62→    62→  });
    63→    63→});
    64→    64→
    65→    65→test('initConfirmModal() is called in DOMContentLoaded', () => {
    66→    66→  assert(mainJs.includes('initConfirmModal()'), 'initConfirmModal() not called');
    67→    67→});
    68→    68→
    69→    69→test('showConfirmModal() has correct signature', () => {
    70→    70→  assert(
    71→    71→    mainJs.includes('function showConfirmModal(title, message, onConfirm'),
    72→    72→    'showConfirmModal missing or wrong signature'
    73→    73→  );
    74→    74→});
    75→    75→
    76→    76→test('hideConfirmModal() handles callbacks', () => {
    77→    77→  assert(mainJs.includes('function hideConfirmModal(confirmed'), 'hideConfirmModal missing');
    78→    78→  assert(mainJs.includes('confirmModalCallback.onConfirm()'), 'Missing onConfirm callback');
    79→    79→});
    80→    80→
    81→    81→test('deletePresetWithConfirm uses showConfirmModal (not confirm())', () => {
    82→    82→  const funcMatch = mainJs.match(/function deletePresetWithConfirm[\s\S]*?^\}/m);
    83→    83→  assert(funcMatch, 'deletePresetWithConfirm not found');
    84→    84→  assert(!funcMatch[0].includes('confirm('), 'Still uses confirm()');
    85→    85→  assert(funcMatch[0].includes('showConfirmModal'), 'Does not use showConfirmModal');
    86→    86→});
    87→    87→
    88→    88→test('Modal keyboard handlers exist', () => {
    89→    89→  assert(mainJs.includes("e.key === 'Escape'"), 'Missing Escape handler');
    90→    90→  assert(mainJs.includes("e.key === 'Enter'"), 'Missing Enter handler');
    91→    91→});
    92→    92→
    93→    93→test('Modal backdrop click closes modal', () => {
    94→    94→  assert(mainJs.includes('e.target === ui.confirmModal'), 'Missing backdrop click handler');
    95→    95→});
    96→    96→
    97→    97→// ============================================================================
    98→    98→// TEST 1.2 + 1.4: UXP File Import
    99→    99→// ============================================================================
   100→   100→console.log('\n--- Test 1.2 + 1.4: UXP File Import ---');
   101→   101→
   102→   102→test('FileReader is not used (only in comments)', () => {
   103→   103→  const lines = mainJs.split('\n');
   104→   104→  lines.forEach((line, i) => {
   105→   105→    if (line.includes('new FileReader') && !line.trim().startsWith('*') && !line.trim().startsWith('//')) {
   106→   106→      throw new Error(`FileReader used at line ${i + 1}`);
   107→   107→    }
   108→   108→  });
   109→   109→});
   110→   110→
   111→   111→test('importPresetsFromFile uses UXP file API', () => {
   112→   112→  const funcMatch = mainJs.match(/async function importPresetsFromFile[\s\S]*?^}/m);
   113→   113→  assert(funcMatch, 'importPresetsFromFile not found');
   114→   114→  assert(funcMatch[0].includes('getFileForOpening'), 'Missing getFileForOpening');
   115→   115→  assert(funcMatch[0].includes('file.read()'), 'Missing file.read()');
   116→   116→});
   117→   117→
   118→   118→test('importPresetsFromFile has no file parameter (uses picker)', () => {
   119→   119→  assert(mainJs.includes('async function importPresetsFromFile()'), 'Should have no parameters');
   120→   120→});
   121→   121→
   122→   122→test('Hidden file input removed from HTML', () => {
   123→   123→  assert(!indexHtml.includes('importPresetsFile'), 'importPresetsFile still in HTML');
   124→   124→  assert(!indexHtml.includes('type="file"'), 'type="file" input still exists');
   125→   125→});
   126→   126→
   127→   127→test('Import button directly calls importPresetsFromFile', () => {
   128→   128→  assert(mainJs.includes('importPresetsBtn.addEventListener'), 'Missing event listener');
   129→   129→  assert(!mainJs.includes('importPresetsFile.click()'), 'Still clicking file input');
   130→   130→});
   131→   131→
   132→   132→test('Import handles empty/cancelled file picker', () => {
   133→   133→  const funcMatch = mainJs.match(/async function importPresetsFromFile[\s\S]*?^}/m);
   134→   134→  assert(funcMatch[0].includes('if (!file)'), 'Missing null file check');
   135→   135→});
   136→   136→
   137→   137→test('Import has error handling', () => {
   138→   138→  const funcMatch = mainJs.match(/async function importPresetsFromFile[\s\S]*?^}/m);
   139→   139→  assert(funcMatch[0].includes('catch (err)'), 'Missing error handling');
   140→   140→  assert(funcMatch[0].includes('setStatus'), 'Missing status feedback');
   141→   141→});
   142→   142→
   143→   143→// ============================================================================
   144→   144→// TEST 1.3: Batch Event Delegation
   145→   145→// ============================================================================
   146→   146→console.log('\n--- Test 1.3: Batch Event Delegation ---');
   147→   147→
   148→   148→test('No inline onclick in batch list', () => {
   149→   149→  const lines = mainJs.split('\n');
   150→   150→  lines.forEach((line, i) => {
   151→   151→    if (line.includes('onclick=') && line.includes('removeBatchItem')) {
   152→   152→      throw new Error(`Inline onclick at line ${i + 1}`);
   153→   153→    }
   154→   154→  });
   155→   155→});
   156→   156→
   157→   157→test('Batch items use data-index attribute', () => {
   158→   158→  assert(mainJs.includes('data-index="${i}"'), 'Missing data-index attribute');
   159→   159→  assert(mainJs.includes('class="batch-remove-btn"'), 'Missing batch-remove-btn class');
   160→   160→});
   161→   161→
   162→   162→test('Event delegation in initBatchHandlers', () => {
   163→   163→  assert(mainJs.includes("batchList.addEventListener('click'"), 'Missing event delegation');
   164→   164→  assert(mainJs.includes(".closest('.batch-remove-btn')"), 'Missing closest() check');
   165→   165→});
   166→   166→
   167→   167→test('Data-index is parsed correctly', () => {
   168→   168→  assert(mainJs.includes('parseInt(removeBtn.dataset.index, 10)'), 'Missing parseInt for index');
   169→   169→});
   170→   170→
   171→   171→test('Batch remove has bounds checking', () => {
   172→   172→  assert(mainJs.includes('index >= 0 && index < batchQueue.length'), 'Missing bounds check');
   173→   173→});
   174→   174→
   175→   175→test('Batch remove buttons have aria-label', () => {
   176→   176→  assert(mainJs.includes('aria-label="Remove'), 'Missing aria-label on remove buttons');
   177→   177→});
   178→   178→
   179→   179→// ============================================================================
   180→   180→// INTEGRATION CHECKS
   181→   181→// ============================================================================
   182→   182→console.log('\n--- Integration Checks ---');
   183→   183→
   184→   184→test('No confirm() calls in plugin code', () => {
   185→   185→  const lines = mainJs.split('\n');
   186→   186→  lines.forEach((line, i) => {
   187→   187→    // Skip comments and the replacement function
   188→   188→    if (line.trim().startsWith('//') || line.trim().startsWith('*')) return;
   189→   189→    if (line.includes('replacement for confirm()')) return;
   190→   190→    if (line.includes('confirm(') && !line.includes('showConfirmModal') && !line.includes('Confirm')) {
   191→   191→      throw new Error(`confirm() used at line ${i + 1}: ${line.trim()}`);
   192→   192→    }
   193→   193→  });
   194→   194→});
   195→   195→
   196→   196→test('All UI elements cached before use', () => {
   197→   197→  // Check that cacheUIElements is called first in DOMContentLoaded handler
   198→   198→  // Use the final "Plugin initialized" log as end marker (not earlier logs)
   199→   199→  const domContentLoaded = mainJs.match(/DOMContentLoaded[^{]*\{([\s\S]*?)\[SPLICE\] Plugin initialized/);
   200→   200→  assert(domContentLoaded, 'DOMContentLoaded block not found');
   201→   201→  const initOrder = domContentLoaded[1];
   202→   202→  const cachePos = initOrder.indexOf('cacheUIElements()');
   203→   203→  const confirmPos = initOrder.indexOf('initConfirmModal()');
   204→   204→  assert(cachePos !== -1, 'cacheUIElements() not found in init block');
   205→   205→  assert(confirmPos !== -1, 'initConfirmModal() not found in init block');
   206→   206→  assert(cachePos < confirmPos, 'cacheUIElements must be called before initConfirmModal');
   207→   207→});
   208→   208→
   209→   209→test('No JavaScript syntax errors (basic check)', () => {
   210→   210→  // Check for common issues
   211→   211→  assert(!mainJs.includes('function function'), 'Double function keyword');
   212→   212→  assert(!mainJs.includes('const const'), 'Double const keyword');
   213→   213→  assert(!mainJs.includes('let let'), 'Double let keyword');
   214→   214→});
   215→   215→
   216→   216→// ============================================================================
   217→   217→// SUMMARY
   218→   218→// ============================================================================
   219→   219→console.log('\n=== Summary ===');
   220→   220→console.log(`Passed: ${passed}`);
   221→   221→console.log(`Failed: ${failed}`);
   222→   222→console.log(`Total:  ${passed + failed}`);
   223→   223→
   224→   224→if (failed > 0) {
   225→   225→  console.log('\n❌ SOME TESTS FAILED - Fix issues and re-run');
   226→   226→  process.exit(1);
   227→   227→} else {
   228→   228→  console.log('\n✅ ALL TESTS PASSED');
   229→   229→  process.exit(0);
   230→   230→}
   231→   231→
   232→
   233→<system-reminder>
   234→Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
   235→</system-reminder>
   236→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
