     1â†’/**
     2â†’ * Comprehensive UI E2E Tests
     3â†’ *
     4â†’ * Simulates full UI workflow to verify:
     5â†’ * 1. All UI elements are correctly wired
     6â†’ * 2. Event handlers fire correctly
     7â†’ * 3. State management is consistent
     8â†’ * 4. No performance bottlenecks
     9â†’ * 5. Error handling works properly
    10â†’ */
    11â†’
    12â†’// =============================================================================
    13â†’// MOCK ENVIRONMENT SETUP
    14â†’// =============================================================================
    15â†’
    16â†’// Simulate localStorage
    17â†’const storage = { data: {} };
    18â†’global.localStorage = {
    19â†’  getItem: (key) => storage.data[key] || null,
    20â†’  setItem: (key, value) => { storage.data[key] = value; },
    21â†’  removeItem: (key) => { delete storage.data[key]; },
    22â†’  clear: () => { storage.data = {}; }
    23â†’};
    24â†’
    25â†’// Mock DOM elements
    26â†’const mockElements = {};
    27â†’function createMockElement(id, type = 'div') {
    28â†’  return {
    29â†’    id,
    30â†’    type,
    31â†’    value: '',
    32â†’    textContent: '',
    33â†’    innerHTML: '',
    34â†’    style: { display: '' },
    35â†’    classList: {
    36â†’      _classes: new Set(),
    37â†’      add: function(c) { this._classes.add(c); },
    38â†’      remove: function(c) { this._classes.delete(c); },
    39â†’      contains: function(c) { return this._classes.has(c); },
    40â†’      toggle: function(c) { this._classes.has(c) ? this._classes.delete(c) : this._classes.add(c); }
    41â†’    },
    42â†’    dataset: {},
    43â†’    disabled: false,
    44â†’    checked: false,
    45â†’    _eventListeners: {},
    46â†’    addEventListener: function(event, handler) {
    47â†’      if (!this._eventListeners[event]) this._eventListeners[event] = [];
    48â†’      this._eventListeners[event].push(handler);
    49â†’    },
    50â†’    dispatchEvent: function(event) {
    51â†’      const handlers = this._eventListeners[event.type] || [];
    52â†’      handlers.forEach(h => h(event));
    53â†’    },
    54â†’    click: function() {
    55â†’      this.dispatchEvent({ type: 'click', target: this });
    56â†’    },
    57â†’    focus: function() {},
    58â†’    blur: function() {},
    59â†’    appendChild: function(child) {},
    60â†’    removeChild: function(child) {},
    61â†’    closest: function(selector) {
    62â†’      // Simple mock - check if this element matches
    63â†’      if (selector.startsWith('.') && this.classList.contains(selector.slice(1))) {
    64â†’        return this;
    65â†’      }
    66â†’      return null;
    67â†’    },
    68â†’    querySelectorAll: function() { return []; }
    69â†’  };
    70â†’}
    71â†’
    72â†’global.document = {
    73â†’  getElementById: (id) => {
    74â†’    if (!mockElements[id]) {
    75â†’      mockElements[id] = createMockElement(id);
    76â†’    }
    77â†’    return mockElements[id];
    78â†’  },
    79â†’  createElement: (type) => createMockElement('dynamic-' + Date.now(), type),
    80â†’  createDocumentFragment: () => ({
    81â†’    appendChild: function() {}
    82â†’  }),
    83â†’  querySelectorAll: () => []
    84â†’};
    85â†’
    86â†’global.confirm = () => true;
    87â†’global.alert = () => {};
    88â†’global.FileReader = class {
    89â†’  constructor() {
    90â†’    this.onload = null;
    91â†’    this.onerror = null;
    92â†’  }
    93â†’  readAsText(file) {
    94â†’    setTimeout(() => {
    95â†’      if (this.onload) {
    96â†’        this.onload({ target: { result: file._content || '{}' } });
    97â†’      }
    98â†’    }, 0);
    99â†’  }
   100â†’};
   101â†’
   102â†’// Mock console.warn
   103â†’const originalWarn = console.warn;
   104â†’console.warn = () => {};
   105â†’
   106â†’// =============================================================================
   107â†’// COPY CORE FUNCTIONS FROM settings.js
   108â†’// =============================================================================
   109â†’
   110â†’const CUSTOM_PRESETS_KEY = 'spliceCustomPresets';
   111â†’
   112â†’const PRESETS = {
   113â†’  custom: { name: 'Custom', description: 'Your custom settings', icon: 'settings', settings: null },
   114â†’  podcast: { name: 'Podcast', description: 'Natural pauses', icon: 'mic', settings: { sensitivity: 35, threshold: -32 } },
   115â†’  interview: { name: 'Interview', description: 'Q&A rhythm', icon: 'people', settings: { sensitivity: 50, threshold: -30 } },
   116â†’  reaction: { name: 'Reaction', description: 'Fast-paced', icon: 'bolt', settings: { sensitivity: 70, threshold: -28 } },
   117â†’  tutorial: { name: 'Tutorial', description: 'Teaching pace', icon: 'school', settings: { sensitivity: 30, threshold: -35 } },
   118â†’  vlog: { name: 'Vlog', description: 'Punchy edits', icon: 'videocam', settings: { sensitivity: 65, threshold: -30 } }
   119â†’};
   120â†’
   121â†’const BUILT_IN_PRESET_IDS = ['custom', 'podcast', 'interview', 'reaction', 'tutorial', 'vlog'];
   122â†’
   123â†’function loadCustomPresets() {
   124â†’  try {
   125â†’    const saved = localStorage.getItem(CUSTOM_PRESETS_KEY);
   126â†’    if (saved) {
   127â†’      const parsed = JSON.parse(saved);
   128â†’      if (parsed && typeof parsed === 'object' && parsed.version && parsed.presets) {
   129â†’        return { version: parsed.version || 1, presets: { ...parsed.presets } || {}, order: [...(parsed.order || [])] };
   130â†’      }
   131â†’    }
   132â†’  } catch (e) {}
   133â†’  return { version: 1, presets: {}, order: [] };
   134â†’}
   135â†’
   136â†’function saveCustomPresets(data) {
   137â†’  try {
   138â†’    if (!data || typeof data !== 'object') return false;
   139â†’    const toSave = { version: data.version || 1, presets: data.presets || {}, order: data.order || [] };
   140â†’    localStorage.setItem(CUSTOM_PRESETS_KEY, JSON.stringify(toSave));
   141â†’    return true;
   142â†’  } catch (e) { return false; }
   143â†’}
   144â†’
   145â†’function slugifyPresetName(name) {
   146â†’  return name.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '').substring(0, 50) || 'preset';
   147â†’}
   148â†’
   149â†’function generateUniquePresetId(baseName, existingPresets) {
   150â†’  const baseId = slugifyPresetName(baseName);
   151â†’  let id = baseId;
   152â†’  let counter = 1;
   153â†’  while (existingPresets[id]) { id = `${baseId}-${counter}`; counter++; }
   154â†’  return id;
   155â†’}
   156â†’
   157â†’function getCurrentPresetSettings() {
   158â†’  return { sensitivity: 50, threshold: -32, minSilenceLength: 0.5, paddingStart: 0.1, paddingEnd: 0.1, autoMarkBest: true, enableTakesDetection: true };
   159â†’}
   160â†’
   161â†’function createCustomPreset(preset) {
   162â†’  if (!preset || typeof preset !== 'object') return { success: false, error: 'Invalid preset data' };
   163â†’  if (!preset.name || typeof preset.name !== 'string' || !preset.name.trim()) return { success: false, error: 'Preset name is required' };
   164â†’  const name = preset.name.trim();
   165â†’  const data = loadCustomPresets();
   166â†’  const id = generateUniquePresetId(name, data.presets);
   167â†’  const settings = preset.settings && typeof preset.settings === 'object' ? { ...preset.settings } : getCurrentPresetSettings();
   168â†’  const newPreset = { id, name, description: preset.description || '', icon: preset.icon || 'settings', createdAt: new Date().toISOString(), settings };
   169â†’  data.presets[id] = newPreset;
   170â†’  data.order.push(id);
   171â†’  const saved = saveCustomPresets(data);
   172â†’  if (!saved) return { success: false, error: 'Failed to save preset' };
   173â†’  return { success: true, id };
   174â†’}
   175â†’
   176â†’function updateCustomPreset(id, updates) {
   177â†’  if (!id || typeof id !== 'string') return { success: false, error: 'Preset ID is required' };
   178â†’  if (!updates || typeof updates !== 'object') return { success: false, error: 'Updates must be an object' };
   179â†’  const data = loadCustomPresets();
   180â†’  if (!data.presets[id]) return { success: false, error: 'Preset not found' };
   181â†’  const existing = data.presets[id];
   182â†’  const updated = { ...existing, updatedAt: new Date().toISOString() };
   183â†’  if (updates.name !== undefined) {
   184â†’    if (typeof updates.name !== 'string' || !updates.name.trim()) return { success: false, error: 'Name must be a non-empty string' };
   185â†’    updated.name = updates.name.trim();
   186â†’  }
   187â†’  if (updates.description !== undefined) updated.description = String(updates.description);
   188â†’  if (updates.icon !== undefined) updated.icon = String(updates.icon);
   189â†’  if (updates.settings !== undefined) {
   190â†’    if (typeof updates.settings !== 'object') return { success: false, error: 'Settings must be an object' };
   191â†’    updated.settings = { ...existing.settings, ...updates.settings };
   192â†’  }
   193â†’  data.presets[id] = updated;
   194â†’  const saved = saveCustomPresets(data);
   195â†’  if (!saved) return { success: false, error: 'Failed to save preset' };
   196â†’  return { success: true };
   197â†’}
   198â†’
   199â†’function deleteCustomPreset(id) {
   200â†’  if (!id || typeof id !== 'string') return { success: false, error: 'Preset ID is required' };
   201â†’  const data = loadCustomPresets();
   202â†’  if (!data.presets[id]) return { success: false, error: 'Preset not found' };
   203â†’  delete data.presets[id];
   204â†’  const orderIndex = data.order.indexOf(id);
   205â†’  if (orderIndex !== -1) data.order.splice(orderIndex, 1);
   206â†’  const saved = saveCustomPresets(data);
   207â†’  if (!saved) return { success: false, error: 'Failed to save after deletion' };
   208â†’  return { success: true };
   209â†’}
   210â†’
   211â†’function getCustomPreset(id) {
   212â†’  if (!id || typeof id !== 'string') return null;
   213â†’  const data = loadCustomPresets();
   214â†’  return data.presets[id] || null;
   215â†’}
   216â†’
   217â†’function isBuiltInPreset(id) { return BUILT_IN_PRESET_IDS.includes(id); }
   218â†’
   219â†’function getAllPresets() {
   220â†’  const builtInPresets = BUILT_IN_PRESET_IDS.map(id => {
   221â†’    const preset = PRESETS[id];
   222â†’    return { id, name: preset.name, description: preset.description, icon: preset.icon, settings: preset.settings, isBuiltIn: true };
   223â†’  });
   224â†’  const customData = loadCustomPresets();
   225â†’  const customPresets = customData.order.map(id => {
   226â†’    const preset = customData.presets[id];
   227â†’    if (!preset) return null;
   228â†’    return { ...preset, isBuiltIn: false };
   229â†’  }).filter(Boolean);
   230â†’  return [...builtInPresets, ...customPresets];
   231â†’}
   232â†’
   233â†’function getPresetById(id) {
   234â†’  if (!id || typeof id !== 'string') return null;
   235â†’  if (isBuiltInPreset(id)) {
   236â†’    const preset = PRESETS[id];
   237â†’    return { id, name: preset.name, description: preset.description, icon: preset.icon, settings: preset.settings, isBuiltIn: true };
   238â†’  }
   239â†’  const custom = getCustomPreset(id);
   240â†’  if (custom) return { ...custom, isBuiltIn: false };
   241â†’  return null;
   242â†’}
   243â†’
   244â†’function duplicatePreset(id) {
   245â†’  if (!id || typeof id !== 'string') return { success: false, error: 'Preset ID is required' };
   246â†’  const original = getPresetById(id);
   247â†’  if (!original) return { success: false, error: 'Preset not found' };
   248â†’  let copyName = `${original.name} (Copy)`;
   249â†’  const data = loadCustomPresets();
   250â†’  let copyNumber = 1;
   251â†’  let testId = slugifyPresetName(copyName);
   252â†’  while (data.presets[testId]) { copyNumber++; copyName = `${original.name} (Copy ${copyNumber})`; testId = slugifyPresetName(copyName); }
   253â†’  return createCustomPreset({ name: copyName, description: original.description || '', icon: original.icon || 'settings', settings: original.settings ? { ...original.settings } : getCurrentPresetSettings() });
   254â†’}
   255â†’
   256â†’function exportPresets() {
   257â†’  try {
   258â†’    const data = loadCustomPresets();
   259â†’    const customPresets = data.order.map(id => data.presets[id]).filter(Boolean);
   260â†’    if (customPresets.length === 0) return { success: false, error: 'No custom presets to export' };
   261â†’    const exportData = { version: 1, exportedAt: new Date().toISOString(), presets: customPresets };
   262â†’    return { success: true, data: JSON.stringify(exportData, null, 2), count: customPresets.length };
   263â†’  } catch (e) { return { success: false, error: 'Failed to export presets: ' + e.message }; }
   264â†’}
   265â†’
   266â†’function importPresets(jsonString, merge = true) {
   267â†’  try {
   268â†’    const imported = JSON.parse(jsonString);
   269â†’    if (!imported || !imported.presets || !Array.isArray(imported.presets)) return { success: false, error: 'Invalid preset file format' };
   270â†’    let importedCount = 0, skippedCount = 0;
   271â†’    for (const preset of imported.presets) {
   272â†’      if (!preset.name || typeof preset.name !== 'string') { skippedCount++; continue; }
   273â†’      const existingId = slugifyPresetName(preset.name);
   274â†’      const existing = getCustomPreset(existingId);
   275â†’      if (existing && !merge) { skippedCount++; continue; }
   276â†’      if (existing && merge) {
   277â†’        let newName = `${preset.name} (Imported)`;
   278â†’        let counter = 1;
   279â†’        while (getCustomPreset(slugifyPresetName(newName))) { counter++; newName = `${preset.name} (Imported ${counter})`; }
   280â†’        preset.name = newName;
   281â†’      }
   282â†’      const result = createCustomPreset({ name: preset.name, description: preset.description || '', icon: preset.icon || 'settings', settings: preset.settings || getCurrentPresetSettings() });
   283â†’      if (result.success) importedCount++; else skippedCount++;
   284â†’    }
   285â†’    if (importedCount === 0 && skippedCount > 0) return { success: false, error: 'All presets already exist or were invalid', skipped: skippedCount };
   286â†’    return { success: true, imported: importedCount, skipped: skippedCount };
   287â†’  } catch (e) {
   288â†’    if (e instanceof SyntaxError) return { success: false, error: 'Invalid JSON format' };
   289â†’    return { success: false, error: 'Failed to import presets: ' + e.message };
   290â†’  }
   291â†’}
   292â†’
   293â†’// =============================================================================
   294â†’// SIMULATE UI STATE & FUNCTIONS
   295â†’// =============================================================================
   296â†’
   297â†’const PRESET_ICON_MAP = {
   298â†’  'settings': '*', 'mic': 'M', 'people': 'P', 'bolt': '!',
   299â†’  'school': 'E', 'videocam': 'V', 'star': 'S', 'heart': 'H'
   300â†’};
   301â†’
   302â†’// Simulated UI state
   303â†’const ui = {
   304â†’  presetModal: null,
   305â†’  presetNameInput: null,
   306â†’  presetDescInput: null,
   307â†’  presetEditId: null,
   308â†’  presetSelectedIcon: null,
   309â†’  presetModalTitle: null,
   310â†’  savePresetConfirmBtn: null,
   311â†’  presetModalError: null,
   312â†’  managePresetsModal: null,
   313â†’  presetsList: null,
   314â†’  noCustomPresets: null,
   315â†’  presetSelector: null,
   316â†’  presetSensitivity: null,
   317â†’  presetSensitivityValue: null,
   318â†’  presetThreshold: null,
   319â†’  sensitivitySlider: null,
   320â†’  status: null
   321â†’};
   322â†’
   323â†’let statusMessages = [];
   324â†’
   325â†’function initUI() {
   326â†’  // Initialize mock UI elements
   327â†’  ui.presetModal = document.getElementById('presetModal');
   328â†’  ui.presetNameInput = document.getElementById('presetNameInput');
   329â†’  ui.presetDescInput = document.getElementById('presetDescInput');
   330â†’  ui.presetEditId = document.getElementById('presetEditId');
   331â†’  ui.presetSelectedIcon = document.getElementById('presetSelectedIcon');
   332â†’  ui.presetModalTitle = document.getElementById('presetModalTitle');
   333â†’  ui.savePresetConfirmBtn = document.getElementById('savePresetConfirmBtn');
   334â†’  ui.presetModalError = document.getElementById('presetModalError');
   335â†’  ui.managePresetsModal = document.getElementById('managePresetsModal');
   336â†’  ui.presetsList = document.getElementById('presetsList');
   337â†’  ui.noCustomPresets = document.getElementById('noCustomPresets');
   338â†’  ui.presetSelector = document.getElementById('presetSelector');
   339â†’  ui.presetSensitivity = document.getElementById('presetSensitivity');
   340â†’  ui.presetSensitivityValue = document.getElementById('presetSensitivityValue');
   341â†’  ui.presetThreshold = document.getElementById('presetThreshold');
   342â†’  ui.sensitivitySlider = document.getElementById('sensitivitySlider');
   343â†’  ui.status = document.getElementById('status');
   344â†’
   345â†’  // Set defaults
   346â†’  ui.presetSensitivity.value = 50;
   347â†’  ui.presetThreshold.value = -32;
   348â†’  ui.sensitivitySlider.value = 50;
   349â†’}
   350â†’
   351â†’function setStatus(msg) {
   352â†’  statusMessages.push(msg);
   353â†’  if (ui.status) ui.status.textContent = msg;
   354â†’}
   355â†’
   356â†’function showPresetModal(editId = null) {
   357â†’  if (!ui.presetModal) return;
   358â†’  ui.presetNameInput.value = '';
   359â†’  ui.presetDescInput.value = '';
   360â†’  ui.presetEditId.value = '';
   361â†’  ui.presetSelectedIcon.value = 'settings';
   362â†’  ui.presetModalError.style.display = 'none';
   363â†’
   364â†’  const defaultSensitivity = 50;
   365â†’  const defaultThreshold = -32;
   366â†’
   367â†’  if (editId) {
   368â†’    const preset = getPresetById(editId);
   369â†’    if (preset && !preset.isBuiltIn) {
   370â†’      ui.presetModalTitle.textContent = 'Edit Preset';
   371â†’      ui.presetNameInput.value = preset.name;
   372â†’      ui.presetDescInput.value = preset.description || '';
   373â†’      ui.presetEditId.value = editId;
   374â†’      ui.presetSelectedIcon.value = preset.icon || 'settings';
   375â†’      ui.savePresetConfirmBtn.textContent = 'Update Preset';
   376â†’
   377â†’      const presetSensitivity = preset.settings?.sensitivity ?? defaultSensitivity;
   378â†’      const presetThreshold = preset.settings?.threshold ?? defaultThreshold;
   379â†’      ui.presetSensitivity.value = presetSensitivity;
   380â†’      ui.presetSensitivityValue.textContent = presetSensitivity;
   381â†’      ui.presetThreshold.value = presetThreshold;
   382â†’    }
   383â†’  } else {
   384â†’    ui.presetModalTitle.textContent = 'Save Preset';
   385â†’    ui.savePresetConfirmBtn.textContent = 'Save Preset';
   386â†’    const mainSensitivity = ui.sensitivitySlider?.value ?? defaultSensitivity;
   387â†’    ui.presetSensitivity.value = mainSensitivity;
   388â†’    ui.presetSensitivityValue.textContent = mainSensitivity;
   389â†’    ui.presetThreshold.value = defaultThreshold;
   390â†’  }
   391â†’
   392â†’  ui.presetModal.classList.remove('hidden');
   393â†’}
   394â†’
   395â†’function hidePresetModal() {
   396â†’  if (ui.presetModal) ui.presetModal.classList.add('hidden');
   397â†’}
   398â†’
   399â†’function showPresetError(msg) {
   400â†’  if (ui.presetModalError) {
   401â†’    ui.presetModalError.textContent = msg;
   402â†’    ui.presetModalError.style.display = 'block';
   403â†’  }
   404â†’}
   405â†’
   406â†’function savePresetFromModal() {
   407â†’  const name = ui.presetNameInput?.value?.trim();
   408â†’  const description = ui.presetDescInput?.value?.trim() || '';
   409â†’  const icon = ui.presetSelectedIcon?.value || 'settings';
   410â†’  const editId = ui.presetEditId?.value;
   411â†’
   412â†’  if (!name) {
   413â†’    showPresetError('Please enter a preset name');
   414â†’    return { success: false, error: 'Please enter a preset name' };
   415â†’  }
   416â†’
   417â†’  const sensitivityRaw = parseInt(ui.presetSensitivity?.value);
   418â†’  const thresholdRaw = parseInt(ui.presetThreshold?.value);
   419â†’  const sensitivity = isNaN(sensitivityRaw) ? 50 : sensitivityRaw;
   420â†’  const threshold = isNaN(thresholdRaw) ? -32 : thresholdRaw;
   421â†’  const baseSettings = getCurrentPresetSettings();
   422â†’  const settings = { ...baseSettings, sensitivity, threshold };
   423â†’
   424â†’  let result;
   425â†’  if (editId) {
   426â†’    result = updateCustomPreset(editId, { name, description, icon, settings });
   427â†’    if (result.success) setStatus(`Preset "${name}" updated`);
   428â†’  } else {
   429â†’    result = createCustomPreset({ name, description, icon, settings });
   430â†’    if (result.success) {
   431â†’      setStatus(`Preset "${name}" saved`);
   432â†’      refreshPresetDropdown();
   433â†’      if (ui.presetSelector) ui.presetSelector.value = result.id;
   434â†’    }
   435â†’  }
   436â†’
   437â†’  if (result.success) {
   438â†’    hidePresetModal();
   439â†’    refreshPresetDropdown();
   440â†’  } else {
   441â†’    showPresetError(result.error || 'Failed to save preset');
   442â†’  }
   443â†’
   444â†’  return result;
   445â†’}
   446â†’
   447â†’function refreshPresetDropdown() {
   448â†’  if (!ui.presetSelector) return;
   449â†’  const currentValue = ui.presetSelector.value;
   450â†’  const presets = getAllPresets();
   451â†’  ui.presetSelector.innerHTML = '';
   452â†’
   453â†’  presets.forEach(preset => {
   454â†’    const option = document.createElement('option');
   455â†’    option.value = preset.id;
   456â†’    option.textContent = preset.name + (preset.description ? ` - ${preset.description}` : '');
   457â†’    ui.presetSelector.appendChild(option);
   458â†’  });
   459â†’
   460â†’  const stillExists = presets.some(p => p.id === currentValue);
   461â†’  if (stillExists) ui.presetSelector.value = currentValue;
   462â†’  else ui.presetSelector.value = 'custom';
   463â†’}
   464â†’
   465â†’function renderPresetsList() {
   466â†’  if (!ui.presetsList) return;
   467â†’  const presets = getAllPresets();
   468â†’  const customPresets = presets.filter(p => !p.isBuiltIn);
   469â†’
   470â†’  if (ui.noCustomPresets) {
   471â†’    ui.noCustomPresets.style.display = customPresets.length === 0 ? 'block' : 'none';
   472â†’  }
   473â†’
   474â†’  // Build HTML representation
   475â†’  const items = presets.map(preset => {
   476â†’    const iconChar = PRESET_ICON_MAP[preset.icon] || '*';
   477â†’    const desc = preset.description || (preset.isBuiltIn ? 'Built-in preset' : 'Custom preset');
   478â†’    return {
   479â†’      id: preset.id,
   480â†’      name: preset.name,
   481â†’      description: desc,
   482â†’      icon: iconChar,
   483â†’      isBuiltIn: preset.isBuiltIn,
   484â†’      hasDuplicate: true,
   485â†’      hasEdit: !preset.isBuiltIn,
   486â†’      hasDelete: !preset.isBuiltIn
   487â†’    };
   488â†’  });
   489â†’
   490â†’  ui.presetsList._items = items;
   491â†’  return items;
   492â†’}
   493â†’
   494â†’function duplicatePresetFromUI(presetId, presetName) {
   495â†’  const result = duplicatePreset(presetId);
   496â†’  if (result.success) {
   497â†’    setStatus(`Created copy of "${presetName}"`);
   498â†’    renderPresetsList();
   499â†’    refreshPresetDropdown();
   500â†’    if (ui.presetSelector && result.id) ui.presetSelector.value = result.id;
   501â†’  } else {
   502â†’    setStatus('Failed to duplicate preset: ' + (result.error || 'Unknown error'));
   503â†’  }
   504â†’  return result;
   505â†’}
   506â†’
   507â†’function deletePresetWithConfirm(presetId, presetName) {
   508â†’  const result = deleteCustomPreset(presetId);
   509â†’  if (result.success) {
   510â†’    setStatus(`Preset "${presetName}" deleted`);
   511â†’    renderPresetsList();
   512â†’    refreshPresetDropdown();
   513â†’  } else {
   514â†’    setStatus('Failed to delete preset: ' + (result.error || 'Unknown error'));
   515â†’  }
   516â†’  return result;
   517â†’}
   518â†’
   519â†’function applyPresetAndUpdateUI(presetId) {
   520â†’  const preset = getPresetById(presetId);
   521â†’  if (!preset) return { success: false, error: 'Preset not found' };
   522â†’
   523â†’  if (preset.settings) {
   524â†’    if (preset.settings.sensitivity !== undefined && ui.sensitivitySlider) {
   525â†’      ui.sensitivitySlider.value = preset.settings.sensitivity;
   526â†’    }
   527â†’  }
   528â†’
   529â†’  setStatus(`Applied preset: ${preset.name}`);
   530â†’  return { success: true, preset };
   531â†’}
   532â†’
   533â†’// =============================================================================
   534â†’// TEST UTILITIES
   535â†’// =============================================================================
   536â†’
   537â†’let testsPassed = 0;
   538â†’let testsFailed = 0;
   539â†’const startTime = Date.now();
   540â†’const performanceMetrics = [];
   541â†’
   542â†’function assert(condition, message) {
   543â†’  if (!condition) throw new Error(message);
   544â†’}
   545â†’
   546â†’function assertEqual(actual, expected, message) {
   547â†’  if (JSON.stringify(actual) !== JSON.stringify(expected)) {
   548â†’    throw new Error(`${message}\n  Expected: ${JSON.stringify(expected)}\n  Actual: ${JSON.stringify(actual)}`);
   549â†’  }
   550â†’}
   551â†’
   552â†’function resetState() {
   553â†’  storage.data = {};
   554â†’  statusMessages = [];
   555â†’  Object.keys(mockElements).forEach(k => delete mockElements[k]);
   556â†’  initUI();
   557â†’}
   558â†’
   559â†’async function runTest(name, testFn) {
   560â†’  const testStart = Date.now();
   561â†’  try {
   562â†’    resetState();
   563â†’    await testFn();
   564â†’    const elapsed = Date.now() - testStart;
   565â†’    console.log(`  âœ“ ${name} (${elapsed}ms)`);
   566â†’    testsPassed++;
   567â†’    performanceMetrics.push({ name, elapsed, status: 'pass' });
   568â†’    if (elapsed > 10) {
   569â†’      console.log(`    âš  Slow test: ${elapsed}ms`);
   570â†’    }
   571â†’  } catch (err) {
   572â†’    const elapsed = Date.now() - testStart;
   573â†’    console.log(`  âœ— ${name}`);
   574â†’    console.log(`    Error: ${err.message}`);
   575â†’    testsFailed++;
   576â†’    performanceMetrics.push({ name, elapsed, status: 'fail', error: err.message });
   577â†’  }
   578â†’}
   579â†’
   580â†’// =============================================================================
   581â†’// UI WIRING TESTS
   582â†’// =============================================================================
   583â†’
   584â†’async function testUIWiring() {
   585â†’  console.log('\nðŸ”Œ UI Wiring Tests');
   586â†’  console.log('=' .repeat(50));
   587â†’
   588â†’  await runTest('All UI elements are initialized', async () => {
   589â†’    assert(ui.presetModal, 'presetModal should exist');
   590â†’    assert(ui.presetNameInput, 'presetNameInput should exist');
   591â†’    assert(ui.presetDescInput, 'presetDescInput should exist');
   592â†’    assert(ui.presetEditId, 'presetEditId should exist');
   593â†’    assert(ui.presetSelectedIcon, 'presetSelectedIcon should exist');
   594â†’    assert(ui.presetSensitivity, 'presetSensitivity should exist');
   595â†’    assert(ui.presetThreshold, 'presetThreshold should exist');
   596â†’    assert(ui.presetSelector, 'presetSelector should exist');
   597â†’    assert(ui.status, 'status should exist');
   598â†’  });
   599â†’
   600â†’  await runTest('showPresetModal initializes form correctly for new preset', async () => {
   601â†’    ui.sensitivitySlider.value = 75; // Set main UI sensitivity
   602â†’    showPresetModal();
   603â†’
   604â†’    assertEqual(ui.presetNameInput.value, '', 'Name should be empty');
   605â†’    assertEqual(ui.presetDescInput.value, '', 'Description should be empty');
   606â†’    assertEqual(ui.presetEditId.value, '', 'Edit ID should be empty');
   607â†’    assertEqual(ui.presetSelectedIcon.value, 'settings', 'Icon should be settings');
   608â†’    assertEqual(String(ui.presetSensitivity.value), '75', 'Sensitivity should match main UI');
   609â†’    assertEqual(ui.presetModalTitle.textContent, 'Save Preset', 'Title should be Save Preset');
   610â†’    assert(!ui.presetModal.classList.contains('hidden'), 'Modal should be visible');
   611â†’  });
   612â†’
   613â†’  await runTest('showPresetModal populates form for edit mode', async () => {
   614â†’    // Create a preset first
   615â†’    createCustomPreset({
   616â†’      name: 'Edit Test',
   617â†’      description: 'For editing',
   618â†’      icon: 'mic',
   619â†’      settings: { sensitivity: 80, threshold: -25 }
   620â†’    });
   621â†’
   622â†’    showPresetModal('edit-test');
   623â†’
   624â†’    assertEqual(ui.presetNameInput.value, 'Edit Test', 'Name should be populated');
   625â†’    assertEqual(ui.presetDescInput.value, 'For editing', 'Description should be populated');
   626â†’    assertEqual(ui.presetEditId.value, 'edit-test', 'Edit ID should be set');
   627â†’    assertEqual(ui.presetSelectedIcon.value, 'mic', 'Icon should be mic');
   628â†’    assertEqual(String(ui.presetSensitivity.value), '80', 'Sensitivity should be from preset');
   629â†’    assertEqual(String(ui.presetThreshold.value), '-25', 'Threshold should be from preset');
   630â†’    assertEqual(ui.presetModalTitle.textContent, 'Edit Preset', 'Title should be Edit Preset');
   631â†’  });
   632â†’
   633â†’  await runTest('hidePresetModal adds hidden class', async () => {
   634â†’    showPresetModal();
   635â†’    assert(!ui.presetModal.classList.contains('hidden'), 'Should be visible');
   636â†’    hidePresetModal();
   637â†’    assert(ui.presetModal.classList.contains('hidden'), 'Should be hidden');
   638â†’  });
   639â†’
   640â†’  await runTest('savePresetFromModal validates empty name', async () => {
   641â†’    showPresetModal();
   642â†’    ui.presetNameInput.value = '';
   643â†’
   644â†’    const result = savePresetFromModal();
   645â†’
   646â†’    assert(!result.success, 'Should fail');
   647â†’    assertEqual(result.error, 'Please enter a preset name', 'Should have correct error');
   648â†’    assertEqual(ui.presetModalError.style.display, 'block', 'Error should be visible');
   649â†’  });
   650â†’
   651â†’  await runTest('savePresetFromModal creates new preset with modal settings', async () => {
   652â†’    showPresetModal();
   653â†’    ui.presetNameInput.value = 'New Preset';
   654â†’    ui.presetDescInput.value = 'Description';
   655â†’    ui.presetSelectedIcon.value = 'star';
   656â†’    ui.presetSensitivity.value = '85';
   657â†’    ui.presetThreshold.value = '-20';
   658â†’
   659â†’    const result = savePresetFromModal();
   660â†’
   661â†’    assert(result.success, 'Should succeed');
   662â†’    const preset = getPresetById(result.id);
   663â†’    assertEqual(preset.name, 'New Preset', 'Name should match');
   664â†’    assertEqual(preset.description, 'Description', 'Description should match');
   665â†’    assertEqual(preset.icon, 'star', 'Icon should match');
   666â†’    assertEqual(preset.settings.sensitivity, 85, 'Sensitivity should be from modal');
   667â†’    assertEqual(preset.settings.threshold, -20, 'Threshold should be from modal');
   668â†’  });
   669â†’
   670â†’  await runTest('savePresetFromModal updates existing preset', async () => {
   671â†’    createCustomPreset({ name: 'Update Me', settings: { sensitivity: 50 } });
   672â†’
   673â†’    showPresetModal('update-me');
   674â†’    ui.presetNameInput.value = 'Updated Name';
   675â†’    ui.presetSensitivity.value = '90';
   676â†’
   677â†’    const result = savePresetFromModal();
   678â†’
   679â†’    assert(result.success, 'Should succeed');
   680â†’    const preset = getPresetById('update-me');
   681â†’    assertEqual(preset.name, 'Updated Name', 'Name should be updated');
   682â†’    assertEqual(preset.settings.sensitivity, 90, 'Sensitivity should be updated');
   683â†’  });
   684â†’
   685â†’  await runTest('refreshPresetDropdown includes all presets', async () => {
   686â†’    createCustomPreset({ name: 'Custom A' });
   687â†’    createCustomPreset({ name: 'Custom B' });
   688â†’
   689â†’    refreshPresetDropdown();
   690â†’
   691â†’    const presets = getAllPresets();
   692â†’    assertEqual(presets.length, 8, 'Should have 6 built-in + 2 custom');
   693â†’  });
   694â†’
   695â†’  await runTest('renderPresetsList shows correct buttons', async () => {
   696â†’    createCustomPreset({ name: 'Render Test' });
   697â†’
   698â†’    const items = renderPresetsList();
   699â†’
   700â†’    const builtIn = items.find(i => i.id === 'podcast');
   701â†’    assert(builtIn.hasDuplicate, 'Built-in should have duplicate');
   702â†’    assert(!builtIn.hasEdit, 'Built-in should not have edit');
   703â†’    assert(!builtIn.hasDelete, 'Built-in should not have delete');
   704â†’
   705â†’    const custom = items.find(i => i.id === 'render-test');
   706â†’    assert(custom.hasDuplicate, 'Custom should have duplicate');
   707â†’    assert(custom.hasEdit, 'Custom should have edit');
   708â†’    assert(custom.hasDelete, 'Custom should have delete');
   709â†’  });
   710â†’}
   711â†’
   712â†’// =============================================================================
   713â†’// WORKFLOW TESTS
   714â†’// =============================================================================
   715â†’
   716â†’async function testWorkflows() {
   717â†’  console.log('\nðŸ”„ Workflow Tests');
   718â†’  console.log('=' .repeat(50));
   719â†’
   720â†’  await runTest('Full create preset workflow', async () => {
   721â†’    // 1. Open modal
   722â†’    showPresetModal();
   723â†’
   724â†’    // 2. Fill form
   725â†’    ui.presetNameInput.value = 'Workflow Preset';
   726â†’    ui.presetDescInput.value = 'Created via workflow';
   727â†’    ui.presetSensitivity.value = '70';
   728â†’    ui.presetThreshold.value = '-28';
   729â†’
   730â†’    // 3. Save
   731â†’    const result = savePresetFromModal();
   732â†’    assert(result.success, 'Should create preset');
   733â†’
   734â†’    // 4. Verify modal closed
   735â†’    assert(ui.presetModal.classList.contains('hidden'), 'Modal should close');
   736â†’
   737â†’    // 5. Verify preset exists
   738â†’    const preset = getPresetById(result.id);
   739â†’    assert(preset, 'Preset should exist');
   740â†’    assertEqual(preset.settings.sensitivity, 70, 'Sensitivity should be saved');
   741â†’
   742â†’    // 6. Verify status message
   743â†’    assert(statusMessages.includes('Preset "Workflow Preset" saved'), 'Status should be set');
   744â†’  });
   745â†’
   746â†’  await runTest('Full edit preset workflow', async () => {
   747â†’    // 1. Create preset
   748â†’    const create = createCustomPreset({ name: 'Edit Workflow', settings: { sensitivity: 50 } });
   749â†’
   750â†’    // 2. Open edit modal
   751â†’    showPresetModal(create.id);
   752â†’    assertEqual(ui.presetNameInput.value, 'Edit Workflow', 'Should populate name');
   753â†’
   754â†’    // 3. Modify
   755â†’    ui.presetNameInput.value = 'Edited Workflow';
   756â†’    ui.presetSensitivity.value = '80';
   757â†’
   758â†’    // 4. Save
   759â†’    const result = savePresetFromModal();
   760â†’    assert(result.success, 'Should update preset');
   761â†’
   762â†’    // 5. Verify changes
   763â†’    const preset = getPresetById(create.id);
   764â†’    assertEqual(preset.name, 'Edited Workflow', 'Name should be updated');
   765â†’    assertEqual(preset.settings.sensitivity, 80, 'Sensitivity should be updated');
   766â†’  });
   767â†’
   768â†’  await runTest('Full duplicate workflow', async () => {
   769â†’    // 1. Create original
   770â†’    const original = createCustomPreset({
   771â†’      name: 'Original',
   772â†’      description: 'To be copied',
   773â†’      settings: { sensitivity: 65, threshold: -30 }
   774â†’    });
   775â†’
   776â†’    // 2. Duplicate
   777â†’    const dup = duplicatePresetFromUI(original.id, 'Original');
   778â†’    assert(dup.success, 'Should duplicate');
   779â†’
   780â†’    // 3. Verify copy
   781â†’    const copy = getPresetById(dup.id);
   782â†’    assertEqual(copy.name, 'Original (Copy)', 'Should have copy suffix');
   783â†’    assertEqual(copy.settings.sensitivity, 65, 'Should copy settings');
   784â†’    assertEqual(copy.description, 'To be copied', 'Should copy description');
   785â†’
   786â†’    // 4. Verify original unchanged
   787â†’    const orig = getPresetById(original.id);
   788â†’    assertEqual(orig.name, 'Original', 'Original should be unchanged');
   789â†’  });
   790â†’
   791â†’  await runTest('Full delete workflow', async () => {
   792â†’    // 1. Create preset
   793â†’    createCustomPreset({ name: 'To Delete' });
   794â†’    const before = getAllPresets().length;
   795â†’
   796â†’    // 2. Delete
   797â†’    deletePresetWithConfirm('to-delete', 'To Delete');
   798â†’
   799â†’    // 3. Verify deleted
   800â†’    const after = getAllPresets().length;
   801â†’    assertEqual(after, before - 1, 'Should have one less preset');
   802â†’    assert(!getPresetById('to-delete'), 'Preset should not exist');
   803â†’  });
   804â†’
   805â†’  await runTest('Apply preset updates UI', async () => {
   806â†’    createCustomPreset({ name: 'Apply Test', settings: { sensitivity: 75 } });
   807â†’
   808â†’    applyPresetAndUpdateUI('apply-test');
   809â†’
   810â†’    assertEqual(String(ui.sensitivitySlider.value), '75', 'Main UI should be updated');
   811â†’    assert(statusMessages.some(m => m.includes('Applied preset')), 'Status should be set');
   812â†’  });
   813â†’
   814â†’  await runTest('Export then import workflow', async () => {
   815â†’    // 1. Create presets
   816â†’    createCustomPreset({ name: 'Export A', settings: { sensitivity: 55 } });
   817â†’    createCustomPreset({ name: 'Export B', settings: { sensitivity: 65 } });
   818â†’
   819â†’    // 2. Export
   820â†’    const exported = exportPresets();
   821â†’    assert(exported.success, 'Should export');
   822â†’    assertEqual(exported.count, 2, 'Should have 2 presets');
   823â†’
   824â†’    // 3. Clear and import
   825â†’    storage.data = {};
   826â†’    const imported = importPresets(exported.data);
   827â†’    assert(imported.success, 'Should import');
   828â†’    assertEqual(imported.imported, 2, 'Should import 2');
   829â†’
   830â†’    // 4. Verify
   831â†’    const presetA = getPresetById('export-a');
   832â†’    assertEqual(presetA.settings.sensitivity, 55, 'Should preserve settings');
   833â†’  });
   834â†’}
   835â†’
   836â†’// =============================================================================
   837â†’// EDGE CASE TESTS
   838â†’// =============================================================================
   839â†’
   840â†’async function testEdgeCases() {
   841â†’  console.log('\nâš ï¸ Edge Case Tests');
   842â†’  console.log('=' .repeat(50));
   843â†’
   844â†’  await runTest('Create preset with very long name', async () => {
   845â†’    const longName = 'A'.repeat(100);
   846â†’    showPresetModal();
   847â†’    ui.presetNameInput.value = longName;
   848â†’
   849â†’    const result = savePresetFromModal();
   850â†’    assert(result.success, 'Should create with long name');
   851â†’
   852â†’    const preset = getPresetById(result.id);
   853â†’    assertEqual(preset.name, longName, 'Should preserve full name');
   854â†’  });
   855â†’
   856â†’  await runTest('Create preset with special characters', async () => {
   857â†’    showPresetModal();
   858â†’    ui.presetNameInput.value = 'SpÃ«cial Ch@racters! & More?';
   859â†’
   860â†’    const result = savePresetFromModal();
   861â†’    assert(result.success, 'Should create');
   862â†’    assertEqual(result.id, 'sp-cial-ch-racters-more', 'ID should be slugified');
   863â†’  });
   864â†’
   865â†’  await runTest('Handle whitespace-only name', async () => {
   866â†’    showPresetModal();
   867â†’    ui.presetNameInput.value = '   ';
   868â†’
   869â†’    const result = savePresetFromModal();
   870â†’    assert(!result.success, 'Should fail');
   871â†’  });
   872â†’
   873â†’  await runTest('Duplicate same preset multiple times', async () => {
   874â†’    createCustomPreset({ name: 'Multi Dup' });
   875â†’
   876â†’    const dup1 = duplicatePreset('multi-dup');
   877â†’    const dup2 = duplicatePreset('multi-dup');
   878â†’    const dup3 = duplicatePreset('multi-dup');
   879â†’
   880â†’    assert(dup1.success && dup2.success && dup3.success, 'All should succeed');
   881â†’
   882â†’    const copy1 = getPresetById(dup1.id);
   883â†’    const copy2 = getPresetById(dup2.id);
   884â†’    const copy3 = getPresetById(dup3.id);
   885â†’
   886â†’    assertEqual(copy1.name, 'Multi Dup (Copy)', 'First copy');
   887â†’    assertEqual(copy2.name, 'Multi Dup (Copy 2)', 'Second copy');
   888â†’    assertEqual(copy3.name, 'Multi Dup (Copy 3)', 'Third copy');
   889â†’  });
   890â†’
   891â†’  await runTest('Delete preset while editing', async () => {
   892â†’    const create = createCustomPreset({ name: 'Delete While Edit' });
   893â†’
   894â†’    // Open edit modal
   895â†’    showPresetModal(create.id);
   896â†’
   897â†’    // Delete the preset
   898â†’    deleteCustomPreset(create.id);
   899â†’
   900â†’    // Try to save
   901â†’    ui.presetNameInput.value = 'Updated Name';
   902â†’    const result = savePresetFromModal();
   903â†’
   904â†’    // Should fail because preset no longer exists
   905â†’    assert(!result.success, 'Should fail to update deleted preset');
   906â†’  });
   907â†’
   908â†’  await runTest('Import with invalid JSON shows error', async () => {
   909â†’    const result = importPresets('not json {{{');
   910â†’    assert(!result.success, 'Should fail');
   911â†’    assertEqual(result.error, 'Invalid JSON format', 'Should have correct error');
   912â†’  });
   913â†’
   914â†’  await runTest('Import empty array', async () => {
   915â†’    const result = importPresets(JSON.stringify({ version: 1, presets: [] }));
   916â†’    // Empty array should succeed with 0 imported
   917â†’    assert(result.success, 'Should succeed with empty import');
   918â†’    assertEqual(result.imported, 0, 'Should import 0');
   919â†’  });
   920â†’
   921â†’  await runTest('Sensitivity slider boundary values', async () => {
   922â†’    // Min value test
   923â†’    showPresetModal();
   924â†’    ui.presetNameInput.value = 'Boundary Min';
   925â†’    ui.presetSensitivity.value = 0; // Use number, simulating slider
   926â†’
   927â†’    let result = savePresetFromModal();
   928â†’    assert(result.success, 'Should create with min sensitivity');
   929â†’    let preset = getPresetById(result.id);
   930â†’    assertEqual(preset.settings.sensitivity, 0, 'Should save 0');
   931â†’
   932â†’    // Max value test
   933â†’    showPresetModal();
   934â†’    ui.presetNameInput.value = 'Boundary Max';
   935â†’    ui.presetSensitivity.value = 100; // Use number, simulating slider
   936â†’
   937â†’    result = savePresetFromModal();
   938â†’    assert(result.success, 'Should create with max sensitivity');
   939â†’    preset = getPresetById(result.id);
   940â†’    assertEqual(preset.settings.sensitivity, 100, 'Should save 100');
   941â†’  });
   942â†’
   943â†’  await runTest('Threshold boundary values', async () => {
   944â†’    showPresetModal();
   945â†’    ui.presetNameInput.value = 'Threshold Test';
   946â†’    ui.presetThreshold.value = '-60';
   947â†’
   948â†’    const result = savePresetFromModal();
   949â†’    const preset = getPresetById(result.id);
   950â†’    assertEqual(preset.settings.threshold, -60, 'Should save -60');
   951â†’  });
   952â†’}
   953â†’
   954â†’// =============================================================================
   955â†’// PERFORMANCE TESTS
   956â†’// =============================================================================
   957â†’
   958â†’async function testPerformance() {
   959â†’  console.log('\nâš¡ Performance Tests');
   960â†’  console.log('=' .repeat(50));
   961â†’
   962â†’  await runTest('Create 100 presets < 100ms', async () => {
   963â†’    const start = Date.now();
   964â†’    for (let i = 0; i < 100; i++) {
   965â†’      showPresetModal();
   966â†’      ui.presetNameInput.value = `Perf Preset ${i}`;
   967â†’      ui.presetSensitivity.value = String(i % 100);
   968â†’      savePresetFromModal();
   969â†’    }
   970â†’    const elapsed = Date.now() - start;
   971â†’    assert(elapsed < 100, `Should complete in <100ms (was ${elapsed}ms)`);
   972â†’
   973â†’    const presets = getAllPresets();
   974â†’    assertEqual(presets.length, 106, 'Should have 6 built-in + 100 custom');
   975â†’  });
   976â†’
   977â†’  await runTest('Refresh dropdown with 100 presets < 50ms', async () => {
   978â†’    // Create 100 presets
   979â†’    for (let i = 0; i < 100; i++) {
   980â†’      createCustomPreset({ name: `Refresh Test ${i}` });
   981â†’    }
   982â†’
   983â†’    const start = Date.now();
   984â†’    for (let i = 0; i < 100; i++) {
   985â†’      refreshPresetDropdown();
   986â†’    }
   987â†’    const elapsed = Date.now() - start;
   988â†’    assert(elapsed < 50, `100 refreshes should complete in <50ms (was ${elapsed}ms)`);
   989â†’  });
   990â†’
   991â†’  await runTest('Render list with 100 presets < 50ms', async () => {
   992â†’    for (let i = 0; i < 100; i++) {
   993â†’      createCustomPreset({ name: `Render Test ${i}` });
   994â†’    }
   995â†’
   996â†’    const start = Date.now();
   997â†’    for (let i = 0; i < 100; i++) {
   998â†’      renderPresetsList();
   999â†’    }
  1000â†’    const elapsed = Date.now() - start;
  1001â†’    assert(elapsed < 50, `100 renders should complete in <50ms (was ${elapsed}ms)`);
  1002â†’  });
  1003â†’
  1004â†’  await runTest('Duplicate 50 presets < 50ms', async () => {
  1005â†’    createCustomPreset({ name: 'Dup Source', settings: { sensitivity: 50 } });
  1006â†’
  1007â†’    const start = Date.now();
  1008â†’    for (let i = 0; i < 50; i++) {
  1009â†’      duplicatePreset('dup-source');
  1010â†’    }
  1011â†’    const elapsed = Date.now() - start;
  1012â†’    assert(elapsed < 50, `50 duplicates should complete in <50ms (was ${elapsed}ms)`);
  1013â†’  });
  1014â†’
  1015â†’  await runTest('Export 100 presets < 20ms', async () => {
  1016â†’    for (let i = 0; i < 100; i++) {
  1017â†’      createCustomPreset({ name: `Export Perf ${i}`, settings: { sensitivity: i } });
  1018â†’    }
  1019â†’
  1020â†’    const start = Date.now();
  1021â†’    const result = exportPresets();
  1022â†’    const elapsed = Date.now() - start;
  1023â†’
  1024â†’    assert(result.success, 'Should export');
  1025â†’    assert(elapsed < 20, `Export should complete in <20ms (was ${elapsed}ms)`);
  1026â†’  });
  1027â†’}
  1028â†’
  1029â†’// =============================================================================
  1030â†’// STATE CONSISTENCY TESTS
  1031â†’// =============================================================================
  1032â†’
  1033â†’async function testStateConsistency() {
  1034â†’  console.log('\nðŸ”’ State Consistency Tests');
  1035â†’  console.log('=' .repeat(50));
  1036â†’
  1037â†’  await runTest('Dropdown stays in sync after CRUD', async () => {
  1038â†’    refreshPresetDropdown();
  1039â†’    const initial = getAllPresets().length;
  1040â†’
  1041â†’    // Create
  1042â†’    createCustomPreset({ name: 'Sync Test' });
  1043â†’    refreshPresetDropdown();
  1044â†’    assertEqual(getAllPresets().length, initial + 1, 'Should add 1');
  1045â†’
  1046â†’    // Update
  1047â†’    updateCustomPreset('sync-test', { name: 'Sync Updated' });
  1048â†’    const updated = getPresetById('sync-test');
  1049â†’    assertEqual(updated.name, 'Sync Updated', 'Should be updated');
  1050â†’
  1051â†’    // Delete
  1052â†’    deleteCustomPreset('sync-test');
  1053â†’    refreshPresetDropdown();
  1054â†’    assertEqual(getAllPresets().length, initial, 'Should be back to initial');
  1055â†’  });
  1056â†’
  1057â†’  await runTest('Modal state resets between opens', async () => {
  1058â†’    // First open and partially fill
  1059â†’    showPresetModal();
  1060â†’    ui.presetNameInput.value = 'Partial';
  1061â†’    ui.presetSensitivity.value = '80';
  1062â†’    hidePresetModal();
  1063â†’
  1064â†’    // Second open should be fresh
  1065â†’    showPresetModal();
  1066â†’    assertEqual(ui.presetNameInput.value, '', 'Name should be reset');
  1067â†’    assertEqual(ui.presetEditId.value, '', 'Edit ID should be reset');
  1068â†’  });
  1069â†’
  1070â†’  await runTest('Settings persist through export/import', async () => {
  1071â†’    const original = {
  1072â†’      name: 'Persist Test',
  1073â†’      description: 'Full settings',
  1074â†’      icon: 'bolt',
  1075â†’      settings: {
  1076â†’        sensitivity: 77,
  1077â†’        threshold: -25,
  1078â†’        minSilenceLength: 0.3,
  1079â†’        paddingStart: 0.2,
  1080â†’        paddingEnd: 0.15
  1081â†’      }
  1082â†’    };
  1083â†’
  1084â†’    createCustomPreset(original);
  1085â†’    const exported = exportPresets();
  1086â†’
  1087â†’    storage.data = {};
  1088â†’    importPresets(exported.data);
  1089â†’
  1090â†’    const reimported = getPresetById('persist-test');
  1091â†’    assertEqual(reimported.settings.sensitivity, 77, 'Sensitivity preserved');
  1092â†’    assertEqual(reimported.settings.threshold, -25, 'Threshold preserved');
  1093â†’    assertEqual(reimported.settings.minSilenceLength, 0.3, 'minSilenceLength preserved');
  1094â†’    assertEqual(reimported.description, 'Full settings', 'Description preserved');
  1095â†’    assertEqual(reimported.icon, 'bolt', 'Icon preserved');
  1096â†’  });
  1097â†’
  1098â†’  await runTest('Order preserved after multiple operations', async () => {
  1099â†’    createCustomPreset({ name: 'Order A' });
  1100â†’    createCustomPreset({ name: 'Order B' });
  1101â†’    createCustomPreset({ name: 'Order C' });
  1102â†’
  1103â†’    // Duplicate B
  1104â†’    duplicatePreset('order-b');
  1105â†’
  1106â†’    // Delete A
  1107â†’    deleteCustomPreset('order-a');
  1108â†’
  1109â†’    // Update C
  1110â†’    updateCustomPreset('order-c', { name: 'Order C Updated' });
  1111â†’
  1112â†’    const presets = getAllPresets();
  1113â†’    const customPresets = presets.filter(p => !p.isBuiltIn);
  1114â†’
  1115â†’    assertEqual(customPresets.length, 3, 'Should have 3 custom');
  1116â†’    assertEqual(customPresets[0].id, 'order-b', 'B should be first');
  1117â†’    assertEqual(customPresets[1].id, 'order-c', 'C should be second');
  1118â†’    assertEqual(customPresets[2].id, 'order-b-copy', 'Copy should be third');
  1119â†’  });
  1120â†’}
  1121â†’
  1122â†’// =============================================================================
  1123â†’// MAIN TEST RUNNER
  1124â†’// =============================================================================
  1125â†’
  1126â†’async function runAllTests() {
  1127â†’  console.log('\n' + '='.repeat(60));
  1128â†’  console.log('ðŸ§ª Comprehensive UI E2E Tests');
  1129â†’  console.log('='.repeat(60));
  1130â†’
  1131â†’  await testUIWiring();
  1132â†’  await testWorkflows();
  1133â†’  await testEdgeCases();
  1134â†’  await testPerformance();
  1135â†’  await testStateConsistency();
  1136â†’
  1137â†’  // Summary
  1138â†’  console.log('\n' + '='.repeat(60));
  1139â†’  console.log('ðŸ“Š Test Summary');
  1140â†’  console.log('='.repeat(60));
  1141â†’  console.log(`  Total: ${testsPassed + testsFailed}`);
  1142â†’  console.log(`  Passed: ${testsPassed}`);
  1143â†’  console.log(`  Failed: ${testsFailed}`);
  1144â†’  console.log(`  Duration: ${Date.now() - startTime}ms`);
  1145â†’
  1146â†’  // Performance analysis
  1147â†’  console.log('\nðŸ“ˆ Performance Analysis');
  1148â†’  console.log('-'.repeat(50));
  1149â†’  const slowTests = performanceMetrics.filter(m => m.elapsed > 5);
  1150â†’  if (slowTests.length > 0) {
  1151â†’    console.log('  Slow tests (>5ms):');
  1152â†’    slowTests.forEach(t => console.log(`    - ${t.name}: ${t.elapsed}ms`));
  1153â†’  } else {
  1154â†’    console.log('  All tests completed quickly (<5ms each)');
  1155â†’  }
  1156â†’
  1157â†’  // Bottleneck analysis
  1158â†’  console.log('\nðŸ” Potential Bottlenecks');
  1159â†’  console.log('-'.repeat(50));
  1160â†’  const perfTests = performanceMetrics.filter(m => m.name.includes('Performance') || m.name.includes('100'));
  1161â†’  perfTests.forEach(t => {
  1162â†’    console.log(`  ${t.name}: ${t.elapsed}ms - ${t.status === 'pass' ? 'âœ“ OK' : 'âœ— SLOW'}`);
  1163â†’  });
  1164â†’
  1165â†’  if (testsFailed > 0) {
  1166â†’    console.log('\nâŒ Some tests failed!');
  1167â†’    process.exit(1);
  1168â†’  } else {
  1169â†’    console.log('\nâœ… All tests passed!');
  1170â†’    process.exit(0);
  1171â†’  }
  1172â†’}
  1173â†’
  1174â†’process.on('exit', () => {
  1175â†’  console.warn = originalWarn;
  1176â†’});
  1177â†’
  1178â†’runAllTests().catch(err => {
  1179â†’  console.error('Test runner error:', err);
  1180â†’  process.exit(1);
  1181â†’});
  1182â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
