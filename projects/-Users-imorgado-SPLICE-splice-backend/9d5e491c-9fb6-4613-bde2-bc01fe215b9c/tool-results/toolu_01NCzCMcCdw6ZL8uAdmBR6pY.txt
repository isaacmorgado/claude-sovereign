     1→/**
     2→ * Phase 5: Referral System E2E Tests
     3→ *
     4→ * Tests for:
     5→ * 1. Code generation - unique codes per user
     6→ * 2. Code validation - valid/invalid/edge cases
     7→ * 3. Code application - discount/credits
     8→ * 4. Statistics - tracking referrals
     9→ */
    10→
    11→const path = require('path');
    12→const fs = require('fs');
    13→
    14→// =============================================================================
    15→// TEST FRAMEWORK
    16→// =============================================================================
    17→
    18→let passCount = 0;
    19→let failCount = 0;
    20→
    21→function test(name, fn) {
    22→  try {
    23→    const result = fn();
    24→    if (result instanceof Promise) {
    25→      return result.then(() => {
    26→        passCount++;
    27→        console.log(`  ✓ ${name}`);
    28→      }).catch(err => {
    29→        failCount++;
    30→        console.log(`  ✗ ${name}`);
    31→        console.log(`    Error: ${err.message}`);
    32→      });
    33→    }
    34→    passCount++;
    35→    console.log(`  ✓ ${name}`);
    36→  } catch (err) {
    37→    failCount++;
    38→    console.log(`  ✗ ${name}`);
    39→    console.log(`    Error: ${err.message}`);
    40→  }
    41→}
    42→
    43→async function asyncTest(name, fn) {
    44→  try {
    45→    await fn();
    46→    passCount++;
    47→    console.log(`  ✓ ${name}`);
    48→  } catch (err) {
    49→    failCount++;
    50→    console.log(`  ✗ ${name}`);
    51→    console.log(`    Error: ${err.message}`);
    52→  }
    53→}
    54→
    55→function assertEqual(actual, expected, message = '') {
    56→  if (actual !== expected) {
    57→    throw new Error(`${message}: Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
    58→  }
    59→}
    60→
    61→function assertTrue(condition, message = '') {
    62→  if (!condition) {
    63→    throw new Error(`${message}: Expected true, got false`);
    64→  }
    65→}
    66→
    67→function assertFalse(condition, message = '') {
    68→  if (condition) {
    69→    throw new Error(`${message}: Expected false, got true`);
    70→  }
    71→}
    72→
    73→// =============================================================================
    74→// REFERRAL SERVICE TESTS
    75→// =============================================================================
    76→
    77→console.log('\n=== Phase 5: Referral System E2E Tests ===\n');
    78→
    79→// Import the referral service
    80→const referralService = require('../services/referralService');
    81→
    82→console.log('1. Code Generation Tests');
    83→
    84→test('generateCode should create SPLICE-XXXXXX format', () => {
    85→  const code = referralService.generateCode();
    86→  assertTrue(code.startsWith('SPLICE-'), 'Code should start with SPLICE-');
    87→  assertEqual(code.length, 13, 'Code length should be 13 (SPLICE- + 6 chars)');
    88→});
    89→
    90→test('generateCode should use alphanumeric chars only', () => {
    91→  const code = referralService.generateCode();
    92→  const suffix = code.split('-')[1];
    93→  assertTrue(/^[A-Z0-9]+$/.test(suffix), 'Suffix should be alphanumeric');
    94→});
    95→
    96→test('generateCode should not use confusing chars (O, I, 0, 1)', () => {
    97→  // Generate many codes and check none have confusing chars
    98→  // The allowed set is: ABCDEFGHJKLMNPQRSTUVWXYZ23456789 (excludes O, I, 0, 1)
    99→  const allowedChars = /^[ABCDEFGHJKLMNPQRSTUVWXYZ23456789]+$/;
   100→  for (let i = 0; i < 100; i++) {
   101→    const code = referralService.generateCode();
   102→    const suffix = code.split('-')[1];
   103→    assertTrue(allowedChars.test(suffix), `Should only contain allowed chars, got: ${suffix}`);
   104→  }
   105→});
   106→
   107→test('generateCode should be unique across calls', () => {
   108→  const codes = new Set();
   109→  for (let i = 0; i < 100; i++) {
   110→    codes.add(referralService.generateCode());
   111→  }
   112→  assertEqual(codes.size, 100, 'All 100 codes should be unique');
   113→});
   114→
   115→console.log('\n2. Default Values Tests');
   116→
   117→test('should have default referee discount of 10%', () => {
   118→  assertEqual(referralService.DEFAULT_REFEREE_DISCOUNT, 10, 'Referee discount');
   119→});
   120→
   121→test('should have default referrer credit of 1 hour', () => {
   122→  assertEqual(referralService.DEFAULT_REFERRER_CREDIT, 1.0, 'Referrer credit');
   123→});
   124→
   125→console.log('\n3. Server Endpoint Verification Tests');
   126→
   127→// Read server.js to verify endpoints are registered
   128→const serverSource = fs.readFileSync(path.join(__dirname, '../server.js'), 'utf8');
   129→
   130→test('server should have GET /referral/code endpoint', () => {
   131→  assertTrue(serverSource.includes("app.get('/referral/code'"), 'Should have /referral/code');
   132→});
   133→
   134→test('server should have POST /referral/validate endpoint', () => {
   135→  assertTrue(serverSource.includes("app.post('/referral/validate'"), 'Should have /referral/validate');
   136→});
   137→
   138→test('server should have POST /referral/apply endpoint', () => {
   139→  assertTrue(serverSource.includes("app.post('/referral/apply'"), 'Should have /referral/apply');
   140→});
   141→
   142→test('server should have GET /referral/stats endpoint', () => {
   143→  assertTrue(serverSource.includes("app.get('/referral/stats'"), 'Should have /referral/stats');
   144→});
   145→
   146→test('server should initialize referral tables on startup', () => {
   147→  assertTrue(serverSource.includes('initReferralTables'), 'Should initialize referral tables');
   148→});
   149→
   150→console.log('\n4. Referral Service Function Tests');
   151→
   152→// Read referralService.js to verify functions are exported
   153→const referralSource = fs.readFileSync(path.join(__dirname, '../services/referralService.js'), 'utf8');
   154→
   155→test('should export getOrCreateCode function', () => {
   156→  assertTrue(typeof referralService.getOrCreateCode === 'function', 'Should export getOrCreateCode');
   157→});
   158→
   159→test('should export validateCode function', () => {
   160→  assertTrue(typeof referralService.validateCode === 'function', 'Should export validateCode');
   161→});
   162→
   163→test('should export applyCode function', () => {
   164→  assertTrue(typeof referralService.applyCode === 'function', 'Should export applyCode');
   165→});
   166→
   167→test('should export getStats function', () => {
   168→  assertTrue(typeof referralService.getStats === 'function', 'Should export getStats');
   169→});
   170→
   171→test('should export initReferralTables function', () => {
   172→  assertTrue(typeof referralService.initReferralTables === 'function', 'Should export initReferralTables');
   173→});
   174→
   175→test('should export awardReferrerCredit function', () => {
   176→  assertTrue(typeof referralService.awardReferrerCredit === 'function', 'Should export awardReferrerCredit');
   177→});
   178→
   179→test('should export hasUsedReferralCode function', () => {
   180→  assertTrue(typeof referralService.hasUsedReferralCode === 'function', 'Should export hasUsedReferralCode');
   181→});
   182→
   183→console.log('\n5. Database Schema Tests');
   184→
   185→test('should create referral_codes table', () => {
   186→  assertTrue(referralSource.includes('CREATE TABLE IF NOT EXISTS referral_codes'), 'Should create referral_codes table');
   187→});
   188→
   189→test('referral_codes should have required columns', () => {
   190→  assertTrue(referralSource.includes('code VARCHAR(12) UNIQUE NOT NULL'), 'Should have code column');
   191→  assertTrue(referralSource.includes('owner_customer_id VARCHAR(255) NOT NULL'), 'Should have owner column');
   192→  assertTrue(referralSource.includes('referee_discount_percent INTEGER'), 'Should have discount column');
   193→  assertTrue(referralSource.includes('referrer_credit_hours DECIMAL'), 'Should have credit column');
   194→  assertTrue(referralSource.includes('times_used INTEGER'), 'Should have times_used column');
   195→  assertTrue(referralSource.includes('is_active BOOLEAN'), 'Should have is_active column');
   196→});
   197→
   198→test('should create referral_uses table', () => {
   199→  assertTrue(referralSource.includes('CREATE TABLE IF NOT EXISTS referral_uses'), 'Should create referral_uses table');
   200→});
   201→
   202→test('referral_uses should have required columns', () => {
   203→  assertTrue(referralSource.includes('referee_customer_id VARCHAR(255) NOT NULL'), 'Should have referee column');
   204→  assertTrue(referralSource.includes('credit_awarded BOOLEAN'), 'Should have credit_awarded column');
   205→  assertTrue(referralSource.includes('stripe_coupon_id VARCHAR(255)'), 'Should have stripe_coupon_id column');
   206→});
   207→
   208→test('should create indexes for referral tables', () => {
   209→  assertTrue(referralSource.includes('idx_referral_codes_owner'), 'Should index owner');
   210→  assertTrue(referralSource.includes('idx_referral_codes_code'), 'Should index code');
   211→  assertTrue(referralSource.includes('idx_referral_uses_code'), 'Should index code_id');
   212→  assertTrue(referralSource.includes('idx_referral_uses_referee'), 'Should index referee');
   213→});
   214→
   215→console.log('\n6. Validation Logic Tests');
   216→
   217→test('validateCode should handle null code', async () => {
   218→  const result = await referralService.validateCode(null);
   219→  assertFalse(result.valid, 'Should be invalid');
   220→  assertEqual(result.error, 'Invalid code format', 'Should have format error');
   221→});
   222→
   223→test('validateCode should handle empty string', async () => {
   224→  const result = await referralService.validateCode('');
   225→  assertFalse(result.valid, 'Should be invalid');
   226→});
   227→
   228→test('validateCode should handle non-string', async () => {
   229→  const result = await referralService.validateCode(123);
   230→  assertFalse(result.valid, 'Should be invalid for number');
   231→});
   232→
   233→console.log('\n7. Endpoint Auth Tests');
   234→
   235→test('GET /referral/code should require x-stripe-customer-id', () => {
   236→  assertTrue(
   237→    serverSource.includes("app.get('/referral/code'") &&
   238→    serverSource.includes("req.headers['x-stripe-customer-id']"),
   239→    'Should check for customer ID header'
   240→  );
   241→});
   242→
   243→test('GET /referral/stats should require x-stripe-customer-id', () => {
   244→  assertTrue(
   245→    serverSource.includes("app.get('/referral/stats'") &&
   246→    serverSource.includes("req.headers['x-stripe-customer-id']"),
   247→    'Should check for customer ID header'
   248→  );
   249→});
   250→
   251→test('POST /referral/validate should accept code in body', () => {
   252→  assertTrue(
   253→    serverSource.includes("const { code, customerId } = req.body"),
   254→    'Should extract code from body'
   255→  );
   256→});
   257→
   258→test('POST /referral/apply should require code and customerId', () => {
   259→  assertTrue(
   260→    serverSource.includes("if (!code || !customerId)"),
   261→    'Should validate required fields'
   262→  );
   263→});
   264→
   265→console.log('\n8. Error Handling Tests');
   266→
   267→test('apply endpoint should return user-friendly errors', () => {
   268→  assertTrue(
   269→    serverSource.includes("Cannot use your own") &&
   270→    serverSource.includes("already used") &&
   271→    serverSource.includes("not found"),
   272→    'Should handle validation errors gracefully'
   273→  );
   274→});
   275→
   276→console.log('\n9. API Documentation Tests');
   277→
   278→test('API root should list referral endpoints', () => {
   279→  assertTrue(serverSource.includes("'GET /referral/code'"), 'Should document /referral/code');
   280→  assertTrue(serverSource.includes("'POST /referral/validate'"), 'Should document /referral/validate');
   281→  assertTrue(serverSource.includes("'POST /referral/apply'"), 'Should document /referral/apply');
   282→  assertTrue(serverSource.includes("'GET /referral/stats'"), 'Should document /referral/stats');
   283→});
   284→
   285→// =============================================================================
   286→// SUMMARY
   287→// =============================================================================
   288→
   289→console.log('\n=== Test Summary ===');
   290→console.log(`  Passed: ${passCount}`);
   291→console.log(`  Failed: ${failCount}`);
   292→console.log(`  Total: ${passCount + failCount}`);
   293→
   294→if (failCount > 0) {
   295→  console.log('\n❌ Some tests failed');
   296→  process.exit(1);
   297→} else {
   298→  console.log('\n✓ All Phase 5 Referral tests passed');
   299→  process.exit(0);
   300→}
   301→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
