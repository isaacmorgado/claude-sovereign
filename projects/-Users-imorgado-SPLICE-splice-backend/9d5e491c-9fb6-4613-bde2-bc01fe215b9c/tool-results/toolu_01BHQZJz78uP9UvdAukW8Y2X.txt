     1→/**
     2→ * End-to-End Tests for Word-Level Transcription
     3→ *
     4→ * Tests the transcribeWithWords function and endpoint integration.
     5→ * Uses mocked OpenAI responses to test without API calls.
     6→ */
     7→
     8→const { detectProfanity } = require('../services/profanityDetection');
     9→const { detectStutters, detectAllRepetitions } = require('../services/repetitionDetection');
    10→
    11→// Mock transcript with word-level timestamps (simulating Whisper output)
    12→const mockTranscriptWithWords = {
    13→  text: "Hello I I I think we we we need to check for stutters. The damn quick brown fox jumps over the lazy dog.",
    14→  words: [
    15→    { word: "Hello", start: 0.0, end: 0.5 },
    16→    { word: "I", start: 0.6, end: 0.7 },
    17→    { word: "I", start: 0.75, end: 0.85 },
    18→    { word: "I", start: 0.9, end: 1.0 },
    19→    { word: "think", start: 1.1, end: 1.4 },
    20→    { word: "we", start: 1.5, end: 1.6 },
    21→    { word: "we", start: 1.65, end: 1.75 },
    22→    { word: "we", start: 1.8, end: 1.9 },
    23→    { word: "need", start: 2.0, end: 2.3 },
    24→    { word: "to", start: 2.4, end: 2.5 },
    25→    { word: "check", start: 2.6, end: 2.9 },
    26→    { word: "for", start: 3.0, end: 3.1 },
    27→    { word: "stutters", start: 3.2, end: 3.6 },
    28→    { word: "The", start: 3.8, end: 4.0 },
    29→    { word: "damn", start: 4.1, end: 4.4 },
    30→    { word: "quick", start: 4.5, end: 4.8 },
    31→    { word: "brown", start: 4.9, end: 5.2 },
    32→    { word: "fox", start: 5.3, end: 5.5 },
    33→    { word: "jumps", start: 5.6, end: 5.9 },
    34→    { word: "over", start: 6.0, end: 6.2 },
    35→    { word: "the", start: 6.3, end: 6.4 },
    36→    { word: "lazy", start: 6.5, end: 6.8 },
    37→    { word: "dog", start: 6.9, end: 7.1 }
    38→  ],
    39→  language: "en",
    40→  duration: 7.5
    41→};
    42→
    43→// Test stutter detection
    44→function testStutterDetection() {
    45→  console.log('\n=== Test: Stutter Detection ===');
    46→
    47→  const startTime = Date.now();
    48→  const result = detectStutters(mockTranscriptWithWords, {
    49→    minRepeats: 2,
    50→    maxGapMs: 500,
    51→    ignoreFillers: true,
    52→    minWordLength: 1  // Allow single-char words like "I"
    53→  });
    54→  const duration = Date.now() - startTime;
    55→
    56→  console.log(`Duration: ${duration}ms`);
    57→  console.log(`Stutters found: ${result.stutters.length}`);
    58→
    59→  // Should find "I I I" and "we we we"
    60→  if (result.stutters.length !== 2) {
    61→    console.error(`FAIL: Expected 2 stutters, got ${result.stutters.length}`);
    62→    return false;
    63→  }
    64→
    65→  // Verify "I" stutter (single char word)
    66→  const iStutter = result.stutters.find(s => s.word === 'i');
    67→  if (!iStutter) {
    68→    console.error('FAIL: "I" stutter not detected (single char word issue!)');
    69→    return false;
    70→  }
    71→  console.log(`✓ "I" stutter detected: ${iStutter.occurrences} occurrences`);
    72→
    73→  // Verify "we" stutter
    74→  const weStutter = result.stutters.find(s => s.word === 'we');
    75→  if (!weStutter) {
    76→    console.error('FAIL: "we" stutter not detected');
    77→    return false;
    78→  }
    79→  console.log(`✓ "we" stutter detected: ${weStutter.occurrences} occurrences`);
    80→
    81→  console.log('✓ PASS: Stutter detection working correctly');
    82→  return true;
    83→}
    84→
    85→// Test profanity detection
    86→function testProfanityDetection() {
    87→  console.log('\n=== Test: Profanity Detection ===');
    88→
    89→  const startTime = Date.now();
    90→  const result = detectProfanity(mockTranscriptWithWords, {
    91→    language: 'en',
    92→    customBlocklist: [],
    93→    customAllowlist: [],
    94→    frameRate: 30
    95→  });
    96→  const duration = Date.now() - startTime;
    97→
    98→  console.log(`Duration: ${duration}ms`);
    99→  console.log(`Profanity found: ${result.metadata?.profanityCount || 0}`);
   100→  console.log(`Words checked: ${result.metadata?.totalWords || 'N/A'}`);
   101→
   102→  // Should find "damn"
   103→  if (!result.metadata?.profanityCount || result.metadata.profanityCount < 1) {
   104→    console.error('FAIL: Expected at least 1 profanity word (damn)');
   105→    return false;
   106→  }
   107→
   108→  const damnWord = result.words?.find(w => w.text?.toLowerCase() === 'damn' && w.isProfanity);
   109→  if (damnWord) {
   110→    console.log(`✓ "damn" detected at ${damnWord.start}s - ${damnWord.end}s`);
   111→  }
   112→
   113→  console.log('✓ PASS: Profanity detection working correctly');
   114→  return true;
   115→}
   116→
   117→// Test repetition detection
   118→async function testRepetitionDetection() {
   119→  console.log('\n=== Test: Repetition Detection ===');
   120→
   121→  const startTime = Date.now();
   122→  const result = await detectAllRepetitions(mockTranscriptWithWords, {
   123→    phraseSize: 3,
   124→    tolerance: 0.7,
   125→    searchRadius: 50,
   126→    useOpenAI: false
   127→  });
   128→  const duration = Date.now() - startTime;
   129→
   130→  console.log(`Duration: ${duration}ms`);
   131→  console.log(`Phrase repetitions: ${result.repetitions?.length || 0}`);
   132→  console.log(`Stutters: ${result.stutters?.length || 0}`);
   133→  console.log(`Removal segments: ${result.removalSegments?.length || 0}`);
   134→
   135→  console.log('✓ PASS: Repetition detection completed');
   136→  return true;
   137→}
   138→
   139→// Performance test with larger dataset
   140→async function testPerformance() {
   141→  console.log('\n=== Test: Performance with Large Dataset ===');
   142→
   143→  // Create a large transcript (1000 words)
   144→  const largeTranscript = {
   145→    text: '',
   146→    words: [],
   147→    language: 'en',
   148→    duration: 600
   149→  };
   150→
   151→  const sampleWords = ['hello', 'world', 'test', 'check', 'word', 'think', 'need', 'want'];
   152→  let time = 0;
   153→
   154→  for (let i = 0; i < 1000; i++) {
   155→    const word = sampleWords[i % sampleWords.length];
   156→    largeTranscript.words.push({
   157→      word,
   158→      start: time,
   159→      end: time + 0.3
   160→    });
   161→    time += 0.35;
   162→  }
   163→
   164→  // Add some stutters
   165→  largeTranscript.words.splice(100, 0,
   166→    { word: 'I', start: 35, end: 35.1 },
   167→    { word: 'I', start: 35.15, end: 35.25 },
   168→    { word: 'I', start: 35.3, end: 35.4 }
   169→  );
   170→
   171→  console.log(`Dataset size: ${largeTranscript.words.length} words`);
   172→
   173→  // Measure stutter detection
   174→  let start = Date.now();
   175→  const stutterResult = detectStutters(largeTranscript, { minRepeats: 2, minWordLength: 1 });
   176→  const stutterTime = Date.now() - start;
   177→  console.log(`Stutter detection: ${stutterTime}ms (${stutterResult.stutters.length} found)`);
   178→
   179→  // Measure profanity detection
   180→  start = Date.now();
   181→  const profanityResult = detectProfanity(largeTranscript, { language: 'en' });
   182→  const profanityTime = Date.now() - start;
   183→  console.log(`Profanity detection: ${profanityTime}ms`);
   184→
   185→  // Measure full repetition detection (can be slower due to phrase comparison)
   186→  start = Date.now();
   187→  const repResult = await detectAllRepetitions(largeTranscript, {
   188→    phraseSize: 3,
   189→    tolerance: 0.7,
   190→    searchRadius: 50
   191→  });
   192→  const repTime = Date.now() - start;
   193→  console.log(`Full repetition detection: ${repTime}ms`);
   194→
   195→  // Performance thresholds
   196→  const maxAcceptableTime = 1000; // 1 second
   197→  if (stutterTime > maxAcceptableTime) {
   198→    console.warn(`⚠ WARNING: Stutter detection took ${stutterTime}ms (>1s)`);
   199→  }
   200→  if (repTime > maxAcceptableTime) {
   201→    console.warn(`⚠ WARNING: Repetition detection took ${repTime}ms (>1s)`);
   202→  }
   203→
   204→  console.log('✓ Performance test completed');
   205→  return true;
   206→}
   207→
   208→// Test cache key uniqueness
   209→function testCacheKeys() {
   210→  console.log('\n=== Test: Cache Key Design ===');
   211→
   212→  // Simulate cache behavior
   213→  const cache = new Map();
   214→
   215→  const path1 = '/tmp/test.wav';
   216→  const path2 = '/tmp/test.wav';
   217→
   218→  // Standard cache
   219→  cache.set(path1, { type: 'segment' });
   220→  cache.set(`words:${path2}`, { type: 'words' });
   221→
   222→  console.log(`Cache entries: ${cache.size}`);
   223→  console.log(`Segment cache: ${cache.get(path1)?.type}`);
   224→  console.log(`Words cache: ${cache.get(`words:${path2}`)?.type}`);
   225→
   226→  if (cache.size !== 2) {
   227→    console.error('FAIL: Cache keys should be unique for segment vs word caches');
   228→    return false;
   229→  }
   230→
   231→  console.log('✓ PASS: Cache keys are correctly separated');
   232→  return true;
   233→}
   234→
   235→// Run all tests
   236→async function runAllTests() {
   237→  console.log('='.repeat(60));
   238→  console.log('SPLICE Word-Level Transcription E2E Tests');
   239→  console.log('='.repeat(60));
   240→
   241→  const results = [];
   242→
   243→  try {
   244→    results.push({ name: 'Stutter Detection', pass: testStutterDetection() });
   245→    results.push({ name: 'Profanity Detection', pass: testProfanityDetection() });
   246→    results.push({ name: 'Repetition Detection', pass: await testRepetitionDetection() });
   247→    results.push({ name: 'Performance', pass: await testPerformance() });
   248→    results.push({ name: 'Cache Keys', pass: testCacheKeys() });
   249→  } catch (err) {
   250→    console.error('\n❌ Test error:', err.message);
   251→    console.error(err.stack);
   252→  }
   253→
   254→  console.log('\n' + '='.repeat(60));
   255→  console.log('SUMMARY');
   256→  console.log('='.repeat(60));
   257→
   258→  let passed = 0;
   259→  let failed = 0;
   260→
   261→  for (const r of results) {
   262→    const status = r.pass ? '✓ PASS' : '✗ FAIL';
   263→    console.log(`${status}: ${r.name}`);
   264→    if (r.pass) passed++; else failed++;
   265→  }
   266→
   267→  console.log(`\nTotal: ${passed} passed, ${failed} failed`);
   268→
   269→  process.exit(failed > 0 ? 1 : 0);
   270→}
   271→
   272→runAllTests();
   273→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
