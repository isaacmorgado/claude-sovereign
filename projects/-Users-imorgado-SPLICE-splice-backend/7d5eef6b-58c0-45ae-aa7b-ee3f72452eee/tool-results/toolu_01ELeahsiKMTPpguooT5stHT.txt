     1→/**
     2→ * Billing Routes
     3→ *
     4→ * Credits and usage history endpoints
     5→ */
     6→
     7→const express = require('express');
     8→
     9→/**
    10→ * Create billing routes
    11→ * @param {Object} options - Route configuration options
    12→ * @param {Object} options.services - Shared services (usageTracking)
    13→ * @param {Object} options.authHelpers - Auth helper functions (verifyToken)
    14→ * @returns {express.Router}
    15→ */
    16→function createBillingRoutes(options = {}) {
    17→  const router = express.Router();
    18→  const { usageTracking } = options.services || {};
    19→  const { verifyToken } = options.authHelpers || {};
    20→
    21→  /**
    22→   * GET /credits - Get user's credit balance
    23→   *
    24→   * Supports both JWT (Authorization: Bearer) and legacy x-stripe-customer-id header
    25→   */
    26→  router.get('/credits', async (req, res) => {
    27→    // Support both JWT and legacy auth
    28→    let stripeCustomerId = null;
    29→
    30→    // Try JWT first
    31→    const authHeader = req.headers['authorization'];
    32→    if (authHeader && authHeader.startsWith('Bearer ') && verifyToken) {
    33→      const token = authHeader.slice(7);
    34→      const decoded = verifyToken(token);
    35→      if (decoded && decoded.sub) {
    36→        stripeCustomerId = decoded.sub;
    37→      }
    38→    }
    39→
    40→    // Fallback to legacy header
    41→    if (!stripeCustomerId) {
    42→      stripeCustomerId = req.headers['x-stripe-customer-id'];
    43→    }
    44→
    45→    if (!stripeCustomerId) {
    46→      return res.status(401).json({
    47→        error: 'Authentication required',
    48→        message: 'Please provide a valid Bearer token or log in again'
    49→      });
    50→    }
    51→
    52→    try {
    53→      const balance = await usageTracking.getBalance(stripeCustomerId);
    54→      res.json({
    55→        success: true,
    56→        ...balance
    57→      });
    58→    } catch (err) {
    59→      console.error('[SPLICE] Credits error:', err);
    60→      res.status(500).json({ error: err.message });
    61→    }
    62→  });
    63→
    64→  /**
    65→   * GET /usage-history - Get user's usage history
    66→   */
    67→  router.get('/usage-history', async (req, res) => {
    68→    // Support both JWT and legacy auth
    69→    let stripeCustomerId = null;
    70→
    71→    const authHeader = req.headers['authorization'];
    72→    if (authHeader && authHeader.startsWith('Bearer ') && verifyToken) {
    73→      const token = authHeader.slice(7);
    74→      const decoded = verifyToken(token);
    75→      if (decoded && decoded.sub) {
    76→        stripeCustomerId = decoded.sub;
    77→      }
    78→    }
    79→
    80→    if (!stripeCustomerId) {
    81→      stripeCustomerId = req.headers['x-stripe-customer-id'];
    82→    }
    83→
    84→    if (!stripeCustomerId) {
    85→      return res.status(401).json({
    86→        error: 'Authentication required',
    87→        message: 'Please provide a valid Bearer token or log in again'
    88→      });
    89→    }
    90→
    91→    try {
    92→      const history = await usageTracking.getUsageHistory(stripeCustomerId);
    93→      res.json({
    94→        success: true,
    95→        history
    96→      });
    97→    } catch (err) {
    98→      console.error('[SPLICE] Usage history error:', err);
    99→      res.status(500).json({ error: err.message });
   100→    }
   101→  });
   102→
   103→  return router;
   104→}
   105→
   106→module.exports = createBillingRoutes;
   107→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
