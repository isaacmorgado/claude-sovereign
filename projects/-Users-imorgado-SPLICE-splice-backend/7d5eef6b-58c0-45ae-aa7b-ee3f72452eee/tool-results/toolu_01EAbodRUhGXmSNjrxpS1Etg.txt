     1→/**
     2→ * Referral Routes
     3→ *
     4→ * Referral system endpoints
     5→ */
     6→
     7→const express = require('express');
     8→
     9→/**
    10→ * Create referral routes
    11→ * @param {Object} options - Route configuration options
    12→ * @param {Object} options.services - Shared services (referralService, stripe)
    13→ * @returns {express.Router}
    14→ */
    15→function createReferralRoutes(options = {}) {
    16→  const router = express.Router();
    17→  const { referralService, stripe } = options.services || {};
    18→
    19→  /**
    20→   * GET /code - Get or create referral code for user
    21→   *
    22→   * Requires x-stripe-customer-id header
    23→   */
    24→  router.get('/code', async (req, res) => {
    25→    const stripeCustomerId = req.headers['x-stripe-customer-id'];
    26→
    27→    if (!stripeCustomerId) {
    28→      return res.status(401).json({
    29→        error: 'Authentication required',
    30→        message: 'Missing x-stripe-customer-id header'
    31→      });
    32→    }
    33→
    34→    try {
    35→      const codeInfo = await referralService.getOrCreateCode(stripeCustomerId);
    36→      res.json({
    37→        success: true,
    38→        ...codeInfo
    39→      });
    40→    } catch (err) {
    41→      console.error('[SPLICE] Referral code error:', err);
    42→      res.status(500).json({ error: err.message });
    43→    }
    44→  });
    45→
    46→  /**
    47→   * POST /validate - Validate a referral code
    48→   *
    49→   * Body: { code: string, customerId?: string }
    50→   */
    51→  router.post('/validate', async (req, res) => {
    52→    const { code, customerId } = req.body;
    53→
    54→    if (!code) {
    55→      return res.status(400).json({
    56→        error: 'Missing code',
    57→        message: 'Referral code is required'
    58→      });
    59→    }
    60→
    61→    try {
    62→      const result = await referralService.validateCode(code, customerId);
    63→      res.json({
    64→        success: true,
    65→        ...result
    66→      });
    67→    } catch (err) {
    68→      console.error('[SPLICE] Referral validate error:', err);
    69→      res.status(500).json({ error: err.message });
    70→    }
    71→  });
    72→
    73→  /**
    74→   * POST /apply - Apply referral code at signup
    75→   *
    76→   * Body: { code: string, customerId: string }
    77→   */
    78→  router.post('/apply', async (req, res) => {
    79→    const { code, customerId } = req.body;
    80→
    81→    if (!code || !customerId) {
    82→      return res.status(400).json({
    83→        error: 'Missing required fields',
    84→        message: 'Both code and customerId are required'
    85→      });
    86→    }
    87→
    88→    try {
    89→      const result = await referralService.applyCode(code, customerId, stripe);
    90→      res.json({
    91→        success: true,
    92→        ...result
    93→      });
    94→    } catch (err) {
    95→      console.error('[SPLICE] Referral apply error:', err);
    96→      // Return user-friendly errors for validation failures
    97→      if (err.message.includes('Cannot use your own') ||
    98→          err.message.includes('already used') ||
    99→          err.message.includes('not found') ||
   100→          err.message.includes('no longer active')) {
   101→        return res.status(400).json({ error: err.message });
   102→      }
   103→      res.status(500).json({ error: err.message });
   104→    }
   105→  });
   106→
   107→  /**
   108→   * GET /stats - Get referral statistics for user
   109→   *
   110→   * Requires x-stripe-customer-id header
   111→   */
   112→  router.get('/stats', async (req, res) => {
   113→    const stripeCustomerId = req.headers['x-stripe-customer-id'];
   114→
   115→    if (!stripeCustomerId) {
   116→      return res.status(401).json({
   117→        error: 'Authentication required',
   118→        message: 'Missing x-stripe-customer-id header'
   119→      });
   120→    }
   121→
   122→    try {
   123→      const stats = await referralService.getStats(stripeCustomerId);
   124→      res.json({
   125→        success: true,
   126→        ...stats
   127→      });
   128→    } catch (err) {
   129→      console.error('[SPLICE] Referral stats error:', err);
   130→      res.status(500).json({ error: err.message });
   131→    }
   132→  });
   133→
   134→  return router;
   135→}
   136→
   137→module.exports = createReferralRoutes;
   138→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
