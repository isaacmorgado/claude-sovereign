{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":"Implement mutually exclusive treatment categories.\n\n**Key files to modify:**\n- `looksmaxx-app/src/lib/recommendations/types.ts` - Add exclusiveWith field\n- `looksmaxx-app/src/lib/recommendations/engine.ts` - Validate exclusivity\n- `looksmaxx-app/src/lib/advice-engine.ts` - Add exclusivity data\n\n**Reference FaceIQ logic from:**\n- `/Users/imorgado/LOOKSMAXX/FACEIQPAID/LOGIC/logic_report.md` (Section 6: Treatment Exclusivity)\n\n**FaceIQ Categories (from logic_report):**\n1. Jaw augmentation vs reduction (cannot combine)\n2. Chin augmentation (pick ONE): chin implants, genioplasty, fat grafting\n3. Cheekbone augmentation (pick ONE): fillers, implants\n4. Lip augmentation vs reduction\n5. Submental/Neck procedures\n6. Eye procedures: canthoplasty, canthopexy\n7. Maxillary repositioning: bimaxillary, LeFort\n\n**Implementation:**\n1. Add `exclusiveWith?: string[]` to Treatment interface\n2. Add `exclusiveCategory?: string` to group exclusive treatments\n3. Add validation in recommendation engine to filter conflicting treatments\n4. Show warning in UI when user selects conflicting treatments\n\nWrite the code. Do NOT just plan - actually implement it."},"uuid":"968222ec-95c6-4d90-aa26-c511fc23e922","timestamp":"2025-12-26T14:49:42.179Z"}
{"parentUuid":"968222ec-95c6-4d90-aa26-c511fc23e922","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RQADKbR5F5XUUCWqJPxc1Q","type":"message","role":"assistant","content":[{"type":"text","text":"I'll implement mutually exclusive treatment categories. Let me start by reading the reference file and the key files that need modification."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":26739,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":26739,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWVV3h4649YuvbhfsyP3K","type":"assistant","uuid":"6f6ac207-69db-4811-8203-8e8f84b1f14f","timestamp":"2025-12-26T14:49:48.215Z"}
{"parentUuid":"6f6ac207-69db-4811-8203-8e8f84b1f14f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RQADKbR5F5XUUCWqJPxc1Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QcuaBVduRVfLUdDKrTVRSS","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/FACEIQPAID/LOGIC/logic_report.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":26739,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":26739,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWVV3h4649YuvbhfsyP3K","type":"assistant","uuid":"eed2c9f6-cdcb-4904-9fe3-64e993d46ec1","timestamp":"2025-12-26T14:49:48.797Z"}
{"parentUuid":"eed2c9f6-cdcb-4904-9fe3-64e993d46ec1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RQADKbR5F5XUUCWqJPxc1Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012rpkQab1K6kiCzAwxKp8uW","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/types.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":26739,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":26739,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWVV3h4649YuvbhfsyP3K","type":"assistant","uuid":"ddb70893-31da-4ddc-b768-1f2409e47beb","timestamp":"2025-12-26T14:49:49.250Z"}
{"parentUuid":"ddb70893-31da-4ddc-b768-1f2409e47beb","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RQADKbR5F5XUUCWqJPxc1Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HxDabgyPgSw1j4E9xNMV8Y","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":26739,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":26739,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWVV3h4649YuvbhfsyP3K","type":"assistant","uuid":"e2282c1b-351b-41d8-8be3-63d2e63289be","timestamp":"2025-12-26T14:49:49.851Z"}
{"parentUuid":"e2282c1b-351b-41d8-8be3-63d2e63289be","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RQADKbR5F5XUUCWqJPxc1Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01E61KrMwmBcCeePWnJhCXwT","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":26739,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":26739,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWVV3h4649YuvbhfsyP3K","type":"assistant","uuid":"a172cbe8-337f-4ac4-99cb-aec3e5b7132c","timestamp":"2025-12-26T14:49:50.412Z"}
{"parentUuid":"a172cbe8-337f-4ac4-99cb-aec3e5b7132c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012rpkQab1K6kiCzAwxKp8uW","type":"tool_result","content":"     1→/**\n     2→ * Recommendation System Types\n     3→ * Comprehensive type definitions for looksmaxxing recommendations\n     4→ */\n     5→\n     6→// ============================================\n     7→// ENUMS & BASIC TYPES\n     8→// ============================================\n     9→\n    10→export type Severity = 'optimal' | 'mild' | 'moderate' | 'severe';\n    11→\n    12→export type TreatmentCategory =\n    13→  | 'lifestyle'\n    14→  | 'softmaxxing'\n    15→  | 'non_surgical'\n    16→  | 'minimally_invasive'\n    17→  | 'surgical';\n    18→\n    19→export type CostLevel = 'free' | 'low' | 'medium' | 'high' | 'very_high';\n    20→\n    21→export type EvidenceLevel = 'strong' | 'moderate' | 'weak' | 'anecdotal';\n    22→\n    23→export type RiskLevel = 'none' | 'very_low' | 'low' | 'medium' | 'high' | 'very_high';\n    24→\n    25→export type Gender = 'male' | 'female';\n    26→\n    27→export type ProfileType = 'front' | 'side';\n    28→\n    29→// ============================================\n    30→// TREATMENT TYPES\n    31→// ============================================\n    32→\n    33→export interface Treatment {\n    34→  id: string;\n    35→  name: string;\n    36→  category: TreatmentCategory;\n    37→  description: string;\n    38→  howItWorks: string;\n    39→\n    40→  // Effectiveness\n    41→  effectiveness: number; // 1-10\n    42→  evidenceLevel: EvidenceLevel;\n    43→  pslImprovement: { min: number; max: number };\n    44→\n    45→  // Costs\n    46→  costLevel: CostLevel;\n    47→  costRange: { min: number; max: number; currency: string };\n    48→  costFrequency: 'one-time' | 'monthly' | 'per-session' | 'annual';\n    49→\n    50→  // Timeline\n    51→  timelineToResults: string;\n    52→  resultsDuration: string;\n    53→  maintenanceRequired: boolean;\n    54→  maintenanceFrequency?: string;\n    55→\n    56→  // Recovery\n    57→  recoveryTime: string;\n    58→  downtime: string;\n    59→  painLevel: 'none' | 'low' | 'moderate' | 'high';\n    60→\n    61→  // Risk\n    62→  riskLevel: RiskLevel;\n    63→  sideEffects: string[];\n    64→  contraindications: string[];\n    65→\n    66→  // Applicability\n    67→  targetMetrics: string[];\n    68→  targetIssues: string[];\n    69→  genderSpecific?: Gender;\n    70→  ageRestrictions?: { min?: number; max?: number };\n    71→\n    72→  // Additional info\n    73→  notes?: string[];\n    74→  sources?: string[];\n    75→}\n    76→\n    77→export interface Surgery extends Treatment {\n    78→  category: 'surgical';\n    79→  surgeonRecommendations?: SurgeonInfo[];\n    80→  regionalCosts: RegionalCost[];\n    81→  revisionRate?: number;\n    82→  permanence: 'permanent' | 'semi-permanent' | 'temporary';\n    83→  hospitalStay?: string;\n    84→  anesthesiaType: 'local' | 'sedation' | 'general';\n    85→}\n    86→\n    87→export interface SurgeonInfo {\n    88→  name: string;\n    89→  location: string;\n    90→  specialty: string;\n    91→  costRange: string;\n    92→  notes?: string;\n    93→}\n    94→\n    95→export interface RegionalCost {\n    96→  region: string;\n    97→  min: number;\n    98→  max: number;\n    99→  currency: string;\n   100→  notes?: string;\n   101→}\n   102→\n   103→export interface Supplement {\n   104→  id: string;\n   105→  name: string;\n   106→  category: 'skin' | 'hair' | 'bone' | 'hormonal' | 'anti-aging' | 'general';\n   107→  description: string;\n   108→\n   109→  // Dosage\n   110→  dosage: string;\n   111→  frequency: string;\n   112→  timing?: string; // e.g., \"with meals\", \"before bed\"\n   113→\n   114→  // Effectiveness\n   115→  effectiveness: number; // 1-10\n   116→  evidenceLevel: EvidenceLevel;\n   117→\n   118→  // Cost\n   119→  costPerMonth: { min: number; max: number };\n   120→\n   121→  // Timeline\n   122→  timelineToResults: string;\n   123→\n   124→  // Safety\n   125→  riskLevel: RiskLevel;\n   126→  sideEffects: string[];\n   127→  interactions: string[];\n   128→  contraindications: string[];\n   129→\n   130→  // Applicability\n   131→  targetBenefits: string[];\n   132→  requiresPrescription: boolean;\n   133→\n   134→  notes?: string[];\n   135→  sources?: string[];\n   136→}\n   137→\n   138→// ============================================\n   139→// SEVERITY & SCORING\n   140→// ============================================\n   141→\n   142→export interface SeverityThreshold {\n   143→  metric: string;\n   144→  optimal: { min: number; max: number };\n   145→  mild: { min: number; max: number };\n   146→  moderate: { min: number; max: number };\n   147→  severe: { min: number; max: number };\n   148→  unit: string;\n   149→  higherIsBetter?: boolean;\n   150→}\n   151→\n   152→export interface SeverityResult {\n   153→  severity: Severity;\n   154→  label: string;\n   155→  color: string;\n   156→  icon: string;\n   157→  description: string;\n   158→}\n   159→\n   160→// ============================================\n   161→// RECOMMENDATION ENGINE TYPES\n   162→// ============================================\n   163→\n   164→export interface MetricAnalysis {\n   165→  metricId: string;\n   166→  metricName: string;\n   167→  currentValue: number;\n   168→  idealValue: number;\n   169→  idealRange: { min: number; max: number };\n   170→  deviation: number;\n   171→  deviationPercent: number;\n   172→  score: number;\n   173→  severity: SeverityResult;\n   174→  issue?: string;\n   175→  profileType: ProfileType;\n   176→}\n   177→\n   178→export interface TreatmentRecommendation {\n   179→  treatment: Treatment | Surgery | Supplement;\n   180→  priority: 'high' | 'medium' | 'low';\n   181→  relevanceScore: number; // 0-100\n   182→  targetMetrics: string[];\n   183→  estimatedImprovement: number;\n   184→  reasoning: string;\n   185→}\n   186→\n   187→export interface RecommendationPlan {\n   188→  // Summary\n   189→  overallScore: number;\n   190→  overallSeverity: SeverityResult;\n   191→  harmonyScore: number;\n   192→  percentile: number;\n   193→\n   194→  // Analysis\n   195→  metricAnalyses: MetricAnalysis[];\n   196→  strengths: MetricAnalysis[];\n   197→  weaknesses: MetricAnalysis[];\n   198→\n   199→  // Recommendations by category\n   200→  lifestyle: TreatmentRecommendation[];\n   201→  softmaxxing: TreatmentRecommendation[];\n   202→  nonSurgical: TreatmentRecommendation[];\n   203→  minimallyInvasive: TreatmentRecommendation[];\n   204→  surgical: TreatmentRecommendation[];\n   205→  supplements: TreatmentRecommendation[];\n   206→\n   207→  // Potential\n   208→  currentPSL: number;\n   209→  potentialPSL: number;\n   210→  potentialImprovement: number;\n   211→\n   212→  // Order of operations\n   213→  orderOfOperations: OrderOfOperation[];\n   214→}\n   215→\n   216→export interface OrderOfOperation {\n   217→  step: number;\n   218→  category: TreatmentCategory;\n   219→  treatment: Treatment | Surgery;\n   220→  reasoning: string;\n   221→  prerequisites?: string[];\n   222→  waitTime?: string;\n   223→}\n   224→\n   225→// ============================================\n   226→// METRIC TO ISSUE MAPPING\n   227→// ============================================\n   228→\n   229→export interface MetricIssueMapping {\n   230→  metric: string;\n   231→  lowIssue: string;\n   232→  highIssue: string;\n   233→  lowTreatments: string[];\n   234→  highTreatments: string[];\n   235→}\n   236→\n   237→// ============================================\n   238→// PSL RATING SYSTEM\n   239→// ============================================\n   240→\n   241→export interface PSLRating {\n   242→  score: number;\n   243→  tier: string;\n   244→  percentile: number;\n   245→  description: string;\n   246→}\n   247→\n   248→export const PSL_TIERS: PSLRating[] = [\n   249→  { score: 7.5, tier: 'Top Model', percentile: 99.99, description: 'Near perfection - world-class genetics' },\n   250→  { score: 7.0, tier: 'Chad', percentile: 99.87, description: 'Exceptional - top 0.1%' },\n   251→  { score: 6.5, tier: 'Chadlite', percentile: 99.0, description: 'Very attractive - top 1%' },\n   252→  { score: 6.0, tier: 'High Tier Normie+', percentile: 97.25, description: 'Notably attractive - top 3%' },\n   253→  { score: 5.5, tier: 'High Tier Normie', percentile: 90.0, description: 'Above average - top 10%' },\n   254→  { score: 5.0, tier: 'Mid Tier Normie+', percentile: 84.15, description: 'Slightly above average' },\n   255→  { score: 4.5, tier: 'Mid Tier Normie', percentile: 65.0, description: 'Average' },\n   256→  { score: 4.0, tier: 'Low Tier Normie', percentile: 50.0, description: 'Median' },\n   257→  { score: 3.5, tier: 'Below Average', percentile: 30.0, description: 'Below average' },\n   258→  { score: 3.0, tier: 'Subpar', percentile: 15.0, description: 'Noticeably below average' },\n   259→];\n   260→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"12eaeb26-8971-4b00-b484-63f5f89c6084","timestamp":"2025-12-26T14:49:50.483Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/types.ts","content":"/**\n * Recommendation System Types\n * Comprehensive type definitions for looksmaxxing recommendations\n */\n\n// ============================================\n// ENUMS & BASIC TYPES\n// ============================================\n\nexport type Severity = 'optimal' | 'mild' | 'moderate' | 'severe';\n\nexport type TreatmentCategory =\n  | 'lifestyle'\n  | 'softmaxxing'\n  | 'non_surgical'\n  | 'minimally_invasive'\n  | 'surgical';\n\nexport type CostLevel = 'free' | 'low' | 'medium' | 'high' | 'very_high';\n\nexport type EvidenceLevel = 'strong' | 'moderate' | 'weak' | 'anecdotal';\n\nexport type RiskLevel = 'none' | 'very_low' | 'low' | 'medium' | 'high' | 'very_high';\n\nexport type Gender = 'male' | 'female';\n\nexport type ProfileType = 'front' | 'side';\n\n// ============================================\n// TREATMENT TYPES\n// ============================================\n\nexport interface Treatment {\n  id: string;\n  name: string;\n  category: TreatmentCategory;\n  description: string;\n  howItWorks: string;\n\n  // Effectiveness\n  effectiveness: number; // 1-10\n  evidenceLevel: EvidenceLevel;\n  pslImprovement: { min: number; max: number };\n\n  // Costs\n  costLevel: CostLevel;\n  costRange: { min: number; max: number; currency: string };\n  costFrequency: 'one-time' | 'monthly' | 'per-session' | 'annual';\n\n  // Timeline\n  timelineToResults: string;\n  resultsDuration: string;\n  maintenanceRequired: boolean;\n  maintenanceFrequency?: string;\n\n  // Recovery\n  recoveryTime: string;\n  downtime: string;\n  painLevel: 'none' | 'low' | 'moderate' | 'high';\n\n  // Risk\n  riskLevel: RiskLevel;\n  sideEffects: string[];\n  contraindications: string[];\n\n  // Applicability\n  targetMetrics: string[];\n  targetIssues: string[];\n  genderSpecific?: Gender;\n  ageRestrictions?: { min?: number; max?: number };\n\n  // Additional info\n  notes?: string[];\n  sources?: string[];\n}\n\nexport interface Surgery extends Treatment {\n  category: 'surgical';\n  surgeonRecommendations?: SurgeonInfo[];\n  regionalCosts: RegionalCost[];\n  revisionRate?: number;\n  permanence: 'permanent' | 'semi-permanent' | 'temporary';\n  hospitalStay?: string;\n  anesthesiaType: 'local' | 'sedation' | 'general';\n}\n\nexport interface SurgeonInfo {\n  name: string;\n  location: string;\n  specialty: string;\n  costRange: string;\n  notes?: string;\n}\n\nexport interface RegionalCost {\n  region: string;\n  min: number;\n  max: number;\n  currency: string;\n  notes?: string;\n}\n\nexport interface Supplement {\n  id: string;\n  name: string;\n  category: 'skin' | 'hair' | 'bone' | 'hormonal' | 'anti-aging' | 'general';\n  description: string;\n\n  // Dosage\n  dosage: string;\n  frequency: string;\n  timing?: string; // e.g., \"with meals\", \"before bed\"\n\n  // Effectiveness\n  effectiveness: number; // 1-10\n  evidenceLevel: EvidenceLevel;\n\n  // Cost\n  costPerMonth: { min: number; max: number };\n\n  // Timeline\n  timelineToResults: string;\n\n  // Safety\n  riskLevel: RiskLevel;\n  sideEffects: string[];\n  interactions: string[];\n  contraindications: string[];\n\n  // Applicability\n  targetBenefits: string[];\n  requiresPrescription: boolean;\n\n  notes?: string[];\n  sources?: string[];\n}\n\n// ============================================\n// SEVERITY & SCORING\n// ============================================\n\nexport interface SeverityThreshold {\n  metric: string;\n  optimal: { min: number; max: number };\n  mild: { min: number; max: number };\n  moderate: { min: number; max: number };\n  severe: { min: number; max: number };\n  unit: string;\n  higherIsBetter?: boolean;\n}\n\nexport interface SeverityResult {\n  severity: Severity;\n  label: string;\n  color: string;\n  icon: string;\n  description: string;\n}\n\n// ============================================\n// RECOMMENDATION ENGINE TYPES\n// ============================================\n\nexport interface MetricAnalysis {\n  metricId: string;\n  metricName: string;\n  currentValue: number;\n  idealValue: number;\n  idealRange: { min: number; max: number };\n  deviation: number;\n  deviationPercent: number;\n  score: number;\n  severity: SeverityResult;\n  issue?: string;\n  profileType: ProfileType;\n}\n\nexport interface TreatmentRecommendation {\n  treatment: Treatment | Surgery | Supplement;\n  priority: 'high' | 'medium' | 'low';\n  relevanceScore: number; // 0-100\n  targetMetrics: string[];\n  estimatedImprovement: number;\n  reasoning: string;\n}\n\nexport interface RecommendationPlan {\n  // Summary\n  overallScore: number;\n  overallSeverity: SeverityResult;\n  harmonyScore: number;\n  percentile: number;\n\n  // Analysis\n  metricAnalyses: MetricAnalysis[];\n  strengths: MetricAnalysis[];\n  weaknesses: MetricAnalysis[];\n\n  // Recommendations by category\n  lifestyle: TreatmentRecommendation[];\n  softmaxxing: TreatmentRecommendation[];\n  nonSurgical: TreatmentRecommendation[];\n  minimallyInvasive: TreatmentRecommendation[];\n  surgical: TreatmentRecommendation[];\n  supplements: TreatmentRecommendation[];\n\n  // Potential\n  currentPSL: number;\n  potentialPSL: number;\n  potentialImprovement: number;\n\n  // Order of operations\n  orderOfOperations: OrderOfOperation[];\n}\n\nexport interface OrderOfOperation {\n  step: number;\n  category: TreatmentCategory;\n  treatment: Treatment | Surgery;\n  reasoning: string;\n  prerequisites?: string[];\n  waitTime?: string;\n}\n\n// ============================================\n// METRIC TO ISSUE MAPPING\n// ============================================\n\nexport interface MetricIssueMapping {\n  metric: string;\n  lowIssue: string;\n  highIssue: string;\n  lowTreatments: string[];\n  highTreatments: string[];\n}\n\n// ============================================\n// PSL RATING SYSTEM\n// ============================================\n\nexport interface PSLRating {\n  score: number;\n  tier: string;\n  percentile: number;\n  description: string;\n}\n\nexport const PSL_TIERS: PSLRating[] = [\n  { score: 7.5, tier: 'Top Model', percentile: 99.99, description: 'Near perfection - world-class genetics' },\n  { score: 7.0, tier: 'Chad', percentile: 99.87, description: 'Exceptional - top 0.1%' },\n  { score: 6.5, tier: 'Chadlite', percentile: 99.0, description: 'Very attractive - top 1%' },\n  { score: 6.0, tier: 'High Tier Normie+', percentile: 97.25, description: 'Notably attractive - top 3%' },\n  { score: 5.5, tier: 'High Tier Normie', percentile: 90.0, description: 'Above average - top 10%' },\n  { score: 5.0, tier: 'Mid Tier Normie+', percentile: 84.15, description: 'Slightly above average' },\n  { score: 4.5, tier: 'Mid Tier Normie', percentile: 65.0, description: 'Average' },\n  { score: 4.0, tier: 'Low Tier Normie', percentile: 50.0, description: 'Median' },\n  { score: 3.5, tier: 'Below Average', percentile: 30.0, description: 'Below average' },\n  { score: 3.0, tier: 'Subpar', percentile: 15.0, description: 'Noticeably below average' },\n];\n","numLines":260,"startLine":1,"totalLines":260}}}
{"parentUuid":"12eaeb26-8971-4b00-b484-63f5f89c6084","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HxDabgyPgSw1j4E9xNMV8Y","type":"tool_result","content":"     1→/**\n     2→ * Recommendation Engine\n     3→ * Analyzes facial metrics and generates personalized treatment recommendations\n     4→ */\n     5→\n     6→import {\n     7→  Treatment,\n     8→  Surgery,\n     9→  Supplement,\n    10→  TreatmentRecommendation,\n    11→  MetricAnalysis,\n    12→  RecommendationPlan,\n    13→  OrderOfOperation,\n    14→  TreatmentCategory,\n    15→  Gender,\n    16→  ProfileType,\n    17→} from './types';\n    18→import { SOFTMAXXING_TREATMENTS } from './softmaxxing';\n    19→import { SURGICAL_TREATMENTS } from './hardmaxxing';\n    20→import { SUPPLEMENTS } from './supplements';\n    21→import { NON_SURGICAL_TREATMENTS } from './nonSurgical';\n    22→import {\n    23→  classifyMetricValue,\n    24→  calculateDeviation,\n    25→  getIssueForMetric,\n    26→  getTreatmentIdsForMetric,\n    27→  getOverallSeverity,\n    28→  harmonyToPSL,\n    29→  estimatePotentialPSL,\n    30→} from './severity';\n    31→\n    32→// ============================================\n    33→// ALL TREATMENTS COMBINED\n    34→// ============================================\n    35→\n    36→const ALL_TREATMENTS: (Treatment | Surgery)[] = [\n    37→  ...SOFTMAXXING_TREATMENTS,\n    38→  ...NON_SURGICAL_TREATMENTS,\n    39→  ...SURGICAL_TREATMENTS,\n    40→];\n    41→\n    42→// ============================================\n    43→// METRIC ANALYSIS\n    44→// ============================================\n    45→\n    46→export interface MetricInput {\n    47→  metricId: string;\n    48→  metricName: string;\n    49→  currentValue: number;\n    50→  idealValue: number;\n    51→  idealRange: { min: number; max: number };\n    52→  score: number;\n    53→  profileType: ProfileType;\n    54→}\n    55→\n    56→/**\n    57→ * Analyze a single metric and determine severity\n    58→ */\n    59→export function analyzeMetric(\n    60→  input: MetricInput,\n    61→  gender?: Gender\n    62→): MetricAnalysis {\n    63→  const { deviation, deviationPercent, direction } = calculateDeviation(\n    64→    input.metricId,\n    65→    input.currentValue\n    66→  );\n    67→\n    68→  const severity = classifyMetricValue(input.metricId, input.currentValue, gender);\n    69→  const issue = getIssueForMetric(input.metricId, direction);\n    70→\n    71→  return {\n    72→    metricId: input.metricId,\n    73→    metricName: input.metricName,\n    74→    currentValue: input.currentValue,\n    75→    idealValue: input.idealValue,\n    76→    idealRange: input.idealRange,\n    77→    deviation,\n    78→    deviationPercent,\n    79→    score: input.score,\n    80→    severity,\n    81→    issue: issue || undefined,\n    82→    profileType: input.profileType,\n    83→  };\n    84→}\n    85→\n    86→/**\n    87→ * Analyze all metrics and sort by severity\n    88→ */\n    89→export function analyzeAllMetrics(\n    90→  metrics: MetricInput[],\n    91→  gender?: Gender\n    92→): MetricAnalysis[] {\n    93→  const analyses = metrics.map(m => analyzeMetric(m, gender));\n    94→\n    95→  // Sort by severity (severe first) then by score (lowest first)\n    96→  const severityOrder = { severe: 0, moderate: 1, mild: 2, optimal: 3 };\n    97→\n    98→  return analyses.sort((a, b) => {\n    99→    const severityDiff = severityOrder[a.severity.severity] - severityOrder[b.severity.severity];\n   100→    if (severityDiff !== 0) return severityDiff;\n   101→    return a.score - b.score;\n   102→  });\n   103→}\n   104→\n   105→// ============================================\n   106→// TREATMENT MATCHING\n   107→// ============================================\n   108→\n   109→/**\n   110→ * Find treatment by ID\n   111→ */\n   112→export function findTreatment(id: string): Treatment | Surgery | Supplement | undefined {\n   113→  const treatment = ALL_TREATMENTS.find(t => t.id === id);\n   114→  if (treatment) return treatment;\n   115→\n   116→  return SUPPLEMENTS.find(s => s.id === id);\n   117→}\n   118→\n   119→/**\n   120→ * Find treatments that target a specific issue\n   121→ */\n   122→export function findTreatmentsForIssue(issue: string): (Treatment | Surgery)[] {\n   123→  return ALL_TREATMENTS.filter(t =>\n   124→    t.targetIssues.some(i =>\n   125→      i.toLowerCase().includes(issue.toLowerCase()) ||\n   126→      issue.toLowerCase().includes(i.toLowerCase())\n   127→    )\n   128→  );\n   129→}\n   130→\n   131→/**\n   132→ * Find treatments that target a specific metric\n   133→ */\n   134→export function findTreatmentsForMetric(metricId: string): (Treatment | Surgery)[] {\n   135→  return ALL_TREATMENTS.filter(t =>\n   136→    t.targetMetrics.some(m =>\n   137→      m.toLowerCase().includes(metricId.toLowerCase()) ||\n   138→      metricId.toLowerCase().includes(m.toLowerCase())\n   139→    )\n   140→  );\n   141→}\n   142→\n   143→/**\n   144→ * Score treatment relevance for a metric analysis\n   145→ */\n   146→function scoreTreatmentRelevance(\n   147→  treatment: Treatment | Surgery,\n   148→  analysis: MetricAnalysis\n   149→): number {\n   150→  let score = 0;\n   151→\n   152→  // Check if treatment targets this metric\n   153→  const targetsMetric = treatment.targetMetrics.some(m =>\n   154→    m.toLowerCase().includes(analysis.metricId.toLowerCase())\n   155→  );\n   156→  if (targetsMetric) score += 30;\n   157→\n   158→  // Check if treatment addresses the issue\n   159→  if (analysis.issue) {\n   160→    const addressesIssue = treatment.targetIssues.some(i =>\n   161→      i.toLowerCase().includes(analysis.issue!.toLowerCase()) ||\n   162→      analysis.issue!.toLowerCase().includes(i.toLowerCase())\n   163→    );\n   164→    if (addressesIssue) score += 40;\n   165→  }\n   166→\n   167→  // Factor in severity\n   168→  const severityMultiplier = {\n   169→    severe: 1.5,\n   170→    moderate: 1.2,\n   171→    mild: 1.0,\n   172→    optimal: 0.3,\n   173→  };\n   174→  score *= severityMultiplier[analysis.severity.severity];\n   175→\n   176→  // Factor in treatment effectiveness\n   177→  score += treatment.effectiveness * 2;\n   178→\n   179→  // Factor in PSL improvement potential\n   180→  const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n   181→  score += avgPSLImprovement * 10;\n   182→\n   183→  return Math.round(score);\n   184→}\n   185→\n   186→/**\n   187→ * Generate treatment recommendations for a metric analysis\n   188→ */\n   189→export function getRecommendationsForMetric(\n   190→  analysis: MetricAnalysis,\n   191→  gender?: Gender,\n   192→  maxRecommendations: number = 5\n   193→): TreatmentRecommendation[] {\n   194→  if (analysis.severity.severity === 'optimal') {\n   195→    return []; // No treatment needed for optimal metrics\n   196→  }\n   197→\n   198→  // Get treatment IDs from mapping\n   199→  const { direction } = calculateDeviation(analysis.metricId, analysis.currentValue);\n   200→  const treatmentIds = getTreatmentIdsForMetric(analysis.metricId, direction);\n   201→\n   202→  // Find matching treatments\n   203→  let treatments: (Treatment | Surgery)[] = [];\n   204→\n   205→  // First, add treatments from the mapping\n   206→  for (const id of treatmentIds) {\n   207→    const treatment = findTreatment(id);\n   208→    if (treatment && 'category' in treatment && treatment.category !== undefined) {\n   209→      treatments.push(treatment as Treatment | Surgery);\n   210→    }\n   211→  }\n   212→\n   213→  // Then, find additional treatments that target this metric or issue\n   214→  const additionalTreatments = [\n   215→    ...findTreatmentsForMetric(analysis.metricId),\n   216→    ...(analysis.issue ? findTreatmentsForIssue(analysis.issue) : []),\n   217→  ];\n   218→\n   219→  // Remove duplicates\n   220→  const seenIds = treatments.map(t => t.id);\n   221→  for (const t of additionalTreatments) {\n   222→    if (!seenIds.includes(t.id)) {\n   223→      seenIds.push(t.id);\n   224→      treatments.push(t);\n   225→    }\n   226→  }\n   227→\n   228→  // Filter by gender if specified\n   229→  if (gender) {\n   230→    treatments = treatments.filter(t =>\n   231→      !t.genderSpecific || t.genderSpecific === gender\n   232→    );\n   233→  }\n   234→\n   235→  // Score and rank treatments\n   236→  const scoredTreatments = treatments.map(treatment => ({\n   237→    treatment,\n   238→    relevanceScore: scoreTreatmentRelevance(treatment, analysis),\n   239→  }));\n   240→\n   241→  // Sort by relevance score\n   242→  scoredTreatments.sort((a, b) => b.relevanceScore - a.relevanceScore);\n   243→\n   244→  // Create recommendations\n   245→  return scoredTreatments.slice(0, maxRecommendations).map(({ treatment, relevanceScore }) => {\n   246→    const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n   247→\n   248→    return {\n   249→      treatment,\n   250→      priority: relevanceScore >= 60 ? 'high' as const :\n   251→                relevanceScore >= 40 ? 'medium' as const :\n   252→                'low' as const,\n   253→      relevanceScore,\n   254→      targetMetrics: [analysis.metricId],\n   255→      estimatedImprovement: avgPSLImprovement,\n   256→      reasoning: generateReasoning(treatment, analysis),\n   257→    };\n   258→  });\n   259→}\n   260→\n   261→/**\n   262→ * Generate human-readable reasoning for a recommendation\n   263→ */\n   264→function generateReasoning(\n   265→  treatment: Treatment | Surgery,\n   266→  analysis: MetricAnalysis\n   267→): string {\n   268→  const parts: string[] = [];\n   269→\n   270→  // Issue description\n   271→  if (analysis.issue) {\n   272→    parts.push(`Addresses ${analysis.issue.replace(/_/g, ' ')}`);\n   273→  }\n   274→\n   275→  // Effectiveness\n   276→  parts.push(`Effectiveness: ${treatment.effectiveness}/10`);\n   277→\n   278→  // PSL improvement\n   279→  const pslRange = `${treatment.pslImprovement.min}-${treatment.pslImprovement.max}`;\n   280→  parts.push(`Expected improvement: ${pslRange} PSL points`);\n   281→\n   282→  // Timeline\n   283→  parts.push(`Results in: ${treatment.timelineToResults}`);\n   284→\n   285→  return parts.join('. ') + '.';\n   286→}\n   287→\n   288→// ============================================\n   289→// RECOMMENDATION PLAN GENERATION\n   290→// ============================================\n   291→\n   292→/**\n   293→ * Generate a comprehensive recommendation plan\n   294→ */\n   295→export function generateRecommendationPlan(\n   296→  metrics: MetricInput[],\n   297→  overallScore: number,\n   298→  harmonyPercent: number,\n   299→  gender?: Gender\n   300→): RecommendationPlan {\n   301→  // Analyze all metrics\n   302→  const metricAnalyses = analyzeAllMetrics(metrics, gender);\n   303→\n   304→  // Determine strengths and weaknesses\n   305→  const strengths = metricAnalyses.filter(m =>\n   306→    m.severity.severity === 'optimal' || m.score >= 85\n   307→  );\n   308→  const weaknesses = metricAnalyses.filter(m =>\n   309→    m.severity.severity !== 'optimal' && m.score < 85\n   310→  );\n   311→\n   312→  // Get recommendations for each weakness\n   313→  const allRecommendations: TreatmentRecommendation[] = [];\n   314→  for (const weakness of weaknesses) {\n   315→    const recs = getRecommendationsForMetric(weakness, gender);\n   316→    allRecommendations.push(...recs);\n   317→  }\n   318→\n   319→  // Deduplicate recommendations (same treatment might help multiple metrics)\n   320→  const uniqueRecommendations = deduplicateRecommendations(allRecommendations);\n   321→\n   322→  // Categorize recommendations\n   323→  const lifestyle = uniqueRecommendations.filter(r =>\n   324→    r.treatment.category === 'lifestyle' || r.treatment.category === 'softmaxxing'\n   325→  );\n   326→  const softmaxxing = uniqueRecommendations.filter(r =>\n   327→    r.treatment.category === 'softmaxxing'\n   328→  );\n   329→  const nonSurgical = uniqueRecommendations.filter(r =>\n   330→    r.treatment.category === 'non_surgical'\n   331→  );\n   332→  const minimallyInvasive = uniqueRecommendations.filter(r =>\n   333→    r.treatment.category === 'minimally_invasive'\n   334→  );\n   335→  const surgical = uniqueRecommendations.filter(r =>\n   336→    r.treatment.category === 'surgical'\n   337→  );\n   338→\n   339→  // Get supplement recommendations\n   340→  const supplements = getSupplementRecommendations(weaknesses, gender);\n   341→\n   342→  // Calculate PSL ratings\n   343→  const pslRating = harmonyToPSL(harmonyPercent);\n   344→  const treatmentImprovements = uniqueRecommendations.map(r => r.estimatedImprovement);\n   345→  const potentialPSL = estimatePotentialPSL(pslRating.psl, treatmentImprovements);\n   346→\n   347→  // Generate order of operations\n   348→  const orderOfOperations = generateOrderOfOperations(uniqueRecommendations);\n   349→\n   350→  // Get overall severity\n   351→  const overallSeverity = getOverallSeverity(metricAnalyses.map(m => m.severity.severity));\n   352→\n   353→  return {\n   354→    overallScore,\n   355→    overallSeverity,\n   356→    harmonyScore: harmonyPercent,\n   357→    percentile: pslRating.percentile,\n   358→    metricAnalyses,\n   359→    strengths,\n   360→    weaknesses,\n   361→    lifestyle,\n   362→    softmaxxing,\n   363→    nonSurgical,\n   364→    minimallyInvasive,\n   365→    surgical,\n   366→    supplements,\n   367→    currentPSL: pslRating.psl,\n   368→    potentialPSL: potentialPSL.potentialPSL,\n   369→    potentialImprovement: potentialPSL.totalImprovement,\n   370→    orderOfOperations,\n   371→  };\n   372→}\n   373→\n   374→/**\n   375→ * Deduplicate recommendations, combining target metrics for same treatment\n   376→ */\n   377→function deduplicateRecommendations(\n   378→  recommendations: TreatmentRecommendation[]\n   379→): TreatmentRecommendation[] {\n   380→  const byId = new Map<string, TreatmentRecommendation>();\n   381→\n   382→  for (const rec of recommendations) {\n   383→    const existing = byId.get(rec.treatment.id);\n   384→    if (existing) {\n   385→      // Combine target metrics (deduplicate using filter)\n   386→      const combined = [...existing.targetMetrics, ...rec.targetMetrics];\n   387→      existing.targetMetrics = combined.filter((m, i) => combined.indexOf(m) === i);\n   388→\n   389→      // Take higher relevance score\n   390→      existing.relevanceScore = Math.max(existing.relevanceScore, rec.relevanceScore);\n   391→\n   392→      // Update priority based on new relevance\n   393→      existing.priority = existing.relevanceScore >= 60 ? 'high' :\n   394→                         existing.relevanceScore >= 40 ? 'medium' :\n   395→                         'low';\n   396→    } else {\n   397→      byId.set(rec.treatment.id, { ...rec });\n   398→    }\n   399→  }\n   400→\n   401→  return Array.from(byId.values()).sort((a, b) => b.relevanceScore - a.relevanceScore);\n   402→}\n   403→\n   404→/**\n   405→ * Get supplement recommendations based on weaknesses\n   406→ */\n   407→function getSupplementRecommendations(\n   408→  weaknesses: MetricAnalysis[],\n   409→  gender?: Gender\n   410→): TreatmentRecommendation[] {\n   411→  const recommendations: TreatmentRecommendation[] = [];\n   412→\n   413→  // Map weakness types to supplement categories\n   414→  const hasSkinIssues = weaknesses.some(w =>\n   415→    w.issue?.includes('skin') || w.metricId.includes('skin')\n   416→  );\n   417→  const hasHairIssues = weaknesses.some(w =>\n   418→    w.issue?.includes('hair') || w.metricId.includes('hairline')\n   419→  );\n   420→  const hasGeneralAging = weaknesses.some(w =>\n   421→    w.issue?.includes('aging') || w.severity.severity === 'moderate' || w.severity.severity === 'severe'\n   422→  );\n   423→\n   424→  // Helper to create supplement recommendation\n   425→  const createSupplementRec = (\n   426→    supp: Supplement,\n   427→    priority: 'high' | 'medium' | 'low',\n   428→    relevanceScore: number,\n   429→    targetMetrics: string[],\n   430→    reasoning: string\n   431→  ): TreatmentRecommendation => ({\n   432→    treatment: {\n   433→      id: supp.id,\n   434→      name: supp.name,\n   435→      category: 'lifestyle',\n   436→      description: supp.description,\n   437→      howItWorks: `Dosage: ${supp.dosage} ${supp.frequency}`,\n   438→      effectiveness: supp.effectiveness,\n   439→      evidenceLevel: supp.evidenceLevel,\n   440→      pslImprovement: { min: 0.05, max: 0.15 },\n   441→      costLevel: supp.costPerMonth.max > 30 ? 'medium' : 'low',\n   442→      costRange: { min: supp.costPerMonth.min, max: supp.costPerMonth.max, currency: 'USD' },\n   443→      costFrequency: 'monthly',\n   444→      timelineToResults: supp.timelineToResults,\n   445→      resultsDuration: 'Ongoing with continued use',\n   446→      maintenanceRequired: true,\n   447→      maintenanceFrequency: supp.frequency,\n   448→      recoveryTime: 'None',\n   449→      downtime: 'None',\n   450→      painLevel: 'none',\n   451→      riskLevel: supp.riskLevel,\n   452→      sideEffects: supp.sideEffects,\n   453→      contraindications: supp.contraindications,\n   454→      targetMetrics,\n   455→      targetIssues: supp.targetBenefits,\n   456→      notes: supp.notes,\n   457→      sources: supp.sources,\n   458→    },\n   459→    priority,\n   460→    relevanceScore,\n   461→    targetMetrics,\n   462→    estimatedImprovement: 0.1,\n   463→    reasoning,\n   464→  });\n   465→\n   466→  // Add relevant supplements\n   467→  if (hasSkinIssues || hasGeneralAging) {\n   468→    const skinSupplements = SUPPLEMENTS.filter(s =>\n   469→      s.category === 'skin' || s.category === 'anti-aging'\n   470→    );\n   471→    for (const supp of skinSupplements.slice(0, 3)) {\n   472→      recommendations.push(createSupplementRec(\n   473→        supp,\n   474→        'medium',\n   475→        50,\n   476→        ['skin_quality'],\n   477→        `${supp.name} supports skin health and anti-aging.`\n   478→      ));\n   479→    }\n   480→  }\n   481→\n   482→  if (hasHairIssues && gender === 'male') {\n   483→    const hairSupplements = SUPPLEMENTS.filter(s => s.category === 'hair');\n   484→    for (const supp of hairSupplements.slice(0, 3)) {\n   485→      recommendations.push(createSupplementRec(\n   486→        supp,\n   487→        'medium',\n   488→        45,\n   489→        ['hairline'],\n   490→        `${supp.name} supports hair health.`\n   491→      ));\n   492→    }\n   493→  }\n   494→\n   495→  // Always recommend foundational supplements\n   496→  const foundational = SUPPLEMENTS.filter(s =>\n   497→    ['vitamin_d3', 'omega_3', 'magnesium'].includes(s.id)\n   498→  );\n   499→  for (const supp of foundational) {\n   500→    if (!recommendations.some(r => r.treatment.id === supp.id)) {\n   501→      recommendations.push(createSupplementRec(\n   502→        supp,\n   503→        'low',\n   504→        30,\n   505→        ['general_health'],\n   506→        `${supp.name} supports overall health and wellbeing.`\n   507→      ));\n   508→    }\n   509→  }\n   510→\n   511→  return recommendations.slice(0, 10);\n   512→}\n   513→\n   514→/**\n   515→ * Generate order of operations for treatments\n   516→ */\n   517→function generateOrderOfOperations(\n   518→  recommendations: TreatmentRecommendation[]\n   519→): OrderOfOperation[] {\n   520→  const operations: OrderOfOperation[] = [];\n   521→\n   522→  // Define category order: lifestyle -> softmaxxing -> non-surgical -> minimally invasive -> surgical\n   523→  const categoryOrder: TreatmentCategory[] = [\n   524→    'lifestyle',\n   525→    'softmaxxing',\n   526→    'non_surgical',\n   527→    'minimally_invasive',\n   528→    'surgical',\n   529→  ];\n   530→\n   531→  // Group by category (only for valid treatment categories)\n   532→  const validCategories: TreatmentCategory[] = ['lifestyle', 'softmaxxing', 'non_surgical', 'minimally_invasive', 'surgical'];\n   533→  const byCategory = new Map<TreatmentCategory, TreatmentRecommendation[]>();\n   534→  for (const rec of recommendations) {\n   535→    const cat = rec.treatment.category as TreatmentCategory;\n   536→    if (validCategories.includes(cat)) {\n   537→      if (!byCategory.has(cat)) {\n   538→        byCategory.set(cat, []);\n   539→      }\n   540→      byCategory.get(cat)!.push(rec);\n   541→    }\n   542→  }\n   543→\n   544→  let step = 1;\n   545→  for (const category of categoryOrder) {\n   546→    const recs = byCategory.get(category) || [];\n   547→    // Sort by priority and relevance\n   548→    recs.sort((a, b) => {\n   549→      if (a.priority !== b.priority) {\n   550→        const priorityOrder = { high: 0, medium: 1, low: 2 };\n   551→        return priorityOrder[a.priority] - priorityOrder[b.priority];\n   552→      }\n   553→      return b.relevanceScore - a.relevanceScore;\n   554→    });\n   555→\n   556→    for (const rec of recs.slice(0, 3)) { // Max 3 per category\n   557→      const treatment = rec.treatment as Treatment | Surgery;\n   558→      const operation: OrderOfOperation = {\n   559→        step,\n   560→        category,\n   561→        treatment,\n   562→        reasoning: getStepReasoning(step, category),\n   563→      };\n   564→\n   565→      // Add prerequisites for surgical procedures\n   566→      if (category === 'surgical') {\n   567→        operation.prerequisites = ['Complete non-surgical options first', 'Consult with board-certified surgeon'];\n   568→        operation.waitTime = '6-12 months recovery between major procedures';\n   569→      }\n   570→\n   571→      operations.push(operation);\n   572→      step++;\n   573→    }\n   574→  }\n   575→\n   576→  return operations;\n   577→}\n   578→\n   579→/**\n   580→ * Generate reasoning for a step in order of operations\n   581→ */\n   582→function getStepReasoning(\n   583→  step: number,\n   584→  category: TreatmentCategory\n   585→): string {\n   586→  if (step === 1) {\n   587→    return 'Start with foundational changes before considering more invasive options.';\n   588→  }\n   589→\n   590→  if (category === 'lifestyle' || category === 'softmaxxing') {\n   591→    return 'Low-risk, reversible changes that can provide noticeable improvement.';\n   592→  }\n   593→\n   594→  if (category === 'non_surgical') {\n   595→    return 'Non-invasive treatments with minimal downtime to test results before committing to surgery.';\n   596→  }\n   597→\n   598→  if (category === 'minimally_invasive') {\n   599→    return 'Minimally invasive procedures can provide significant results with less risk than surgery.';\n   600→  }\n   601→\n   602→  if (category === 'surgical') {\n   603→    return 'Consider surgery only after exhausting less invasive options and with realistic expectations.';\n   604→  }\n   605→\n   606→  return '';\n   607→}\n   608→\n   609→// ============================================\n   610→// UTILITY FUNCTIONS\n   611→// ============================================\n   612→\n   613→/**\n   614→ * Get top priority recommendations across all categories\n   615→ */\n   616→export function getTopRecommendations(\n   617→  plan: RecommendationPlan,\n   618→  count: number = 5\n   619→): TreatmentRecommendation[] {\n   620→  const all = [\n   621→    ...plan.lifestyle,\n   622→    ...plan.softmaxxing,\n   623→    ...plan.nonSurgical,\n   624→    ...plan.minimallyInvasive,\n   625→    ...plan.surgical,\n   626→  ];\n   627→\n   628→  return all\n   629→    .sort((a, b) => b.relevanceScore - a.relevanceScore)\n   630→    .slice(0, count);\n   631→}\n   632→\n   633→/**\n   634→ * Get recommendations filtered by cost level\n   635→ */\n   636→export function getRecommendationsByCost(\n   637→  plan: RecommendationPlan,\n   638→  maxCost: 'free' | 'low' | 'medium' | 'high' | 'very_high'\n   639→): TreatmentRecommendation[] {\n   640→  const costOrder = ['free', 'low', 'medium', 'high', 'very_high'];\n   641→  const maxCostIndex = costOrder.indexOf(maxCost);\n   642→\n   643→  const all = [\n   644→    ...plan.lifestyle,\n   645→    ...plan.softmaxxing,\n   646→    ...plan.nonSurgical,\n   647→    ...plan.minimallyInvasive,\n   648→    ...plan.surgical,\n   649→  ];\n   650→\n   651→  return all.filter(r => {\n   652→    const treatment = r.treatment as Treatment;\n   653→    if ('costLevel' in treatment) {\n   654→      return costOrder.indexOf(treatment.costLevel) <= maxCostIndex;\n   655→    }\n   656→    return true;\n   657→  });\n   658→}\n   659→\n   660→/**\n   661→ * Get recommendations with minimal downtime\n   662→ */\n   663→export function getNoDowntimeRecommendations(\n   664→  plan: RecommendationPlan\n   665→): TreatmentRecommendation[] {\n   666→  const all = [\n   667→    ...plan.lifestyle,\n   668→    ...plan.softmaxxing,\n   669→    ...plan.nonSurgical,\n   670→    ...plan.minimallyInvasive,\n   671→  ];\n   672→\n   673→  return all.filter(r => {\n   674→    const treatment = r.treatment as Treatment;\n   675→    if ('downtime' in treatment) {\n   676→      const downtime = treatment.downtime.toLowerCase();\n   677→      return downtime.includes('none') || downtime.includes('minimal');\n   678→    }\n   679→    return true;\n   680→  });\n   681→}\n   682→\n   683→/**\n   684→ * Format cost for display\n   685→ */\n   686→export function formatCost(treatment: Treatment | Surgery): string {\n   687→  const { min, max, currency } = treatment.costRange;\n   688→  const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : currency;\n   689→\n   690→  if (min === max) {\n   691→    return `${symbol}${min.toLocaleString()}`;\n   692→  }\n   693→\n   694→  return `${symbol}${min.toLocaleString()} - ${symbol}${max.toLocaleString()}`;\n   695→}\n   696→\n   697→/**\n   698→ * Get summary statistics for a plan\n   699→ */\n   700→export function getPlanSummary(plan: RecommendationPlan): {\n   701→  totalRecommendations: number;\n   702→  highPriority: number;\n   703→  mediumPriority: number;\n   704→  lowPriority: number;\n   705→  categoryCounts: Record<string, number>;\n   706→  estimatedTotalImprovement: number;\n   707→} {\n   708→  const all = [\n   709→    ...plan.lifestyle,\n   710→    ...plan.softmaxxing,\n   711→    ...plan.nonSurgical,\n   712→    ...plan.minimallyInvasive,\n   713→    ...plan.surgical,\n   714→  ];\n   715→\n   716→  return {\n   717→    totalRecommendations: all.length,\n   718→    highPriority: all.filter(r => r.priority === 'high').length,\n   719→    mediumPriority: all.filter(r => r.priority === 'medium').length,\n   720→    lowPriority: all.filter(r => r.priority === 'low').length,\n   721→    categoryCounts: {\n   722→      lifestyle: plan.lifestyle.length,\n   723→      softmaxxing: plan.softmaxxing.length,\n   724→      nonSurgical: plan.nonSurgical.length,\n   725→      minimallyInvasive: plan.minimallyInvasive.length,\n   726→      surgical: plan.surgical.length,\n   727→      supplements: plan.supplements.length,\n   728→    },\n   729→    estimatedTotalImprovement: plan.potentialImprovement,\n   730→  };\n   731→}\n   732→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"54ad256a-f180-446c-acfe-fdf3198a1eca","timestamp":"2025-12-26T14:49:50.483Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","content":"/**\n * Recommendation Engine\n * Analyzes facial metrics and generates personalized treatment recommendations\n */\n\nimport {\n  Treatment,\n  Surgery,\n  Supplement,\n  TreatmentRecommendation,\n  MetricAnalysis,\n  RecommendationPlan,\n  OrderOfOperation,\n  TreatmentCategory,\n  Gender,\n  ProfileType,\n} from './types';\nimport { SOFTMAXXING_TREATMENTS } from './softmaxxing';\nimport { SURGICAL_TREATMENTS } from './hardmaxxing';\nimport { SUPPLEMENTS } from './supplements';\nimport { NON_SURGICAL_TREATMENTS } from './nonSurgical';\nimport {\n  classifyMetricValue,\n  calculateDeviation,\n  getIssueForMetric,\n  getTreatmentIdsForMetric,\n  getOverallSeverity,\n  harmonyToPSL,\n  estimatePotentialPSL,\n} from './severity';\n\n// ============================================\n// ALL TREATMENTS COMBINED\n// ============================================\n\nconst ALL_TREATMENTS: (Treatment | Surgery)[] = [\n  ...SOFTMAXXING_TREATMENTS,\n  ...NON_SURGICAL_TREATMENTS,\n  ...SURGICAL_TREATMENTS,\n];\n\n// ============================================\n// METRIC ANALYSIS\n// ============================================\n\nexport interface MetricInput {\n  metricId: string;\n  metricName: string;\n  currentValue: number;\n  idealValue: number;\n  idealRange: { min: number; max: number };\n  score: number;\n  profileType: ProfileType;\n}\n\n/**\n * Analyze a single metric and determine severity\n */\nexport function analyzeMetric(\n  input: MetricInput,\n  gender?: Gender\n): MetricAnalysis {\n  const { deviation, deviationPercent, direction } = calculateDeviation(\n    input.metricId,\n    input.currentValue\n  );\n\n  const severity = classifyMetricValue(input.metricId, input.currentValue, gender);\n  const issue = getIssueForMetric(input.metricId, direction);\n\n  return {\n    metricId: input.metricId,\n    metricName: input.metricName,\n    currentValue: input.currentValue,\n    idealValue: input.idealValue,\n    idealRange: input.idealRange,\n    deviation,\n    deviationPercent,\n    score: input.score,\n    severity,\n    issue: issue || undefined,\n    profileType: input.profileType,\n  };\n}\n\n/**\n * Analyze all metrics and sort by severity\n */\nexport function analyzeAllMetrics(\n  metrics: MetricInput[],\n  gender?: Gender\n): MetricAnalysis[] {\n  const analyses = metrics.map(m => analyzeMetric(m, gender));\n\n  // Sort by severity (severe first) then by score (lowest first)\n  const severityOrder = { severe: 0, moderate: 1, mild: 2, optimal: 3 };\n\n  return analyses.sort((a, b) => {\n    const severityDiff = severityOrder[a.severity.severity] - severityOrder[b.severity.severity];\n    if (severityDiff !== 0) return severityDiff;\n    return a.score - b.score;\n  });\n}\n\n// ============================================\n// TREATMENT MATCHING\n// ============================================\n\n/**\n * Find treatment by ID\n */\nexport function findTreatment(id: string): Treatment | Surgery | Supplement | undefined {\n  const treatment = ALL_TREATMENTS.find(t => t.id === id);\n  if (treatment) return treatment;\n\n  return SUPPLEMENTS.find(s => s.id === id);\n}\n\n/**\n * Find treatments that target a specific issue\n */\nexport function findTreatmentsForIssue(issue: string): (Treatment | Surgery)[] {\n  return ALL_TREATMENTS.filter(t =>\n    t.targetIssues.some(i =>\n      i.toLowerCase().includes(issue.toLowerCase()) ||\n      issue.toLowerCase().includes(i.toLowerCase())\n    )\n  );\n}\n\n/**\n * Find treatments that target a specific metric\n */\nexport function findTreatmentsForMetric(metricId: string): (Treatment | Surgery)[] {\n  return ALL_TREATMENTS.filter(t =>\n    t.targetMetrics.some(m =>\n      m.toLowerCase().includes(metricId.toLowerCase()) ||\n      metricId.toLowerCase().includes(m.toLowerCase())\n    )\n  );\n}\n\n/**\n * Score treatment relevance for a metric analysis\n */\nfunction scoreTreatmentRelevance(\n  treatment: Treatment | Surgery,\n  analysis: MetricAnalysis\n): number {\n  let score = 0;\n\n  // Check if treatment targets this metric\n  const targetsMetric = treatment.targetMetrics.some(m =>\n    m.toLowerCase().includes(analysis.metricId.toLowerCase())\n  );\n  if (targetsMetric) score += 30;\n\n  // Check if treatment addresses the issue\n  if (analysis.issue) {\n    const addressesIssue = treatment.targetIssues.some(i =>\n      i.toLowerCase().includes(analysis.issue!.toLowerCase()) ||\n      analysis.issue!.toLowerCase().includes(i.toLowerCase())\n    );\n    if (addressesIssue) score += 40;\n  }\n\n  // Factor in severity\n  const severityMultiplier = {\n    severe: 1.5,\n    moderate: 1.2,\n    mild: 1.0,\n    optimal: 0.3,\n  };\n  score *= severityMultiplier[analysis.severity.severity];\n\n  // Factor in treatment effectiveness\n  score += treatment.effectiveness * 2;\n\n  // Factor in PSL improvement potential\n  const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n  score += avgPSLImprovement * 10;\n\n  return Math.round(score);\n}\n\n/**\n * Generate treatment recommendations for a metric analysis\n */\nexport function getRecommendationsForMetric(\n  analysis: MetricAnalysis,\n  gender?: Gender,\n  maxRecommendations: number = 5\n): TreatmentRecommendation[] {\n  if (analysis.severity.severity === 'optimal') {\n    return []; // No treatment needed for optimal metrics\n  }\n\n  // Get treatment IDs from mapping\n  const { direction } = calculateDeviation(analysis.metricId, analysis.currentValue);\n  const treatmentIds = getTreatmentIdsForMetric(analysis.metricId, direction);\n\n  // Find matching treatments\n  let treatments: (Treatment | Surgery)[] = [];\n\n  // First, add treatments from the mapping\n  for (const id of treatmentIds) {\n    const treatment = findTreatment(id);\n    if (treatment && 'category' in treatment && treatment.category !== undefined) {\n      treatments.push(treatment as Treatment | Surgery);\n    }\n  }\n\n  // Then, find additional treatments that target this metric or issue\n  const additionalTreatments = [\n    ...findTreatmentsForMetric(analysis.metricId),\n    ...(analysis.issue ? findTreatmentsForIssue(analysis.issue) : []),\n  ];\n\n  // Remove duplicates\n  const seenIds = treatments.map(t => t.id);\n  for (const t of additionalTreatments) {\n    if (!seenIds.includes(t.id)) {\n      seenIds.push(t.id);\n      treatments.push(t);\n    }\n  }\n\n  // Filter by gender if specified\n  if (gender) {\n    treatments = treatments.filter(t =>\n      !t.genderSpecific || t.genderSpecific === gender\n    );\n  }\n\n  // Score and rank treatments\n  const scoredTreatments = treatments.map(treatment => ({\n    treatment,\n    relevanceScore: scoreTreatmentRelevance(treatment, analysis),\n  }));\n\n  // Sort by relevance score\n  scoredTreatments.sort((a, b) => b.relevanceScore - a.relevanceScore);\n\n  // Create recommendations\n  return scoredTreatments.slice(0, maxRecommendations).map(({ treatment, relevanceScore }) => {\n    const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n\n    return {\n      treatment,\n      priority: relevanceScore >= 60 ? 'high' as const :\n                relevanceScore >= 40 ? 'medium' as const :\n                'low' as const,\n      relevanceScore,\n      targetMetrics: [analysis.metricId],\n      estimatedImprovement: avgPSLImprovement,\n      reasoning: generateReasoning(treatment, analysis),\n    };\n  });\n}\n\n/**\n * Generate human-readable reasoning for a recommendation\n */\nfunction generateReasoning(\n  treatment: Treatment | Surgery,\n  analysis: MetricAnalysis\n): string {\n  const parts: string[] = [];\n\n  // Issue description\n  if (analysis.issue) {\n    parts.push(`Addresses ${analysis.issue.replace(/_/g, ' ')}`);\n  }\n\n  // Effectiveness\n  parts.push(`Effectiveness: ${treatment.effectiveness}/10`);\n\n  // PSL improvement\n  const pslRange = `${treatment.pslImprovement.min}-${treatment.pslImprovement.max}`;\n  parts.push(`Expected improvement: ${pslRange} PSL points`);\n\n  // Timeline\n  parts.push(`Results in: ${treatment.timelineToResults}`);\n\n  return parts.join('. ') + '.';\n}\n\n// ============================================\n// RECOMMENDATION PLAN GENERATION\n// ============================================\n\n/**\n * Generate a comprehensive recommendation plan\n */\nexport function generateRecommendationPlan(\n  metrics: MetricInput[],\n  overallScore: number,\n  harmonyPercent: number,\n  gender?: Gender\n): RecommendationPlan {\n  // Analyze all metrics\n  const metricAnalyses = analyzeAllMetrics(metrics, gender);\n\n  // Determine strengths and weaknesses\n  const strengths = metricAnalyses.filter(m =>\n    m.severity.severity === 'optimal' || m.score >= 85\n  );\n  const weaknesses = metricAnalyses.filter(m =>\n    m.severity.severity !== 'optimal' && m.score < 85\n  );\n\n  // Get recommendations for each weakness\n  const allRecommendations: TreatmentRecommendation[] = [];\n  for (const weakness of weaknesses) {\n    const recs = getRecommendationsForMetric(weakness, gender);\n    allRecommendations.push(...recs);\n  }\n\n  // Deduplicate recommendations (same treatment might help multiple metrics)\n  const uniqueRecommendations = deduplicateRecommendations(allRecommendations);\n\n  // Categorize recommendations\n  const lifestyle = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'lifestyle' || r.treatment.category === 'softmaxxing'\n  );\n  const softmaxxing = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'softmaxxing'\n  );\n  const nonSurgical = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'non_surgical'\n  );\n  const minimallyInvasive = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'minimally_invasive'\n  );\n  const surgical = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'surgical'\n  );\n\n  // Get supplement recommendations\n  const supplements = getSupplementRecommendations(weaknesses, gender);\n\n  // Calculate PSL ratings\n  const pslRating = harmonyToPSL(harmonyPercent);\n  const treatmentImprovements = uniqueRecommendations.map(r => r.estimatedImprovement);\n  const potentialPSL = estimatePotentialPSL(pslRating.psl, treatmentImprovements);\n\n  // Generate order of operations\n  const orderOfOperations = generateOrderOfOperations(uniqueRecommendations);\n\n  // Get overall severity\n  const overallSeverity = getOverallSeverity(metricAnalyses.map(m => m.severity.severity));\n\n  return {\n    overallScore,\n    overallSeverity,\n    harmonyScore: harmonyPercent,\n    percentile: pslRating.percentile,\n    metricAnalyses,\n    strengths,\n    weaknesses,\n    lifestyle,\n    softmaxxing,\n    nonSurgical,\n    minimallyInvasive,\n    surgical,\n    supplements,\n    currentPSL: pslRating.psl,\n    potentialPSL: potentialPSL.potentialPSL,\n    potentialImprovement: potentialPSL.totalImprovement,\n    orderOfOperations,\n  };\n}\n\n/**\n * Deduplicate recommendations, combining target metrics for same treatment\n */\nfunction deduplicateRecommendations(\n  recommendations: TreatmentRecommendation[]\n): TreatmentRecommendation[] {\n  const byId = new Map<string, TreatmentRecommendation>();\n\n  for (const rec of recommendations) {\n    const existing = byId.get(rec.treatment.id);\n    if (existing) {\n      // Combine target metrics (deduplicate using filter)\n      const combined = [...existing.targetMetrics, ...rec.targetMetrics];\n      existing.targetMetrics = combined.filter((m, i) => combined.indexOf(m) === i);\n\n      // Take higher relevance score\n      existing.relevanceScore = Math.max(existing.relevanceScore, rec.relevanceScore);\n\n      // Update priority based on new relevance\n      existing.priority = existing.relevanceScore >= 60 ? 'high' :\n                         existing.relevanceScore >= 40 ? 'medium' :\n                         'low';\n    } else {\n      byId.set(rec.treatment.id, { ...rec });\n    }\n  }\n\n  return Array.from(byId.values()).sort((a, b) => b.relevanceScore - a.relevanceScore);\n}\n\n/**\n * Get supplement recommendations based on weaknesses\n */\nfunction getSupplementRecommendations(\n  weaknesses: MetricAnalysis[],\n  gender?: Gender\n): TreatmentRecommendation[] {\n  const recommendations: TreatmentRecommendation[] = [];\n\n  // Map weakness types to supplement categories\n  const hasSkinIssues = weaknesses.some(w =>\n    w.issue?.includes('skin') || w.metricId.includes('skin')\n  );\n  const hasHairIssues = weaknesses.some(w =>\n    w.issue?.includes('hair') || w.metricId.includes('hairline')\n  );\n  const hasGeneralAging = weaknesses.some(w =>\n    w.issue?.includes('aging') || w.severity.severity === 'moderate' || w.severity.severity === 'severe'\n  );\n\n  // Helper to create supplement recommendation\n  const createSupplementRec = (\n    supp: Supplement,\n    priority: 'high' | 'medium' | 'low',\n    relevanceScore: number,\n    targetMetrics: string[],\n    reasoning: string\n  ): TreatmentRecommendation => ({\n    treatment: {\n      id: supp.id,\n      name: supp.name,\n      category: 'lifestyle',\n      description: supp.description,\n      howItWorks: `Dosage: ${supp.dosage} ${supp.frequency}`,\n      effectiveness: supp.effectiveness,\n      evidenceLevel: supp.evidenceLevel,\n      pslImprovement: { min: 0.05, max: 0.15 },\n      costLevel: supp.costPerMonth.max > 30 ? 'medium' : 'low',\n      costRange: { min: supp.costPerMonth.min, max: supp.costPerMonth.max, currency: 'USD' },\n      costFrequency: 'monthly',\n      timelineToResults: supp.timelineToResults,\n      resultsDuration: 'Ongoing with continued use',\n      maintenanceRequired: true,\n      maintenanceFrequency: supp.frequency,\n      recoveryTime: 'None',\n      downtime: 'None',\n      painLevel: 'none',\n      riskLevel: supp.riskLevel,\n      sideEffects: supp.sideEffects,\n      contraindications: supp.contraindications,\n      targetMetrics,\n      targetIssues: supp.targetBenefits,\n      notes: supp.notes,\n      sources: supp.sources,\n    },\n    priority,\n    relevanceScore,\n    targetMetrics,\n    estimatedImprovement: 0.1,\n    reasoning,\n  });\n\n  // Add relevant supplements\n  if (hasSkinIssues || hasGeneralAging) {\n    const skinSupplements = SUPPLEMENTS.filter(s =>\n      s.category === 'skin' || s.category === 'anti-aging'\n    );\n    for (const supp of skinSupplements.slice(0, 3)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'medium',\n        50,\n        ['skin_quality'],\n        `${supp.name} supports skin health and anti-aging.`\n      ));\n    }\n  }\n\n  if (hasHairIssues && gender === 'male') {\n    const hairSupplements = SUPPLEMENTS.filter(s => s.category === 'hair');\n    for (const supp of hairSupplements.slice(0, 3)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'medium',\n        45,\n        ['hairline'],\n        `${supp.name} supports hair health.`\n      ));\n    }\n  }\n\n  // Always recommend foundational supplements\n  const foundational = SUPPLEMENTS.filter(s =>\n    ['vitamin_d3', 'omega_3', 'magnesium'].includes(s.id)\n  );\n  for (const supp of foundational) {\n    if (!recommendations.some(r => r.treatment.id === supp.id)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'low',\n        30,\n        ['general_health'],\n        `${supp.name} supports overall health and wellbeing.`\n      ));\n    }\n  }\n\n  return recommendations.slice(0, 10);\n}\n\n/**\n * Generate order of operations for treatments\n */\nfunction generateOrderOfOperations(\n  recommendations: TreatmentRecommendation[]\n): OrderOfOperation[] {\n  const operations: OrderOfOperation[] = [];\n\n  // Define category order: lifestyle -> softmaxxing -> non-surgical -> minimally invasive -> surgical\n  const categoryOrder: TreatmentCategory[] = [\n    'lifestyle',\n    'softmaxxing',\n    'non_surgical',\n    'minimally_invasive',\n    'surgical',\n  ];\n\n  // Group by category (only for valid treatment categories)\n  const validCategories: TreatmentCategory[] = ['lifestyle', 'softmaxxing', 'non_surgical', 'minimally_invasive', 'surgical'];\n  const byCategory = new Map<TreatmentCategory, TreatmentRecommendation[]>();\n  for (const rec of recommendations) {\n    const cat = rec.treatment.category as TreatmentCategory;\n    if (validCategories.includes(cat)) {\n      if (!byCategory.has(cat)) {\n        byCategory.set(cat, []);\n      }\n      byCategory.get(cat)!.push(rec);\n    }\n  }\n\n  let step = 1;\n  for (const category of categoryOrder) {\n    const recs = byCategory.get(category) || [];\n    // Sort by priority and relevance\n    recs.sort((a, b) => {\n      if (a.priority !== b.priority) {\n        const priorityOrder = { high: 0, medium: 1, low: 2 };\n        return priorityOrder[a.priority] - priorityOrder[b.priority];\n      }\n      return b.relevanceScore - a.relevanceScore;\n    });\n\n    for (const rec of recs.slice(0, 3)) { // Max 3 per category\n      const treatment = rec.treatment as Treatment | Surgery;\n      const operation: OrderOfOperation = {\n        step,\n        category,\n        treatment,\n        reasoning: getStepReasoning(step, category),\n      };\n\n      // Add prerequisites for surgical procedures\n      if (category === 'surgical') {\n        operation.prerequisites = ['Complete non-surgical options first', 'Consult with board-certified surgeon'];\n        operation.waitTime = '6-12 months recovery between major procedures';\n      }\n\n      operations.push(operation);\n      step++;\n    }\n  }\n\n  return operations;\n}\n\n/**\n * Generate reasoning for a step in order of operations\n */\nfunction getStepReasoning(\n  step: number,\n  category: TreatmentCategory\n): string {\n  if (step === 1) {\n    return 'Start with foundational changes before considering more invasive options.';\n  }\n\n  if (category === 'lifestyle' || category === 'softmaxxing') {\n    return 'Low-risk, reversible changes that can provide noticeable improvement.';\n  }\n\n  if (category === 'non_surgical') {\n    return 'Non-invasive treatments with minimal downtime to test results before committing to surgery.';\n  }\n\n  if (category === 'minimally_invasive') {\n    return 'Minimally invasive procedures can provide significant results with less risk than surgery.';\n  }\n\n  if (category === 'surgical') {\n    return 'Consider surgery only after exhausting less invasive options and with realistic expectations.';\n  }\n\n  return '';\n}\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\n/**\n * Get top priority recommendations across all categories\n */\nexport function getTopRecommendations(\n  plan: RecommendationPlan,\n  count: number = 5\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all\n    .sort((a, b) => b.relevanceScore - a.relevanceScore)\n    .slice(0, count);\n}\n\n/**\n * Get recommendations filtered by cost level\n */\nexport function getRecommendationsByCost(\n  plan: RecommendationPlan,\n  maxCost: 'free' | 'low' | 'medium' | 'high' | 'very_high'\n): TreatmentRecommendation[] {\n  const costOrder = ['free', 'low', 'medium', 'high', 'very_high'];\n  const maxCostIndex = costOrder.indexOf(maxCost);\n\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('costLevel' in treatment) {\n      return costOrder.indexOf(treatment.costLevel) <= maxCostIndex;\n    }\n    return true;\n  });\n}\n\n/**\n * Get recommendations with minimal downtime\n */\nexport function getNoDowntimeRecommendations(\n  plan: RecommendationPlan\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('downtime' in treatment) {\n      const downtime = treatment.downtime.toLowerCase();\n      return downtime.includes('none') || downtime.includes('minimal');\n    }\n    return true;\n  });\n}\n\n/**\n * Format cost for display\n */\nexport function formatCost(treatment: Treatment | Surgery): string {\n  const { min, max, currency } = treatment.costRange;\n  const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : currency;\n\n  if (min === max) {\n    return `${symbol}${min.toLocaleString()}`;\n  }\n\n  return `${symbol}${min.toLocaleString()} - ${symbol}${max.toLocaleString()}`;\n}\n\n/**\n * Get summary statistics for a plan\n */\nexport function getPlanSummary(plan: RecommendationPlan): {\n  totalRecommendations: number;\n  highPriority: number;\n  mediumPriority: number;\n  lowPriority: number;\n  categoryCounts: Record<string, number>;\n  estimatedTotalImprovement: number;\n} {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return {\n    totalRecommendations: all.length,\n    highPriority: all.filter(r => r.priority === 'high').length,\n    mediumPriority: all.filter(r => r.priority === 'medium').length,\n    lowPriority: all.filter(r => r.priority === 'low').length,\n    categoryCounts: {\n      lifestyle: plan.lifestyle.length,\n      softmaxxing: plan.softmaxxing.length,\n      nonSurgical: plan.nonSurgical.length,\n      minimallyInvasive: plan.minimallyInvasive.length,\n      surgical: plan.surgical.length,\n      supplements: plan.supplements.length,\n    },\n    estimatedTotalImprovement: plan.potentialImprovement,\n  };\n}\n","numLines":732,"startLine":1,"totalLines":732}}}
{"parentUuid":"54ad256a-f180-446c-acfe-fdf3198a1eca","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E61KrMwmBcCeePWnJhCXwT","type":"tool_result","content":"     1→/**\n     2→ * Advice Engine - Client-side implementation matching the Python AdviceEngine\n     3→ * Processes plans.json trigger rules against user metrics\n     4→ */\n     5→\n     6→import { Plan } from '@/components/results/cards/PlanActionCard';\n     7→\n     8→// ============================================\n     9→// TYPES\n    10→// ============================================\n    11→\n    12→interface Threshold {\n    13→  operator: '<' | '>';\n    14→  value: number;\n    15→}\n    16→\n    17→interface TriggerRules {\n    18→  metrics: string[];\n    19→  condition: 'OR' | 'AND';\n    20→  thresholds: Record<string, Threshold>;\n    21→}\n    22→\n    23→// Harmony-style effectiveness rating\n    24→interface Effectiveness {\n    25→  level: 'high' | 'medium' | 'low';\n    26→  score: number;  // 1-5\n    27→  confidence: number;  // 0-1\n    28→}\n    29→\n    30→// How a treatment impacts a specific ratio\n    31→interface RatioImpact {\n    32→  direction: 'increase' | 'decrease';\n    33→  percentage: number;  // Expected % change\n    34→}\n    35→\n    36→interface PlanContent {\n    37→  description: string;\n    38→  cost_min: number;\n    39→  cost_max: number;\n    40→  time_min?: string;\n    41→  time_max?: string;\n    42→  risks?: string;\n    43→  citations?: string[];\n    44→  tags?: string[];\n    45→  // Treatment metadata fields\n    46→  priority_score?: number;  // 1-5, higher = more important\n    47→  effectiveness?: Effectiveness;\n    48→  ratios_impacted?: Record<string, RatioImpact>;\n    49→  pillars?: string[];  // e.g., ['angularity', 'harmony', 'symmetry']\n    50→}\n    51→\n    52→interface RawPlan {\n    53→  id: string;\n    54→  title: string;\n    55→  trigger_rules: TriggerRules;\n    56→  content: PlanContent;\n    57→}\n    58→\n    59→interface TriggerResult {\n    60→  metric: string;\n    61→  value: number;\n    62→  threshold: number;\n    63→  operator: '<' | '>';\n    64→}\n    65→\n    66→// ============================================\n    67→// PLANS DATA (from plans.json)\n    68→// ============================================\n    69→\n    70→export const PLANS: RawPlan[] = [\n    71→  {\n    72→    id: \"jaw_fillers\",\n    73→    title: \"Jaw Fillers\",\n    74→    trigger_rules: {\n    75→      metrics: [\"Gonial Angle\", \"Bigonial Width\", \"Ramus to Mandible Ratio\"],\n    76→      condition: \"OR\",\n    77→      thresholds: {\n    78→        \"Gonial Angle\": { operator: \">\", value: 128.0 },\n    79→        \"Bigonial Width\": { operator: \"<\", value: 90.0 },\n    80→        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.5 }\n    81→      }\n    82→    },\n    83→    content: {\n    84→      description: \"Injectable dermal fillers (hyaluronic acid or hydroxyapatite) to enhance jawline definition, gonial angle sharpness, and mandibular border projection. Common products: Radiesse, Sculptra, Juvederm Voluma. Targets masseter hollow, prejowl sulcus, and mandibular angle.\",\n    85→      cost_min: 600,\n    86→      cost_max: 2500,\n    87→      time_min: \"6 months\",\n    88→      time_max: \"18 months\",\n    89→      risks: \"Vascular occlusion, asymmetry, swelling.\",\n    90→      citations: [\"Al-Khafaji et al., 2023\"],\n    91→      tags: [\"Minimally Invasive\"],\n    92→      priority_score: 4,\n    93→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n    94→      ratios_impacted: {\n    95→        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 },\n    96→        \"Bigonial Width\": { direction: \"increase\", percentage: 4 },\n    97→        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 2 }\n    98→      },\n    99→      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n   100→    }\n   101→  },\n   102→  {\n   103→    id: \"cheekbone_fillers\",\n   104→    title: \"Cheekbone Fillers\",\n   105→    trigger_rules: {\n   106→      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n   107→      condition: \"OR\",\n   108→      thresholds: {\n   109→        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n   110→        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.75 }\n   111→      }\n   112→    },\n   113→    content: {\n   114→      description: \"Malar augmentation via hyaluronic acid fillers placed at the zygomatic arch and submalar region. Products: Juvederm Voluma, Restylane Lyft. Enhances ogee curve, anterior cheek projection, and lateral zygomatic width for improved facial angularity.\",\n   115→      cost_min: 650,\n   116→      cost_max: 2500,\n   117→      time_min: \"6 months\",\n   118→      time_max: \"18 months\",\n   119→      risks: \"Asymmetry, filler migration.\",\n   120→      citations: [\"Trinh & Gupta, 2021\"],\n   121→      tags: [\"Minimally Invasive\"],\n   122→      priority_score: 4,\n   123→      effectiveness: { level: 'high', score: 5, confidence: 0.85 },\n   124→      ratios_impacted: {\n   125→        \"Cheekbone Height\": { direction: \"increase\", percentage: 4 },\n   126→        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 2 },\n   127→        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 }\n   128→      },\n   129→      pillars: [\"angularity\", \"harmony\", \"youthfulness\"]\n   130→    }\n   131→  },\n   132→  {\n   133→    id: \"beard_growth\",\n   134→    title: \"Beard / Stubble Growth\",\n   135→    trigger_rules: {\n   136→      metrics: [\"Chin to Philtrum Ratio\", \"Gonial Angle\"],\n   137→      condition: \"OR\",\n   138→      thresholds: {\n   139→        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.8 },\n   140→        \"Gonial Angle\": { operator: \">\", value: 126.0 }\n   141→      }\n   142→    },\n   143→    content: {\n   144→      description: \"Strategic facial hair growth (5-10mm stubble or full beard) to optically enhance jawline definition, camouflage gonial angle softness, and create visual chin projection. Consider minoxidil 5% foam if low coverage. Trim to maintain sharp mandibular border.\",\n   145→      cost_min: 0,\n   146→      cost_max: 20,\n   147→      time_min: \"1 month\",\n   148→      time_max: \"3 months\",\n   149→      risks: \"None\",\n   150→      citations: [\"Dixson et al., 2016\"],\n   151→      tags: [\"Foundational\", \"Free\"],\n   152→      priority_score: 2,\n   153→      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n   154→      ratios_impacted: {\n   155→        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 5 },\n   156→        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 }\n   157→      },\n   158→      pillars: [\"masculinity\", \"camouflage\"]\n   159→    }\n   160→  },\n   161→  {\n   162→    id: \"lip_filler\",\n   163→    title: \"Lip Filler\",\n   164→    trigger_rules: {\n   165→      metrics: [\"Lower Lip to Upper Lip Ratio\"],\n   166→      condition: \"OR\",\n   167→      thresholds: {\n   168→        \"Lower Lip to Upper Lip Ratio\": { operator: \"<\", value: 1.0 }\n   169→      }\n   170→    },\n   171→    content: {\n   172→      description: \"Lip augmentation via hyaluronic acid fillers (Restylane, Juvederm) to enhance vermillion border, cupid's bow definition, and lip ratio balance. Can target vermillion height, philtral columns, or tubercles. Alternative: surgical lip lift (bullhorn or corner lift) for permanent results.\",\n   173→      cost_min: 500,\n   174→      cost_max: 1200,\n   175→      time_min: \"6 months\",\n   176→      time_max: \"12 months\",\n   177→      risks: \"Migration, bruising.\",\n   178→      citations: [\"Hernandez et al., 2023\"],\n   179→      tags: [\"Minimally Invasive\"],\n   180→      priority_score: 3,\n   181→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n   182→      ratios_impacted: {\n   183→        \"Lower Lip to Upper Lip Ratio\": { direction: \"increase\", percentage: 15 }\n   184→      },\n   185→      pillars: [\"harmony\", \"femininity\", \"youthfulness\"]\n   186→    }\n   187→  },\n   188→  {\n   189→    id: \"weight_loss_protocol\",\n   190→    title: \"Fat Loss Protocol (High Protein + Cardio)\",\n   191→    trigger_rules: {\n   192→      metrics: [\"Cheekbone Height\", \"Jaw Slope\"],\n   193→      condition: \"OR\",\n   194→      thresholds: {\n   195→        \"Cheekbone Height\": { operator: \"<\", value: 65.0 },\n   196→        \"Jaw Slope\": { operator: \">\", value: 140.0 }\n   197→      }\n   198→    },\n   199→    content: {\n   200→      description: \"Caloric deficit protocol targeting 8-12% body fat to debloat buccal fat pads and reveal zygomatic, mandibular, and maxillary bone structure. High-protein intake (1.6-2.2g/kg), fasted cardio, and sodium/water management. Consider buccal fat removal surgery if structure remains obscured at low body fat.\",\n   201→      cost_min: 200,\n   202→      cost_max: 1000,\n   203→      time_min: \"3 months\",\n   204→      time_max: \"12 months\",\n   205→      risks: \"None\",\n   206→      citations: [\"Moon & Koh, 2020\"],\n   207→      tags: [\"Foundational\"],\n   208→      priority_score: 5,\n   209→      effectiveness: { level: 'high', score: 4, confidence: 0.90 },\n   210→      ratios_impacted: {\n   211→        \"Cheekbone Height\": { direction: \"increase\", percentage: 8 },\n   212→        \"Jaw Slope\": { direction: \"decrease\", percentage: 5 },\n   213→        \"Bigonial Width\": { direction: \"increase\", percentage: 3 }\n   214→      },\n   215→      pillars: [\"angularity\", \"bone_structure\", \"definition\"]\n   216→    }\n   217→  },\n   218→  {\n   219→    id: \"mewing_posture\",\n   220→    title: \"Mewing & Posture Correction\",\n   221→    trigger_rules: {\n   222→      metrics: [\"Midface Ratio\", \"Nasolabial Angle\"],\n   223→      condition: \"OR\",\n   224→      thresholds: {\n   225→        \"Midface Ratio\": { operator: \">\", value: 1.05 },\n   226→        \"Nasolabial Angle\": { operator: \"<\", value: 90.0 }\n   227→      }\n   228→    },\n   229→    content: {\n   230→      description: \"Orthotropic tongue posture: entire tongue (posterior third critical) pressed against palate, teeth in light contact, nasal breathing. Aims to stimulate maxillary protraction, improve mandibular posture, and enhance gonial angle over time. Combine with proper head/neck alignment and chin tucks.\",\n   231→      cost_min: 0,\n   232→      cost_max: 0,\n   233→      time_min: \"12 months\",\n   234→      time_max: \"Lifetime\",\n   235→      risks: \"None if performed correctly.\",\n   236→      citations: [\"Mew J. et al., 2014\"],\n   237→      tags: [\"Foundational\", \"Free\"],\n   238→      priority_score: 3,\n   239→      effectiveness: { level: 'low', score: 2, confidence: 0.50 },\n   240→      ratios_impacted: {\n   241→        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 },\n   242→        \"Nasolabial Angle\": { direction: \"increase\", percentage: 3 },\n   243→        \"Gonial Angle\": { direction: \"decrease\", percentage: 2 }\n   244→      },\n   245→      pillars: [\"bone_structure\", \"posture\", \"long_term\"]\n   246→    }\n   247→  },\n   248→  {\n   249→    id: \"rhinoplasty\",\n   250→    title: \"Rhinoplasty\",\n   251→    trigger_rules: {\n   252→      metrics: [\"Nasal Projection\", \"Nasal W to H Ratio\", \"Nasolabial Angle\"],\n   253→      condition: \"OR\",\n   254→      thresholds: {\n   255→        \"Nasal Projection\": { operator: \">\", value: 0.75 },\n   256→        \"Nasal W to H Ratio\": { operator: \">\", value: 0.85 },\n   257→        \"Nasolabial Angle\": { operator: \"<\", value: 85.0 }\n   258→      }\n   259→    },\n   260→    content: {\n   261→      description: \"Comprehensive nasal surgery: dorsal hump reduction, osteotomies for width correction, tip plasty for bulbous refinement, alarplasty for alar base narrowing, cephalic trim for tip rotation, septoplasty for deviation. Can address nasal index, nasolabial angle, nasofrontal angle, and tip projection.\",\n   262→      cost_min: 5000,\n   263→      cost_max: 15000,\n   264→      time_min: \"6 months\",\n   265→      time_max: \"12 months\",\n   266→      risks: \"Infection, asymmetry, breathing issues, revision surgery.\",\n   267→      citations: [\"Rohrich RJ et al., 2010\", \"Foda HM, 2008\"],\n   268→      tags: [\"Surgical\"],\n   269→      priority_score: 5,\n   270→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n   271→      ratios_impacted: {\n   272→        \"Nasal Projection\": { direction: \"decrease\", percentage: 10 },\n   273→        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 8 },\n   274→        \"Nasolabial Angle\": { direction: \"increase\", percentage: 12 },\n   275→        \"Nasal Index\": { direction: \"decrease\", percentage: 6 }\n   276→      },\n   277→      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n   278→    }\n   279→  },\n   280→  {\n   281→    id: \"genioplasty\",\n   282→    title: \"Sliding Genioplasty (Chin Surgery)\",\n   283→    trigger_rules: {\n   284→      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\"],\n   285→      condition: \"OR\",\n   286→      thresholds: {\n   287→        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.5 },\n   288→        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 15.0 }\n   289→      }\n   290→    },\n   291→    content: {\n   292→      description: \"Osseous genioplasty: horizontal advancement or setback of the chin via osteotomy and titanium plate fixation. Can also adjust vertical height (reduction/augmentation) and transverse width. Alternative: alloplastic chin implant (silicone/Medpor) for pure augmentation. Improves chin-philtrum ratio and profile convexity.\",\n   293→      cost_min: 4000,\n   294→      cost_max: 12000,\n   295→      time_min: \"3 months\",\n   296→      time_max: \"12 months\",\n   297→      risks: \"Numbness, infection, asymmetry.\",\n   298→      citations: [\"Park JH et al., 2018\"],\n   299→      tags: [\"Surgical\"],\n   300→      priority_score: 5,\n   301→      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n   302→      ratios_impacted: {\n   303→        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 20 },\n   304→        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 15 },\n   305→        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 5 }\n   306→      },\n   307→      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n   308→    }\n   309→  },\n   310→  {\n   311→    id: \"canthoplasty\",\n   312→    title: \"Canthoplasty (Eye Corner Surgery)\",\n   313→    trigger_rules: {\n   314→      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n   315→      condition: \"AND\",\n   316→      thresholds: {\n   317→        \"Lateral Canthal Tilt\": { operator: \"<\", value: 4.0 },\n   318→        \"Eye Aspect Ratio\": { operator: \"<\", value: 2.8 }\n   319→      }\n   320→    },\n   321→    content: {\n   322→      description: \"Lateral canthoplasty or canthopexy: surgical elevation and fixation of the lateral canthal tendon to increase positive canthal tilt angle. Techniques include tarsal strip, lateral canthal suspension, or almond eye surgery. Can be combined with lower blepharoplasty. Addresses negative canthal tilt and downturned eye appearance.\",\n   323→      cost_min: 3000,\n   324→      cost_max: 8000,\n   325→      time_min: \"2 months\",\n   326→      time_max: \"6 months\",\n   327→      risks: \"Scarring, asymmetry, dry eyes.\",\n   328→      citations: [\"Rhee SC et al., 2017\", \"Chen WP, 2016\"],\n   329→      tags: [\"Surgical\"],\n   330→      priority_score: 4,\n   331→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n   332→      ratios_impacted: {\n   333→        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 40 },\n   334→        \"Eye Aspect Ratio\": { direction: \"increase\", percentage: 10 }\n   335→      },\n   336→      pillars: [\"youthfulness\", \"alertness\", \"femininity\"]\n   337→    }\n   338→  },\n   339→  {\n   340→    id: \"brow_lift\",\n   341→    title: \"Brow Lift / Browridge Enhancement\",\n   342→    trigger_rules: {\n   343→      metrics: [\"Eyebrow Low Setedness\", \"Browridge Inclination Angle\"],\n   344→      condition: \"OR\",\n   345→      thresholds: {\n   346→        \"Eyebrow Low Setedness\": { operator: \">\", value: 2.0 },\n   347→        \"Browridge Inclination Angle\": { operator: \"<\", value: 10.0 }\n   348→      }\n   349→    },\n   350→    content: {\n   351→      description: \"Brow elevation via endoscopic browlift, temporal lift, or direct browplasty to reduce hooding and increase eyebrow height. For browridge: supraorbital rim augmentation with PMMA, hydroxyapatite paste, or custom implants. Botox for brow arch shaping. Addresses low-set brows and flat browridge inclination.\",\n   352→      cost_min: 1500,\n   353→      cost_max: 10000,\n   354→      time_min: \"1 month\",\n   355→      time_max: \"6 months\",\n   356→      risks: \"Asymmetry, numbness, unnatural appearance.\",\n   357→      citations: [\"Mendelson B et al., 2015\"],\n   358→      tags: [\"Surgical\", \"Minimally Invasive\"],\n   359→      priority_score: 3,\n   360→      effectiveness: { level: 'medium', score: 4, confidence: 0.75 },\n   361→      ratios_impacted: {\n   362→        \"Eyebrow Low Setedness\": { direction: \"decrease\", percentage: 30 },\n   363→        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 20 }\n   364→      },\n   365→      pillars: [\"youthfulness\", \"masculinity\", \"upper_third\"]\n   366→    }\n   367→  },\n   368→  // ============================================\n   369→  // ADDITIONAL PROCEDURES\n   370→  // ============================================\n   371→  {\n   372→    id: \"kybella\",\n   373→    title: \"Kybella (Double Chin Removal)\",\n   374→    trigger_rules: {\n   375→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   376→      condition: \"OR\",\n   377→      thresholds: {\n   378→        \"Submental Cervical Angle\": { operator: \">\", value: 130.0 },\n   379→        \"Neck Width\": { operator: \">\", value: 95.0 }\n   380→      }\n   381→    },\n   382→    content: {\n   383→      description: \"Injectable deoxycholic acid (Kybella/ATX-101) to permanently dissolve submental fat. Multiple sessions required (2-6 treatments, 4-6 weeks apart). Destroys fat cell membranes, eliminating double chin without surgery. FDA-approved for moderate-to-severe submental fullness.\",\n   384→      cost_min: 1200,\n   385→      cost_max: 3000,\n   386→      time_min: \"2 months\",\n   387→      time_max: \"6 months\",\n   388→      risks: \"Swelling, bruising, numbness, pain, nerve injury causing asymmetric smile, asymmetry, difficulty swallowing.\",\n   389→      citations: [\"Jones DH et al., 2016\", \"Ascher B et al., 2017\"],\n   390→      tags: [\"Minimally Invasive\"],\n   391→      priority_score: 3,\n   392→      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n   393→      ratios_impacted: {\n   394→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n   395→        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n   396→      },\n   397→      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n   398→    }\n   399→  },\n   400→  {\n   401→    id: \"cryolipolysis\",\n   402→    title: \"Cryolipolysis (Fat Freezing)\",\n   403→    trigger_rules: {\n   404→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   405→      condition: \"OR\",\n   406→      thresholds: {\n   407→        \"Submental Cervical Angle\": { operator: \">\", value: 125.0 },\n   408→        \"Neck Width\": { operator: \">\", value: 90.0 }\n   409→      }\n   410→    },\n   411→    content: {\n   412→      description: \"Non-invasive fat reduction via controlled cooling (CoolSculpting). Targets stubborn subcutaneous fat without surgery by crystallizing fat cells which are then naturally eliminated. FDA-cleared for submental area, flanks, abdomen. Results visible in 2-4 months.\",\n   413→      cost_min: 750,\n   414→      cost_max: 2500,\n   415→      time_min: \"2 months\",\n   416→      time_max: \"4 months\",\n   417→      risks: \"Temporary erythema/swelling, bruising, numbness/paresthesia, pain, paradoxical adipose hyperplasia (rare), frostbite, hyperpigmentation.\",\n   418→      citations: [\"Ingargiola MJ et al., 2015\", \"Kilmer SL et al., 2017\"],\n   419→      tags: [\"Minimally Invasive\"],\n   420→      priority_score: 2,\n   421→      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n   422→      ratios_impacted: {\n   423→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 12 },\n   424→        \"Neck Width\": { direction: \"decrease\", percentage: 8 }\n   425→      },\n   426→      pillars: [\"definition\", \"non_invasive\", \"neck\"]\n   427→    }\n   428→  },\n   429→  {\n   430→    id: \"chin_implant\",\n   431→    title: \"Chin Implant (Mentoplasty)\",\n   432→    trigger_rules: {\n   433→      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\", \"Facial Convexity\"],\n   434→      condition: \"OR\",\n   435→      thresholds: {\n   436→        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.6 },\n   437→        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 12.0 },\n   438→        \"Facial Convexity\": { operator: \"<\", value: 165.0 }\n   439→      }\n   440→    },\n   441→    content: {\n   442→      description: \"Alloplastic chin augmentation using silicone or Medpor implants placed through submental or intraoral incision. Provides permanent chin projection and width enhancement. Alternative to sliding genioplasty for pure augmentation without bone cutting. Custom implants available for precise contouring.\",\n   443→      cost_min: 3000,\n   444→      cost_max: 8000,\n   445→      time_min: \"2 weeks\",\n   446→      time_max: \"3 months\",\n   447→      risks: \"Infection, implant migration, bone erosion, asymmetry, numbness, capsular contracture, implant extrusion.\",\n   448→      citations: [\"Yaremchuk MJ, 2013\", \"Binder WJ et al., 2008\"],\n   449→      tags: [\"Surgical\"],\n   450→      priority_score: 4,\n   451→      effectiveness: { level: 'high', score: 4, confidence: 0.88 },\n   452→      ratios_impacted: {\n   453→        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 18 },\n   454→        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 12 },\n   455→        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 4 }\n   456→      },\n   457→      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n   458→    }\n   459→  },\n   460→  {\n   461→    id: \"buccal_fat_removal\",\n   462→    title: \"Buccal Fat Removal (Bichectomy)\",\n   463→    trigger_rules: {\n   464→      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n   465→      condition: \"AND\",\n   466→      thresholds: {\n   467→        \"Cheekbone Height\": { operator: \"<\", value: 70.0 },\n   468→        \"Face Width to Height Ratio\": { operator: \">\", value: 1.55 }\n   469→      }\n   470→    },\n   471→    content: {\n   472→      description: \"Surgical excision of buccal fat pads through intraoral incision to slim the lower cheeks and enhance facial angularity. Creates more defined cheekbone-to-jaw contour. Best for patients with naturally round faces at low body fat. Results are permanent and irreversible.\",\n   473→      cost_min: 2500,\n   474→      cost_max: 6000,\n   475→      time_min: \"2 weeks\",\n   476→      time_max: \"6 months\",\n   477→      risks: \"Facial nerve damage, asymmetry, over-resection causing gaunt appearance, infection, hematoma, parotid duct injury.\",\n   478→      citations: [\"Tarallo M et al., 2018\", \"Moura LB et al., 2018\"],\n   479→      tags: [\"Surgical\"],\n   480→      priority_score: 3,\n   481→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n   482→      ratios_impacted: {\n   483→        \"Cheekbone Height\": { direction: \"increase\", percentage: 6 },\n   484→        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 3 }\n   485→      },\n   486→      pillars: [\"angularity\", \"definition\", \"bone_structure\"]\n   487→    }\n   488→  },\n   489→  {\n   490→    id: \"alarplasty\",\n   491→    title: \"Alarplasty (Alar Base Reduction)\",\n   492→    trigger_rules: {\n   493→      metrics: [\"Nasal W to H Ratio\", \"Alar Base Width\"],\n   494→      condition: \"OR\",\n   495→      thresholds: {\n   496→        \"Nasal W to H Ratio\": { operator: \">\", value: 0.80 },\n   497→        \"Alar Base Width\": { operator: \">\", value: 35.0 }\n   498→      }\n   499→    },\n   500→    content: {\n   501→      description: \"Surgical narrowing of the nasal alar base through wedge excision. Reduces nostril width and alar flare. Can be performed alone or combined with rhinoplasty. Weir excision for nostril sill, alar wedge for flaring. Hidden incision placement minimizes visible scarring.\",\n   502→      cost_min: 2000,\n   503→      cost_max: 5000,\n   504→      time_min: \"2 weeks\",\n   505→      time_max: \"3 months\",\n   506→      risks: \"Visible scarring, asymmetry, over-narrowing, nostril distortion, poor wound healing.\",\n   507→      citations: [\"Rohrich RJ et al., 2009\", \"Ingels K et al., 2015\"],\n   508→      tags: [\"Surgical\"],\n   509→      priority_score: 3,\n   510→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n   511→      ratios_impacted: {\n   512→        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 12 },\n   513→        \"Nasal Index\": { direction: \"decrease\", percentage: 8 }\n   514→      },\n   515→      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n   516→    }\n   517→  },\n   518→  {\n   519→    id: \"canthopexy\",\n   520→    title: \"Canthopexy (Lateral Canthal Suspension)\",\n   521→    trigger_rules: {\n   522→      metrics: [\"Lateral Canthal Tilt\", \"Lower Eyelid Position\"],\n   523→      condition: \"OR\",\n   524→      thresholds: {\n   525→        \"Lateral Canthal Tilt\": { operator: \"<\", value: 3.0 },\n   526→        \"Lower Eyelid Position\": { operator: \">\", value: 1.5 }\n   527→      }\n   528→    },\n   529→    content: {\n   530→      description: \"Suture suspension of the lateral canthal tendon to tighten lower eyelid and prevent sagging. Less invasive than canthoplasty (no tendon cutting). Supports eye shape, prevents scleral show, and can provide subtle upward tilt. Often combined with blepharoplasty.\",\n   531→      cost_min: 2500,\n   532→      cost_max: 6000,\n   533→      time_min: \"2 weeks\",\n   534→      time_max: \"3 months\",\n   535→      risks: \"Asymmetry, under/overcorrection, dry eyes, ectropion, scarring, temporary swelling.\",\n   536→      citations: [\"Hester TR et al., 2000\", \"Codner MA et al., 2008\"],\n   537→      tags: [\"Surgical\"],\n   538→      priority_score: 3,\n   539→      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n   540→      ratios_impacted: {\n   541→        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 20 }\n   542→      },\n   543→      pillars: [\"youthfulness\", \"alertness\", \"eye_area\"]\n   544→    }\n   545→  },\n   546→  {\n   547→    id: \"neck_lift\",\n   548→    title: \"Neck Lift (Platysmaplasty)\",\n   549→    trigger_rules: {\n   550→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   551→      condition: \"OR\",\n   552→      thresholds: {\n   553→        \"Submental Cervical Angle\": { operator: \">\", value: 135.0 },\n   554→        \"Neck Width\": { operator: \">\", value: 100.0 }\n   555→      }\n   556→    },\n   557→    content: {\n   558→      description: \"Comprehensive neck rejuvenation: platysma muscle tightening (platysmaplasty), submental liposuction, excess skin removal, and possible digastric muscle reduction. Addresses turkey neck, platysmal banding, submental fullness, and skin laxity. Can include submental tuck or deep plane techniques.\",\n   559→      cost_min: 5000,\n   560→      cost_max: 15000,\n   561→      time_min: \"3 weeks\",\n   562→      time_max: \"6 months\",\n   563→      risks: \"Hematoma, nerve injury, skin necrosis, asymmetry, visible scarring, skin irregularities, prolonged swelling.\",\n   564→      citations: [\"Feldman JJ, 2006\", \"Ellenbogen R et al., 2014\"],\n   565→      tags: [\"Surgical\"],\n   566→      priority_score: 4,\n   567→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n   568→      ratios_impacted: {\n   569→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 25 },\n   570→        \"Neck Width\": { direction: \"decrease\", percentage: 15 }\n   571→      },\n   572→      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n   573→    }\n   574→  },\n   575→  {\n   576→    id: \"septoplasty\",\n   577→    title: \"Septoplasty (Deviated Septum Correction)\",\n   578→    trigger_rules: {\n   579→      metrics: [\"Nasal Deviation\", \"Nasal Symmetry\"],\n   580→      condition: \"OR\",\n   581→      thresholds: {\n   582→        \"Nasal Deviation\": { operator: \">\", value: 5.0 },\n   583→        \"Nasal Symmetry\": { operator: \"<\", value: 0.90 }\n   584→      }\n   585→    },\n   586→    content: {\n   587→      description: \"Surgical correction of deviated nasal septum to improve nasal airflow and symmetry. Performed through closed endonasal approach. Can be functional (breathing) or cosmetic (straightening). Often combined with rhinoplasty (septorhinoplasty) for comprehensive nasal reshaping.\",\n   588→      cost_min: 3000,\n   589→      cost_max: 10000,\n   590→      time_min: \"1 week\",\n   591→      time_max: \"3 months\",\n   592→      risks: \"Septal perforation, persistent deviation, saddle nose, numbness, infection, bleeding, CSF leak (rare).\",\n   593→      citations: [\"Rohrich RJ et al., 2011\", \"Fettman N et al., 2009\"],\n   594→      tags: [\"Surgical\"],\n   595→      priority_score: 2,\n   596→      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n   597→      ratios_impacted: {\n   598→        \"Nasal Deviation\": { direction: \"decrease\", percentage: 80 },\n   599→        \"Nasal Symmetry\": { direction: \"increase\", percentage: 10 }\n   600→      },\n   601→      pillars: [\"symmetry\", \"function\", \"breathing\"]\n   602→    }\n   603→  },\n   604→  {\n   605→    id: \"lip_lift\",\n   606→    title: \"Lip Lift (Bullhorn/Subnasal Lip Lift)\",\n   607→    trigger_rules: {\n   608→      metrics: [\"Philtrum Length\", \"Upper Lip Vermilion Height\", \"Midface Ratio\"],\n   609→      condition: \"OR\",\n   610→      thresholds: {\n   611→        \"Philtrum Length\": { operator: \">\", value: 15.0 },\n   612→        \"Upper Lip Vermilion Height\": { operator: \"<\", value: 7.0 },\n   613→        \"Midface Ratio\": { operator: \">\", value: 1.1 }\n   614→      }\n   615→    },\n   616→    content: {\n   617→      description: \"Surgical shortening of the philtrum by removing skin at the base of the nose (bullhorn excision). Permanently increases upper lip vermilion show and reduces long upper lip appearance. Alternative to filler for long philtrum correction. Scar hidden in nasal base crease.\",\n   618→      cost_min: 3500,\n   619→      cost_max: 8000,\n   620→      time_min: \"2 weeks\",\n   621→      time_max: \"6 months\",\n   622→      risks: \"Visible scarring, asymmetry, over-shortening, distorted nostril base, wound dehiscence, prolonged swelling.\",\n   623→      citations: [\"Austin HW, 1986\", \"Santanché P et al., 2014\"],\n   624→      tags: [\"Surgical\"],\n   625→      priority_score: 4,\n   626→      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n   627→      ratios_impacted: {\n   628→        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 25 },\n   629→        \"Midface Ratio\": { direction: \"decrease\", percentage: 8 }\n   630→      },\n   631→      pillars: [\"youthfulness\", \"harmony\", \"lip_area\"]\n   632→    }\n   633→  },\n   634→  {\n   635→    id: \"jaw_implants\",\n   636→    title: \"Jaw Implants (Mandibular Augmentation)\",\n   637→    trigger_rules: {\n   638→      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Ramus to Mandible Ratio\"],\n   639→      condition: \"OR\",\n   640→      thresholds: {\n   641→        \"Bigonial Width\": { operator: \"<\", value: 85.0 },\n   642→        \"Gonial Angle\": { operator: \">\", value: 130.0 },\n   643→        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.45 }\n   644→      }\n   645→    },\n   646→    content: {\n   647→      description: \"Alloplastic mandibular augmentation using silicone, Medpor, or custom PEEK implants. Enhances jaw width (bigonial), gonial angle definition, and mandibular border projection. Placed through intraoral incision. Custom wraparound implants available for comprehensive jaw enhancement.\",\n   648→      cost_min: 6000,\n   649→      cost_max: 20000,\n   650→      time_min: \"3 weeks\",\n   651→      time_max: \"6 months\",\n   652→      risks: \"Infection, implant migration, bone erosion, asymmetry, mental nerve injury, capsular contracture, masseter atrophy.\",\n   653→      citations: [\"Yaremchuk MJ, 2006\", \"Rao LK et al., 2011\"],\n   654→      tags: [\"Surgical\"],\n   655→      priority_score: 5,\n   656→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n   657→      ratios_impacted: {\n   658→        \"Bigonial Width\": { direction: \"increase\", percentage: 12 },\n   659→        \"Gonial Angle\": { direction: \"decrease\", percentage: 8 },\n   660→        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 6 }\n   661→      },\n   662→      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n   663→    }\n   664→  },\n   665→  {\n   666→    id: \"midface_implants\",\n   667→    title: \"Midface Implants (Malar/Submalar)\",\n   668→    trigger_rules: {\n   669→      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Face Width to Height Ratio\"],\n   670→      condition: \"OR\",\n   671→      thresholds: {\n   672→        \"Cheekbone Height\": { operator: \"<\", value: 55.0 },\n   673→        \"Midface Ratio\": { operator: \">\", value: 1.15 },\n   674→        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.65 }\n   675→      }\n   676→    },\n   677→    content: {\n   678→      description: \"Alloplastic augmentation of the malar (cheekbone) and/or submalar region using silicone or Medpor implants. Enhances midface projection, cheekbone prominence, and overall facial width. Custom implants available. Alternative to fat grafting for permanent midface volume.\",\n   679→      cost_min: 5000,\n   680→      cost_max: 15000,\n   681→      time_min: \"3 weeks\",\n   682→      time_max: \"6 months\",\n   683→      risks: \"Infection, implant migration, asymmetry, nerve injury (infraorbital), bone erosion, capsular contracture, visibility.\",\n   684→      citations: [\"Terino EO, 2000\", \"Binder WJ et al., 2007\"],\n   685→      tags: [\"Surgical\"],\n   686→      priority_score: 4,\n   687→      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n   688→      ratios_impacted: {\n   689→        \"Cheekbone Height\": { direction: \"increase\", percentage: 10 },\n   690→        \"Midface Ratio\": { direction: \"decrease\", percentage: 6 },\n   691→        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 4 }\n   692→      },\n   693→      pillars: [\"angularity\", \"harmony\", \"bone_structure\"]\n   694→    }\n   695→  },\n   696→  {\n   697→    id: \"submental_liposuction\",\n   698→    title: \"Submental Liposuction\",\n   699→    trigger_rules: {\n   700→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   701→      condition: \"AND\",\n   702→      thresholds: {\n   703→        \"Submental Cervical Angle\": { operator: \">\", value: 120.0 },\n   704→        \"Neck Width\": { operator: \">\", value: 85.0 }\n   705→      }\n   706→    },\n   707→    content: {\n   708→      description: \"Surgical removal of excess fat beneath the chin via small cannula through submental incision. Refines jawline contour and improves neck definition. Can be combined with skin tightening or platysmaplasty. Best for younger patients with good skin elasticity.\",\n   709→      cost_min: 2000,\n   710→      cost_max: 5000,\n   711→      time_min: \"1 week\",\n   712→      time_max: \"3 months\",\n   713→      risks: \"Contour irregularities, asymmetry, nerve injury, skin laxity, hematoma, seroma, prolonged swelling.\",\n   714→      citations: [\"Rohrich RJ et al., 2007\", \"Giampapa VC et al., 2000\"],\n   715→      tags: [\"Surgical\"],\n   716→      priority_score: 3,\n   717→      effectiveness: { level: 'medium', score: 4, confidence: 0.82 },\n   718→      ratios_impacted: {\n   719→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n   720→        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n   721→      },\n   722→      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n   723→    }\n   724→  },\n   725→  {\n   726→    id: \"submentoplasty\",\n   727→    title: \"Submentoplasty (Submental Tuck)\",\n   728→    trigger_rules: {\n   729→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   730→      condition: \"OR\",\n   731→      thresholds: {\n   732→        \"Submental Cervical Angle\": { operator: \">\", value: 140.0 },\n   733→        \"Neck Width\": { operator: \">\", value: 105.0 }\n   734→      }\n   735→    },\n   736→    content: {\n   737→      description: \"Direct excision of submental skin/fat with platysma muscle plication through small chin incision. Tightens central neck muscles and removes excess tissue. More aggressive than liposuction alone, less extensive than full neck lift. Also called cervicoplasty.\",\n   738→      cost_min: 3500,\n   739→      cost_max: 8000,\n   740→      time_min: \"2 weeks\",\n   741→      time_max: \"4 months\",\n   742→      risks: \"Visible scarring, hematoma, nerve injury, skin necrosis, asymmetry, contour irregularities.\",\n   743→      citations: [\"Giampapa VC et al., 2000\", \"Ellenbogen R et al., 2014\"],\n   744→      tags: [\"Surgical\"],\n   745→      priority_score: 4,\n   746→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n   747→      ratios_impacted: {\n   748→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 20 },\n   749→        \"Neck Width\": { direction: \"decrease\", percentage: 12 }\n   750→      },\n   751→      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n   752→    }\n   753→  },\n   754→  {\n   755→    id: \"fat_grafting\",\n   756→    title: \"Fat Grafting (Facial Lipofilling)\",\n   757→    trigger_rules: {\n   758→      metrics: [\"Cheekbone Height\", \"Under-Eye Hollowness\", \"Temple Volume\"],\n   759→      condition: \"OR\",\n   760→      thresholds: {\n   761→        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n   762→        \"Under-Eye Hollowness\": { operator: \">\", value: 3.0 },\n   763→        \"Temple Volume\": { operator: \"<\", value: 0.8 }\n   764→      }\n   765→    },\n   766→    content: {\n   767→      description: \"Autologous fat transfer: fat harvested from body (abdomen, thighs), processed, and injected for facial volumization. Microfat for volume (cheeks, temples, jawline), nanofat for skin rejuvenation. Natural permanent filler with 40-60% long-term retention. Multiple sessions may be needed.\",\n   768→      cost_min: 4000,\n   769→      cost_max: 12000,\n   770→      time_min: \"1 month\",\n   771→      time_max: \"6 months\",\n   772→      risks: \"Fat resorption, asymmetry, lumpiness, oil cysts, infection, embolism (rare), over/under-correction.\",\n   773→      citations: [\"Coleman SR, 2006\", \"Khouri RK et al., 2014\"],\n   774→      tags: [\"Surgical\"],\n   775→      priority_score: 3,\n   776→      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n   777→      ratios_impacted: {\n   778→        \"Cheekbone Height\": { direction: \"increase\", percentage: 5 },\n   779→        \"Tear Trough Depth\": { direction: \"decrease\", percentage: 40 }\n   780→      },\n   781→      pillars: [\"youthfulness\", \"volume\", \"natural\"]\n   782→    }\n   783→  },\n   784→  {\n   785→    id: \"supraorbital_implants\",\n   786→    title: \"Supraorbital Rim Implants (Browridge)\",\n   787→    trigger_rules: {\n   788→      metrics: [\"Browridge Inclination Angle\", \"Supraorbital Projection\"],\n   789→      condition: \"OR\",\n   790→      thresholds: {\n   791→        \"Browridge Inclination Angle\": { operator: \"<\", value: 8.0 },\n   792→        \"Supraorbital Projection\": { operator: \"<\", value: 0.85 }\n   793→      }\n   794→    },\n   795→    content: {\n   796→      description: \"Custom or standard implants placed along the supraorbital rim to enhance browridge projection and definition. Creates more prominent brow bone for masculine appearance. Often custom-designed from CT scans. Placed through coronal or endoscopic approach.\",\n   797→      cost_min: 8000,\n   798→      cost_max: 25000,\n   799→      time_min: \"3 weeks\",\n   800→      time_max: \"6 months\",\n   801→      risks: \"Infection, implant migration, asymmetry, nerve injury, frontal sinus violation, visible/palpable implant, bone erosion.\",\n   802→      citations: [\"Yaremchuk MJ, 2003\", \"Spiegel JH, 2011\"],\n   803→      tags: [\"Surgical\"],\n   804→      priority_score: 3,\n   805→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n   806→      ratios_impacted: {\n   807→        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 30 }\n   808→      },\n   809→      pillars: [\"masculinity\", \"bone_structure\", \"upper_third\"]\n   810→    }\n   811→  },\n   812→  {\n   813→    id: \"lip_reduction\",\n   814→    title: \"Lip Reduction Surgery (Reduction Cheiloplasty)\",\n   815→    trigger_rules: {\n   816→      metrics: [\"Lip Thickness\", \"Lower Lip to Upper Lip Ratio\"],\n   817→      condition: \"OR\",\n   818→      thresholds: {\n   819→        \"Lip Thickness\": { operator: \">\", value: 18.0 },\n   820→        \"Lower Lip to Upper Lip Ratio\": { operator: \">\", value: 2.2 }\n   821→      }\n   822→    },\n   823→    content: {\n   824→      description: \"Surgical removal of excess lip tissue through incision along wet-dry border to reduce lip volume and projection. Improves proportion between lips and surrounding features. Separate procedures for upper and lower lips. Permanent alternative to reversible fillers.\",\n   825→      cost_min: 2500,\n   826→      cost_max: 6000,\n   827→      time_min: \"2 weeks\",\n   828→      time_max: \"3 months\",\n   829→      risks: \"Visible scarring, asymmetry, over-reduction, numbness, altered sensation, wound dehiscence.\",\n   830→      citations: [\"Fanous N, 2007\", \"Garcia RM et al., 2016\"],\n   831→      tags: [\"Surgical\"],\n   832→      priority_score: 2,\n   833→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n   834→      ratios_impacted: {\n   835→        \"Lower Lip to Upper Lip Ratio\": { direction: \"decrease\", percentage: 20 }\n   836→      },\n   837→      pillars: [\"harmony\", \"balance\", \"lip_area\"]\n   838→    }\n   839→  },\n   840→  {\n   841→    id: \"jaw_reduction\",\n   842→    title: \"Jaw Reduction Surgery (V-Line Surgery)\",\n   843→    trigger_rules: {\n   844→      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Face Width to Height Ratio\"],\n   845→      condition: \"AND\",\n   846→      thresholds: {\n   847→        \"Bigonial Width\": { operator: \">\", value: 120.0 },\n   848→        \"Gonial Angle\": { operator: \"<\", value: 115.0 },\n   849→        \"Face Width to Height Ratio\": { operator: \">\", value: 1.65 }\n   850→      }\n   851→    },\n   852→    content: {\n   853→      description: \"Mandibular angle resection and contouring to slim and feminize the lower face, creating V-line effect. Osteotomy of mandibular angle, possible chin tapering (T-osteotomy), and masseter reduction. Popular in East Asian aesthetic surgery. Performed through intraoral approach.\",\n   854→      cost_min: 8000,\n   855→      cost_max: 25000,\n   856→      time_min: \"1 month\",\n   857→      time_max: \"6 months\",\n   858→      risks: \"Facial nerve injury, asymmetry, over-reduction, bone necrosis, infection, prolonged swelling, numbness.\",\n   859→      citations: [\"Yang DB et al., 2014\", \"Jin H et al., 2013\"],\n   860→      tags: [\"Surgical\"],\n   861→      priority_score: 4,\n   862→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n   863→      ratios_impacted: {\n   864→        \"Bigonial Width\": { direction: \"decrease\", percentage: 15 },\n   865→        \"Gonial Angle\": { direction: \"increase\", percentage: 10 },\n   866→        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 8 }\n   867→      },\n   868→      pillars: [\"femininity\", \"harmony\", \"bone_structure\"]\n   869→    }\n   870→  },\n   871→  {\n   872→    id: \"bimaxillary_osteotomy\",\n   873→    title: \"Bimaxillary Osteotomy (Double Jaw Surgery)\",\n   874→    trigger_rules: {\n   875→      metrics: [\"Facial Convexity\", \"Recession Relative to Frankfort Plane\", \"Midface Ratio\"],\n   876→      condition: \"AND\",\n   877→      thresholds: {\n   878→        \"Facial Convexity\": { operator: \"<\", value: 160.0 },\n   879→        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 18.0 },\n   880→        \"Midface Ratio\": { operator: \">\", value: 1.2 }\n   881→      }\n   882→    },\n   883→    content: {\n   884→      description: \"Simultaneous repositioning of both maxilla (Le Fort I) and mandible (BSSO) to correct facial disharmony and skeletal malocclusion. Addresses severe class II/III relationships, facial asymmetry, and vertical excess. Requires orthodontic preparation. Most comprehensive facial skeletal surgery.\",\n   885→      cost_min: 20000,\n   886→      cost_max: 60000,\n   887→      time_min: \"3 months\",\n   888→      time_max: \"12 months\",\n   889→      risks: \"Nerve injury, infection, relapse, TMJ dysfunction, malocclusion, bleeding, airway compromise, need for revision.\",\n   890→      citations: [\"Proffit WR et al., 2013\", \"Wolford LM et al., 2003\"],\n   891→      tags: [\"Surgical\"],\n   892→      priority_score: 5,\n   893→      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n   894→      ratios_impacted: {\n   895→        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 15 },\n   896→        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 20 },\n   897→        \"Midface Ratio\": { direction: \"decrease\", percentage: 10 }\n   898→      },\n   899→      pillars: [\"profile\", \"bone_structure\", \"comprehensive\"]\n   900→    }\n   901→  }\n   902→];\n   903→\n   904→// ============================================\n   905→// ADVICE ENGINE CLASS\n   906→// ============================================\n   907→\n   908→export class AdviceEngine {\n   909→  private plans: RawPlan[];\n   910→\n   911→  constructor(customPlans?: RawPlan[]) {\n   912→    this.plans = customPlans || PLANS;\n   913→  }\n   914→\n   915→  /**\n   916→   * Check if a single threshold condition is met\n   917→   */\n   918→  private checkThreshold(userValue: number, operator: '<' | '>', thresholdValue: number): boolean {\n   919→    if (operator === '<') {\n   920→      return userValue < thresholdValue;\n   921→    }\n   922→    return userValue > thresholdValue;\n   923→  }\n   924→\n   925→  /**\n   926→   * Evaluate trigger rules against user metrics\n   927→   */\n   928→  private evaluateTriggerRules(\n   929→    triggerRules: TriggerRules,\n   930→    metricsDict: Record<string, number>\n   931→  ): { isTriggered: boolean; triggeredMetrics: TriggerResult[] } {\n   932→    const { metrics, thresholds, condition } = triggerRules;\n   933→    const triggeredMetrics: TriggerResult[] = [];\n   934→    const results: boolean[] = [];\n   935→\n   936→    for (const metricName of metrics) {\n   937→      if (!(metricName in metricsDict)) continue;\n   938→      if (!(metricName in thresholds)) continue;\n   939→\n   940→      const userValue = metricsDict[metricName];\n   941→      const { operator, value: thresholdValue } = thresholds[metricName];\n   942→      const isMet = this.checkThreshold(userValue, operator, thresholdValue);\n   943→\n   944→      if (isMet) {\n   945→        triggeredMetrics.push({\n   946→          metric: metricName,\n   947→          value: userValue,\n   948→          threshold: thresholdValue,\n   949→          operator\n   950→        });\n   951→      }\n   952→\n   953→      results.push(isMet);\n   954→    }\n   955→\n   956→    const isTriggered = condition === 'AND'\n   957→      ? results.length > 0 && results.every(r => r)\n   958→      : results.some(r => r);\n   959→\n   960→    return { isTriggered, triggeredMetrics };\n   961→  }\n   962→\n   963→  /**\n   964→   * Get all recommendations that match the user's metrics\n   965→   *\n   966→   * @param metricsDict - Raw metric values\n   967→   * @param severityDict - Severity classifications (ideal/good/moderate/severe) for each metric\n   968→   *                       If a metric is 'ideal', it will NOT trigger remediation plans\n   969→   */\n   970→  getRecommendations(\n   971→    metricsDict: Record<string, number>,\n   972→    severityDict?: Record<string, string>\n   973→  ): Plan[] {\n   974→    const recommendations: Plan[] = [];\n   975→\n   976→    for (const rawPlan of this.plans) {\n   977→      const { isTriggered, triggeredMetrics } = this.evaluateTriggerRules(\n   978→        rawPlan.trigger_rules,\n   979→        metricsDict\n   980→      );\n   981→\n   982→      // If severity data is provided, filter out metrics that are already ideal\n   983→      if (isTriggered && severityDict) {\n   984→        // Check if ALL triggered metrics are outside ideal range\n   985→        const hasActualFlaw = triggeredMetrics.some(tm => {\n   986→          const severity = severityDict[tm.metric];\n   987→          // Only trigger if severity is NOT ideal (i.e., it's good/moderate/severe)\n   988→          return severity && severity !== 'ideal';\n   989→        });\n   990→\n   991→        // Skip this plan if all triggered metrics are already ideal\n   992→        if (!hasActualFlaw) {\n   993→          continue;\n   994→        }\n   995→      }\n   996→\n   997→      if (isTriggered) {\n   998→        recommendations.push({\n   999→          id: rawPlan.id,\n  1000→          title: rawPlan.title,\n  1001→          content: {\n  1002→            description: rawPlan.content.description,\n  1003→            cost_min: rawPlan.content.cost_min,\n  1004→            cost_max: rawPlan.content.cost_max,\n  1005→            time_min: rawPlan.content.time_min || 'Unknown',\n  1006→            time_max: rawPlan.content.time_max || 'Unknown',\n  1007→            risks: rawPlan.content.risks || 'Consult a professional.',\n  1008→            citations: rawPlan.content.citations || [],\n  1009→            tags: rawPlan.content.tags\n  1010→          },\n  1011→          trigger_reason: triggeredMetrics\n  1012→        });\n  1013→      }\n  1014→    }\n  1015→\n  1016→    return recommendations;\n  1017→  }\n  1018→\n  1019→  /**\n  1020→   * Get recommendations sorted by cost (cheapest first)\n  1021→   */\n  1022→  getRecommendationsByCost(\n  1023→    metricsDict: Record<string, number>,\n  1024→    severityDict?: Record<string, string>\n  1025→  ): Plan[] {\n  1026→    return this.getRecommendations(metricsDict, severityDict).sort(\n  1027→      (a, b) => a.content.cost_min - b.content.cost_min\n  1028→    );\n  1029→  }\n  1030→\n  1031→  /**\n  1032→   * Get recommendations grouped by phase/tag\n  1033→   */\n  1034→  getRecommendationsByPhase(\n  1035→    metricsDict: Record<string, number>,\n  1036→    severityDict?: Record<string, string>\n  1037→  ): Record<string, Plan[]> {\n  1038→    const recommendations = this.getRecommendations(metricsDict, severityDict);\n  1039→    const grouped: Record<string, Plan[]> = {\n  1040→      'Foundational': [],\n  1041→      'Minimally Invasive': [],\n  1042→      'Surgical': []\n  1043→    };\n  1044→\n  1045→    for (const rec of recommendations) {\n  1046→      const tags = rec.content.tags || [];\n  1047→      if (tags.includes('Foundational')) {\n  1048→        grouped['Foundational'].push(rec);\n  1049→      } else if (tags.includes('Surgical')) {\n  1050→        grouped['Surgical'].push(rec);\n  1051→      } else if (tags.includes('Minimally Invasive')) {\n  1052→        grouped['Minimally Invasive'].push(rec);\n  1053→      } else {\n  1054→        grouped['Minimally Invasive'].push(rec); // Default\n  1055→      }\n  1056→    }\n  1057→\n  1058→    return grouped;\n  1059→  }\n  1060→}\n  1061→\n  1062→// ============================================\n  1063→// SINGLETON INSTANCE\n  1064→// ============================================\n  1065→\n  1066→export const adviceEngine = new AdviceEngine();\n  1067→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fcc6a7b4-44ce-4c5b-8e15-7f9b66e8a816","timestamp":"2025-12-26T14:49:50.605Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts","content":"/**\n * Advice Engine - Client-side implementation matching the Python AdviceEngine\n * Processes plans.json trigger rules against user metrics\n */\n\nimport { Plan } from '@/components/results/cards/PlanActionCard';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface Threshold {\n  operator: '<' | '>';\n  value: number;\n}\n\ninterface TriggerRules {\n  metrics: string[];\n  condition: 'OR' | 'AND';\n  thresholds: Record<string, Threshold>;\n}\n\n// Harmony-style effectiveness rating\ninterface Effectiveness {\n  level: 'high' | 'medium' | 'low';\n  score: number;  // 1-5\n  confidence: number;  // 0-1\n}\n\n// How a treatment impacts a specific ratio\ninterface RatioImpact {\n  direction: 'increase' | 'decrease';\n  percentage: number;  // Expected % change\n}\n\ninterface PlanContent {\n  description: string;\n  cost_min: number;\n  cost_max: number;\n  time_min?: string;\n  time_max?: string;\n  risks?: string;\n  citations?: string[];\n  tags?: string[];\n  // Treatment metadata fields\n  priority_score?: number;  // 1-5, higher = more important\n  effectiveness?: Effectiveness;\n  ratios_impacted?: Record<string, RatioImpact>;\n  pillars?: string[];  // e.g., ['angularity', 'harmony', 'symmetry']\n}\n\ninterface RawPlan {\n  id: string;\n  title: string;\n  trigger_rules: TriggerRules;\n  content: PlanContent;\n}\n\ninterface TriggerResult {\n  metric: string;\n  value: number;\n  threshold: number;\n  operator: '<' | '>';\n}\n\n// ============================================\n// PLANS DATA (from plans.json)\n// ============================================\n\nexport const PLANS: RawPlan[] = [\n  {\n    id: \"jaw_fillers\",\n    title: \"Jaw Fillers\",\n    trigger_rules: {\n      metrics: [\"Gonial Angle\", \"Bigonial Width\", \"Ramus to Mandible Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Gonial Angle\": { operator: \">\", value: 128.0 },\n        \"Bigonial Width\": { operator: \"<\", value: 90.0 },\n        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.5 }\n      }\n    },\n    content: {\n      description: \"Injectable dermal fillers (hyaluronic acid or hydroxyapatite) to enhance jawline definition, gonial angle sharpness, and mandibular border projection. Common products: Radiesse, Sculptra, Juvederm Voluma. Targets masseter hollow, prejowl sulcus, and mandibular angle.\",\n      cost_min: 600,\n      cost_max: 2500,\n      time_min: \"6 months\",\n      time_max: \"18 months\",\n      risks: \"Vascular occlusion, asymmetry, swelling.\",\n      citations: [\"Al-Khafaji et al., 2023\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 },\n        \"Bigonial Width\": { direction: \"increase\", percentage: 4 },\n        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 2 }\n      },\n      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"cheekbone_fillers\",\n    title: \"Cheekbone Fillers\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.75 }\n      }\n    },\n    content: {\n      description: \"Malar augmentation via hyaluronic acid fillers placed at the zygomatic arch and submalar region. Products: Juvederm Voluma, Restylane Lyft. Enhances ogee curve, anterior cheek projection, and lateral zygomatic width for improved facial angularity.\",\n      cost_min: 650,\n      cost_max: 2500,\n      time_min: \"6 months\",\n      time_max: \"18 months\",\n      risks: \"Asymmetry, filler migration.\",\n      citations: [\"Trinh & Gupta, 2021\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.85 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 4 },\n        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 2 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 }\n      },\n      pillars: [\"angularity\", \"harmony\", \"youthfulness\"]\n    }\n  },\n  {\n    id: \"beard_growth\",\n    title: \"Beard / Stubble Growth\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Gonial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.8 },\n        \"Gonial Angle\": { operator: \">\", value: 126.0 }\n      }\n    },\n    content: {\n      description: \"Strategic facial hair growth (5-10mm stubble or full beard) to optically enhance jawline definition, camouflage gonial angle softness, and create visual chin projection. Consider minoxidil 5% foam if low coverage. Trim to maintain sharp mandibular border.\",\n      cost_min: 0,\n      cost_max: 20,\n      time_min: \"1 month\",\n      time_max: \"3 months\",\n      risks: \"None\",\n      citations: [\"Dixson et al., 2016\"],\n      tags: [\"Foundational\", \"Free\"],\n      priority_score: 2,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 5 },\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 }\n      },\n      pillars: [\"masculinity\", \"camouflage\"]\n    }\n  },\n  {\n    id: \"lip_filler\",\n    title: \"Lip Filler\",\n    trigger_rules: {\n      metrics: [\"Lower Lip to Upper Lip Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lower Lip to Upper Lip Ratio\": { operator: \"<\", value: 1.0 }\n      }\n    },\n    content: {\n      description: \"Lip augmentation via hyaluronic acid fillers (Restylane, Juvederm) to enhance vermillion border, cupid's bow definition, and lip ratio balance. Can target vermillion height, philtral columns, or tubercles. Alternative: surgical lip lift (bullhorn or corner lift) for permanent results.\",\n      cost_min: 500,\n      cost_max: 1200,\n      time_min: \"6 months\",\n      time_max: \"12 months\",\n      risks: \"Migration, bruising.\",\n      citations: [\"Hernandez et al., 2023\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Lower Lip to Upper Lip Ratio\": { direction: \"increase\", percentage: 15 }\n      },\n      pillars: [\"harmony\", \"femininity\", \"youthfulness\"]\n    }\n  },\n  {\n    id: \"weight_loss_protocol\",\n    title: \"Fat Loss Protocol (High Protein + Cardio)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Jaw Slope\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 65.0 },\n        \"Jaw Slope\": { operator: \">\", value: 140.0 }\n      }\n    },\n    content: {\n      description: \"Caloric deficit protocol targeting 8-12% body fat to debloat buccal fat pads and reveal zygomatic, mandibular, and maxillary bone structure. High-protein intake (1.6-2.2g/kg), fasted cardio, and sodium/water management. Consider buccal fat removal surgery if structure remains obscured at low body fat.\",\n      cost_min: 200,\n      cost_max: 1000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"None\",\n      citations: [\"Moon & Koh, 2020\"],\n      tags: [\"Foundational\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 4, confidence: 0.90 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 8 },\n        \"Jaw Slope\": { direction: \"decrease\", percentage: 5 },\n        \"Bigonial Width\": { direction: \"increase\", percentage: 3 }\n      },\n      pillars: [\"angularity\", \"bone_structure\", \"definition\"]\n    }\n  },\n  {\n    id: \"mewing_posture\",\n    title: \"Mewing & Posture Correction\",\n    trigger_rules: {\n      metrics: [\"Midface Ratio\", \"Nasolabial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Midface Ratio\": { operator: \">\", value: 1.05 },\n        \"Nasolabial Angle\": { operator: \"<\", value: 90.0 }\n      }\n    },\n    content: {\n      description: \"Orthotropic tongue posture: entire tongue (posterior third critical) pressed against palate, teeth in light contact, nasal breathing. Aims to stimulate maxillary protraction, improve mandibular posture, and enhance gonial angle over time. Combine with proper head/neck alignment and chin tucks.\",\n      cost_min: 0,\n      cost_max: 0,\n      time_min: \"12 months\",\n      time_max: \"Lifetime\",\n      risks: \"None if performed correctly.\",\n      citations: [\"Mew J. et al., 2014\"],\n      tags: [\"Foundational\", \"Free\"],\n      priority_score: 3,\n      effectiveness: { level: 'low', score: 2, confidence: 0.50 },\n      ratios_impacted: {\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 },\n        \"Nasolabial Angle\": { direction: \"increase\", percentage: 3 },\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 2 }\n      },\n      pillars: [\"bone_structure\", \"posture\", \"long_term\"]\n    }\n  },\n  {\n    id: \"rhinoplasty\",\n    title: \"Rhinoplasty\",\n    trigger_rules: {\n      metrics: [\"Nasal Projection\", \"Nasal W to H Ratio\", \"Nasolabial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal Projection\": { operator: \">\", value: 0.75 },\n        \"Nasal W to H Ratio\": { operator: \">\", value: 0.85 },\n        \"Nasolabial Angle\": { operator: \"<\", value: 85.0 }\n      }\n    },\n    content: {\n      description: \"Comprehensive nasal surgery: dorsal hump reduction, osteotomies for width correction, tip plasty for bulbous refinement, alarplasty for alar base narrowing, cephalic trim for tip rotation, septoplasty for deviation. Can address nasal index, nasolabial angle, nasofrontal angle, and tip projection.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"6 months\",\n      time_max: \"12 months\",\n      risks: \"Infection, asymmetry, breathing issues, revision surgery.\",\n      citations: [\"Rohrich RJ et al., 2010\", \"Foda HM, 2008\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Nasal Projection\": { direction: \"decrease\", percentage: 10 },\n        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 8 },\n        \"Nasolabial Angle\": { direction: \"increase\", percentage: 12 },\n        \"Nasal Index\": { direction: \"decrease\", percentage: 6 }\n      },\n      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n    }\n  },\n  {\n    id: \"genioplasty\",\n    title: \"Sliding Genioplasty (Chin Surgery)\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.5 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 15.0 }\n      }\n    },\n    content: {\n      description: \"Osseous genioplasty: horizontal advancement or setback of the chin via osteotomy and titanium plate fixation. Can also adjust vertical height (reduction/augmentation) and transverse width. Alternative: alloplastic chin implant (silicone/Medpor) for pure augmentation. Improves chin-philtrum ratio and profile convexity.\",\n      cost_min: 4000,\n      cost_max: 12000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"Numbness, infection, asymmetry.\",\n      citations: [\"Park JH et al., 2018\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 20 },\n        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 15 },\n        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 5 }\n      },\n      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"canthoplasty\",\n    title: \"Canthoplasty (Eye Corner Surgery)\",\n    trigger_rules: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Lateral Canthal Tilt\": { operator: \"<\", value: 4.0 },\n        \"Eye Aspect Ratio\": { operator: \"<\", value: 2.8 }\n      }\n    },\n    content: {\n      description: \"Lateral canthoplasty or canthopexy: surgical elevation and fixation of the lateral canthal tendon to increase positive canthal tilt angle. Techniques include tarsal strip, lateral canthal suspension, or almond eye surgery. Can be combined with lower blepharoplasty. Addresses negative canthal tilt and downturned eye appearance.\",\n      cost_min: 3000,\n      cost_max: 8000,\n      time_min: \"2 months\",\n      time_max: \"6 months\",\n      risks: \"Scarring, asymmetry, dry eyes.\",\n      citations: [\"Rhee SC et al., 2017\", \"Chen WP, 2016\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 40 },\n        \"Eye Aspect Ratio\": { direction: \"increase\", percentage: 10 }\n      },\n      pillars: [\"youthfulness\", \"alertness\", \"femininity\"]\n    }\n  },\n  {\n    id: \"brow_lift\",\n    title: \"Brow Lift / Browridge Enhancement\",\n    trigger_rules: {\n      metrics: [\"Eyebrow Low Setedness\", \"Browridge Inclination Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Eyebrow Low Setedness\": { operator: \">\", value: 2.0 },\n        \"Browridge Inclination Angle\": { operator: \"<\", value: 10.0 }\n      }\n    },\n    content: {\n      description: \"Brow elevation via endoscopic browlift, temporal lift, or direct browplasty to reduce hooding and increase eyebrow height. For browridge: supraorbital rim augmentation with PMMA, hydroxyapatite paste, or custom implants. Botox for brow arch shaping. Addresses low-set brows and flat browridge inclination.\",\n      cost_min: 1500,\n      cost_max: 10000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Asymmetry, numbness, unnatural appearance.\",\n      citations: [\"Mendelson B et al., 2015\"],\n      tags: [\"Surgical\", \"Minimally Invasive\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 4, confidence: 0.75 },\n      ratios_impacted: {\n        \"Eyebrow Low Setedness\": { direction: \"decrease\", percentage: 30 },\n        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 20 }\n      },\n      pillars: [\"youthfulness\", \"masculinity\", \"upper_third\"]\n    }\n  },\n  // ============================================\n  // ADDITIONAL PROCEDURES\n  // ============================================\n  {\n    id: \"kybella\",\n    title: \"Kybella (Double Chin Removal)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 130.0 },\n        \"Neck Width\": { operator: \">\", value: 95.0 }\n      }\n    },\n    content: {\n      description: \"Injectable deoxycholic acid (Kybella/ATX-101) to permanently dissolve submental fat. Multiple sessions required (2-6 treatments, 4-6 weeks apart). Destroys fat cell membranes, eliminating double chin without surgery. FDA-approved for moderate-to-severe submental fullness.\",\n      cost_min: 1200,\n      cost_max: 3000,\n      time_min: \"2 months\",\n      time_max: \"6 months\",\n      risks: \"Swelling, bruising, numbness, pain, nerve injury causing asymmetric smile, asymmetry, difficulty swallowing.\",\n      citations: [\"Jones DH et al., 2016\", \"Ascher B et al., 2017\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"cryolipolysis\",\n    title: \"Cryolipolysis (Fat Freezing)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 125.0 },\n        \"Neck Width\": { operator: \">\", value: 90.0 }\n      }\n    },\n    content: {\n      description: \"Non-invasive fat reduction via controlled cooling (CoolSculpting). Targets stubborn subcutaneous fat without surgery by crystallizing fat cells which are then naturally eliminated. FDA-cleared for submental area, flanks, abdomen. Results visible in 2-4 months.\",\n      cost_min: 750,\n      cost_max: 2500,\n      time_min: \"2 months\",\n      time_max: \"4 months\",\n      risks: \"Temporary erythema/swelling, bruising, numbness/paresthesia, pain, paradoxical adipose hyperplasia (rare), frostbite, hyperpigmentation.\",\n      citations: [\"Ingargiola MJ et al., 2015\", \"Kilmer SL et al., 2017\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 2,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 12 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"definition\", \"non_invasive\", \"neck\"]\n    }\n  },\n  {\n    id: \"chin_implant\",\n    title: \"Chin Implant (Mentoplasty)\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\", \"Facial Convexity\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.6 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 12.0 },\n        \"Facial Convexity\": { operator: \"<\", value: 165.0 }\n      }\n    },\n    content: {\n      description: \"Alloplastic chin augmentation using silicone or Medpor implants placed through submental or intraoral incision. Provides permanent chin projection and width enhancement. Alternative to sliding genioplasty for pure augmentation without bone cutting. Custom implants available for precise contouring.\",\n      cost_min: 3000,\n      cost_max: 8000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Infection, implant migration, bone erosion, asymmetry, numbness, capsular contracture, implant extrusion.\",\n      citations: [\"Yaremchuk MJ, 2013\", \"Binder WJ et al., 2008\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.88 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 18 },\n        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 12 },\n        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 4 }\n      },\n      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"buccal_fat_removal\",\n    title: \"Buccal Fat Removal (Bichectomy)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 70.0 },\n        \"Face Width to Height Ratio\": { operator: \">\", value: 1.55 }\n      }\n    },\n    content: {\n      description: \"Surgical excision of buccal fat pads through intraoral incision to slim the lower cheeks and enhance facial angularity. Creates more defined cheekbone-to-jaw contour. Best for patients with naturally round faces at low body fat. Results are permanent and irreversible.\",\n      cost_min: 2500,\n      cost_max: 6000,\n      time_min: \"2 weeks\",\n      time_max: \"6 months\",\n      risks: \"Facial nerve damage, asymmetry, over-resection causing gaunt appearance, infection, hematoma, parotid duct injury.\",\n      citations: [\"Tarallo M et al., 2018\", \"Moura LB et al., 2018\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 6 },\n        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 3 }\n      },\n      pillars: [\"angularity\", \"definition\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"alarplasty\",\n    title: \"Alarplasty (Alar Base Reduction)\",\n    trigger_rules: {\n      metrics: [\"Nasal W to H Ratio\", \"Alar Base Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal W to H Ratio\": { operator: \">\", value: 0.80 },\n        \"Alar Base Width\": { operator: \">\", value: 35.0 }\n      }\n    },\n    content: {\n      description: \"Surgical narrowing of the nasal alar base through wedge excision. Reduces nostril width and alar flare. Can be performed alone or combined with rhinoplasty. Weir excision for nostril sill, alar wedge for flaring. Hidden incision placement minimizes visible scarring.\",\n      cost_min: 2000,\n      cost_max: 5000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Visible scarring, asymmetry, over-narrowing, nostril distortion, poor wound healing.\",\n      citations: [\"Rohrich RJ et al., 2009\", \"Ingels K et al., 2015\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 12 },\n        \"Nasal Index\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n    }\n  },\n  {\n    id: \"canthopexy\",\n    title: \"Canthopexy (Lateral Canthal Suspension)\",\n    trigger_rules: {\n      metrics: [\"Lateral Canthal Tilt\", \"Lower Eyelid Position\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lateral Canthal Tilt\": { operator: \"<\", value: 3.0 },\n        \"Lower Eyelid Position\": { operator: \">\", value: 1.5 }\n      }\n    },\n    content: {\n      description: \"Suture suspension of the lateral canthal tendon to tighten lower eyelid and prevent sagging. Less invasive than canthoplasty (no tendon cutting). Supports eye shape, prevents scleral show, and can provide subtle upward tilt. Often combined with blepharoplasty.\",\n      cost_min: 2500,\n      cost_max: 6000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Asymmetry, under/overcorrection, dry eyes, ectropion, scarring, temporary swelling.\",\n      citations: [\"Hester TR et al., 2000\", \"Codner MA et al., 2008\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n      ratios_impacted: {\n        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 20 }\n      },\n      pillars: [\"youthfulness\", \"alertness\", \"eye_area\"]\n    }\n  },\n  {\n    id: \"neck_lift\",\n    title: \"Neck Lift (Platysmaplasty)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 135.0 },\n        \"Neck Width\": { operator: \">\", value: 100.0 }\n      }\n    },\n    content: {\n      description: \"Comprehensive neck rejuvenation: platysma muscle tightening (platysmaplasty), submental liposuction, excess skin removal, and possible digastric muscle reduction. Addresses turkey neck, platysmal banding, submental fullness, and skin laxity. Can include submental tuck or deep plane techniques.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Hematoma, nerve injury, skin necrosis, asymmetry, visible scarring, skin irregularities, prolonged swelling.\",\n      citations: [\"Feldman JJ, 2006\", \"Ellenbogen R et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 25 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 15 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"septoplasty\",\n    title: \"Septoplasty (Deviated Septum Correction)\",\n    trigger_rules: {\n      metrics: [\"Nasal Deviation\", \"Nasal Symmetry\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal Deviation\": { operator: \">\", value: 5.0 },\n        \"Nasal Symmetry\": { operator: \"<\", value: 0.90 }\n      }\n    },\n    content: {\n      description: \"Surgical correction of deviated nasal septum to improve nasal airflow and symmetry. Performed through closed endonasal approach. Can be functional (breathing) or cosmetic (straightening). Often combined with rhinoplasty (septorhinoplasty) for comprehensive nasal reshaping.\",\n      cost_min: 3000,\n      cost_max: 10000,\n      time_min: \"1 week\",\n      time_max: \"3 months\",\n      risks: \"Septal perforation, persistent deviation, saddle nose, numbness, infection, bleeding, CSF leak (rare).\",\n      citations: [\"Rohrich RJ et al., 2011\", \"Fettman N et al., 2009\"],\n      tags: [\"Surgical\"],\n      priority_score: 2,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n      ratios_impacted: {\n        \"Nasal Deviation\": { direction: \"decrease\", percentage: 80 },\n        \"Nasal Symmetry\": { direction: \"increase\", percentage: 10 }\n      },\n      pillars: [\"symmetry\", \"function\", \"breathing\"]\n    }\n  },\n  {\n    id: \"lip_lift\",\n    title: \"Lip Lift (Bullhorn/Subnasal Lip Lift)\",\n    trigger_rules: {\n      metrics: [\"Philtrum Length\", \"Upper Lip Vermilion Height\", \"Midface Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Philtrum Length\": { operator: \">\", value: 15.0 },\n        \"Upper Lip Vermilion Height\": { operator: \"<\", value: 7.0 },\n        \"Midface Ratio\": { operator: \">\", value: 1.1 }\n      }\n    },\n    content: {\n      description: \"Surgical shortening of the philtrum by removing skin at the base of the nose (bullhorn excision). Permanently increases upper lip vermilion show and reduces long upper lip appearance. Alternative to filler for long philtrum correction. Scar hidden in nasal base crease.\",\n      cost_min: 3500,\n      cost_max: 8000,\n      time_min: \"2 weeks\",\n      time_max: \"6 months\",\n      risks: \"Visible scarring, asymmetry, over-shortening, distorted nostril base, wound dehiscence, prolonged swelling.\",\n      citations: [\"Austin HW, 1986\", \"Santanché P et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 25 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"youthfulness\", \"harmony\", \"lip_area\"]\n    }\n  },\n  {\n    id: \"jaw_implants\",\n    title: \"Jaw Implants (Mandibular Augmentation)\",\n    trigger_rules: {\n      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Ramus to Mandible Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Bigonial Width\": { operator: \"<\", value: 85.0 },\n        \"Gonial Angle\": { operator: \">\", value: 130.0 },\n        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.45 }\n      }\n    },\n    content: {\n      description: \"Alloplastic mandibular augmentation using silicone, Medpor, or custom PEEK implants. Enhances jaw width (bigonial), gonial angle definition, and mandibular border projection. Placed through intraoral incision. Custom wraparound implants available for comprehensive jaw enhancement.\",\n      cost_min: 6000,\n      cost_max: 20000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Infection, implant migration, bone erosion, asymmetry, mental nerve injury, capsular contracture, masseter atrophy.\",\n      citations: [\"Yaremchuk MJ, 2006\", \"Rao LK et al., 2011\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Bigonial Width\": { direction: \"increase\", percentage: 12 },\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 8 },\n        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 6 }\n      },\n      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"midface_implants\",\n    title: \"Midface Implants (Malar/Submalar)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Face Width to Height Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 55.0 },\n        \"Midface Ratio\": { operator: \">\", value: 1.15 },\n        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.65 }\n      }\n    },\n    content: {\n      description: \"Alloplastic augmentation of the malar (cheekbone) and/or submalar region using silicone or Medpor implants. Enhances midface projection, cheekbone prominence, and overall facial width. Custom implants available. Alternative to fat grafting for permanent midface volume.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Infection, implant migration, asymmetry, nerve injury (infraorbital), bone erosion, capsular contracture, visibility.\",\n      citations: [\"Terino EO, 2000\", \"Binder WJ et al., 2007\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 10 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 6 },\n        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 4 }\n      },\n      pillars: [\"angularity\", \"harmony\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"submental_liposuction\",\n    title: \"Submental Liposuction\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 120.0 },\n        \"Neck Width\": { operator: \">\", value: 85.0 }\n      }\n    },\n    content: {\n      description: \"Surgical removal of excess fat beneath the chin via small cannula through submental incision. Refines jawline contour and improves neck definition. Can be combined with skin tightening or platysmaplasty. Best for younger patients with good skin elasticity.\",\n      cost_min: 2000,\n      cost_max: 5000,\n      time_min: \"1 week\",\n      time_max: \"3 months\",\n      risks: \"Contour irregularities, asymmetry, nerve injury, skin laxity, hematoma, seroma, prolonged swelling.\",\n      citations: [\"Rohrich RJ et al., 2007\", \"Giampapa VC et al., 2000\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 4, confidence: 0.82 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"submentoplasty\",\n    title: \"Submentoplasty (Submental Tuck)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 140.0 },\n        \"Neck Width\": { operator: \">\", value: 105.0 }\n      }\n    },\n    content: {\n      description: \"Direct excision of submental skin/fat with platysma muscle plication through small chin incision. Tightens central neck muscles and removes excess tissue. More aggressive than liposuction alone, less extensive than full neck lift. Also called cervicoplasty.\",\n      cost_min: 3500,\n      cost_max: 8000,\n      time_min: \"2 weeks\",\n      time_max: \"4 months\",\n      risks: \"Visible scarring, hematoma, nerve injury, skin necrosis, asymmetry, contour irregularities.\",\n      citations: [\"Giampapa VC et al., 2000\", \"Ellenbogen R et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 20 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 12 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"fat_grafting\",\n    title: \"Fat Grafting (Facial Lipofilling)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Under-Eye Hollowness\", \"Temple Volume\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n        \"Under-Eye Hollowness\": { operator: \">\", value: 3.0 },\n        \"Temple Volume\": { operator: \"<\", value: 0.8 }\n      }\n    },\n    content: {\n      description: \"Autologous fat transfer: fat harvested from body (abdomen, thighs), processed, and injected for facial volumization. Microfat for volume (cheeks, temples, jawline), nanofat for skin rejuvenation. Natural permanent filler with 40-60% long-term retention. Multiple sessions may be needed.\",\n      cost_min: 4000,\n      cost_max: 12000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Fat resorption, asymmetry, lumpiness, oil cysts, infection, embolism (rare), over/under-correction.\",\n      citations: [\"Coleman SR, 2006\", \"Khouri RK et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 5 },\n        \"Tear Trough Depth\": { direction: \"decrease\", percentage: 40 }\n      },\n      pillars: [\"youthfulness\", \"volume\", \"natural\"]\n    }\n  },\n  {\n    id: \"supraorbital_implants\",\n    title: \"Supraorbital Rim Implants (Browridge)\",\n    trigger_rules: {\n      metrics: [\"Browridge Inclination Angle\", \"Supraorbital Projection\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Browridge Inclination Angle\": { operator: \"<\", value: 8.0 },\n        \"Supraorbital Projection\": { operator: \"<\", value: 0.85 }\n      }\n    },\n    content: {\n      description: \"Custom or standard implants placed along the supraorbital rim to enhance browridge projection and definition. Creates more prominent brow bone for masculine appearance. Often custom-designed from CT scans. Placed through coronal or endoscopic approach.\",\n      cost_min: 8000,\n      cost_max: 25000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Infection, implant migration, asymmetry, nerve injury, frontal sinus violation, visible/palpable implant, bone erosion.\",\n      citations: [\"Yaremchuk MJ, 2003\", \"Spiegel JH, 2011\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 30 }\n      },\n      pillars: [\"masculinity\", \"bone_structure\", \"upper_third\"]\n    }\n  },\n  {\n    id: \"lip_reduction\",\n    title: \"Lip Reduction Surgery (Reduction Cheiloplasty)\",\n    trigger_rules: {\n      metrics: [\"Lip Thickness\", \"Lower Lip to Upper Lip Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lip Thickness\": { operator: \">\", value: 18.0 },\n        \"Lower Lip to Upper Lip Ratio\": { operator: \">\", value: 2.2 }\n      }\n    },\n    content: {\n      description: \"Surgical removal of excess lip tissue through incision along wet-dry border to reduce lip volume and projection. Improves proportion between lips and surrounding features. Separate procedures for upper and lower lips. Permanent alternative to reversible fillers.\",\n      cost_min: 2500,\n      cost_max: 6000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Visible scarring, asymmetry, over-reduction, numbness, altered sensation, wound dehiscence.\",\n      citations: [\"Fanous N, 2007\", \"Garcia RM et al., 2016\"],\n      tags: [\"Surgical\"],\n      priority_score: 2,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Lower Lip to Upper Lip Ratio\": { direction: \"decrease\", percentage: 20 }\n      },\n      pillars: [\"harmony\", \"balance\", \"lip_area\"]\n    }\n  },\n  {\n    id: \"jaw_reduction\",\n    title: \"Jaw Reduction Surgery (V-Line Surgery)\",\n    trigger_rules: {\n      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Face Width to Height Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Bigonial Width\": { operator: \">\", value: 120.0 },\n        \"Gonial Angle\": { operator: \"<\", value: 115.0 },\n        \"Face Width to Height Ratio\": { operator: \">\", value: 1.65 }\n      }\n    },\n    content: {\n      description: \"Mandibular angle resection and contouring to slim and feminize the lower face, creating V-line effect. Osteotomy of mandibular angle, possible chin tapering (T-osteotomy), and masseter reduction. Popular in East Asian aesthetic surgery. Performed through intraoral approach.\",\n      cost_min: 8000,\n      cost_max: 25000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Facial nerve injury, asymmetry, over-reduction, bone necrosis, infection, prolonged swelling, numbness.\",\n      citations: [\"Yang DB et al., 2014\", \"Jin H et al., 2013\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Bigonial Width\": { direction: \"decrease\", percentage: 15 },\n        \"Gonial Angle\": { direction: \"increase\", percentage: 10 },\n        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"femininity\", \"harmony\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"bimaxillary_osteotomy\",\n    title: \"Bimaxillary Osteotomy (Double Jaw Surgery)\",\n    trigger_rules: {\n      metrics: [\"Facial Convexity\", \"Recession Relative to Frankfort Plane\", \"Midface Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Facial Convexity\": { operator: \"<\", value: 160.0 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 18.0 },\n        \"Midface Ratio\": { operator: \">\", value: 1.2 }\n      }\n    },\n    content: {\n      description: \"Simultaneous repositioning of both maxilla (Le Fort I) and mandible (BSSO) to correct facial disharmony and skeletal malocclusion. Addresses severe class II/III relationships, facial asymmetry, and vertical excess. Requires orthodontic preparation. Most comprehensive facial skeletal surgery.\",\n      cost_min: 20000,\n      cost_max: 60000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"Nerve injury, infection, relapse, TMJ dysfunction, malocclusion, bleeding, airway compromise, need for revision.\",\n      citations: [\"Proffit WR et al., 2013\", \"Wolford LM et al., 2003\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n      ratios_impacted: {\n        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 15 },\n        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 20 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 10 }\n      },\n      pillars: [\"profile\", \"bone_structure\", \"comprehensive\"]\n    }\n  }\n];\n\n// ============================================\n// ADVICE ENGINE CLASS\n// ============================================\n\nexport class AdviceEngine {\n  private plans: RawPlan[];\n\n  constructor(customPlans?: RawPlan[]) {\n    this.plans = customPlans || PLANS;\n  }\n\n  /**\n   * Check if a single threshold condition is met\n   */\n  private checkThreshold(userValue: number, operator: '<' | '>', thresholdValue: number): boolean {\n    if (operator === '<') {\n      return userValue < thresholdValue;\n    }\n    return userValue > thresholdValue;\n  }\n\n  /**\n   * Evaluate trigger rules against user metrics\n   */\n  private evaluateTriggerRules(\n    triggerRules: TriggerRules,\n    metricsDict: Record<string, number>\n  ): { isTriggered: boolean; triggeredMetrics: TriggerResult[] } {\n    const { metrics, thresholds, condition } = triggerRules;\n    const triggeredMetrics: TriggerResult[] = [];\n    const results: boolean[] = [];\n\n    for (const metricName of metrics) {\n      if (!(metricName in metricsDict)) continue;\n      if (!(metricName in thresholds)) continue;\n\n      const userValue = metricsDict[metricName];\n      const { operator, value: thresholdValue } = thresholds[metricName];\n      const isMet = this.checkThreshold(userValue, operator, thresholdValue);\n\n      if (isMet) {\n        triggeredMetrics.push({\n          metric: metricName,\n          value: userValue,\n          threshold: thresholdValue,\n          operator\n        });\n      }\n\n      results.push(isMet);\n    }\n\n    const isTriggered = condition === 'AND'\n      ? results.length > 0 && results.every(r => r)\n      : results.some(r => r);\n\n    return { isTriggered, triggeredMetrics };\n  }\n\n  /**\n   * Get all recommendations that match the user's metrics\n   *\n   * @param metricsDict - Raw metric values\n   * @param severityDict - Severity classifications (ideal/good/moderate/severe) for each metric\n   *                       If a metric is 'ideal', it will NOT trigger remediation plans\n   */\n  getRecommendations(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Plan[] {\n    const recommendations: Plan[] = [];\n\n    for (const rawPlan of this.plans) {\n      const { isTriggered, triggeredMetrics } = this.evaluateTriggerRules(\n        rawPlan.trigger_rules,\n        metricsDict\n      );\n\n      // If severity data is provided, filter out metrics that are already ideal\n      if (isTriggered && severityDict) {\n        // Check if ALL triggered metrics are outside ideal range\n        const hasActualFlaw = triggeredMetrics.some(tm => {\n          const severity = severityDict[tm.metric];\n          // Only trigger if severity is NOT ideal (i.e., it's good/moderate/severe)\n          return severity && severity !== 'ideal';\n        });\n\n        // Skip this plan if all triggered metrics are already ideal\n        if (!hasActualFlaw) {\n          continue;\n        }\n      }\n\n      if (isTriggered) {\n        recommendations.push({\n          id: rawPlan.id,\n          title: rawPlan.title,\n          content: {\n            description: rawPlan.content.description,\n            cost_min: rawPlan.content.cost_min,\n            cost_max: rawPlan.content.cost_max,\n            time_min: rawPlan.content.time_min || 'Unknown',\n            time_max: rawPlan.content.time_max || 'Unknown',\n            risks: rawPlan.content.risks || 'Consult a professional.',\n            citations: rawPlan.content.citations || [],\n            tags: rawPlan.content.tags\n          },\n          trigger_reason: triggeredMetrics\n        });\n      }\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Get recommendations sorted by cost (cheapest first)\n   */\n  getRecommendationsByCost(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Plan[] {\n    return this.getRecommendations(metricsDict, severityDict).sort(\n      (a, b) => a.content.cost_min - b.content.cost_min\n    );\n  }\n\n  /**\n   * Get recommendations grouped by phase/tag\n   */\n  getRecommendationsByPhase(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Record<string, Plan[]> {\n    const recommendations = this.getRecommendations(metricsDict, severityDict);\n    const grouped: Record<string, Plan[]> = {\n      'Foundational': [],\n      'Minimally Invasive': [],\n      'Surgical': []\n    };\n\n    for (const rec of recommendations) {\n      const tags = rec.content.tags || [];\n      if (tags.includes('Foundational')) {\n        grouped['Foundational'].push(rec);\n      } else if (tags.includes('Surgical')) {\n        grouped['Surgical'].push(rec);\n      } else if (tags.includes('Minimally Invasive')) {\n        grouped['Minimally Invasive'].push(rec);\n      } else {\n        grouped['Minimally Invasive'].push(rec); // Default\n      }\n    }\n\n    return grouped;\n  }\n}\n\n// ============================================\n// SINGLETON INSTANCE\n// ============================================\n\nexport const adviceEngine = new AdviceEngine();\n","numLines":1067,"startLine":1,"totalLines":1067}}}
{"parentUuid":"fcc6a7b4-44ce-4c5b-8e15-7f9b66e8a816","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QcuaBVduRVfLUdDKrTVRSS","type":"tool_result","content":"     1→# FaceIQ Comprehensive Logic Report\n     2→\n     3→This report details the logic used by the application to recommend treatments, including Surgeries, Soft-Maxes (NST), and Lifestyle changes. It also documents the specific impacts these treatments have on facial scoring.\n     4→\n     5→## 1. Trigger Logic Map (Flaw -> Treatments)\n     6→The following table maps specific Flaws to recommended Treatments.\n     7→\n     8→| Flaw (Trigger) | Recommended Treatment | Category |\n     9→| :--- | :--- | :--- |\n    10→| Disproportionate lower face (long chin or short philtrum) | Lip filler | NST |\n    11→| Disproportionate lower face (short chin or long philtrum) | Jaw fillers | NST |\n    12→| Disproportionate lower face (short chin or long philtrum) | Lip filler | NST |\n    13→| Double chin | Cryolipolysis (fat freezing) | NST |\n    14→| Double chin | Kybella (double chin removal) | NST |\n    15→| Flat & small cheekbones | Cheekbone fillers | NST |\n    16→| Flat jaw | Jaw fillers | NST |\n    17→| High submental fat | Cryolipolysis (fat freezing) | NST |\n    18→| High submental fat | Kybella (double chin removal) | NST |\n    19→| Lacking Ogee curve | Cheekbone fillers | NST |\n    20→| Lacking cupid's bow | Lip filler | NST |\n    21→| Long midface | Cheekbone fillers | NST |\n    22→| Long midface | Lip filler | NST |\n    23→| Low-set cheekbones | Cheekbone fillers | NST |\n    24→| Mandibular recession | Jaw fillers | NST |\n    25→| Medium-set cheekbones | Cheekbone fillers | NST |\n    26→| Mouth asymmetry | Lip filler | NST |\n    27→| Narrow jaw | Jaw fillers | NST |\n    28→| Overly long face shape | Cheekbone fillers | NST |\n    29→| Overly retruded lower lip | Lip filler | NST |\n    30→| Overly retruded upper lip | Lip filler | NST |\n    31→| Round neck region | Cryolipolysis (fat freezing) | NST |\n    32→| Rounder convex facial profile | Jaw fillers | NST |\n    33→| Short lower third | Jaw fillers | NST |\n    34→| Short ramus | Jaw fillers | NST |\n    35→| Steep jaw | Jaw fillers | NST |\n    36→| Thin lower lip | Lip filler | NST |\n    37→| Thin upper lip | Lip filler | NST |\n    38→| Undefined jawline | Cryolipolysis (fat freezing) | NST |\n    39→| Undefined jawline | Jaw fillers | NST |\n    40→| Undefined jawline | Kybella (double chin removal) | NST |\n    41→| Underprojected chin | Jaw fillers | NST |\n    42→| Weak/soft jaw structure | Jaw fillers | NST |\n    43→| Wide-set eyes | Cheekbone fillers | NST |\n    44→\n    45→---\n    46→\n    47→## 2. Comprehensive Treatment Library\n    48→### Surgical Procedures\n    49→\n    50→#### **Facial liposuction** (`SUR-36`)\n    51→> **Description**: Removes excess fat from face for contouring, often chin/jawline/temples.\n    52→\n    53→- **Risks/Side Effects**: ÎÎ§Î¼ÏÏÎ¨Î£Î£ Î¸Î©ÎÎºÏÎ½ ÏÎ²ÏÎ ÎÎ¤Î¦Î½Î² Î¼ÎÎµÎÎÎ¿ÎÎ ÎµÎ·Ï Î¦ÎÎÏÎÎ¨ ÏÏÎ¦Î Î¤ÎÏÏÎ§Î§ ÏÎÏÎ¡ ÏÏÎ Î© ÎÎ¾Î Î³ÎÏ ÎÎ¹Î¥ÎÎ Î©ÎÎ¥ Î·ÏÎÎ¶ÎÎÎ± Î¦Î¹Î³ÏÏ ÏÎ¦ÏÎÎµÏÎ© ÎÎ¨ÏÎ¨ Î·ÏÎÏ Î³ÎÏÎ¨Î¾Î²Î»Î» Î£Î©Î¦Î¡ ÏÎµÎ»Î¹Î ÎÎ ÎµÎ¥Î·Îº Î¥Î Î¸ÏÏÎ¨Î· ÎÎÎ±ÎÎ·Î´Ï Î\n    54→- **Logic Rules (Triggers & Impacts)**:\n    55→\n    56→#### **Unknown Treatment** (`???`)\n    57→> **Description**: \n    58→\n    59→\n    60→#### **Unknown Treatment** (`???`)\n    61→> **Description**: \n    62→\n    63→\n    64→#### **Canthopexy** (`SUR-33`)\n    65→> **Description**: Tightens lower eyelid to prevent sagging and support eye shape.\n    66→\n    67→- **Risks/Side Effects**: ÏÏÏÎ¹ÎÎ¡ÎÎ¿ Î¹Î¨Ï Î¶ÏÏ ÎÎ²ÏÎÎ¥ ÏÎÎ ÎÎ¦ÎºÏÎ ÎÏÎº Î·Î£Î» ÎÎ¾Î Î§ÎºÎ Î±Î½ÎÎÎ¹Î½Î£ ÏÎÎ²ÏÎ»ÎÎ§Î Î½Î¦ÎÏ ÎÏÏÎ ÎÎÎÎ ÏÎÎ¾ÎÎ£ÎÎ Î¨ÎºÎÎµÎ ÎÎÎ¥Î·Î Î¹ÎÎ¤Î¨Î¨ Î½ÏÎÎÎÎ¹Î ÏÎÎ ÏÎ¨ÎÎÎ¸Î³Î¶Î¦ ÏÎÎ¾Î³ Î©Î¡ÏÎ±Î½Î¸Î·Î½ ÎÎ¿Î¿ ÎÎµÎ² ÏÏÎÎ¹Î³ ÏÎ§Î¹ ÏÏ\n    68→- **Logic Rules (Triggers & Impacts)**:\n    69→\n    70→#### **Unknown Treatment** (`???`)\n    71→> **Description**: \n    72→\n    73→\n    74→#### **Unknown Treatment** (`???`)\n    75→> **Description**: \n    76→\n    77→\n    78→#### **Canthoplasty** (`SUR-25`)\n    79→> **Description**: Targets the corners of the eye to alter the shape, tilt, and size of the eyes.\n    80→\n    81→- **Risks/Side Effects**: ÏÎÏÎÎ¦ÎÎ Î Î¸Î·ÎÎÏÎÎºÏ ÏÏÎÎ²Î¿Î»Ï Î¡ÏÎÎÏÏÏÎ¥ ÏÏÎÎÎ  ÎÎºÎ¦Ï Î ÏÎ¹ÎÏÎ» Î³Î¤Î Î Î¡ÎÎ»Î Î³Î¸Î´Î£Î ÏÎ³ÎÎ§Î¿ ÏÎ¼ÎÎ²Î·Î ÎÎÎ¸ÎÎ¡ÏÎ¼ ÎÎ¤Î¦ Î¥ÎÎ¶Î ÎµÎ´ÎÎÎ© ÎÎÎÎ±Î±Î¦ÎÎ ÎÎÏÎ¥ÎÎ Î³ Î¶ÏÎ ÎÎÎ± ÎÎÎ©Î©ÎÎÎ²Î\n    82→- **Logic Rules (Triggers & Impacts)**:\n    83→\n    84→#### **Unknown Treatment** (`???`)\n    85→> **Description**: \n    86→\n    87→\n    88→#### **Unknown Treatment** (`???`)\n    89→> **Description**: \n    90→\n    91→\n    92→#### **Unknown Treatment** (`???`)\n    93→> **Description**: \n    94→\n    95→\n    96→#### **Unknown Treatment** (`???`)\n    97→> **Description**: \n    98→\n    99→\n   100→#### **ÏÏÎ¿ÎÏÎ ÎÎ½Î¾ ÎÎÎ¤ÎÎÏÎ** (`SUR-35`)\n   101→> **Description**: Î½ÏÎ Î ÎÎÎ¥Î Î¨Î¼Ï ÏÎ´ÎÎ¸Î¤Î¿ ÏÎ Ï ÏÏÎºÎÎÏ Î³ÎÎ¸ÎÏÎÎ±Î Î Î±ÏÎÎÎ²Î£Î ÎºÎ²Î§Î»ÎÎ¶Ï Î³Î³Î±ÎÎºÎ³ÎÎ¨ Î½ÎÎºÎÎ ÎÎ¼Î Î¦ÎÎ ÏÎ¾Î³Î·Î¼Î ÏÏÎÎÏÎÎ  Î ÎÏÏÎ ÏÎ³ ÏÏÎ½Î¸Î\n   102→\n   103→- **Risks/Side Effects**: Î·Î¿ÏÎÎ Î³ÎÎ² Î¾ÎÎ Î´Î¼ÎÎÎ ÎÎ¤Îµ ÎÎ¿ÎÎ·ÏÎÎ¤Î¤ Î³Î»Ï Î£ÏÎ¸ÎÎ½ÏÎ§Î ÏÏÎ¦ ÏÏÏÎ¹Î Î·ÏÎÏÎ Î£Î¤Î Î¼ Î¶Î¨Î¤ Î±ÎÎ¹Î¹Î± ÏÎÎÎ£ÏÏÏÎ ÎÎ»ÏÎÎ ÎÏÎ² ÎÎ¸ÎÎ¤Î±Î Î Î¡ÏÎ¨ÎÎÎ³ Î±Î½Î²Î Î±ÏÎ¤ÏÎ¿ Î¨Î¿Î¦Î¹Î¾ ÏÏÎÎ¶ ÏÎ¹ÏÏÎ´ÏÎ¹Î ÎÎ¹ÎÎ¼ Î Î¹Ï ÎÎÎ£Î±ÎÎ ÎÏÎ¾\n   104→- **Logic Rules (Triggers & Impacts)**:\n   105→\n   106→#### **Chin implants** (`SUR-07`)\n   107→> **Description**: Implants to specifically enhance chin projection and shape.\n   108→\n   109→- **Risks/Side Effects**: ÏÎ¸Î¨Î²Î½Î¤Î¦Î± Î¾ÎµÎ§Î´Î¹ÎÏ ÏÎÎÎ ÎÎÎ¨ Î§ÎÎÎÎÎ¶Î¸ ÏÏÎÎ¤Î¦ ÎÏÎ¤ ÎºÎÎ©ÎÎ£Î¶Î» Î¤ÏÎ³ÎÎ©Î± Î¡ÎÎ¨Î¡Î§Î¡ Î¶Î²Î³ÏÎ¿Î Î£ÏÎ¨Î Î§Î±Î¹Î£ÎÎ»Ï Î´Î³ÎÎÎ¤Î Î¡ ÏÎÎ ÎÎÏÏÎÏ Î·Î©Î¥ÏÏ Î£Î¾Î¹ÎÎ·Ï ÏÎ¡ÎÎ¤ÏÏÎ¨Î¦ Î´ÎÏÎÎ· ÎÎÎÏÎ»\n   110→- **Logic Rules (Triggers & Impacts)**:\n   111→\n   112→#### **Fat grafting** (`SUR-09`)\n   113→> **Description**: Fat is harvested from the patient and processed. Microfat is for volume enhancement. Nanofat is for facial/skin rejuvenation.\n   114→\n   115→- **Risks/Side Effects**: ÎµÎÎÎÎ¡Î¾ÎÎ Î¸Î¾Î¸Î£Î³ÏÎÏ Î¼ÎÎ¤Î£ÏÎ¨Î·Î Î·Î±Î·ÎÎ Î³Î»Î§ÎÎ¡ Î¥Î·Î§ÎÎÏÎµÏ ÎÎÎÎÎ¨ÏÎ§ Î©ÏÏÎº ÏÎÎ± ÏÎ©ÎÎÎ¶Î¶ÎÎ§ Î»Î Î ÏÎ¤Î  Î²Î©Î¶Î» Î£Î¤ÎÎ¥Î´Î¤Î ÎÎ¥Î½Î±Î¿Ï Î½Î¥ÎÎ¸Î Î¶Î±Î¥Î¶Î¤ÎÏÎ¸ Î¼ÎµÎ¦Î»Î¸ÎÎÎ¥ ÏÎ»ÏÎ¿ÎÏÎ»Î£ Î´ÏÎ¥Î ÏÏÎÎ¨ÎÎ²Î ÎÎÎ Î»Î Î¿Î¥ÎÏÏÎ¿Î±Ï ÎÎ¿Î¸ÎÎÎ ÎÎ¥ÏÎ¼ÎºÎµ Î¸ÎÎ¤ÏÎ ÏÎÏÎ¾ÎÏÎ Î½Î©ÎÎ¤ Î©Î¥ÎÎ¼ÎÎÏÎ¤ ÎÎÎ·Î¦Î ÎÎ±ÎÎ²ÏÎÎºÎ© Î¦Î²ÎÎÏÎ» ÏÏÎ§ÏÎ§Î¾ Î·Î³Î¤ÎÎ¤Î§ Î¥Î¸Î´Î¼Î³ÎÎ· ÎÎ©ÏÏÎ ÏÎ§Î¸Î Î¾Î¼Î¾Î©ÎÎ´Î» ÎµÎ§ÎÏÎ¸Î ÎÎ¡ÏÎÎ¶Î¿Î¶Î ÎÎ¡ÎºÎ¿ÏÎ Î³Ï Î¡ÏÎÏÎ§ Î²ÎÏÎ¹ÎÎ¶ ÎÏÎ»ÏÎ¡ ÎÎÎ´ Î¶ÏÎ¹ÏÎ¦Î Î¹ Î¼Î£ÎÏ ÏÎ¡Î¦Î»ÏÎ½ÏÎ¡ ÎÎ©Î±ÎÎ½ÎÎ³Ï ÏÎ·Î¿ÎÎ¥ ÏÎ§Î ÎÎ\n   116→- **Logic Rules (Triggers & Impacts)**:\n   117→\n   118→#### **Unknown Treatment** (`???`)\n   119→> **Description**: \n   120→\n   121→\n   122→#### **Jaw implants** (`SUR-17`)\n   123→> **Description**: Implants to enhance/ augment jaw bone for a prominent jawline.\n   124→\n   125→- **Risks/Side Effects**: Î¨ÏÎÏÎµÎ¾ÏÎ Î»Î¶ÎÎ Î Î¿Î¦Î¥Î´ ÎÎ¡Î¥ÎÎµÎ¾Î¹ Î»ÎÎÏÎ ÏÎÎ¸Î¾ ÎÎ¾ÎÎ¨Î³ÏÎÎ ÎÎ§ÏÎ Î³ÎÎ¥ÏÎ¥ÏÎ Î¾Î³ÏÏÎÏÏÎ\n   126→- **Logic Rules (Triggers & Impacts)**:\n   127→\n   128→#### **Jaw reduction surgery** (`SUR-34`)\n   129→> **Description**: Reshapes jawbone to slim and contour the lower face, often for V-line effect.\n   130→\n   131→- **Risks/Side Effects**: ÎºÎ©ÏÎ Î²Î¡ÏÏ Î¼ÎÎ§ÎµÎ¡Î¼ ÎÎ³Î£ ÏÎ¥Îµ ÎÎ·ÎÎºÎ·ÎÎÎ ÎÏÎÏ ÎµÏÎ Î¸Î¸Î¦ Î¡Î´Î²ÏÎ¼Î Î¨ÎÎ¸ÎÎ´Î§ Î¡ÎÏÎ¶Î Ï Î´Î»ÏÎ¾ ÏÏÎ¡ÏÎ² ÏÎÏÏ ÎÏÎ£Î±ÎµÎ·Î²Î Î¿ÏÏÎ¸Î´Î  ÎÎ´ÏÎÎÎº Î¶ÎÎÏÎ¨ÎÎ ÏÏÎÎ©Î»ÎºÎ ÎÏÎ¤ÎÎ¥ÎÎÎ ÏÎ¾ÎÎÏÏ Î¦Î·ÎÎ¸ÏÎÎ» ÎÎÏÎ±Î ÎÎ§Î Î´ Î±Î¡ÎÏÎ Î·ÎÎ¿ÎÎ·ÏÎ¤Î¶ Î»ÎÎÎ±Î·Î¿ ÏÎÎ Î¿Î²Î ÎÎ¦Î£Î ÎÎ¦ÎÎÎ»ÎÏÎ ÎÎ¸Î¼ÏÎ§Ï Î»Î»ÏÎ§Îº ÏÎ¦ÎÎ¡Î¦ÎÎ©Ï Î¤Î´Î¾Î¦ Î ÏÎÎ¦ÎºÎ¦ Î·ÎÎ¨ÎµÏ ÎÎÎ·Î Î¨Î¥Ï ÎÎ¤ÎÎ´ÎÎÎ»Î¼ ÏÎ¶Î»ÎÎ¥Ï Î´ÎÎÏÎÎÏÎ¡ ÎÏÏÎÎ¹ÎÎ¿ ÏÎ ÏÎ¸Î¸Î¾ÏÎ½\n   132→- **Logic Rules (Triggers & Impacts)**:\n   133→\n   134→#### **Unknown Treatment** (`???`)\n   135→> **Description**: \n   136→\n   137→\n   138→#### **Unknown Treatment** (`???`)\n   139→> **Description**: \n   140→\n   141→\n   142→#### **Bimaxillary osteotomy** (`SUR-13`)\n   143→> **Description**: Reposition both the jaws for facial balance and remove any misalignment.\n   144→\n   145→- **Risks/Side Effects**: ÎÎ Î¦Î Î·ÎÎ¾Î· Î»ÏÎÎ Î¼ÏÎ¹ÎÎ¾ Î¶ÎÎÎ· ÏÎÎ³Î¿ Î¦Î²ÎÎÏ ÎÎ½Î´ Î¤ÏÎÎ¨Î¨ÎÎÎ¸ ÏÎÎÎ¦Î·Î¡ÎÎ¨ ÎÏÏÎ¨ÎÎÎ¶ ÎÎÎ¤ÏÏÎÏ Î½Î¥ÏÎ·ÎÎÎ§Î¨ Î¿ÏÎ§Î¥ Î ÎÎÎ¹Î¦Î¥Î» ÏÎ¿Î·Î¦ÏÎ³ ÏÎ¿Î ÎÎÎ ÎµÎ³ÎÎÎÎ Î¹Î¹ÏÎ§Î§ ÎÎÎÎÎÎ¡ Î¡ÏÎ·Î¡Î\n   146→- **Logic Rules (Triggers & Impacts)**:\n   147→\n   148→#### **Unknown Treatment** (`???`)\n   149→> **Description**: \n   150→\n   151→\n   152→#### **Unknown Treatment** (`???`)\n   153→> **Description**: \n   154→\n   155→\n   156→#### **Neck lift** (`SUR-21`)\n   157→> **Description**: Comprehensive procedure that removes excess skin and lifts the neck skin May include “Submental Tuck” (muscle/skin tightening) or “Submental Liposuction” (fat removal)\n   158→\n   159→- **Risks/Side Effects**: Î¤ÎÎÎ¾Î¤ÎÎÏ Î½Î¤ÏÎ¥Î±Î¼ÎÎ© Î¼ÎÎ½Î²ÎÏÎÎ Î¤Î£Î Î³ÏÎ¸Î ÎÎÏÎÎ¸ Î´ÎÏÏ Î¼Î¨Î¹Î¨ÎÏÎ¨Î Î¤Î±ÎÎÎÎµÎ Î¸Î¤Î©Î¹Î¼ Î©ÎÎÎÎÎÏÎ Î¼ÏÎ¼Î·ÎÎ±Î  ÎÏÎ´Î·ÎÎÎ¡Î½ Î¸ÎÎ¶Î£Î£ ÎºÎÎ¾ÎÎ¤Î\n   160→- **Logic Rules (Triggers & Impacts)**:\n   161→\n   162→#### **Midface implants** (`SUR-06`)\n   163→> **Description**: Implants to enhance and augment midface projection.\n   164→\n   165→- **Risks/Side Effects**: ÏÎÎ·Î¿Î©ÏÎÎµ Î¼ÏÎ·ÏÎ¥Î¼Î± ÎºÎÎºÎ±Î§Î½Ï Î±ÏÎÎ³Î Î¤ÏÎ¨ÏÎÎ¡ ÎÎ§Î´ÏÏÎ½ Î§Î¨Î³ Î§Î±ÏÎ ÎÏÎºÎ»ÎÎµÎÎ¦ ÎÎ¹Î¾Î¿Î Î¦ÎÎµÎ Î·Î²Î£ ÎÎ¼ÎÎÎÎÎ¡ ÎÎ¹ÎÎ Î¼ÏÎÏÎ¸Î§Î Î¿Î£Î§ÎÎ§ÎÎÎ© Î¿Î½Î³ÎÎ¥\n   166→- **Logic Rules (Triggers & Impacts)**:\n   167→\n   168→#### **Unknown Treatment** (`???`)\n   169→> **Description**: \n   170→\n   171→\n   172→#### **Î¶Î¿ÎÎÎ¶Ï Î¸ÏÎ»ÎµÎÎÎÎ³ ÎÏ** (`SUR-39`)\n   173→> **Description**: Î¨Î»Î½Î ÎÎ½Î¿ÎÎ»ÎÎ¼ Î¸Î¥Î Î¤ Î³Î¥ÎµÎÏ Î¾ÎÎÎÎ¿ÎÎ¦ ÎÎ¨Î¼ÎÎµÎ¶Î Î¦Î±ÏÎ¿ ÎÎ¿Î´ÏÎÎ¦ÎÎ ÎÎ½ÎºÎ²Î¹ÏÎ¤ ÎÏÎÎ¾Î£ ÏÎ¿ÏÎÎÎÎ¶Ï ÏÎµÎµÎ¥ ÎµÏÎ¦Î±ÎÎÎ¡ ÎÎ½ÏÎ ÎÎÎ¡Î³ÎÏÎ£Î¿ ÏÏÏÏÎ¨ÏÎ§Î¦ ÏÎÎ¸Î Î£ÎÎ¾ÎÏ Î£ÏÎÎ¶ÎÎ£ Î¥Î¾Î ÎÎ¿ ÎÎÎ¹Î¦Î²Î¨Î£ Î©ÏÎ³ÏÎ³ÏÎ³Î§ Î´Î¹ÎÎ±ÎÎ¹ÎÎ Î²Î¹ÎÎÎÎ§ ÏÎ½ÎÎÎ ÏÎÎµÎ Ï ÎÎÎ©Î ÎÏÎ¦Î Î Î£ÏÎÎÏÎ Î¡ÎµÎ´Î¡Ï Î¹Î»ÏÎ¤ÏÎ£ÎÏ ÎÏÎÎ± Î¤ÎÎÏ Î¸ÏÎÎ©Î½ ÏÎ§Î§ÎÎº ÎÎ§Î´Î·ÎÎ ÏÎ£ÎºÎÎÎ³Î±Îµ ÏÏÎÎ²ÏÎ ÏÎ¥ÎÎ¶ÎÎ£Î¨Î  Î ÎÎºÎ³\n   174→\n   175→- **Risks/Side Effects**: Î¡Î¶ÎÎÎÎ±ÏÏ Î»Î¾ÎÎºÎÎÏ ÏÎ¹ÎºÏÏÏÎ£Î¾ ÏÎ¡Î½Î©ÏÎ¹ ÏÏÎÏÎÎ Ï ÎÏÎÎ»Î¸Î ÏÎÎ´ Î²ÎÎ¾ Î¹Î ÎÎ³Î ÏÎµÎ¾Î¸ÏÎ¨ ÎÎÎ Î¶Î¥Î ÎºÎ£ÏÎ´ÎµÎ¹Î¹Î¶ Î¹Î¨Î¸Î¨ Î²Î²ÎÎ½ÎÎ¾Î¹ Î Î£ÏÎ´Î±Î² ÎÎ¿ÏÏÏÏÎº Î»ÎÎÎ¨ Î¦ÎÎÎ¶ÎÎ¼ Î¼ÎÎ ÎÎ»Î Î¼Î¿ ÎÎ§ÎÎÎÎ² ÎÎºÎ£ÎÎÏ Î¤ÏÎ³Î¾ÎÎ·ÎºÎ½ Î¶Î¸Î¶Î Î²Î´Î¶ÏÏÎ¥Î´Î ÏÎ¤Î¦ÎÎÎÎ Î¿ÏÎÎ½ ÎÎ¾ÎÎÎ¦Î¥ ÏÎÏÎ¼ÎÏ ÏÎÎ³Î Î¿ÎÎ´Î±Î¾ ÎºÎ²Î² ÎÏ\n   176→- **Logic Rules (Triggers & Impacts)**:\n   177→\n   178→#### **Supraorbital rim implants** (`SUR-22`)\n   179→> **Description**: Implant to enhance the upper orbital hollows for proper orbital definition.\n   180→\n   181→- **Risks/Side Effects**: ÎÎ¡Î±Î³ÏÎÎÏ Î¼ÏÎ»Î© ÎÎ§ÏÎÎÎÏ Î¡ÎºÎºÏÎ¸ÎÎ© Î Î²ÏÎ ÎÎÎ¡ÏÎ¼ ÎÎ§ÎÎÎÎ² ÎÎºÏÎ©Î Î©Î±Ï ÏÎÎ¨ÎÏÎ·ÏÎ Î¸ÎÎºÎ¦Î©Î² ÎÎ¤ÎÎÎ Î¡ÎÎ¥ ÎÎ¾Î¡Î» Î´ÎÎµÎÏ ÎÎ£ÏÎ¸ÎºÎ½Î½Î» ÏÏÏÎ´ÎµÎ» Î¨Î³Î¸ÏÏ Î±ÎÏÏÎ ÎµÎ¹ Î¾ÎÎ±ÎÎ¹ ÎÎÎ¡Î´Î  Î¸Î¸ÎÏ ÏÎ Î¼Î¦Î³ÎÎÎ ÎÏÎÎ²Î±ÏÎÎ± ÎÎ¤ÏÎ±Î½Î\n   182→- **Logic Rules (Triggers & Impacts)**:\n   183→\n   184→#### **Unknown Treatment** (`???`)\n   185→> **Description**: \n   186→\n   187→\n   188→#### **Submental liposuction** (`SUR-38`)\n   189→> **Description**: Removes excess fat beneath the chin to refine the jawline and improve neck contour.\n   190→\n   191→- **Risks/Side Effects**: ÎÎ»Î¶Î¶Î£Î¼Î¥Îº Î¸Î Î ÏÎÎ³Î¼Î Î¹Î¿ÎµÏÎÎ´Ï Î±ÎÎÎ»ÎÎ¼Ï ÏÎÎ ÏÎÎ¦ÏÎ²Î  Î¨ÏÎÎ¹Îº Î©Î¨ÎÎ³ Î²ÏÎ§Î¨Î²Î ÎÎ¦ÎÏÏÎ¨ ÏÏÎÏÎ¹ ÎÏÎÎÎ¦Î¾ ÎÎÏÎ ÏÎÎÎ¶Îº ÎÎ¨ÏÎ¨Î¤Î£Î¼Î¡ Î Î¿ÏÏ Î¦Î±ÏÎÎ´Î· ÎÎ½ÎÏÎÎÏÎ ÏÎÎ§Î¨Î·Îµ Î¨ÎºÎÎÎ¾Î¦Î¤ ÎÎ¾ÎÎ¤Î Î´ Î·ÎÎ¹Î¼ÏÎ©Î© ÎÎÎ´Î·ÎÏ ÎÏÏÎÏÎ ÎÎÎÎ¼Ï ÎÎÎºÎÎ¥Î¥Î¿Î½ ÏÎ¿ÎÎ¥ÎÎÏÎ ÎµÏÏÏÏÎ ÎÎÎµÎµÎÎ  ÏÏÏÎ¤Î\n   192→- **Logic Rules (Triggers & Impacts)**:\n   193→\n   194→#### **Unknown Treatment** (`???`)\n   195→> **Description**: \n   196→\n   197→\n   198→#### **Submental tuck (submentoplasty)** (`SUR-11`)\n   199→> **Description**: Direct excision of submental skin/fat with platysma plication; tightens central neck muscles and removes excess tissue and fat. Also called cervicoplasty. Targets submental fullness and laxity via small incision under chin.\n   200→\n   201→- **Risks/Side Effects**: ÎÎÎ¨Î£ÏÎÎ§Î Î¹ÎÎ¡ÏÏÎ½Î© Î¹Î·ÎÎÎÎ³ÏÎ¥ Î¼ÎÎÎ¹ÎÎ¥ Î²ÎÏÏÎ¹Î±ÎÏ Î©ÎÎ³ÎµÎ² ÎÏÎÎÎµÏÎ¼ ÏÎ¶Î½ ÏÎÎºÎ³ ÏÎÎÎ¼Î»ÎÏÎ\n   202→- **Logic Rules (Triggers & Impacts)**:\n   203→\n   204→#### **Lip reduction surgery (reduction cheiloplasty)** (`SUR-40`)\n   205→> **Description**: Surgically removes excess lip tissue to reduce lip volume and projection, improving proportion between the lips and surrounding features.\n   206→\n   207→- **Risks/Side Effects**: Î¦ÎÎ¡ÎÎ ÎÎ©Î¡ Î¹ÎÎ§Î¶ ÎÎ¥Î± Î²Î©Î¦Î·Î ÎÏÎ²ÎÎÎÎ³Î³ ÎÎÏ ÎÎÎ²Î±Î¼ÎÎ·Î¿ ÎµÎ¿Î¦ Î¨Î¹ÎºÎ¤ÎÎ¿ ÎºÎ´Î¹ÎÏÎ¤ÏÎ£ ÎÎ´Î´ÏÎ¦Î¿Î£Î¼ Î¥Î¦Î Î»Î³Î¸Î£Î»Î¸ Î¨ÎÎÎ¸ÎÎ½Î¿Ï ÎÎ¡Î·Î¶ ÎÎ£Î¤ÏÎ½Î§Î¿Î§ Î¡Î´ÎºÎ´\n   208→- **Logic Rules (Triggers & Impacts)**:\n   209→\n   210→#### **Unknown Treatment** (`???`)\n   211→> **Description**: \n   212→\n   213→\n   214→#### **Cheekbone implants** (`SUR-05`)\n   215→> **Description**: Implants to enhance zygomatic prominence.\n   216→\n   217→- **Risks/Side Effects**: Î´ÎÎÎ´ÎÎÏÎ¶ Î»Î¨Î¡ÏÎÎÎ»Î  Î¨Î©Î´Ï Î¿Î¦ÎÎ© Î¹Î´Î¹ÏÎÎ¡ÏÎ ÎÏÎ²Î©Î¥ ÎÎÎ½ÎÎµÎ¡Îº Î²Î¼ÎÎ¹Î Î©Î·Î¾ÏÎ§Î ÎÎ±ÏÎÏÎ·Î´Ï ÎÎºÏÎ¶Î¿Î¹ ÏÏÎÎ¦ ÏÎÎ³ÎÎÎÎÎ» ÏÎÎ¸Î§Î£ÎÎ Î·ÎºÏ ÎÎ¥Î¨ÏÏ ÏÏÎÎÎÏÎ Î½Î²Ï ÏÏÏÎ ÏÎ¶Î±ÎÏ Î±ÎÏÎ¡ÏÎ²Î ÎµÎ¤Î»ÏÎÎµÎ¹Ï Î£ÎÎµÏÎ¥ÎµÎ Î\n   218→- **Logic Rules (Triggers & Impacts)**:\n   219→\n   220→#### **Genioplasty** (`SUR-20`)\n   221→> **Description**: Osteotomy of chin bone to reshape the chin for symmetry and facial balance.\n   222→\n   223→- **Risks/Side Effects**: Î¼ÎÎ¼ÎÎ¿ÏÎ Ï Î¾ÏÎÎÎ¶Î ÎÎ»Î¥Î© ÎÏÎÎ¶Î´Î¦Î¼Î Î¿Î£Î©Î¦ ÎÎÎ¥Î¦Î³ ÎÎÎµÎµÎ£ÏÎ¥ ÎÎÎ¥Î¾ ÎÎÎÎÎ»ÏÎ» ÎÎ¸ÏÎ½ÎµÏ ÎÎ»ÏÏÎ¥ÎÎ² Î¡ÎÎÎÏ ÎÎ´Î¶ÏÏ\n   224→- **Logic Rules (Triggers & Impacts)**:\n   225→\n   226→#### **Lip lift** (`SUR-29`)\n   227→> **Description**: Shorten philtrum by skin removal under nose.\n   228→\n   229→- **Risks/Side Effects**: Î»Î´ÎÏÏÎÎÎ¨ Î¸Î¶Î¼ÎÎµ ÏÎ½Î·Î·Î§ÎºÏ ÎÎ§Î¸ Î¥Î¨ÎÎ³ ÎÎÎºÎ§ÏÏ ÎºÎ¡Î¶Î¶Î¾ÎÎÏ Î Î±Î·Î´Î´ÎÏ ÎºÏÎ¼ Î¡Î´Î½ Î¶Î Î¨Î¹ÎÏÏÎ ÎµÎ£ÎÎÏÎ³Î Î¸Î¾Î©Î¨Î³Î·Î¦\n   230→- **Logic Rules (Triggers & Impacts)**:\n   231→\n   232→### Non-Surgical Treatments (Soft-Maxes)\n   233→\n   234→#### **Jaw fillers** (`NST-05`)\n   235→> **Description**: Injectable fillers to enhance jawline definition, width, and projection.\n   236→\n   237→- **Risks/Side Effects**: Temporary swelling, bruising, asymmetry, lumps, infection, vascular occlusion (rare but vision/necrosis risk), blueish discolouration (if superficial), migration.\n   238→- **Logic Rules (Triggers & Impacts)**:\n   239→    - **Trigger**: \"Weak/soft jaw structure\"\n   240→      - **Impacts**:\n   241→        - `Bigonial width`: increase (2%)\n   242→        - `Ramus to Mandible Ratio`: increase (2%)\n   243→        - `Recession relative to frankfort plane`: increase (2%)\n   244→        - `Lower Third`: increase (2%)\n   245→        - `Lower Third Proportion`: decrease (2%)\n   246→        - `Chin to philtrum ratio`: increase (2%)\n   247→        - `Total Facial Width to Height Ratio`: increase (2%)\n   248→        - `Facial Convexity (Glabella)`: increase (2%)\n   249→        - `Facial Convexity (Nasion)`: increase (2%)\n   250→        - `Total Facial Convexity`: increase (2%)\n   251→        - `Jaw Frontal Angle`: both (2%)\n   252→        - `Nasofacial Angle`: decrease (2%)\n   253→        - `Nasomental Angle`: increase (2%)\n   254→        - `Mentolabial angle`: decrease (2%)\n   255→        - `Gonion to mouth line`: increase (2%)\n   256→        - `Upper Lip S-Line Position`: both (2%)\n   257→        - `Lower Lip S-Line Position`: both (2%)\n   258→        - `Upper Lip E-Line Position`: both (2%)\n   259→        - `Lower Lip E-Line Position`: both (2%)\n   260→        - `Upper Lip Burstone Line`: both (2%)\n   261→        - `Lower Lip Burstone Line`: both (2%)\n   262→        - `Holdaway H Line`: both (2%)\n   263→        - `Jaw Slope`: decrease (2%)\n   264→    - **Trigger**: \"Narrow jaw\"\n   265→      - **Impacts**:\n   266→        - `Bigonial width`: increase (2%)\n   267→        - `Jaw Frontal Angle`: increase (2%)\n   268→        - `Neck Width`: decrease (2%)\n   269→    - **Trigger**: \"Flat jaw\"\n   270→      - **Impacts**:\n   271→        - `Jaw Frontal Angle`: decrease (2%)\n   272→        - `Lower Third`: increase (2%)\n   273→        - `Lower Third Proportion`: decrease (2%)\n   274→        - `Chin to philtrum ratio`: increase (2%)\n   275→        - `Mandibular Plane Angle`: increase (2%)\n   276→        - `Gonial Angle`: increase (2%)\n   277→        - `Jaw Slope`: increase (2%)\n   278→    - **Trigger**: \"Undefined jawline\"\n   279→    - **Trigger**: \"Mandibular recession\"\n   280→      - **Impacts**:\n   281→        - `Recession relative to frankfort plane`: increase (2%)\n   282→        - `Facial Convexity (Glabella)`: increase (2%)\n   283→        - `Facial Convexity (Nasion)`: increase (2%)\n   284→        - `Total Facial Convexity`: increase (2%)\n   285→        - `Upper Lip S-Line Position`: both (2%)\n   286→        - `Lower Lip S-Line Position`: both (2%)\n   287→        - `Upper Lip E-Line Position`: both (2%)\n   288→        - `Lower Lip E-Line Position`: both (2%)\n   289→        - `Upper Lip Burstone Line`: both (2%)\n   290→        - `Lower Lip Burstone Line`: both (2%)\n   291→        - `Holdaway H Line`: both (2%)\n   292→        - `Nasofacial Angle`: decrease (2%)\n   293→        - `Nasomental Angle`: increase (2%)\n   294→        - `Mentolabial angle`: decrease (2%)\n   295→        - `Z Angle`: increase (2%)\n   296→    - **Trigger**: \"Rounder convex facial profile\"\n   297→      - **Impacts**:\n   298→        - `Recession relative to frankfort plane`: increase (2%)\n   299→        - `Facial Convexity (Glabella)`: increase (2%)\n   300→        - `Facial Convexity (Nasion)`: increase (2%)\n   301→        - `Total Facial Convexity`: increase (2%)\n   302→        - `Upper Lip S-Line Position`: both (2%)\n   303→        - `Lower Lip S-Line Position`: both (2%)\n   304→        - `Upper Lip E-Line Position`: both (2%)\n   305→        - `Lower Lip E-Line Position`: both (2%)\n   306→        - `Upper Lip Burstone Line`: both (2%)\n   307→        - `Lower Lip Burstone Line`: both (2%)\n   308→        - `Holdaway H Line`: both (2%)\n   309→        - `Nasofacial Angle`: decrease (2%)\n   310→        - `Nasomental Angle`: increase (2%)\n   311→        - `Mentolabial angle`: decrease (2%)\n   312→    - **Trigger**: \"Underprojected chin\"\n   313→      - **Impacts**:\n   314→        - `Recession relative to frankfort plane`: increase (2%)\n   315→        - `Facial Convexity (Glabella)`: increase (2%)\n   316→        - `Facial Convexity (Nasion)`: increase (2%)\n   317→        - `Total Facial Convexity`: increase (2%)\n   318→        - `Upper Lip S-Line Position`: both (2%)\n   319→        - `Lower Lip S-Line Position`: both (2%)\n   320→        - `Upper Lip E-Line Position`: both (2%)\n   321→        - `Lower Lip E-Line Position`: both (2%)\n   322→        - `Upper Lip Burstone Line`: both (2%)\n   323→        - `Lower Lip Burstone Line`: both (2%)\n   324→        - `Holdaway H Line`: both (2%)\n   325→        - `Nasofacial Angle`: decrease (2%)\n   326→        - `Nasomental Angle`: increase (2%)\n   327→        - `Mentolabial angle`: decrease (2%)\n   328→    - **Trigger**: \"Steep jaw\"\n   329→      - **Impacts**:\n   330→        - `Jaw Frontal Angle`: increase (2%)\n   331→        - `Mandibular Plane Angle`: decrease (2%)\n   332→        - `Gonial Angle`: decrease (2%)\n   333→    - **Trigger**: \"Short ramus\"\n   334→      - **Impacts**:\n   335→        - `Ramus to Mandible Ratio`: increase (2%)\n   336→        - `Gonion to mouth line`: increase (2%)\n   337→        - `Mandibular Plane Angle`: decrease (2%)\n   338→        - `Gonial Angle`: decrease (2%)\n   339→    - **Trigger**: \"Disproportionate lower face (short chin or long philtrum)\"\n   340→      - **Impacts**:\n   341→        - `Total Facial Width to Height Ratio`: increase (2%)\n   342→        - `Chin to philtrum ratio`: increase (2%)\n   343→        - `Lower Third`: increase (2%)\n   344→        - `Lower Third Proportion`: decrease (2%)\n   345→        - `Jaw Frontal Angle`: decrease (2%)\n   346→        - `Mandibular Plane Angle`: increase (2%)\n   347→        - `Gonial Angle`: increase (2%)\n   348→    - **Trigger**: \"Short lower third\"\n   349→      - **Impacts**:\n   350→        - `Ramus to Mandible Ratio`: both (2%)\n   351→        - `Recession relative to frankfort plane`: increase (2%)\n   352→        - `Total Facial Width to Height Ratio`: increase (2%)\n   353→        - `Lower Third`: increase (2%)\n   354→        - `Lower Third Proportion`: decrease (2%)\n   355→        - `Chin to philtrum ratio`: increase (2%)\n   356→        - `Facial Convexity (Glabella)`: increase (2%)\n   357→        - `Facial Convexity (Nasion)`: increase (2%)\n   358→        - `Total Facial Convexity`: increase (2%)\n   359→        - `Jaw Frontal Angle`: decrease (2%)\n   360→        - `Nasofacial Angle`: decrease (2%)\n   361→        - `Nasomental Angle`: increase (2%)\n   362→        - `Mentolabial angle`: decrease (2%)\n   363→        - `Upper lip E-line position`: increase (2%)\n   364→        - `Lower lip E-line position`: increase (2%)\n   365→        - `Upper lip S-line position`: increase (2%)\n   366→        - `Lower lip S-line position`: increase (2%)\n   367→        - `Upper lip Burstone line`: increase (2%)\n   368→        - `Lower lip Burstone line`: increase (2%)\n   369→        - `Holdaway H line`: increase (2%)\n   370→\n   371→#### **Unknown Treatment** (`???`)\n   372→> **Description**: \n   373→\n   374→\n   375→#### **Unknown Treatment** (`???`)\n   376→> **Description**: \n   377→\n   378→\n   379→#### **Kybella (double chin removal)** (`NST-01`)\n   380→> **Description**: Injectable deoxycholic acid to dissolve submental fat.\n   381→\n   382→- **Risks/Side Effects**: Swelling, bruising, numbness, pain, nerve injury, asymmetry.\n   383→- **Logic Rules (Triggers & Impacts)**:\n   384→    - **Trigger**: \"Double chin\"\n   385→      - **Impacts**:\n   386→        - `Submental Cervical Angle`: decrease (2%)\n   387→    - **Trigger**: \"High submental fat\"\n   388→      - **Impacts**:\n   389→        - `Submental Cervical Angle`: decrease (2%)\n   390→    - **Trigger**: \"Undefined jawline\"\n   391→      - **Impacts**:\n   392→        - `Submental Cervical Angle`: decrease (2%)\n   393→\n   394→#### **Cheekbone fillers** (`NST-06`)\n   395→> **Description**: Enhances cheekbone prominence for better facial angularity, harmony, and prominence.\n   396→\n   397→- **Risks/Side Effects**: Temporary swelling, asymmetry risk, bruising, lumps, infection, vascular compromise to retina (rare), nodules/biofilm.\n   398→- **Logic Rules (Triggers & Impacts)**:\n   399→    - **Trigger**: \"Flat & small cheekbones\"\n   400→      - **Impacts**:\n   401→        - `Cheekbone height`: increase (2%)\n   402→        - `Facial width to height ratio`: increase (2%)\n   403→        - `Total Facial Width to Height Ratio`: decrease (2%)\n   404→        - `Bigonial width`: decrease (2%)\n   405→        - `Eye Separation Ratio`: decrease (1%)\n   406→        - `Bitemporal width`: decrease (2%)\n   407→    - **Trigger**: \"Lacking Ogee curve\"\n   408→      - **Impacts**:\n   409→        - `Cheekbone height`: increase (2%)\n   410→        - `Facial width to height ratio`: increase (2%)\n   411→        - `Total Facial Width to Height Ratio`: decrease (2%)\n   412→        - `Bigonial width`: decrease (2%)\n   413→        - `Eye Separation Ratio`: decrease (1%)\n   414→        - `Bitemporal width`: decrease (2%)\n   415→    - **Trigger**: \"Low-set cheekbones\"\n   416→      - **Impacts**:\n   417→        - `Cheekbone height`: increase (2%)\n   418→        - `Facial width to height ratio`: increase (2%)\n   419→        - `Total Facial Width to Height Ratio`: decrease (2%)\n   420→        - `Bigonial width`: decrease (2%)\n   421→        - `Eye Separation Ratio`: decrease (1%)\n   422→        - `Bitemporal width`: decrease (2%)\n   423→    - **Trigger**: \"Medium-set cheekbones\"\n   424→      - **Impacts**:\n   425→        - `Cheekbone height`: increase (2%)\n   426→        - `Facial width to height ratio`: increase (2%)\n   427→        - `Total Facial Width to Height Ratio`: decrease (2%)\n   428→        - `Bigonial width`: decrease (2%)\n   429→        - `Eye Separation Ratio`: decrease (1%)\n   430→        - `Bitemporal width`: decrease (2%)\n   431→    - **Trigger**: \"Overly long face shape\"\n   432→      - **Impacts**:\n   433→        - `Cheekbone height`: increase (2%)\n   434→        - `Facial width to height ratio`: increase (2%)\n   435→        - `Total Facial Width to Height Ratio`: decrease (2%)\n   436→        - `Bigonial width`: decrease (2%)\n   437→        - `Eye Separation Ratio`: decrease (1%)\n   438→        - `Bitemporal width`: decrease (2%)\n   439→    - **Trigger**: \"Long midface\"\n   440→      - **Impacts**:\n   441→        - `Cheekbone height`: increase (2%)\n   442→        - `Facial width to height ratio`: increase (2%)\n   443→        - `Total Facial Width to Height Ratio`: decrease (2%)\n   444→        - `Bigonial width`: decrease (2%)\n   445→        - `Eye Separation Ratio`: decrease (1%)\n   446→        - `Bitemporal width`: decrease (2%)\n   447→    - **Trigger**: \"Wide-set eyes\"\n   448→      - **Impacts**:\n   449→        - `Cheekbone height`: increase (2%)\n   450→        - `Facial width to height ratio`: increase (2%)\n   451→        - `Total Facial Width to Height Ratio`: decrease (2%)\n   452→        - `Bigonial width`: decrease (2%)\n   453→        - `Eye Separation Ratio`: decrease (1%)\n   454→        - `Bitemporal width`: decrease (2%)\n   455→\n   456→#### **Cryolipolysis (fat freezing)** (`NST-04`)\n   457→> **Description**: Noninvasive fat reduction via controlled cooling (e.g., CoolSculpting); targets stubborn subcutaneous fat without surgery. FDA-cleared for abdomen, flanks, thighs, arms, back, and submental area.\n   458→\n   459→- **Risks/Side Effects**: Temporary erythema/swelling, bruising, numbness/paresthesia, pain, edema, paradoxical adipose hyperplasia, frostbite, hyperpigmentation.\n   460→- **Logic Rules (Triggers & Impacts)**:\n   461→    - **Trigger**: \"Double chin\"\n   462→      - **Impacts**:\n   463→        - `Submental Cervical Angle`: decrease (2%)\n   464→    - **Trigger**: \"High submental fat\"\n   465→      - **Impacts**:\n   466→        - `Submental Cervical Angle`: decrease (2%)\n   467→    - **Trigger**: \"Undefined jawline\"\n   468→      - **Impacts**:\n   469→        - `Submental Cervical Angle`: decrease (2%)\n   470→    - **Trigger**: \"Round neck region\"\n   471→      - **Impacts**:\n   472→        - `Submental Cervical Angle`: decrease (2%)\n   473→\n   474→#### **Lip filler** (`NST-08`)\n   475→> **Description**: injectable filler to enhance lip volume, contour and correct asymmetry.\n   476→\n   477→- **Risks/Side Effects**: Swelling, lumps, bruising, asymmetry, vascular occlusion, vascular occlusion; mucosal ulceration if over-filled.\n   478→- **Logic Rules (Triggers & Impacts)**:\n   479→    - **Trigger**: \"Thin upper lip\"\n   480→      - **Impacts**:\n   481→        - `Lip Thickness`: increase (2%)\n   482→        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n   483→        - `Upper Lip S-Line Position`: decrease (2%)\n   484→        - `Upper Lip E-Line Position`: decrease (2%)\n   485→        - `Upper Lip Burstone Line`: decrease (2%)\n   486→        - `Holdaway H Line`: increase (2%)\n   487→        - `Nasolabial angle`: decrease (2%)\n   488→        - `Chin to philtrum ratio`: increase (2%)\n   489→        - `Midface Ratio`: increase (2%)\n   490→        - `Facial Width to Height Ratio`: increase (2%)\n   491→        - `Cupid's Bow Depth`: increase (2%)\n   492→        - `Z Angle`: decrease (2%)\n   493→    - **Trigger**: \"Lacking cupid's bow\"\n   494→      - **Impacts**:\n   495→        - `Cupid's Bow Depth`: increase (2%)\n   496→        - `Lip Thickness`: increase (2%)\n   497→        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n   498→        - `Upper Lip S-Line Position`: decrease (2%)\n   499→        - `Upper Lip E-Line Position`: decrease (2%)\n   500→        - `Upper Lip Burstone Line`: decrease (2%)\n   501→        - `Holdaway H Line`: increase (2%)\n   502→        - `Nasolabial angle`: decrease (2%)\n   503→        - `Chin to philtrum ratio`: increase (2%)\n   504→        - `Midface Ratio`: increase (2%)\n   505→        - `Facial Width to Height Ratio`: increase (2%)\n   506→        - `Z Angle`: decrease (2%)\n   507→    - **Trigger**: \"Thin lower lip\"\n   508→      - **Impacts**:\n   509→        - `Lip Thickness`: increase (2%)\n   510→        - `Lower Lip to Upper Lip Ratio`: increase (2%)\n   511→        - `Lower Lip S-Line Position`: decrease (2%)\n   512→        - `Lower Lip E-Line Position`: decrease (2%)\n   513→        - `Lower Lip Burstone Line`: decrease (2%)\n   514→        - `Holdaway H Line`: decrease (2%)\n   515→        - `Mentolabial angle`: decrease (2%)\n   516→        - `Chin to philtrum ratio`: decrease (2%)\n   517→    - **Trigger**: \"Overly retruded upper lip\"\n   518→      - **Impacts**:\n   519→        - `Lip Thickness`: increase (2%)\n   520→        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n   521→        - `Upper Lip S-Line Position`: decrease (2%)\n   522→        - `Upper Lip E-Line Position`: decrease (2%)\n   523→        - `Upper Lip Burstone Line`: decrease (2%)\n   524→        - `Holdaway H Line`: increase (2%)\n   525→        - `Nasolabial angle`: decrease (2%)\n   526→        - `Chin to philtrum ratio`: increase (2%)\n   527→        - `Midface Ratio`: increase (2%)\n   528→        - `Facial Width to Height Ratio`: increase (2%)\n   529→        - `Cupid's Bow Depth`: increase (2%)\n   530→        - `Z Angle`: decrease (2%)\n   531→    - **Trigger**: \"Overly retruded lower lip\"\n   532→      - **Impacts**:\n   533→        - `Lip Thickness`: increase (2%)\n   534→        - `Lower Lip to Upper Lip Ratio`: increase (2%)\n   535→        - `Lower Lip S-Line Position`: decrease (2%)\n   536→        - `Lower Lip E-Line Position`: decrease (2%)\n   537→        - `Lower Lip Burstone Line`: decrease (2%)\n   538→        - `Holdaway H Line`: decrease (2%)\n   539→        - `Mentolabial angle`: decrease (2%)\n   540→        - `Chin to philtrum ratio`: decrease (2%)\n   541→    - **Trigger**: \"Mouth asymmetry\"\n   542→    - **Trigger**: \"Disproportionate lower face (short chin or long philtrum)\"\n   543→      - **Impacts**:\n   544→        - `Lip Thickness`: increase (2%)\n   545→        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n   546→        - `Upper Lip S-Line Position`: decrease (2%)\n   547→        - `Upper Lip E-Line Position`: decrease (2%)\n   548→        - `Upper Lip Burstone Line`: decrease (2%)\n   549→        - `Holdaway H Line`: increase (2%)\n   550→        - `Nasolabial angle`: decrease (2%)\n   551→        - `Chin to philtrum ratio`: increase (2%)\n   552→        - `Midface Ratio`: increase (2%)\n   553→        - `Facial Width to Height Ratio`: increase (2%)\n   554→    - **Trigger**: \"Disproportionate lower face (long chin or short philtrum)\"\n   555→      - **Impacts**:\n   556→        - `Lip Thickness`: increase (2%)\n   557→        - `Lower Lip to Upper Lip Ratio`: increase (2%)\n   558→        - `Lower Lip S-Line Position`: decrease (2%)\n   559→        - `Lower Lip E-Line Position`: decrease (2%)\n   560→        - `Lower Lip Burstone Line`: decrease (2%)\n   561→        - `Holdaway H Line`: decrease (2%)\n   562→        - `Mentolabial angle`: decrease (2%)\n   563→        - `Chin to philtrum ratio`: decrease (2%)\n   564→    - **Trigger**: \"Long midface\"\n   565→      - **Impacts**:\n   566→        - `Lip Thickness`: increase (2%)\n   567→        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n   568→        - `Upper Lip S-Line Position`: decrease (2%)\n   569→        - `Upper Lip E-Line Position`: decrease (2%)\n   570→        - `Upper Lip Burstone Line`: decrease (2%)\n   571→        - `Holdaway H Line`: increase (2%)\n   572→        - `Nasolabial angle`: decrease (2%)\n   573→        - `Chin to philtrum ratio`: increase (2%)\n   574→        - `Midface Ratio`: increase (2%)\n   575→        - `Facial Width to Height Ratio`: increase (2%)\n   576→\n   577→### Lifestyle & Habits\n   578→\n   579→#### **Unknown Treatment** (`???`)\n   580→> **Description**: \n   581→\n   582→\n   583→#### **Unknown Treatment** (`???`)\n   584→> **Description**: \n   585→\n   586→\n   587→#### **Unknown Treatment** (`???`)\n   588→> **Description**: \n   589→\n   590→\n   591→#### **Unknown Treatment** (`???`)\n   592→> **Description**: \n   593→\n   594→\n   595→#### **Unknown Treatment** (`???`)\n   596→> **Description**: \n   597→\n   598→\n   599→#### **Unknown Treatment** (`???`)\n   600→> **Description**: \n   601→\n   602→\n   603→#### **Unknown Treatment** (`???`)\n   604→> **Description**: \n   605→\n   606→\n   607→### Cosmetics & Enhancement\n   608→\n   609→#### **Unknown Treatment** (`???`)\n   610→> **Description**: \n   611→\n   612→\n   613→#### **Unknown Treatment** (`???`)\n   614→> **Description**: \n   615→\n   616→\n   617→#### **Unknown Treatment** (`???`)\n   618→> **Description**: \n   619→\n   620→\n   621→#### **Unknown Treatment** (`???`)\n   622→> **Description**: \n   623→\n   624→\n   625→#### **Unknown Treatment** (`???`)\n   626→> **Description**: \n   627→\n   628→\n   629→### Hair Restoration\n   630→\n   631→#### **Unknown Treatment** (`???`)\n   632→> **Description**: \n   633→\n   634→\n   635→#### **Unknown Treatment** (`???`)\n   636→> **Description**: \n   637→\n   638→\n   639→#### **Unknown Treatment** (`???`)\n   640→> **Description**: \n   641→\n   642→\n   643→#### **Unknown Treatment** (`???`)\n   644→> **Description**: \n   645→\n   646→\n   647→#### **Unknown Treatment** (`???`)\n   648→> **Description**: \n   649→\n   650→\n   651→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f9f12f52-7ac5-40ce-87ca-8684aebe4086","timestamp":"2025-12-26T14:49:50.626Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/FACEIQPAID/LOGIC/logic_report.md","content":"# FaceIQ Comprehensive Logic Report\n\nThis report details the logic used by the application to recommend treatments, including Surgeries, Soft-Maxes (NST), and Lifestyle changes. It also documents the specific impacts these treatments have on facial scoring.\n\n## 1. Trigger Logic Map (Flaw -> Treatments)\nThe following table maps specific Flaws to recommended Treatments.\n\n| Flaw (Trigger) | Recommended Treatment | Category |\n| :--- | :--- | :--- |\n| Disproportionate lower face (long chin or short philtrum) | Lip filler | NST |\n| Disproportionate lower face (short chin or long philtrum) | Jaw fillers | NST |\n| Disproportionate lower face (short chin or long philtrum) | Lip filler | NST |\n| Double chin | Cryolipolysis (fat freezing) | NST |\n| Double chin | Kybella (double chin removal) | NST |\n| Flat & small cheekbones | Cheekbone fillers | NST |\n| Flat jaw | Jaw fillers | NST |\n| High submental fat | Cryolipolysis (fat freezing) | NST |\n| High submental fat | Kybella (double chin removal) | NST |\n| Lacking Ogee curve | Cheekbone fillers | NST |\n| Lacking cupid's bow | Lip filler | NST |\n| Long midface | Cheekbone fillers | NST |\n| Long midface | Lip filler | NST |\n| Low-set cheekbones | Cheekbone fillers | NST |\n| Mandibular recession | Jaw fillers | NST |\n| Medium-set cheekbones | Cheekbone fillers | NST |\n| Mouth asymmetry | Lip filler | NST |\n| Narrow jaw | Jaw fillers | NST |\n| Overly long face shape | Cheekbone fillers | NST |\n| Overly retruded lower lip | Lip filler | NST |\n| Overly retruded upper lip | Lip filler | NST |\n| Round neck region | Cryolipolysis (fat freezing) | NST |\n| Rounder convex facial profile | Jaw fillers | NST |\n| Short lower third | Jaw fillers | NST |\n| Short ramus | Jaw fillers | NST |\n| Steep jaw | Jaw fillers | NST |\n| Thin lower lip | Lip filler | NST |\n| Thin upper lip | Lip filler | NST |\n| Undefined jawline | Cryolipolysis (fat freezing) | NST |\n| Undefined jawline | Jaw fillers | NST |\n| Undefined jawline | Kybella (double chin removal) | NST |\n| Underprojected chin | Jaw fillers | NST |\n| Weak/soft jaw structure | Jaw fillers | NST |\n| Wide-set eyes | Cheekbone fillers | NST |\n\n---\n\n## 2. Comprehensive Treatment Library\n### Surgical Procedures\n\n#### **Facial liposuction** (`SUR-36`)\n> **Description**: Removes excess fat from face for contouring, often chin/jawline/temples.\n\n- **Risks/Side Effects**: ÎÎ§Î¼ÏÏÎ¨Î£Î£ Î¸Î©ÎÎºÏÎ½ ÏÎ²ÏÎ ÎÎ¤Î¦Î½Î² Î¼ÎÎµÎÎÎ¿ÎÎ ÎµÎ·Ï Î¦ÎÎÏÎÎ¨ ÏÏÎ¦Î Î¤ÎÏÏÎ§Î§ ÏÎÏÎ¡ ÏÏÎ Î© ÎÎ¾Î Î³ÎÏ ÎÎ¹Î¥ÎÎ Î©ÎÎ¥ Î·ÏÎÎ¶ÎÎÎ± Î¦Î¹Î³ÏÏ ÏÎ¦ÏÎÎµÏÎ© ÎÎ¨ÏÎ¨ Î·ÏÎÏ Î³ÎÏÎ¨Î¾Î²Î»Î» Î£Î©Î¦Î¡ ÏÎµÎ»Î¹Î ÎÎ ÎµÎ¥Î·Îº Î¥Î Î¸ÏÏÎ¨Î· ÎÎÎ±ÎÎ·Î´Ï Î\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Canthopexy** (`SUR-33`)\n> **Description**: Tightens lower eyelid to prevent sagging and support eye shape.\n\n- **Risks/Side Effects**: ÏÏÏÎ¹ÎÎ¡ÎÎ¿ Î¹Î¨Ï Î¶ÏÏ ÎÎ²ÏÎÎ¥ ÏÎÎ ÎÎ¦ÎºÏÎ ÎÏÎº Î·Î£Î» ÎÎ¾Î Î§ÎºÎ Î±Î½ÎÎÎ¹Î½Î£ ÏÎÎ²ÏÎ»ÎÎ§Î Î½Î¦ÎÏ ÎÏÏÎ ÎÎÎÎ ÏÎÎ¾ÎÎ£ÎÎ Î¨ÎºÎÎµÎ ÎÎÎ¥Î·Î Î¹ÎÎ¤Î¨Î¨ Î½ÏÎÎÎÎ¹Î ÏÎÎ ÏÎ¨ÎÎÎ¸Î³Î¶Î¦ ÏÎÎ¾Î³ Î©Î¡ÏÎ±Î½Î¸Î·Î½ ÎÎ¿Î¿ ÎÎµÎ² ÏÏÎÎ¹Î³ ÏÎ§Î¹ ÏÏ\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Canthoplasty** (`SUR-25`)\n> **Description**: Targets the corners of the eye to alter the shape, tilt, and size of the eyes.\n\n- **Risks/Side Effects**: ÏÎÏÎÎ¦ÎÎ Î Î¸Î·ÎÎÏÎÎºÏ ÏÏÎÎ²Î¿Î»Ï Î¡ÏÎÎÏÏÏÎ¥ ÏÏÎÎÎ  ÎÎºÎ¦Ï Î ÏÎ¹ÎÏÎ» Î³Î¤Î Î Î¡ÎÎ»Î Î³Î¸Î´Î£Î ÏÎ³ÎÎ§Î¿ ÏÎ¼ÎÎ²Î·Î ÎÎÎ¸ÎÎ¡ÏÎ¼ ÎÎ¤Î¦ Î¥ÎÎ¶Î ÎµÎ´ÎÎÎ© ÎÎÎÎ±Î±Î¦ÎÎ ÎÎÏÎ¥ÎÎ Î³ Î¶ÏÎ ÎÎÎ± ÎÎÎ©Î©ÎÎÎ²Î\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **ÏÏÎ¿ÎÏÎ ÎÎ½Î¾ ÎÎÎ¤ÎÎÏÎ** (`SUR-35`)\n> **Description**: Î½ÏÎ Î ÎÎÎ¥Î Î¨Î¼Ï ÏÎ´ÎÎ¸Î¤Î¿ ÏÎ Ï ÏÏÎºÎÎÏ Î³ÎÎ¸ÎÏÎÎ±Î Î Î±ÏÎÎÎ²Î£Î ÎºÎ²Î§Î»ÎÎ¶Ï Î³Î³Î±ÎÎºÎ³ÎÎ¨ Î½ÎÎºÎÎ ÎÎ¼Î Î¦ÎÎ ÏÎ¾Î³Î·Î¼Î ÏÏÎÎÏÎÎ  Î ÎÏÏÎ ÏÎ³ ÏÏÎ½Î¸Î\n\n- **Risks/Side Effects**: Î·Î¿ÏÎÎ Î³ÎÎ² Î¾ÎÎ Î´Î¼ÎÎÎ ÎÎ¤Îµ ÎÎ¿ÎÎ·ÏÎÎ¤Î¤ Î³Î»Ï Î£ÏÎ¸ÎÎ½ÏÎ§Î ÏÏÎ¦ ÏÏÏÎ¹Î Î·ÏÎÏÎ Î£Î¤Î Î¼ Î¶Î¨Î¤ Î±ÎÎ¹Î¹Î± ÏÎÎÎ£ÏÏÏÎ ÎÎ»ÏÎÎ ÎÏÎ² ÎÎ¸ÎÎ¤Î±Î Î Î¡ÏÎ¨ÎÎÎ³ Î±Î½Î²Î Î±ÏÎ¤ÏÎ¿ Î¨Î¿Î¦Î¹Î¾ ÏÏÎÎ¶ ÏÎ¹ÏÏÎ´ÏÎ¹Î ÎÎ¹ÎÎ¼ Î Î¹Ï ÎÎÎ£Î±ÎÎ ÎÏÎ¾\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Chin implants** (`SUR-07`)\n> **Description**: Implants to specifically enhance chin projection and shape.\n\n- **Risks/Side Effects**: ÏÎ¸Î¨Î²Î½Î¤Î¦Î± Î¾ÎµÎ§Î´Î¹ÎÏ ÏÎÎÎ ÎÎÎ¨ Î§ÎÎÎÎÎ¶Î¸ ÏÏÎÎ¤Î¦ ÎÏÎ¤ ÎºÎÎ©ÎÎ£Î¶Î» Î¤ÏÎ³ÎÎ©Î± Î¡ÎÎ¨Î¡Î§Î¡ Î¶Î²Î³ÏÎ¿Î Î£ÏÎ¨Î Î§Î±Î¹Î£ÎÎ»Ï Î´Î³ÎÎÎ¤Î Î¡ ÏÎÎ ÎÎÏÏÎÏ Î·Î©Î¥ÏÏ Î£Î¾Î¹ÎÎ·Ï ÏÎ¡ÎÎ¤ÏÏÎ¨Î¦ Î´ÎÏÎÎ· ÎÎÎÏÎ»\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Fat grafting** (`SUR-09`)\n> **Description**: Fat is harvested from the patient and processed. Microfat is for volume enhancement. Nanofat is for facial/skin rejuvenation.\n\n- **Risks/Side Effects**: ÎµÎÎÎÎ¡Î¾ÎÎ Î¸Î¾Î¸Î£Î³ÏÎÏ Î¼ÎÎ¤Î£ÏÎ¨Î·Î Î·Î±Î·ÎÎ Î³Î»Î§ÎÎ¡ Î¥Î·Î§ÎÎÏÎµÏ ÎÎÎÎÎ¨ÏÎ§ Î©ÏÏÎº ÏÎÎ± ÏÎ©ÎÎÎ¶Î¶ÎÎ§ Î»Î Î ÏÎ¤Î  Î²Î©Î¶Î» Î£Î¤ÎÎ¥Î´Î¤Î ÎÎ¥Î½Î±Î¿Ï Î½Î¥ÎÎ¸Î Î¶Î±Î¥Î¶Î¤ÎÏÎ¸ Î¼ÎµÎ¦Î»Î¸ÎÎÎ¥ ÏÎ»ÏÎ¿ÎÏÎ»Î£ Î´ÏÎ¥Î ÏÏÎÎ¨ÎÎ²Î ÎÎÎ Î»Î Î¿Î¥ÎÏÏÎ¿Î±Ï ÎÎ¿Î¸ÎÎÎ ÎÎ¥ÏÎ¼ÎºÎµ Î¸ÎÎ¤ÏÎ ÏÎÏÎ¾ÎÏÎ Î½Î©ÎÎ¤ Î©Î¥ÎÎ¼ÎÎÏÎ¤ ÎÎÎ·Î¦Î ÎÎ±ÎÎ²ÏÎÎºÎ© Î¦Î²ÎÎÏÎ» ÏÏÎ§ÏÎ§Î¾ Î·Î³Î¤ÎÎ¤Î§ Î¥Î¸Î´Î¼Î³ÎÎ· ÎÎ©ÏÏÎ ÏÎ§Î¸Î Î¾Î¼Î¾Î©ÎÎ´Î» ÎµÎ§ÎÏÎ¸Î ÎÎ¡ÏÎÎ¶Î¿Î¶Î ÎÎ¡ÎºÎ¿ÏÎ Î³Ï Î¡ÏÎÏÎ§ Î²ÎÏÎ¹ÎÎ¶ ÎÏÎ»ÏÎ¡ ÎÎÎ´ Î¶ÏÎ¹ÏÎ¦Î Î¹ Î¼Î£ÎÏ ÏÎ¡Î¦Î»ÏÎ½ÏÎ¡ ÎÎ©Î±ÎÎ½ÎÎ³Ï ÏÎ·Î¿ÎÎ¥ ÏÎ§Î ÎÎ\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Jaw implants** (`SUR-17`)\n> **Description**: Implants to enhance/ augment jaw bone for a prominent jawline.\n\n- **Risks/Side Effects**: Î¨ÏÎÏÎµÎ¾ÏÎ Î»Î¶ÎÎ Î Î¿Î¦Î¥Î´ ÎÎ¡Î¥ÎÎµÎ¾Î¹ Î»ÎÎÏÎ ÏÎÎ¸Î¾ ÎÎ¾ÎÎ¨Î³ÏÎÎ ÎÎ§ÏÎ Î³ÎÎ¥ÏÎ¥ÏÎ Î¾Î³ÏÏÎÏÏÎ\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Jaw reduction surgery** (`SUR-34`)\n> **Description**: Reshapes jawbone to slim and contour the lower face, often for V-line effect.\n\n- **Risks/Side Effects**: ÎºÎ©ÏÎ Î²Î¡ÏÏ Î¼ÎÎ§ÎµÎ¡Î¼ ÎÎ³Î£ ÏÎ¥Îµ ÎÎ·ÎÎºÎ·ÎÎÎ ÎÏÎÏ ÎµÏÎ Î¸Î¸Î¦ Î¡Î´Î²ÏÎ¼Î Î¨ÎÎ¸ÎÎ´Î§ Î¡ÎÏÎ¶Î Ï Î´Î»ÏÎ¾ ÏÏÎ¡ÏÎ² ÏÎÏÏ ÎÏÎ£Î±ÎµÎ·Î²Î Î¿ÏÏÎ¸Î´Î  ÎÎ´ÏÎÎÎº Î¶ÎÎÏÎ¨ÎÎ ÏÏÎÎ©Î»ÎºÎ ÎÏÎ¤ÎÎ¥ÎÎÎ ÏÎ¾ÎÎÏÏ Î¦Î·ÎÎ¸ÏÎÎ» ÎÎÏÎ±Î ÎÎ§Î Î´ Î±Î¡ÎÏÎ Î·ÎÎ¿ÎÎ·ÏÎ¤Î¶ Î»ÎÎÎ±Î·Î¿ ÏÎÎ Î¿Î²Î ÎÎ¦Î£Î ÎÎ¦ÎÎÎ»ÎÏÎ ÎÎ¸Î¼ÏÎ§Ï Î»Î»ÏÎ§Îº ÏÎ¦ÎÎ¡Î¦ÎÎ©Ï Î¤Î´Î¾Î¦ Î ÏÎÎ¦ÎºÎ¦ Î·ÎÎ¨ÎµÏ ÎÎÎ·Î Î¨Î¥Ï ÎÎ¤ÎÎ´ÎÎÎ»Î¼ ÏÎ¶Î»ÎÎ¥Ï Î´ÎÎÏÎÎÏÎ¡ ÎÏÏÎÎ¹ÎÎ¿ ÏÎ ÏÎ¸Î¸Î¾ÏÎ½\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Bimaxillary osteotomy** (`SUR-13`)\n> **Description**: Reposition both the jaws for facial balance and remove any misalignment.\n\n- **Risks/Side Effects**: ÎÎ Î¦Î Î·ÎÎ¾Î· Î»ÏÎÎ Î¼ÏÎ¹ÎÎ¾ Î¶ÎÎÎ· ÏÎÎ³Î¿ Î¦Î²ÎÎÏ ÎÎ½Î´ Î¤ÏÎÎ¨Î¨ÎÎÎ¸ ÏÎÎÎ¦Î·Î¡ÎÎ¨ ÎÏÏÎ¨ÎÎÎ¶ ÎÎÎ¤ÏÏÎÏ Î½Î¥ÏÎ·ÎÎÎ§Î¨ Î¿ÏÎ§Î¥ Î ÎÎÎ¹Î¦Î¥Î» ÏÎ¿Î·Î¦ÏÎ³ ÏÎ¿Î ÎÎÎ ÎµÎ³ÎÎÎÎ Î¹Î¹ÏÎ§Î§ ÎÎÎÎÎÎ¡ Î¡ÏÎ·Î¡Î\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Neck lift** (`SUR-21`)\n> **Description**: Comprehensive procedure that removes excess skin and lifts the neck skin May include “Submental Tuck” (muscle/skin tightening) or “Submental Liposuction” (fat removal)\n\n- **Risks/Side Effects**: Î¤ÎÎÎ¾Î¤ÎÎÏ Î½Î¤ÏÎ¥Î±Î¼ÎÎ© Î¼ÎÎ½Î²ÎÏÎÎ Î¤Î£Î Î³ÏÎ¸Î ÎÎÏÎÎ¸ Î´ÎÏÏ Î¼Î¨Î¹Î¨ÎÏÎ¨Î Î¤Î±ÎÎÎÎµÎ Î¸Î¤Î©Î¹Î¼ Î©ÎÎÎÎÎÏÎ Î¼ÏÎ¼Î·ÎÎ±Î  ÎÏÎ´Î·ÎÎÎ¡Î½ Î¸ÎÎ¶Î£Î£ ÎºÎÎ¾ÎÎ¤Î\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Midface implants** (`SUR-06`)\n> **Description**: Implants to enhance and augment midface projection.\n\n- **Risks/Side Effects**: ÏÎÎ·Î¿Î©ÏÎÎµ Î¼ÏÎ·ÏÎ¥Î¼Î± ÎºÎÎºÎ±Î§Î½Ï Î±ÏÎÎ³Î Î¤ÏÎ¨ÏÎÎ¡ ÎÎ§Î´ÏÏÎ½ Î§Î¨Î³ Î§Î±ÏÎ ÎÏÎºÎ»ÎÎµÎÎ¦ ÎÎ¹Î¾Î¿Î Î¦ÎÎµÎ Î·Î²Î£ ÎÎ¼ÎÎÎÎÎ¡ ÎÎ¹ÎÎ Î¼ÏÎÏÎ¸Î§Î Î¿Î£Î§ÎÎ§ÎÎÎ© Î¿Î½Î³ÎÎ¥\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Î¶Î¿ÎÎÎ¶Ï Î¸ÏÎ»ÎµÎÎÎÎ³ ÎÏ** (`SUR-39`)\n> **Description**: Î¨Î»Î½Î ÎÎ½Î¿ÎÎ»ÎÎ¼ Î¸Î¥Î Î¤ Î³Î¥ÎµÎÏ Î¾ÎÎÎÎ¿ÎÎ¦ ÎÎ¨Î¼ÎÎµÎ¶Î Î¦Î±ÏÎ¿ ÎÎ¿Î´ÏÎÎ¦ÎÎ ÎÎ½ÎºÎ²Î¹ÏÎ¤ ÎÏÎÎ¾Î£ ÏÎ¿ÏÎÎÎÎ¶Ï ÏÎµÎµÎ¥ ÎµÏÎ¦Î±ÎÎÎ¡ ÎÎ½ÏÎ ÎÎÎ¡Î³ÎÏÎ£Î¿ ÏÏÏÏÎ¨ÏÎ§Î¦ ÏÎÎ¸Î Î£ÎÎ¾ÎÏ Î£ÏÎÎ¶ÎÎ£ Î¥Î¾Î ÎÎ¿ ÎÎÎ¹Î¦Î²Î¨Î£ Î©ÏÎ³ÏÎ³ÏÎ³Î§ Î´Î¹ÎÎ±ÎÎ¹ÎÎ Î²Î¹ÎÎÎÎ§ ÏÎ½ÎÎÎ ÏÎÎµÎ Ï ÎÎÎ©Î ÎÏÎ¦Î Î Î£ÏÎÎÏÎ Î¡ÎµÎ´Î¡Ï Î¹Î»ÏÎ¤ÏÎ£ÎÏ ÎÏÎÎ± Î¤ÎÎÏ Î¸ÏÎÎ©Î½ ÏÎ§Î§ÎÎº ÎÎ§Î´Î·ÎÎ ÏÎ£ÎºÎÎÎ³Î±Îµ ÏÏÎÎ²ÏÎ ÏÎ¥ÎÎ¶ÎÎ£Î¨Î  Î ÎÎºÎ³\n\n- **Risks/Side Effects**: Î¡Î¶ÎÎÎÎ±ÏÏ Î»Î¾ÎÎºÎÎÏ ÏÎ¹ÎºÏÏÏÎ£Î¾ ÏÎ¡Î½Î©ÏÎ¹ ÏÏÎÏÎÎ Ï ÎÏÎÎ»Î¸Î ÏÎÎ´ Î²ÎÎ¾ Î¹Î ÎÎ³Î ÏÎµÎ¾Î¸ÏÎ¨ ÎÎÎ Î¶Î¥Î ÎºÎ£ÏÎ´ÎµÎ¹Î¹Î¶ Î¹Î¨Î¸Î¨ Î²Î²ÎÎ½ÎÎ¾Î¹ Î Î£ÏÎ´Î±Î² ÎÎ¿ÏÏÏÏÎº Î»ÎÎÎ¨ Î¦ÎÎÎ¶ÎÎ¼ Î¼ÎÎ ÎÎ»Î Î¼Î¿ ÎÎ§ÎÎÎÎ² ÎÎºÎ£ÎÎÏ Î¤ÏÎ³Î¾ÎÎ·ÎºÎ½ Î¶Î¸Î¶Î Î²Î´Î¶ÏÏÎ¥Î´Î ÏÎ¤Î¦ÎÎÎÎ Î¿ÏÎÎ½ ÎÎ¾ÎÎÎ¦Î¥ ÏÎÏÎ¼ÎÏ ÏÎÎ³Î Î¿ÎÎ´Î±Î¾ ÎºÎ²Î² ÎÏ\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Supraorbital rim implants** (`SUR-22`)\n> **Description**: Implant to enhance the upper orbital hollows for proper orbital definition.\n\n- **Risks/Side Effects**: ÎÎ¡Î±Î³ÏÎÎÏ Î¼ÏÎ»Î© ÎÎ§ÏÎÎÎÏ Î¡ÎºÎºÏÎ¸ÎÎ© Î Î²ÏÎ ÎÎÎ¡ÏÎ¼ ÎÎ§ÎÎÎÎ² ÎÎºÏÎ©Î Î©Î±Ï ÏÎÎ¨ÎÏÎ·ÏÎ Î¸ÎÎºÎ¦Î©Î² ÎÎ¤ÎÎÎ Î¡ÎÎ¥ ÎÎ¾Î¡Î» Î´ÎÎµÎÏ ÎÎ£ÏÎ¸ÎºÎ½Î½Î» ÏÏÏÎ´ÎµÎ» Î¨Î³Î¸ÏÏ Î±ÎÏÏÎ ÎµÎ¹ Î¾ÎÎ±ÎÎ¹ ÎÎÎ¡Î´Î  Î¸Î¸ÎÏ ÏÎ Î¼Î¦Î³ÎÎÎ ÎÏÎÎ²Î±ÏÎÎ± ÎÎ¤ÏÎ±Î½Î\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Submental liposuction** (`SUR-38`)\n> **Description**: Removes excess fat beneath the chin to refine the jawline and improve neck contour.\n\n- **Risks/Side Effects**: ÎÎ»Î¶Î¶Î£Î¼Î¥Îº Î¸Î Î ÏÎÎ³Î¼Î Î¹Î¿ÎµÏÎÎ´Ï Î±ÎÎÎ»ÎÎ¼Ï ÏÎÎ ÏÎÎ¦ÏÎ²Î  Î¨ÏÎÎ¹Îº Î©Î¨ÎÎ³ Î²ÏÎ§Î¨Î²Î ÎÎ¦ÎÏÏÎ¨ ÏÏÎÏÎ¹ ÎÏÎÎÎ¦Î¾ ÎÎÏÎ ÏÎÎÎ¶Îº ÎÎ¨ÏÎ¨Î¤Î£Î¼Î¡ Î Î¿ÏÏ Î¦Î±ÏÎÎ´Î· ÎÎ½ÎÏÎÎÏÎ ÏÎÎ§Î¨Î·Îµ Î¨ÎºÎÎÎ¾Î¦Î¤ ÎÎ¾ÎÎ¤Î Î´ Î·ÎÎ¹Î¼ÏÎ©Î© ÎÎÎ´Î·ÎÏ ÎÏÏÎÏÎ ÎÎÎÎ¼Ï ÎÎÎºÎÎ¥Î¥Î¿Î½ ÏÎ¿ÎÎ¥ÎÎÏÎ ÎµÏÏÏÏÎ ÎÎÎµÎµÎÎ  ÏÏÏÎ¤Î\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Submental tuck (submentoplasty)** (`SUR-11`)\n> **Description**: Direct excision of submental skin/fat with platysma plication; tightens central neck muscles and removes excess tissue and fat. Also called cervicoplasty. Targets submental fullness and laxity via small incision under chin.\n\n- **Risks/Side Effects**: ÎÎÎ¨Î£ÏÎÎ§Î Î¹ÎÎ¡ÏÏÎ½Î© Î¹Î·ÎÎÎÎ³ÏÎ¥ Î¼ÎÎÎ¹ÎÎ¥ Î²ÎÏÏÎ¹Î±ÎÏ Î©ÎÎ³ÎµÎ² ÎÏÎÎÎµÏÎ¼ ÏÎ¶Î½ ÏÎÎºÎ³ ÏÎÎÎ¼Î»ÎÏÎ\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Lip reduction surgery (reduction cheiloplasty)** (`SUR-40`)\n> **Description**: Surgically removes excess lip tissue to reduce lip volume and projection, improving proportion between the lips and surrounding features.\n\n- **Risks/Side Effects**: Î¦ÎÎ¡ÎÎ ÎÎ©Î¡ Î¹ÎÎ§Î¶ ÎÎ¥Î± Î²Î©Î¦Î·Î ÎÏÎ²ÎÎÎÎ³Î³ ÎÎÏ ÎÎÎ²Î±Î¼ÎÎ·Î¿ ÎµÎ¿Î¦ Î¨Î¹ÎºÎ¤ÎÎ¿ ÎºÎ´Î¹ÎÏÎ¤ÏÎ£ ÎÎ´Î´ÏÎ¦Î¿Î£Î¼ Î¥Î¦Î Î»Î³Î¸Î£Î»Î¸ Î¨ÎÎÎ¸ÎÎ½Î¿Ï ÎÎ¡Î·Î¶ ÎÎ£Î¤ÏÎ½Î§Î¿Î§ Î¡Î´ÎºÎ´\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Cheekbone implants** (`SUR-05`)\n> **Description**: Implants to enhance zygomatic prominence.\n\n- **Risks/Side Effects**: Î´ÎÎÎ´ÎÎÏÎ¶ Î»Î¨Î¡ÏÎÎÎ»Î  Î¨Î©Î´Ï Î¿Î¦ÎÎ© Î¹Î´Î¹ÏÎÎ¡ÏÎ ÎÏÎ²Î©Î¥ ÎÎÎ½ÎÎµÎ¡Îº Î²Î¼ÎÎ¹Î Î©Î·Î¾ÏÎ§Î ÎÎ±ÏÎÏÎ·Î´Ï ÎÎºÏÎ¶Î¿Î¹ ÏÏÎÎ¦ ÏÎÎ³ÎÎÎÎÎ» ÏÎÎ¸Î§Î£ÎÎ Î·ÎºÏ ÎÎ¥Î¨ÏÏ ÏÏÎÎÎÏÎ Î½Î²Ï ÏÏÏÎ ÏÎ¶Î±ÎÏ Î±ÎÏÎ¡ÏÎ²Î ÎµÎ¤Î»ÏÎÎµÎ¹Ï Î£ÎÎµÏÎ¥ÎµÎ Î\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Genioplasty** (`SUR-20`)\n> **Description**: Osteotomy of chin bone to reshape the chin for symmetry and facial balance.\n\n- **Risks/Side Effects**: Î¼ÎÎ¼ÎÎ¿ÏÎ Ï Î¾ÏÎÎÎ¶Î ÎÎ»Î¥Î© ÎÏÎÎ¶Î´Î¦Î¼Î Î¿Î£Î©Î¦ ÎÎÎ¥Î¦Î³ ÎÎÎµÎµÎ£ÏÎ¥ ÎÎÎ¥Î¾ ÎÎÎÎÎ»ÏÎ» ÎÎ¸ÏÎ½ÎµÏ ÎÎ»ÏÏÎ¥ÎÎ² Î¡ÎÎÎÏ ÎÎ´Î¶ÏÏ\n- **Logic Rules (Triggers & Impacts)**:\n\n#### **Lip lift** (`SUR-29`)\n> **Description**: Shorten philtrum by skin removal under nose.\n\n- **Risks/Side Effects**: Î»Î´ÎÏÏÎÎÎ¨ Î¸Î¶Î¼ÎÎµ ÏÎ½Î·Î·Î§ÎºÏ ÎÎ§Î¸ Î¥Î¨ÎÎ³ ÎÎÎºÎ§ÏÏ ÎºÎ¡Î¶Î¶Î¾ÎÎÏ Î Î±Î·Î´Î´ÎÏ ÎºÏÎ¼ Î¡Î´Î½ Î¶Î Î¨Î¹ÎÏÏÎ ÎµÎ£ÎÎÏÎ³Î Î¸Î¾Î©Î¨Î³Î·Î¦\n- **Logic Rules (Triggers & Impacts)**:\n\n### Non-Surgical Treatments (Soft-Maxes)\n\n#### **Jaw fillers** (`NST-05`)\n> **Description**: Injectable fillers to enhance jawline definition, width, and projection.\n\n- **Risks/Side Effects**: Temporary swelling, bruising, asymmetry, lumps, infection, vascular occlusion (rare but vision/necrosis risk), blueish discolouration (if superficial), migration.\n- **Logic Rules (Triggers & Impacts)**:\n    - **Trigger**: \"Weak/soft jaw structure\"\n      - **Impacts**:\n        - `Bigonial width`: increase (2%)\n        - `Ramus to Mandible Ratio`: increase (2%)\n        - `Recession relative to frankfort plane`: increase (2%)\n        - `Lower Third`: increase (2%)\n        - `Lower Third Proportion`: decrease (2%)\n        - `Chin to philtrum ratio`: increase (2%)\n        - `Total Facial Width to Height Ratio`: increase (2%)\n        - `Facial Convexity (Glabella)`: increase (2%)\n        - `Facial Convexity (Nasion)`: increase (2%)\n        - `Total Facial Convexity`: increase (2%)\n        - `Jaw Frontal Angle`: both (2%)\n        - `Nasofacial Angle`: decrease (2%)\n        - `Nasomental Angle`: increase (2%)\n        - `Mentolabial angle`: decrease (2%)\n        - `Gonion to mouth line`: increase (2%)\n        - `Upper Lip S-Line Position`: both (2%)\n        - `Lower Lip S-Line Position`: both (2%)\n        - `Upper Lip E-Line Position`: both (2%)\n        - `Lower Lip E-Line Position`: both (2%)\n        - `Upper Lip Burstone Line`: both (2%)\n        - `Lower Lip Burstone Line`: both (2%)\n        - `Holdaway H Line`: both (2%)\n        - `Jaw Slope`: decrease (2%)\n    - **Trigger**: \"Narrow jaw\"\n      - **Impacts**:\n        - `Bigonial width`: increase (2%)\n        - `Jaw Frontal Angle`: increase (2%)\n        - `Neck Width`: decrease (2%)\n    - **Trigger**: \"Flat jaw\"\n      - **Impacts**:\n        - `Jaw Frontal Angle`: decrease (2%)\n        - `Lower Third`: increase (2%)\n        - `Lower Third Proportion`: decrease (2%)\n        - `Chin to philtrum ratio`: increase (2%)\n        - `Mandibular Plane Angle`: increase (2%)\n        - `Gonial Angle`: increase (2%)\n        - `Jaw Slope`: increase (2%)\n    - **Trigger**: \"Undefined jawline\"\n    - **Trigger**: \"Mandibular recession\"\n      - **Impacts**:\n        - `Recession relative to frankfort plane`: increase (2%)\n        - `Facial Convexity (Glabella)`: increase (2%)\n        - `Facial Convexity (Nasion)`: increase (2%)\n        - `Total Facial Convexity`: increase (2%)\n        - `Upper Lip S-Line Position`: both (2%)\n        - `Lower Lip S-Line Position`: both (2%)\n        - `Upper Lip E-Line Position`: both (2%)\n        - `Lower Lip E-Line Position`: both (2%)\n        - `Upper Lip Burstone Line`: both (2%)\n        - `Lower Lip Burstone Line`: both (2%)\n        - `Holdaway H Line`: both (2%)\n        - `Nasofacial Angle`: decrease (2%)\n        - `Nasomental Angle`: increase (2%)\n        - `Mentolabial angle`: decrease (2%)\n        - `Z Angle`: increase (2%)\n    - **Trigger**: \"Rounder convex facial profile\"\n      - **Impacts**:\n        - `Recession relative to frankfort plane`: increase (2%)\n        - `Facial Convexity (Glabella)`: increase (2%)\n        - `Facial Convexity (Nasion)`: increase (2%)\n        - `Total Facial Convexity`: increase (2%)\n        - `Upper Lip S-Line Position`: both (2%)\n        - `Lower Lip S-Line Position`: both (2%)\n        - `Upper Lip E-Line Position`: both (2%)\n        - `Lower Lip E-Line Position`: both (2%)\n        - `Upper Lip Burstone Line`: both (2%)\n        - `Lower Lip Burstone Line`: both (2%)\n        - `Holdaway H Line`: both (2%)\n        - `Nasofacial Angle`: decrease (2%)\n        - `Nasomental Angle`: increase (2%)\n        - `Mentolabial angle`: decrease (2%)\n    - **Trigger**: \"Underprojected chin\"\n      - **Impacts**:\n        - `Recession relative to frankfort plane`: increase (2%)\n        - `Facial Convexity (Glabella)`: increase (2%)\n        - `Facial Convexity (Nasion)`: increase (2%)\n        - `Total Facial Convexity`: increase (2%)\n        - `Upper Lip S-Line Position`: both (2%)\n        - `Lower Lip S-Line Position`: both (2%)\n        - `Upper Lip E-Line Position`: both (2%)\n        - `Lower Lip E-Line Position`: both (2%)\n        - `Upper Lip Burstone Line`: both (2%)\n        - `Lower Lip Burstone Line`: both (2%)\n        - `Holdaway H Line`: both (2%)\n        - `Nasofacial Angle`: decrease (2%)\n        - `Nasomental Angle`: increase (2%)\n        - `Mentolabial angle`: decrease (2%)\n    - **Trigger**: \"Steep jaw\"\n      - **Impacts**:\n        - `Jaw Frontal Angle`: increase (2%)\n        - `Mandibular Plane Angle`: decrease (2%)\n        - `Gonial Angle`: decrease (2%)\n    - **Trigger**: \"Short ramus\"\n      - **Impacts**:\n        - `Ramus to Mandible Ratio`: increase (2%)\n        - `Gonion to mouth line`: increase (2%)\n        - `Mandibular Plane Angle`: decrease (2%)\n        - `Gonial Angle`: decrease (2%)\n    - **Trigger**: \"Disproportionate lower face (short chin or long philtrum)\"\n      - **Impacts**:\n        - `Total Facial Width to Height Ratio`: increase (2%)\n        - `Chin to philtrum ratio`: increase (2%)\n        - `Lower Third`: increase (2%)\n        - `Lower Third Proportion`: decrease (2%)\n        - `Jaw Frontal Angle`: decrease (2%)\n        - `Mandibular Plane Angle`: increase (2%)\n        - `Gonial Angle`: increase (2%)\n    - **Trigger**: \"Short lower third\"\n      - **Impacts**:\n        - `Ramus to Mandible Ratio`: both (2%)\n        - `Recession relative to frankfort plane`: increase (2%)\n        - `Total Facial Width to Height Ratio`: increase (2%)\n        - `Lower Third`: increase (2%)\n        - `Lower Third Proportion`: decrease (2%)\n        - `Chin to philtrum ratio`: increase (2%)\n        - `Facial Convexity (Glabella)`: increase (2%)\n        - `Facial Convexity (Nasion)`: increase (2%)\n        - `Total Facial Convexity`: increase (2%)\n        - `Jaw Frontal Angle`: decrease (2%)\n        - `Nasofacial Angle`: decrease (2%)\n        - `Nasomental Angle`: increase (2%)\n        - `Mentolabial angle`: decrease (2%)\n        - `Upper lip E-line position`: increase (2%)\n        - `Lower lip E-line position`: increase (2%)\n        - `Upper lip S-line position`: increase (2%)\n        - `Lower lip S-line position`: increase (2%)\n        - `Upper lip Burstone line`: increase (2%)\n        - `Lower lip Burstone line`: increase (2%)\n        - `Holdaway H line`: increase (2%)\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Kybella (double chin removal)** (`NST-01`)\n> **Description**: Injectable deoxycholic acid to dissolve submental fat.\n\n- **Risks/Side Effects**: Swelling, bruising, numbness, pain, nerve injury, asymmetry.\n- **Logic Rules (Triggers & Impacts)**:\n    - **Trigger**: \"Double chin\"\n      - **Impacts**:\n        - `Submental Cervical Angle`: decrease (2%)\n    - **Trigger**: \"High submental fat\"\n      - **Impacts**:\n        - `Submental Cervical Angle`: decrease (2%)\n    - **Trigger**: \"Undefined jawline\"\n      - **Impacts**:\n        - `Submental Cervical Angle`: decrease (2%)\n\n#### **Cheekbone fillers** (`NST-06`)\n> **Description**: Enhances cheekbone prominence for better facial angularity, harmony, and prominence.\n\n- **Risks/Side Effects**: Temporary swelling, asymmetry risk, bruising, lumps, infection, vascular compromise to retina (rare), nodules/biofilm.\n- **Logic Rules (Triggers & Impacts)**:\n    - **Trigger**: \"Flat & small cheekbones\"\n      - **Impacts**:\n        - `Cheekbone height`: increase (2%)\n        - `Facial width to height ratio`: increase (2%)\n        - `Total Facial Width to Height Ratio`: decrease (2%)\n        - `Bigonial width`: decrease (2%)\n        - `Eye Separation Ratio`: decrease (1%)\n        - `Bitemporal width`: decrease (2%)\n    - **Trigger**: \"Lacking Ogee curve\"\n      - **Impacts**:\n        - `Cheekbone height`: increase (2%)\n        - `Facial width to height ratio`: increase (2%)\n        - `Total Facial Width to Height Ratio`: decrease (2%)\n        - `Bigonial width`: decrease (2%)\n        - `Eye Separation Ratio`: decrease (1%)\n        - `Bitemporal width`: decrease (2%)\n    - **Trigger**: \"Low-set cheekbones\"\n      - **Impacts**:\n        - `Cheekbone height`: increase (2%)\n        - `Facial width to height ratio`: increase (2%)\n        - `Total Facial Width to Height Ratio`: decrease (2%)\n        - `Bigonial width`: decrease (2%)\n        - `Eye Separation Ratio`: decrease (1%)\n        - `Bitemporal width`: decrease (2%)\n    - **Trigger**: \"Medium-set cheekbones\"\n      - **Impacts**:\n        - `Cheekbone height`: increase (2%)\n        - `Facial width to height ratio`: increase (2%)\n        - `Total Facial Width to Height Ratio`: decrease (2%)\n        - `Bigonial width`: decrease (2%)\n        - `Eye Separation Ratio`: decrease (1%)\n        - `Bitemporal width`: decrease (2%)\n    - **Trigger**: \"Overly long face shape\"\n      - **Impacts**:\n        - `Cheekbone height`: increase (2%)\n        - `Facial width to height ratio`: increase (2%)\n        - `Total Facial Width to Height Ratio`: decrease (2%)\n        - `Bigonial width`: decrease (2%)\n        - `Eye Separation Ratio`: decrease (1%)\n        - `Bitemporal width`: decrease (2%)\n    - **Trigger**: \"Long midface\"\n      - **Impacts**:\n        - `Cheekbone height`: increase (2%)\n        - `Facial width to height ratio`: increase (2%)\n        - `Total Facial Width to Height Ratio`: decrease (2%)\n        - `Bigonial width`: decrease (2%)\n        - `Eye Separation Ratio`: decrease (1%)\n        - `Bitemporal width`: decrease (2%)\n    - **Trigger**: \"Wide-set eyes\"\n      - **Impacts**:\n        - `Cheekbone height`: increase (2%)\n        - `Facial width to height ratio`: increase (2%)\n        - `Total Facial Width to Height Ratio`: decrease (2%)\n        - `Bigonial width`: decrease (2%)\n        - `Eye Separation Ratio`: decrease (1%)\n        - `Bitemporal width`: decrease (2%)\n\n#### **Cryolipolysis (fat freezing)** (`NST-04`)\n> **Description**: Noninvasive fat reduction via controlled cooling (e.g., CoolSculpting); targets stubborn subcutaneous fat without surgery. FDA-cleared for abdomen, flanks, thighs, arms, back, and submental area.\n\n- **Risks/Side Effects**: Temporary erythema/swelling, bruising, numbness/paresthesia, pain, edema, paradoxical adipose hyperplasia, frostbite, hyperpigmentation.\n- **Logic Rules (Triggers & Impacts)**:\n    - **Trigger**: \"Double chin\"\n      - **Impacts**:\n        - `Submental Cervical Angle`: decrease (2%)\n    - **Trigger**: \"High submental fat\"\n      - **Impacts**:\n        - `Submental Cervical Angle`: decrease (2%)\n    - **Trigger**: \"Undefined jawline\"\n      - **Impacts**:\n        - `Submental Cervical Angle`: decrease (2%)\n    - **Trigger**: \"Round neck region\"\n      - **Impacts**:\n        - `Submental Cervical Angle`: decrease (2%)\n\n#### **Lip filler** (`NST-08`)\n> **Description**: injectable filler to enhance lip volume, contour and correct asymmetry.\n\n- **Risks/Side Effects**: Swelling, lumps, bruising, asymmetry, vascular occlusion, vascular occlusion; mucosal ulceration if over-filled.\n- **Logic Rules (Triggers & Impacts)**:\n    - **Trigger**: \"Thin upper lip\"\n      - **Impacts**:\n        - `Lip Thickness`: increase (2%)\n        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n        - `Upper Lip S-Line Position`: decrease (2%)\n        - `Upper Lip E-Line Position`: decrease (2%)\n        - `Upper Lip Burstone Line`: decrease (2%)\n        - `Holdaway H Line`: increase (2%)\n        - `Nasolabial angle`: decrease (2%)\n        - `Chin to philtrum ratio`: increase (2%)\n        - `Midface Ratio`: increase (2%)\n        - `Facial Width to Height Ratio`: increase (2%)\n        - `Cupid's Bow Depth`: increase (2%)\n        - `Z Angle`: decrease (2%)\n    - **Trigger**: \"Lacking cupid's bow\"\n      - **Impacts**:\n        - `Cupid's Bow Depth`: increase (2%)\n        - `Lip Thickness`: increase (2%)\n        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n        - `Upper Lip S-Line Position`: decrease (2%)\n        - `Upper Lip E-Line Position`: decrease (2%)\n        - `Upper Lip Burstone Line`: decrease (2%)\n        - `Holdaway H Line`: increase (2%)\n        - `Nasolabial angle`: decrease (2%)\n        - `Chin to philtrum ratio`: increase (2%)\n        - `Midface Ratio`: increase (2%)\n        - `Facial Width to Height Ratio`: increase (2%)\n        - `Z Angle`: decrease (2%)\n    - **Trigger**: \"Thin lower lip\"\n      - **Impacts**:\n        - `Lip Thickness`: increase (2%)\n        - `Lower Lip to Upper Lip Ratio`: increase (2%)\n        - `Lower Lip S-Line Position`: decrease (2%)\n        - `Lower Lip E-Line Position`: decrease (2%)\n        - `Lower Lip Burstone Line`: decrease (2%)\n        - `Holdaway H Line`: decrease (2%)\n        - `Mentolabial angle`: decrease (2%)\n        - `Chin to philtrum ratio`: decrease (2%)\n    - **Trigger**: \"Overly retruded upper lip\"\n      - **Impacts**:\n        - `Lip Thickness`: increase (2%)\n        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n        - `Upper Lip S-Line Position`: decrease (2%)\n        - `Upper Lip E-Line Position`: decrease (2%)\n        - `Upper Lip Burstone Line`: decrease (2%)\n        - `Holdaway H Line`: increase (2%)\n        - `Nasolabial angle`: decrease (2%)\n        - `Chin to philtrum ratio`: increase (2%)\n        - `Midface Ratio`: increase (2%)\n        - `Facial Width to Height Ratio`: increase (2%)\n        - `Cupid's Bow Depth`: increase (2%)\n        - `Z Angle`: decrease (2%)\n    - **Trigger**: \"Overly retruded lower lip\"\n      - **Impacts**:\n        - `Lip Thickness`: increase (2%)\n        - `Lower Lip to Upper Lip Ratio`: increase (2%)\n        - `Lower Lip S-Line Position`: decrease (2%)\n        - `Lower Lip E-Line Position`: decrease (2%)\n        - `Lower Lip Burstone Line`: decrease (2%)\n        - `Holdaway H Line`: decrease (2%)\n        - `Mentolabial angle`: decrease (2%)\n        - `Chin to philtrum ratio`: decrease (2%)\n    - **Trigger**: \"Mouth asymmetry\"\n    - **Trigger**: \"Disproportionate lower face (short chin or long philtrum)\"\n      - **Impacts**:\n        - `Lip Thickness`: increase (2%)\n        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n        - `Upper Lip S-Line Position`: decrease (2%)\n        - `Upper Lip E-Line Position`: decrease (2%)\n        - `Upper Lip Burstone Line`: decrease (2%)\n        - `Holdaway H Line`: increase (2%)\n        - `Nasolabial angle`: decrease (2%)\n        - `Chin to philtrum ratio`: increase (2%)\n        - `Midface Ratio`: increase (2%)\n        - `Facial Width to Height Ratio`: increase (2%)\n    - **Trigger**: \"Disproportionate lower face (long chin or short philtrum)\"\n      - **Impacts**:\n        - `Lip Thickness`: increase (2%)\n        - `Lower Lip to Upper Lip Ratio`: increase (2%)\n        - `Lower Lip S-Line Position`: decrease (2%)\n        - `Lower Lip E-Line Position`: decrease (2%)\n        - `Lower Lip Burstone Line`: decrease (2%)\n        - `Holdaway H Line`: decrease (2%)\n        - `Mentolabial angle`: decrease (2%)\n        - `Chin to philtrum ratio`: decrease (2%)\n    - **Trigger**: \"Long midface\"\n      - **Impacts**:\n        - `Lip Thickness`: increase (2%)\n        - `Lower Lip to Upper Lip Ratio`: decrease (2%)\n        - `Upper Lip S-Line Position`: decrease (2%)\n        - `Upper Lip E-Line Position`: decrease (2%)\n        - `Upper Lip Burstone Line`: decrease (2%)\n        - `Holdaway H Line`: increase (2%)\n        - `Nasolabial angle`: decrease (2%)\n        - `Chin to philtrum ratio`: increase (2%)\n        - `Midface Ratio`: increase (2%)\n        - `Facial Width to Height Ratio`: increase (2%)\n\n### Lifestyle & Habits\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n### Cosmetics & Enhancement\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n### Hair Restoration\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n#### **Unknown Treatment** (`???`)\n> **Description**: \n\n\n","numLines":651,"startLine":1,"totalLines":651}}}
{"parentUuid":"f9f12f52-7ac5-40ce-87ca-8684aebe4086","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TfeD8dmi9rtmZFJyn4dMxy","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a good understanding of the codebase. The reference file doesn't have a specific \"Section 6: Treatment Exclusivity\" but I can see the FaceIQ treatment categories from the surgical procedures mentioned. Let me now implement the mutually exclusive treatment categories."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":29631,"cache_creation_input_tokens":18960,"cache_read_input_tokens":26739,"cache_creation":{"ephemeral_5m_input_tokens":18960,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVV4KR7vwUvWBfcfm8Fp","type":"assistant","uuid":"a52c7c42-c757-4dd1-8afc-119850fae1d1","timestamp":"2025-12-26T14:49:58.242Z"}
{"parentUuid":"a52c7c42-c757-4dd1-8afc-119850fae1d1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TfeD8dmi9rtmZFJyn4dMxy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017fcWs8X7ieTUtuHfFPsw9Y","name":"TodoWrite","input":{"todos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"in_progress","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"pending","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"pending","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"pending","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":29631,"cache_creation_input_tokens":18960,"cache_read_input_tokens":26739,"cache_creation":{"ephemeral_5m_input_tokens":18960,"ephemeral_1h_input_tokens":0},"output_tokens":288,"service_tier":"standard"}},"requestId":"req_011CWVV4KR7vwUvWBfcfm8Fp","type":"assistant","uuid":"d7fb7e62-81e9-467d-8c12-03da010bd031","timestamp":"2025-12-26T14:50:01.400Z"}
{"parentUuid":"d7fb7e62-81e9-467d-8c12-03da010bd031","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017fcWs8X7ieTUtuHfFPsw9Y","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"94c2b313-5dfe-455c-b452-42fbc7223d61","timestamp":"2025-12-26T14:50:01.462Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"in_progress","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"pending","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"pending","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"pending","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}]}}
{"parentUuid":"94c2b313-5dfe-455c-b452-42fbc7223d61","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LQsaNjjdtVUexRoV5thwMJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MKQqoTAG2Au3c5Ktf2r2w5","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/types.ts","old_string":"export interface Treatment {\n  id: string;\n  name: string;\n  category: TreatmentCategory;\n  description: string;\n  howItWorks: string;\n\n  // Effectiveness\n  effectiveness: number; // 1-10\n  evidenceLevel: EvidenceLevel;\n  pslImprovement: { min: number; max: number };\n\n  // Costs\n  costLevel: CostLevel;\n  costRange: { min: number; max: number; currency: string };\n  costFrequency: 'one-time' | 'monthly' | 'per-session' | 'annual';\n\n  // Timeline\n  timelineToResults: string;\n  resultsDuration: string;\n  maintenanceRequired: boolean;\n  maintenanceFrequency?: string;\n\n  // Recovery\n  recoveryTime: string;\n  downtime: string;\n  painLevel: 'none' | 'low' | 'moderate' | 'high';\n\n  // Risk\n  riskLevel: RiskLevel;\n  sideEffects: string[];\n  contraindications: string[];\n\n  // Applicability\n  targetMetrics: string[];\n  targetIssues: string[];\n  genderSpecific?: Gender;\n  ageRestrictions?: { min?: number; max?: number };\n\n  // Additional info\n  notes?: string[];\n  sources?: string[];\n}","new_string":"/**\n * Exclusive treatment category identifiers\n * Used to group treatments that are mutually exclusive\n */\nexport type ExclusiveCategory =\n  | 'jaw_augmentation'      // Jaw implants, jaw fillers (cannot combine with jaw reduction)\n  | 'jaw_reduction'         // V-line surgery, masseter botox (cannot combine with jaw augmentation)\n  | 'chin_augmentation'     // Chin implants, genioplasty, chin filler, fat grafting to chin (pick ONE)\n  | 'cheekbone_augmentation' // Cheek fillers, cheek implants (pick ONE)\n  | 'lip_augmentation'      // Lip filler, lip fat grafting (cannot combine with lip reduction)\n  | 'lip_reduction'         // Lip reduction surgery (cannot combine with lip augmentation)\n  | 'submental_fat_removal' // Kybella, cryolipolysis, submental liposuction (pick ONE for submental)\n  | 'neck_procedures'       // Neck lift, submentoplasty (overlapping procedures)\n  | 'eye_lateral_canthus'   // Canthoplasty, canthopexy (pick ONE for lateral canthus)\n  | 'maxillary_surgery';    // Bimaxillary osteotomy, LeFort (comprehensive - supersedes others)\n\nexport interface Treatment {\n  id: string;\n  name: string;\n  category: TreatmentCategory;\n  description: string;\n  howItWorks: string;\n\n  // Effectiveness\n  effectiveness: number; // 1-10\n  evidenceLevel: EvidenceLevel;\n  pslImprovement: { min: number; max: number };\n\n  // Costs\n  costLevel: CostLevel;\n  costRange: { min: number; max: number; currency: string };\n  costFrequency: 'one-time' | 'monthly' | 'per-session' | 'annual';\n\n  // Timeline\n  timelineToResults: string;\n  resultsDuration: string;\n  maintenanceRequired: boolean;\n  maintenanceFrequency?: string;\n\n  // Recovery\n  recoveryTime: string;\n  downtime: string;\n  painLevel: 'none' | 'low' | 'moderate' | 'high';\n\n  // Risk\n  riskLevel: RiskLevel;\n  sideEffects: string[];\n  contraindications: string[];\n\n  // Applicability\n  targetMetrics: string[];\n  targetIssues: string[];\n  genderSpecific?: Gender;\n  ageRestrictions?: { min?: number; max?: number };\n\n  // Treatment exclusivity\n  exclusiveCategory?: ExclusiveCategory;  // Category this treatment belongs to\n  exclusiveWith?: string[];               // Specific treatment IDs that conflict\n\n  // Additional info\n  notes?: string[];\n  sources?: string[];\n}"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":29953,"cache_read_input_tokens":45699,"cache_creation":{"ephemeral_5m_input_tokens":29953,"ephemeral_1h_input_tokens":0},"output_tokens":1153,"service_tier":"standard"}},"requestId":"req_011CWVV58CxCinGVkboDcBAx","type":"assistant","uuid":"3f92d5f9-3fc9-4841-9879-9083294a90f9","timestamp":"2025-12-26T14:50:21.702Z"}
{"parentUuid":"3f92d5f9-3fc9-4841-9879-9083294a90f9","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MKQqoTAG2Au3c5Ktf2r2w5","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/types.ts has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    29→// ============================================\n    30→// TREATMENT TYPES\n    31→// ============================================\n    32→\n    33→/**\n    34→ * Exclusive treatment category identifiers\n    35→ * Used to group treatments that are mutually exclusive\n    36→ */\n    37→export type ExclusiveCategory =\n    38→  | 'jaw_augmentation'      // Jaw implants, jaw fillers (cannot combine with jaw reduction)\n    39→  | 'jaw_reduction'         // V-line surgery, masseter botox (cannot combine with jaw augmentation)\n    40→  | 'chin_augmentation'     // Chin implants, genioplasty, chin filler, fat grafting to chin (pick ONE)\n    41→  | 'cheekbone_augmentation' // Cheek fillers, cheek implants (pick ONE)\n    42→  | 'lip_augmentation'      // Lip filler, lip fat grafting (cannot combine with lip reduction)\n    43→  | 'lip_reduction'         // Lip reduction surgery (cannot combine with lip augmentation)\n    44→  | 'submental_fat_removal' // Kybella, cryolipolysis, submental liposuction (pick ONE for submental)\n    45→  | 'neck_procedures'       // Neck lift, submentoplasty (overlapping procedures)\n    46→  | 'eye_lateral_canthus'   // Canthoplasty, canthopexy (pick ONE for lateral canthus)\n    47→  | 'maxillary_surgery';    // Bimaxillary osteotomy, LeFort (comprehensive - supersedes others)\n    48→\n    49→export interface Treatment {\n    50→  id: string;\n    51→  name: string;\n    52→  category: TreatmentCategory;\n    53→  description: string;\n    54→  howItWorks: string;\n    55→\n    56→  // Effectiveness\n    57→  effectiveness: number; // 1-10\n    58→  evidenceLevel: EvidenceLevel;\n    59→  pslImprovement: { min: number; max: number };\n    60→\n    61→  // Costs\n    62→  costLevel: CostLevel;\n    63→  costRange: { min: number; max: number; currency: string };\n    64→  costFrequency: 'one-time' | 'monthly' | 'per-session' | 'annual';\n    65→\n    66→  // Timeline\n    67→  timelineToResults: string;\n    68→  resultsDuration: string;\n    69→  maintenanceRequired: boolean;\n    70→  maintenanceFrequency?: string;\n    71→\n    72→  // Recovery\n    73→  recoveryTime: string;\n    74→  downtime: string;\n    75→  painLevel: 'none' | 'low' | 'moderate' | 'high';\n    76→\n    77→  // Risk\n    78→  riskLevel: RiskLevel;\n    79→  sideEffects: string[];\n    80→  contraindications: string[];\n    81→\n    82→  // Applicability\n    83→  targetMetrics: string[];\n    84→  targetIssues: string[];\n    85→  genderSpecific?: Gender;\n    86→  ageRestrictions?: { min?: number; max?: number };\n    87→\n    88→  // Treatment exclusivity\n    89→  exclusiveCategory?: ExclusiveCategory;  // Category this treatment belongs to\n    90→  exclusiveWith?: string[];               // Specific treatment IDs that conflict\n    91→\n    92→  // Additional info\n    93→  notes?: string[];\n    94→  sources?: string[];\n    95→}\n    96→\n    97→export interface Surgery extends Treatment {\n    98→  category: 'surgical';\n    99→  surgeonRecommendations?: SurgeonInfo[];"}]},"uuid":"3ab77b47-5137-409b-9005-2f3809078c42","timestamp":"2025-12-26T14:50:21.756Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/types.ts","oldString":"export interface Treatment {\n  id: string;\n  name: string;\n  category: TreatmentCategory;\n  description: string;\n  howItWorks: string;\n\n  // Effectiveness\n  effectiveness: number; // 1-10\n  evidenceLevel: EvidenceLevel;\n  pslImprovement: { min: number; max: number };\n\n  // Costs\n  costLevel: CostLevel;\n  costRange: { min: number; max: number; currency: string };\n  costFrequency: 'one-time' | 'monthly' | 'per-session' | 'annual';\n\n  // Timeline\n  timelineToResults: string;\n  resultsDuration: string;\n  maintenanceRequired: boolean;\n  maintenanceFrequency?: string;\n\n  // Recovery\n  recoveryTime: string;\n  downtime: string;\n  painLevel: 'none' | 'low' | 'moderate' | 'high';\n\n  // Risk\n  riskLevel: RiskLevel;\n  sideEffects: string[];\n  contraindications: string[];\n\n  // Applicability\n  targetMetrics: string[];\n  targetIssues: string[];\n  genderSpecific?: Gender;\n  ageRestrictions?: { min?: number; max?: number };\n\n  // Additional info\n  notes?: string[];\n  sources?: string[];\n}","newString":"/**\n * Exclusive treatment category identifiers\n * Used to group treatments that are mutually exclusive\n */\nexport type ExclusiveCategory =\n  | 'jaw_augmentation'      // Jaw implants, jaw fillers (cannot combine with jaw reduction)\n  | 'jaw_reduction'         // V-line surgery, masseter botox (cannot combine with jaw augmentation)\n  | 'chin_augmentation'     // Chin implants, genioplasty, chin filler, fat grafting to chin (pick ONE)\n  | 'cheekbone_augmentation' // Cheek fillers, cheek implants (pick ONE)\n  | 'lip_augmentation'      // Lip filler, lip fat grafting (cannot combine with lip reduction)\n  | 'lip_reduction'         // Lip reduction surgery (cannot combine with lip augmentation)\n  | 'submental_fat_removal' // Kybella, cryolipolysis, submental liposuction (pick ONE for submental)\n  | 'neck_procedures'       // Neck lift, submentoplasty (overlapping procedures)\n  | 'eye_lateral_canthus'   // Canthoplasty, canthopexy (pick ONE for lateral canthus)\n  | 'maxillary_surgery';    // Bimaxillary osteotomy, LeFort (comprehensive - supersedes others)\n\nexport interface Treatment {\n  id: string;\n  name: string;\n  category: TreatmentCategory;\n  description: string;\n  howItWorks: string;\n\n  // Effectiveness\n  effectiveness: number; // 1-10\n  evidenceLevel: EvidenceLevel;\n  pslImprovement: { min: number; max: number };\n\n  // Costs\n  costLevel: CostLevel;\n  costRange: { min: number; max: number; currency: string };\n  costFrequency: 'one-time' | 'monthly' | 'per-session' | 'annual';\n\n  // Timeline\n  timelineToResults: string;\n  resultsDuration: string;\n  maintenanceRequired: boolean;\n  maintenanceFrequency?: string;\n\n  // Recovery\n  recoveryTime: string;\n  downtime: string;\n  painLevel: 'none' | 'low' | 'moderate' | 'high';\n\n  // Risk\n  riskLevel: RiskLevel;\n  sideEffects: string[];\n  contraindications: string[];\n\n  // Applicability\n  targetMetrics: string[];\n  targetIssues: string[];\n  genderSpecific?: Gender;\n  ageRestrictions?: { min?: number; max?: number };\n\n  // Treatment exclusivity\n  exclusiveCategory?: ExclusiveCategory;  // Category this treatment belongs to\n  exclusiveWith?: string[];               // Specific treatment IDs that conflict\n\n  // Additional info\n  notes?: string[];\n  sources?: string[];\n}","originalFile":"/**\n * Recommendation System Types\n * Comprehensive type definitions for looksmaxxing recommendations\n */\n\n// ============================================\n// ENUMS & BASIC TYPES\n// ============================================\n\nexport type Severity = 'optimal' | 'mild' | 'moderate' | 'severe';\n\nexport type TreatmentCategory =\n  | 'lifestyle'\n  | 'softmaxxing'\n  | 'non_surgical'\n  | 'minimally_invasive'\n  | 'surgical';\n\nexport type CostLevel = 'free' | 'low' | 'medium' | 'high' | 'very_high';\n\nexport type EvidenceLevel = 'strong' | 'moderate' | 'weak' | 'anecdotal';\n\nexport type RiskLevel = 'none' | 'very_low' | 'low' | 'medium' | 'high' | 'very_high';\n\nexport type Gender = 'male' | 'female';\n\nexport type ProfileType = 'front' | 'side';\n\n// ============================================\n// TREATMENT TYPES\n// ============================================\n\nexport interface Treatment {\n  id: string;\n  name: string;\n  category: TreatmentCategory;\n  description: string;\n  howItWorks: string;\n\n  // Effectiveness\n  effectiveness: number; // 1-10\n  evidenceLevel: EvidenceLevel;\n  pslImprovement: { min: number; max: number };\n\n  // Costs\n  costLevel: CostLevel;\n  costRange: { min: number; max: number; currency: string };\n  costFrequency: 'one-time' | 'monthly' | 'per-session' | 'annual';\n\n  // Timeline\n  timelineToResults: string;\n  resultsDuration: string;\n  maintenanceRequired: boolean;\n  maintenanceFrequency?: string;\n\n  // Recovery\n  recoveryTime: string;\n  downtime: string;\n  painLevel: 'none' | 'low' | 'moderate' | 'high';\n\n  // Risk\n  riskLevel: RiskLevel;\n  sideEffects: string[];\n  contraindications: string[];\n\n  // Applicability\n  targetMetrics: string[];\n  targetIssues: string[];\n  genderSpecific?: Gender;\n  ageRestrictions?: { min?: number; max?: number };\n\n  // Additional info\n  notes?: string[];\n  sources?: string[];\n}\n\nexport interface Surgery extends Treatment {\n  category: 'surgical';\n  surgeonRecommendations?: SurgeonInfo[];\n  regionalCosts: RegionalCost[];\n  revisionRate?: number;\n  permanence: 'permanent' | 'semi-permanent' | 'temporary';\n  hospitalStay?: string;\n  anesthesiaType: 'local' | 'sedation' | 'general';\n}\n\nexport interface SurgeonInfo {\n  name: string;\n  location: string;\n  specialty: string;\n  costRange: string;\n  notes?: string;\n}\n\nexport interface RegionalCost {\n  region: string;\n  min: number;\n  max: number;\n  currency: string;\n  notes?: string;\n}\n\nexport interface Supplement {\n  id: string;\n  name: string;\n  category: 'skin' | 'hair' | 'bone' | 'hormonal' | 'anti-aging' | 'general';\n  description: string;\n\n  // Dosage\n  dosage: string;\n  frequency: string;\n  timing?: string; // e.g., \"with meals\", \"before bed\"\n\n  // Effectiveness\n  effectiveness: number; // 1-10\n  evidenceLevel: EvidenceLevel;\n\n  // Cost\n  costPerMonth: { min: number; max: number };\n\n  // Timeline\n  timelineToResults: string;\n\n  // Safety\n  riskLevel: RiskLevel;\n  sideEffects: string[];\n  interactions: string[];\n  contraindications: string[];\n\n  // Applicability\n  targetBenefits: string[];\n  requiresPrescription: boolean;\n\n  notes?: string[];\n  sources?: string[];\n}\n\n// ============================================\n// SEVERITY & SCORING\n// ============================================\n\nexport interface SeverityThreshold {\n  metric: string;\n  optimal: { min: number; max: number };\n  mild: { min: number; max: number };\n  moderate: { min: number; max: number };\n  severe: { min: number; max: number };\n  unit: string;\n  higherIsBetter?: boolean;\n}\n\nexport interface SeverityResult {\n  severity: Severity;\n  label: string;\n  color: string;\n  icon: string;\n  description: string;\n}\n\n// ============================================\n// RECOMMENDATION ENGINE TYPES\n// ============================================\n\nexport interface MetricAnalysis {\n  metricId: string;\n  metricName: string;\n  currentValue: number;\n  idealValue: number;\n  idealRange: { min: number; max: number };\n  deviation: number;\n  deviationPercent: number;\n  score: number;\n  severity: SeverityResult;\n  issue?: string;\n  profileType: ProfileType;\n}\n\nexport interface TreatmentRecommendation {\n  treatment: Treatment | Surgery | Supplement;\n  priority: 'high' | 'medium' | 'low';\n  relevanceScore: number; // 0-100\n  targetMetrics: string[];\n  estimatedImprovement: number;\n  reasoning: string;\n}\n\nexport interface RecommendationPlan {\n  // Summary\n  overallScore: number;\n  overallSeverity: SeverityResult;\n  harmonyScore: number;\n  percentile: number;\n\n  // Analysis\n  metricAnalyses: MetricAnalysis[];\n  strengths: MetricAnalysis[];\n  weaknesses: MetricAnalysis[];\n\n  // Recommendations by category\n  lifestyle: TreatmentRecommendation[];\n  softmaxxing: TreatmentRecommendation[];\n  nonSurgical: TreatmentRecommendation[];\n  minimallyInvasive: TreatmentRecommendation[];\n  surgical: TreatmentRecommendation[];\n  supplements: TreatmentRecommendation[];\n\n  // Potential\n  currentPSL: number;\n  potentialPSL: number;\n  potentialImprovement: number;\n\n  // Order of operations\n  orderOfOperations: OrderOfOperation[];\n}\n\nexport interface OrderOfOperation {\n  step: number;\n  category: TreatmentCategory;\n  treatment: Treatment | Surgery;\n  reasoning: string;\n  prerequisites?: string[];\n  waitTime?: string;\n}\n\n// ============================================\n// METRIC TO ISSUE MAPPING\n// ============================================\n\nexport interface MetricIssueMapping {\n  metric: string;\n  lowIssue: string;\n  highIssue: string;\n  lowTreatments: string[];\n  highTreatments: string[];\n}\n\n// ============================================\n// PSL RATING SYSTEM\n// ============================================\n\nexport interface PSLRating {\n  score: number;\n  tier: string;\n  percentile: number;\n  description: string;\n}\n\nexport const PSL_TIERS: PSLRating[] = [\n  { score: 7.5, tier: 'Top Model', percentile: 99.99, description: 'Near perfection - world-class genetics' },\n  { score: 7.0, tier: 'Chad', percentile: 99.87, description: 'Exceptional - top 0.1%' },\n  { score: 6.5, tier: 'Chadlite', percentile: 99.0, description: 'Very attractive - top 1%' },\n  { score: 6.0, tier: 'High Tier Normie+', percentile: 97.25, description: 'Notably attractive - top 3%' },\n  { score: 5.5, tier: 'High Tier Normie', percentile: 90.0, description: 'Above average - top 10%' },\n  { score: 5.0, tier: 'Mid Tier Normie+', percentile: 84.15, description: 'Slightly above average' },\n  { score: 4.5, tier: 'Mid Tier Normie', percentile: 65.0, description: 'Average' },\n  { score: 4.0, tier: 'Low Tier Normie', percentile: 50.0, description: 'Median' },\n  { score: 3.5, tier: 'Below Average', percentile: 30.0, description: 'Below average' },\n  { score: 3.0, tier: 'Subpar', percentile: 15.0, description: 'Noticeably below average' },\n];\n","structuredPatch":[{"oldStart":30,"oldLines":6,"newStart":30,"newLines":22,"lines":[" // TREATMENT TYPES"," // ============================================"," ","+/**","+ * Exclusive treatment category identifiers","+ * Used to group treatments that are mutually exclusive","+ */","+export type ExclusiveCategory =","+  | 'jaw_augmentation'      // Jaw implants, jaw fillers (cannot combine with jaw reduction)","+  | 'jaw_reduction'         // V-line surgery, masseter botox (cannot combine with jaw augmentation)","+  | 'chin_augmentation'     // Chin implants, genioplasty, chin filler, fat grafting to chin (pick ONE)","+  | 'cheekbone_augmentation' // Cheek fillers, cheek implants (pick ONE)","+  | 'lip_augmentation'      // Lip filler, lip fat grafting (cannot combine with lip reduction)","+  | 'lip_reduction'         // Lip reduction surgery (cannot combine with lip augmentation)","+  | 'submental_fat_removal' // Kybella, cryolipolysis, submental liposuction (pick ONE for submental)","+  | 'neck_procedures'       // Neck lift, submentoplasty (overlapping procedures)","+  | 'eye_lateral_canthus'   // Canthoplasty, canthopexy (pick ONE for lateral canthus)","+  | 'maxillary_surgery';    // Bimaxillary osteotomy, LeFort (comprehensive - supersedes others)","+"," export interface Treatment {","   id: string;","   name: string;"]},{"oldStart":69,"oldLines":6,"newStart":85,"newLines":10,"lines":["   genderSpecific?: Gender;","   ageRestrictions?: { min?: number; max?: number };"," ","+  // Treatment exclusivity","+  exclusiveCategory?: ExclusiveCategory;  // Category this treatment belongs to","+  exclusiveWith?: string[];               // Specific treatment IDs that conflict","+","   // Additional info","   notes?: string[];","   sources?: string[];"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"3ab77b47-5137-409b-9005-2f3809078c42","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Bu61cZbt8ZvYv3mU2jRmsC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DaPxJn8VMcee81Pk7iDMCD","name":"TodoWrite","input":{"todos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"in_progress","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"pending","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"pending","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2197,"cache_read_input_tokens":75652,"cache_creation":{"ephemeral_5m_input_tokens":2197,"ephemeral_1h_input_tokens":0},"output_tokens":222,"service_tier":"standard"}},"requestId":"req_011CWVV6cHgNbGZxdJ7uJ8Lr","type":"assistant","uuid":"3af91ef9-010f-46b0-901f-5bfe23313fff","timestamp":"2025-12-26T14:50:27.805Z"}
{"parentUuid":"3af91ef9-010f-46b0-901f-5bfe23313fff","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DaPxJn8VMcee81Pk7iDMCD","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"649591c5-a6f1-43d5-90c1-98046261e606","timestamp":"2025-12-26T14:50:27.862Z","toolUseResult":{"oldTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"in_progress","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"pending","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"pending","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"pending","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}],"newTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"in_progress","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"pending","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"pending","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}]}}
{"parentUuid":"649591c5-a6f1-43d5-90c1-98046261e606","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_011CJbb9ZkcxChCPHZru56Pn","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me add the exclusivity data to the treatments in advice-engine.ts. I need to add a new section with exclusivity mappings and then update the PLANS array:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":77849,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVV74Yzgyrhc466Vj9QR","type":"assistant","uuid":"1e563196-76da-4884-b555-3f9591cd3d74","timestamp":"2025-12-26T14:50:33.582Z"}
{"parentUuid":"1e563196-76da-4884-b555-3f9591cd3d74","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_011CJbb9ZkcxChCPHZru56Pn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WNLP73a7tCLT2a72iQ5V75","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts","old_string":"/**\n * Advice Engine - Client-side implementation matching the Python AdviceEngine\n * Processes plans.json trigger rules against user metrics\n */\n\nimport { Plan } from '@/components/results/cards/PlanActionCard';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface Threshold {\n  operator: '<' | '>';\n  value: number;\n}","new_string":"/**\n * Advice Engine - Client-side implementation matching the Python AdviceEngine\n * Processes plans.json trigger rules against user metrics\n */\n\nimport { Plan } from '@/components/results/cards/PlanActionCard';\nimport type { ExclusiveCategory } from './recommendations/types';\n\n// ============================================\n// TREATMENT EXCLUSIVITY RULES\n// ============================================\n\n/**\n * Treatment exclusivity configuration\n * Based on FaceIQ logic for mutually exclusive procedures\n */\nexport interface TreatmentExclusivity {\n  exclusiveCategory?: ExclusiveCategory;\n  exclusiveWith?: string[];  // Specific treatment IDs that conflict\n}\n\n/**\n * Mapping of treatment IDs to their exclusivity rules\n */\nexport const TREATMENT_EXCLUSIVITY: Record<string, TreatmentExclusivity> = {\n  // ============================================\n  // JAW AUGMENTATION vs REDUCTION\n  // Cannot combine augmentation with reduction\n  // ============================================\n  'jaw_fillers': {\n    exclusiveCategory: 'jaw_augmentation',\n    exclusiveWith: ['jaw_reduction', 'masseter_botox']\n  },\n  'jaw_implants': {\n    exclusiveCategory: 'jaw_augmentation',\n    exclusiveWith: ['jaw_reduction', 'masseter_botox']\n  },\n  'jaw_reduction': {\n    exclusiveCategory: 'jaw_reduction',\n    exclusiveWith: ['jaw_fillers', 'jaw_implants']\n  },\n  'masseter_botox': {\n    exclusiveCategory: 'jaw_reduction',\n    exclusiveWith: ['jaw_fillers', 'jaw_implants']\n  },\n\n  // ============================================\n  // CHIN AUGMENTATION - Pick ONE\n  // Chin implants, genioplasty, fat grafting to chin\n  // ============================================\n  'chin_implant': {\n    exclusiveCategory: 'chin_augmentation',\n    exclusiveWith: ['genioplasty', 'chin_filler', 'fat_grafting']\n  },\n  'genioplasty': {\n    exclusiveCategory: 'chin_augmentation',\n    exclusiveWith: ['chin_implant', 'chin_filler', 'fat_grafting']\n  },\n  'chin_filler': {\n    exclusiveCategory: 'chin_augmentation',\n    exclusiveWith: ['chin_implant', 'genioplasty', 'fat_grafting']\n  },\n\n  // ============================================\n  // CHEEKBONE AUGMENTATION - Pick ONE\n  // Fillers vs implants\n  // ============================================\n  'cheekbone_fillers': {\n    exclusiveCategory: 'cheekbone_augmentation',\n    exclusiveWith: ['midface_implants']\n  },\n  'midface_implants': {\n    exclusiveCategory: 'cheekbone_augmentation',\n    exclusiveWith: ['cheekbone_fillers']\n  },\n\n  // ============================================\n  // LIP AUGMENTATION vs REDUCTION\n  // ============================================\n  'lip_filler': {\n    exclusiveCategory: 'lip_augmentation',\n    exclusiveWith: ['lip_reduction']\n  },\n  'lip_reduction': {\n    exclusiveCategory: 'lip_reduction',\n    exclusiveWith: ['lip_filler']\n  },\n\n  // ============================================\n  // SUBMENTAL/NECK FAT REMOVAL - Pick ONE\n  // Kybella, cryolipolysis, submental liposuction\n  // ============================================\n  'kybella': {\n    exclusiveCategory: 'submental_fat_removal',\n    exclusiveWith: ['cryolipolysis', 'submental_liposuction']\n  },\n  'cryolipolysis': {\n    exclusiveCategory: 'submental_fat_removal',\n    exclusiveWith: ['kybella', 'submental_liposuction']\n  },\n  'submental_liposuction': {\n    exclusiveCategory: 'submental_fat_removal',\n    exclusiveWith: ['kybella', 'cryolipolysis']\n  },\n\n  // ============================================\n  // NECK PROCEDURES - Overlapping\n  // Neck lift supersedes submentoplasty\n  // ============================================\n  'neck_lift': {\n    exclusiveCategory: 'neck_procedures',\n    exclusiveWith: ['submentoplasty']  // Neck lift includes submentoplasty\n  },\n  'submentoplasty': {\n    exclusiveCategory: 'neck_procedures',\n    exclusiveWith: ['neck_lift']  // If getting neck lift, don't need separate submentoplasty\n  },\n\n  // ============================================\n  // EYE LATERAL CANTHUS - Pick ONE\n  // Canthoplasty vs canthopexy\n  // ============================================\n  'canthoplasty': {\n    exclusiveCategory: 'eye_lateral_canthus',\n    exclusiveWith: ['canthopexy']\n  },\n  'canthopexy': {\n    exclusiveCategory: 'eye_lateral_canthus',\n    exclusiveWith: ['canthoplasty']\n  },\n\n  // ============================================\n  // MAXILLARY SURGERY - Comprehensive\n  // Bimaxillary osteotomy supersedes many other procedures\n  // ============================================\n  'bimaxillary_osteotomy': {\n    exclusiveCategory: 'maxillary_surgery',\n    exclusiveWith: [\n      'genioplasty',        // Chin is repositioned in bimax\n      'chin_implant',       // Redundant after bimax\n      'jaw_implants',       // Jaw position changed\n      'jaw_fillers',        // Temporary vs permanent bone change\n      'rhinoplasty'         // Often combined but distinct - may need sequencing\n    ]\n  }\n};\n\n/**\n * Get exclusivity data for a treatment\n */\nexport function getTreatmentExclusivity(treatmentId: string): TreatmentExclusivity | undefined {\n  return TREATMENT_EXCLUSIVITY[treatmentId];\n}\n\n/**\n * Check if two treatments conflict\n */\nexport function treatmentsConflict(treatmentId1: string, treatmentId2: string): boolean {\n  const exclusivity1 = TREATMENT_EXCLUSIVITY[treatmentId1];\n  const exclusivity2 = TREATMENT_EXCLUSIVITY[treatmentId2];\n\n  // Check direct exclusivity via IDs\n  if (exclusivity1?.exclusiveWith?.includes(treatmentId2)) {\n    return true;\n  }\n  if (exclusivity2?.exclusiveWith?.includes(treatmentId1)) {\n    return true;\n  }\n\n  // Check category-based exclusivity (same category = mutually exclusive)\n  if (\n    exclusivity1?.exclusiveCategory &&\n    exclusivity2?.exclusiveCategory &&\n    exclusivity1.exclusiveCategory === exclusivity2.exclusiveCategory\n  ) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Get all treatments that conflict with a given treatment\n */\nexport function getConflictingTreatments(treatmentId: string): string[] {\n  const conflicts: string[] = [];\n  const exclusivity = TREATMENT_EXCLUSIVITY[treatmentId];\n\n  if (!exclusivity) {\n    return conflicts;\n  }\n\n  // Add direct exclusions\n  if (exclusivity.exclusiveWith) {\n    conflicts.push(...exclusivity.exclusiveWith);\n  }\n\n  // Add treatments from same exclusive category\n  if (exclusivity.exclusiveCategory) {\n    for (const [id, data] of Object.entries(TREATMENT_EXCLUSIVITY)) {\n      if (id !== treatmentId && data.exclusiveCategory === exclusivity.exclusiveCategory) {\n        if (!conflicts.includes(id)) {\n          conflicts.push(id);\n        }\n      }\n    }\n  }\n\n  return conflicts;\n}\n\n/**\n * Human-readable descriptions of why treatments conflict\n */\nexport const CONFLICT_REASONS: Record<ExclusiveCategory, string> = {\n  'jaw_augmentation': 'Jaw augmentation procedures conflict with jaw reduction procedures. Choose one approach.',\n  'jaw_reduction': 'Jaw reduction procedures conflict with jaw augmentation procedures. Choose one approach.',\n  'chin_augmentation': 'Choose one chin augmentation method. Combining implants, genioplasty, or fillers is not recommended.',\n  'cheekbone_augmentation': 'Choose either fillers or implants for cheekbone augmentation, not both.',\n  'lip_augmentation': 'Lip augmentation conflicts with lip reduction. Choose one approach for lip volume.',\n  'lip_reduction': 'Lip reduction conflicts with lip augmentation. Choose one approach for lip volume.',\n  'submental_fat_removal': 'Choose one submental fat removal method. Multiple procedures to the same area increase complication risk.',\n  'neck_procedures': 'Neck lift includes submentoplasty. Having both is redundant and increases risk.',\n  'eye_lateral_canthus': 'Choose either canthoplasty or canthopexy for lateral canthus modification, not both.',\n  'maxillary_surgery': 'Bimaxillary osteotomy is comprehensive and may make other jaw/chin procedures redundant.'\n};\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface Threshold {\n  operator: '<' | '>';\n  value: number;\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":77849,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":2561,"service_tier":"standard"}},"requestId":"req_011CWVV74Yzgyrhc466Vj9QR","type":"assistant","uuid":"c73d4e25-6e0d-43ba-9ab1-f44634715cea","timestamp":"2025-12-26T14:51:00.213Z"}
{"parentUuid":"c73d4e25-6e0d-43ba-9ab1-f44634715cea","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WNLP73a7tCLT2a72iQ5V75","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→/**\n     2→ * Advice Engine - Client-side implementation matching the Python AdviceEngine\n     3→ * Processes plans.json trigger rules against user metrics\n     4→ */\n     5→\n     6→import { Plan } from '@/components/results/cards/PlanActionCard';\n     7→import type { ExclusiveCategory } from './recommendations/types';\n     8→\n     9→// ============================================\n    10→// TREATMENT EXCLUSIVITY RULES\n    11→// ============================================\n    12→\n    13→/**\n    14→ * Treatment exclusivity configuration\n    15→ * Based on FaceIQ logic for mutually exclusive procedures\n    16→ */\n    17→export interface TreatmentExclusivity {\n    18→  exclusiveCategory?: ExclusiveCategory;\n    19→  exclusiveWith?: string[];  // Specific treatment IDs that conflict\n    20→}\n    21→\n    22→/**\n    23→ * Mapping of treatment IDs to their exclusivity rules\n    24→ */\n    25→export const TREATMENT_EXCLUSIVITY: Record<string, TreatmentExclusivity> = {\n    26→  // ============================================\n    27→  // JAW AUGMENTATION vs REDUCTION\n    28→  // Cannot combine augmentation with reduction\n    29→  // ============================================\n    30→  'jaw_fillers': {\n    31→    exclusiveCategory: 'jaw_augmentation',\n    32→    exclusiveWith: ['jaw_reduction', 'masseter_botox']\n    33→  },\n    34→  'jaw_implants': {\n    35→    exclusiveCategory: 'jaw_augmentation',\n    36→    exclusiveWith: ['jaw_reduction', 'masseter_botox']\n    37→  },\n    38→  'jaw_reduction': {\n    39→    exclusiveCategory: 'jaw_reduction',\n    40→    exclusiveWith: ['jaw_fillers', 'jaw_implants']\n    41→  },\n    42→  'masseter_botox': {\n    43→    exclusiveCategory: 'jaw_reduction',\n    44→    exclusiveWith: ['jaw_fillers', 'jaw_implants']\n    45→  },\n    46→\n    47→  // ============================================\n    48→  // CHIN AUGMENTATION - Pick ONE\n    49→  // Chin implants, genioplasty, fat grafting to chin\n    50→  // ============================================\n    51→  'chin_implant': {\n    52→    exclusiveCategory: 'chin_augmentation',\n    53→    exclusiveWith: ['genioplasty', 'chin_filler', 'fat_grafting']\n    54→  },\n    55→  'genioplasty': {\n    56→    exclusiveCategory: 'chin_augmentation',\n    57→    exclusiveWith: ['chin_implant', 'chin_filler', 'fat_grafting']\n    58→  },\n    59→  'chin_filler': {\n    60→    exclusiveCategory: 'chin_augmentation',\n    61→    exclusiveWith: ['chin_implant', 'genioplasty', 'fat_grafting']\n    62→  },\n    63→\n    64→  // ============================================\n    65→  // CHEEKBONE AUGMENTATION - Pick ONE\n    66→  // Fillers vs implants\n    67→  // ============================================\n    68→  'cheekbone_fillers': {\n    69→    exclusiveCategory: 'cheekbone_augmentation',\n    70→    exclusiveWith: ['midface_implants']\n    71→  },\n    72→  'midface_implants': {\n    73→    exclusiveCategory: 'cheekbone_augmentation',\n    74→    exclusiveWith: ['cheekbone_fillers']\n    75→  },\n    76→\n    77→  // ============================================\n    78→  // LIP AUGMENTATION vs REDUCTION\n    79→  // ============================================\n    80→  'lip_filler': {\n    81→    exclusiveCategory: 'lip_augmentation',\n    82→    exclusiveWith: ['lip_reduction']\n    83→  },\n    84→  'lip_reduction': {\n    85→    exclusiveCategory: 'lip_reduction',\n    86→    exclusiveWith: ['lip_filler']\n    87→  },\n    88→\n    89→  // ============================================\n    90→  // SUBMENTAL/NECK FAT REMOVAL - Pick ONE\n    91→  // Kybella, cryolipolysis, submental liposuction\n    92→  // ============================================\n    93→  'kybella': {\n    94→    exclusiveCategory: 'submental_fat_removal',\n    95→    exclusiveWith: ['cryolipolysis', 'submental_liposuction']\n    96→  },\n    97→  'cryolipolysis': {\n    98→    exclusiveCategory: 'submental_fat_removal',\n    99→    exclusiveWith: ['kybella', 'submental_liposuction']\n   100→  },\n   101→  'submental_liposuction': {\n   102→    exclusiveCategory: 'submental_fat_removal',\n   103→    exclusiveWith: ['kybella', 'cryolipolysis']\n   104→  },\n   105→\n   106→  // ============================================\n   107→  // NECK PROCEDURES - Overlapping\n   108→  // Neck lift supersedes submentoplasty\n   109→  // ============================================\n   110→  'neck_lift': {\n   111→    exclusiveCategory: 'neck_procedures',\n   112→    exclusiveWith: ['submentoplasty']  // Neck lift includes submentoplasty\n   113→  },\n   114→  'submentoplasty': {\n   115→    exclusiveCategory: 'neck_procedures',\n   116→    exclusiveWith: ['neck_lift']  // If getting neck lift, don't need separate submentoplasty\n   117→  },\n   118→\n   119→  // ============================================\n   120→  // EYE LATERAL CANTHUS - Pick ONE\n   121→  // Canthoplasty vs canthopexy\n   122→  // ============================================\n   123→  'canthoplasty': {\n   124→    exclusiveCategory: 'eye_lateral_canthus',\n   125→    exclusiveWith: ['canthopexy']\n   126→  },\n   127→  'canthopexy': {\n   128→    exclusiveCategory: 'eye_lateral_canthus',\n   129→    exclusiveWith: ['canthoplasty']\n   130→  },\n   131→\n   132→  // ============================================\n   133→  // MAXILLARY SURGERY - Comprehensive\n   134→  // Bimaxillary osteotomy supersedes many other procedures\n   135→  // ============================================\n   136→  'bimaxillary_osteotomy': {\n   137→    exclusiveCategory: 'maxillary_surgery',\n   138→    exclusiveWith: [\n   139→      'genioplasty',        // Chin is repositioned in bimax\n   140→      'chin_implant',       // Redundant after bimax\n   141→      'jaw_implants',       // Jaw position changed\n   142→      'jaw_fillers',        // Temporary vs permanent bone change\n   143→      'rhinoplasty'         // Often combined but distinct - may need sequencing\n   144→    ]\n   145→  }\n   146→};\n   147→\n   148→/**\n   149→ * Get exclusivity data for a treatment\n   150→ */\n   151→export function getTreatmentExclusivity(treatmentId: string): TreatmentExclusivity | undefined {\n   152→  return TREATMENT_EXCLUSIVITY[treatmentId];\n   153→}\n   154→\n   155→/**\n   156→ * Check if two treatments conflict\n   157→ */\n   158→export function treatmentsConflict(treatmentId1: string, treatmentId2: string): boolean {\n   159→  const exclusivity1 = TREATMENT_EXCLUSIVITY[treatmentId1];\n   160→  const exclusivity2 = TREATMENT_EXCLUSIVITY[treatmentId2];\n   161→\n   162→  // Check direct exclusivity via IDs\n   163→  if (exclusivity1?.exclusiveWith?.includes(treatmentId2)) {\n   164→    return true;\n   165→  }\n   166→  if (exclusivity2?.exclusiveWith?.includes(treatmentId1)) {\n   167→    return true;\n   168→  }\n   169→\n   170→  // Check category-based exclusivity (same category = mutually exclusive)\n   171→  if (\n   172→    exclusivity1?.exclusiveCategory &&\n   173→    exclusivity2?.exclusiveCategory &&\n   174→    exclusivity1.exclusiveCategory === exclusivity2.exclusiveCategory\n   175→  ) {\n   176→    return true;\n   177→  }\n   178→\n   179→  return false;\n   180→}\n   181→\n   182→/**\n   183→ * Get all treatments that conflict with a given treatment\n   184→ */\n   185→export function getConflictingTreatments(treatmentId: string): string[] {\n   186→  const conflicts: string[] = [];\n   187→  const exclusivity = TREATMENT_EXCLUSIVITY[treatmentId];\n   188→\n   189→  if (!exclusivity) {\n   190→    return conflicts;\n   191→  }\n   192→\n   193→  // Add direct exclusions\n   194→  if (exclusivity.exclusiveWith) {\n   195→    conflicts.push(...exclusivity.exclusiveWith);\n   196→  }\n   197→\n   198→  // Add treatments from same exclusive category\n   199→  if (exclusivity.exclusiveCategory) {\n   200→    for (const [id, data] of Object.entries(TREATMENT_EXCLUSIVITY)) {\n   201→      if (id !== treatmentId && data.exclusiveCategory === exclusivity.exclusiveCategory) {\n   202→        if (!conflicts.includes(id)) {\n   203→          conflicts.push(id);\n   204→        }\n   205→      }\n   206→    }\n   207→  }\n   208→\n   209→  return conflicts;\n   210→}\n   211→\n   212→/**\n   213→ * Human-readable descriptions of why treatments conflict\n   214→ */\n   215→export const CONFLICT_REASONS: Record<ExclusiveCategory, string> = {\n   216→  'jaw_augmentation': 'Jaw augmentation procedures conflict with jaw reduction procedures. Choose one approach.',\n   217→  'jaw_reduction': 'Jaw reduction procedures conflict with jaw augmentation procedures. Choose one approach.',\n   218→  'chin_augmentation': 'Choose one chin augmentation method. Combining implants, genioplasty, or fillers is not recommended.',\n   219→  'cheekbone_augmentation': 'Choose either fillers or implants for cheekbone augmentation, not both.',\n   220→  'lip_augmentation': 'Lip augmentation conflicts with lip reduction. Choose one approach for lip volume.',\n   221→  'lip_reduction': 'Lip reduction conflicts with lip augmentation. Choose one approach for lip volume.',\n   222→  'submental_fat_removal': 'Choose one submental fat removal method. Multiple procedures to the same area increase complication risk.',\n   223→  'neck_procedures': 'Neck lift includes submentoplasty. Having both is redundant and increases risk.',\n   224→  'eye_lateral_canthus': 'Choose either canthoplasty or canthopexy for lateral canthus modification, not both.',\n   225→  'maxillary_surgery': 'Bimaxillary osteotomy is comprehensive and may make other jaw/chin procedures redundant.'\n   226→};\n   227→\n   228→// ============================================\n   229→// TYPES\n   230→// ============================================\n   231→\n   232→interface Threshold {\n   233→  operator: '<' | '>';\n   234→  value: number;\n   235→}\n   236→\n   237→interface TriggerRules {\n   238→  metrics: string[];\n   239→  condition: 'OR' | 'AND';"}]},"uuid":"39e47730-0bc6-4834-a7e5-5a72d8f980fe","timestamp":"2025-12-26T14:51:00.276Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts","oldString":"/**\n * Advice Engine - Client-side implementation matching the Python AdviceEngine\n * Processes plans.json trigger rules against user metrics\n */\n\nimport { Plan } from '@/components/results/cards/PlanActionCard';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface Threshold {\n  operator: '<' | '>';\n  value: number;\n}","newString":"/**\n * Advice Engine - Client-side implementation matching the Python AdviceEngine\n * Processes plans.json trigger rules against user metrics\n */\n\nimport { Plan } from '@/components/results/cards/PlanActionCard';\nimport type { ExclusiveCategory } from './recommendations/types';\n\n// ============================================\n// TREATMENT EXCLUSIVITY RULES\n// ============================================\n\n/**\n * Treatment exclusivity configuration\n * Based on FaceIQ logic for mutually exclusive procedures\n */\nexport interface TreatmentExclusivity {\n  exclusiveCategory?: ExclusiveCategory;\n  exclusiveWith?: string[];  // Specific treatment IDs that conflict\n}\n\n/**\n * Mapping of treatment IDs to their exclusivity rules\n */\nexport const TREATMENT_EXCLUSIVITY: Record<string, TreatmentExclusivity> = {\n  // ============================================\n  // JAW AUGMENTATION vs REDUCTION\n  // Cannot combine augmentation with reduction\n  // ============================================\n  'jaw_fillers': {\n    exclusiveCategory: 'jaw_augmentation',\n    exclusiveWith: ['jaw_reduction', 'masseter_botox']\n  },\n  'jaw_implants': {\n    exclusiveCategory: 'jaw_augmentation',\n    exclusiveWith: ['jaw_reduction', 'masseter_botox']\n  },\n  'jaw_reduction': {\n    exclusiveCategory: 'jaw_reduction',\n    exclusiveWith: ['jaw_fillers', 'jaw_implants']\n  },\n  'masseter_botox': {\n    exclusiveCategory: 'jaw_reduction',\n    exclusiveWith: ['jaw_fillers', 'jaw_implants']\n  },\n\n  // ============================================\n  // CHIN AUGMENTATION - Pick ONE\n  // Chin implants, genioplasty, fat grafting to chin\n  // ============================================\n  'chin_implant': {\n    exclusiveCategory: 'chin_augmentation',\n    exclusiveWith: ['genioplasty', 'chin_filler', 'fat_grafting']\n  },\n  'genioplasty': {\n    exclusiveCategory: 'chin_augmentation',\n    exclusiveWith: ['chin_implant', 'chin_filler', 'fat_grafting']\n  },\n  'chin_filler': {\n    exclusiveCategory: 'chin_augmentation',\n    exclusiveWith: ['chin_implant', 'genioplasty', 'fat_grafting']\n  },\n\n  // ============================================\n  // CHEEKBONE AUGMENTATION - Pick ONE\n  // Fillers vs implants\n  // ============================================\n  'cheekbone_fillers': {\n    exclusiveCategory: 'cheekbone_augmentation',\n    exclusiveWith: ['midface_implants']\n  },\n  'midface_implants': {\n    exclusiveCategory: 'cheekbone_augmentation',\n    exclusiveWith: ['cheekbone_fillers']\n  },\n\n  // ============================================\n  // LIP AUGMENTATION vs REDUCTION\n  // ============================================\n  'lip_filler': {\n    exclusiveCategory: 'lip_augmentation',\n    exclusiveWith: ['lip_reduction']\n  },\n  'lip_reduction': {\n    exclusiveCategory: 'lip_reduction',\n    exclusiveWith: ['lip_filler']\n  },\n\n  // ============================================\n  // SUBMENTAL/NECK FAT REMOVAL - Pick ONE\n  // Kybella, cryolipolysis, submental liposuction\n  // ============================================\n  'kybella': {\n    exclusiveCategory: 'submental_fat_removal',\n    exclusiveWith: ['cryolipolysis', 'submental_liposuction']\n  },\n  'cryolipolysis': {\n    exclusiveCategory: 'submental_fat_removal',\n    exclusiveWith: ['kybella', 'submental_liposuction']\n  },\n  'submental_liposuction': {\n    exclusiveCategory: 'submental_fat_removal',\n    exclusiveWith: ['kybella', 'cryolipolysis']\n  },\n\n  // ============================================\n  // NECK PROCEDURES - Overlapping\n  // Neck lift supersedes submentoplasty\n  // ============================================\n  'neck_lift': {\n    exclusiveCategory: 'neck_procedures',\n    exclusiveWith: ['submentoplasty']  // Neck lift includes submentoplasty\n  },\n  'submentoplasty': {\n    exclusiveCategory: 'neck_procedures',\n    exclusiveWith: ['neck_lift']  // If getting neck lift, don't need separate submentoplasty\n  },\n\n  // ============================================\n  // EYE LATERAL CANTHUS - Pick ONE\n  // Canthoplasty vs canthopexy\n  // ============================================\n  'canthoplasty': {\n    exclusiveCategory: 'eye_lateral_canthus',\n    exclusiveWith: ['canthopexy']\n  },\n  'canthopexy': {\n    exclusiveCategory: 'eye_lateral_canthus',\n    exclusiveWith: ['canthoplasty']\n  },\n\n  // ============================================\n  // MAXILLARY SURGERY - Comprehensive\n  // Bimaxillary osteotomy supersedes many other procedures\n  // ============================================\n  'bimaxillary_osteotomy': {\n    exclusiveCategory: 'maxillary_surgery',\n    exclusiveWith: [\n      'genioplasty',        // Chin is repositioned in bimax\n      'chin_implant',       // Redundant after bimax\n      'jaw_implants',       // Jaw position changed\n      'jaw_fillers',        // Temporary vs permanent bone change\n      'rhinoplasty'         // Often combined but distinct - may need sequencing\n    ]\n  }\n};\n\n/**\n * Get exclusivity data for a treatment\n */\nexport function getTreatmentExclusivity(treatmentId: string): TreatmentExclusivity | undefined {\n  return TREATMENT_EXCLUSIVITY[treatmentId];\n}\n\n/**\n * Check if two treatments conflict\n */\nexport function treatmentsConflict(treatmentId1: string, treatmentId2: string): boolean {\n  const exclusivity1 = TREATMENT_EXCLUSIVITY[treatmentId1];\n  const exclusivity2 = TREATMENT_EXCLUSIVITY[treatmentId2];\n\n  // Check direct exclusivity via IDs\n  if (exclusivity1?.exclusiveWith?.includes(treatmentId2)) {\n    return true;\n  }\n  if (exclusivity2?.exclusiveWith?.includes(treatmentId1)) {\n    return true;\n  }\n\n  // Check category-based exclusivity (same category = mutually exclusive)\n  if (\n    exclusivity1?.exclusiveCategory &&\n    exclusivity2?.exclusiveCategory &&\n    exclusivity1.exclusiveCategory === exclusivity2.exclusiveCategory\n  ) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Get all treatments that conflict with a given treatment\n */\nexport function getConflictingTreatments(treatmentId: string): string[] {\n  const conflicts: string[] = [];\n  const exclusivity = TREATMENT_EXCLUSIVITY[treatmentId];\n\n  if (!exclusivity) {\n    return conflicts;\n  }\n\n  // Add direct exclusions\n  if (exclusivity.exclusiveWith) {\n    conflicts.push(...exclusivity.exclusiveWith);\n  }\n\n  // Add treatments from same exclusive category\n  if (exclusivity.exclusiveCategory) {\n    for (const [id, data] of Object.entries(TREATMENT_EXCLUSIVITY)) {\n      if (id !== treatmentId && data.exclusiveCategory === exclusivity.exclusiveCategory) {\n        if (!conflicts.includes(id)) {\n          conflicts.push(id);\n        }\n      }\n    }\n  }\n\n  return conflicts;\n}\n\n/**\n * Human-readable descriptions of why treatments conflict\n */\nexport const CONFLICT_REASONS: Record<ExclusiveCategory, string> = {\n  'jaw_augmentation': 'Jaw augmentation procedures conflict with jaw reduction procedures. Choose one approach.',\n  'jaw_reduction': 'Jaw reduction procedures conflict with jaw augmentation procedures. Choose one approach.',\n  'chin_augmentation': 'Choose one chin augmentation method. Combining implants, genioplasty, or fillers is not recommended.',\n  'cheekbone_augmentation': 'Choose either fillers or implants for cheekbone augmentation, not both.',\n  'lip_augmentation': 'Lip augmentation conflicts with lip reduction. Choose one approach for lip volume.',\n  'lip_reduction': 'Lip reduction conflicts with lip augmentation. Choose one approach for lip volume.',\n  'submental_fat_removal': 'Choose one submental fat removal method. Multiple procedures to the same area increase complication risk.',\n  'neck_procedures': 'Neck lift includes submentoplasty. Having both is redundant and increases risk.',\n  'eye_lateral_canthus': 'Choose either canthoplasty or canthopexy for lateral canthus modification, not both.',\n  'maxillary_surgery': 'Bimaxillary osteotomy is comprehensive and may make other jaw/chin procedures redundant.'\n};\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface Threshold {\n  operator: '<' | '>';\n  value: number;\n}","originalFile":"/**\n * Advice Engine - Client-side implementation matching the Python AdviceEngine\n * Processes plans.json trigger rules against user metrics\n */\n\nimport { Plan } from '@/components/results/cards/PlanActionCard';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface Threshold {\n  operator: '<' | '>';\n  value: number;\n}\n\ninterface TriggerRules {\n  metrics: string[];\n  condition: 'OR' | 'AND';\n  thresholds: Record<string, Threshold>;\n}\n\n// Harmony-style effectiveness rating\ninterface Effectiveness {\n  level: 'high' | 'medium' | 'low';\n  score: number;  // 1-5\n  confidence: number;  // 0-1\n}\n\n// How a treatment impacts a specific ratio\ninterface RatioImpact {\n  direction: 'increase' | 'decrease';\n  percentage: number;  // Expected % change\n}\n\ninterface PlanContent {\n  description: string;\n  cost_min: number;\n  cost_max: number;\n  time_min?: string;\n  time_max?: string;\n  risks?: string;\n  citations?: string[];\n  tags?: string[];\n  // Treatment metadata fields\n  priority_score?: number;  // 1-5, higher = more important\n  effectiveness?: Effectiveness;\n  ratios_impacted?: Record<string, RatioImpact>;\n  pillars?: string[];  // e.g., ['angularity', 'harmony', 'symmetry']\n}\n\ninterface RawPlan {\n  id: string;\n  title: string;\n  trigger_rules: TriggerRules;\n  content: PlanContent;\n}\n\ninterface TriggerResult {\n  metric: string;\n  value: number;\n  threshold: number;\n  operator: '<' | '>';\n}\n\n// ============================================\n// PLANS DATA (from plans.json)\n// ============================================\n\nexport const PLANS: RawPlan[] = [\n  {\n    id: \"jaw_fillers\",\n    title: \"Jaw Fillers\",\n    trigger_rules: {\n      metrics: [\"Gonial Angle\", \"Bigonial Width\", \"Ramus to Mandible Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Gonial Angle\": { operator: \">\", value: 128.0 },\n        \"Bigonial Width\": { operator: \"<\", value: 90.0 },\n        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.5 }\n      }\n    },\n    content: {\n      description: \"Injectable dermal fillers (hyaluronic acid or hydroxyapatite) to enhance jawline definition, gonial angle sharpness, and mandibular border projection. Common products: Radiesse, Sculptra, Juvederm Voluma. Targets masseter hollow, prejowl sulcus, and mandibular angle.\",\n      cost_min: 600,\n      cost_max: 2500,\n      time_min: \"6 months\",\n      time_max: \"18 months\",\n      risks: \"Vascular occlusion, asymmetry, swelling.\",\n      citations: [\"Al-Khafaji et al., 2023\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 },\n        \"Bigonial Width\": { direction: \"increase\", percentage: 4 },\n        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 2 }\n      },\n      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"cheekbone_fillers\",\n    title: \"Cheekbone Fillers\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.75 }\n      }\n    },\n    content: {\n      description: \"Malar augmentation via hyaluronic acid fillers placed at the zygomatic arch and submalar region. Products: Juvederm Voluma, Restylane Lyft. Enhances ogee curve, anterior cheek projection, and lateral zygomatic width for improved facial angularity.\",\n      cost_min: 650,\n      cost_max: 2500,\n      time_min: \"6 months\",\n      time_max: \"18 months\",\n      risks: \"Asymmetry, filler migration.\",\n      citations: [\"Trinh & Gupta, 2021\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.85 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 4 },\n        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 2 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 }\n      },\n      pillars: [\"angularity\", \"harmony\", \"youthfulness\"]\n    }\n  },\n  {\n    id: \"beard_growth\",\n    title: \"Beard / Stubble Growth\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Gonial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.8 },\n        \"Gonial Angle\": { operator: \">\", value: 126.0 }\n      }\n    },\n    content: {\n      description: \"Strategic facial hair growth (5-10mm stubble or full beard) to optically enhance jawline definition, camouflage gonial angle softness, and create visual chin projection. Consider minoxidil 5% foam if low coverage. Trim to maintain sharp mandibular border.\",\n      cost_min: 0,\n      cost_max: 20,\n      time_min: \"1 month\",\n      time_max: \"3 months\",\n      risks: \"None\",\n      citations: [\"Dixson et al., 2016\"],\n      tags: [\"Foundational\", \"Free\"],\n      priority_score: 2,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 5 },\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 }\n      },\n      pillars: [\"masculinity\", \"camouflage\"]\n    }\n  },\n  {\n    id: \"lip_filler\",\n    title: \"Lip Filler\",\n    trigger_rules: {\n      metrics: [\"Lower Lip to Upper Lip Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lower Lip to Upper Lip Ratio\": { operator: \"<\", value: 1.0 }\n      }\n    },\n    content: {\n      description: \"Lip augmentation via hyaluronic acid fillers (Restylane, Juvederm) to enhance vermillion border, cupid's bow definition, and lip ratio balance. Can target vermillion height, philtral columns, or tubercles. Alternative: surgical lip lift (bullhorn or corner lift) for permanent results.\",\n      cost_min: 500,\n      cost_max: 1200,\n      time_min: \"6 months\",\n      time_max: \"12 months\",\n      risks: \"Migration, bruising.\",\n      citations: [\"Hernandez et al., 2023\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Lower Lip to Upper Lip Ratio\": { direction: \"increase\", percentage: 15 }\n      },\n      pillars: [\"harmony\", \"femininity\", \"youthfulness\"]\n    }\n  },\n  {\n    id: \"weight_loss_protocol\",\n    title: \"Fat Loss Protocol (High Protein + Cardio)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Jaw Slope\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 65.0 },\n        \"Jaw Slope\": { operator: \">\", value: 140.0 }\n      }\n    },\n    content: {\n      description: \"Caloric deficit protocol targeting 8-12% body fat to debloat buccal fat pads and reveal zygomatic, mandibular, and maxillary bone structure. High-protein intake (1.6-2.2g/kg), fasted cardio, and sodium/water management. Consider buccal fat removal surgery if structure remains obscured at low body fat.\",\n      cost_min: 200,\n      cost_max: 1000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"None\",\n      citations: [\"Moon & Koh, 2020\"],\n      tags: [\"Foundational\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 4, confidence: 0.90 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 8 },\n        \"Jaw Slope\": { direction: \"decrease\", percentage: 5 },\n        \"Bigonial Width\": { direction: \"increase\", percentage: 3 }\n      },\n      pillars: [\"angularity\", \"bone_structure\", \"definition\"]\n    }\n  },\n  {\n    id: \"mewing_posture\",\n    title: \"Mewing & Posture Correction\",\n    trigger_rules: {\n      metrics: [\"Midface Ratio\", \"Nasolabial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Midface Ratio\": { operator: \">\", value: 1.05 },\n        \"Nasolabial Angle\": { operator: \"<\", value: 90.0 }\n      }\n    },\n    content: {\n      description: \"Orthotropic tongue posture: entire tongue (posterior third critical) pressed against palate, teeth in light contact, nasal breathing. Aims to stimulate maxillary protraction, improve mandibular posture, and enhance gonial angle over time. Combine with proper head/neck alignment and chin tucks.\",\n      cost_min: 0,\n      cost_max: 0,\n      time_min: \"12 months\",\n      time_max: \"Lifetime\",\n      risks: \"None if performed correctly.\",\n      citations: [\"Mew J. et al., 2014\"],\n      tags: [\"Foundational\", \"Free\"],\n      priority_score: 3,\n      effectiveness: { level: 'low', score: 2, confidence: 0.50 },\n      ratios_impacted: {\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 },\n        \"Nasolabial Angle\": { direction: \"increase\", percentage: 3 },\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 2 }\n      },\n      pillars: [\"bone_structure\", \"posture\", \"long_term\"]\n    }\n  },\n  {\n    id: \"rhinoplasty\",\n    title: \"Rhinoplasty\",\n    trigger_rules: {\n      metrics: [\"Nasal Projection\", \"Nasal W to H Ratio\", \"Nasolabial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal Projection\": { operator: \">\", value: 0.75 },\n        \"Nasal W to H Ratio\": { operator: \">\", value: 0.85 },\n        \"Nasolabial Angle\": { operator: \"<\", value: 85.0 }\n      }\n    },\n    content: {\n      description: \"Comprehensive nasal surgery: dorsal hump reduction, osteotomies for width correction, tip plasty for bulbous refinement, alarplasty for alar base narrowing, cephalic trim for tip rotation, septoplasty for deviation. Can address nasal index, nasolabial angle, nasofrontal angle, and tip projection.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"6 months\",\n      time_max: \"12 months\",\n      risks: \"Infection, asymmetry, breathing issues, revision surgery.\",\n      citations: [\"Rohrich RJ et al., 2010\", \"Foda HM, 2008\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Nasal Projection\": { direction: \"decrease\", percentage: 10 },\n        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 8 },\n        \"Nasolabial Angle\": { direction: \"increase\", percentage: 12 },\n        \"Nasal Index\": { direction: \"decrease\", percentage: 6 }\n      },\n      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n    }\n  },\n  {\n    id: \"genioplasty\",\n    title: \"Sliding Genioplasty (Chin Surgery)\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.5 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 15.0 }\n      }\n    },\n    content: {\n      description: \"Osseous genioplasty: horizontal advancement or setback of the chin via osteotomy and titanium plate fixation. Can also adjust vertical height (reduction/augmentation) and transverse width. Alternative: alloplastic chin implant (silicone/Medpor) for pure augmentation. Improves chin-philtrum ratio and profile convexity.\",\n      cost_min: 4000,\n      cost_max: 12000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"Numbness, infection, asymmetry.\",\n      citations: [\"Park JH et al., 2018\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 20 },\n        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 15 },\n        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 5 }\n      },\n      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"canthoplasty\",\n    title: \"Canthoplasty (Eye Corner Surgery)\",\n    trigger_rules: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Lateral Canthal Tilt\": { operator: \"<\", value: 4.0 },\n        \"Eye Aspect Ratio\": { operator: \"<\", value: 2.8 }\n      }\n    },\n    content: {\n      description: \"Lateral canthoplasty or canthopexy: surgical elevation and fixation of the lateral canthal tendon to increase positive canthal tilt angle. Techniques include tarsal strip, lateral canthal suspension, or almond eye surgery. Can be combined with lower blepharoplasty. Addresses negative canthal tilt and downturned eye appearance.\",\n      cost_min: 3000,\n      cost_max: 8000,\n      time_min: \"2 months\",\n      time_max: \"6 months\",\n      risks: \"Scarring, asymmetry, dry eyes.\",\n      citations: [\"Rhee SC et al., 2017\", \"Chen WP, 2016\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 40 },\n        \"Eye Aspect Ratio\": { direction: \"increase\", percentage: 10 }\n      },\n      pillars: [\"youthfulness\", \"alertness\", \"femininity\"]\n    }\n  },\n  {\n    id: \"brow_lift\",\n    title: \"Brow Lift / Browridge Enhancement\",\n    trigger_rules: {\n      metrics: [\"Eyebrow Low Setedness\", \"Browridge Inclination Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Eyebrow Low Setedness\": { operator: \">\", value: 2.0 },\n        \"Browridge Inclination Angle\": { operator: \"<\", value: 10.0 }\n      }\n    },\n    content: {\n      description: \"Brow elevation via endoscopic browlift, temporal lift, or direct browplasty to reduce hooding and increase eyebrow height. For browridge: supraorbital rim augmentation with PMMA, hydroxyapatite paste, or custom implants. Botox for brow arch shaping. Addresses low-set brows and flat browridge inclination.\",\n      cost_min: 1500,\n      cost_max: 10000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Asymmetry, numbness, unnatural appearance.\",\n      citations: [\"Mendelson B et al., 2015\"],\n      tags: [\"Surgical\", \"Minimally Invasive\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 4, confidence: 0.75 },\n      ratios_impacted: {\n        \"Eyebrow Low Setedness\": { direction: \"decrease\", percentage: 30 },\n        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 20 }\n      },\n      pillars: [\"youthfulness\", \"masculinity\", \"upper_third\"]\n    }\n  },\n  // ============================================\n  // ADDITIONAL PROCEDURES\n  // ============================================\n  {\n    id: \"kybella\",\n    title: \"Kybella (Double Chin Removal)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 130.0 },\n        \"Neck Width\": { operator: \">\", value: 95.0 }\n      }\n    },\n    content: {\n      description: \"Injectable deoxycholic acid (Kybella/ATX-101) to permanently dissolve submental fat. Multiple sessions required (2-6 treatments, 4-6 weeks apart). Destroys fat cell membranes, eliminating double chin without surgery. FDA-approved for moderate-to-severe submental fullness.\",\n      cost_min: 1200,\n      cost_max: 3000,\n      time_min: \"2 months\",\n      time_max: \"6 months\",\n      risks: \"Swelling, bruising, numbness, pain, nerve injury causing asymmetric smile, asymmetry, difficulty swallowing.\",\n      citations: [\"Jones DH et al., 2016\", \"Ascher B et al., 2017\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"cryolipolysis\",\n    title: \"Cryolipolysis (Fat Freezing)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 125.0 },\n        \"Neck Width\": { operator: \">\", value: 90.0 }\n      }\n    },\n    content: {\n      description: \"Non-invasive fat reduction via controlled cooling (CoolSculpting). Targets stubborn subcutaneous fat without surgery by crystallizing fat cells which are then naturally eliminated. FDA-cleared for submental area, flanks, abdomen. Results visible in 2-4 months.\",\n      cost_min: 750,\n      cost_max: 2500,\n      time_min: \"2 months\",\n      time_max: \"4 months\",\n      risks: \"Temporary erythema/swelling, bruising, numbness/paresthesia, pain, paradoxical adipose hyperplasia (rare), frostbite, hyperpigmentation.\",\n      citations: [\"Ingargiola MJ et al., 2015\", \"Kilmer SL et al., 2017\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 2,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 12 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"definition\", \"non_invasive\", \"neck\"]\n    }\n  },\n  {\n    id: \"chin_implant\",\n    title: \"Chin Implant (Mentoplasty)\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\", \"Facial Convexity\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.6 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 12.0 },\n        \"Facial Convexity\": { operator: \"<\", value: 165.0 }\n      }\n    },\n    content: {\n      description: \"Alloplastic chin augmentation using silicone or Medpor implants placed through submental or intraoral incision. Provides permanent chin projection and width enhancement. Alternative to sliding genioplasty for pure augmentation without bone cutting. Custom implants available for precise contouring.\",\n      cost_min: 3000,\n      cost_max: 8000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Infection, implant migration, bone erosion, asymmetry, numbness, capsular contracture, implant extrusion.\",\n      citations: [\"Yaremchuk MJ, 2013\", \"Binder WJ et al., 2008\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.88 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 18 },\n        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 12 },\n        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 4 }\n      },\n      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"buccal_fat_removal\",\n    title: \"Buccal Fat Removal (Bichectomy)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 70.0 },\n        \"Face Width to Height Ratio\": { operator: \">\", value: 1.55 }\n      }\n    },\n    content: {\n      description: \"Surgical excision of buccal fat pads through intraoral incision to slim the lower cheeks and enhance facial angularity. Creates more defined cheekbone-to-jaw contour. Best for patients with naturally round faces at low body fat. Results are permanent and irreversible.\",\n      cost_min: 2500,\n      cost_max: 6000,\n      time_min: \"2 weeks\",\n      time_max: \"6 months\",\n      risks: \"Facial nerve damage, asymmetry, over-resection causing gaunt appearance, infection, hematoma, parotid duct injury.\",\n      citations: [\"Tarallo M et al., 2018\", \"Moura LB et al., 2018\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 6 },\n        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 3 }\n      },\n      pillars: [\"angularity\", \"definition\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"alarplasty\",\n    title: \"Alarplasty (Alar Base Reduction)\",\n    trigger_rules: {\n      metrics: [\"Nasal W to H Ratio\", \"Alar Base Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal W to H Ratio\": { operator: \">\", value: 0.80 },\n        \"Alar Base Width\": { operator: \">\", value: 35.0 }\n      }\n    },\n    content: {\n      description: \"Surgical narrowing of the nasal alar base through wedge excision. Reduces nostril width and alar flare. Can be performed alone or combined with rhinoplasty. Weir excision for nostril sill, alar wedge for flaring. Hidden incision placement minimizes visible scarring.\",\n      cost_min: 2000,\n      cost_max: 5000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Visible scarring, asymmetry, over-narrowing, nostril distortion, poor wound healing.\",\n      citations: [\"Rohrich RJ et al., 2009\", \"Ingels K et al., 2015\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 12 },\n        \"Nasal Index\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n    }\n  },\n  {\n    id: \"canthopexy\",\n    title: \"Canthopexy (Lateral Canthal Suspension)\",\n    trigger_rules: {\n      metrics: [\"Lateral Canthal Tilt\", \"Lower Eyelid Position\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lateral Canthal Tilt\": { operator: \"<\", value: 3.0 },\n        \"Lower Eyelid Position\": { operator: \">\", value: 1.5 }\n      }\n    },\n    content: {\n      description: \"Suture suspension of the lateral canthal tendon to tighten lower eyelid and prevent sagging. Less invasive than canthoplasty (no tendon cutting). Supports eye shape, prevents scleral show, and can provide subtle upward tilt. Often combined with blepharoplasty.\",\n      cost_min: 2500,\n      cost_max: 6000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Asymmetry, under/overcorrection, dry eyes, ectropion, scarring, temporary swelling.\",\n      citations: [\"Hester TR et al., 2000\", \"Codner MA et al., 2008\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n      ratios_impacted: {\n        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 20 }\n      },\n      pillars: [\"youthfulness\", \"alertness\", \"eye_area\"]\n    }\n  },\n  {\n    id: \"neck_lift\",\n    title: \"Neck Lift (Platysmaplasty)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 135.0 },\n        \"Neck Width\": { operator: \">\", value: 100.0 }\n      }\n    },\n    content: {\n      description: \"Comprehensive neck rejuvenation: platysma muscle tightening (platysmaplasty), submental liposuction, excess skin removal, and possible digastric muscle reduction. Addresses turkey neck, platysmal banding, submental fullness, and skin laxity. Can include submental tuck or deep plane techniques.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Hematoma, nerve injury, skin necrosis, asymmetry, visible scarring, skin irregularities, prolonged swelling.\",\n      citations: [\"Feldman JJ, 2006\", \"Ellenbogen R et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 25 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 15 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"septoplasty\",\n    title: \"Septoplasty (Deviated Septum Correction)\",\n    trigger_rules: {\n      metrics: [\"Nasal Deviation\", \"Nasal Symmetry\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal Deviation\": { operator: \">\", value: 5.0 },\n        \"Nasal Symmetry\": { operator: \"<\", value: 0.90 }\n      }\n    },\n    content: {\n      description: \"Surgical correction of deviated nasal septum to improve nasal airflow and symmetry. Performed through closed endonasal approach. Can be functional (breathing) or cosmetic (straightening). Often combined with rhinoplasty (septorhinoplasty) for comprehensive nasal reshaping.\",\n      cost_min: 3000,\n      cost_max: 10000,\n      time_min: \"1 week\",\n      time_max: \"3 months\",\n      risks: \"Septal perforation, persistent deviation, saddle nose, numbness, infection, bleeding, CSF leak (rare).\",\n      citations: [\"Rohrich RJ et al., 2011\", \"Fettman N et al., 2009\"],\n      tags: [\"Surgical\"],\n      priority_score: 2,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n      ratios_impacted: {\n        \"Nasal Deviation\": { direction: \"decrease\", percentage: 80 },\n        \"Nasal Symmetry\": { direction: \"increase\", percentage: 10 }\n      },\n      pillars: [\"symmetry\", \"function\", \"breathing\"]\n    }\n  },\n  {\n    id: \"lip_lift\",\n    title: \"Lip Lift (Bullhorn/Subnasal Lip Lift)\",\n    trigger_rules: {\n      metrics: [\"Philtrum Length\", \"Upper Lip Vermilion Height\", \"Midface Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Philtrum Length\": { operator: \">\", value: 15.0 },\n        \"Upper Lip Vermilion Height\": { operator: \"<\", value: 7.0 },\n        \"Midface Ratio\": { operator: \">\", value: 1.1 }\n      }\n    },\n    content: {\n      description: \"Surgical shortening of the philtrum by removing skin at the base of the nose (bullhorn excision). Permanently increases upper lip vermilion show and reduces long upper lip appearance. Alternative to filler for long philtrum correction. Scar hidden in nasal base crease.\",\n      cost_min: 3500,\n      cost_max: 8000,\n      time_min: \"2 weeks\",\n      time_max: \"6 months\",\n      risks: \"Visible scarring, asymmetry, over-shortening, distorted nostril base, wound dehiscence, prolonged swelling.\",\n      citations: [\"Austin HW, 1986\", \"Santanché P et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 25 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"youthfulness\", \"harmony\", \"lip_area\"]\n    }\n  },\n  {\n    id: \"jaw_implants\",\n    title: \"Jaw Implants (Mandibular Augmentation)\",\n    trigger_rules: {\n      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Ramus to Mandible Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Bigonial Width\": { operator: \"<\", value: 85.0 },\n        \"Gonial Angle\": { operator: \">\", value: 130.0 },\n        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.45 }\n      }\n    },\n    content: {\n      description: \"Alloplastic mandibular augmentation using silicone, Medpor, or custom PEEK implants. Enhances jaw width (bigonial), gonial angle definition, and mandibular border projection. Placed through intraoral incision. Custom wraparound implants available for comprehensive jaw enhancement.\",\n      cost_min: 6000,\n      cost_max: 20000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Infection, implant migration, bone erosion, asymmetry, mental nerve injury, capsular contracture, masseter atrophy.\",\n      citations: [\"Yaremchuk MJ, 2006\", \"Rao LK et al., 2011\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Bigonial Width\": { direction: \"increase\", percentage: 12 },\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 8 },\n        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 6 }\n      },\n      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"midface_implants\",\n    title: \"Midface Implants (Malar/Submalar)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Face Width to Height Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 55.0 },\n        \"Midface Ratio\": { operator: \">\", value: 1.15 },\n        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.65 }\n      }\n    },\n    content: {\n      description: \"Alloplastic augmentation of the malar (cheekbone) and/or submalar region using silicone or Medpor implants. Enhances midface projection, cheekbone prominence, and overall facial width. Custom implants available. Alternative to fat grafting for permanent midface volume.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Infection, implant migration, asymmetry, nerve injury (infraorbital), bone erosion, capsular contracture, visibility.\",\n      citations: [\"Terino EO, 2000\", \"Binder WJ et al., 2007\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 10 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 6 },\n        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 4 }\n      },\n      pillars: [\"angularity\", \"harmony\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"submental_liposuction\",\n    title: \"Submental Liposuction\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 120.0 },\n        \"Neck Width\": { operator: \">\", value: 85.0 }\n      }\n    },\n    content: {\n      description: \"Surgical removal of excess fat beneath the chin via small cannula through submental incision. Refines jawline contour and improves neck definition. Can be combined with skin tightening or platysmaplasty. Best for younger patients with good skin elasticity.\",\n      cost_min: 2000,\n      cost_max: 5000,\n      time_min: \"1 week\",\n      time_max: \"3 months\",\n      risks: \"Contour irregularities, asymmetry, nerve injury, skin laxity, hematoma, seroma, prolonged swelling.\",\n      citations: [\"Rohrich RJ et al., 2007\", \"Giampapa VC et al., 2000\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 4, confidence: 0.82 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"submentoplasty\",\n    title: \"Submentoplasty (Submental Tuck)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 140.0 },\n        \"Neck Width\": { operator: \">\", value: 105.0 }\n      }\n    },\n    content: {\n      description: \"Direct excision of submental skin/fat with platysma muscle plication through small chin incision. Tightens central neck muscles and removes excess tissue. More aggressive than liposuction alone, less extensive than full neck lift. Also called cervicoplasty.\",\n      cost_min: 3500,\n      cost_max: 8000,\n      time_min: \"2 weeks\",\n      time_max: \"4 months\",\n      risks: \"Visible scarring, hematoma, nerve injury, skin necrosis, asymmetry, contour irregularities.\",\n      citations: [\"Giampapa VC et al., 2000\", \"Ellenbogen R et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 20 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 12 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"fat_grafting\",\n    title: \"Fat Grafting (Facial Lipofilling)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Under-Eye Hollowness\", \"Temple Volume\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n        \"Under-Eye Hollowness\": { operator: \">\", value: 3.0 },\n        \"Temple Volume\": { operator: \"<\", value: 0.8 }\n      }\n    },\n    content: {\n      description: \"Autologous fat transfer: fat harvested from body (abdomen, thighs), processed, and injected for facial volumization. Microfat for volume (cheeks, temples, jawline), nanofat for skin rejuvenation. Natural permanent filler with 40-60% long-term retention. Multiple sessions may be needed.\",\n      cost_min: 4000,\n      cost_max: 12000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Fat resorption, asymmetry, lumpiness, oil cysts, infection, embolism (rare), over/under-correction.\",\n      citations: [\"Coleman SR, 2006\", \"Khouri RK et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 5 },\n        \"Tear Trough Depth\": { direction: \"decrease\", percentage: 40 }\n      },\n      pillars: [\"youthfulness\", \"volume\", \"natural\"]\n    }\n  },\n  {\n    id: \"supraorbital_implants\",\n    title: \"Supraorbital Rim Implants (Browridge)\",\n    trigger_rules: {\n      metrics: [\"Browridge Inclination Angle\", \"Supraorbital Projection\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Browridge Inclination Angle\": { operator: \"<\", value: 8.0 },\n        \"Supraorbital Projection\": { operator: \"<\", value: 0.85 }\n      }\n    },\n    content: {\n      description: \"Custom or standard implants placed along the supraorbital rim to enhance browridge projection and definition. Creates more prominent brow bone for masculine appearance. Often custom-designed from CT scans. Placed through coronal or endoscopic approach.\",\n      cost_min: 8000,\n      cost_max: 25000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Infection, implant migration, asymmetry, nerve injury, frontal sinus violation, visible/palpable implant, bone erosion.\",\n      citations: [\"Yaremchuk MJ, 2003\", \"Spiegel JH, 2011\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 30 }\n      },\n      pillars: [\"masculinity\", \"bone_structure\", \"upper_third\"]\n    }\n  },\n  {\n    id: \"lip_reduction\",\n    title: \"Lip Reduction Surgery (Reduction Cheiloplasty)\",\n    trigger_rules: {\n      metrics: [\"Lip Thickness\", \"Lower Lip to Upper Lip Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lip Thickness\": { operator: \">\", value: 18.0 },\n        \"Lower Lip to Upper Lip Ratio\": { operator: \">\", value: 2.2 }\n      }\n    },\n    content: {\n      description: \"Surgical removal of excess lip tissue through incision along wet-dry border to reduce lip volume and projection. Improves proportion between lips and surrounding features. Separate procedures for upper and lower lips. Permanent alternative to reversible fillers.\",\n      cost_min: 2500,\n      cost_max: 6000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Visible scarring, asymmetry, over-reduction, numbness, altered sensation, wound dehiscence.\",\n      citations: [\"Fanous N, 2007\", \"Garcia RM et al., 2016\"],\n      tags: [\"Surgical\"],\n      priority_score: 2,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Lower Lip to Upper Lip Ratio\": { direction: \"decrease\", percentage: 20 }\n      },\n      pillars: [\"harmony\", \"balance\", \"lip_area\"]\n    }\n  },\n  {\n    id: \"jaw_reduction\",\n    title: \"Jaw Reduction Surgery (V-Line Surgery)\",\n    trigger_rules: {\n      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Face Width to Height Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Bigonial Width\": { operator: \">\", value: 120.0 },\n        \"Gonial Angle\": { operator: \"<\", value: 115.0 },\n        \"Face Width to Height Ratio\": { operator: \">\", value: 1.65 }\n      }\n    },\n    content: {\n      description: \"Mandibular angle resection and contouring to slim and feminize the lower face, creating V-line effect. Osteotomy of mandibular angle, possible chin tapering (T-osteotomy), and masseter reduction. Popular in East Asian aesthetic surgery. Performed through intraoral approach.\",\n      cost_min: 8000,\n      cost_max: 25000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Facial nerve injury, asymmetry, over-reduction, bone necrosis, infection, prolonged swelling, numbness.\",\n      citations: [\"Yang DB et al., 2014\", \"Jin H et al., 2013\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Bigonial Width\": { direction: \"decrease\", percentage: 15 },\n        \"Gonial Angle\": { direction: \"increase\", percentage: 10 },\n        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"femininity\", \"harmony\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"bimaxillary_osteotomy\",\n    title: \"Bimaxillary Osteotomy (Double Jaw Surgery)\",\n    trigger_rules: {\n      metrics: [\"Facial Convexity\", \"Recession Relative to Frankfort Plane\", \"Midface Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Facial Convexity\": { operator: \"<\", value: 160.0 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 18.0 },\n        \"Midface Ratio\": { operator: \">\", value: 1.2 }\n      }\n    },\n    content: {\n      description: \"Simultaneous repositioning of both maxilla (Le Fort I) and mandible (BSSO) to correct facial disharmony and skeletal malocclusion. Addresses severe class II/III relationships, facial asymmetry, and vertical excess. Requires orthodontic preparation. Most comprehensive facial skeletal surgery.\",\n      cost_min: 20000,\n      cost_max: 60000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"Nerve injury, infection, relapse, TMJ dysfunction, malocclusion, bleeding, airway compromise, need for revision.\",\n      citations: [\"Proffit WR et al., 2013\", \"Wolford LM et al., 2003\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n      ratios_impacted: {\n        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 15 },\n        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 20 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 10 }\n      },\n      pillars: [\"profile\", \"bone_structure\", \"comprehensive\"]\n    }\n  }\n];\n\n// ============================================\n// ADVICE ENGINE CLASS\n// ============================================\n\nexport class AdviceEngine {\n  private plans: RawPlan[];\n\n  constructor(customPlans?: RawPlan[]) {\n    this.plans = customPlans || PLANS;\n  }\n\n  /**\n   * Check if a single threshold condition is met\n   */\n  private checkThreshold(userValue: number, operator: '<' | '>', thresholdValue: number): boolean {\n    if (operator === '<') {\n      return userValue < thresholdValue;\n    }\n    return userValue > thresholdValue;\n  }\n\n  /**\n   * Evaluate trigger rules against user metrics\n   */\n  private evaluateTriggerRules(\n    triggerRules: TriggerRules,\n    metricsDict: Record<string, number>\n  ): { isTriggered: boolean; triggeredMetrics: TriggerResult[] } {\n    const { metrics, thresholds, condition } = triggerRules;\n    const triggeredMetrics: TriggerResult[] = [];\n    const results: boolean[] = [];\n\n    for (const metricName of metrics) {\n      if (!(metricName in metricsDict)) continue;\n      if (!(metricName in thresholds)) continue;\n\n      const userValue = metricsDict[metricName];\n      const { operator, value: thresholdValue } = thresholds[metricName];\n      const isMet = this.checkThreshold(userValue, operator, thresholdValue);\n\n      if (isMet) {\n        triggeredMetrics.push({\n          metric: metricName,\n          value: userValue,\n          threshold: thresholdValue,\n          operator\n        });\n      }\n\n      results.push(isMet);\n    }\n\n    const isTriggered = condition === 'AND'\n      ? results.length > 0 && results.every(r => r)\n      : results.some(r => r);\n\n    return { isTriggered, triggeredMetrics };\n  }\n\n  /**\n   * Get all recommendations that match the user's metrics\n   *\n   * @param metricsDict - Raw metric values\n   * @param severityDict - Severity classifications (ideal/good/moderate/severe) for each metric\n   *                       If a metric is 'ideal', it will NOT trigger remediation plans\n   */\n  getRecommendations(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Plan[] {\n    const recommendations: Plan[] = [];\n\n    for (const rawPlan of this.plans) {\n      const { isTriggered, triggeredMetrics } = this.evaluateTriggerRules(\n        rawPlan.trigger_rules,\n        metricsDict\n      );\n\n      // If severity data is provided, filter out metrics that are already ideal\n      if (isTriggered && severityDict) {\n        // Check if ALL triggered metrics are outside ideal range\n        const hasActualFlaw = triggeredMetrics.some(tm => {\n          const severity = severityDict[tm.metric];\n          // Only trigger if severity is NOT ideal (i.e., it's good/moderate/severe)\n          return severity && severity !== 'ideal';\n        });\n\n        // Skip this plan if all triggered metrics are already ideal\n        if (!hasActualFlaw) {\n          continue;\n        }\n      }\n\n      if (isTriggered) {\n        recommendations.push({\n          id: rawPlan.id,\n          title: rawPlan.title,\n          content: {\n            description: rawPlan.content.description,\n            cost_min: rawPlan.content.cost_min,\n            cost_max: rawPlan.content.cost_max,\n            time_min: rawPlan.content.time_min || 'Unknown',\n            time_max: rawPlan.content.time_max || 'Unknown',\n            risks: rawPlan.content.risks || 'Consult a professional.',\n            citations: rawPlan.content.citations || [],\n            tags: rawPlan.content.tags\n          },\n          trigger_reason: triggeredMetrics\n        });\n      }\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Get recommendations sorted by cost (cheapest first)\n   */\n  getRecommendationsByCost(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Plan[] {\n    return this.getRecommendations(metricsDict, severityDict).sort(\n      (a, b) => a.content.cost_min - b.content.cost_min\n    );\n  }\n\n  /**\n   * Get recommendations grouped by phase/tag\n   */\n  getRecommendationsByPhase(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Record<string, Plan[]> {\n    const recommendations = this.getRecommendations(metricsDict, severityDict);\n    const grouped: Record<string, Plan[]> = {\n      'Foundational': [],\n      'Minimally Invasive': [],\n      'Surgical': []\n    };\n\n    for (const rec of recommendations) {\n      const tags = rec.content.tags || [];\n      if (tags.includes('Foundational')) {\n        grouped['Foundational'].push(rec);\n      } else if (tags.includes('Surgical')) {\n        grouped['Surgical'].push(rec);\n      } else if (tags.includes('Minimally Invasive')) {\n        grouped['Minimally Invasive'].push(rec);\n      } else {\n        grouped['Minimally Invasive'].push(rec); // Default\n      }\n    }\n\n    return grouped;\n  }\n}\n\n// ============================================\n// SINGLETON INSTANCE\n// ============================================\n\nexport const adviceEngine = new AdviceEngine();\n","structuredPatch":[{"oldStart":4,"oldLines":8,"newStart":4,"newLines":228,"lines":["  */"," "," import { Plan } from '@/components/results/cards/PlanActionCard';","+import type { ExclusiveCategory } from './recommendations/types';"," "," // ============================================","+// TREATMENT EXCLUSIVITY RULES","+// ============================================","+","+/**","+ * Treatment exclusivity configuration","+ * Based on FaceIQ logic for mutually exclusive procedures","+ */","+export interface TreatmentExclusivity {","+  exclusiveCategory?: ExclusiveCategory;","+  exclusiveWith?: string[];  // Specific treatment IDs that conflict","+}","+","+/**","+ * Mapping of treatment IDs to their exclusivity rules","+ */","+export const TREATMENT_EXCLUSIVITY: Record<string, TreatmentExclusivity> = {","+  // ============================================","+  // JAW AUGMENTATION vs REDUCTION","+  // Cannot combine augmentation with reduction","+  // ============================================","+  'jaw_fillers': {","+    exclusiveCategory: 'jaw_augmentation',","+    exclusiveWith: ['jaw_reduction', 'masseter_botox']","+  },","+  'jaw_implants': {","+    exclusiveCategory: 'jaw_augmentation',","+    exclusiveWith: ['jaw_reduction', 'masseter_botox']","+  },","+  'jaw_reduction': {","+    exclusiveCategory: 'jaw_reduction',","+    exclusiveWith: ['jaw_fillers', 'jaw_implants']","+  },","+  'masseter_botox': {","+    exclusiveCategory: 'jaw_reduction',","+    exclusiveWith: ['jaw_fillers', 'jaw_implants']","+  },","+","+  // ============================================","+  // CHIN AUGMENTATION - Pick ONE","+  // Chin implants, genioplasty, fat grafting to chin","+  // ============================================","+  'chin_implant': {","+    exclusiveCategory: 'chin_augmentation',","+    exclusiveWith: ['genioplasty', 'chin_filler', 'fat_grafting']","+  },","+  'genioplasty': {","+    exclusiveCategory: 'chin_augmentation',","+    exclusiveWith: ['chin_implant', 'chin_filler', 'fat_grafting']","+  },","+  'chin_filler': {","+    exclusiveCategory: 'chin_augmentation',","+    exclusiveWith: ['chin_implant', 'genioplasty', 'fat_grafting']","+  },","+","+  // ============================================","+  // CHEEKBONE AUGMENTATION - Pick ONE","+  // Fillers vs implants","+  // ============================================","+  'cheekbone_fillers': {","+    exclusiveCategory: 'cheekbone_augmentation',","+    exclusiveWith: ['midface_implants']","+  },","+  'midface_implants': {","+    exclusiveCategory: 'cheekbone_augmentation',","+    exclusiveWith: ['cheekbone_fillers']","+  },","+","+  // ============================================","+  // LIP AUGMENTATION vs REDUCTION","+  // ============================================","+  'lip_filler': {","+    exclusiveCategory: 'lip_augmentation',","+    exclusiveWith: ['lip_reduction']","+  },","+  'lip_reduction': {","+    exclusiveCategory: 'lip_reduction',","+    exclusiveWith: ['lip_filler']","+  },","+","+  // ============================================","+  // SUBMENTAL/NECK FAT REMOVAL - Pick ONE","+  // Kybella, cryolipolysis, submental liposuction","+  // ============================================","+  'kybella': {","+    exclusiveCategory: 'submental_fat_removal',","+    exclusiveWith: ['cryolipolysis', 'submental_liposuction']","+  },","+  'cryolipolysis': {","+    exclusiveCategory: 'submental_fat_removal',","+    exclusiveWith: ['kybella', 'submental_liposuction']","+  },","+  'submental_liposuction': {","+    exclusiveCategory: 'submental_fat_removal',","+    exclusiveWith: ['kybella', 'cryolipolysis']","+  },","+","+  // ============================================","+  // NECK PROCEDURES - Overlapping","+  // Neck lift supersedes submentoplasty","+  // ============================================","+  'neck_lift': {","+    exclusiveCategory: 'neck_procedures',","+    exclusiveWith: ['submentoplasty']  // Neck lift includes submentoplasty","+  },","+  'submentoplasty': {","+    exclusiveCategory: 'neck_procedures',","+    exclusiveWith: ['neck_lift']  // If getting neck lift, don't need separate submentoplasty","+  },","+","+  // ============================================","+  // EYE LATERAL CANTHUS - Pick ONE","+  // Canthoplasty vs canthopexy","+  // ============================================","+  'canthoplasty': {","+    exclusiveCategory: 'eye_lateral_canthus',","+    exclusiveWith: ['canthopexy']","+  },","+  'canthopexy': {","+    exclusiveCategory: 'eye_lateral_canthus',","+    exclusiveWith: ['canthoplasty']","+  },","+","+  // ============================================","+  // MAXILLARY SURGERY - Comprehensive","+  // Bimaxillary osteotomy supersedes many other procedures","+  // ============================================","+  'bimaxillary_osteotomy': {","+    exclusiveCategory: 'maxillary_surgery',","+    exclusiveWith: [","+      'genioplasty',        // Chin is repositioned in bimax","+      'chin_implant',       // Redundant after bimax","+      'jaw_implants',       // Jaw position changed","+      'jaw_fillers',        // Temporary vs permanent bone change","+      'rhinoplasty'         // Often combined but distinct - may need sequencing","+    ]","+  }","+};","+","+/**","+ * Get exclusivity data for a treatment","+ */","+export function getTreatmentExclusivity(treatmentId: string): TreatmentExclusivity | undefined {","+  return TREATMENT_EXCLUSIVITY[treatmentId];","+}","+","+/**","+ * Check if two treatments conflict","+ */","+export function treatmentsConflict(treatmentId1: string, treatmentId2: string): boolean {","+  const exclusivity1 = TREATMENT_EXCLUSIVITY[treatmentId1];","+  const exclusivity2 = TREATMENT_EXCLUSIVITY[treatmentId2];","+","+  // Check direct exclusivity via IDs","+  if (exclusivity1?.exclusiveWith?.includes(treatmentId2)) {","+    return true;","+  }","+  if (exclusivity2?.exclusiveWith?.includes(treatmentId1)) {","+    return true;","+  }","+","+  // Check category-based exclusivity (same category = mutually exclusive)","+  if (","+    exclusivity1?.exclusiveCategory &&","+    exclusivity2?.exclusiveCategory &&","+    exclusivity1.exclusiveCategory === exclusivity2.exclusiveCategory","+  ) {","+    return true;","+  }","+","+  return false;","+}","+","+/**","+ * Get all treatments that conflict with a given treatment","+ */","+export function getConflictingTreatments(treatmentId: string): string[] {","+  const conflicts: string[] = [];","+  const exclusivity = TREATMENT_EXCLUSIVITY[treatmentId];","+","+  if (!exclusivity) {","+    return conflicts;","+  }","+","+  // Add direct exclusions","+  if (exclusivity.exclusiveWith) {","+    conflicts.push(...exclusivity.exclusiveWith);","+  }","+","+  // Add treatments from same exclusive category","+  if (exclusivity.exclusiveCategory) {","+    for (const [id, data] of Object.entries(TREATMENT_EXCLUSIVITY)) {","+      if (id !== treatmentId && data.exclusiveCategory === exclusivity.exclusiveCategory) {","+        if (!conflicts.includes(id)) {","+          conflicts.push(id);","+        }","+      }","+    }","+  }","+","+  return conflicts;","+}","+","+/**","+ * Human-readable descriptions of why treatments conflict","+ */","+export const CONFLICT_REASONS: Record<ExclusiveCategory, string> = {","+  'jaw_augmentation': 'Jaw augmentation procedures conflict with jaw reduction procedures. Choose one approach.',","+  'jaw_reduction': 'Jaw reduction procedures conflict with jaw augmentation procedures. Choose one approach.',","+  'chin_augmentation': 'Choose one chin augmentation method. Combining implants, genioplasty, or fillers is not recommended.',","+  'cheekbone_augmentation': 'Choose either fillers or implants for cheekbone augmentation, not both.',","+  'lip_augmentation': 'Lip augmentation conflicts with lip reduction. Choose one approach for lip volume.',","+  'lip_reduction': 'Lip reduction conflicts with lip augmentation. Choose one approach for lip volume.',","+  'submental_fat_removal': 'Choose one submental fat removal method. Multiple procedures to the same area increase complication risk.',","+  'neck_procedures': 'Neck lift includes submentoplasty. Having both is redundant and increases risk.',","+  'eye_lateral_canthus': 'Choose either canthoplasty or canthopexy for lateral canthus modification, not both.',","+  'maxillary_surgery': 'Bimaxillary osteotomy is comprehensive and may make other jaw/chin procedures redundant.'","+};","+","+// ============================================"," // TYPES"," // ============================================"," "]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"39e47730-0bc6-4834-a7e5-5a72d8f980fe","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JWKQgcEL8XTFFm14jvxCcF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Tg2xbbJb1naAfAUJgMkoJc","name":"TodoWrite","input":{"todos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"in_progress","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"pending","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5714,"cache_read_input_tokens":78113,"cache_creation":{"ephemeral_5m_input_tokens":5714,"ephemeral_1h_input_tokens":0},"output_tokens":222,"service_tier":"standard"}},"requestId":"req_011CWVV9SyvTEvT3GaYnV6Mm","type":"assistant","uuid":"67cd9e7b-8bac-4266-9147-4a7c45514966","timestamp":"2025-12-26T14:51:08.362Z"}
{"parentUuid":"67cd9e7b-8bac-4266-9147-4a7c45514966","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Tg2xbbJb1naAfAUJgMkoJc","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"41e04718-4692-481a-8bdf-0366656ab91f","timestamp":"2025-12-26T14:51:08.415Z","toolUseResult":{"oldTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"in_progress","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"pending","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"pending","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}],"newTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"in_progress","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"pending","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}]}}
{"parentUuid":"41e04718-4692-481a-8bdf-0366656ab91f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LWCHXGDfpq6iZbDUbpT5F3","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me implement the validation function in engine.ts:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":83827,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVA3s9VsSREgb6CuWrL","type":"assistant","uuid":"5cf72244-a03f-4297-a69f-c7d5107764c9","timestamp":"2025-12-26T14:51:13.866Z"}
{"parentUuid":"5cf72244-a03f-4297-a69f-c7d5107764c9","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LWCHXGDfpq6iZbDUbpT5F3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01S9VaFyC36Gm8JBunqURjoC","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","offset":600}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":83827,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVA3s9VsSREgb6CuWrL","type":"assistant","uuid":"365acc8f-8acb-4cab-b20d-9d1a19991bf1","timestamp":"2025-12-26T14:51:14.555Z"}
{"parentUuid":"365acc8f-8acb-4cab-b20d-9d1a19991bf1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01S9VaFyC36Gm8JBunqURjoC","type":"tool_result","content":"   600→  }\n   601→\n   602→  if (category === 'surgical') {\n   603→    return 'Consider surgery only after exhausting less invasive options and with realistic expectations.';\n   604→  }\n   605→\n   606→  return '';\n   607→}\n   608→\n   609→// ============================================\n   610→// UTILITY FUNCTIONS\n   611→// ============================================\n   612→\n   613→/**\n   614→ * Get top priority recommendations across all categories\n   615→ */\n   616→export function getTopRecommendations(\n   617→  plan: RecommendationPlan,\n   618→  count: number = 5\n   619→): TreatmentRecommendation[] {\n   620→  const all = [\n   621→    ...plan.lifestyle,\n   622→    ...plan.softmaxxing,\n   623→    ...plan.nonSurgical,\n   624→    ...plan.minimallyInvasive,\n   625→    ...plan.surgical,\n   626→  ];\n   627→\n   628→  return all\n   629→    .sort((a, b) => b.relevanceScore - a.relevanceScore)\n   630→    .slice(0, count);\n   631→}\n   632→\n   633→/**\n   634→ * Get recommendations filtered by cost level\n   635→ */\n   636→export function getRecommendationsByCost(\n   637→  plan: RecommendationPlan,\n   638→  maxCost: 'free' | 'low' | 'medium' | 'high' | 'very_high'\n   639→): TreatmentRecommendation[] {\n   640→  const costOrder = ['free', 'low', 'medium', 'high', 'very_high'];\n   641→  const maxCostIndex = costOrder.indexOf(maxCost);\n   642→\n   643→  const all = [\n   644→    ...plan.lifestyle,\n   645→    ...plan.softmaxxing,\n   646→    ...plan.nonSurgical,\n   647→    ...plan.minimallyInvasive,\n   648→    ...plan.surgical,\n   649→  ];\n   650→\n   651→  return all.filter(r => {\n   652→    const treatment = r.treatment as Treatment;\n   653→    if ('costLevel' in treatment) {\n   654→      return costOrder.indexOf(treatment.costLevel) <= maxCostIndex;\n   655→    }\n   656→    return true;\n   657→  });\n   658→}\n   659→\n   660→/**\n   661→ * Get recommendations with minimal downtime\n   662→ */\n   663→export function getNoDowntimeRecommendations(\n   664→  plan: RecommendationPlan\n   665→): TreatmentRecommendation[] {\n   666→  const all = [\n   667→    ...plan.lifestyle,\n   668→    ...plan.softmaxxing,\n   669→    ...plan.nonSurgical,\n   670→    ...plan.minimallyInvasive,\n   671→  ];\n   672→\n   673→  return all.filter(r => {\n   674→    const treatment = r.treatment as Treatment;\n   675→    if ('downtime' in treatment) {\n   676→      const downtime = treatment.downtime.toLowerCase();\n   677→      return downtime.includes('none') || downtime.includes('minimal');\n   678→    }\n   679→    return true;\n   680→  });\n   681→}\n   682→\n   683→/**\n   684→ * Format cost for display\n   685→ */\n   686→export function formatCost(treatment: Treatment | Surgery): string {\n   687→  const { min, max, currency } = treatment.costRange;\n   688→  const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : currency;\n   689→\n   690→  if (min === max) {\n   691→    return `${symbol}${min.toLocaleString()}`;\n   692→  }\n   693→\n   694→  return `${symbol}${min.toLocaleString()} - ${symbol}${max.toLocaleString()}`;\n   695→}\n   696→\n   697→/**\n   698→ * Get summary statistics for a plan\n   699→ */\n   700→export function getPlanSummary(plan: RecommendationPlan): {\n   701→  totalRecommendations: number;\n   702→  highPriority: number;\n   703→  mediumPriority: number;\n   704→  lowPriority: number;\n   705→  categoryCounts: Record<string, number>;\n   706→  estimatedTotalImprovement: number;\n   707→} {\n   708→  const all = [\n   709→    ...plan.lifestyle,\n   710→    ...plan.softmaxxing,\n   711→    ...plan.nonSurgical,\n   712→    ...plan.minimallyInvasive,\n   713→    ...plan.surgical,\n   714→  ];\n   715→\n   716→  return {\n   717→    totalRecommendations: all.length,\n   718→    highPriority: all.filter(r => r.priority === 'high').length,\n   719→    mediumPriority: all.filter(r => r.priority === 'medium').length,\n   720→    lowPriority: all.filter(r => r.priority === 'low').length,\n   721→    categoryCounts: {\n   722→      lifestyle: plan.lifestyle.length,\n   723→      softmaxxing: plan.softmaxxing.length,\n   724→      nonSurgical: plan.nonSurgical.length,\n   725→      minimallyInvasive: plan.minimallyInvasive.length,\n   726→      surgical: plan.surgical.length,\n   727→      supplements: plan.supplements.length,\n   728→    },\n   729→    estimatedTotalImprovement: plan.potentialImprovement,\n   730→  };\n   731→}\n   732→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0811b135-a6ef-4b74-9526-7a844fce95f2","timestamp":"2025-12-26T14:51:14.650Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","content":"  }\n\n  if (category === 'surgical') {\n    return 'Consider surgery only after exhausting less invasive options and with realistic expectations.';\n  }\n\n  return '';\n}\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\n/**\n * Get top priority recommendations across all categories\n */\nexport function getTopRecommendations(\n  plan: RecommendationPlan,\n  count: number = 5\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all\n    .sort((a, b) => b.relevanceScore - a.relevanceScore)\n    .slice(0, count);\n}\n\n/**\n * Get recommendations filtered by cost level\n */\nexport function getRecommendationsByCost(\n  plan: RecommendationPlan,\n  maxCost: 'free' | 'low' | 'medium' | 'high' | 'very_high'\n): TreatmentRecommendation[] {\n  const costOrder = ['free', 'low', 'medium', 'high', 'very_high'];\n  const maxCostIndex = costOrder.indexOf(maxCost);\n\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('costLevel' in treatment) {\n      return costOrder.indexOf(treatment.costLevel) <= maxCostIndex;\n    }\n    return true;\n  });\n}\n\n/**\n * Get recommendations with minimal downtime\n */\nexport function getNoDowntimeRecommendations(\n  plan: RecommendationPlan\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('downtime' in treatment) {\n      const downtime = treatment.downtime.toLowerCase();\n      return downtime.includes('none') || downtime.includes('minimal');\n    }\n    return true;\n  });\n}\n\n/**\n * Format cost for display\n */\nexport function formatCost(treatment: Treatment | Surgery): string {\n  const { min, max, currency } = treatment.costRange;\n  const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : currency;\n\n  if (min === max) {\n    return `${symbol}${min.toLocaleString()}`;\n  }\n\n  return `${symbol}${min.toLocaleString()} - ${symbol}${max.toLocaleString()}`;\n}\n\n/**\n * Get summary statistics for a plan\n */\nexport function getPlanSummary(plan: RecommendationPlan): {\n  totalRecommendations: number;\n  highPriority: number;\n  mediumPriority: number;\n  lowPriority: number;\n  categoryCounts: Record<string, number>;\n  estimatedTotalImprovement: number;\n} {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return {\n    totalRecommendations: all.length,\n    highPriority: all.filter(r => r.priority === 'high').length,\n    mediumPriority: all.filter(r => r.priority === 'medium').length,\n    lowPriority: all.filter(r => r.priority === 'low').length,\n    categoryCounts: {\n      lifestyle: plan.lifestyle.length,\n      softmaxxing: plan.softmaxxing.length,\n      nonSurgical: plan.nonSurgical.length,\n      minimallyInvasive: plan.minimallyInvasive.length,\n      surgical: plan.surgical.length,\n      supplements: plan.supplements.length,\n    },\n    estimatedTotalImprovement: plan.potentialImprovement,\n  };\n}\n","numLines":133,"startLine":600,"totalLines":732}}}
{"parentUuid":"0811b135-a6ef-4b74-9526-7a844fce95f2","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WTdKPZr7ApEZJ17bsDWnuE","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me add the conflict validation functions to engine.ts:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1739,"cache_read_input_tokens":84091,"cache_creation":{"ephemeral_5m_input_tokens":1739,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVAWZWQ7f2gyWiL6PS9","type":"assistant","uuid":"3b110be4-6079-45b2-9608-c08135a65594","timestamp":"2025-12-26T14:51:20.302Z"}
{"parentUuid":"3b110be4-6079-45b2-9608-c08135a65594","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WTdKPZr7ApEZJ17bsDWnuE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BCUMPXSFUS8XZa9fMHwkvN","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","old_string":"/**\n * Get summary statistics for a plan\n */\nexport function getPlanSummary(plan: RecommendationPlan): {\n  totalRecommendations: number;\n  highPriority: number;\n  mediumPriority: number;\n  lowPriority: number;\n  categoryCounts: Record<string, number>;\n  estimatedTotalImprovement: number;\n} {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return {\n    totalRecommendations: all.length,\n    highPriority: all.filter(r => r.priority === 'high').length,\n    mediumPriority: all.filter(r => r.priority === 'medium').length,\n    lowPriority: all.filter(r => r.priority === 'low').length,\n    categoryCounts: {\n      lifestyle: plan.lifestyle.length,\n      softmaxxing: plan.softmaxxing.length,\n      nonSurgical: plan.nonSurgical.length,\n      minimallyInvasive: plan.minimallyInvasive.length,\n      surgical: plan.surgical.length,\n      supplements: plan.supplements.length,\n    },\n    estimatedTotalImprovement: plan.potentialImprovement,\n  };\n}","new_string":"/**\n * Get summary statistics for a plan\n */\nexport function getPlanSummary(plan: RecommendationPlan): {\n  totalRecommendations: number;\n  highPriority: number;\n  mediumPriority: number;\n  lowPriority: number;\n  categoryCounts: Record<string, number>;\n  estimatedTotalImprovement: number;\n} {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return {\n    totalRecommendations: all.length,\n    highPriority: all.filter(r => r.priority === 'high').length,\n    mediumPriority: all.filter(r => r.priority === 'medium').length,\n    lowPriority: all.filter(r => r.priority === 'low').length,\n    categoryCounts: {\n      lifestyle: plan.lifestyle.length,\n      softmaxxing: plan.softmaxxing.length,\n      nonSurgical: plan.nonSurgical.length,\n      minimallyInvasive: plan.minimallyInvasive.length,\n      surgical: plan.surgical.length,\n      supplements: plan.supplements.length,\n    },\n    estimatedTotalImprovement: plan.potentialImprovement,\n  };\n}\n\n// ============================================\n// TREATMENT EXCLUSIVITY & CONFLICT DETECTION\n// ============================================\n\nimport {\n  treatmentsConflict,\n  getConflictingTreatments,\n  getTreatmentExclusivity,\n  CONFLICT_REASONS,\n} from '../advice-engine';\nimport type { ExclusiveCategory } from './types';\n\n/**\n * Conflict information for a pair of treatments\n */\nexport interface TreatmentConflict {\n  treatment1Id: string;\n  treatment1Name: string;\n  treatment2Id: string;\n  treatment2Name: string;\n  reason: string;\n  category?: ExclusiveCategory;\n}\n\n/**\n * Find all conflicts in a list of selected treatments\n */\nexport function findTreatmentConflicts(\n  selectedTreatmentIds: string[],\n  treatmentNameMap?: Record<string, string>\n): TreatmentConflict[] {\n  const conflicts: TreatmentConflict[] = [];\n  const seen = new Set<string>();\n\n  for (let i = 0; i < selectedTreatmentIds.length; i++) {\n    for (let j = i + 1; j < selectedTreatmentIds.length; j++) {\n      const id1 = selectedTreatmentIds[i];\n      const id2 = selectedTreatmentIds[j];\n\n      // Create unique key for this pair\n      const pairKey = [id1, id2].sort().join(':');\n      if (seen.has(pairKey)) continue;\n      seen.add(pairKey);\n\n      if (treatmentsConflict(id1, id2)) {\n        const exclusivity1 = getTreatmentExclusivity(id1);\n        const exclusivity2 = getTreatmentExclusivity(id2);\n        const category = exclusivity1?.exclusiveCategory || exclusivity2?.exclusiveCategory;\n        const reason = category\n          ? CONFLICT_REASONS[category]\n          : 'These treatments are mutually exclusive and should not be combined.';\n\n        conflicts.push({\n          treatment1Id: id1,\n          treatment1Name: treatmentNameMap?.[id1] || id1,\n          treatment2Id: id2,\n          treatment2Name: treatmentNameMap?.[id2] || id2,\n          reason,\n          category,\n        });\n      }\n    }\n  }\n\n  return conflicts;\n}\n\n/**\n * Filter recommendations to remove conflicting treatments\n * Keeps the treatment with higher relevance score when conflicts occur\n */\nexport function filterConflictingRecommendations(\n  recommendations: TreatmentRecommendation[]\n): {\n  filtered: TreatmentRecommendation[];\n  removed: TreatmentRecommendation[];\n  conflicts: TreatmentConflict[];\n} {\n  // Sort by relevance score (highest first)\n  const sorted = [...recommendations].sort((a, b) => b.relevanceScore - a.relevanceScore);\n  const filtered: TreatmentRecommendation[] = [];\n  const removed: TreatmentRecommendation[] = [];\n  const conflicts: TreatmentConflict[] = [];\n  const selectedIds = new Set<string>();\n\n  for (const rec of sorted) {\n    const treatmentId = rec.treatment.id;\n    const conflictingIds = getConflictingTreatments(treatmentId);\n\n    // Check if any already-selected treatment conflicts with this one\n    let hasConflict = false;\n    let conflictingSelectedId: string | null = null;\n\n    for (const selectedId of selectedIds) {\n      if (conflictingIds.includes(selectedId)) {\n        hasConflict = true;\n        conflictingSelectedId = selectedId;\n        break;\n      }\n    }\n\n    if (hasConflict && conflictingSelectedId) {\n      // Record the conflict\n      const exclusivity = getTreatmentExclusivity(treatmentId);\n      const category = exclusivity?.exclusiveCategory;\n      const reason = category\n        ? CONFLICT_REASONS[category]\n        : 'These treatments are mutually exclusive.';\n\n      // Find the conflicting recommendation for name lookup\n      const conflictingRec = filtered.find(r => r.treatment.id === conflictingSelectedId);\n\n      conflicts.push({\n        treatment1Id: conflictingSelectedId,\n        treatment1Name: conflictingRec?.treatment.name || conflictingSelectedId,\n        treatment2Id: treatmentId,\n        treatment2Name: rec.treatment.name,\n        reason,\n        category,\n      });\n\n      removed.push(rec);\n    } else {\n      filtered.push(rec);\n      selectedIds.add(treatmentId);\n    }\n  }\n\n  return { filtered, removed, conflicts };\n}\n\n/**\n * Validate a single treatment selection against existing selections\n */\nexport function validateTreatmentSelection(\n  newTreatmentId: string,\n  existingTreatmentIds: string[],\n  treatmentNameMap?: Record<string, string>\n): {\n  isValid: boolean;\n  conflicts: TreatmentConflict[];\n} {\n  const conflicts: TreatmentConflict[] = [];\n  const conflictingIds = getConflictingTreatments(newTreatmentId);\n\n  for (const existingId of existingTreatmentIds) {\n    if (conflictingIds.includes(existingId)) {\n      const exclusivity = getTreatmentExclusivity(newTreatmentId);\n      const category = exclusivity?.exclusiveCategory;\n      const reason = category\n        ? CONFLICT_REASONS[category]\n        : 'These treatments are mutually exclusive.';\n\n      conflicts.push({\n        treatment1Id: existingId,\n        treatment1Name: treatmentNameMap?.[existingId] || existingId,\n        treatment2Id: newTreatmentId,\n        treatment2Name: treatmentNameMap?.[newTreatmentId] || newTreatmentId,\n        reason,\n        category,\n      });\n    }\n  }\n\n  return {\n    isValid: conflicts.length === 0,\n    conflicts,\n  };\n}\n\n/**\n * Get a recommended alternative when a treatment conflicts\n */\nexport function getAlternativeTreatments(\n  conflictingTreatmentId: string,\n  existingTreatmentIds: string[]\n): string[] {\n  const exclusivity = getTreatmentExclusivity(conflictingTreatmentId);\n  if (!exclusivity?.exclusiveCategory) {\n    return [];\n  }\n\n  // Find all treatments in the same category that don't conflict with existing selections\n  const alternatives: string[] = [];\n  const conflictingIds = new Set(existingTreatmentIds);\n\n  // Look through all treatments for same category that aren't already conflicting\n  for (const treatment of ALL_TREATMENTS) {\n    if (treatment.id === conflictingTreatmentId) continue;\n    if (conflictingIds.has(treatment.id)) continue;\n\n    // Check if this treatment could address similar issues\n    const treatmentExclusivity = getTreatmentExclusivity(treatment.id);\n\n    // Not in same exclusive category = potential alternative\n    if (\n      !treatmentExclusivity?.exclusiveCategory ||\n      treatmentExclusivity.exclusiveCategory !== exclusivity.exclusiveCategory\n    ) {\n      // Check if it targets similar metrics\n      const originalTreatment = ALL_TREATMENTS.find(t => t.id === conflictingTreatmentId);\n      if (originalTreatment) {\n        const sharedMetrics = treatment.targetMetrics.filter(m =>\n          originalTreatment.targetMetrics.includes(m)\n        );\n        if (sharedMetrics.length > 0) {\n          alternatives.push(treatment.id);\n        }\n      }\n    }\n  }\n\n  return alternatives;\n}"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1739,"cache_read_input_tokens":84091,"cache_creation":{"ephemeral_5m_input_tokens":1739,"ephemeral_1h_input_tokens":0},"output_tokens":2783,"service_tier":"standard"}},"requestId":"req_011CWVVAWZWQ7f2gyWiL6PS9","type":"assistant","uuid":"5e92f072-8f8c-4847-a018-0dccd8678f24","timestamp":"2025-12-26T14:51:47.139Z"}
{"parentUuid":"5e92f072-8f8c-4847-a018-0dccd8678f24","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BCUMPXSFUS8XZa9fMHwkvN","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   693→\n   694→  return `${symbol}${min.toLocaleString()} - ${symbol}${max.toLocaleString()}`;\n   695→}\n   696→\n   697→/**\n   698→ * Get summary statistics for a plan\n   699→ */\n   700→export function getPlanSummary(plan: RecommendationPlan): {\n   701→  totalRecommendations: number;\n   702→  highPriority: number;\n   703→  mediumPriority: number;\n   704→  lowPriority: number;\n   705→  categoryCounts: Record<string, number>;\n   706→  estimatedTotalImprovement: number;\n   707→} {\n   708→  const all = [\n   709→    ...plan.lifestyle,\n   710→    ...plan.softmaxxing,\n   711→    ...plan.nonSurgical,\n   712→    ...plan.minimallyInvasive,\n   713→    ...plan.surgical,\n   714→  ];\n   715→\n   716→  return {\n   717→    totalRecommendations: all.length,\n   718→    highPriority: all.filter(r => r.priority === 'high').length,\n   719→    mediumPriority: all.filter(r => r.priority === 'medium').length,\n   720→    lowPriority: all.filter(r => r.priority === 'low').length,\n   721→    categoryCounts: {\n   722→      lifestyle: plan.lifestyle.length,\n   723→      softmaxxing: plan.softmaxxing.length,\n   724→      nonSurgical: plan.nonSurgical.length,\n   725→      minimallyInvasive: plan.minimallyInvasive.length,\n   726→      surgical: plan.surgical.length,\n   727→      supplements: plan.supplements.length,\n   728→    },\n   729→    estimatedTotalImprovement: plan.potentialImprovement,\n   730→  };\n   731→}\n   732→\n   733→// ============================================\n   734→// TREATMENT EXCLUSIVITY & CONFLICT DETECTION\n   735→// ============================================\n   736→\n   737→import {\n   738→  treatmentsConflict,\n   739→  getConflictingTreatments,\n   740→  getTreatmentExclusivity,\n   741→  CONFLICT_REASONS,\n   742→} from '../advice-engine';\n   743→import type { ExclusiveCategory } from './types';\n   744→\n   745→/**\n   746→ * Conflict information for a pair of treatments\n   747→ */\n   748→export interface TreatmentConflict {\n   749→  treatment1Id: string;\n   750→  treatment1Name: string;\n   751→  treatment2Id: string;\n   752→  treatment2Name: string;\n   753→  reason: string;\n   754→  category?: ExclusiveCategory;\n   755→}\n   756→\n   757→/**\n   758→ * Find all conflicts in a list of selected treatments\n   759→ */\n   760→export function findTreatmentConflicts(\n   761→  selectedTreatmentIds: string[],\n   762→  treatmentNameMap?: Record<string, string>\n   763→): TreatmentConflict[] {\n   764→  const conflicts: TreatmentConflict[] = [];\n   765→  const seen = new Set<string>();\n   766→\n   767→  for (let i = 0; i < selectedTreatmentIds.length; i++) {\n   768→    for (let j = i + 1; j < selectedTreatmentIds.length; j++) {\n   769→      const id1 = selectedTreatmentIds[i];\n   770→      const id2 = selectedTreatmentIds[j];\n   771→\n   772→      // Create unique key for this pair\n   773→      const pairKey = [id1, id2].sort().join(':');\n   774→      if (seen.has(pairKey)) continue;\n   775→      seen.add(pairKey);\n   776→\n   777→      if (treatmentsConflict(id1, id2)) {\n   778→        const exclusivity1 = getTreatmentExclusivity(id1);\n   779→        const exclusivity2 = getTreatmentExclusivity(id2);\n   780→        const category = exclusivity1?.exclusiveCategory || exclusivity2?.exclusiveCategory;\n   781→        const reason = category\n   782→          ? CONFLICT_REASONS[category]\n   783→          : 'These treatments are mutually exclusive and should not be combined.';\n   784→\n   785→        conflicts.push({\n   786→          treatment1Id: id1,\n   787→          treatment1Name: treatmentNameMap?.[id1] || id1,\n   788→          treatment2Id: id2,\n   789→          treatment2Name: treatmentNameMap?.[id2] || id2,\n   790→          reason,\n   791→          category,\n   792→        });\n   793→      }\n   794→    }\n   795→  }\n   796→\n   797→  return conflicts;\n   798→}\n   799→\n   800→/**\n   801→ * Filter recommendations to remove conflicting treatments\n   802→ * Keeps the treatment with higher relevance score when conflicts occur\n   803→ */\n   804→export function filterConflictingRecommendations(\n   805→  recommendations: TreatmentRecommendation[]\n   806→): {\n   807→  filtered: TreatmentRecommendation[];\n   808→  removed: TreatmentRecommendation[];\n   809→  conflicts: TreatmentConflict[];\n   810→} {\n   811→  // Sort by relevance score (highest first)\n   812→  const sorted = [...recommendations].sort((a, b) => b.relevanceScore - a.relevanceScore);\n   813→  const filtered: TreatmentRecommendation[] = [];\n   814→  const removed: TreatmentRecommendation[] = [];\n   815→  const conflicts: TreatmentConflict[] = [];\n   816→  const selectedIds = new Set<string>();\n   817→\n   818→  for (const rec of sorted) {\n   819→    const treatmentId = rec.treatment.id;\n   820→    const conflictingIds = getConflictingTreatments(treatmentId);\n   821→\n   822→    // Check if any already-selected treatment conflicts with this one\n   823→    let hasConflict = false;\n   824→    let conflictingSelectedId: string | null = null;\n   825→\n   826→    for (const selectedId of selectedIds) {\n   827→      if (conflictingIds.includes(selectedId)) {\n   828→        hasConflict = true;\n   829→        conflictingSelectedId = selectedId;\n   830→        break;\n   831→      }\n   832→    }\n   833→\n   834→    if (hasConflict && conflictingSelectedId) {\n   835→      // Record the conflict\n   836→      const exclusivity = getTreatmentExclusivity(treatmentId);\n   837→      const category = exclusivity?.exclusiveCategory;\n   838→      const reason = category\n   839→        ? CONFLICT_REASONS[category]\n   840→        : 'These treatments are mutually exclusive.';\n   841→\n   842→      // Find the conflicting recommendation for name lookup\n   843→      const conflictingRec = filtered.find(r => r.treatment.id === conflictingSelectedId);\n   844→\n   845→      conflicts.push({\n   846→        treatment1Id: conflictingSelectedId,\n   847→        treatment1Name: conflictingRec?.treatment.name || conflictingSelectedId,\n   848→        treatment2Id: treatmentId,\n   849→        treatment2Name: rec.treatment.name,\n   850→        reason,\n   851→        category,\n   852→      });\n   853→\n   854→      removed.push(rec);\n   855→    } else {\n   856→      filtered.push(rec);\n   857→      selectedIds.add(treatmentId);\n   858→    }\n   859→  }\n   860→\n   861→  return { filtered, removed, conflicts };\n   862→}\n   863→\n   864→/**\n   865→ * Validate a single treatment selection against existing selections\n   866→ */\n   867→export function validateTreatmentSelection(\n   868→  newTreatmentId: string,\n   869→  existingTreatmentIds: string[],\n   870→  treatmentNameMap?: Record<string, string>\n   871→): {\n   872→  isValid: boolean;\n   873→  conflicts: TreatmentConflict[];\n   874→} {\n   875→  const conflicts: TreatmentConflict[] = [];\n   876→  const conflictingIds = getConflictingTreatments(newTreatmentId);\n   877→\n   878→  for (const existingId of existingTreatmentIds) {\n   879→    if (conflictingIds.includes(existingId)) {\n   880→      const exclusivity = getTreatmentExclusivity(newTreatmentId);\n   881→      const category = exclusivity?.exclusiveCategory;\n   882→      const reason = category\n   883→        ? CONFLICT_REASONS[category]\n   884→        : 'These treatments are mutually exclusive.';\n   885→\n   886→      conflicts.push({\n   887→        treatment1Id: existingId,\n   888→        treatment1Name: treatmentNameMap?.[existingId] || existingId,\n   889→        treatment2Id: newTreatmentId,\n   890→        treatment2Name: treatmentNameMap?.[newTreatmentId] || newTreatmentId,\n   891→        reason,\n   892→        category,\n   893→      });\n   894→    }\n   895→  }\n   896→\n   897→  return {\n   898→    isValid: conflicts.length === 0,\n   899→    conflicts,\n   900→  };\n   901→}\n   902→\n   903→/**\n   904→ * Get a recommended alternative when a treatment conflicts\n   905→ */\n   906→export function getAlternativeTreatments(\n   907→  conflictingTreatmentId: string,\n   908→  existingTreatmentIds: string[]\n   909→): string[] {\n   910→  const exclusivity = getTreatmentExclusivity(conflictingTreatmentId);\n   911→  if (!exclusivity?.exclusiveCategory) {\n   912→    return [];\n   913→  }\n   914→\n   915→  // Find all treatments in the same category that don't conflict with existing selections\n   916→  const alternatives: string[] = [];\n   917→  const conflictingIds = new Set(existingTreatmentIds);\n   918→\n   919→  // Look through all treatments for same category that aren't already conflicting\n   920→  for (const treatment of ALL_TREATMENTS) {\n   921→    if (treatment.id === conflictingTreatmentId) continue;\n   922→    if (conflictingIds.has(treatment.id)) continue;\n   923→\n   924→    // Check if this treatment could address similar issues\n   925→    const treatmentExclusivity = getTreatmentExclusivity(treatment.id);\n   926→\n   927→    // Not in same exclusive category = potential alternative\n   928→    if (\n   929→      !treatmentExclusivity?.exclusiveCategory ||\n   930→      treatmentExclusivity.exclusiveCategory !== exclusivity.exclusiveCategory\n   931→    ) {\n   932→      // Check if it targets similar metrics\n   933→      const originalTreatment = ALL_TREATMENTS.find(t => t.id === conflictingTreatmentId);\n   934→      if (originalTreatment) {\n   935→        const sharedMetrics = treatment.targetMetrics.filter(m =>\n   936→          originalTreatment.targetMetrics.includes(m)\n   937→        );\n   938→        if (sharedMetrics.length > 0) {\n   939→          alternatives.push(treatment.id);\n   940→        }\n   941→      }\n   942→    }\n   943→  }\n   944→\n   945→  return alternatives;\n   946→}\n   947→"}]},"uuid":"c50f4fd0-f95e-4020-bfab-5f38dd815a70","timestamp":"2025-12-26T14:51:47.193Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","oldString":"/**\n * Get summary statistics for a plan\n */\nexport function getPlanSummary(plan: RecommendationPlan): {\n  totalRecommendations: number;\n  highPriority: number;\n  mediumPriority: number;\n  lowPriority: number;\n  categoryCounts: Record<string, number>;\n  estimatedTotalImprovement: number;\n} {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return {\n    totalRecommendations: all.length,\n    highPriority: all.filter(r => r.priority === 'high').length,\n    mediumPriority: all.filter(r => r.priority === 'medium').length,\n    lowPriority: all.filter(r => r.priority === 'low').length,\n    categoryCounts: {\n      lifestyle: plan.lifestyle.length,\n      softmaxxing: plan.softmaxxing.length,\n      nonSurgical: plan.nonSurgical.length,\n      minimallyInvasive: plan.minimallyInvasive.length,\n      surgical: plan.surgical.length,\n      supplements: plan.supplements.length,\n    },\n    estimatedTotalImprovement: plan.potentialImprovement,\n  };\n}","newString":"/**\n * Get summary statistics for a plan\n */\nexport function getPlanSummary(plan: RecommendationPlan): {\n  totalRecommendations: number;\n  highPriority: number;\n  mediumPriority: number;\n  lowPriority: number;\n  categoryCounts: Record<string, number>;\n  estimatedTotalImprovement: number;\n} {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return {\n    totalRecommendations: all.length,\n    highPriority: all.filter(r => r.priority === 'high').length,\n    mediumPriority: all.filter(r => r.priority === 'medium').length,\n    lowPriority: all.filter(r => r.priority === 'low').length,\n    categoryCounts: {\n      lifestyle: plan.lifestyle.length,\n      softmaxxing: plan.softmaxxing.length,\n      nonSurgical: plan.nonSurgical.length,\n      minimallyInvasive: plan.minimallyInvasive.length,\n      surgical: plan.surgical.length,\n      supplements: plan.supplements.length,\n    },\n    estimatedTotalImprovement: plan.potentialImprovement,\n  };\n}\n\n// ============================================\n// TREATMENT EXCLUSIVITY & CONFLICT DETECTION\n// ============================================\n\nimport {\n  treatmentsConflict,\n  getConflictingTreatments,\n  getTreatmentExclusivity,\n  CONFLICT_REASONS,\n} from '../advice-engine';\nimport type { ExclusiveCategory } from './types';\n\n/**\n * Conflict information for a pair of treatments\n */\nexport interface TreatmentConflict {\n  treatment1Id: string;\n  treatment1Name: string;\n  treatment2Id: string;\n  treatment2Name: string;\n  reason: string;\n  category?: ExclusiveCategory;\n}\n\n/**\n * Find all conflicts in a list of selected treatments\n */\nexport function findTreatmentConflicts(\n  selectedTreatmentIds: string[],\n  treatmentNameMap?: Record<string, string>\n): TreatmentConflict[] {\n  const conflicts: TreatmentConflict[] = [];\n  const seen = new Set<string>();\n\n  for (let i = 0; i < selectedTreatmentIds.length; i++) {\n    for (let j = i + 1; j < selectedTreatmentIds.length; j++) {\n      const id1 = selectedTreatmentIds[i];\n      const id2 = selectedTreatmentIds[j];\n\n      // Create unique key for this pair\n      const pairKey = [id1, id2].sort().join(':');\n      if (seen.has(pairKey)) continue;\n      seen.add(pairKey);\n\n      if (treatmentsConflict(id1, id2)) {\n        const exclusivity1 = getTreatmentExclusivity(id1);\n        const exclusivity2 = getTreatmentExclusivity(id2);\n        const category = exclusivity1?.exclusiveCategory || exclusivity2?.exclusiveCategory;\n        const reason = category\n          ? CONFLICT_REASONS[category]\n          : 'These treatments are mutually exclusive and should not be combined.';\n\n        conflicts.push({\n          treatment1Id: id1,\n          treatment1Name: treatmentNameMap?.[id1] || id1,\n          treatment2Id: id2,\n          treatment2Name: treatmentNameMap?.[id2] || id2,\n          reason,\n          category,\n        });\n      }\n    }\n  }\n\n  return conflicts;\n}\n\n/**\n * Filter recommendations to remove conflicting treatments\n * Keeps the treatment with higher relevance score when conflicts occur\n */\nexport function filterConflictingRecommendations(\n  recommendations: TreatmentRecommendation[]\n): {\n  filtered: TreatmentRecommendation[];\n  removed: TreatmentRecommendation[];\n  conflicts: TreatmentConflict[];\n} {\n  // Sort by relevance score (highest first)\n  const sorted = [...recommendations].sort((a, b) => b.relevanceScore - a.relevanceScore);\n  const filtered: TreatmentRecommendation[] = [];\n  const removed: TreatmentRecommendation[] = [];\n  const conflicts: TreatmentConflict[] = [];\n  const selectedIds = new Set<string>();\n\n  for (const rec of sorted) {\n    const treatmentId = rec.treatment.id;\n    const conflictingIds = getConflictingTreatments(treatmentId);\n\n    // Check if any already-selected treatment conflicts with this one\n    let hasConflict = false;\n    let conflictingSelectedId: string | null = null;\n\n    for (const selectedId of selectedIds) {\n      if (conflictingIds.includes(selectedId)) {\n        hasConflict = true;\n        conflictingSelectedId = selectedId;\n        break;\n      }\n    }\n\n    if (hasConflict && conflictingSelectedId) {\n      // Record the conflict\n      const exclusivity = getTreatmentExclusivity(treatmentId);\n      const category = exclusivity?.exclusiveCategory;\n      const reason = category\n        ? CONFLICT_REASONS[category]\n        : 'These treatments are mutually exclusive.';\n\n      // Find the conflicting recommendation for name lookup\n      const conflictingRec = filtered.find(r => r.treatment.id === conflictingSelectedId);\n\n      conflicts.push({\n        treatment1Id: conflictingSelectedId,\n        treatment1Name: conflictingRec?.treatment.name || conflictingSelectedId,\n        treatment2Id: treatmentId,\n        treatment2Name: rec.treatment.name,\n        reason,\n        category,\n      });\n\n      removed.push(rec);\n    } else {\n      filtered.push(rec);\n      selectedIds.add(treatmentId);\n    }\n  }\n\n  return { filtered, removed, conflicts };\n}\n\n/**\n * Validate a single treatment selection against existing selections\n */\nexport function validateTreatmentSelection(\n  newTreatmentId: string,\n  existingTreatmentIds: string[],\n  treatmentNameMap?: Record<string, string>\n): {\n  isValid: boolean;\n  conflicts: TreatmentConflict[];\n} {\n  const conflicts: TreatmentConflict[] = [];\n  const conflictingIds = getConflictingTreatments(newTreatmentId);\n\n  for (const existingId of existingTreatmentIds) {\n    if (conflictingIds.includes(existingId)) {\n      const exclusivity = getTreatmentExclusivity(newTreatmentId);\n      const category = exclusivity?.exclusiveCategory;\n      const reason = category\n        ? CONFLICT_REASONS[category]\n        : 'These treatments are mutually exclusive.';\n\n      conflicts.push({\n        treatment1Id: existingId,\n        treatment1Name: treatmentNameMap?.[existingId] || existingId,\n        treatment2Id: newTreatmentId,\n        treatment2Name: treatmentNameMap?.[newTreatmentId] || newTreatmentId,\n        reason,\n        category,\n      });\n    }\n  }\n\n  return {\n    isValid: conflicts.length === 0,\n    conflicts,\n  };\n}\n\n/**\n * Get a recommended alternative when a treatment conflicts\n */\nexport function getAlternativeTreatments(\n  conflictingTreatmentId: string,\n  existingTreatmentIds: string[]\n): string[] {\n  const exclusivity = getTreatmentExclusivity(conflictingTreatmentId);\n  if (!exclusivity?.exclusiveCategory) {\n    return [];\n  }\n\n  // Find all treatments in the same category that don't conflict with existing selections\n  const alternatives: string[] = [];\n  const conflictingIds = new Set(existingTreatmentIds);\n\n  // Look through all treatments for same category that aren't already conflicting\n  for (const treatment of ALL_TREATMENTS) {\n    if (treatment.id === conflictingTreatmentId) continue;\n    if (conflictingIds.has(treatment.id)) continue;\n\n    // Check if this treatment could address similar issues\n    const treatmentExclusivity = getTreatmentExclusivity(treatment.id);\n\n    // Not in same exclusive category = potential alternative\n    if (\n      !treatmentExclusivity?.exclusiveCategory ||\n      treatmentExclusivity.exclusiveCategory !== exclusivity.exclusiveCategory\n    ) {\n      // Check if it targets similar metrics\n      const originalTreatment = ALL_TREATMENTS.find(t => t.id === conflictingTreatmentId);\n      if (originalTreatment) {\n        const sharedMetrics = treatment.targetMetrics.filter(m =>\n          originalTreatment.targetMetrics.includes(m)\n        );\n        if (sharedMetrics.length > 0) {\n          alternatives.push(treatment.id);\n        }\n      }\n    }\n  }\n\n  return alternatives;\n}","originalFile":"/**\n * Recommendation Engine\n * Analyzes facial metrics and generates personalized treatment recommendations\n */\n\nimport {\n  Treatment,\n  Surgery,\n  Supplement,\n  TreatmentRecommendation,\n  MetricAnalysis,\n  RecommendationPlan,\n  OrderOfOperation,\n  TreatmentCategory,\n  Gender,\n  ProfileType,\n} from './types';\nimport { SOFTMAXXING_TREATMENTS } from './softmaxxing';\nimport { SURGICAL_TREATMENTS } from './hardmaxxing';\nimport { SUPPLEMENTS } from './supplements';\nimport { NON_SURGICAL_TREATMENTS } from './nonSurgical';\nimport {\n  classifyMetricValue,\n  calculateDeviation,\n  getIssueForMetric,\n  getTreatmentIdsForMetric,\n  getOverallSeverity,\n  harmonyToPSL,\n  estimatePotentialPSL,\n} from './severity';\n\n// ============================================\n// ALL TREATMENTS COMBINED\n// ============================================\n\nconst ALL_TREATMENTS: (Treatment | Surgery)[] = [\n  ...SOFTMAXXING_TREATMENTS,\n  ...NON_SURGICAL_TREATMENTS,\n  ...SURGICAL_TREATMENTS,\n];\n\n// ============================================\n// METRIC ANALYSIS\n// ============================================\n\nexport interface MetricInput {\n  metricId: string;\n  metricName: string;\n  currentValue: number;\n  idealValue: number;\n  idealRange: { min: number; max: number };\n  score: number;\n  profileType: ProfileType;\n}\n\n/**\n * Analyze a single metric and determine severity\n */\nexport function analyzeMetric(\n  input: MetricInput,\n  gender?: Gender\n): MetricAnalysis {\n  const { deviation, deviationPercent, direction } = calculateDeviation(\n    input.metricId,\n    input.currentValue\n  );\n\n  const severity = classifyMetricValue(input.metricId, input.currentValue, gender);\n  const issue = getIssueForMetric(input.metricId, direction);\n\n  return {\n    metricId: input.metricId,\n    metricName: input.metricName,\n    currentValue: input.currentValue,\n    idealValue: input.idealValue,\n    idealRange: input.idealRange,\n    deviation,\n    deviationPercent,\n    score: input.score,\n    severity,\n    issue: issue || undefined,\n    profileType: input.profileType,\n  };\n}\n\n/**\n * Analyze all metrics and sort by severity\n */\nexport function analyzeAllMetrics(\n  metrics: MetricInput[],\n  gender?: Gender\n): MetricAnalysis[] {\n  const analyses = metrics.map(m => analyzeMetric(m, gender));\n\n  // Sort by severity (severe first) then by score (lowest first)\n  const severityOrder = { severe: 0, moderate: 1, mild: 2, optimal: 3 };\n\n  return analyses.sort((a, b) => {\n    const severityDiff = severityOrder[a.severity.severity] - severityOrder[b.severity.severity];\n    if (severityDiff !== 0) return severityDiff;\n    return a.score - b.score;\n  });\n}\n\n// ============================================\n// TREATMENT MATCHING\n// ============================================\n\n/**\n * Find treatment by ID\n */\nexport function findTreatment(id: string): Treatment | Surgery | Supplement | undefined {\n  const treatment = ALL_TREATMENTS.find(t => t.id === id);\n  if (treatment) return treatment;\n\n  return SUPPLEMENTS.find(s => s.id === id);\n}\n\n/**\n * Find treatments that target a specific issue\n */\nexport function findTreatmentsForIssue(issue: string): (Treatment | Surgery)[] {\n  return ALL_TREATMENTS.filter(t =>\n    t.targetIssues.some(i =>\n      i.toLowerCase().includes(issue.toLowerCase()) ||\n      issue.toLowerCase().includes(i.toLowerCase())\n    )\n  );\n}\n\n/**\n * Find treatments that target a specific metric\n */\nexport function findTreatmentsForMetric(metricId: string): (Treatment | Surgery)[] {\n  return ALL_TREATMENTS.filter(t =>\n    t.targetMetrics.some(m =>\n      m.toLowerCase().includes(metricId.toLowerCase()) ||\n      metricId.toLowerCase().includes(m.toLowerCase())\n    )\n  );\n}\n\n/**\n * Score treatment relevance for a metric analysis\n */\nfunction scoreTreatmentRelevance(\n  treatment: Treatment | Surgery,\n  analysis: MetricAnalysis\n): number {\n  let score = 0;\n\n  // Check if treatment targets this metric\n  const targetsMetric = treatment.targetMetrics.some(m =>\n    m.toLowerCase().includes(analysis.metricId.toLowerCase())\n  );\n  if (targetsMetric) score += 30;\n\n  // Check if treatment addresses the issue\n  if (analysis.issue) {\n    const addressesIssue = treatment.targetIssues.some(i =>\n      i.toLowerCase().includes(analysis.issue!.toLowerCase()) ||\n      analysis.issue!.toLowerCase().includes(i.toLowerCase())\n    );\n    if (addressesIssue) score += 40;\n  }\n\n  // Factor in severity\n  const severityMultiplier = {\n    severe: 1.5,\n    moderate: 1.2,\n    mild: 1.0,\n    optimal: 0.3,\n  };\n  score *= severityMultiplier[analysis.severity.severity];\n\n  // Factor in treatment effectiveness\n  score += treatment.effectiveness * 2;\n\n  // Factor in PSL improvement potential\n  const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n  score += avgPSLImprovement * 10;\n\n  return Math.round(score);\n}\n\n/**\n * Generate treatment recommendations for a metric analysis\n */\nexport function getRecommendationsForMetric(\n  analysis: MetricAnalysis,\n  gender?: Gender,\n  maxRecommendations: number = 5\n): TreatmentRecommendation[] {\n  if (analysis.severity.severity === 'optimal') {\n    return []; // No treatment needed for optimal metrics\n  }\n\n  // Get treatment IDs from mapping\n  const { direction } = calculateDeviation(analysis.metricId, analysis.currentValue);\n  const treatmentIds = getTreatmentIdsForMetric(analysis.metricId, direction);\n\n  // Find matching treatments\n  let treatments: (Treatment | Surgery)[] = [];\n\n  // First, add treatments from the mapping\n  for (const id of treatmentIds) {\n    const treatment = findTreatment(id);\n    if (treatment && 'category' in treatment && treatment.category !== undefined) {\n      treatments.push(treatment as Treatment | Surgery);\n    }\n  }\n\n  // Then, find additional treatments that target this metric or issue\n  const additionalTreatments = [\n    ...findTreatmentsForMetric(analysis.metricId),\n    ...(analysis.issue ? findTreatmentsForIssue(analysis.issue) : []),\n  ];\n\n  // Remove duplicates\n  const seenIds = treatments.map(t => t.id);\n  for (const t of additionalTreatments) {\n    if (!seenIds.includes(t.id)) {\n      seenIds.push(t.id);\n      treatments.push(t);\n    }\n  }\n\n  // Filter by gender if specified\n  if (gender) {\n    treatments = treatments.filter(t =>\n      !t.genderSpecific || t.genderSpecific === gender\n    );\n  }\n\n  // Score and rank treatments\n  const scoredTreatments = treatments.map(treatment => ({\n    treatment,\n    relevanceScore: scoreTreatmentRelevance(treatment, analysis),\n  }));\n\n  // Sort by relevance score\n  scoredTreatments.sort((a, b) => b.relevanceScore - a.relevanceScore);\n\n  // Create recommendations\n  return scoredTreatments.slice(0, maxRecommendations).map(({ treatment, relevanceScore }) => {\n    const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n\n    return {\n      treatment,\n      priority: relevanceScore >= 60 ? 'high' as const :\n                relevanceScore >= 40 ? 'medium' as const :\n                'low' as const,\n      relevanceScore,\n      targetMetrics: [analysis.metricId],\n      estimatedImprovement: avgPSLImprovement,\n      reasoning: generateReasoning(treatment, analysis),\n    };\n  });\n}\n\n/**\n * Generate human-readable reasoning for a recommendation\n */\nfunction generateReasoning(\n  treatment: Treatment | Surgery,\n  analysis: MetricAnalysis\n): string {\n  const parts: string[] = [];\n\n  // Issue description\n  if (analysis.issue) {\n    parts.push(`Addresses ${analysis.issue.replace(/_/g, ' ')}`);\n  }\n\n  // Effectiveness\n  parts.push(`Effectiveness: ${treatment.effectiveness}/10`);\n\n  // PSL improvement\n  const pslRange = `${treatment.pslImprovement.min}-${treatment.pslImprovement.max}`;\n  parts.push(`Expected improvement: ${pslRange} PSL points`);\n\n  // Timeline\n  parts.push(`Results in: ${treatment.timelineToResults}`);\n\n  return parts.join('. ') + '.';\n}\n\n// ============================================\n// RECOMMENDATION PLAN GENERATION\n// ============================================\n\n/**\n * Generate a comprehensive recommendation plan\n */\nexport function generateRecommendationPlan(\n  metrics: MetricInput[],\n  overallScore: number,\n  harmonyPercent: number,\n  gender?: Gender\n): RecommendationPlan {\n  // Analyze all metrics\n  const metricAnalyses = analyzeAllMetrics(metrics, gender);\n\n  // Determine strengths and weaknesses\n  const strengths = metricAnalyses.filter(m =>\n    m.severity.severity === 'optimal' || m.score >= 85\n  );\n  const weaknesses = metricAnalyses.filter(m =>\n    m.severity.severity !== 'optimal' && m.score < 85\n  );\n\n  // Get recommendations for each weakness\n  const allRecommendations: TreatmentRecommendation[] = [];\n  for (const weakness of weaknesses) {\n    const recs = getRecommendationsForMetric(weakness, gender);\n    allRecommendations.push(...recs);\n  }\n\n  // Deduplicate recommendations (same treatment might help multiple metrics)\n  const uniqueRecommendations = deduplicateRecommendations(allRecommendations);\n\n  // Categorize recommendations\n  const lifestyle = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'lifestyle' || r.treatment.category === 'softmaxxing'\n  );\n  const softmaxxing = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'softmaxxing'\n  );\n  const nonSurgical = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'non_surgical'\n  );\n  const minimallyInvasive = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'minimally_invasive'\n  );\n  const surgical = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'surgical'\n  );\n\n  // Get supplement recommendations\n  const supplements = getSupplementRecommendations(weaknesses, gender);\n\n  // Calculate PSL ratings\n  const pslRating = harmonyToPSL(harmonyPercent);\n  const treatmentImprovements = uniqueRecommendations.map(r => r.estimatedImprovement);\n  const potentialPSL = estimatePotentialPSL(pslRating.psl, treatmentImprovements);\n\n  // Generate order of operations\n  const orderOfOperations = generateOrderOfOperations(uniqueRecommendations);\n\n  // Get overall severity\n  const overallSeverity = getOverallSeverity(metricAnalyses.map(m => m.severity.severity));\n\n  return {\n    overallScore,\n    overallSeverity,\n    harmonyScore: harmonyPercent,\n    percentile: pslRating.percentile,\n    metricAnalyses,\n    strengths,\n    weaknesses,\n    lifestyle,\n    softmaxxing,\n    nonSurgical,\n    minimallyInvasive,\n    surgical,\n    supplements,\n    currentPSL: pslRating.psl,\n    potentialPSL: potentialPSL.potentialPSL,\n    potentialImprovement: potentialPSL.totalImprovement,\n    orderOfOperations,\n  };\n}\n\n/**\n * Deduplicate recommendations, combining target metrics for same treatment\n */\nfunction deduplicateRecommendations(\n  recommendations: TreatmentRecommendation[]\n): TreatmentRecommendation[] {\n  const byId = new Map<string, TreatmentRecommendation>();\n\n  for (const rec of recommendations) {\n    const existing = byId.get(rec.treatment.id);\n    if (existing) {\n      // Combine target metrics (deduplicate using filter)\n      const combined = [...existing.targetMetrics, ...rec.targetMetrics];\n      existing.targetMetrics = combined.filter((m, i) => combined.indexOf(m) === i);\n\n      // Take higher relevance score\n      existing.relevanceScore = Math.max(existing.relevanceScore, rec.relevanceScore);\n\n      // Update priority based on new relevance\n      existing.priority = existing.relevanceScore >= 60 ? 'high' :\n                         existing.relevanceScore >= 40 ? 'medium' :\n                         'low';\n    } else {\n      byId.set(rec.treatment.id, { ...rec });\n    }\n  }\n\n  return Array.from(byId.values()).sort((a, b) => b.relevanceScore - a.relevanceScore);\n}\n\n/**\n * Get supplement recommendations based on weaknesses\n */\nfunction getSupplementRecommendations(\n  weaknesses: MetricAnalysis[],\n  gender?: Gender\n): TreatmentRecommendation[] {\n  const recommendations: TreatmentRecommendation[] = [];\n\n  // Map weakness types to supplement categories\n  const hasSkinIssues = weaknesses.some(w =>\n    w.issue?.includes('skin') || w.metricId.includes('skin')\n  );\n  const hasHairIssues = weaknesses.some(w =>\n    w.issue?.includes('hair') || w.metricId.includes('hairline')\n  );\n  const hasGeneralAging = weaknesses.some(w =>\n    w.issue?.includes('aging') || w.severity.severity === 'moderate' || w.severity.severity === 'severe'\n  );\n\n  // Helper to create supplement recommendation\n  const createSupplementRec = (\n    supp: Supplement,\n    priority: 'high' | 'medium' | 'low',\n    relevanceScore: number,\n    targetMetrics: string[],\n    reasoning: string\n  ): TreatmentRecommendation => ({\n    treatment: {\n      id: supp.id,\n      name: supp.name,\n      category: 'lifestyle',\n      description: supp.description,\n      howItWorks: `Dosage: ${supp.dosage} ${supp.frequency}`,\n      effectiveness: supp.effectiveness,\n      evidenceLevel: supp.evidenceLevel,\n      pslImprovement: { min: 0.05, max: 0.15 },\n      costLevel: supp.costPerMonth.max > 30 ? 'medium' : 'low',\n      costRange: { min: supp.costPerMonth.min, max: supp.costPerMonth.max, currency: 'USD' },\n      costFrequency: 'monthly',\n      timelineToResults: supp.timelineToResults,\n      resultsDuration: 'Ongoing with continued use',\n      maintenanceRequired: true,\n      maintenanceFrequency: supp.frequency,\n      recoveryTime: 'None',\n      downtime: 'None',\n      painLevel: 'none',\n      riskLevel: supp.riskLevel,\n      sideEffects: supp.sideEffects,\n      contraindications: supp.contraindications,\n      targetMetrics,\n      targetIssues: supp.targetBenefits,\n      notes: supp.notes,\n      sources: supp.sources,\n    },\n    priority,\n    relevanceScore,\n    targetMetrics,\n    estimatedImprovement: 0.1,\n    reasoning,\n  });\n\n  // Add relevant supplements\n  if (hasSkinIssues || hasGeneralAging) {\n    const skinSupplements = SUPPLEMENTS.filter(s =>\n      s.category === 'skin' || s.category === 'anti-aging'\n    );\n    for (const supp of skinSupplements.slice(0, 3)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'medium',\n        50,\n        ['skin_quality'],\n        `${supp.name} supports skin health and anti-aging.`\n      ));\n    }\n  }\n\n  if (hasHairIssues && gender === 'male') {\n    const hairSupplements = SUPPLEMENTS.filter(s => s.category === 'hair');\n    for (const supp of hairSupplements.slice(0, 3)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'medium',\n        45,\n        ['hairline'],\n        `${supp.name} supports hair health.`\n      ));\n    }\n  }\n\n  // Always recommend foundational supplements\n  const foundational = SUPPLEMENTS.filter(s =>\n    ['vitamin_d3', 'omega_3', 'magnesium'].includes(s.id)\n  );\n  for (const supp of foundational) {\n    if (!recommendations.some(r => r.treatment.id === supp.id)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'low',\n        30,\n        ['general_health'],\n        `${supp.name} supports overall health and wellbeing.`\n      ));\n    }\n  }\n\n  return recommendations.slice(0, 10);\n}\n\n/**\n * Generate order of operations for treatments\n */\nfunction generateOrderOfOperations(\n  recommendations: TreatmentRecommendation[]\n): OrderOfOperation[] {\n  const operations: OrderOfOperation[] = [];\n\n  // Define category order: lifestyle -> softmaxxing -> non-surgical -> minimally invasive -> surgical\n  const categoryOrder: TreatmentCategory[] = [\n    'lifestyle',\n    'softmaxxing',\n    'non_surgical',\n    'minimally_invasive',\n    'surgical',\n  ];\n\n  // Group by category (only for valid treatment categories)\n  const validCategories: TreatmentCategory[] = ['lifestyle', 'softmaxxing', 'non_surgical', 'minimally_invasive', 'surgical'];\n  const byCategory = new Map<TreatmentCategory, TreatmentRecommendation[]>();\n  for (const rec of recommendations) {\n    const cat = rec.treatment.category as TreatmentCategory;\n    if (validCategories.includes(cat)) {\n      if (!byCategory.has(cat)) {\n        byCategory.set(cat, []);\n      }\n      byCategory.get(cat)!.push(rec);\n    }\n  }\n\n  let step = 1;\n  for (const category of categoryOrder) {\n    const recs = byCategory.get(category) || [];\n    // Sort by priority and relevance\n    recs.sort((a, b) => {\n      if (a.priority !== b.priority) {\n        const priorityOrder = { high: 0, medium: 1, low: 2 };\n        return priorityOrder[a.priority] - priorityOrder[b.priority];\n      }\n      return b.relevanceScore - a.relevanceScore;\n    });\n\n    for (const rec of recs.slice(0, 3)) { // Max 3 per category\n      const treatment = rec.treatment as Treatment | Surgery;\n      const operation: OrderOfOperation = {\n        step,\n        category,\n        treatment,\n        reasoning: getStepReasoning(step, category),\n      };\n\n      // Add prerequisites for surgical procedures\n      if (category === 'surgical') {\n        operation.prerequisites = ['Complete non-surgical options first', 'Consult with board-certified surgeon'];\n        operation.waitTime = '6-12 months recovery between major procedures';\n      }\n\n      operations.push(operation);\n      step++;\n    }\n  }\n\n  return operations;\n}\n\n/**\n * Generate reasoning for a step in order of operations\n */\nfunction getStepReasoning(\n  step: number,\n  category: TreatmentCategory\n): string {\n  if (step === 1) {\n    return 'Start with foundational changes before considering more invasive options.';\n  }\n\n  if (category === 'lifestyle' || category === 'softmaxxing') {\n    return 'Low-risk, reversible changes that can provide noticeable improvement.';\n  }\n\n  if (category === 'non_surgical') {\n    return 'Non-invasive treatments with minimal downtime to test results before committing to surgery.';\n  }\n\n  if (category === 'minimally_invasive') {\n    return 'Minimally invasive procedures can provide significant results with less risk than surgery.';\n  }\n\n  if (category === 'surgical') {\n    return 'Consider surgery only after exhausting less invasive options and with realistic expectations.';\n  }\n\n  return '';\n}\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\n/**\n * Get top priority recommendations across all categories\n */\nexport function getTopRecommendations(\n  plan: RecommendationPlan,\n  count: number = 5\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all\n    .sort((a, b) => b.relevanceScore - a.relevanceScore)\n    .slice(0, count);\n}\n\n/**\n * Get recommendations filtered by cost level\n */\nexport function getRecommendationsByCost(\n  plan: RecommendationPlan,\n  maxCost: 'free' | 'low' | 'medium' | 'high' | 'very_high'\n): TreatmentRecommendation[] {\n  const costOrder = ['free', 'low', 'medium', 'high', 'very_high'];\n  const maxCostIndex = costOrder.indexOf(maxCost);\n\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('costLevel' in treatment) {\n      return costOrder.indexOf(treatment.costLevel) <= maxCostIndex;\n    }\n    return true;\n  });\n}\n\n/**\n * Get recommendations with minimal downtime\n */\nexport function getNoDowntimeRecommendations(\n  plan: RecommendationPlan\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('downtime' in treatment) {\n      const downtime = treatment.downtime.toLowerCase();\n      return downtime.includes('none') || downtime.includes('minimal');\n    }\n    return true;\n  });\n}\n\n/**\n * Format cost for display\n */\nexport function formatCost(treatment: Treatment | Surgery): string {\n  const { min, max, currency } = treatment.costRange;\n  const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : currency;\n\n  if (min === max) {\n    return `${symbol}${min.toLocaleString()}`;\n  }\n\n  return `${symbol}${min.toLocaleString()} - ${symbol}${max.toLocaleString()}`;\n}\n\n/**\n * Get summary statistics for a plan\n */\nexport function getPlanSummary(plan: RecommendationPlan): {\n  totalRecommendations: number;\n  highPriority: number;\n  mediumPriority: number;\n  lowPriority: number;\n  categoryCounts: Record<string, number>;\n  estimatedTotalImprovement: number;\n} {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return {\n    totalRecommendations: all.length,\n    highPriority: all.filter(r => r.priority === 'high').length,\n    mediumPriority: all.filter(r => r.priority === 'medium').length,\n    lowPriority: all.filter(r => r.priority === 'low').length,\n    categoryCounts: {\n      lifestyle: plan.lifestyle.length,\n      softmaxxing: plan.softmaxxing.length,\n      nonSurgical: plan.nonSurgical.length,\n      minimallyInvasive: plan.minimallyInvasive.length,\n      surgical: plan.surgical.length,\n      supplements: plan.supplements.length,\n    },\n    estimatedTotalImprovement: plan.potentialImprovement,\n  };\n}\n","structuredPatch":[{"oldStart":729,"oldLines":3,"newStart":729,"newLines":218,"lines":["     estimatedTotalImprovement: plan.potentialImprovement,","   };"," }","+","+// ============================================","+// TREATMENT EXCLUSIVITY & CONFLICT DETECTION","+// ============================================","+","+import {","+  treatmentsConflict,","+  getConflictingTreatments,","+  getTreatmentExclusivity,","+  CONFLICT_REASONS,","+} from '../advice-engine';","+import type { ExclusiveCategory } from './types';","+","+/**","+ * Conflict information for a pair of treatments","+ */","+export interface TreatmentConflict {","+  treatment1Id: string;","+  treatment1Name: string;","+  treatment2Id: string;","+  treatment2Name: string;","+  reason: string;","+  category?: ExclusiveCategory;","+}","+","+/**","+ * Find all conflicts in a list of selected treatments","+ */","+export function findTreatmentConflicts(","+  selectedTreatmentIds: string[],","+  treatmentNameMap?: Record<string, string>","+): TreatmentConflict[] {","+  const conflicts: TreatmentConflict[] = [];","+  const seen = new Set<string>();","+","+  for (let i = 0; i < selectedTreatmentIds.length; i++) {","+    for (let j = i + 1; j < selectedTreatmentIds.length; j++) {","+      const id1 = selectedTreatmentIds[i];","+      const id2 = selectedTreatmentIds[j];","+","+      // Create unique key for this pair","+      const pairKey = [id1, id2].sort().join(':');","+      if (seen.has(pairKey)) continue;","+      seen.add(pairKey);","+","+      if (treatmentsConflict(id1, id2)) {","+        const exclusivity1 = getTreatmentExclusivity(id1);","+        const exclusivity2 = getTreatmentExclusivity(id2);","+        const category = exclusivity1?.exclusiveCategory || exclusivity2?.exclusiveCategory;","+        const reason = category","+          ? CONFLICT_REASONS[category]","+          : 'These treatments are mutually exclusive and should not be combined.';","+","+        conflicts.push({","+          treatment1Id: id1,","+          treatment1Name: treatmentNameMap?.[id1] || id1,","+          treatment2Id: id2,","+          treatment2Name: treatmentNameMap?.[id2] || id2,","+          reason,","+          category,","+        });","+      }","+    }","+  }","+","+  return conflicts;","+}","+","+/**","+ * Filter recommendations to remove conflicting treatments","+ * Keeps the treatment with higher relevance score when conflicts occur","+ */","+export function filterConflictingRecommendations(","+  recommendations: TreatmentRecommendation[]","+): {","+  filtered: TreatmentRecommendation[];","+  removed: TreatmentRecommendation[];","+  conflicts: TreatmentConflict[];","+} {","+  // Sort by relevance score (highest first)","+  const sorted = [...recommendations].sort((a, b) => b.relevanceScore - a.relevanceScore);","+  const filtered: TreatmentRecommendation[] = [];","+  const removed: TreatmentRecommendation[] = [];","+  const conflicts: TreatmentConflict[] = [];","+  const selectedIds = new Set<string>();","+","+  for (const rec of sorted) {","+    const treatmentId = rec.treatment.id;","+    const conflictingIds = getConflictingTreatments(treatmentId);","+","+    // Check if any already-selected treatment conflicts with this one","+    let hasConflict = false;","+    let conflictingSelectedId: string | null = null;","+","+    for (const selectedId of selectedIds) {","+      if (conflictingIds.includes(selectedId)) {","+        hasConflict = true;","+        conflictingSelectedId = selectedId;","+        break;","+      }","+    }","+","+    if (hasConflict && conflictingSelectedId) {","+      // Record the conflict","+      const exclusivity = getTreatmentExclusivity(treatmentId);","+      const category = exclusivity?.exclusiveCategory;","+      const reason = category","+        ? CONFLICT_REASONS[category]","+        : 'These treatments are mutually exclusive.';","+","+      // Find the conflicting recommendation for name lookup","+      const conflictingRec = filtered.find(r => r.treatment.id === conflictingSelectedId);","+","+      conflicts.push({","+        treatment1Id: conflictingSelectedId,","+        treatment1Name: conflictingRec?.treatment.name || conflictingSelectedId,","+        treatment2Id: treatmentId,","+        treatment2Name: rec.treatment.name,","+        reason,","+        category,","+      });","+","+      removed.push(rec);","+    } else {","+      filtered.push(rec);","+      selectedIds.add(treatmentId);","+    }","+  }","+","+  return { filtered, removed, conflicts };","+}","+","+/**","+ * Validate a single treatment selection against existing selections","+ */","+export function validateTreatmentSelection(","+  newTreatmentId: string,","+  existingTreatmentIds: string[],","+  treatmentNameMap?: Record<string, string>","+): {","+  isValid: boolean;","+  conflicts: TreatmentConflict[];","+} {","+  const conflicts: TreatmentConflict[] = [];","+  const conflictingIds = getConflictingTreatments(newTreatmentId);","+","+  for (const existingId of existingTreatmentIds) {","+    if (conflictingIds.includes(existingId)) {","+      const exclusivity = getTreatmentExclusivity(newTreatmentId);","+      const category = exclusivity?.exclusiveCategory;","+      const reason = category","+        ? CONFLICT_REASONS[category]","+        : 'These treatments are mutually exclusive.';","+","+      conflicts.push({","+        treatment1Id: existingId,","+        treatment1Name: treatmentNameMap?.[existingId] || existingId,","+        treatment2Id: newTreatmentId,","+        treatment2Name: treatmentNameMap?.[newTreatmentId] || newTreatmentId,","+        reason,","+        category,","+      });","+    }","+  }","+","+  return {","+    isValid: conflicts.length === 0,","+    conflicts,","+  };","+}","+","+/**","+ * Get a recommended alternative when a treatment conflicts","+ */","+export function getAlternativeTreatments(","+  conflictingTreatmentId: string,","+  existingTreatmentIds: string[]","+): string[] {","+  const exclusivity = getTreatmentExclusivity(conflictingTreatmentId);","+  if (!exclusivity?.exclusiveCategory) {","+    return [];","+  }","+","+  // Find all treatments in the same category that don't conflict with existing selections","+  const alternatives: string[] = [];","+  const conflictingIds = new Set(existingTreatmentIds);","+","+  // Look through all treatments for same category that aren't already conflicting","+  for (const treatment of ALL_TREATMENTS) {","+    if (treatment.id === conflictingTreatmentId) continue;","+    if (conflictingIds.has(treatment.id)) continue;","+","+    // Check if this treatment could address similar issues","+    const treatmentExclusivity = getTreatmentExclusivity(treatment.id);","+","+    // Not in same exclusive category = potential alternative","+    if (","+      !treatmentExclusivity?.exclusiveCategory ||","+      treatmentExclusivity.exclusiveCategory !== exclusivity.exclusiveCategory","+    ) {","+      // Check if it targets similar metrics","+      const originalTreatment = ALL_TREATMENTS.find(t => t.id === conflictingTreatmentId);","+      if (originalTreatment) {","+        const sharedMetrics = treatment.targetMetrics.filter(m =>","+          originalTreatment.targetMetrics.includes(m)","+        );","+        if (sharedMetrics.length > 0) {","+          alternatives.push(treatment.id);","+        }","+      }","+    }","+  }","+","+  return alternatives;","+}"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"c50f4fd0-f95e-4020-bfab-5f38dd815a70","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01X6w2vqQyr5VwSeVHxPjzoZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017BwkBCuQMSSZuRURGqTLWA","name":"TodoWrite","input":{"todos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"completed","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"in_progress","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5979,"cache_read_input_tokens":85830,"cache_creation":{"ephemeral_5m_input_tokens":5979,"ephemeral_1h_input_tokens":0},"output_tokens":222,"service_tier":"standard"}},"requestId":"req_011CWVVCufcdBjqhaJ5pkQPH","type":"assistant","uuid":"1da8d83c-502c-456b-90e2-18e931d40cb2","timestamp":"2025-12-26T14:51:58.618Z"}
{"parentUuid":"1da8d83c-502c-456b-90e2-18e931d40cb2","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017BwkBCuQMSSZuRURGqTLWA","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"bc144914-672c-4dee-85e6-55ed82fcd130","timestamp":"2025-12-26T14:51:58.827Z","toolUseResult":{"oldTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"in_progress","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"pending","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}],"newTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"completed","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"in_progress","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}]}}
{"parentUuid":"bc144914-672c-4dee-85e6-55ed82fcd130","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CEdc5Ug4cLSwZ5YUsDUvPD","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create a UI component for displaying treatment conflict warnings. First, let me check what UI components exist:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":91809,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVDnZWTAVdiwpHUbm8h","type":"assistant","uuid":"e0428cbd-f4bd-41b1-9751-772e40f83f4b","timestamp":"2025-12-26T14:52:04.741Z"}
{"parentUuid":"e0428cbd-f4bd-41b1-9751-772e40f83f4b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CEdc5Ug4cLSwZ5YUsDUvPD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017eYddGNogQHxzcxhYXbPTm","name":"Glob","input":{"pattern":"looksmaxx-app/src/components/ui/*.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":91809,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVDnZWTAVdiwpHUbm8h","type":"assistant","uuid":"87c94fca-a80f-46cd-8168-06abf06c2d1d","timestamp":"2025-12-26T14:52:05.124Z"}
{"parentUuid":"87c94fca-a80f-46cd-8168-06abf06c2d1d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017eYddGNogQHxzcxhYXbPTm","type":"tool_result","content":"No files found"}]},"uuid":"4351a123-3529-42c2-8c02-2794ec832df5","timestamp":"2025-12-26T14:52:05.669Z","toolUseResult":{"filenames":[],"durationMs":482,"numFiles":0,"truncated":false}}
{"parentUuid":"4351a123-3529-42c2-8c02-2794ec832df5","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_017ZuPz335PZSTmow4zsLp6C","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Sad2Ms818wXw5vo7g2ZHJL","name":"Glob","input":{"pattern":"looksmaxx-app/src/components/results/**/*.tsx"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":104,"cache_read_input_tokens":92073,"cache_creation":{"ephemeral_5m_input_tokens":104,"ephemeral_1h_input_tokens":0},"output_tokens":66,"service_tier":"standard"}},"requestId":"req_011CWVVEGZzmohhR9YAXHKHD","type":"assistant","uuid":"b41239e6-5aa5-4255-8801-8e83f34c3419","timestamp":"2025-12-26T14:52:11.262Z"}
{"parentUuid":"b41239e6-5aa5-4255-8801-8e83f34c3419","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Sad2Ms818wXw5vo7g2ZHJL","type":"tool_result","content":"No files found"}]},"uuid":"94e55731-7d6e-4e3e-8ddd-418272d41be8","timestamp":"2025-12-26T14:52:11.720Z","toolUseResult":{"filenames":[],"durationMs":409,"numFiles":0,"truncated":false}}
{"parentUuid":"94e55731-7d6e-4e3e-8ddd-418272d41be8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MMicYHXqs8T6TeWxaUpD3s","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016v8VwoCY5YkDJ6TqYMWLm6","name":"Glob","input":{"pattern":"**/components/results/**/*.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":81,"cache_read_input_tokens":92177,"cache_creation":{"ephemeral_5m_input_tokens":81,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CWVVEiPmRjBzrAWvt6zpC","type":"assistant","uuid":"8295832e-eee1-4b47-acf7-6797d71b549c","timestamp":"2025-12-26T14:52:16.461Z"}
{"parentUuid":"8295832e-eee1-4b47-acf7-6797d71b549c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016v8VwoCY5YkDJ6TqYMWLm6","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/IdealRangeBar.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/RecommendationCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/AnimatedScore.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ExportButton.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/GradientRangeBar.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/PlanActionCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/UserProfileModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/TreatmentTimeline.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/BeforeAfterPreview.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/MetricDetailModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/RatiosTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FacialRadarChart.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/RankBadge.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/SupportTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/DailyStackCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/CommunityTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/ArchetypeTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/ProgressComparisonCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/ProductCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/KeyStrengthsFlaws.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/MeasurementCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/WeakPointCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/index.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ShareButton.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PSLTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StreakCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/VisionInsightsCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/MedicalPrescriptionCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/GuidesTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StrengthFlawCards.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/RatioDetailModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/LeaderboardTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/PricingModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceMorphing.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OptionsTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/SurgeryConsentModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/AnalysisHistoryCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/ReferralsTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/Results.tsx"}]},"uuid":"23714b13-fa1f-422e-886f-564e14e40dad","timestamp":"2025-12-26T14:52:17.019Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/IdealRangeBar.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/RecommendationCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/AnimatedScore.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ExportButton.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/GradientRangeBar.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/PlanActionCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/UserProfileModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/TreatmentTimeline.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/BeforeAfterPreview.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/MetricDetailModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/RatiosTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FacialRadarChart.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/RankBadge.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/SupportTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/DailyStackCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/CommunityTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/ArchetypeTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/ProgressComparisonCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/ProductCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/KeyStrengthsFlaws.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/MeasurementCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/WeakPointCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/index.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ShareButton.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PSLTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StreakCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/VisionInsightsCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/MedicalPrescriptionCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/GuidesTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StrengthFlawCards.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/RatioDetailModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/LeaderboardTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/PricingModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceMorphing.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OptionsTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/SurgeryConsentModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/AnalysisHistoryCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/ReferralsTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/Results.tsx"],"durationMs":494,"numFiles":45,"truncated":false}}
{"parentUuid":"23714b13-fa1f-422e-886f-564e14e40dad","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EJeRe3XmKpmkKxSqB7pdJF","type":"message","role":"assistant","content":[{"type":"text","text":"Let me look at the PlanTab.tsx to understand how treatments are displayed:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1664,"cache_read_input_tokens":92258,"cache_creation":{"ephemeral_5m_input_tokens":1664,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWVVF79jNgp8BUv2ntnLZ","type":"assistant","uuid":"d73943e0-02cd-44d3-9ff0-438d3d413420","timestamp":"2025-12-26T14:52:22.390Z"}
{"parentUuid":"d73943e0-02cd-44d3-9ff0-438d3d413420","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EJeRe3XmKpmkKxSqB7pdJF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CCxntQZMAFB9AeveVp4eki","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1664,"cache_read_input_tokens":92258,"cache_creation":{"ephemeral_5m_input_tokens":1664,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWVVF79jNgp8BUv2ntnLZ","type":"assistant","uuid":"167f9aa3-43cd-46ea-b3c9-8cb7abefcc21","timestamp":"2025-12-26T14:52:22.907Z"}
{"parentUuid":"167f9aa3-43cd-46ea-b3c9-8cb7abefcc21","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CCxntQZMAFB9AeveVp4eki","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useState, useMemo, useCallback } from 'react';\n     4→import { motion, AnimatePresence } from 'framer-motion';\n     5→import {\n     6→  Sparkles,\n     7→  TrendingUp,\n     8→  Target,\n     9→  Zap,\n    10→  ChevronRight,\n    11→  Lock,\n    12→  CheckCircle,\n    13→  AlertCircle,\n    14→  CheckCircle2,\n    15→  Scale,\n    16→  Dumbbell,\n    17→  Salad,\n    18→  ArrowDown,\n    19→  ArrowUp,\n    20→  Minus,\n    21→  Package,\n    22→  ShoppingCart,\n    23→} from 'lucide-react';\n    24→import { useResults } from '@/contexts/ResultsContext';\n    25→import { useAuth } from '@/contexts/AuthContext';\n    26→import { usePricing } from '@/contexts/PricingContext';\n    27→import { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\n    28→import { TabContent } from '../ResultsLayout';\n    29→import { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\n    30→import { ScoreCircle, PhaseBadge } from '../shared';\n    31→import { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\n    32→import { FaceMorphing } from '../visualization/FaceMorphing';\n    33→import { TreatmentTimeline } from '../visualization/TreatmentTimeline';\n    34→import { RecommendationPhase, ProductRecommendation } from '@/types/results';\n    35→import { DailyStackCard } from '../cards/DailyStackCard';\n    36→import { ProductCard } from '../cards/ProductCard';\n    37→import { WeakPointCard } from '../cards/WeakPointCard';\n    38→import { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\n    39→import { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\n    40→import { generateDailyStack } from '@/lib/daily-stack';\n    41→import { getProductRecommendations } from '@/lib/product-recommendations';\n    42→import { SUPPLEMENTS } from '@/lib/recommendations/supplements';\n    43→\n    44→// ============================================\n    45→// POTENTIAL SCORE CARD\n    46→// ============================================\n    47→\n    48→function PotentialScoreCard() {\n    49→  const { overallScore, recommendations } = useResults();\n    50→  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n    51→\n    52→  // Calculate potential improvement\n    53→  const potentialImprovement = useMemo(() => {\n    54→    if (recommendations.length === 0) return 0;\n    55→    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    56→    return Math.min(totalImpact * 1.5, 10 - numericScore);\n    57→  }, [recommendations, numericScore]);\n    58→\n    59→  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n    60→\n    61→  return (\n    62→    <motion.div\n    63→      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n    64→      initial={{ opacity: 0, y: 20 }}\n    65→      animate={{ opacity: 1, y: 0 }}\n    66→    >\n    67→      <div className=\"flex items-center gap-2 mb-4\">\n    68→        <Sparkles size={20} className=\"text-cyan-400\" />\n    69→        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n    70→      </div>\n    71→\n    72→      <div className=\"flex items-center justify-center gap-8 mb-6\">\n    73→        {/* Current */}\n    74→        <div className=\"text-center\">\n    75→          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n    76→          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n    77→        </div>\n    78→\n    79→        {/* Arrow */}\n    80→        <div className=\"flex flex-col items-center gap-1\">\n    81→          <ChevronRight size={24} className=\"text-cyan-400\" />\n    82→          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n    83→        </div>\n    84→\n    85→        {/* Potential */}\n    86→        <div className=\"text-center\">\n    87→          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n    88→          <div className=\"relative\">\n    89→            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n    90→            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n    91→              <TrendingUp size={12} className=\"text-black\" />\n    92→            </div>\n    93→          </div>\n    94→        </div>\n    95→      </div>\n    96→\n    97→      <p className=\"text-sm text-neutral-400 text-center\">\n    98→        Following our recommendations could improve your harmony score by up to{' '}\n    99→        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n   100→      </p>\n   101→    </motion.div>\n   102→  );\n   103→}\n   104→\n   105→// ============================================\n   106→// PHASE FILTER\n   107→// ============================================\n   108→\n   109→interface PhaseFilterProps {\n   110→  selectedPhase: RecommendationPhase | null;\n   111→  onSelect: (phase: RecommendationPhase | null) => void;\n   112→  counts: Record<RecommendationPhase, number>;\n   113→}\n   114→\n   115→function PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n   116→  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n   117→\n   118→  return (\n   119→    <div className=\"flex flex-wrap gap-2\">\n   120→      <button\n   121→        onClick={() => onSelect(null)}\n   122→        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n   123→          ? 'bg-cyan-500 text-black'\n   124→          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n   125→          }`}\n   126→      >\n   127→        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n   128→      </button>\n   129→      {phases.map(phase => (\n   130→        <button\n   131→          key={phase}\n   132→          onClick={() => onSelect(phase)}\n   133→          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n   134→            ? 'bg-neutral-700 text-white'\n   135→            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n   136→            }`}\n   137→        >\n   138→          <PhaseBadge phase={phase} size=\"sm\" />\n   139→          ({counts[phase] || 0})\n   140→        </button>\n   141→      ))}\n   142→    </div>\n   143→  );\n   144→}\n   145→\n   146→// ============================================\n   147→// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n   148→// ============================================\n   149→\n   150→type PreviewMode = 'static' | 'morphing';\n   151→\n   152→function BeforeAfterPreviewSection() {\n   153→  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n   154→  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n   155→  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n   156→\n   157→  // Calculate potential improvement\n   158→  const potentialImprovement = useMemo(() => {\n   159→    if (recommendations.length === 0) return 0;\n   160→    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n   161→    return Math.min(totalImpact * 1.5, 10 - numericScore);\n   162→  }, [recommendations, numericScore]);\n   163→\n   164→  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n   165→\n   166→  if (!frontPhoto) return null;\n   167→\n   168→  return (\n   169→    <div className=\"space-y-3\">\n   170→      {/* Mode Toggle */}\n   171→      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n   172→        <button\n   173→          onClick={() => setPreviewMode('morphing')}\n   174→          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n   175→            previewMode === 'morphing'\n   176→              ? 'bg-cyan-500/20 text-cyan-400'\n   177→              : 'text-neutral-500 hover:text-white'\n   178→          }`}\n   179→        >\n   180→          Face Morphing\n   181→        </button>\n   182→        <button\n   183→          onClick={() => setPreviewMode('static')}\n   184→          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n   185→            previewMode === 'static'\n   186→              ? 'bg-neutral-700 text-white'\n   187→              : 'text-neutral-500 hover:text-white'\n   188→          }`}\n   189→        >\n   190→          Static Preview\n   191→        </button>\n   192→      </div>\n   193→\n   194→      {/* Preview Component */}\n   195→      <AnimatePresence mode=\"wait\">\n   196→        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n   197→          <motion.div\n   198→            key=\"morphing\"\n   199→            initial={{ opacity: 0, x: -20 }}\n   200→            animate={{ opacity: 1, x: 0 }}\n   201→            exit={{ opacity: 0, x: 20 }}\n   202→            transition={{ duration: 0.2 }}\n   203→          >\n   204→            <FaceMorphing\n   205→              photo={frontPhoto}\n   206→              frontLandmarks={frontLandmarks}\n   207→              currentScore={numericScore}\n   208→              potentialScore={potentialScore}\n   209→              recommendations={recommendations}\n   210→            />\n   211→          </motion.div>\n   212→        ) : (\n   213→          <motion.div\n   214→            key=\"static\"\n   215→            initial={{ opacity: 0, x: 20 }}\n   216→            animate={{ opacity: 1, x: 0 }}\n   217→            exit={{ opacity: 0, x: -20 }}\n   218→            transition={{ duration: 0.2 }}\n   219→          >\n   220→            <BeforeAfterPreview\n   221→              photo={frontPhoto}\n   222→              currentScore={numericScore}\n   223→              potentialScore={potentialScore}\n   224→              recommendations={recommendations}\n   225→            />\n   226→          </motion.div>\n   227→        )}\n   228→      </AnimatePresence>\n   229→    </div>\n   230→  );\n   231→}\n   232→\n   233→// ============================================\n   234→// ORDER OF OPERATIONS\n   235→// ============================================\n   236→\n   237→function OrderOfOperations() {\n   238→  return (\n   239→    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n   240→      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n   241→        <Target size={16} className=\"text-cyan-400\" />\n   242→        Recommended Order\n   243→      </h4>\n   244→      <div className=\"space-y-3\">\n   245→        <div className=\"flex items-start gap-3\">\n   246→          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n   247→            <span className=\"text-xs font-bold text-green-400\">1</span>\n   248→          </div>\n   249→          <div>\n   250→            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n   251→            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n   252→          </div>\n   253→        </div>\n   254→        <div className=\"flex items-start gap-3\">\n   255→          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n   256→            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n   257→          </div>\n   258→          <div>\n   259→            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n   260→            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n   261→          </div>\n   262→        </div>\n   263→        <div className=\"flex items-start gap-3\">\n   264→          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n   265→            <span className=\"text-xs font-bold text-red-400\">3</span>\n   266→          </div>\n   267→          <div>\n   268→            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n   269→            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n   270→          </div>\n   271→        </div>\n   272→      </div>\n   273→    </div>\n   274→  );\n   275→}\n   276→\n   277→// ============================================\n   278→// YOUR PHASE CARD (Body Composition Phase)\n   279→// ============================================\n   280→\n   281→type BodyPhase = 'bulk' | 'cut' | 'maintain';\n   282→\n   283→interface YourPhaseCardProps {\n   284→  bodyFatPercent?: number;\n   285→  gender: 'male' | 'female';\n   286→}\n   287→\n   288→function YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n   289→  // Determine phase based on body fat and gender\n   290→  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n   291→    if (!bodyFatPercent) {\n   292→      return {\n   293→        phase: 'maintain',\n   294→        message: 'Complete your physique analysis to get personalized phase recommendations.',\n   295→        color: 'from-neutral-700 to-neutral-800',\n   296→        icon: <Scale size={24} className=\"text-neutral-400\" />,\n   297→      };\n   298→    }\n   299→\n   300→    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n   301→    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n   302→    const bulkThreshold = gender === 'male' ? 12 : 18;\n   303→    const cutThreshold = gender === 'male' ? 18 : 25;\n   304→\n   305→    if (bodyFatPercent < bulkThreshold) {\n   306→      return {\n   307→        phase: 'bulk',\n   308→        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n   309→        color: 'from-green-600 to-emerald-700',\n   310→        icon: <Dumbbell size={24} className=\"text-white\" />,\n   311→      };\n   312→    } else if (bodyFatPercent > cutThreshold) {\n   313→      return {\n   314→        phase: 'cut',\n   315→        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n   316→        color: 'from-orange-600 to-red-700',\n   317→        icon: <Salad size={24} className=\"text-white\" />,\n   318→      };\n   319→    } else {\n   320→      return {\n   321→        phase: 'maintain',\n   322→        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n   323→        color: 'from-blue-600 to-cyan-700',\n   324→        icon: <Scale size={24} className=\"text-white\" />,\n   325→      };\n   326→    }\n   327→  };\n   328→\n   329→  const { phase, message, color, icon } = getPhase();\n   330→  const phaseLabels: Record<BodyPhase, string> = {\n   331→    bulk: 'Lean Bulk Phase',\n   332→    cut: 'Cutting Phase',\n   333→    maintain: 'Maintenance Phase',\n   334→  };\n   335→\n   336→  return (\n   337→    <motion.div\n   338→      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n   339→      initial={{ opacity: 0, y: 20 }}\n   340→      animate={{ opacity: 1, y: 0 }}\n   341→    >\n   342→      <div className=\"flex items-start gap-4\">\n   343→        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n   344→          {icon}\n   345→        </div>\n   346→        <div className=\"flex-1\">\n   347→          <div className=\"flex items-center gap-2 mb-1\">\n   348→            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n   349→            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n   350→              {phaseLabels[phase]}\n   351→            </div>\n   352→          </div>\n   353→          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n   354→\n   355→          {/* Phase-specific tips */}\n   356→          <div className=\"grid grid-cols-3 gap-2\">\n   357→            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n   358→              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n   359→                {phase === 'bulk' ? (\n   360→                  <ArrowUp size={12} className=\"text-green-300\" />\n   361→                ) : phase === 'cut' ? (\n   362→                  <ArrowDown size={12} className=\"text-orange-300\" />\n   363→                ) : (\n   364→                  <Minus size={12} className=\"text-blue-300\" />\n   365→                )}\n   366→                <span className=\"text-xs text-white/60\">Calories</span>\n   367→              </div>\n   368→              <span className=\"text-sm font-medium text-white\">\n   369→                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n   370→              </span>\n   371→            </div>\n   372→            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n   373→              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n   374→              <span className=\"text-sm font-medium text-white\">\n   375→                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n   376→              </span>\n   377→            </div>\n   378→            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n   379→              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n   380→              <span className=\"text-sm font-medium text-white\">\n   381→                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n   382→              </span>\n   383→            </div>\n   384→          </div>\n   385→        </div>\n   386→      </div>\n   387→    </motion.div>\n   388→  );\n   389→}\n   390→\n   391→// ============================================\n   392→// PRODUCT BUNDLE CTA\n   393→// ============================================\n   394→\n   395→interface ProductBundleCardProps {\n   396→  products: ProductRecommendation[];\n   397→  title?: string;\n   398→}\n   399→\n   400→function ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n   401→  // Get top 3 most important products\n   402→  const bundleProducts = products.slice(0, 3);\n   403→\n   404→  // Calculate total cost\n   405→  const totalCost = bundleProducts.reduce((sum, rec) => {\n   406→    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n   407→    return sum + (supplement?.costPerMonth.min || 0);\n   408→  }, 0);\n   409→\n   410→  if (bundleProducts.length === 0) return null;\n   411→\n   412→  return (\n   413→    <motion.div\n   414→      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n   415→      initial={{ opacity: 0, y: 20 }}\n   416→      animate={{ opacity: 1, y: 0 }}\n   417→    >\n   418→      <div className=\"flex items-center gap-2 mb-4\">\n   419→        <Package size={20} className=\"text-purple-400\" />\n   420→        <h3 className=\"font-semibold text-white\">{title}</h3>\n   421→        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n   422→          Save 15%\n   423→        </div>\n   424→      </div>\n   425→\n   426→      <p className=\"text-sm text-neutral-300 mb-4\">\n   427→        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n   428→      </p>\n   429→\n   430→      {/* Bundle Items */}\n   431→      <div className=\"space-y-2 mb-4\">\n   432→        {bundleProducts.map((rec, index) => (\n   433→          <div\n   434→            key={rec.product.id}\n   435→            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n   436→          >\n   437→            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n   438→              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n   439→            </div>\n   440→            <div className=\"flex-1 min-w-0\">\n   441→              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n   442→              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n   443→            </div>\n   444→            <div className=\"text-right flex-shrink-0\">\n   445→              <p className=\"text-sm text-white\">\n   446→                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n   447→              </p>\n   448→            </div>\n   449→          </div>\n   450→        ))}\n   451→      </div>\n   452→\n   453→      {/* Total & CTA */}\n   454→      <div className=\"border-t border-purple-500/20 pt-4\">\n   455→        <div className=\"flex items-center justify-between mb-3\">\n   456→          <span className=\"text-neutral-400\">Bundle Total</span>\n   457→          <div className=\"text-right\">\n   458→            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n   459→            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n   460→          </div>\n   461→        </div>\n   462→        <button\n   463→          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n   464→        >\n   465→          <ShoppingCart size={18} />\n   466→          Get Your Bundle\n   467→        </button>\n   468→      </div>\n   469→    </motion.div>\n   470→  );\n   471→}\n   472→\n   473→// ============================================\n   474→// PLAN TAB\n   475→// ============================================\n   476→\n   477→export function PlanTab() {\n   478→  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n   479→  const { user } = useAuth();\n   480→  const physiqueContext = usePhysiqueOptional();\n   481→  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n   482→  const [expandedId, setExpandedId] = useState<string | null>(null);\n   483→  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n   484→  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n   485→  const [previousAnalysis, setPreviousAnalysis] = useState<{\n   486→    date: string;\n   487→    overallScore: number;\n   488→    bodyFatPercent?: number;\n   489→    frontPhotoUrl?: string;\n   490→  } | null>(null);\n   491→\n   492→  const { openPricingModal } = usePricing();\n   493→\n   494→  // Convert to number for arithmetic operations\n   495→  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n   496→\n   497→  // Check if user has a paid plan\n   498→  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n   499→\n   500→  // Get body fat from physique analysis\n   501→  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n   502→\n   503→  // Generate Daily Stack for all users\n   504→  const dailyStack = useMemo(() => {\n   505→    return generateDailyStack(gender);\n   506→  }, [gender]);\n   507→\n   508→  // Generate Product Recommendations based on metrics\n   509→  const productRecommendations = useMemo(() => {\n   510→    // Build metrics and severity dictionaries from ratios\n   511→    const metricsDict: Record<string, number> = {};\n   512→    const severityDict: Record<string, string> = {};\n   513→\n   514→    [...frontRatios, ...sideRatios].forEach(ratio => {\n   515→      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n   516→      severityDict[ratio.name] = ratio.severity;\n   517→    });\n   518→\n   519→    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n   520→  }, [frontRatios, sideRatios, gender, ethnicity]);\n   521→\n   522→  // Split product recommendations by state\n   523→  const { flawProducts, idealProducts } = useMemo(() => {\n   524→    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n   525→    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n   526→    return { flawProducts: flaw, idealProducts: ideal };\n   527→  }, [productRecommendations]);\n   528→\n   529→  // Map flaws to products and treatments\n   530→  const flawsWithProducts = useMemo(() => {\n   531→    return flaws.slice(0, 5).map(flaw => {\n   532→      // Find products that target metrics related to this flaw\n   533→      const relatedProducts = productRecommendations.filter(rec =>\n   534→        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n   535→          rec.matchedMetrics.some(metric =>\n   536→            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n   537→            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n   538→          )\n   539→        )\n   540→      );\n   541→\n   542→      // Find treatments that match this flaw\n   543→      const relatedTreatments = recommendations.filter(rec =>\n   544→        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n   545→      );\n   546→\n   547→      return {\n   548→        flaw,\n   549→        products: relatedProducts.slice(0, 2),\n   550→        treatments: relatedTreatments.slice(0, 3),\n   551→      };\n   552→    });\n   553→  }, [flaws, productRecommendations, recommendations]);\n   554→\n   555→  // Handle progress photo upload\n   556→  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n   557→    // Store current analysis as previous before re-analyzing\n   558→    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n   559→    setPreviousAnalysis({\n   560→      date: new Date().toISOString(),\n   561→      overallScore: numScore,\n   562→      bodyFatPercent,\n   563→      frontPhotoUrl: frontPhoto || undefined,\n   564→    });\n   565→\n   566→    // In a real implementation, this would upload to API and trigger re-analysis\n   567→    console.log('Progress photo uploaded:', file.name);\n   568→  }, [overallScore, bodyFatPercent, frontPhoto]);\n   569→\n   570→  // Count recommendations by phase\n   571→  const phaseCounts = useMemo(() => {\n   572→    const counts: Record<RecommendationPhase, number> = {\n   573→      'Foundational': 0,\n   574→      'Minimally Invasive': 0,\n   575→      'Surgical': 0,\n   576→    };\n   577→    recommendations.forEach(r => {\n   578→      if (!removedIds.has(r.ref_id)) {\n   579→        counts[r.phase]++;\n   580→      }\n   581→    });\n   582→    return counts;\n   583→  }, [recommendations, removedIds]);\n   584→\n   585→  // Filter recommendations\n   586→  const filteredRecommendations = useMemo(() => {\n   587→    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n   588→    if (selectedPhase) {\n   589→      filtered = filtered.filter(r => r.phase === selectedPhase);\n   590→    }\n   591→    return filtered;\n   592→  }, [recommendations, selectedPhase, removedIds]);\n   593→\n   594→  const hasRecommendations = filteredRecommendations.length > 0;\n   595→\n   596→  // Handle mark complete\n   597→  const handleMarkComplete = useCallback((id: string) => {\n   598→    setCompletedIds(prev => {\n   599→      const newSet = new Set(prev);\n   600→      if (newSet.has(id)) {\n   601→        newSet.delete(id);\n   602→      } else {\n   603→        newSet.add(id);\n   604→      }\n   605→      return newSet;\n   606→    });\n   607→  }, []);\n   608→\n   609→  // Handle remove\n   610→  const handleRemove = useCallback((id: string) => {\n   611→    setRemovedIds(prev => {\n   612→      const newSet = new Set(prev);\n   613→      newSet.add(id);\n   614→      return newSet;\n   615→    });\n   616→    if (expandedId === id) {\n   617→      setExpandedId(null);\n   618→    }\n   619→  }, [expandedId]);\n   620→\n   621→  return (\n   622→    <TabContent\n   623→      title=\"Your Plan & Potential\"\n   624→      subtitle=\"Personalized recommendations based on your analysis\"\n   625→    >\n   626→      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n   627→        {/* Main Content */}\n   628→        <div className=\"lg:col-span-2 space-y-6\">\n   629→          {/* Your Phase Card - Body Composition Phase */}\n   630→          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n   631→\n   632→          {/* Daily Stack Card - Hero Element for ALL users */}\n   633→          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n   634→\n   635→          {/* Potential Score */}\n   636→          <PotentialScoreCard />\n   637→\n   638→          {/* Fix Your Weak Points Section */}\n   639→          {flawsWithProducts.length > 0 && (\n   640→            <div className=\"space-y-4\">\n   641→              <div className=\"flex items-center gap-2\">\n   642→                <AlertCircle size={20} className=\"text-red-400\" />\n   643→                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n   644→                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n   645→                  {flawsWithProducts.length} Issues\n   646→                </span>\n   647→              </div>\n   648→              <div className=\"space-y-3\">\n   649→                {flawsWithProducts.map((item, index) => (\n   650→                  <WeakPointCard\n   651→                    key={item.flaw.id}\n   652→                    flaw={item.flaw}\n   653→                    rank={index + 1}\n   654→                    products={item.products}\n   655→                    treatments={item.treatments}\n   656→                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n   657→                  />\n   658→                ))}\n   659→              </div>\n   660→            </div>\n   661→          )}\n   662→\n   663→          {/* Targeted Product Recommendations - Corrective */}\n   664→          {flawProducts.length > 0 && (\n   665→            <div className=\"space-y-4\">\n   666→              <div className=\"flex items-center gap-2\">\n   667→                <Package size={20} className=\"text-cyan-400\" />\n   668→                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n   669→                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n   670→                  Corrective\n   671→                </span>\n   672→              </div>\n   673→              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n   674→                {flawProducts.slice(0, 6).map((rec, index) => (\n   675→                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n   676→                ))}\n   677→              </div>\n   678→            </div>\n   679→          )}\n   680→\n   681→          {/* Targeted Product Recommendations - Maintenance */}\n   682→          {idealProducts.length > 0 && (\n   683→            <div className=\"space-y-4\">\n   684→              <div className=\"flex items-center gap-2\">\n   685→                <CheckCircle2 size={20} className=\"text-green-400\" />\n   686→                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n   687→                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n   688→                  Maintenance\n   689→                </span>\n   690→              </div>\n   691→              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n   692→                {idealProducts.slice(0, 4).map((rec) => (\n   693→                  <ProductCard key={rec.product.id} recommendation={rec} />\n   694→                ))}\n   695→              </div>\n   696→            </div>\n   697→          )}\n   698→\n   699→          {/* Treatment Timeline */}\n   700→          {recommendations.length > 0 && (\n   701→            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n   702→          )}\n   703→\n   704→          {/* Phase Filter */}\n   705→          <PhaseFilter\n   706→            selectedPhase={selectedPhase}\n   707→            onSelect={setSelectedPhase}\n   708→            counts={phaseCounts}\n   709→          />\n   710→\n   711→          {/* Recommendations List */}\n   712→          {hasRecommendations ? (\n   713→            <motion.div className=\"space-y-4\" layout>\n   714→              <AnimatePresence mode=\"popLayout\">\n   715→                {filteredRecommendations.map((rec, index) => (\n   716→                  <motion.div\n   717→                    key={rec.ref_id}\n   718→                    layout\n   719→                    initial={{ opacity: 0, y: 20 }}\n   720→                    animate={{ opacity: 1, y: 0 }}\n   721→                    exit={{ opacity: 0, y: -20 }}\n   722→                    transition={{ duration: 0.2, delay: index * 0.05 }}\n   723→                  >\n   724→                    <EnhancedRecommendationCard\n   725→                      recommendation={rec}\n   726→                      rank={index + 1}\n   727→                      isExpanded={expandedId === rec.ref_id}\n   728→                      onToggle={() => setExpandedId(\n   729→                        expandedId === rec.ref_id ? null : rec.ref_id\n   730→                      )}\n   731→                      onMarkComplete={handleMarkComplete}\n   732→                      onRemove={handleRemove}\n   733→                      isCompleted={completedIds.has(rec.ref_id)}\n   734→                      gender={gender}\n   735→                      ethnicity={ethnicity}\n   736→                    />\n   737→                  </motion.div>\n   738→                ))}\n   739→              </AnimatePresence>\n   740→            </motion.div>\n   741→          ) : (\n   742→            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n   743→              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n   744→              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n   745→              <p className=\"text-neutral-500 mb-4\">\n   746→                Complete a facial analysis to get personalized recommendations\n   747→              </p>\n   748→            </div>\n   749→          )}\n   750→        </div>\n   751→\n   752→        {/* Sidebar */}\n   753→        <div className=\"space-y-6\">\n   754→          {/* Medical Prescription Card (Dental) */}\n   755→          {vision?.teeth && (\n   756→            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n   757→          )}\n   758→\n   759→          {/* Progress Comparison Card */}\n   760→          <ProgressComparisonCard\n   761→            currentAnalysis={{\n   762→              date: new Date().toISOString(),\n   763→              overallScore: numericOverallScore,\n   764→              bodyFatPercent,\n   765→              frontPhotoUrl: frontPhoto || undefined,\n   766→            }}\n   767→            previousAnalysis={previousAnalysis}\n   768→            onUploadNewPhoto={handleProgressPhotoUpload}\n   769→          />\n   770→\n   771→          {/* Product Bundle CTA */}\n   772→          {flawProducts.length >= 3 && (\n   773→            <ProductBundleCard\n   774→              products={flawProducts}\n   775→              title=\"Your Fix Bundle\"\n   776→            />\n   777→          )}\n   778→\n   779→          {/* Before/After Preview */}\n   780→          <BeforeAfterPreviewSection />\n   781→\n   782→          {/* Order of Operations */}\n   783→          <OrderOfOperations />\n   784→\n   785→          {/* My Plan Summary */}\n   786→          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n   787→            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n   788→              <Zap size={16} className=\"text-yellow-400\" />\n   789→              My Plan\n   790→            </h4>\n   791→            <div className=\"text-center py-6\">\n   792→              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n   793→                <Lock size={20} className=\"text-neutral-600\" />\n   794→              </div>\n   795→              <p className=\"text-sm text-neutral-500 mb-3\">\n   796→                Add recommendations to build your personalized plan\n   797→              </p>\n   798→              <p className=\"text-xs text-neutral-600\">\n   799→                0 items selected\n   800→              </p>\n   801→            </div>\n   802→          </div>\n   803→\n   804→          {/* Issues Summary */}\n   805→          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n   806→            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n   807→            <div className=\"space-y-2\">\n   808→              {flaws.slice(0, 5).map(flaw => (\n   809→                <div\n   810→                  key={flaw.id}\n   811→                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n   812→                >\n   813→                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n   814→                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n   815→                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n   816→                  </span>\n   817→                </div>\n   818→              ))}\n   819→              {flaws.length === 0 && (\n   820→                <p className=\"text-sm text-neutral-500 text-center py-4\">\n   821→                  No issues detected\n   822→                </p>\n   823→              )}\n   824→            </div>\n   825→          </div>\n   826→\n   827→          {/* Upgrade CTA or Premium Badge */}\n   828→          {hasPaidPlan ? (\n   829→            <motion.div\n   830→              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n   831→              initial={{ opacity: 0, y: 20 }}\n   832→              animate={{ opacity: 1, y: 0 }}\n   833→              transition={{ delay: 0.3 }}\n   834→            >\n   835→              <div className=\"flex items-center gap-2 mb-2\">\n   836→                <CheckCircle size={16} className=\"text-green-400\" />\n   837→                <span className=\"text-sm font-medium text-white\">\n   838→                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n   839→                </span>\n   840→              </div>\n   841→              <p className=\"text-xs text-neutral-400\">\n   842→                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n   843→              </p>\n   844→            </motion.div>\n   845→          ) : (\n   846→            <motion.div\n   847→              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n   848→              initial={{ opacity: 0, y: 20 }}\n   849→              animate={{ opacity: 1, y: 0 }}\n   850→              transition={{ delay: 0.3 }}\n   851→            >\n   852→              <div className=\"flex items-center gap-2 mb-2\">\n   853→                <Sparkles size={16} className=\"text-cyan-400\" />\n   854→                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n   855→              </div>\n   856→              <p className=\"text-xs text-neutral-400 mb-3\">\n   857→                Get detailed treatment guides, cost estimates, and provider recommendations.\n   858→              </p>\n   859→              <button\n   860→                onClick={() => openPricingModal('plan_sidebar')}\n   861→                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n   862→              >\n   863→                Upgrade Now\n   864→              </button>\n   865→            </motion.div>\n   866→          )}\n   867→        </div>\n   868→      </div>\n   869→    </TabContent>\n   870→  );\n   871→}\n   872→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a5335ba6-f97a-46f6-91b9-0a312fb76651","timestamp":"2025-12-26T14:52:23.200Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","content":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n  CheckCircle,\n  AlertCircle,\n  CheckCircle2,\n  Scale,\n  Dumbbell,\n  Salad,\n  ArrowDown,\n  ArrowUp,\n  Minus,\n  Package,\n  ShoppingCart,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { usePricing } from '@/contexts/PricingContext';\nimport { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\nimport { FaceMorphing } from '../visualization/FaceMorphing';\nimport { TreatmentTimeline } from '../visualization/TreatmentTimeline';\nimport { RecommendationPhase, ProductRecommendation } from '@/types/results';\nimport { DailyStackCard } from '../cards/DailyStackCard';\nimport { ProductCard } from '../cards/ProductCard';\nimport { WeakPointCard } from '../cards/WeakPointCard';\nimport { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\nimport { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\nimport { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n          ? 'bg-cyan-500 text-black'\n          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n            ? 'bg-neutral-700 text-white'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n            }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n// ============================================\n\ntype PreviewMode = 'static' | 'morphing';\n\nfunction BeforeAfterPreviewSection() {\n  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  if (!frontPhoto) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n        <button\n          onClick={() => setPreviewMode('morphing')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'morphing'\n              ? 'bg-cyan-500/20 text-cyan-400'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Face Morphing\n        </button>\n        <button\n          onClick={() => setPreviewMode('static')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'static'\n              ? 'bg-neutral-700 text-white'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Static Preview\n        </button>\n      </div>\n\n      {/* Preview Component */}\n      <AnimatePresence mode=\"wait\">\n        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n          <motion.div\n            key=\"morphing\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: 20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <FaceMorphing\n              photo={frontPhoto}\n              frontLandmarks={frontLandmarks}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"static\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: -20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <BeforeAfterPreview\n              photo={frontPhoto}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// YOUR PHASE CARD (Body Composition Phase)\n// ============================================\n\ntype BodyPhase = 'bulk' | 'cut' | 'maintain';\n\ninterface YourPhaseCardProps {\n  bodyFatPercent?: number;\n  gender: 'male' | 'female';\n}\n\nfunction YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n  // Determine phase based on body fat and gender\n  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n    if (!bodyFatPercent) {\n      return {\n        phase: 'maintain',\n        message: 'Complete your physique analysis to get personalized phase recommendations.',\n        color: 'from-neutral-700 to-neutral-800',\n        icon: <Scale size={24} className=\"text-neutral-400\" />,\n      };\n    }\n\n    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n    const bulkThreshold = gender === 'male' ? 12 : 18;\n    const cutThreshold = gender === 'male' ? 18 : 25;\n\n    if (bodyFatPercent < bulkThreshold) {\n      return {\n        phase: 'bulk',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n        color: 'from-green-600 to-emerald-700',\n        icon: <Dumbbell size={24} className=\"text-white\" />,\n      };\n    } else if (bodyFatPercent > cutThreshold) {\n      return {\n        phase: 'cut',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n        color: 'from-orange-600 to-red-700',\n        icon: <Salad size={24} className=\"text-white\" />,\n      };\n    } else {\n      return {\n        phase: 'maintain',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n        color: 'from-blue-600 to-cyan-700',\n        icon: <Scale size={24} className=\"text-white\" />,\n      };\n    }\n  };\n\n  const { phase, message, color, icon } = getPhase();\n  const phaseLabels: Record<BodyPhase, string> = {\n    bulk: 'Lean Bulk Phase',\n    cut: 'Cutting Phase',\n    maintain: 'Maintenance Phase',\n  };\n\n  return (\n    <motion.div\n      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-start gap-4\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n          {icon}\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n              {phaseLabels[phase]}\n            </div>\n          </div>\n          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n\n          {/* Phase-specific tips */}\n          <div className=\"grid grid-cols-3 gap-2\">\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n                {phase === 'bulk' ? (\n                  <ArrowUp size={12} className=\"text-green-300\" />\n                ) : phase === 'cut' ? (\n                  <ArrowDown size={12} className=\"text-orange-300\" />\n                ) : (\n                  <Minus size={12} className=\"text-blue-300\" />\n                )}\n                <span className=\"text-xs text-white/60\">Calories</span>\n              </div>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PRODUCT BUNDLE CTA\n// ============================================\n\ninterface ProductBundleCardProps {\n  products: ProductRecommendation[];\n  title?: string;\n}\n\nfunction ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n  // Get top 3 most important products\n  const bundleProducts = products.slice(0, 3);\n\n  // Calculate total cost\n  const totalCost = bundleProducts.reduce((sum, rec) => {\n    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n    return sum + (supplement?.costPerMonth.min || 0);\n  }, 0);\n\n  if (bundleProducts.length === 0) return null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Package size={20} className=\"text-purple-400\" />\n        <h3 className=\"font-semibold text-white\">{title}</h3>\n        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n          Save 15%\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-300 mb-4\">\n        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n      </p>\n\n      {/* Bundle Items */}\n      <div className=\"space-y-2 mb-4\">\n        {bundleProducts.map((rec, index) => (\n          <div\n            key={rec.product.id}\n            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n          >\n            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n            </div>\n            <div className=\"text-right flex-shrink-0\">\n              <p className=\"text-sm text-white\">\n                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n              </p>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Total & CTA */}\n      <div className=\"border-t border-purple-500/20 pt-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-neutral-400\">Bundle Total</span>\n          <div className=\"text-right\">\n            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n          </div>\n        </div>\n        <button\n          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n        >\n          <ShoppingCart size={18} />\n          Get Your Bundle\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  const { openPricingModal } = usePricing();\n\n  // Convert to number for arithmetic operations\n  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Check if user has a paid plan\n  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n\n  // Get body fat from physique analysis\n  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n\n  // Generate Daily Stack for all users\n  const dailyStack = useMemo(() => {\n    return generateDailyStack(gender);\n  }, [gender]);\n\n  // Generate Product Recommendations based on metrics\n  const productRecommendations = useMemo(() => {\n    // Build metrics and severity dictionaries from ratios\n    const metricsDict: Record<string, number> = {};\n    const severityDict: Record<string, string> = {};\n\n    [...frontRatios, ...sideRatios].forEach(ratio => {\n      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n      severityDict[ratio.name] = ratio.severity;\n    });\n\n    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n  }, [frontRatios, sideRatios, gender, ethnicity]);\n\n  // Split product recommendations by state\n  const { flawProducts, idealProducts } = useMemo(() => {\n    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n    return { flawProducts: flaw, idealProducts: ideal };\n  }, [productRecommendations]);\n\n  // Map flaws to products and treatments\n  const flawsWithProducts = useMemo(() => {\n    return flaws.slice(0, 5).map(flaw => {\n      // Find products that target metrics related to this flaw\n      const relatedProducts = productRecommendations.filter(rec =>\n        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n          rec.matchedMetrics.some(metric =>\n            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n          )\n        )\n      );\n\n      // Find treatments that match this flaw\n      const relatedTreatments = recommendations.filter(rec =>\n        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n      );\n\n      return {\n        flaw,\n        products: relatedProducts.slice(0, 2),\n        treatments: relatedTreatments.slice(0, 3),\n      };\n    });\n  }, [flaws, productRecommendations, recommendations]);\n\n  // Handle progress photo upload\n  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n    // Store current analysis as previous before re-analyzing\n    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n    setPreviousAnalysis({\n      date: new Date().toISOString(),\n      overallScore: numScore,\n      bodyFatPercent,\n      frontPhotoUrl: frontPhoto || undefined,\n    });\n\n    // In a real implementation, this would upload to API and trigger re-analysis\n    console.log('Progress photo uploaded:', file.name);\n  }, [overallScore, bodyFatPercent, frontPhoto]);\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Your Phase Card - Body Composition Phase */}\n          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n\n          {/* Daily Stack Card - Hero Element for ALL users */}\n          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Fix Your Weak Points Section */}\n          {flawsWithProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Upgrade CTA or Premium Badge */}\n          {hasPaidPlan ? (\n            <motion.div\n              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n    </TabContent>\n  );\n}\n","numLines":872,"startLine":1,"totalLines":872}}}
{"parentUuid":"a5335ba6-f97a-46f6-91b9-0a312fb76651","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Cv7DjnNRZZvjatRke3sNw1","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create a UI component for displaying treatment conflicts. I'll add it to the cards folder:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":13230,"cache_read_input_tokens":93922,"cache_creation":{"ephemeral_5m_input_tokens":13230,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWVVFZYEYGtKonsjvEjbW","type":"assistant","uuid":"d69d3f85-57ec-4f11-aa39-dba7c45df3e4","timestamp":"2025-12-26T14:52:28.360Z"}
{"parentUuid":"d69d3f85-57ec-4f11-aa39-dba7c45df3e4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Cv7DjnNRZZvjatRke3sNw1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QezCHwAYhaReK6z5EECtM1","name":"Write","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/TreatmentConflictWarning.tsx","content":"'use client';\n\nimport { useState } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  AlertTriangle,\n  X,\n  ChevronDown,\n  ChevronUp,\n  Info,\n  ArrowRight,\n  XCircle,\n} from 'lucide-react';\nimport type { TreatmentConflict } from '@/lib/recommendations/engine';\nimport type { ExclusiveCategory } from '@/lib/recommendations/types';\n\n// ============================================\n// CATEGORY DISPLAY INFO\n// ============================================\n\nconst CATEGORY_DISPLAY: Record<ExclusiveCategory, { label: string; color: string; icon: string }> = {\n  'jaw_augmentation': {\n    label: 'Jaw Augmentation',\n    color: 'from-blue-500 to-blue-600',\n    icon: 'A',\n  },\n  'jaw_reduction': {\n    label: 'Jaw Reduction',\n    color: 'from-purple-500 to-purple-600',\n    icon: 'R',\n  },\n  'chin_augmentation': {\n    label: 'Chin Enhancement',\n    color: 'from-cyan-500 to-cyan-600',\n    icon: 'C',\n  },\n  'cheekbone_augmentation': {\n    label: 'Cheekbone Enhancement',\n    color: 'from-pink-500 to-pink-600',\n    icon: 'Z',\n  },\n  'lip_augmentation': {\n    label: 'Lip Augmentation',\n    color: 'from-red-500 to-red-600',\n    icon: 'L+',\n  },\n  'lip_reduction': {\n    label: 'Lip Reduction',\n    color: 'from-orange-500 to-orange-600',\n    icon: 'L-',\n  },\n  'submental_fat_removal': {\n    label: 'Double Chin Treatment',\n    color: 'from-yellow-500 to-yellow-600',\n    icon: 'S',\n  },\n  'neck_procedures': {\n    label: 'Neck Procedures',\n    color: 'from-teal-500 to-teal-600',\n    icon: 'N',\n  },\n  'eye_lateral_canthus': {\n    label: 'Eye Corner Surgery',\n    color: 'from-indigo-500 to-indigo-600',\n    icon: 'E',\n  },\n  'maxillary_surgery': {\n    label: 'Jaw Repositioning',\n    color: 'from-rose-500 to-rose-600',\n    icon: 'M',\n  },\n};\n\n// ============================================\n// SINGLE CONFLICT CARD\n// ============================================\n\ninterface ConflictCardProps {\n  conflict: TreatmentConflict;\n  onDismiss?: () => void;\n}\n\nfunction ConflictCard({ conflict, onDismiss }: ConflictCardProps) {\n  const [isExpanded, setIsExpanded] = useState(false);\n  const categoryInfo = conflict.category ? CATEGORY_DISPLAY[conflict.category] : null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-red-950/50 to-orange-950/50 border border-red-500/30 rounded-xl overflow-hidden\"\n      initial={{ opacity: 0, y: -10 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, height: 0 }}\n    >\n      {/* Header */}\n      <div className=\"flex items-center gap-3 p-4\">\n        <div className=\"w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0\">\n          <AlertTriangle size={20} className=\"text-red-400\" />\n        </div>\n\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2 mb-0.5\">\n            <h4 className=\"text-sm font-semibold text-white\">Treatment Conflict Detected</h4>\n            {categoryInfo && (\n              <span className={`px-2 py-0.5 bg-gradient-to-r ${categoryInfo.color} text-white text-[10px] font-medium rounded-full`}>\n                {categoryInfo.label}\n              </span>\n            )}\n          </div>\n          <p className=\"text-xs text-neutral-400\">\n            These treatments are mutually exclusive\n          </p>\n        </div>\n\n        <div className=\"flex items-center gap-1\">\n          <button\n            onClick={() => setIsExpanded(!isExpanded)}\n            className=\"p-1.5 hover:bg-white/10 rounded-lg transition-colors\"\n            aria-label={isExpanded ? 'Collapse' : 'Expand'}\n          >\n            {isExpanded ? (\n              <ChevronUp size={16} className=\"text-neutral-400\" />\n            ) : (\n              <ChevronDown size={16} className=\"text-neutral-400\" />\n            )}\n          </button>\n          {onDismiss && (\n            <button\n              onClick={onDismiss}\n              className=\"p-1.5 hover:bg-white/10 rounded-lg transition-colors\"\n              aria-label=\"Dismiss\"\n            >\n              <X size={16} className=\"text-neutral-500\" />\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* Conflict Details */}\n      <div className=\"px-4 pb-3\">\n        <div className=\"flex items-center gap-2 p-2 bg-black/30 rounded-lg\">\n          <div className=\"flex-1 text-center\">\n            <p className=\"text-xs text-red-400/70 mb-0.5\">Treatment 1</p>\n            <p className=\"text-sm font-medium text-white truncate\">{conflict.treatment1Name}</p>\n          </div>\n          <div className=\"flex-shrink-0 p-1.5 bg-red-500/20 rounded-full\">\n            <XCircle size={14} className=\"text-red-400\" />\n          </div>\n          <div className=\"flex-1 text-center\">\n            <p className=\"text-xs text-red-400/70 mb-0.5\">Treatment 2</p>\n            <p className=\"text-sm font-medium text-white truncate\">{conflict.treatment2Name}</p>\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded Content */}\n      <AnimatePresence>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n          >\n            <div className=\"px-4 pb-4 pt-1 border-t border-red-500/20\">\n              <div className=\"flex items-start gap-2 p-3 bg-black/20 rounded-lg\">\n                <Info size={14} className=\"text-red-400 flex-shrink-0 mt-0.5\" />\n                <div>\n                  <p className=\"text-sm text-neutral-300 leading-relaxed\">\n                    {conflict.reason}\n                  </p>\n                  <p className=\"text-xs text-neutral-500 mt-2\">\n                    Choose one treatment from this category and remove the other from your plan.\n                  </p>\n                </div>\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\n// ============================================\n// CONFLICT LIST\n// ============================================\n\ninterface TreatmentConflictListProps {\n  conflicts: TreatmentConflict[];\n  onDismiss?: (conflict: TreatmentConflict) => void;\n  onDismissAll?: () => void;\n}\n\nexport function TreatmentConflictList({\n  conflicts,\n  onDismiss,\n  onDismissAll,\n}: TreatmentConflictListProps) {\n  if (conflicts.length === 0) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <AlertTriangle size={16} className=\"text-red-400\" />\n          <span className=\"text-sm font-medium text-white\">\n            {conflicts.length} Treatment Conflict{conflicts.length !== 1 ? 's' : ''}\n          </span>\n        </div>\n        {onDismissAll && conflicts.length > 1 && (\n          <button\n            onClick={onDismissAll}\n            className=\"text-xs text-neutral-500 hover:text-white transition-colors\"\n          >\n            Dismiss All\n          </button>\n        )}\n      </div>\n\n      {/* Conflicts */}\n      <AnimatePresence>\n        {conflicts.map((conflict, index) => (\n          <ConflictCard\n            key={`${conflict.treatment1Id}-${conflict.treatment2Id}`}\n            conflict={conflict}\n            onDismiss={onDismiss ? () => onDismiss(conflict) : undefined}\n          />\n        ))}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// INLINE WARNING BADGE\n// ============================================\n\ninterface TreatmentConflictBadgeProps {\n  conflictsWith: string;\n  onClick?: () => void;\n}\n\nexport function TreatmentConflictBadge({ conflictsWith, onClick }: TreatmentConflictBadgeProps) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"inline-flex items-center gap-1 px-2 py-0.5 bg-red-500/20 border border-red-500/30 text-red-400 text-xs font-medium rounded-full hover:bg-red-500/30 transition-colors\"\n    >\n      <AlertTriangle size={10} />\n      <span>Conflicts with {conflictsWith}</span>\n    </button>\n  );\n}\n\n// ============================================\n// SELECTION WARNING MODAL\n// ============================================\n\ninterface SelectionWarningModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  conflict: TreatmentConflict;\n  onProceed: () => void;\n  onCancel: () => void;\n}\n\nexport function SelectionWarningModal({\n  isOpen,\n  onClose,\n  conflict,\n  onProceed,\n  onCancel,\n}: SelectionWarningModalProps) {\n  const categoryInfo = conflict.category ? CATEGORY_DISPLAY[conflict.category] : null;\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <>\n          {/* Backdrop */}\n          <motion.div\n            className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-50\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            onClick={onClose}\n          />\n\n          {/* Modal */}\n          <motion.div\n            className=\"fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md z-50\"\n            initial={{ opacity: 0, scale: 0.95, y: 20 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.95, y: 20 }}\n          >\n            <div className=\"bg-neutral-900 border border-neutral-700 rounded-2xl overflow-hidden shadow-2xl\">\n              {/* Header */}\n              <div className=\"p-5 border-b border-neutral-800\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center\">\n                    <AlertTriangle size={24} className=\"text-red-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"text-lg font-semibold text-white\">Treatment Conflict</h3>\n                    {categoryInfo && (\n                      <span className={`inline-block px-2 py-0.5 bg-gradient-to-r ${categoryInfo.color} text-white text-xs font-medium rounded-full mt-1`}>\n                        {categoryInfo.label}\n                      </span>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Content */}\n              <div className=\"p-5 space-y-4\">\n                {/* Visual Conflict */}\n                <div className=\"flex items-center gap-3 p-4 bg-neutral-800/50 rounded-xl\">\n                  <div className=\"flex-1 text-center\">\n                    <div className=\"w-full p-3 bg-neutral-700/50 rounded-lg mb-2\">\n                      <p className=\"text-sm font-medium text-white\">{conflict.treatment1Name}</p>\n                    </div>\n                    <p className=\"text-xs text-green-400\">Already Selected</p>\n                  </div>\n                  <div className=\"flex-shrink-0\">\n                    <div className=\"w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center\">\n                      <XCircle size={16} className=\"text-red-400\" />\n                    </div>\n                  </div>\n                  <div className=\"flex-1 text-center\">\n                    <div className=\"w-full p-3 bg-neutral-700/50 rounded-lg mb-2\">\n                      <p className=\"text-sm font-medium text-white\">{conflict.treatment2Name}</p>\n                    </div>\n                    <p className=\"text-xs text-yellow-400\">New Selection</p>\n                  </div>\n                </div>\n\n                {/* Explanation */}\n                <div className=\"p-3 bg-red-950/30 border border-red-500/20 rounded-lg\">\n                  <p className=\"text-sm text-neutral-300 leading-relaxed\">\n                    {conflict.reason}\n                  </p>\n                </div>\n\n                {/* Options */}\n                <p className=\"text-xs text-neutral-500 text-center\">\n                  You can proceed (the lower priority treatment will be removed) or cancel to keep your current selection.\n                </p>\n              </div>\n\n              {/* Actions */}\n              <div className=\"p-5 border-t border-neutral-800 flex gap-3\">\n                <button\n                  onClick={onCancel}\n                  className=\"flex-1 py-2.5 bg-neutral-800 text-white font-medium rounded-lg hover:bg-neutral-700 transition-colors\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={onProceed}\n                  className=\"flex-1 py-2.5 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center gap-2\"\n                >\n                  Replace Treatment\n                  <ArrowRight size={16} />\n                </button>\n              </div>\n            </div>\n          </motion.div>\n        </>\n      )}\n    </AnimatePresence>\n  );\n}\n\n// ============================================\n// EXPORTS\n// ============================================\n\nexport { ConflictCard };\nexport default TreatmentConflictList;\n"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":13230,"cache_read_input_tokens":93922,"cache_creation":{"ephemeral_5m_input_tokens":13230,"ephemeral_1h_input_tokens":0},"output_tokens":4123,"service_tier":"standard"}},"requestId":"req_011CWVVFZYEYGtKonsjvEjbW","type":"assistant","uuid":"f27a5e17-984f-424b-afd3-ecc308cf481e","timestamp":"2025-12-26T14:53:25.612Z"}
{"parentUuid":"f27a5e17-984f-424b-afd3-ecc308cf481e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QezCHwAYhaReK6z5EECtM1","type":"tool_result","content":"File created successfully at: /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/TreatmentConflictWarning.tsx"}]},"uuid":"2e4bd43b-2c53-4696-8c67-648c4759cff0","timestamp":"2025-12-26T14:53:25.664Z","toolUseResult":{"type":"create","filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/TreatmentConflictWarning.tsx","content":"'use client';\n\nimport { useState } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  AlertTriangle,\n  X,\n  ChevronDown,\n  ChevronUp,\n  Info,\n  ArrowRight,\n  XCircle,\n} from 'lucide-react';\nimport type { TreatmentConflict } from '@/lib/recommendations/engine';\nimport type { ExclusiveCategory } from '@/lib/recommendations/types';\n\n// ============================================\n// CATEGORY DISPLAY INFO\n// ============================================\n\nconst CATEGORY_DISPLAY: Record<ExclusiveCategory, { label: string; color: string; icon: string }> = {\n  'jaw_augmentation': {\n    label: 'Jaw Augmentation',\n    color: 'from-blue-500 to-blue-600',\n    icon: 'A',\n  },\n  'jaw_reduction': {\n    label: 'Jaw Reduction',\n    color: 'from-purple-500 to-purple-600',\n    icon: 'R',\n  },\n  'chin_augmentation': {\n    label: 'Chin Enhancement',\n    color: 'from-cyan-500 to-cyan-600',\n    icon: 'C',\n  },\n  'cheekbone_augmentation': {\n    label: 'Cheekbone Enhancement',\n    color: 'from-pink-500 to-pink-600',\n    icon: 'Z',\n  },\n  'lip_augmentation': {\n    label: 'Lip Augmentation',\n    color: 'from-red-500 to-red-600',\n    icon: 'L+',\n  },\n  'lip_reduction': {\n    label: 'Lip Reduction',\n    color: 'from-orange-500 to-orange-600',\n    icon: 'L-',\n  },\n  'submental_fat_removal': {\n    label: 'Double Chin Treatment',\n    color: 'from-yellow-500 to-yellow-600',\n    icon: 'S',\n  },\n  'neck_procedures': {\n    label: 'Neck Procedures',\n    color: 'from-teal-500 to-teal-600',\n    icon: 'N',\n  },\n  'eye_lateral_canthus': {\n    label: 'Eye Corner Surgery',\n    color: 'from-indigo-500 to-indigo-600',\n    icon: 'E',\n  },\n  'maxillary_surgery': {\n    label: 'Jaw Repositioning',\n    color: 'from-rose-500 to-rose-600',\n    icon: 'M',\n  },\n};\n\n// ============================================\n// SINGLE CONFLICT CARD\n// ============================================\n\ninterface ConflictCardProps {\n  conflict: TreatmentConflict;\n  onDismiss?: () => void;\n}\n\nfunction ConflictCard({ conflict, onDismiss }: ConflictCardProps) {\n  const [isExpanded, setIsExpanded] = useState(false);\n  const categoryInfo = conflict.category ? CATEGORY_DISPLAY[conflict.category] : null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-red-950/50 to-orange-950/50 border border-red-500/30 rounded-xl overflow-hidden\"\n      initial={{ opacity: 0, y: -10 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, height: 0 }}\n    >\n      {/* Header */}\n      <div className=\"flex items-center gap-3 p-4\">\n        <div className=\"w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0\">\n          <AlertTriangle size={20} className=\"text-red-400\" />\n        </div>\n\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2 mb-0.5\">\n            <h4 className=\"text-sm font-semibold text-white\">Treatment Conflict Detected</h4>\n            {categoryInfo && (\n              <span className={`px-2 py-0.5 bg-gradient-to-r ${categoryInfo.color} text-white text-[10px] font-medium rounded-full`}>\n                {categoryInfo.label}\n              </span>\n            )}\n          </div>\n          <p className=\"text-xs text-neutral-400\">\n            These treatments are mutually exclusive\n          </p>\n        </div>\n\n        <div className=\"flex items-center gap-1\">\n          <button\n            onClick={() => setIsExpanded(!isExpanded)}\n            className=\"p-1.5 hover:bg-white/10 rounded-lg transition-colors\"\n            aria-label={isExpanded ? 'Collapse' : 'Expand'}\n          >\n            {isExpanded ? (\n              <ChevronUp size={16} className=\"text-neutral-400\" />\n            ) : (\n              <ChevronDown size={16} className=\"text-neutral-400\" />\n            )}\n          </button>\n          {onDismiss && (\n            <button\n              onClick={onDismiss}\n              className=\"p-1.5 hover:bg-white/10 rounded-lg transition-colors\"\n              aria-label=\"Dismiss\"\n            >\n              <X size={16} className=\"text-neutral-500\" />\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* Conflict Details */}\n      <div className=\"px-4 pb-3\">\n        <div className=\"flex items-center gap-2 p-2 bg-black/30 rounded-lg\">\n          <div className=\"flex-1 text-center\">\n            <p className=\"text-xs text-red-400/70 mb-0.5\">Treatment 1</p>\n            <p className=\"text-sm font-medium text-white truncate\">{conflict.treatment1Name}</p>\n          </div>\n          <div className=\"flex-shrink-0 p-1.5 bg-red-500/20 rounded-full\">\n            <XCircle size={14} className=\"text-red-400\" />\n          </div>\n          <div className=\"flex-1 text-center\">\n            <p className=\"text-xs text-red-400/70 mb-0.5\">Treatment 2</p>\n            <p className=\"text-sm font-medium text-white truncate\">{conflict.treatment2Name}</p>\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded Content */}\n      <AnimatePresence>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n          >\n            <div className=\"px-4 pb-4 pt-1 border-t border-red-500/20\">\n              <div className=\"flex items-start gap-2 p-3 bg-black/20 rounded-lg\">\n                <Info size={14} className=\"text-red-400 flex-shrink-0 mt-0.5\" />\n                <div>\n                  <p className=\"text-sm text-neutral-300 leading-relaxed\">\n                    {conflict.reason}\n                  </p>\n                  <p className=\"text-xs text-neutral-500 mt-2\">\n                    Choose one treatment from this category and remove the other from your plan.\n                  </p>\n                </div>\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\n// ============================================\n// CONFLICT LIST\n// ============================================\n\ninterface TreatmentConflictListProps {\n  conflicts: TreatmentConflict[];\n  onDismiss?: (conflict: TreatmentConflict) => void;\n  onDismissAll?: () => void;\n}\n\nexport function TreatmentConflictList({\n  conflicts,\n  onDismiss,\n  onDismissAll,\n}: TreatmentConflictListProps) {\n  if (conflicts.length === 0) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <AlertTriangle size={16} className=\"text-red-400\" />\n          <span className=\"text-sm font-medium text-white\">\n            {conflicts.length} Treatment Conflict{conflicts.length !== 1 ? 's' : ''}\n          </span>\n        </div>\n        {onDismissAll && conflicts.length > 1 && (\n          <button\n            onClick={onDismissAll}\n            className=\"text-xs text-neutral-500 hover:text-white transition-colors\"\n          >\n            Dismiss All\n          </button>\n        )}\n      </div>\n\n      {/* Conflicts */}\n      <AnimatePresence>\n        {conflicts.map((conflict, index) => (\n          <ConflictCard\n            key={`${conflict.treatment1Id}-${conflict.treatment2Id}`}\n            conflict={conflict}\n            onDismiss={onDismiss ? () => onDismiss(conflict) : undefined}\n          />\n        ))}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// INLINE WARNING BADGE\n// ============================================\n\ninterface TreatmentConflictBadgeProps {\n  conflictsWith: string;\n  onClick?: () => void;\n}\n\nexport function TreatmentConflictBadge({ conflictsWith, onClick }: TreatmentConflictBadgeProps) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"inline-flex items-center gap-1 px-2 py-0.5 bg-red-500/20 border border-red-500/30 text-red-400 text-xs font-medium rounded-full hover:bg-red-500/30 transition-colors\"\n    >\n      <AlertTriangle size={10} />\n      <span>Conflicts with {conflictsWith}</span>\n    </button>\n  );\n}\n\n// ============================================\n// SELECTION WARNING MODAL\n// ============================================\n\ninterface SelectionWarningModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  conflict: TreatmentConflict;\n  onProceed: () => void;\n  onCancel: () => void;\n}\n\nexport function SelectionWarningModal({\n  isOpen,\n  onClose,\n  conflict,\n  onProceed,\n  onCancel,\n}: SelectionWarningModalProps) {\n  const categoryInfo = conflict.category ? CATEGORY_DISPLAY[conflict.category] : null;\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <>\n          {/* Backdrop */}\n          <motion.div\n            className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-50\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            onClick={onClose}\n          />\n\n          {/* Modal */}\n          <motion.div\n            className=\"fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md z-50\"\n            initial={{ opacity: 0, scale: 0.95, y: 20 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.95, y: 20 }}\n          >\n            <div className=\"bg-neutral-900 border border-neutral-700 rounded-2xl overflow-hidden shadow-2xl\">\n              {/* Header */}\n              <div className=\"p-5 border-b border-neutral-800\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center\">\n                    <AlertTriangle size={24} className=\"text-red-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"text-lg font-semibold text-white\">Treatment Conflict</h3>\n                    {categoryInfo && (\n                      <span className={`inline-block px-2 py-0.5 bg-gradient-to-r ${categoryInfo.color} text-white text-xs font-medium rounded-full mt-1`}>\n                        {categoryInfo.label}\n                      </span>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Content */}\n              <div className=\"p-5 space-y-4\">\n                {/* Visual Conflict */}\n                <div className=\"flex items-center gap-3 p-4 bg-neutral-800/50 rounded-xl\">\n                  <div className=\"flex-1 text-center\">\n                    <div className=\"w-full p-3 bg-neutral-700/50 rounded-lg mb-2\">\n                      <p className=\"text-sm font-medium text-white\">{conflict.treatment1Name}</p>\n                    </div>\n                    <p className=\"text-xs text-green-400\">Already Selected</p>\n                  </div>\n                  <div className=\"flex-shrink-0\">\n                    <div className=\"w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center\">\n                      <XCircle size={16} className=\"text-red-400\" />\n                    </div>\n                  </div>\n                  <div className=\"flex-1 text-center\">\n                    <div className=\"w-full p-3 bg-neutral-700/50 rounded-lg mb-2\">\n                      <p className=\"text-sm font-medium text-white\">{conflict.treatment2Name}</p>\n                    </div>\n                    <p className=\"text-xs text-yellow-400\">New Selection</p>\n                  </div>\n                </div>\n\n                {/* Explanation */}\n                <div className=\"p-3 bg-red-950/30 border border-red-500/20 rounded-lg\">\n                  <p className=\"text-sm text-neutral-300 leading-relaxed\">\n                    {conflict.reason}\n                  </p>\n                </div>\n\n                {/* Options */}\n                <p className=\"text-xs text-neutral-500 text-center\">\n                  You can proceed (the lower priority treatment will be removed) or cancel to keep your current selection.\n                </p>\n              </div>\n\n              {/* Actions */}\n              <div className=\"p-5 border-t border-neutral-800 flex gap-3\">\n                <button\n                  onClick={onCancel}\n                  className=\"flex-1 py-2.5 bg-neutral-800 text-white font-medium rounded-lg hover:bg-neutral-700 transition-colors\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={onProceed}\n                  className=\"flex-1 py-2.5 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center gap-2\"\n                >\n                  Replace Treatment\n                  <ArrowRight size={16} />\n                </button>\n              </div>\n            </div>\n          </motion.div>\n        </>\n      )}\n    </AnimatePresence>\n  );\n}\n\n// ============================================\n// EXPORTS\n// ============================================\n\nexport { ConflictCard };\nexport default TreatmentConflictList;\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"2e4bd43b-2c53-4696-8c67-648c4759cff0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BfdVtMuD7bLJbwfzKEp2MG","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the PlanTab to use the conflict detection and warning components:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4179,"cache_read_input_tokens":107152,"cache_creation":{"ephemeral_5m_input_tokens":4179,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVLAiS1PzmG54ZTAMDF","type":"assistant","uuid":"658de07a-b3e4-45c3-afbb-993d800f1d00","timestamp":"2025-12-26T14:53:29.575Z"}
{"parentUuid":"658de07a-b3e4-45c3-afbb-993d800f1d00","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BfdVtMuD7bLJbwfzKEp2MG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01L9D7iz8kMvoKMWWUiPdBPu","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","old_string":"import { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';","new_string":"import { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\nimport {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":4179,"cache_read_input_tokens":107152,"cache_creation":{"ephemeral_5m_input_tokens":4179,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVLAiS1PzmG54ZTAMDF","type":"assistant","uuid":"cbf82a7e-079a-4cde-88fd-08c08c40ccad","timestamp":"2025-12-26T14:53:35.419Z"}
{"parentUuid":"cbf82a7e-079a-4cde-88fd-08c08c40ccad","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01L9D7iz8kMvoKMWWUiPdBPu","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    36→import { ProductCard } from '../cards/ProductCard';\n    37→import { WeakPointCard } from '../cards/WeakPointCard';\n    38→import { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\n    39→import { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\n    40→import { generateDailyStack } from '@/lib/daily-stack';\n    41→import { getProductRecommendations } from '@/lib/product-recommendations';\n    42→import { SUPPLEMENTS } from '@/lib/recommendations/supplements';\n    43→import {\n    44→  TreatmentConflictList,\n    45→  SelectionWarningModal,\n    46→} from '../cards/TreatmentConflictWarning';\n    47→import {\n    48→  findTreatmentConflicts,\n    49→  filterConflictingRecommendations,\n    50→  type TreatmentConflict,\n    51→} from '@/lib/recommendations/engine';\n    52→\n    53→// ============================================\n    54→// POTENTIAL SCORE CARD\n    55→// ============================================"}]},"uuid":"0189ee52-1376-405c-b69d-0a02ec1b688c","timestamp":"2025-12-26T14:53:35.494Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","oldString":"import { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';","newString":"import { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\nimport {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';","originalFile":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n  CheckCircle,\n  AlertCircle,\n  CheckCircle2,\n  Scale,\n  Dumbbell,\n  Salad,\n  ArrowDown,\n  ArrowUp,\n  Minus,\n  Package,\n  ShoppingCart,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { usePricing } from '@/contexts/PricingContext';\nimport { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\nimport { FaceMorphing } from '../visualization/FaceMorphing';\nimport { TreatmentTimeline } from '../visualization/TreatmentTimeline';\nimport { RecommendationPhase, ProductRecommendation } from '@/types/results';\nimport { DailyStackCard } from '../cards/DailyStackCard';\nimport { ProductCard } from '../cards/ProductCard';\nimport { WeakPointCard } from '../cards/WeakPointCard';\nimport { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\nimport { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\nimport { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n          ? 'bg-cyan-500 text-black'\n          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n            ? 'bg-neutral-700 text-white'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n            }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n// ============================================\n\ntype PreviewMode = 'static' | 'morphing';\n\nfunction BeforeAfterPreviewSection() {\n  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  if (!frontPhoto) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n        <button\n          onClick={() => setPreviewMode('morphing')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'morphing'\n              ? 'bg-cyan-500/20 text-cyan-400'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Face Morphing\n        </button>\n        <button\n          onClick={() => setPreviewMode('static')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'static'\n              ? 'bg-neutral-700 text-white'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Static Preview\n        </button>\n      </div>\n\n      {/* Preview Component */}\n      <AnimatePresence mode=\"wait\">\n        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n          <motion.div\n            key=\"morphing\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: 20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <FaceMorphing\n              photo={frontPhoto}\n              frontLandmarks={frontLandmarks}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"static\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: -20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <BeforeAfterPreview\n              photo={frontPhoto}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// YOUR PHASE CARD (Body Composition Phase)\n// ============================================\n\ntype BodyPhase = 'bulk' | 'cut' | 'maintain';\n\ninterface YourPhaseCardProps {\n  bodyFatPercent?: number;\n  gender: 'male' | 'female';\n}\n\nfunction YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n  // Determine phase based on body fat and gender\n  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n    if (!bodyFatPercent) {\n      return {\n        phase: 'maintain',\n        message: 'Complete your physique analysis to get personalized phase recommendations.',\n        color: 'from-neutral-700 to-neutral-800',\n        icon: <Scale size={24} className=\"text-neutral-400\" />,\n      };\n    }\n\n    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n    const bulkThreshold = gender === 'male' ? 12 : 18;\n    const cutThreshold = gender === 'male' ? 18 : 25;\n\n    if (bodyFatPercent < bulkThreshold) {\n      return {\n        phase: 'bulk',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n        color: 'from-green-600 to-emerald-700',\n        icon: <Dumbbell size={24} className=\"text-white\" />,\n      };\n    } else if (bodyFatPercent > cutThreshold) {\n      return {\n        phase: 'cut',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n        color: 'from-orange-600 to-red-700',\n        icon: <Salad size={24} className=\"text-white\" />,\n      };\n    } else {\n      return {\n        phase: 'maintain',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n        color: 'from-blue-600 to-cyan-700',\n        icon: <Scale size={24} className=\"text-white\" />,\n      };\n    }\n  };\n\n  const { phase, message, color, icon } = getPhase();\n  const phaseLabels: Record<BodyPhase, string> = {\n    bulk: 'Lean Bulk Phase',\n    cut: 'Cutting Phase',\n    maintain: 'Maintenance Phase',\n  };\n\n  return (\n    <motion.div\n      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-start gap-4\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n          {icon}\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n              {phaseLabels[phase]}\n            </div>\n          </div>\n          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n\n          {/* Phase-specific tips */}\n          <div className=\"grid grid-cols-3 gap-2\">\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n                {phase === 'bulk' ? (\n                  <ArrowUp size={12} className=\"text-green-300\" />\n                ) : phase === 'cut' ? (\n                  <ArrowDown size={12} className=\"text-orange-300\" />\n                ) : (\n                  <Minus size={12} className=\"text-blue-300\" />\n                )}\n                <span className=\"text-xs text-white/60\">Calories</span>\n              </div>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PRODUCT BUNDLE CTA\n// ============================================\n\ninterface ProductBundleCardProps {\n  products: ProductRecommendation[];\n  title?: string;\n}\n\nfunction ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n  // Get top 3 most important products\n  const bundleProducts = products.slice(0, 3);\n\n  // Calculate total cost\n  const totalCost = bundleProducts.reduce((sum, rec) => {\n    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n    return sum + (supplement?.costPerMonth.min || 0);\n  }, 0);\n\n  if (bundleProducts.length === 0) return null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Package size={20} className=\"text-purple-400\" />\n        <h3 className=\"font-semibold text-white\">{title}</h3>\n        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n          Save 15%\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-300 mb-4\">\n        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n      </p>\n\n      {/* Bundle Items */}\n      <div className=\"space-y-2 mb-4\">\n        {bundleProducts.map((rec, index) => (\n          <div\n            key={rec.product.id}\n            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n          >\n            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n            </div>\n            <div className=\"text-right flex-shrink-0\">\n              <p className=\"text-sm text-white\">\n                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n              </p>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Total & CTA */}\n      <div className=\"border-t border-purple-500/20 pt-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-neutral-400\">Bundle Total</span>\n          <div className=\"text-right\">\n            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n          </div>\n        </div>\n        <button\n          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n        >\n          <ShoppingCart size={18} />\n          Get Your Bundle\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  const { openPricingModal } = usePricing();\n\n  // Convert to number for arithmetic operations\n  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Check if user has a paid plan\n  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n\n  // Get body fat from physique analysis\n  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n\n  // Generate Daily Stack for all users\n  const dailyStack = useMemo(() => {\n    return generateDailyStack(gender);\n  }, [gender]);\n\n  // Generate Product Recommendations based on metrics\n  const productRecommendations = useMemo(() => {\n    // Build metrics and severity dictionaries from ratios\n    const metricsDict: Record<string, number> = {};\n    const severityDict: Record<string, string> = {};\n\n    [...frontRatios, ...sideRatios].forEach(ratio => {\n      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n      severityDict[ratio.name] = ratio.severity;\n    });\n\n    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n  }, [frontRatios, sideRatios, gender, ethnicity]);\n\n  // Split product recommendations by state\n  const { flawProducts, idealProducts } = useMemo(() => {\n    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n    return { flawProducts: flaw, idealProducts: ideal };\n  }, [productRecommendations]);\n\n  // Map flaws to products and treatments\n  const flawsWithProducts = useMemo(() => {\n    return flaws.slice(0, 5).map(flaw => {\n      // Find products that target metrics related to this flaw\n      const relatedProducts = productRecommendations.filter(rec =>\n        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n          rec.matchedMetrics.some(metric =>\n            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n          )\n        )\n      );\n\n      // Find treatments that match this flaw\n      const relatedTreatments = recommendations.filter(rec =>\n        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n      );\n\n      return {\n        flaw,\n        products: relatedProducts.slice(0, 2),\n        treatments: relatedTreatments.slice(0, 3),\n      };\n    });\n  }, [flaws, productRecommendations, recommendations]);\n\n  // Handle progress photo upload\n  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n    // Store current analysis as previous before re-analyzing\n    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n    setPreviousAnalysis({\n      date: new Date().toISOString(),\n      overallScore: numScore,\n      bodyFatPercent,\n      frontPhotoUrl: frontPhoto || undefined,\n    });\n\n    // In a real implementation, this would upload to API and trigger re-analysis\n    console.log('Progress photo uploaded:', file.name);\n  }, [overallScore, bodyFatPercent, frontPhoto]);\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Your Phase Card - Body Composition Phase */}\n          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n\n          {/* Daily Stack Card - Hero Element for ALL users */}\n          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Fix Your Weak Points Section */}\n          {flawsWithProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Upgrade CTA or Premium Badge */}\n          {hasPaidPlan ? (\n            <motion.div\n              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n    </TabContent>\n  );\n}\n","structuredPatch":[{"oldStart":40,"oldLines":6,"newStart":40,"newLines":15,"lines":[" import { generateDailyStack } from '@/lib/daily-stack';"," import { getProductRecommendations } from '@/lib/product-recommendations';"," import { SUPPLEMENTS } from '@/lib/recommendations/supplements';","+import {","+  TreatmentConflictList,","+  SelectionWarningModal,","+} from '../cards/TreatmentConflictWarning';","+import {","+  findTreatmentConflicts,","+  filterConflictingRecommendations,","+  type TreatmentConflict,","+} from '@/lib/recommendations/engine';"," "," // ============================================"," // POTENTIAL SCORE CARD"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"0189ee52-1376-405c-b69d-0a02ec1b688c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CmJ229gNA6kGAwde2LwK7Z","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me add the conflict detection state and UI to the PlanTab:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":891,"cache_read_input_tokens":111331,"cache_creation":{"ephemeral_5m_input_tokens":891,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVLtf4niVMBRVLYvRDh","type":"assistant","uuid":"1a43508e-2356-4673-adec-f24a20c5b7fe","timestamp":"2025-12-26T14:53:38.339Z"}
{"parentUuid":"1a43508e-2356-4673-adec-f24a20c5b7fe","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CmJ229gNA6kGAwde2LwK7Z","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KVML2cXvCsZKnhoDoYrNfr","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","old_string":"export function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  const { openPricingModal } = usePricing();","new_string":"export function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  // Treatment conflict state\n  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());\n  const [conflictModal, setConflictModal] = useState<{\n    isOpen: boolean;\n    conflict: TreatmentConflict | null;\n    newTreatmentId: string;\n  }>({ isOpen: false, conflict: null, newTreatmentId: '' });\n\n  const { openPricingModal } = usePricing();"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":891,"cache_read_input_tokens":111331,"cache_creation":{"ephemeral_5m_input_tokens":891,"ephemeral_1h_input_tokens":0},"output_tokens":745,"service_tier":"standard"}},"requestId":"req_011CWVVLtf4niVMBRVLYvRDh","type":"assistant","uuid":"87701295-45c9-4271-87a4-28ee61b9a3d4","timestamp":"2025-12-26T14:53:48.550Z"}
{"parentUuid":"87701295-45c9-4271-87a4-28ee61b9a3d4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KVML2cXvCsZKnhoDoYrNfr","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   482→// ============================================\n   483→// PLAN TAB\n   484→// ============================================\n   485→\n   486→export function PlanTab() {\n   487→  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n   488→  const { user } = useAuth();\n   489→  const physiqueContext = usePhysiqueOptional();\n   490→  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n   491→  const [expandedId, setExpandedId] = useState<string | null>(null);\n   492→  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n   493→  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n   494→  const [previousAnalysis, setPreviousAnalysis] = useState<{\n   495→    date: string;\n   496→    overallScore: number;\n   497→    bodyFatPercent?: number;\n   498→    frontPhotoUrl?: string;\n   499→  } | null>(null);\n   500→\n   501→  // Treatment conflict state\n   502→  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());\n   503→  const [conflictModal, setConflictModal] = useState<{\n   504→    isOpen: boolean;\n   505→    conflict: TreatmentConflict | null;\n   506→    newTreatmentId: string;\n   507→  }>({ isOpen: false, conflict: null, newTreatmentId: '' });\n   508→\n   509→  const { openPricingModal } = usePricing();\n   510→\n   511→  // Convert to number for arithmetic operations\n   512→  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n   513→"}]},"uuid":"32e709f4-e143-4d1f-ae5d-264867b11166","timestamp":"2025-12-26T14:53:48.609Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","oldString":"export function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  const { openPricingModal } = usePricing();","newString":"export function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  // Treatment conflict state\n  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());\n  const [conflictModal, setConflictModal] = useState<{\n    isOpen: boolean;\n    conflict: TreatmentConflict | null;\n    newTreatmentId: string;\n  }>({ isOpen: false, conflict: null, newTreatmentId: '' });\n\n  const { openPricingModal } = usePricing();","originalFile":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n  CheckCircle,\n  AlertCircle,\n  CheckCircle2,\n  Scale,\n  Dumbbell,\n  Salad,\n  ArrowDown,\n  ArrowUp,\n  Minus,\n  Package,\n  ShoppingCart,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { usePricing } from '@/contexts/PricingContext';\nimport { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\nimport { FaceMorphing } from '../visualization/FaceMorphing';\nimport { TreatmentTimeline } from '../visualization/TreatmentTimeline';\nimport { RecommendationPhase, ProductRecommendation } from '@/types/results';\nimport { DailyStackCard } from '../cards/DailyStackCard';\nimport { ProductCard } from '../cards/ProductCard';\nimport { WeakPointCard } from '../cards/WeakPointCard';\nimport { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\nimport { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\nimport { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\nimport {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n          ? 'bg-cyan-500 text-black'\n          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n            ? 'bg-neutral-700 text-white'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n            }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n// ============================================\n\ntype PreviewMode = 'static' | 'morphing';\n\nfunction BeforeAfterPreviewSection() {\n  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  if (!frontPhoto) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n        <button\n          onClick={() => setPreviewMode('morphing')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'morphing'\n              ? 'bg-cyan-500/20 text-cyan-400'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Face Morphing\n        </button>\n        <button\n          onClick={() => setPreviewMode('static')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'static'\n              ? 'bg-neutral-700 text-white'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Static Preview\n        </button>\n      </div>\n\n      {/* Preview Component */}\n      <AnimatePresence mode=\"wait\">\n        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n          <motion.div\n            key=\"morphing\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: 20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <FaceMorphing\n              photo={frontPhoto}\n              frontLandmarks={frontLandmarks}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"static\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: -20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <BeforeAfterPreview\n              photo={frontPhoto}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// YOUR PHASE CARD (Body Composition Phase)\n// ============================================\n\ntype BodyPhase = 'bulk' | 'cut' | 'maintain';\n\ninterface YourPhaseCardProps {\n  bodyFatPercent?: number;\n  gender: 'male' | 'female';\n}\n\nfunction YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n  // Determine phase based on body fat and gender\n  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n    if (!bodyFatPercent) {\n      return {\n        phase: 'maintain',\n        message: 'Complete your physique analysis to get personalized phase recommendations.',\n        color: 'from-neutral-700 to-neutral-800',\n        icon: <Scale size={24} className=\"text-neutral-400\" />,\n      };\n    }\n\n    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n    const bulkThreshold = gender === 'male' ? 12 : 18;\n    const cutThreshold = gender === 'male' ? 18 : 25;\n\n    if (bodyFatPercent < bulkThreshold) {\n      return {\n        phase: 'bulk',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n        color: 'from-green-600 to-emerald-700',\n        icon: <Dumbbell size={24} className=\"text-white\" />,\n      };\n    } else if (bodyFatPercent > cutThreshold) {\n      return {\n        phase: 'cut',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n        color: 'from-orange-600 to-red-700',\n        icon: <Salad size={24} className=\"text-white\" />,\n      };\n    } else {\n      return {\n        phase: 'maintain',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n        color: 'from-blue-600 to-cyan-700',\n        icon: <Scale size={24} className=\"text-white\" />,\n      };\n    }\n  };\n\n  const { phase, message, color, icon } = getPhase();\n  const phaseLabels: Record<BodyPhase, string> = {\n    bulk: 'Lean Bulk Phase',\n    cut: 'Cutting Phase',\n    maintain: 'Maintenance Phase',\n  };\n\n  return (\n    <motion.div\n      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-start gap-4\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n          {icon}\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n              {phaseLabels[phase]}\n            </div>\n          </div>\n          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n\n          {/* Phase-specific tips */}\n          <div className=\"grid grid-cols-3 gap-2\">\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n                {phase === 'bulk' ? (\n                  <ArrowUp size={12} className=\"text-green-300\" />\n                ) : phase === 'cut' ? (\n                  <ArrowDown size={12} className=\"text-orange-300\" />\n                ) : (\n                  <Minus size={12} className=\"text-blue-300\" />\n                )}\n                <span className=\"text-xs text-white/60\">Calories</span>\n              </div>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PRODUCT BUNDLE CTA\n// ============================================\n\ninterface ProductBundleCardProps {\n  products: ProductRecommendation[];\n  title?: string;\n}\n\nfunction ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n  // Get top 3 most important products\n  const bundleProducts = products.slice(0, 3);\n\n  // Calculate total cost\n  const totalCost = bundleProducts.reduce((sum, rec) => {\n    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n    return sum + (supplement?.costPerMonth.min || 0);\n  }, 0);\n\n  if (bundleProducts.length === 0) return null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Package size={20} className=\"text-purple-400\" />\n        <h3 className=\"font-semibold text-white\">{title}</h3>\n        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n          Save 15%\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-300 mb-4\">\n        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n      </p>\n\n      {/* Bundle Items */}\n      <div className=\"space-y-2 mb-4\">\n        {bundleProducts.map((rec, index) => (\n          <div\n            key={rec.product.id}\n            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n          >\n            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n            </div>\n            <div className=\"text-right flex-shrink-0\">\n              <p className=\"text-sm text-white\">\n                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n              </p>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Total & CTA */}\n      <div className=\"border-t border-purple-500/20 pt-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-neutral-400\">Bundle Total</span>\n          <div className=\"text-right\">\n            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n          </div>\n        </div>\n        <button\n          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n        >\n          <ShoppingCart size={18} />\n          Get Your Bundle\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  const { openPricingModal } = usePricing();\n\n  // Convert to number for arithmetic operations\n  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Check if user has a paid plan\n  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n\n  // Get body fat from physique analysis\n  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n\n  // Generate Daily Stack for all users\n  const dailyStack = useMemo(() => {\n    return generateDailyStack(gender);\n  }, [gender]);\n\n  // Generate Product Recommendations based on metrics\n  const productRecommendations = useMemo(() => {\n    // Build metrics and severity dictionaries from ratios\n    const metricsDict: Record<string, number> = {};\n    const severityDict: Record<string, string> = {};\n\n    [...frontRatios, ...sideRatios].forEach(ratio => {\n      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n      severityDict[ratio.name] = ratio.severity;\n    });\n\n    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n  }, [frontRatios, sideRatios, gender, ethnicity]);\n\n  // Split product recommendations by state\n  const { flawProducts, idealProducts } = useMemo(() => {\n    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n    return { flawProducts: flaw, idealProducts: ideal };\n  }, [productRecommendations]);\n\n  // Map flaws to products and treatments\n  const flawsWithProducts = useMemo(() => {\n    return flaws.slice(0, 5).map(flaw => {\n      // Find products that target metrics related to this flaw\n      const relatedProducts = productRecommendations.filter(rec =>\n        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n          rec.matchedMetrics.some(metric =>\n            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n          )\n        )\n      );\n\n      // Find treatments that match this flaw\n      const relatedTreatments = recommendations.filter(rec =>\n        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n      );\n\n      return {\n        flaw,\n        products: relatedProducts.slice(0, 2),\n        treatments: relatedTreatments.slice(0, 3),\n      };\n    });\n  }, [flaws, productRecommendations, recommendations]);\n\n  // Handle progress photo upload\n  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n    // Store current analysis as previous before re-analyzing\n    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n    setPreviousAnalysis({\n      date: new Date().toISOString(),\n      overallScore: numScore,\n      bodyFatPercent,\n      frontPhotoUrl: frontPhoto || undefined,\n    });\n\n    // In a real implementation, this would upload to API and trigger re-analysis\n    console.log('Progress photo uploaded:', file.name);\n  }, [overallScore, bodyFatPercent, frontPhoto]);\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Your Phase Card - Body Composition Phase */}\n          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n\n          {/* Daily Stack Card - Hero Element for ALL users */}\n          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Fix Your Weak Points Section */}\n          {flawsWithProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Upgrade CTA or Premium Badge */}\n          {hasPaidPlan ? (\n            <motion.div\n              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n    </TabContent>\n  );\n}\n","structuredPatch":[{"oldStart":498,"oldLines":6,"newStart":498,"newLines":14,"lines":["     frontPhotoUrl?: string;","   } | null>(null);"," ","+  // Treatment conflict state","+  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());","+  const [conflictModal, setConflictModal] = useState<{","+    isOpen: boolean;","+    conflict: TreatmentConflict | null;","+    newTreatmentId: string;","+  }>({ isOpen: false, conflict: null, newTreatmentId: '' });","+","   const { openPricingModal } = usePricing();"," ","   // Convert to number for arithmetic operations"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"32e709f4-e143-4d1f-ae5d-264867b11166","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01F7M6oSYbph7QeS7SenLbey","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me add the conflict detection logic after the filtered recommendations useMemo:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1326,"cache_read_input_tokens":112222,"cache_creation":{"ephemeral_5m_input_tokens":1326,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWVVMrqDGqnguayrG9rBM","type":"assistant","uuid":"0fe2289c-988a-4180-be4d-3eaa40c002b4","timestamp":"2025-12-26T14:53:51.304Z"}
{"parentUuid":"0fe2289c-988a-4180-be4d-3eaa40c002b4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01F7M6oSYbph7QeS7SenLbey","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019HVpcRQxixS8sziBb3pFyn","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","old_string":"// Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;","new_string":"// Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.title])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);\n\n  // Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set([...prev, conflictKey]));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);\n\n  const handleConflictCancel = useCallback(() => {\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, []);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1326,"cache_read_input_tokens":112222,"cache_creation":{"ephemeral_5m_input_tokens":1326,"ephemeral_1h_input_tokens":0},"output_tokens":885,"service_tier":"standard"}},"requestId":"req_011CWVVMrqDGqnguayrG9rBM","type":"assistant","uuid":"cd8649ce-6e9b-41da-b346-8152c23d41f3","timestamp":"2025-12-26T14:54:03.668Z"}
{"parentUuid":"cd8649ce-6e9b-41da-b346-8152c23d41f3","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019HVpcRQxixS8sziBb3pFyn","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   598→    });\n   599→    return counts;\n   600→  }, [recommendations, removedIds]);\n   601→\n   602→  // Filter recommendations\n   603→  const filteredRecommendations = useMemo(() => {\n   604→    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n   605→    if (selectedPhase) {\n   606→      filtered = filtered.filter(r => r.phase === selectedPhase);\n   607→    }\n   608→    return filtered;\n   609→  }, [recommendations, selectedPhase, removedIds]);\n   610→\n   611→  const hasRecommendations = filteredRecommendations.length > 0;\n   612→\n   613→  // Detect treatment conflicts in current recommendations\n   614→  const treatmentConflicts = useMemo(() => {\n   615→    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n   616→    const nameMap = Object.fromEntries(\n   617→      filteredRecommendations.map(r => [r.ref_id, r.title])\n   618→    );\n   619→    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n   620→\n   621→    // Filter out dismissed conflicts\n   622→    return conflicts.filter(c => {\n   623→      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n   624→      return !dismissedConflicts.has(conflictKey);\n   625→    });\n   626→  }, [filteredRecommendations, dismissedConflicts]);\n   627→\n   628→  // Handle dismissing a conflict\n   629→  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n   630→    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n   631→    setDismissedConflicts(prev => new Set([...prev, conflictKey]));\n   632→  }, []);\n   633→\n   634→  // Handle dismissing all conflicts\n   635→  const handleDismissAllConflicts = useCallback(() => {\n   636→    const allKeys = treatmentConflicts.map(\n   637→      c => `${c.treatment1Id}-${c.treatment2Id}`\n   638→    );\n   639→    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));\n   640→  }, [treatmentConflicts]);\n   641→\n   642→  // Handle conflict modal actions\n   643→  const handleConflictProceed = useCallback(() => {\n   644→    if (conflictModal.conflict) {\n   645→      // Remove the lower priority (existing) treatment\n   646→      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));\n   647→    }\n   648→    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n   649→  }, [conflictModal.conflict]);\n   650→\n   651→  const handleConflictCancel = useCallback(() => {\n   652→    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n   653→  }, []);\n   654→\n   655→  // Handle mark complete\n   656→  const handleMarkComplete = useCallback((id: string) => {\n   657→    setCompletedIds(prev => {"}]},"uuid":"66bdf329-ed77-4c90-bc2b-0df3af53c96e","timestamp":"2025-12-26T14:54:03.724Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","oldString":"// Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;","newString":"// Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.title])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);\n\n  // Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set([...prev, conflictKey]));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);\n\n  const handleConflictCancel = useCallback(() => {\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, []);","originalFile":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n  CheckCircle,\n  AlertCircle,\n  CheckCircle2,\n  Scale,\n  Dumbbell,\n  Salad,\n  ArrowDown,\n  ArrowUp,\n  Minus,\n  Package,\n  ShoppingCart,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { usePricing } from '@/contexts/PricingContext';\nimport { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\nimport { FaceMorphing } from '../visualization/FaceMorphing';\nimport { TreatmentTimeline } from '../visualization/TreatmentTimeline';\nimport { RecommendationPhase, ProductRecommendation } from '@/types/results';\nimport { DailyStackCard } from '../cards/DailyStackCard';\nimport { ProductCard } from '../cards/ProductCard';\nimport { WeakPointCard } from '../cards/WeakPointCard';\nimport { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\nimport { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\nimport { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\nimport {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n          ? 'bg-cyan-500 text-black'\n          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n            ? 'bg-neutral-700 text-white'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n            }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n// ============================================\n\ntype PreviewMode = 'static' | 'morphing';\n\nfunction BeforeAfterPreviewSection() {\n  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  if (!frontPhoto) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n        <button\n          onClick={() => setPreviewMode('morphing')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'morphing'\n              ? 'bg-cyan-500/20 text-cyan-400'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Face Morphing\n        </button>\n        <button\n          onClick={() => setPreviewMode('static')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'static'\n              ? 'bg-neutral-700 text-white'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Static Preview\n        </button>\n      </div>\n\n      {/* Preview Component */}\n      <AnimatePresence mode=\"wait\">\n        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n          <motion.div\n            key=\"morphing\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: 20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <FaceMorphing\n              photo={frontPhoto}\n              frontLandmarks={frontLandmarks}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"static\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: -20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <BeforeAfterPreview\n              photo={frontPhoto}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// YOUR PHASE CARD (Body Composition Phase)\n// ============================================\n\ntype BodyPhase = 'bulk' | 'cut' | 'maintain';\n\ninterface YourPhaseCardProps {\n  bodyFatPercent?: number;\n  gender: 'male' | 'female';\n}\n\nfunction YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n  // Determine phase based on body fat and gender\n  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n    if (!bodyFatPercent) {\n      return {\n        phase: 'maintain',\n        message: 'Complete your physique analysis to get personalized phase recommendations.',\n        color: 'from-neutral-700 to-neutral-800',\n        icon: <Scale size={24} className=\"text-neutral-400\" />,\n      };\n    }\n\n    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n    const bulkThreshold = gender === 'male' ? 12 : 18;\n    const cutThreshold = gender === 'male' ? 18 : 25;\n\n    if (bodyFatPercent < bulkThreshold) {\n      return {\n        phase: 'bulk',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n        color: 'from-green-600 to-emerald-700',\n        icon: <Dumbbell size={24} className=\"text-white\" />,\n      };\n    } else if (bodyFatPercent > cutThreshold) {\n      return {\n        phase: 'cut',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n        color: 'from-orange-600 to-red-700',\n        icon: <Salad size={24} className=\"text-white\" />,\n      };\n    } else {\n      return {\n        phase: 'maintain',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n        color: 'from-blue-600 to-cyan-700',\n        icon: <Scale size={24} className=\"text-white\" />,\n      };\n    }\n  };\n\n  const { phase, message, color, icon } = getPhase();\n  const phaseLabels: Record<BodyPhase, string> = {\n    bulk: 'Lean Bulk Phase',\n    cut: 'Cutting Phase',\n    maintain: 'Maintenance Phase',\n  };\n\n  return (\n    <motion.div\n      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-start gap-4\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n          {icon}\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n              {phaseLabels[phase]}\n            </div>\n          </div>\n          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n\n          {/* Phase-specific tips */}\n          <div className=\"grid grid-cols-3 gap-2\">\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n                {phase === 'bulk' ? (\n                  <ArrowUp size={12} className=\"text-green-300\" />\n                ) : phase === 'cut' ? (\n                  <ArrowDown size={12} className=\"text-orange-300\" />\n                ) : (\n                  <Minus size={12} className=\"text-blue-300\" />\n                )}\n                <span className=\"text-xs text-white/60\">Calories</span>\n              </div>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PRODUCT BUNDLE CTA\n// ============================================\n\ninterface ProductBundleCardProps {\n  products: ProductRecommendation[];\n  title?: string;\n}\n\nfunction ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n  // Get top 3 most important products\n  const bundleProducts = products.slice(0, 3);\n\n  // Calculate total cost\n  const totalCost = bundleProducts.reduce((sum, rec) => {\n    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n    return sum + (supplement?.costPerMonth.min || 0);\n  }, 0);\n\n  if (bundleProducts.length === 0) return null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Package size={20} className=\"text-purple-400\" />\n        <h3 className=\"font-semibold text-white\">{title}</h3>\n        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n          Save 15%\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-300 mb-4\">\n        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n      </p>\n\n      {/* Bundle Items */}\n      <div className=\"space-y-2 mb-4\">\n        {bundleProducts.map((rec, index) => (\n          <div\n            key={rec.product.id}\n            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n          >\n            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n            </div>\n            <div className=\"text-right flex-shrink-0\">\n              <p className=\"text-sm text-white\">\n                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n              </p>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Total & CTA */}\n      <div className=\"border-t border-purple-500/20 pt-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-neutral-400\">Bundle Total</span>\n          <div className=\"text-right\">\n            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n          </div>\n        </div>\n        <button\n          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n        >\n          <ShoppingCart size={18} />\n          Get Your Bundle\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  // Treatment conflict state\n  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());\n  const [conflictModal, setConflictModal] = useState<{\n    isOpen: boolean;\n    conflict: TreatmentConflict | null;\n    newTreatmentId: string;\n  }>({ isOpen: false, conflict: null, newTreatmentId: '' });\n\n  const { openPricingModal } = usePricing();\n\n  // Convert to number for arithmetic operations\n  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Check if user has a paid plan\n  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n\n  // Get body fat from physique analysis\n  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n\n  // Generate Daily Stack for all users\n  const dailyStack = useMemo(() => {\n    return generateDailyStack(gender);\n  }, [gender]);\n\n  // Generate Product Recommendations based on metrics\n  const productRecommendations = useMemo(() => {\n    // Build metrics and severity dictionaries from ratios\n    const metricsDict: Record<string, number> = {};\n    const severityDict: Record<string, string> = {};\n\n    [...frontRatios, ...sideRatios].forEach(ratio => {\n      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n      severityDict[ratio.name] = ratio.severity;\n    });\n\n    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n  }, [frontRatios, sideRatios, gender, ethnicity]);\n\n  // Split product recommendations by state\n  const { flawProducts, idealProducts } = useMemo(() => {\n    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n    return { flawProducts: flaw, idealProducts: ideal };\n  }, [productRecommendations]);\n\n  // Map flaws to products and treatments\n  const flawsWithProducts = useMemo(() => {\n    return flaws.slice(0, 5).map(flaw => {\n      // Find products that target metrics related to this flaw\n      const relatedProducts = productRecommendations.filter(rec =>\n        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n          rec.matchedMetrics.some(metric =>\n            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n          )\n        )\n      );\n\n      // Find treatments that match this flaw\n      const relatedTreatments = recommendations.filter(rec =>\n        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n      );\n\n      return {\n        flaw,\n        products: relatedProducts.slice(0, 2),\n        treatments: relatedTreatments.slice(0, 3),\n      };\n    });\n  }, [flaws, productRecommendations, recommendations]);\n\n  // Handle progress photo upload\n  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n    // Store current analysis as previous before re-analyzing\n    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n    setPreviousAnalysis({\n      date: new Date().toISOString(),\n      overallScore: numScore,\n      bodyFatPercent,\n      frontPhotoUrl: frontPhoto || undefined,\n    });\n\n    // In a real implementation, this would upload to API and trigger re-analysis\n    console.log('Progress photo uploaded:', file.name);\n  }, [overallScore, bodyFatPercent, frontPhoto]);\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Your Phase Card - Body Composition Phase */}\n          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n\n          {/* Daily Stack Card - Hero Element for ALL users */}\n          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Fix Your Weak Points Section */}\n          {flawsWithProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Upgrade CTA or Premium Badge */}\n          {hasPaidPlan ? (\n            <motion.div\n              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n    </TabContent>\n  );\n}\n","structuredPatch":[{"oldStart":610,"oldLines":6,"newStart":610,"newLines":48,"lines":[" ","   const hasRecommendations = filteredRecommendations.length > 0;"," ","+  // Detect treatment conflicts in current recommendations","+  const treatmentConflicts = useMemo(() => {","+    const selectedIds = filteredRecommendations.map(r => r.ref_id);","+    const nameMap = Object.fromEntries(","+      filteredRecommendations.map(r => [r.ref_id, r.title])","+    );","+    const conflicts = findTreatmentConflicts(selectedIds, nameMap);","+","+    // Filter out dismissed conflicts","+    return conflicts.filter(c => {","+      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;","+      return !dismissedConflicts.has(conflictKey);","+    });","+  }, [filteredRecommendations, dismissedConflicts]);","+","+  // Handle dismissing a conflict","+  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {","+    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;","+    setDismissedConflicts(prev => new Set([...prev, conflictKey]));","+  }, []);","+","+  // Handle dismissing all conflicts","+  const handleDismissAllConflicts = useCallback(() => {","+    const allKeys = treatmentConflicts.map(","+      c => `${c.treatment1Id}-${c.treatment2Id}`","+    );","+    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));","+  }, [treatmentConflicts]);","+","+  // Handle conflict modal actions","+  const handleConflictProceed = useCallback(() => {","+    if (conflictModal.conflict) {","+      // Remove the lower priority (existing) treatment","+      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));","+    }","+    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });","+  }, [conflictModal.conflict]);","+","+  const handleConflictCancel = useCallback(() => {","+    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });","+  }, []);","+","   // Handle mark complete","   const handleMarkComplete = useCallback((id: string) => {","     setCompletedIds(prev => {"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"66bdf329-ed77-4c90-bc2b-0df3af53c96e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PECTorENergBRgfTubKdgx","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me add the conflict warning UI in the PlanTab's render section. Let me find the right place to add it:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2035,"cache_read_input_tokens":113548,"cache_creation":{"ephemeral_5m_input_tokens":2035,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWVVNyMu6LdAPjvwbfjn6","type":"assistant","uuid":"0d5b55ed-a9c6-4e07-a251-50711640e04f","timestamp":"2025-12-26T14:54:07.098Z"}
{"parentUuid":"0d5b55ed-a9c6-4e07-a251-50711640e04f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PECTorENergBRgfTubKdgx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DGzFvaWYtuEa193tAvY4PF","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","offset":700,"limit":150}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2035,"cache_read_input_tokens":113548,"cache_creation":{"ephemeral_5m_input_tokens":2035,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWVVNyMu6LdAPjvwbfjn6","type":"assistant","uuid":"2543c6ec-74d4-4972-9c45-e0689adb3b3f","timestamp":"2025-12-26T14:54:08.944Z"}
{"parentUuid":"2543c6ec-74d4-4972-9c45-e0689adb3b3f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DGzFvaWYtuEa193tAvY4PF","type":"tool_result","content":"   700→              <div className=\"flex items-center gap-2\">\n   701→                <AlertCircle size={20} className=\"text-red-400\" />\n   702→                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n   703→                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n   704→                  {flawsWithProducts.length} Issues\n   705→                </span>\n   706→              </div>\n   707→              <div className=\"space-y-3\">\n   708→                {flawsWithProducts.map((item, index) => (\n   709→                  <WeakPointCard\n   710→                    key={item.flaw.id}\n   711→                    flaw={item.flaw}\n   712→                    rank={index + 1}\n   713→                    products={item.products}\n   714→                    treatments={item.treatments}\n   715→                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n   716→                  />\n   717→                ))}\n   718→              </div>\n   719→            </div>\n   720→          )}\n   721→\n   722→          {/* Targeted Product Recommendations - Corrective */}\n   723→          {flawProducts.length > 0 && (\n   724→            <div className=\"space-y-4\">\n   725→              <div className=\"flex items-center gap-2\">\n   726→                <Package size={20} className=\"text-cyan-400\" />\n   727→                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n   728→                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n   729→                  Corrective\n   730→                </span>\n   731→              </div>\n   732→              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n   733→                {flawProducts.slice(0, 6).map((rec, index) => (\n   734→                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n   735→                ))}\n   736→              </div>\n   737→            </div>\n   738→          )}\n   739→\n   740→          {/* Targeted Product Recommendations - Maintenance */}\n   741→          {idealProducts.length > 0 && (\n   742→            <div className=\"space-y-4\">\n   743→              <div className=\"flex items-center gap-2\">\n   744→                <CheckCircle2 size={20} className=\"text-green-400\" />\n   745→                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n   746→                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n   747→                  Maintenance\n   748→                </span>\n   749→              </div>\n   750→              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n   751→                {idealProducts.slice(0, 4).map((rec) => (\n   752→                  <ProductCard key={rec.product.id} recommendation={rec} />\n   753→                ))}\n   754→              </div>\n   755→            </div>\n   756→          )}\n   757→\n   758→          {/* Treatment Timeline */}\n   759→          {recommendations.length > 0 && (\n   760→            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n   761→          )}\n   762→\n   763→          {/* Phase Filter */}\n   764→          <PhaseFilter\n   765→            selectedPhase={selectedPhase}\n   766→            onSelect={setSelectedPhase}\n   767→            counts={phaseCounts}\n   768→          />\n   769→\n   770→          {/* Recommendations List */}\n   771→          {hasRecommendations ? (\n   772→            <motion.div className=\"space-y-4\" layout>\n   773→              <AnimatePresence mode=\"popLayout\">\n   774→                {filteredRecommendations.map((rec, index) => (\n   775→                  <motion.div\n   776→                    key={rec.ref_id}\n   777→                    layout\n   778→                    initial={{ opacity: 0, y: 20 }}\n   779→                    animate={{ opacity: 1, y: 0 }}\n   780→                    exit={{ opacity: 0, y: -20 }}\n   781→                    transition={{ duration: 0.2, delay: index * 0.05 }}\n   782→                  >\n   783→                    <EnhancedRecommendationCard\n   784→                      recommendation={rec}\n   785→                      rank={index + 1}\n   786→                      isExpanded={expandedId === rec.ref_id}\n   787→                      onToggle={() => setExpandedId(\n   788→                        expandedId === rec.ref_id ? null : rec.ref_id\n   789→                      )}\n   790→                      onMarkComplete={handleMarkComplete}\n   791→                      onRemove={handleRemove}\n   792→                      isCompleted={completedIds.has(rec.ref_id)}\n   793→                      gender={gender}\n   794→                      ethnicity={ethnicity}\n   795→                    />\n   796→                  </motion.div>\n   797→                ))}\n   798→              </AnimatePresence>\n   799→            </motion.div>\n   800→          ) : (\n   801→            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n   802→              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n   803→              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n   804→              <p className=\"text-neutral-500 mb-4\">\n   805→                Complete a facial analysis to get personalized recommendations\n   806→              </p>\n   807→            </div>\n   808→          )}\n   809→        </div>\n   810→\n   811→        {/* Sidebar */}\n   812→        <div className=\"space-y-6\">\n   813→          {/* Medical Prescription Card (Dental) */}\n   814→          {vision?.teeth && (\n   815→            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n   816→          )}\n   817→\n   818→          {/* Progress Comparison Card */}\n   819→          <ProgressComparisonCard\n   820→            currentAnalysis={{\n   821→              date: new Date().toISOString(),\n   822→              overallScore: numericOverallScore,\n   823→              bodyFatPercent,\n   824→              frontPhotoUrl: frontPhoto || undefined,\n   825→            }}\n   826→            previousAnalysis={previousAnalysis}\n   827→            onUploadNewPhoto={handleProgressPhotoUpload}\n   828→          />\n   829→\n   830→          {/* Product Bundle CTA */}\n   831→          {flawProducts.length >= 3 && (\n   832→            <ProductBundleCard\n   833→              products={flawProducts}\n   834→              title=\"Your Fix Bundle\"\n   835→            />\n   836→          )}\n   837→\n   838→          {/* Before/After Preview */}\n   839→          <BeforeAfterPreviewSection />\n   840→\n   841→          {/* Order of Operations */}\n   842→          <OrderOfOperations />\n   843→\n   844→          {/* My Plan Summary */}\n   845→          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n   846→            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n   847→              <Zap size={16} className=\"text-yellow-400\" />\n   848→              My Plan\n   849→            </h4>\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"716e37e0-3b43-4f95-af28-7d4dde8e9500","timestamp":"2025-12-26T14:54:09.101Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","content":"              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>","numLines":150,"startLine":700,"totalLines":931}}}
{"parentUuid":"716e37e0-3b43-4f95-af28-7d4dde8e9500","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WeNUi7jn1M89hovBWzMgwj","type":"message","role":"assistant","content":[{"type":"text","text":"I'll add the Treatment Conflict Warning section before the Phase Filter, and also add the SelectionWarningModal at the end. Let me edit:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2381,"cache_read_input_tokens":115583,"cache_creation":{"ephemeral_5m_input_tokens":2381,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVPNQENRpwpWdAYjaPH","type":"assistant","uuid":"e365ccfb-a29d-4d89-b142-deb1a61ef580","timestamp":"2025-12-26T14:54:13.132Z"}
{"parentUuid":"e365ccfb-a29d-4d89-b142-deb1a61ef580","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WeNUi7jn1M89hovBWzMgwj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017MokdE9A6n7eMtAKzaWmhC","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","old_string":"{/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />","new_string":"{/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Treatment Conflict Warnings */}\n          {treatmentConflicts.length > 0 && (\n            <TreatmentConflictList\n              conflicts={treatmentConflicts}\n              onDismiss={handleDismissConflict}\n              onDismissAll={handleDismissAllConflicts}\n            />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2381,"cache_read_input_tokens":115583,"cache_creation":{"ephemeral_5m_input_tokens":2381,"ephemeral_1h_input_tokens":0},"output_tokens":435,"service_tier":"standard"}},"requestId":"req_011CWVVPNQENRpwpWdAYjaPH","type":"assistant","uuid":"42f7cc65-e73d-4106-acfa-b73ec0115c7d","timestamp":"2025-12-26T14:54:19.341Z"}
{"parentUuid":"42f7cc65-e73d-4106-acfa-b73ec0115c7d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017MokdE9A6n7eMtAKzaWmhC","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   754→              </div>\n   755→            </div>\n   756→          )}\n   757→\n   758→          {/* Treatment Timeline */}\n   759→          {recommendations.length > 0 && (\n   760→            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n   761→          )}\n   762→\n   763→          {/* Treatment Conflict Warnings */}\n   764→          {treatmentConflicts.length > 0 && (\n   765→            <TreatmentConflictList\n   766→              conflicts={treatmentConflicts}\n   767→              onDismiss={handleDismissConflict}\n   768→              onDismissAll={handleDismissAllConflicts}\n   769→            />\n   770→          )}\n   771→\n   772→          {/* Phase Filter */}\n   773→          <PhaseFilter\n   774→            selectedPhase={selectedPhase}\n   775→            onSelect={setSelectedPhase}\n   776→            counts={phaseCounts}\n   777→          />\n   778→\n   779→          {/* Recommendations List */}\n   780→          {hasRecommendations ? (\n   781→            <motion.div className=\"space-y-4\" layout>"}]},"uuid":"50a9e06c-129e-47e7-831d-1a93b47f9d25","timestamp":"2025-12-26T14:54:19.394Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","oldString":"{/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />","newString":"{/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Treatment Conflict Warnings */}\n          {treatmentConflicts.length > 0 && (\n            <TreatmentConflictList\n              conflicts={treatmentConflicts}\n              onDismiss={handleDismissConflict}\n              onDismissAll={handleDismissAllConflicts}\n            />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />","originalFile":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n  CheckCircle,\n  AlertCircle,\n  CheckCircle2,\n  Scale,\n  Dumbbell,\n  Salad,\n  ArrowDown,\n  ArrowUp,\n  Minus,\n  Package,\n  ShoppingCart,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { usePricing } from '@/contexts/PricingContext';\nimport { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\nimport { FaceMorphing } from '../visualization/FaceMorphing';\nimport { TreatmentTimeline } from '../visualization/TreatmentTimeline';\nimport { RecommendationPhase, ProductRecommendation } from '@/types/results';\nimport { DailyStackCard } from '../cards/DailyStackCard';\nimport { ProductCard } from '../cards/ProductCard';\nimport { WeakPointCard } from '../cards/WeakPointCard';\nimport { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\nimport { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\nimport { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\nimport {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n          ? 'bg-cyan-500 text-black'\n          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n            ? 'bg-neutral-700 text-white'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n            }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n// ============================================\n\ntype PreviewMode = 'static' | 'morphing';\n\nfunction BeforeAfterPreviewSection() {\n  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  if (!frontPhoto) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n        <button\n          onClick={() => setPreviewMode('morphing')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'morphing'\n              ? 'bg-cyan-500/20 text-cyan-400'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Face Morphing\n        </button>\n        <button\n          onClick={() => setPreviewMode('static')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'static'\n              ? 'bg-neutral-700 text-white'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Static Preview\n        </button>\n      </div>\n\n      {/* Preview Component */}\n      <AnimatePresence mode=\"wait\">\n        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n          <motion.div\n            key=\"morphing\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: 20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <FaceMorphing\n              photo={frontPhoto}\n              frontLandmarks={frontLandmarks}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"static\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: -20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <BeforeAfterPreview\n              photo={frontPhoto}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// YOUR PHASE CARD (Body Composition Phase)\n// ============================================\n\ntype BodyPhase = 'bulk' | 'cut' | 'maintain';\n\ninterface YourPhaseCardProps {\n  bodyFatPercent?: number;\n  gender: 'male' | 'female';\n}\n\nfunction YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n  // Determine phase based on body fat and gender\n  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n    if (!bodyFatPercent) {\n      return {\n        phase: 'maintain',\n        message: 'Complete your physique analysis to get personalized phase recommendations.',\n        color: 'from-neutral-700 to-neutral-800',\n        icon: <Scale size={24} className=\"text-neutral-400\" />,\n      };\n    }\n\n    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n    const bulkThreshold = gender === 'male' ? 12 : 18;\n    const cutThreshold = gender === 'male' ? 18 : 25;\n\n    if (bodyFatPercent < bulkThreshold) {\n      return {\n        phase: 'bulk',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n        color: 'from-green-600 to-emerald-700',\n        icon: <Dumbbell size={24} className=\"text-white\" />,\n      };\n    } else if (bodyFatPercent > cutThreshold) {\n      return {\n        phase: 'cut',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n        color: 'from-orange-600 to-red-700',\n        icon: <Salad size={24} className=\"text-white\" />,\n      };\n    } else {\n      return {\n        phase: 'maintain',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n        color: 'from-blue-600 to-cyan-700',\n        icon: <Scale size={24} className=\"text-white\" />,\n      };\n    }\n  };\n\n  const { phase, message, color, icon } = getPhase();\n  const phaseLabels: Record<BodyPhase, string> = {\n    bulk: 'Lean Bulk Phase',\n    cut: 'Cutting Phase',\n    maintain: 'Maintenance Phase',\n  };\n\n  return (\n    <motion.div\n      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-start gap-4\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n          {icon}\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n              {phaseLabels[phase]}\n            </div>\n          </div>\n          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n\n          {/* Phase-specific tips */}\n          <div className=\"grid grid-cols-3 gap-2\">\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n                {phase === 'bulk' ? (\n                  <ArrowUp size={12} className=\"text-green-300\" />\n                ) : phase === 'cut' ? (\n                  <ArrowDown size={12} className=\"text-orange-300\" />\n                ) : (\n                  <Minus size={12} className=\"text-blue-300\" />\n                )}\n                <span className=\"text-xs text-white/60\">Calories</span>\n              </div>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PRODUCT BUNDLE CTA\n// ============================================\n\ninterface ProductBundleCardProps {\n  products: ProductRecommendation[];\n  title?: string;\n}\n\nfunction ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n  // Get top 3 most important products\n  const bundleProducts = products.slice(0, 3);\n\n  // Calculate total cost\n  const totalCost = bundleProducts.reduce((sum, rec) => {\n    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n    return sum + (supplement?.costPerMonth.min || 0);\n  }, 0);\n\n  if (bundleProducts.length === 0) return null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Package size={20} className=\"text-purple-400\" />\n        <h3 className=\"font-semibold text-white\">{title}</h3>\n        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n          Save 15%\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-300 mb-4\">\n        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n      </p>\n\n      {/* Bundle Items */}\n      <div className=\"space-y-2 mb-4\">\n        {bundleProducts.map((rec, index) => (\n          <div\n            key={rec.product.id}\n            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n          >\n            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n            </div>\n            <div className=\"text-right flex-shrink-0\">\n              <p className=\"text-sm text-white\">\n                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n              </p>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Total & CTA */}\n      <div className=\"border-t border-purple-500/20 pt-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-neutral-400\">Bundle Total</span>\n          <div className=\"text-right\">\n            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n          </div>\n        </div>\n        <button\n          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n        >\n          <ShoppingCart size={18} />\n          Get Your Bundle\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  // Treatment conflict state\n  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());\n  const [conflictModal, setConflictModal] = useState<{\n    isOpen: boolean;\n    conflict: TreatmentConflict | null;\n    newTreatmentId: string;\n  }>({ isOpen: false, conflict: null, newTreatmentId: '' });\n\n  const { openPricingModal } = usePricing();\n\n  // Convert to number for arithmetic operations\n  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Check if user has a paid plan\n  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n\n  // Get body fat from physique analysis\n  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n\n  // Generate Daily Stack for all users\n  const dailyStack = useMemo(() => {\n    return generateDailyStack(gender);\n  }, [gender]);\n\n  // Generate Product Recommendations based on metrics\n  const productRecommendations = useMemo(() => {\n    // Build metrics and severity dictionaries from ratios\n    const metricsDict: Record<string, number> = {};\n    const severityDict: Record<string, string> = {};\n\n    [...frontRatios, ...sideRatios].forEach(ratio => {\n      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n      severityDict[ratio.name] = ratio.severity;\n    });\n\n    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n  }, [frontRatios, sideRatios, gender, ethnicity]);\n\n  // Split product recommendations by state\n  const { flawProducts, idealProducts } = useMemo(() => {\n    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n    return { flawProducts: flaw, idealProducts: ideal };\n  }, [productRecommendations]);\n\n  // Map flaws to products and treatments\n  const flawsWithProducts = useMemo(() => {\n    return flaws.slice(0, 5).map(flaw => {\n      // Find products that target metrics related to this flaw\n      const relatedProducts = productRecommendations.filter(rec =>\n        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n          rec.matchedMetrics.some(metric =>\n            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n          )\n        )\n      );\n\n      // Find treatments that match this flaw\n      const relatedTreatments = recommendations.filter(rec =>\n        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n      );\n\n      return {\n        flaw,\n        products: relatedProducts.slice(0, 2),\n        treatments: relatedTreatments.slice(0, 3),\n      };\n    });\n  }, [flaws, productRecommendations, recommendations]);\n\n  // Handle progress photo upload\n  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n    // Store current analysis as previous before re-analyzing\n    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n    setPreviousAnalysis({\n      date: new Date().toISOString(),\n      overallScore: numScore,\n      bodyFatPercent,\n      frontPhotoUrl: frontPhoto || undefined,\n    });\n\n    // In a real implementation, this would upload to API and trigger re-analysis\n    console.log('Progress photo uploaded:', file.name);\n  }, [overallScore, bodyFatPercent, frontPhoto]);\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.title])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);\n\n  // Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set([...prev, conflictKey]));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);\n\n  const handleConflictCancel = useCallback(() => {\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, []);\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Your Phase Card - Body Composition Phase */}\n          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n\n          {/* Daily Stack Card - Hero Element for ALL users */}\n          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Fix Your Weak Points Section */}\n          {flawsWithProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Upgrade CTA or Premium Badge */}\n          {hasPaidPlan ? (\n            <motion.div\n              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n    </TabContent>\n  );\n}\n","structuredPatch":[{"oldStart":760,"oldLines":6,"newStart":760,"newLines":15,"lines":["             <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />","           )}"," ","+          {/* Treatment Conflict Warnings */}","+          {treatmentConflicts.length > 0 && (","+            <TreatmentConflictList","+              conflicts={treatmentConflicts}","+              onDismiss={handleDismissConflict}","+              onDismissAll={handleDismissAllConflicts}","+            />","+          )}","+","           {/* Phase Filter */}","           <PhaseFilter","             selectedPhase={selectedPhase}"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"50a9e06c-129e-47e7-831d-1a93b47f9d25","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BnvjNDufrAyFBgJFt9PxTx","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me add the SelectionWarningModal at the end of the component (before the closing TabContent):"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1031,"cache_read_input_tokens":117964,"cache_creation":{"ephemeral_5m_input_tokens":1031,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWVVQ8MAjivNv8BtGUHHt","type":"assistant","uuid":"b2686bbd-61bb-4acb-9721-7b1cbfaf5faf","timestamp":"2025-12-26T14:54:22.888Z"}
{"parentUuid":"b2686bbd-61bb-4acb-9721-7b1cbfaf5faf","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BnvjNDufrAyFBgJFt9PxTx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QHFWLFfMr6cGafTD4PbCPJ","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","offset":900}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1031,"cache_read_input_tokens":117964,"cache_creation":{"ephemeral_5m_input_tokens":1031,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWVVQ8MAjivNv8BtGUHHt","type":"assistant","uuid":"c2d427d5-55c4-43bc-a97e-091b1d183b8d","timestamp":"2025-12-26T14:54:23.845Z"}
{"parentUuid":"c2d427d5-55c4-43bc-a97e-091b1d183b8d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QHFWLFfMr6cGafTD4PbCPJ","type":"tool_result","content":"   900→              animate={{ opacity: 1, y: 0 }}\n   901→              transition={{ delay: 0.3 }}\n   902→            >\n   903→              <div className=\"flex items-center gap-2 mb-2\">\n   904→                <CheckCircle size={16} className=\"text-green-400\" />\n   905→                <span className=\"text-sm font-medium text-white\">\n   906→                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n   907→                </span>\n   908→              </div>\n   909→              <p className=\"text-xs text-neutral-400\">\n   910→                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n   911→              </p>\n   912→            </motion.div>\n   913→          ) : (\n   914→            <motion.div\n   915→              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n   916→              initial={{ opacity: 0, y: 20 }}\n   917→              animate={{ opacity: 1, y: 0 }}\n   918→              transition={{ delay: 0.3 }}\n   919→            >\n   920→              <div className=\"flex items-center gap-2 mb-2\">\n   921→                <Sparkles size={16} className=\"text-cyan-400\" />\n   922→                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n   923→              </div>\n   924→              <p className=\"text-xs text-neutral-400 mb-3\">\n   925→                Get detailed treatment guides, cost estimates, and provider recommendations.\n   926→              </p>\n   927→              <button\n   928→                onClick={() => openPricingModal('plan_sidebar')}\n   929→                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n   930→              >\n   931→                Upgrade Now\n   932→              </button>\n   933→            </motion.div>\n   934→          )}\n   935→        </div>\n   936→      </div>\n   937→    </TabContent>\n   938→  );\n   939→}\n   940→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"c65b4a16-63f1-43ac-86f4-b26b572af9a7","timestamp":"2025-12-26T14:54:23.914Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","content":"              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n    </TabContent>\n  );\n}\n","numLines":41,"startLine":900,"totalLines":940}}}
{"parentUuid":"c65b4a16-63f1-43ac-86f4-b26b572af9a7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Rc3X3873pJ9Vr6wxgL3uhx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CbvtNCbzXJvfssCK2EPUX3","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","old_string":")}\n        </div>\n      </div>\n    </TabContent>\n  );\n}","new_string":")}\n        </div>\n      </div>\n\n      {/* Treatment Conflict Modal */}\n      <SelectionWarningModal\n        isOpen={conflictModal.isOpen}\n        onClose={handleConflictCancel}\n        conflict={conflictModal.conflict || {\n          treatment1Id: '',\n          treatment1Name: '',\n          treatment2Id: '',\n          treatment2Name: '',\n          reason: '',\n        }}\n        onProceed={handleConflictProceed}\n        onCancel={handleConflictCancel}\n      />\n    </TabContent>\n  );\n}"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":829,"cache_read_input_tokens":118995,"cache_creation":{"ephemeral_5m_input_tokens":829,"ephemeral_1h_input_tokens":0},"output_tokens":283,"service_tier":"standard"}},"requestId":"req_011CWVVQTh1RdF3uLS6wPruT","type":"assistant","uuid":"48150dbf-ab0f-4db1-97fb-d07291609742","timestamp":"2025-12-26T14:54:30.010Z"}
{"parentUuid":"48150dbf-ab0f-4db1-97fb-d07291609742","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CbvtNCbzXJvfssCK2EPUX3","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   930→              >\n   931→                Upgrade Now\n   932→              </button>\n   933→            </motion.div>\n   934→          )}\n   935→        </div>\n   936→      </div>\n   937→\n   938→      {/* Treatment Conflict Modal */}\n   939→      <SelectionWarningModal\n   940→        isOpen={conflictModal.isOpen}\n   941→        onClose={handleConflictCancel}\n   942→        conflict={conflictModal.conflict || {\n   943→          treatment1Id: '',\n   944→          treatment1Name: '',\n   945→          treatment2Id: '',\n   946→          treatment2Name: '',\n   947→          reason: '',\n   948→        }}\n   949→        onProceed={handleConflictProceed}\n   950→        onCancel={handleConflictCancel}\n   951→      />\n   952→    </TabContent>\n   953→  );\n   954→}\n   955→"}]},"uuid":"94529126-e419-4bee-bf0e-4f3d76287e25","timestamp":"2025-12-26T14:54:30.067Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","oldString":")}\n        </div>\n      </div>\n    </TabContent>\n  );\n}","newString":")}\n        </div>\n      </div>\n\n      {/* Treatment Conflict Modal */}\n      <SelectionWarningModal\n        isOpen={conflictModal.isOpen}\n        onClose={handleConflictCancel}\n        conflict={conflictModal.conflict || {\n          treatment1Id: '',\n          treatment1Name: '',\n          treatment2Id: '',\n          treatment2Name: '',\n          reason: '',\n        }}\n        onProceed={handleConflictProceed}\n        onCancel={handleConflictCancel}\n      />\n    </TabContent>\n  );\n}","originalFile":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n  CheckCircle,\n  AlertCircle,\n  CheckCircle2,\n  Scale,\n  Dumbbell,\n  Salad,\n  ArrowDown,\n  ArrowUp,\n  Minus,\n  Package,\n  ShoppingCart,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { usePricing } from '@/contexts/PricingContext';\nimport { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\nimport { FaceMorphing } from '../visualization/FaceMorphing';\nimport { TreatmentTimeline } from '../visualization/TreatmentTimeline';\nimport { RecommendationPhase, ProductRecommendation } from '@/types/results';\nimport { DailyStackCard } from '../cards/DailyStackCard';\nimport { ProductCard } from '../cards/ProductCard';\nimport { WeakPointCard } from '../cards/WeakPointCard';\nimport { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\nimport { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\nimport { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\nimport {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n          ? 'bg-cyan-500 text-black'\n          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n            ? 'bg-neutral-700 text-white'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n            }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n// ============================================\n\ntype PreviewMode = 'static' | 'morphing';\n\nfunction BeforeAfterPreviewSection() {\n  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  if (!frontPhoto) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n        <button\n          onClick={() => setPreviewMode('morphing')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'morphing'\n              ? 'bg-cyan-500/20 text-cyan-400'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Face Morphing\n        </button>\n        <button\n          onClick={() => setPreviewMode('static')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'static'\n              ? 'bg-neutral-700 text-white'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Static Preview\n        </button>\n      </div>\n\n      {/* Preview Component */}\n      <AnimatePresence mode=\"wait\">\n        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n          <motion.div\n            key=\"morphing\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: 20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <FaceMorphing\n              photo={frontPhoto}\n              frontLandmarks={frontLandmarks}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"static\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: -20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <BeforeAfterPreview\n              photo={frontPhoto}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// YOUR PHASE CARD (Body Composition Phase)\n// ============================================\n\ntype BodyPhase = 'bulk' | 'cut' | 'maintain';\n\ninterface YourPhaseCardProps {\n  bodyFatPercent?: number;\n  gender: 'male' | 'female';\n}\n\nfunction YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n  // Determine phase based on body fat and gender\n  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n    if (!bodyFatPercent) {\n      return {\n        phase: 'maintain',\n        message: 'Complete your physique analysis to get personalized phase recommendations.',\n        color: 'from-neutral-700 to-neutral-800',\n        icon: <Scale size={24} className=\"text-neutral-400\" />,\n      };\n    }\n\n    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n    const bulkThreshold = gender === 'male' ? 12 : 18;\n    const cutThreshold = gender === 'male' ? 18 : 25;\n\n    if (bodyFatPercent < bulkThreshold) {\n      return {\n        phase: 'bulk',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n        color: 'from-green-600 to-emerald-700',\n        icon: <Dumbbell size={24} className=\"text-white\" />,\n      };\n    } else if (bodyFatPercent > cutThreshold) {\n      return {\n        phase: 'cut',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n        color: 'from-orange-600 to-red-700',\n        icon: <Salad size={24} className=\"text-white\" />,\n      };\n    } else {\n      return {\n        phase: 'maintain',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n        color: 'from-blue-600 to-cyan-700',\n        icon: <Scale size={24} className=\"text-white\" />,\n      };\n    }\n  };\n\n  const { phase, message, color, icon } = getPhase();\n  const phaseLabels: Record<BodyPhase, string> = {\n    bulk: 'Lean Bulk Phase',\n    cut: 'Cutting Phase',\n    maintain: 'Maintenance Phase',\n  };\n\n  return (\n    <motion.div\n      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-start gap-4\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n          {icon}\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n              {phaseLabels[phase]}\n            </div>\n          </div>\n          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n\n          {/* Phase-specific tips */}\n          <div className=\"grid grid-cols-3 gap-2\">\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n                {phase === 'bulk' ? (\n                  <ArrowUp size={12} className=\"text-green-300\" />\n                ) : phase === 'cut' ? (\n                  <ArrowDown size={12} className=\"text-orange-300\" />\n                ) : (\n                  <Minus size={12} className=\"text-blue-300\" />\n                )}\n                <span className=\"text-xs text-white/60\">Calories</span>\n              </div>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PRODUCT BUNDLE CTA\n// ============================================\n\ninterface ProductBundleCardProps {\n  products: ProductRecommendation[];\n  title?: string;\n}\n\nfunction ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n  // Get top 3 most important products\n  const bundleProducts = products.slice(0, 3);\n\n  // Calculate total cost\n  const totalCost = bundleProducts.reduce((sum, rec) => {\n    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n    return sum + (supplement?.costPerMonth.min || 0);\n  }, 0);\n\n  if (bundleProducts.length === 0) return null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Package size={20} className=\"text-purple-400\" />\n        <h3 className=\"font-semibold text-white\">{title}</h3>\n        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n          Save 15%\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-300 mb-4\">\n        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n      </p>\n\n      {/* Bundle Items */}\n      <div className=\"space-y-2 mb-4\">\n        {bundleProducts.map((rec, index) => (\n          <div\n            key={rec.product.id}\n            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n          >\n            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n            </div>\n            <div className=\"text-right flex-shrink-0\">\n              <p className=\"text-sm text-white\">\n                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n              </p>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Total & CTA */}\n      <div className=\"border-t border-purple-500/20 pt-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-neutral-400\">Bundle Total</span>\n          <div className=\"text-right\">\n            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n          </div>\n        </div>\n        <button\n          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n        >\n          <ShoppingCart size={18} />\n          Get Your Bundle\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  // Treatment conflict state\n  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());\n  const [conflictModal, setConflictModal] = useState<{\n    isOpen: boolean;\n    conflict: TreatmentConflict | null;\n    newTreatmentId: string;\n  }>({ isOpen: false, conflict: null, newTreatmentId: '' });\n\n  const { openPricingModal } = usePricing();\n\n  // Convert to number for arithmetic operations\n  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Check if user has a paid plan\n  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n\n  // Get body fat from physique analysis\n  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n\n  // Generate Daily Stack for all users\n  const dailyStack = useMemo(() => {\n    return generateDailyStack(gender);\n  }, [gender]);\n\n  // Generate Product Recommendations based on metrics\n  const productRecommendations = useMemo(() => {\n    // Build metrics and severity dictionaries from ratios\n    const metricsDict: Record<string, number> = {};\n    const severityDict: Record<string, string> = {};\n\n    [...frontRatios, ...sideRatios].forEach(ratio => {\n      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n      severityDict[ratio.name] = ratio.severity;\n    });\n\n    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n  }, [frontRatios, sideRatios, gender, ethnicity]);\n\n  // Split product recommendations by state\n  const { flawProducts, idealProducts } = useMemo(() => {\n    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n    return { flawProducts: flaw, idealProducts: ideal };\n  }, [productRecommendations]);\n\n  // Map flaws to products and treatments\n  const flawsWithProducts = useMemo(() => {\n    return flaws.slice(0, 5).map(flaw => {\n      // Find products that target metrics related to this flaw\n      const relatedProducts = productRecommendations.filter(rec =>\n        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n          rec.matchedMetrics.some(metric =>\n            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n          )\n        )\n      );\n\n      // Find treatments that match this flaw\n      const relatedTreatments = recommendations.filter(rec =>\n        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n      );\n\n      return {\n        flaw,\n        products: relatedProducts.slice(0, 2),\n        treatments: relatedTreatments.slice(0, 3),\n      };\n    });\n  }, [flaws, productRecommendations, recommendations]);\n\n  // Handle progress photo upload\n  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n    // Store current analysis as previous before re-analyzing\n    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n    setPreviousAnalysis({\n      date: new Date().toISOString(),\n      overallScore: numScore,\n      bodyFatPercent,\n      frontPhotoUrl: frontPhoto || undefined,\n    });\n\n    // In a real implementation, this would upload to API and trigger re-analysis\n    console.log('Progress photo uploaded:', file.name);\n  }, [overallScore, bodyFatPercent, frontPhoto]);\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.title])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);\n\n  // Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set([...prev, conflictKey]));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);\n\n  const handleConflictCancel = useCallback(() => {\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, []);\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Your Phase Card - Body Composition Phase */}\n          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n\n          {/* Daily Stack Card - Hero Element for ALL users */}\n          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Fix Your Weak Points Section */}\n          {flawsWithProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Treatment Conflict Warnings */}\n          {treatmentConflicts.length > 0 && (\n            <TreatmentConflictList\n              conflicts={treatmentConflicts}\n              onDismiss={handleDismissConflict}\n              onDismissAll={handleDismissAllConflicts}\n            />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Upgrade CTA or Premium Badge */}\n          {hasPaidPlan ? (\n            <motion.div\n              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n    </TabContent>\n  );\n}\n","structuredPatch":[{"oldStart":934,"oldLines":6,"newStart":934,"newLines":21,"lines":["           )}","         </div>","       </div>","+","+      {/* Treatment Conflict Modal */}","+      <SelectionWarningModal","+        isOpen={conflictModal.isOpen}","+        onClose={handleConflictCancel}","+        conflict={conflictModal.conflict || {","+          treatment1Id: '',","+          treatment1Name: '',","+          treatment2Id: '',","+          treatment2Name: '',","+          reason: '',","+        }}","+        onProceed={handleConflictProceed}","+        onCancel={handleConflictCancel}","+      />","     </TabContent>","   );"," }"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"94529126-e419-4bee-bf0e-4f3d76287e25","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UjmModyinjJA29Eq6CiASf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014tNDTLpHjGrL3EpHS1UMTu","name":"TodoWrite","input":{"todos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"completed","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"completed","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"in_progress","activeForm":"Testing implementation"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":800,"cache_read_input_tokens":119824,"cache_creation":{"ephemeral_5m_input_tokens":800,"ephemeral_1h_input_tokens":0},"output_tokens":222,"service_tier":"standard"}},"requestId":"req_011CWVVQv6VqhV81RmicpKzQ","type":"assistant","uuid":"9b3f97cf-7744-423b-b4d5-31ccb5ee0332","timestamp":"2025-12-26T14:54:35.752Z"}
{"parentUuid":"9b3f97cf-7744-423b-b4d5-31ccb5ee0332","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014tNDTLpHjGrL3EpHS1UMTu","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"f35b7d11-6c5e-4b2b-a2b4-25e846baaecf","timestamp":"2025-12-26T14:54:35.809Z","toolUseResult":{"oldTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"completed","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"in_progress","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"pending","activeForm":"Testing implementation"}],"newTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"completed","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"completed","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"in_progress","activeForm":"Testing implementation"}]}}
{"parentUuid":"f35b7d11-6c5e-4b2b-a2b4-25e846baaecf","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WyEG99oQeXhbWz1zykqyb3","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me test the implementation by running the TypeScript checker and linter:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":120624,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWVVRLauDseeVTJLYkBiC","type":"assistant","uuid":"67dab3b9-7a90-47eb-87c6-65b9f8571d1c","timestamp":"2025-12-26T14:54:38.945Z"}
{"parentUuid":"67dab3b9-7a90-47eb-87c6-65b9f8571d1c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WyEG99oQeXhbWz1zykqyb3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01L2xz6xype7Vbt59Bg9Wpra","name":"Bash","input":{"command":"npx tsc --noEmit 2>&1 | head -100","description":"Run TypeScript type checking","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":120624,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWVVRLauDseeVTJLYkBiC","type":"assistant","uuid":"49b2a07e-4530-4645-bd41-51a06944af19","timestamp":"2025-12-26T14:54:40.353Z"}
{"parentUuid":"49b2a07e-4530-4645-bd41-51a06944af19","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01L2xz6xype7Vbt59Bg9Wpra","type":"tool_result","content":"src/components/results/tabs/PlanTab.tsx(617,53): error TS2339: Property 'title' does not exist on type 'Recommendation'.\nsrc/components/results/tabs/PlanTab.tsx(631,47): error TS2802: Type 'Set<string>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.\nsrc/components/results/tabs/PlanTab.tsx(639,47): error TS2802: Type 'Set<string>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.\nsrc/components/results/tabs/PlanTab.tsx(646,41): error TS2802: Type 'Set<string>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.\nsrc/components/results/tabs/ReferralsTab.tsx(21,13): error TS2339: Property 'resultsAnalysis' does not exist on type 'ResultsContextType'.\nsrc/lib/recommendations/engine.ts(826,30): error TS2802: Type 'Set<string>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.","is_error":false}]},"uuid":"3005042e-ce95-4fee-b100-74dad9de82fb","timestamp":"2025-12-26T14:54:42.294Z","toolUseResult":{"stdout":"src/components/results/tabs/PlanTab.tsx(617,53): error TS2339: Property 'title' does not exist on type 'Recommendation'.\nsrc/components/results/tabs/PlanTab.tsx(631,47): error TS2802: Type 'Set<string>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.\nsrc/components/results/tabs/PlanTab.tsx(639,47): error TS2802: Type 'Set<string>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.\nsrc/components/results/tabs/PlanTab.tsx(646,41): error TS2802: Type 'Set<string>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.\nsrc/components/results/tabs/ReferralsTab.tsx(21,13): error TS2339: Property 'resultsAnalysis' does not exist on type 'ResultsContextType'.\nsrc/lib/recommendations/engine.ts(826,30): error TS2802: Type 'Set<string>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"3005042e-ce95-4fee-b100-74dad9de82fb","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TAmcmCnRg235RPQeakk2vU","type":"message","role":"assistant","content":[{"type":"text","text":"I need to fix a few TypeScript errors. Let me address them:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":477,"cache_read_input_tokens":120888,"cache_creation":{"ephemeral_5m_input_tokens":477,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWVVRpG3WjPruwtmQ9YXk","type":"assistant","uuid":"a03754c9-4a2f-40c4-967f-8fc5bb850884","timestamp":"2025-12-26T14:54:45.238Z"}
{"parentUuid":"a03754c9-4a2f-40c4-967f-8fc5bb850884","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TAmcmCnRg235RPQeakk2vU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016ztooFeXXQUp5j1BBbXP6C","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","limit":100}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":477,"cache_read_input_tokens":120888,"cache_creation":{"ephemeral_5m_input_tokens":477,"ephemeral_1h_input_tokens":0},"output_tokens":112,"service_tier":"standard"}},"requestId":"req_011CWVVRpG3WjPruwtmQ9YXk","type":"assistant","uuid":"fc4ffe4e-6cfd-4264-af34-e6d64381a48c","timestamp":"2025-12-26T14:54:46.808Z"}
{"parentUuid":"fc4ffe4e-6cfd-4264-af34-e6d64381a48c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016ztooFeXXQUp5j1BBbXP6C","type":"tool_result","content":"     1→/**\n     2→ * Harmony-Style Results Page Types\n     3→ * Complete type definitions for the results UI\n     4→ */\n     5→\n     6→import { QualityTier, SeverityLevel, MeasurementUnit, ConfidenceLevel } from '@/lib/harmony-scoring';\n     7→\n     8→// ============================================\n     9→// ILLUSTRATION TYPES\n    10→// ============================================\n    11→\n    12→export interface IllustrationPoint {\n    13→  type: 'landmark' | 'calculated';\n    14→  landmarkId?: string;\n    15→  x?: number;\n    16→  y?: number;\n    17→  label?: string;\n    18→}\n    19→\n    20→export interface IllustrationLine {\n    21→  from: string;\n    22→  to: string;\n    23→  color: string;\n    24→  style?: 'solid' | 'dashed';\n    25→  label?: string;\n    26→  labelColor?: string;\n    27→  labelPosition?: 'start' | 'middle' | 'end';\n    28→}\n    29→\n    30→export interface RatioIllustration {\n    31→  points: Record<string, IllustrationPoint>;\n    32→  lines: Record<string, IllustrationLine>;\n    33→}\n    34→\n    35→// ============================================\n    36→// RATIO/MEASUREMENT TYPES\n    37→// ============================================\n    38→\n    39→export interface Ratio {\n    40→  id: string;\n    41→  name: string;\n    42→  value: number | string;\n    43→  score: number | string;  // 0-10 scale or Greek text\n    44→  standardizedScore: number | string;\n    45→  unit: 'x' | 'mm' | '%' | '°';\n    46→  idealMin: number;\n    47→  idealMax: number;\n    48→  rangeMin: number;\n    49→  rangeMax: number;\n    50→  description: string;\n    51→  category: string;\n    52→  qualityLevel: QualityTier;\n    53→  severity: SeverityLevel;\n    54→  illustration: RatioIllustration;\n    55→  mayIndicateFlaws: string[];\n    56→  mayIndicateStrengths: string[];\n    57→  usedLandmarks: string[];\n    58→  scoringCurveConfig?: {\n    59→    decayRate: number;\n    60→    maxScore: number;\n    61→  };\n    62→  // Harmony Taxonomy classification\n    63→  taxonomyPrimary?: string;    // 'harmony' | 'dimorphism' | 'angularity' | 'features'\n    64→  taxonomySecondary?: string;  // Subcategory ID\n    65→}\n    66→\n    67→// ============================================\n    68→// STRENGTH/FLAW TYPES\n    69→// ============================================\n    70→\n    71→export interface ResponsibleRatio {\n    72→  ratioName: string;\n    73→  ratioId: string;\n    74→  score: number | string;\n    75→  value: number | string;\n    76→  isObfuscated?: boolean;\n    77→  // Additional properties for AI descriptions\n    78→  idealMin: number;\n    79→  idealMax: number;\n    80→  unit: string;\n    81→  category?: string;\n    82→}\n    83→\n    84→export interface Strength {\n    85→  id: string;\n    86→  strengthName: string;\n    87→  summary: string;\n    88→  avgScore: number | string;\n    89→  qualityLevel: QualityTier;\n    90→  categoryName: string;\n    91→  responsibleRatios: ResponsibleRatio[];\n    92→}\n    93→\n    94→export interface Flaw {\n    95→  id: string;\n    96→  flawName: string;\n    97→  summary: string;\n    98→  harmonyPercentageLost: number;\n    99→  standardizedImpact: number;\n   100→  categoryName: string;\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"545a0508-ed98-4c73-987b-6b6d81c34c4d","timestamp":"2025-12-26T14:54:46.855Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","content":"/**\n * Harmony-Style Results Page Types\n * Complete type definitions for the results UI\n */\n\nimport { QualityTier, SeverityLevel, MeasurementUnit, ConfidenceLevel } from '@/lib/harmony-scoring';\n\n// ============================================\n// ILLUSTRATION TYPES\n// ============================================\n\nexport interface IllustrationPoint {\n  type: 'landmark' | 'calculated';\n  landmarkId?: string;\n  x?: number;\n  y?: number;\n  label?: string;\n}\n\nexport interface IllustrationLine {\n  from: string;\n  to: string;\n  color: string;\n  style?: 'solid' | 'dashed';\n  label?: string;\n  labelColor?: string;\n  labelPosition?: 'start' | 'middle' | 'end';\n}\n\nexport interface RatioIllustration {\n  points: Record<string, IllustrationPoint>;\n  lines: Record<string, IllustrationLine>;\n}\n\n// ============================================\n// RATIO/MEASUREMENT TYPES\n// ============================================\n\nexport interface Ratio {\n  id: string;\n  name: string;\n  value: number | string;\n  score: number | string;  // 0-10 scale or Greek text\n  standardizedScore: number | string;\n  unit: 'x' | 'mm' | '%' | '°';\n  idealMin: number;\n  idealMax: number;\n  rangeMin: number;\n  rangeMax: number;\n  description: string;\n  category: string;\n  qualityLevel: QualityTier;\n  severity: SeverityLevel;\n  illustration: RatioIllustration;\n  mayIndicateFlaws: string[];\n  mayIndicateStrengths: string[];\n  usedLandmarks: string[];\n  scoringCurveConfig?: {\n    decayRate: number;\n    maxScore: number;\n  };\n  // Harmony Taxonomy classification\n  taxonomyPrimary?: string;    // 'harmony' | 'dimorphism' | 'angularity' | 'features'\n  taxonomySecondary?: string;  // Subcategory ID\n}\n\n// ============================================\n// STRENGTH/FLAW TYPES\n// ============================================\n\nexport interface ResponsibleRatio {\n  ratioName: string;\n  ratioId: string;\n  score: number | string;\n  value: number | string;\n  isObfuscated?: boolean;\n  // Additional properties for AI descriptions\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category?: string;\n}\n\nexport interface Strength {\n  id: string;\n  strengthName: string;\n  summary: string;\n  avgScore: number | string;\n  qualityLevel: QualityTier;\n  categoryName: string;\n  responsibleRatios: ResponsibleRatio[];\n}\n\nexport interface Flaw {\n  id: string;\n  flawName: string;\n  summary: string;\n  harmonyPercentageLost: number;\n  standardizedImpact: number;\n  categoryName: string;","numLines":100,"startLine":1,"totalLines":395}}}
{"parentUuid":"545a0508-ed98-4c73-987b-6b6d81c34c4d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01F3XM9kwTCc76FUndNg14x4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EASSGJ4RjwjsepQM7bZxsS","name":"Grep","input":{"pattern":"interface Recommendation","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1274,"cache_read_input_tokens":121365,"cache_creation":{"ephemeral_5m_input_tokens":1274,"ephemeral_1h_input_tokens":0},"output_tokens":23,"service_tier":"standard"}},"requestId":"req_011CWVVS9k4aqZ2xPJjCE1o2","type":"assistant","uuid":"2ad73e66-c782-4926-a820-ed60e891aef8","timestamp":"2025-12-26T14:54:51.108Z"}
{"parentUuid":"2ad73e66-c782-4926-a820-ed60e891aef8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EASSGJ4RjwjsepQM7bZxsS","type":"tool_result","content":"121:export interface RecommendationTimeline {\n127:export interface RecommendationCost {\n141:export interface Recommendation {"}]},"uuid":"3e16abea-db58-4d41-aadb-1772daa7f54f","timestamp":"2025-12-26T14:54:51.617Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"121:export interface RecommendationTimeline {\n127:export interface RecommendationCost {\n141:export interface Recommendation {","numLines":3}}
{"parentUuid":"3e16abea-db58-4d41-aadb-1772daa7f54f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_0126XoiUsP7dyMMwe6v4trSa","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Mq4wEa3oPJsSA5TBhg6A9n","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","offset":140,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":159,"cache_read_input_tokens":122639,"cache_creation":{"ephemeral_5m_input_tokens":159,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWVVSWFbr8xNuuaSo2qd3","type":"assistant","uuid":"b6250cfe-0329-4a7e-9766-a051979c5d78","timestamp":"2025-12-26T14:54:55.074Z"}
{"parentUuid":"b6250cfe-0329-4a7e-9766-a051979c5d78","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Mq4wEa3oPJsSA5TBhg6A9n","type":"tool_result","content":"   140→\n   141→export interface Recommendation {\n   142→  ref_id: string;\n   143→  name: string;\n   144→  description: string;\n   145→  phase: RecommendationPhase;\n   146→  impact: number;  // 0-1 effectiveness score\n   147→  coverage: number;  // Number of metrics improved\n   148→  percentage: string;  // e.g., \"10-20%\"\n   149→  expectedImprovementRange?: { min: number; max: number };\n   150→  matchedFlaws: string[];\n   151→  matchedRatios: string[];\n   152→  ratios_impacted: RatioImpact[];\n   153→  timeline: RecommendationTimeline;\n   154→  cost: RecommendationCost;\n   155→  risks_side_effects: string | null;\n   156→  warnings: string[];\n   157→  gender: 'male' | 'female' | 'both';\n   158→}\n   159→\n   160→// ============================================\n   161→// HARMONY ANALYSIS TYPES\n   162→// ============================================\n   163→\n   164→export interface ProfileAnalysis {\n   165→  standardizedScore: number;\n   166→  ratios: Ratio[];\n   167→  overallAIDescription?: string | null;\n   168→}\n   169→\n   170→export interface FullHarmonyAnalysis {\n   171→  standardizedScore: number;\n   172→  front: ProfileAnalysis;\n   173→  side: ProfileAnalysis;\n   174→  strengths: Strength[];\n   175→  flaws: Flaw[];\n   176→}\n   177→\n   178→// ============================================\n   179→// FACE DATA TYPES\n   180→// ============================================\n   181→\n   182→export interface FaceData {\n   183→  id: string;\n   184→  userId?: string;\n   185→  frontPhotoUrl: string;\n   186→  sidePhotoUrl?: string;\n   187→  harmonyScore: number | null;\n   188→  frontHarmonyScore: number | null;\n   189→  sideHarmonyScore: number | null;\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"93a4a4cd-679c-4bec-aec1-42a55ac013e9","timestamp":"2025-12-26T14:54:55.219Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","content":"\nexport interface Recommendation {\n  ref_id: string;\n  name: string;\n  description: string;\n  phase: RecommendationPhase;\n  impact: number;  // 0-1 effectiveness score\n  coverage: number;  // Number of metrics improved\n  percentage: string;  // e.g., \"10-20%\"\n  expectedImprovementRange?: { min: number; max: number };\n  matchedFlaws: string[];\n  matchedRatios: string[];\n  ratios_impacted: RatioImpact[];\n  timeline: RecommendationTimeline;\n  cost: RecommendationCost;\n  risks_side_effects: string | null;\n  warnings: string[];\n  gender: 'male' | 'female' | 'both';\n}\n\n// ============================================\n// HARMONY ANALYSIS TYPES\n// ============================================\n\nexport interface ProfileAnalysis {\n  standardizedScore: number;\n  ratios: Ratio[];\n  overallAIDescription?: string | null;\n}\n\nexport interface FullHarmonyAnalysis {\n  standardizedScore: number;\n  front: ProfileAnalysis;\n  side: ProfileAnalysis;\n  strengths: Strength[];\n  flaws: Flaw[];\n}\n\n// ============================================\n// FACE DATA TYPES\n// ============================================\n\nexport interface FaceData {\n  id: string;\n  userId?: string;\n  frontPhotoUrl: string;\n  sidePhotoUrl?: string;\n  harmonyScore: number | null;\n  frontHarmonyScore: number | null;\n  sideHarmonyScore: number | null;","numLines":50,"startLine":140,"totalLines":395}}}
{"parentUuid":"93a4a4cd-679c-4bec-aec1-42a55ac013e9","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_019e7kFQeNsaQwrd6n19si2K","type":"message","role":"assistant","content":[{"type":"text","text":"I see the issue. The Recommendation interface has `name` not `title`. Let me also fix the Set iteration issues by using Array.from():"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":954,"cache_read_input_tokens":122798,"cache_creation":{"ephemeral_5m_input_tokens":954,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVSmYMcF6S5x1gWgJDQ","type":"assistant","uuid":"2bbe2662-afb5-4419-bddc-9ffec879f429","timestamp":"2025-12-26T14:54:59.236Z"}
{"parentUuid":"2bbe2662-afb5-4419-bddc-9ffec879f429","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_019e7kFQeNsaQwrd6n19si2K","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YJbwNCXiHhBhsxyHaX7uc2","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","old_string":"// Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.title])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);","new_string":"// Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.name])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":954,"cache_read_input_tokens":122798,"cache_creation":{"ephemeral_5m_input_tokens":954,"ephemeral_1h_input_tokens":0},"output_tokens":515,"service_tier":"standard"}},"requestId":"req_011CWVVSmYMcF6S5x1gWgJDQ","type":"assistant","uuid":"43f1d4d4-fa27-492a-9cb2-476c2469ac91","timestamp":"2025-12-26T14:55:05.987Z"}
{"parentUuid":"43f1d4d4-fa27-492a-9cb2-476c2469ac91","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YJbwNCXiHhBhsxyHaX7uc2","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   609→  }, [recommendations, selectedPhase, removedIds]);\n   610→\n   611→  const hasRecommendations = filteredRecommendations.length > 0;\n   612→\n   613→  // Detect treatment conflicts in current recommendations\n   614→  const treatmentConflicts = useMemo(() => {\n   615→    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n   616→    const nameMap = Object.fromEntries(\n   617→      filteredRecommendations.map(r => [r.ref_id, r.name])\n   618→    );\n   619→    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n   620→\n   621→    // Filter out dismissed conflicts\n   622→    return conflicts.filter(c => {\n   623→      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n   624→      return !dismissedConflicts.has(conflictKey);\n   625→    });\n   626→  }, [filteredRecommendations, dismissedConflicts]);\n   627→\n   628→  // Handle dismissing a conflict\n   629→  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n   630→    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;"}]},"uuid":"808f8365-e23d-47d5-9925-512a51f43559","timestamp":"2025-12-26T14:55:06.039Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","oldString":"// Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.title])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);","newString":"// Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.name])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);","originalFile":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n  CheckCircle,\n  AlertCircle,\n  CheckCircle2,\n  Scale,\n  Dumbbell,\n  Salad,\n  ArrowDown,\n  ArrowUp,\n  Minus,\n  Package,\n  ShoppingCart,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { usePricing } from '@/contexts/PricingContext';\nimport { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\nimport { FaceMorphing } from '../visualization/FaceMorphing';\nimport { TreatmentTimeline } from '../visualization/TreatmentTimeline';\nimport { RecommendationPhase, ProductRecommendation } from '@/types/results';\nimport { DailyStackCard } from '../cards/DailyStackCard';\nimport { ProductCard } from '../cards/ProductCard';\nimport { WeakPointCard } from '../cards/WeakPointCard';\nimport { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\nimport { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\nimport { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\nimport {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n          ? 'bg-cyan-500 text-black'\n          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n            ? 'bg-neutral-700 text-white'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n            }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n// ============================================\n\ntype PreviewMode = 'static' | 'morphing';\n\nfunction BeforeAfterPreviewSection() {\n  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  if (!frontPhoto) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n        <button\n          onClick={() => setPreviewMode('morphing')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'morphing'\n              ? 'bg-cyan-500/20 text-cyan-400'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Face Morphing\n        </button>\n        <button\n          onClick={() => setPreviewMode('static')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'static'\n              ? 'bg-neutral-700 text-white'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Static Preview\n        </button>\n      </div>\n\n      {/* Preview Component */}\n      <AnimatePresence mode=\"wait\">\n        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n          <motion.div\n            key=\"morphing\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: 20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <FaceMorphing\n              photo={frontPhoto}\n              frontLandmarks={frontLandmarks}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"static\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: -20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <BeforeAfterPreview\n              photo={frontPhoto}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// YOUR PHASE CARD (Body Composition Phase)\n// ============================================\n\ntype BodyPhase = 'bulk' | 'cut' | 'maintain';\n\ninterface YourPhaseCardProps {\n  bodyFatPercent?: number;\n  gender: 'male' | 'female';\n}\n\nfunction YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n  // Determine phase based on body fat and gender\n  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n    if (!bodyFatPercent) {\n      return {\n        phase: 'maintain',\n        message: 'Complete your physique analysis to get personalized phase recommendations.',\n        color: 'from-neutral-700 to-neutral-800',\n        icon: <Scale size={24} className=\"text-neutral-400\" />,\n      };\n    }\n\n    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n    const bulkThreshold = gender === 'male' ? 12 : 18;\n    const cutThreshold = gender === 'male' ? 18 : 25;\n\n    if (bodyFatPercent < bulkThreshold) {\n      return {\n        phase: 'bulk',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n        color: 'from-green-600 to-emerald-700',\n        icon: <Dumbbell size={24} className=\"text-white\" />,\n      };\n    } else if (bodyFatPercent > cutThreshold) {\n      return {\n        phase: 'cut',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n        color: 'from-orange-600 to-red-700',\n        icon: <Salad size={24} className=\"text-white\" />,\n      };\n    } else {\n      return {\n        phase: 'maintain',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n        color: 'from-blue-600 to-cyan-700',\n        icon: <Scale size={24} className=\"text-white\" />,\n      };\n    }\n  };\n\n  const { phase, message, color, icon } = getPhase();\n  const phaseLabels: Record<BodyPhase, string> = {\n    bulk: 'Lean Bulk Phase',\n    cut: 'Cutting Phase',\n    maintain: 'Maintenance Phase',\n  };\n\n  return (\n    <motion.div\n      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-start gap-4\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n          {icon}\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n              {phaseLabels[phase]}\n            </div>\n          </div>\n          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n\n          {/* Phase-specific tips */}\n          <div className=\"grid grid-cols-3 gap-2\">\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n                {phase === 'bulk' ? (\n                  <ArrowUp size={12} className=\"text-green-300\" />\n                ) : phase === 'cut' ? (\n                  <ArrowDown size={12} className=\"text-orange-300\" />\n                ) : (\n                  <Minus size={12} className=\"text-blue-300\" />\n                )}\n                <span className=\"text-xs text-white/60\">Calories</span>\n              </div>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PRODUCT BUNDLE CTA\n// ============================================\n\ninterface ProductBundleCardProps {\n  products: ProductRecommendation[];\n  title?: string;\n}\n\nfunction ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n  // Get top 3 most important products\n  const bundleProducts = products.slice(0, 3);\n\n  // Calculate total cost\n  const totalCost = bundleProducts.reduce((sum, rec) => {\n    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n    return sum + (supplement?.costPerMonth.min || 0);\n  }, 0);\n\n  if (bundleProducts.length === 0) return null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Package size={20} className=\"text-purple-400\" />\n        <h3 className=\"font-semibold text-white\">{title}</h3>\n        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n          Save 15%\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-300 mb-4\">\n        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n      </p>\n\n      {/* Bundle Items */}\n      <div className=\"space-y-2 mb-4\">\n        {bundleProducts.map((rec, index) => (\n          <div\n            key={rec.product.id}\n            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n          >\n            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n            </div>\n            <div className=\"text-right flex-shrink-0\">\n              <p className=\"text-sm text-white\">\n                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n              </p>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Total & CTA */}\n      <div className=\"border-t border-purple-500/20 pt-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-neutral-400\">Bundle Total</span>\n          <div className=\"text-right\">\n            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n          </div>\n        </div>\n        <button\n          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n        >\n          <ShoppingCart size={18} />\n          Get Your Bundle\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  // Treatment conflict state\n  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());\n  const [conflictModal, setConflictModal] = useState<{\n    isOpen: boolean;\n    conflict: TreatmentConflict | null;\n    newTreatmentId: string;\n  }>({ isOpen: false, conflict: null, newTreatmentId: '' });\n\n  const { openPricingModal } = usePricing();\n\n  // Convert to number for arithmetic operations\n  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Check if user has a paid plan\n  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n\n  // Get body fat from physique analysis\n  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n\n  // Generate Daily Stack for all users\n  const dailyStack = useMemo(() => {\n    return generateDailyStack(gender);\n  }, [gender]);\n\n  // Generate Product Recommendations based on metrics\n  const productRecommendations = useMemo(() => {\n    // Build metrics and severity dictionaries from ratios\n    const metricsDict: Record<string, number> = {};\n    const severityDict: Record<string, string> = {};\n\n    [...frontRatios, ...sideRatios].forEach(ratio => {\n      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n      severityDict[ratio.name] = ratio.severity;\n    });\n\n    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n  }, [frontRatios, sideRatios, gender, ethnicity]);\n\n  // Split product recommendations by state\n  const { flawProducts, idealProducts } = useMemo(() => {\n    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n    return { flawProducts: flaw, idealProducts: ideal };\n  }, [productRecommendations]);\n\n  // Map flaws to products and treatments\n  const flawsWithProducts = useMemo(() => {\n    return flaws.slice(0, 5).map(flaw => {\n      // Find products that target metrics related to this flaw\n      const relatedProducts = productRecommendations.filter(rec =>\n        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n          rec.matchedMetrics.some(metric =>\n            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n          )\n        )\n      );\n\n      // Find treatments that match this flaw\n      const relatedTreatments = recommendations.filter(rec =>\n        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n      );\n\n      return {\n        flaw,\n        products: relatedProducts.slice(0, 2),\n        treatments: relatedTreatments.slice(0, 3),\n      };\n    });\n  }, [flaws, productRecommendations, recommendations]);\n\n  // Handle progress photo upload\n  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n    // Store current analysis as previous before re-analyzing\n    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n    setPreviousAnalysis({\n      date: new Date().toISOString(),\n      overallScore: numScore,\n      bodyFatPercent,\n      frontPhotoUrl: frontPhoto || undefined,\n    });\n\n    // In a real implementation, this would upload to API and trigger re-analysis\n    console.log('Progress photo uploaded:', file.name);\n  }, [overallScore, bodyFatPercent, frontPhoto]);\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.title])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);\n\n  // Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set([...prev, conflictKey]));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);\n\n  const handleConflictCancel = useCallback(() => {\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, []);\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Your Phase Card - Body Composition Phase */}\n          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n\n          {/* Daily Stack Card - Hero Element for ALL users */}\n          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Fix Your Weak Points Section */}\n          {flawsWithProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Treatment Conflict Warnings */}\n          {treatmentConflicts.length > 0 && (\n            <TreatmentConflictList\n              conflicts={treatmentConflicts}\n              onDismiss={handleDismissConflict}\n              onDismissAll={handleDismissAllConflicts}\n            />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Upgrade CTA or Premium Badge */}\n          {hasPaidPlan ? (\n            <motion.div\n              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n\n      {/* Treatment Conflict Modal */}\n      <SelectionWarningModal\n        isOpen={conflictModal.isOpen}\n        onClose={handleConflictCancel}\n        conflict={conflictModal.conflict || {\n          treatment1Id: '',\n          treatment1Name: '',\n          treatment2Id: '',\n          treatment2Name: '',\n          reason: '',\n        }}\n        onProceed={handleConflictProceed}\n        onCancel={handleConflictCancel}\n      />\n    </TabContent>\n  );\n}\n","structuredPatch":[{"oldStart":614,"oldLines":7,"newStart":614,"newLines":7,"lines":["   const treatmentConflicts = useMemo(() => {","     const selectedIds = filteredRecommendations.map(r => r.ref_id);","     const nameMap = Object.fromEntries(","-      filteredRecommendations.map(r => [r.ref_id, r.title])","+      filteredRecommendations.map(r => [r.ref_id, r.name])","     );","     const conflicts = findTreatmentConflicts(selectedIds, nameMap);"," "]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"808f8365-e23d-47d5-9925-512a51f43559","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_018LVj63ZpVi7zGPf6Ym7wAb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018naJ585KzZ21RaU7SoM2qH","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","old_string":"// Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set([...prev, conflictKey]));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);","new_string":"// Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set(Array.from(prev).concat(conflictKey)));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set(Array.from(prev).concat(allKeys)));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set(Array.from(prev).concat(conflictModal.conflict!.treatment1Id)));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":929,"cache_read_input_tokens":123752,"cache_creation":{"ephemeral_5m_input_tokens":929,"ephemeral_1h_input_tokens":0},"output_tokens":714,"service_tier":"standard"}},"requestId":"req_011CWVVTZutYSGStP28HrqLe","type":"assistant","uuid":"5bef2d86-a69f-4e3c-909b-f72a04c873eb","timestamp":"2025-12-26T14:55:17.445Z"}
{"parentUuid":"5bef2d86-a69f-4e3c-909b-f72a04c873eb","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018naJ585KzZ21RaU7SoM2qH","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   624→      return !dismissedConflicts.has(conflictKey);\n   625→    });\n   626→  }, [filteredRecommendations, dismissedConflicts]);\n   627→\n   628→  // Handle dismissing a conflict\n   629→  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n   630→    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n   631→    setDismissedConflicts(prev => new Set(Array.from(prev).concat(conflictKey)));\n   632→  }, []);\n   633→\n   634→  // Handle dismissing all conflicts\n   635→  const handleDismissAllConflicts = useCallback(() => {\n   636→    const allKeys = treatmentConflicts.map(\n   637→      c => `${c.treatment1Id}-${c.treatment2Id}`\n   638→    );\n   639→    setDismissedConflicts(prev => new Set(Array.from(prev).concat(allKeys)));\n   640→  }, [treatmentConflicts]);\n   641→\n   642→  // Handle conflict modal actions\n   643→  const handleConflictProceed = useCallback(() => {\n   644→    if (conflictModal.conflict) {\n   645→      // Remove the lower priority (existing) treatment\n   646→      setRemovedIds(prev => new Set(Array.from(prev).concat(conflictModal.conflict!.treatment1Id)));\n   647→    }\n   648→    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n   649→  }, [conflictModal.conflict]);\n   650→\n   651→  const handleConflictCancel = useCallback(() => {\n   652→    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n   653→  }, []);"}]},"uuid":"02868d1a-09d6-45e2-aaf1-6253912e82d4","timestamp":"2025-12-26T14:55:17.501Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","oldString":"// Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set([...prev, conflictKey]));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);","newString":"// Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set(Array.from(prev).concat(conflictKey)));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set(Array.from(prev).concat(allKeys)));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set(Array.from(prev).concat(conflictModal.conflict!.treatment1Id)));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);","originalFile":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n  CheckCircle,\n  AlertCircle,\n  CheckCircle2,\n  Scale,\n  Dumbbell,\n  Salad,\n  ArrowDown,\n  ArrowUp,\n  Minus,\n  Package,\n  ShoppingCart,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { usePricing } from '@/contexts/PricingContext';\nimport { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\nimport { FaceMorphing } from '../visualization/FaceMorphing';\nimport { TreatmentTimeline } from '../visualization/TreatmentTimeline';\nimport { RecommendationPhase, ProductRecommendation } from '@/types/results';\nimport { DailyStackCard } from '../cards/DailyStackCard';\nimport { ProductCard } from '../cards/ProductCard';\nimport { WeakPointCard } from '../cards/WeakPointCard';\nimport { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\nimport { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\nimport { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\nimport {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n          ? 'bg-cyan-500 text-black'\n          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n            ? 'bg-neutral-700 text-white'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n            }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n// ============================================\n\ntype PreviewMode = 'static' | 'morphing';\n\nfunction BeforeAfterPreviewSection() {\n  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  if (!frontPhoto) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n        <button\n          onClick={() => setPreviewMode('morphing')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'morphing'\n              ? 'bg-cyan-500/20 text-cyan-400'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Face Morphing\n        </button>\n        <button\n          onClick={() => setPreviewMode('static')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'static'\n              ? 'bg-neutral-700 text-white'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Static Preview\n        </button>\n      </div>\n\n      {/* Preview Component */}\n      <AnimatePresence mode=\"wait\">\n        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n          <motion.div\n            key=\"morphing\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: 20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <FaceMorphing\n              photo={frontPhoto}\n              frontLandmarks={frontLandmarks}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"static\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: -20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <BeforeAfterPreview\n              photo={frontPhoto}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// YOUR PHASE CARD (Body Composition Phase)\n// ============================================\n\ntype BodyPhase = 'bulk' | 'cut' | 'maintain';\n\ninterface YourPhaseCardProps {\n  bodyFatPercent?: number;\n  gender: 'male' | 'female';\n}\n\nfunction YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n  // Determine phase based on body fat and gender\n  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n    if (!bodyFatPercent) {\n      return {\n        phase: 'maintain',\n        message: 'Complete your physique analysis to get personalized phase recommendations.',\n        color: 'from-neutral-700 to-neutral-800',\n        icon: <Scale size={24} className=\"text-neutral-400\" />,\n      };\n    }\n\n    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n    const bulkThreshold = gender === 'male' ? 12 : 18;\n    const cutThreshold = gender === 'male' ? 18 : 25;\n\n    if (bodyFatPercent < bulkThreshold) {\n      return {\n        phase: 'bulk',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n        color: 'from-green-600 to-emerald-700',\n        icon: <Dumbbell size={24} className=\"text-white\" />,\n      };\n    } else if (bodyFatPercent > cutThreshold) {\n      return {\n        phase: 'cut',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n        color: 'from-orange-600 to-red-700',\n        icon: <Salad size={24} className=\"text-white\" />,\n      };\n    } else {\n      return {\n        phase: 'maintain',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n        color: 'from-blue-600 to-cyan-700',\n        icon: <Scale size={24} className=\"text-white\" />,\n      };\n    }\n  };\n\n  const { phase, message, color, icon } = getPhase();\n  const phaseLabels: Record<BodyPhase, string> = {\n    bulk: 'Lean Bulk Phase',\n    cut: 'Cutting Phase',\n    maintain: 'Maintenance Phase',\n  };\n\n  return (\n    <motion.div\n      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-start gap-4\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n          {icon}\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n              {phaseLabels[phase]}\n            </div>\n          </div>\n          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n\n          {/* Phase-specific tips */}\n          <div className=\"grid grid-cols-3 gap-2\">\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n                {phase === 'bulk' ? (\n                  <ArrowUp size={12} className=\"text-green-300\" />\n                ) : phase === 'cut' ? (\n                  <ArrowDown size={12} className=\"text-orange-300\" />\n                ) : (\n                  <Minus size={12} className=\"text-blue-300\" />\n                )}\n                <span className=\"text-xs text-white/60\">Calories</span>\n              </div>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PRODUCT BUNDLE CTA\n// ============================================\n\ninterface ProductBundleCardProps {\n  products: ProductRecommendation[];\n  title?: string;\n}\n\nfunction ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n  // Get top 3 most important products\n  const bundleProducts = products.slice(0, 3);\n\n  // Calculate total cost\n  const totalCost = bundleProducts.reduce((sum, rec) => {\n    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n    return sum + (supplement?.costPerMonth.min || 0);\n  }, 0);\n\n  if (bundleProducts.length === 0) return null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Package size={20} className=\"text-purple-400\" />\n        <h3 className=\"font-semibold text-white\">{title}</h3>\n        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n          Save 15%\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-300 mb-4\">\n        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n      </p>\n\n      {/* Bundle Items */}\n      <div className=\"space-y-2 mb-4\">\n        {bundleProducts.map((rec, index) => (\n          <div\n            key={rec.product.id}\n            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n          >\n            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n            </div>\n            <div className=\"text-right flex-shrink-0\">\n              <p className=\"text-sm text-white\">\n                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n              </p>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Total & CTA */}\n      <div className=\"border-t border-purple-500/20 pt-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-neutral-400\">Bundle Total</span>\n          <div className=\"text-right\">\n            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n          </div>\n        </div>\n        <button\n          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n        >\n          <ShoppingCart size={18} />\n          Get Your Bundle\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  // Treatment conflict state\n  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());\n  const [conflictModal, setConflictModal] = useState<{\n    isOpen: boolean;\n    conflict: TreatmentConflict | null;\n    newTreatmentId: string;\n  }>({ isOpen: false, conflict: null, newTreatmentId: '' });\n\n  const { openPricingModal } = usePricing();\n\n  // Convert to number for arithmetic operations\n  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Check if user has a paid plan\n  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n\n  // Get body fat from physique analysis\n  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n\n  // Generate Daily Stack for all users\n  const dailyStack = useMemo(() => {\n    return generateDailyStack(gender);\n  }, [gender]);\n\n  // Generate Product Recommendations based on metrics\n  const productRecommendations = useMemo(() => {\n    // Build metrics and severity dictionaries from ratios\n    const metricsDict: Record<string, number> = {};\n    const severityDict: Record<string, string> = {};\n\n    [...frontRatios, ...sideRatios].forEach(ratio => {\n      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n      severityDict[ratio.name] = ratio.severity;\n    });\n\n    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n  }, [frontRatios, sideRatios, gender, ethnicity]);\n\n  // Split product recommendations by state\n  const { flawProducts, idealProducts } = useMemo(() => {\n    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n    return { flawProducts: flaw, idealProducts: ideal };\n  }, [productRecommendations]);\n\n  // Map flaws to products and treatments\n  const flawsWithProducts = useMemo(() => {\n    return flaws.slice(0, 5).map(flaw => {\n      // Find products that target metrics related to this flaw\n      const relatedProducts = productRecommendations.filter(rec =>\n        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n          rec.matchedMetrics.some(metric =>\n            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n          )\n        )\n      );\n\n      // Find treatments that match this flaw\n      const relatedTreatments = recommendations.filter(rec =>\n        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n      );\n\n      return {\n        flaw,\n        products: relatedProducts.slice(0, 2),\n        treatments: relatedTreatments.slice(0, 3),\n      };\n    });\n  }, [flaws, productRecommendations, recommendations]);\n\n  // Handle progress photo upload\n  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n    // Store current analysis as previous before re-analyzing\n    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n    setPreviousAnalysis({\n      date: new Date().toISOString(),\n      overallScore: numScore,\n      bodyFatPercent,\n      frontPhotoUrl: frontPhoto || undefined,\n    });\n\n    // In a real implementation, this would upload to API and trigger re-analysis\n    console.log('Progress photo uploaded:', file.name);\n  }, [overallScore, bodyFatPercent, frontPhoto]);\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.name])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);\n\n  // Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set([...prev, conflictKey]));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);\n\n  const handleConflictCancel = useCallback(() => {\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, []);\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Your Phase Card - Body Composition Phase */}\n          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n\n          {/* Daily Stack Card - Hero Element for ALL users */}\n          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Fix Your Weak Points Section */}\n          {flawsWithProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Treatment Conflict Warnings */}\n          {treatmentConflicts.length > 0 && (\n            <TreatmentConflictList\n              conflicts={treatmentConflicts}\n              onDismiss={handleDismissConflict}\n              onDismissAll={handleDismissAllConflicts}\n            />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Upgrade CTA or Premium Badge */}\n          {hasPaidPlan ? (\n            <motion.div\n              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n\n      {/* Treatment Conflict Modal */}\n      <SelectionWarningModal\n        isOpen={conflictModal.isOpen}\n        onClose={handleConflictCancel}\n        conflict={conflictModal.conflict || {\n          treatment1Id: '',\n          treatment1Name: '',\n          treatment2Id: '',\n          treatment2Name: '',\n          reason: '',\n        }}\n        onProceed={handleConflictProceed}\n        onCancel={handleConflictCancel}\n      />\n    </TabContent>\n  );\n}\n","structuredPatch":[{"oldStart":628,"oldLines":7,"newStart":628,"newLines":7,"lines":["   // Handle dismissing a conflict","   const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {","     const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;","-    setDismissedConflicts(prev => new Set([...prev, conflictKey]));","+    setDismissedConflicts(prev => new Set(Array.from(prev).concat(conflictKey)));","   }, []);"," ","   // Handle dismissing all conflicts"]},{"oldStart":636,"oldLines":14,"newStart":636,"newLines":14,"lines":["     const allKeys = treatmentConflicts.map(","       c => `${c.treatment1Id}-${c.treatment2Id}`","     );","-    setDismissedConflicts(prev => new Set([...prev, ...allKeys]));","+    setDismissedConflicts(prev => new Set(Array.from(prev).concat(allKeys)));","   }, [treatmentConflicts]);"," ","   // Handle conflict modal actions","   const handleConflictProceed = useCallback(() => {","     if (conflictModal.conflict) {","       // Remove the lower priority (existing) treatment","-      setRemovedIds(prev => new Set([...prev, conflictModal.conflict!.treatment1Id]));","+      setRemovedIds(prev => new Set(Array.from(prev).concat(conflictModal.conflict!.treatment1Id)));","     }","     setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });","   }, [conflictModal.conflict]);"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"02868d1a-09d6-45e2-aaf1-6253912e82d4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QUVTjY2kezvuWnqpTZwdtQ","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me fix the same issue in the engine.ts file:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1467,"cache_read_input_tokens":124681,"cache_creation":{"ephemeral_5m_input_tokens":1467,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVUQoytKk5kzQZy4C2N","type":"assistant","uuid":"0dd3fd93-457c-4d92-b805-c785f6bfb617","timestamp":"2025-12-26T14:55:20.242Z"}
{"parentUuid":"0dd3fd93-457c-4d92-b805-c785f6bfb617","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QUVTjY2kezvuWnqpTZwdtQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RBDEUSuyCRprfW713921AW","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","offset":820,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1467,"cache_read_input_tokens":124681,"cache_creation":{"ephemeral_5m_input_tokens":1467,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWVVUQoytKk5kzQZy4C2N","type":"assistant","uuid":"48aafb1e-156b-4018-91d9-95a44f95971b","timestamp":"2025-12-26T14:55:21.622Z"}
{"parentUuid":"48aafb1e-156b-4018-91d9-95a44f95971b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RBDEUSuyCRprfW713921AW","type":"tool_result","content":"   820→    const conflictingIds = getConflictingTreatments(treatmentId);\n   821→\n   822→    // Check if any already-selected treatment conflicts with this one\n   823→    let hasConflict = false;\n   824→    let conflictingSelectedId: string | null = null;\n   825→\n   826→    for (const selectedId of selectedIds) {\n   827→      if (conflictingIds.includes(selectedId)) {\n   828→        hasConflict = true;\n   829→        conflictingSelectedId = selectedId;\n   830→        break;\n   831→      }\n   832→    }\n   833→\n   834→    if (hasConflict && conflictingSelectedId) {\n   835→      // Record the conflict\n   836→      const exclusivity = getTreatmentExclusivity(treatmentId);\n   837→      const category = exclusivity?.exclusiveCategory;\n   838→      const reason = category\n   839→        ? CONFLICT_REASONS[category]\n   840→        : 'These treatments are mutually exclusive.';\n   841→\n   842→      // Find the conflicting recommendation for name lookup\n   843→      const conflictingRec = filtered.find(r => r.treatment.id === conflictingSelectedId);\n   844→\n   845→      conflicts.push({\n   846→        treatment1Id: conflictingSelectedId,\n   847→        treatment1Name: conflictingRec?.treatment.name || conflictingSelectedId,\n   848→        treatment2Id: treatmentId,\n   849→        treatment2Name: rec.treatment.name,\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"9b4e0b83-1607-4bdd-8b58-5bc6f315ebc4","timestamp":"2025-12-26T14:55:21.767Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","content":"    const conflictingIds = getConflictingTreatments(treatmentId);\n\n    // Check if any already-selected treatment conflicts with this one\n    let hasConflict = false;\n    let conflictingSelectedId: string | null = null;\n\n    for (const selectedId of selectedIds) {\n      if (conflictingIds.includes(selectedId)) {\n        hasConflict = true;\n        conflictingSelectedId = selectedId;\n        break;\n      }\n    }\n\n    if (hasConflict && conflictingSelectedId) {\n      // Record the conflict\n      const exclusivity = getTreatmentExclusivity(treatmentId);\n      const category = exclusivity?.exclusiveCategory;\n      const reason = category\n        ? CONFLICT_REASONS[category]\n        : 'These treatments are mutually exclusive.';\n\n      // Find the conflicting recommendation for name lookup\n      const conflictingRec = filtered.find(r => r.treatment.id === conflictingSelectedId);\n\n      conflicts.push({\n        treatment1Id: conflictingSelectedId,\n        treatment1Name: conflictingRec?.treatment.name || conflictingSelectedId,\n        treatment2Id: treatmentId,\n        treatment2Name: rec.treatment.name,","numLines":30,"startLine":820,"totalLines":947}}}
{"parentUuid":"9b4e0b83-1607-4bdd-8b58-5bc6f315ebc4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Nsfg97ibCCvavgbcyvrU1d","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012SAzfZouf1Zx5PQQw9qzG1","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","old_string":"// Check if any already-selected treatment conflicts with this one\n    let hasConflict = false;\n    let conflictingSelectedId: string | null = null;\n\n    for (const selectedId of selectedIds) {\n      if (conflictingIds.includes(selectedId)) {\n        hasConflict = true;\n        conflictingSelectedId = selectedId;\n        break;\n      }\n    }","new_string":"// Check if any already-selected treatment conflicts with this one\n    let hasConflict = false;\n    let conflictingSelectedId: string | null = null;\n\n    const selectedIdsArray = Array.from(selectedIds);\n    for (const selectedId of selectedIdsArray) {\n      if (conflictingIds.includes(selectedId)) {\n        hasConflict = true;\n        conflictingSelectedId = selectedId;\n        break;\n      }\n    }"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":617,"cache_read_input_tokens":126148,"cache_creation":{"ephemeral_5m_input_tokens":617,"ephemeral_1h_input_tokens":0},"output_tokens":322,"service_tier":"standard"}},"requestId":"req_011CWVVUj1rvca1So8EFSWtx","type":"assistant","uuid":"7a8ab57f-3a6e-42be-87b9-551c93d20074","timestamp":"2025-12-26T14:55:28.832Z"}
{"parentUuid":"7a8ab57f-3a6e-42be-87b9-551c93d20074","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012SAzfZouf1Zx5PQQw9qzG1","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   818→  for (const rec of sorted) {\n   819→    const treatmentId = rec.treatment.id;\n   820→    const conflictingIds = getConflictingTreatments(treatmentId);\n   821→\n   822→    // Check if any already-selected treatment conflicts with this one\n   823→    let hasConflict = false;\n   824→    let conflictingSelectedId: string | null = null;\n   825→\n   826→    const selectedIdsArray = Array.from(selectedIds);\n   827→    for (const selectedId of selectedIdsArray) {\n   828→      if (conflictingIds.includes(selectedId)) {\n   829→        hasConflict = true;\n   830→        conflictingSelectedId = selectedId;\n   831→        break;\n   832→      }\n   833→    }\n   834→\n   835→    if (hasConflict && conflictingSelectedId) {\n   836→      // Record the conflict\n   837→      const exclusivity = getTreatmentExclusivity(treatmentId);"}]},"uuid":"9f92da3b-2d0a-4f3a-a2cb-69143e1c9aa1","timestamp":"2025-12-26T14:55:28.895Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","oldString":"// Check if any already-selected treatment conflicts with this one\n    let hasConflict = false;\n    let conflictingSelectedId: string | null = null;\n\n    for (const selectedId of selectedIds) {\n      if (conflictingIds.includes(selectedId)) {\n        hasConflict = true;\n        conflictingSelectedId = selectedId;\n        break;\n      }\n    }","newString":"// Check if any already-selected treatment conflicts with this one\n    let hasConflict = false;\n    let conflictingSelectedId: string | null = null;\n\n    const selectedIdsArray = Array.from(selectedIds);\n    for (const selectedId of selectedIdsArray) {\n      if (conflictingIds.includes(selectedId)) {\n        hasConflict = true;\n        conflictingSelectedId = selectedId;\n        break;\n      }\n    }","originalFile":"/**\n * Recommendation Engine\n * Analyzes facial metrics and generates personalized treatment recommendations\n */\n\nimport {\n  Treatment,\n  Surgery,\n  Supplement,\n  TreatmentRecommendation,\n  MetricAnalysis,\n  RecommendationPlan,\n  OrderOfOperation,\n  TreatmentCategory,\n  Gender,\n  ProfileType,\n} from './types';\nimport { SOFTMAXXING_TREATMENTS } from './softmaxxing';\nimport { SURGICAL_TREATMENTS } from './hardmaxxing';\nimport { SUPPLEMENTS } from './supplements';\nimport { NON_SURGICAL_TREATMENTS } from './nonSurgical';\nimport {\n  classifyMetricValue,\n  calculateDeviation,\n  getIssueForMetric,\n  getTreatmentIdsForMetric,\n  getOverallSeverity,\n  harmonyToPSL,\n  estimatePotentialPSL,\n} from './severity';\n\n// ============================================\n// ALL TREATMENTS COMBINED\n// ============================================\n\nconst ALL_TREATMENTS: (Treatment | Surgery)[] = [\n  ...SOFTMAXXING_TREATMENTS,\n  ...NON_SURGICAL_TREATMENTS,\n  ...SURGICAL_TREATMENTS,\n];\n\n// ============================================\n// METRIC ANALYSIS\n// ============================================\n\nexport interface MetricInput {\n  metricId: string;\n  metricName: string;\n  currentValue: number;\n  idealValue: number;\n  idealRange: { min: number; max: number };\n  score: number;\n  profileType: ProfileType;\n}\n\n/**\n * Analyze a single metric and determine severity\n */\nexport function analyzeMetric(\n  input: MetricInput,\n  gender?: Gender\n): MetricAnalysis {\n  const { deviation, deviationPercent, direction } = calculateDeviation(\n    input.metricId,\n    input.currentValue\n  );\n\n  const severity = classifyMetricValue(input.metricId, input.currentValue, gender);\n  const issue = getIssueForMetric(input.metricId, direction);\n\n  return {\n    metricId: input.metricId,\n    metricName: input.metricName,\n    currentValue: input.currentValue,\n    idealValue: input.idealValue,\n    idealRange: input.idealRange,\n    deviation,\n    deviationPercent,\n    score: input.score,\n    severity,\n    issue: issue || undefined,\n    profileType: input.profileType,\n  };\n}\n\n/**\n * Analyze all metrics and sort by severity\n */\nexport function analyzeAllMetrics(\n  metrics: MetricInput[],\n  gender?: Gender\n): MetricAnalysis[] {\n  const analyses = metrics.map(m => analyzeMetric(m, gender));\n\n  // Sort by severity (severe first) then by score (lowest first)\n  const severityOrder = { severe: 0, moderate: 1, mild: 2, optimal: 3 };\n\n  return analyses.sort((a, b) => {\n    const severityDiff = severityOrder[a.severity.severity] - severityOrder[b.severity.severity];\n    if (severityDiff !== 0) return severityDiff;\n    return a.score - b.score;\n  });\n}\n\n// ============================================\n// TREATMENT MATCHING\n// ============================================\n\n/**\n * Find treatment by ID\n */\nexport function findTreatment(id: string): Treatment | Surgery | Supplement | undefined {\n  const treatment = ALL_TREATMENTS.find(t => t.id === id);\n  if (treatment) return treatment;\n\n  return SUPPLEMENTS.find(s => s.id === id);\n}\n\n/**\n * Find treatments that target a specific issue\n */\nexport function findTreatmentsForIssue(issue: string): (Treatment | Surgery)[] {\n  return ALL_TREATMENTS.filter(t =>\n    t.targetIssues.some(i =>\n      i.toLowerCase().includes(issue.toLowerCase()) ||\n      issue.toLowerCase().includes(i.toLowerCase())\n    )\n  );\n}\n\n/**\n * Find treatments that target a specific metric\n */\nexport function findTreatmentsForMetric(metricId: string): (Treatment | Surgery)[] {\n  return ALL_TREATMENTS.filter(t =>\n    t.targetMetrics.some(m =>\n      m.toLowerCase().includes(metricId.toLowerCase()) ||\n      metricId.toLowerCase().includes(m.toLowerCase())\n    )\n  );\n}\n\n/**\n * Score treatment relevance for a metric analysis\n */\nfunction scoreTreatmentRelevance(\n  treatment: Treatment | Surgery,\n  analysis: MetricAnalysis\n): number {\n  let score = 0;\n\n  // Check if treatment targets this metric\n  const targetsMetric = treatment.targetMetrics.some(m =>\n    m.toLowerCase().includes(analysis.metricId.toLowerCase())\n  );\n  if (targetsMetric) score += 30;\n\n  // Check if treatment addresses the issue\n  if (analysis.issue) {\n    const addressesIssue = treatment.targetIssues.some(i =>\n      i.toLowerCase().includes(analysis.issue!.toLowerCase()) ||\n      analysis.issue!.toLowerCase().includes(i.toLowerCase())\n    );\n    if (addressesIssue) score += 40;\n  }\n\n  // Factor in severity\n  const severityMultiplier = {\n    severe: 1.5,\n    moderate: 1.2,\n    mild: 1.0,\n    optimal: 0.3,\n  };\n  score *= severityMultiplier[analysis.severity.severity];\n\n  // Factor in treatment effectiveness\n  score += treatment.effectiveness * 2;\n\n  // Factor in PSL improvement potential\n  const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n  score += avgPSLImprovement * 10;\n\n  return Math.round(score);\n}\n\n/**\n * Generate treatment recommendations for a metric analysis\n */\nexport function getRecommendationsForMetric(\n  analysis: MetricAnalysis,\n  gender?: Gender,\n  maxRecommendations: number = 5\n): TreatmentRecommendation[] {\n  if (analysis.severity.severity === 'optimal') {\n    return []; // No treatment needed for optimal metrics\n  }\n\n  // Get treatment IDs from mapping\n  const { direction } = calculateDeviation(analysis.metricId, analysis.currentValue);\n  const treatmentIds = getTreatmentIdsForMetric(analysis.metricId, direction);\n\n  // Find matching treatments\n  let treatments: (Treatment | Surgery)[] = [];\n\n  // First, add treatments from the mapping\n  for (const id of treatmentIds) {\n    const treatment = findTreatment(id);\n    if (treatment && 'category' in treatment && treatment.category !== undefined) {\n      treatments.push(treatment as Treatment | Surgery);\n    }\n  }\n\n  // Then, find additional treatments that target this metric or issue\n  const additionalTreatments = [\n    ...findTreatmentsForMetric(analysis.metricId),\n    ...(analysis.issue ? findTreatmentsForIssue(analysis.issue) : []),\n  ];\n\n  // Remove duplicates\n  const seenIds = treatments.map(t => t.id);\n  for (const t of additionalTreatments) {\n    if (!seenIds.includes(t.id)) {\n      seenIds.push(t.id);\n      treatments.push(t);\n    }\n  }\n\n  // Filter by gender if specified\n  if (gender) {\n    treatments = treatments.filter(t =>\n      !t.genderSpecific || t.genderSpecific === gender\n    );\n  }\n\n  // Score and rank treatments\n  const scoredTreatments = treatments.map(treatment => ({\n    treatment,\n    relevanceScore: scoreTreatmentRelevance(treatment, analysis),\n  }));\n\n  // Sort by relevance score\n  scoredTreatments.sort((a, b) => b.relevanceScore - a.relevanceScore);\n\n  // Create recommendations\n  return scoredTreatments.slice(0, maxRecommendations).map(({ treatment, relevanceScore }) => {\n    const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n\n    return {\n      treatment,\n      priority: relevanceScore >= 60 ? 'high' as const :\n                relevanceScore >= 40 ? 'medium' as const :\n                'low' as const,\n      relevanceScore,\n      targetMetrics: [analysis.metricId],\n      estimatedImprovement: avgPSLImprovement,\n      reasoning: generateReasoning(treatment, analysis),\n    };\n  });\n}\n\n/**\n * Generate human-readable reasoning for a recommendation\n */\nfunction generateReasoning(\n  treatment: Treatment | Surgery,\n  analysis: MetricAnalysis\n): string {\n  const parts: string[] = [];\n\n  // Issue description\n  if (analysis.issue) {\n    parts.push(`Addresses ${analysis.issue.replace(/_/g, ' ')}`);\n  }\n\n  // Effectiveness\n  parts.push(`Effectiveness: ${treatment.effectiveness}/10`);\n\n  // PSL improvement\n  const pslRange = `${treatment.pslImprovement.min}-${treatment.pslImprovement.max}`;\n  parts.push(`Expected improvement: ${pslRange} PSL points`);\n\n  // Timeline\n  parts.push(`Results in: ${treatment.timelineToResults}`);\n\n  return parts.join('. ') + '.';\n}\n\n// ============================================\n// RECOMMENDATION PLAN GENERATION\n// ============================================\n\n/**\n * Generate a comprehensive recommendation plan\n */\nexport function generateRecommendationPlan(\n  metrics: MetricInput[],\n  overallScore: number,\n  harmonyPercent: number,\n  gender?: Gender\n): RecommendationPlan {\n  // Analyze all metrics\n  const metricAnalyses = analyzeAllMetrics(metrics, gender);\n\n  // Determine strengths and weaknesses\n  const strengths = metricAnalyses.filter(m =>\n    m.severity.severity === 'optimal' || m.score >= 85\n  );\n  const weaknesses = metricAnalyses.filter(m =>\n    m.severity.severity !== 'optimal' && m.score < 85\n  );\n\n  // Get recommendations for each weakness\n  const allRecommendations: TreatmentRecommendation[] = [];\n  for (const weakness of weaknesses) {\n    const recs = getRecommendationsForMetric(weakness, gender);\n    allRecommendations.push(...recs);\n  }\n\n  // Deduplicate recommendations (same treatment might help multiple metrics)\n  const uniqueRecommendations = deduplicateRecommendations(allRecommendations);\n\n  // Categorize recommendations\n  const lifestyle = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'lifestyle' || r.treatment.category === 'softmaxxing'\n  );\n  const softmaxxing = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'softmaxxing'\n  );\n  const nonSurgical = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'non_surgical'\n  );\n  const minimallyInvasive = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'minimally_invasive'\n  );\n  const surgical = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'surgical'\n  );\n\n  // Get supplement recommendations\n  const supplements = getSupplementRecommendations(weaknesses, gender);\n\n  // Calculate PSL ratings\n  const pslRating = harmonyToPSL(harmonyPercent);\n  const treatmentImprovements = uniqueRecommendations.map(r => r.estimatedImprovement);\n  const potentialPSL = estimatePotentialPSL(pslRating.psl, treatmentImprovements);\n\n  // Generate order of operations\n  const orderOfOperations = generateOrderOfOperations(uniqueRecommendations);\n\n  // Get overall severity\n  const overallSeverity = getOverallSeverity(metricAnalyses.map(m => m.severity.severity));\n\n  return {\n    overallScore,\n    overallSeverity,\n    harmonyScore: harmonyPercent,\n    percentile: pslRating.percentile,\n    metricAnalyses,\n    strengths,\n    weaknesses,\n    lifestyle,\n    softmaxxing,\n    nonSurgical,\n    minimallyInvasive,\n    surgical,\n    supplements,\n    currentPSL: pslRating.psl,\n    potentialPSL: potentialPSL.potentialPSL,\n    potentialImprovement: potentialPSL.totalImprovement,\n    orderOfOperations,\n  };\n}\n\n/**\n * Deduplicate recommendations, combining target metrics for same treatment\n */\nfunction deduplicateRecommendations(\n  recommendations: TreatmentRecommendation[]\n): TreatmentRecommendation[] {\n  const byId = new Map<string, TreatmentRecommendation>();\n\n  for (const rec of recommendations) {\n    const existing = byId.get(rec.treatment.id);\n    if (existing) {\n      // Combine target metrics (deduplicate using filter)\n      const combined = [...existing.targetMetrics, ...rec.targetMetrics];\n      existing.targetMetrics = combined.filter((m, i) => combined.indexOf(m) === i);\n\n      // Take higher relevance score\n      existing.relevanceScore = Math.max(existing.relevanceScore, rec.relevanceScore);\n\n      // Update priority based on new relevance\n      existing.priority = existing.relevanceScore >= 60 ? 'high' :\n                         existing.relevanceScore >= 40 ? 'medium' :\n                         'low';\n    } else {\n      byId.set(rec.treatment.id, { ...rec });\n    }\n  }\n\n  return Array.from(byId.values()).sort((a, b) => b.relevanceScore - a.relevanceScore);\n}\n\n/**\n * Get supplement recommendations based on weaknesses\n */\nfunction getSupplementRecommendations(\n  weaknesses: MetricAnalysis[],\n  gender?: Gender\n): TreatmentRecommendation[] {\n  const recommendations: TreatmentRecommendation[] = [];\n\n  // Map weakness types to supplement categories\n  const hasSkinIssues = weaknesses.some(w =>\n    w.issue?.includes('skin') || w.metricId.includes('skin')\n  );\n  const hasHairIssues = weaknesses.some(w =>\n    w.issue?.includes('hair') || w.metricId.includes('hairline')\n  );\n  const hasGeneralAging = weaknesses.some(w =>\n    w.issue?.includes('aging') || w.severity.severity === 'moderate' || w.severity.severity === 'severe'\n  );\n\n  // Helper to create supplement recommendation\n  const createSupplementRec = (\n    supp: Supplement,\n    priority: 'high' | 'medium' | 'low',\n    relevanceScore: number,\n    targetMetrics: string[],\n    reasoning: string\n  ): TreatmentRecommendation => ({\n    treatment: {\n      id: supp.id,\n      name: supp.name,\n      category: 'lifestyle',\n      description: supp.description,\n      howItWorks: `Dosage: ${supp.dosage} ${supp.frequency}`,\n      effectiveness: supp.effectiveness,\n      evidenceLevel: supp.evidenceLevel,\n      pslImprovement: { min: 0.05, max: 0.15 },\n      costLevel: supp.costPerMonth.max > 30 ? 'medium' : 'low',\n      costRange: { min: supp.costPerMonth.min, max: supp.costPerMonth.max, currency: 'USD' },\n      costFrequency: 'monthly',\n      timelineToResults: supp.timelineToResults,\n      resultsDuration: 'Ongoing with continued use',\n      maintenanceRequired: true,\n      maintenanceFrequency: supp.frequency,\n      recoveryTime: 'None',\n      downtime: 'None',\n      painLevel: 'none',\n      riskLevel: supp.riskLevel,\n      sideEffects: supp.sideEffects,\n      contraindications: supp.contraindications,\n      targetMetrics,\n      targetIssues: supp.targetBenefits,\n      notes: supp.notes,\n      sources: supp.sources,\n    },\n    priority,\n    relevanceScore,\n    targetMetrics,\n    estimatedImprovement: 0.1,\n    reasoning,\n  });\n\n  // Add relevant supplements\n  if (hasSkinIssues || hasGeneralAging) {\n    const skinSupplements = SUPPLEMENTS.filter(s =>\n      s.category === 'skin' || s.category === 'anti-aging'\n    );\n    for (const supp of skinSupplements.slice(0, 3)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'medium',\n        50,\n        ['skin_quality'],\n        `${supp.name} supports skin health and anti-aging.`\n      ));\n    }\n  }\n\n  if (hasHairIssues && gender === 'male') {\n    const hairSupplements = SUPPLEMENTS.filter(s => s.category === 'hair');\n    for (const supp of hairSupplements.slice(0, 3)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'medium',\n        45,\n        ['hairline'],\n        `${supp.name} supports hair health.`\n      ));\n    }\n  }\n\n  // Always recommend foundational supplements\n  const foundational = SUPPLEMENTS.filter(s =>\n    ['vitamin_d3', 'omega_3', 'magnesium'].includes(s.id)\n  );\n  for (const supp of foundational) {\n    if (!recommendations.some(r => r.treatment.id === supp.id)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'low',\n        30,\n        ['general_health'],\n        `${supp.name} supports overall health and wellbeing.`\n      ));\n    }\n  }\n\n  return recommendations.slice(0, 10);\n}\n\n/**\n * Generate order of operations for treatments\n */\nfunction generateOrderOfOperations(\n  recommendations: TreatmentRecommendation[]\n): OrderOfOperation[] {\n  const operations: OrderOfOperation[] = [];\n\n  // Define category order: lifestyle -> softmaxxing -> non-surgical -> minimally invasive -> surgical\n  const categoryOrder: TreatmentCategory[] = [\n    'lifestyle',\n    'softmaxxing',\n    'non_surgical',\n    'minimally_invasive',\n    'surgical',\n  ];\n\n  // Group by category (only for valid treatment categories)\n  const validCategories: TreatmentCategory[] = ['lifestyle', 'softmaxxing', 'non_surgical', 'minimally_invasive', 'surgical'];\n  const byCategory = new Map<TreatmentCategory, TreatmentRecommendation[]>();\n  for (const rec of recommendations) {\n    const cat = rec.treatment.category as TreatmentCategory;\n    if (validCategories.includes(cat)) {\n      if (!byCategory.has(cat)) {\n        byCategory.set(cat, []);\n      }\n      byCategory.get(cat)!.push(rec);\n    }\n  }\n\n  let step = 1;\n  for (const category of categoryOrder) {\n    const recs = byCategory.get(category) || [];\n    // Sort by priority and relevance\n    recs.sort((a, b) => {\n      if (a.priority !== b.priority) {\n        const priorityOrder = { high: 0, medium: 1, low: 2 };\n        return priorityOrder[a.priority] - priorityOrder[b.priority];\n      }\n      return b.relevanceScore - a.relevanceScore;\n    });\n\n    for (const rec of recs.slice(0, 3)) { // Max 3 per category\n      const treatment = rec.treatment as Treatment | Surgery;\n      const operation: OrderOfOperation = {\n        step,\n        category,\n        treatment,\n        reasoning: getStepReasoning(step, category),\n      };\n\n      // Add prerequisites for surgical procedures\n      if (category === 'surgical') {\n        operation.prerequisites = ['Complete non-surgical options first', 'Consult with board-certified surgeon'];\n        operation.waitTime = '6-12 months recovery between major procedures';\n      }\n\n      operations.push(operation);\n      step++;\n    }\n  }\n\n  return operations;\n}\n\n/**\n * Generate reasoning for a step in order of operations\n */\nfunction getStepReasoning(\n  step: number,\n  category: TreatmentCategory\n): string {\n  if (step === 1) {\n    return 'Start with foundational changes before considering more invasive options.';\n  }\n\n  if (category === 'lifestyle' || category === 'softmaxxing') {\n    return 'Low-risk, reversible changes that can provide noticeable improvement.';\n  }\n\n  if (category === 'non_surgical') {\n    return 'Non-invasive treatments with minimal downtime to test results before committing to surgery.';\n  }\n\n  if (category === 'minimally_invasive') {\n    return 'Minimally invasive procedures can provide significant results with less risk than surgery.';\n  }\n\n  if (category === 'surgical') {\n    return 'Consider surgery only after exhausting less invasive options and with realistic expectations.';\n  }\n\n  return '';\n}\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\n/**\n * Get top priority recommendations across all categories\n */\nexport function getTopRecommendations(\n  plan: RecommendationPlan,\n  count: number = 5\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all\n    .sort((a, b) => b.relevanceScore - a.relevanceScore)\n    .slice(0, count);\n}\n\n/**\n * Get recommendations filtered by cost level\n */\nexport function getRecommendationsByCost(\n  plan: RecommendationPlan,\n  maxCost: 'free' | 'low' | 'medium' | 'high' | 'very_high'\n): TreatmentRecommendation[] {\n  const costOrder = ['free', 'low', 'medium', 'high', 'very_high'];\n  const maxCostIndex = costOrder.indexOf(maxCost);\n\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('costLevel' in treatment) {\n      return costOrder.indexOf(treatment.costLevel) <= maxCostIndex;\n    }\n    return true;\n  });\n}\n\n/**\n * Get recommendations with minimal downtime\n */\nexport function getNoDowntimeRecommendations(\n  plan: RecommendationPlan\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('downtime' in treatment) {\n      const downtime = treatment.downtime.toLowerCase();\n      return downtime.includes('none') || downtime.includes('minimal');\n    }\n    return true;\n  });\n}\n\n/**\n * Format cost for display\n */\nexport function formatCost(treatment: Treatment | Surgery): string {\n  const { min, max, currency } = treatment.costRange;\n  const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : currency;\n\n  if (min === max) {\n    return `${symbol}${min.toLocaleString()}`;\n  }\n\n  return `${symbol}${min.toLocaleString()} - ${symbol}${max.toLocaleString()}`;\n}\n\n/**\n * Get summary statistics for a plan\n */\nexport function getPlanSummary(plan: RecommendationPlan): {\n  totalRecommendations: number;\n  highPriority: number;\n  mediumPriority: number;\n  lowPriority: number;\n  categoryCounts: Record<string, number>;\n  estimatedTotalImprovement: number;\n} {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return {\n    totalRecommendations: all.length,\n    highPriority: all.filter(r => r.priority === 'high').length,\n    mediumPriority: all.filter(r => r.priority === 'medium').length,\n    lowPriority: all.filter(r => r.priority === 'low').length,\n    categoryCounts: {\n      lifestyle: plan.lifestyle.length,\n      softmaxxing: plan.softmaxxing.length,\n      nonSurgical: plan.nonSurgical.length,\n      minimallyInvasive: plan.minimallyInvasive.length,\n      surgical: plan.surgical.length,\n      supplements: plan.supplements.length,\n    },\n    estimatedTotalImprovement: plan.potentialImprovement,\n  };\n}\n\n// ============================================\n// TREATMENT EXCLUSIVITY & CONFLICT DETECTION\n// ============================================\n\nimport {\n  treatmentsConflict,\n  getConflictingTreatments,\n  getTreatmentExclusivity,\n  CONFLICT_REASONS,\n} from '../advice-engine';\nimport type { ExclusiveCategory } from './types';\n\n/**\n * Conflict information for a pair of treatments\n */\nexport interface TreatmentConflict {\n  treatment1Id: string;\n  treatment1Name: string;\n  treatment2Id: string;\n  treatment2Name: string;\n  reason: string;\n  category?: ExclusiveCategory;\n}\n\n/**\n * Find all conflicts in a list of selected treatments\n */\nexport function findTreatmentConflicts(\n  selectedTreatmentIds: string[],\n  treatmentNameMap?: Record<string, string>\n): TreatmentConflict[] {\n  const conflicts: TreatmentConflict[] = [];\n  const seen = new Set<string>();\n\n  for (let i = 0; i < selectedTreatmentIds.length; i++) {\n    for (let j = i + 1; j < selectedTreatmentIds.length; j++) {\n      const id1 = selectedTreatmentIds[i];\n      const id2 = selectedTreatmentIds[j];\n\n      // Create unique key for this pair\n      const pairKey = [id1, id2].sort().join(':');\n      if (seen.has(pairKey)) continue;\n      seen.add(pairKey);\n\n      if (treatmentsConflict(id1, id2)) {\n        const exclusivity1 = getTreatmentExclusivity(id1);\n        const exclusivity2 = getTreatmentExclusivity(id2);\n        const category = exclusivity1?.exclusiveCategory || exclusivity2?.exclusiveCategory;\n        const reason = category\n          ? CONFLICT_REASONS[category]\n          : 'These treatments are mutually exclusive and should not be combined.';\n\n        conflicts.push({\n          treatment1Id: id1,\n          treatment1Name: treatmentNameMap?.[id1] || id1,\n          treatment2Id: id2,\n          treatment2Name: treatmentNameMap?.[id2] || id2,\n          reason,\n          category,\n        });\n      }\n    }\n  }\n\n  return conflicts;\n}\n\n/**\n * Filter recommendations to remove conflicting treatments\n * Keeps the treatment with higher relevance score when conflicts occur\n */\nexport function filterConflictingRecommendations(\n  recommendations: TreatmentRecommendation[]\n): {\n  filtered: TreatmentRecommendation[];\n  removed: TreatmentRecommendation[];\n  conflicts: TreatmentConflict[];\n} {\n  // Sort by relevance score (highest first)\n  const sorted = [...recommendations].sort((a, b) => b.relevanceScore - a.relevanceScore);\n  const filtered: TreatmentRecommendation[] = [];\n  const removed: TreatmentRecommendation[] = [];\n  const conflicts: TreatmentConflict[] = [];\n  const selectedIds = new Set<string>();\n\n  for (const rec of sorted) {\n    const treatmentId = rec.treatment.id;\n    const conflictingIds = getConflictingTreatments(treatmentId);\n\n    // Check if any already-selected treatment conflicts with this one\n    let hasConflict = false;\n    let conflictingSelectedId: string | null = null;\n\n    for (const selectedId of selectedIds) {\n      if (conflictingIds.includes(selectedId)) {\n        hasConflict = true;\n        conflictingSelectedId = selectedId;\n        break;\n      }\n    }\n\n    if (hasConflict && conflictingSelectedId) {\n      // Record the conflict\n      const exclusivity = getTreatmentExclusivity(treatmentId);\n      const category = exclusivity?.exclusiveCategory;\n      const reason = category\n        ? CONFLICT_REASONS[category]\n        : 'These treatments are mutually exclusive.';\n\n      // Find the conflicting recommendation for name lookup\n      const conflictingRec = filtered.find(r => r.treatment.id === conflictingSelectedId);\n\n      conflicts.push({\n        treatment1Id: conflictingSelectedId,\n        treatment1Name: conflictingRec?.treatment.name || conflictingSelectedId,\n        treatment2Id: treatmentId,\n        treatment2Name: rec.treatment.name,\n        reason,\n        category,\n      });\n\n      removed.push(rec);\n    } else {\n      filtered.push(rec);\n      selectedIds.add(treatmentId);\n    }\n  }\n\n  return { filtered, removed, conflicts };\n}\n\n/**\n * Validate a single treatment selection against existing selections\n */\nexport function validateTreatmentSelection(\n  newTreatmentId: string,\n  existingTreatmentIds: string[],\n  treatmentNameMap?: Record<string, string>\n): {\n  isValid: boolean;\n  conflicts: TreatmentConflict[];\n} {\n  const conflicts: TreatmentConflict[] = [];\n  const conflictingIds = getConflictingTreatments(newTreatmentId);\n\n  for (const existingId of existingTreatmentIds) {\n    if (conflictingIds.includes(existingId)) {\n      const exclusivity = getTreatmentExclusivity(newTreatmentId);\n      const category = exclusivity?.exclusiveCategory;\n      const reason = category\n        ? CONFLICT_REASONS[category]\n        : 'These treatments are mutually exclusive.';\n\n      conflicts.push({\n        treatment1Id: existingId,\n        treatment1Name: treatmentNameMap?.[existingId] || existingId,\n        treatment2Id: newTreatmentId,\n        treatment2Name: treatmentNameMap?.[newTreatmentId] || newTreatmentId,\n        reason,\n        category,\n      });\n    }\n  }\n\n  return {\n    isValid: conflicts.length === 0,\n    conflicts,\n  };\n}\n\n/**\n * Get a recommended alternative when a treatment conflicts\n */\nexport function getAlternativeTreatments(\n  conflictingTreatmentId: string,\n  existingTreatmentIds: string[]\n): string[] {\n  const exclusivity = getTreatmentExclusivity(conflictingTreatmentId);\n  if (!exclusivity?.exclusiveCategory) {\n    return [];\n  }\n\n  // Find all treatments in the same category that don't conflict with existing selections\n  const alternatives: string[] = [];\n  const conflictingIds = new Set(existingTreatmentIds);\n\n  // Look through all treatments for same category that aren't already conflicting\n  for (const treatment of ALL_TREATMENTS) {\n    if (treatment.id === conflictingTreatmentId) continue;\n    if (conflictingIds.has(treatment.id)) continue;\n\n    // Check if this treatment could address similar issues\n    const treatmentExclusivity = getTreatmentExclusivity(treatment.id);\n\n    // Not in same exclusive category = potential alternative\n    if (\n      !treatmentExclusivity?.exclusiveCategory ||\n      treatmentExclusivity.exclusiveCategory !== exclusivity.exclusiveCategory\n    ) {\n      // Check if it targets similar metrics\n      const originalTreatment = ALL_TREATMENTS.find(t => t.id === conflictingTreatmentId);\n      if (originalTreatment) {\n        const sharedMetrics = treatment.targetMetrics.filter(m =>\n          originalTreatment.targetMetrics.includes(m)\n        );\n        if (sharedMetrics.length > 0) {\n          alternatives.push(treatment.id);\n        }\n      }\n    }\n  }\n\n  return alternatives;\n}\n","structuredPatch":[{"oldStart":823,"oldLines":7,"newStart":823,"newLines":8,"lines":["     let hasConflict = false;","     let conflictingSelectedId: string | null = null;"," ","-    for (const selectedId of selectedIds) {","+    const selectedIdsArray = Array.from(selectedIds);","+    for (const selectedId of selectedIdsArray) {","       if (conflictingIds.includes(selectedId)) {","         hasConflict = true;","         conflictingSelectedId = selectedId;"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"9f92da3b-2d0a-4f3a-a2cb-69143e1c9aa1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_017vW8xBmQzj2ZbPZovq99LL","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me run the TypeScript check again:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":853,"cache_read_input_tokens":126765,"cache_creation":{"ephemeral_5m_input_tokens":853,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWVVVFWR1J1YSdLFNBHVu","type":"assistant","uuid":"46df7368-80a3-4b7a-b891-21bbd7a53b6a","timestamp":"2025-12-26T14:55:31.845Z"}
{"parentUuid":"46df7368-80a3-4b7a-b891-21bbd7a53b6a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_017vW8xBmQzj2ZbPZovq99LL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01F2SgutuWwNTiTfqjzS2Ysr","name":"Bash","input":{"command":"npx tsc --noEmit 2>&1 | head -50","description":"Run TypeScript type checking","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":853,"cache_read_input_tokens":126765,"cache_creation":{"ephemeral_5m_input_tokens":853,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWVVVFWR1J1YSdLFNBHVu","type":"assistant","uuid":"ca3d4e23-2977-4330-9532-b3478cfe55f9","timestamp":"2025-12-26T14:55:33.277Z"}
{"parentUuid":"ca3d4e23-2977-4330-9532-b3478cfe55f9","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01F2SgutuWwNTiTfqjzS2Ysr","type":"tool_result","content":"src/components/results/tabs/ReferralsTab.tsx(21,13): error TS2339: Property 'resultsAnalysis' does not exist on type 'ResultsContextType'.","is_error":false}]},"uuid":"8575556a-9de9-4f79-b07f-a2e91989d85e","timestamp":"2025-12-26T14:55:35.069Z","toolUseResult":{"stdout":"src/components/results/tabs/ReferralsTab.tsx(21,13): error TS2339: Property 'resultsAnalysis' does not exist on type 'ResultsContextType'.","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"8575556a-9de9-4f79-b07f-a2e91989d85e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XuKmjs1atSp4J9T4mnBuEL","type":"message","role":"assistant","content":[{"type":"text","text":"Good - the only error now is unrelated to our changes (it's in ReferralsTab). Let me run the linter to make sure there are no issues:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":176,"cache_read_input_tokens":127618,"cache_creation":{"ephemeral_5m_input_tokens":176,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVVhzsEV52Esqtv6uqG","type":"assistant","uuid":"4054b9c3-d2f5-4194-9ed2-6fe428604e02","timestamp":"2025-12-26T14:55:38.347Z"}
{"parentUuid":"4054b9c3-d2f5-4194-9ed2-6fe428604e02","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XuKmjs1atSp4J9T4mnBuEL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Sqpgr7AggceJQNDoXmg2pv","name":"Bash","input":{"command":"npm run lint 2>&1 | head -80","description":"Run ESLint","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":176,"cache_read_input_tokens":127618,"cache_creation":{"ephemeral_5m_input_tokens":176,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVVhzsEV52Esqtv6uqG","type":"assistant","uuid":"9326b1ff-ea20-40c9-904c-9ed3b29391df","timestamp":"2025-12-26T14:55:39.532Z"}
{"parentUuid":"9326b1ff-ea20-40c9-904c-9ed3b29391df","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Sqpgr7AggceJQNDoXmg2pv","type":"tool_result","content":"> looksmaxx-app@0.1.0 lint\n> next lint\n\n\n./src/components/results/cards/AnalysisHistoryCard.tsx\n64:13  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/cards/KeyStrengthsFlaws.tsx\n174:10  Error: 'ConfidenceBadge' is defined but never used.  @typescript-eslint/no-unused-vars\n\n./src/components/results/cards/TreatmentConflictWarning.tsx\n223:35  Error: 'index' is defined but never used.  @typescript-eslint/no-unused-vars\n\n./src/components/results/modals/UserProfileModal.tsx\n108:21  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/tabs/LeaderboardTab.tsx\n212:29  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/tabs/PlanTab.tsx\n49:3  Error: 'filterConflictingRecommendations' is defined but never used.  @typescript-eslint/no-unused-vars\n\n./src/components/results/tabs/ReferralsTab.tsx\n4:10  Error: 'motion' is defined but never used.  @typescript-eslint/no-unused-vars\n5:43  Error: 'Facebook' is defined but never used.  @typescript-eslint/no-unused-vars\n5:53  Error: 'Twitter' is defined but never used.  @typescript-eslint/no-unused-vars\n5:62  Error: 'Mail' is defined but never used.  @typescript-eslint/no-unused-vars\n21:13  Error: 'resultsAnalysis' is assigned a value but never used.  @typescript-eslint/no-unused-vars\n\n./src/contexts/ResultsContext.tsx\n920:6  Warning: React Hook useCallback has missing dependencies: 'frontPhoto', 'sidePhoto', and 'updateStreak'. Either include them or remove the dependency array.  react-hooks/exhaustive-deps\n1123:7  Warning: React Hook useMemo has a missing dependency: 'productRecommendations'. Either include it or remove the dependency array.  react-hooks/exhaustive-deps\n\ninfo  - Need to disable some ESLint rules? Learn more here: https://nextjs.org/docs/basic-features/eslint#disabling-rules","is_error":false}]},"uuid":"e286dc72-fc67-4d77-9656-7e55c9599d8f","timestamp":"2025-12-26T14:55:41.554Z","toolUseResult":{"stdout":"> looksmaxx-app@0.1.0 lint\n> next lint\n\n\n./src/components/results/cards/AnalysisHistoryCard.tsx\n64:13  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/cards/KeyStrengthsFlaws.tsx\n174:10  Error: 'ConfidenceBadge' is defined but never used.  @typescript-eslint/no-unused-vars\n\n./src/components/results/cards/TreatmentConflictWarning.tsx\n223:35  Error: 'index' is defined but never used.  @typescript-eslint/no-unused-vars\n\n./src/components/results/modals/UserProfileModal.tsx\n108:21  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/tabs/LeaderboardTab.tsx\n212:29  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/tabs/PlanTab.tsx\n49:3  Error: 'filterConflictingRecommendations' is defined but never used.  @typescript-eslint/no-unused-vars\n\n./src/components/results/tabs/ReferralsTab.tsx\n4:10  Error: 'motion' is defined but never used.  @typescript-eslint/no-unused-vars\n5:43  Error: 'Facebook' is defined but never used.  @typescript-eslint/no-unused-vars\n5:53  Error: 'Twitter' is defined but never used.  @typescript-eslint/no-unused-vars\n5:62  Error: 'Mail' is defined but never used.  @typescript-eslint/no-unused-vars\n21:13  Error: 'resultsAnalysis' is assigned a value but never used.  @typescript-eslint/no-unused-vars\n\n./src/contexts/ResultsContext.tsx\n920:6  Warning: React Hook useCallback has missing dependencies: 'frontPhoto', 'sidePhoto', and 'updateStreak'. Either include them or remove the dependency array.  react-hooks/exhaustive-deps\n1123:7  Warning: React Hook useMemo has a missing dependency: 'productRecommendations'. Either include it or remove the dependency array.  react-hooks/exhaustive-deps\n\ninfo  - Need to disable some ESLint rules? Learn more here: https://nextjs.org/docs/basic-features/eslint#disabling-rules","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"e286dc72-fc67-4d77-9656-7e55c9599d8f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JQGiZ2KqLy7w2CZohFVs9u","type":"message","role":"assistant","content":[{"type":"text","text":"Let me fix the unused variable errors in our new code:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1134,"cache_read_input_tokens":127794,"cache_creation":{"ephemeral_5m_input_tokens":1134,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWVVWBmxq2c4avB3cxeV2","type":"assistant","uuid":"ea0639c7-06dd-4172-a95a-366a57dd1d46","timestamp":"2025-12-26T14:55:45.158Z"}
{"parentUuid":"ea0639c7-06dd-4172-a95a-366a57dd1d46","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JQGiZ2KqLy7w2CZohFVs9u","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01R4nabC2hwPayFNEERYH2BS","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/TreatmentConflictWarning.tsx","old_string":"      {/* Conflicts */}\n      <AnimatePresence>\n        {conflicts.map((conflict, index) => (\n          <ConflictCard\n            key={`${conflict.treatment1Id}-${conflict.treatment2Id}`}\n            conflict={conflict}\n            onDismiss={onDismiss ? () => onDismiss(conflict) : undefined}\n          />\n        ))}\n      </AnimatePresence>","new_string":"      {/* Conflicts */}\n      <AnimatePresence>\n        {conflicts.map((conflict) => (\n          <ConflictCard\n            key={`${conflict.treatment1Id}-${conflict.treatment2Id}`}\n            conflict={conflict}\n            onDismiss={onDismiss ? () => onDismiss(conflict) : undefined}\n          />\n        ))}\n      </AnimatePresence>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1134,"cache_read_input_tokens":127794,"cache_creation":{"ephemeral_5m_input_tokens":1134,"ephemeral_1h_input_tokens":0},"output_tokens":336,"service_tier":"standard"}},"requestId":"req_011CWVVWBmxq2c4avB3cxeV2","type":"assistant","uuid":"7e397539-ec81-41a7-9b35-2cc1813c9fcb","timestamp":"2025-12-26T14:55:49.597Z"}
{"parentUuid":"7e397539-ec81-41a7-9b35-2cc1813c9fcb","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01R4nabC2hwPayFNEERYH2BS","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/TreatmentConflictWarning.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   217→          </button>\n   218→        )}\n   219→      </div>\n   220→\n   221→      {/* Conflicts */}\n   222→      <AnimatePresence>\n   223→        {conflicts.map((conflict) => (\n   224→          <ConflictCard\n   225→            key={`${conflict.treatment1Id}-${conflict.treatment2Id}`}\n   226→            conflict={conflict}\n   227→            onDismiss={onDismiss ? () => onDismiss(conflict) : undefined}\n   228→          />\n   229→        ))}\n   230→      </AnimatePresence>\n   231→    </div>\n   232→  );\n   233→}\n   234→"}]},"uuid":"b8844448-6c66-4af0-816f-f0f5f82a0b8e","timestamp":"2025-12-26T14:55:49.653Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/TreatmentConflictWarning.tsx","oldString":"      {/* Conflicts */}\n      <AnimatePresence>\n        {conflicts.map((conflict, index) => (\n          <ConflictCard\n            key={`${conflict.treatment1Id}-${conflict.treatment2Id}`}\n            conflict={conflict}\n            onDismiss={onDismiss ? () => onDismiss(conflict) : undefined}\n          />\n        ))}\n      </AnimatePresence>","newString":"      {/* Conflicts */}\n      <AnimatePresence>\n        {conflicts.map((conflict) => (\n          <ConflictCard\n            key={`${conflict.treatment1Id}-${conflict.treatment2Id}`}\n            conflict={conflict}\n            onDismiss={onDismiss ? () => onDismiss(conflict) : undefined}\n          />\n        ))}\n      </AnimatePresence>","originalFile":"'use client';\n\nimport { useState } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  AlertTriangle,\n  X,\n  ChevronDown,\n  ChevronUp,\n  Info,\n  ArrowRight,\n  XCircle,\n} from 'lucide-react';\nimport type { TreatmentConflict } from '@/lib/recommendations/engine';\nimport type { ExclusiveCategory } from '@/lib/recommendations/types';\n\n// ============================================\n// CATEGORY DISPLAY INFO\n// ============================================\n\nconst CATEGORY_DISPLAY: Record<ExclusiveCategory, { label: string; color: string; icon: string }> = {\n  'jaw_augmentation': {\n    label: 'Jaw Augmentation',\n    color: 'from-blue-500 to-blue-600',\n    icon: 'A',\n  },\n  'jaw_reduction': {\n    label: 'Jaw Reduction',\n    color: 'from-purple-500 to-purple-600',\n    icon: 'R',\n  },\n  'chin_augmentation': {\n    label: 'Chin Enhancement',\n    color: 'from-cyan-500 to-cyan-600',\n    icon: 'C',\n  },\n  'cheekbone_augmentation': {\n    label: 'Cheekbone Enhancement',\n    color: 'from-pink-500 to-pink-600',\n    icon: 'Z',\n  },\n  'lip_augmentation': {\n    label: 'Lip Augmentation',\n    color: 'from-red-500 to-red-600',\n    icon: 'L+',\n  },\n  'lip_reduction': {\n    label: 'Lip Reduction',\n    color: 'from-orange-500 to-orange-600',\n    icon: 'L-',\n  },\n  'submental_fat_removal': {\n    label: 'Double Chin Treatment',\n    color: 'from-yellow-500 to-yellow-600',\n    icon: 'S',\n  },\n  'neck_procedures': {\n    label: 'Neck Procedures',\n    color: 'from-teal-500 to-teal-600',\n    icon: 'N',\n  },\n  'eye_lateral_canthus': {\n    label: 'Eye Corner Surgery',\n    color: 'from-indigo-500 to-indigo-600',\n    icon: 'E',\n  },\n  'maxillary_surgery': {\n    label: 'Jaw Repositioning',\n    color: 'from-rose-500 to-rose-600',\n    icon: 'M',\n  },\n};\n\n// ============================================\n// SINGLE CONFLICT CARD\n// ============================================\n\ninterface ConflictCardProps {\n  conflict: TreatmentConflict;\n  onDismiss?: () => void;\n}\n\nfunction ConflictCard({ conflict, onDismiss }: ConflictCardProps) {\n  const [isExpanded, setIsExpanded] = useState(false);\n  const categoryInfo = conflict.category ? CATEGORY_DISPLAY[conflict.category] : null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-red-950/50 to-orange-950/50 border border-red-500/30 rounded-xl overflow-hidden\"\n      initial={{ opacity: 0, y: -10 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, height: 0 }}\n    >\n      {/* Header */}\n      <div className=\"flex items-center gap-3 p-4\">\n        <div className=\"w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0\">\n          <AlertTriangle size={20} className=\"text-red-400\" />\n        </div>\n\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2 mb-0.5\">\n            <h4 className=\"text-sm font-semibold text-white\">Treatment Conflict Detected</h4>\n            {categoryInfo && (\n              <span className={`px-2 py-0.5 bg-gradient-to-r ${categoryInfo.color} text-white text-[10px] font-medium rounded-full`}>\n                {categoryInfo.label}\n              </span>\n            )}\n          </div>\n          <p className=\"text-xs text-neutral-400\">\n            These treatments are mutually exclusive\n          </p>\n        </div>\n\n        <div className=\"flex items-center gap-1\">\n          <button\n            onClick={() => setIsExpanded(!isExpanded)}\n            className=\"p-1.5 hover:bg-white/10 rounded-lg transition-colors\"\n            aria-label={isExpanded ? 'Collapse' : 'Expand'}\n          >\n            {isExpanded ? (\n              <ChevronUp size={16} className=\"text-neutral-400\" />\n            ) : (\n              <ChevronDown size={16} className=\"text-neutral-400\" />\n            )}\n          </button>\n          {onDismiss && (\n            <button\n              onClick={onDismiss}\n              className=\"p-1.5 hover:bg-white/10 rounded-lg transition-colors\"\n              aria-label=\"Dismiss\"\n            >\n              <X size={16} className=\"text-neutral-500\" />\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* Conflict Details */}\n      <div className=\"px-4 pb-3\">\n        <div className=\"flex items-center gap-2 p-2 bg-black/30 rounded-lg\">\n          <div className=\"flex-1 text-center\">\n            <p className=\"text-xs text-red-400/70 mb-0.5\">Treatment 1</p>\n            <p className=\"text-sm font-medium text-white truncate\">{conflict.treatment1Name}</p>\n          </div>\n          <div className=\"flex-shrink-0 p-1.5 bg-red-500/20 rounded-full\">\n            <XCircle size={14} className=\"text-red-400\" />\n          </div>\n          <div className=\"flex-1 text-center\">\n            <p className=\"text-xs text-red-400/70 mb-0.5\">Treatment 2</p>\n            <p className=\"text-sm font-medium text-white truncate\">{conflict.treatment2Name}</p>\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded Content */}\n      <AnimatePresence>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n          >\n            <div className=\"px-4 pb-4 pt-1 border-t border-red-500/20\">\n              <div className=\"flex items-start gap-2 p-3 bg-black/20 rounded-lg\">\n                <Info size={14} className=\"text-red-400 flex-shrink-0 mt-0.5\" />\n                <div>\n                  <p className=\"text-sm text-neutral-300 leading-relaxed\">\n                    {conflict.reason}\n                  </p>\n                  <p className=\"text-xs text-neutral-500 mt-2\">\n                    Choose one treatment from this category and remove the other from your plan.\n                  </p>\n                </div>\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\n// ============================================\n// CONFLICT LIST\n// ============================================\n\ninterface TreatmentConflictListProps {\n  conflicts: TreatmentConflict[];\n  onDismiss?: (conflict: TreatmentConflict) => void;\n  onDismissAll?: () => void;\n}\n\nexport function TreatmentConflictList({\n  conflicts,\n  onDismiss,\n  onDismissAll,\n}: TreatmentConflictListProps) {\n  if (conflicts.length === 0) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <AlertTriangle size={16} className=\"text-red-400\" />\n          <span className=\"text-sm font-medium text-white\">\n            {conflicts.length} Treatment Conflict{conflicts.length !== 1 ? 's' : ''}\n          </span>\n        </div>\n        {onDismissAll && conflicts.length > 1 && (\n          <button\n            onClick={onDismissAll}\n            className=\"text-xs text-neutral-500 hover:text-white transition-colors\"\n          >\n            Dismiss All\n          </button>\n        )}\n      </div>\n\n      {/* Conflicts */}\n      <AnimatePresence>\n        {conflicts.map((conflict, index) => (\n          <ConflictCard\n            key={`${conflict.treatment1Id}-${conflict.treatment2Id}`}\n            conflict={conflict}\n            onDismiss={onDismiss ? () => onDismiss(conflict) : undefined}\n          />\n        ))}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// INLINE WARNING BADGE\n// ============================================\n\ninterface TreatmentConflictBadgeProps {\n  conflictsWith: string;\n  onClick?: () => void;\n}\n\nexport function TreatmentConflictBadge({ conflictsWith, onClick }: TreatmentConflictBadgeProps) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"inline-flex items-center gap-1 px-2 py-0.5 bg-red-500/20 border border-red-500/30 text-red-400 text-xs font-medium rounded-full hover:bg-red-500/30 transition-colors\"\n    >\n      <AlertTriangle size={10} />\n      <span>Conflicts with {conflictsWith}</span>\n    </button>\n  );\n}\n\n// ============================================\n// SELECTION WARNING MODAL\n// ============================================\n\ninterface SelectionWarningModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  conflict: TreatmentConflict;\n  onProceed: () => void;\n  onCancel: () => void;\n}\n\nexport function SelectionWarningModal({\n  isOpen,\n  onClose,\n  conflict,\n  onProceed,\n  onCancel,\n}: SelectionWarningModalProps) {\n  const categoryInfo = conflict.category ? CATEGORY_DISPLAY[conflict.category] : null;\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <>\n          {/* Backdrop */}\n          <motion.div\n            className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-50\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            onClick={onClose}\n          />\n\n          {/* Modal */}\n          <motion.div\n            className=\"fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md z-50\"\n            initial={{ opacity: 0, scale: 0.95, y: 20 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.95, y: 20 }}\n          >\n            <div className=\"bg-neutral-900 border border-neutral-700 rounded-2xl overflow-hidden shadow-2xl\">\n              {/* Header */}\n              <div className=\"p-5 border-b border-neutral-800\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center\">\n                    <AlertTriangle size={24} className=\"text-red-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"text-lg font-semibold text-white\">Treatment Conflict</h3>\n                    {categoryInfo && (\n                      <span className={`inline-block px-2 py-0.5 bg-gradient-to-r ${categoryInfo.color} text-white text-xs font-medium rounded-full mt-1`}>\n                        {categoryInfo.label}\n                      </span>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Content */}\n              <div className=\"p-5 space-y-4\">\n                {/* Visual Conflict */}\n                <div className=\"flex items-center gap-3 p-4 bg-neutral-800/50 rounded-xl\">\n                  <div className=\"flex-1 text-center\">\n                    <div className=\"w-full p-3 bg-neutral-700/50 rounded-lg mb-2\">\n                      <p className=\"text-sm font-medium text-white\">{conflict.treatment1Name}</p>\n                    </div>\n                    <p className=\"text-xs text-green-400\">Already Selected</p>\n                  </div>\n                  <div className=\"flex-shrink-0\">\n                    <div className=\"w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center\">\n                      <XCircle size={16} className=\"text-red-400\" />\n                    </div>\n                  </div>\n                  <div className=\"flex-1 text-center\">\n                    <div className=\"w-full p-3 bg-neutral-700/50 rounded-lg mb-2\">\n                      <p className=\"text-sm font-medium text-white\">{conflict.treatment2Name}</p>\n                    </div>\n                    <p className=\"text-xs text-yellow-400\">New Selection</p>\n                  </div>\n                </div>\n\n                {/* Explanation */}\n                <div className=\"p-3 bg-red-950/30 border border-red-500/20 rounded-lg\">\n                  <p className=\"text-sm text-neutral-300 leading-relaxed\">\n                    {conflict.reason}\n                  </p>\n                </div>\n\n                {/* Options */}\n                <p className=\"text-xs text-neutral-500 text-center\">\n                  You can proceed (the lower priority treatment will be removed) or cancel to keep your current selection.\n                </p>\n              </div>\n\n              {/* Actions */}\n              <div className=\"p-5 border-t border-neutral-800 flex gap-3\">\n                <button\n                  onClick={onCancel}\n                  className=\"flex-1 py-2.5 bg-neutral-800 text-white font-medium rounded-lg hover:bg-neutral-700 transition-colors\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={onProceed}\n                  className=\"flex-1 py-2.5 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center gap-2\"\n                >\n                  Replace Treatment\n                  <ArrowRight size={16} />\n                </button>\n              </div>\n            </div>\n          </motion.div>\n        </>\n      )}\n    </AnimatePresence>\n  );\n}\n\n// ============================================\n// EXPORTS\n// ============================================\n\nexport { ConflictCard };\nexport default TreatmentConflictList;\n","structuredPatch":[{"oldStart":220,"oldLines":7,"newStart":220,"newLines":7,"lines":[" ","       {/* Conflicts */}","       <AnimatePresence>","-        {conflicts.map((conflict, index) => (","+        {conflicts.map((conflict) => (","           <ConflictCard","             key={`${conflict.treatment1Id}-${conflict.treatment2Id}`}","             conflict={conflict}"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"b8844448-6c66-4af0-816f-f0f5f82a0b8e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01M9GvybfP8ZNkLQPb8iZmTG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QgQE87Ngep1GhR6BfmTFGi","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","old_string":"import {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';","new_string":"import {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":590,"cache_read_input_tokens":128928,"cache_creation":{"ephemeral_5m_input_tokens":590,"ephemeral_1h_input_tokens":0},"output_tokens":20,"service_tier":"standard"}},"requestId":"req_011CWVVWnMaoB4vf6phnk5oP","type":"assistant","uuid":"f87e64b9-5d27-4479-926a-74942bb70393","timestamp":"2025-12-26T14:55:59.461Z"}
{"parentUuid":"f87e64b9-5d27-4479-926a-74942bb70393","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QgQE87Ngep1GhR6BfmTFGi","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    39→import { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\n    40→import { generateDailyStack } from '@/lib/daily-stack';\n    41→import { getProductRecommendations } from '@/lib/product-recommendations';\n    42→import { SUPPLEMENTS } from '@/lib/recommendations/supplements';\n    43→import {\n    44→  TreatmentConflictList,\n    45→  SelectionWarningModal,\n    46→} from '../cards/TreatmentConflictWarning';\n    47→import {\n    48→  findTreatmentConflicts,\n    49→  type TreatmentConflict,\n    50→} from '@/lib/recommendations/engine';\n    51→\n    52→// ============================================\n    53→// POTENTIAL SCORE CARD\n    54→// ============================================"}]},"uuid":"a497be7f-d76d-4fff-99bc-86fc23931f20","timestamp":"2025-12-26T14:55:59.549Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","oldString":"import {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';","newString":"import {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';","originalFile":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n  CheckCircle,\n  AlertCircle,\n  CheckCircle2,\n  Scale,\n  Dumbbell,\n  Salad,\n  ArrowDown,\n  ArrowUp,\n  Minus,\n  Package,\n  ShoppingCart,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { usePricing } from '@/contexts/PricingContext';\nimport { usePhysiqueOptional } from '@/contexts/PhysiqueContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';\nimport { FaceMorphing } from '../visualization/FaceMorphing';\nimport { TreatmentTimeline } from '../visualization/TreatmentTimeline';\nimport { RecommendationPhase, ProductRecommendation } from '@/types/results';\nimport { DailyStackCard } from '../cards/DailyStackCard';\nimport { ProductCard } from '../cards/ProductCard';\nimport { WeakPointCard } from '../cards/WeakPointCard';\nimport { ProgressComparisonCard } from '../cards/ProgressComparisonCard';\nimport { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';\nimport { generateDailyStack } from '@/lib/daily-stack';\nimport { getProductRecommendations } from '@/lib/product-recommendations';\nimport { SUPPLEMENTS } from '@/lib/recommendations/supplements';\nimport {\n  TreatmentConflictList,\n  SelectionWarningModal,\n} from '../cards/TreatmentConflictWarning';\nimport {\n  findTreatmentConflicts,\n  filterConflictingRecommendations,\n  type TreatmentConflict,\n} from '@/lib/recommendations/engine';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${selectedPhase === null\n          ? 'bg-cyan-500 text-black'\n          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedPhase === phase\n            ? 'bg-neutral-700 text-white'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n            }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// BEFORE/AFTER PREVIEW SECTION WITH MORPHING\n// ============================================\n\ntype PreviewMode = 'static' | 'morphing';\n\nfunction BeforeAfterPreviewSection() {\n  const { frontPhoto, overallScore, recommendations, frontLandmarks } = useResults();\n  const [previewMode, setPreviewMode] = useState<PreviewMode>('morphing');\n  const numericScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - numericScore);\n  }, [recommendations, numericScore]);\n\n  const potentialScore = Math.min(10, numericScore + potentialImprovement);\n\n  if (!frontPhoto) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Mode Toggle */}\n      <div className=\"flex items-center justify-center gap-1 p-1 bg-black/40 rounded-lg border border-white/10\">\n        <button\n          onClick={() => setPreviewMode('morphing')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'morphing'\n              ? 'bg-cyan-500/20 text-cyan-400'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Face Morphing\n        </button>\n        <button\n          onClick={() => setPreviewMode('static')}\n          className={`flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${\n            previewMode === 'static'\n              ? 'bg-neutral-700 text-white'\n              : 'text-neutral-500 hover:text-white'\n          }`}\n        >\n          Static Preview\n        </button>\n      </div>\n\n      {/* Preview Component */}\n      <AnimatePresence mode=\"wait\">\n        {previewMode === 'morphing' && frontLandmarks.length > 0 ? (\n          <motion.div\n            key=\"morphing\"\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: 20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <FaceMorphing\n              photo={frontPhoto}\n              frontLandmarks={frontLandmarks}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"static\"\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            exit={{ opacity: 0, x: -20 }}\n            transition={{ duration: 0.2 }}\n          >\n            <BeforeAfterPreview\n              photo={frontPhoto}\n              currentScore={numericScore}\n              potentialScore={potentialScore}\n              recommendations={recommendations}\n            />\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// YOUR PHASE CARD (Body Composition Phase)\n// ============================================\n\ntype BodyPhase = 'bulk' | 'cut' | 'maintain';\n\ninterface YourPhaseCardProps {\n  bodyFatPercent?: number;\n  gender: 'male' | 'female';\n}\n\nfunction YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {\n  // Determine phase based on body fat and gender\n  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {\n    if (!bodyFatPercent) {\n      return {\n        phase: 'maintain',\n        message: 'Complete your physique analysis to get personalized phase recommendations.',\n        color: 'from-neutral-700 to-neutral-800',\n        icon: <Scale size={24} className=\"text-neutral-400\" />,\n      };\n    }\n\n    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut\n    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut\n    const bulkThreshold = gender === 'male' ? 12 : 18;\n    const cutThreshold = gender === 'male' ? 18 : 25;\n\n    if (bodyFatPercent < bulkThreshold) {\n      return {\n        phase: 'bulk',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,\n        color: 'from-green-600 to-emerald-700',\n        icon: <Dumbbell size={24} className=\"text-white\" />,\n      };\n    } else if (bodyFatPercent > cutThreshold) {\n      return {\n        phase: 'cut',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,\n        color: 'from-orange-600 to-red-700',\n        icon: <Salad size={24} className=\"text-white\" />,\n      };\n    } else {\n      return {\n        phase: 'maintain',\n        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,\n        color: 'from-blue-600 to-cyan-700',\n        icon: <Scale size={24} className=\"text-white\" />,\n      };\n    }\n  };\n\n  const { phase, message, color, icon } = getPhase();\n  const phaseLabels: Record<BodyPhase, string> = {\n    bulk: 'Lean Bulk Phase',\n    cut: 'Cutting Phase',\n    maintain: 'Maintenance Phase',\n  };\n\n  return (\n    <motion.div\n      className={`bg-gradient-to-br ${color} rounded-2xl p-6 border border-white/10`}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-start gap-4\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0\">\n          {icon}\n        </div>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-white text-lg\">Your Phase</h3>\n            <div className=\"px-2 py-0.5 bg-white/20 rounded-full text-xs font-medium text-white\">\n              {phaseLabels[phase]}\n            </div>\n          </div>\n          <p className=\"text-sm text-white/80 mb-4\">{message}</p>\n\n          {/* Phase-specific tips */}\n          <div className=\"grid grid-cols-3 gap-2\">\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <div className=\"flex items-center justify-center gap-1 mb-0.5\">\n                {phase === 'bulk' ? (\n                  <ArrowUp size={12} className=\"text-green-300\" />\n                ) : phase === 'cut' ? (\n                  <ArrowDown size={12} className=\"text-orange-300\" />\n                ) : (\n                  <Minus size={12} className=\"text-blue-300\" />\n                )}\n                <span className=\"text-xs text-white/60\">Calories</span>\n              </div>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '±0'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Protein</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}\n              </span>\n            </div>\n            <div className=\"bg-black/20 rounded-lg p-2 text-center\">\n              <span className=\"text-xs text-white/60 block mb-0.5\">Cardio</span>\n              <span className=\"text-sm font-medium text-white\">\n                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PRODUCT BUNDLE CTA\n// ============================================\n\ninterface ProductBundleCardProps {\n  products: ProductRecommendation[];\n  title?: string;\n}\n\nfunction ProductBundleCard({ products, title = 'Recommended Bundle' }: ProductBundleCardProps) {\n  // Get top 3 most important products\n  const bundleProducts = products.slice(0, 3);\n\n  // Calculate total cost\n  const totalCost = bundleProducts.reduce((sum, rec) => {\n    const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);\n    return sum + (supplement?.costPerMonth.min || 0);\n  }, 0);\n\n  if (bundleProducts.length === 0) return null;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-purple-900/50 to-violet-950/50 border border-purple-500/30 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Package size={20} className=\"text-purple-400\" />\n        <h3 className=\"font-semibold text-white\">{title}</h3>\n        <div className=\"ml-auto px-2 py-0.5 bg-purple-500/20 text-purple-300 text-xs font-medium rounded-full\">\n          Save 15%\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-300 mb-4\">\n        Your analysis recommends these {bundleProducts.length} supplements - optimized for your specific weak points.\n      </p>\n\n      {/* Bundle Items */}\n      <div className=\"space-y-2 mb-4\">\n        {bundleProducts.map((rec, index) => (\n          <div\n            key={rec.product.id}\n            className=\"flex items-center gap-3 p-2 bg-black/20 rounded-lg\"\n          >\n            <div className=\"w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-bold text-purple-300\">{index + 1}</span>\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium text-white truncate\">{rec.product.name}</p>\n              <p className=\"text-xs text-neutral-400 truncate\">Targets: {rec.targetMetric}</p>\n            </div>\n            <div className=\"text-right flex-shrink-0\">\n              <p className=\"text-sm text-white\">\n                ${SUPPLEMENTS.find(s => s.id === rec.product.supplementId)?.costPerMonth.min || 0}/mo\n              </p>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Total & CTA */}\n      <div className=\"border-t border-purple-500/20 pt-4\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <span className=\"text-neutral-400\">Bundle Total</span>\n          <div className=\"text-right\">\n            <span className=\"text-lg font-bold text-white\">${totalCost}/mo</span>\n            <span className=\"text-xs text-neutral-500 ml-2 line-through\">${Math.round(totalCost * 1.15)}/mo</span>\n          </div>\n        </div>\n        <button\n          className=\"w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-medium rounded-lg hover:opacity-90 transition-opacity\"\n        >\n          <ShoppingCart size={18} />\n          Get Your Bundle\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();\n  const { user } = useAuth();\n  const physiqueContext = usePhysiqueOptional();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n  const [previousAnalysis, setPreviousAnalysis] = useState<{\n    date: string;\n    overallScore: number;\n    bodyFatPercent?: number;\n    frontPhotoUrl?: string;\n  } | null>(null);\n\n  // Treatment conflict state\n  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());\n  const [conflictModal, setConflictModal] = useState<{\n    isOpen: boolean;\n    conflict: TreatmentConflict | null;\n    newTreatmentId: string;\n  }>({ isOpen: false, conflict: null, newTreatmentId: '' });\n\n  const { openPricingModal } = usePricing();\n\n  // Convert to number for arithmetic operations\n  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;\n\n  // Check if user has a paid plan\n  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';\n\n  // Get body fat from physique analysis\n  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;\n\n  // Generate Daily Stack for all users\n  const dailyStack = useMemo(() => {\n    return generateDailyStack(gender);\n  }, [gender]);\n\n  // Generate Product Recommendations based on metrics\n  const productRecommendations = useMemo(() => {\n    // Build metrics and severity dictionaries from ratios\n    const metricsDict: Record<string, number> = {};\n    const severityDict: Record<string, string> = {};\n\n    [...frontRatios, ...sideRatios].forEach(ratio => {\n      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;\n      severityDict[ratio.name] = ratio.severity;\n    });\n\n    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);\n  }, [frontRatios, sideRatios, gender, ethnicity]);\n\n  // Split product recommendations by state\n  const { flawProducts, idealProducts } = useMemo(() => {\n    const flaw = productRecommendations.filter(r => r.state === 'flaw');\n    const ideal = productRecommendations.filter(r => r.state === 'ideal');\n    return { flawProducts: flaw, idealProducts: ideal };\n  }, [productRecommendations]);\n\n  // Map flaws to products and treatments\n  const flawsWithProducts = useMemo(() => {\n    return flaws.slice(0, 5).map(flaw => {\n      // Find products that target metrics related to this flaw\n      const relatedProducts = productRecommendations.filter(rec =>\n        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>\n          rec.matchedMetrics.some(metric =>\n            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||\n            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())\n          )\n        )\n      );\n\n      // Find treatments that match this flaw\n      const relatedTreatments = recommendations.filter(rec =>\n        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))\n      );\n\n      return {\n        flaw,\n        products: relatedProducts.slice(0, 2),\n        treatments: relatedTreatments.slice(0, 3),\n      };\n    });\n  }, [flaws, productRecommendations, recommendations]);\n\n  // Handle progress photo upload\n  const handleProgressPhotoUpload = useCallback(async (file: File) => {\n    // Store current analysis as previous before re-analyzing\n    const numScore = typeof overallScore === 'number' ? overallScore : 0;\n    setPreviousAnalysis({\n      date: new Date().toISOString(),\n      overallScore: numScore,\n      bodyFatPercent,\n      frontPhotoUrl: frontPhoto || undefined,\n    });\n\n    // In a real implementation, this would upload to API and trigger re-analysis\n    console.log('Progress photo uploaded:', file.name);\n  }, [overallScore, bodyFatPercent, frontPhoto]);\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Detect treatment conflicts in current recommendations\n  const treatmentConflicts = useMemo(() => {\n    const selectedIds = filteredRecommendations.map(r => r.ref_id);\n    const nameMap = Object.fromEntries(\n      filteredRecommendations.map(r => [r.ref_id, r.name])\n    );\n    const conflicts = findTreatmentConflicts(selectedIds, nameMap);\n\n    // Filter out dismissed conflicts\n    return conflicts.filter(c => {\n      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;\n      return !dismissedConflicts.has(conflictKey);\n    });\n  }, [filteredRecommendations, dismissedConflicts]);\n\n  // Handle dismissing a conflict\n  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {\n    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;\n    setDismissedConflicts(prev => new Set(Array.from(prev).concat(conflictKey)));\n  }, []);\n\n  // Handle dismissing all conflicts\n  const handleDismissAllConflicts = useCallback(() => {\n    const allKeys = treatmentConflicts.map(\n      c => `${c.treatment1Id}-${c.treatment2Id}`\n    );\n    setDismissedConflicts(prev => new Set(Array.from(prev).concat(allKeys)));\n  }, [treatmentConflicts]);\n\n  // Handle conflict modal actions\n  const handleConflictProceed = useCallback(() => {\n    if (conflictModal.conflict) {\n      // Remove the lower priority (existing) treatment\n      setRemovedIds(prev => new Set(Array.from(prev).concat(conflictModal.conflict!.treatment1Id)));\n    }\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, [conflictModal.conflict]);\n\n  const handleConflictCancel = useCallback(() => {\n    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });\n  }, []);\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Your Phase Card - Body Composition Phase */}\n          <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />\n\n          {/* Daily Stack Card - Hero Element for ALL users */}\n          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}\n\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Fix Your Weak Points Section */}\n          {flawsWithProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <AlertCircle size={20} className=\"text-red-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Fix Your Weak Points</h3>\n                <span className=\"px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30\">\n                  {flawsWithProducts.length} Issues\n                </span>\n              </div>\n              <div className=\"space-y-3\">\n                {flawsWithProducts.map((item, index) => (\n                  <WeakPointCard\n                    key={item.flaw.id}\n                    flaw={item.flaw}\n                    rank={index + 1}\n                    products={item.products}\n                    treatments={item.treatments}\n                    onViewTreatment={(treatment) => setExpandedId(treatment.ref_id)}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Corrective */}\n          {flawProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Package size={20} className=\"text-cyan-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Recommended Products</h3>\n                <span className=\"px-2 py-0.5 bg-cyan-500/20 text-cyan-400 text-xs rounded-full border border-cyan-500/30\">\n                  Corrective\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {flawProducts.slice(0, 6).map((rec, index) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Targeted Product Recommendations - Maintenance */}\n          {idealProducts.length > 0 && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <CheckCircle2 size={20} className=\"text-green-400\" />\n                <h3 className=\"text-lg font-semibold text-white\">Protect Your Strengths</h3>\n                <span className=\"px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30\">\n                  Maintenance\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {idealProducts.slice(0, 4).map((rec) => (\n                  <ProductCard key={rec.product.id} recommendation={rec} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Treatment Timeline */}\n          {recommendations.length > 0 && (\n            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />\n          )}\n\n          {/* Treatment Conflict Warnings */}\n          {treatmentConflicts.length > 0 && (\n            <TreatmentConflictList\n              conflicts={treatmentConflicts}\n              onDismiss={handleDismissConflict}\n              onDismissAll={handleDismissAllConflicts}\n            />\n          )}\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Medical Prescription Card (Dental) */}\n          {vision?.teeth && (\n            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />\n          )}\n\n          {/* Progress Comparison Card */}\n          <ProgressComparisonCard\n            currentAnalysis={{\n              date: new Date().toISOString(),\n              overallScore: numericOverallScore,\n              bodyFatPercent,\n              frontPhotoUrl: frontPhoto || undefined,\n            }}\n            previousAnalysis={previousAnalysis}\n            onUploadNewPhoto={handleProgressPhotoUpload}\n          />\n\n          {/* Product Bundle CTA */}\n          {flawProducts.length >= 3 && (\n            <ProductBundleCard\n              products={flawProducts}\n              title=\"Your Fix Bundle\"\n            />\n          )}\n\n          {/* Before/After Preview */}\n          <BeforeAfterPreviewSection />\n\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Upgrade CTA or Premium Badge */}\n          {hasPaidPlan ? (\n            <motion.div\n              className=\"bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle size={16} className=\"text-green-400\" />\n                <span className=\"text-sm font-medium text-white\">\n                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active\n                </span>\n              </div>\n              <p className=\"text-xs text-neutral-400\">\n                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.\n              </p>\n            </motion.div>\n          ) : (\n            <motion.div\n              className=\"bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n            >\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Sparkles size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm font-medium text-white\">Unlock Full Plan</span>\n              </div>\n              <p className=\"text-xs text-neutral-400 mb-3\">\n                Get detailed treatment guides, cost estimates, and provider recommendations.\n              </p>\n              <button\n                onClick={() => openPricingModal('plan_sidebar')}\n                className=\"block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors\"\n              >\n                Upgrade Now\n              </button>\n            </motion.div>\n          )}\n        </div>\n      </div>\n\n      {/* Treatment Conflict Modal */}\n      <SelectionWarningModal\n        isOpen={conflictModal.isOpen}\n        onClose={handleConflictCancel}\n        conflict={conflictModal.conflict || {\n          treatment1Id: '',\n          treatment1Name: '',\n          treatment2Id: '',\n          treatment2Name: '',\n          reason: '',\n        }}\n        onProceed={handleConflictProceed}\n        onCancel={handleConflictCancel}\n      />\n    </TabContent>\n  );\n}\n","structuredPatch":[{"oldStart":46,"oldLines":7,"newStart":46,"newLines":6,"lines":[" } from '../cards/TreatmentConflictWarning';"," import {","   findTreatmentConflicts,","-  filterConflictingRecommendations,","   type TreatmentConflict,"," } from '@/lib/recommendations/engine';"," "]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"a497be7f-d76d-4fff-99bc-86fc23931f20","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Lb4vFjMzBQ639efx4MFLog","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me run the lint and type check again to confirm everything is working:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":768,"cache_read_input_tokens":129518,"cache_creation":{"ephemeral_5m_input_tokens":768,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWVVXWhXFf4hrCryPTe9x","type":"assistant","uuid":"b148aa30-7880-40b6-83fb-6002493acb1b","timestamp":"2025-12-26T14:56:03.170Z"}
{"parentUuid":"b148aa30-7880-40b6-83fb-6002493acb1b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Lb4vFjMzBQ639efx4MFLog","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017CD3Jqs1hewHhxPuHv9ZCS","name":"Bash","input":{"command":"npm run lint 2>&1 | grep -E \"(Error|error)\" | head -20","description":"Check for ESLint errors only","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":768,"cache_read_input_tokens":129518,"cache_creation":{"ephemeral_5m_input_tokens":768,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWVVXWhXFf4hrCryPTe9x","type":"assistant","uuid":"c50ac39b-a360-4da2-9a16-49933852f82f","timestamp":"2025-12-26T14:56:11.258Z"}
{"parentUuid":"c50ac39b-a360-4da2-9a16-49933852f82f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017CD3Jqs1hewHhxPuHv9ZCS","type":"tool_result","content":"42:10  Error: 'ConfidenceBadge' is defined but never used.  @typescript-eslint/no-unused-vars\n4:10  Error: 'motion' is defined but never used.  @typescript-eslint/no-unused-vars\n5:43  Error: 'Facebook' is defined but never used.  @typescript-eslint/no-unused-vars\n5:53  Error: 'Twitter' is defined but never used.  @typescript-eslint/no-unused-vars\n5:62  Error: 'Mail' is defined but never used.  @typescript-eslint/no-unused-vars\n21:13  Error: 'resultsAnalysis' is assigned a value but never used.  @typescript-eslint/no-unused-vars","is_error":false}]},"uuid":"140d2c25-911d-4095-9bdf-ec4faf8e93a0","timestamp":"2025-12-26T14:56:14.811Z","toolUseResult":{"stdout":"42:10  Error: 'ConfidenceBadge' is defined but never used.  @typescript-eslint/no-unused-vars\n4:10  Error: 'motion' is defined but never used.  @typescript-eslint/no-unused-vars\n5:43  Error: 'Facebook' is defined but never used.  @typescript-eslint/no-unused-vars\n5:53  Error: 'Twitter' is defined but never used.  @typescript-eslint/no-unused-vars\n5:62  Error: 'Mail' is defined but never used.  @typescript-eslint/no-unused-vars\n21:13  Error: 'resultsAnalysis' is assigned a value but never used.  @typescript-eslint/no-unused-vars","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"140d2c25-911d-4095-9bdf-ec4faf8e93a0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Eie8UbR33DCTmAM2xW8p7r","type":"message","role":"assistant","content":[{"type":"text","text":"All the remaining errors are in other files not related to our changes. Let me verify our specific files have no errors:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":326,"cache_read_input_tokens":130286,"cache_creation":{"ephemeral_5m_input_tokens":326,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVYeUNYKjzrc2twPtY6","type":"assistant","uuid":"7adb9755-36ee-4aa8-bf23-85a57058866e","timestamp":"2025-12-26T14:56:18.486Z"}
{"parentUuid":"7adb9755-36ee-4aa8-bf23-85a57058866e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Eie8UbR33DCTmAM2xW8p7r","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012rjhhpT46vyNS2S4t78kE9","name":"Bash","input":{"command":"npm run lint 2>&1 | grep -E \"(TreatmentConflict|engine\\.ts|advice-engine|types\\.ts|PlanTab\\.tsx)\" | head -10","description":"Check our modified files","timeout":60000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":326,"cache_read_input_tokens":130286,"cache_creation":{"ephemeral_5m_input_tokens":326,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVYeUNYKjzrc2twPtY6","type":"assistant","uuid":"292ece0b-77b6-4224-b9cd-07a8e64c7382","timestamp":"2025-12-26T14:56:20.025Z"}
{"parentUuid":"292ece0b-77b6-4224-b9cd-07a8e64c7382","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012rjhhpT46vyNS2S4t78kE9","type":"tool_result","content":"","is_error":false}]},"uuid":"53d1da37-691d-42b4-b3dc-6611e1e56fb1","timestamp":"2025-12-26T14:56:21.403Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"53d1da37-691d-42b4-b3dc-6611e1e56fb1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ULGbN4t8D7WdSeLYzph4rW","type":"message","role":"assistant","content":[{"type":"text","text":"No errors in our modified files. Let me also run a quick build check to ensure everything compiles:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":370,"cache_read_input_tokens":130612,"cache_creation":{"ephemeral_5m_input_tokens":370,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVZ85JNMGUX6jo7Tgpj","type":"assistant","uuid":"44603900-4f81-4c18-9c3e-ee0bf5dd3d0d","timestamp":"2025-12-26T14:56:24.978Z"}
{"parentUuid":"44603900-4f81-4c18-9c3e-ee0bf5dd3d0d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ULGbN4t8D7WdSeLYzph4rW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DHz7vde4EuxCkCFsN858kJ","name":"Bash","input":{"command":"npx tsc --noEmit 2>&1","description":"Final TypeScript check","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":370,"cache_read_input_tokens":130612,"cache_creation":{"ephemeral_5m_input_tokens":370,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVZ85JNMGUX6jo7Tgpj","type":"assistant","uuid":"f07ba228-56e5-4fb8-8851-182604492a48","timestamp":"2025-12-26T14:56:25.934Z"}
{"parentUuid":"f07ba228-56e5-4fb8-8851-182604492a48","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"Exit code 2\nsrc/components/results/tabs/ReferralsTab.tsx(21,13): error TS2339: Property 'resultsAnalysis' does not exist on type 'ResultsContextType'.","is_error":true,"tool_use_id":"toolu_01DHz7vde4EuxCkCFsN858kJ"}]},"uuid":"2de9b216-51ea-4ee8-baf1-55e4e05ae24b","timestamp":"2025-12-26T14:56:27.765Z","toolUseResult":"Error: Exit code 2\nsrc/components/results/tabs/ReferralsTab.tsx(21,13): error TS2339: Property 'resultsAnalysis' does not exist on type 'ResultsContextType'."}
{"parentUuid":"2de9b216-51ea-4ee8-baf1-55e4e05ae24b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CgmUjWJBZSNgt1piVm6kLq","type":"message","role":"assistant","content":[{"type":"text","text":"The only remaining error is in ReferralsTab.tsx which is unrelated to our implementation. Let me update the todo list and provide a summary:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":194,"cache_read_input_tokens":130982,"cache_creation":{"ephemeral_5m_input_tokens":194,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVZbCCuvoU3Y3ZV4pLs","type":"assistant","uuid":"cf6bf15a-b263-4d72-b00f-30df76c624c1","timestamp":"2025-12-26T14:56:31.082Z"}
{"parentUuid":"cf6bf15a-b263-4d72-b00f-30df76c624c1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CgmUjWJBZSNgt1piVm6kLq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XK4BuqPHNK2dsMVvuPha82","name":"TodoWrite","input":{"todos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"completed","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"completed","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"completed","activeForm":"Testing implementation"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":194,"cache_read_input_tokens":130982,"cache_creation":{"ephemeral_5m_input_tokens":194,"ephemeral_1h_input_tokens":0},"output_tokens":253,"service_tier":"standard"}},"requestId":"req_011CWVVZbCCuvoU3Y3ZV4pLs","type":"assistant","uuid":"26e232b0-b15a-4a0d-ae67-919ae686723d","timestamp":"2025-12-26T14:56:33.903Z"}
{"parentUuid":"26e232b0-b15a-4a0d-ae67-919ae686723d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XK4BuqPHNK2dsMVvuPha82","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"087f9a2e-e94e-4e57-b28d-01e3e69ffe04","timestamp":"2025-12-26T14:56:33.952Z","toolUseResult":{"oldTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"completed","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"completed","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"in_progress","activeForm":"Testing implementation"}],"newTodos":[{"content":"Add exclusiveWith and exclusiveCategory fields to Treatment interface in types.ts","status":"completed","activeForm":"Adding exclusivity fields to Treatment interface"},{"content":"Add exclusivity data to all relevant treatments in advice-engine.ts","status":"completed","activeForm":"Adding exclusivity data to treatments"},{"content":"Implement validation function to filter conflicting treatments in engine.ts","status":"completed","activeForm":"Implementing conflict validation"},{"content":"Add UI warning component for conflicting treatment selections","status":"completed","activeForm":"Adding UI warning component"},{"content":"Test the implementation","status":"completed","activeForm":"Testing implementation"}]}}
{"parentUuid":"087f9a2e-e94e-4e57-b28d-01e3e69ffe04","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"df8c5b13-ae4e-4858-825f-600437c50d83","version":"2.0.76","gitBranch":"main","agentId":"a6da709","slug":"optimized-strolling-moler","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XAikQremBW2cJ7AmaBemPg","type":"message","role":"assistant","content":[{"type":"text","text":"I have successfully implemented mutually exclusive treatment categories. Here's a summary of the changes:\n\n## Summary of Implementation\n\n### 1. Types Added (`/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/types.ts`)\n\nAdded `ExclusiveCategory` type and two new fields to the `Treatment` interface:\n- `exclusiveCategory?: ExclusiveCategory` - Category this treatment belongs to\n- `exclusiveWith?: string[]` - Specific treatment IDs that conflict\n\n**10 Exclusive Categories defined:**\n- `jaw_augmentation` - Jaw implants/fillers (conflicts with reduction)\n- `jaw_reduction` - V-line surgery/masseter botox (conflicts with augmentation)\n- `chin_augmentation` - Chin implants, genioplasty, filler (pick ONE)\n- `cheekbone_augmentation` - Cheek fillers or implants (pick ONE)\n- `lip_augmentation` - Lip filler (conflicts with reduction)\n- `lip_reduction` - Lip reduction surgery (conflicts with augmentation)\n- `submental_fat_removal` - Kybella, cryolipolysis, liposuction (pick ONE)\n- `neck_procedures` - Neck lift, submentoplasty (overlapping)\n- `eye_lateral_canthus` - Canthoplasty or canthopexy (pick ONE)\n- `maxillary_surgery` - Bimaxillary osteotomy (supersedes others)\n\n### 2. Exclusivity Data (`/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts`)\n\nAdded:\n- `TREATMENT_EXCLUSIVITY` - Mapping of 20+ treatments to their exclusivity rules\n- `getTreatmentExclusivity()` - Get exclusivity data for a treatment\n- `treatmentsConflict()` - Check if two treatments conflict\n- `getConflictingTreatments()` - Get all treatments that conflict with a given one\n- `CONFLICT_REASONS` - Human-readable explanations for each conflict category\n\n### 3. Validation Functions (`/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts`)\n\nAdded:\n- `TreatmentConflict` interface - Conflict information structure\n- `findTreatmentConflicts()` - Find all conflicts in a list of treatments\n- `filterConflictingRecommendations()` - Filter out conflicting treatments (keeps higher priority)\n- `validateTreatmentSelection()` - Validate a new selection against existing ones\n- `getAlternativeTreatments()` - Get alternative non-conflicting treatments\n\n### 4. UI Components (`/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/TreatmentConflictWarning.tsx`)\n\nCreated new components:\n- `ConflictCard` - Expandable card showing a single conflict\n- `TreatmentConflictList` - List of all conflicts with dismiss functionality\n- `TreatmentConflictBadge` - Inline badge for treatment cards\n- `SelectionWarningModal` - Modal warning when selecting conflicting treatments\n\n### 5. PlanTab Integration (`/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx`)\n\nIntegrated conflict detection into the Plan tab:\n- Real-time conflict detection as treatments are displayed\n- Conflict warnings shown before the phase filter\n- Dismissable conflicts with \"Dismiss All\" option\n- Modal for handling conflicts when adding new treatments"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":295,"cache_read_input_tokens":131176,"cache_creation":{"ephemeral_5m_input_tokens":295,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWVVa3qLJzipudEfjNh8k","type":"assistant","uuid":"fbc272e7-a1af-4eb2-97aa-da90e216d940","timestamp":"2025-12-26T14:56:56.890Z"}
