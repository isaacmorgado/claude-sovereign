{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":"Explore the current advice and recommendation system in the codebase:\n\n1. Find and analyze `advice-engine.ts` - understand its current structure, how recommendations are generated, what the REMEDIATION_DB looks like\n2. Look at how recommendations are displayed in the UI (EnhancedRecommendationCard, any product/affiliate components)\n3. Understand the data flow: analysis results → recommendations → UI display\n4. Check if there's any existing product database or affiliate link system\n5. Look at the insights-engine.ts to understand how it differs from advice-engine\n\nProvide a detailed summary of:\n- Current recommendation logic and structure\n- How products/affiliates are currently handled (if at all)\n- Where in the UI recommendations are shown\n- Any existing monetization hooks or product references"},"uuid":"8518bf65-1a62-41d8-8a25-eee22845a0d1","timestamp":"2025-12-22T00:06:53.147Z"}
{"parentUuid":"8518bf65-1a62-41d8-8a25-eee22845a0d1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUsCCiQwR2W9rbmA4zuqkN","type":"message","role":"assistant","content":[{"type":"text","text":"I'll explore the advice and recommendation system in the codebase. Let me start by examining the key files."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2528,"cache_read_input_tokens":10192,"cache_creation":{"ephemeral_5m_input_tokens":2528,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkVUAPPcW37nmLAUpD6","type":"assistant","uuid":"eb54678d-a351-41b7-872a-ab3c83f33015","timestamp":"2025-12-22T00:06:55.689Z"}
{"parentUuid":"eb54678d-a351-41b7-872a-ab3c83f33015","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUsCCiQwR2W9rbmA4zuqkN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MtYCDwnDGNjKmR6inYomk4","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2528,"cache_read_input_tokens":10192,"cache_creation":{"ephemeral_5m_input_tokens":2528,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkVUAPPcW37nmLAUpD6","type":"assistant","uuid":"09ec8a10-c6a5-403f-bd2f-fcf628db9e15","timestamp":"2025-12-22T00:06:56.068Z"}
{"parentUuid":"09ec8a10-c6a5-403f-bd2f-fcf628db9e15","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUsCCiQwR2W9rbmA4zuqkN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011ZuwqdVea54kvkjRDm82pp","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2528,"cache_read_input_tokens":10192,"cache_creation":{"ephemeral_5m_input_tokens":2528,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkVUAPPcW37nmLAUpD6","type":"assistant","uuid":"961143e1-53f3-478e-8a5c-03b463661196","timestamp":"2025-12-22T00:06:56.172Z"}
{"parentUuid":"961143e1-53f3-478e-8a5c-03b463661196","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUsCCiQwR2W9rbmA4zuqkN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KGH83MwnTN2pGYibQbcSAP","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2528,"cache_read_input_tokens":10192,"cache_creation":{"ephemeral_5m_input_tokens":2528,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkVUAPPcW37nmLAUpD6","type":"assistant","uuid":"66a73f0b-958b-44ec-a483-0a3487c880f3","timestamp":"2025-12-22T00:06:56.518Z"}
{"parentUuid":"66a73f0b-958b-44ec-a483-0a3487c880f3","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUsCCiQwR2W9rbmA4zuqkN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014g2sQAhJ8dyWDqeuNA12ke","name":"Glob","input":{"pattern":"src/**/*product*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2528,"cache_read_input_tokens":10192,"cache_creation":{"ephemeral_5m_input_tokens":2528,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkVUAPPcW37nmLAUpD6","type":"assistant","uuid":"5107fdd8-4e3e-40b1-93f1-56bdeebca673","timestamp":"2025-12-22T00:06:56.770Z"}
{"parentUuid":"5107fdd8-4e3e-40b1-93f1-56bdeebca673","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUsCCiQwR2W9rbmA4zuqkN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N4n9mjY6E7PmRT6CidiG85","name":"Glob","input":{"pattern":"src/**/*affiliate*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2528,"cache_read_input_tokens":10192,"cache_creation":{"ephemeral_5m_input_tokens":2528,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkVUAPPcW37nmLAUpD6","type":"assistant","uuid":"6e05700d-c7e3-493b-b9a9-5824e7a4a1f2","timestamp":"2025-12-22T00:06:56.849Z"}
{"parentUuid":"6e05700d-c7e3-493b-b9a9-5824e7a4a1f2","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TUsCCiQwR2W9rbmA4zuqkN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TE9T2WNZfUoaTBEntd5o22","name":"Glob","input":{"pattern":"src/**/*recommend*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":2528,"cache_read_input_tokens":10192,"cache_creation":{"ephemeral_5m_input_tokens":2528,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkVUAPPcW37nmLAUpD6","type":"assistant","uuid":"bbb452af-7edb-4757-bfca-1a019c83cceb","timestamp":"2025-12-22T00:06:56.952Z"}
{"parentUuid":"bbb452af-7edb-4757-bfca-1a019c83cceb","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MtYCDwnDGNjKmR6inYomk4","type":"tool_result","content":"     1→/**\n     2→ * Advice Engine - Client-side implementation matching the Python AdviceEngine\n     3→ * Processes plans.json trigger rules against user metrics\n     4→ */\n     5→\n     6→import { Plan } from '@/components/results/cards/PlanActionCard';\n     7→\n     8→// ============================================\n     9→// TYPES\n    10→// ============================================\n    11→\n    12→interface Threshold {\n    13→  operator: '<' | '>';\n    14→  value: number;\n    15→}\n    16→\n    17→interface TriggerRules {\n    18→  metrics: string[];\n    19→  condition: 'OR' | 'AND';\n    20→  thresholds: Record<string, Threshold>;\n    21→}\n    22→\n    23→interface PlanContent {\n    24→  description: string;\n    25→  cost_min: number;\n    26→  cost_max: number;\n    27→  time_min?: string;\n    28→  time_max?: string;\n    29→  risks?: string;\n    30→  citations?: string[];\n    31→  tags?: string[];\n    32→}\n    33→\n    34→interface RawPlan {\n    35→  id: string;\n    36→  title: string;\n    37→  trigger_rules: TriggerRules;\n    38→  content: PlanContent;\n    39→}\n    40→\n    41→interface TriggerResult {\n    42→  metric: string;\n    43→  value: number;\n    44→  threshold: number;\n    45→  operator: '<' | '>';\n    46→}\n    47→\n    48→// ============================================\n    49→// PLANS DATA (from plans.json)\n    50→// ============================================\n    51→\n    52→export const PLANS: RawPlan[] = [\n    53→  {\n    54→    id: \"jaw_fillers\",\n    55→    title: \"Jaw Fillers\",\n    56→    trigger_rules: {\n    57→      metrics: [\"Gonial Angle\", \"Bigonial Width\", \"Ramus to Mandible Ratio\"],\n    58→      condition: \"OR\",\n    59→      thresholds: {\n    60→        \"Gonial Angle\": { operator: \">\", value: 128.0 },\n    61→        \"Bigonial Width\": { operator: \"<\", value: 90.0 },\n    62→        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.5 }\n    63→      }\n    64→    },\n    65→    content: {\n    66→      description: \"Injectable fillers to enhance jawline definition, width, and projection.\",\n    67→      cost_min: 600,\n    68→      cost_max: 2500,\n    69→      time_min: \"6 months\",\n    70→      time_max: \"18 months\",\n    71→      risks: \"Vascular occlusion, asymmetry, swelling.\",\n    72→      citations: [\"Al-Khafaji et al., 2023\"],\n    73→      tags: [\"Minimally Invasive\"]\n    74→    }\n    75→  },\n    76→  {\n    77→    id: \"cheekbone_fillers\",\n    78→    title: \"Cheekbone Fillers\",\n    79→    trigger_rules: {\n    80→      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n    81→      condition: \"OR\",\n    82→      thresholds: {\n    83→        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n    84→        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.75 }\n    85→      }\n    86→    },\n    87→    content: {\n    88→      description: \"Enhances cheekbone prominence for better facial angularity and harmony.\",\n    89→      cost_min: 650,\n    90→      cost_max: 2500,\n    91→      time_min: \"6 months\",\n    92→      time_max: \"18 months\",\n    93→      risks: \"Asymmetry, filler migration.\",\n    94→      citations: [\"Trinh & Gupta, 2021\"],\n    95→      tags: [\"Minimally Invasive\"]\n    96→    }\n    97→  },\n    98→  {\n    99→    id: \"beard_growth\",\n   100→    title: \"Beard / Stubble Growth\",\n   101→    trigger_rules: {\n   102→      metrics: [\"Chin to Philtrum Ratio\", \"Gonial Angle\"],\n   103→      condition: \"OR\",\n   104→      thresholds: {\n   105→        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.8 },\n   106→        \"Gonial Angle\": { operator: \">\", value: 126.0 }\n   107→      }\n   108→    },\n   109→    content: {\n   110→      description: \"Grow dense stubble to camouflage weak chin projection or steep jawline.\",\n   111→      cost_min: 0,\n   112→      cost_max: 20,\n   113→      time_min: \"1 month\",\n   114→      time_max: \"3 months\",\n   115→      risks: \"None\",\n   116→      citations: [\"Dixson et al., 2016\"],\n   117→      tags: [\"Foundational\", \"Free\"]\n   118→    }\n   119→  },\n   120→  {\n   121→    id: \"lip_filler\",\n   122→    title: \"Lip Filler\",\n   123→    trigger_rules: {\n   124→      metrics: [\"Lower Lip to Upper Lip Ratio\"],\n   125→      condition: \"OR\",\n   126→      thresholds: {\n   127→        \"Lower Lip to Upper Lip Ratio\": { operator: \"<\", value: 1.0 }\n   128→      }\n   129→    },\n   130→    content: {\n   131→      description: \"Injectable filler to enhance volume and correct asymmetry.\",\n   132→      cost_min: 500,\n   133→      cost_max: 1200,\n   134→      time_min: \"6 months\",\n   135→      time_max: \"12 months\",\n   136→      risks: \"Migration, bruising.\",\n   137→      citations: [\"Hernandez et al., 2023\"],\n   138→      tags: [\"Minimally Invasive\"]\n   139→    }\n   140→  },\n   141→  {\n   142→    id: \"weight_loss_protocol\",\n   143→    title: \"Fat Loss Protocol (High Protein + Cardio)\",\n   144→    trigger_rules: {\n   145→      metrics: [\"Cheekbone Height\", \"Jaw Slope\"],\n   146→      condition: \"OR\",\n   147→      thresholds: {\n   148→        \"Cheekbone Height\": { operator: \"<\", value: 65.0 },\n   149→        \"Jaw Slope\": { operator: \">\", value: 140.0 }\n   150→      }\n   151→    },\n   152→    content: {\n   153→      description: \"High-protein diet combined with cardio to reduce facial bloat and reveal bone structure.\",\n   154→      cost_min: 200,\n   155→      cost_max: 1000,\n   156→      time_min: \"3 months\",\n   157→      time_max: \"12 months\",\n   158→      risks: \"None\",\n   159→      citations: [\"Moon & Koh, 2020\"],\n   160→      tags: [\"Foundational\"]\n   161→    }\n   162→  },\n   163→  {\n   164→    id: \"mewing_posture\",\n   165→    title: \"Mewing & Posture Correction\",\n   166→    trigger_rules: {\n   167→      metrics: [\"Midface Ratio\", \"Nasolabial Angle\"],\n   168→      condition: \"OR\",\n   169→      thresholds: {\n   170→        \"Midface Ratio\": { operator: \">\", value: 1.05 },\n   171→        \"Nasolabial Angle\": { operator: \"<\", value: 90.0 }\n   172→      }\n   173→    },\n   174→    content: {\n   175→      description: \"Proper tongue posture and body alignment to improve facial forward growth over time.\",\n   176→      cost_min: 0,\n   177→      cost_max: 0,\n   178→      time_min: \"12 months\",\n   179→      time_max: \"Lifetime\",\n   180→      risks: \"None if performed correctly.\",\n   181→      citations: [\"Mew J. et al., 2014\"],\n   182→      tags: [\"Foundational\", \"Free\"]\n   183→    }\n   184→  },\n   185→  {\n   186→    id: \"rhinoplasty\",\n   187→    title: \"Rhinoplasty\",\n   188→    trigger_rules: {\n   189→      metrics: [\"Nasal Projection\", \"Nasal W to H Ratio\", \"Nasolabial Angle\"],\n   190→      condition: \"OR\",\n   191→      thresholds: {\n   192→        \"Nasal Projection\": { operator: \">\", value: 0.75 },\n   193→        \"Nasal W to H Ratio\": { operator: \">\", value: 0.85 },\n   194→        \"Nasolabial Angle\": { operator: \"<\", value: 85.0 }\n   195→      }\n   196→    },\n   197→    content: {\n   198→      description: \"Surgical nose reshaping to improve proportion, projection, or correct a droopy tip.\",\n   199→      cost_min: 5000,\n   200→      cost_max: 15000,\n   201→      time_min: \"6 months\",\n   202→      time_max: \"12 months\",\n   203→      risks: \"Infection, asymmetry, breathing issues, revision surgery.\",\n   204→      citations: [\"Rohrich RJ et al., 2010\", \"Foda HM, 2008\"],\n   205→      tags: [\"Surgical\"]\n   206→    }\n   207→  },\n   208→  {\n   209→    id: \"genioplasty\",\n   210→    title: \"Sliding Genioplasty (Chin Surgery)\",\n   211→    trigger_rules: {\n   212→      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\"],\n   213→      condition: \"OR\",\n   214→      thresholds: {\n   215→        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.5 },\n   216→        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 15.0 }\n   217→      }\n   218→    },\n   219→    content: {\n   220→      description: \"Surgical advancement or reduction of the chin bone for improved facial balance.\",\n   221→      cost_min: 4000,\n   222→      cost_max: 12000,\n   223→      time_min: \"3 months\",\n   224→      time_max: \"12 months\",\n   225→      risks: \"Numbness, infection, asymmetry.\",\n   226→      citations: [\"Park JH et al., 2018\"],\n   227→      tags: [\"Surgical\"]\n   228→    }\n   229→  },\n   230→  {\n   231→    id: \"canthoplasty\",\n   232→    title: \"Canthoplasty (Eye Corner Surgery)\",\n   233→    trigger_rules: {\n   234→      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n   235→      condition: \"AND\",\n   236→      thresholds: {\n   237→        \"Lateral Canthal Tilt\": { operator: \"<\", value: 4.0 },\n   238→        \"Eye Aspect Ratio\": { operator: \"<\", value: 2.8 }\n   239→      }\n   240→    },\n   241→    content: {\n   242→      description: \"Surgical repositioning of the outer eye corner to create a more positive canthal tilt.\",\n   243→      cost_min: 3000,\n   244→      cost_max: 8000,\n   245→      time_min: \"2 months\",\n   246→      time_max: \"6 months\",\n   247→      risks: \"Scarring, asymmetry, dry eyes.\",\n   248→      citations: [\"Rhee SC et al., 2017\", \"Chen WP, 2016\"],\n   249→      tags: [\"Surgical\"]\n   250→    }\n   251→  },\n   252→  {\n   253→    id: \"brow_lift\",\n   254→    title: \"Brow Lift / Browridge Enhancement\",\n   255→    trigger_rules: {\n   256→      metrics: [\"Eyebrow Low Setedness\", \"Browridge Inclination Angle\"],\n   257→      condition: \"OR\",\n   258→      thresholds: {\n   259→        \"Eyebrow Low Setedness\": { operator: \">\", value: 2.0 },\n   260→        \"Browridge Inclination Angle\": { operator: \"<\", value: 10.0 }\n   261→      }\n   262→    },\n   263→    content: {\n   264→      description: \"Surgical or filler-based enhancement of brow position and browridge definition.\",\n   265→      cost_min: 1500,\n   266→      cost_max: 10000,\n   267→      time_min: \"1 month\",\n   268→      time_max: \"6 months\",\n   269→      risks: \"Asymmetry, numbness, unnatural appearance.\",\n   270→      citations: [\"Mendelson B et al., 2015\"],\n   271→      tags: [\"Surgical\", \"Minimally Invasive\"]\n   272→    }\n   273→  }\n   274→];\n   275→\n   276→// ============================================\n   277→// ADVICE ENGINE CLASS\n   278→// ============================================\n   279→\n   280→export class AdviceEngine {\n   281→  private plans: RawPlan[];\n   282→\n   283→  constructor(customPlans?: RawPlan[]) {\n   284→    this.plans = customPlans || PLANS;\n   285→  }\n   286→\n   287→  /**\n   288→   * Check if a single threshold condition is met\n   289→   */\n   290→  private checkThreshold(userValue: number, operator: '<' | '>', thresholdValue: number): boolean {\n   291→    if (operator === '<') {\n   292→      return userValue < thresholdValue;\n   293→    }\n   294→    return userValue > thresholdValue;\n   295→  }\n   296→\n   297→  /**\n   298→   * Evaluate trigger rules against user metrics\n   299→   */\n   300→  private evaluateTriggerRules(\n   301→    triggerRules: TriggerRules,\n   302→    metricsDict: Record<string, number>\n   303→  ): { isTriggered: boolean; triggeredMetrics: TriggerResult[] } {\n   304→    const { metrics, thresholds, condition } = triggerRules;\n   305→    const triggeredMetrics: TriggerResult[] = [];\n   306→    const results: boolean[] = [];\n   307→\n   308→    for (const metricName of metrics) {\n   309→      if (!(metricName in metricsDict)) continue;\n   310→      if (!(metricName in thresholds)) continue;\n   311→\n   312→      const userValue = metricsDict[metricName];\n   313→      const { operator, value: thresholdValue } = thresholds[metricName];\n   314→      const isMet = this.checkThreshold(userValue, operator, thresholdValue);\n   315→\n   316→      if (isMet) {\n   317→        triggeredMetrics.push({\n   318→          metric: metricName,\n   319→          value: userValue,\n   320→          threshold: thresholdValue,\n   321→          operator\n   322→        });\n   323→      }\n   324→\n   325→      results.push(isMet);\n   326→    }\n   327→\n   328→    const isTriggered = condition === 'AND'\n   329→      ? results.length > 0 && results.every(r => r)\n   330→      : results.some(r => r);\n   331→\n   332→    return { isTriggered, triggeredMetrics };\n   333→  }\n   334→\n   335→  /**\n   336→   * Get all recommendations that match the user's metrics\n   337→   *\n   338→   * @param metricsDict - Raw metric values\n   339→   * @param severityDict - Severity classifications (ideal/good/moderate/severe) for each metric\n   340→   *                       If a metric is 'ideal', it will NOT trigger remediation plans\n   341→   */\n   342→  getRecommendations(\n   343→    metricsDict: Record<string, number>,\n   344→    severityDict?: Record<string, string>\n   345→  ): Plan[] {\n   346→    const recommendations: Plan[] = [];\n   347→\n   348→    for (const rawPlan of this.plans) {\n   349→      const { isTriggered, triggeredMetrics } = this.evaluateTriggerRules(\n   350→        rawPlan.trigger_rules,\n   351→        metricsDict\n   352→      );\n   353→\n   354→      // If severity data is provided, filter out metrics that are already ideal\n   355→      if (isTriggered && severityDict) {\n   356→        // Check if ALL triggered metrics are outside ideal range\n   357→        const hasActualFlaw = triggeredMetrics.some(tm => {\n   358→          const severity = severityDict[tm.metric];\n   359→          // Only trigger if severity is NOT ideal (i.e., it's good/moderate/severe)\n   360→          return severity && severity !== 'ideal';\n   361→        });\n   362→\n   363→        // Skip this plan if all triggered metrics are already ideal\n   364→        if (!hasActualFlaw) {\n   365→          continue;\n   366→        }\n   367→      }\n   368→\n   369→      if (isTriggered) {\n   370→        recommendations.push({\n   371→          id: rawPlan.id,\n   372→          title: rawPlan.title,\n   373→          content: {\n   374→            description: rawPlan.content.description,\n   375→            cost_min: rawPlan.content.cost_min,\n   376→            cost_max: rawPlan.content.cost_max,\n   377→            time_min: rawPlan.content.time_min || 'Unknown',\n   378→            time_max: rawPlan.content.time_max || 'Unknown',\n   379→            risks: rawPlan.content.risks || 'Consult a professional.',\n   380→            citations: rawPlan.content.citations || [],\n   381→            tags: rawPlan.content.tags\n   382→          },\n   383→          trigger_reason: triggeredMetrics\n   384→        });\n   385→      }\n   386→    }\n   387→\n   388→    return recommendations;\n   389→  }\n   390→\n   391→  /**\n   392→   * Get recommendations sorted by cost (cheapest first)\n   393→   */\n   394→  getRecommendationsByCost(\n   395→    metricsDict: Record<string, number>,\n   396→    severityDict?: Record<string, string>\n   397→  ): Plan[] {\n   398→    return this.getRecommendations(metricsDict, severityDict).sort(\n   399→      (a, b) => a.content.cost_min - b.content.cost_min\n   400→    );\n   401→  }\n   402→\n   403→  /**\n   404→   * Get recommendations grouped by phase/tag\n   405→   */\n   406→  getRecommendationsByPhase(\n   407→    metricsDict: Record<string, number>,\n   408→    severityDict?: Record<string, string>\n   409→  ): Record<string, Plan[]> {\n   410→    const recommendations = this.getRecommendations(metricsDict, severityDict);\n   411→    const grouped: Record<string, Plan[]> = {\n   412→      'Foundational': [],\n   413→      'Minimally Invasive': [],\n   414→      'Surgical': []\n   415→    };\n   416→\n   417→    for (const rec of recommendations) {\n   418→      const tags = rec.content.tags || [];\n   419→      if (tags.includes('Foundational')) {\n   420→        grouped['Foundational'].push(rec);\n   421→      } else if (tags.includes('Surgical')) {\n   422→        grouped['Surgical'].push(rec);\n   423→      } else if (tags.includes('Minimally Invasive')) {\n   424→        grouped['Minimally Invasive'].push(rec);\n   425→      } else {\n   426→        grouped['Minimally Invasive'].push(rec); // Default\n   427→      }\n   428→    }\n   429→\n   430→    return grouped;\n   431→  }\n   432→}\n   433→\n   434→// ============================================\n   435→// SINGLETON INSTANCE\n   436→// ============================================\n   437→\n   438→export const adviceEngine = new AdviceEngine();\n   439→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2b91c175-2c77-46df-bab9-4af1d84b4150","timestamp":"2025-12-22T00:06:57.005Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts","content":"/**\n * Advice Engine - Client-side implementation matching the Python AdviceEngine\n * Processes plans.json trigger rules against user metrics\n */\n\nimport { Plan } from '@/components/results/cards/PlanActionCard';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface Threshold {\n  operator: '<' | '>';\n  value: number;\n}\n\ninterface TriggerRules {\n  metrics: string[];\n  condition: 'OR' | 'AND';\n  thresholds: Record<string, Threshold>;\n}\n\ninterface PlanContent {\n  description: string;\n  cost_min: number;\n  cost_max: number;\n  time_min?: string;\n  time_max?: string;\n  risks?: string;\n  citations?: string[];\n  tags?: string[];\n}\n\ninterface RawPlan {\n  id: string;\n  title: string;\n  trigger_rules: TriggerRules;\n  content: PlanContent;\n}\n\ninterface TriggerResult {\n  metric: string;\n  value: number;\n  threshold: number;\n  operator: '<' | '>';\n}\n\n// ============================================\n// PLANS DATA (from plans.json)\n// ============================================\n\nexport const PLANS: RawPlan[] = [\n  {\n    id: \"jaw_fillers\",\n    title: \"Jaw Fillers\",\n    trigger_rules: {\n      metrics: [\"Gonial Angle\", \"Bigonial Width\", \"Ramus to Mandible Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Gonial Angle\": { operator: \">\", value: 128.0 },\n        \"Bigonial Width\": { operator: \"<\", value: 90.0 },\n        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.5 }\n      }\n    },\n    content: {\n      description: \"Injectable fillers to enhance jawline definition, width, and projection.\",\n      cost_min: 600,\n      cost_max: 2500,\n      time_min: \"6 months\",\n      time_max: \"18 months\",\n      risks: \"Vascular occlusion, asymmetry, swelling.\",\n      citations: [\"Al-Khafaji et al., 2023\"],\n      tags: [\"Minimally Invasive\"]\n    }\n  },\n  {\n    id: \"cheekbone_fillers\",\n    title: \"Cheekbone Fillers\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.75 }\n      }\n    },\n    content: {\n      description: \"Enhances cheekbone prominence for better facial angularity and harmony.\",\n      cost_min: 650,\n      cost_max: 2500,\n      time_min: \"6 months\",\n      time_max: \"18 months\",\n      risks: \"Asymmetry, filler migration.\",\n      citations: [\"Trinh & Gupta, 2021\"],\n      tags: [\"Minimally Invasive\"]\n    }\n  },\n  {\n    id: \"beard_growth\",\n    title: \"Beard / Stubble Growth\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Gonial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.8 },\n        \"Gonial Angle\": { operator: \">\", value: 126.0 }\n      }\n    },\n    content: {\n      description: \"Grow dense stubble to camouflage weak chin projection or steep jawline.\",\n      cost_min: 0,\n      cost_max: 20,\n      time_min: \"1 month\",\n      time_max: \"3 months\",\n      risks: \"None\",\n      citations: [\"Dixson et al., 2016\"],\n      tags: [\"Foundational\", \"Free\"]\n    }\n  },\n  {\n    id: \"lip_filler\",\n    title: \"Lip Filler\",\n    trigger_rules: {\n      metrics: [\"Lower Lip to Upper Lip Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lower Lip to Upper Lip Ratio\": { operator: \"<\", value: 1.0 }\n      }\n    },\n    content: {\n      description: \"Injectable filler to enhance volume and correct asymmetry.\",\n      cost_min: 500,\n      cost_max: 1200,\n      time_min: \"6 months\",\n      time_max: \"12 months\",\n      risks: \"Migration, bruising.\",\n      citations: [\"Hernandez et al., 2023\"],\n      tags: [\"Minimally Invasive\"]\n    }\n  },\n  {\n    id: \"weight_loss_protocol\",\n    title: \"Fat Loss Protocol (High Protein + Cardio)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Jaw Slope\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 65.0 },\n        \"Jaw Slope\": { operator: \">\", value: 140.0 }\n      }\n    },\n    content: {\n      description: \"High-protein diet combined with cardio to reduce facial bloat and reveal bone structure.\",\n      cost_min: 200,\n      cost_max: 1000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"None\",\n      citations: [\"Moon & Koh, 2020\"],\n      tags: [\"Foundational\"]\n    }\n  },\n  {\n    id: \"mewing_posture\",\n    title: \"Mewing & Posture Correction\",\n    trigger_rules: {\n      metrics: [\"Midface Ratio\", \"Nasolabial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Midface Ratio\": { operator: \">\", value: 1.05 },\n        \"Nasolabial Angle\": { operator: \"<\", value: 90.0 }\n      }\n    },\n    content: {\n      description: \"Proper tongue posture and body alignment to improve facial forward growth over time.\",\n      cost_min: 0,\n      cost_max: 0,\n      time_min: \"12 months\",\n      time_max: \"Lifetime\",\n      risks: \"None if performed correctly.\",\n      citations: [\"Mew J. et al., 2014\"],\n      tags: [\"Foundational\", \"Free\"]\n    }\n  },\n  {\n    id: \"rhinoplasty\",\n    title: \"Rhinoplasty\",\n    trigger_rules: {\n      metrics: [\"Nasal Projection\", \"Nasal W to H Ratio\", \"Nasolabial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal Projection\": { operator: \">\", value: 0.75 },\n        \"Nasal W to H Ratio\": { operator: \">\", value: 0.85 },\n        \"Nasolabial Angle\": { operator: \"<\", value: 85.0 }\n      }\n    },\n    content: {\n      description: \"Surgical nose reshaping to improve proportion, projection, or correct a droopy tip.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"6 months\",\n      time_max: \"12 months\",\n      risks: \"Infection, asymmetry, breathing issues, revision surgery.\",\n      citations: [\"Rohrich RJ et al., 2010\", \"Foda HM, 2008\"],\n      tags: [\"Surgical\"]\n    }\n  },\n  {\n    id: \"genioplasty\",\n    title: \"Sliding Genioplasty (Chin Surgery)\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.5 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 15.0 }\n      }\n    },\n    content: {\n      description: \"Surgical advancement or reduction of the chin bone for improved facial balance.\",\n      cost_min: 4000,\n      cost_max: 12000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"Numbness, infection, asymmetry.\",\n      citations: [\"Park JH et al., 2018\"],\n      tags: [\"Surgical\"]\n    }\n  },\n  {\n    id: \"canthoplasty\",\n    title: \"Canthoplasty (Eye Corner Surgery)\",\n    trigger_rules: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Lateral Canthal Tilt\": { operator: \"<\", value: 4.0 },\n        \"Eye Aspect Ratio\": { operator: \"<\", value: 2.8 }\n      }\n    },\n    content: {\n      description: \"Surgical repositioning of the outer eye corner to create a more positive canthal tilt.\",\n      cost_min: 3000,\n      cost_max: 8000,\n      time_min: \"2 months\",\n      time_max: \"6 months\",\n      risks: \"Scarring, asymmetry, dry eyes.\",\n      citations: [\"Rhee SC et al., 2017\", \"Chen WP, 2016\"],\n      tags: [\"Surgical\"]\n    }\n  },\n  {\n    id: \"brow_lift\",\n    title: \"Brow Lift / Browridge Enhancement\",\n    trigger_rules: {\n      metrics: [\"Eyebrow Low Setedness\", \"Browridge Inclination Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Eyebrow Low Setedness\": { operator: \">\", value: 2.0 },\n        \"Browridge Inclination Angle\": { operator: \"<\", value: 10.0 }\n      }\n    },\n    content: {\n      description: \"Surgical or filler-based enhancement of brow position and browridge definition.\",\n      cost_min: 1500,\n      cost_max: 10000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Asymmetry, numbness, unnatural appearance.\",\n      citations: [\"Mendelson B et al., 2015\"],\n      tags: [\"Surgical\", \"Minimally Invasive\"]\n    }\n  }\n];\n\n// ============================================\n// ADVICE ENGINE CLASS\n// ============================================\n\nexport class AdviceEngine {\n  private plans: RawPlan[];\n\n  constructor(customPlans?: RawPlan[]) {\n    this.plans = customPlans || PLANS;\n  }\n\n  /**\n   * Check if a single threshold condition is met\n   */\n  private checkThreshold(userValue: number, operator: '<' | '>', thresholdValue: number): boolean {\n    if (operator === '<') {\n      return userValue < thresholdValue;\n    }\n    return userValue > thresholdValue;\n  }\n\n  /**\n   * Evaluate trigger rules against user metrics\n   */\n  private evaluateTriggerRules(\n    triggerRules: TriggerRules,\n    metricsDict: Record<string, number>\n  ): { isTriggered: boolean; triggeredMetrics: TriggerResult[] } {\n    const { metrics, thresholds, condition } = triggerRules;\n    const triggeredMetrics: TriggerResult[] = [];\n    const results: boolean[] = [];\n\n    for (const metricName of metrics) {\n      if (!(metricName in metricsDict)) continue;\n      if (!(metricName in thresholds)) continue;\n\n      const userValue = metricsDict[metricName];\n      const { operator, value: thresholdValue } = thresholds[metricName];\n      const isMet = this.checkThreshold(userValue, operator, thresholdValue);\n\n      if (isMet) {\n        triggeredMetrics.push({\n          metric: metricName,\n          value: userValue,\n          threshold: thresholdValue,\n          operator\n        });\n      }\n\n      results.push(isMet);\n    }\n\n    const isTriggered = condition === 'AND'\n      ? results.length > 0 && results.every(r => r)\n      : results.some(r => r);\n\n    return { isTriggered, triggeredMetrics };\n  }\n\n  /**\n   * Get all recommendations that match the user's metrics\n   *\n   * @param metricsDict - Raw metric values\n   * @param severityDict - Severity classifications (ideal/good/moderate/severe) for each metric\n   *                       If a metric is 'ideal', it will NOT trigger remediation plans\n   */\n  getRecommendations(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Plan[] {\n    const recommendations: Plan[] = [];\n\n    for (const rawPlan of this.plans) {\n      const { isTriggered, triggeredMetrics } = this.evaluateTriggerRules(\n        rawPlan.trigger_rules,\n        metricsDict\n      );\n\n      // If severity data is provided, filter out metrics that are already ideal\n      if (isTriggered && severityDict) {\n        // Check if ALL triggered metrics are outside ideal range\n        const hasActualFlaw = triggeredMetrics.some(tm => {\n          const severity = severityDict[tm.metric];\n          // Only trigger if severity is NOT ideal (i.e., it's good/moderate/severe)\n          return severity && severity !== 'ideal';\n        });\n\n        // Skip this plan if all triggered metrics are already ideal\n        if (!hasActualFlaw) {\n          continue;\n        }\n      }\n\n      if (isTriggered) {\n        recommendations.push({\n          id: rawPlan.id,\n          title: rawPlan.title,\n          content: {\n            description: rawPlan.content.description,\n            cost_min: rawPlan.content.cost_min,\n            cost_max: rawPlan.content.cost_max,\n            time_min: rawPlan.content.time_min || 'Unknown',\n            time_max: rawPlan.content.time_max || 'Unknown',\n            risks: rawPlan.content.risks || 'Consult a professional.',\n            citations: rawPlan.content.citations || [],\n            tags: rawPlan.content.tags\n          },\n          trigger_reason: triggeredMetrics\n        });\n      }\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Get recommendations sorted by cost (cheapest first)\n   */\n  getRecommendationsByCost(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Plan[] {\n    return this.getRecommendations(metricsDict, severityDict).sort(\n      (a, b) => a.content.cost_min - b.content.cost_min\n    );\n  }\n\n  /**\n   * Get recommendations grouped by phase/tag\n   */\n  getRecommendationsByPhase(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Record<string, Plan[]> {\n    const recommendations = this.getRecommendations(metricsDict, severityDict);\n    const grouped: Record<string, Plan[]> = {\n      'Foundational': [],\n      'Minimally Invasive': [],\n      'Surgical': []\n    };\n\n    for (const rec of recommendations) {\n      const tags = rec.content.tags || [];\n      if (tags.includes('Foundational')) {\n        grouped['Foundational'].push(rec);\n      } else if (tags.includes('Surgical')) {\n        grouped['Surgical'].push(rec);\n      } else if (tags.includes('Minimally Invasive')) {\n        grouped['Minimally Invasive'].push(rec);\n      } else {\n        grouped['Minimally Invasive'].push(rec); // Default\n      }\n    }\n\n    return grouped;\n  }\n}\n\n// ============================================\n// SINGLETON INSTANCE\n// ============================================\n\nexport const adviceEngine = new AdviceEngine();\n","numLines":439,"startLine":1,"totalLines":439}}}
{"parentUuid":"2b91c175-2c77-46df-bab9-4af1d84b4150","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'","is_error":true,"tool_use_id":"toolu_014g2sQAhJ8dyWDqeuNA12ke"}]},"uuid":"b86acc55-b89a-4f0d-a451-9ab3a4d1d3e1","timestamp":"2025-12-22T00:06:57.014Z","toolUseResult":"Error: ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'"}
{"parentUuid":"b86acc55-b89a-4f0d-a451-9ab3a4d1d3e1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'","is_error":true,"tool_use_id":"toolu_01N4n9mjY6E7PmRT6CidiG85"}]},"uuid":"d4ccc633-f75f-4521-bf4b-d112ba2be1cd","timestamp":"2025-12-22T00:06:57.014Z","toolUseResult":"Error: ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'"}
{"parentUuid":"d4ccc633-f75f-4521-bf4b-d112ba2be1cd","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'","is_error":true,"tool_use_id":"toolu_01TE9T2WNZfUoaTBEntd5o22"}]},"uuid":"38805ba4-8c34-4081-817d-14da1ca6e8ec","timestamp":"2025-12-22T00:06:57.014Z","toolUseResult":"Error: ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'"}
{"parentUuid":"38805ba4-8c34-4081-817d-14da1ca6e8ec","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KGH83MwnTN2pGYibQbcSAP","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useState, useCallback, useMemo } from 'react';\n     4→import { motion, AnimatePresence } from 'framer-motion';\n     5→import {\n     6→  ChevronDown,\n     7→  Clock,\n     8→  DollarSign,\n     9→  AlertTriangle,\n    10→  Target,\n    11→  Info,\n    12→  BookOpen,\n    13→  CheckCircle,\n    14→  Trash2,\n    15→  Plus,\n    16→  Sparkles,\n    17→  ExternalLink,\n    18→} from 'lucide-react';\n    19→import { Recommendation } from '@/types/results';\n    20→import { Gender, Ethnicity } from '@/lib/faceiq-scoring';\n    21→\n    22→// ============================================\n    23→// TYPES\n    24→// ============================================\n    25→\n    26→interface EnhancedRecommendationCardProps {\n    27→  recommendation: Recommendation;\n    28→  isExpanded?: boolean;\n    29→  onToggle?: () => void;\n    30→  rank?: number;\n    31→  onMarkComplete?: (id: string) => void;\n    32→  onRemove?: (id: string) => void;\n    33→  isCompleted?: boolean;\n    34→  gender?: Gender;\n    35→  ethnicity?: Ethnicity;\n    36→}\n    37→\n    38→// ============================================\n    39→// RESEARCH CITATIONS DATABASE\n    40→// ============================================\n    41→\n    42→interface ResearchCitation {\n    43→  title: string;\n    44→  authors: string;\n    45→  journal: string;\n    46→  year: number;\n    47→  doi?: string;\n    48→  summary: string;\n    49→  procedureRefs: string[];  // Matches recommendation ref_id\n    50→  genderRelevance?: 'male' | 'female' | 'both';\n    51→  ethnicityRelevance?: Ethnicity[];\n    52→}\n    53→\n    54→const RESEARCH_CITATIONS: ResearchCitation[] = [\n    55→  // Rhinoplasty Research\n    56→  {\n    57→    title: 'Ethnic Considerations in Rhinoplasty',\n    58→    authors: 'Rohrich RJ, Bolden K',\n    59→    journal: 'Plastic and Reconstructive Surgery',\n    60→    year: 2010,\n    61→    doi: '10.1097/PRS.0b013e3181c6b2b7',\n    62→    summary: 'Discusses the importance of preserving ethnic identity while achieving aesthetic goals in rhinoplasty across different ethnicities.',\n    63→    procedureRefs: ['SUR-02', 'MIN-04'],\n    64→    genderRelevance: 'both',\n    65→    ethnicityRelevance: ['black', 'east_asian', 'south_asian', 'middle_eastern', 'hispanic'],\n    66→  },\n    67→  {\n    68→    title: 'The Male Rhinoplasty',\n    69→    authors: 'Foda HM',\n    70→    journal: 'Facial Plastic Surgery',\n    71→    year: 2008,\n    72→    summary: 'Examines unique considerations for male rhinoplasty including maintaining masculine features and avoiding feminization.',\n    73→    procedureRefs: ['SUR-02', 'MIN-04'],\n    74→    genderRelevance: 'male',\n    75→  },\n    76→  // Jaw/Chin Research\n    77→  {\n    78→    title: 'Sliding Genioplasty: A Systematic Review',\n    79→    authors: 'Park JH, Tae-Hoon K',\n    80→    journal: 'Journal of Oral and Maxillofacial Surgery',\n    81→    year: 2018,\n    82→    summary: 'Comprehensive analysis of chin advancement outcomes and patient satisfaction rates across demographics.',\n    83→    procedureRefs: ['SUR-01', 'MIN-02'],\n    84→    genderRelevance: 'both',\n    85→  },\n    86→  {\n    87→    title: 'Gender Differences in Jaw Angle Aesthetics',\n    88→    authors: 'Kim YH, Cho J',\n    89→    journal: 'Aesthetic Plastic Surgery',\n    90→    year: 2020,\n    91→    summary: 'Research on ideal jaw angle parameters for males (90-110°) versus females (110-120°).',\n    92→    procedureRefs: ['SUR-03', 'MIN-03'],\n    93→    genderRelevance: 'both',\n    94→  },\n    95→  {\n    96→    title: 'Mandibular Angle Augmentation in Asian Patients',\n    97→    authors: 'Lee YJ, Park KS',\n    98→    journal: 'Asian Journal of Beauty and Cosmetology',\n    99→    year: 2019,\n   100→    summary: 'Study on jaw angle enhancement specific to East Asian facial structure and aesthetic preferences.',\n   101→    procedureRefs: ['SUR-03', 'MIN-03'],\n   102→    genderRelevance: 'both',\n   103→    ethnicityRelevance: ['east_asian', 'south_asian'],\n   104→  },\n   105→  // Lip Research\n   106→  {\n   107→    title: 'Ideal Lip Proportions Across Ethnicities',\n   108→    authors: 'Farkas LG, Katic MJ',\n   109→    journal: 'Aesthetic Surgery Journal',\n   110→    year: 2003,\n   111→    summary: 'Anthropometric study establishing ethnic-specific ideal lip ratios and proportions.',\n   112→    procedureRefs: ['MIN-01', 'FND-01'],\n   113→    genderRelevance: 'both',\n   114→    ethnicityRelevance: ['white', 'black', 'east_asian', 'hispanic'],\n   115→  },\n   116→  {\n   117→    title: 'Lip Enhancement in African American Patients',\n   118→    authors: 'Mack WP',\n   119→    journal: 'Facial Plastic Surgery Clinics',\n   120→    year: 2014,\n   121→    summary: 'Guidelines for maintaining ethnic characteristics while enhancing lip aesthetics.',\n   122→    procedureRefs: ['MIN-01'],\n   123→    genderRelevance: 'both',\n   124→    ethnicityRelevance: ['black'],\n   125→  },\n   126→  // Eye/Canthal Research\n   127→  {\n   128→    title: 'Canthal Tilt and Facial Attractiveness',\n   129→    authors: 'Rhee SC, et al.',\n   130→    journal: 'Plastic and Reconstructive Surgery',\n   131→    year: 2017,\n   132→    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n   133→    procedureRefs: ['SUR-05', 'MIN-04'],\n   134→    genderRelevance: 'both',\n   135→  },\n   136→  {\n   137→    title: 'Asian Blepharoplasty and Canthopexy',\n   138→    authors: 'Chen WP',\n   139→    journal: 'Ophthalmic Plastic Surgery',\n   140→    year: 2016,\n   141→    summary: 'Specific techniques for Asian eyelid surgery that preserve ethnic identity while enhancing eye shape.',\n   142→    procedureRefs: ['SUR-05'],\n   143→    genderRelevance: 'both',\n   144→    ethnicityRelevance: ['east_asian', 'south_asian'],\n   145→  },\n   146→  // Midface/Cheek Research\n   147→  {\n   148→    title: 'Cheekbone Enhancement for Facial Harmony',\n   149→    authors: 'Mendelson B, Wong CH',\n   150→    journal: 'Clinics in Plastic Surgery',\n   151→    year: 2015,\n   152→    summary: 'Analysis of malar augmentation effects on overall facial harmony and perceived attractiveness.',\n   153→    procedureRefs: ['SUR-06', 'MIN-05'],\n   154→    genderRelevance: 'both',\n   155→  },\n   156→  {\n   157→    title: 'Midface Aesthetics in Middle Eastern Populations',\n   158→    authors: 'Rohrich RJ, et al.',\n   159→    journal: 'Aesthetic Surgery Journal',\n   160→    year: 2021,\n   161→    summary: 'Ethnic considerations for midface enhancement in Middle Eastern patients.',\n   162→    procedureRefs: ['SUR-06', 'MIN-05'],\n   163→    genderRelevance: 'both',\n   164→    ethnicityRelevance: ['middle_eastern'],\n   165→  },\n   166→  // Foundational/Non-Surgical Research\n   167→  {\n   168→    title: 'Mewing and Orthotropic Treatment',\n   169→    authors: 'Mew J, Mew M',\n   170→    journal: 'International Journal of Orthodontics',\n   171→    year: 2014,\n   172→    summary: 'Research on proper tongue posture and its effects on facial development and structure.',\n   173→    procedureRefs: ['FND-02', 'FND-03'],\n   174→    genderRelevance: 'both',\n   175→  },\n   176→  {\n   177→    title: 'Effects of Body Composition on Facial Aesthetics',\n   178→    authors: 'Morrison CS, et al.',\n   179→    journal: 'Aesthetic Surgery Journal',\n   180→    year: 2017,\n   181→    summary: 'Study on how body fat percentage affects facial definition and perceived attractiveness.',\n   182→    procedureRefs: ['FND-04', 'FND-05'],\n   183→    genderRelevance: 'both',\n   184→  },\n   185→  {\n   186→    title: 'Grooming and First Impressions',\n   187→    authors: 'Phelan C, Etcoff N',\n   188→    journal: 'Journal of Applied Social Psychology',\n   189→    year: 2011,\n   190→    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n   191→    procedureRefs: ['FND-04', 'FND-05'],\n   192→    genderRelevance: 'both',\n   193→  },\n   194→  // Orthognathic Research\n   195→  {\n   196→    title: 'Bimaxillary Surgery Outcomes',\n   197→    authors: 'Rustemeyer J, et al.',\n   198→    journal: 'Journal of Cranio-Maxillofacial Surgery',\n   199→    year: 2019,\n   200→    summary: 'Long-term outcomes and patient satisfaction following double jaw surgery.',\n   201→    procedureRefs: ['SUR-04'],\n   202→    genderRelevance: 'both',\n   203→  },\n   204→  // General Attractiveness Research\n   205→  {\n   206→    title: 'Cross-Cultural Facial Attractiveness',\n   207→    authors: 'Perrett DI, et al.',\n   208→    journal: 'Nature',\n   209→    year: 1998,\n   210→    summary: 'Landmark study on universal vs. culture-specific aspects of facial attractiveness.',\n   211→    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06'],\n   212→    genderRelevance: 'both',\n   213→  },\n   214→  {\n   215→    title: 'Golden Ratios in Facial Beauty',\n   216→    authors: 'Marquardt SR',\n   217→    journal: 'International Journal of Cosmetic Surgery',\n   218→    year: 2002,\n   219→    summary: 'Analysis of mathematical proportions and their relationship to perceived facial beauty.',\n   220→    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06', 'MIN-01', 'MIN-02'],\n   221→    genderRelevance: 'both',\n   222→  },\n   223→];\n   224→\n   225→function getRelevantCitations(\n   226→  procedureRefId: string,\n   227→  gender?: Gender,\n   228→  ethnicity?: Ethnicity\n   229→): ResearchCitation[] {\n   230→  // Calculate relevance score for sorting\n   231→  function calculateRelevance(citation: ResearchCitation): number {\n   232→    let score = 0;\n   233→\n   234→    // Base score: procedure is in the list\n   235→    if (!citation.procedureRefs.includes(procedureRefId)) return -1;\n   236→\n   237→    // Procedure specificity: fewer refs = more specific to this procedure (+20 max)\n   238→    score += Math.max(0, 20 - (citation.procedureRefs.length * 3));\n   239→\n   240→    // Gender relevance scoring\n   241→    if (gender && citation.genderRelevance) {\n   242→      if (citation.genderRelevance === gender) {\n   243→        // Exact gender match - highest priority (+30)\n   244→        score += 30;\n   245→      } else if (citation.genderRelevance === 'both') {\n   246→        // General/both - neutral (+10)\n   247→        score += 10;\n   248→      } else {\n   249→        // Wrong gender - exclude\n   250→        return -1;\n   251→      }\n   252→    } else {\n   253→      // No gender specified or citation has no gender preference\n   254→      score += 10;\n   255→    }\n   256→\n   257→    // Ethnicity relevance scoring\n   258→    if (ethnicity && ethnicity !== 'other' && citation.ethnicityRelevance) {\n   259→      if (citation.ethnicityRelevance.includes(ethnicity)) {\n   260→        // Exact ethnicity match - high priority (+25)\n   261→        score += 25;\n   262→        // Bonus for ethnicity-specific studies (fewer ethnicities = more focused)\n   263→        score += Math.max(0, 15 - (citation.ethnicityRelevance.length * 2));\n   264→      } else {\n   265→        // Citation is ethnicity-specific but doesn't match user - lower priority\n   266→        // Still include unless very specific (1-2 ethnicities)\n   267→        if (citation.ethnicityRelevance.length <= 2) {\n   268→          return -1; // Too specific for different ethnicity\n   269→        }\n   270→        score += 5; // General enough to still be useful\n   271→      }\n   272→    } else {\n   273→      // No ethnicity filter or citation applies to all\n   274→      score += 10;\n   275→    }\n   276→\n   277→    // Recency bonus: newer studies slightly preferred\n   278→    const yearBonus = Math.max(0, (citation.year - 2000) * 0.5);\n   279→    score += yearBonus;\n   280→\n   281→    return score;\n   282→  }\n   283→\n   284→  // Filter, score, sort, and take top 3\n   285→  return RESEARCH_CITATIONS\n   286→    .map(citation => ({ citation, relevance: calculateRelevance(citation) }))\n   287→    .filter(item => item.relevance >= 0)\n   288→    .sort((a, b) => b.relevance - a.relevance)\n   289→    .slice(0, 3)\n   290→    .map(item => item.citation);\n   291→}\n   292→\n   293→interface TrackerState {\n   294→  notes: string;\n   295→  checklist: Array<{ id: string; text: string; completed: boolean }>;\n   296→}\n   297→\n   298→// ============================================\n   299→// PHASE BADGE (Dark Theme)\n   300→// ============================================\n   301→\n   302→function PhaseBadge({ phase }: { phase: string }) {\n   303→  const getPhaseConfig = () => {\n   304→    switch (phase) {\n   305→      case 'Foundational':\n   306→        return {\n   307→          bg: 'bg-emerald-500/20',\n   308→          text: 'text-emerald-400',\n   309→          border: 'border-emerald-500/30',\n   310→        };\n   311→      case 'Minimally Invasive':\n   312→        return {\n   313→          bg: 'bg-blue-500/20',\n   314→          text: 'text-blue-400',\n   315→          border: 'border-blue-500/30',\n   316→        };\n   317→      case 'Surgical':\n   318→        return {\n   319→          bg: 'bg-purple-500/20',\n   320→          text: 'text-purple-400',\n   321→          border: 'border-purple-500/30',\n   322→        };\n   323→      default:\n   324→        return {\n   325→          bg: 'bg-neutral-500/20',\n   326→          text: 'text-neutral-400',\n   327→          border: 'border-neutral-500/30',\n   328→        };\n   329→    }\n   330→  };\n   331→\n   332→  const config = getPhaseConfig();\n   333→\n   334→  return (\n   335→    <span\n   336→      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}\n   337→    >\n   338→      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}\n   339→    </span>\n   340→  );\n   341→}\n   342→\n   343→// ============================================\n   344→// IMPACT BADGE\n   345→// ============================================\n   346→\n   347→function ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {\n   348→  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);\n   349→\n   350→  return (\n   351→    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n   352→      <span className=\"flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0\">\n   353→        <Sparkles className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n   354→        {formattedImpact}\n   355→      </span>\n   356→      {(frontImpact !== undefined || sideImpact !== undefined) && (\n   357→        <span className=\"hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0\">\n   358→          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n   359→            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}\n   360→          </span>\n   361→          <span className=\"text-neutral-600\">|</span>\n   362→          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n   363→            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}\n   364→          </span>\n   365→        </span>\n   366→      )}\n   367→    </div>\n   368→  );\n   369→}\n   370→\n   371→// ============================================\n   372→// IMPROVEMENT TAG\n   373→// ============================================\n   374→\n   375→function ImprovementTag({ text }: { text: string }) {\n   376→  return (\n   377→    <div className=\"inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm\">\n   378→      <CheckCircle className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0\" />\n   379→      <span className=\"truncate\">{text}</span>\n   380→    </div>\n   381→  );\n   382→}\n   383→\n   384→// ============================================\n   385→// SECTION HEADER\n   386→// ============================================\n   387→\n   388→function SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {\n   389→  return (\n   390→    <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3\">\n   391→      <Icon className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n   392→      {title}\n   393→    </h4>\n   394→  );\n   395→}\n   396→\n   397→// ============================================\n   398→// MY TRACKER SECTION\n   399→// ============================================\n   400→\n   401→function MyTracker({\n   402→  tracker,\n   403→  onNotesChange,\n   404→  onAddChecklistItem,\n   405→  onToggleChecklistItem,\n   406→  onRemoveChecklistItem\n   407→}: {\n   408→  tracker: TrackerState;\n   409→  onNotesChange: (notes: string) => void;\n   410→  onAddChecklistItem: () => void;\n   411→  onToggleChecklistItem: (id: string) => void;\n   412→  onRemoveChecklistItem: (id: string) => void;\n   413→}) {\n   414→  return (\n   415→    <div className=\"md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full\">\n   416→      <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4\">\n   417→        <BookOpen className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n   418→        My Tracker\n   419→      </h4>\n   420→      <div className=\"space-y-3 sm:space-y-4\">\n   421→        {/* Personal Notes */}\n   422→        <div className=\"space-y-1 sm:space-y-1.5\">\n   423→          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400\">Personal Notes</label>\n   424→          <textarea\n   425→            value={tracker.notes}\n   426→            onChange={(e) => onNotesChange(e.target.value)}\n   427→            className=\"w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all\"\n   428→            placeholder=\"Track progress, questions, dates...\"\n   429→          />\n   430→        </div>\n   431→\n   432→        {/* Checklist */}\n   433→        <div className=\"space-y-1.5 sm:space-y-2 pt-1 sm:pt-2\">\n   434→          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center\">\n   435→            <span>Checklist</span>\n   436→            <button\n   437→              onClick={onAddChecklistItem}\n   438→              className=\"text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors\"\n   439→            >\n   440→              <Plus className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n   441→              Add\n   442→            </button>\n   443→          </label>\n   444→          <div className=\"space-y-1.5 sm:space-y-2\">\n   445→            {tracker.checklist.length === 0 ? (\n   446→              <div className=\"text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50\">\n   447→                No tasks yet\n   448→              </div>\n   449→            ) : (\n   450→              tracker.checklist.map((item) => (\n   451→                <div\n   452→                  key={item.id}\n   453→                  className=\"flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg\"\n   454→                >\n   455→                  <button\n   456→                    onClick={() => onToggleChecklistItem(item.id)}\n   457→                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${\n   458→                      item.completed\n   459→                        ? 'bg-emerald-500 border-emerald-500'\n   460→                        : 'border-neutral-600 hover:border-neutral-500'\n   461→                    }`}\n   462→                  >\n   463→                    {item.completed && <CheckCircle className=\"w-3 h-3 text-black\" />}\n   464→                  </button>\n   465→                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>\n   466→                    {item.text}\n   467→                  </span>\n   468→                  <button\n   469→                    onClick={() => onRemoveChecklistItem(item.id)}\n   470→                    className=\"text-neutral-600 hover:text-red-400 transition-colors\"\n   471→                  >\n   472→                    <Trash2 className=\"w-3 h-3\" />\n   473→                  </button>\n   474→                </div>\n   475→              ))\n   476→            )}\n   477→          </div>\n   478→        </div>\n   479→      </div>\n   480→    </div>\n   481→  );\n   482→}\n   483→\n   484→// ============================================\n   485→// MAIN ENHANCED RECOMMENDATION CARD\n   486→// ============================================\n   487→\n   488→export function EnhancedRecommendationCard({\n   489→  recommendation,\n   490→  isExpanded = false,\n   491→  onToggle,\n   492→  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n   493→  rank,\n   494→  onMarkComplete,\n   495→  onRemove,\n   496→  isCompleted = false,\n   497→  gender,\n   498→  ethnicity,\n   499→}: EnhancedRecommendationCardProps) {\n   500→  // Tracker state (would be persisted in real app)\n   501→  const [tracker, setTracker] = useState<TrackerState>({\n   502→    notes: '',\n   503→    checklist: [],\n   504→  });\n   505→\n   506→  // Get relevant research citations based on procedure, gender, and ethnicity\n   507→  const citations = useMemo(() => {\n   508→    return getRelevantCitations(recommendation.ref_id, gender, ethnicity);\n   509→  }, [recommendation.ref_id, gender, ethnicity]);\n   510→\n   511→  const handleNotesChange = useCallback((notes: string) => {\n   512→    setTracker(prev => ({ ...prev, notes }));\n   513→  }, []);\n   514→\n   515→  const handleAddChecklistItem = useCallback(() => {\n   516→    const text = window.prompt('Enter task:');\n   517→    if (text) {\n   518→      setTracker(prev => ({\n   519→        ...prev,\n   520→        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],\n   521→      }));\n   522→    }\n   523→  }, []);\n   524→\n   525→  const handleToggleChecklistItem = useCallback((id: string) => {\n   526→    setTracker(prev => ({\n   527→      ...prev,\n   528→      checklist: prev.checklist.map(item =>\n   529→        item.id === id ? { ...item, completed: !item.completed } : item\n   530→      ),\n   531→    }));\n   532→  }, []);\n   533→\n   534→  const handleRemoveChecklistItem = useCallback((id: string) => {\n   535→    setTracker(prev => ({\n   536→      ...prev,\n   537→      checklist: prev.checklist.filter(item => item.id !== id),\n   538→    }));\n   539→  }, []);\n   540→\n   541→  // Format cost\n   542→  const formatCost = () => {\n   543→    const { min, max, type } = recommendation.cost;\n   544→    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';\n   545→    if (min === max) {\n   546→      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n   547→    }\n   548→    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n   549→  };\n   550→\n   551→  // Format timeline\n   552→  const formatTimeline = () => {\n   553→    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;\n   554→    if (full_results_weeks_max) {\n   555→      return `${full_results_weeks}-${full_results_weeks_max} weeks`;\n   556→    }\n   557→    if (full_results_weeks >= 52) {\n   558→      const months = Math.round(full_results_weeks / 4);\n   559→      return `${months} months`;\n   560→    }\n   561→    return `${full_results_weeks} weeks`;\n   562→  };\n   563→\n   564→  // Get effectiveness level\n   565→  const getEffectiveness = () => {\n   566→    if (recommendation.impact >= 0.7) return 'high';\n   567→    if (recommendation.impact >= 0.4) return 'moderate';\n   568→    return 'low';\n   569→  };\n   570→\n   571→  return (\n   572→    <motion.div\n   573→      layout\n   574→      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${\n   575→        isExpanded\n   576→          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'\n   577→          : 'border-neutral-800 hover:border-neutral-700'\n   578→      } ${isCompleted ? 'opacity-60' : ''}`}\n   579→    >\n   580→      {/* Header - Clickable */}\n   581→      <div className=\"p-3.5 sm:p-5 cursor-pointer\" onClick={onToggle}>\n   582→        <div className=\"space-y-3 sm:space-y-4\">\n   583→          <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4\">\n   584→            <div className=\"flex-1 min-w-0\">\n   585→              <div className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2\">\n   586→                <h3 className=\"text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white\">\n   587→                  {recommendation.name}\n   588→                </h3>\n   589→                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n   590→                  <PhaseBadge phase={recommendation.phase} />\n   591→                  <ImpactBadge impact={recommendation.impact} />\n   592→                </div>\n   593→              </div>\n   594→              <p className=\"text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none\">\n   595→                {recommendation.description}\n   596→              </p>\n   597→            </div>\n   598→\n   599→            {/* Action buttons */}\n   600→            <div className=\"flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto\">\n   601→              {onMarkComplete && (\n   602→                <button\n   603→                  onClick={(e) => {\n   604→                    e.stopPropagation();\n   605→                    onMarkComplete(recommendation.ref_id);\n   606→                  }}\n   607→                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${\n   608→                    isCompleted\n   609→                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'\n   610→                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'\n   611→                  }`}\n   612→                  title=\"Mark as complete\"\n   613→                >\n   614→                  <CheckCircle className=\"w-4 h-4\" />\n   615→                </button>\n   616→              )}\n   617→              {onRemove && (\n   618→                <button\n   619→                  onClick={(e) => {\n   620→                    e.stopPropagation();\n   621→                    onRemove(recommendation.ref_id);\n   622→                  }}\n   623→                  className=\"p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10\"\n   624→                  title=\"Remove action\"\n   625→                >\n   626→                  <Trash2 className=\"w-4 h-4\" />\n   627→                </button>\n   628→              )}\n   629→            </div>\n   630→          </div>\n   631→\n   632→          {/* Quick stats row */}\n   633→          <div className=\"flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400\">\n   634→            <div className=\"flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5\">\n   635→              <div className=\"flex items-center gap-1 sm:gap-1.5\" title=\"Estimated Cost\">\n   636→                <DollarSign className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n   637→                <span className=\"font-medium text-neutral-300\">{formatCost()}</span>\n   638→              </div>\n   639→              {recommendation.timeline.full_results_weeks > 0 && (\n   640→                <div className=\"flex items-center gap-1 sm:gap-1.5\">\n   641→                  <Clock className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n   642→                  <span className=\"font-medium text-neutral-300\">{formatTimeline()}</span>\n   643→                </div>\n   644→              )}\n   645→            </div>\n   646→            <button\n   647→              className=\"flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white\"\n   648→            >\n   649→              {isExpanded ? 'Less' : 'More'}\n   650→              <ChevronDown\n   651→                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n   652→              />\n   653→            </button>\n   654→          </div>\n   655→        </div>\n   656→      </div>\n   657→\n   658→      {/* Expanded Content */}\n   659→      <AnimatePresence initial={false}>\n   660→        {isExpanded && (\n   661→          <motion.div\n   662→            initial={{ height: 0, opacity: 0 }}\n   663→            animate={{ height: 'auto', opacity: 1 }}\n   664→            exit={{ height: 0, opacity: 0 }}\n   665→            transition={{ duration: 0.3 }}\n   666→            className=\"overflow-hidden\"\n   667→          >\n   668→            <div className=\"border-t border-neutral-800 bg-neutral-900/50\">\n   669→              <div className=\"grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800\">\n   670→                {/* Main Content */}\n   671→                <div className=\"md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6\">\n   672→                  {/* Improvements */}\n   673→                  <div>\n   674→                    <SectionHeader icon={Target} title=\"Improvements\" />\n   675→                    <div className=\"space-y-2 sm:space-y-3\">\n   676→                      <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\n   677→                        {recommendation.matchedFlaws.map((flaw, i) => (\n   678→                          <ImprovementTag key={i} text={flaw} />\n   679→                        ))}\n   680→                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (\n   681→                          <ImprovementTag key={i} text={ratio} />\n   682→                        ))}\n   683→                      </div>\n   684→                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n   685→                        <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n   686→                          <div className=\"text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase\">Effectiveness</div>\n   687→                          <div className=\"h-1 w-1 rounded-full bg-neutral-600\" />\n   688→                          <div className=\"font-medium text-white capitalize text-xs sm:text-sm\">{getEffectiveness()}</div>\n   689→                        </div>\n   690→                      </div>\n   691→                    </div>\n   692→                  </div>\n   693→\n   694→                  {/* How It Helps */}\n   695→                  <div>\n   696→                    <SectionHeader icon={Info} title=\"How It Helps\" />\n   697→                    <div className=\"space-y-1.5 sm:space-y-2\">\n   698→                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n   699→                        <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n   700→                          {recommendation.description}\n   701→                        </p>\n   702→                      </div>\n   703→                      {recommendation.ratios_impacted.length > 0 && (\n   704→                        <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n   705→                          <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n   706→                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}\n   707→                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.\n   708→                          </p>\n   709→                        </div>\n   710→                      )}\n   711→                    </div>\n   712→                  </div>\n   713→\n   714→                  {/* Logistics & Timeline */}\n   715→                  {recommendation.timeline.full_results_weeks > 0 && (\n   716→                    <div>\n   717→                      <SectionHeader icon={Clock} title=\"Logistics & Timeline\" />\n   718→                      <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\n   719→                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n   720→                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n   721→                            Effect Starts\n   722→                          </span>\n   723→                          <span className=\"text-xs sm:text-sm font-medium text-white capitalize\">\n   724→                            {recommendation.timeline.effect_start}\n   725→                          </span>\n   726→                        </div>\n   727→                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n   728→                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n   729→                            Full Results\n   730→                          </span>\n   731→                          <span className=\"text-xs sm:text-sm font-medium text-white\">\n   732→                            {formatTimeline()}\n   733→                          </span>\n   734→                        </div>\n   735→                      </div>\n   736→                    </div>\n   737→                  )}\n   738→\n   739→                  {/* Considerations */}\n   740→                  <div>\n   741→                    <SectionHeader icon={AlertTriangle} title=\"Considerations\" />\n   742→                    <div className=\"space-y-2 sm:space-y-3\">\n   743→                      {/* Prerequisites */}\n   744→                      {recommendation.warnings.length > 0 && (\n   745→                        <div className=\"bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm\">\n   746→                          <span className=\"font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">Prerequisites</span>\n   747→                          <p className=\"text-blue-300/80 text-[11px] sm:text-xs leading-relaxed\">\n   748→                            {recommendation.warnings[0]}\n   749→                          </p>\n   750→                        </div>\n   751→                      )}\n   752→\n   753→                      {/* Risks & Side Effects */}\n   754→                      {recommendation.risks_side_effects && (\n   755→                        <div className=\"bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm\">\n   756→                          <span className=\"font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">\n   757→                            Risks & Side Effects\n   758→                          </span>\n   759→                          <p className=\"text-amber-300/80 text-[11px] sm:text-xs leading-relaxed\">\n   760→                            {recommendation.risks_side_effects}\n   761→                          </p>\n   762→                        </div>\n   763→                      )}\n   764→                    </div>\n   765→                  </div>\n   766→\n   767→                  {/* Notes & Warnings */}\n   768→                  {recommendation.warnings.length > 1 && (\n   769→                    <div className=\"text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic\">\n   770→                      {recommendation.warnings.slice(1).join(' ')}\n   771→                    </div>\n   772→                  )}\n   773→\n   774→                  {/* Research Citations */}\n   775→                  <div className=\"bg-cyan-500/10 p-3 sm:p-4 rounded-lg border border-cyan-500/30\">\n   776→                    <div className=\"flex items-center gap-2 mb-3\">\n   777→                      <BookOpen size={14} className=\"text-cyan-400\" />\n   778→                      <span className=\"font-semibold text-cyan-400 text-xs sm:text-sm\">Research & Evidence</span>\n   779→                      {ethnicity && ethnicity !== 'other' && (\n   780→                        <span className=\"text-[9px] px-1.5 py-0.5 bg-cyan-500/20 rounded text-cyan-300 capitalize\">\n   781→                          {ethnicity.replace('_', ' ')} focus\n   782→                        </span>\n   783→                      )}\n   784→                    </div>\n   785→                    {citations.length > 0 ? (\n   786→                      <div className=\"space-y-2.5\">\n   787→                        {citations.map((citation, idx) => (\n   788→                          <div key={idx} className=\"text-[11px] sm:text-xs bg-neutral-900/50 p-2.5 rounded-lg border border-neutral-700/50\">\n   789→                            <div className=\"flex items-start justify-between gap-2\">\n   790→                              <div className=\"flex-1\">\n   791→                                <div className=\"font-medium text-cyan-300 mb-0.5 line-clamp-2\">\n   792→                                  {citation.title}\n   793→                                </div>\n   794→                                <div className=\"text-neutral-500 text-[10px] mb-1\">\n   795→                                  {citation.authors} • {citation.journal} ({citation.year})\n   796→                                </div>\n   797→                                <div className=\"text-neutral-400 leading-relaxed\">\n   798→                                  {citation.summary}\n   799→                                </div>\n   800→                              </div>\n   801→                              {citation.doi && (\n   802→                                <a\n   803→                                  href={`https://doi.org/${citation.doi}`}\n   804→                                  target=\"_blank\"\n   805→                                  rel=\"noopener noreferrer\"\n   806→                                  className=\"flex-shrink-0 p-1 text-cyan-400 hover:text-cyan-300 transition-colors\"\n   807→                                  title=\"View full paper\"\n   808→                                >\n   809→                                  <ExternalLink size={12} />\n   810→                                </a>\n   811→                              )}\n   812→                            </div>\n   813→                          </div>\n   814→                        ))}\n   815→                      </div>\n   816→                    ) : (\n   817→                      <div className=\"text-[11px] sm:text-xs text-cyan-300/70\">\n   818→                        {recommendation.matchedFlaws.length > 0\n   819→                          ? 'Based on facial analysis and established aesthetic research. More specific citations coming soon.'\n   820→                          : 'No specific research citations available for this recommendation.'}\n   821→                      </div>\n   822→                    )}\n   823→                  </div>\n   824→                </div>\n   825→\n   826→                {/* My Tracker Sidebar */}\n   827→                <MyTracker\n   828→                  tracker={tracker}\n   829→                  onNotesChange={handleNotesChange}\n   830→                  onAddChecklistItem={handleAddChecklistItem}\n   831→                  onToggleChecklistItem={handleToggleChecklistItem}\n   832→                  onRemoveChecklistItem={handleRemoveChecklistItem}\n   833→                />\n   834→              </div>\n   835→            </div>\n   836→          </motion.div>\n   837→        )}\n   838→      </AnimatePresence>\n   839→    </motion.div>\n   840→  );\n   841→}\n   842→\n   843→export default EnhancedRecommendationCard;\n   844→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7eaa2591-4d55-4911-99ec-932fb27996c8","timestamp":"2025-12-22T00:06:57.140Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","content":"'use client';\n\nimport { useState, useCallback, useMemo } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  ChevronDown,\n  Clock,\n  DollarSign,\n  AlertTriangle,\n  Target,\n  Info,\n  BookOpen,\n  CheckCircle,\n  Trash2,\n  Plus,\n  Sparkles,\n  ExternalLink,\n} from 'lucide-react';\nimport { Recommendation } from '@/types/results';\nimport { Gender, Ethnicity } from '@/lib/faceiq-scoring';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface EnhancedRecommendationCardProps {\n  recommendation: Recommendation;\n  isExpanded?: boolean;\n  onToggle?: () => void;\n  rank?: number;\n  onMarkComplete?: (id: string) => void;\n  onRemove?: (id: string) => void;\n  isCompleted?: boolean;\n  gender?: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// RESEARCH CITATIONS DATABASE\n// ============================================\n\ninterface ResearchCitation {\n  title: string;\n  authors: string;\n  journal: string;\n  year: number;\n  doi?: string;\n  summary: string;\n  procedureRefs: string[];  // Matches recommendation ref_id\n  genderRelevance?: 'male' | 'female' | 'both';\n  ethnicityRelevance?: Ethnicity[];\n}\n\nconst RESEARCH_CITATIONS: ResearchCitation[] = [\n  // Rhinoplasty Research\n  {\n    title: 'Ethnic Considerations in Rhinoplasty',\n    authors: 'Rohrich RJ, Bolden K',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2010,\n    doi: '10.1097/PRS.0b013e3181c6b2b7',\n    summary: 'Discusses the importance of preserving ethnic identity while achieving aesthetic goals in rhinoplasty across different ethnicities.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black', 'east_asian', 'south_asian', 'middle_eastern', 'hispanic'],\n  },\n  {\n    title: 'The Male Rhinoplasty',\n    authors: 'Foda HM',\n    journal: 'Facial Plastic Surgery',\n    year: 2008,\n    summary: 'Examines unique considerations for male rhinoplasty including maintaining masculine features and avoiding feminization.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'male',\n  },\n  // Jaw/Chin Research\n  {\n    title: 'Sliding Genioplasty: A Systematic Review',\n    authors: 'Park JH, Tae-Hoon K',\n    journal: 'Journal of Oral and Maxillofacial Surgery',\n    year: 2018,\n    summary: 'Comprehensive analysis of chin advancement outcomes and patient satisfaction rates across demographics.',\n    procedureRefs: ['SUR-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Gender Differences in Jaw Angle Aesthetics',\n    authors: 'Kim YH, Cho J',\n    journal: 'Aesthetic Plastic Surgery',\n    year: 2020,\n    summary: 'Research on ideal jaw angle parameters for males (90-110°) versus females (110-120°).',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Mandibular Angle Augmentation in Asian Patients',\n    authors: 'Lee YJ, Park KS',\n    journal: 'Asian Journal of Beauty and Cosmetology',\n    year: 2019,\n    summary: 'Study on jaw angle enhancement specific to East Asian facial structure and aesthetic preferences.',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Lip Research\n  {\n    title: 'Ideal Lip Proportions Across Ethnicities',\n    authors: 'Farkas LG, Katic MJ',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2003,\n    summary: 'Anthropometric study establishing ethnic-specific ideal lip ratios and proportions.',\n    procedureRefs: ['MIN-01', 'FND-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['white', 'black', 'east_asian', 'hispanic'],\n  },\n  {\n    title: 'Lip Enhancement in African American Patients',\n    authors: 'Mack WP',\n    journal: 'Facial Plastic Surgery Clinics',\n    year: 2014,\n    summary: 'Guidelines for maintaining ethnic characteristics while enhancing lip aesthetics.',\n    procedureRefs: ['MIN-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black'],\n  },\n  // Eye/Canthal Research\n  {\n    title: 'Canthal Tilt and Facial Attractiveness',\n    authors: 'Rhee SC, et al.',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2017,\n    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n    procedureRefs: ['SUR-05', 'MIN-04'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Asian Blepharoplasty and Canthopexy',\n    authors: 'Chen WP',\n    journal: 'Ophthalmic Plastic Surgery',\n    year: 2016,\n    summary: 'Specific techniques for Asian eyelid surgery that preserve ethnic identity while enhancing eye shape.',\n    procedureRefs: ['SUR-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Midface/Cheek Research\n  {\n    title: 'Cheekbone Enhancement for Facial Harmony',\n    authors: 'Mendelson B, Wong CH',\n    journal: 'Clinics in Plastic Surgery',\n    year: 2015,\n    summary: 'Analysis of malar augmentation effects on overall facial harmony and perceived attractiveness.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Midface Aesthetics in Middle Eastern Populations',\n    authors: 'Rohrich RJ, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2021,\n    summary: 'Ethnic considerations for midface enhancement in Middle Eastern patients.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['middle_eastern'],\n  },\n  // Foundational/Non-Surgical Research\n  {\n    title: 'Mewing and Orthotropic Treatment',\n    authors: 'Mew J, Mew M',\n    journal: 'International Journal of Orthodontics',\n    year: 2014,\n    summary: 'Research on proper tongue posture and its effects on facial development and structure.',\n    procedureRefs: ['FND-02', 'FND-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Effects of Body Composition on Facial Aesthetics',\n    authors: 'Morrison CS, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2017,\n    summary: 'Study on how body fat percentage affects facial definition and perceived attractiveness.',\n    procedureRefs: ['FND-04', 'FND-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Grooming and First Impressions',\n    authors: 'Phelan C, Etcoff N',\n    journal: 'Journal of Applied Social Psychology',\n    year: 2011,\n    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n    procedureRefs: ['FND-04', 'FND-05'],\n    genderRelevance: 'both',\n  },\n  // Orthognathic Research\n  {\n    title: 'Bimaxillary Surgery Outcomes',\n    authors: 'Rustemeyer J, et al.',\n    journal: 'Journal of Cranio-Maxillofacial Surgery',\n    year: 2019,\n    summary: 'Long-term outcomes and patient satisfaction following double jaw surgery.',\n    procedureRefs: ['SUR-04'],\n    genderRelevance: 'both',\n  },\n  // General Attractiveness Research\n  {\n    title: 'Cross-Cultural Facial Attractiveness',\n    authors: 'Perrett DI, et al.',\n    journal: 'Nature',\n    year: 1998,\n    summary: 'Landmark study on universal vs. culture-specific aspects of facial attractiveness.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Golden Ratios in Facial Beauty',\n    authors: 'Marquardt SR',\n    journal: 'International Journal of Cosmetic Surgery',\n    year: 2002,\n    summary: 'Analysis of mathematical proportions and their relationship to perceived facial beauty.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06', 'MIN-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n];\n\nfunction getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  // Calculate relevance score for sorting\n  function calculateRelevance(citation: ResearchCitation): number {\n    let score = 0;\n\n    // Base score: procedure is in the list\n    if (!citation.procedureRefs.includes(procedureRefId)) return -1;\n\n    // Procedure specificity: fewer refs = more specific to this procedure (+20 max)\n    score += Math.max(0, 20 - (citation.procedureRefs.length * 3));\n\n    // Gender relevance scoring\n    if (gender && citation.genderRelevance) {\n      if (citation.genderRelevance === gender) {\n        // Exact gender match - highest priority (+30)\n        score += 30;\n      } else if (citation.genderRelevance === 'both') {\n        // General/both - neutral (+10)\n        score += 10;\n      } else {\n        // Wrong gender - exclude\n        return -1;\n      }\n    } else {\n      // No gender specified or citation has no gender preference\n      score += 10;\n    }\n\n    // Ethnicity relevance scoring\n    if (ethnicity && ethnicity !== 'other' && citation.ethnicityRelevance) {\n      if (citation.ethnicityRelevance.includes(ethnicity)) {\n        // Exact ethnicity match - high priority (+25)\n        score += 25;\n        // Bonus for ethnicity-specific studies (fewer ethnicities = more focused)\n        score += Math.max(0, 15 - (citation.ethnicityRelevance.length * 2));\n      } else {\n        // Citation is ethnicity-specific but doesn't match user - lower priority\n        // Still include unless very specific (1-2 ethnicities)\n        if (citation.ethnicityRelevance.length <= 2) {\n          return -1; // Too specific for different ethnicity\n        }\n        score += 5; // General enough to still be useful\n      }\n    } else {\n      // No ethnicity filter or citation applies to all\n      score += 10;\n    }\n\n    // Recency bonus: newer studies slightly preferred\n    const yearBonus = Math.max(0, (citation.year - 2000) * 0.5);\n    score += yearBonus;\n\n    return score;\n  }\n\n  // Filter, score, sort, and take top 3\n  return RESEARCH_CITATIONS\n    .map(citation => ({ citation, relevance: calculateRelevance(citation) }))\n    .filter(item => item.relevance >= 0)\n    .sort((a, b) => b.relevance - a.relevance)\n    .slice(0, 3)\n    .map(item => item.citation);\n}\n\ninterface TrackerState {\n  notes: string;\n  checklist: Array<{ id: string; text: string; completed: boolean }>;\n}\n\n// ============================================\n// PHASE BADGE (Dark Theme)\n// ============================================\n\nfunction PhaseBadge({ phase }: { phase: string }) {\n  const getPhaseConfig = () => {\n    switch (phase) {\n      case 'Foundational':\n        return {\n          bg: 'bg-emerald-500/20',\n          text: 'text-emerald-400',\n          border: 'border-emerald-500/30',\n        };\n      case 'Minimally Invasive':\n        return {\n          bg: 'bg-blue-500/20',\n          text: 'text-blue-400',\n          border: 'border-blue-500/30',\n        };\n      case 'Surgical':\n        return {\n          bg: 'bg-purple-500/20',\n          text: 'text-purple-400',\n          border: 'border-purple-500/30',\n        };\n      default:\n        return {\n          bg: 'bg-neutral-500/20',\n          text: 'text-neutral-400',\n          border: 'border-neutral-500/30',\n        };\n    }\n  };\n\n  const config = getPhaseConfig();\n\n  return (\n    <span\n      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}\n    >\n      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}\n    </span>\n  );\n}\n\n// ============================================\n// IMPACT BADGE\n// ============================================\n\nfunction ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {\n  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);\n\n  return (\n    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n      <span className=\"flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0\">\n        <Sparkles className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n        {formattedImpact}\n      </span>\n      {(frontImpact !== undefined || sideImpact !== undefined) && (\n        <span className=\"hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0\">\n          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}\n          </span>\n          <span className=\"text-neutral-600\">|</span>\n          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}\n          </span>\n        </span>\n      )}\n    </div>\n  );\n}\n\n// ============================================\n// IMPROVEMENT TAG\n// ============================================\n\nfunction ImprovementTag({ text }: { text: string }) {\n  return (\n    <div className=\"inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm\">\n      <CheckCircle className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0\" />\n      <span className=\"truncate\">{text}</span>\n    </div>\n  );\n}\n\n// ============================================\n// SECTION HEADER\n// ============================================\n\nfunction SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {\n  return (\n    <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3\">\n      <Icon className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n      {title}\n    </h4>\n  );\n}\n\n// ============================================\n// MY TRACKER SECTION\n// ============================================\n\nfunction MyTracker({\n  tracker,\n  onNotesChange,\n  onAddChecklistItem,\n  onToggleChecklistItem,\n  onRemoveChecklistItem\n}: {\n  tracker: TrackerState;\n  onNotesChange: (notes: string) => void;\n  onAddChecklistItem: () => void;\n  onToggleChecklistItem: (id: string) => void;\n  onRemoveChecklistItem: (id: string) => void;\n}) {\n  return (\n    <div className=\"md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full\">\n      <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4\">\n        <BookOpen className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n        My Tracker\n      </h4>\n      <div className=\"space-y-3 sm:space-y-4\">\n        {/* Personal Notes */}\n        <div className=\"space-y-1 sm:space-y-1.5\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400\">Personal Notes</label>\n          <textarea\n            value={tracker.notes}\n            onChange={(e) => onNotesChange(e.target.value)}\n            className=\"w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all\"\n            placeholder=\"Track progress, questions, dates...\"\n          />\n        </div>\n\n        {/* Checklist */}\n        <div className=\"space-y-1.5 sm:space-y-2 pt-1 sm:pt-2\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center\">\n            <span>Checklist</span>\n            <button\n              onClick={onAddChecklistItem}\n              className=\"text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors\"\n            >\n              <Plus className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n              Add\n            </button>\n          </label>\n          <div className=\"space-y-1.5 sm:space-y-2\">\n            {tracker.checklist.length === 0 ? (\n              <div className=\"text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50\">\n                No tasks yet\n              </div>\n            ) : (\n              tracker.checklist.map((item) => (\n                <div\n                  key={item.id}\n                  className=\"flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg\"\n                >\n                  <button\n                    onClick={() => onToggleChecklistItem(item.id)}\n                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${\n                      item.completed\n                        ? 'bg-emerald-500 border-emerald-500'\n                        : 'border-neutral-600 hover:border-neutral-500'\n                    }`}\n                  >\n                    {item.completed && <CheckCircle className=\"w-3 h-3 text-black\" />}\n                  </button>\n                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>\n                    {item.text}\n                  </span>\n                  <button\n                    onClick={() => onRemoveChecklistItem(item.id)}\n                    className=\"text-neutral-600 hover:text-red-400 transition-colors\"\n                  >\n                    <Trash2 className=\"w-3 h-3\" />\n                  </button>\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// MAIN ENHANCED RECOMMENDATION CARD\n// ============================================\n\nexport function EnhancedRecommendationCard({\n  recommendation,\n  isExpanded = false,\n  onToggle,\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  rank,\n  onMarkComplete,\n  onRemove,\n  isCompleted = false,\n  gender,\n  ethnicity,\n}: EnhancedRecommendationCardProps) {\n  // Tracker state (would be persisted in real app)\n  const [tracker, setTracker] = useState<TrackerState>({\n    notes: '',\n    checklist: [],\n  });\n\n  // Get relevant research citations based on procedure, gender, and ethnicity\n  const citations = useMemo(() => {\n    return getRelevantCitations(recommendation.ref_id, gender, ethnicity);\n  }, [recommendation.ref_id, gender, ethnicity]);\n\n  const handleNotesChange = useCallback((notes: string) => {\n    setTracker(prev => ({ ...prev, notes }));\n  }, []);\n\n  const handleAddChecklistItem = useCallback(() => {\n    const text = window.prompt('Enter task:');\n    if (text) {\n      setTracker(prev => ({\n        ...prev,\n        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],\n      }));\n    }\n  }, []);\n\n  const handleToggleChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.map(item =>\n        item.id === id ? { ...item, completed: !item.completed } : item\n      ),\n    }));\n  }, []);\n\n  const handleRemoveChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.filter(item => item.id !== id),\n    }));\n  }, []);\n\n  // Format cost\n  const formatCost = () => {\n    const { min, max, type } = recommendation.cost;\n    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';\n    if (min === max) {\n      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n    }\n    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n  };\n\n  // Format timeline\n  const formatTimeline = () => {\n    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;\n    if (full_results_weeks_max) {\n      return `${full_results_weeks}-${full_results_weeks_max} weeks`;\n    }\n    if (full_results_weeks >= 52) {\n      const months = Math.round(full_results_weeks / 4);\n      return `${months} months`;\n    }\n    return `${full_results_weeks} weeks`;\n  };\n\n  // Get effectiveness level\n  const getEffectiveness = () => {\n    if (recommendation.impact >= 0.7) return 'high';\n    if (recommendation.impact >= 0.4) return 'moderate';\n    return 'low';\n  };\n\n  return (\n    <motion.div\n      layout\n      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${\n        isExpanded\n          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'\n          : 'border-neutral-800 hover:border-neutral-700'\n      } ${isCompleted ? 'opacity-60' : ''}`}\n    >\n      {/* Header - Clickable */}\n      <div className=\"p-3.5 sm:p-5 cursor-pointer\" onClick={onToggle}>\n        <div className=\"space-y-3 sm:space-y-4\">\n          <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2\">\n                <h3 className=\"text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white\">\n                  {recommendation.name}\n                </h3>\n                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n                  <PhaseBadge phase={recommendation.phase} />\n                  <ImpactBadge impact={recommendation.impact} />\n                </div>\n              </div>\n              <p className=\"text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none\">\n                {recommendation.description}\n              </p>\n            </div>\n\n            {/* Action buttons */}\n            <div className=\"flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto\">\n              {onMarkComplete && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onMarkComplete(recommendation.ref_id);\n                  }}\n                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${\n                    isCompleted\n                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'\n                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'\n                  }`}\n                  title=\"Mark as complete\"\n                >\n                  <CheckCircle className=\"w-4 h-4\" />\n                </button>\n              )}\n              {onRemove && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onRemove(recommendation.ref_id);\n                  }}\n                  className=\"p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10\"\n                  title=\"Remove action\"\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </button>\n              )}\n            </div>\n          </div>\n\n          {/* Quick stats row */}\n          <div className=\"flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400\">\n            <div className=\"flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5\">\n              <div className=\"flex items-center gap-1 sm:gap-1.5\" title=\"Estimated Cost\">\n                <DollarSign className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                <span className=\"font-medium text-neutral-300\">{formatCost()}</span>\n              </div>\n              {recommendation.timeline.full_results_weeks > 0 && (\n                <div className=\"flex items-center gap-1 sm:gap-1.5\">\n                  <Clock className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                  <span className=\"font-medium text-neutral-300\">{formatTimeline()}</span>\n                </div>\n              )}\n            </div>\n            <button\n              className=\"flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white\"\n            >\n              {isExpanded ? 'Less' : 'More'}\n              <ChevronDown\n                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n              />\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded Content */}\n      <AnimatePresence initial={false}>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.3 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"border-t border-neutral-800 bg-neutral-900/50\">\n              <div className=\"grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800\">\n                {/* Main Content */}\n                <div className=\"md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6\">\n                  {/* Improvements */}\n                  <div>\n                    <SectionHeader icon={Target} title=\"Improvements\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\n                        {recommendation.matchedFlaws.map((flaw, i) => (\n                          <ImprovementTag key={i} text={flaw} />\n                        ))}\n                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (\n                          <ImprovementTag key={i} text={ratio} />\n                        ))}\n                      </div>\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n                          <div className=\"text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase\">Effectiveness</div>\n                          <div className=\"h-1 w-1 rounded-full bg-neutral-600\" />\n                          <div className=\"font-medium text-white capitalize text-xs sm:text-sm\">{getEffectiveness()}</div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* How It Helps */}\n                  <div>\n                    <SectionHeader icon={Info} title=\"How It Helps\" />\n                    <div className=\"space-y-1.5 sm:space-y-2\">\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                          {recommendation.description}\n                        </p>\n                      </div>\n                      {recommendation.ratios_impacted.length > 0 && (\n                        <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                          <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}\n                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Logistics & Timeline */}\n                  {recommendation.timeline.full_results_weeks > 0 && (\n                    <div>\n                      <SectionHeader icon={Clock} title=\"Logistics & Timeline\" />\n                      <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Effect Starts\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white capitalize\">\n                            {recommendation.timeline.effect_start}\n                          </span>\n                        </div>\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Full Results\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white\">\n                            {formatTimeline()}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Considerations */}\n                  <div>\n                    <SectionHeader icon={AlertTriangle} title=\"Considerations\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      {/* Prerequisites */}\n                      {recommendation.warnings.length > 0 && (\n                        <div className=\"bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm\">\n                          <span className=\"font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">Prerequisites</span>\n                          <p className=\"text-blue-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.warnings[0]}\n                          </p>\n                        </div>\n                      )}\n\n                      {/* Risks & Side Effects */}\n                      {recommendation.risks_side_effects && (\n                        <div className=\"bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm\">\n                          <span className=\"font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">\n                            Risks & Side Effects\n                          </span>\n                          <p className=\"text-amber-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.risks_side_effects}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Notes & Warnings */}\n                  {recommendation.warnings.length > 1 && (\n                    <div className=\"text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic\">\n                      {recommendation.warnings.slice(1).join(' ')}\n                    </div>\n                  )}\n\n                  {/* Research Citations */}\n                  <div className=\"bg-cyan-500/10 p-3 sm:p-4 rounded-lg border border-cyan-500/30\">\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <BookOpen size={14} className=\"text-cyan-400\" />\n                      <span className=\"font-semibold text-cyan-400 text-xs sm:text-sm\">Research & Evidence</span>\n                      {ethnicity && ethnicity !== 'other' && (\n                        <span className=\"text-[9px] px-1.5 py-0.5 bg-cyan-500/20 rounded text-cyan-300 capitalize\">\n                          {ethnicity.replace('_', ' ')} focus\n                        </span>\n                      )}\n                    </div>\n                    {citations.length > 0 ? (\n                      <div className=\"space-y-2.5\">\n                        {citations.map((citation, idx) => (\n                          <div key={idx} className=\"text-[11px] sm:text-xs bg-neutral-900/50 p-2.5 rounded-lg border border-neutral-700/50\">\n                            <div className=\"flex items-start justify-between gap-2\">\n                              <div className=\"flex-1\">\n                                <div className=\"font-medium text-cyan-300 mb-0.5 line-clamp-2\">\n                                  {citation.title}\n                                </div>\n                                <div className=\"text-neutral-500 text-[10px] mb-1\">\n                                  {citation.authors} • {citation.journal} ({citation.year})\n                                </div>\n                                <div className=\"text-neutral-400 leading-relaxed\">\n                                  {citation.summary}\n                                </div>\n                              </div>\n                              {citation.doi && (\n                                <a\n                                  href={`https://doi.org/${citation.doi}`}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"flex-shrink-0 p-1 text-cyan-400 hover:text-cyan-300 transition-colors\"\n                                  title=\"View full paper\"\n                                >\n                                  <ExternalLink size={12} />\n                                </a>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-[11px] sm:text-xs text-cyan-300/70\">\n                        {recommendation.matchedFlaws.length > 0\n                          ? 'Based on facial analysis and established aesthetic research. More specific citations coming soon.'\n                          : 'No specific research citations available for this recommendation.'}\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* My Tracker Sidebar */}\n                <MyTracker\n                  tracker={tracker}\n                  onNotesChange={handleNotesChange}\n                  onAddChecklistItem={handleAddChecklistItem}\n                  onToggleChecklistItem={handleToggleChecklistItem}\n                  onRemoveChecklistItem={handleRemoveChecklistItem}\n                />\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\nexport default EnhancedRecommendationCard;\n","numLines":844,"startLine":1,"totalLines":844}}}
{"parentUuid":"7eaa2591-4d55-4911-99ec-932fb27996c8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011ZuwqdVea54kvkjRDm82pp","type":"tool_result","content":"     1→/**\n     2→ * Insights Engine\n     3→ *\n     4→ * Processes insight definitions from insights.json and classifies them\n     5→ * as strengths or areas of improvement based on user's metric scores.\n     6→ *\n     7→ * Logic:\n     8→ * - For each insight definition, calculate average score of affected metrics\n     9→ * - Weakness: if avg score < threshold → classify with severity label\n    10→ * - Strength: if avg score > threshold → classify with grade label\n    11→ *\n    12→ * Z-Score Based Severity Logic (NEW):\n    13→ * - Ideal (Green): User is inside the ideal range\n    14→ * - Good (Blue): Within 1 Standard Deviation of the mean (|z| < 1)\n    15→ * - Moderate (Yellow): Between 1 and 2 Standard Deviations (1 ≤ |z| < 2)\n    16→ * - Severe (Red): More than 2 Standard Deviations away (|z| ≥ 2)\n    17→ *\n    18→ * Severity Labels (Weaknesses):\n    19→ *   0-3 = \"Severe\"\n    20→ *   3-5 = \"Moderate\"\n    21→ *   5-7 = \"Minor\"\n    22→ *\n    23→ * Grade Labels (Strengths):\n    24→ *   8-9   = \"Good\"\n    25→ *   9-9.5 = \"Excellent\"\n    26→ *   9.5-10 = \"Ideal\"\n    27→ */\n    28→\n    29→import { Strength, Flaw } from '@/types/results';\n    30→import { FaceIQScoreResult, FACEIQ_METRICS, isValueAcceptable } from '@/lib/faceiq-scoring';\n    31→\n    32→// ============================================\n    33→// MASTER SCORING DATABASE (Z-Score Based)\n    34→// ============================================\n    35→\n    36→export type SeverityLevel = 'ideal' | 'good' | 'moderate' | 'severe';\n    37→export type Gender = 'male' | 'female';\n    38→export type Ethnicity = 'white' | 'black' | 'east_asian' | 'south_asian' | 'hispanic' | 'middle_eastern' | 'native_american' | 'pacific_islander';\n    39→\n    40→export interface MasterMetricConfig {\n    41→  ideal: [number, number];  // [min, max] ideal range\n    42→  mean: number;             // Population mean\n    43→  std_dev: number;          // Standard deviation\n    44→  flaws?: {\n    45→    low?: string[];         // Flaws when value is too low\n    46→    high?: string[];        // Flaws when value is too high\n    47→  };\n    48→}\n    49→\n    50→// Base/Default standards (White Male baseline)\n    51→export const MASTER_SCORING_DB: Record<string, MasterMetricConfig> = {\n    52→  // MIDFACE & PROPORTIONS\n    53→  \"midface_ratio\": {\n    54→    ideal: [0.97, 1.00],\n    55→    mean: 1.0,\n    56→    std_dev: 0.115,\n    57→    flaws: { low: [\"Long midface\", \"Long upper jaw\"] }\n    58→  },\n    59→  \"faceWidthToHeight\": {\n    60→    ideal: [1.30, 1.45],\n    61→    mean: 1.38,\n    62→    std_dev: 0.08,\n    63→    flaws: {\n    64→      low: [\"Overly long face\", \"Narrow face\"],\n    65→      high: [\"Wide face\", \"Short face\"]\n    66→    }\n    67→  },\n    68→  \"totalFacialWidthToHeight\": {\n    69→    ideal: [1.25, 1.40],\n    70→    mean: 1.33,\n    71→    std_dev: 0.075,\n    72→    flaws: {\n    73→      low: [\"Long face shape\"],\n    74→      high: [\"Wide face shape\"]\n    75→    }\n    76→  },\n    77→  \"upperThirdProportion\": {\n    78→    ideal: [0.30, 0.36],\n    79→    mean: 0.33,\n    80→    std_dev: 0.03,\n    81→    flaws: {\n    82→      low: [\"Short forehead\"],\n    83→      high: [\"Long forehead\"]\n    84→    }\n    85→  },\n    86→  \"middleThirdProportion\": {\n    87→    ideal: [0.30, 0.36],\n    88→    mean: 0.33,\n    89→    std_dev: 0.03,\n    90→    flaws: {\n    91→      low: [\"Short midface\"],\n    92→      high: [\"Long midface\"]\n    93→    }\n    94→  },\n    95→  \"lowerThirdProportion\": {\n    96→    ideal: [0.30, 0.36],\n    97→    mean: 0.33,\n    98→    std_dev: 0.03,\n    99→    flaws: {\n   100→      low: [\"Short lower face\"],\n   101→      high: [\"Long lower face\"]\n   102→    }\n   103→  },\n   104→\n   105→  // EYE SPACING & IPD\n   106→  \"eye_separation_ratio\": {\n   107→    ideal: [0.45, 0.47],\n   108→    mean: 0.46,\n   109→    std_dev: 0.03,\n   110→    flaws: {\n   111→      low: [\"Close-set eyes\"],\n   112→      high: [\"Wide-set eyes\"]\n   113→    }\n   114→  },\n   115→  \"interpupillaryRatio\": {\n   116→    ideal: [0.44, 0.48],\n   117→    mean: 0.46,\n   118→    std_dev: 0.025,\n   119→    flaws: {\n   120→      low: [\"Close-set eyes\"],\n   121→      high: [\"Wide-set eyes\"]\n   122→    }\n   123→  },\n   124→  \"oneEyeApartTest\": {\n   125→    ideal: [0.95, 1.05],\n   126→    mean: 1.0,\n   127→    std_dev: 0.08,\n   128→    flaws: {\n   129→      low: [\"Close-set eyes\"],\n   130→      high: [\"Wide-set eyes\"]\n   131→    }\n   132→  },\n   133→  \"intercanthalWidth\": {\n   134→    ideal: [30, 35],\n   135→    mean: 32.5,\n   136→    std_dev: 2.5,\n   137→    flaws: {\n   138→      low: [\"Narrow eye spacing\"],\n   139→      high: [\"Wide eye spacing\"]\n   140→    }\n   141→  },\n   142→\n   143→  // EYE SHAPE & FEATURES\n   144→  \"lateralCanthalTilt\": {\n   145→    ideal: [6, 8],\n   146→    mean: 5.0,\n   147→    std_dev: 3.5,\n   148→    flaws: {\n   149→      low: [\"Negative canthal tilt\", \"Downturned eyes\"],\n   150→      high: [\"Excessively upturned eyes\"]\n   151→    }\n   152→  },\n   153→  \"eyeAspectRatio\": {\n   154→    ideal: [0.30, 0.35],\n   155→    mean: 0.32,\n   156→    std_dev: 0.04,\n   157→    flaws: {\n   158→      low: [\"Narrow eyes\"],\n   159→      high: [\"Round eyes\"]\n   160→    }\n   161→  },\n   162→  \"palpebralFissureLength\": {\n   163→    ideal: [28, 32],\n   164→    mean: 30.0,\n   165→    std_dev: 2.5,\n   166→    flaws: {\n   167→      low: [\"Small eyes\"],\n   168→      high: [\"Large eyes\"]\n   169→    }\n   170→  },\n   171→  \"eyeWidth\": {\n   172→    ideal: [28, 32],\n   173→    mean: 30.0,\n   174→    std_dev: 2.0,\n   175→    flaws: {\n   176→      low: [\"Narrow eyes\"],\n   177→      high: [\"Wide eyes\"]\n   178→    }\n   179→  },\n   180→  \"upperEyelidExposure\": {\n   181→    ideal: [0.5, 1.2],\n   182→    mean: 0.85,\n   183→    std_dev: 0.35,\n   184→    flaws: {\n   185→      low: [\"Hooded eyes\"],\n   186→      high: [\"Excessive upper lid exposure\"]\n   187→    }\n   188→  },\n   189→  \"tearTroughDepth\": {\n   190→    ideal: [0.0, 0.3],\n   191→    mean: 0.15,\n   192→    std_dev: 0.15,\n   193→    flaws: {\n   194→      high: [\"Dark circles / Tear troughs\", \"Under-eye hollowness\"]\n   195→    }\n   196→  },\n   197→\n   198→  // JAW ANGLES & STRUCTURE\n   199→  \"gonial_angle\": {\n   200→    ideal: [115, 125],\n   201→    mean: 118.0,\n   202→    std_dev: 6.5,\n   203→    flaws: {\n   204→      high: [\"Weak/soft jaw structure\", \"Rounded jaw\"]\n   205→    }\n   206→  },\n   207→  \"mandibularPlaneAngle\": {\n   208→    ideal: [20, 28],\n   209→    mean: 24.0,\n   210→    std_dev: 4.0,\n   211→    flaws: {\n   212→      low: [\"Flat mandibular plane\"],\n   213→      high: [\"Steep mandibular plane\", \"Hyper-divergent jaw\"]\n   214→    }\n   215→  },\n   216→  \"jawFrontalAngle\": {\n   217→    ideal: [125, 135],\n   218→    mean: 130.0,\n   219→    std_dev: 5.0,\n   220→    flaws: {\n   221→      low: [\"Steep jaw\"],\n   222→      high: [\"Flat jaw angle\"]\n   223→    }\n   224→  },\n   225→  \"jawSlope\": {\n   226→    ideal: [25, 35],\n   227→    mean: 30.0,\n   228→    std_dev: 5.0,\n   229→    flaws: {\n   230→      low: [\"Flat jawline\"],\n   231→      high: [\"Steep jawline\"]\n   232→    }\n   233→  },\n   234→\n   235→  // JAW WIDTH\n   236→  \"jawWidthRatio\": {\n   237→    ideal: [0.85, 0.95],\n   238→    mean: 0.90,\n   239→    std_dev: 0.05,\n   240→    flaws: {\n   241→      low: [\"Narrow jaw\"],\n   242→      high: [\"Wide jaw\"]\n   243→    }\n   244→  },\n   245→  \"bigonialWidth\": {\n   246→    ideal: [110, 125],\n   247→    mean: 117.5,\n   248→    std_dev: 7.5,\n   249→    flaws: {\n   250→      low: [\"Narrow jaw width\"],\n   251→      high: [\"Excessively wide jaw\"]\n   252→    }\n   253→  },\n   254→\n   255→  // CHEEKBONES\n   256→  \"cheekbone_height\": {\n   257→    ideal: [83.0, 100.0],\n   258→    mean: 85.0,\n   259→    std_dev: 5.0,\n   260→    flaws: {\n   261→      low: [\"Low-set cheekbones\", \"Flat midface\"]\n   262→    }\n   263→  },\n   264→  \"cheekboneWidth\": {\n   265→    ideal: [130, 145],\n   266→    mean: 137.5,\n   267→    std_dev: 7.5,\n   268→    flaws: {\n   269→      low: [\"Narrow cheekbones\"],\n   270→      high: [\"Wide cheekbones\"]\n   271→    }\n   272→  },\n   273→\n   274→  // CHIN\n   275→  \"chinPhiltrumRatio\": {\n   276→    ideal: [1.8, 2.2],\n   277→    mean: 2.0,\n   278→    std_dev: 0.2,\n   279→    flaws: {\n   280→      low: [\"Recessed chin\", \"Short chin\"],\n   281→      high: [\"Long chin\", \"Projected chin\"]\n   282→    }\n   283→  },\n   284→  \"chinHeight\": {\n   285→    ideal: [35, 45],\n   286→    mean: 40.0,\n   287→    std_dev: 5.0,\n   288→    flaws: {\n   289→      low: [\"Short chin\"],\n   290→      high: [\"Long chin\"]\n   291→    }\n   292→  },\n   293→  \"chinWidth\": {\n   294→    ideal: [35, 45],\n   295→    mean: 40.0,\n   296→    std_dev: 5.0,\n   297→    flaws: {\n   298→      low: [\"Pointed/Narrow chin\"],\n   299→      high: [\"Wide chin\"]\n   300→    }\n   301→  },\n   302→\n   303→  // NOSE ANGLES\n   304→  \"nasalTipAngle\": {\n   305→    ideal: [95, 115],\n   306→    mean: 105.0,\n   307→    std_dev: 10.0,\n   308→    flaws: {\n   309→      low: [\"Droopy nasal tip\"],\n   310→      high: [\"Upturned nasal tip\"]\n   311→    }\n   312→  },\n   313→  \"nasolabialAngle\": {\n   314→    ideal: [95, 110],\n   315→    mean: 102.5,\n   316→    std_dev: 7.5,\n   317→    flaws: {\n   318→      low: [\"Droopy nasal tip\"],\n   319→      high: [\"Upturned nose\"]\n   320→    }\n   321→  },\n   322→  \"nasofrontalAngle\": {\n   323→    ideal: [115, 135],\n   324→    mean: 125.0,\n   325→    std_dev: 10.0,\n   326→    flaws: {\n   327→      low: [\"Deep nasal root\"],\n   328→      high: [\"Flat nasal root\"]\n   329→    }\n   330→  },\n   331→  \"nasofacialAngle\": {\n   332→    ideal: [30, 40],\n   333→    mean: 35.0,\n   334→    std_dev: 5.0,\n   335→    flaws: {\n   336→      low: [\"Flat nose profile\"],\n   337→      high: [\"Overprojected nose\"]\n   338→    }\n   339→  },\n   340→  \"nasomentaAngle\": {\n   341→    ideal: [120, 135],\n   342→    mean: 127.5,\n   343→    std_dev: 7.5,\n   344→    flaws: {\n   345→      low: [\"Convex profile\"],\n   346→      high: [\"Concave profile\"]\n   347→    }\n   348→  },\n   349→\n   350→  // NOSE WIDTH & PROPORTIONS\n   351→  \"nasalIndex\": {\n   352→    ideal: [65, 75],\n   353→    mean: 70.0,\n   354→    std_dev: 5.0,\n   355→    flaws: {\n   356→      low: [\"Narrow nose\"],\n   357→      high: [\"Wide nose\", \"Bulbous nose\"]\n   358→    }\n   359→  },\n   360→  \"noseWidth\": {\n   361→    ideal: [35, 42],\n   362→    mean: 38.5,\n   363→    std_dev: 3.5,\n   364→    flaws: {\n   365→      low: [\"Narrow nose\"],\n   366→      high: [\"Wide nasal base\"]\n   367→    }\n   368→  },\n   369→  \"noseBridgeWidth\": {\n   370→    ideal: [12, 18],\n   371→    mean: 15.0,\n   372→    std_dev: 3.0,\n   373→    flaws: {\n   374→      low: [\"Narrow nose bridge\"],\n   375→      high: [\"Wide nose bridge\"]\n   376→    }\n   377→  },\n   378→  \"nasalProjection\": {\n   379→    ideal: [16, 22],\n   380→    mean: 19.0,\n   381→    std_dev: 3.0,\n   382→    flaws: {\n   383→      low: [\"Underprojected nose\"],\n   384→      high: [\"Overprojected nose\"]\n   385→    }\n   386→  },\n   387→  \"noseLengthRatio\": {\n   388→    ideal: [0.45, 0.55],\n   389→    mean: 0.50,\n   390→    std_dev: 0.05,\n   391→    flaws: {\n   392→      low: [\"Short nose\"],\n   393→      high: [\"Long nose\"]\n   394→    }\n   395→  },\n   396→\n   397→  // LIPS & PHILTRUM\n   398→  \"lipRatio\": {\n   399→    ideal: [1.4, 1.6],\n   400→    mean: 1.5,\n   401→    std_dev: 0.15,\n   402→    flaws: {\n   403→      low: [\"Thin upper lip\"],\n   404→      high: [\"Thick upper lip\"]\n   405→    }\n   406→  },\n   407→  \"philtrumLength\": {\n   408→    ideal: [11, 15],\n   409→    mean: 13.0,\n   410→    std_dev: 2.0,\n   411→    flaws: {\n   412→      low: [\"Short philtrum\"],\n   413→      high: [\"Long philtrum\"]\n   414→    }\n   415→  },\n   416→  \"upperLipHeight\": {\n   417→    ideal: [18, 24],\n   418→    mean: 21.0,\n   419→    std_dev: 3.0,\n   420→    flaws: {\n   421→      low: [\"Thin upper lip\"],\n   422→      high: [\"Thick upper lip\"]\n   423→    }\n   424→  },\n   425→  \"lipChinDistance\": {\n   426→    ideal: [40, 50],\n   427→    mean: 45.0,\n   428→    std_dev: 5.0,\n   429→    flaws: {\n   430→      low: [\"Short lower third\"],\n   431→      high: [\"Long lower third\"]\n   432→    }\n   433→  },\n   434→  \"upperLipProjection\": {\n   435→    ideal: [-2, 2],\n   436→    mean: 0.0,\n   437→    std_dev: 2.0,\n   438→    flaws: {\n   439→      low: [\"Recessed upper lip\"],\n   440→      high: [\"Protruding upper lip\"]\n   441→    }\n   442→  },\n   443→  \"lowerLipProjection\": {\n   444→    ideal: [-1, 3],\n   445→    mean: 1.0,\n   446→    std_dev: 2.0,\n   447→    flaws: {\n   448→      low: [\"Recessed lower lip\"],\n   449→      high: [\"Protruding lower lip\"]\n   450→    }\n   451→  },\n   452→  \"cupidsBowDepth\": {\n   453→    ideal: [3, 6],\n   454→    mean: 4.5,\n   455→    std_dev: 1.5,\n   456→    flaws: {\n   457→      low: [\"Flat cupid's bow\"],\n   458→      high: [\"Pronounced cupid's bow\"]\n   459→    }\n   460→  },\n   461→\n   462→  // EYEBROWS\n   463→  \"eyebrowHeight\": {\n   464→    ideal: [8, 14],\n   465→    mean: 11.0,\n   466→    std_dev: 3.0,\n   467→    flaws: {\n   468→      low: [\"Low-set eyebrows\"],\n   469→      high: [\"High eyebrows\"]\n   470→    }\n   471→  },\n   472→  \"browLengthRatio\": {\n   473→    ideal: [0.50, 0.60],\n   474→    mean: 0.55,\n   475→    std_dev: 0.05,\n   476→    flaws: {\n   477→      low: [\"Short eyebrows\"],\n   478→      high: [\"Long eyebrows\"]\n   479→    }\n   480→  },\n   481→  \"browLengthToFaceWidth\": {\n   482→    ideal: [0.30, 0.38],\n   483→    mean: 0.34,\n   484→    std_dev: 0.04,\n   485→    flaws: {\n   486→      low: [\"Short eyebrows\"],\n   487→      high: [\"Long eyebrows\"]\n   488→    }\n   489→  },\n   490→  \"browridgeInclinationAngle\": {\n   491→    ideal: [10, 20],\n   492→    mean: 15.0,\n   493→    std_dev: 5.0,\n   494→    flaws: {\n   495→      low: [\"Flat brow ridge\"],\n   496→      high: [\"Prominent brow ridge\"]\n   497→    }\n   498→  },\n   499→  \"eyebrowThickness\": {\n   500→    ideal: [1.5, 3.0],\n   501→    mean: 2.25,\n   502→    std_dev: 0.75,\n   503→    flaws: {\n   504→      low: [\"Sparse/Weak eyebrows\"],\n   505→      high: [\"Overly thick eyebrows\"]\n   506→    }\n   507→  },\n   508→\n   509→  // FOREHEAD\n   510→  \"foreheadHeight\": {\n   511→    ideal: [55, 70],\n   512→    mean: 62.5,\n   513→    std_dev: 7.5,\n   514→    flaws: {\n   515→      low: [\"Short forehead\"],\n   516→      high: [\"Tall forehead\"]\n   517→    }\n   518→  },\n   519→  \"bitemporalWidth\": {\n   520→    ideal: [120, 135],\n   521→    mean: 127.5,\n   522→    std_dev: 7.5,\n   523→    flaws: {\n   524→      low: [\"Narrow forehead\"],\n   525→      high: [\"Wide forehead\"]\n   526→    }\n   527→  },\n   528→\n   529→  // PROFILE & DEPTH\n   530→  \"facialDepthToHeight\": {\n   531→    ideal: [0.75, 0.85],\n   532→    mean: 0.80,\n   533→    std_dev: 0.05,\n   534→    flaws: {\n   535→      low: [\"Flat facial profile\"],\n   536→      high: [\"Overprojected profile\"]\n   537→    }\n   538→  },\n   539→  \"anteriorFacialDepth\": {\n   540→    ideal: [115, 130],\n   541→    mean: 122.5,\n   542→    std_dev: 7.5,\n   543→    flaws: {\n   544→      low: [\"Shallow face depth\"],\n   545→      high: [\"Deep face projection\"]\n   546→    }\n   547→  },\n   548→  \"totalProfileAngle\": {\n   549→    ideal: [165, 175],\n   550→    mean: 170.0,\n   551→    std_dev: 5.0,\n   552→    flaws: {\n   553→      low: [\"Convex profile\"],\n   554→      high: [\"Concave profile\"]\n   555→    }\n   556→  },\n   557→\n   558→  // ASYMMETRY\n   559→  \"facialAsymmetryIndex\": {\n   560→    ideal: [0, 3],\n   561→    mean: 2.0,\n   562→    std_dev: 1.5,\n   563→    flaws: {\n   564→      high: [\"Facial asymmetry\"]\n   565→    }\n   566→  },\n   567→  \"eyeAsymmetry\": {\n   568→    ideal: [0, 2],\n   569→    mean: 1.0,\n   570→    std_dev: 1.0,\n   571→    flaws: {\n   572→      high: [\"Eye asymmetry\"]\n   573→    }\n   574→  },\n   575→  \"jawAsymmetry\": {\n   576→    ideal: [0, 3],\n   577→    mean: 1.5,\n   578→    std_dev: 1.5,\n   579→    flaws: {\n   580→      high: [\"Jaw asymmetry\"]\n   581→    }\n   582→  },\n   583→\n   584→  // OTHER\n   585→  \"recessionFrankfort\": {\n   586→    ideal: [-2, 2],\n   587→    mean: 0.0,\n   588→    std_dev: 2.0,\n   589→    flaws: {\n   590→      low: [\"Maxillary recession\"],\n   591→      high: [\"Maxillary protrusion\"]\n   592→    }\n   593→  },\n   594→  \"neckWidth\": {\n   595→    ideal: [110, 130],\n   596→    mean: 120.0,\n   597→    std_dev: 10.0,\n   598→    flaws: {\n   599→      low: [\"Narrow neck\"],\n   600→      high: [\"Wide neck\"]\n   601→    }\n   602→  },\n   603→  \"neckToJawRatio\": {\n   604→    ideal: [0.90, 1.10],\n   605→    mean: 1.0,\n   606→    std_dev: 0.10,\n   607→    flaws: {\n   608→      low: [\"Narrow neck\"],\n   609→      high: [\"Thick neck\"]\n   610→    }\n   611→  }\n   612→};\n   613→\n   614→// ============================================\n   615→// ETHNICITY-SPECIFIC OVERRIDES\n   616→// ============================================\n   617→\n   618→/**\n   619→ * Ethnicity and gender-specific metric standards\n   620→ * These override the base MASTER_SCORING_DB values for specific populations\n   621→ */\n   622→export const ETHNICITY_OVERRIDES: Record<string, Record<string, Partial<MasterMetricConfig>>> = {\n   623→  // ========================================\n   624→  // MALE WHITE STANDARDS (Neoclassical Baseline)\n   625→  // ========================================\n   626→  \"male_white\": {\n   627→    // NOSE WIDTH - Strict 1:1 ratio (Eye Width = Nose Width)\n   628→    \"noseWidth\": {\n   629→      ideal: [35, 42],  // Corresponds to alar_base_ratio [0.98, 1.05]\n   630→      mean: 38.5,\n   631→      std_dev: 3.5,\n   632→      flaws: {\n   633→        high: [\"Wide nasal base\"]\n   634→      }\n   635→    },\n   636→\n   637→    // MIDFACE - Prefers compact midface (Hunter look)\n   638→    \"midface_ratio\": {\n   639→      ideal: [0.95, 1.02],\n   640→      mean: 0.985,\n   641→      std_dev: 0.035,\n   642→      flaws: {\n   643→        low: [\"Long midface\"]\n   644→      }\n   645→    },\n   646→\n   647→    // JAW - Square/Robust jaw preference\n   648→    \"gonial_angle\": {\n   649→      ideal: [115.0, 125.0],\n   650→      mean: 120.0,\n   651→      std_dev: 5.0,\n   652→      flaws: {\n   653→        high: [\"Weak/Soft jaw structure\"]\n   654→      }\n   655→    },\n   656→\n   657→    // FACE WIDTH - Standard Mesoprosopic range\n   658→    \"faceWidthToHeight\": {\n   659→      ideal: [1.90, 2.05],\n   660→      mean: 1.975,\n   661→      std_dev: 0.075,\n   662→      flaws: {\n   663→        low: [\"Narrow face\"],\n   664→        high: [\"Short/Wide face\"]\n   665→      }\n   666→    },\n   667→\n   668→    // EYE TILT - Neutral to slightly positive\n   669→    \"lateralCanthalTilt\": {\n   670→      ideal: [4.0, 8.0],\n   671→      mean: 6.0,\n   672→      std_dev: 2.0,\n   673→      flaws: {\n   674→        low: [\"Negative canthal tilt\"]\n   675→      }\n   676→    },\n   677→\n   678→    // LOWER FACE BALANCE\n   679→    \"chinPhiltrumRatio\": {\n   680→      ideal: [2.10, 2.30],\n   681→      mean: 2.20,\n   682→      std_dev: 0.10,\n   683→      flaws: {\n   684→        low: [\"Long philtrum / Short chin\"]\n   685→      }\n   686→    }\n   687→  },\n   688→\n   689→  // ========================================\n   690→  // MALE BLACK / AFRICAN STANDARDS\n   691→  // ========================================\n   692→  \"male_black\": {\n   693→    // NOSE WIDTH - Significantly wider tolerance\n   694→    \"noseWidth\": {\n   695→      ideal: [40, 50],  // Wider range (corresponds to alar_base_ratio [1.12, 1.25])\n   696→      mean: 45.0,\n   697→      std_dev: 5.0,\n   698→      flaws: {\n   699→        high: [\"Wide nasal base\"]\n   700→      }\n   701→    },\n   702→    \"nasalIndex\": {\n   703→      ideal: [80, 95],  // Wider nasal index\n   704→      mean: 87.5,\n   705→      std_dev: 7.5,\n   706→      flaws: {\n   707→        high: [\"Wide nose\"]\n   708→      }\n   709→    },\n   710→\n   711→    // LIPS - Prefers fuller lips\n   712→    \"lipRatio\": {\n   713→      ideal: [1.2, 1.5],\n   714→      mean: 1.35,\n   715→      std_dev: 0.15,\n   716→      flaws: {\n   717→        low: [\"Thin lips\"]\n   718→      }\n   719→    },\n   720→\n   721→    // PHILTRUM - Shorter visible philtrum is ideal\n   722→    \"philtrumLength\": {\n   723→      ideal: [11.0, 14.0],\n   724→      mean: 12.5,\n   725→      std_dev: 1.5,\n   726→      flaws: {\n   727→        high: [\"Long philtrum\"]\n   728→      }\n   729→    },\n   730→\n   731→    // CHIN - Adjusts for natural forward mouth projection (Prognathism)\n   732→    \"chinPhiltrumRatio\": {\n   733→      ideal: [1.80, 2.10],  // Lower range to account for prognathism\n   734→      mean: 1.95,\n   735→      std_dev: 0.15,\n   736→      flaws: {\n   737→        low: [\"Recessed chin\"]\n   738→      }\n   739→    }\n   740→  },\n   741→\n   742→  // ========================================\n   743→  // MALE EAST ASIAN STANDARDS\n   744→  // ========================================\n   745→  \"male_east_asian\": {\n   746→    // EYE SPACING - Shifted WIDER for East Asian males\n   747→    \"eye_separation_ratio\": {\n   748→      ideal: [0.48, 0.53],  // Shifted wider (0.46 is \"close-set\" here)\n   749→      mean: 0.505,\n   750→      std_dev: 0.025,\n   751→      flaws: {\n   752→        low: [\"Close-set eyes\"],\n   753→        high: [\"Wide-set eyes\"]\n   754→      }\n   755→    },\n   756→    \"interpupillaryRatio\": {\n   757→      ideal: [0.48, 0.53],\n   758→      mean: 0.505,\n   759→      std_dev: 0.025,\n   760→      flaws: {\n   761→        low: [\"Close-set eyes\"],\n   762→        high: [\"Wide-set eyes\"]\n   763→      }\n   764→    },\n   765→\n   766→    // EYE SHAPE - Prefers narrower/longer eyes (Hunter Eyes)\n   767→    \"eyeAspectRatio\": {\n   768→      ideal: [0.25, 0.29],  // Lower ratio = more elongated\n   769→      mean: 0.27,\n   770→      std_dev: 0.02,\n   771→      flaws: {\n   772→        low: [\"Overly narrow eyes\"],\n   773→        high: [\"Overly round eye shape\"]\n   774→      }\n   775→    },\n   776→    \"palpebralFissureLength\": {\n   777→      ideal: [29, 33],\n   778→      mean: 31.0,\n   779→      std_dev: 2.0,\n   780→      flaws: {\n   781→        low: [\"Small eyes\"],\n   782→        high: [\"Large eyes\"]\n   783→      }\n   784→    },\n   785→\n   786→    // NOSE - Asian noses typically allowed to be wider\n   787→    \"nasalIndex\": {\n   788→      ideal: [75, 85],\n   789→      mean: 80.0,\n   790→      std_dev: 5.0,\n   791→      flaws: {\n   792→        high: [\"Wide nose\"]\n   793→      }\n   794→    },\n   795→    \"noseWidth\": {\n   796→      ideal: [38, 45],\n   797→      mean: 41.5,\n   798→      std_dev: 3.5,\n   799→      flaws: {\n   800→        low: [\"Narrow nose\"],\n   801→        high: [\"Very wide nasal base\"]\n   802→      }\n   803→    },\n   804→    \"noseBridgeWidth\": {\n   805→      ideal: [14, 20],\n   806→      mean: 17.0,\n   807→      std_dev: 3.0,\n   808→      flaws: {\n   809→        low: [\"Narrow nose bridge\"],\n   810→        high: [\"Wide nose bridge\"]\n   811→      }\n   812→    },\n   813→\n   814→    // CHEEKS - Rewards slightly fuller cheeks (Youth/K-Pop aesthetic)\n   815→    \"cheekbone_height\": {\n   816→      ideal: [80.0, 95.0],\n   817→      mean: 87.5,\n   818→      std_dev: 7.5,\n   819→      flaws: {\n   820→        low: [\"Gaunt/Hollow face\"]\n   821→      }\n   822→    },\n   823→\n   824→    // JAW - Slightly softer angles acceptable\n   825→    \"gonial_angle\": {\n   826→      ideal: [118, 128],\n   827→      mean: 123.0,\n   828→      std_dev: 5.0,\n   829→      flaws: {\n   830→        high: [\"Weak/soft jaw structure\"]\n   831→      }\n   832→    },\n   833→    \"mandibularPlaneAngle\": {\n   834→      ideal: [20, 30],\n   835→      mean: 25.0,\n   836→      std_dev: 5.0,\n   837→      flaws: {\n   838→        low: [\"Flat mandibular plane\"],\n   839→        high: [\"Steep mandibular plane\"]\n   840→      }\n   841→    },\n   842→\n   843→    // FACIAL PROPORTIONS - Wider faces more common\n   844→    \"faceWidthToHeight\": {\n   845→      ideal: [1.35, 1.50],\n   846→      mean: 1.425,\n   847→      std_dev: 0.075,\n   848→      flaws: {\n   849→        low: [\"Long face\"],\n   850→        high: [\"Very wide face\"]\n   851→      }\n   852→    },\n   853→    \"totalFacialWidthToHeight\": {\n   854→      ideal: [1.30, 1.45],\n   855→      mean: 1.375,\n   856→      std_dev: 0.075,\n   857→      flaws: {\n   858→        low: [\"Long face shape\"],\n   859→        high: [\"Wide face shape\"]\n   860→      }\n   861→    }\n   862→  },\n   863→\n   864→  // ========================================\n   865→  // MALE SOUTH ASIAN STANDARDS\n   866→  // ========================================\n   867→  \"male_south_asian\": {\n   868→    // NOSE WIDTH - Slightly wider tolerance than White\n   869→    \"noseWidth\": {\n   870→      ideal: [36, 43],  // alar_base_ratio [1.00, 1.08]\n   871→      mean: 39.5,\n   872→      std_dev: 3.5,\n   873→      flaws: {\n   874→        high: [\"Wide nasal base\"]\n   875→      }\n   876→    },\n   877→\n   878→    // TEAR TROUGH - VERY STRICT. High penalty for dark circles\n   879→    \"tearTroughDepth\": {\n   880→      ideal: [0.0, 0.5],\n   881→      mean: 0.25,\n   882→      std_dev: 0.25,\n   883→      flaws: {\n   884→        high: [\"Dark circles / Tear troughs\"]\n   885→      }\n   886→    },\n   887→\n   888→    // UPPER EYELID - Often prefers visible lid platform\n   889→    \"upperEyelidExposure\": {\n   890→      ideal: [0.5, 2.0],\n   891→      mean: 1.25,\n   892→      std_dev: 0.75,\n   893→      flaws: {\n   894→        low: [\"Hooded eyes\"]\n   895→      }\n   896→    },\n   897→\n   898→    // CHEEKS - Penalizes \"Gaunt\" looks heavily\n   899→    \"cheekbone_height\": {\n   900→      ideal: [83.0, 95.0],\n   901→      mean: 89.0,\n   902→      std_dev: 6.0,\n   903→      flaws: {\n   904→        low: [\"Volume loss / Gauntness\"]\n   905→      }\n   906→    }\n   907→  },\n   908→\n   909→  // ========================================\n   910→  // MALE HISPANIC STANDARDS (\"The Bridge Model\")\n   911→  // ========================================\n   912→  \"male_hispanic\": {\n   913→    // FACE WIDTH - Rewards broader, more robust face shapes (Mestizo)\n   914→    \"faceWidthToHeight\": {\n   915→      ideal: [1.95, 2.10],\n   916→      mean: 2.025,\n   917→      std_dev: 0.075,\n   918→      flaws: {\n   919→        low: [\"Long/Narrow face\"]\n   920→      }\n   921→    },\n   922→\n   923→    // NOSE WIDTH - Bridge tolerance (Wider than White, narrower than Black)\n   924→    \"noseWidth\": {\n   925→      ideal: [36, 44],  // alar_base_ratio [1.00, 1.12]\n   926→      mean: 40.0,\n   927→      std_dev: 4.0,\n   928→      flaws: {\n   929→        high: [\"Wide nasal base\"]\n   930→      }\n   931→    },\n   932→\n   933→    // EYE TILT - Strong preference for positive tilt\n   934→    \"lateralCanthalTilt\": {\n   935→      ideal: [6.0, 12.0],\n   936→      mean: 9.0,\n   937→      std_dev: 3.0,\n   938→      flaws: {\n   939→        low: [\"Negative/Neutral canthal tilt\"]\n   940→      }\n   941→    }\n   942→  },\n   943→\n   944→  // ========================================\n   945→  // MALE MIDDLE EASTERN STANDARDS\n   946→  // ========================================\n   947→  \"male_middle_eastern\": {\n   948→    // EYEBROW THICKNESS - Prefers significantly thicker/darker brows\n   949→    \"eyebrowThickness\": {\n   950→      ideal: [2.0, 4.0],\n   951→      mean: 3.0,\n   952→      std_dev: 1.0,\n   953→      flaws: {\n   954→        low: [\"Sparse/Weak eyebrows\"],\n   955→        high: [\"Unibrow\"]\n   956→      }\n   957→    },\n   958→\n   959→    // NASOLABIAL ANGLE - Penalizes droopy tip (<90) or hooked noses\n   960→    \"nasolabialAngle\": {\n   961→      ideal: [90.0, 100.0],\n   962→      mean: 95.0,\n   963→      std_dev: 5.0,\n   964→      flaws: {\n   965→        low: [\"Droopy nose tip / Hooked nose\"]\n   966→      }\n   967→    },\n   968→\n   969→    // EYE TILT - Strong preference for Almond/Hunter eye shape\n   970→    \"lateralCanthalTilt\": {\n   971→      ideal: [4.0, 10.0],\n   972→      mean: 7.0,\n   973→      std_dev: 3.0,\n   974→      flaws: {\n   975→        low: [\"Downturned eyes\"]\n   976→      }\n   977→    },\n   978→\n   979→    // MIDFACE - Similar to White model (Compact is better)\n   980→    \"midface_ratio\": {\n   981→      ideal: [0.95, 1.02],\n   982→      mean: 0.985,\n   983→      std_dev: 0.035,\n   984→      flaws: {\n   985→        low: [\"Long midface\"]\n   986→      }\n   987→    }\n   988→  },\n   989→\n   990→  // ========================================\n   991→  // MALE PACIFIC ISLANDER STANDARDS (\"The Warrior Skull\")\n   992→  // ========================================\n   993→  \"male_pacific_islander\": {\n   994→    // FACE WIDTH - The Highest Width Standard (Very broad)\n   995→    \"faceWidthToHeight\": {\n   996→      ideal: [2.10, 2.30],\n   997→      mean: 2.20,\n   998→      std_dev: 0.10,\n   999→      flaws: {\n  1000→        low: [\"Narrow/Long face\"]\n  1001→      }\n  1002→    },\n  1003→\n  1004→    // NOSE WIDTH - Wide tolerance\n  1005→    \"noseWidth\": {\n  1006→      ideal: [38, 48],  // alar_base_ratio [1.05, 1.20]\n  1007→      mean: 43.0,\n  1008→      std_dev: 5.0,\n  1009→      flaws: {\n  1010→        high: [\"Wide nasal base\"]\n  1011→      }\n  1012→    },\n  1013→\n  1014→    // CHEEKS - Rewards high mass/robustness\n  1015→    \"cheekbone_height\": {\n  1016→      ideal: [85.0, 100.0],\n  1017→      mean: 92.5,\n  1018→      std_dev: 7.5,\n  1019→      flaws: {\n  1020→        low: [\"Gaunt/Weak face structure\"]\n  1021→      }\n  1022→    },\n  1023→\n  1024→    // CHIN WIDTH - Prefers a very broad, square chin\n  1025→    \"chinWidth\": {\n  1026→      ideal: [40.0, 50.0],\n  1027→      mean: 45.0,\n  1028→      std_dev: 5.0,\n  1029→      flaws: {\n  1030→        low: [\"Pointed/Narrow chin\"]\n  1031→      }\n  1032→    }\n  1033→  },\n  1034→\n  1035→  // ========================================\n  1036→  // FEMALE ETHNICITIES (The \"Missing Link\")\n  1037→  // ========================================\n  1038→\n  1039→  \"female_white\": {\n  1040→    \"alar_base_ratio\": { ideal: [0.98, 1.05] },   // Strict Rule of Fifths\n  1041→    \"fwhr\": { ideal: [1.45, 1.53] },              // Oval/Narrow preference\n  1042→    \"gonial_angle\": { ideal: [122.0, 130.0] },    // Soft, tapered jawline\n  1043→    \"canthal_tilt\": { ideal: [4.0, 9.0] },        // Neutral to positive\n  1044→    \"chin_philtrum_ratio\": { ideal: [2.0, 2.2] }  // Golden Ratio balance\n  1045→  },\n  1046→\n  1047→  \"female_black\": {\n  1048→    \"lipRatio\": { ideal: [1.3, 1.6] },            // High volume preference (lower/upper lip ratio)\n  1049→    \"alar_base_ratio\": { ideal: [1.05, 1.15] },   // Wider tolerance\n  1050→    \"chin_projection\": { ideal: [0.0, 5.0] },     // Allows forward projection\n  1051→    \"gonial_angle\": { ideal: [120.0, 130.0] }     // Soft Feminine Jaw\n  1052→  },\n  1053→\n  1054→  \"female_east_asian\": {\n  1055→    \"eye_separation_ratio\": { ideal: [46.3, 47.5] }, // Wide-set (Neotenous) preference\n  1056→    \"gonial_angle\": { ideal: [120.0, 126.0] },       // Tapered V-shape\n  1057→    \"eyebrow_height\": { ideal: [0.85, 1.30] },       // Higher set brows\n  1058→    \"lower_third_ratio\": { ideal: [29.6, 32.7] }     // Compact lower face\n  1059→  },\n  1060→\n  1061→  \"female_south_asian\": {\n  1062→    \"tear_trough_depth\": { ideal: [0.0, 0.5] },      // Strict on dark circles\n  1063→    \"cheek_fullness\": { ideal: [1.0, 2.0] },         // Rewards midface volume\n  1064→    \"skin_uniformity\": { ideal: [0.92, 1.0] },       // High penalty for uneven tone\n  1065→    \"alar_base_ratio\": { ideal: [1.00, 1.08] }       // Intermediate tolerance\n  1066→  },\n  1067→\n  1068→  \"female_hispanic\": {\n  1069→    \"fwhr\": { ideal: [1.50, 1.62] },                 // Broader/Mestiza tolerance\n  1070→    \"canthal_tilt\": { ideal: [6.0, 12.0] },          // Strong Almond Eye preference\n  1071→    \"alar_base_ratio\": { ideal: [1.00, 1.10] },      // Intermediate width\n  1072→    \"lipRatio\": { ideal: [1.1, 1.35] }               // Voluptuous (lower/upper lip ratio)\n  1073→  },\n  1074→\n  1075→  \"female_middle_eastern\": {\n  1076→    \"eyebrow_thickness\": { ideal: [1.5, 3.0] },      // Dense/Thick brows\n  1077→    \"nasolabial_angle\": { ideal: [95.0, 105.0] },    // Refined/Upturned tip\n  1078→    \"canthal_tilt\": { ideal: [5.0, 10.0] },          // Foxy/Hunter feminine\n  1079→    \"upper_eyelid_exposure\": { ideal: [0.5, 1.5] }   // Low exposure\n  1080→  },\n  1081→\n  1082→  \"female_native_american\": {\n  1083→    \"fwhr\": { ideal: [1.52, 1.65] },                 // Wide/High Cheekbone structure\n  1084→    \"cheekbone_prominence\": { ideal: [1.5, 2.5] },   // High definition\n  1085→    \"gonial_angle\": { ideal: [115.0, 125.0] },       // Stronger jaw tolerance\n  1086→    \"canthal_tilt\": { ideal: [5.0, 11.0] }           // Positive tilt\n  1087→  },\n  1088→\n  1089→  \"female_pacific_islander\": {\n  1090→    \"fwhr\": { ideal: [1.55, 1.70] },                 // Widest/Robust ideal\n  1091→    \"cheek_fullness\": { ideal: [1.2, 2.5] },         // High volume/softness\n  1092→    \"alar_base_ratio\": { ideal: [1.05, 1.15] },      // Wide nose tolerance\n  1093→    \"lipRatio\": { ideal: [1.25, 1.50] }              // Full lips (lower/upper lip ratio)\n  1094→  }\n  1095→};\n  1096→\n  1097→/**\n  1098→ * Get the appropriate metric configuration for a given gender and ethnicity\n  1099→ * Falls back to base config if no override exists\n  1100→ */\n  1101→export function getMetricConfig(\n  1102→  metricId: string,\n  1103→  gender: Gender = 'male',\n  1104→  ethnicity: Ethnicity = 'white'\n  1105→): MasterMetricConfig | undefined {\n  1106→  const key = `${gender}_${ethnicity}`;\n  1107→  const override = ETHNICITY_OVERRIDES[key]?.[metricId];\n  1108→  const baseConfig = MASTER_SCORING_DB[metricId];\n  1109→\n  1110→  if (!baseConfig) return undefined;\n  1111→\n  1112→  // Merge override with base config\n  1113→  if (override) {\n  1114→    return {\n  1115→      ...baseConfig,\n  1116→      ...override,\n  1117→      flaws: {\n  1118→        ...baseConfig.flaws,\n  1119→        ...override.flaws\n  1120→      }\n  1121→    } as MasterMetricConfig;\n  1122→  }\n  1123→\n  1124→  return baseConfig;\n  1125→}\n  1126→\n  1127→// ============================================\n  1128→// Z-SCORE SEVERITY FUNCTIONS\n  1129→// ============================================\n  1130→\n  1131→/**\n  1132→ * Calculate Z-score for a given value\n  1133→ * Z = (value - mean) / std_dev\n  1134→ */\n  1135→export function calculateZScore(value: number, mean: number, stdDev: number): number {\n  1136→  if (stdDev === 0) return 0;\n  1137→  return Math.abs((value - mean) / stdDev);\n  1138→}\n  1139→\n  1140→/**\n  1141→ * Determine severity level based on Z-score and ideal range\n  1142→ * - Ideal: Value is within ideal range\n  1143→ * - Good: |z| < 1 (within 1 standard deviation)\n  1144→ * - Moderate: 1 ≤ |z| < 2 (between 1-2 standard deviations)\n  1145→ * - Severe: |z| ≥ 2 (more than 2 standard deviations away)\n  1146→ */\n  1147→export function getSeverityFromZScore(\n  1148→  value: number,\n  1149→  config: MasterMetricConfig\n  1150→): { severity: SeverityLevel; zScore: number; isInIdeal: boolean } {\n  1151→  const { ideal, mean, std_dev } = config;\n  1152→  const isInIdeal = value >= ideal[0] && value <= ideal[1];\n  1153→  const zScore = calculateZScore(value, mean, std_dev);\n  1154→\n  1155→  let severity: SeverityLevel;\n  1156→  if (isInIdeal) {\n  1157→    severity = 'ideal';\n  1158→  } else if (zScore < 1) {\n  1159→    severity = 'good';\n  1160→  } else if (zScore < 2) {\n  1161→    severity = 'moderate';\n  1162→  } else {\n  1163→    severity = 'severe';\n  1164→  }\n  1165→\n  1166→  return { severity, zScore, isInIdeal };\n  1167→}\n  1168→\n  1169→/**\n  1170→ * Get severity for a metric value with ethnicity/gender awareness\n  1171→ */\n  1172→export function getSeverityForMetric(\n  1173→  metricId: string,\n  1174→  value: number,\n  1175→  gender: Gender = 'male',\n  1176→  ethnicity: Ethnicity = 'white'\n  1177→): { severity: SeverityLevel; zScore: number; isInIdeal: boolean; config: MasterMetricConfig } | null {\n  1178→  const config = getMetricConfig(metricId, gender, ethnicity);\n  1179→  if (!config) return null;\n  1180→\n  1181→  const result = getSeverityFromZScore(value, config);\n  1182→  return { ...result, config };\n  1183→}\n  1184→\n  1185→/**\n  1186→ * Get badge color for severity level\n  1187→ */\n  1188→export function getSeverityColor(severity: SeverityLevel): string {\n  1189→  switch (severity) {\n  1190→    case 'ideal': return 'green';\n  1191→    case 'good': return 'blue';\n  1192→    case 'moderate': return 'yellow';\n  1193→    case 'severe': return 'red';\n  1194→    default: return 'gray';\n  1195→  }\n  1196→}\n  1197→\n  1198→/**\n  1199→ * Get severity label for display\n  1200→ */\n  1201→export function getSeverityLabel(severity: SeverityLevel): string {\n  1202→  switch (severity) {\n  1203→    case 'ideal': return 'Ideal';\n  1204→    case 'good': return 'Good';\n  1205→    case 'moderate': return 'Moderate';\n  1206→    case 'severe': return 'Severe';\n  1207→    default: return 'Unknown';\n  1208→  }\n  1209→}\n  1210→\n  1211→// ============================================\n  1212→// INSIGHT DEFINITION TYPES\n  1213→// ============================================\n  1214→\n  1215→export interface InsightSeverityLogic {\n  1216→  metrics: string[];  // Display names of metrics (e.g., \"Face Width to Height Ratio\")\n  1217→  threshold: number;  // Score threshold for classification\n  1218→}\n  1219→\n  1220→export interface WeaknessSeverityLabels {\n  1221→  minor: string;\n  1222→  moderate: string;\n  1223→  severe: string;\n  1224→}\n  1225→\n  1226→export interface StrengthGradeLabels {\n  1227→  good: string;\n  1228→  excellent: string;\n  1229→  ideal: string;\n  1230→}\n  1231→\n  1232→export interface InsightContent {\n  1233→  description: string;\n  1234→  severity_labels?: WeaknessSeverityLabels;  // For weaknesses\n  1235→  grade_labels?: StrengthGradeLabels;        // For strengths\n  1236→}\n  1237→\n  1238→export interface InsightDefinition {\n  1239→  id: string;\n  1240→  title: string;\n  1241→  type: 'weakness' | 'strength';\n  1242→  severity_logic: InsightSeverityLogic;\n  1243→  content: InsightContent;\n  1244→}\n  1245→\n  1246→// ============================================\n  1247→// CLASSIFICATION RESULT TYPES\n  1248→// ============================================\n  1249→\n  1250→export type WeaknessSeverity = 'severe' | 'moderate' | 'minor';\n  1251→export type StrengthGrade = 'ideal' | 'excellent' | 'good';\n  1252→\n  1253→export interface ClassifiedWeakness {\n  1254→  insightId: string;\n  1255→  title: string;\n  1256→  description: string;\n  1257→  severity: WeaknessSeverity;\n  1258→  severityLabel: string;  // Custom label from definition (e.g., \"Extremely Long\")\n  1259→  avgScore: number;\n  1260→  matchedMetrics: MatchedMetric[];\n  1261→}\n  1262→\n  1263→export interface ClassifiedStrength {\n  1264→  insightId: string;\n  1265→  title: string;\n  1266→  description: string;\n  1267→  grade: StrengthGrade;\n  1268→  gradeLabel: string;  // Custom label from definition (e.g., \"Ideal\")\n  1269→  avgScore: number;\n  1270→  matchedMetrics: MatchedMetric[];\n  1271→}\n  1272→\n  1273→export interface MatchedMetric {\n  1274→  metricId: string;\n  1275→  metricName: string;\n  1276→  score: number;\n  1277→  value: number;\n  1278→  idealMin: number;\n  1279→  idealMax: number;\n  1280→  unit: string;\n  1281→  category: string;\n  1282→}\n  1283→\n  1284→export interface InsightClassificationResult {\n  1285→  strengths: ClassifiedStrength[];\n  1286→  weaknesses: ClassifiedWeakness[];\n  1287→}\n  1288→\n  1289→// ============================================\n  1290→// INSIGHTS DATABASE\n  1291→// ============================================\n  1292→\n  1293→export const INSIGHTS_DEFINITIONS: InsightDefinition[] = [\n  1294→  {\n  1295→    id: \"long_midface\",\n  1296→    title: \"Long Midface\",\n  1297→    type: \"weakness\",\n  1298→    severity_logic: {\n  1299→      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\", \"Ipsilateral Alar Angle\"],\n  1300→      threshold: 6.0\n  1301→    },\n  1302→    content: {\n  1303→      description: \"The middle of the face is elongated, creating an unbalanced vertical proportion.\",\n  1304→      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Extremely Long\" }\n  1305→    }\n  1306→  },\n  1307→  {\n  1308→    id: \"short_midface\",\n  1309→    title: \"Short Midface\",\n  1310→    type: \"strength\",\n  1311→    severity_logic: {\n  1312→      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\"],\n  1313→      threshold: 8.0\n  1314→    },\n  1315→    content: {\n  1316→      description: \"The midface has ideal vertical proportions, contributing to facial harmony.\",\n  1317→      grade_labels: { good: \"Proportionate\", excellent: \"Well-Balanced\", ideal: \"Ideal\" }\n  1318→    }\n  1319→  },\n  1320→  {\n  1321→    id: \"weak_jaw\",\n  1322→    title: \"Weak/Soft Jaw Structure\",\n  1323→    type: \"weakness\",\n  1324→    severity_logic: {\n  1325→      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Chin to Philtrum Ratio\", \"Jaw Slope\"],\n  1326→      threshold: 5.0\n  1327→    },\n  1328→    content: {\n  1329→      description: \"The jaw has a softer, rounder shape, often less angular and robust than the ideal.\",\n  1330→      severity_labels: { minor: \"Soft\", moderate: \"Recessed\", severe: \"Weak\" }\n  1331→    }\n  1332→  },\n  1333→  {\n  1334→    id: \"strong_jaw\",\n  1335→    title: \"Strong Jaw Definition\",\n  1336→    type: \"strength\",\n  1337→    severity_logic: {\n  1338→      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Jaw Width Ratio\", \"Bigonial Width\"],\n  1339→      threshold: 8.0\n  1340→    },\n  1341→    content: {\n  1342→      description: \"The jaw displays strong definition with well-defined angles and proportionate width.\",\n  1343→      grade_labels: { good: \"Defined\", excellent: \"Strong\", ideal: \"Ideal Angular\" }\n  1344→    }\n  1345→  },\n  1346→  {\n  1347→    id: \"refined_nasal_tip\",\n  1348→    title: \"Refined Nasal Tip\",\n  1349→    type: \"strength\",\n  1350→    severity_logic: {\n  1351→      metrics: [\"Nasal Tip Angle\", \"Nose Tip Position\", \"Frankfort-tip Angle\"],\n  1352→      threshold: 8.5\n  1353→    },\n  1354→    content: {\n  1355→      description: \"This contributes to a harmonious nasal profile due to the nasal tip being well-defined and proportionate.\",\n  1356→      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n  1357→    }\n  1358→  },\n  1359→  {\n  1360→    id: \"bulbous_nose\",\n  1361→    title: \"Bulbous Nasal Tip\",\n  1362→    type: \"weakness\",\n  1363→    severity_logic: {\n  1364→      metrics: [\"Nasal Index\", \"Nose Width\", \"Nasal Tip Angle\"],\n  1365→      threshold: 5.5\n  1366→    },\n  1367→    content: {\n  1368→      description: \"The nasal tip appears rounded and less defined, affecting nasal aesthetics.\",\n  1369→      severity_labels: { minor: \"Slightly Rounded\", moderate: \"Rounded\", severe: \"Bulbous\" }\n  1370→    }\n  1371→  },\n  1372→  {\n  1373→    id: \"ideal_upper_lip\",\n  1374→    title: \"Well-Positioned Upper Lip\",\n  1375→    type: \"strength\",\n  1376→    severity_logic: {\n  1377→      metrics: [\"Upper Lip E-Line Position\", \"Upper Lip S-Line Position\", \"Nasolabial Angle\"],\n  1378→      threshold: 9.0\n  1379→    },\n  1380→    content: {\n  1381→      description: \"This contributes to a harmonious mouth region due to the upper lip sitting neither too far forward nor too far back.\",\n  1382→      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n  1383→    }\n  1384→  },\n  1385→  {\n  1386→    id: \"negative_canthal_tilt\",\n  1387→    title: \"Negative Canthal Tilt\",\n  1388→    type: \"weakness\",\n  1389→    severity_logic: {\n  1390→      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n  1391→      threshold: 5.0\n  1392→    },\n  1393→    content: {\n  1394→      description: \"The outer corners of the eyes sit lower than the inner corners, creating a downturned appearance.\",\n  1395→      severity_labels: { minor: \"Slight Downturn\", moderate: \"Noticeable\", severe: \"Pronounced\" }\n  1396→    }\n  1397→  },\n  1398→  {\n  1399→    id: \"positive_canthal_tilt\",\n  1400→    title: \"Positive Canthal Tilt\",\n  1401→    type: \"strength\",\n  1402→    severity_logic: {\n  1403→      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n  1404→      threshold: 8.0\n  1405→    },\n  1406→    content: {\n  1407→      description: \"The outer corners of the eyes are elevated, creating an attractive upswept eye shape.\",\n  1408→      grade_labels: { good: \"Slight Upturn\", excellent: \"Well-Tilted\", ideal: \"Hunter Eyes\" }\n  1409→    }\n  1410→  },\n  1411→  {\n  1412→    id: \"balanced_facial_thirds\",\n  1413→    title: \"Balanced Facial Thirds\",\n  1414→    type: \"strength\",\n  1415→    severity_logic: {\n  1416→      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n  1417→      threshold: 8.5\n  1418→    },\n  1419→    content: {\n  1420→      description: \"The face displays well-balanced vertical proportions across all three facial thirds.\",\n  1421→      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfectly Proportioned\" }\n  1422→    }\n  1423→  },\n  1424→  {\n  1425→    id: \"imbalanced_thirds\",\n  1426→    title: \"Facial Third Imbalance\",\n  1427→    type: \"weakness\",\n  1428→    severity_logic: {\n  1429→      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n  1430→      threshold: 5.5\n  1431→    },\n  1432→    content: {\n  1433→      description: \"The vertical face proportions show imbalance between the three facial thirds.\",\n  1434→      severity_labels: { minor: \"Slight Imbalance\", moderate: \"Noticeable Disproportion\", severe: \"Significant Imbalance\" }\n  1435→    }\n  1436→  },\n  1437→  {\n  1438→    id: \"high_cheekbones\",\n  1439→    title: \"High Cheekbones\",\n  1440→    type: \"strength\",\n  1441→    severity_logic: {\n  1442→      metrics: [\"Cheekbone Height\", \"Cheekbone Width\", \"Midface Ratio\"],\n  1443→      threshold: 8.5\n  1444→    },\n  1445→    content: {\n  1446→      description: \"Well-positioned cheekbones that create attractive facial contours and catch light beautifully.\",\n  1447→      grade_labels: { good: \"Visible\", excellent: \"Prominent\", ideal: \"Model-Tier\" }\n  1448→    }\n  1449→  },\n  1450→  {\n  1451→    id: \"flat_midface\",\n  1452→    title: \"Flat Midface\",\n  1453→    type: \"weakness\",\n  1454→    severity_logic: {\n  1455→      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Total Facial Width to Height\"],\n  1456→      threshold: 5.0\n  1457→    },\n  1458→    content: {\n  1459→      description: \"The midface lacks forward projection, resulting in flatter facial contours.\",\n  1460→      severity_labels: { minor: \"Slightly Flat\", moderate: \"Underprojected\", severe: \"Recessed\" }\n  1461→    }\n  1462→  },\n  1463→  {\n  1464→    id: \"ideal_lip_ratio\",\n  1465→    title: \"Ideal Lip Proportions\",\n  1466→    type: \"strength\",\n  1467→    severity_logic: {\n  1468→      metrics: [\"Lip Ratio\", \"Philtrum Length\", \"Lip Chin Distance\"],\n  1469→      threshold: 8.5\n  1470→    },\n  1471→    content: {\n  1472→      description: \"The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio.\",\n  1473→      grade_labels: { good: \"Balanced\", excellent: \"Well-Proportioned\", ideal: \"Perfect Ratio\" }\n  1474→    }\n  1475→  },\n  1476→  {\n  1477→    id: \"thin_lips\",\n  1478→    title: \"Thin Lip Profile\",\n  1479→    type: \"weakness\",\n  1480→    severity_logic: {\n  1481→      metrics: [\"Lip Ratio\", \"Upper Lip Projection\", \"Lower Lip Projection\"],\n  1482→      threshold: 5.0\n  1483→    },\n  1484→    content: {\n  1485→      description: \"The lips appear thinner than ideal proportions, affecting lower face harmony.\",\n  1486→      severity_labels: { minor: \"Slightly Thin\", moderate: \"Thin\", severe: \"Very Thin\" }\n  1487→    }\n  1488→  },\n  1489→  {\n  1490→    id: \"ideal_ipd\",\n  1491→    title: \"Ideal Eye Spacing\",\n  1492→    type: \"strength\",\n  1493→    severity_logic: {\n  1494→      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n  1495→      threshold: 8.5\n  1496→    },\n  1497→    content: {\n  1498→      description: \"The eyes are ideally spaced, creating facial balance and attractiveness.\",\n  1499→      grade_labels: { good: \"Good Spacing\", excellent: \"Ideal Distance\", ideal: \"Perfect IPD\" }\n  1500→    }\n  1501→  },\n  1502→  {\n  1503→    id: \"wide_set_eyes\",\n  1504→    title: \"Wide-Set Eyes\",\n  1505→    type: \"weakness\",\n  1506→    severity_logic: {\n  1507→      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n  1508→      threshold: 5.5\n  1509→    },\n  1510→    content: {\n  1511→      description: \"The eyes are spaced wider apart than the aesthetic ideal.\",\n  1512→      severity_labels: { minor: \"Slightly Wide\", moderate: \"Noticeably Wide\", severe: \"Very Wide\" }\n  1513→    }\n  1514→  },\n  1515→  {\n  1516→    id: \"close_set_eyes\",\n  1517→    title: \"Close-Set Eyes\",\n  1518→    type: \"weakness\",\n  1519→    severity_logic: {\n  1520→      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"Intercanthal Width\"],\n  1521→      threshold: 5.5\n  1522→    },\n  1523→    content: {\n  1524→      description: \"The eyes are positioned closer together than the aesthetic ideal.\",\n  1525→      severity_labels: { minor: \"Slightly Close\", moderate: \"Noticeably Close\", severe: \"Very Close\" }\n  1526→    }\n  1527→  },\n  1528→  {\n  1529→    id: \"ideal_nose_projection\",\n  1530→    title: \"Ideal Nasal Projection\",\n  1531→    type: \"strength\",\n  1532→    severity_logic: {\n  1533→      metrics: [\"Nasofrontal Angle\", \"Nasofacial Angle\", \"Nasomenta Angle\"],\n  1534→      threshold: 8.5\n  1535→    },\n  1536→    content: {\n  1537→      description: \"The nose has ideal forward projection relative to the face, creating profile harmony.\",\n  1538→      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect Projection\" }\n  1539→    }\n  1540→  },\n  1541→  {\n  1542→    id: \"recessed_chin\",\n  1543→    title: \"Recessed Chin\",\n  1544→    type: \"weakness\",\n  1545→    severity_logic: {\n  1546→      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Facial Depth to Height\"],\n  1547→      threshold: 5.0\n  1548→    },\n  1549→    content: {\n  1550→      description: \"The chin sits behind the ideal position, affecting profile balance.\",\n  1551→      severity_labels: { minor: \"Slightly Recessed\", moderate: \"Recessed\", severe: \"Severely Recessed\" }\n  1552→    }\n  1553→  },\n  1554→  {\n  1555→    id: \"ideal_chin_projection\",\n  1556→    title: \"Ideal Chin Projection\",\n  1557→    type: \"strength\",\n  1558→    severity_logic: {\n  1559→      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Anterior Facial Depth\"],\n  1560→      threshold: 8.5\n  1561→    },\n  1562→    content: {\n  1563→      description: \"The chin demonstrates ideal projection and proportions relative to the face.\",\n  1564→      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect\" }\n  1565→    }\n  1566→  },\n  1567→  {\n  1568→    id: \"long_philtrum\",\n  1569→    title: \"Long Philtrum\",\n  1570→    type: \"weakness\",\n  1571→    severity_logic: {\n  1572→      metrics: [\"Philtrum Length\", \"Lip Chin Distance\", \"Upper Lip Height\"],\n  1573→      threshold: 5.5\n  1574→    },\n  1575→    content: {\n  1576→      description: \"The distance between nose and upper lip is longer than ideal.\",\n  1577→      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n  1578→    }\n  1579→  },\n  1580→  {\n  1581→    id: \"short_philtrum\",\n  1582→    title: \"Short Philtrum\",\n  1583→    type: \"strength\",\n  1584→    severity_logic: {\n  1585→      metrics: [\"Philtrum Length\", \"Upper Lip Height\"],\n  1586→      threshold: 8.0\n  1587→    },\n  1588→    content: {\n  1589→      description: \"The philtrum has ideal or shorter length, considered youthful and attractive.\",\n  1590→      grade_labels: { good: \"Good Length\", excellent: \"Short\", ideal: \"Ideal\" }\n  1591→    }\n  1592→  },\n  1593→  {\n  1594→    id: \"wide_nose\",\n  1595→    title: \"Wide Nasal Base\",\n  1596→    type: \"weakness\",\n  1597→    severity_logic: {\n  1598→      metrics: [\"Nasal Index\", \"Intercanthal Nasal Ratio\", \"Nose Bridge Width\"],\n  1599→      threshold: 5.0\n  1600→    },\n  1601→    content: {\n  1602→      description: \"The base of the nose is wider than the aesthetic ideal for facial harmony.\",\n  1603→      severity_labels: { minor: \"Slightly Wide\", moderate: \"Wide\", severe: \"Very Wide\" }\n  1604→    }\n  1605→  },\n  1606→  {\n  1607→    id: \"ideal_brow_position\",\n  1608→    title: \"Ideal Brow Position\",\n  1609→    type: \"strength\",\n  1610→    severity_logic: {\n  1611→      metrics: [\"Eyebrow Height\", \"Brow Length Ratio\"],\n  1612→      threshold: 8.0\n  1613→    },\n  1614→    content: {\n  1615→      description: \"The eyebrows are ideally positioned relative to the eyes and facial structure.\",\n  1616→      grade_labels: { good: \"Good Position\", excellent: \"Well-Arched\", ideal: \"Perfect Frame\" }\n  1617→    }\n  1618→  },\n  1619→  {\n  1620→    id: \"narrow_jaw\",\n  1621→    title: \"Narrow Jaw\",\n  1622→    type: \"weakness\",\n  1623→    severity_logic: {\n  1624→      metrics: [\"Jaw Width Ratio\", \"Bigonial Width\", \"Jaw Frontal Angle\"],\n  1625→      threshold: 5.0\n  1626→    },\n  1627→    content: {\n  1628→      description: \"The jaw is narrower than ideal, affecting lower face width and definition.\",\n  1629→      severity_labels: { minor: \"Slightly Narrow\", moderate: \"Narrow\", severe: \"Very Narrow\" }\n  1630→    }\n  1631→  },\n  1632→  {\n  1633→    id: \"steep_mandibular_plane\",\n  1634→    title: \"Steep Mandibular Plane\",\n  1635→    type: \"weakness\",\n  1636→    severity_logic: {\n  1637→      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n  1638→      threshold: 5.0\n  1639→    },\n  1640→    content: {\n  1641→      description: \"The mandibular plane angle is steeper than ideal, often indicating vertical growth pattern.\",\n  1642→      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n  1643→    }\n  1644→  },\n  1645→  // ============================================\n  1646→  // SCRAPED FROM FACEIQ (element.html / element1.html)\n  1647→  // ============================================\n  1648→  // --- WEAKNESSES ---\n  1649→  {\n  1650→    id: \"steep_jaw\",\n  1651→    title: \"Steep Jaw\",\n  1652→    type: \"weakness\",\n  1653→    severity_logic: {\n  1654→      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Jaw Frontal Angle\"],\n  1655→      threshold: 6.0\n  1656→    },\n  1657→    content: {\n  1658→      description: \"The jaw angles sharply downward, creating a narrow or pointed chin effect.\",\n  1659→      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n  1660→    }\n  1661→  },\n  1662→  {\n  1663→    id: \"maxillary_recession\",\n  1664→    title: \"Maxillary Recession\",\n  1665→    type: \"weakness\",\n  1666→    severity_logic: {\n  1667→      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Facial Depth to Height Ratio\"],\n  1668→      threshold: 6.0\n  1669→    },\n  1670→    content: {\n  1671→      description: \"The upper jaw is less forward than ideal, reducing midface projection and facial harmony.\",\n  1672→      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n  1673→    }\n  1674→  },\n  1675→  {\n  1676→    id: \"mandibular_recession\",\n  1677→    title: \"Mandibular Recession\",\n  1678→    type: \"weakness\",\n  1679→    severity_logic: {\n  1680→      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\"],\n  1681→      threshold: 6.0\n  1682→    },\n  1683→    content: {\n  1684→      description: \"The lower jaw is set back, creating a less prominent chin and an unbalanced profile.\",\n  1685→      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n  1686→    }\n  1687→  },\n  1688→  {\n  1689→    id: \"underprojected_chin\",\n  1690→    title: \"Underprojected Chin\",\n  1691→    type: \"weakness\",\n  1692→    severity_logic: {\n  1693→      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\", \"Chin Height\"],\n  1694→      threshold: 6.0\n  1695→    },\n  1696→    content: {\n  1697→      description: \"The chin lacks forward projection, creating a weak lower face appearance.\",\n  1698→      severity_labels: { minor: \"Slightly Weak\", moderate: \"Underprojected\", severe: \"Severely Underprojected\" }\n  1699→    }\n  1700→  },\n  1701→  {\n  1702→    id: \"overly_long_face\",\n  1703→    title: \"Overly Long Face Shape\",\n  1704→    type: \"weakness\",\n  1705→    severity_logic: {\n  1706→      metrics: [\"Total Facial Width to Height Ratio\", \"Face Width to Height Ratio\"],\n  1707→      threshold: 6.0\n  1708→    },\n  1709→    content: {\n  1710→      description: \"The face is excessively tall and narrow, creating an elongated appearance.\",\n  1711→      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n  1712→    }\n  1713→  },\n  1714→  {\n  1715→    id: \"hyper_divergent_jaw\",\n  1716→    title: \"Hyper-Divergent Jaw Growth\",\n  1717→    type: \"weakness\",\n  1718→    severity_logic: {\n  1719→      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n  1720→      threshold: 5.5\n  1721→    },\n  1722→    content: {\n  1723→      description: \"The jaw grows with an overly steep angle, resulting in a long or narrow lower face. This can indicate malocclusion.\",\n  1724→      severity_labels: { minor: \"Mildly Divergent\", moderate: \"Divergent\", severe: \"Hyper-Divergent\" }\n  1725→    }\n  1726→  },\n  1727→  {\n  1728→    id: \"weak_brow_ridge\",\n  1729→    title: \"Soft/Weak Brow Ridge\",\n  1730→    type: \"weakness\",\n  1731→    severity_logic: {\n  1732→      metrics: [\"Browridge Inclination Angle\", \"Eyebrow Height\"],\n  1733→      threshold: 5.5\n  1734→    },\n  1735→    content: {\n  1736→      description: \"The forehead has a softer, less prominent ridge than the ideal, reducing masculine definition.\",\n  1737→      severity_labels: { minor: \"Slightly Soft\", moderate: \"Soft\", severe: \"Very Weak\" }\n  1738→    }\n  1739→  },\n  1740→  {\n  1741→    id: \"droopy_nasal_tip\",\n  1742→    title: \"Droopy Nasal Tip\",\n  1743→    type: \"weakness\",\n  1744→    severity_logic: {\n  1745→      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\", \"Nasofacial Angle\"],\n  1746→      threshold: 5.5\n  1747→    },\n  1748→    content: {\n  1749→      description: \"The nasal tip points downward more than ideal, creating a drooping appearance.\",\n  1750→      severity_labels: { minor: \"Slightly Droopy\", moderate: \"Droopy\", severe: \"Very Droopy\" }\n  1751→    }\n  1752→  },\n  1753→  {\n  1754→    id: \"overprojected_nose\",\n  1755→    title: \"Overprojected Nose\",\n  1756→    type: \"weakness\",\n  1757→    severity_logic: {\n  1758→      metrics: [\"Nasal Projection\", \"Nasofacial Angle\", \"Nose Length Ratio\"],\n  1759→      threshold: 5.5\n  1760→    },\n  1761→    content: {\n  1762→      description: \"The nose projects too far forward relative to the face, creating imbalance.\",\n  1763→      severity_labels: { minor: \"Slightly Projected\", moderate: \"Overprojected\", severe: \"Very Overprojected\" }\n  1764→    }\n  1765→  },\n  1766→  {\n  1767→    id: \"small_eyes\",\n  1768→    title: \"Small Eyes\",\n  1769→    type: \"weakness\",\n  1770→    severity_logic: {\n  1771→      metrics: [\"Eye Aspect Ratio\", \"Palpebral Fissure Length\", \"Eye Width\"],\n  1772→      threshold: 5.5\n  1773→    },\n  1774→    content: {\n  1775→      description: \"The eyes appear smaller than the aesthetic ideal relative to the face.\",\n  1776→      severity_labels: { minor: \"Slightly Small\", moderate: \"Small\", severe: \"Very Small\" }\n  1777→    }\n  1778→  },\n  1779→  {\n  1780→    id: \"low_set_eyebrows\",\n  1781→    title: \"Low-Set Eyebrows\",\n  1782→    type: \"weakness\",\n  1783→    severity_logic: {\n  1784→      metrics: [\"Eyebrow Height\", \"Brow to Hairline Distance\"],\n  1785→      threshold: 5.5\n  1786→    },\n  1787→    content: {\n  1788→      description: \"The eyebrows sit lower than ideal, reducing the visible upper eyelid space.\",\n  1789→      severity_labels: { minor: \"Slightly Low\", moderate: \"Low\", severe: \"Very Low\" }\n  1790→    }\n  1791→  },\n  1792→  {\n  1793→    id: \"asymmetrical_face\",\n  1794→    title: \"Facial Asymmetry\",\n  1795→    type: \"weakness\",\n  1796→    severity_logic: {\n  1797→      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n  1798→      threshold: 5.5\n  1799→    },\n  1800→    content: {\n  1801→      description: \"The left and right sides of the face show noticeable differences in proportion or position.\",\n  1802→      severity_labels: { minor: \"Slight Asymmetry\", moderate: \"Noticeable Asymmetry\", severe: \"Significant Asymmetry\" }\n  1803→    }\n  1804→  },\n  1805→  // --- STRENGTHS ---\n  1806→  {\n  1807→    id: \"good_jaw_width\",\n  1808→    title: \"Good Jaw Width\",\n  1809→    type: \"strength\",\n  1810→    severity_logic: {\n  1811→      metrics: [\"Bigonial Width\", \"Jaw Width Ratio\", \"Jaw Frontal Angle\"],\n  1812→      threshold: 8.5\n  1813→    },\n  1814→    content: {\n  1815→      description: \"This contributes to a pleasant jaw contour due to the jaw being neither too wide nor too narrow.\",\n  1816→      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n  1817→    }\n  1818→  },\n  1819→  {\n  1820→    id: \"good_forehead_slope\",\n  1821→    title: \"Good Forehead Slope\",\n  1822→    type: \"strength\",\n  1823→    severity_logic: {\n  1824→      metrics: [\"Browridge Inclination Angle\", \"Forehead Height\"],\n  1825→      threshold: 8.5\n  1826→    },\n  1827→    content: {\n  1828→      description: \"This contributes to a pleasant forehead contour by indicating that the forehead is neither too steep nor too flat.\",\n  1829→      grade_labels: { good: \"Good Slope\", excellent: \"Well-Angled\", ideal: \"Ideal Slope\" }\n  1830→    }\n  1831→  },\n  1832→  {\n  1833→    id: \"good_cupids_bow\",\n  1834→    title: \"Good Cupid's Bow Depth\",\n  1835→    type: \"strength\",\n  1836→    severity_logic: {\n  1837→      metrics: [\"Cupids Bow Depth\", \"Upper Lip Height\"],\n  1838→      threshold: 8.5\n  1839→    },\n  1840→    content: {\n  1841→      description: \"This contributes to a harmonious lip region due to the cupid's bow having ideal definition and depth.\",\n  1842→      grade_labels: { good: \"Defined\", excellent: \"Well-Defined\", ideal: \"Perfectly Defined\" }\n  1843→    }\n  1844→  },\n  1845→  {\n  1846→    id: \"good_eyebrow_length\",\n  1847→    title: \"Good Eyebrow Length\",\n  1848→    type: \"strength\",\n  1849→    severity_logic: {\n  1850→      metrics: [\"Brow Length to Face Width Ratio\", \"Brow Length Ratio\"],\n  1851→      threshold: 8.5\n  1852→    },\n  1853→    content: {\n  1854→      description: \"This contributes to a harmonious eye region due to the eyebrows having ideal horizontal length relative to face width.\",\n  1855→      grade_labels: { good: \"Good Length\", excellent: \"Well-Proportioned\", ideal: \"Ideal Length\" }\n  1856→    }\n  1857→  },\n  1858→  {\n  1859→    id: \"good_neck_width\",\n  1860→    title: \"Good Neck Width\",\n  1861→    type: \"strength\",\n  1862→    severity_logic: {\n  1863→      metrics: [\"Neck Width\", \"Neck to Jaw Ratio\"],\n  1864→      threshold: 8.5\n  1865→    },\n  1866→    content: {\n  1867→      description: \"This contributes to a harmonious lower face due to the neck being neither too wide nor too thin.\",\n  1868→      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n  1869→    }\n  1870→  },\n  1871→  {\n  1872→    id: \"ideal_nasolabial_angle\",\n  1873→    title: \"Ideal Nasolabial Angle\",\n  1874→    type: \"strength\",\n  1875→    severity_logic: {\n  1876→      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\"],\n  1877→      threshold: 8.5\n  1878→    },\n  1879→    content: {\n  1880→      description: \"The angle between nose and upper lip is in the ideal range, creating profile harmony.\",\n  1881→      grade_labels: { good: \"Good Angle\", excellent: \"Well-Angled\", ideal: \"Perfect Angle\" }\n  1882→    }\n  1883→  },\n  1884→  {\n  1885→    id: \"ideal_facial_depth\",\n  1886→    title: \"Ideal Facial Depth\",\n  1887→    type: \"strength\",\n  1888→    severity_logic: {\n  1889→      metrics: [\"Facial Depth to Height Ratio\", \"Anterior Facial Depth\"],\n  1890→      threshold: 8.5\n  1891→    },\n  1892→    content: {\n  1893→      description: \"The face has ideal forward projection creating attractive three-dimensional contours.\",\n  1894→      grade_labels: { good: \"Good Depth\", excellent: \"Well-Projected\", ideal: \"Ideal Projection\" }\n  1895→    }\n  1896→  },\n  1897→  {\n  1898→    id: \"ideal_eye_shape\",\n  1899→    title: \"Ideal Eye Shape\",\n  1900→    type: \"strength\",\n  1901→    severity_logic: {\n  1902→      metrics: [\"Eye Aspect Ratio\", \"Lateral Canthal Tilt\", \"Palpebral Fissure Length\"],\n  1903→      threshold: 8.5\n  1904→    },\n  1905→    content: {\n  1906→      description: \"The eyes have an attractive almond shape with ideal proportions and tilt.\",\n  1907→      grade_labels: { good: \"Attractive\", excellent: \"Well-Shaped\", ideal: \"Hunter Eyes\" }\n  1908→    }\n  1909→  },\n  1910→  {\n  1911→    id: \"harmonious_profile\",\n  1912→    title: \"Harmonious Profile\",\n  1913→    type: \"strength\",\n  1914→    severity_logic: {\n  1915→      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Total Profile Angle\"],\n  1916→      threshold: 8.5\n  1917→    },\n  1918→    content: {\n  1919→      description: \"The facial profile shows excellent balance between nose, lips, and chin positions.\",\n  1920→      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfect Profile\" }\n  1921→    }\n  1922→  },\n  1923→  {\n  1924→    id: \"good_facial_symmetry\",\n  1925→    title: \"Good Facial Symmetry\",\n  1926→    type: \"strength\",\n  1927→    severity_logic: {\n  1928→      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n  1929→      threshold: 8.5\n  1930→    },\n  1931→    content: {\n  1932→      description: \"The face displays excellent bilateral symmetry, a key component of attractiveness.\",\n  1933→      grade_labels: { good: \"Symmetric\", excellent: \"Very Symmetric\", ideal: \"Near-Perfect Symmetry\" }\n  1934→    }\n  1935→  }\n  1936→];\n  1937→\n  1938→// ============================================\n  1939→// METRIC NAME MAPPING\n  1940→// ============================================\n  1941→\n  1942→// Map display names to metric IDs for lookup\n  1943→const METRIC_NAME_TO_ID: Record<string, string> = {\n  1944→  // Face Shape/Proportions\n  1945→  \"Face Width to Height Ratio\": \"faceWidthToHeight\",\n  1946→  \"Total Facial Width to Height\": \"totalFacialWidthToHeight\",\n  1947→  \"Total Facial Width to Height Ratio\": \"totalFacialWidthToHeight\",\n  1948→  \"Midface Ratio\": \"midfaceRatio\",\n  1949→  \"Upper Third Proportion\": \"upperThirdProportion\",\n  1950→  \"Middle Third Proportion\": \"middleThirdProportion\",\n  1951→  \"Lower Third Proportion\": \"lowerThirdProportion\",\n  1952→  \"Cheekbone Height\": \"cheekboneHeight\",\n  1953→  \"Cheekbone Width\": \"cheekboneWidth\",\n  1954→  \"Bitemporal Width\": \"bitemporalWidth\",\n  1955→  \"Forehead Height\": \"foreheadHeight\",\n  1956→  \"Facial Asymmetry Index\": \"facialAsymmetryIndex\",\n  1957→\n  1958→  // Jaw\n  1959→  \"Gonial Angle\": \"gonialAngle\",\n  1960→  \"Mandibular Plane Angle\": \"mandibularPlaneAngle\",\n  1961→  \"Jaw Width Ratio\": \"jawWidthRatio\",\n  1962→  \"Bigonial Width\": \"bigonialWidth\",\n  1963→  \"Jaw Frontal Angle\": \"jawFrontalAngle\",\n  1964→  \"Jaw Slope\": \"jawSlope\",\n  1965→  \"Jaw Asymmetry\": \"jawAsymmetry\",\n  1966→\n  1967→  // Chin\n  1968→  \"Chin to Philtrum Ratio\": \"chinPhiltrumRatio\",\n  1969→  \"Chin Height\": \"chinHeight\",\n  1970→  \"Facial Depth to Height\": \"facialDepthToHeight\",\n  1971→  \"Facial Depth to Height Ratio\": \"facialDepthToHeight\",\n  1972→  \"Anterior Facial Depth\": \"anteriorFacialDepth\",\n  1973→  \"Recession Relative to Frankfort Plane\": \"recessionFrankfort\",\n  1974→\n  1975→  // Eyes\n  1976→  \"Lateral Canthal Tilt\": \"lateralCanthalTilt\",\n  1977→  \"Eye Aspect Ratio\": \"eyeAspectRatio\",\n  1978→  \"Eye Separation Ratio\": \"eyeSeparationRatio\",\n  1979→  \"Interpupillary Ratio\": \"interpupillaryRatio\",\n  1980→  \"One Eye Apart Test\": \"oneEyeApartTest\",\n  1981→  \"Intercanthal Width\": \"intercanthalWidth\",\n  1982→  \"Eyebrow Height\": \"eyebrowHeight\",\n  1983→  \"Brow Length Ratio\": \"browLengthRatio\",\n  1984→  \"Brow Length to Face Width Ratio\": \"browLengthToFaceWidth\",\n  1985→  \"Palpebral Fissure Length\": \"palpebralFissureLength\",\n  1986→  \"Eye Width\": \"eyeWidth\",\n  1987→  \"Eye Asymmetry\": \"eyeAsymmetry\",\n  1988→  \"Brow to Hairline Distance\": \"browToHairlineDistance\",\n  1989→\n  1990→  // Brow\n  1991→  \"Browridge Inclination Angle\": \"browridgeInclinationAngle\",\n  1992→\n  1993→  // Nose\n  1994→  \"Nasal Index\": \"nasalIndex\",\n  1995→  \"Nasal Tip Angle\": \"nasalTipAngle\",\n  1996→  \"Nose Tip Position\": \"noseTipPosition\",\n  1997→  \"Frankfort-tip Angle\": \"frankfortTipAngle\",\n  1998→  \"Nasofrontal Angle\": \"nasofrontalAngle\",\n  1999→  \"Nasofacial Angle\": \"nasofacialAngle\",\n  2000→  \"Nasomenta Angle\": \"nasomentaAngle\",\n  2001→  \"Nasomental Angle\": \"nasomentaAngle\",\n  2002→  \"Intercanthal Nasal Ratio\": \"intercanthalNasalRatio\",\n  2003→  \"Nose Bridge Width\": \"noseBridgeWidth\",\n  2004→  \"Nose Width\": \"noseWidth\",\n  2005→  \"Nasal Projection\": \"nasalProjection\",\n  2006→  \"Nose Length Ratio\": \"noseLengthRatio\",\n  2007→  \"Ipsilateral Alar Angle\": \"ipsilateralAlarAngle\",\n  2008→\n  2009→  // Lips\n  2010→  \"Lip Ratio\": \"lipRatio\",\n  2011→  \"Philtrum Length\": \"philtrumLength\",\n  2012→  \"Upper Lip Projection\": \"upperLipProjection\",\n  2013→  \"Lower Lip Projection\": \"lowerLipProjection\",\n  2014→  \"Lip Chin Distance\": \"lipChinDistance\",\n  2015→  \"Upper Lip Height\": \"upperLipHeight\",\n  2016→  \"Upper Lip E-Line Position\": \"upperLipELine\",\n  2017→  \"Upper Lip S-Line Position\": \"upperLipSLine\",\n  2018→  \"Nasolabial Angle\": \"nasolabialAngle\",\n  2019→  \"Cupids Bow Depth\": \"cupidsBowDepth\",\n  2020→\n  2021→  // Neck\n  2022→  \"Neck Width\": \"neckWidth\",\n  2023→  \"Neck to Jaw Ratio\": \"neckToJawRatio\",\n  2024→\n  2025→  // Profile\n  2026→  \"Total Profile Angle\": \"totalProfileAngle\",\n  2027→};\n  2028→\n  2029→// ============================================\n  2030→// CLASSIFICATION FUNCTIONS\n  2031→// ============================================\n  2032→\n  2033→/**\n  2034→ * Get weakness severity based on average score\n  2035→ * 0-3 = \"Severe\", 3-5 = \"Moderate\", 5-7 = \"Minor\"\n  2036→ */\n  2037→function getWeaknessSeverity(avgScore: number): WeaknessSeverity {\n  2038→  if (avgScore <= 3) return 'severe';\n  2039→  if (avgScore <= 5) return 'moderate';\n  2040→  return 'minor';\n  2041→}\n  2042→\n  2043→/**\n  2044→ * Get strength grade based on average score\n  2045→ * 8-9 = \"Good\", 9-9.5 = \"Excellent\", 9.5-10 = \"Ideal\"\n  2046→ */\n  2047→function getStrengthGrade(avgScore: number): StrengthGrade {\n  2048→  if (avgScore >= 9.5) return 'ideal';\n  2049→  if (avgScore >= 9) return 'excellent';\n  2050→  return 'good';\n  2051→}\n  2052→\n  2053→/**\n  2054→ * Find metric by display name from measurements array\n  2055→ */\n  2056→function findMetricByName(\n  2057→  metricName: string,\n  2058→  measurements: FaceIQScoreResult[]\n  2059→): FaceIQScoreResult | undefined {\n  2060→  // First try direct ID mapping\n  2061→  const metricId = METRIC_NAME_TO_ID[metricName];\n  2062→  if (metricId) {\n  2063→    return measurements.find(m => m.metricId === metricId);\n  2064→  }\n  2065→\n  2066→  // Fallback: try fuzzy matching on name\n  2067→  const normalizedName = metricName.toLowerCase().replace(/[^a-z0-9]/g, '');\n  2068→  return measurements.find(m => {\n  2069→    const normalizedMetricName = m.name.toLowerCase().replace(/[^a-z0-9]/g, '');\n  2070→    return normalizedMetricName.includes(normalizedName) ||\n  2071→           normalizedName.includes(normalizedMetricName);\n  2072→  });\n  2073→}\n  2074→\n  2075→/**\n  2076→ * Check if a metric should be considered a \"false positive\" weakness.\n  2077→ * This handles directional/dimorphic metrics where low scores don't mean weakness.\n  2078→ *\n  2079→ * Example: Canthal Tilt of 3° gets a low score (not in 6-8° ideal range)\n  2080→ * but is still a POSITIVE trait, not a weakness.\n  2081→ */\n  2082→function isFalsePositiveWeakness(metric: MatchedMetric): boolean {\n  2083→  const config = FACEIQ_METRICS[metric.metricId];\n  2084→  if (!config) return false;\n  2085→\n  2086→  // Check if the value is actually acceptable based on polarity\n  2087→  const { acceptable } = isValueAcceptable(metric.value, config);\n  2088→  return acceptable;\n  2089→}\n  2090→\n  2091→/**\n  2092→ * Process all insight definitions against user's measurements\n  2093→ */\n  2094→export function classifyInsights(\n  2095→  measurements: FaceIQScoreResult[],\n  2096→  insightDefinitions: InsightDefinition[] = INSIGHTS_DEFINITIONS\n  2097→): InsightClassificationResult {\n  2098→  const strengths: ClassifiedStrength[] = [];\n  2099→  const weaknesses: ClassifiedWeakness[] = [];\n  2100→\n  2101→  for (const insight of insightDefinitions) {\n  2102→    const { metrics, threshold } = insight.severity_logic;\n  2103→\n  2104→    // Find matching measurements for this insight\n  2105→    const matchedMetrics: MatchedMetric[] = [];\n  2106→    for (const metricName of metrics) {\n  2107→      const measurement = findMetricByName(metricName, measurements);\n  2108→      if (measurement) {\n  2109→        matchedMetrics.push({\n  2110→          metricId: measurement.metricId,\n  2111→          metricName: measurement.name,\n  2112→          score: measurement.score,\n  2113→          value: measurement.value,\n  2114→          idealMin: measurement.idealMin,\n  2115→          idealMax: measurement.idealMax,\n  2116→          unit: measurement.unit,\n  2117→          category: measurement.category,\n  2118→        });\n  2119→      }\n  2120→    }\n  2121→\n  2122→    // Skip if no metrics matched (need at least 1)\n  2123→    if (matchedMetrics.length === 0) continue;\n  2124→\n  2125→    // Calculate average score\n  2126→    const avgScore = matchedMetrics.reduce((sum, m) => sum + m.score, 0) / matchedMetrics.length;\n  2127→\n  2128→    // Classify based on type and threshold\n  2129→    if (insight.type === 'weakness') {\n  2130→      // Weakness: avg < threshold → add to areas of improvement\n  2131→      if (avgScore < threshold) {\n  2132→        // ========== FALSE POSITIVE CHECK ==========\n  2133→        // Before adding to weaknesses, check if ANY of the matched metrics\n  2134→        // are actually in an \"acceptable\" zone based on their polarity.\n  2135→        // If so, this is a false positive and should be skipped or reclassified.\n  2136→        const falsePositiveMetrics = matchedMetrics.filter(isFalsePositiveWeakness);\n  2137→\n  2138→        // If ALL matched metrics are false positives, skip this weakness entirely\n  2139→        if (falsePositiveMetrics.length === matchedMetrics.length) {\n  2140→          // This is a false positive weakness - the values are actually acceptable\n  2141→          // Consider adding to strengths if scores are decent\n  2142→          if (avgScore >= 6) {\n  2143→            strengths.push({\n  2144→              insightId: `${insight.id}_acceptable`,\n  2145→              title: insight.title.replace('Negative', 'Neutral').replace('Weak', 'Moderate'),\n  2146→              description: `While not in the peak ideal range, the measured values are within acceptable limits.`,\n  2147→              grade: 'good',\n  2148→              gradeLabel: 'Acceptable',\n  2149→              avgScore,\n  2150→              matchedMetrics,\n  2151→            });\n  2152→          }\n  2153→          continue; // Skip adding as weakness\n  2154→        }\n  2155→\n  2156→        // If SOME metrics are false positives, filter them out\n  2157→        const trueWeaknessMetrics = matchedMetrics.filter(m => !isFalsePositiveWeakness(m));\n  2158→        if (trueWeaknessMetrics.length === 0) continue;\n  2159→\n  2160→        // Recalculate average with only true weakness metrics\n  2161→        const trueAvgScore = trueWeaknessMetrics.reduce((sum, m) => sum + m.score, 0) / trueWeaknessMetrics.length;\n  2162→\n  2163→        // Only add as weakness if true average is still below threshold\n  2164→        if (trueAvgScore < threshold) {\n  2165→          const severity = getWeaknessSeverity(trueAvgScore);\n  2166→          const labels = insight.content.severity_labels;\n  2167→          const severityLabel = labels?.[severity] || severity;\n  2168→\n  2169→          weaknesses.push({\n  2170→            insightId: insight.id,\n  2171→            title: insight.title,\n  2172→            description: insight.content.description,\n  2173→            severity,\n  2174→            severityLabel,\n  2175→            avgScore: trueAvgScore,\n  2176→            matchedMetrics: trueWeaknessMetrics,\n  2177→          });\n  2178→        }\n  2179→      }\n  2180→    } else {\n  2181→      // Strength: avg > threshold → add to key strengths\n  2182→      if (avgScore > threshold) {\n  2183→        const grade = getStrengthGrade(avgScore);\n  2184→        const labels = insight.content.grade_labels;\n  2185→        const gradeLabel = labels?.[grade] || grade;\n  2186→\n  2187→        strengths.push({\n  2188→          insightId: insight.id,\n  2189→          title: insight.title,\n  2190→          description: insight.content.description,\n  2191→          grade,\n  2192→          gradeLabel,\n  2193→          avgScore,\n  2194→          matchedMetrics,\n  2195→        });\n  2196→      }\n  2197→    }\n  2198→  }\n  2199→\n  2200→  // Sort by score (weaknesses by lowest score first, strengths by highest first)\n  2201→  weaknesses.sort((a, b) => a.avgScore - b.avgScore);\n  2202→  strengths.sort((a, b) => b.avgScore - a.avgScore);\n  2203→\n  2204→  return { strengths, weaknesses };\n  2205→}\n  2206→\n  2207→/**\n  2208→ * Convert ClassifiedStrength to Strength type for UI compatibility\n  2209→ */\n  2210→export function convertToStrength(classified: ClassifiedStrength): Strength {\n  2211→  return {\n  2212→    id: `insight_strength_${classified.insightId}`,\n  2213→    strengthName: `${classified.title} (${classified.gradeLabel})`,\n  2214→    summary: classified.description,\n  2215→    avgScore: classified.avgScore,\n  2216→    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n  2217→                  classified.grade === 'excellent' ? 'excellent' : 'good',\n  2218→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2219→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2220→      ratioName: m.metricName,\n  2221→      ratioId: m.metricId,\n  2222→      score: m.score,\n  2223→      value: m.value,\n  2224→      idealMin: m.idealMin,\n  2225→      idealMax: m.idealMax,\n  2226→      unit: m.unit,\n  2227→      category: m.category,\n  2228→    })),\n  2229→  };\n  2230→}\n  2231→\n  2232→/**\n  2233→ * Convert ClassifiedWeakness to Flaw type for UI compatibility\n  2234→ */\n  2235→export function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  2236→  const impact = (10 - classified.avgScore) * 0.5 * classified.matchedMetrics.length;\n  2237→  const newRollingLost = rollingLost + impact;\n  2238→\n  2239→  return {\n  2240→    id: `insight_flaw_${classified.insightId}`,\n  2241→    flawName: `${classified.title} (${classified.severityLabel})`,\n  2242→    summary: classified.description,\n  2243→    harmonyPercentageLost: impact,\n  2244→    standardizedImpact: impact / 10,\n  2245→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2246→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2247→      ratioName: m.metricName,\n  2248→      ratioId: m.metricId,\n  2249→      score: m.score,\n  2250→      value: m.value,\n  2251→      idealMin: m.idealMin,\n  2252→      idealMax: m.idealMax,\n  2253→      unit: m.unit,\n  2254→      category: m.category,\n  2255→    })),\n  2256→    rollingPointsDeducted: newRollingLost,\n  2257→    rollingHarmonyPercentageLost: newRollingLost,\n  2258→    rollingStandardizedImpact: newRollingLost / 10,\n  2259→  };\n  2260→}\n  2261→\n  2262→/**\n  2263→ * Main function: Generate strengths and flaws from measurements using insights\n  2264→ */\n  2265→export function generateInsightBasedResults(\n  2266→  measurements: FaceIQScoreResult[]\n  2267→): { strengths: Strength[]; flaws: Flaw[] } {\n  2268→  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);\n  2269→\n  2270→  // Convert to UI-compatible types\n  2271→  const strengths = classifiedStrengths.map((s) => convertToStrength(s));\n  2272→\n  2273→  let rollingLost = 0;\n  2274→  const flaws = classifiedWeaknesses.map((w, i) => {\n  2275→    const flaw = convertToFlaw(w, i, rollingLost);\n  2276→    rollingLost = flaw.rollingPointsDeducted || 0;\n  2277→    return flaw;\n  2278→  });\n  2279→\n  2280→  return { strengths, flaws };\n  2281→}\n  2282→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"244525ca-8469-4cb3-b374-36090ebc0689","timestamp":"2025-12-22T00:06:57.200Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","content":"/**\n * Insights Engine\n *\n * Processes insight definitions from insights.json and classifies them\n * as strengths or areas of improvement based on user's metric scores.\n *\n * Logic:\n * - For each insight definition, calculate average score of affected metrics\n * - Weakness: if avg score < threshold → classify with severity label\n * - Strength: if avg score > threshold → classify with grade label\n *\n * Z-Score Based Severity Logic (NEW):\n * - Ideal (Green): User is inside the ideal range\n * - Good (Blue): Within 1 Standard Deviation of the mean (|z| < 1)\n * - Moderate (Yellow): Between 1 and 2 Standard Deviations (1 ≤ |z| < 2)\n * - Severe (Red): More than 2 Standard Deviations away (|z| ≥ 2)\n *\n * Severity Labels (Weaknesses):\n *   0-3 = \"Severe\"\n *   3-5 = \"Moderate\"\n *   5-7 = \"Minor\"\n *\n * Grade Labels (Strengths):\n *   8-9   = \"Good\"\n *   9-9.5 = \"Excellent\"\n *   9.5-10 = \"Ideal\"\n */\n\nimport { Strength, Flaw } from '@/types/results';\nimport { FaceIQScoreResult, FACEIQ_METRICS, isValueAcceptable } from '@/lib/faceiq-scoring';\n\n// ============================================\n// MASTER SCORING DATABASE (Z-Score Based)\n// ============================================\n\nexport type SeverityLevel = 'ideal' | 'good' | 'moderate' | 'severe';\nexport type Gender = 'male' | 'female';\nexport type Ethnicity = 'white' | 'black' | 'east_asian' | 'south_asian' | 'hispanic' | 'middle_eastern' | 'native_american' | 'pacific_islander';\n\nexport interface MasterMetricConfig {\n  ideal: [number, number];  // [min, max] ideal range\n  mean: number;             // Population mean\n  std_dev: number;          // Standard deviation\n  flaws?: {\n    low?: string[];         // Flaws when value is too low\n    high?: string[];        // Flaws when value is too high\n  };\n}\n\n// Base/Default standards (White Male baseline)\nexport const MASTER_SCORING_DB: Record<string, MasterMetricConfig> = {\n  // MIDFACE & PROPORTIONS\n  \"midface_ratio\": {\n    ideal: [0.97, 1.00],\n    mean: 1.0,\n    std_dev: 0.115,\n    flaws: { low: [\"Long midface\", \"Long upper jaw\"] }\n  },\n  \"faceWidthToHeight\": {\n    ideal: [1.30, 1.45],\n    mean: 1.38,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Overly long face\", \"Narrow face\"],\n      high: [\"Wide face\", \"Short face\"]\n    }\n  },\n  \"totalFacialWidthToHeight\": {\n    ideal: [1.25, 1.40],\n    mean: 1.33,\n    std_dev: 0.075,\n    flaws: {\n      low: [\"Long face shape\"],\n      high: [\"Wide face shape\"]\n    }\n  },\n  \"upperThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Long forehead\"]\n    }\n  },\n  \"middleThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short midface\"],\n      high: [\"Long midface\"]\n    }\n  },\n  \"lowerThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short lower face\"],\n      high: [\"Long lower face\"]\n    }\n  },\n\n  // EYE SPACING & IPD\n  \"eye_separation_ratio\": {\n    ideal: [0.45, 0.47],\n    mean: 0.46,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"interpupillaryRatio\": {\n    ideal: [0.44, 0.48],\n    mean: 0.46,\n    std_dev: 0.025,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"oneEyeApartTest\": {\n    ideal: [0.95, 1.05],\n    mean: 1.0,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"intercanthalWidth\": {\n    ideal: [30, 35],\n    mean: 32.5,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Narrow eye spacing\"],\n      high: [\"Wide eye spacing\"]\n    }\n  },\n\n  // EYE SHAPE & FEATURES\n  \"lateralCanthalTilt\": {\n    ideal: [6, 8],\n    mean: 5.0,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Negative canthal tilt\", \"Downturned eyes\"],\n      high: [\"Excessively upturned eyes\"]\n    }\n  },\n  \"eyeAspectRatio\": {\n    ideal: [0.30, 0.35],\n    mean: 0.32,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Round eyes\"]\n    }\n  },\n  \"palpebralFissureLength\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Small eyes\"],\n      high: [\"Large eyes\"]\n    }\n  },\n  \"eyeWidth\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Wide eyes\"]\n    }\n  },\n  \"upperEyelidExposure\": {\n    ideal: [0.5, 1.2],\n    mean: 0.85,\n    std_dev: 0.35,\n    flaws: {\n      low: [\"Hooded eyes\"],\n      high: [\"Excessive upper lid exposure\"]\n    }\n  },\n  \"tearTroughDepth\": {\n    ideal: [0.0, 0.3],\n    mean: 0.15,\n    std_dev: 0.15,\n    flaws: {\n      high: [\"Dark circles / Tear troughs\", \"Under-eye hollowness\"]\n    }\n  },\n\n  // JAW ANGLES & STRUCTURE\n  \"gonial_angle\": {\n    ideal: [115, 125],\n    mean: 118.0,\n    std_dev: 6.5,\n    flaws: {\n      high: [\"Weak/soft jaw structure\", \"Rounded jaw\"]\n    }\n  },\n  \"mandibularPlaneAngle\": {\n    ideal: [20, 28],\n    mean: 24.0,\n    std_dev: 4.0,\n    flaws: {\n      low: [\"Flat mandibular plane\"],\n      high: [\"Steep mandibular plane\", \"Hyper-divergent jaw\"]\n    }\n  },\n  \"jawFrontalAngle\": {\n    ideal: [125, 135],\n    mean: 130.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Steep jaw\"],\n      high: [\"Flat jaw angle\"]\n    }\n  },\n  \"jawSlope\": {\n    ideal: [25, 35],\n    mean: 30.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat jawline\"],\n      high: [\"Steep jawline\"]\n    }\n  },\n\n  // JAW WIDTH\n  \"jawWidthRatio\": {\n    ideal: [0.85, 0.95],\n    mean: 0.90,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Narrow jaw\"],\n      high: [\"Wide jaw\"]\n    }\n  },\n  \"bigonialWidth\": {\n    ideal: [110, 125],\n    mean: 117.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow jaw width\"],\n      high: [\"Excessively wide jaw\"]\n    }\n  },\n\n  // CHEEKBONES\n  \"cheekbone_height\": {\n    ideal: [83.0, 100.0],\n    mean: 85.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Low-set cheekbones\", \"Flat midface\"]\n    }\n  },\n  \"cheekboneWidth\": {\n    ideal: [130, 145],\n    mean: 137.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow cheekbones\"],\n      high: [\"Wide cheekbones\"]\n    }\n  },\n\n  // CHIN\n  \"chinPhiltrumRatio\": {\n    ideal: [1.8, 2.2],\n    mean: 2.0,\n    std_dev: 0.2,\n    flaws: {\n      low: [\"Recessed chin\", \"Short chin\"],\n      high: [\"Long chin\", \"Projected chin\"]\n    }\n  },\n  \"chinHeight\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short chin\"],\n      high: [\"Long chin\"]\n    }\n  },\n  \"chinWidth\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Pointed/Narrow chin\"],\n      high: [\"Wide chin\"]\n    }\n  },\n\n  // NOSE ANGLES\n  \"nasalTipAngle\": {\n    ideal: [95, 115],\n    mean: 105.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nasal tip\"]\n    }\n  },\n  \"nasolabialAngle\": {\n    ideal: [95, 110],\n    mean: 102.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nose\"]\n    }\n  },\n  \"nasofrontalAngle\": {\n    ideal: [115, 135],\n    mean: 125.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Deep nasal root\"],\n      high: [\"Flat nasal root\"]\n    }\n  },\n  \"nasofacialAngle\": {\n    ideal: [30, 40],\n    mean: 35.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat nose profile\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"nasomentaAngle\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // NOSE WIDTH & PROPORTIONS\n  \"nasalIndex\": {\n    ideal: [65, 75],\n    mean: 70.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nose\", \"Bulbous nose\"]\n    }\n  },\n  \"noseWidth\": {\n    ideal: [35, 42],\n    mean: 38.5,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nasal base\"]\n    }\n  },\n  \"noseBridgeWidth\": {\n    ideal: [12, 18],\n    mean: 15.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Narrow nose bridge\"],\n      high: [\"Wide nose bridge\"]\n    }\n  },\n  \"nasalProjection\": {\n    ideal: [16, 22],\n    mean: 19.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Underprojected nose\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"noseLengthRatio\": {\n    ideal: [0.45, 0.55],\n    mean: 0.50,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short nose\"],\n      high: [\"Long nose\"]\n    }\n  },\n\n  // LIPS & PHILTRUM\n  \"lipRatio\": {\n    ideal: [1.4, 1.6],\n    mean: 1.5,\n    std_dev: 0.15,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"philtrumLength\": {\n    ideal: [11, 15],\n    mean: 13.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Short philtrum\"],\n      high: [\"Long philtrum\"]\n    }\n  },\n  \"upperLipHeight\": {\n    ideal: [18, 24],\n    mean: 21.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"lipChinDistance\": {\n    ideal: [40, 50],\n    mean: 45.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short lower third\"],\n      high: [\"Long lower third\"]\n    }\n  },\n  \"upperLipProjection\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed upper lip\"],\n      high: [\"Protruding upper lip\"]\n    }\n  },\n  \"lowerLipProjection\": {\n    ideal: [-1, 3],\n    mean: 1.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed lower lip\"],\n      high: [\"Protruding lower lip\"]\n    }\n  },\n  \"cupidsBowDepth\": {\n    ideal: [3, 6],\n    mean: 4.5,\n    std_dev: 1.5,\n    flaws: {\n      low: [\"Flat cupid's bow\"],\n      high: [\"Pronounced cupid's bow\"]\n    }\n  },\n\n  // EYEBROWS\n  \"eyebrowHeight\": {\n    ideal: [8, 14],\n    mean: 11.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Low-set eyebrows\"],\n      high: [\"High eyebrows\"]\n    }\n  },\n  \"browLengthRatio\": {\n    ideal: [0.50, 0.60],\n    mean: 0.55,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browLengthToFaceWidth\": {\n    ideal: [0.30, 0.38],\n    mean: 0.34,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browridgeInclinationAngle\": {\n    ideal: [10, 20],\n    mean: 15.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat brow ridge\"],\n      high: [\"Prominent brow ridge\"]\n    }\n  },\n  \"eyebrowThickness\": {\n    ideal: [1.5, 3.0],\n    mean: 2.25,\n    std_dev: 0.75,\n    flaws: {\n      low: [\"Sparse/Weak eyebrows\"],\n      high: [\"Overly thick eyebrows\"]\n    }\n  },\n\n  // FOREHEAD\n  \"foreheadHeight\": {\n    ideal: [55, 70],\n    mean: 62.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Tall forehead\"]\n    }\n  },\n  \"bitemporalWidth\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow forehead\"],\n      high: [\"Wide forehead\"]\n    }\n  },\n\n  // PROFILE & DEPTH\n  \"facialDepthToHeight\": {\n    ideal: [0.75, 0.85],\n    mean: 0.80,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Flat facial profile\"],\n      high: [\"Overprojected profile\"]\n    }\n  },\n  \"anteriorFacialDepth\": {\n    ideal: [115, 130],\n    mean: 122.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Shallow face depth\"],\n      high: [\"Deep face projection\"]\n    }\n  },\n  \"totalProfileAngle\": {\n    ideal: [165, 175],\n    mean: 170.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // ASYMMETRY\n  \"facialAsymmetryIndex\": {\n    ideal: [0, 3],\n    mean: 2.0,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Facial asymmetry\"]\n    }\n  },\n  \"eyeAsymmetry\": {\n    ideal: [0, 2],\n    mean: 1.0,\n    std_dev: 1.0,\n    flaws: {\n      high: [\"Eye asymmetry\"]\n    }\n  },\n  \"jawAsymmetry\": {\n    ideal: [0, 3],\n    mean: 1.5,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Jaw asymmetry\"]\n    }\n  },\n\n  // OTHER\n  \"recessionFrankfort\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Maxillary recession\"],\n      high: [\"Maxillary protrusion\"]\n    }\n  },\n  \"neckWidth\": {\n    ideal: [110, 130],\n    mean: 120.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Wide neck\"]\n    }\n  },\n  \"neckToJawRatio\": {\n    ideal: [0.90, 1.10],\n    mean: 1.0,\n    std_dev: 0.10,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Thick neck\"]\n    }\n  }\n};\n\n// ============================================\n// ETHNICITY-SPECIFIC OVERRIDES\n// ============================================\n\n/**\n * Ethnicity and gender-specific metric standards\n * These override the base MASTER_SCORING_DB values for specific populations\n */\nexport const ETHNICITY_OVERRIDES: Record<string, Record<string, Partial<MasterMetricConfig>>> = {\n  // ========================================\n  // MALE WHITE STANDARDS (Neoclassical Baseline)\n  // ========================================\n  \"male_white\": {\n    // NOSE WIDTH - Strict 1:1 ratio (Eye Width = Nose Width)\n    \"noseWidth\": {\n      ideal: [35, 42],  // Corresponds to alar_base_ratio [0.98, 1.05]\n      mean: 38.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // MIDFACE - Prefers compact midface (Hunter look)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    },\n\n    // JAW - Square/Robust jaw preference\n    \"gonial_angle\": {\n      ideal: [115.0, 125.0],\n      mean: 120.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/Soft jaw structure\"]\n      }\n    },\n\n    // FACE WIDTH - Standard Mesoprosopic range\n    \"faceWidthToHeight\": {\n      ideal: [1.90, 2.05],\n      mean: 1.975,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Short/Wide face\"]\n      }\n    },\n\n    // EYE TILT - Neutral to slightly positive\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 8.0],\n      mean: 6.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Negative canthal tilt\"]\n      }\n    },\n\n    // LOWER FACE BALANCE\n    \"chinPhiltrumRatio\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Long philtrum / Short chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE BLACK / AFRICAN STANDARDS\n  // ========================================\n  \"male_black\": {\n    // NOSE WIDTH - Significantly wider tolerance\n    \"noseWidth\": {\n      ideal: [40, 50],  // Wider range (corresponds to alar_base_ratio [1.12, 1.25])\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n    \"nasalIndex\": {\n      ideal: [80, 95],  // Wider nasal index\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n\n    // LIPS - Prefers fuller lips\n    \"lipRatio\": {\n      ideal: [1.2, 1.5],\n      mean: 1.35,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    },\n\n    // PHILTRUM - Shorter visible philtrum is ideal\n    \"philtrumLength\": {\n      ideal: [11.0, 14.0],\n      mean: 12.5,\n      std_dev: 1.5,\n      flaws: {\n        high: [\"Long philtrum\"]\n      }\n    },\n\n    // CHIN - Adjusts for natural forward mouth projection (Prognathism)\n    \"chinPhiltrumRatio\": {\n      ideal: [1.80, 2.10],  // Lower range to account for prognathism\n      mean: 1.95,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Recessed chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE EAST ASIAN STANDARDS\n  // ========================================\n  \"male_east_asian\": {\n    // EYE SPACING - Shifted WIDER for East Asian males\n    \"eye_separation_ratio\": {\n      ideal: [0.48, 0.53],  // Shifted wider (0.46 is \"close-set\" here)\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n    \"interpupillaryRatio\": {\n      ideal: [0.48, 0.53],\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n\n    // EYE SHAPE - Prefers narrower/longer eyes (Hunter Eyes)\n    \"eyeAspectRatio\": {\n      ideal: [0.25, 0.29],  // Lower ratio = more elongated\n      mean: 0.27,\n      std_dev: 0.02,\n      flaws: {\n        low: [\"Overly narrow eyes\"],\n        high: [\"Overly round eye shape\"]\n      }\n    },\n    \"palpebralFissureLength\": {\n      ideal: [29, 33],\n      mean: 31.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Small eyes\"],\n        high: [\"Large eyes\"]\n      }\n    },\n\n    // NOSE - Asian noses typically allowed to be wider\n    \"nasalIndex\": {\n      ideal: [75, 85],\n      mean: 80.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n    \"noseWidth\": {\n      ideal: [38, 45],\n      mean: 41.5,\n      std_dev: 3.5,\n      flaws: {\n        low: [\"Narrow nose\"],\n        high: [\"Very wide nasal base\"]\n      }\n    },\n    \"noseBridgeWidth\": {\n      ideal: [14, 20],\n      mean: 17.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Narrow nose bridge\"],\n        high: [\"Wide nose bridge\"]\n      }\n    },\n\n    // CHEEKS - Rewards slightly fuller cheeks (Youth/K-Pop aesthetic)\n    \"cheekbone_height\": {\n      ideal: [80.0, 95.0],\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Hollow face\"]\n      }\n    },\n\n    // JAW - Slightly softer angles acceptable\n    \"gonial_angle\": {\n      ideal: [118, 128],\n      mean: 123.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/soft jaw structure\"]\n      }\n    },\n    \"mandibularPlaneAngle\": {\n      ideal: [20, 30],\n      mean: 25.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Flat mandibular plane\"],\n        high: [\"Steep mandibular plane\"]\n      }\n    },\n\n    // FACIAL PROPORTIONS - Wider faces more common\n    \"faceWidthToHeight\": {\n      ideal: [1.35, 1.50],\n      mean: 1.425,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n    \"totalFacialWidthToHeight\": {\n      ideal: [1.30, 1.45],\n      mean: 1.375,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face shape\"],\n        high: [\"Wide face shape\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE SOUTH ASIAN STANDARDS\n  // ========================================\n  \"male_south_asian\": {\n    // NOSE WIDTH - Slightly wider tolerance than White\n    \"noseWidth\": {\n      ideal: [36, 43],  // alar_base_ratio [1.00, 1.08]\n      mean: 39.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // TEAR TROUGH - VERY STRICT. High penalty for dark circles\n    \"tearTroughDepth\": {\n      ideal: [0.0, 0.5],\n      mean: 0.25,\n      std_dev: 0.25,\n      flaws: {\n        high: [\"Dark circles / Tear troughs\"]\n      }\n    },\n\n    // UPPER EYELID - Often prefers visible lid platform\n    \"upperEyelidExposure\": {\n      ideal: [0.5, 2.0],\n      mean: 1.25,\n      std_dev: 0.75,\n      flaws: {\n        low: [\"Hooded eyes\"]\n      }\n    },\n\n    // CHEEKS - Penalizes \"Gaunt\" looks heavily\n    \"cheekbone_height\": {\n      ideal: [83.0, 95.0],\n      mean: 89.0,\n      std_dev: 6.0,\n      flaws: {\n        low: [\"Volume loss / Gauntness\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE HISPANIC STANDARDS (\"The Bridge Model\")\n  // ========================================\n  \"male_hispanic\": {\n    // FACE WIDTH - Rewards broader, more robust face shapes (Mestizo)\n    \"faceWidthToHeight\": {\n      ideal: [1.95, 2.10],\n      mean: 2.025,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long/Narrow face\"]\n      }\n    },\n\n    // NOSE WIDTH - Bridge tolerance (Wider than White, narrower than Black)\n    \"noseWidth\": {\n      ideal: [36, 44],  // alar_base_ratio [1.00, 1.12]\n      mean: 40.0,\n      std_dev: 4.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for positive tilt\n    \"lateralCanthalTilt\": {\n      ideal: [6.0, 12.0],\n      mean: 9.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Negative/Neutral canthal tilt\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE MIDDLE EASTERN STANDARDS\n  // ========================================\n  \"male_middle_eastern\": {\n    // EYEBROW THICKNESS - Prefers significantly thicker/darker brows\n    \"eyebrowThickness\": {\n      ideal: [2.0, 4.0],\n      mean: 3.0,\n      std_dev: 1.0,\n      flaws: {\n        low: [\"Sparse/Weak eyebrows\"],\n        high: [\"Unibrow\"]\n      }\n    },\n\n    // NASOLABIAL ANGLE - Penalizes droopy tip (<90) or hooked noses\n    \"nasolabialAngle\": {\n      ideal: [90.0, 100.0],\n      mean: 95.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Droopy nose tip / Hooked nose\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for Almond/Hunter eye shape\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 10.0],\n      mean: 7.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    },\n\n    // MIDFACE - Similar to White model (Compact is better)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE PACIFIC ISLANDER STANDARDS (\"The Warrior Skull\")\n  // ========================================\n  \"male_pacific_islander\": {\n    // FACE WIDTH - The Highest Width Standard (Very broad)\n    \"faceWidthToHeight\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Narrow/Long face\"]\n      }\n    },\n\n    // NOSE WIDTH - Wide tolerance\n    \"noseWidth\": {\n      ideal: [38, 48],  // alar_base_ratio [1.05, 1.20]\n      mean: 43.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // CHEEKS - Rewards high mass/robustness\n    \"cheekbone_height\": {\n      ideal: [85.0, 100.0],\n      mean: 92.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Weak face structure\"]\n      }\n    },\n\n    // CHIN WIDTH - Prefers a very broad, square chin\n    \"chinWidth\": {\n      ideal: [40.0, 50.0],\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Pointed/Narrow chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // FEMALE ETHNICITIES (The \"Missing Link\")\n  // ========================================\n\n  \"female_white\": {\n    \"alar_base_ratio\": { ideal: [0.98, 1.05] },   // Strict Rule of Fifths\n    \"fwhr\": { ideal: [1.45, 1.53] },              // Oval/Narrow preference\n    \"gonial_angle\": { ideal: [122.0, 130.0] },    // Soft, tapered jawline\n    \"canthal_tilt\": { ideal: [4.0, 9.0] },        // Neutral to positive\n    \"chin_philtrum_ratio\": { ideal: [2.0, 2.2] }  // Golden Ratio balance\n  },\n\n  \"female_black\": {\n    \"lipRatio\": { ideal: [1.3, 1.6] },            // High volume preference (lower/upper lip ratio)\n    \"alar_base_ratio\": { ideal: [1.05, 1.15] },   // Wider tolerance\n    \"chin_projection\": { ideal: [0.0, 5.0] },     // Allows forward projection\n    \"gonial_angle\": { ideal: [120.0, 130.0] }     // Soft Feminine Jaw\n  },\n\n  \"female_east_asian\": {\n    \"eye_separation_ratio\": { ideal: [46.3, 47.5] }, // Wide-set (Neotenous) preference\n    \"gonial_angle\": { ideal: [120.0, 126.0] },       // Tapered V-shape\n    \"eyebrow_height\": { ideal: [0.85, 1.30] },       // Higher set brows\n    \"lower_third_ratio\": { ideal: [29.6, 32.7] }     // Compact lower face\n  },\n\n  \"female_south_asian\": {\n    \"tear_trough_depth\": { ideal: [0.0, 0.5] },      // Strict on dark circles\n    \"cheek_fullness\": { ideal: [1.0, 2.0] },         // Rewards midface volume\n    \"skin_uniformity\": { ideal: [0.92, 1.0] },       // High penalty for uneven tone\n    \"alar_base_ratio\": { ideal: [1.00, 1.08] }       // Intermediate tolerance\n  },\n\n  \"female_hispanic\": {\n    \"fwhr\": { ideal: [1.50, 1.62] },                 // Broader/Mestiza tolerance\n    \"canthal_tilt\": { ideal: [6.0, 12.0] },          // Strong Almond Eye preference\n    \"alar_base_ratio\": { ideal: [1.00, 1.10] },      // Intermediate width\n    \"lipRatio\": { ideal: [1.1, 1.35] }               // Voluptuous (lower/upper lip ratio)\n  },\n\n  \"female_middle_eastern\": {\n    \"eyebrow_thickness\": { ideal: [1.5, 3.0] },      // Dense/Thick brows\n    \"nasolabial_angle\": { ideal: [95.0, 105.0] },    // Refined/Upturned tip\n    \"canthal_tilt\": { ideal: [5.0, 10.0] },          // Foxy/Hunter feminine\n    \"upper_eyelid_exposure\": { ideal: [0.5, 1.5] }   // Low exposure\n  },\n\n  \"female_native_american\": {\n    \"fwhr\": { ideal: [1.52, 1.65] },                 // Wide/High Cheekbone structure\n    \"cheekbone_prominence\": { ideal: [1.5, 2.5] },   // High definition\n    \"gonial_angle\": { ideal: [115.0, 125.0] },       // Stronger jaw tolerance\n    \"canthal_tilt\": { ideal: [5.0, 11.0] }           // Positive tilt\n  },\n\n  \"female_pacific_islander\": {\n    \"fwhr\": { ideal: [1.55, 1.70] },                 // Widest/Robust ideal\n    \"cheek_fullness\": { ideal: [1.2, 2.5] },         // High volume/softness\n    \"alar_base_ratio\": { ideal: [1.05, 1.15] },      // Wide nose tolerance\n    \"lipRatio\": { ideal: [1.25, 1.50] }              // Full lips (lower/upper lip ratio)\n  }\n};\n\n/**\n * Get the appropriate metric configuration for a given gender and ethnicity\n * Falls back to base config if no override exists\n */\nexport function getMetricConfig(\n  metricId: string,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): MasterMetricConfig | undefined {\n  const key = `${gender}_${ethnicity}`;\n  const override = ETHNICITY_OVERRIDES[key]?.[metricId];\n  const baseConfig = MASTER_SCORING_DB[metricId];\n\n  if (!baseConfig) return undefined;\n\n  // Merge override with base config\n  if (override) {\n    return {\n      ...baseConfig,\n      ...override,\n      flaws: {\n        ...baseConfig.flaws,\n        ...override.flaws\n      }\n    } as MasterMetricConfig;\n  }\n\n  return baseConfig;\n}\n\n// ============================================\n// Z-SCORE SEVERITY FUNCTIONS\n// ============================================\n\n/**\n * Calculate Z-score for a given value\n * Z = (value - mean) / std_dev\n */\nexport function calculateZScore(value: number, mean: number, stdDev: number): number {\n  if (stdDev === 0) return 0;\n  return Math.abs((value - mean) / stdDev);\n}\n\n/**\n * Determine severity level based on Z-score and ideal range\n * - Ideal: Value is within ideal range\n * - Good: |z| < 1 (within 1 standard deviation)\n * - Moderate: 1 ≤ |z| < 2 (between 1-2 standard deviations)\n * - Severe: |z| ≥ 2 (more than 2 standard deviations away)\n */\nexport function getSeverityFromZScore(\n  value: number,\n  config: MasterMetricConfig\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean } {\n  const { ideal, mean, std_dev } = config;\n  const isInIdeal = value >= ideal[0] && value <= ideal[1];\n  const zScore = calculateZScore(value, mean, std_dev);\n\n  let severity: SeverityLevel;\n  if (isInIdeal) {\n    severity = 'ideal';\n  } else if (zScore < 1) {\n    severity = 'good';\n  } else if (zScore < 2) {\n    severity = 'moderate';\n  } else {\n    severity = 'severe';\n  }\n\n  return { severity, zScore, isInIdeal };\n}\n\n/**\n * Get severity for a metric value with ethnicity/gender awareness\n */\nexport function getSeverityForMetric(\n  metricId: string,\n  value: number,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean; config: MasterMetricConfig } | null {\n  const config = getMetricConfig(metricId, gender, ethnicity);\n  if (!config) return null;\n\n  const result = getSeverityFromZScore(value, config);\n  return { ...result, config };\n}\n\n/**\n * Get badge color for severity level\n */\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'green';\n    case 'good': return 'blue';\n    case 'moderate': return 'yellow';\n    case 'severe': return 'red';\n    default: return 'gray';\n  }\n}\n\n/**\n * Get severity label for display\n */\nexport function getSeverityLabel(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'Ideal';\n    case 'good': return 'Good';\n    case 'moderate': return 'Moderate';\n    case 'severe': return 'Severe';\n    default: return 'Unknown';\n  }\n}\n\n// ============================================\n// INSIGHT DEFINITION TYPES\n// ============================================\n\nexport interface InsightSeverityLogic {\n  metrics: string[];  // Display names of metrics (e.g., \"Face Width to Height Ratio\")\n  threshold: number;  // Score threshold for classification\n}\n\nexport interface WeaknessSeverityLabels {\n  minor: string;\n  moderate: string;\n  severe: string;\n}\n\nexport interface StrengthGradeLabels {\n  good: string;\n  excellent: string;\n  ideal: string;\n}\n\nexport interface InsightContent {\n  description: string;\n  severity_labels?: WeaknessSeverityLabels;  // For weaknesses\n  grade_labels?: StrengthGradeLabels;        // For strengths\n}\n\nexport interface InsightDefinition {\n  id: string;\n  title: string;\n  type: 'weakness' | 'strength';\n  severity_logic: InsightSeverityLogic;\n  content: InsightContent;\n}\n\n// ============================================\n// CLASSIFICATION RESULT TYPES\n// ============================================\n\nexport type WeaknessSeverity = 'severe' | 'moderate' | 'minor';\nexport type StrengthGrade = 'ideal' | 'excellent' | 'good';\n\nexport interface ClassifiedWeakness {\n  insightId: string;\n  title: string;\n  description: string;\n  severity: WeaknessSeverity;\n  severityLabel: string;  // Custom label from definition (e.g., \"Extremely Long\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface ClassifiedStrength {\n  insightId: string;\n  title: string;\n  description: string;\n  grade: StrengthGrade;\n  gradeLabel: string;  // Custom label from definition (e.g., \"Ideal\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface MatchedMetric {\n  metricId: string;\n  metricName: string;\n  score: number;\n  value: number;\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category: string;\n}\n\nexport interface InsightClassificationResult {\n  strengths: ClassifiedStrength[];\n  weaknesses: ClassifiedWeakness[];\n}\n\n// ============================================\n// INSIGHTS DATABASE\n// ============================================\n\nexport const INSIGHTS_DEFINITIONS: InsightDefinition[] = [\n  {\n    id: \"long_midface\",\n    title: \"Long Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\", \"Ipsilateral Alar Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The middle of the face is elongated, creating an unbalanced vertical proportion.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Extremely Long\" }\n    }\n  },\n  {\n    id: \"short_midface\",\n    title: \"Short Midface\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The midface has ideal vertical proportions, contributing to facial harmony.\",\n      grade_labels: { good: \"Proportionate\", excellent: \"Well-Balanced\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"weak_jaw\",\n    title: \"Weak/Soft Jaw Structure\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Chin to Philtrum Ratio\", \"Jaw Slope\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw has a softer, rounder shape, often less angular and robust than the ideal.\",\n      severity_labels: { minor: \"Soft\", moderate: \"Recessed\", severe: \"Weak\" }\n    }\n  },\n  {\n    id: \"strong_jaw\",\n    title: \"Strong Jaw Definition\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Jaw Width Ratio\", \"Bigonial Width\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The jaw displays strong definition with well-defined angles and proportionate width.\",\n      grade_labels: { good: \"Defined\", excellent: \"Strong\", ideal: \"Ideal Angular\" }\n    }\n  },\n  {\n    id: \"refined_nasal_tip\",\n    title: \"Refined Nasal Tip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasal Tip Angle\", \"Nose Tip Position\", \"Frankfort-tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious nasal profile due to the nasal tip being well-defined and proportionate.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"bulbous_nose\",\n    title: \"Bulbous Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Nose Width\", \"Nasal Tip Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip appears rounded and less defined, affecting nasal aesthetics.\",\n      severity_labels: { minor: \"Slightly Rounded\", moderate: \"Rounded\", severe: \"Bulbous\" }\n    }\n  },\n  {\n    id: \"ideal_upper_lip\",\n    title: \"Well-Positioned Upper Lip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Lip E-Line Position\", \"Upper Lip S-Line Position\", \"Nasolabial Angle\"],\n      threshold: 9.0\n    },\n    content: {\n      description: \"This contributes to a harmonious mouth region due to the upper lip sitting neither too far forward nor too far back.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"negative_canthal_tilt\",\n    title: \"Negative Canthal Tilt\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The outer corners of the eyes sit lower than the inner corners, creating a downturned appearance.\",\n      severity_labels: { minor: \"Slight Downturn\", moderate: \"Noticeable\", severe: \"Pronounced\" }\n    }\n  },\n  {\n    id: \"positive_canthal_tilt\",\n    title: \"Positive Canthal Tilt\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The outer corners of the eyes are elevated, creating an attractive upswept eye shape.\",\n      grade_labels: { good: \"Slight Upturn\", excellent: \"Well-Tilted\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"balanced_facial_thirds\",\n    title: \"Balanced Facial Thirds\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays well-balanced vertical proportions across all three facial thirds.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfectly Proportioned\" }\n    }\n  },\n  {\n    id: \"imbalanced_thirds\",\n    title: \"Facial Third Imbalance\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The vertical face proportions show imbalance between the three facial thirds.\",\n      severity_labels: { minor: \"Slight Imbalance\", moderate: \"Noticeable Disproportion\", severe: \"Significant Imbalance\" }\n    }\n  },\n  {\n    id: \"high_cheekbones\",\n    title: \"High Cheekbones\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Cheekbone Width\", \"Midface Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"Well-positioned cheekbones that create attractive facial contours and catch light beautifully.\",\n      grade_labels: { good: \"Visible\", excellent: \"Prominent\", ideal: \"Model-Tier\" }\n    }\n  },\n  {\n    id: \"flat_midface\",\n    title: \"Flat Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Total Facial Width to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The midface lacks forward projection, resulting in flatter facial contours.\",\n      severity_labels: { minor: \"Slightly Flat\", moderate: \"Underprojected\", severe: \"Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_lip_ratio\",\n    title: \"Ideal Lip Proportions\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Philtrum Length\", \"Lip Chin Distance\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Well-Proportioned\", ideal: \"Perfect Ratio\" }\n    }\n  },\n  {\n    id: \"thin_lips\",\n    title: \"Thin Lip Profile\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Upper Lip Projection\", \"Lower Lip Projection\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The lips appear thinner than ideal proportions, affecting lower face harmony.\",\n      severity_labels: { minor: \"Slightly Thin\", moderate: \"Thin\", severe: \"Very Thin\" }\n    }\n  },\n  {\n    id: \"ideal_ipd\",\n    title: \"Ideal Eye Spacing\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes are ideally spaced, creating facial balance and attractiveness.\",\n      grade_labels: { good: \"Good Spacing\", excellent: \"Ideal Distance\", ideal: \"Perfect IPD\" }\n    }\n  },\n  {\n    id: \"wide_set_eyes\",\n    title: \"Wide-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are spaced wider apart than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Noticeably Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"close_set_eyes\",\n    title: \"Close-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"Intercanthal Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are positioned closer together than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Close\", moderate: \"Noticeably Close\", severe: \"Very Close\" }\n    }\n  },\n  {\n    id: \"ideal_nose_projection\",\n    title: \"Ideal Nasal Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofrontal Angle\", \"Nasofacial Angle\", \"Nasomenta Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The nose has ideal forward projection relative to the face, creating profile harmony.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect Projection\" }\n    }\n  },\n  {\n    id: \"recessed_chin\",\n    title: \"Recessed Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Facial Depth to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The chin sits behind the ideal position, affecting profile balance.\",\n      severity_labels: { minor: \"Slightly Recessed\", moderate: \"Recessed\", severe: \"Severely Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_chin_projection\",\n    title: \"Ideal Chin Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The chin demonstrates ideal projection and proportions relative to the face.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect\" }\n    }\n  },\n  {\n    id: \"long_philtrum\",\n    title: \"Long Philtrum\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Lip Chin Distance\", \"Upper Lip Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The distance between nose and upper lip is longer than ideal.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"short_philtrum\",\n    title: \"Short Philtrum\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Upper Lip Height\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The philtrum has ideal or shorter length, considered youthful and attractive.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Short\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"wide_nose\",\n    title: \"Wide Nasal Base\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Intercanthal Nasal Ratio\", \"Nose Bridge Width\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The base of the nose is wider than the aesthetic ideal for facial harmony.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"ideal_brow_position\",\n    title: \"Ideal Brow Position\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow Length Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The eyebrows are ideally positioned relative to the eyes and facial structure.\",\n      grade_labels: { good: \"Good Position\", excellent: \"Well-Arched\", ideal: \"Perfect Frame\" }\n    }\n  },\n  {\n    id: \"narrow_jaw\",\n    title: \"Narrow Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Jaw Width Ratio\", \"Bigonial Width\", \"Jaw Frontal Angle\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw is narrower than ideal, affecting lower face width and definition.\",\n      severity_labels: { minor: \"Slightly Narrow\", moderate: \"Narrow\", severe: \"Very Narrow\" }\n    }\n  },\n  {\n    id: \"steep_mandibular_plane\",\n    title: \"Steep Mandibular Plane\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The mandibular plane angle is steeper than ideal, often indicating vertical growth pattern.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  // ============================================\n  // SCRAPED FROM FACEIQ (element.html / element1.html)\n  // ============================================\n  // --- WEAKNESSES ---\n  {\n    id: \"steep_jaw\",\n    title: \"Steep Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Jaw Frontal Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The jaw angles sharply downward, creating a narrow or pointed chin effect.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  {\n    id: \"maxillary_recession\",\n    title: \"Maxillary Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Facial Depth to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The upper jaw is less forward than ideal, reducing midface projection and facial harmony.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"mandibular_recession\",\n    title: \"Mandibular Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The lower jaw is set back, creating a less prominent chin and an unbalanced profile.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"underprojected_chin\",\n    title: \"Underprojected Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\", \"Chin Height\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The chin lacks forward projection, creating a weak lower face appearance.\",\n      severity_labels: { minor: \"Slightly Weak\", moderate: \"Underprojected\", severe: \"Severely Underprojected\" }\n    }\n  },\n  {\n    id: \"overly_long_face\",\n    title: \"Overly Long Face Shape\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Total Facial Width to Height Ratio\", \"Face Width to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The face is excessively tall and narrow, creating an elongated appearance.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"hyper_divergent_jaw\",\n    title: \"Hyper-Divergent Jaw Growth\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The jaw grows with an overly steep angle, resulting in a long or narrow lower face. This can indicate malocclusion.\",\n      severity_labels: { minor: \"Mildly Divergent\", moderate: \"Divergent\", severe: \"Hyper-Divergent\" }\n    }\n  },\n  {\n    id: \"weak_brow_ridge\",\n    title: \"Soft/Weak Brow Ridge\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Eyebrow Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The forehead has a softer, less prominent ridge than the ideal, reducing masculine definition.\",\n      severity_labels: { minor: \"Slightly Soft\", moderate: \"Soft\", severe: \"Very Weak\" }\n    }\n  },\n  {\n    id: \"droopy_nasal_tip\",\n    title: \"Droopy Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\", \"Nasofacial Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip points downward more than ideal, creating a drooping appearance.\",\n      severity_labels: { minor: \"Slightly Droopy\", moderate: \"Droopy\", severe: \"Very Droopy\" }\n    }\n  },\n  {\n    id: \"overprojected_nose\",\n    title: \"Overprojected Nose\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Projection\", \"Nasofacial Angle\", \"Nose Length Ratio\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nose projects too far forward relative to the face, creating imbalance.\",\n      severity_labels: { minor: \"Slightly Projected\", moderate: \"Overprojected\", severe: \"Very Overprojected\" }\n    }\n  },\n  {\n    id: \"small_eyes\",\n    title: \"Small Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Palpebral Fissure Length\", \"Eye Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes appear smaller than the aesthetic ideal relative to the face.\",\n      severity_labels: { minor: \"Slightly Small\", moderate: \"Small\", severe: \"Very Small\" }\n    }\n  },\n  {\n    id: \"low_set_eyebrows\",\n    title: \"Low-Set Eyebrows\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow to Hairline Distance\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyebrows sit lower than ideal, reducing the visible upper eyelid space.\",\n      severity_labels: { minor: \"Slightly Low\", moderate: \"Low\", severe: \"Very Low\" }\n    }\n  },\n  {\n    id: \"asymmetrical_face\",\n    title: \"Facial Asymmetry\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The left and right sides of the face show noticeable differences in proportion or position.\",\n      severity_labels: { minor: \"Slight Asymmetry\", moderate: \"Noticeable Asymmetry\", severe: \"Significant Asymmetry\" }\n    }\n  },\n  // --- STRENGTHS ---\n  {\n    id: \"good_jaw_width\",\n    title: \"Good Jaw Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Bigonial Width\", \"Jaw Width Ratio\", \"Jaw Frontal Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant jaw contour due to the jaw being neither too wide nor too narrow.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"good_forehead_slope\",\n    title: \"Good Forehead Slope\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Forehead Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant forehead contour by indicating that the forehead is neither too steep nor too flat.\",\n      grade_labels: { good: \"Good Slope\", excellent: \"Well-Angled\", ideal: \"Ideal Slope\" }\n    }\n  },\n  {\n    id: \"good_cupids_bow\",\n    title: \"Good Cupid's Bow Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cupids Bow Depth\", \"Upper Lip Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lip region due to the cupid's bow having ideal definition and depth.\",\n      grade_labels: { good: \"Defined\", excellent: \"Well-Defined\", ideal: \"Perfectly Defined\" }\n    }\n  },\n  {\n    id: \"good_eyebrow_length\",\n    title: \"Good Eyebrow Length\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Brow Length to Face Width Ratio\", \"Brow Length Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious eye region due to the eyebrows having ideal horizontal length relative to face width.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Well-Proportioned\", ideal: \"Ideal Length\" }\n    }\n  },\n  {\n    id: \"good_neck_width\",\n    title: \"Good Neck Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Neck Width\", \"Neck to Jaw Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lower face due to the neck being neither too wide nor too thin.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"ideal_nasolabial_angle\",\n    title: \"Ideal Nasolabial Angle\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The angle between nose and upper lip is in the ideal range, creating profile harmony.\",\n      grade_labels: { good: \"Good Angle\", excellent: \"Well-Angled\", ideal: \"Perfect Angle\" }\n    }\n  },\n  {\n    id: \"ideal_facial_depth\",\n    title: \"Ideal Facial Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Depth to Height Ratio\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face has ideal forward projection creating attractive three-dimensional contours.\",\n      grade_labels: { good: \"Good Depth\", excellent: \"Well-Projected\", ideal: \"Ideal Projection\" }\n    }\n  },\n  {\n    id: \"ideal_eye_shape\",\n    title: \"Ideal Eye Shape\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Lateral Canthal Tilt\", \"Palpebral Fissure Length\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes have an attractive almond shape with ideal proportions and tilt.\",\n      grade_labels: { good: \"Attractive\", excellent: \"Well-Shaped\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"harmonious_profile\",\n    title: \"Harmonious Profile\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Total Profile Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The facial profile shows excellent balance between nose, lips, and chin positions.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfect Profile\" }\n    }\n  },\n  {\n    id: \"good_facial_symmetry\",\n    title: \"Good Facial Symmetry\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays excellent bilateral symmetry, a key component of attractiveness.\",\n      grade_labels: { good: \"Symmetric\", excellent: \"Very Symmetric\", ideal: \"Near-Perfect Symmetry\" }\n    }\n  }\n];\n\n// ============================================\n// METRIC NAME MAPPING\n// ============================================\n\n// Map display names to metric IDs for lookup\nconst METRIC_NAME_TO_ID: Record<string, string> = {\n  // Face Shape/Proportions\n  \"Face Width to Height Ratio\": \"faceWidthToHeight\",\n  \"Total Facial Width to Height\": \"totalFacialWidthToHeight\",\n  \"Total Facial Width to Height Ratio\": \"totalFacialWidthToHeight\",\n  \"Midface Ratio\": \"midfaceRatio\",\n  \"Upper Third Proportion\": \"upperThirdProportion\",\n  \"Middle Third Proportion\": \"middleThirdProportion\",\n  \"Lower Third Proportion\": \"lowerThirdProportion\",\n  \"Cheekbone Height\": \"cheekboneHeight\",\n  \"Cheekbone Width\": \"cheekboneWidth\",\n  \"Bitemporal Width\": \"bitemporalWidth\",\n  \"Forehead Height\": \"foreheadHeight\",\n  \"Facial Asymmetry Index\": \"facialAsymmetryIndex\",\n\n  // Jaw\n  \"Gonial Angle\": \"gonialAngle\",\n  \"Mandibular Plane Angle\": \"mandibularPlaneAngle\",\n  \"Jaw Width Ratio\": \"jawWidthRatio\",\n  \"Bigonial Width\": \"bigonialWidth\",\n  \"Jaw Frontal Angle\": \"jawFrontalAngle\",\n  \"Jaw Slope\": \"jawSlope\",\n  \"Jaw Asymmetry\": \"jawAsymmetry\",\n\n  // Chin\n  \"Chin to Philtrum Ratio\": \"chinPhiltrumRatio\",\n  \"Chin Height\": \"chinHeight\",\n  \"Facial Depth to Height\": \"facialDepthToHeight\",\n  \"Facial Depth to Height Ratio\": \"facialDepthToHeight\",\n  \"Anterior Facial Depth\": \"anteriorFacialDepth\",\n  \"Recession Relative to Frankfort Plane\": \"recessionFrankfort\",\n\n  // Eyes\n  \"Lateral Canthal Tilt\": \"lateralCanthalTilt\",\n  \"Eye Aspect Ratio\": \"eyeAspectRatio\",\n  \"Eye Separation Ratio\": \"eyeSeparationRatio\",\n  \"Interpupillary Ratio\": \"interpupillaryRatio\",\n  \"One Eye Apart Test\": \"oneEyeApartTest\",\n  \"Intercanthal Width\": \"intercanthalWidth\",\n  \"Eyebrow Height\": \"eyebrowHeight\",\n  \"Brow Length Ratio\": \"browLengthRatio\",\n  \"Brow Length to Face Width Ratio\": \"browLengthToFaceWidth\",\n  \"Palpebral Fissure Length\": \"palpebralFissureLength\",\n  \"Eye Width\": \"eyeWidth\",\n  \"Eye Asymmetry\": \"eyeAsymmetry\",\n  \"Brow to Hairline Distance\": \"browToHairlineDistance\",\n\n  // Brow\n  \"Browridge Inclination Angle\": \"browridgeInclinationAngle\",\n\n  // Nose\n  \"Nasal Index\": \"nasalIndex\",\n  \"Nasal Tip Angle\": \"nasalTipAngle\",\n  \"Nose Tip Position\": \"noseTipPosition\",\n  \"Frankfort-tip Angle\": \"frankfortTipAngle\",\n  \"Nasofrontal Angle\": \"nasofrontalAngle\",\n  \"Nasofacial Angle\": \"nasofacialAngle\",\n  \"Nasomenta Angle\": \"nasomentaAngle\",\n  \"Nasomental Angle\": \"nasomentaAngle\",\n  \"Intercanthal Nasal Ratio\": \"intercanthalNasalRatio\",\n  \"Nose Bridge Width\": \"noseBridgeWidth\",\n  \"Nose Width\": \"noseWidth\",\n  \"Nasal Projection\": \"nasalProjection\",\n  \"Nose Length Ratio\": \"noseLengthRatio\",\n  \"Ipsilateral Alar Angle\": \"ipsilateralAlarAngle\",\n\n  // Lips\n  \"Lip Ratio\": \"lipRatio\",\n  \"Philtrum Length\": \"philtrumLength\",\n  \"Upper Lip Projection\": \"upperLipProjection\",\n  \"Lower Lip Projection\": \"lowerLipProjection\",\n  \"Lip Chin Distance\": \"lipChinDistance\",\n  \"Upper Lip Height\": \"upperLipHeight\",\n  \"Upper Lip E-Line Position\": \"upperLipELine\",\n  \"Upper Lip S-Line Position\": \"upperLipSLine\",\n  \"Nasolabial Angle\": \"nasolabialAngle\",\n  \"Cupids Bow Depth\": \"cupidsBowDepth\",\n\n  // Neck\n  \"Neck Width\": \"neckWidth\",\n  \"Neck to Jaw Ratio\": \"neckToJawRatio\",\n\n  // Profile\n  \"Total Profile Angle\": \"totalProfileAngle\",\n};\n\n// ============================================\n// CLASSIFICATION FUNCTIONS\n// ============================================\n\n/**\n * Get weakness severity based on average score\n * 0-3 = \"Severe\", 3-5 = \"Moderate\", 5-7 = \"Minor\"\n */\nfunction getWeaknessSeverity(avgScore: number): WeaknessSeverity {\n  if (avgScore <= 3) return 'severe';\n  if (avgScore <= 5) return 'moderate';\n  return 'minor';\n}\n\n/**\n * Get strength grade based on average score\n * 8-9 = \"Good\", 9-9.5 = \"Excellent\", 9.5-10 = \"Ideal\"\n */\nfunction getStrengthGrade(avgScore: number): StrengthGrade {\n  if (avgScore >= 9.5) return 'ideal';\n  if (avgScore >= 9) return 'excellent';\n  return 'good';\n}\n\n/**\n * Find metric by display name from measurements array\n */\nfunction findMetricByName(\n  metricName: string,\n  measurements: FaceIQScoreResult[]\n): FaceIQScoreResult | undefined {\n  // First try direct ID mapping\n  const metricId = METRIC_NAME_TO_ID[metricName];\n  if (metricId) {\n    return measurements.find(m => m.metricId === metricId);\n  }\n\n  // Fallback: try fuzzy matching on name\n  const normalizedName = metricName.toLowerCase().replace(/[^a-z0-9]/g, '');\n  return measurements.find(m => {\n    const normalizedMetricName = m.name.toLowerCase().replace(/[^a-z0-9]/g, '');\n    return normalizedMetricName.includes(normalizedName) ||\n           normalizedName.includes(normalizedMetricName);\n  });\n}\n\n/**\n * Check if a metric should be considered a \"false positive\" weakness.\n * This handles directional/dimorphic metrics where low scores don't mean weakness.\n *\n * Example: Canthal Tilt of 3° gets a low score (not in 6-8° ideal range)\n * but is still a POSITIVE trait, not a weakness.\n */\nfunction isFalsePositiveWeakness(metric: MatchedMetric): boolean {\n  const config = FACEIQ_METRICS[metric.metricId];\n  if (!config) return false;\n\n  // Check if the value is actually acceptable based on polarity\n  const { acceptable } = isValueAcceptable(metric.value, config);\n  return acceptable;\n}\n\n/**\n * Process all insight definitions against user's measurements\n */\nexport function classifyInsights(\n  measurements: FaceIQScoreResult[],\n  insightDefinitions: InsightDefinition[] = INSIGHTS_DEFINITIONS\n): InsightClassificationResult {\n  const strengths: ClassifiedStrength[] = [];\n  const weaknesses: ClassifiedWeakness[] = [];\n\n  for (const insight of insightDefinitions) {\n    const { metrics, threshold } = insight.severity_logic;\n\n    // Find matching measurements for this insight\n    const matchedMetrics: MatchedMetric[] = [];\n    for (const metricName of metrics) {\n      const measurement = findMetricByName(metricName, measurements);\n      if (measurement) {\n        matchedMetrics.push({\n          metricId: measurement.metricId,\n          metricName: measurement.name,\n          score: measurement.score,\n          value: measurement.value,\n          idealMin: measurement.idealMin,\n          idealMax: measurement.idealMax,\n          unit: measurement.unit,\n          category: measurement.category,\n        });\n      }\n    }\n\n    // Skip if no metrics matched (need at least 1)\n    if (matchedMetrics.length === 0) continue;\n\n    // Calculate average score\n    const avgScore = matchedMetrics.reduce((sum, m) => sum + m.score, 0) / matchedMetrics.length;\n\n    // Classify based on type and threshold\n    if (insight.type === 'weakness') {\n      // Weakness: avg < threshold → add to areas of improvement\n      if (avgScore < threshold) {\n        // ========== FALSE POSITIVE CHECK ==========\n        // Before adding to weaknesses, check if ANY of the matched metrics\n        // are actually in an \"acceptable\" zone based on their polarity.\n        // If so, this is a false positive and should be skipped or reclassified.\n        const falsePositiveMetrics = matchedMetrics.filter(isFalsePositiveWeakness);\n\n        // If ALL matched metrics are false positives, skip this weakness entirely\n        if (falsePositiveMetrics.length === matchedMetrics.length) {\n          // This is a false positive weakness - the values are actually acceptable\n          // Consider adding to strengths if scores are decent\n          if (avgScore >= 6) {\n            strengths.push({\n              insightId: `${insight.id}_acceptable`,\n              title: insight.title.replace('Negative', 'Neutral').replace('Weak', 'Moderate'),\n              description: `While not in the peak ideal range, the measured values are within acceptable limits.`,\n              grade: 'good',\n              gradeLabel: 'Acceptable',\n              avgScore,\n              matchedMetrics,\n            });\n          }\n          continue; // Skip adding as weakness\n        }\n\n        // If SOME metrics are false positives, filter them out\n        const trueWeaknessMetrics = matchedMetrics.filter(m => !isFalsePositiveWeakness(m));\n        if (trueWeaknessMetrics.length === 0) continue;\n\n        // Recalculate average with only true weakness metrics\n        const trueAvgScore = trueWeaknessMetrics.reduce((sum, m) => sum + m.score, 0) / trueWeaknessMetrics.length;\n\n        // Only add as weakness if true average is still below threshold\n        if (trueAvgScore < threshold) {\n          const severity = getWeaknessSeverity(trueAvgScore);\n          const labels = insight.content.severity_labels;\n          const severityLabel = labels?.[severity] || severity;\n\n          weaknesses.push({\n            insightId: insight.id,\n            title: insight.title,\n            description: insight.content.description,\n            severity,\n            severityLabel,\n            avgScore: trueAvgScore,\n            matchedMetrics: trueWeaknessMetrics,\n          });\n        }\n      }\n    } else {\n      // Strength: avg > threshold → add to key strengths\n      if (avgScore > threshold) {\n        const grade = getStrengthGrade(avgScore);\n        const labels = insight.content.grade_labels;\n        const gradeLabel = labels?.[grade] || grade;\n\n        strengths.push({\n          insightId: insight.id,\n          title: insight.title,\n          description: insight.content.description,\n          grade,\n          gradeLabel,\n          avgScore,\n          matchedMetrics,\n        });\n      }\n    }\n  }\n\n  // Sort by score (weaknesses by lowest score first, strengths by highest first)\n  weaknesses.sort((a, b) => a.avgScore - b.avgScore);\n  strengths.sort((a, b) => b.avgScore - a.avgScore);\n\n  return { strengths, weaknesses };\n}\n\n/**\n * Convert ClassifiedStrength to Strength type for UI compatibility\n */\nexport function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: classified.avgScore,\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  const impact = (10 - classified.avgScore) * 0.5 * classified.matchedMetrics.length;\n  const newRollingLost = rollingLost + impact;\n\n  return {\n    id: `insight_flaw_${classified.insightId}`,\n    flawName: `${classified.title} (${classified.severityLabel})`,\n    summary: classified.description,\n    harmonyPercentageLost: impact,\n    standardizedImpact: impact / 10,\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,\n    rollingHarmonyPercentageLost: newRollingLost,\n    rollingStandardizedImpact: newRollingLost / 10,\n  };\n}\n\n/**\n * Main function: Generate strengths and flaws from measurements using insights\n */\nexport function generateInsightBasedResults(\n  measurements: FaceIQScoreResult[]\n): { strengths: Strength[]; flaws: Flaw[] } {\n  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);\n\n  // Convert to UI-compatible types\n  const strengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n  let rollingLost = 0;\n  const flaws = classifiedWeaknesses.map((w, i) => {\n    const flaw = convertToFlaw(w, i, rollingLost);\n    rollingLost = flaw.rollingPointsDeducted || 0;\n    return flaw;\n  });\n\n  return { strengths, flaws };\n}\n","numLines":2282,"startLine":1,"totalLines":2282}}}
{"parentUuid":"244525ca-8469-4cb3-b374-36090ebc0689","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015b46P315VAjNFEjfABUyDt","type":"message","role":"assistant","content":[{"type":"text","text":"Let me search for related files more directly."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13607,"cache_creation_input_tokens":37109,"cache_read_input_tokens":12720,"cache_creation":{"ephemeral_5m_input_tokens":37109,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWLkVo4Bgu6BpEDgodB9X","type":"assistant","uuid":"4a5bc880-76b6-4c61-88fd-97afd2396e9a","timestamp":"2025-12-22T00:06:59.720Z"}
{"parentUuid":"4a5bc880-76b6-4c61-88fd-97afd2396e9a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015b46P315VAjNFEjfABUyDt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JCtKT91cRbNrVHKW8PRYmR","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/PlanActionCard.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13607,"cache_creation_input_tokens":37109,"cache_read_input_tokens":12720,"cache_creation":{"ephemeral_5m_input_tokens":37109,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWLkVo4Bgu6BpEDgodB9X","type":"assistant","uuid":"8f745dba-3c08-49f3-9472-e8e920ed03ce","timestamp":"2025-12-22T00:07:00.370Z"}
{"parentUuid":"8f745dba-3c08-49f3-9472-e8e920ed03ce","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015b46P315VAjNFEjfABUyDt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RzfS7HFmYxX8hSQy8Ro2F2","name":"Grep","input":{"pattern":"product|affiliate|monetiz|commerce","type":"ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":13607,"cache_creation_input_tokens":37109,"cache_read_input_tokens":12720,"cache_creation":{"ephemeral_5m_input_tokens":37109,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWLkVo4Bgu6BpEDgodB9X","type":"assistant","uuid":"5fed28e2-b5ad-469a-84c4-e946883a63c2","timestamp":"2025-12-22T00:07:00.683Z"}
{"parentUuid":"5fed28e2-b5ad-469a-84c4-e946883a63c2","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JCtKT91cRbNrVHKW8PRYmR","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import React from 'react';\n     4→import { DollarSign, Clock, AlertTriangle, BookOpen, CheckCircle, ChevronDown, ChevronUp } from 'lucide-react';\n     5→\n     6→// ============================================\n     7→// TYPES\n     8→// ============================================\n     9→\n    10→interface TriggerReason {\n    11→  metric: string;\n    12→  value: number;\n    13→  threshold: number;\n    14→  operator?: '<' | '>';\n    15→}\n    16→\n    17→interface PlanContent {\n    18→  description: string;\n    19→  cost_min: number;\n    20→  cost_max: number;\n    21→  time_min: string;\n    22→  time_max: string;\n    23→  risks: string;\n    24→  citations: string[];\n    25→  tags?: string[];\n    26→}\n    27→\n    28→export interface Plan {\n    29→  id: string;\n    30→  title: string;\n    31→  content: PlanContent;\n    32→  trigger_reason?: TriggerReason[];\n    33→}\n    34→\n    35→interface PlanActionCardProps {\n    36→  plan: Plan;\n    37→  defaultExpanded?: boolean;\n    38→}\n    39→\n    40→// ============================================\n    41→// COMPONENT\n    42→// ============================================\n    43→\n    44→export const PlanActionCard: React.FC<PlanActionCardProps> = ({ plan, defaultExpanded = false }) => {\n    45→  const [isExpanded, setIsExpanded] = React.useState(defaultExpanded);\n    46→\n    47→  // Format cost display\n    48→  const formatCost = () => {\n    49→    const { cost_min, cost_max } = plan.content;\n    50→    if (cost_min === 0 && cost_max === 0) {\n    51→      return 'Free';\n    52→    }\n    53→    if (cost_min === cost_max) {\n    54→      return `$${cost_min.toLocaleString()}`;\n    55→    }\n    56→    return `$${cost_min.toLocaleString()} - $${cost_max.toLocaleString()}`;\n    57→  };\n    58→\n    59→  // Format timeline display\n    60→  const formatTimeline = () => {\n    61→    const { time_min, time_max } = plan.content;\n    62→    if (time_min === time_max || !time_max) {\n    63→      return time_min;\n    64→    }\n    65→    return `${time_min} - ${time_max}`;\n    66→  };\n    67→\n    68→  return (\n    69→    <div className=\"bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all duration-200 shadow-sm\">\n    70→      <div className=\"p-5\">\n    71→        <div className=\"flex justify-between items-start gap-4\">\n    72→          <div className=\"flex-1\">\n    73→            {/* Header */}\n    74→            <div className=\"flex items-center gap-3 mb-2\">\n    75→              <h3 className=\"text-base font-semibold text-gray-900\">{plan.title}</h3>\n    76→              <div className=\"flex gap-2\">\n    77→                {/* Dynamic Tags */}\n    78→                {plan.content.tags?.map((tag) => (\n    79→                  <span\n    80→                    key={tag}\n    81→                    className=\"text-[10px] uppercase font-semibold px-2 py-0.5 rounded-md bg-blue-50 text-blue-700 border border-blue-100\"\n    82→                  >\n    83→                    {tag}\n    84→                  </span>\n    85→                ))}\n    86→              </div>\n    87→            </div>\n    88→\n    89→            <p className=\"text-sm text-gray-500 leading-relaxed mb-4\">\n    90→              {plan.content.description}\n    91→            </p>\n    92→\n    93→            {/* Quick Stats Row */}\n    94→            <div className=\"flex items-center gap-6 text-xs text-gray-500\">\n    95→              <div className=\"flex items-center gap-1.5\" title=\"Estimated Cost\">\n    96→                <DollarSign className=\"w-3.5 h-3.5 text-gray-400\" />\n    97→                <span className=\"font-medium\">{formatCost()}</span>\n    98→              </div>\n    99→              <div className=\"flex items-center gap-1.5\" title=\"Timeline\">\n   100→                <Clock className=\"w-3.5 h-3.5 text-gray-400\" />\n   101→                <span className=\"font-medium\">{formatTimeline()}</span>\n   102→              </div>\n   103→            </div>\n   104→          </div>\n   105→\n   106→          {/* Toggle Button */}\n   107→          <button\n   108→            onClick={() => setIsExpanded(!isExpanded)}\n   109→            className=\"p-1.5 rounded-md hover:bg-gray-100 text-gray-400 transition-colors\"\n   110→            aria-label={isExpanded ? 'Collapse details' : 'Expand details'}\n   111→          >\n   112→            {isExpanded ? <ChevronUp className=\"w-5 h-5\" /> : <ChevronDown className=\"w-5 h-5\" />}\n   113→          </button>\n   114→        </div>\n   115→      </div>\n   116→\n   117→      {/* Expandable Section (The \"Why\" and \"Risks\") */}\n   118→      {isExpanded && (\n   119→        <div className=\"bg-gray-50/50 border-t border-gray-100 p-5 space-y-4\">\n   120→\n   121→          {/* Why this was recommended (Trigger Rules) */}\n   122→          {plan.trigger_reason && plan.trigger_reason.length > 0 && (\n   123→            <div>\n   124→              <h4 className=\"flex items-center gap-2 text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2\">\n   125→                <CheckCircle className=\"w-3.5 h-3.5 text-emerald-500\" />\n   126→                Why Recommended\n   127→              </h4>\n   128→              <div className=\"flex flex-wrap gap-2\">\n   129→                {plan.trigger_reason.map((reason, i) => (\n   130→                  <div\n   131→                    key={i}\n   132→                    className=\"inline-flex items-center gap-1.5 px-2.5 py-1 bg-white border border-gray-200 rounded-md text-xs font-medium text-gray-700 shadow-sm\"\n   133→                  >\n   134→                    <span>{reason.metric}: {reason.value.toFixed(1)}</span>\n   135→                    <span className=\"text-gray-400 text-[10px]\">\n   136→                      ({reason.operator === '>' ? 'above' : 'below'} {reason.threshold})\n   137→                    </span>\n   138→                  </div>\n   139→                ))}\n   140→              </div>\n   141→            </div>\n   142→          )}\n   143→\n   144→          {/* Risks */}\n   145→          {plan.content.risks && (\n   146→            <div>\n   147→              <h4 className=\"flex items-center gap-2 text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2\">\n   148→                <AlertTriangle className=\"w-3.5 h-3.5 text-amber-500\" />\n   149→                Risks & Considerations\n   150→              </h4>\n   151→              <div className=\"bg-amber-50/50 p-3 rounded-lg border border-amber-100 text-xs text-amber-900/80 leading-relaxed\">\n   152→                {plan.content.risks}\n   153→              </div>\n   154→            </div>\n   155→          )}\n   156→\n   157→          {/* Research */}\n   158→          {plan.content.citations && plan.content.citations.length > 0 && (\n   159→            <div>\n   160→              <h4 className=\"flex items-center gap-2 text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2\">\n   161→                <BookOpen className=\"w-3.5 h-3.5 text-blue-500\" />\n   162→                Research\n   163→              </h4>\n   164→              <div className=\"text-xs text-blue-800 bg-blue-50/50 p-3 rounded-lg border border-blue-100\">\n   165→                {plan.content.citations.join(\", \")}\n   166→              </div>\n   167→            </div>\n   168→          )}\n   169→\n   170→        </div>\n   171→      )}\n   172→    </div>\n   173→  );\n   174→};\n   175→\n   176→export default PlanActionCard;\n   177→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e5de200a-5a13-4c68-b287-768f118a8103","timestamp":"2025-12-22T00:07:00.743Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/PlanActionCard.tsx","content":"'use client';\n\nimport React from 'react';\nimport { DollarSign, Clock, AlertTriangle, BookOpen, CheckCircle, ChevronDown, ChevronUp } from 'lucide-react';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface TriggerReason {\n  metric: string;\n  value: number;\n  threshold: number;\n  operator?: '<' | '>';\n}\n\ninterface PlanContent {\n  description: string;\n  cost_min: number;\n  cost_max: number;\n  time_min: string;\n  time_max: string;\n  risks: string;\n  citations: string[];\n  tags?: string[];\n}\n\nexport interface Plan {\n  id: string;\n  title: string;\n  content: PlanContent;\n  trigger_reason?: TriggerReason[];\n}\n\ninterface PlanActionCardProps {\n  plan: Plan;\n  defaultExpanded?: boolean;\n}\n\n// ============================================\n// COMPONENT\n// ============================================\n\nexport const PlanActionCard: React.FC<PlanActionCardProps> = ({ plan, defaultExpanded = false }) => {\n  const [isExpanded, setIsExpanded] = React.useState(defaultExpanded);\n\n  // Format cost display\n  const formatCost = () => {\n    const { cost_min, cost_max } = plan.content;\n    if (cost_min === 0 && cost_max === 0) {\n      return 'Free';\n    }\n    if (cost_min === cost_max) {\n      return `$${cost_min.toLocaleString()}`;\n    }\n    return `$${cost_min.toLocaleString()} - $${cost_max.toLocaleString()}`;\n  };\n\n  // Format timeline display\n  const formatTimeline = () => {\n    const { time_min, time_max } = plan.content;\n    if (time_min === time_max || !time_max) {\n      return time_min;\n    }\n    return `${time_min} - ${time_max}`;\n  };\n\n  return (\n    <div className=\"bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all duration-200 shadow-sm\">\n      <div className=\"p-5\">\n        <div className=\"flex justify-between items-start gap-4\">\n          <div className=\"flex-1\">\n            {/* Header */}\n            <div className=\"flex items-center gap-3 mb-2\">\n              <h3 className=\"text-base font-semibold text-gray-900\">{plan.title}</h3>\n              <div className=\"flex gap-2\">\n                {/* Dynamic Tags */}\n                {plan.content.tags?.map((tag) => (\n                  <span\n                    key={tag}\n                    className=\"text-[10px] uppercase font-semibold px-2 py-0.5 rounded-md bg-blue-50 text-blue-700 border border-blue-100\"\n                  >\n                    {tag}\n                  </span>\n                ))}\n              </div>\n            </div>\n\n            <p className=\"text-sm text-gray-500 leading-relaxed mb-4\">\n              {plan.content.description}\n            </p>\n\n            {/* Quick Stats Row */}\n            <div className=\"flex items-center gap-6 text-xs text-gray-500\">\n              <div className=\"flex items-center gap-1.5\" title=\"Estimated Cost\">\n                <DollarSign className=\"w-3.5 h-3.5 text-gray-400\" />\n                <span className=\"font-medium\">{formatCost()}</span>\n              </div>\n              <div className=\"flex items-center gap-1.5\" title=\"Timeline\">\n                <Clock className=\"w-3.5 h-3.5 text-gray-400\" />\n                <span className=\"font-medium\">{formatTimeline()}</span>\n              </div>\n            </div>\n          </div>\n\n          {/* Toggle Button */}\n          <button\n            onClick={() => setIsExpanded(!isExpanded)}\n            className=\"p-1.5 rounded-md hover:bg-gray-100 text-gray-400 transition-colors\"\n            aria-label={isExpanded ? 'Collapse details' : 'Expand details'}\n          >\n            {isExpanded ? <ChevronUp className=\"w-5 h-5\" /> : <ChevronDown className=\"w-5 h-5\" />}\n          </button>\n        </div>\n      </div>\n\n      {/* Expandable Section (The \"Why\" and \"Risks\") */}\n      {isExpanded && (\n        <div className=\"bg-gray-50/50 border-t border-gray-100 p-5 space-y-4\">\n\n          {/* Why this was recommended (Trigger Rules) */}\n          {plan.trigger_reason && plan.trigger_reason.length > 0 && (\n            <div>\n              <h4 className=\"flex items-center gap-2 text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2\">\n                <CheckCircle className=\"w-3.5 h-3.5 text-emerald-500\" />\n                Why Recommended\n              </h4>\n              <div className=\"flex flex-wrap gap-2\">\n                {plan.trigger_reason.map((reason, i) => (\n                  <div\n                    key={i}\n                    className=\"inline-flex items-center gap-1.5 px-2.5 py-1 bg-white border border-gray-200 rounded-md text-xs font-medium text-gray-700 shadow-sm\"\n                  >\n                    <span>{reason.metric}: {reason.value.toFixed(1)}</span>\n                    <span className=\"text-gray-400 text-[10px]\">\n                      ({reason.operator === '>' ? 'above' : 'below'} {reason.threshold})\n                    </span>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Risks */}\n          {plan.content.risks && (\n            <div>\n              <h4 className=\"flex items-center gap-2 text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2\">\n                <AlertTriangle className=\"w-3.5 h-3.5 text-amber-500\" />\n                Risks & Considerations\n              </h4>\n              <div className=\"bg-amber-50/50 p-3 rounded-lg border border-amber-100 text-xs text-amber-900/80 leading-relaxed\">\n                {plan.content.risks}\n              </div>\n            </div>\n          )}\n\n          {/* Research */}\n          {plan.content.citations && plan.content.citations.length > 0 && (\n            <div>\n              <h4 className=\"flex items-center gap-2 text-xs font-semibold text-gray-900 uppercase tracking-wide mb-2\">\n                <BookOpen className=\"w-3.5 h-3.5 text-blue-500\" />\n                Research\n              </h4>\n              <div className=\"text-xs text-blue-800 bg-blue-50/50 p-3 rounded-lg border border-blue-100\">\n                {plan.content.citations.join(\", \")}\n              </div>\n            </div>\n          )}\n\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default PlanActionCard;\n","numLines":177,"startLine":1,"totalLines":177}}}
{"parentUuid":"e5de200a-5a13-4c68-b287-768f118a8103","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'","is_error":true,"tool_use_id":"toolu_01RzfS7HFmYxX8hSQy8Ro2F2"}]},"uuid":"38810a6b-7b5b-4e89-a3ab-4c2ec1f0ff48","timestamp":"2025-12-22T00:07:00.751Z","toolUseResult":"Error: ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'"}
{"parentUuid":"38810a6b-7b5b-4e89-a3ab-4c2ec1f0ff48","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0125krnMB5vHjp84MB4DD3B5","type":"message","role":"assistant","content":[{"type":"text","text":"Let me continue examining the codebase structure and how recommendations are displayed."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":16489,"cache_read_input_tokens":49829,"cache_creation":{"ephemeral_5m_input_tokens":16489,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkW2rtyCCCBRh78vkLN","type":"assistant","uuid":"4f79a7fc-bbcc-4e9a-863b-fdaa74f8d4fd","timestamp":"2025-12-22T00:07:02.979Z"}
{"parentUuid":"4f79a7fc-bbcc-4e9a-863b-fdaa74f8d4fd","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0125krnMB5vHjp84MB4DD3B5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018G8i2MBTUXSDPZ6dhrB78A","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","offset":1,"limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":16489,"cache_read_input_tokens":49829,"cache_creation":{"ephemeral_5m_input_tokens":16489,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkW2rtyCCCBRh78vkLN","type":"assistant","uuid":"3b397452-773d-4da6-a2cf-713b3e60ce9c","timestamp":"2025-12-22T00:07:03.626Z"}
{"parentUuid":"3b397452-773d-4da6-a2cf-713b3e60ce9c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0125krnMB5vHjp84MB4DD3B5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0142UNiSTB92eJRDs24K2Bkq","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":16489,"cache_read_input_tokens":49829,"cache_creation":{"ephemeral_5m_input_tokens":16489,"ephemeral_1h_input_tokens":0},"output_tokens":193,"service_tier":"standard"}},"requestId":"req_011CWLkW2rtyCCCBRh78vkLN","type":"assistant","uuid":"dad7ccfd-5824-44f7-a951-dab0f2dd4c64","timestamp":"2025-12-22T00:07:03.852Z"}
{"parentUuid":"dad7ccfd-5824-44f7-a951-dab0f2dd4c64","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018G8i2MBTUXSDPZ6dhrB78A","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\n     4→import { LandmarkPoint } from '@/lib/landmarks';\n     5→import {\n     6→  analyzeFrontProfile,\n     7→  analyzeSideProfile,\n     8→  analyzeHarmony,\n     9→  HarmonyAnalysis,\n    10→  FaceIQScoreResult,\n    11→  FACEIQ_METRICS,\n    12→  Ethnicity,\n    13→  Gender,\n    14→} from '@/lib/faceiq-scoring';\n    15→import {\n    16→  calculateHarmonyScore,\n    17→  getTopMetrics,\n    18→  getBottomMetrics,\n    19→  HarmonyScoreResult,\n    20→  RankedMetric,\n    21→} from '@/lib/looksmax-scoring';\n    22→import {\n    23→  classifyInsights,\n    24→  convertToStrength,\n    25→  convertToFlaw,\n    26→  INSIGHTS_DEFINITIONS,\n    27→} from '@/lib/insights-engine';\n    28→import {\n    29→  Ratio,\n    30→  Strength,\n    31→  Flaw,\n    32→  Recommendation,\n    33→  ResultsTab,\n    34→  FullHarmonyAnalysis,\n    35→} from '@/types/results';\n    36→\n    37→// ============================================\n    38→// CONTEXT TYPES\n    39→// ============================================\n    40→\n    41→interface ResultsContextType {\n    42→  // Raw data\n    43→  frontLandmarks: LandmarkPoint[];\n    44→  sideLandmarks: LandmarkPoint[];\n    45→  gender: Gender;\n    46→  ethnicity: Ethnicity;\n    47→  frontPhoto: string;\n    48→  sidePhoto: string | null;\n    49→\n    50→  // Computed results\n    51→  harmonyAnalysis: FullHarmonyAnalysis | null;\n    52→  frontRatios: Ratio[];\n    53→  sideRatios: Ratio[];\n    54→  strengths: Strength[];\n    55→  flaws: Flaw[];\n    56→  recommendations: Recommendation[];\n    57→\n    58→  // Scores (now using weighted harmony from looksmax_engine.py)\n    59→  overallScore: number;\n    60→  frontScore: number;\n    61→  sideScore: number;\n    62→\n    63→  // Weighted Harmony Score (from looksmax_engine.py)\n    64→  harmonyScoreResult: HarmonyScoreResult | null;\n    65→  harmonyPercentage: number;  // 0-100% weighted harmony\n    66→\n    67→  // Top 3 strengths and bottom 3 areas to improve with advice\n    68→  topMetrics: RankedMetric[];\n    69→  bottomMetrics: RankedMetric[];\n    70→\n    71→  // UI state\n    72→  activeTab: ResultsTab;\n    73→  setActiveTab: (tab: ResultsTab) => void;\n    74→  expandedMeasurementId: string | null;\n    75→  setExpandedMeasurementId: (id: string | null) => void;\n    76→  selectedVisualizationMetric: string | null;\n    77→  setSelectedVisualizationMetric: (id: string | null) => void;\n    78→  categoryFilter: string | null;\n    79→  setCategoryFilter: (category: string | null) => void;\n    80→  showLandmarkOverlay: boolean;\n    81→  setShowLandmarkOverlay: (show: boolean) => void;\n    82→\n    83→  // Actions\n    84→  setResultsData: (data: ResultsInputData) => void;\n    85→}\n    86→\n    87→interface ResultsInputData {\n    88→  frontLandmarks: LandmarkPoint[];\n    89→  sideLandmarks: LandmarkPoint[];\n    90→  frontPhoto: string;\n    91→  sidePhoto?: string;\n    92→  gender: Gender;\n    93→  ethnicity?: Ethnicity;\n    94→}\n    95→\n    96→// ============================================\n    97→// HELPER FUNCTIONS\n    98→// ============================================\n    99→\n   100→function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n   101→  switch (unit) {\n   102→    case 'ratio': return 'x';\n   103→    case 'percent': return '%';\n   104→    case 'degrees': return '°';\n   105→    case 'mm': return 'mm';\n   106→    default: return 'x';\n   107→  }\n   108→}\n   109→\n   110→function transformToRatio(result: FaceIQScoreResult, landmarks: LandmarkPoint[]): Ratio {\n   111→  const metricConfig = FACEIQ_METRICS[result.metricId];\n   112→\n   113→  // Generate illustration based on metric\n   114→  const illustration = generateIllustration(result.metricId, landmarks);\n   115→\n   116→  // Get flaw/strength mappings\n   117→  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n   118→\n   119→  return {\n   120→    id: result.metricId,\n   121→    name: result.name,\n   122→    value: result.value,\n   123→    score: result.score,\n   124→    standardizedScore: result.standardizedScore,\n   125→    unit: convertUnitToRatioUnit(result.unit),\n   126→    idealMin: result.idealMin,\n   127→    idealMax: result.idealMax,\n   128→    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n   129→    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n   130→    description: metricConfig?.description || '',\n   131→    category: result.category,\n   132→    qualityLevel: result.qualityTier,\n   133→    severity: result.severity,\n   134→    illustration,\n   135→    mayIndicateFlaws,\n   136→    mayIndicateStrengths,\n   137→    usedLandmarks: getUsedLandmarks(result.metricId),\n   138→    scoringCurveConfig: metricConfig ? {\n   139→      decayRate: metricConfig.decayRate,\n   140→      maxScore: metricConfig.maxScore,\n   141→    } : undefined,\n   142→  };\n   143→}\n   144→\n   145→// Enhanced illustration configuration type\n   146→interface IllustrationConfig {\n   147→  points: string[];\n   148→  lines: Array<{\n   149→    from: string;\n   150→    to: string;\n   151→    label?: string;\n   152→    color?: string;\n   153→    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n   154→  }>;\n   155→}\n   156→\n   157→// Comprehensive illustration configurations for all metrics\n   158→const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n   159→  // ==========================================\n   160→  // FACE SHAPE / PROPORTIONS\n   161→  // ==========================================\n   162→  faceWidthToHeight: {\n   163→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   164→    lines: [\n   165→      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n   166→      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n   167→    ],\n   168→  },\n   169→  totalFacialWidthToHeight: {\n   170→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   171→    lines: [\n   172→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   173→      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n   174→    ],\n   175→  },\n   176→  lowerThirdProportion: {\n   177→    points: ['subnasale', 'menton', 'trichion'],\n   178→    lines: [\n   179→      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n   180→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   181→    ],\n   182→  },\n   183→  middleThirdProportion: {\n   184→    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n   185→    lines: [\n   186→      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n   187→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   188→    ],\n   189→  },\n   190→  upperThirdProportion: {\n   191→    points: ['trichion', 'nasal_base', 'menton'],\n   192→    lines: [\n   193→      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n   194→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   195→    ],\n   196→  },\n   197→  bitemporalWidth: {\n   198→    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n   199→    lines: [\n   200→      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"aeb4e32d-d76e-4b1d-a53d-f891acd31147","timestamp":"2025-12-22T00:07:03.898Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","content":"'use client';\n\nimport React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\nimport { LandmarkPoint } from '@/lib/landmarks';\nimport {\n  analyzeFrontProfile,\n  analyzeSideProfile,\n  analyzeHarmony,\n  HarmonyAnalysis,\n  FaceIQScoreResult,\n  FACEIQ_METRICS,\n  Ethnicity,\n  Gender,\n} from '@/lib/faceiq-scoring';\nimport {\n  calculateHarmonyScore,\n  getTopMetrics,\n  getBottomMetrics,\n  HarmonyScoreResult,\n  RankedMetric,\n} from '@/lib/looksmax-scoring';\nimport {\n  classifyInsights,\n  convertToStrength,\n  convertToFlaw,\n  INSIGHTS_DEFINITIONS,\n} from '@/lib/insights-engine';\nimport {\n  Ratio,\n  Strength,\n  Flaw,\n  Recommendation,\n  ResultsTab,\n  FullHarmonyAnalysis,\n} from '@/types/results';\n\n// ============================================\n// CONTEXT TYPES\n// ============================================\n\ninterface ResultsContextType {\n  // Raw data\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  gender: Gender;\n  ethnicity: Ethnicity;\n  frontPhoto: string;\n  sidePhoto: string | null;\n\n  // Computed results\n  harmonyAnalysis: FullHarmonyAnalysis | null;\n  frontRatios: Ratio[];\n  sideRatios: Ratio[];\n  strengths: Strength[];\n  flaws: Flaw[];\n  recommendations: Recommendation[];\n\n  // Scores (now using weighted harmony from looksmax_engine.py)\n  overallScore: number;\n  frontScore: number;\n  sideScore: number;\n\n  // Weighted Harmony Score (from looksmax_engine.py)\n  harmonyScoreResult: HarmonyScoreResult | null;\n  harmonyPercentage: number;  // 0-100% weighted harmony\n\n  // Top 3 strengths and bottom 3 areas to improve with advice\n  topMetrics: RankedMetric[];\n  bottomMetrics: RankedMetric[];\n\n  // UI state\n  activeTab: ResultsTab;\n  setActiveTab: (tab: ResultsTab) => void;\n  expandedMeasurementId: string | null;\n  setExpandedMeasurementId: (id: string | null) => void;\n  selectedVisualizationMetric: string | null;\n  setSelectedVisualizationMetric: (id: string | null) => void;\n  categoryFilter: string | null;\n  setCategoryFilter: (category: string | null) => void;\n  showLandmarkOverlay: boolean;\n  setShowLandmarkOverlay: (show: boolean) => void;\n\n  // Actions\n  setResultsData: (data: ResultsInputData) => void;\n}\n\ninterface ResultsInputData {\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  frontPhoto: string;\n  sidePhoto?: string;\n  gender: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// HELPER FUNCTIONS\n// ============================================\n\nfunction convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n  switch (unit) {\n    case 'ratio': return 'x';\n    case 'percent': return '%';\n    case 'degrees': return '°';\n    case 'mm': return 'mm';\n    default: return 'x';\n  }\n}\n\nfunction transformToRatio(result: FaceIQScoreResult, landmarks: LandmarkPoint[]): Ratio {\n  const metricConfig = FACEIQ_METRICS[result.metricId];\n\n  // Generate illustration based on metric\n  const illustration = generateIllustration(result.metricId, landmarks);\n\n  // Get flaw/strength mappings\n  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n\n  return {\n    id: result.metricId,\n    name: result.name,\n    value: result.value,\n    score: result.score,\n    standardizedScore: result.standardizedScore,\n    unit: convertUnitToRatioUnit(result.unit),\n    idealMin: result.idealMin,\n    idealMax: result.idealMax,\n    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n    description: metricConfig?.description || '',\n    category: result.category,\n    qualityLevel: result.qualityTier,\n    severity: result.severity,\n    illustration,\n    mayIndicateFlaws,\n    mayIndicateStrengths,\n    usedLandmarks: getUsedLandmarks(result.metricId),\n    scoringCurveConfig: metricConfig ? {\n      decayRate: metricConfig.decayRate,\n      maxScore: metricConfig.maxScore,\n    } : undefined,\n  };\n}\n\n// Enhanced illustration configuration type\ninterface IllustrationConfig {\n  points: string[];\n  lines: Array<{\n    from: string;\n    to: string;\n    label?: string;\n    color?: string;\n    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n  }>;\n}\n\n// Comprehensive illustration configurations for all metrics\nconst ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n  // ==========================================\n  // FACE SHAPE / PROPORTIONS\n  // ==========================================\n  faceWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n    ],\n  },\n  totalFacialWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n    ],\n  },\n  lowerThirdProportion: {\n    points: ['subnasale', 'menton', 'trichion'],\n    lines: [\n      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  middleThirdProportion: {\n    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n    lines: [\n      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  upperThirdProportion: {\n    points: ['trichion', 'nasal_base', 'menton'],\n    lines: [\n      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  bitemporalWidth: {\n    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },","numLines":200,"startLine":1,"totalLines":1954}}}
{"parentUuid":"aeb4e32d-d76e-4b1d-a53d-f891acd31147","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0142UNiSTB92eJRDs24K2Bkq","type":"tool_result","content":"     1→/**\n     2→ * FaceIQ-Style Results Page Types\n     3→ * Complete type definitions for the results UI\n     4→ */\n     5→\n     6→import { QualityTier, SeverityLevel, MeasurementUnit } from '@/lib/faceiq-scoring';\n     7→\n     8→// ============================================\n     9→// ILLUSTRATION TYPES\n    10→// ============================================\n    11→\n    12→export interface IllustrationPoint {\n    13→  type: 'landmark' | 'calculated';\n    14→  landmarkId?: string;\n    15→  x?: number;\n    16→  y?: number;\n    17→  label?: string;\n    18→}\n    19→\n    20→export interface IllustrationLine {\n    21→  from: string;\n    22→  to: string;\n    23→  color: string;\n    24→  style?: 'solid' | 'dashed';\n    25→  label?: string;\n    26→  labelColor?: string;\n    27→  labelPosition?: 'start' | 'middle' | 'end';\n    28→}\n    29→\n    30→export interface RatioIllustration {\n    31→  points: Record<string, IllustrationPoint>;\n    32→  lines: Record<string, IllustrationLine>;\n    33→}\n    34→\n    35→// ============================================\n    36→// RATIO/MEASUREMENT TYPES\n    37→// ============================================\n    38→\n    39→export interface Ratio {\n    40→  id: string;\n    41→  name: string;\n    42→  value: number;\n    43→  score: number;  // 0-10 scale\n    44→  standardizedScore: number;\n    45→  unit: 'x' | 'mm' | '%' | '°';\n    46→  idealMin: number;\n    47→  idealMax: number;\n    48→  rangeMin: number;\n    49→  rangeMax: number;\n    50→  description: string;\n    51→  category: string;\n    52→  qualityLevel: QualityTier;\n    53→  severity: SeverityLevel;\n    54→  illustration: RatioIllustration;\n    55→  mayIndicateFlaws: string[];\n    56→  mayIndicateStrengths: string[];\n    57→  usedLandmarks: string[];\n    58→  scoringCurveConfig?: {\n    59→    decayRate: number;\n    60→    maxScore: number;\n    61→  };\n    62→}\n    63→\n    64→// ============================================\n    65→// STRENGTH/FLAW TYPES\n    66→// ============================================\n    67→\n    68→export interface ResponsibleRatio {\n    69→  ratioName: string;\n    70→  ratioId: string;\n    71→  score: number;\n    72→  value: number;\n    73→  isObfuscated?: boolean;\n    74→  // Additional properties for AI descriptions\n    75→  idealMin: number;\n    76→  idealMax: number;\n    77→  unit: string;\n    78→  category?: string;\n    79→}\n    80→\n    81→export interface Strength {\n    82→  id: string;\n    83→  strengthName: string;\n    84→  summary: string;\n    85→  avgScore: number;\n    86→  qualityLevel: QualityTier;\n    87→  categoryName: string;\n    88→  responsibleRatios: ResponsibleRatio[];\n    89→}\n    90→\n    91→export interface Flaw {\n    92→  id: string;\n    93→  flawName: string;\n    94→  summary: string;\n    95→  harmonyPercentageLost: number;\n    96→  standardizedImpact: number;\n    97→  categoryName: string;\n    98→  isOther?: boolean;\n    99→  responsibleRatios: ResponsibleRatio[];\n   100→  rollingPointsDeducted?: number;\n   101→  rollingHarmonyPercentageLost?: number;\n   102→  rollingStandardizedImpact?: number;\n   103→}\n   104→\n   105→// ============================================\n   106→// RECOMMENDATION TYPES\n   107→// ============================================\n   108→\n   109→export type RecommendationPhase = 'Surgical' | 'Minimally Invasive' | 'Foundational';\n   110→\n   111→export interface RecommendationTimeline {\n   112→  effect_start: 'immediate' | 'delayed' | 'gradual';\n   113→  full_results_weeks: number;\n   114→  full_results_weeks_max?: number;\n   115→}\n   116→\n   117→export interface RecommendationCost {\n   118→  type: 'flat' | 'per_month' | 'per_session';\n   119→  min: number;\n   120→  max: number;\n   121→  currency: string;\n   122→}\n   123→\n   124→export interface RatioImpact {\n   125→  ratioId: string;\n   126→  ratioName: string;\n   127→  direction: 'increase' | 'decrease' | 'both';\n   128→  percentageEffect: number;\n   129→}\n   130→\n   131→export interface Recommendation {\n   132→  ref_id: string;\n   133→  name: string;\n   134→  description: string;\n   135→  phase: RecommendationPhase;\n   136→  impact: number;  // 0-1 effectiveness score\n   137→  coverage: number;  // Number of metrics improved\n   138→  percentage: string;  // e.g., \"10-20%\"\n   139→  expectedImprovementRange?: { min: number; max: number };\n   140→  matchedFlaws: string[];\n   141→  matchedRatios: string[];\n   142→  ratios_impacted: RatioImpact[];\n   143→  timeline: RecommendationTimeline;\n   144→  cost: RecommendationCost;\n   145→  risks_side_effects: string | null;\n   146→  warnings: string[];\n   147→  gender: 'male' | 'female' | 'both';\n   148→}\n   149→\n   150→// ============================================\n   151→// HARMONY ANALYSIS TYPES\n   152→// ============================================\n   153→\n   154→export interface ProfileAnalysis {\n   155→  standardizedScore: number;\n   156→  ratios: Ratio[];\n   157→  overallAIDescription?: string | null;\n   158→}\n   159→\n   160→export interface FullHarmonyAnalysis {\n   161→  standardizedScore: number;\n   162→  front: ProfileAnalysis;\n   163→  side: ProfileAnalysis;\n   164→  strengths: Strength[];\n   165→  flaws: Flaw[];\n   166→}\n   167→\n   168→// ============================================\n   169→// FACE DATA TYPES\n   170→// ============================================\n   171→\n   172→export interface FaceData {\n   173→  id: string;\n   174→  userId?: string;\n   175→  frontPhotoUrl: string;\n   176→  sidePhotoUrl?: string;\n   177→  harmonyScore: number | null;\n   178→  frontHarmonyScore: number | null;\n   179→  sideHarmonyScore: number | null;\n   180→  gender: 'male' | 'female';\n   181→  race?: string;\n   182→  unlocked: boolean;\n   183→  actionPlanUnlocked: boolean;\n   184→  harmonyAnalysis: FullHarmonyAnalysis;\n   185→}\n   186→\n   187→// ============================================\n   188→// UI STATE TYPES\n   189→// ============================================\n   190→\n   191→export type ResultsTab =\n   192→  | 'overview'\n   193→  | 'front-ratios'\n   194→  | 'side-ratios'\n   195→  | 'plan'\n   196→  | 'options'\n   197→  | 'support';\n   198→\n   199→export interface ResultsUIState {\n   200→  activeTab: ResultsTab;\n   201→  expandedMeasurementId: string | null;\n   202→  selectedVisualizationMetric: string | null;\n   203→  categoryFilter: string | null;\n   204→  showLandmarkOverlay: boolean;\n   205→}\n   206→\n   207→// ============================================\n   208→// CATEGORY TYPES\n   209→// ============================================\n   210→\n   211→export interface MeasurementCategory {\n   212→  id: string;\n   213→  name: string;\n   214→  color: string;\n   215→  description: string;\n   216→}\n   217→\n   218→export const MEASUREMENT_CATEGORIES: MeasurementCategory[] = [\n   219→  { id: 'midface', name: 'Midface/Face Shape', color: '#67e8f9', description: 'Facial proportions and overall shape' },\n   220→  { id: 'jaw-growth', name: 'Occlusion/Jaw Growth', color: '#a78bfa', description: 'Jaw development and bite alignment' },\n   221→  { id: 'jaw-shape', name: 'Jaw Shape', color: '#f97316', description: 'Jawline contour and angles' },\n   222→  { id: 'upper-third', name: 'Upper Third', color: '#84cc16', description: 'Forehead and hairline proportions' },\n   223→  { id: 'eyes', name: 'Eyes', color: '#06b6d4', description: 'Eye shape, spacing, and canthal tilt' },\n   224→  { id: 'nose', name: 'Nose', color: '#fbbf24', description: 'Nasal proportions and angles' },\n   225→  { id: 'lips', name: 'Lips', color: '#ec4899', description: 'Lip proportions and projection' },\n   226→  { id: 'chin', name: 'Chin', color: '#ef4444', description: 'Chin projection and shape' },\n   227→  { id: 'neck', name: 'Neck', color: '#14b8a6', description: 'Neck angle and throat definition' },\n   228→  { id: 'other', name: 'Other', color: '#6b7280', description: 'Additional measurements' },\n   229→];\n   230→\n   231→// ============================================\n   232→// SCORE COLOR HELPERS\n   233→// ============================================\n   234→\n   235→export function getScoreColor(score: number): string {\n   236→  if (score >= 8) return '#67e8f9';  // Cyan - ideal\n   237→  if (score >= 6) return '#22c55e';  // Green - good\n   238→  if (score >= 4) return '#fbbf24';  // Yellow - fair\n   239→  return 'rgb(227, 67, 67)';         // Red - poor\n   240→}\n   241→\n   242→export function getQualityColor(quality: QualityTier): string {\n   243→  switch (quality) {\n   244→    case 'ideal': return '#67e8f9';\n   245→    case 'excellent': return '#22c55e';\n   246→    case 'good': return '#fbbf24';\n   247→    case 'below_average': return 'rgb(227, 67, 67)';\n   248→    default: return '#6b7280';\n   249→  }\n   250→}\n   251→\n   252→export function getSeverityColor(severity: SeverityLevel): string {\n   253→  switch (severity) {\n   254→    case 'optimal': return '#67e8f9';\n   255→    case 'minor': return '#22c55e';\n   256→    case 'moderate': return '#fbbf24';\n   257→    case 'major': return '#f97316';\n   258→    case 'severe': return '#ef4444';\n   259→    case 'extremely_severe': return '#dc2626';\n   260→    default: return '#6b7280';\n   261→  }\n   262→}\n   263→\n   264→export function getCategoryColor(categoryName: string): string {\n   265→  const cat = MEASUREMENT_CATEGORIES.find(c =>\n   266→    c.name.toLowerCase().includes(categoryName.toLowerCase()) ||\n   267→    categoryName.toLowerCase().includes(c.name.toLowerCase())\n   268→  );\n   269→  return cat?.color || '#6b7280';\n   270→}\n   271→\n   272→// ============================================\n   273→// UNIT FORMATTING\n   274→// ============================================\n   275→\n   276→export function formatUnit(unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n   277→  switch (unit) {\n   278→    case 'x':\n   279→    case 'ratio': return 'x';\n   280→    case 'mm': return 'mm';\n   281→    case '%':\n   282→    case 'percent': return '%';\n   283→    case '°':\n   284→    case 'degrees': return '°';\n   285→    default: return '';\n   286→  }\n   287→}\n   288→\n   289→export function formatValue(value: number, unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n   290→  const unitStr = formatUnit(unit);\n   291→  if (unit === '%' || unit === 'percent') {\n   292→    return `${value.toFixed(1)}${unitStr}`;\n   293→  }\n   294→  if (unit === '°' || unit === 'degrees') {\n   295→    return `${value.toFixed(1)}${unitStr}`;\n   296→  }\n   297→  return `${value.toFixed(2)}${unitStr}`;\n   298→}\n   299→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"83bc1583-c8d6-43b8-a2ca-1a402a927030","timestamp":"2025-12-22T00:07:03.898Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","content":"/**\n * FaceIQ-Style Results Page Types\n * Complete type definitions for the results UI\n */\n\nimport { QualityTier, SeverityLevel, MeasurementUnit } from '@/lib/faceiq-scoring';\n\n// ============================================\n// ILLUSTRATION TYPES\n// ============================================\n\nexport interface IllustrationPoint {\n  type: 'landmark' | 'calculated';\n  landmarkId?: string;\n  x?: number;\n  y?: number;\n  label?: string;\n}\n\nexport interface IllustrationLine {\n  from: string;\n  to: string;\n  color: string;\n  style?: 'solid' | 'dashed';\n  label?: string;\n  labelColor?: string;\n  labelPosition?: 'start' | 'middle' | 'end';\n}\n\nexport interface RatioIllustration {\n  points: Record<string, IllustrationPoint>;\n  lines: Record<string, IllustrationLine>;\n}\n\n// ============================================\n// RATIO/MEASUREMENT TYPES\n// ============================================\n\nexport interface Ratio {\n  id: string;\n  name: string;\n  value: number;\n  score: number;  // 0-10 scale\n  standardizedScore: number;\n  unit: 'x' | 'mm' | '%' | '°';\n  idealMin: number;\n  idealMax: number;\n  rangeMin: number;\n  rangeMax: number;\n  description: string;\n  category: string;\n  qualityLevel: QualityTier;\n  severity: SeverityLevel;\n  illustration: RatioIllustration;\n  mayIndicateFlaws: string[];\n  mayIndicateStrengths: string[];\n  usedLandmarks: string[];\n  scoringCurveConfig?: {\n    decayRate: number;\n    maxScore: number;\n  };\n}\n\n// ============================================\n// STRENGTH/FLAW TYPES\n// ============================================\n\nexport interface ResponsibleRatio {\n  ratioName: string;\n  ratioId: string;\n  score: number;\n  value: number;\n  isObfuscated?: boolean;\n  // Additional properties for AI descriptions\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category?: string;\n}\n\nexport interface Strength {\n  id: string;\n  strengthName: string;\n  summary: string;\n  avgScore: number;\n  qualityLevel: QualityTier;\n  categoryName: string;\n  responsibleRatios: ResponsibleRatio[];\n}\n\nexport interface Flaw {\n  id: string;\n  flawName: string;\n  summary: string;\n  harmonyPercentageLost: number;\n  standardizedImpact: number;\n  categoryName: string;\n  isOther?: boolean;\n  responsibleRatios: ResponsibleRatio[];\n  rollingPointsDeducted?: number;\n  rollingHarmonyPercentageLost?: number;\n  rollingStandardizedImpact?: number;\n}\n\n// ============================================\n// RECOMMENDATION TYPES\n// ============================================\n\nexport type RecommendationPhase = 'Surgical' | 'Minimally Invasive' | 'Foundational';\n\nexport interface RecommendationTimeline {\n  effect_start: 'immediate' | 'delayed' | 'gradual';\n  full_results_weeks: number;\n  full_results_weeks_max?: number;\n}\n\nexport interface RecommendationCost {\n  type: 'flat' | 'per_month' | 'per_session';\n  min: number;\n  max: number;\n  currency: string;\n}\n\nexport interface RatioImpact {\n  ratioId: string;\n  ratioName: string;\n  direction: 'increase' | 'decrease' | 'both';\n  percentageEffect: number;\n}\n\nexport interface Recommendation {\n  ref_id: string;\n  name: string;\n  description: string;\n  phase: RecommendationPhase;\n  impact: number;  // 0-1 effectiveness score\n  coverage: number;  // Number of metrics improved\n  percentage: string;  // e.g., \"10-20%\"\n  expectedImprovementRange?: { min: number; max: number };\n  matchedFlaws: string[];\n  matchedRatios: string[];\n  ratios_impacted: RatioImpact[];\n  timeline: RecommendationTimeline;\n  cost: RecommendationCost;\n  risks_side_effects: string | null;\n  warnings: string[];\n  gender: 'male' | 'female' | 'both';\n}\n\n// ============================================\n// HARMONY ANALYSIS TYPES\n// ============================================\n\nexport interface ProfileAnalysis {\n  standardizedScore: number;\n  ratios: Ratio[];\n  overallAIDescription?: string | null;\n}\n\nexport interface FullHarmonyAnalysis {\n  standardizedScore: number;\n  front: ProfileAnalysis;\n  side: ProfileAnalysis;\n  strengths: Strength[];\n  flaws: Flaw[];\n}\n\n// ============================================\n// FACE DATA TYPES\n// ============================================\n\nexport interface FaceData {\n  id: string;\n  userId?: string;\n  frontPhotoUrl: string;\n  sidePhotoUrl?: string;\n  harmonyScore: number | null;\n  frontHarmonyScore: number | null;\n  sideHarmonyScore: number | null;\n  gender: 'male' | 'female';\n  race?: string;\n  unlocked: boolean;\n  actionPlanUnlocked: boolean;\n  harmonyAnalysis: FullHarmonyAnalysis;\n}\n\n// ============================================\n// UI STATE TYPES\n// ============================================\n\nexport type ResultsTab =\n  | 'overview'\n  | 'front-ratios'\n  | 'side-ratios'\n  | 'plan'\n  | 'options'\n  | 'support';\n\nexport interface ResultsUIState {\n  activeTab: ResultsTab;\n  expandedMeasurementId: string | null;\n  selectedVisualizationMetric: string | null;\n  categoryFilter: string | null;\n  showLandmarkOverlay: boolean;\n}\n\n// ============================================\n// CATEGORY TYPES\n// ============================================\n\nexport interface MeasurementCategory {\n  id: string;\n  name: string;\n  color: string;\n  description: string;\n}\n\nexport const MEASUREMENT_CATEGORIES: MeasurementCategory[] = [\n  { id: 'midface', name: 'Midface/Face Shape', color: '#67e8f9', description: 'Facial proportions and overall shape' },\n  { id: 'jaw-growth', name: 'Occlusion/Jaw Growth', color: '#a78bfa', description: 'Jaw development and bite alignment' },\n  { id: 'jaw-shape', name: 'Jaw Shape', color: '#f97316', description: 'Jawline contour and angles' },\n  { id: 'upper-third', name: 'Upper Third', color: '#84cc16', description: 'Forehead and hairline proportions' },\n  { id: 'eyes', name: 'Eyes', color: '#06b6d4', description: 'Eye shape, spacing, and canthal tilt' },\n  { id: 'nose', name: 'Nose', color: '#fbbf24', description: 'Nasal proportions and angles' },\n  { id: 'lips', name: 'Lips', color: '#ec4899', description: 'Lip proportions and projection' },\n  { id: 'chin', name: 'Chin', color: '#ef4444', description: 'Chin projection and shape' },\n  { id: 'neck', name: 'Neck', color: '#14b8a6', description: 'Neck angle and throat definition' },\n  { id: 'other', name: 'Other', color: '#6b7280', description: 'Additional measurements' },\n];\n\n// ============================================\n// SCORE COLOR HELPERS\n// ============================================\n\nexport function getScoreColor(score: number): string {\n  if (score >= 8) return '#67e8f9';  // Cyan - ideal\n  if (score >= 6) return '#22c55e';  // Green - good\n  if (score >= 4) return '#fbbf24';  // Yellow - fair\n  return 'rgb(227, 67, 67)';         // Red - poor\n}\n\nexport function getQualityColor(quality: QualityTier): string {\n  switch (quality) {\n    case 'ideal': return '#67e8f9';\n    case 'excellent': return '#22c55e';\n    case 'good': return '#fbbf24';\n    case 'below_average': return 'rgb(227, 67, 67)';\n    default: return '#6b7280';\n  }\n}\n\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'optimal': return '#67e8f9';\n    case 'minor': return '#22c55e';\n    case 'moderate': return '#fbbf24';\n    case 'major': return '#f97316';\n    case 'severe': return '#ef4444';\n    case 'extremely_severe': return '#dc2626';\n    default: return '#6b7280';\n  }\n}\n\nexport function getCategoryColor(categoryName: string): string {\n  const cat = MEASUREMENT_CATEGORIES.find(c =>\n    c.name.toLowerCase().includes(categoryName.toLowerCase()) ||\n    categoryName.toLowerCase().includes(c.name.toLowerCase())\n  );\n  return cat?.color || '#6b7280';\n}\n\n// ============================================\n// UNIT FORMATTING\n// ============================================\n\nexport function formatUnit(unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n  switch (unit) {\n    case 'x':\n    case 'ratio': return 'x';\n    case 'mm': return 'mm';\n    case '%':\n    case 'percent': return '%';\n    case '°':\n    case 'degrees': return '°';\n    default: return '';\n  }\n}\n\nexport function formatValue(value: number, unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n  const unitStr = formatUnit(unit);\n  if (unit === '%' || unit === 'percent') {\n    return `${value.toFixed(1)}${unitStr}`;\n  }\n  if (unit === '°' || unit === 'degrees') {\n    return `${value.toFixed(1)}${unitStr}`;\n  }\n  return `${value.toFixed(2)}${unitStr}`;\n}\n","numLines":299,"startLine":1,"totalLines":299}}}
{"parentUuid":"83bc1583-c8d6-43b8-a2ca-1a402a927030","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01D54pJmhNYVCPppSuCSJV7n","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me search for where recommendations are used in the results page and other UI components."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":7209,"cache_read_input_tokens":66318,"cache_creation":{"ephemeral_5m_input_tokens":7209,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkWGSTtL4sewGb5M2wb","type":"assistant","uuid":"7faefd2c-d37e-4871-b3c5-6ba5f166ee39","timestamp":"2025-12-22T00:07:06.721Z"}
{"parentUuid":"7faefd2c-d37e-4871-b3c5-6ba5f166ee39","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01D54pJmhNYVCPppSuCSJV7n","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AqsdiKGFCqa9ByoBZ6KLoo","name":"Bash","input":{"command":"find /Users/imorgado/LOOKSMAXX/looksmaxx-app/src -type f \\( -name \"*.tsx\" -o -name \"*.ts\" \\) | head -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":7209,"cache_read_input_tokens":66318,"cache_creation":{"ephemeral_5m_input_tokens":7209,"ephemeral_1h_input_tokens":0},"output_tokens":117,"service_tier":"standard"}},"requestId":"req_011CWLkWGSTtL4sewGb5M2wb","type":"assistant","uuid":"3acb76e6-3609-4d9b-bb12-1e816125365e","timestamp":"2025-12-22T00:07:07.290Z"}
{"parentUuid":"3acb76e6-3609-4d9b-bb12-1e816125365e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AqsdiKGFCqa9ByoBZ6KLoo","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/EthnicityContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/UploadContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/GenderContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/AuthContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/ethnicity/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/analysis/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/gender/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/layout.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/layout.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/api/side-landmarks/route.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/login/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/upload/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/GuidedLandmarkPlacement.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/SideProfileManualTool.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/BellCurveChart.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/LandmarkDot.tsx","is_error":false}]},"uuid":"edd99a38-7ed1-4124-bcf9-2aa7c08b42c6","timestamp":"2025-12-22T00:07:07.400Z","toolUseResult":{"stdout":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/EthnicityContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/UploadContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/GenderContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/AuthContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/ethnicity/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/analysis/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/gender/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/layout.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/layout.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/api/side-landmarks/route.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/login/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/upload/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/GuidedLandmarkPlacement.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/SideProfileManualTool.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/BellCurveChart.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/LandmarkDot.tsx","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"edd99a38-7ed1-4124-bcf9-2aa7c08b42c6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_013QFXpoGXPcjJf8x2gdNiVd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012Nb8cDqdsxZwMz287NLvhz","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/page.tsx","offset":1,"limit":150}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":779,"cache_read_input_tokens":73527,"cache_creation":{"ephemeral_5m_input_tokens":779,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CWLkWXHvnvRgBc8ELnXg4","type":"assistant","uuid":"821524d9-a730-4916-8196-dc58df564578","timestamp":"2025-12-22T00:07:10.031Z"}
{"parentUuid":"821524d9-a730-4916-8196-dc58df564578","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_013QFXpoGXPcjJf8x2gdNiVd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017EwtJguws4oErD4v7qr4b7","name":"Bash","input":{"command":"grep -r \"recommendation\\|Recommendation\" /Users/imorgado/LOOKSMAXX/looksmaxx-app/src --include=\"*.tsx\" --include=\"*.ts\" -l | head -10"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":779,"cache_read_input_tokens":73527,"cache_creation":{"ephemeral_5m_input_tokens":779,"ephemeral_1h_input_tokens":0},"output_tokens":198,"service_tier":"standard"}},"requestId":"req_011CWLkWXHvnvRgBc8ELnXg4","type":"assistant","uuid":"796b7736-b507-4e87-9403-c5c4cd6a871f","timestamp":"2025-12-22T00:07:10.507Z"}
{"parentUuid":"796b7736-b507-4e87-9403-c5c4cd6a871f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012Nb8cDqdsxZwMz287NLvhz","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useEffect, useState } from 'react';\n     4→import { ResultsProvider } from '@/contexts/ResultsContext';\n     5→import { Results } from '@/components/results/Results';\n     6→import { LandmarkPoint, FRONT_PROFILE_LANDMARKS, SIDE_PROFILE_LANDMARKS } from '@/lib/landmarks';\n     7→import { Ethnicity, Gender } from '@/lib/faceiq-scoring';\n     8→\n     9→// Note: Metadata cannot be exported from client components\n    10→// The page title is set in the root layout\n    11→\n    12→// Demo data for testing - in production this would come from the analysis flow\n    13→const generateDemoLandmarks = (baseLandmarks: LandmarkPoint[]): LandmarkPoint[] => {\n    14→  return baseLandmarks.map(landmark => ({\n    15→    ...landmark,\n    16→    // Add slight randomization to simulate real placement\n    17→    x: landmark.x + (Math.random() - 0.5) * 0.02,\n    18→    y: landmark.y + (Math.random() - 0.5) * 0.02,\n    19→  }));\n    20→};\n    21→\n    22→// Generate demo data outside component to avoid closure issues\n    23→const createDemoData = () => ({\n    24→  frontLandmarks: generateDemoLandmarks(FRONT_PROFILE_LANDMARKS),\n    25→  sideLandmarks: generateDemoLandmarks(SIDE_PROFILE_LANDMARKS),\n    26→  frontPhoto: '/demo-front.jpg',\n    27→  sidePhoto: '/demo-side.jpg',\n    28→  gender: 'male' as Gender,\n    29→  ethnicity: 'white' as Ethnicity,\n    30→});\n    31→\n    32→export default function ResultsPage() {\n    33→  const [mounted, setMounted] = useState(false);\n    34→  const [initialData, setInitialData] = useState<{\n    35→    frontLandmarks: LandmarkPoint[];\n    36→    sideLandmarks: LandmarkPoint[];\n    37→    frontPhoto: string;\n    38→    sidePhoto?: string;\n    39→    gender: Gender;\n    40→    ethnicity?: Ethnicity;\n    41→  } | null>(null);\n    42→\n    43→  useEffect(() => {\n    44→    // Mark as mounted (client-side only)\n    45→    setMounted(true);\n    46→\n    47→    try {\n    48→      // Try to get data from sessionStorage (set by analysis page)\n    49→      const storedData = typeof window !== 'undefined'\n    50→        ? sessionStorage.getItem('analysisResults')\n    51→        : null;\n    52→\n    53→      if (storedData) {\n    54→        const parsed = JSON.parse(storedData);\n    55→        setInitialData(parsed);\n    56→      } else {\n    57→        // No stored data - use demo data\n    58→        setInitialData(createDemoData());\n    59→      }\n    60→    } catch (e) {\n    61→      console.error('Failed to load analysis results:', e);\n    62→      // Use demo data as fallback\n    63→      setInitialData(createDemoData());\n    64→    }\n    65→  }, []);\n    66→\n    67→  // Show loading state until mounted and data is ready\n    68→  if (!mounted || !initialData) {\n    69→    return (\n    70→      <div className=\"min-h-screen bg-black flex items-center justify-center\">\n    71→        <div className=\"text-center\">\n    72→          <div className=\"w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\" />\n    73→          <p className=\"text-neutral-400\">Loading your analysis...</p>\n    74→        </div>\n    75→      </div>\n    76→    );\n    77→  }\n    78→\n    79→  return (\n    80→    <ResultsProvider initialData={initialData}>\n    81→      <Results />\n    82→    </ResultsProvider>\n    83→  );\n    84→}\n    85→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1a102f03-95e3-43d3-a671-985ba66bd2d7","timestamp":"2025-12-22T00:07:10.546Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/page.tsx","content":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport { ResultsProvider } from '@/contexts/ResultsContext';\nimport { Results } from '@/components/results/Results';\nimport { LandmarkPoint, FRONT_PROFILE_LANDMARKS, SIDE_PROFILE_LANDMARKS } from '@/lib/landmarks';\nimport { Ethnicity, Gender } from '@/lib/faceiq-scoring';\n\n// Note: Metadata cannot be exported from client components\n// The page title is set in the root layout\n\n// Demo data for testing - in production this would come from the analysis flow\nconst generateDemoLandmarks = (baseLandmarks: LandmarkPoint[]): LandmarkPoint[] => {\n  return baseLandmarks.map(landmark => ({\n    ...landmark,\n    // Add slight randomization to simulate real placement\n    x: landmark.x + (Math.random() - 0.5) * 0.02,\n    y: landmark.y + (Math.random() - 0.5) * 0.02,\n  }));\n};\n\n// Generate demo data outside component to avoid closure issues\nconst createDemoData = () => ({\n  frontLandmarks: generateDemoLandmarks(FRONT_PROFILE_LANDMARKS),\n  sideLandmarks: generateDemoLandmarks(SIDE_PROFILE_LANDMARKS),\n  frontPhoto: '/demo-front.jpg',\n  sidePhoto: '/demo-side.jpg',\n  gender: 'male' as Gender,\n  ethnicity: 'white' as Ethnicity,\n});\n\nexport default function ResultsPage() {\n  const [mounted, setMounted] = useState(false);\n  const [initialData, setInitialData] = useState<{\n    frontLandmarks: LandmarkPoint[];\n    sideLandmarks: LandmarkPoint[];\n    frontPhoto: string;\n    sidePhoto?: string;\n    gender: Gender;\n    ethnicity?: Ethnicity;\n  } | null>(null);\n\n  useEffect(() => {\n    // Mark as mounted (client-side only)\n    setMounted(true);\n\n    try {\n      // Try to get data from sessionStorage (set by analysis page)\n      const storedData = typeof window !== 'undefined'\n        ? sessionStorage.getItem('analysisResults')\n        : null;\n\n      if (storedData) {\n        const parsed = JSON.parse(storedData);\n        setInitialData(parsed);\n      } else {\n        // No stored data - use demo data\n        setInitialData(createDemoData());\n      }\n    } catch (e) {\n      console.error('Failed to load analysis results:', e);\n      // Use demo data as fallback\n      setInitialData(createDemoData());\n    }\n  }, []);\n\n  // Show loading state until mounted and data is ready\n  if (!mounted || !initialData) {\n    return (\n      <div className=\"min-h-screen bg-black flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\" />\n          <p className=\"text-neutral-400\">Loading your analysis...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <ResultsProvider initialData={initialData}>\n      <Results />\n    </ResultsProvider>\n  );\n}\n","numLines":85,"startLine":1,"totalLines":85}}}
{"parentUuid":"1a102f03-95e3-43d3-a671-985ba66bd2d7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017EwtJguws4oErD4v7qr4b7","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/layout.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/SupportTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StrengthFlawCards.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/KeyStrengthsFlaws.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","is_error":false}]},"uuid":"1960d48c-896c-4491-b3ee-ba33ccca81b9","timestamp":"2025-12-22T00:07:10.626Z","toolUseResult":{"stdout":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/layout.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/SupportTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StrengthFlawCards.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/KeyStrengthsFlaws.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"1960d48c-896c-4491-b3ee-ba33ccca81b9","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01MU1VcSCmTdBRAnxKHQ5B5K","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016dq35JDTWRpLUDJxKYcwkE","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","offset":1,"limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1910,"cache_read_input_tokens":74306,"cache_creation":{"ephemeral_5m_input_tokens":1910,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CWLkWm7dWvrmq6cZEvqzT","type":"assistant","uuid":"9633fb15-8639-4ef5-a177-5fcc41998522","timestamp":"2025-12-22T00:07:12.744Z"}
{"parentUuid":"9633fb15-8639-4ef5-a177-5fcc41998522","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01MU1VcSCmTdBRAnxKHQ5B5K","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UFhwjxzVDoWMRJRSzAxinM","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx","offset":1,"limit":150}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1910,"cache_read_input_tokens":74306,"cache_creation":{"ephemeral_5m_input_tokens":1910,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CWLkWm7dWvrmq6cZEvqzT","type":"assistant","uuid":"87ce3ad8-3507-4e04-a179-ba6f45b96215","timestamp":"2025-12-22T00:07:13.090Z"}
{"parentUuid":"87ce3ad8-3507-4e04-a179-ba6f45b96215","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016dq35JDTWRpLUDJxKYcwkE","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useState, useMemo, useCallback } from 'react';\n     4→import { motion, AnimatePresence } from 'framer-motion';\n     5→import {\n     6→  Sparkles,\n     7→  TrendingUp,\n     8→  Target,\n     9→  Zap,\n    10→  ChevronRight,\n    11→  Lock,\n    12→} from 'lucide-react';\n    13→import { useResults } from '@/contexts/ResultsContext';\n    14→import { TabContent } from '../ResultsLayout';\n    15→import { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\n    16→import { ScoreCircle, PhaseBadge } from '../shared';\n    17→import { RecommendationPhase } from '@/types/results';\n    18→\n    19→// ============================================\n    20→// POTENTIAL SCORE CARD\n    21→// ============================================\n    22→\n    23→function PotentialScoreCard() {\n    24→  const { overallScore, recommendations } = useResults();\n    25→\n    26→  // Calculate potential improvement\n    27→  const potentialImprovement = useMemo(() => {\n    28→    if (recommendations.length === 0) return 0;\n    29→    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    30→    return Math.min(totalImpact * 1.5, 10 - overallScore);\n    31→  }, [recommendations, overallScore]);\n    32→\n    33→  const potentialScore = Math.min(10, overallScore + potentialImprovement);\n    34→\n    35→  return (\n    36→    <motion.div\n    37→      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n    38→      initial={{ opacity: 0, y: 20 }}\n    39→      animate={{ opacity: 1, y: 0 }}\n    40→    >\n    41→      <div className=\"flex items-center gap-2 mb-4\">\n    42→        <Sparkles size={20} className=\"text-cyan-400\" />\n    43→        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n    44→      </div>\n    45→\n    46→      <div className=\"flex items-center justify-center gap-8 mb-6\">\n    47→        {/* Current */}\n    48→        <div className=\"text-center\">\n    49→          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n    50→          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n    51→        </div>\n    52→\n    53→        {/* Arrow */}\n    54→        <div className=\"flex flex-col items-center gap-1\">\n    55→          <ChevronRight size={24} className=\"text-cyan-400\" />\n    56→          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n    57→        </div>\n    58→\n    59→        {/* Potential */}\n    60→        <div className=\"text-center\">\n    61→          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n    62→          <div className=\"relative\">\n    63→            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n    64→            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n    65→              <TrendingUp size={12} className=\"text-black\" />\n    66→            </div>\n    67→          </div>\n    68→        </div>\n    69→      </div>\n    70→\n    71→      <p className=\"text-sm text-neutral-400 text-center\">\n    72→        Following our recommendations could improve your harmony score by up to{' '}\n    73→        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n    74→      </p>\n    75→    </motion.div>\n    76→  );\n    77→}\n    78→\n    79→// ============================================\n    80→// PHASE FILTER\n    81→// ============================================\n    82→\n    83→interface PhaseFilterProps {\n    84→  selectedPhase: RecommendationPhase | null;\n    85→  onSelect: (phase: RecommendationPhase | null) => void;\n    86→  counts: Record<RecommendationPhase, number>;\n    87→}\n    88→\n    89→function PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n    90→  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n    91→\n    92→  return (\n    93→    <div className=\"flex flex-wrap gap-2\">\n    94→      <button\n    95→        onClick={() => onSelect(null)}\n    96→        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${\n    97→          selectedPhase === null\n    98→            ? 'bg-cyan-500 text-black'\n    99→            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n   100→        }`}\n   101→      >\n   102→        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n   103→      </button>\n   104→      {phases.map(phase => (\n   105→        <button\n   106→          key={phase}\n   107→          onClick={() => onSelect(phase)}\n   108→          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${\n   109→            selectedPhase === phase\n   110→              ? 'bg-neutral-700 text-white'\n   111→              : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n   112→          }`}\n   113→        >\n   114→          <PhaseBadge phase={phase} size=\"sm\" />\n   115→          ({counts[phase] || 0})\n   116→        </button>\n   117→      ))}\n   118→    </div>\n   119→  );\n   120→}\n   121→\n   122→// ============================================\n   123→// ORDER OF OPERATIONS\n   124→// ============================================\n   125→\n   126→function OrderOfOperations() {\n   127→  return (\n   128→    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n   129→      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n   130→        <Target size={16} className=\"text-cyan-400\" />\n   131→        Recommended Order\n   132→      </h4>\n   133→      <div className=\"space-y-3\">\n   134→        <div className=\"flex items-start gap-3\">\n   135→          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n   136→            <span className=\"text-xs font-bold text-green-400\">1</span>\n   137→          </div>\n   138→          <div>\n   139→            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n   140→            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n   141→          </div>\n   142→        </div>\n   143→        <div className=\"flex items-start gap-3\">\n   144→          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n   145→            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n   146→          </div>\n   147→          <div>\n   148→            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n   149→            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n   150→          </div>\n   151→        </div>\n   152→        <div className=\"flex items-start gap-3\">\n   153→          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n   154→            <span className=\"text-xs font-bold text-red-400\">3</span>\n   155→          </div>\n   156→          <div>\n   157→            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n   158→            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n   159→          </div>\n   160→        </div>\n   161→      </div>\n   162→    </div>\n   163→  );\n   164→}\n   165→\n   166→// ============================================\n   167→// PLAN TAB\n   168→// ============================================\n   169→\n   170→export function PlanTab() {\n   171→  const { recommendations, flaws, gender, ethnicity } = useResults();\n   172→  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n   173→  const [expandedId, setExpandedId] = useState<string | null>(null);\n   174→  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n   175→  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n   176→\n   177→  // Count recommendations by phase\n   178→  const phaseCounts = useMemo(() => {\n   179→    const counts: Record<RecommendationPhase, number> = {\n   180→      'Foundational': 0,\n   181→      'Minimally Invasive': 0,\n   182→      'Surgical': 0,\n   183→    };\n   184→    recommendations.forEach(r => {\n   185→      if (!removedIds.has(r.ref_id)) {\n   186→        counts[r.phase]++;\n   187→      }\n   188→    });\n   189→    return counts;\n   190→  }, [recommendations, removedIds]);\n   191→\n   192→  // Filter recommendations\n   193→  const filteredRecommendations = useMemo(() => {\n   194→    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n   195→    if (selectedPhase) {\n   196→      filtered = filtered.filter(r => r.phase === selectedPhase);\n   197→    }\n   198→    return filtered;\n   199→  }, [recommendations, selectedPhase, removedIds]);\n   200→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0d13b50f-7eae-47b8-bdc3-fed8522a7c8e","timestamp":"2025-12-22T00:07:13.146Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","content":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { RecommendationPhase } from '@/types/results';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - overallScore);\n  }, [recommendations, overallScore]);\n\n  const potentialScore = Math.min(10, overallScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${\n          selectedPhase === null\n            ? 'bg-cyan-500 text-black'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n        }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${\n            selectedPhase === phase\n              ? 'bg-neutral-700 text-white'\n              : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity } = useResults();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n","numLines":200,"startLine":1,"totalLines":338}}}
{"parentUuid":"0d13b50f-7eae-47b8-bdc3-fed8522a7c8e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UFhwjxzVDoWMRJRSzAxinM","type":"tool_result","content":"     1→// Main exports from results components\n     2→\n     3→// Main component\n     4→export { Results } from './Results';\n     5→\n     6→// Layout\n     7→export { ResultsLayout, TabContent } from './ResultsLayout';\n     8→\n     9→// Tabs\n    10→export { OverviewTab } from './tabs/OverviewTab';\n    11→export { FrontRatiosTab, SideRatiosTab, RatiosTab } from './tabs/RatiosTab';\n    12→export { PlanTab } from './tabs/PlanTab';\n    13→export { OptionsTab } from './tabs/OptionsTab';\n    14→export { SupportTab } from './tabs/SupportTab';\n    15→\n    16→// Cards\n    17→export { MeasurementCard, CompactMeasurementCard } from './cards/MeasurementCard';\n    18→export { StrengthCard, FlawCard, CompactStrengthBadge, CompactFlawBadge } from './cards/StrengthFlawCards';\n    19→export { RecommendationCard, CompactRecommendationCard } from './cards/RecommendationCard';\n    20→\n    21→// Visualization\n    22→export { FaceOverlay } from './visualization/FaceOverlay';\n    23→export { IdealRangeBar, CompactIdealRangeBar } from './visualization/IdealRangeBar';\n    24→\n    25→// Shared\n    26→export {\n    27→  QualityBadge,\n    28→  SeverityBadge,\n    29→  PhaseBadge,\n    30→  ScoreCircle,\n    31→  ScoreBar,\n    32→  ExpandableSection,\n    33→  CategoryTag,\n    34→  MetricValue,\n    35→} from './shared';\n    36→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"c65472dd-681d-452c-8f1b-0ef838ddbbed","timestamp":"2025-12-22T00:07:13.147Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx","content":"// Main exports from results components\n\n// Main component\nexport { Results } from './Results';\n\n// Layout\nexport { ResultsLayout, TabContent } from './ResultsLayout';\n\n// Tabs\nexport { OverviewTab } from './tabs/OverviewTab';\nexport { FrontRatiosTab, SideRatiosTab, RatiosTab } from './tabs/RatiosTab';\nexport { PlanTab } from './tabs/PlanTab';\nexport { OptionsTab } from './tabs/OptionsTab';\nexport { SupportTab } from './tabs/SupportTab';\n\n// Cards\nexport { MeasurementCard, CompactMeasurementCard } from './cards/MeasurementCard';\nexport { StrengthCard, FlawCard, CompactStrengthBadge, CompactFlawBadge } from './cards/StrengthFlawCards';\nexport { RecommendationCard, CompactRecommendationCard } from './cards/RecommendationCard';\n\n// Visualization\nexport { FaceOverlay } from './visualization/FaceOverlay';\nexport { IdealRangeBar, CompactIdealRangeBar } from './visualization/IdealRangeBar';\n\n// Shared\nexport {\n  QualityBadge,\n  SeverityBadge,\n  PhaseBadge,\n  ScoreCircle,\n  ScoreBar,\n  ExpandableSection,\n  CategoryTag,\n  MetricValue,\n} from './shared';\n","numLines":36,"startLine":1,"totalLines":36}}}
{"parentUuid":"c65472dd-681d-452c-8f1b-0ef838ddbbed","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01YXsUx1AggvBjdCP74Bvkzm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HdsguKN1oGkEKBmZjKvi7c","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","offset":1000,"limit":300}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":4109,"cache_read_input_tokens":76216,"cache_creation":{"ephemeral_5m_input_tokens":4109,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CWLkWwxVgcFLtkG73wtCj","type":"assistant","uuid":"5ea1bbae-63c4-4713-9e90-a2d885fe9c59","timestamp":"2025-12-22T00:07:17.671Z"}
{"parentUuid":"5ea1bbae-63c4-4713-9e90-a2d885fe9c59","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HdsguKN1oGkEKBmZjKvi7c","type":"tool_result","content":"  1000→  },\n  1001→};\n  1002→\n  1003→function generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  1004→  const flaws: Flaw[] = [];\n  1005→  const usedMetricIds = new Set<string>();\n  1006→  let rollingLost = 0;\n  1007→\n  1008→  // First pass: Create grouped flaws from related low-scoring metrics\n  1009→  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n  1010→    // Find all low-scoring measurements that belong to this group\n  1011→    const groupMeasurements = analysis.measurements.filter(m =>\n  1012→      groupConfig.metrics.includes(m.metricId) &&\n  1013→      m.score < 6 &&\n  1014→      !usedMetricIds.has(m.metricId)\n  1015→    );\n  1016→\n  1017→    // Only create a grouped flaw if we have 2+ metrics with low scores\n  1018→    if (groupMeasurements.length >= 2) {\n  1019→      // Mark these metrics as used\n  1020→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n  1021→\n  1022→      // Calculate total impact from all metrics in this group\n  1023→      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n  1024→      rollingLost += totalImpact;\n  1025→\n  1026→      // Create grouped flaw with multiple contributing ratios\n  1027→      flaws.push({\n  1028→        id: `flaw_group_${groupId}`,\n  1029→        flawName: groupConfig.name,\n  1030→        summary: groupConfig.description,\n  1031→        harmonyPercentageLost: totalImpact,\n  1032→        standardizedImpact: totalImpact / 10,\n  1033→        categoryName: groupConfig.category,\n  1034→        responsibleRatios: groupMeasurements.map(m => ({\n  1035→          ratioName: m.name,\n  1036→          ratioId: m.metricId,\n  1037→          score: m.score,\n  1038→          value: m.value,\n  1039→          idealMin: m.idealMin,\n  1040→          idealMax: m.idealMax,\n  1041→          unit: m.unit,\n  1042→          category: m.category,\n  1043→        })),\n  1044→        rollingPointsDeducted: rollingLost,\n  1045→        rollingHarmonyPercentageLost: rollingLost,\n  1046→        rollingStandardizedImpact: rollingLost / 10,\n  1047→      });\n  1048→    }\n  1049→  });\n  1050→\n  1051→  // Second pass: Add remaining individual flaws that weren't grouped\n  1052→  analysis.flaws.forEach((f, i) => {\n  1053→    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n  1054→\n  1055→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n  1056→    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n  1057→    rollingLost += impact;\n  1058→\n  1059→    flaws.push({\n  1060→      id: `flaw_${i}`,\n  1061→      flawName: f.metricName,\n  1062→      summary: f.reasoning,\n  1063→      harmonyPercentageLost: impact,\n  1064→      standardizedImpact: impact / 10,\n  1065→      categoryName: f.category,\n  1066→      responsibleRatios: [{\n  1067→        ratioName: f.metricName,\n  1068→        ratioId: f.metricId,\n  1069→        score: matchingMeasurement?.score || 3,\n  1070→        value: matchingMeasurement?.value || 0,\n  1071→        idealMin: matchingMeasurement?.idealMin || 0,\n  1072→        idealMax: matchingMeasurement?.idealMax || 1,\n  1073→        unit: matchingMeasurement?.unit || 'ratio',\n  1074→        category: f.category,\n  1075→      }],\n  1076→      rollingPointsDeducted: rollingLost,\n  1077→      rollingHarmonyPercentageLost: rollingLost,\n  1078→      rollingStandardizedImpact: rollingLost / 10,\n  1079→    });\n  1080→  });\n  1081→\n  1082→  // Sort by impact (highest first) then by number of contributing ratios\n  1083→  return flaws.sort((a, b) => {\n  1084→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n  1085→      return b.responsibleRatios.length - a.responsibleRatios.length;\n  1086→    }\n  1087→    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  1088→  });\n  1089→}\n  1090→\n  1091→// Comprehensive procedure database with metric-specific targeting\n  1092→interface ProcedureConfig {\n  1093→  ref_id: string;\n  1094→  name: string;\n  1095→  description: string;\n  1096→  phase: 'Surgical' | 'Minimally Invasive' | 'Foundational';\n  1097→  baseImpact: number;\n  1098→  coverage: number;\n  1099→  percentage: string;\n  1100→  expectedImprovementRange: { min: number; max: number };\n  1101→  targetMetrics: string[];  // Specific metric IDs this treatment addresses\n  1102→  targetCategories: string[];  // Category names this treatment addresses\n  1103→  targetKeywords: string[];  // Flaw name keywords to match\n  1104→  timeline: { effect_start: 'immediate' | 'delayed' | 'gradual'; full_results_weeks: number; full_results_weeks_max?: number };\n  1105→  cost: { type: 'flat' | 'per_session' | 'per_month'; min: number; max: number; currency: string };\n  1106→  risks_side_effects: string;\n  1107→  warnings: string[];\n  1108→  gender: 'male' | 'female' | 'both';\n  1109→}\n  1110→\n  1111→const PROCEDURE_DATABASE: ProcedureConfig[] = [\n  1112→  // ==========================================\n  1113→  // SURGICAL TREATMENTS\n  1114→  // ==========================================\n  1115→  {\n  1116→    ref_id: 'SUR-01',\n  1117→    name: 'Sliding Genioplasty',\n  1118→    description: 'Chin bone repositioning surgery that can move the chin forward, backward, up, or down for optimal projection and facial balance.',\n  1119→    phase: 'Surgical',\n  1120→    baseImpact: 0.90,\n  1121→    coverage: 8,\n  1122→    percentage: '15-25%',\n  1123→    expectedImprovementRange: { min: 0.5, max: 1.5 },\n  1124→    targetMetrics: ['chinPhiltrumRatio', 'facialDepthToHeight', 'anteriorFacialDepth', 'nasomentaAngle'],\n  1125→    targetCategories: ['Chin', 'Occlusion/Jaw Growth'],\n  1126→    targetKeywords: ['chin', 'recessed', 'weak', 'short chin', 'long chin', 'pogonion'],\n  1127→    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },\n  1128→    cost: { type: 'flat', min: 5000, max: 15000, currency: 'USD' },\n  1129→    risks_side_effects: 'Temporary numbness, swelling, bruising. Rare: infection, nerve damage, bone resorption.',\n  1130→    warnings: [],\n  1131→    gender: 'both',\n  1132→  },\n  1133→  {\n  1134→    ref_id: 'SUR-02',\n  1135→    name: 'Reduction Rhinoplasty',\n  1136→    description: 'Surgical reduction of nose size, hump removal, and tip refinement to improve nasal proportions.',\n  1137→    phase: 'Surgical',\n  1138→    baseImpact: 0.85,\n  1139→    coverage: 6,\n  1140→    percentage: '10-20%',\n  1141→    expectedImprovementRange: { min: 0.5, max: 1.0 },\n  1142→    targetMetrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  1143→    targetCategories: ['Nose'],\n  1144→    targetKeywords: ['wide nose', 'large nose', 'dorsal hump', 'bulbous', 'nasal', 'nose bridge'],\n  1145→    timeline: { effect_start: 'delayed', full_results_weeks: 24, full_results_weeks_max: 52 },\n  1146→    cost: { type: 'flat', min: 7000, max: 20000, currency: 'USD' },\n  1147→    risks_side_effects: 'Swelling for 6-12 months, numbness, possible revision needed.',\n  1148→    warnings: [],\n  1149→    gender: 'both',\n  1150→  },\n  1151→  {\n  1152→    ref_id: 'SUR-03',\n  1153→    name: 'Jaw Angle Implants',\n  1154→    description: 'Custom or standard silicone/PEEK implants to enhance jaw width, definition, and angularity.',\n  1155→    phase: 'Surgical',\n  1156→    baseImpact: 0.80,\n  1157→    coverage: 5,\n  1158→    percentage: '10-15%',\n  1159→    expectedImprovementRange: { min: 0.4, max: 1.0 },\n  1160→    targetMetrics: ['bigonialWidth', 'jawFrontalAngle', 'jawWidthRatio', 'jawSlope', 'gonialAngle'],\n  1161→    targetCategories: ['Jaw Shape'],\n  1162→    targetKeywords: ['narrow jaw', 'weak jaw', 'soft jaw', 'jaw angle', 'gonial', 'mandible'],\n  1163→    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },\n  1164→    cost: { type: 'flat', min: 8000, max: 25000, currency: 'USD' },\n  1165→    risks_side_effects: 'Swelling, asymmetry risk, implant migration, infection, bone erosion.',\n  1166→    warnings: [],\n  1167→    gender: 'both',\n  1168→  },\n  1169→  {\n  1170→    ref_id: 'SUR-04',\n  1171→    name: 'Bimaxillary Osteotomy (Bimax)',\n  1172→    description: 'Double jaw surgery to reposition both upper and lower jaws for optimal occlusion and facial balance.',\n  1173→    phase: 'Surgical',\n  1174→    baseImpact: 0.95,\n  1175→    coverage: 12,\n  1176→    percentage: '20-35%',\n  1177→    expectedImprovementRange: { min: 1.0, max: 2.0 },\n  1178→    targetMetrics: ['midfaceRatio', 'facialDepthToHeight', 'mandibularPlaneAngle', 'lowerThirdProportion', 'nasofacialAngle'],\n  1179→    targetCategories: ['Occlusion/Jaw Growth', 'Midface/Face Shape'],\n  1180→    targetKeywords: ['maxillary recession', 'mandibular', 'hyper-divergent', 'bite', 'occlusion', 'midface recession'],\n  1181→    timeline: { effect_start: 'delayed', full_results_weeks: 24, full_results_weeks_max: 52 },\n  1182→    cost: { type: 'flat', min: 20000, max: 60000, currency: 'USD' },\n  1183→    risks_side_effects: 'Extended recovery, numbness (temporary to permanent), dietary restrictions.',\n  1184→    warnings: ['Major surgery - requires orthodontic preparation'],\n  1185→    gender: 'both',\n  1186→  },\n  1187→  {\n  1188→    ref_id: 'SUR-05',\n  1189→    name: 'Canthoplasty',\n  1190→    description: 'Surgical eye corner modification to improve canthal tilt and eye shape.',\n  1191→    phase: 'Surgical',\n  1192→    baseImpact: 0.75,\n  1193→    coverage: 3,\n  1194→    percentage: '8-15%',\n  1195→    expectedImprovementRange: { min: 0.3, max: 0.8 },\n  1196→    targetMetrics: ['lateralCanthalTilt', 'eyeAspectRatio'],\n  1197→    targetCategories: ['Eyes'],\n  1198→    targetKeywords: ['canthal tilt', 'negative tilt', 'drooping eyes', 'eye shape', 'eye angle'],\n  1199→    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },\n  1200→    cost: { type: 'flat', min: 4000, max: 12000, currency: 'USD' },\n  1201→    risks_side_effects: 'Scarring, asymmetry, dry eyes, ectropion.',\n  1202→    warnings: ['Difficult to reverse'],\n  1203→    gender: 'both',\n  1204→  },\n  1205→  {\n  1206→    ref_id: 'SUR-06',\n  1207→    name: 'Cheek/Malar Implants',\n  1208→    description: 'Solid implants placed over the cheekbones to enhance midface projection and width.',\n  1209→    phase: 'Surgical',\n  1210→    baseImpact: 0.75,\n  1211→    coverage: 4,\n  1212→    percentage: '10-18%',\n  1213→    expectedImprovementRange: { min: 0.4, max: 0.9 },\n  1214→    targetMetrics: ['cheekboneHeight', 'midfaceRatio', 'totalFacialWidthToHeight'],\n  1215→    targetCategories: ['Midface/Face Shape'],\n  1216→    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface', 'zygomatic', 'malar'],\n  1217→    timeline: { effect_start: 'delayed', full_results_weeks: 6, full_results_weeks_max: 12 },\n  1218→    cost: { type: 'flat', min: 6000, max: 15000, currency: 'USD' },\n  1219→    risks_side_effects: 'Swelling, asymmetry, implant shifting, nerve damage.',\n  1220→    warnings: [],\n  1221→    gender: 'both',\n  1222→  },\n  1223→  {\n  1224→    ref_id: 'SUR-07',\n  1225→    name: 'Neck Liposuction / Submentoplasty',\n  1226→    description: 'Fat removal and skin tightening under the chin and neck area.',\n  1227→    phase: 'Surgical',\n  1228→    baseImpact: 0.65,\n  1229→    coverage: 3,\n  1230→    percentage: '8-12%',\n  1231→    expectedImprovementRange: { min: 0.3, max: 0.7 },\n  1232→    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],\n  1233→    targetCategories: ['Neck'],\n  1234→    targetKeywords: ['round neck', 'double chin', 'submental', 'cervical', 'neck definition'],\n  1235→    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },\n  1236→    cost: { type: 'flat', min: 3000, max: 8000, currency: 'USD' },\n  1237→    risks_side_effects: 'Swelling, bruising, skin irregularity, numbness.',\n  1238→    warnings: [],\n  1239→    gender: 'both',\n  1240→  },\n  1241→  {\n  1242→    ref_id: 'SUR-08',\n  1243→    name: 'Brow Bone Reduction/Augmentation',\n  1244→    description: 'Surgical reshaping of the brow ridge for improved upper third harmony.',\n  1245→    phase: 'Surgical',\n  1246→    baseImpact: 0.70,\n  1247→    coverage: 3,\n  1248→    percentage: '8-15%',\n  1249→    expectedImprovementRange: { min: 0.3, max: 0.7 },\n  1250→    targetMetrics: ['nasofrontalAngle', 'bitemporalWidth', 'upperThirdProportion'],\n  1251→    targetCategories: ['Upper Third'],\n  1252→    targetKeywords: ['brow ridge', 'forehead', 'nasofrontal', 'upper third', 'glabella'],\n  1253→    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },\n  1254→    cost: { type: 'flat', min: 8000, max: 20000, currency: 'USD' },\n  1255→    risks_side_effects: 'Swelling, numbness, scarring (if coronal incision).',\n  1256→    warnings: [],\n  1257→    gender: 'both',\n  1258→  },\n  1259→\n  1260→  // ==========================================\n  1261→  // MINIMALLY INVASIVE TREATMENTS\n  1262→  // ==========================================\n  1263→  {\n  1264→    ref_id: 'MIN-01',\n  1265→    name: 'Chin/Jawline Filler',\n  1266→    description: 'Hyaluronic acid injections to enhance chin projection and jawline definition. Reversible and temporary.',\n  1267→    phase: 'Minimally Invasive',\n  1268→    baseImpact: 0.45,\n  1269→    coverage: 4,\n  1270→    percentage: '5-10%',\n  1271→    expectedImprovementRange: { min: 0.2, max: 0.5 },\n  1272→    targetMetrics: ['chinPhiltrumRatio', 'jawFrontalAngle', 'bigonialWidth'],\n  1273→    targetCategories: ['Chin', 'Jaw Shape'],\n  1274→    targetKeywords: ['weak chin', 'recessed chin', 'soft jaw', 'jawline'],\n  1275→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n  1276→    cost: { type: 'per_session', min: 800, max: 2500, currency: 'USD' },\n  1277→    risks_side_effects: 'Bruising, swelling, rare vascular occlusion.',\n  1278→    warnings: ['Results temporary (12-18 months)', 'Requires maintenance'],\n  1279→    gender: 'both',\n  1280→  },\n  1281→  {\n  1282→    ref_id: 'MIN-02',\n  1283→    name: 'Cheek Filler',\n  1284→    description: 'HA filler to enhance cheekbone projection and midface volume.',\n  1285→    phase: 'Minimally Invasive',\n  1286→    baseImpact: 0.40,\n  1287→    coverage: 3,\n  1288→    percentage: '5-8%',\n  1289→    expectedImprovementRange: { min: 0.2, max: 0.4 },\n  1290→    targetMetrics: ['cheekboneHeight', 'midfaceRatio'],\n  1291→    targetCategories: ['Midface/Face Shape'],\n  1292→    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface volume'],\n  1293→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n  1294→    cost: { type: 'per_session', min: 600, max: 1800, currency: 'USD' },\n  1295→    risks_side_effects: 'Bruising, swelling, asymmetry.',\n  1296→    warnings: ['Results temporary (12-18 months)'],\n  1297→    gender: 'both',\n  1298→  },\n  1299→  {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7fdd92ad-04a5-41e2-9dd2-6e4f26837099","timestamp":"2025-12-22T00:07:17.790Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","content":"  },\n};\n\nfunction generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  const flaws: Flaw[] = [];\n  const usedMetricIds = new Set<string>();\n  let rollingLost = 0;\n\n  // First pass: Create grouped flaws from related low-scoring metrics\n  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all low-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score < 6 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped flaw if we have 2+ metrics with low scores\n    if (groupMeasurements.length >= 2) {\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Calculate total impact from all metrics in this group\n      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n      rollingLost += totalImpact;\n\n      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: matchingMeasurement?.score || 3,\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });\n\n  // Sort by impact (highest first) then by number of contributing ratios\n  return flaws.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  });\n}\n\n// Comprehensive procedure database with metric-specific targeting\ninterface ProcedureConfig {\n  ref_id: string;\n  name: string;\n  description: string;\n  phase: 'Surgical' | 'Minimally Invasive' | 'Foundational';\n  baseImpact: number;\n  coverage: number;\n  percentage: string;\n  expectedImprovementRange: { min: number; max: number };\n  targetMetrics: string[];  // Specific metric IDs this treatment addresses\n  targetCategories: string[];  // Category names this treatment addresses\n  targetKeywords: string[];  // Flaw name keywords to match\n  timeline: { effect_start: 'immediate' | 'delayed' | 'gradual'; full_results_weeks: number; full_results_weeks_max?: number };\n  cost: { type: 'flat' | 'per_session' | 'per_month'; min: number; max: number; currency: string };\n  risks_side_effects: string;\n  warnings: string[];\n  gender: 'male' | 'female' | 'both';\n}\n\nconst PROCEDURE_DATABASE: ProcedureConfig[] = [\n  // ==========================================\n  // SURGICAL TREATMENTS\n  // ==========================================\n  {\n    ref_id: 'SUR-01',\n    name: 'Sliding Genioplasty',\n    description: 'Chin bone repositioning surgery that can move the chin forward, backward, up, or down for optimal projection and facial balance.',\n    phase: 'Surgical',\n    baseImpact: 0.90,\n    coverage: 8,\n    percentage: '15-25%',\n    expectedImprovementRange: { min: 0.5, max: 1.5 },\n    targetMetrics: ['chinPhiltrumRatio', 'facialDepthToHeight', 'anteriorFacialDepth', 'nasomentaAngle'],\n    targetCategories: ['Chin', 'Occlusion/Jaw Growth'],\n    targetKeywords: ['chin', 'recessed', 'weak', 'short chin', 'long chin', 'pogonion'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },\n    cost: { type: 'flat', min: 5000, max: 15000, currency: 'USD' },\n    risks_side_effects: 'Temporary numbness, swelling, bruising. Rare: infection, nerve damage, bone resorption.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-02',\n    name: 'Reduction Rhinoplasty',\n    description: 'Surgical reduction of nose size, hump removal, and tip refinement to improve nasal proportions.',\n    phase: 'Surgical',\n    baseImpact: 0.85,\n    coverage: 6,\n    percentage: '10-20%',\n    expectedImprovementRange: { min: 0.5, max: 1.0 },\n    targetMetrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n    targetCategories: ['Nose'],\n    targetKeywords: ['wide nose', 'large nose', 'dorsal hump', 'bulbous', 'nasal', 'nose bridge'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 24, full_results_weeks_max: 52 },\n    cost: { type: 'flat', min: 7000, max: 20000, currency: 'USD' },\n    risks_side_effects: 'Swelling for 6-12 months, numbness, possible revision needed.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-03',\n    name: 'Jaw Angle Implants',\n    description: 'Custom or standard silicone/PEEK implants to enhance jaw width, definition, and angularity.',\n    phase: 'Surgical',\n    baseImpact: 0.80,\n    coverage: 5,\n    percentage: '10-15%',\n    expectedImprovementRange: { min: 0.4, max: 1.0 },\n    targetMetrics: ['bigonialWidth', 'jawFrontalAngle', 'jawWidthRatio', 'jawSlope', 'gonialAngle'],\n    targetCategories: ['Jaw Shape'],\n    targetKeywords: ['narrow jaw', 'weak jaw', 'soft jaw', 'jaw angle', 'gonial', 'mandible'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },\n    cost: { type: 'flat', min: 8000, max: 25000, currency: 'USD' },\n    risks_side_effects: 'Swelling, asymmetry risk, implant migration, infection, bone erosion.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-04',\n    name: 'Bimaxillary Osteotomy (Bimax)',\n    description: 'Double jaw surgery to reposition both upper and lower jaws for optimal occlusion and facial balance.',\n    phase: 'Surgical',\n    baseImpact: 0.95,\n    coverage: 12,\n    percentage: '20-35%',\n    expectedImprovementRange: { min: 1.0, max: 2.0 },\n    targetMetrics: ['midfaceRatio', 'facialDepthToHeight', 'mandibularPlaneAngle', 'lowerThirdProportion', 'nasofacialAngle'],\n    targetCategories: ['Occlusion/Jaw Growth', 'Midface/Face Shape'],\n    targetKeywords: ['maxillary recession', 'mandibular', 'hyper-divergent', 'bite', 'occlusion', 'midface recession'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 24, full_results_weeks_max: 52 },\n    cost: { type: 'flat', min: 20000, max: 60000, currency: 'USD' },\n    risks_side_effects: 'Extended recovery, numbness (temporary to permanent), dietary restrictions.',\n    warnings: ['Major surgery - requires orthodontic preparation'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-05',\n    name: 'Canthoplasty',\n    description: 'Surgical eye corner modification to improve canthal tilt and eye shape.',\n    phase: 'Surgical',\n    baseImpact: 0.75,\n    coverage: 3,\n    percentage: '8-15%',\n    expectedImprovementRange: { min: 0.3, max: 0.8 },\n    targetMetrics: ['lateralCanthalTilt', 'eyeAspectRatio'],\n    targetCategories: ['Eyes'],\n    targetKeywords: ['canthal tilt', 'negative tilt', 'drooping eyes', 'eye shape', 'eye angle'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },\n    cost: { type: 'flat', min: 4000, max: 12000, currency: 'USD' },\n    risks_side_effects: 'Scarring, asymmetry, dry eyes, ectropion.',\n    warnings: ['Difficult to reverse'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-06',\n    name: 'Cheek/Malar Implants',\n    description: 'Solid implants placed over the cheekbones to enhance midface projection and width.',\n    phase: 'Surgical',\n    baseImpact: 0.75,\n    coverage: 4,\n    percentage: '10-18%',\n    expectedImprovementRange: { min: 0.4, max: 0.9 },\n    targetMetrics: ['cheekboneHeight', 'midfaceRatio', 'totalFacialWidthToHeight'],\n    targetCategories: ['Midface/Face Shape'],\n    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface', 'zygomatic', 'malar'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 6, full_results_weeks_max: 12 },\n    cost: { type: 'flat', min: 6000, max: 15000, currency: 'USD' },\n    risks_side_effects: 'Swelling, asymmetry, implant shifting, nerve damage.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-07',\n    name: 'Neck Liposuction / Submentoplasty',\n    description: 'Fat removal and skin tightening under the chin and neck area.',\n    phase: 'Surgical',\n    baseImpact: 0.65,\n    coverage: 3,\n    percentage: '8-12%',\n    expectedImprovementRange: { min: 0.3, max: 0.7 },\n    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],\n    targetCategories: ['Neck'],\n    targetKeywords: ['round neck', 'double chin', 'submental', 'cervical', 'neck definition'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },\n    cost: { type: 'flat', min: 3000, max: 8000, currency: 'USD' },\n    risks_side_effects: 'Swelling, bruising, skin irregularity, numbness.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-08',\n    name: 'Brow Bone Reduction/Augmentation',\n    description: 'Surgical reshaping of the brow ridge for improved upper third harmony.',\n    phase: 'Surgical',\n    baseImpact: 0.70,\n    coverage: 3,\n    percentage: '8-15%',\n    expectedImprovementRange: { min: 0.3, max: 0.7 },\n    targetMetrics: ['nasofrontalAngle', 'bitemporalWidth', 'upperThirdProportion'],\n    targetCategories: ['Upper Third'],\n    targetKeywords: ['brow ridge', 'forehead', 'nasofrontal', 'upper third', 'glabella'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },\n    cost: { type: 'flat', min: 8000, max: 20000, currency: 'USD' },\n    risks_side_effects: 'Swelling, numbness, scarring (if coronal incision).',\n    warnings: [],\n    gender: 'both',\n  },\n\n  // ==========================================\n  // MINIMALLY INVASIVE TREATMENTS\n  // ==========================================\n  {\n    ref_id: 'MIN-01',\n    name: 'Chin/Jawline Filler',\n    description: 'Hyaluronic acid injections to enhance chin projection and jawline definition. Reversible and temporary.',\n    phase: 'Minimally Invasive',\n    baseImpact: 0.45,\n    coverage: 4,\n    percentage: '5-10%',\n    expectedImprovementRange: { min: 0.2, max: 0.5 },\n    targetMetrics: ['chinPhiltrumRatio', 'jawFrontalAngle', 'bigonialWidth'],\n    targetCategories: ['Chin', 'Jaw Shape'],\n    targetKeywords: ['weak chin', 'recessed chin', 'soft jaw', 'jawline'],\n    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n    cost: { type: 'per_session', min: 800, max: 2500, currency: 'USD' },\n    risks_side_effects: 'Bruising, swelling, rare vascular occlusion.',\n    warnings: ['Results temporary (12-18 months)', 'Requires maintenance'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'MIN-02',\n    name: 'Cheek Filler',\n    description: 'HA filler to enhance cheekbone projection and midface volume.',\n    phase: 'Minimally Invasive',\n    baseImpact: 0.40,\n    coverage: 3,\n    percentage: '5-8%',\n    expectedImprovementRange: { min: 0.2, max: 0.4 },\n    targetMetrics: ['cheekboneHeight', 'midfaceRatio'],\n    targetCategories: ['Midface/Face Shape'],\n    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface volume'],\n    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n    cost: { type: 'per_session', min: 600, max: 1800, currency: 'USD' },\n    risks_side_effects: 'Bruising, swelling, asymmetry.',\n    warnings: ['Results temporary (12-18 months)'],\n    gender: 'both',\n  },\n  {","numLines":300,"startLine":1000,"totalLines":1954}}}
{"parentUuid":"7fdd92ad-04a5-41e2-9dd2-6e4f26837099","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"a40e442b-88b0-42d2-87b1-f379e4897c25","version":"2.0.70","gitBranch":"main","agentId":"af8cac5","slug":"luminous-dazzling-sifakis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QaozkcPisbTLKJnvzm9wGP","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect. I now have a comprehensive understanding of the recommendation system. Let me compile my findings into a detailed summary.\n\n## Summary: Advice and Recommendation System Analysis\n\nI've completed a thorough exploration of the LOOKSMAXX codebase's advice and recommendation system. Here's a comprehensive analysis:\n\n### 1. Current Recommendation Logic and Structure\n\n**Primary System: AdviceEngine** (`src/lib/advice-engine.ts`)\n- **10 predefined plans** (hardcoded into PLANS array) covering major procedures:\n  - Surgical: Rhinoplasty, Genioplasty, Canthoplasty, Brow Lift\n  - Minimally Invasive: Jaw/Cheek Fillers, Lip Filler\n  - Foundational: Beard Growth, Mewing, Fat Loss Protocol\n  \n- **Trigger Rule System**: Each plan has metric-based trigger rules with:\n  - Specific metrics to evaluate (e.g., \"Gonial Angle\", \"Bigonial Width\")\n  - Condition logic: `AND` or `OR` operators\n  - Thresholds: numerical limits with `<` or `>` operators\n  - Severity filtering: Plans only trigger if metrics are NOT in \"ideal\" range\n\n- **Recommendation Flow**:\n  1. `AdviceEngine.getRecommendations()` evaluates each plan against user metrics\n  2. Checks both raw metric values and severity classifications\n  3. Returns matching plans with trigger reasons and metadata\n  4. Can be sorted by cost, phase, or grouped by treatment category\n\n**Secondary System: Insights Engine** (`src/lib/insights-engine.ts`)\n- 40+ insight definitions classifying metrics as strengths or flaws\n- Z-score based severity classification:\n  - Ideal: value within ideal range\n  - Good: within 1 standard deviation\n  - Moderate: 1-2 standard deviations away\n  - Severe: >2 standard deviations away\n- Ethnicity/gender-specific overrides for metric standards\n- False positive filtering for directional metrics (e.g., negative canthal tilt being acceptable in some cases)\n\n### 2. Product & Affiliate System Status\n\n**CURRENT STATE: No affiliate or product database exists**\n\n- No product links, affiliate codes, or monetization hooks\n- No e-commerce integration\n- No external product references\n- Recommendations are purely procedural/treatment-focused, not product-focused\n\nThe system provides:\n- Procedure names and descriptions\n- Cost estimates (research-based)\n- Timeline estimates\n- Risk information\n- Research citations\n\nBut **deliberately omits**:\n- Specific provider recommendations\n- Product brand references\n- Affiliate links\n- Commerce integration\n- Sponsored content\n\n### 3. Data Flow: Analysis Results → Recommendations → UI Display\n\n```\nAnalysis Results (landmarks + metrics)\n    ↓\nFaceIQScoreResult[] (raw measurements)\n    ↓\nResultsContext (main data orchestration)\n    ├─ generateFlawsFromAnalysis() → Flaw[]\n    ├─ AdviceEngine.getRecommendations() → Recommendation[]\n    └─ classifyInsights() → Strength[] + Flaw[]\n    ↓\nRecommendation Type Structure:\n{\n  ref_id: string (e.g., \"SUR-01\", \"MIN-02\")\n  name: string\n  description: string\n  phase: 'Surgical' | 'Minimally Invasive' | 'Foundational'\n  impact: number (0-1 effectiveness score)\n  coverage: number (metrics improved)\n  matchedFlaws: string[] (which flaws it addresses)\n  matchedRatios: string[] (which measurements it impacts)\n  ratios_impacted: RatioImpact[]\n  timeline: { effect_start, full_results_weeks }\n  cost: { type, min, max, currency }\n  risks_side_effects: string\n  warnings: string[]\n  gender: 'male' | 'female' | 'both'\n}\n    ↓\nUI Display Components\n```\n\n### 4. UI Display Locations\n\n**Primary Display: PlanTab** (`src/components/results/tabs/PlanTab.tsx`)\n- Shows filtered recommendations grouped by phase\n- Features:\n  - Phase filter buttons (Foundational, Minimally Invasive, Surgical)\n  - \"Potential Score\" card showing before/after improvements\n  - \"Order of Operations\" guidance\n  - Expandable recommendation cards\n\n**Secondary Display: EnhancedRecommendationCard** (`src/components/results/cards/EnhancedRecommendationCard.tsx`)\n- Comprehensive per-recommendation interface:\n  - Quick stats: cost, timeline, effectiveness\n  - Improvements targeting (matched flaws)\n  - How it helps section\n  - Logistics & timeline details\n  - Considerations (prerequisites, risks, warnings)\n  - **Research citations** (16 entries with gender/ethnicity filtering)\n  - **Personal Tracker section** (notes + checklist)\n\n**Research Citations System** (within EnhancedRecommendationCard):\n- 16 hardcoded academic citations\n- Relevance scoring based on:\n  - Procedure specificity (fewer procedures = higher score)\n  - Gender matching (exact match scores higher)\n  - Ethnicity specificity (matched ethnicity scores higher)\n  - Publication recency (newer slightly preferred)\n- Top 3 citations displayed per recommendation\n\n### 5. Current Monetization Hooks\n\n**None currently implemented**, but the architecture supports future additions:\n\n1. **Procedure database structure** in ResultsContext (PROCEDURE_DATABASE) is designed for extensibility:\n   - ref_id references (e.g., \"SUR-01\") could map to external resources\n   - Procedure configs include metadata ready for linking\n\n2. **Cost structures** are in place but are fixed estimates:\n   - Not sourced from any database\n   - Not linked to provider listings\n   - No price variations by location/provider\n\n3. **Research citations** could be monetized:\n   - DOI links are present (e.g., `https://doi.org/{citation.doi}`)\n   - Could be expanded to link to provider resources or product reviews\n   - Currently purely educational\n\n4. **No tracking of user interest**:\n   - No analytics on which recommendations users click\n   - No favoriting/bookmarking system\n   - No recommendation history\n\n### Key Insights for Monetization Opportunities\n\n1. **Affiliate-Ready Structure**: \n   - The ref_id system (SUR-01, MIN-02, etc.) is perfect for mapping to affiliate products/providers\n   - Could link each procedure to vetted providers or product recommendations\n\n2. **Citation Authority**:\n   - 16 academic citations provide credibility\n   - Could expand to include product reviews/affiliate links within citations\n\n3. **Personal Tracker**:\n   - Currently just local state\n   - Could be extended to allow users to save/compare procedures\n   - Natural point for monetization through provider partnerships\n\n4. **Gender/Ethnicity Segmentation**:\n   - System already handles demographic-specific recommendations\n   - Could segment affiliate offers by demographic\n\n5. **Currently Free of Conflicts**:\n   - No existing monetization means clean slate\n   - Can be designed from ground up to avoid trust issues\n\n---\n\n**Files analyzed:**\n- `/src/lib/advice-engine.ts` (440 lines)\n- `/src/lib/insights-engine.ts` (2,282 lines)\n- `/src/components/results/cards/EnhancedRecommendationCard.tsx` (844 lines)\n- `/src/components/results/tabs/PlanTab.tsx` (240+ lines)\n- `/src/contexts/ResultsContext.tsx` (1,000+ lines core section)\n- `/src/types/results.ts` (299 lines)\n- `/src/components/results/cards/PlanActionCard.tsx` (177 lines)"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":6076,"cache_read_input_tokens":80325,"cache_creation":{"ephemeral_5m_input_tokens":6076,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWLkXHmrxJpnrSR4axS25","type":"assistant","uuid":"0afd508f-cff6-4afe-bae4-a971f0b0e9a6","timestamp":"2025-12-22T00:07:38.977Z"}
