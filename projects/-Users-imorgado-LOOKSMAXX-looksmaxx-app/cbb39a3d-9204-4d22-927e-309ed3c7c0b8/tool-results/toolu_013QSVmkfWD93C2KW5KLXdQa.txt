     1→"""
     2→Email service using SendGrid
     3→"""
     4→
     5→from sendgrid import SendGridAPIClient
     6→from sendgrid.helpers.mail import Mail, Email, To, Content
     7→from app.config import get_settings
     8→
     9→
    10→class EmailService:
    11→    """SendGrid email service for transactional emails"""
    12→
    13→    def __init__(self):
    14→        self._client = None
    15→
    16→    def _get_settings(self):
    17→        """Get fresh settings each time (not cached at init)"""
    18→        return get_settings()
    19→
    20→    @property
    21→    def api_key(self):
    22→        return self._get_settings().sendgrid_api_key
    23→
    24→    @property
    25→    def from_email(self):
    26→        return self._get_settings().sendgrid_from_email
    27→
    28→    @property
    29→    def from_name(self):
    30→        return self._get_settings().sendgrid_from_name
    31→
    32→    @property
    33→    def frontend_url(self):
    34→        return self._get_settings().frontend_url
    35→
    36→    @property
    37→    def client(self):
    38→        if self._client is None and self.api_key:
    39→            self._client = SendGridAPIClient(self.api_key)
    40→        return self._client
    41→
    42→    @property
    43→    def is_configured(self) -> bool:
    44→        return bool(self.api_key)
    45→
    46→    async def send_password_reset_email(self, to_email: str, reset_token: str) -> bool:
    47→        """
    48→        Send password reset email with reset link.
    49→        Returns True if sent successfully, False otherwise.
    50→        """
    51→        if not self.is_configured:
    52→            print(f"[EMAIL] SendGrid not configured. Reset token for {to_email}: {reset_token}")
    53→            return False
    54→
    55→        reset_url = f"{self.frontend_url}/reset-password?token={reset_token}"
    56→
    57→        html_content = f"""
    58→<!DOCTYPE html>
    59→<html>
    60→<head>
    61→    <meta charset="utf-8">
    62→    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    63→</head>
    64→<body style="margin: 0; padding: 0; background-color: #000000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
    65→    <table role="presentation" style="width: 100%; border-collapse: collapse;">
    66→        <tr>
    67→            <td align="center" style="padding: 40px 20px;">
    68→                <table role="presentation" style="max-width: 480px; width: 100%; border-collapse: collapse;">
    69→                    <!-- Logo -->
    70→                    <tr>
    71→                        <td align="center" style="padding-bottom: 32px;">
    72→                            <div style="width: 48px; height: 48px; background-color: rgba(0, 243, 255, 0.2); border-radius: 8px; display: inline-flex; align-items: center; justify-content: center;">
    73→                                <span style="color: #00f3ff; font-size: 24px; font-weight: bold;">L</span>
    74→                            </div>
    75→                        </td>
    76→                    </tr>
    77→
    78→                    <!-- Title -->
    79→                    <tr>
    80→                        <td align="center" style="padding-bottom: 16px;">
    81→                            <h1 style="margin: 0; color: #ffffff; font-size: 24px; font-weight: 600;">
    82→                                Reset Your Password
    83→                            </h1>
    84→                        </td>
    85→                    </tr>
    86→
    87→                    <!-- Message -->
    88→                    <tr>
    89→                        <td align="center" style="padding-bottom: 32px;">
    90→                            <p style="margin: 0; color: #a3a3a3; font-size: 16px; line-height: 24px;">
    91→                                We received a request to reset your password. Click the button below to create a new password. This link will expire in 1 hour.
    92→                            </p>
    93→                        </td>
    94→                    </tr>
    95→
    96→                    <!-- Button -->
    97→                    <tr>
    98→                        <td align="center" style="padding-bottom: 32px;">
    99→                            <a href="{reset_url}"
   100→                               style="display: inline-block; padding: 14px 32px; background-color: #00f3ff; color: #000000; text-decoration: none; font-size: 16px; font-weight: 600; border-radius: 8px;">
   101→                                Reset Password
   102→                            </a>
   103→                        </td>
   104→                    </tr>
   105→
   106→                    <!-- Alternative Link -->
   107→                    <tr>
   108→                        <td align="center" style="padding-bottom: 32px;">
   109→                            <p style="margin: 0; color: #737373; font-size: 14px; line-height: 20px;">
   110→                                If the button doesn't work, copy and paste this link into your browser:
   111→                            </p>
   112→                            <p style="margin: 8px 0 0 0; word-break: break-all;">
   113→                                <a href="{reset_url}" style="color: #00f3ff; font-size: 14px;">{reset_url}</a>
   114→                            </p>
   115→                        </td>
   116→                    </tr>
   117→
   118→                    <!-- Security Note -->
   119→                    <tr>
   120→                        <td align="center" style="padding: 24px; background-color: #171717; border-radius: 8px;">
   121→                            <p style="margin: 0; color: #737373; font-size: 14px; line-height: 20px;">
   122→                                If you didn't request a password reset, you can safely ignore this email. Your password will remain unchanged.
   123→                            </p>
   124→                        </td>
   125→                    </tr>
   126→
   127→                    <!-- Footer -->
   128→                    <tr>
   129→                        <td align="center" style="padding-top: 32px;">
   130→                            <p style="margin: 0; color: #525252; font-size: 12px;">
   131→                                &copy; 2024 LOOKSMAXX. All rights reserved.
   132→                            </p>
   133→                        </td>
   134→                    </tr>
   135→                </table>
   136→            </td>
   137→        </tr>
   138→    </table>
   139→</body>
   140→</html>
   141→"""
   142→
   143→        text_content = f"""
   144→Reset Your Password
   145→
   146→We received a request to reset your password. Click the link below to create a new password. This link will expire in 1 hour.
   147→
   148→Reset Password: {reset_url}
   149→
   150→If you didn't request a password reset, you can safely ignore this email. Your password will remain unchanged.
   151→
   152→© 2024 LOOKSMAXX
   153→"""
   154→
   155→        try:
   156→            message = Mail(
   157→                from_email=Email(self.from_email, self.from_name),
   158→                to_emails=To(to_email),
   159→                subject="Reset Your LOOKSMAXX Password",
   160→            )
   161→            message.add_content(Content("text/plain", text_content))
   162→            message.add_content(Content("text/html", html_content))
   163→
   164→            response = self.client.send(message)
   165→
   166→            if response.status_code in (200, 201, 202):
   167→                print(f"[EMAIL] Password reset email sent to {to_email}")
   168→                return True
   169→            else:
   170→                print(f"[EMAIL] Failed to send email: {response.status_code}")
   171→                return False
   172→
   173→        except Exception as e:
   174→            print(f"[EMAIL] Error sending email: {e}")
   175→            return False
   176→
   177→    async def send_welcome_email(self, to_email: str, username: str) -> bool:
   178→        """
   179→        Send welcome email to new users.
   180→        Returns True if sent successfully, False otherwise.
   181→        """
   182→        if not self.is_configured:
   183→            print(f"[EMAIL] SendGrid not configured. Skipping welcome email for {to_email}")
   184→            return False
   185→
   186→        html_content = f"""
   187→<!DOCTYPE html>
   188→<html>
   189→<head>
   190→    <meta charset="utf-8">
   191→    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   192→</head>
   193→<body style="margin: 0; padding: 0; background-color: #000000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
   194→    <table role="presentation" style="width: 100%; border-collapse: collapse;">
   195→        <tr>
   196→            <td align="center" style="padding: 40px 20px;">
   197→                <table role="presentation" style="max-width: 480px; width: 100%; border-collapse: collapse;">
   198→                    <!-- Logo -->
   199→                    <tr>
   200→                        <td align="center" style="padding-bottom: 32px;">
   201→                            <div style="width: 48px; height: 48px; background-color: rgba(0, 243, 255, 0.2); border-radius: 8px; display: inline-flex; align-items: center; justify-content: center;">
   202→                                <span style="color: #00f3ff; font-size: 24px; font-weight: bold;">L</span>
   203→                            </div>
   204→                        </td>
   205→                    </tr>
   206→
   207→                    <!-- Title -->
   208→                    <tr>
   209→                        <td align="center" style="padding-bottom: 16px;">
   210→                            <h1 style="margin: 0; color: #ffffff; font-size: 24px; font-weight: 600;">
   211→                                Welcome to LOOKSMAXX, {username}!
   212→                            </h1>
   213→                        </td>
   214→                    </tr>
   215→
   216→                    <!-- Message -->
   217→                    <tr>
   218→                        <td align="center" style="padding-bottom: 32px;">
   219→                            <p style="margin: 0; color: #a3a3a3; font-size: 16px; line-height: 24px;">
   220→                                Your account has been created successfully. Start your facial analysis journey today.
   221→                            </p>
   222→                        </td>
   223→                    </tr>
   224→
   225→                    <!-- Button -->
   226→                    <tr>
   227→                        <td align="center" style="padding-bottom: 32px;">
   228→                            <a href="{self.frontend_url}"
   229→                               style="display: inline-block; padding: 14px 32px; background-color: #00f3ff; color: #000000; text-decoration: none; font-size: 16px; font-weight: 600; border-radius: 8px;">
   230→                                Start Analysis
   231→                            </a>
   232→                        </td>
   233→                    </tr>
   234→
   235→                    <!-- Footer -->
   236→                    <tr>
   237→                        <td align="center" style="padding-top: 32px;">
   238→                            <p style="margin: 0; color: #525252; font-size: 12px;">
   239→                                &copy; 2024 LOOKSMAXX. All rights reserved.
   240→                            </p>
   241→                        </td>
   242→                    </tr>
   243→                </table>
   244→            </td>
   245→        </tr>
   246→    </table>
   247→</body>
   248→</html>
   249→"""
   250→
   251→        text_content = f"""
   252→Welcome to LOOKSMAXX, {username}!
   253→
   254→Your account has been created successfully. Start your facial analysis journey today.
   255→
   256→Visit: {self.frontend_url}
   257→
   258→© 2024 LOOKSMAXX
   259→"""
   260→
   261→        try:
   262→            message = Mail(
   263→                from_email=Email(self.from_email, self.from_name),
   264→                to_emails=To(to_email),
   265→                subject="Welcome to LOOKSMAXX!",
   266→            )
   267→            message.add_content(Content("text/plain", text_content))
   268→            message.add_content(Content("text/html", html_content))
   269→
   270→            response = self.client.send(message)
   271→
   272→            if response.status_code in (200, 201, 202):
   273→                print(f"[EMAIL] Welcome email sent to {to_email}")
   274→                return True
   275→            else:
   276→                print(f"[EMAIL] Failed to send welcome email: {response.status_code}")
   277→                return False
   278→
   279→        except Exception as e:
   280→            print(f"[EMAIL] Error sending welcome email: {e}")
   281→            return False
   282→
   283→
   284→# Singleton instance
   285→email_service = EmailService()
   286→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
