     1→"""
     2→LOOKSMAXX API - Unified backend for facial analysis
     3→"""
     4→import sys
     5→print("[STARTUP] Loading main.py...", flush=True)
     6→
     7→from contextlib import asynccontextmanager
     8→from fastapi import FastAPI
     9→from fastapi.middleware.cors import CORSMiddleware
    10→
    11→print("[STARTUP] Imports done, loading config...", flush=True)
    12→
    13→from app.config import get_settings
    14→print("[STARTUP] Config loaded, loading database...", flush=True)
    15→
    16→from app.database import engine, Base
    17→print("[STARTUP] Database loaded, loading services...", flush=True)
    18→
    19→from app.services.detection import detection_service
    20→from app.routers import auth_router, detection_router, analyses_router, payments_router, leaderboard_router, referrals_router, forum_router, psl_router, archetype_router, physique_router
    21→
    22→print("[STARTUP] All imports complete!", flush=True)
    23→
    24→settings = get_settings()
    25→print(f"[STARTUP] Settings: frontend_url={settings.frontend_url}", flush=True)
    26→
    27→
    28→@asynccontextmanager
    29→async def lifespan(app: FastAPI):
    30→    """Startup and shutdown events"""
    31→    # Startup
    32→    print("[API] Starting up...", flush=True)
    33→
    34→    try:
    35→        # Create database tables
    36→        async with engine.begin() as conn:
    37→            await conn.run_sync(Base.metadata.create_all)
    38→        print("[API] Database tables created", flush=True)
    39→    except Exception as e:
    40→        print(f"[API] Database error (non-fatal): {e}", flush=True)
    41→
    42→    # Note: InsightFace model is lazy-loaded on first detection request
    43→    # This reduces startup memory usage and prevents OOM on Railway
    44→    print("[API] Detection service ready (lazy-load enabled)", flush=True)
    45→
    46→    yield
    47→
    48→    # Shutdown
    49→    print("[API] Shutting down...", flush=True)
    50→    await engine.dispose()
    51→
    52→
    53→app = FastAPI(
    54→    title="LOOKSMAXX API",
    55→    description="Facial analysis and metrics API",
    56→    version="1.0.0",
    57→    lifespan=lifespan,
    58→)
    59→
    60→# CORS middleware
    61→app.add_middleware(
    62→    CORSMiddleware,
    63→    allow_origins=[
    64→        settings.frontend_url,
    65→        "http://localhost:3000",
    66→        "http://localhost:3001",
    67→    ],
    68→    allow_credentials=True,
    69→    allow_methods=["*"],
    70→    allow_headers=["*"],
    71→)
    72→
    73→# Include routers
    74→app.include_router(auth_router)
    75→app.include_router(detection_router)
    76→app.include_router(analyses_router)
    77→app.include_router(payments_router)
    78→app.include_router(leaderboard_router)
    79→app.include_router(referrals_router)
    80→app.include_router(forum_router)
    81→app.include_router(psl_router)
    82→app.include_router(archetype_router)
    83→app.include_router(physique_router)
    84→
    85→
    86→@app.get("/")
    87→async def root():
    88→    """Root endpoint - API info"""
    89→    return {
    90→        "name": "LOOKSMAXX API",
    91→        "version": "1.0.0",
    92→        "status": "running",
    93→        "docs": "/docs",
    94→    }
    95→
    96→
    97→@app.get("/health")
    98→async def health():
    99→    """Health check endpoint"""
   100→    return {
   101→        "status": "healthy",
   102→        "detection_ready": detection_service._face_analyzer is not None,
   103→    }
   104→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
