     1→"""
     2→Authentication router - register, login, profile, password reset
     3→"""
     4→
     5→import secrets
     6→from datetime import datetime, timedelta
     7→from fastapi import APIRouter, Depends, HTTPException, status
     8→from sqlalchemy.ext.asyncio import AsyncSession
     9→from sqlalchemy import select, func
    10→from uuid import uuid4
    11→
    12→from app.database import get_db
    13→from app.models.user import User, ReferralCode
    14→from app.schemas.user import (
    15→    UserCreate, UserLogin, UserResponse, Token,
    16→    ForgotPasswordRequest, ResetPasswordRequest
    17→)
    18→from app.services.auth import AuthService, get_current_user
    19→from app.services.email import email_service
    20→
    21→router = APIRouter(prefix="/auth", tags=["auth"])
    22→
    23→
    24→@router.post("/register", response_model=Token)
    25→async def register(user_data: UserCreate, db: AsyncSession = Depends(get_db)):
    26→    """Register a new user"""
    27→    # Check if email exists
    28→    result = await db.execute(select(User).where(User.email == user_data.email))
    29→    existing_user = result.scalar_one_or_none()
    30→
    31→    if existing_user:
    32→        raise HTTPException(
    33→            status_code=status.HTTP_400_BAD_REQUEST,
    34→            detail="Email already registered"
    35→        )
    36→
    37→    # Check if username already exists (case-insensitive)
    38→    result = await db.execute(
    39→        select(User).where(func.lower(User.username) == user_data.username.lower())
    40→    )
    41→    existing_username = result.scalar_one_or_none()
    42→
    43→    if existing_username:
    44→        raise HTTPException(
    45→            status_code=status.HTTP_400_BAD_REQUEST,
    46→            detail="Username already taken"
    47→        )
    48→
    49→    # Validate referral code if provided
    50→    stripe_promo_id = None
    51→    if user_data.referral_code:
    52→        result = await db.execute(
    53→            select(ReferralCode).where(
    54→                func.upper(ReferralCode.code) == user_data.referral_code.upper(),
    55→                ReferralCode.is_active == True
    56→            )
    57→        )
    58→        referral = result.scalar_one_or_none()
    59→        if referral:
    60→            stripe_promo_id = referral.stripe_promotion_code_id
    61→            # Increment usage count
    62→            referral.total_uses += 1
    63→
    64→    # Create user
    65→    hashed_password = AuthService.hash_password(user_data.password)
    66→    user = User(
    67→        id=uuid4(),
    68→        email=user_data.email,
    69→        password_hash=hashed_password,
    70→        name=user_data.name,
    71→        username=user_data.username,
    72→        terms_accepted_at=datetime.utcnow() if user_data.terms_accepted else None,
    73→        referral_code=user_data.referral_code,
    74→        referred_by=stripe_promo_id,
    75→    )
    76→
    77→    db.add(user)
    78→    await db.commit()
    79→    await db.refresh(user)
    80→
    81→    # Send welcome email (non-blocking, don't fail registration if email fails)
    82→    try:
    83→        await email_service.send_welcome_email(user.email, user.username)
    84→    except Exception as e:
    85→        print(f"[AUTH] Failed to send welcome email: {e}")
    86→
    87→    # Generate token
    88→    access_token = AuthService.create_access_token(str(user.id))
    89→
    90→    return Token(access_token=access_token, token_type="bearer", user=user)
    91→
    92→
    93→@router.post("/login", response_model=Token)
    94→async def login(credentials: UserLogin, db: AsyncSession = Depends(get_db)):
    95→    """Login and get JWT token"""
    96→    result = await db.execute(select(User).where(User.email == credentials.email))
    97→    user = result.scalar_one_or_none()
    98→
    99→    if not user or not AuthService.verify_password(credentials.password, user.password_hash):
   100→        raise HTTPException(
   101→            status_code=status.HTTP_401_UNAUTHORIZED,
   102→            detail="Invalid email or password",
   103→            headers={"WWW-Authenticate": "Bearer"},
   104→        )
   105→
   106→    access_token = AuthService.create_access_token(str(user.id))
   107→
   108→    return Token(access_token=access_token, token_type="bearer", user=user)
   109→
   110→
   111→@router.get("/me", response_model=UserResponse)
   112→async def get_me(current_user: User = Depends(get_current_user)):
   113→    """Get current user profile"""
   114→    return current_user
   115→
   116→
   117→@router.get("/check-username/{username}")
   118→async def check_username(username: str, db: AsyncSession = Depends(get_db)):
   119→    """Check if a username is available (no auth required)"""
   120→    # Validate format
   121→    if len(username) < 3:
   122→        return {"available": False, "reason": "Too short"}
   123→    if len(username) > 30:
   124→        return {"available": False, "reason": "Too long"}
   125→    if not all(c.isalnum() or c == '_' for c in username):
   126→        return {"available": False, "reason": "Invalid characters"}
   127→    if username.lower().startswith('user_'):
   128→        return {"available": False, "reason": "Reserved prefix"}
   129→
   130→    # Check database
   131→    result = await db.execute(
   132→        select(User).where(func.lower(User.username) == username.lower())
   133→    )
   134→    exists = result.scalar_one_or_none()
   135→
   136→    return {
   137→        "available": not exists,
   138→        "reason": "Username taken" if exists else None
   139→    }
   140→
   141→
   142→@router.get("/validate-referral/{code}")
   143→async def validate_referral_code(code: str, db: AsyncSession = Depends(get_db)):
   144→    """Validate a referral code (no auth required)"""
   145→    if len(code) < 3:
   146→        return {"valid": False, "message": "Invalid code format"}
   147→
   148→    result = await db.execute(
   149→        select(ReferralCode).where(
   150→            func.upper(ReferralCode.code) == code.upper(),
   151→            ReferralCode.is_active == True
   152→        )
   153→    )
   154→    referral = result.scalar_one_or_none()
   155→
   156→    if referral:
   157→        discount_msg = f"{referral.discount_percent}% discount" if referral.discount_percent else "Special offer"
   158→        return {
   159→            "valid": True,
   160→            "message": f"Code applied! {discount_msg} from {referral.influencer_name}"
   161→        }
   162→
   163→    return {"valid": False, "message": "Invalid or expired code"}
   164→
   165→
   166→@router.post("/forgot-password")
   167→async def forgot_password(data: ForgotPasswordRequest, db: AsyncSession = Depends(get_db)):
   168→    """Request a password reset email"""
   169→    # Always return success to prevent email enumeration
   170→    result = await db.execute(select(User).where(User.email == data.email))
   171→    user = result.scalar_one_or_none()
   172→
   173→    if user:
   174→        # Generate secure reset token
   175→        reset_token = secrets.token_urlsafe(32)
   176→        user.password_reset_token = reset_token
   177→        user.password_reset_expires = datetime.utcnow() + timedelta(hours=1)
   178→        await db.commit()
   179→
   180→        # Send password reset email
   181→        await email_service.send_password_reset_email(user.email, reset_token)
   182→
   183→    return {"message": "If an account exists with this email, a reset link has been sent."}
   184→
   185→
   186→@router.post("/reset-password")
   187→async def reset_password(data: ResetPasswordRequest, db: AsyncSession = Depends(get_db)):
   188→    """Reset password using token"""
   189→    result = await db.execute(
   190→        select(User).where(
   191→            User.password_reset_token == data.token,
   192→            User.password_reset_expires > datetime.utcnow()
   193→        )
   194→    )
   195→    user = result.scalar_one_or_none()
   196→
   197→    if not user:
   198→        raise HTTPException(
   199→            status_code=status.HTTP_400_BAD_REQUEST,
   200→            detail="Invalid or expired reset token"
   201→        )
   202→
   203→    # Update password
   204→    user.password_hash = AuthService.hash_password(data.new_password)
   205→    user.password_reset_token = None
   206→    user.password_reset_expires = None
   207→    await db.commit()
   208→
   209→    return {"message": "Password has been reset successfully"}
   210→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
