     1→'use client';
     2→
     3→import { useState, useMemo, useCallback } from 'react';
     4→import { motion, AnimatePresence } from 'framer-motion';
     5→import {
     6→  Sparkles,
     7→  TrendingUp,
     8→  Target,
     9→  Zap,
    10→  ChevronRight,
    11→  CheckCircle,
    12→  Scale,
    13→  Dumbbell,
    14→  Salad,
    15→  ArrowDown,
    16→  ArrowUp,
    17→  Minus,
    18→  Package,
    19→} from 'lucide-react';
    20→import { useResults } from '@/contexts/ResultsContext';
    21→import { useAuth } from '@/contexts/AuthContext';
    22→import { usePricing } from '@/contexts/PricingContext';
    23→import { usePhysiqueOptional } from '@/contexts/PhysiqueContext';
    24→import { TabContent } from '../ResultsLayout';
    25→import { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';
    26→import { ScoreCircle, PhaseBadge } from '../shared';
    27→import { TreatmentTimeline } from '../visualization/TreatmentTimeline';
    28→import { RecommendationPhase } from '@/types/results';
    29→import { DailyStackCard } from '../cards/DailyStackCard';
    30→import { ProductCard } from '../cards/ProductCard';
    31→import { WeakPointCard } from '../cards/WeakPointCard';
    32→import { ProgressComparisonCard } from '../cards/ProgressComparisonCard';
    33→import { MedicalPrescriptionCard } from '../cards/MedicalPrescriptionCard';
    34→import { generateDailyStack } from '@/lib/daily-stack';
    35→import { getProductRecommendations } from '@/lib/product-recommendations';
    36→import { SUPPLEMENTS } from '@/lib/recommendations/supplements';
    37→import {
    38→  TreatmentConflictList,
    39→  SelectionWarningModal,
    40→} from '../cards/TreatmentConflictWarning';
    41→import {
    42→  findTreatmentConflicts,
    43→  type TreatmentConflict,
    44→} from '@/lib/recommendations/engine';
    45→
    46→// ============================================
    47→// SECTION HEADER COMPONENT
    48→// ============================================
    49→
    50→function SectionHeader({ title, children }: { title: string; children?: React.ReactNode }) {
    51→  return (
    52→    <div className="flex items-center gap-4 mb-6">
    53→      <h2 className="text-[10px] font-black uppercase tracking-[0.4em] text-neutral-600 whitespace-nowrap">
    54→        {title}
    55→      </h2>
    56→      <div className="flex-1 h-px bg-neutral-800" />
    57→      {children}
    58→    </div>
    59→  );
    60→}
    61→
    62→// ============================================
    63→// POTENTIAL SCORE CARD
    64→// ============================================
    65→
    66→function PotentialScoreCard() {
    67→  const { overallScore, recommendations } = useResults();
    68→  const numericScore = typeof overallScore === 'number' ? overallScore : 0;
    69→
    70→  // Calculate potential improvement
    71→  const potentialImprovement = useMemo(() => {
    72→    if (recommendations.length === 0) return 0;
    73→    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + (r.impact || 0), 0);
    74→    return Math.min(totalImpact * 1.5, 10 - numericScore);
    75→  }, [recommendations, numericScore]);
    76→
    77→  const potentialScore = Math.min(10, numericScore + potentialImprovement);
    78→
    79→  return (
    80→    <motion.div
    81→      className="rounded-[2rem] bg-neutral-900/40 border border-white/5 p-6 md:p-8"
    82→      initial={{ opacity: 0, y: 20 }}
    83→      animate={{ opacity: 1, y: 0 }}
    84→    >
    85→      <div className="flex items-center gap-3 mb-6">
    86→        <div className="w-10 h-10 rounded-xl bg-neutral-900 border border-white/10 flex items-center justify-center">
    87→          <Sparkles size={18} className="text-cyan-400" />
    88→        </div>
    89→        <div>
    90→          <h3 className="text-sm font-black uppercase tracking-wider text-white">Your Potential</h3>
    91→          <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-600">Maximum Achievable Score</p>
    92→        </div>
    93→      </div>
    94→
    95→      <div className="flex items-center justify-center gap-6 md:gap-10 mb-6">
    96→        {/* Current */}
    97→        <div className="text-center">
    98→          <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-600 mb-3">Current</p>
    99→          <ScoreCircle score={overallScore} size="lg" animate={false} />
   100→        </div>
   101→
   102→        {/* Arrow */}
   103→        <div className="flex flex-col items-center gap-2">
   104→          <ChevronRight size={28} className="text-cyan-400" />
   105→          <span className="px-2 py-1 rounded-lg bg-green-500/20 border border-green-500/30 text-xs font-black uppercase tracking-wider text-green-400">
   106→            +{potentialImprovement.toFixed(1)}
   107→          </span>
   108→        </div>
   109→
   110→        {/* Potential */}
   111→        <div className="text-center">
   112→          <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-600 mb-3">Potential</p>
   113→          <div className="relative">
   114→            <ScoreCircle score={potentialScore} size="lg" animate={false} />
   115→            <div className="absolute -top-1 -right-1 w-6 h-6 bg-green-500 rounded-lg flex items-center justify-center shadow-lg shadow-green-500/30">
   116→              <TrendingUp size={14} className="text-black" />
   117→            </div>
   118→          </div>
   119→        </div>
   120→      </div>
   121→
   122→      <p className="text-sm text-neutral-400 text-center leading-relaxed">
   123→        Following our recommendations could improve your harmony score by up to{' '}
   124→        <span className="text-green-400 font-black">+{potentialImprovement.toFixed(1)} points</span>
   125→      </p>
   126→    </motion.div>
   127→  );
   128→}
   129→
   130→// ============================================
   131→// PHASE FILTER
   132→// ============================================
   133→
   134→interface PhaseFilterProps {
   135→  selectedPhase: RecommendationPhase | null;
   136→  onSelect: (phase: RecommendationPhase | null) => void;
   137→  counts: Record<RecommendationPhase, number>;
   138→}
   139→
   140→function PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {
   141→  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];
   142→
   143→  return (
   144→    <div className="flex flex-wrap gap-2">
   145→      <button
   146→        onClick={() => onSelect(null)}
   147→        className={`px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider transition-all border ${selectedPhase === null
   148→          ? 'bg-cyan-500 text-black border-cyan-400'
   149→          : 'bg-neutral-900/50 text-neutral-400 border-white/5 hover:border-white/10 hover:text-white'
   150→          }`}
   151→      >
   152→        All ({Object.values(counts).reduce((a, b) => a + b, 0)})
   153→      </button>
   154→      {phases.map(phase => (
   155→        <button
   156→          key={phase}
   157→          onClick={() => onSelect(phase)}
   158→          className={`px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2 border ${selectedPhase === phase
   159→            ? 'bg-neutral-800 text-white border-white/10'
   160→            : 'bg-neutral-900/50 text-neutral-400 border-white/5 hover:border-white/10 hover:text-white'
   161→            }`}
   162→        >
   163→          <PhaseBadge phase={phase} size="sm" />
   164→          ({counts[phase] || 0})
   165→        </button>
   166→      ))}
   167→    </div>
   168→  );
   169→}
   170→
   171→// ============================================
   172→// YOUR PHASE CARD (Body Composition Phase)
   173→// ============================================
   174→
   175→type BodyPhase = 'bulk' | 'cut' | 'maintain';
   176→
   177→interface YourPhaseCardProps {
   178→  bodyFatPercent?: number;
   179→  gender: 'male' | 'female';
   180→}
   181→
   182→function YourPhaseCard({ bodyFatPercent, gender }: YourPhaseCardProps) {
   183→  // Determine phase based on body fat and gender
   184→  const getPhase = (): { phase: BodyPhase; message: string; color: string; icon: React.ReactNode } => {
   185→    if (!bodyFatPercent) {
   186→      return {
   187→        phase: 'maintain',
   188→        message: 'Complete your physique analysis to get personalized phase recommendations.',
   189→        color: 'from-neutral-800 to-neutral-900',
   190→        icon: <Scale size={24} className="text-neutral-400" />,
   191→      };
   192→    }
   193→
   194→    // Male thresholds: <12% = bulk, 12-18% = maintain, >18% = cut
   195→    // Female thresholds: <18% = bulk, 18-25% = maintain, >25% = cut
   196→    const bulkThreshold = gender === 'male' ? 12 : 18;
   197→    const cutThreshold = gender === 'male' ? 18 : 25;
   198→
   199→    if (bodyFatPercent < bulkThreshold) {
   200→      return {
   201→        phase: 'bulk',
   202→        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're lean enough to build muscle. Focus on a slight caloric surplus with progressive overload.`,
   203→        color: 'from-green-600 to-emerald-700',
   204→        icon: <Dumbbell size={24} className="text-white" />,
   205→      };
   206→    } else if (bodyFatPercent > cutThreshold) {
   207→      return {
   208→        phase: 'cut',
   209→        message: `At ${bodyFatPercent.toFixed(1)}% body fat, prioritize fat loss. A moderate caloric deficit with high protein will reveal your facial structure.`,
   210→        color: 'from-orange-600 to-red-700',
   211→        icon: <Salad size={24} className="text-white" />,
   212→      };
   213→    } else {
   214→      return {
   215→        phase: 'maintain',
   216→        message: `At ${bodyFatPercent.toFixed(1)}% body fat, you're in the optimal range. Focus on body recomposition to build muscle while staying lean.`,
   217→        color: 'from-blue-600 to-cyan-700',
   218→        icon: <Scale size={24} className="text-white" />,
   219→      };
   220→    }
   221→  };
   222→
   223→  const { phase, message, color, icon } = getPhase();
   224→  const phaseLabels: Record<BodyPhase, string> = {
   225→    bulk: 'Lean Bulk Phase',
   226→    cut: 'Cutting Phase',
   227→    maintain: 'Maintenance Phase',
   228→  };
   229→
   230→  return (
   231→    <motion.div
   232→      className={`bg-gradient-to-br ${color} rounded-[2rem] p-6 md:p-8 border border-white/10`}
   233→      initial={{ opacity: 0, y: 20 }}
   234→      animate={{ opacity: 1, y: 0 }}
   235→    >
   236→      <div className="flex items-start gap-5">
   237→        <div className="w-14 h-14 rounded-2xl bg-white/20 border border-white/20 flex items-center justify-center flex-shrink-0 shadow-xl">
   238→          {icon}
   239→        </div>
   240→        <div className="flex-1">
   241→          <div className="flex items-center gap-3 mb-2">
   242→            <h3 className="text-lg font-black uppercase tracking-wider text-white">Your Phase</h3>
   243→            <div className="px-3 py-1 bg-white/20 border border-white/20 rounded-lg text-[10px] font-black uppercase tracking-wider text-white">
   244→              {phaseLabels[phase]}
   245→            </div>
   246→          </div>
   247→          <p className="text-sm text-white/80 leading-relaxed mb-5">{message}</p>
   248→
   249→          {/* Phase-specific tips */}
   250→          <div className="grid grid-cols-3 gap-3">
   251→            <div className="bg-black/20 rounded-xl p-3 text-center border border-white/10">
   252→              <div className="flex items-center justify-center gap-1.5 mb-1">
   253→                {phase === 'bulk' ? (
   254→                  <ArrowUp size={12} className="text-green-300" />
   255→                ) : phase === 'cut' ? (
   256→                  <ArrowDown size={12} className="text-orange-300" />
   257→                ) : (
   258→                  <Minus size={12} className="text-blue-300" />
   259→                )}
   260→                <span className="text-[10px] font-bold uppercase tracking-wider text-white/60">Calories</span>
   261→              </div>
   262→              <span className="text-sm font-black uppercase text-white">
   263→                {phase === 'bulk' ? '+300' : phase === 'cut' ? '-500' : '+/-0'}
   264→              </span>
   265→            </div>
   266→            <div className="bg-black/20 rounded-xl p-3 text-center border border-white/10">
   267→              <span className="text-[10px] font-bold uppercase tracking-wider text-white/60 block mb-1">Protein</span>
   268→              <span className="text-sm font-black uppercase text-white">
   269→                {phase === 'cut' ? '1.2g/lb' : '1g/lb'}
   270→              </span>
   271→            </div>
   272→            <div className="bg-black/20 rounded-xl p-3 text-center border border-white/10">
   273→              <span className="text-[10px] font-bold uppercase tracking-wider text-white/60 block mb-1">Cardio</span>
   274→              <span className="text-sm font-black uppercase text-white">
   275→                {phase === 'bulk' ? 'Minimal' : phase === 'cut' ? '4-5x/wk' : '2-3x/wk'}
   276→              </span>
   277→            </div>
   278→          </div>
   279→        </div>
   280→      </div>
   281→    </motion.div>
   282→  );
   283→}
   284→
   285→// ============================================
   286→// UNIFIED PRICING SUMMARY CARD
   287→// ============================================
   288→
   289→interface UnifiedPricingSummaryProps {
   290→  dailyStackCost: { min: number; max: number };
   291→  productCost: number;
   292→  totalProducts: number;
   293→  totalSupplements: number;
   294→}
   295→
   296→function UnifiedPricingSummary({ dailyStackCost, productCost, totalProducts, totalSupplements }: UnifiedPricingSummaryProps) {
   297→  const totalMin = dailyStackCost.min + productCost;
   298→  const totalMax = dailyStackCost.max + productCost;
   299→
   300→  return (
   301→    <motion.div
   302→      className="rounded-2xl bg-gradient-to-br from-cyan-900/30 to-blue-900/30 border border-cyan-500/20 p-5"
   303→      initial={{ opacity: 0, y: 20 }}
   304→      animate={{ opacity: 1, y: 0 }}
   305→    >
   306→      <div className="flex items-center gap-3 mb-4">
   307→        <div className="w-9 h-9 rounded-xl bg-cyan-500/20 border border-cyan-500/30 flex items-center justify-center">
   308→          <Package size={16} className="text-cyan-400" />
   309→        </div>
   310→        <h4 className="text-xs font-black uppercase tracking-wider text-white">Monthly Investment</h4>
   311→      </div>
   312→
   313→      {/* Cost Breakdown */}
   314→      <div className="space-y-3 mb-4">
   315→        <div className="flex items-center justify-between p-3 bg-black/20 rounded-xl border border-white/5">
   316→          <div>
   317→            <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-400">Foundation Stack</p>
   318→            <p className="text-[9px] font-bold uppercase tracking-wider text-neutral-600">{totalSupplements} supplements</p>
   319→          </div>
   320→          <span className="text-sm font-black text-white">${dailyStackCost.min}-${dailyStackCost.max}</span>
   321→        </div>
   322→        {productCost > 0 && (
   323→          <div className="flex items-center justify-between p-3 bg-black/20 rounded-xl border border-white/5">
   324→            <div>
   325→              <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-400">Corrective Products</p>
   326→              <p className="text-[9px] font-bold uppercase tracking-wider text-neutral-600">{totalProducts} products</p>
   327→            </div>
   328→            <span className="text-sm font-black text-white">${productCost}</span>
   329→          </div>
   330→        )}
   331→      </div>
   332→
   333→      {/* Total */}
   334→      <div className="border-t border-cyan-500/20 pt-4">
   335→        <div className="flex items-center justify-between">
   336→          <span className="text-[10px] font-bold uppercase tracking-wider text-neutral-400">Total Monthly</span>
   337→          <div className="text-right">
   338→            <span className="text-xl font-black text-cyan-400">${totalMin}-${totalMax}</span>
   339→            <span className="text-[9px] font-bold uppercase tracking-wider text-neutral-500 block">/month</span>
   340→          </div>
   341→        </div>
   342→      </div>
   343→    </motion.div>
   344→  );
   345→}
   346→
   347→
   348→// ============================================
   349→// PLAN TAB
   350→// ============================================
   351→
   352→// Plan subtab type
   353→type PlanSubTab = 'foundation' | 'fixes' | 'treatments';
   354→
   355→export function PlanTab() {
   356→  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios, overallScore, frontPhoto, vision, isUnlocked } = useResults();
   357→  const { user } = useAuth();
   358→  const physiqueContext = usePhysiqueOptional();
   359→  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);
   360→  const [expandedId, setExpandedId] = useState<string | null>(null);
   361→  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());
   362→  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());
   363→  const [previousAnalysis, setPreviousAnalysis] = useState<{
   364→    date: string;
   365→    overallScore: number;
   366→    bodyFatPercent?: number;
   367→    frontPhotoUrl?: string;
   368→  } | null>(null);
   369→
   370→  // Subtab state for organized navigation
   371→  const [activeSubTab, setActiveSubTab] = useState<PlanSubTab>('foundation');
   372→
   373→  // Treatment conflict state
   374→  const [dismissedConflicts, setDismissedConflicts] = useState<Set<string>>(new Set());
   375→  const [conflictModal, setConflictModal] = useState<{
   376→    isOpen: boolean;
   377→    conflict: TreatmentConflict | null;
   378→    newTreatmentId: string;
   379→  }>({ isOpen: false, conflict: null, newTreatmentId: '' });
   380→
   381→  const { openPricingModal } = usePricing();
   382→
   383→  // Convert to number for arithmetic operations
   384→  const numericOverallScore = typeof overallScore === 'number' ? overallScore : 0;
   385→
   386→  // Check if user has a paid plan
   387→  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';
   388→
   389→  // Get body fat from physique analysis
   390→  const bodyFatPercent = physiqueContext?.physiqueAnalysis?.bodyFatPercent;
   391→
   392→  // Generate Daily Stack for all users
   393→  const dailyStack = useMemo(() => {
   394→    return generateDailyStack(gender);
   395→  }, [gender]);
   396→
   397→  // Generate Product Recommendations based on metrics
   398→  const productRecommendations = useMemo(() => {
   399→    // Build metrics and severity dictionaries from ratios
   400→    const metricsDict: Record<string, number> = {};
   401→    const severityDict: Record<string, string> = {};
   402→
   403→    [...frontRatios, ...sideRatios].forEach(ratio => {
   404→      metricsDict[ratio.name] = typeof ratio.value === 'number' ? ratio.value : 0;
   405→      severityDict[ratio.name] = ratio.severity;
   406→    });
   407→
   408→    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);
   409→  }, [frontRatios, sideRatios, gender, ethnicity]);
   410→
   411→  // Split product recommendations by state
   412→  const { flawProducts, idealProducts } = useMemo(() => {
   413→    const flaw = productRecommendations.filter(r => r.state === 'flaw');
   414→    const ideal = productRecommendations.filter(r => r.state === 'ideal');
   415→    return { flawProducts: flaw, idealProducts: ideal };
   416→  }, [productRecommendations]);
   417→
   418→  // Map flaws to products and treatments
   419→  const flawsWithProducts = useMemo(() => {
   420→    return flaws.slice(0, 5).map(flaw => {
   421→      // Find products that target metrics related to this flaw
   422→      const relatedProducts = productRecommendations.filter(rec =>
   423→        flaw && flaw.responsibleRatios && flaw.responsibleRatios.some(ratio =>
   424→          rec.matchedMetrics.some(metric =>
   425→            metric.toLowerCase().includes(ratio.ratioName.toLowerCase()) ||
   426→            ratio.ratioName.toLowerCase().includes(metric.toLowerCase())
   427→          )
   428→        )
   429→      );
   430→
   431→      // Find treatments that match this flaw
   432→      const relatedTreatments = recommendations.filter(rec =>
   433→        rec.matchedFlaws.some(f => f.toLowerCase().includes(flaw.flawName.toLowerCase()))
   434→      );
   435→
   436→      return {
   437→        flaw,
   438→        products: relatedProducts.slice(0, 2),
   439→        treatments: relatedTreatments.slice(0, 3),
   440→      };
   441→    });
   442→  }, [flaws, productRecommendations, recommendations]);
   443→
   444→  // Handle progress photo upload
   445→  const handleProgressPhotoUpload = useCallback(async (file: File) => {
   446→    // Store current analysis as previous before re-analyzing
   447→    const numScore = typeof overallScore === 'number' ? overallScore : 0;
   448→    setPreviousAnalysis({
   449→      date: new Date().toISOString(),
   450→      overallScore: numScore,
   451→      bodyFatPercent,
   452→      frontPhotoUrl: frontPhoto || undefined,
   453→    });
   454→
   455→    // In a real implementation, this would upload to API and trigger re-analysis
   456→    console.log('Progress photo uploaded:', file.name);
   457→  }, [overallScore, bodyFatPercent, frontPhoto]);
   458→
   459→  // Count recommendations by phase
   460→  const phaseCounts = useMemo(() => {
   461→    const counts: Record<RecommendationPhase, number> = {
   462→      'Foundational': 0,
   463→      'Minimally Invasive': 0,
   464→      'Surgical': 0,
   465→    };
   466→    recommendations.forEach(r => {
   467→      if (!removedIds.has(r.ref_id)) {
   468→        counts[r.phase]++;
   469→      }
   470→    });
   471→    return counts;
   472→  }, [recommendations, removedIds]);
   473→
   474→  // Filter recommendations
   475→  const filteredRecommendations = useMemo(() => {
   476→    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));
   477→    if (selectedPhase) {
   478→      filtered = filtered.filter(r => r.phase === selectedPhase);
   479→    }
   480→    return filtered;
   481→  }, [recommendations, selectedPhase, removedIds]);
   482→
   483→  const hasRecommendations = filteredRecommendations.length > 0;
   484→
   485→  // Detect treatment conflicts in current recommendations
   486→  const treatmentConflicts = useMemo(() => {
   487→    const selectedIds = filteredRecommendations.map(r => r.ref_id);
   488→    const nameMap = Object.fromEntries(
   489→      filteredRecommendations.map(r => [r.ref_id, r.name])
   490→    );
   491→    const conflicts = findTreatmentConflicts(selectedIds, nameMap);
   492→
   493→    // Filter out dismissed conflicts
   494→    return conflicts.filter(c => {
   495→      const conflictKey = `${c.treatment1Id}-${c.treatment2Id}`;
   496→      return !dismissedConflicts.has(conflictKey);
   497→    });
   498→  }, [filteredRecommendations, dismissedConflicts]);
   499→
   500→  // Handle dismissing a conflict
   501→  const handleDismissConflict = useCallback((conflict: TreatmentConflict) => {
   502→    const conflictKey = `${conflict.treatment1Id}-${conflict.treatment2Id}`;
   503→    setDismissedConflicts(prev => new Set(Array.from(prev).concat(conflictKey)));
   504→  }, []);
   505→
   506→  // Handle dismissing all conflicts
   507→  const handleDismissAllConflicts = useCallback(() => {
   508→    const allKeys = treatmentConflicts.map(
   509→      c => `${c.treatment1Id}-${c.treatment2Id}`
   510→    );
   511→    setDismissedConflicts(prev => new Set(Array.from(prev).concat(allKeys)));
   512→  }, [treatmentConflicts]);
   513→
   514→  // Handle conflict modal actions
   515→  const handleConflictProceed = useCallback(() => {
   516→    if (conflictModal.conflict) {
   517→      // Remove the lower priority (existing) treatment
   518→      setRemovedIds(prev => new Set(Array.from(prev).concat(conflictModal.conflict!.treatment1Id)));
   519→    }
   520→    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });
   521→  }, [conflictModal.conflict]);
   522→
   523→  const handleConflictCancel = useCallback(() => {
   524→    setConflictModal({ isOpen: false, conflict: null, newTreatmentId: '' });
   525→  }, []);
   526→
   527→  // Handle mark complete
   528→  const handleMarkComplete = useCallback((id: string) => {
   529→    setCompletedIds(prev => {
   530→      const newSet = new Set(prev);
   531→      if (newSet.has(id)) {
   532→        newSet.delete(id);
   533→      } else {
   534→        newSet.add(id);
   535→      }
   536→      return newSet;
   537→    });
   538→  }, []);
   539→
   540→  // Handle remove
   541→  const handleRemove = useCallback((id: string) => {
   542→    setRemovedIds(prev => {
   543→      const newSet = new Set(prev);
   544→      newSet.add(id);
   545→      return newSet;
   546→    });
   547→    if (expandedId === id) {
   548→      setExpandedId(null);
   549→    }
   550→  }, [expandedId]);
   551→
   552→  // Calculate unified pricing
   553→  const unifiedPricing = useMemo(() => {
   554→    const stackCost = dailyStack?.totalCostPerMonth
   555→      ? { min: dailyStack.totalCostPerMonth.min || 0, max: dailyStack.totalCostPerMonth.max || 0 }
   556→      : { min: 0, max: 0 };
   557→
   558→    const productCost = flawProducts.slice(0, 3).reduce((sum, rec) => {
   559→      const supplement = SUPPLEMENTS.find(s => s.id === rec.product.supplementId);
   560→      return sum + (supplement?.costPerMonth?.min || 0);
   561→    }, 0);
   562→
   563→    return {
   564→      stackCost,
   565→      productCost,
   566→      totalProducts: flawProducts.length,
   567→      totalSupplements: dailyStack?.products?.length || 0,
   568→    };
   569→  }, [dailyStack, flawProducts]);
   570→
   571→  return (
   572→    <TabContent
   573→      title="Your Plan & Potential"
   574→      subtitle="Personalized recommendations based on your analysis"
   575→    >
   576→      {/* Subtab Navigation */}
   577→      <div className="flex items-center gap-1 p-1.5 bg-neutral-900/50 rounded-2xl border border-white/5 mb-8">
   578→        {[
   579→          { id: 'foundation' as PlanSubTab, label: 'Foundation', icon: <Sparkles size={14} /> },
   580→          { id: 'fixes' as PlanSubTab, label: 'Fix Issues', icon: <Target size={14} />, count: flaws.length },
   581→          { id: 'treatments' as PlanSubTab, label: 'Treatments', icon: <Zap size={14} />, count: filteredRecommendations.length },
   582→        ].map(tab => (
   583→          <button
   584→            key={tab.id}
   585→            onClick={() => setActiveSubTab(tab.id)}
   586→            className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-[10px] font-black uppercase tracking-wider transition-all ${
   587→              activeSubTab === tab.id
   588→                ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30'
   589→                : 'text-neutral-500 hover:text-white border border-transparent'
   590→            }`}
   591→          >
   592→            {tab.icon}
   593→            <span className="hidden sm:inline">{tab.label}</span>
   594→            {tab.count !== undefined && tab.count > 0 && (
   595→              <span className={`ml-1 px-1.5 py-0.5 rounded-md text-[9px] ${
   596→                activeSubTab === tab.id ? 'bg-cyan-500/30' : 'bg-neutral-800'
   597→              }`}>
   598→                {tab.count}
   599→              </span>
   600→            )}
   601→          </button>
   602→        ))}
   603→      </div>
   604→
   605→      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
   606→        {/* Main Content */}
   607→        <div className="lg:col-span-2 space-y-8">
   608→          <AnimatePresence mode="wait">
   609→            {/* FOUNDATION TAB */}
   610→            {activeSubTab === 'foundation' && (
   611→              <motion.div
   612→                key="foundation"
   613→                initial={{ opacity: 0, x: -20 }}
   614→                animate={{ opacity: 1, x: 0 }}
   615→                exit={{ opacity: 0, x: 20 }}
   616→                className="space-y-8"
   617→              >
   618→                {/* Your Phase Card */}
   619→                <YourPhaseCard bodyFatPercent={bodyFatPercent} gender={gender} />
   620→
   621→                {/* Potential Score */}
   622→                <PotentialScoreCard />
   623→
   624→                {/* Daily Stack Card */}
   625→                {dailyStack && <DailyStackCard dailyStack={dailyStack} />}
   626→              </motion.div>
   627→            )}
   628→
   629→            {/* FIX ISSUES TAB */}
   630→            {activeSubTab === 'fixes' && (
   631→              <motion.div
   632→                key="fixes"
   633→                initial={{ opacity: 0, x: -20 }}
   634→                animate={{ opacity: 1, x: 0 }}
   635→                exit={{ opacity: 0, x: 20 }}
   636→                className="space-y-8"
   637→              >
   638→                {/* Fix Your Weak Points Section */}
   639→                {flawsWithProducts.length > 0 && (
   640→                  <section>
   641→                    <SectionHeader title="Fix Your Weak Points">
   642→                      <span className="px-3 py-1.5 bg-red-500/20 border border-red-500/30 text-red-400 text-[10px] font-black uppercase tracking-wider rounded-lg">
   643→                        {flawsWithProducts.length} Issues
   644→                      </span>
   645→                    </SectionHeader>
   646→                    <div className="space-y-4">
   647→                      {flawsWithProducts.map((item, index) => (
   648→                        <WeakPointCard
   649→                          key={item.flaw.id}
   650→                          flaw={item.flaw}
   651→                          rank={index + 1}
   652→                          products={item.products}
   653→                          treatments={item.treatments}
   654→                          onViewTreatment={(treatment) => {
   655→                            setActiveSubTab('treatments');
   656→                            setExpandedId(treatment.ref_id);
   657→                          }}
   658→                        />
   659→                      ))}
   660→                    </div>
   661→                  </section>
   662→                )}
   663→
   664→                {/* Corrective Products */}
   665→                {flawProducts.length > 0 && (
   666→                  <section>
   667→                    <SectionHeader title="Recommended Products">
   668→                      <span className="px-3 py-1.5 bg-cyan-500/20 border border-cyan-500/30 text-cyan-400 text-[10px] font-black uppercase tracking-wider rounded-lg">
   669→                        {flawProducts.length} Corrective
   670→                      </span>
   671→                    </SectionHeader>
   672→                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
   673→                      {flawProducts.slice(0, 4).map((rec, index) => (
   674→                        <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />
   675→                      ))}
   676→                    </div>
   677→                  </section>
   678→                )}
   679→
   680→                {/* Maintenance Products */}
   681→                {idealProducts.length > 0 && (
   682→                  <section>
   683→                    <SectionHeader title="Protect Your Strengths">
   684→                      <span className="px-3 py-1.5 bg-green-500/20 border border-green-500/30 text-green-400 text-[10px] font-black uppercase tracking-wider rounded-lg">
   685→                        Maintenance
   686→                      </span>
   687→                    </SectionHeader>
   688→                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
   689→                      {idealProducts.slice(0, 2).map((rec) => (
   690→                        <ProductCard key={rec.product.id} recommendation={rec} />
   691→                      ))}
   692→                    </div>
   693→                  </section>
   694→                )}
   695→              </motion.div>
   696→            )}
   697→
   698→            {/* TREATMENTS TAB */}
   699→            {activeSubTab === 'treatments' && (
   700→              <motion.div
   701→                key="treatments"
   702→                initial={{ opacity: 0, x: -20 }}
   703→                animate={{ opacity: 1, x: 0 }}
   704→                exit={{ opacity: 0, x: 20 }}
   705→                className="space-y-8"
   706→              >
   707→                {/* Treatment Timeline */}
   708→                {recommendations.length > 0 && (
   709→                  <section>
   710→                    <SectionHeader title="Treatment Timeline" />
   711→                    <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />
   712→                  </section>
   713→                )}
   714→
   715→                {/* Treatment Conflict Warnings */}
   716→                {treatmentConflicts.length > 0 && (
   717→                  <TreatmentConflictList
   718→                    conflicts={treatmentConflicts}
   719→                    onDismiss={handleDismissConflict}
   720→                    onDismissAll={handleDismissAllConflicts}
   721→                  />
   722→                )}
   723→
   724→                {/* Phase Filter */}
   725→                <section>
   726→                  <SectionHeader title="Treatment Options" />
   727→                  <PhaseFilter
   728→                    selectedPhase={selectedPhase}
   729→                    onSelect={setSelectedPhase}
   730→                    counts={phaseCounts}
   731→                  />
   732→                </section>
   733→
   734→                {/* Recommendations List */}
   735→                {hasRecommendations ? (
   736→                  <motion.div className="space-y-4" layout>
   737→                    <AnimatePresence mode="popLayout">
   738→                      {filteredRecommendations.map((rec, index) => (
   739→                        <motion.div
   740→                          key={rec.ref_id}
   741→                          layout
   742→                          initial={{ opacity: 0, y: 20 }}
   743→                          animate={{ opacity: 1, y: 0 }}
   744→                          exit={{ opacity: 0, y: -20 }}
   745→                          transition={{ duration: 0.2, delay: index * 0.05 }}
   746→                        >
   747→                          <EnhancedRecommendationCard
   748→                            recommendation={rec}
   749→                            rank={index + 1}
   750→                            isExpanded={expandedId === rec.ref_id}
   751→                            onToggle={() => setExpandedId(
   752→                              expandedId === rec.ref_id ? null : rec.ref_id
   753→                            )}
   754→                            onMarkComplete={handleMarkComplete}
   755→                            onRemove={handleRemove}
   756→                            isCompleted={completedIds.has(rec.ref_id)}
   757→                            gender={gender}
   758→                            ethnicity={ethnicity}
   759→                          />
   760→                        </motion.div>
   761→                      ))}
   762→                    </AnimatePresence>
   763→                  </motion.div>
   764→                ) : (
   765→                  <div className="rounded-2xl bg-neutral-900/40 border border-white/5 p-10 text-center">
   766→                    <div className="w-16 h-16 rounded-2xl bg-neutral-900 border border-white/10 flex items-center justify-center mx-auto mb-5">
   767→                      <Sparkles size={28} className="text-neutral-600" />
   768→                    </div>
   769→                    <h3 className="text-lg font-black uppercase tracking-wider text-white mb-2">No Recommendations Yet</h3>
   770→                    <p className="text-[10px] font-bold uppercase tracking-wider text-neutral-600">
   771→                      Complete a facial analysis to get personalized recommendations
   772→                    </p>
   773→                  </div>
   774→                )}
   775→              </motion.div>
   776→            )}
   777→          </AnimatePresence>
   778→        </div>
   779→
   780→        {/* Simplified Sidebar */}
   781→        <div className="space-y-5">
   782→          {/* Unified Pricing Summary - Always visible */}
   783→          <UnifiedPricingSummary
   784→            dailyStackCost={unifiedPricing.stackCost}
   785→            productCost={unifiedPricing.productCost}
   786→            totalProducts={unifiedPricing.totalProducts}
   787→            totalSupplements={unifiedPricing.totalSupplements}
   788→          />
   789→
   790→          {/* Medical Prescription Card (Dental) */}
   791→          {vision?.teeth && (
   792→            <MedicalPrescriptionCard vision={vision} isUnlocked={isUnlocked} />
   793→          )}
   794→
   795→          {/* Progress Comparison Card */}
   796→          <ProgressComparisonCard
   797→            currentAnalysis={{
   798→              date: new Date().toISOString(),
   799→              overallScore: numericOverallScore,
   800→              bodyFatPercent,
   801→              frontPhotoUrl: frontPhoto || undefined,
   802→            }}
   803→            previousAnalysis={previousAnalysis}
   804→            onUploadNewPhoto={handleProgressPhotoUpload}
   805→          />
   806→
   807→
   808→
   809→          {/* Upgrade CTA or Premium Badge */}
   810→          {hasPaidPlan ? (
   811→            <motion.div
   812→              className="rounded-2xl bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 p-4"
   813→              initial={{ opacity: 0, y: 20 }}
   814→              animate={{ opacity: 1, y: 0 }}
   815→            >
   816→              <div className="flex items-center gap-3">
   817→                <div className="w-8 h-8 rounded-lg bg-green-500/20 border border-green-500/30 flex items-center justify-center">
   818→                  <CheckCircle size={14} className="text-green-400" />
   819→                </div>
   820→                <div>
   821→                  <span className="text-[10px] font-black uppercase tracking-wider text-white block">
   822→                    {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active
   823→                  </span>
   824→                  <span className="text-[9px] font-bold uppercase tracking-wider text-neutral-500">
   825→                    Full access enabled
   826→                  </span>
   827→                </div>
   828→              </div>
   829→            </motion.div>
   830→          ) : (
   831→            <motion.div
   832→              className="rounded-2xl bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 p-4"
   833→              initial={{ opacity: 0, y: 20 }}
   834→              animate={{ opacity: 1, y: 0 }}
   835→            >
   836→              <div className="flex items-center gap-3 mb-3">
   837→                <div className="w-8 h-8 rounded-lg bg-cyan-500/20 border border-cyan-500/30 flex items-center justify-center">
   838→                  <Sparkles size={14} className="text-cyan-400" />
   839→                </div>
   840→                <span className="text-[10px] font-black uppercase tracking-wider text-white">Unlock Full Plan</span>
   841→              </div>
   842→              <button
   843→                onClick={() => openPricingModal('plan_sidebar')}
   844→                className="block w-full py-2.5 bg-cyan-500 text-black text-[10px] font-black uppercase tracking-wider rounded-xl text-center hover:bg-cyan-400 transition-colors"
   845→              >
   846→                Upgrade Now
   847→              </button>
   848→            </motion.div>
   849→          )}
   850→        </div>
   851→      </div>
   852→
   853→      {/* Treatment Conflict Modal */}
   854→      <SelectionWarningModal
   855→        isOpen={conflictModal.isOpen}
   856→        onClose={handleConflictCancel}
   857→        conflict={conflictModal.conflict || {
   858→          treatment1Id: '',
   859→          treatment1Name: '',
   860→          treatment2Id: '',
   861→          treatment2Name: '',
   862→          reason: '',
   863→        }}
   864→        onProceed={handleConflictProceed}
   865→        onCancel={handleConflictCancel}
   866→      />
   867→    </TabContent>
   868→  );
   869→}
   870→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
