     1→#!/usr/bin/env python3
     2→"""
     3→looksmax_engine.py - Comprehensive facial analysis algorithm
     4→Implements Frankfort plane standardization, geometric calculations, and Gaussian scoring.
     5→Supports 66+ metrics matching ranges.json specifications.
     6→"""
     7→
     8→import json
     9→import math
    10→import os
    11→import numpy as np
    12→from dataclasses import dataclass
    13→from pathlib import Path
    14→from typing import Dict, List, Tuple, Optional
    15→
    16→# =============================================================================
    17→# LANDMARK MAPPINGS (MediaPipe 478-point indices)
    18→# =============================================================================
    19→
    20→LM_MAP = {
    21→    # === CORE FACIAL STRUCTURE ===
    22→    "trichion": 10,              # Hairline / top of forehead
    23→    "glabella": 168,             # Between eyebrows
    24→    "nasion": 6,                 # Bridge of nose (between eyes)
    25→    "pronasale": 1,              # Tip of nose
    26→    "subnasale": 164,            # Base of nose (columella base)
    27→    "labrale_sup": 0,            # Upper lip vermilion border
    28→    "stomion": 13,               # Meeting point of lips
    29→    "labrale_inf": 17,           # Lower lip vermilion border
    30→    "sublabiale": 18,            # Below lower lip
    31→    "pogonion": 152,             # Most anterior point of chin
    32→    "menton": 152,               # Bottom of chin (same as pogonion in 2D)
    33→    "gnathion": 175,             # Lowest point of mandible
    34→
    35→    # === FRANKFORT PLANE ===
    36→    "porion": 226,               # Superior margin of ear canal
    37→    "orbitale": 33,              # Lowest point of orbital margin
    38→
    39→    # === JAW / MANDIBLE ===
    40→    "gonion": 172,               # Angle of mandible (side view)
    41→    "gonion_l": 172,             # Left jaw angle
    42→    "gonion_r": 397,             # Right jaw angle
    43→    "condyle": 234,              # Condylar process (jaw joint)
    44→
    45→    # === CHEEKBONES / ZYGOMA ===
    46→    "zygion_l": 123,             # Left zygomatic arch (cheekbone)
    47→    "zygion_r": 352,             # Right zygomatic arch
    48→    "cheekbone_l": 123,          # Alias for zygion_l
    49→    "cheekbone_r": 352,          # Alias for zygion_r
    50→
    51→    # === EYES ===
    52→    "pupil_l": 468,              # Left pupil center
    53→    "pupil_r": 473,              # Right pupil center
    54→    "canthus_in_l": 133,         # Left inner canthus (medial)
    55→    "canthus_out_l": 33,         # Left outer canthus (lateral)
    56→    "canthus_in_r": 362,         # Right inner canthus
    57→    "canthus_out_r": 263,        # Right outer canthus
    58→    "endo_canthus_l": 133,       # Alias - endocanthion left
    59→    "endo_canthus_r": 362,       # Alias - endocanthion right
    60→    "exo_canthus_l": 33,         # Alias - exocanthion left
    61→    "exo_canthus_r": 263,        # Alias - exocanthion right
    62→    "upper_eyelid_l": 159,       # Upper eyelid center left
    63→    "lower_eyelid_l": 145,       # Lower eyelid center left
    64→    "upper_eyelid_r": 386,       # Upper eyelid center right
    65→    "lower_eyelid_r": 374,       # Lower eyelid center right
    66→
    67→    # === EYEBROWS ===
    68→    "brow_inner_l": 107,         # Inner brow left
    69→    "brow_outer_l": 70,          # Outer brow left
    70→    "brow_peak_l": 105,          # Brow peak left
    71→    "brow_inner_r": 336,         # Inner brow right
    72→    "brow_outer_r": 300,         # Outer brow right
    73→    "brow_peak_r": 334,          # Brow peak right
    74→    "brow_l": 70,                # Legacy alias
    75→    "brow_r": 300,               # Legacy alias
    76→
    77→    # === NOSE ===
    78→    "ala_l": 102,                # Left alar (nostril wing)
    79→    "ala_r": 331,                # Right alar
    80→    "ala_nasi_l": 102,           # Alias
    81→    "ala_nasi_r": 331,           # Alias
    82→    "nose_bridge": 6,            # Alias for nasion
    83→    "columella": 2,              # Columella (between nostrils)
    84→
    85→    # === MOUTH / LIPS ===
    86→    "cheilion_l": 61,            # Left mouth corner
    87→    "cheilion_r": 291,           # Right mouth corner
    88→    "upper_lip": 0,              # Upper lip center (vermilion)
    89→    "lower_lip": 17,             # Lower lip center
    90→    "cupid_bow_l": 37,           # Left cupid's bow peak
    91→    "cupid_bow_r": 267,          # Right cupid's bow peak
    92→    "cupid_bow_center": 0,       # Center of cupid's bow
    93→    "philtrum_top": 164,         # Top of philtrum (at subnasale)
    94→    "philtrum_bottom": 0,        # Bottom of philtrum (at upper lip)
    95→
    96→    # === TEMPLES / FOREHEAD ===
    97→    "temple_l": 21,              # Left temple
    98→    "temple_r": 251,             # Right temple
    99→    "forehead_top": 10,          # Top of forehead
   100→    "forehead_center": 151,      # Center of forehead
   101→
   102→    # === EARS ===
   103→    "ear_l": 234,                # Left ear (tragus area)
   104→    "ear_r": 454,                # Right ear
   105→    "ear_top_l": 127,            # Top of left ear
   106→    "ear_top_r": 356,            # Top of right ear
   107→    "ear_bottom_l": 234,         # Bottom of left ear (lobule)
   108→    "ear_bottom_r": 454,         # Bottom of right ear
   109→
   110→    # === NECK ===
   111→    "neck_l": 132,               # Left neck point
   112→    "neck_r": 361,               # Right neck point
   113→    "cervical_point": 152,       # Cervical point (approximated)
   114→
   115→    # === CHIN ===
   116→    "chin_tip": 152,             # Tip of chin
   117→    "chin_l": 177,               # Left chin contour
   118→    "chin_r": 401,               # Right chin contour
   119→}
   120→
   121→# Legacy mappings for backward compatibility
   122→LANDMARKS_SIDE = {k: v for k, v in LM_MAP.items() if k in [
   123→    "porion", "orbitale", "glabella", "nasion", "pronasale", "subnasale",
   124→    "labrale_sup", "labrale_inf", "pogonion", "menton", "gnathion", "gonion",
   125→    "condyle", "cheilion_l", "sublabiale", "stomion"
   126→]}
   127→
   128→LANDMARKS_FRONT = {k: v for k, v in LM_MAP.items() if k in [
   129→    "trichion", "menton", "cheekbone_l", "cheekbone_r", "gonion_l", "gonion_r",
   130→    "pupil_l", "pupil_r", "canthus_in_l", "canthus_out_l", "canthus_in_r", "canthus_out_r",
   131→    "ala_nasi_l", "ala_nasi_r", "cheilion_l", "cheilion_r", "glabella", "upper_lip"
   132→]}
   133→
   134→# =============================================================================
   135→# DATA CLASSES
   136→# =============================================================================
   137→
   138→@dataclass
   139→class MockLandmark:
   140→    """Represents a single facial landmark with x, y, z coordinates."""
   141→    x: float
   142→    y: float
   143→    z: float = 0.0
   144→
   145→
   146→@dataclass
   147→class Point2D:
   148→    """2D point for geometric calculations."""
   149→    x: float
   150→    y: float
   151→
   152→    def __sub__(self, other: 'Point2D') -> 'Point2D':
   153→        return Point2D(self.x - other.x, self.y - other.y)
   154→
   155→    def __add__(self, other: 'Point2D') -> 'Point2D':
   156→        return Point2D(self.x + other.x, self.y + other.y)
   157→
   158→
   159→# =============================================================================
   160→# GEOMETRIC UTILITIES
   161→# =============================================================================
   162→
   163→def distance(p1: Point2D, p2: Point2D) -> float:
   164→    """Calculate Euclidean distance between two points."""
   165→    return math.sqrt((p2.x - p1.x) ** 2 + (p2.y - p1.y) ** 2)
   166→
   167→
   168→def angle_between_points(p1: Point2D, vertex: Point2D, p2: Point2D) -> float:
   169→    """
   170→    Calculate angle at vertex formed by p1-vertex-p2.
   171→    Returns angle in degrees.
   172→    """
   173→    v1 = Point2D(p1.x - vertex.x, p1.y - vertex.y)
   174→    v2 = Point2D(p2.x - vertex.x, p2.y - vertex.y)
   175→
   176→    dot = v1.x * v2.x + v1.y * v2.y
   177→    mag1 = math.sqrt(v1.x ** 2 + v1.y ** 2)
   178→    mag2 = math.sqrt(v2.x ** 2 + v2.y ** 2)
   179→
   180→    if mag1 == 0 or mag2 == 0:
   181→        return 0.0
   182→
   183→    cos_angle = max(-1.0, min(1.0, dot / (mag1 * mag2)))
   184→    return math.degrees(math.acos(cos_angle))
   185→
   186→
   187→def angle_to_horizontal(p1: Point2D, p2: Point2D) -> float:
   188→    """
   189→    Calculate angle of line p1->p2 relative to horizontal.
   190→    Returns angle in degrees (positive = upward tilt).
   191→    """
   192→    dx = p2.x - p1.x
   193→    dy = p2.y - p1.y
   194→
   195→    if dx == 0:
   196→        return 90.0 if dy > 0 else -90.0
   197→
   198→    return math.degrees(math.atan2(dy, dx))
   199→
   200→
   201→def rotate_point(point: Point2D, center: Point2D, angle_rad: float) -> Point2D:
   202→    """Rotate a point around a center by angle (radians)."""
   203→    cos_a = math.cos(angle_rad)
   204→    sin_a = math.sin(angle_rad)
   205→
   206→    # Translate to origin
   207→    px = point.x - center.x
   208→    py = point.y - center.y
   209→
   210→    # Rotate
   211→    new_x = px * cos_a - py * sin_a
   212→    new_y = px * sin_a + py * cos_a
   213→
   214→    # Translate back
   215→    return Point2D(new_x + center.x, new_y + center.y)
   216→
   217→
   218→# =============================================================================
   219→# FRANKFORT PLANE STANDARDIZATION
   220→# =============================================================================
   221→
   222→def apply_frankfort_correction(landmarks: List[MockLandmark]) -> Dict[str, Point2D]:
   223→    """
   224→    Apply Frankfort Plane correction to side profile landmarks.
   225→    """
   226→    porion_idx = LANDMARKS_SIDE["porion"]
   227→    orbitale_idx = LANDMARKS_SIDE["orbitale"]
   228→
   229→    porion = Point2D(landmarks[porion_idx].x, landmarks[porion_idx].y)
   230→    orbitale = Point2D(landmarks[orbitale_idx].x, landmarks[orbitale_idx].y)
   231→
   232→    current_angle = angle_to_horizontal(porion, orbitale)
   233→    rotation_angle = -math.radians(current_angle)
   234→
   235→    corrected = {}
   236→    for name, idx in LANDMARKS_SIDE.items():
   237→        original = Point2D(landmarks[idx].x, landmarks[idx].y)
   238→        corrected[name] = rotate_point(original, porion, rotation_angle)
   239→
   240→    return corrected
   241→
   242→
   243→def get_front_landmarks(landmarks: List[MockLandmark]) -> Dict[str, Point2D]:
   244→    """Extract front profile landmarks as Point2D objects."""
   245→    result = {}
   246→    for name, idx in LANDMARKS_FRONT.items():
   247→        result[name] = Point2D(landmarks[idx].x, landmarks[idx].y)
   248→    return result
   249→
   250→
   251→# =============================================================================
   252→# GAUSSIAN SCORING SYSTEM
   253→# =============================================================================
   254→
   255→def calculate_score(value: float, min_range: float, max_range: float) -> float:
   256→    """
   257→    Calculate a score from 0-10 using Gaussian decay.
   258→    """
   259→    if min_range <= value <= max_range:
   260→        return 10.0
   261→
   262→    if value < min_range:
   263→        deviation = min_range - value
   264→        target = min_range
   265→    else:
   266→        deviation = value - max_range
   267→        target = max_range
   268→
   269→    if target == 0:
   270→        target = 1.0
   271→
   272→    sigma = abs(target) * 0.1
   273→    if sigma == 0:
   274→        sigma = 1.0
   275→
   276→    score = 10.0 * math.exp(-0.5 * (deviation / sigma) ** 2)
   277→    return max(0.0, min(10.0, score))
   278→
   279→
   280→def score_metrics(metrics: Dict[str, float]) -> Dict[str, Tuple[float, float]]:
   281→    """Score all metrics and return (value, score) tuples."""
   282→    results = {}
   283→    for name, value in metrics.items():
   284→        results[name] = (value, None)
   285→    return results
   286→
   287→
   288→# =============================================================================
   289→# RANGES LOADER
   290→# =============================================================================
   291→
   292→def load_ranges(filepath: str = None) -> dict:
   293→    """Load scoring ranges from ranges.json file."""
   294→    if filepath is None:
   295→        script_dir = Path(__file__).parent
   296→        filepath = script_dir / "ranges.json"
   297→
   298→    with open(filepath, 'r') as f:
   299→        return json.load(f)
   300→
   301→
   302→def get_ranges_for_profile(ranges: dict, gender: str = "male", ethnicity: str = "caucasian") -> dict:
   303→    """Get front and side ranges for a specific gender/ethnicity combination."""
   304→    return ranges.get(gender, {}).get(ethnicity, {"front": {}, "side": {}})
   305→
   306→
   307→# =============================================================================
   308→# FACIAL CALCULATOR CLASS - COMPREHENSIVE 66+ METRICS
   309→# =============================================================================
   310→
   311→class FacialCalculator:
   312→    """
   313→    Unified facial metrics calculator that computes all 66+ facial measurements.
   314→    Uses real-world mm scaling based on interpupillary distance (IPD).
   315→    """
   316→
   317→    # Class-level IPD constant (can be calibrated)
   318→    REAL_WORLD_IPD_MM = 63.0  # Standard male IPD
   319→
   320→    def __init__(self, landmarks: List[MockLandmark]):
   321→        self.landmarks = landmarks
   322→        self.std_landmarks = self._apply_frankfort_correction()
   323→
   324→        # Calculate mm_per_unit scaling factor
   325→        pupil_l = self.get_pt("pupil_l")
   326→        pupil_r = self.get_pt("pupil_r")
   327→        eye_dist_units = np.linalg.norm(pupil_l - pupil_r)
   328→
   329→        self.mm_per_unit = self.REAL_WORLD_IPD_MM / eye_dist_units if eye_dist_units > 0 else 1.0
   330→
   331→    @classmethod
   332→    def calibrate(cls, metric_name: str, known_value: float) -> None:
   333→        """
   334→        Calibrate the IPD constant based on a known measurement.
   335→
   336→        Args:
   337→            metric_name: Currently only 'IPD' is supported
   338→            known_value: Known real-world value in mm
   339→
   340→        Example:
   341→            FacialCalculator.calibrate('IPD', 65.0)  # Set IPD to 65mm
   342→        """
   343→        if metric_name.upper() == 'IPD':
   344→            cls.REAL_WORLD_IPD_MM = known_value
   345→            print(f"[Calibration] IPD set to {known_value}mm")
   346→        else:
   347→            print(f"[Calibration] Unknown metric: {metric_name}")
   348→
   349→    def get_pt(self, name: str, standardized: bool = False) -> np.ndarray:
   350→        """Get a landmark point as numpy array [x, y]."""
   351→        idx = LM_MAP[name]
   352→        pts = self.std_landmarks if standardized else self.landmarks
   353→        pt = pts[idx]
   354→        if isinstance(pt, dict):
   355→            return np.array([pt['x'], pt['y']])
   356→        return np.array([pt.x, pt.y])
   357→
   358→    def dist(self, p1_name: str, p2_name: str, standardized: bool = False) -> float:
   359→        """Calculate distance in normalized units."""
   360→        return np.linalg.norm(self.get_pt(p1_name, standardized) - self.get_pt(p2_name, standardized))
   361→
   362→    def dist_mm(self, p1_name: str, p2_name: str, standardized: bool = False) -> float:
   363→        """Calculate distance in real-world millimeters."""
   364→        return self.dist(p1_name, p2_name, standardized) * self.mm_per_unit
   365→
   366→    def angle_at_vertex(self, p1_name: str, vertex_name: str, p2_name: str, standardized: bool = False) -> float:
   367→        """Calculate angle at vertex formed by p1-vertex-p2 in degrees."""
   368→        p1 = self.get_pt(p1_name, standardized)
   369→        vertex = self.get_pt(vertex_name, standardized)
   370→        p2 = self.get_pt(p2_name, standardized)
   371→
   372→        v1 = p1 - vertex
   373→        v2 = p2 - vertex
   374→
   375→        dot = np.dot(v1, v2)
   376→        mag1 = np.linalg.norm(v1)
   377→        mag2 = np.linalg.norm(v2)
   378→
   379→        if mag1 == 0 or mag2 == 0:
   380→            return 0.0
   381→
   382→        cos_angle = np.clip(dot / (mag1 * mag2), -1.0, 1.0)
   383→        return np.degrees(np.arccos(cos_angle))
   384→
   385→    def angle_to_horizontal(self, p1_name: str, p2_name: str, standardized: bool = False) -> float:
   386→        """Calculate angle of line p1->p2 relative to horizontal in degrees."""
   387→        p1 = self.get_pt(p1_name, standardized)
   388→        p2 = self.get_pt(p2_name, standardized)
   389→
   390→        dx = p2[0] - p1[0]
   391→        dy = p2[1] - p1[1]
   392→
   393→        if dx == 0:
   394→            return 90.0 if dy > 0 else -90.0
   395→
   396→        return np.degrees(np.arctan2(dy, dx))
   397→
   398→    def perpendicular_distance(self, point_name: str, line_p1_name: str, line_p2_name: str,
   399→                                standardized: bool = False) -> float:
   400→        """
   401→        Calculate perpendicular distance from a point to a line defined by two points.
   402→        Returns distance in normalized units (multiply by mm_per_unit for mm).
   403→        Positive = point is to the right of line direction, Negative = left.
   404→        """
   405→        point = self.get_pt(point_name, standardized)
   406→        p1 = self.get_pt(line_p1_name, standardized)
   407→        p2 = self.get_pt(line_p2_name, standardized)
   408→
   409→        # Line vector
   410→        line_vec = p2 - p1
   411→        line_len = np.linalg.norm(line_vec)
   412→
   413→        if line_len == 0:
   414→            return 0.0
   415→
   416→        # Vector from p1 to point
   417→        point_vec = point - p1
   418→
   419→        # Cross product gives signed area of parallelogram
   420→        # In 2D: cross = v1.x * v2.y - v1.y * v2.x
   421→        cross = line_vec[0] * point_vec[1] - line_vec[1] * point_vec[0]
   422→
   423→        # Perpendicular distance = cross / line_length
   424→        return cross / line_len
   425→
   426→    def horizontal_distance(self, p1_name: str, p2_name: str, standardized: bool = False) -> float:
   427→        """Calculate horizontal (X-axis) distance between two points. Positive = p2 is right of p1."""
   428→        p1 = self.get_pt(p1_name, standardized)
   429→        p2 = self.get_pt(p2_name, standardized)
   430→        return p2[0] - p1[0]
   431→
   432→    def vertical_distance(self, p1_name: str, p2_name: str, standardized: bool = False) -> float:
   433→        """Calculate vertical (Y-axis) distance between two points. Positive = p2 is below p1."""
   434→        p1 = self.get_pt(p1_name, standardized)
   435→        p2 = self.get_pt(p2_name, standardized)
   436→        return p2[1] - p1[1]
   437→
   438→    def _apply_frankfort_correction(self) -> List[MockLandmark]:
   439→        """Apply Frankfort Plane correction to all landmarks."""
   440→        porion_idx = LM_MAP["porion"]
   441→        orbitale_idx = LM_MAP["orbitale"]
   442→
   443→        porion = np.array([self.landmarks[porion_idx].x, self.landmarks[porion_idx].y])
   444→        orbitale = np.array([self.landmarks[orbitale_idx].x, self.landmarks[orbitale_idx].y])
   445→
   446→        dx = orbitale[0] - porion[0]
   447→        dy = orbitale[1] - porion[1]
   448→        current_angle = np.arctan2(dy, dx)
   449→
   450→        cos_a = np.cos(-current_angle)
   451→        sin_a = np.sin(-current_angle)
   452→
   453→        corrected = []
   454→        for lm in self.landmarks:
   455→            px = lm.x - porion[0]
   456→            py = lm.y - porion[1]
   457→
   458→            new_x = px * cos_a - py * sin_a + porion[0]
   459→            new_y = px * sin_a + py * cos_a + porion[1]
   460→
   461→            corrected.append(MockLandmark(new_x, new_y, lm.z))
   462→
   463→        return corrected
   464→
   465→    def calculate_all(self) -> Dict[str, Dict[str, float]]:
   466→        """Calculate all front and side profile metrics."""
   467→        return {
   468→            'front': self.calculate_front_metrics(),
   469→            'side': self.calculate_side_metrics()
   470→        }
   471→
   472→    # =========================================================================
   473→    # FRONT PROFILE METRICS (37 total)
   474→    # =========================================================================
   475→
   476→    def calculate_front_metrics(self) -> Dict[str, float]:
   477→        """Calculate all front profile metrics matching ranges.json keys."""
   478→        r = {}
   479→
   480→        # Get key measurements for ratios
   481→        face_width = self.dist("cheekbone_l", "cheekbone_r")
   482→        jaw_width = self.dist("gonion_l", "gonion_r")
   483→
   484→        trichion = self.get_pt("trichion")
   485→        glabella = self.get_pt("glabella")
   486→        nasion = self.get_pt("nasion")
   487→        subnasale = self.get_pt("subnasale")
   488→        upper_lip = self.get_pt("upper_lip")
   489→        menton = self.get_pt("menton")
   490→
   491→        # Face height measurements
   492→        face_height_total = np.linalg.norm(trichion - menton)
   493→        upper_third = np.linalg.norm(trichion - glabella)
   494→        middle_third = np.linalg.norm(glabella - subnasale)
   495→        lower_third = np.linalg.norm(subnasale - menton)
   496→
   497→        # =====================================================================
   498→        # 1. Face Width to Height Ratio (FWHR)
   499→        # =====================================================================
   500→        midface_height = np.linalg.norm(glabella - upper_lip)
   501→        if midface_height > 0:
   502→            r["Face Width to Height Ratio"] = face_width / midface_height
   503→
   504→        # =====================================================================
   505→        # 2. Cheekbone Height
   506→        # =====================================================================
   507→        # (Mean Y of Zygions - Mean Y of Gonions) / (Y of Trichion - Y of Menton) * 100
   508→        zygion_l = self.get_pt("zygion_l")
   509→        zygion_r = self.get_pt("zygion_r")
   510→        gonion_l = self.get_pt("gonion_l")
   511→        gonion_r = self.get_pt("gonion_r")
   512→
   513→        mean_zygion_y = (zygion_l[1] + zygion_r[1]) / 2
   514→        mean_gonion_y = (gonion_l[1] + gonion_r[1]) / 2
   515→
   516→        if face_height_total > 0:
   517→            cheekbone_height = ((mean_gonion_y - mean_zygion_y) / face_height_total) * 100
   518→            r["Cheekbone Height"] = cheekbone_height
   519→
   520→        # =====================================================================
   521→        # 3. Jaw Slope
   522→        # =====================================================================
   523→        # Angle of line from gonion to menton relative to horizontal
   524→        jaw_slope_l = abs(self.angle_to_horizontal("gonion_l", "menton"))
   525→        jaw_slope_r = abs(self.angle_to_horizontal("gonion_r", "menton"))
   526→        r["Jaw Slope"] = (jaw_slope_l + jaw_slope_r) / 2 + 90  # Convert to 90-180 scale
   527→
   528→        # =====================================================================
   529→        # 4. Total Facial Width to Height Ratio
   530→        # =====================================================================
   531→        if face_height_total > 0:
   532→            r["Total Facial Width to Height Ratio"] = face_width / face_height_total
   533→
   534→        # =====================================================================
   535→        # 5. Nose Bridge to Nose Width
   536→        # =====================================================================
   537→        # Distance between inner canthi / nose width (ala to ala)
   538→        inter_canthal = self.dist("endo_canthus_l", "endo_canthus_r")
   539→        nose_width = self.dist("ala_l", "ala_r")
   540→        if nose_width > 0:
   541→            r["Nose Bridge to Nose Width"] = inter_canthal / nose_width
   542→
   543→        # =====================================================================
   544→        # 6. Mouth Width to Nose Width Ratio
   545→        # =====================================================================
   546→        mouth_width = self.dist("cheilion_l", "cheilion_r")
   547→        if nose_width > 0:
   548→            r["Mouth Width to Nose Width Ratio"] = mouth_width / nose_width
   549→
   550→        # =====================================================================
   551→        # 7. Midface Ratio
   552→        # =====================================================================
   553→        pupil_l = self.get_pt("pupil_l")
   554→        pupil_r = self.get_pt("pupil_r")
   555→        pupil_center = (pupil_l + pupil_r) / 2
   556→
   557→        cheilion_l_pt = self.get_pt("cheilion_l")
   558→        cheilion_r_pt = self.get_pt("cheilion_r")
   559→        mouth_center = (cheilion_l_pt + cheilion_r_pt) / 2
   560→
   561→        midface_dist = np.linalg.norm(pupil_center - mouth_center)
   562→        if face_width > 0:
   563→            r["Midface Ratio"] = midface_dist / face_width
   564→
   565→        # =====================================================================
   566→        # 8. Lower Third Proportion
   567→        # =====================================================================
   568→        if face_height_total > 0:
   569→            r["Lower Third Proportion"] = (lower_third / face_height_total) * 100
   570→
   571→        # =====================================================================
   572→        # 9. Lateral Canthal Tilt
   573→        # =====================================================================
   574→        canthus_in_l = self.get_pt("canthus_in_l")
   575→        canthus_out_l = self.get_pt("canthus_out_l")
   576→        canthus_in_r = self.get_pt("canthus_in_r")
   577→        canthus_out_r = self.get_pt("canthus_out_r")
   578→
   579→        left_dx = abs(canthus_out_l[0] - canthus_in_l[0])
   580→        left_dy = canthus_in_l[1] - canthus_out_l[1]
   581→        left_tilt = np.degrees(np.arctan2(left_dy, left_dx))
   582→
   583→        right_dx = abs(canthus_out_r[0] - canthus_in_r[0])
   584→        right_dy = canthus_in_r[1] - canthus_out_r[1]
   585→        right_tilt = np.degrees(np.arctan2(right_dy, right_dx))
   586→
   587→        r["Lateral Canthal Tilt"] = (left_tilt + right_tilt) / 2
   588→
   589→        # =====================================================================
   590→        # 10. Ipsilateral Alar Angle
   591→        # =====================================================================
   592→        # Angle at nose tip between ala points
   593→        r["Ipsilateral Alar Angle"] = self.angle_at_vertex("ala_l", "pronasale", "ala_r")
   594→
   595→        # =====================================================================
   596→        # 11. Jaw Frontal Angle
   597→        # =====================================================================
   598→        # Angle between Gonion_L -> Menton -> Gonion_R
   599→        r["Jaw Frontal Angle"] = self.angle_at_vertex("gonion_l", "menton", "gonion_r")
   600→
   601→        # =====================================================================
   602→        # 12. Chin to Philtrum Ratio
   603→        # =====================================================================
   604→        # Distance(Labrale_Inf, Menton) / Distance(Subnasale, Labrale_Sup)
   605→        chin_height = self.dist("labrale_inf", "menton")
   606→        philtrum_height = self.dist("subnasale", "labrale_sup")
   607→        if philtrum_height > 0:
   608→            r["Chin to Philtrum Ratio"] = chin_height / philtrum_height
   609→
   610→        # =====================================================================
   611→        # 13. Eye Aspect Ratio
   612→        # =====================================================================
   613→        # Eye width / eye height (average of both eyes)
   614→        eye_width_l = self.dist("canthus_in_l", "canthus_out_l")
   615→        eye_height_l = self.dist("upper_eyelid_l", "lower_eyelid_l")
   616→        eye_width_r = self.dist("canthus_in_r", "canthus_out_r")
   617→        eye_height_r = self.dist("upper_eyelid_r", "lower_eyelid_r")
   618→
   619→        if eye_height_l > 0 and eye_height_r > 0:
   620→            ear_l = eye_width_l / eye_height_l
   621→            ear_r = eye_width_r / eye_height_r
   622→            r["Eye Aspect Ratio"] = (ear_l + ear_r) / 2
   623→
   624→        # =====================================================================
   625→        # 14. Bitemporal Width
   626→        # =====================================================================
   627→        # Distance(Temple L, R) / Distance(Zygion L, R) * 100
   628→        temple_width = self.dist("temple_l", "temple_r")
   629→        if face_width > 0:
   630→            r["Bitemporal Width"] = (temple_width / face_width) * 100
   631→
   632→        # =====================================================================
   633→        # 15. Eyebrow Low Setedness
   634→        # =====================================================================
   635→        # Vertical distance from brow to eye relative to eye height
   636→        brow_l = self.get_pt("brow_peak_l")
   637→        brow_r = self.get_pt("brow_peak_r")
   638→        upper_lid_l = self.get_pt("upper_eyelid_l")
   639→        upper_lid_r = self.get_pt("upper_eyelid_r")
   640→
   641→        brow_eye_dist_l = upper_lid_l[1] - brow_l[1]  # Positive = brow above eye
   642→        brow_eye_dist_r = upper_lid_r[1] - brow_r[1]
   643→
   644→        avg_eye_height = (eye_height_l + eye_height_r) / 2 if (eye_height_l + eye_height_r) > 0 else 1
   645→        r["Eyebrow Low Setedness"] = ((brow_eye_dist_l + brow_eye_dist_r) / 2) / avg_eye_height
   646→
   647→        # =====================================================================
   648→        # 16. Eye Separation Ratio
   649→        # =====================================================================
   650→        # Inter-canthal distance / face width * 100
   651→        if face_width > 0:
   652→            r["Eye Separation Ratio"] = (inter_canthal / face_width) * 100
   653→
   654→        # =====================================================================
   655→        # 17. Neck Width
   656→        # =====================================================================
   657→        # Distance(Neck L, R) / Distance(Zygion L, R) * 100
   658→        neck_width = self.dist("neck_l", "neck_r")
   659→        if face_width > 0:
   660→            r["Neck Width"] = (neck_width / face_width) * 100
   661→
   662→        # =====================================================================
   663→        # 18. Brow Length to Face Width Ratio
   664→        # =====================================================================
   665→        brow_inner_l = self.get_pt("brow_inner_l")
   666→        brow_outer_l = self.get_pt("brow_outer_l")
   667→        brow_inner_r = self.get_pt("brow_inner_r")
   668→        brow_outer_r = self.get_pt("brow_outer_r")
   669→
   670→        brow_length_l = np.linalg.norm(brow_outer_l - brow_inner_l)
   671→        brow_length_r = np.linalg.norm(brow_outer_r - brow_inner_r)
   672→        avg_brow_length = (brow_length_l + brow_length_r) / 2
   673→
   674→        if face_width > 0:
   675→            r["Brow Length to Face Width Ratio"] = avg_brow_length / face_width
   676→
   677→        # =====================================================================
   678→        # 19. Mouth Corner Position
   679→        # =====================================================================
   680→        # Vertical offset of mouth corners from lip center
   681→        lip_center = self.get_pt("upper_lip")
   682→        mouth_corner_y = (cheilion_l_pt[1] + cheilion_r_pt[1]) / 2
   683→        r["Mouth Corner Position"] = (mouth_corner_y - lip_center[1]) * self.mm_per_unit
   684→
   685→        # =====================================================================
   686→        # 20. Cupid's Bow Depth
   687→        # =====================================================================
   688→        # Depth of cupid's bow relative to lip line
   689→        cupid_l = self.get_pt("cupid_bow_l")
   690→        cupid_r = self.get_pt("cupid_bow_r")
   691→        cupid_center = self.get_pt("cupid_bow_center")
   692→
   693→        cupid_peaks_y = (cupid_l[1] + cupid_r[1]) / 2
   694→        cupid_depth = (cupid_center[1] - cupid_peaks_y) * self.mm_per_unit
   695→        r["Cupid's Bow Depth"] = cupid_depth
   696→
   697→        # =====================================================================
   698→        # 21. Bigonial Width
   699→        # =====================================================================
   700→        # Jaw width as percentage of face width
   701→        if face_width > 0:
   702→            r["Bigonial Width"] = (jaw_width / face_width) * 100
   703→
   704→        # =====================================================================
   705→        # 22. Lower Lip to Upper Lip Ratio
   706→        # =====================================================================
   707→        upper_lip_height = self.dist("labrale_sup", "stomion")
   708→        lower_lip_height = self.dist("stomion", "labrale_inf")
   709→        if upper_lip_height > 0:
   710→            r["Lower Lip to Upper Lip Ratio"] = lower_lip_height / upper_lip_height
   711→
   712→        # =====================================================================
   713→        # 23. Lower Third
   714→        # =====================================================================
   715→        if face_height_total > 0:
   716→            r["Lower Third"] = (lower_third / face_height_total) * 100
   717→
   718→        # =====================================================================
   719→        # 24. Interpupillary-Mouth Width Ratio
   720→        # =====================================================================
   721→        ipd = self.dist("pupil_l", "pupil_r")
   722→        if mouth_width > 0:
   723→            r["Interpupillary-Mouth Width Ratio"] = ipd / mouth_width
   724→
   725→        # =====================================================================
   726→        # 25. Top Third
   727→        # =====================================================================
   728→        if face_height_total > 0:
   729→            r["Top Third"] = (upper_third / face_height_total) * 100
   730→
   731→        # =====================================================================
   732→        # 26. One Eye Apart Test
   733→        # =====================================================================
   734→        # Inter-canthal distance should equal eye width
   735→        avg_eye_width = (eye_width_l + eye_width_r) / 2
   736→        if avg_eye_width > 0:
   737→            r["One Eye Apart Test"] = inter_canthal / avg_eye_width
   738→
   739→        # =====================================================================
   740→        # 27. Deviation of IAA & JFA
   741→        # =====================================================================
   742→        # Difference between Ipsilateral Alar Angle and Jaw Frontal Angle
   743→        iaa = r.get("Ipsilateral Alar Angle", 90)
   744→        jfa = r.get("Jaw Frontal Angle", 90)
   745→        r["Deviation of IAA & JFA"] = iaa - jfa
   746→
   747→        # =====================================================================
   748→        # 28. Middle Third
   749→        # =====================================================================
   750→        if face_height_total > 0:
   751→            r["Middle Third"] = (middle_third / face_height_total) * 100
   752→
   753→        # =====================================================================
   754→        # 29. Eyebrow Tilt
   755→        # =====================================================================
   756→        # Angle of eyebrow from inner to outer
   757→        brow_tilt_l = self.angle_to_horizontal("brow_inner_l", "brow_outer_l")
   758→        brow_tilt_r = -self.angle_to_horizontal("brow_inner_r", "brow_outer_r")  # Mirror
   759→        r["Eyebrow Tilt"] = (brow_tilt_l + brow_tilt_r) / 2
   760→
   761→        # =====================================================================
   762→        # 30. Intercanthal-Nasal Width Ratio
   763→        # =====================================================================
   764→        if nose_width > 0:
   765→            r["Intercanthal-Nasal Width Ratio"] = inter_canthal / nose_width
   766→
   767→        # =====================================================================
   768→        # 31. Ear Protrusion Angle
   769→        # =====================================================================
   770→        # Angle of ear relative to head (approximated)
   771→        ear_l = self.get_pt("ear_l")
   772→        ear_r = self.get_pt("ear_r")
   773→        cheek_l = self.get_pt("cheekbone_l")
   774→        cheek_r = self.get_pt("cheekbone_r")
   775→
   776→        # Calculate how far ears protrude past cheekbones
   777→        ear_protrusion_l = cheek_l[0] - ear_l[0]  # Positive = ear is more lateral
   778→        ear_protrusion_r = ear_r[0] - cheek_r[0]
   779→
   780→        # Convert to angle approximation
   781→        head_width = self.dist("ear_l", "ear_r")
   782→        if head_width > 0:
   783→            avg_protrusion = (ear_protrusion_l + ear_protrusion_r) / 2
   784→            r["Ear Protrusion Angle"] = np.degrees(np.arctan2(avg_protrusion, head_width / 10))
   785→
   786→        # =====================================================================
   787→        # 32. Ear Protrusion Ratio
   788→        # =====================================================================
   789→        if face_width > 0:
   790→            r["Ear Protrusion Ratio"] = ((ear_protrusion_l + ear_protrusion_r) / 2 / face_width) * 100
   791→
   792→        # =====================================================================
   793→        # 33. Nose Tip Position (Front - horizontal offset)
   794→        # =====================================================================
   795→        pronasale = self.get_pt("pronasale")
   796→        nose_center_x = (self.get_pt("ala_l")[0] + self.get_pt("ala_r")[0]) / 2
   797→        r["Nose Tip Position"] = (pronasale[0] - nose_center_x) * self.mm_per_unit
   798→
   799→        return r
   800→
   801→    # =========================================================================
   802→    # SIDE PROFILE METRICS (33 total)
   803→    # =========================================================================
   804→
   805→    def calculate_side_metrics(self) -> Dict[str, float]:
   806→        """Calculate all side profile metrics matching ranges.json keys."""
   807→        r = {}
   808→
   809→        # Get key points (all Frankfort-corrected)
   810→        porion = self.get_pt("porion", standardized=True)
   811→        orbitale = self.get_pt("orbitale", standardized=True)
   812→        glabella = self.get_pt("glabella", standardized=True)
   813→        nasion = self.get_pt("nasion", standardized=True)
   814→        pronasale = self.get_pt("pronasale", standardized=True)
   815→        subnasale = self.get_pt("subnasale", standardized=True)
   816→        labrale_sup = self.get_pt("labrale_sup", standardized=True)
   817→        labrale_inf = self.get_pt("labrale_inf", standardized=True)
   818→        sublabiale = self.get_pt("sublabiale", standardized=True)
   819→        pogonion = self.get_pt("pogonion", standardized=True)
   820→        menton = self.get_pt("menton", standardized=True)
   821→        gnathion = self.get_pt("gnathion", standardized=True)
   822→        gonion = self.get_pt("gonion", standardized=True)
   823→        condyle = self.get_pt("condyle", standardized=True)
   824→        trichion = self.get_pt("trichion", standardized=True)
   825→
   826→        # Face dimensions
   827→        face_height = np.linalg.norm(trichion - menton)
   828→        face_depth = abs(pogonion[0] - porion[0])
   829→
   830→        # =====================================================================
   831→        # 1. Recession Relative to Frankfort Plane
   832→        # =====================================================================
   833→        # Horizontal distance from Nasion to Pogonion (Positive = Chin behind Nasion)
   834→        recession = (nasion[0] - pogonion[0]) * self.mm_per_unit
   835→        r["Recession Relative to Frankfort Plane"] = recession
   836→
   837→        # =====================================================================
   838→        # 2. Facial Depth to Height Ratio
   839→        # =====================================================================
   840→        if face_height > 0:
   841→            r["Facial Depth to Height Ratio"] = face_depth / face_height
   842→
   843→        # =====================================================================
   844→        # 3. Interior Midface Projection Angle
   845→        # =====================================================================
   846→        # Angle from Nasion to Subnasale to vertical
   847→        midface_angle = self.angle_at_vertex("nasion", "subnasale", "pogonion", standardized=True)
   848→        r["Interior Midface Projection Angle"] = midface_angle
   849→
   850→        # =====================================================================
   851→        # 4. Mandibular Plane Angle
   852→        # =====================================================================
   853→        r["Mandibular Plane Angle"] = abs(self.angle_to_horizontal("gonion", "menton", standardized=True))
   854→
   855→        # =====================================================================
   856→        # 5. Nasofrontal Angle
   857→        # =====================================================================
   858→        # Angle between Glabella -> Nasion -> Pronasale
   859→        r["Nasofrontal Angle"] = self.angle_at_vertex("glabella", "nasion", "pronasale", standardized=True)
   860→
   861→        # =====================================================================
   862→        # 6. Gonion to Mouth Line
   863→        # =====================================================================
   864→        # Vertical distance from gonion to lip line (mm)
   865→        lip_y = (labrale_sup[1] + labrale_inf[1]) / 2
   866→        gonion_to_mouth = (lip_y - gonion[1]) * self.mm_per_unit
   867→        r["Gonion to Mouth Line"] = gonion_to_mouth
   868→
   869→        # =====================================================================
   870→        # 7. Lower Lip S-Line Position
   871→        # =====================================================================
   872→        # S-Line: Subnasale to Pogonion
   873→        # Distance from Lower Lip to this line
   874→        s_line_dist = self.perpendicular_distance("labrale_inf", "subnasale", "pogonion", standardized=True)
   875→        r["Lower Lip S-Line Position"] = s_line_dist * self.mm_per_unit
   876→
   877→        # =====================================================================
   878→        # 8. Z Angle
   879→        # =====================================================================
   880→        # Angle between Frankfort Plane and line from Pogonion to most protrusive lip
   881→        # Frankfort is horizontal after correction, so measure angle of Pogonion->Labrale_Sup
   882→        z_angle = 90 - abs(self.angle_to_horizontal("pogonion", "labrale_sup", standardized=True))
   883→        r["Z Angle"] = z_angle + 90  # Convert to 0-180 scale
   884→
   885→        # =====================================================================
   886→        # 9. Nasomental Angle
   887→        # =====================================================================
   888→        r["Nasomental Angle"] = self.angle_at_vertex("nasion", "pronasale", "pogonion", standardized=True)
   889→
   890→        # =====================================================================
   891→        # 10. Submental Cervical Angle
   892→        # =====================================================================
   893→        # Angle at menton between chin line and neck line
   894→        cervical = self.get_pt("cervical_point", standardized=True)
   895→        r["Submental Cervical Angle"] = self.angle_at_vertex("pogonion", "menton", "cervical_point", standardized=True)
   896→
   897→        # =====================================================================
   898→        # 11. Nasofacial Angle
   899→        # =====================================================================
   900→        # Angle between nose dorsum and facial plane
   901→        r["Nasofacial Angle"] = self.angle_at_vertex("pronasale", "nasion", "pogonion", standardized=True)
   902→
   903→        # =====================================================================
   904→        # 12. Holdaway H-Line
   905→        # =====================================================================
   906→        # H-Line: Labrale_Sup to Pogonion
   907→        # Perpendicular distance from Nasion to this line (mm)
   908→        h_line_dist = self.perpendicular_distance("nasion", "labrale_sup", "pogonion", standardized=True)
   909→        r["Holdaway H Line"] = h_line_dist * self.mm_per_unit
   910→
   911→        # =====================================================================
   912→        # 13. Mentolabial Angle
   913→        # =====================================================================
   914→        # Angle between Labrale_Inf -> Sublabiale -> Pogonion
   915→        r["Mentolabial Angle"] = self.angle_at_vertex("labrale_inf", "sublabiale", "pogonion", standardized=True)
   916→
   917→        # =====================================================================
   918→        # 14. Anterior Facial Depth
   919→        # =====================================================================
   920→        # Distance from Nasion to Pogonion (mm)
   921→        r["Anterior Facial Depth"] = self.dist_mm("nasion", "pogonion", standardized=True)
   922→
   923→        # =====================================================================
   924→        # 15. Lower Lip E-Line Position
   925→        # =====================================================================
   926→        # E-Line: Pronasale to Pogonion
   927→        e_line_lower = self.perpendicular_distance("labrale_inf", "pronasale", "pogonion", standardized=True)
   928→        r["Lower Lip E-Line Position"] = e_line_lower * self.mm_per_unit
   929→
   930→        # =====================================================================
   931→        # 16. Gonial Angle
   932→        # =====================================================================
   933→        r["Gonial Angle"] = self.angle_at_vertex("condyle", "gonion", "menton", standardized=True)
   934→
   935→        # =====================================================================
   936→        # 17. Lower Lip Burstone Line
   937→        # =====================================================================
   938→        # Burstone Line: Subnasale to Pogonion (same as S-line)
   939→        burstone_lower = self.perpendicular_distance("labrale_inf", "subnasale", "pogonion", standardized=True)
   940→        r["Lower Lip Burstone Line"] = burstone_lower * self.mm_per_unit
   941→
   942→        # =====================================================================
   943→        # 18. Nose Tip Rotation Angle
   944→        # =====================================================================
   945→        # Angle of nose tip relative to nose bridge
   946→        columella = self.get_pt("columella", standardized=True)
   947→        nose_rotation = self.angle_at_vertex("nasion", "pronasale", "subnasale", standardized=True)
   948→        r["Nose Tip Rotation Angle"] = nose_rotation - 90  # Normalize
   949→
   950→        # =====================================================================
   951→        # 19. Ramus to Mandible Ratio
   952→        # =====================================================================
   953→        ramus_length = self.dist("condyle", "gonion", standardized=True)
   954→        mandible_length = self.dist("gonion", "menton", standardized=True)
   955→        if mandible_length > 0:
   956→            r["Ramus to Mandible Ratio"] = ramus_length / mandible_length
   957→
   958→        # =====================================================================
   959→        # 20. Orbital Vector
   960→        # =====================================================================
   961→        # Distance between cheekbone depth and eye depth
   962→        pupil = self.get_pt("pupil_l", standardized=True)
   963→        vector = (orbitale[0] - pupil[0]) * self.mm_per_unit
   964→        r["Orbital Vector"] = vector
   965→
   966→        # =====================================================================
   967→        # 21. Facial Convexity (Glabella)
   968→        # =====================================================================
   969→        # Angle: Glabella -> Subnasale -> Pogonion
   970→        r["Facial Convexity (Glabella)"] = self.angle_at_vertex("glabella", "subnasale", "pogonion", standardized=True)
   971→
   972→        # =====================================================================
   973→        # 22. Browridge Inclination Angle
   974→        # =====================================================================
   975→        # Angle of browridge relative to Frankfort horizontal
   976→        brow = self.get_pt("brow_peak_l", standardized=True)
   977→        browridge_angle = self.angle_to_horizontal("glabella", "brow_peak_l", standardized=True)
   978→        r["Browridge Inclination Angle"] = abs(browridge_angle)
   979→
   980→        # =====================================================================
   981→        # 23. Nasal Tip Angle
   982→        # =====================================================================
   983→        # Angle at pronasale between nasion and subnasale
   984→        r["Nasal Tip Angle"] = self.angle_at_vertex("nasion", "pronasale", "subnasale", standardized=True)
   985→
   986→        # =====================================================================
   987→        # 24. Nasal Projection
   988→        # =====================================================================
   989→        # Ratio of nose projection to nose length
   990→        nose_length = self.dist_mm("nasion", "pronasale", standardized=True)
   991→        nose_projection = abs(pronasale[0] - subnasale[0]) * self.mm_per_unit
   992→        if nose_length > 0:
   993→            r["Nasal Projection"] = nose_projection / nose_length
   994→
   995→        # =====================================================================
   996→        # 25. Frankfort-tip Angle
   997→        # =====================================================================
   998→        # Angle from Frankfort plane to nose tip
   999→        frankfort_tip = abs(self.angle_to_horizontal("orbitale", "pronasale", standardized=True))
  1000→        r["Frankfort-tip Angle"] = frankfort_tip
  1001→
  1002→        # =====================================================================
  1003→        # 26. Nasal W to H Ratio
  1004→        # =====================================================================
  1005→        # Nose width to height ratio (using side profile projection)
  1006→        nose_height = self.dist_mm("nasion", "subnasale", standardized=True)
  1007→        nose_width_mm = self.dist_mm("ala_l", "ala_r")
  1008→        if nose_height > 0:
  1009→            r["Nasal W to H Ratio"] = nose_width_mm / nose_height
  1010→
  1011→        # =====================================================================
  1012→        # 27. Nasolabial Angle
  1013→        # =====================================================================
  1014→        columella_pt = (pronasale + subnasale) / 2
  1015→        v1 = columella_pt - subnasale
  1016→        v2 = labrale_sup - subnasale
  1017→        dot = np.dot(v1, v2)
  1018→        mag1 = np.linalg.norm(v1)
  1019→        mag2 = np.linalg.norm(v2)
  1020→        if mag1 > 0 and mag2 > 0:
  1021→            cos_angle = np.clip(dot / (mag1 * mag2), -1.0, 1.0)
  1022→            r["Nasolabial Angle"] = np.degrees(np.arccos(cos_angle))
  1023→
  1024→        # =====================================================================
  1025→        # 28. Facial Convexity (Nasion)
  1026→        # =====================================================================
  1027→        # Angle: Nasion -> Subnasale -> Pogonion
  1028→        r["Facial Convexity (Nasion)"] = self.angle_at_vertex("nasion", "subnasale", "pogonion", standardized=True)
  1029→
  1030→        # =====================================================================
  1031→        # 29. Total Facial Convexity
  1032→        # =====================================================================
  1033→        # Angle: Glabella -> Pronasale -> Pogonion
  1034→        r["Total Facial Convexity"] = self.angle_at_vertex("glabella", "pronasale", "pogonion", standardized=True)
  1035→
  1036→        # =====================================================================
  1037→        # 30. Upper Lip E-Line Position
  1038→        # =====================================================================
  1039→        e_line_upper = self.perpendicular_distance("labrale_sup", "pronasale", "pogonion", standardized=True)
  1040→        r["Upper Lip E-Line Position"] = e_line_upper * self.mm_per_unit
  1041→
  1042→        # =====================================================================
  1043→        # 31. Upper Lip S-Line Position
  1044→        # =====================================================================
  1045→        s_line_upper = self.perpendicular_distance("labrale_sup", "subnasale", "pogonion", standardized=True)
  1046→        r["Upper Lip S-Line Position"] = s_line_upper * self.mm_per_unit
  1047→
  1048→        # =====================================================================
  1049→        # 32. Upper Lip Burstone Line
  1050→        # =====================================================================
  1051→        burstone_upper = self.perpendicular_distance("labrale_sup", "subnasale", "pogonion", standardized=True)
  1052→        r["Upper Lip Burstone Line"] = burstone_upper * self.mm_per_unit
  1053→
  1054→        # =====================================================================
  1055→        # 33. Upper Forehead Slope
  1056→        # =====================================================================
  1057→        # Angle of forehead relative to vertical
  1058→        forehead_angle = 90 - abs(self.angle_to_horizontal("trichion", "glabella", standardized=True))
  1059→        r["Upper Forehead Slope"] = forehead_angle
  1060→
  1061→        return r
  1062→
  1063→
  1064→# =============================================================================
  1065→# MOCK DATA GENERATOR
  1066→# =============================================================================
  1067→
  1068→def generate_mock_landmarks() -> List[MockLandmark]:
  1069→    """
  1070→    Generate 478 mock landmarks roughly shaped like a human face.
  1071→    """
  1072→    landmarks = []
  1073→
  1074→    for i in range(478):
  1075→        t = i / 478.0 * 2 * math.pi
  1076→        x = 0.5 + 0.3 * math.cos(t) * (1 + 0.1 * math.sin(3 * t))
  1077→        y = 0.5 + 0.4 * math.sin(t) * (1 + 0.1 * math.cos(2 * t))
  1078→        landmarks.append(MockLandmark(x, y, 0.0))
  1079→
  1080→    # Override specific landmarks with anatomically correct positions
  1081→    # All coordinates are normalized [0, 1] where (0,0) is top-left
  1082→
  1083→    # === HAIRLINE / FOREHEAD ===
  1084→    landmarks[10] = MockLandmark(0.5, 0.08, 0.0)    # trichion
  1085→    landmarks[151] = MockLandmark(0.5, 0.15, 0.0)   # forehead_center
  1086→
  1087→    # === EYEBROWS ===
  1088→    landmarks[107] = MockLandmark(0.40, 0.28, 0.0)  # brow_inner_l
  1089→    landmarks[70] = MockLandmark(0.30, 0.26, 0.0)   # brow_outer_l
  1090→    landmarks[105] = MockLandmark(0.34, 0.25, 0.0)  # brow_peak_l
  1091→    landmarks[336] = MockLandmark(0.60, 0.28, 0.0)  # brow_inner_r
  1092→    landmarks[300] = MockLandmark(0.70, 0.26, 0.0)  # brow_outer_r
  1093→    landmarks[334] = MockLandmark(0.66, 0.25, 0.0)  # brow_peak_r
  1094→
  1095→    # === EYES - LEFT ===
  1096→    landmarks[468] = MockLandmark(0.38, 0.38, 0.0)   # pupil_l
  1097→    landmarks[133] = MockLandmark(0.42, 0.385, 0.0)  # canthus_in_l
  1098→    landmarks[33] = MockLandmark(0.33, 0.375, 0.0)   # canthus_out_l
  1099→    landmarks[159] = MockLandmark(0.38, 0.36, 0.0)   # upper_eyelid_l
  1100→    landmarks[145] = MockLandmark(0.38, 0.40, 0.0)   # lower_eyelid_l
  1101→
  1102→    # === EYES - RIGHT ===
  1103→    landmarks[473] = MockLandmark(0.62, 0.38, 0.0)   # pupil_r
  1104→    landmarks[362] = MockLandmark(0.58, 0.385, 0.0)  # canthus_in_r
  1105→    landmarks[263] = MockLandmark(0.67, 0.375, 0.0)  # canthus_out_r
  1106→    landmarks[386] = MockLandmark(0.62, 0.36, 0.0)   # upper_eyelid_r
  1107→    landmarks[374] = MockLandmark(0.62, 0.40, 0.0)   # lower_eyelid_r
  1108→
  1109→    # === CHEEKBONES ===
  1110→    landmarks[123] = MockLandmark(0.22, 0.42, 0.0)   # zygion_l / cheekbone_l
  1111→    landmarks[352] = MockLandmark(0.78, 0.42, 0.0)   # zygion_r / cheekbone_r
  1112→
  1113→    # === TEMPLES ===
  1114→    landmarks[21] = MockLandmark(0.18, 0.32, 0.0)    # temple_l
  1115→    landmarks[251] = MockLandmark(0.82, 0.32, 0.0)   # temple_r
  1116→
  1117→    # === NOSE ===
  1118→    landmarks[168] = MockLandmark(0.50, 0.32, 0.0)   # glabella
  1119→    landmarks[6] = MockLandmark(0.50, 0.40, 0.0)     # nasion
  1120→    landmarks[1] = MockLandmark(0.56, 0.46, -0.08)   # pronasale
  1121→    landmarks[164] = MockLandmark(0.54, 0.50, -0.02) # subnasale
  1122→    landmarks[2] = MockLandmark(0.50, 0.48, 0.0)     # columella
  1123→    landmarks[102] = MockLandmark(0.46, 0.49, 0.0)   # ala_l
  1124→    landmarks[331] = MockLandmark(0.54, 0.49, 0.0)   # ala_r
  1125→
  1126→    # === MOUTH / LIPS ===
  1127→    landmarks[0] = MockLandmark(0.50, 0.54, 0.0)     # labrale_sup / upper_lip
  1128→    landmarks[13] = MockLandmark(0.50, 0.57, 0.0)    # stomion
  1129→    landmarks[17] = MockLandmark(0.49, 0.60, 0.0)    # labrale_inf
  1130→    landmarks[18] = MockLandmark(0.50, 0.63, 0.0)    # sublabiale
  1131→    landmarks[61] = MockLandmark(0.42, 0.57, 0.0)    # cheilion_l
  1132→    landmarks[291] = MockLandmark(0.58, 0.57, 0.0)   # cheilion_r
  1133→    landmarks[37] = MockLandmark(0.47, 0.54, 0.0)    # cupid_bow_l
  1134→    landmarks[267] = MockLandmark(0.53, 0.54, 0.0)   # cupid_bow_r
  1135→
  1136→    # === CHIN / JAW ===
  1137→    landmarks[152] = MockLandmark(0.50, 0.78, 0.0)   # pogonion / menton
  1138→    landmarks[175] = MockLandmark(0.50, 0.75, 0.0)   # gnathion
  1139→    landmarks[172] = MockLandmark(0.28, 0.68, 0.0)   # gonion_l
  1140→    landmarks[397] = MockLandmark(0.72, 0.68, 0.0)   # gonion_r
  1141→    landmarks[177] = MockLandmark(0.42, 0.76, 0.0)   # chin_l
  1142→    landmarks[401] = MockLandmark(0.58, 0.76, 0.0)   # chin_r
  1143→
  1144→    # === EARS ===
  1145→    landmarks[234] = MockLandmark(0.12, 0.45, 0.0)   # ear_l
  1146→    landmarks[454] = MockLandmark(0.88, 0.45, 0.0)   # ear_r
  1147→    landmarks[127] = MockLandmark(0.14, 0.35, 0.0)   # ear_top_l
  1148→    landmarks[356] = MockLandmark(0.86, 0.35, 0.0)   # ear_top_r
  1149→
  1150→    # === FRANKFORT PLANE ===
  1151→    landmarks[226] = MockLandmark(0.12, 0.40, 0.0)   # porion
  1152→
  1153→    # === NECK ===
  1154→    landmarks[132] = MockLandmark(0.35, 0.82, 0.0)   # neck_l
  1155→    landmarks[361] = MockLandmark(0.65, 0.82, 0.0)   # neck_r
  1156→
  1157→    return landmarks
  1158→
  1159→
  1160→# =============================================================================
  1161→# TEST HARNESS
  1162→# =============================================================================
  1163→
  1164→def print_profile_table(title: str, metrics: Dict[str, float], ranges: Dict[str, List[float]]) -> Tuple[float, int]:
  1165→    """Print a formatted table for a profile (front or side)."""
  1166→    print(f"\n{'=' * 75}")
  1167→    print(f"  {title}")
  1168→    print(f"{'=' * 75}")
  1169→    print(f"{'Metric':<45} {'Value':>10} {'Range':>12} {'Score':>8}")
  1170→    print(f"{'-' * 75}")
  1171→
  1172→    total_score = 0.0
  1173→    scored_count = 0
  1174→    missing_count = 0
  1175→
  1176→    for metric_name, (min_val, max_val) in sorted(ranges.items()):
  1177→        if metric_name in metrics:
  1178→            value = metrics[metric_name]
  1179→            score = calculate_score(value, min_val, max_val)
  1180→            total_score += score
  1181→            scored_count += 1
  1182→
  1183→            if abs(value) >= 10:
  1184→                value_str = f"{value:.1f}"
  1185→            else:
  1186→                value_str = f"{value:.2f}"
  1187→
  1188→            if "Angle" in metric_name or "Tilt" in metric_name:
  1189→                value_str += "°"
  1190→
  1191→            range_str = f"[{min_val:.1f}, {max_val:.1f}]"
  1192→            score_str = f"{score:.1f}/10"
  1193→
  1194→            print(f"{metric_name:<45} {value_str:>10} {range_str:>12} {score_str:>8}")
  1195→        else:
  1196→            missing_count += 1
  1197→            range_str = f"[{min_val:.1f}, {max_val:.1f}]"
  1198→            print(f"{metric_name:<45} {'N/A':>10} {range_str:>12} {'--':>8}")
  1199→
  1200→    if scored_count > 0:
  1201→        avg_score = total_score / scored_count
  1202→        print(f"{'-' * 75}")
  1203→        print(f"{'AVERAGE SCORE':<45} {'':>10} {'':>12} {avg_score:.2f}/10")
  1204→        print(f"{'Metrics Calculated':<45} {scored_count:>10}")
  1205→        print(f"{'Metrics Missing':<45} {missing_count:>10}")
  1206→
  1207→    print(f"{'=' * 75}")
  1208→
  1209→    return total_score, scored_count
  1210→
  1211→
  1212→def main():
  1213→    """Main test harness for the looksmax engine."""
  1214→    print("\n" + "=" * 75)
  1215→    print("  LOOKSMAX ENGINE - Comprehensive Facial Analysis (66+ Metrics)")
  1216→    print("  Using ranges.json for ethnicity-specific scoring")
  1217→    print("=" * 75)
  1218→
  1219→    # Configuration
  1220→    gender = "male"
  1221→    ethnicity = "caucasian"
  1222→
  1223→    # [1] Load ranges.json
  1224→    print(f"\n[1] Loading ranges.json...")
  1225→    try:
  1226→        ranges = load_ranges()
  1227→        current_ranges = get_ranges_for_profile(ranges, gender, ethnicity)
  1228→        print(f"    Loaded ranges for: {gender} / {ethnicity}")
  1229→        print(f"    Front metrics defined: {len(current_ranges.get('front', {}))}")
  1230→        print(f"    Side metrics defined: {len(current_ranges.get('side', {}))}")
  1231→    except FileNotFoundError:
  1232→        print("    ERROR: ranges.json not found!")
  1233→        return
  1234→
  1235→    # [2] Generate mock landmarks
  1236→    print(f"\n[2] Generating mock facial landmarks (478 points)...")
  1237→    landmarks = generate_mock_landmarks()
  1238→    print(f"    Created {len(landmarks)} landmarks")
  1239→
  1240→    # [3] Calculate metrics using FacialCalculator
  1241→    print(f"\n[3] Calculating facial metrics...")
  1242→    calculator = FacialCalculator(landmarks)
  1243→    all_metrics = calculator.calculate_all()
  1244→    print(f"    Front metrics calculated: {len(all_metrics['front'])}")
  1245→    print(f"    Side metrics calculated: {len(all_metrics['side'])}")
  1246→    print(f"    IPD Scale Factor: {calculator.mm_per_unit:.2f} mm/unit")
  1247→
  1248→    # [4] Print Front Profile Table
  1249→    print(f"\n[4] Scoring against {gender}/{ethnicity} ranges...")
  1250→    front_total, front_count = print_profile_table(
  1251→        "FRONT PROFILE ANALYSIS",
  1252→        all_metrics['front'],
  1253→        current_ranges.get('front', {})
  1254→    )
  1255→
  1256→    # [5] Print Side Profile Table
  1257→    side_total, side_count = print_profile_table(
  1258→        "SIDE PROFILE ANALYSIS",
  1259→        all_metrics['side'],
  1260→        current_ranges.get('side', {})
  1261→    )
  1262→
  1263→    # [6] Overall Summary
  1264→    total_count = front_count + side_count
  1265→    total_score = front_total + side_total
  1266→
  1267→    print(f"\n{'=' * 75}")
  1268→    print("  OVERALL SUMMARY")
  1269→    print(f"{'=' * 75}")
  1270→    print(f"  Profile: {gender.upper()} / {ethnicity.upper()}")
  1271→    print(f"  Front metrics scored: {front_count}/{len(current_ranges.get('front', {}))}")
  1272→    print(f"  Side metrics scored: {side_count}/{len(current_ranges.get('side', {}))}")
  1273→    print(f"  Total metrics: {total_count}")
  1274→    if total_count > 0:
  1275→        overall_avg = total_score / total_count
  1276→        overall_pct = (total_score / (total_count * 10)) * 100
  1277→        print(f"  Average Score: {overall_avg:.2f} / 10")
  1278→        print(f"  Overall Rating: {overall_pct:.1f}%")
  1279→    print(f"{'=' * 75}\n")
  1280→
  1281→
  1282→if __name__ == "__main__":
  1283→    main()
  1284→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
