     1→'use client';
     2→
     3→import React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';
     4→import { LandmarkPoint } from '@/lib/landmarks';
     5→import {
     6→  analyzeFrontProfile,
     7→  analyzeSideProfile,
     8→  analyzeHarmony,
     9→  HarmonyAnalysis,
    10→  MetricScoreResult,
    11→  METRIC_CONFIGS,
    12→  Ethnicity,
    13→  Gender,
    14→} from '@/lib/harmony-scoring';
    15→import {
    16→  calculateHarmonyScore,
    17→  getTopMetrics,
    18→  getBottomMetrics,
    19→  HarmonyScoreResult,
    20→  RankedMetric,
    21→} from '@/lib/looksmax-scoring';
    22→import { harmonyToPSL } from '@/lib/recommendations/severity';
    23→import {
    24→  classifyInsights,
    25→  convertToStrength,
    26→  convertToFlaw,
    27→  INSIGHTS_DEFINITIONS,
    28→} from '@/lib/insights-engine';
    29→import { classifyMetric } from '@/lib/taxonomy';
    30→import {
    31→  Ratio,
    32→  Strength,
    33→  Flaw,
    34→  Recommendation,
    35→  ResultsTab,
    36→  FullHarmonyAnalysis,
    37→} from '@/types/results';
    38→import { generateRecommendations } from '@/lib/results/analysis';
    39→
    40→// ============================================
    41→// CONTEXT TYPES
    42→// ============================================
    43→
    44→interface ResultsContextType {
    45→  // Raw data
    46→  frontLandmarks: LandmarkPoint[];
    47→  sideLandmarks: LandmarkPoint[];
    48→  gender: Gender;
    49→  ethnicity: Ethnicity;
    50→  frontPhoto: string;
    51→  sidePhoto: string | null;
    52→
    53→  // Computed results
    54→  harmonyAnalysis: FullHarmonyAnalysis | null;
    55→  frontRatios: Ratio[];
    56→  sideRatios: Ratio[];
    57→  strengths: Strength[];
    58→  flaws: Flaw[];
    59→  recommendations: Recommendation[];
    60→
    61→  // Scores (now using weighted harmony from looksmax_engine.py)
    62→  overallScore: number;
    63→  frontScore: number;
    64→  sideScore: number;
    65→
    66→  // Weighted Harmony Score (from looksmax_engine.py)
    67→  harmonyScoreResult: HarmonyScoreResult | null;
    68→  harmonyPercentage: number;  // 0-100% weighted harmony
    69→
    70→  // Top 3 strengths and bottom 3 areas to improve with advice
    71→  topMetrics: RankedMetric[];
    72→  bottomMetrics: RankedMetric[];
    73→
    74→  // PSL Rating (1-10 scale)
    75→  pslRating: {
    76→    psl: number;
    77→    tier: string;
    78→    percentile: number;
    79→    description: string;
    80→  };
    81→
    82→  // UI state
    83→  activeTab: ResultsTab;
    84→  setActiveTab: (tab: ResultsTab) => void;
    85→  expandedMeasurementId: string | null;
    86→  setExpandedMeasurementId: (id: string | null) => void;
    87→  selectedVisualizationMetric: string | null;
    88→  setSelectedVisualizationMetric: (id: string | null) => void;
    89→  categoryFilter: string | null;
    90→  setCategoryFilter: (category: string | null) => void;
    91→  showLandmarkOverlay: boolean;
    92→  setShowLandmarkOverlay: (show: boolean) => void;
    93→
    94→  // Actions
    95→  setResultsData: (data: ResultsInputData) => void;
    96→}
    97→
    98→interface ResultsInputData {
    99→  frontLandmarks: LandmarkPoint[];
   100→  sideLandmarks: LandmarkPoint[];
   101→  frontPhoto: string;
   102→  sidePhoto?: string;
   103→  gender: Gender;
   104→  ethnicity?: Ethnicity;
   105→}
   106→
   107→// ============================================
   108→// HELPER FUNCTIONS
   109→// ============================================
   110→
   111→function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {
   112→  switch (unit) {
   113→    case 'ratio': return 'x';
   114→    case 'percent': return '%';
   115→    case 'degrees': return '°';
   116→    case 'mm': return 'mm';
   117→    default: return 'x';
   118→  }
   119→}
   120→
   121→function transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {
   122→  const metricConfig = METRIC_CONFIGS[result.metricId];
   123→
   124→  // Generate illustration based on metric
   125→  const illustration = generateIllustration(result.metricId, landmarks);
   126→
   127→  // Get flaw/strength mappings
   128→  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);
   129→
   130→  // Classify metric using Harmony taxonomy
   131→  const taxonomyClassification = classifyMetric(result.name, result.category);
   132→
   133→  return {
   134→    id: result.metricId,
   135→    name: result.name,
   136→    value: result.value,
   137→    score: result.standardizedScore,  // Use standardized 0-10 score for UI display
   138→    standardizedScore: result.standardizedScore,
   139→    unit: convertUnitToRatioUnit(result.unit),
   140→    idealMin: result.idealMin,
   141→    idealMax: result.idealMax,
   142→    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,
   143→    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,
   144→    description: metricConfig?.description || '',
   145→    category: result.category,
   146→    qualityLevel: result.qualityTier,
   147→    severity: result.severity,
   148→    illustration,
   149→    mayIndicateFlaws,
   150→    mayIndicateStrengths,
   151→    usedLandmarks: getUsedLandmarks(result.metricId),
   152→    scoringCurveConfig: metricConfig ? {
   153→      decayRate: metricConfig.decayRate,
   154→      maxScore: metricConfig.maxScore,
   155→    } : undefined,
   156→    taxonomyPrimary: taxonomyClassification?.primary,
   157→    taxonomySecondary: taxonomyClassification?.secondary,
   158→  };
   159→}
   160→
   161→// Enhanced illustration configuration type
   162→interface IllustrationConfig {
   163→  points: string[];
   164→  lines: Array<{
   165→    from: string;
   166→    to: string;
   167→    label?: string;
   168→    color?: string;
   169→    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type
   170→  }>;
   171→}
   172→
   173→// Comprehensive illustration configurations for all metrics
   174→const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {
   175→  // ==========================================
   176→  // FACE SHAPE / PROPORTIONS
   177→  // ==========================================
   178→  faceWidthToHeight: {
   179→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
   180→    lines: [
   181→      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },
   182→      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },
   183→    ],
   184→  },
   185→  totalFacialWidthToHeight: {
   186→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
   187→    lines: [
   188→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },
   189→      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },
   190→    ],
   191→  },
   192→  lowerThirdProportion: {
   193→    points: ['subnasale', 'menton', 'trichion'],
   194→    lines: [
   195→      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },
   196→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
   197→    ],
   198→  },
   199→  middleThirdProportion: {
   200→    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],
   201→    lines: [
   202→      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },
   203→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
   204→    ],
   205→  },
   206→  upperThirdProportion: {
   207→    points: ['trichion', 'nasal_base', 'menton'],
   208→    lines: [
   209→      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },
   210→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
   211→    ],
   212→  },
   213→  bitemporalWidth: {
   214→    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],
   215→    lines: [
   216→      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },
   217→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },
   218→    ],
   219→  },
   220→  cheekboneHeight: {
   221→    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],
   222→    lines: [
   223→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },
   224→      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },
   225→    ],
   226→  },
   227→  midfaceRatio: {
   228→    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],
   229→    lines: [
   230→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },
   231→      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },
   232→    ],
   233→  },
   234→
   235→  // ==========================================
   236→  // JAW MEASUREMENTS
   237→  // ==========================================
   238→  jawSlope: {
   239→    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],
   240→    lines: [
   241→      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },
   242→      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },
   243→    ],
   244→  },
   245→  jawFrontalAngle: {
   246→    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],
   247→    lines: [
   248→      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },
   249→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },
   250→    ],
   251→  },
   252→  bigonialWidth: {
   253→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],
   254→    lines: [
   255→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },
   256→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },
   257→    ],
   258→  },
   259→  jawWidthRatio: {
   260→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],
   261→    lines: [
   262→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },
   263→      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },
   264→    ],
   265→  },
   266→
   267→  // ==========================================
   268→  // EYE MEASUREMENTS
   269→  // ==========================================
   270→  lateralCanthalTilt: {
   271→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],
   272→    lines: [
   273→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },
   274→      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },
   275→    ],
   276→  },
   277→  eyeAspectRatio: {
   278→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],
   279→    lines: [
   280→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },
   281→      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },
   282→    ],
   283→  },
   284→  eyeSeparationRatio: {
   285→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],
   286→    lines: [
   287→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },
   288→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
   289→    ],
   290→  },
   291→  interpupillaryRatio: {
   292→    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],
   293→    lines: [
   294→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },
   295→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
   296→    ],
   297→  },
   298→  interpupillaryMouthWidthRatio: {
   299→    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],
   300→    lines: [
   301→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },
   302→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
   303→    ],
   304→  },
   305→  oneEyeApartTest: {
   306→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],
   307→    lines: [
   308→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },
   309→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },
   310→    ],
   311→  },
   312→
   313→  // ==========================================
   314→  // EYEBROW MEASUREMENTS
   315→  // ==========================================
   316→  browLengthRatio: {
   317→    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],
   318→    lines: [
   319→      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },
   320→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
   321→    ],
   322→  },
   323→  eyebrowTilt: {
   324→    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],
   325→    lines: [
   326→      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },
   327→      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },
   328→    ],
   329→  },
   330→  eyebrowLowSetedness: {
   331→    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],
   332→    lines: [
   333→      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },
   334→    ],
   335→  },
   336→
   337→  // ==========================================
   338→  // NOSE MEASUREMENTS (FRONT)
   339→  // ==========================================
   340→  nasalIndex: {
   341→    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],
   342→    lines: [
   343→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },
   344→      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },
   345→    ],
   346→  },
   347→  intercanthalNasalRatio: {
   348→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],
   349→    lines: [
   350→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },
   351→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },
   352→    ],
   353→  },
   354→  noseBridgeWidth: {
   355→    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],
   356→    lines: [
   357→      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },
   358→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },
   359→    ],
   360→  },
   361→  noseTipPosition: {
   362→    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],
   363→    lines: [
   364→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },
   365→    ],
   366→  },
   367→
   368→  // ==========================================
   369→  // MOUTH/LIP MEASUREMENTS
   370→  // ==========================================
   371→  mouthNoseWidthRatio: {
   372→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],
   373→    lines: [
   374→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
   375→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },
   376→    ],
   377→  },
   378→  lowerUpperLipRatio: {
   379→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],
   380→    lines: [
   381→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },
   382→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },
   383→    ],
   384→  },
   385→  chinPhiltrumRatio: {
   386→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],
   387→    lines: [
   388→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },
   389→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },
   390→    ],
   391→  },
   392→  mouthWidth: {
   393→    points: ['left_cheilion', 'right_cheilion'],
   394→    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],
   395→  },
   396→
   397→  // ==========================================
   398→  // CHIN MEASUREMENTS
   399→  // ==========================================
   400→  chinHeight: {
   401→    points: ['labrale_inferius', 'menton'],
   402→    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],
   403→  },
   404→
   405→  // ==========================================
   406→  // NECK MEASUREMENTS
   407→  // ==========================================
   408→  neckWidthRatio: {
   409→    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],
   410→    lines: [
   411→      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },
   412→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },
   413→    ],
   414→  },
   415→
   416→  // ==========================================
   417→  // SIDE PROFILE MEASUREMENTS
   418→  // ==========================================
   419→  gonialAngle: {
   420→    points: ['tragus', 'gonionBottom', 'menton'],
   421→    lines: [
   422→      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },
   423→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },
   424→    ],
   425→  },
   426→  nasofrontalAngle: {
   427→    points: ['glabella', 'nasion', 'pronasale'],
   428→    lines: [
   429→      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },
   430→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },
   431→    ],
   432→  },
   433→  nasofacialAngle: {
   434→    points: ['nasion', 'pronasale', 'pogonion'],
   435→    lines: [
   436→      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },
   437→      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },
   438→    ],
   439→  },
   440→  nasomentaAngle: {
   441→    points: ['nasion', 'pronasale', 'pogonion'],
   442→    lines: [
   443→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },
   444→      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },
   445→    ],
   446→  },
   447→  submentalCervicalAngle: {
   448→    points: ['menton', 'cervicalPoint', 'neckPoint'],
   449→    lines: [
   450→      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },
   451→      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },
   452→    ],
   453→  },
   454→  facialDepthToHeight: {
   455→    points: ['pronasale', 'tragus', 'nasion', 'menton'],
   456→    lines: [
   457→      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },
   458→      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },
   459→    ],
   460→  },
   461→  anteriorFacialDepth: {
   462→    points: ['glabella', 'pronasale', 'pogonion'],
   463→    lines: [
   464→      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },
   465→      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },
   466→    ],
   467→  },
   468→  mandibularPlaneAngle: {
   469→    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],
   470→    lines: [
   471→      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },
   472→      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },
   473→    ],
   474→  },
   475→  ramusToMandibleRatio: {
   476→    points: ['gonionTop', 'gonionBottom', 'menton'],
   477→    lines: [
   478→      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },
   479→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },
   480→    ],
   481→  },
   482→  orbitalVector: {
   483→    points: ['cornealApex', 'orbitale', 'cheekbone'],
   484→    lines: [
   485→      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },
   486→    ],
   487→  },
   488→  eLineLowerLip: {
   489→    points: ['pronasale', 'pogonion', 'labraleInferius'],
   490→    lines: [
   491→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },
   492→    ],
   493→  },
   494→  sLineLowerLip: {
   495→    points: ['pronasale', 'pogonion', 'labraleInferius'],
   496→    lines: [
   497→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },
   498→    ],
   499→  },
   500→  holdawayHLine: {
   501→    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],
   502→    lines: [
   503→      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },
   504→    ],
   505→  },
   506→  burstoneLowerLip: {
   507→    points: ['subnasale', 'pogonion', 'labraleInferius'],
   508→    lines: [
   509→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },
   510→    ],
   511→  },
   512→
   513→  // ==========================================
   514→  // ADDITIONAL FRONT PROFILE METRICS
   515→  // ==========================================
   516→  cupidsBowDepth: {
   517→    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],
   518→    lines: [
   519→      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },
   520→      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },
   521→    ],
   522→  },
   523→  mouthCornerPosition: {
   524→    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],
   525→    lines: [
   526→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },
   527→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },
   528→    ],
   529→  },
   530→  iaaJfaDeviation: {
   531→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],
   532→    lines: [
   533→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },
   534→      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },
   535→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },
   536→    ],
   537→  },
   538→  ipsilateralAlarAngle: {
   539→    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],
   540→    lines: [
   541→      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },
   542→      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },
   543→    ],
   544→  },
   545→  earProtrusionAngle: {
   546→    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],
   547→    lines: [
   548→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },
   549→    ],
   550→  },
   551→  earProtrusionRatio: {
   552→    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],
   553→    lines: [
   554→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },
   555→      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },
   556→    ],
   557→  },
   558→  mouthWidthToNoseRatio: {
   559→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],
   560→    lines: [
   561→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
   562→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },
   563→    ],
   564→  },
   565→  lowerToUpperLipRatio: {
   566→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],
   567→    lines: [
   568→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },
   569→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },
   570→    ],
   571→  },
   572→  chinToPhiltrumRatio: {
   573→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],
   574→    lines: [
   575→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },
   576→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },
   577→    ],
   578→  },
   579→
   580→  // ==========================================
   581→  // ADDITIONAL SIDE PROFILE METRICS
   582→  // ==========================================
   583→  nasolabialAngle: {
   584→    points: ['columella', 'subnasale', 'labraleSuperius'],
   585→    lines: [
   586→      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },
   587→      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },
   588→    ],
   589→  },
   590→  nasalTipAngle: {
   591→    points: ['nasion', 'pronasale', 'columella'],
   592→    lines: [
   593→      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },
   594→      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },
   595→    ],
   596→  },
   597→  nasalProjection: {
   598→    points: ['alar_crease', 'pronasale', 'subnasale'],
   599→    lines: [
   600→      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },
   601→    ],
   602→  },
   603→  nasalWToHRatio: {
   604→    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],
   605→    lines: [
   606→      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },
   607→      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },
   608→    ],
   609→  },
   610→  noseTipRotationAngle: {
   611→    points: ['columella', 'subnasale', 'labraleSuperius'],
   612→    lines: [
   613→      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },
   614→    ],
   615→  },
   616→  frankfortTipAngle: {
   617→    points: ['porion', 'orbitale', 'pronasale'],
   618→    lines: [
   619→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
   620→      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },
   621→    ],
   622→  },
   623→  mentolabialAngle: {
   624→    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],
   625→    lines: [
   626→      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },
   627→      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },
   628→    ],
   629→  },
   630→  zAngle: {
   631→    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],
   632→    lines: [
   633→      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },
   634→    ],
   635→  },
   636→  facialConvexityGlabella: {
   637→    points: ['glabella', 'subnasale', 'pogonion'],
   638→    lines: [
   639→      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },
   640→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
   641→    ],
   642→  },
   643→  facialConvexityNasion: {
   644→    points: ['nasion', 'subnasale', 'pogonion'],
   645→    lines: [
   646→      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },
   647→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
   648→    ],
   649→  },
   650→  totalFacialConvexity: {
   651→    points: ['glabella', 'pronasale', 'pogonion'],
   652→    lines: [
   653→      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },
   654→      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
   655→    ],
   656→  },
   657→  interiorMidfaceProjectionAngle: {
   658→    points: ['orbitale', 'subnasale', 'pronasale'],
   659→    lines: [
   660→      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },
   661→      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },
   662→    ],
   663→  },
   664→  recessionFromFrankfort: {
   665→    points: ['porion', 'orbitale', 'pogonion'],
   666→    lines: [
   667→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
   668→      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },
   669→    ],
   670→  },
   671→  gonionToMouthLine: {
   672→    points: ['gonionBottom', 'cheilion', 'tragus'],
   673→    lines: [
   674→      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },
   675→    ],
   676→  },
   677→  eLineUpperLip: {
   678→    points: ['pronasale', 'pogonion', 'labraleSuperius'],
   679→    lines: [
   680→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },
   681→    ],
   682→  },
   683→  sLineUpperLip: {
   684→    points: ['pronasale', 'pogonion', 'labraleSuperius'],
   685→    lines: [
   686→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },
   687→    ],
   688→  },
   689→  burstoneUpperLip: {
   690→    points: ['subnasale', 'pogonion', 'labraleSuperius'],
   691→    lines: [
   692→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },
   693→    ],
   694→  },
   695→  chinProjection: {
   696→    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],
   697→    lines: [
   698→      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },
   699→    ],
   700→  },
   701→  recessionRelativeToFrankfort: {
   702→    points: ['porion', 'orbitale', 'pogonion', 'menton'],
   703→    lines: [
   704→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
   705→      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },
   706→    ],
   707→  },
   708→  browridgeInclinationAngle: {
   709→    points: ['glabella', 'trichion', 'nasion'],
   710→    lines: [
   711→      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },
   712→      { from: 'glabella', to: 'nasion', color: '#67e8f9' },
   713→    ],
   714→  },
   715→  upperForeheadSlope: {
   716→    points: ['trichion', 'glabella', 'frankfortHorizontal'],
   717→    lines: [
   718→      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },
   719→    ],
   720→  },
   721→  midfaceProjectionAngle: {
   722→    points: ['orbitale', 'subnasale', 'pronasale'],
   723→    lines: [
   724→      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },
   725→      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },
   726→    ],
   727→  },
   728→};
   729→
   730→function generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {
   731→  const landmarkMap: Record<string, LandmarkPoint> = {};
   732→  landmarks.forEach(l => { landmarkMap[l.id] = l; });
   733→
   734→  const config = ILLUSTRATION_CONFIGS[metricId];
   735→  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};
   736→  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};
   737→
   738→  if (config) {
   739→    config.points.forEach((pointId, i) => {
   740→      if (landmarkMap[pointId]) {
   741→        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };
   742→      }
   743→    });
   744→    config.lines.forEach((line, i) => {
   745→      lines[`line_${i}`] = {
   746→        from: line.from,
   747→        to: line.to,
   748→        color: line.color || '#67e8f9',
   749→        label: line.label,
   750→        labelPosition: line.labelPosition,
   751→      };
   752→    });
   753→  }
   754→
   755→  return { points, lines };
   756→}
   757→
   758→function getUsedLandmarks(metricId: string): string[] {
   759→  const landmarkMappings: Record<string, string[]> = {
   760→    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
   761→    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],
   762→    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],
   763→    ipd: ['left_pupila', 'right_pupila'],
   764→    mouthWidth: ['left_cheilion', 'right_cheilion'],
   765→    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],
   766→    chinHeight: ['labrale_inferius', 'menton'],
   767→    gonialAngle: ['tragus', 'gonionBottom', 'menton'],
   768→  };
   769→  return landmarkMappings[metricId] || [];
   770→}
   771→
   772→function getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {
   773→  const flawMappings: Record<string, { low: string[]; high: string[] }> = {
   774→    faceWidthToHeight: {
   775→      low: ['Narrow face', 'Vertically elongated face'],
   776→      high: ['Wide face', 'Horizontally expanded face'],
   777→    },
   778→    lowerThirdProportion: {
   779→      low: ['Short lower third', 'Deficient mandible'],
   780→      high: ['Long lower third', 'Mandibular excess'],
   781→    },
   782→    lateralCanthalTilt: {
   783→      low: ['Negative canthal tilt', 'Drooping eyes'],
   784→      high: ['Excessive positive canthal tilt'],
   785→    },
   786→    nasalIndex: {
   787→      low: ['Narrow nose', 'Leptorrhine nose'],
   788→      high: ['Wide nose', 'Platyrrhine nose'],
   789→    },
   790→    gonialAngle: {
   791→      low: ['Steep mandibular plane'],
   792→      high: ['Flat mandibular plane', 'Weak jaw definition'],
   793→    },
   794→  };
   795→
   796→  const strengthMappings: Record<string, { ideal: string[] }> = {
   797→    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },
   798→    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },
   799→    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },
   800→    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },
   801→  };
   802→
   803→  const mapping = flawMappings[result.metricId];
   804→  const strengthMapping = strengthMappings[result.metricId];
   805→
   806→  let mayIndicateFlaws: string[] = [];
   807→  let mayIndicateStrengths: string[] = [];
   808→
   809→  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {
   810→    mayIndicateStrengths = strengthMapping?.ideal || [];
   811→  } else if (mapping) {
   812→    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;
   813→  }
   814→
   815→  return { mayIndicateFlaws, mayIndicateStrengths };
   816→}
   817→
   818→// Metric groupings for creating multi-ratio strengths
   819→const STRENGTH_GROUPINGS: Record<string, {
   820→  name: string;
   821→  category: string;
   822→  description: string;
   823→  metrics: string[];
   824→}> = {
   825→  // Lip Proportions
   826→  lipProportions: {
   827→    name: 'Well Proportioned Lips',
   828→    category: 'Lips',
   829→    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',
   830→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],
   831→  },
   832→  // Eye Proportions
   833→  eyeProportions: {
   834→    name: 'Harmonious Eye Proportions',
   835→    category: 'Eyes',
   836→    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',
   837→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],
   838→  },
   839→  // Nose Proportions
   840→  noseProportions: {
   841→    name: 'Balanced Nasal Proportions',
   842→    category: 'Nose',
   843→    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',
   844→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],
   845→  },
   846→  // Jaw Definition
   847→  jawDefinition: {
   848→    name: 'Well-Defined Jawline',
   849→    category: 'Jaw Shape',
   850→    description: 'The jawline displays strong definition with balanced angles and proportionate width.',
   851→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],
   852→  },
   853→  // Chin Proportions
   854→  chinProportions: {
   855→    name: 'Balanced Chin Projection',
   856→    category: 'Chin',
   857→    description: 'The chin demonstrates ideal projection and proportions relative to the face.',
   858→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],
   859→  },
   860→  // Facial Thirds
   861→  facialThirds: {
   862→    name: 'Balanced Facial Thirds',
   863→    category: 'Face Proportions',
   864→    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',
   865→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],
   866→  },
   867→  // Midface
   868→  midfaceBalance: {
   869→    name: 'Harmonious Midface',
   870→    category: 'Midface/Face Shape',
   871→    description: 'The midface shows balanced proportions with well-positioned cheekbones.',
   872→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],
   873→  },
   874→  // Forehead
   875→  foreheadBalance: {
   876→    name: 'Well-Proportioned Forehead',
   877→    category: 'Forehead',
   878→    description: 'The forehead displays ideal proportions in height and shape.',
   879→    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],
   880→  },
   881→};
   882→
   883→function generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {
   884→  const strengths: Strength[] = [];
   885→  const usedMetricIds = new Set<string>();
   886→
   887→  // First pass: Create grouped strengths from related high-scoring metrics
   888→  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {
   889→    // Find all high-scoring measurements that belong to this group
   890→    const groupMeasurements = analysis.measurements.filter(m =>
   891→      groupConfig.metrics.includes(m.metricId) &&
   892→      m.score >= 7.5 &&
   893→      !usedMetricIds.has(m.metricId)
   894→    );
   895→
   896→    // Only create a grouped strength if we have 2+ metrics with good scores
   897→    if (groupMeasurements.length >= 2) {
   898→      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;
   899→      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';
   900→
   901→      // Mark these metrics as used
   902→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));
   903→
   904→      // Create grouped strength with multiple contributing ratios
   905→      strengths.push({
   906→        id: `strength_group_${groupId}`,
   907→        strengthName: groupConfig.name,
   908→        summary: groupConfig.description,
   909→        avgScore,
   910→        qualityLevel: bestQuality,
   911→        categoryName: groupConfig.category,
   912→        responsibleRatios: groupMeasurements.map(m => ({
   913→          ratioName: m.name,
   914→          ratioId: m.metricId,
   915→          score: m.score,
   916→          value: m.value,
   917→          idealMin: m.idealMin,
   918→          idealMax: m.idealMax,
   919→          unit: m.unit,
   920→          category: m.category,
   921→        })),
   922→      });
   923→    }
   924→  });
   925→
   926→  // Second pass: Add remaining individual strengths that weren't grouped
   927→  analysis.strengths.forEach((s, i) => {
   928→    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group
   929→
   930→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);
   931→
   932→    strengths.push({
   933→      id: `strength_${i}`,
   934→      strengthName: s.metricName,
   935→      summary: s.reasoning,
   936→      avgScore: matchingMeasurement?.score || 8,
   937→      qualityLevel: s.qualityTier,
   938→      categoryName: s.category,
   939→      responsibleRatios: [{
   940→        ratioName: s.metricName,
   941→        ratioId: s.metricId,
   942→        score: matchingMeasurement?.score || 8,
   943→        value: s.value,
   944→        idealMin: matchingMeasurement?.idealMin || 0,
   945→        idealMax: matchingMeasurement?.idealMax || 1,
   946→        unit: matchingMeasurement?.unit || 'ratio',
   947→        category: s.category,
   948→      }],
   949→    });
   950→  });
   951→
   952→  // Sort by average score (highest first) then by number of contributing ratios
   953→  return strengths.sort((a, b) => {
   954→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {
   955→      return b.responsibleRatios.length - a.responsibleRatios.length;
   956→    }
   957→    return b.avgScore - a.avgScore;
   958→  });
   959→}
   960→
   961→// Flaw groupings - similar to strength groupings but for areas of improvement
   962→const FLAW_GROUPINGS: Record<string, {
   963→  name: string;
   964→  category: string;
   965→  description: string;
   966→  metrics: string[];
   967→}> = {
   968→  // Lip Issues
   969→  lipIssues: {
   970→    name: 'Lip Proportion Concerns',
   971→    category: 'Lips',
   972→    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',
   973→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],
   974→  },
   975→  // Eye Issues
   976→  eyeIssues: {
   977→    name: 'Eye Shape Considerations',
   978→    category: 'Eyes',
   979→    description: 'The eye proportions or positioning could benefit from enhancement.',
   980→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],
   981→  },
   982→  // Nose Issues
   983→  noseIssues: {
   984→    name: 'Nasal Proportion Concerns',
   985→    category: 'Nose',
   986→    description: 'The nasal proportions show deviations that affect facial harmony.',
   987→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],
   988→  },
   989→  // Jaw Issues
   990→  jawIssues: {
   991→    name: 'Jawline Definition Concerns',
   992→    category: 'Jaw Shape',
   993→    description: 'The jawline structure shows areas that could be enhanced for better definition.',
   994→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],
   995→  },
   996→  // Chin Issues
   997→  chinIssues: {
   998→    name: 'Chin Projection Concerns',
   999→    category: 'Chin',
  1000→    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',
  1001→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],
  1002→  },
  1003→  // Face Proportion Issues
  1004→  proportionIssues: {
  1005→    name: 'Facial Proportion Imbalance',
  1006→    category: 'Face Proportions',
  1007→    description: 'The vertical face proportions show imbalance between facial thirds.',
  1008→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],
  1009→  },
  1010→  // Midface Issues
  1011→  midfaceIssues: {
  1012→    name: 'Midface Development Concerns',
  1013→    category: 'Midface/Face Shape',
  1014→    description: 'The midface shows areas that could benefit from enhanced projection or balance.',
  1015→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],
  1016→  },
  1017→};
  1018→
  1019→function generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {
  1020→  const flaws: Flaw[] = [];
  1021→  const usedMetricIds = new Set<string>();
  1022→  let rollingLost = 0;
  1023→
  1024→  // First pass: Create grouped flaws from related low-scoring metrics
  1025→  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {
  1026→    // Find all low-scoring measurements that belong to this group
  1027→    const groupMeasurements = analysis.measurements.filter(m =>
  1028→      groupConfig.metrics.includes(m.metricId) &&
  1029→      m.score < 6 &&
  1030→      !usedMetricIds.has(m.metricId)
  1031→    );
  1032→
  1033→    // Only create a grouped flaw if we have 2+ metrics with low scores
  1034→    if (groupMeasurements.length >= 2) {
  1035→      // Mark these metrics as used
  1036→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));
  1037→
  1038→      // Calculate total impact from all metrics in this group
  1039→      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);
  1040→      rollingLost += totalImpact;
  1041→
  1042→      // Create grouped flaw with multiple contributing ratios
  1043→      flaws.push({
  1044→        id: `flaw_group_${groupId}`,
  1045→        flawName: groupConfig.name,
  1046→        summary: groupConfig.description,
  1047→        harmonyPercentageLost: totalImpact,
  1048→        standardizedImpact: totalImpact / 10,
  1049→        categoryName: groupConfig.category,
  1050→        responsibleRatios: groupMeasurements.map(m => ({
  1051→          ratioName: m.name,
  1052→          ratioId: m.metricId,
  1053→          score: m.score,
  1054→          value: m.value,
  1055→          idealMin: m.idealMin,
  1056→          idealMax: m.idealMax,
  1057→          unit: m.unit,
  1058→          category: m.category,
  1059→        })),
  1060→        rollingPointsDeducted: rollingLost,
  1061→        rollingHarmonyPercentageLost: rollingLost,
  1062→        rollingStandardizedImpact: rollingLost / 10,
  1063→      });
  1064→    }
  1065→  });
  1066→
  1067→  // Second pass: Add remaining individual flaws that weren't grouped
  1068→  analysis.flaws.forEach((f, i) => {
  1069→    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group
  1070→
  1071→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);
  1072→    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;
  1073→    rollingLost += impact;
  1074→
  1075→    flaws.push({
  1076→      id: `flaw_${i}`,
  1077→      flawName: f.metricName,
  1078→      summary: f.reasoning,
  1079→      harmonyPercentageLost: impact,
  1080→      standardizedImpact: impact / 10,
  1081→      categoryName: f.category,
  1082→      responsibleRatios: [{
  1083→        ratioName: f.metricName,
  1084→        ratioId: f.metricId,
  1085→        score: matchingMeasurement?.score || 3,
  1086→        value: matchingMeasurement?.value || 0,
  1087→        idealMin: matchingMeasurement?.idealMin || 0,
  1088→        idealMax: matchingMeasurement?.idealMax || 1,
  1089→        unit: matchingMeasurement?.unit || 'ratio',
  1090→        category: f.category,
  1091→      }],
  1092→      rollingPointsDeducted: rollingLost,
  1093→      rollingHarmonyPercentageLost: rollingLost,
  1094→      rollingStandardizedImpact: rollingLost / 10,
  1095→    });
  1096→  });
  1097→
  1098→  // Sort by impact (highest first) then by number of contributing ratios
  1099→  return flaws.sort((a, b) => {
  1100→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {
  1101→      return b.responsibleRatios.length - a.responsibleRatios.length;
  1102→    }
  1103→    return b.harmonyPercentageLost - a.harmonyPercentageLost;
  1104→  });
  1105→}
  1106→
  1107→// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions
  1108→// have been moved to @/lib/results/analysis.ts to reduce bundle size
  1109→// Import generateRecommendations from there instead
  1110→// ============================================
  1111→// CONTEXT CREATION
  1112→// ============================================
  1113→
  1114→const ResultsContext = createContext<ResultsContextType | null>(null);
  1115→
  1116→export function useResults(): ResultsContextType {
  1117→  const context = useContext(ResultsContext);
  1118→  if (!context) {
  1119→    throw new Error('useResults must be used within a ResultsProvider');
  1120→  }
  1121→  return context;
  1122→}
  1123→
  1124→interface ResultsProviderProps {
  1125→  children: ReactNode;
  1126→  initialData?: ResultsInputData;
  1127→}
  1128→
  1129→export function ResultsProvider({ children, initialData }: ResultsProviderProps) {
  1130→  // Raw data state
  1131→  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);
  1132→  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);
  1133→  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');
  1134→  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');
  1135→  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');
  1136→  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);
  1137→
  1138→  // UI state
  1139→  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');
  1140→  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);
  1141→  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);
  1142→  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);
  1143→  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);
  1144→
  1145→  // Compute analysis results (now with demographic-specific scoring)
  1146→  const analysisResults = useMemo(() => {
  1147→    if (frontLandmarks.length === 0) {
  1148→      return null;
  1149→    }
  1150→
  1151→    try {
  1152→      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);
  1153→      const sideAnalysis = sideLandmarks.length > 0
  1154→        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)
  1155→        : null;
  1156→      // analyzeHarmony expects landmarks directly, not analysis results
  1157→      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);
  1158→
  1159→      return { frontAnalysis, sideAnalysis, harmony };
  1160→    } catch (error) {
  1161→      console.error('Analysis error:', error);
  1162→      return null;
  1163→    }
  1164→  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);
  1165→
  1166→  // Transform to Ratio format
  1167→  const frontRatios = useMemo(() => {
  1168→    if (!analysisResults?.frontAnalysis) return [];
  1169→    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));
  1170→  }, [analysisResults, frontLandmarks]);
  1171→
  1172→  const sideRatios = useMemo(() => {
  1173→    if (!analysisResults?.sideAnalysis) return [];
  1174→    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));
  1175→  }, [analysisResults, sideLandmarks]);
  1176→
  1177→  // Generate strengths and flaws using INSIGHTS-BASED classification
  1178→  // This processes insights.json definitions: calculates avg score of affected metrics,
  1179→  // then classifies as strength (avg > threshold) or weakness (avg < threshold)
  1180→  const { insightStrengths, insightFlaws } = useMemo(() => {
  1181→    if (!analysisResults?.harmony) {
  1182→      return { insightStrengths: [], insightFlaws: [] };
  1183→    }
  1184→
  1185→    try {
  1186→      // Classify using insights engine
  1187→      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =
  1188→        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);
  1189→
  1190→      // Convert to UI-compatible types
  1191→      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));
  1192→
  1193→      let rollingLost = 0;
  1194→      const insightFlaws = classifiedWeaknesses.map((w, i) => {
  1195→        const flaw = convertToFlaw(w, i, rollingLost);
  1196→        rollingLost = flaw.rollingPointsDeducted || 0;
  1197→        return flaw;
  1198→      });
  1199→
  1200→      return { insightStrengths, insightFlaws };
  1201→    } catch (error) {
  1202→      console.error('[ResultsContext] Error in insights classification:', error);
  1203→      return { insightStrengths: [], insightFlaws: [] };
  1204→    }
  1205→  }, [analysisResults]);
  1206→
  1207→  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)
  1208→  const groupingStrengths = useMemo(() => {
  1209→    if (!analysisResults?.harmony) return [];
  1210→    return generateStrengthsFromAnalysis(analysisResults.harmony);
  1211→  }, [analysisResults]);
  1212→
  1213→  const groupingFlaws = useMemo(() => {
  1214→    if (!analysisResults?.harmony) return [];
  1215→    return generateFlawsFromAnalysis(analysisResults.harmony);
  1216→  }, [analysisResults]);
  1217→
  1218→  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)
  1219→  const strengths = useMemo(() => {
  1220→    // Use insights as primary source
  1221→    const usedMetricIds = new Set<string>();
  1222→    insightStrengths.forEach(s => {
  1223→      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));
  1224→    });
  1225→
  1226→    // Add grouping-based strengths that don't overlap
  1227→    const nonOverlappingGrouping = groupingStrengths.filter(gs => {
  1228→      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));
  1229→      return !overlap;
  1230→    });
  1231→
  1232→    return [...insightStrengths, ...nonOverlappingGrouping];
  1233→  }, [insightStrengths, groupingStrengths]);
  1234→
  1235→  const flaws = useMemo(() => {
  1236→    // Use insights as primary source
  1237→    const usedMetricIds = new Set<string>();
  1238→    insightFlaws.forEach(f => {
  1239→      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));
  1240→    });
  1241→
  1242→    // Add grouping-based flaws that don't overlap
  1243→    const nonOverlappingGrouping = groupingFlaws.filter(gf => {
  1244→      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));
  1245→      return !overlap;
  1246→    });
  1247→
  1248→    // Recalculate rolling totals for merged list
  1249→    let rollingLost = 0;
  1250→    const merged = [...insightFlaws, ...nonOverlappingGrouping];
  1251→    return merged.map(f => {
  1252→      rollingLost += f.harmonyPercentageLost;
  1253→      return {
  1254→        ...f,
  1255→        rollingPointsDeducted: rollingLost,
  1256→        rollingHarmonyPercentageLost: rollingLost,
  1257→        rollingStandardizedImpact: rollingLost / 10,
  1258→      };
  1259→    });
  1260→  }, [insightFlaws, groupingFlaws]);
  1261→
  1262→  // Generate recommendations with metric-aware matching and Bezier recalculation
  1263→  const recommendations = useMemo(() => {
  1264→    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);
  1265→  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);
  1266→
  1267→  // Build full harmony analysis
  1268→  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {
  1269→    if (!analysisResults?.harmony) return null;
  1270→
  1271→    return {
  1272→      standardizedScore: analysisResults.harmony.overallScore,
  1273→      front: {
  1274→        standardizedScore: analysisResults.harmony.frontScore,
  1275→        ratios: frontRatios,
  1276→      },
  1277→      side: {
  1278→        standardizedScore: analysisResults.harmony.sideScore,
  1279→        ratios: sideRatios,
  1280→      },
  1281→      strengths,
  1282→      flaws,
  1283→    };
  1284→  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);
  1285→
  1286→  // Calculate weighted harmony score using looksmax_engine.py algorithm
  1287→  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {
  1288→    if (!analysisResults?.harmony) return null;
  1289→
  1290→    const allMeasurements = analysisResults.harmony.measurements.map(m => ({
  1291→      metricId: m.metricId,
  1292→      standardizedScore: m.standardizedScore,
  1293→    }));
  1294→
  1295→    return calculateHarmonyScore(allMeasurements);
  1296→  }, [analysisResults]);
  1297→
  1298→  // Get top 3 and bottom 3 metrics with advice
  1299→  const topMetrics = useMemo((): RankedMetric[] => {
  1300→    if (!analysisResults?.harmony) return [];
  1301→    return getTopMetrics(analysisResults.harmony.measurements, 3);
  1302→  }, [analysisResults]);
  1303→
  1304→  const bottomMetrics = useMemo((): RankedMetric[] => {
  1305→    if (!analysisResults?.harmony) return [];
  1306→    return getBottomMetrics(analysisResults.harmony.measurements, 3);
  1307→  }, [analysisResults]);
  1308→
  1309→  // Scores - now using weighted harmony
  1310→  const harmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;
  1311→  const overallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;
  1312→  const frontScore = analysisResults?.harmony?.frontScore || 0;
  1313→  const sideScore = analysisResults?.harmony?.sideScore || 0;
  1314→
  1315→  // PSL Rating (1-10 scale with tier/percentile)
  1316→  const pslRating = useMemo(() => {
  1317→    return harmonyToPSL(harmonyPercentage);
  1318→  }, [harmonyPercentage]);
  1319→
  1320→  // Action to set all results data
  1321→  const setResultsData = useCallback((data: ResultsInputData) => {
  1322→    setFrontLandmarks(data.frontLandmarks);
  1323→    setSideLandmarks(data.sideLandmarks);
  1324→    setFrontPhoto(data.frontPhoto);
  1325→    setSidePhoto(data.sidePhoto || null);
  1326→    setGender(data.gender);
  1327→    setEthnicity(data.ethnicity || 'other');
  1328→  }, []);
  1329→
  1330→  // Memoize context value to prevent unnecessary re-renders
  1331→  const value = useMemo<ResultsContextType>(() => ({
  1332→    frontLandmarks,
  1333→    sideLandmarks,
  1334→    gender,
  1335→    ethnicity,
  1336→    frontPhoto,
  1337→    sidePhoto,
  1338→    harmonyAnalysis,
  1339→    frontRatios,
  1340→    sideRatios,
  1341→    strengths,
  1342→    flaws,
  1343→    recommendations,
  1344→    overallScore,
  1345→    frontScore,
  1346→    sideScore,
  1347→    // Weighted harmony from looksmax_engine.py
  1348→    harmonyScoreResult,
  1349→    harmonyPercentage,
  1350→    topMetrics,
  1351→    bottomMetrics,
  1352→    // PSL Rating
  1353→    pslRating,
  1354→    // UI state
  1355→    activeTab,
  1356→    setActiveTab,
  1357→    expandedMeasurementId,
  1358→    setExpandedMeasurementId,
  1359→    selectedVisualizationMetric,
  1360→    setSelectedVisualizationMetric,
  1361→    categoryFilter,
  1362→    setCategoryFilter,
  1363→    showLandmarkOverlay,
  1364→    setShowLandmarkOverlay,
  1365→    setResultsData,
  1366→  }), [
  1367→    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,
  1368→    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,
  1369→    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,
  1370→    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,
  1371→    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,
  1372→    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,
  1373→    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,
  1374→  ]);
  1375→
  1376→  return (
  1377→    <ResultsContext.Provider value={value}>
  1378→      {children}
  1379→    </ResultsContext.Provider>
  1380→  );
  1381→}
  1382→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
