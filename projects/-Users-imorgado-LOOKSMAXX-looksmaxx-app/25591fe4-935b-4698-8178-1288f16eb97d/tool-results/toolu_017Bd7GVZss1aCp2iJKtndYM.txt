     1→"""
     2→Mention Service - Extract and process @mentions from content
     3→
     4→Features:
     5→- Extract @username patterns from text
     6→- Resolve usernames to user objects
     7→- Create notifications for mentioned users
     8→"""
     9→
    10→import re
    11→from typing import List, Optional
    12→from uuid import UUID
    13→from sqlalchemy.ext.asyncio import AsyncSession
    14→from sqlalchemy import select
    15→
    16→from app.models.user import User
    17→
    18→# Pattern for @mentions: @username where username is 3-30 alphanumeric or underscore chars
    19→# - Positive lookbehind ensures @ is preceded by whitespace or is at start of string
    20→# - Negative lookahead ensures we don't match partial usernames (e.g., @john shouldn't match @johnson)
    21→# This prevents matching email addresses like user@domain.com
    22→MENTION_PATTERN = re.compile(r'(?:^|(?<=\s))@([a-zA-Z0-9_]{3,30})(?![a-zA-Z0-9_])')
    23→
    24→
    25→def extract_mentions(content: str) -> List[str]:
    26→    """Extract all @mentions from content.
    27→
    28→    Args:
    29→        content: The text content to search for mentions
    30→
    31→    Returns:
    32→        List of unique usernames (without @ prefix)
    33→    """
    34→    if not content:
    35→        return []
    36→
    37→    matches = MENTION_PATTERN.findall(content)
    38→    # Return unique usernames, preserving order
    39→    seen = set()
    40→    unique = []
    41→    for username in matches:
    42→        lower = username.lower()
    43→        if lower not in seen:
    44→            seen.add(lower)
    45→            unique.append(username)
    46→    return unique
    47→
    48→
    49→async def resolve_mentions(
    50→    usernames: List[str],
    51→    db: AsyncSession
    52→) -> List[User]:
    53→    """Resolve a list of usernames to user objects.
    54→
    55→    Args:
    56→        usernames: List of usernames to look up
    57→        db: Database session
    58→
    59→    Returns:
    60→        List of User objects that exist and are not banned
    61→    """
    62→    if not usernames:
    63→        return []
    64→
    65→    # Case-insensitive lookup using func.lower for PostgreSQL compatibility
    66→    from sqlalchemy import func, or_
    67→
    68→    # Build OR conditions for case-insensitive username matching
    69→    conditions = [func.lower(User.username) == u.lower() for u in usernames]
    70→
    71→    query = select(User).where(
    72→        or_(*conditions),
    73→        User.is_banned == False
    74→    )
    75→
    76→    result = await db.execute(query)
    77→    users = result.scalars().all()
    78→
    79→    return list(users)
    80→
    81→
    82→async def get_mentioned_users(
    83→    content: str,
    84→    db: AsyncSession,
    85→    exclude_user_id: Optional[UUID] = None
    86→) -> List[User]:
    87→    """Extract mentions from content and resolve to users.
    88→
    89→    This is a convenience function that combines extract_mentions and resolve_mentions.
    90→
    91→    Args:
    92→        content: The text content to search for mentions
    93→        db: Database session
    94→        exclude_user_id: Optional user ID to exclude (e.g., the author)
    95→
    96→    Returns:
    97→        List of User objects for valid mentions (excluding the author if specified)
    98→    """
    99→    usernames = extract_mentions(content)
   100→    if not usernames:
   101→        return []
   102→
   103→    users = await resolve_mentions(usernames, db)
   104→
   105→    # Exclude the author if specified (can't mention yourself)
   106→    if exclude_user_id:
   107→        users = [u for u in users if u.id != exclude_user_id]
   108→
   109→    return users
   110→
   111→
   112→async def create_mention_notifications(
   113→    content_id: UUID,
   114→    content_type: str,  # "post" or "comment"
   115→    author_id: UUID,
   116→    author_username: str,
   117→    mentioned_users: List[User],
   118→    db: AsyncSession
   119→) -> int:
   120→    """Create notifications for mentioned users.
   121→
   122→    Note: This is a placeholder. In a full implementation, you would:
   123→    1. Have a notifications table
   124→    2. Create notification records for each mentioned user
   125→    3. Optionally send push notifications or emails
   126→
   127→    For now, we'll just return the count of notifications that would be created.
   128→
   129→    Args:
   130→        content_id: ID of the post or comment
   131→        content_type: "post" or "comment"
   132→        author_id: ID of the content author
   133→        author_username: Username of the author
   134→        mentioned_users: List of users who were mentioned
   135→        db: Database session
   136→
   137→    Returns:
   138→        Number of notifications created
   139→    """
   140→    # Filter out the author from notifications
   141→    users_to_notify = [u for u in mentioned_users if u.id != author_id]
   142→
   143→    if not users_to_notify:
   144→        return 0
   145→
   146→    # TODO: Create actual notification records when notifications table is added
   147→    # For now, just return the count
   148→    #
   149→    # Example implementation:
   150→    # for user in users_to_notify:
   151→    #     notification = Notification(
   152→    #         user_id=user.id,
   153→    #         type="mention",
   154→    #         content_type=content_type,
   155→    #         content_id=content_id,
   156→    #         message=f"@{author_username} mentioned you in a {content_type}",
   157→    #         is_read=False
   158→    #     )
   159→    #     db.add(notification)
   160→    # await db.commit()
   161→
   162→    return len(users_to_notify)
   163→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
