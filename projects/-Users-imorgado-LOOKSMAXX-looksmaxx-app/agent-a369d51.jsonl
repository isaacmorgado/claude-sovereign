{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":"URGENT BUG: Contributing ratios (short midface, high cheekbones) still go over 10/10 despite previous clamping fixes.\n\nFiles to check and fix:\n- src/lib/scoring/calculator.ts - standardizeScore, calculateMetricScore\n- src/contexts/ResultsContext.tsx - transformToRatio\n- src/lib/looksmax-scoring.ts - calculateHarmonyScore\n- src/components/results/tabs/OverviewTab.tsx - score display\n\nPrevious fixes added clamping but scores still exceed 10. Find WHERE the unclamped values are leaking through and add proper clamping at ALL exit points.\n\nTest by checking if any score > 10 can occur. Fix the bug, verify with lint/tsc."},"uuid":"df117ad7-ad29-408d-bdb2-2726d52785ec","timestamp":"2025-12-26T06:49:24.791Z"}
{"parentUuid":"df117ad7-ad29-408d-bdb2-2726d52785ec","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ErHNCj77VgMAFPdgQsaLq7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016KseGbGu3gsCb8bwewSBuS","name":"TodoWrite","input":{"todos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"in_progress","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"pending","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"pending","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"pending","activeForm":"Verifying fix with lint and tsc"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21714,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":21714,"ephemeral_1h_input_tokens":0},"output_tokens":201,"service_tier":"standard"}},"requestId":"req_011CWUrRSMcQdMZczg53Jzmq","type":"assistant","uuid":"c6da3ddd-70df-44aa-b716-ccfc16296686","timestamp":"2025-12-26T06:49:31.927Z"}
{"parentUuid":"c6da3ddd-70df-44aa-b716-ccfc16296686","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016KseGbGu3gsCb8bwewSBuS","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"f8ab2165-d0fe-47dd-b638-4a596d2c80d5","timestamp":"2025-12-26T06:49:31.962Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"in_progress","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"pending","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"pending","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"pending","activeForm":"Verifying fix with lint and tsc"}]}}
{"parentUuid":"f8ab2165-d0fe-47dd-b638-4a596d2c80d5","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HQV72Mdu7Y3rGVHdtDkV7P","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AieX1Tdvdjg3ekCd2wRR1K","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/calculator.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":240,"cache_read_input_tokens":21714,"cache_creation":{"ephemeral_5m_input_tokens":240,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWUrRy44nBA2HWr5pkTRJ","type":"assistant","uuid":"0f31b5ac-1e57-44db-876a-47d51887a309","timestamp":"2025-12-26T06:49:36.925Z"}
{"parentUuid":"0f31b5ac-1e57-44db-876a-47d51887a309","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HQV72Mdu7Y3rGVHdtDkV7P","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WBz76ih2UfrMqqTeJB37VZ","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":240,"cache_read_input_tokens":21714,"cache_creation":{"ephemeral_5m_input_tokens":240,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWUrRy44nBA2HWr5pkTRJ","type":"assistant","uuid":"b62b65f6-b6cd-446a-a1a9-9dc2d04fe089","timestamp":"2025-12-26T06:49:37.639Z"}
{"parentUuid":"b62b65f6-b6cd-446a-a1a9-9dc2d04fe089","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HQV72Mdu7Y3rGVHdtDkV7P","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MmfqqH2i4hjDsUJXexV6k7","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/looksmax-scoring.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":240,"cache_read_input_tokens":21714,"cache_creation":{"ephemeral_5m_input_tokens":240,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWUrRy44nBA2HWr5pkTRJ","type":"assistant","uuid":"f1b2c4ff-3a88-4e06-a274-bac7b2c3c772","timestamp":"2025-12-26T06:49:38.390Z"}
{"parentUuid":"f1b2c4ff-3a88-4e06-a274-bac7b2c3c772","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HQV72Mdu7Y3rGVHdtDkV7P","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01THur9BN6oJ1QZU95hwZpCi","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":240,"cache_read_input_tokens":21714,"cache_creation":{"ephemeral_5m_input_tokens":240,"ephemeral_1h_input_tokens":0},"output_tokens":280,"service_tier":"standard"}},"requestId":"req_011CWUrRy44nBA2HWr5pkTRJ","type":"assistant","uuid":"ed1ae667-c004-402d-b06c-fff92aace468","timestamp":"2025-12-26T06:49:39.105Z"}
{"parentUuid":"ed1ae667-c004-402d-b06c-fff92aace468","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MmfqqH2i4hjDsUJXexV6k7","type":"tool_result","content":"     1→/**\n     2→ * LOOKSMAX Scoring Engine\n     3→ * Ported from looksmax_engine.py - Presentation Layer\n     4→ *\n     5→ * Features:\n     6→ * - Weighted Harmony Score calculation (3.0x, 2.0x, 1.0x tiers)\n     7→ * - Metric-specific advice generation\n     8→ * - Gaussian scoring with exponential decay\n     9→ */\n    10→\n    11→import type { MetricScoreResult, QualityTier, SeverityLevel } from './harmony-scoring';\n    12→\n    13→// =============================================================================\n    14→// HARMONY SCORE WEIGHTS\n    15→// =============================================================================\n    16→\n    17→/**\n    18→ * High Impact Metrics (3.0x weight)\n    19→ * Core facial harmony indicators that have the greatest effect on overall attractiveness\n    20→ */\n    21→export const HIGH_IMPACT_METRICS = new Set([\n    22→  'faceWidthToHeight',\n    23→  'midfaceRatio',\n    24→  'lateralCanthalTilt',\n    25→  'gonialAngle',\n    26→  'mandibularPlaneAngle',\n    27→  'chinToPhiltrumRatio',\n    28→]);\n    29→\n    30→/**\n    31→ * Medium Impact Metrics (2.0x weight)\n    32→ * Secondary aesthetic factors\n    33→ */\n    34→export const MEDIUM_IMPACT_METRICS = new Set([\n    35→  'noseBridgeToNoseWidth',\n    36→  'nasolabialAngle',\n    37→  'cheekboneHeight',\n    38→  'ramusToMandibleRatio',\n    39→]);\n    40→\n    41→/**\n    42→ * Get the weight multiplier for a metric\n    43→ */\n    44→export function getMetricWeight(metricId: string): number {\n    45→  if (HIGH_IMPACT_METRICS.has(metricId)) return 3.0;\n    46→  if (MEDIUM_IMPACT_METRICS.has(metricId)) return 2.0;\n    47→  return 1.0;\n    48→}\n    49→\n    50→/**\n    51→ * Get weight tier name for display\n    52→ */\n    53→export function getWeightTier(metricId: string): 'high' | 'medium' | 'standard' {\n    54→  if (HIGH_IMPACT_METRICS.has(metricId)) return 'high';\n    55→  if (MEDIUM_IMPACT_METRICS.has(metricId)) return 'medium';\n    56→  return 'standard';\n    57→}\n    58→\n    59→// =============================================================================\n    60→// WEIGHTED HARMONY SCORE CALCULATION\n    61→// =============================================================================\n    62→\n    63→export interface HarmonyScoreResult {\n    64→  /** Weighted harmony percentage (0-100%) */\n    65→  harmonyPercentage: number;\n    66→  /** Weighted average score (0-10 scale) */\n    67→  weightedAverage: number;\n    68→  /** Unweighted average for comparison */\n    69→  unweightedAverage: number;\n    70→  /** Breakdown by weight tier */\n    71→  weightDistribution: {\n    72→    highImpact: { count: number; avgScore: number };\n    73→    mediumImpact: { count: number; avgScore: number };\n    74→    standard: { count: number; avgScore: number };\n    75→  };\n    76→}\n    77→\n    78→/**\n    79→ * Calculate the weighted Harmony Score from scored measurements.\n    80→ * Uses 3-tier weighting: High (3x), Medium (2x), Standard (1x)\n    81→ *\n    82→ * Formula: Σ(Score × Weight) / Σ(Weights) → percentage\n    83→ */\n    84→export function calculateHarmonyScore(\n    85→  measurements: Array<{ metricId: string; standardizedScore: number }>\n    86→): HarmonyScoreResult {\n    87→  let totalWeightedScore = 0;\n    88→  let totalWeight = 0;\n    89→  let unweightedTotal = 0;\n    90→\n    91→  const tiers = {\n    92→    high: { total: 0, count: 0 },\n    93→    medium: { total: 0, count: 0 },\n    94→    standard: { total: 0, count: 0 },\n    95→  };\n    96→\n    97→  for (const m of measurements) {\n    98→    const weight = getMetricWeight(m.metricId);\n    99→    const tier = getWeightTier(m.metricId);\n   100→\n   101→    totalWeightedScore += m.standardizedScore * weight;\n   102→    totalWeight += weight;\n   103→    unweightedTotal += m.standardizedScore;\n   104→\n   105→    tiers[tier].total += m.standardizedScore;\n   106→    tiers[tier].count++;\n   107→  }\n   108→\n   109→  const rawWeightedAverage = totalWeight > 0 ? totalWeightedScore / totalWeight : 0;\n   110→  const rawUnweightedAverage = measurements.length > 0 ? unweightedTotal / measurements.length : 0;\n   111→\n   112→  // Clamp averages to 0-10 range to prevent any edge case overflows\n   113→  const weightedAverage = Math.max(0, Math.min(10, rawWeightedAverage));\n   114→  const unweightedAverage = Math.max(0, Math.min(10, rawUnweightedAverage));\n   115→  const harmonyPercentage = Math.max(0, Math.min(100, (weightedAverage / 10) * 100));\n   116→\n   117→  // Helper to clamp tier averages to 0-10\n   118→  const clampAvg = (total: number, count: number): number => {\n   119→    if (count === 0) return 0;\n   120→    return Math.max(0, Math.min(10, total / count));\n   121→  };\n   122→\n   123→  return {\n   124→    harmonyPercentage,\n   125→    weightedAverage,\n   126→    unweightedAverage,\n   127→    weightDistribution: {\n   128→      highImpact: {\n   129→        count: tiers.high.count,\n   130→        avgScore: clampAvg(tiers.high.total, tiers.high.count),\n   131→      },\n   132→      mediumImpact: {\n   133→        count: tiers.medium.count,\n   134→        avgScore: clampAvg(tiers.medium.total, tiers.medium.count),\n   135→      },\n   136→      standard: {\n   137→        count: tiers.standard.count,\n   138→        avgScore: clampAvg(tiers.standard.total, tiers.standard.count),\n   139→      },\n   140→    },\n   141→  };\n   142→}\n   143→\n   144→// =============================================================================\n   145→// ADVICE ENGINE - METRIC-SPECIFIC FEEDBACK STRINGS\n   146→// =============================================================================\n   147→\n   148→interface AdviceEntry {\n   149→  tooHigh: string;\n   150→  tooLow: string;\n   151→}\n   152→\n   153→/**\n   154→ * Comprehensive advice database for all metrics\n   155→ * Keys match metric IDs from harmony-scoring.ts\n   156→ */\n   157→export const ADVICE_DATABASE: Record<string, AdviceEntry> = {\n   158→  // === HIGH IMPACT METRICS ===\n   159→  faceWidthToHeight: {\n   160→    tooHigh: \"Face appears wider. Consider hairstyles that add vertical length.\",\n   161→    tooLow: \"Face is elongated. Hairstyles with side volume can add balance.\",\n   162→  },\n   163→  midfaceRatio: {\n   164→    tooHigh: \"Midface is elongated. This can project maturity but may benefit from framing.\",\n   165→    tooLow: \"Midface is compact. This is often a dimorphic and youthful trait.\",\n   166→  },\n   167→  lateralCanthalTilt: {\n   168→    tooHigh: \"Eyes have significant positive tilt. Very dimorphic - no action needed.\",\n   169→    tooLow: \"Eyes have negative tilt. Consider brow-maxxing or temporal area work.\",\n   170→  },\n   171→  gonialAngle: {\n   172→    tooHigh: \"Jaw angle is steep (obtuse). Lowering body fat or chewing hard gum may improve definition.\",\n   173→    tooLow: \"Jaw angle is very sharp. Strong masculine trait - no action typically needed.\",\n   174→  },\n   175→  mandibularPlaneAngle: {\n   176→    tooHigh: \"Steep mandibular plane (long face type). May benefit from mewing or jaw work.\",\n   177→    tooLow: \"Flat mandibular plane. This is typically a favorable trait.\",\n   178→  },\n   179→  chinToPhiltrumRatio: {\n   180→    tooHigh: \"Chin is long relative to philtrum. Generally masculine; no action needed.\",\n   181→    tooLow: \"Philtrum is long relative to chin. Upper lip lifting or chin augmentation options exist.\",\n   182→  },\n   183→\n   184→  // === MEDIUM IMPACT METRICS ===\n   185→  noseBridgeToNoseWidth: {\n   186→    tooHigh: \"Nose appears narrow relative to bridge. This is typically favorable.\",\n   187→    tooLow: \"Nose is wide relative to bridge. Nostril work can refine proportions.\",\n   188→  },\n   189→  nasolabialAngle: {\n   190→    tooHigh: \"Nose tip points upward. Can appear more feminine; tip refinement may help.\",\n   191→    tooLow: \"Nose tip points downward (droopy). Tip rotation procedures can improve profile.\",\n   192→  },\n   193→  cheekboneHeight: {\n   194→    tooHigh: \"Cheekbones are exceptionally high. Very aesthetic - no action needed.\",\n   195→    tooLow: \"Cheekbones are lower set. Malar augmentation or filler can enhance projection.\",\n   196→  },\n   197→  cheekFullness: {\n   198→    tooHigh: \"Very full cheeks. Consider facial contouring if seeking a leaner look.\",\n   199→    tooLow: \"Hollow or gaunt cheeks. Malar filler or fat grafting can restore volume.\",\n   200→  },\n   201→  ramusToMandibleRatio: {\n   202→    tooHigh: \"Short mandibular body. Jaw angle implants may improve proportions.\",\n   203→    tooLow: \"Long mandibular body. This is typically favorable for facial width.\",\n   204→  },\n   205→\n   206→  // === FRONT PROFILE METRICS ===\n   207→  jawSlope: {\n   208→    tooHigh: \"Jaw slopes steeply. Consider gonial angle enhancement.\",\n   209→    tooLow: \"Jaw has minimal slope. Strong horizontal projection is present.\",\n   210→  },\n   211→  totalFacialWidthToHeight: {\n   212→    tooHigh: \"Face is very wide relative to height. Can appear robust/masculine.\",\n   213→    tooLow: \"Face is very tall relative to width. Hairstyles with width can balance.\",\n   214→  },\n   215→  mouthWidthToNoseRatio: {\n   216→    tooHigh: \"Wide mouth relative to nose. Typically attractive; no action needed.\",\n   217→    tooLow: \"Narrow mouth relative to nose. Lip exercises may help.\",\n   218→  },\n   219→  lowerThirdProportion: {\n   220→    tooHigh: \"Lower face is long. May benefit from vertical reduction options.\",\n   221→    tooLow: \"Lower face is short. Chin augmentation can add vertical height.\",\n   222→  },\n   223→  ipsilateralAlarAngle: {\n   224→    tooHigh: \"Nostril angle is wide. Alar reduction may refine the nose.\",\n   225→    tooLow: \"Nostril angle is narrow. Typically favorable; no action needed.\",\n   226→  },\n   227→  jawFrontalAngle: {\n   228→    tooHigh: \"Jaw is V-shaped. Gonial angle widening may add presence.\",\n   229→    tooLow: \"Jaw is very U-shaped/wide. Strong masculine trait.\",\n   230→  },\n   231→  eyeAspectRatio: {\n   232→    tooHigh: \"Eyes are horizontally elongated. Hunter eyes are typically desirable.\",\n   233→    tooLow: \"Eyes are more round. Lateral canthoplasty can elongate.\",\n   234→  },\n   235→  bitemporalWidth: {\n   236→    tooHigh: \"Wide temples relative to face. Full head of hair can balance.\",\n   237→    tooLow: \"Narrow temples. Can appear more refined/gracile.\",\n   238→  },\n   239→  eyebrowLowSetedness: {\n   240→    tooHigh: \"Brows are low-set (hooded). Creates intense look; browlift if too heavy.\",\n   241→    tooLow: \"Brows are high-set. More open look; brow products can add fullness.\",\n   242→  },\n   243→  eyeSeparationRatio: {\n   244→    tooHigh: \"Eyes are widely set. Creates softer look; no action typically needed.\",\n   245→    tooLow: \"Eyes are closely set. Can appear intense; glasses can balance.\",\n   246→  },\n   247→  bigonialWidth: {\n   248→    tooHigh: \"Wide jaw relative to cheekbones. Strong masculine trait.\",\n   249→    tooLow: \"Narrow jaw relative to cheekbones. Jaw angle widening may add presence.\",\n   250→  },\n   251→  lowerToUpperLipRatio: {\n   252→    tooHigh: \"Lower lip is much fuller. Very aesthetic; no action needed.\",\n   253→    tooLow: \"Upper lip is fuller. Standard proportion; lip flip may balance.\",\n   254→  },\n   255→  eyebrowTilt: {\n   256→    tooHigh: \"Brows tilt significantly upward. Can appear expressive.\",\n   257→    tooLow: \"Brows are flat or downturned. Can appear more stoic.\",\n   258→  },\n   259→\n   260→  // === SIDE PROFILE METRICS ===\n   261→  recessionRelativeToFrankfort: {\n   262→    tooHigh: \"Significant lower jaw recession. Advancement surgery may help.\",\n   263→    tooLow: \"Jaw projects forward strongly. Very masculine; monitor overbite.\",\n   264→  },\n   265→  facialDepthToHeightRatio: {\n   266→    tooHigh: \"Face is very deep relative to height. Strong forward growth.\",\n   267→    tooLow: \"Face is flat relative to height. May benefit from midface/chin work.\",\n   268→  },\n   269→  interiorMidfaceProjectionAngle: {\n   270→    tooHigh: \"Midface projects significantly. Strong forward growth.\",\n   271→    tooLow: \"Flat midface. Cheekbone augmentation may improve profile.\",\n   272→  },\n   273→  nasofrontalAngle: {\n   274→    tooHigh: \"Deep nasofrontal angle. Creates dramatic brow/nose transition.\",\n   275→    tooLow: \"Shallow nasofrontal angle. Brow work may add definition.\",\n   276→  },\n   277→  gonionToMouthLine: {\n   278→    tooHigh: \"Gonion is low relative to mouth. May appear long-faced.\",\n   279→    tooLow: \"Gonion is high relative to mouth. Compact proportions.\",\n   280→  },\n   281→  lowerLipSLinePosition: {\n   282→    tooHigh: \"Lower lip protrudes past S-line. May indicate maxillary retrusion.\",\n   283→    tooLow: \"Lower lip is behind S-line. Well-balanced profile.\",\n   284→  },\n   285→  zAngle: {\n   286→    tooHigh: \"Profile is very upright/vertical. May appear flat.\",\n   287→    tooLow: \"Profile is convex. Standard Western ideal.\",\n   288→  },\n   289→  nasomentaAngle: {\n   290→    tooHigh: \"Nose-chin line is obtuse. May indicate weak chin.\",\n   291→    tooLow: \"Nose-chin line is acute. Strong chin projection.\",\n   292→  },\n   293→  submentalCervicalAngle: {\n   294→    tooHigh: \"Weak chin-neck angle. May benefit from submental lipo or implant.\",\n   295→    tooLow: \"Sharp chin-neck angle. Excellent definition.\",\n   296→  },\n   297→  nasofacialAngle: {\n   298→    tooHigh: \"Large angle between nose and face. Strong nose or recessed face.\",\n   299→    tooLow: \"Small angle. Well-integrated nose.\",\n   300→  },\n   301→  holdawayHLine: {\n   302→    tooHigh: \"Lips project significantly. Monitor for bimax protrusion.\",\n   303→    tooLow: \"Flat lip line. May appear retruded; filler can add volume.\",\n   304→  },\n   305→  mentolabialAngle: {\n   306→    tooHigh: \"Deep mentolabial fold. Can appear aged; filler can soften.\",\n   307→    tooLow: \"Shallow mentolabial fold. Youthful and balanced.\",\n   308→  },\n   309→  eLineLowerLip: {\n   310→    tooHigh: \"Lower lip protrudes past E-line. May benefit from orthodontics.\",\n   311→    tooLow: \"Lower lip is behind E-line. Balanced or retruded.\",\n   312→  },\n   313→  eLineUpperLip: {\n   314→    tooHigh: \"Upper lip protrudes past E-line. May benefit from orthodontics.\",\n   315→    tooLow: \"Upper lip is behind E-line. Balanced or retruded.\",\n   316→  },\n   317→  nasalTipAngle: {\n   318→    tooHigh: \"Nose tip is rotated upward. Can appear feminine.\",\n   319→    tooLow: \"Nose tip droops. Tip rotation surgery can improve.\",\n   320→  },\n   321→  nasalProjection: {\n   322→    tooHigh: \"Large nose projection. Reduction rhinoplasty may refine.\",\n   323→    tooLow: \"Minimal nose projection. Augmentation rhinoplasty may enhance.\",\n   324→  },\n   325→  nasalWToHRatio: {\n   326→    tooHigh: \"Wide nose relative to height. Narrowing procedures exist.\",\n   327→    tooLow: \"Narrow nose. Typically favorable; no action needed.\",\n   328→  },\n   329→  facialConvexityGlabella: {\n   330→    tooHigh: \"Convex profile. Strong midface projection.\",\n   331→    tooLow: \"Flat or concave profile. May benefit from augmentation.\",\n   332→  },\n   333→  facialConvexityNasion: {\n   334→    tooHigh: \"Convex profile from nasion. Good forward growth.\",\n   335→    tooLow: \"Straight or concave profile. May appear flat.\",\n   336→  },\n   337→  totalFacialConvexity: {\n   338→    tooHigh: \"Very convex total profile. Midface is prominent.\",\n   339→    tooLow: \"Flat total profile. Forward growth options may help.\",\n   340→  },\n   341→  upperForeheadSlope: {\n   342→    tooHigh: \"Sloped forehead. More masculine/primal appearance.\",\n   343→    tooLow: \"Upright forehead. More neotenous appearance.\",\n   344→  },\n   345→  browridgeInclinationAngle: {\n   346→    tooHigh: \"Prominent browridge angle. Strong masculine trait.\",\n   347→    tooLow: \"Flat browridge. Implants can add definition.\",\n   348→  },\n   349→  upperThirdProportion: {\n   350→    tooHigh: \"Upper third is long. Large forehead; can be offset with hair styling.\",\n   351→    tooLow: \"Upper third is short. Compact proportions.\",\n   352→  },\n   353→  middleThirdProportion: {\n   354→    tooHigh: \"Middle third is long. May appear long-faced.\",\n   355→    tooLow: \"Middle third is short. Compact midface.\",\n   356→  },\n   357→  chinProjection: {\n   358→    tooHigh: \"Strong chin projection. Very masculine trait.\",\n   359→    tooLow: \"Weak chin projection. Genioplasty or implant can improve.\",\n   360→  },\n   361→  lipRatio: {\n   362→    tooHigh: \"Full lips. Typically attractive; no action needed.\",\n   363→    tooLow: \"Thin lips. Filler can add volume if desired.\",\n   364→  },\n   365→};\n   366→\n   367→/**\n   368→ * Generate personalized advice based on metric score and value position.\n   369→ *\n   370→ * @param metricId - The metric identifier\n   371→ * @param score - Score from 0-10\n   372→ * @param value - Actual measured value\n   373→ * @param idealMin - Minimum of ideal range\n   374→ * @param idealMax - Maximum of ideal range\n   375→ * @returns Advice string for the metric\n   376→ */\n   377→export function generateAdvice(\n   378→  metricId: string,\n   379→  score: number,\n   380→  value: number,\n   381→  idealMin: number,\n   382→  idealMax: number\n   383→): string {\n   384→  // Perfect score - no action needed\n   385→  if (score >= 9.0) {\n   386→    return \"Ideal proportions. No action needed.\";\n   387→  }\n   388→\n   389→  // Get advice from database\n   390→  const advice = ADVICE_DATABASE[metricId];\n   391→  if (advice) {\n   392→    if (value > idealMax) {\n   393→      return advice.tooHigh;\n   394→    } else if (value < idealMin) {\n   395→      return advice.tooLow;\n   396→    }\n   397→  }\n   398→\n   399→  // Default fallback\n   400→  if (value > idealMax) {\n   401→    return `Value (${value.toFixed(2)}) is above the ideal range of ${idealMin.toFixed(1)}-${idealMax.toFixed(1)}.`;\n   402→  } else if (value < idealMin) {\n   403→    return `Value (${value.toFixed(2)}) is below the ideal range of ${idealMin.toFixed(1)}-${idealMax.toFixed(1)}.`;\n   404→  } else {\n   405→    return \"Value is within acceptable range but not optimal.\";\n   406→  }\n   407→}\n   408→\n   409→/**\n   410→ * Generate advice for a metric score result\n   411→ */\n   412→export function generateAdviceFromResult(result: MetricScoreResult): string {\n   413→  return generateAdvice(\n   414→    result.metricId,\n   415→    result.standardizedScore,\n   416→    result.value,\n   417→    result.idealMin,\n   418→    result.idealMax\n   419→  );\n   420→}\n   421→\n   422→// =============================================================================\n   423→// GAUSSIAN SCORING (matches Python implementation)\n   424→// =============================================================================\n   425→\n   426→/**\n   427→ * Calculate a score from 0-10 using Gaussian decay.\n   428→ * Matches the Python looksmax_engine.py implementation.\n   429→ *\n   430→ * @param value - The measured value\n   431→ * @param minRange - Minimum of ideal range\n   432→ * @param maxRange - Maximum of ideal range\n   433→ * @returns Score from 0-10\n   434→ */\n   435→export function calculateGaussianScore(\n   436→  value: number,\n   437→  minRange: number,\n   438→  maxRange: number\n   439→): number {\n   440→  // Within ideal range = perfect score\n   441→  if (value >= minRange && value <= maxRange) {\n   442→    return 10.0;\n   443→  }\n   444→\n   445→  let deviation: number;\n   446→  let target: number;\n   447→\n   448→  if (value < minRange) {\n   449→    deviation = minRange - value;\n   450→    target = minRange;\n   451→  } else {\n   452→    deviation = value - maxRange;\n   453→    target = maxRange;\n   454→  }\n   455→\n   456→  // Prevent division by zero\n   457→  if (target === 0) target = 1.0;\n   458→\n   459→  // Sigma is 10% of target value\n   460→  let sigma = Math.abs(target) * 0.1;\n   461→  if (sigma === 0) sigma = 1.0;\n   462→\n   463→  // Gaussian decay\n   464→  const score = 10.0 * Math.exp(-0.5 * Math.pow(deviation / sigma, 2));\n   465→  return Math.max(0.0, Math.min(10.0, score));\n   466→}\n   467→\n   468→// =============================================================================\n   469→// TOP/BOTTOM METRICS IDENTIFICATION\n   470→// =============================================================================\n   471→\n   472→export interface RankedMetric {\n   473→  metricId: string;\n   474→  name: string;\n   475→  value: number;\n   476→  score: number;\n   477→  idealMin: number;\n   478→  idealMax: number;\n   479→  advice: string;\n   480→  weightTier: 'high' | 'medium' | 'standard';\n   481→  category: string;\n   482→}\n   483→\n   484→/**\n   485→ * Get the top N metrics (strengths) sorted by score descending\n   486→ */\n   487→export function getTopMetrics(\n   488→  measurements: MetricScoreResult[],\n   489→  count: number = 3\n   490→): RankedMetric[] {\n   491→  return [...measurements]\n   492→    .sort((a, b) => b.standardizedScore - a.standardizedScore)\n   493→    .slice(0, count)\n   494→    .map((m) => ({\n   495→      metricId: m.metricId,\n   496→      name: m.name,\n   497→      value: m.value,\n   498→      score: m.standardizedScore,\n   499→      idealMin: m.idealMin,\n   500→      idealMax: m.idealMax,\n   501→      advice: generateAdviceFromResult(m),\n   502→      weightTier: getWeightTier(m.metricId),\n   503→      category: m.category,\n   504→    }));\n   505→}\n   506→\n   507→/**\n   508→ * Get the bottom N metrics (areas to improve) sorted by score ascending\n   509→ */\n   510→export function getBottomMetrics(\n   511→  measurements: MetricScoreResult[],\n   512→  count: number = 3\n   513→): RankedMetric[] {\n   514→  return [...measurements]\n   515→    .sort((a, b) => a.standardizedScore - b.standardizedScore)\n   516→    .slice(0, count)\n   517→    .map((m) => ({\n   518→      metricId: m.metricId,\n   519→      name: m.name,\n   520→      value: m.value,\n   521→      score: m.standardizedScore,\n   522→      idealMin: m.idealMin,\n   523→      idealMax: m.idealMax,\n   524→      advice: generateAdviceFromResult(m),\n   525→      weightTier: getWeightTier(m.metricId),\n   526→      category: m.category,\n   527→    }));\n   528→}\n   529→\n   530→// =============================================================================\n   531→// QUALITY & SEVERITY HELPERS\n   532→// =============================================================================\n   533→\n   534→/**\n   535→ * Get a human-readable quality description\n   536→ */\n   537→export function getQualityDescription(tier: QualityTier): string {\n   538→  switch (tier) {\n   539→    case 'ideal': return 'Ideal';\n   540→    case 'excellent': return 'Excellent';\n   541→    case 'good': return 'Good';\n   542→    case 'below_average': return 'Below Average';\n   543→  }\n   544→}\n   545→\n   546→/**\n   547→ * Get a human-readable severity description\n   548→ */\n   549→export function getSeverityDescription(severity: SeverityLevel): string {\n   550→  switch (severity) {\n   551→    case 'optimal': return 'Optimal';\n   552→    case 'minor': return 'Minor Deviation';\n   553→    case 'moderate': return 'Moderate Deviation';\n   554→    case 'major': return 'Major Deviation';\n   555→    case 'severe': return 'Severe Deviation';\n   556→    case 'extremely_severe': return 'Extremely Severe';\n   557→  }\n   558→}\n   559→\n   560→/**\n   561→ * Get severity color for UI display\n   562→ */\n   563→export function getSeverityColor(severity: SeverityLevel): string {\n   564→  switch (severity) {\n   565→    case 'optimal': return 'text-green-400';\n   566→    case 'minor': return 'text-lime-400';\n   567→    case 'moderate': return 'text-yellow-400';\n   568→    case 'major': return 'text-orange-400';\n   569→    case 'severe': return 'text-red-400';\n   570→    case 'extremely_severe': return 'text-red-600';\n   571→  }\n   572→}\n   573→\n   574→/**\n   575→ * Get weight tier badge color\n   576→ */\n   577→export function getWeightTierColor(tier: 'high' | 'medium' | 'standard'): string {\n   578→  switch (tier) {\n   579→    case 'high': return 'bg-purple-500/20 text-purple-400 border-purple-500/30';\n   580→    case 'medium': return 'bg-blue-500/20 text-blue-400 border-blue-500/30';\n   581→    case 'standard': return 'bg-gray-500/20 text-gray-400 border-gray-500/30';\n   582→  }\n   583→}\n   584→\n   585→/**\n   586→ * Get weight tier label\n   587→ */\n   588→export function getWeightTierLabel(tier: 'high' | 'medium' | 'standard'): string {\n   589→  switch (tier) {\n   590→    case 'high': return 'High Impact (3x)';\n   591→    case 'medium': return 'Medium Impact (2x)';\n   592→    case 'standard': return 'Standard';\n   593→  }\n   594→}\n   595→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fe668d34-d183-4130-a700-e6b4cc58dceb","timestamp":"2025-12-26T06:49:39.151Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/looksmax-scoring.ts","content":"/**\n * LOOKSMAX Scoring Engine\n * Ported from looksmax_engine.py - Presentation Layer\n *\n * Features:\n * - Weighted Harmony Score calculation (3.0x, 2.0x, 1.0x tiers)\n * - Metric-specific advice generation\n * - Gaussian scoring with exponential decay\n */\n\nimport type { MetricScoreResult, QualityTier, SeverityLevel } from './harmony-scoring';\n\n// =============================================================================\n// HARMONY SCORE WEIGHTS\n// =============================================================================\n\n/**\n * High Impact Metrics (3.0x weight)\n * Core facial harmony indicators that have the greatest effect on overall attractiveness\n */\nexport const HIGH_IMPACT_METRICS = new Set([\n  'faceWidthToHeight',\n  'midfaceRatio',\n  'lateralCanthalTilt',\n  'gonialAngle',\n  'mandibularPlaneAngle',\n  'chinToPhiltrumRatio',\n]);\n\n/**\n * Medium Impact Metrics (2.0x weight)\n * Secondary aesthetic factors\n */\nexport const MEDIUM_IMPACT_METRICS = new Set([\n  'noseBridgeToNoseWidth',\n  'nasolabialAngle',\n  'cheekboneHeight',\n  'ramusToMandibleRatio',\n]);\n\n/**\n * Get the weight multiplier for a metric\n */\nexport function getMetricWeight(metricId: string): number {\n  if (HIGH_IMPACT_METRICS.has(metricId)) return 3.0;\n  if (MEDIUM_IMPACT_METRICS.has(metricId)) return 2.0;\n  return 1.0;\n}\n\n/**\n * Get weight tier name for display\n */\nexport function getWeightTier(metricId: string): 'high' | 'medium' | 'standard' {\n  if (HIGH_IMPACT_METRICS.has(metricId)) return 'high';\n  if (MEDIUM_IMPACT_METRICS.has(metricId)) return 'medium';\n  return 'standard';\n}\n\n// =============================================================================\n// WEIGHTED HARMONY SCORE CALCULATION\n// =============================================================================\n\nexport interface HarmonyScoreResult {\n  /** Weighted harmony percentage (0-100%) */\n  harmonyPercentage: number;\n  /** Weighted average score (0-10 scale) */\n  weightedAverage: number;\n  /** Unweighted average for comparison */\n  unweightedAverage: number;\n  /** Breakdown by weight tier */\n  weightDistribution: {\n    highImpact: { count: number; avgScore: number };\n    mediumImpact: { count: number; avgScore: number };\n    standard: { count: number; avgScore: number };\n  };\n}\n\n/**\n * Calculate the weighted Harmony Score from scored measurements.\n * Uses 3-tier weighting: High (3x), Medium (2x), Standard (1x)\n *\n * Formula: Σ(Score × Weight) / Σ(Weights) → percentage\n */\nexport function calculateHarmonyScore(\n  measurements: Array<{ metricId: string; standardizedScore: number }>\n): HarmonyScoreResult {\n  let totalWeightedScore = 0;\n  let totalWeight = 0;\n  let unweightedTotal = 0;\n\n  const tiers = {\n    high: { total: 0, count: 0 },\n    medium: { total: 0, count: 0 },\n    standard: { total: 0, count: 0 },\n  };\n\n  for (const m of measurements) {\n    const weight = getMetricWeight(m.metricId);\n    const tier = getWeightTier(m.metricId);\n\n    totalWeightedScore += m.standardizedScore * weight;\n    totalWeight += weight;\n    unweightedTotal += m.standardizedScore;\n\n    tiers[tier].total += m.standardizedScore;\n    tiers[tier].count++;\n  }\n\n  const rawWeightedAverage = totalWeight > 0 ? totalWeightedScore / totalWeight : 0;\n  const rawUnweightedAverage = measurements.length > 0 ? unweightedTotal / measurements.length : 0;\n\n  // Clamp averages to 0-10 range to prevent any edge case overflows\n  const weightedAverage = Math.max(0, Math.min(10, rawWeightedAverage));\n  const unweightedAverage = Math.max(0, Math.min(10, rawUnweightedAverage));\n  const harmonyPercentage = Math.max(0, Math.min(100, (weightedAverage / 10) * 100));\n\n  // Helper to clamp tier averages to 0-10\n  const clampAvg = (total: number, count: number): number => {\n    if (count === 0) return 0;\n    return Math.max(0, Math.min(10, total / count));\n  };\n\n  return {\n    harmonyPercentage,\n    weightedAverage,\n    unweightedAverage,\n    weightDistribution: {\n      highImpact: {\n        count: tiers.high.count,\n        avgScore: clampAvg(tiers.high.total, tiers.high.count),\n      },\n      mediumImpact: {\n        count: tiers.medium.count,\n        avgScore: clampAvg(tiers.medium.total, tiers.medium.count),\n      },\n      standard: {\n        count: tiers.standard.count,\n        avgScore: clampAvg(tiers.standard.total, tiers.standard.count),\n      },\n    },\n  };\n}\n\n// =============================================================================\n// ADVICE ENGINE - METRIC-SPECIFIC FEEDBACK STRINGS\n// =============================================================================\n\ninterface AdviceEntry {\n  tooHigh: string;\n  tooLow: string;\n}\n\n/**\n * Comprehensive advice database for all metrics\n * Keys match metric IDs from harmony-scoring.ts\n */\nexport const ADVICE_DATABASE: Record<string, AdviceEntry> = {\n  // === HIGH IMPACT METRICS ===\n  faceWidthToHeight: {\n    tooHigh: \"Face appears wider. Consider hairstyles that add vertical length.\",\n    tooLow: \"Face is elongated. Hairstyles with side volume can add balance.\",\n  },\n  midfaceRatio: {\n    tooHigh: \"Midface is elongated. This can project maturity but may benefit from framing.\",\n    tooLow: \"Midface is compact. This is often a dimorphic and youthful trait.\",\n  },\n  lateralCanthalTilt: {\n    tooHigh: \"Eyes have significant positive tilt. Very dimorphic - no action needed.\",\n    tooLow: \"Eyes have negative tilt. Consider brow-maxxing or temporal area work.\",\n  },\n  gonialAngle: {\n    tooHigh: \"Jaw angle is steep (obtuse). Lowering body fat or chewing hard gum may improve definition.\",\n    tooLow: \"Jaw angle is very sharp. Strong masculine trait - no action typically needed.\",\n  },\n  mandibularPlaneAngle: {\n    tooHigh: \"Steep mandibular plane (long face type). May benefit from mewing or jaw work.\",\n    tooLow: \"Flat mandibular plane. This is typically a favorable trait.\",\n  },\n  chinToPhiltrumRatio: {\n    tooHigh: \"Chin is long relative to philtrum. Generally masculine; no action needed.\",\n    tooLow: \"Philtrum is long relative to chin. Upper lip lifting or chin augmentation options exist.\",\n  },\n\n  // === MEDIUM IMPACT METRICS ===\n  noseBridgeToNoseWidth: {\n    tooHigh: \"Nose appears narrow relative to bridge. This is typically favorable.\",\n    tooLow: \"Nose is wide relative to bridge. Nostril work can refine proportions.\",\n  },\n  nasolabialAngle: {\n    tooHigh: \"Nose tip points upward. Can appear more feminine; tip refinement may help.\",\n    tooLow: \"Nose tip points downward (droopy). Tip rotation procedures can improve profile.\",\n  },\n  cheekboneHeight: {\n    tooHigh: \"Cheekbones are exceptionally high. Very aesthetic - no action needed.\",\n    tooLow: \"Cheekbones are lower set. Malar augmentation or filler can enhance projection.\",\n  },\n  cheekFullness: {\n    tooHigh: \"Very full cheeks. Consider facial contouring if seeking a leaner look.\",\n    tooLow: \"Hollow or gaunt cheeks. Malar filler or fat grafting can restore volume.\",\n  },\n  ramusToMandibleRatio: {\n    tooHigh: \"Short mandibular body. Jaw angle implants may improve proportions.\",\n    tooLow: \"Long mandibular body. This is typically favorable for facial width.\",\n  },\n\n  // === FRONT PROFILE METRICS ===\n  jawSlope: {\n    tooHigh: \"Jaw slopes steeply. Consider gonial angle enhancement.\",\n    tooLow: \"Jaw has minimal slope. Strong horizontal projection is present.\",\n  },\n  totalFacialWidthToHeight: {\n    tooHigh: \"Face is very wide relative to height. Can appear robust/masculine.\",\n    tooLow: \"Face is very tall relative to width. Hairstyles with width can balance.\",\n  },\n  mouthWidthToNoseRatio: {\n    tooHigh: \"Wide mouth relative to nose. Typically attractive; no action needed.\",\n    tooLow: \"Narrow mouth relative to nose. Lip exercises may help.\",\n  },\n  lowerThirdProportion: {\n    tooHigh: \"Lower face is long. May benefit from vertical reduction options.\",\n    tooLow: \"Lower face is short. Chin augmentation can add vertical height.\",\n  },\n  ipsilateralAlarAngle: {\n    tooHigh: \"Nostril angle is wide. Alar reduction may refine the nose.\",\n    tooLow: \"Nostril angle is narrow. Typically favorable; no action needed.\",\n  },\n  jawFrontalAngle: {\n    tooHigh: \"Jaw is V-shaped. Gonial angle widening may add presence.\",\n    tooLow: \"Jaw is very U-shaped/wide. Strong masculine trait.\",\n  },\n  eyeAspectRatio: {\n    tooHigh: \"Eyes are horizontally elongated. Hunter eyes are typically desirable.\",\n    tooLow: \"Eyes are more round. Lateral canthoplasty can elongate.\",\n  },\n  bitemporalWidth: {\n    tooHigh: \"Wide temples relative to face. Full head of hair can balance.\",\n    tooLow: \"Narrow temples. Can appear more refined/gracile.\",\n  },\n  eyebrowLowSetedness: {\n    tooHigh: \"Brows are low-set (hooded). Creates intense look; browlift if too heavy.\",\n    tooLow: \"Brows are high-set. More open look; brow products can add fullness.\",\n  },\n  eyeSeparationRatio: {\n    tooHigh: \"Eyes are widely set. Creates softer look; no action typically needed.\",\n    tooLow: \"Eyes are closely set. Can appear intense; glasses can balance.\",\n  },\n  bigonialWidth: {\n    tooHigh: \"Wide jaw relative to cheekbones. Strong masculine trait.\",\n    tooLow: \"Narrow jaw relative to cheekbones. Jaw angle widening may add presence.\",\n  },\n  lowerToUpperLipRatio: {\n    tooHigh: \"Lower lip is much fuller. Very aesthetic; no action needed.\",\n    tooLow: \"Upper lip is fuller. Standard proportion; lip flip may balance.\",\n  },\n  eyebrowTilt: {\n    tooHigh: \"Brows tilt significantly upward. Can appear expressive.\",\n    tooLow: \"Brows are flat or downturned. Can appear more stoic.\",\n  },\n\n  // === SIDE PROFILE METRICS ===\n  recessionRelativeToFrankfort: {\n    tooHigh: \"Significant lower jaw recession. Advancement surgery may help.\",\n    tooLow: \"Jaw projects forward strongly. Very masculine; monitor overbite.\",\n  },\n  facialDepthToHeightRatio: {\n    tooHigh: \"Face is very deep relative to height. Strong forward growth.\",\n    tooLow: \"Face is flat relative to height. May benefit from midface/chin work.\",\n  },\n  interiorMidfaceProjectionAngle: {\n    tooHigh: \"Midface projects significantly. Strong forward growth.\",\n    tooLow: \"Flat midface. Cheekbone augmentation may improve profile.\",\n  },\n  nasofrontalAngle: {\n    tooHigh: \"Deep nasofrontal angle. Creates dramatic brow/nose transition.\",\n    tooLow: \"Shallow nasofrontal angle. Brow work may add definition.\",\n  },\n  gonionToMouthLine: {\n    tooHigh: \"Gonion is low relative to mouth. May appear long-faced.\",\n    tooLow: \"Gonion is high relative to mouth. Compact proportions.\",\n  },\n  lowerLipSLinePosition: {\n    tooHigh: \"Lower lip protrudes past S-line. May indicate maxillary retrusion.\",\n    tooLow: \"Lower lip is behind S-line. Well-balanced profile.\",\n  },\n  zAngle: {\n    tooHigh: \"Profile is very upright/vertical. May appear flat.\",\n    tooLow: \"Profile is convex. Standard Western ideal.\",\n  },\n  nasomentaAngle: {\n    tooHigh: \"Nose-chin line is obtuse. May indicate weak chin.\",\n    tooLow: \"Nose-chin line is acute. Strong chin projection.\",\n  },\n  submentalCervicalAngle: {\n    tooHigh: \"Weak chin-neck angle. May benefit from submental lipo or implant.\",\n    tooLow: \"Sharp chin-neck angle. Excellent definition.\",\n  },\n  nasofacialAngle: {\n    tooHigh: \"Large angle between nose and face. Strong nose or recessed face.\",\n    tooLow: \"Small angle. Well-integrated nose.\",\n  },\n  holdawayHLine: {\n    tooHigh: \"Lips project significantly. Monitor for bimax protrusion.\",\n    tooLow: \"Flat lip line. May appear retruded; filler can add volume.\",\n  },\n  mentolabialAngle: {\n    tooHigh: \"Deep mentolabial fold. Can appear aged; filler can soften.\",\n    tooLow: \"Shallow mentolabial fold. Youthful and balanced.\",\n  },\n  eLineLowerLip: {\n    tooHigh: \"Lower lip protrudes past E-line. May benefit from orthodontics.\",\n    tooLow: \"Lower lip is behind E-line. Balanced or retruded.\",\n  },\n  eLineUpperLip: {\n    tooHigh: \"Upper lip protrudes past E-line. May benefit from orthodontics.\",\n    tooLow: \"Upper lip is behind E-line. Balanced or retruded.\",\n  },\n  nasalTipAngle: {\n    tooHigh: \"Nose tip is rotated upward. Can appear feminine.\",\n    tooLow: \"Nose tip droops. Tip rotation surgery can improve.\",\n  },\n  nasalProjection: {\n    tooHigh: \"Large nose projection. Reduction rhinoplasty may refine.\",\n    tooLow: \"Minimal nose projection. Augmentation rhinoplasty may enhance.\",\n  },\n  nasalWToHRatio: {\n    tooHigh: \"Wide nose relative to height. Narrowing procedures exist.\",\n    tooLow: \"Narrow nose. Typically favorable; no action needed.\",\n  },\n  facialConvexityGlabella: {\n    tooHigh: \"Convex profile. Strong midface projection.\",\n    tooLow: \"Flat or concave profile. May benefit from augmentation.\",\n  },\n  facialConvexityNasion: {\n    tooHigh: \"Convex profile from nasion. Good forward growth.\",\n    tooLow: \"Straight or concave profile. May appear flat.\",\n  },\n  totalFacialConvexity: {\n    tooHigh: \"Very convex total profile. Midface is prominent.\",\n    tooLow: \"Flat total profile. Forward growth options may help.\",\n  },\n  upperForeheadSlope: {\n    tooHigh: \"Sloped forehead. More masculine/primal appearance.\",\n    tooLow: \"Upright forehead. More neotenous appearance.\",\n  },\n  browridgeInclinationAngle: {\n    tooHigh: \"Prominent browridge angle. Strong masculine trait.\",\n    tooLow: \"Flat browridge. Implants can add definition.\",\n  },\n  upperThirdProportion: {\n    tooHigh: \"Upper third is long. Large forehead; can be offset with hair styling.\",\n    tooLow: \"Upper third is short. Compact proportions.\",\n  },\n  middleThirdProportion: {\n    tooHigh: \"Middle third is long. May appear long-faced.\",\n    tooLow: \"Middle third is short. Compact midface.\",\n  },\n  chinProjection: {\n    tooHigh: \"Strong chin projection. Very masculine trait.\",\n    tooLow: \"Weak chin projection. Genioplasty or implant can improve.\",\n  },\n  lipRatio: {\n    tooHigh: \"Full lips. Typically attractive; no action needed.\",\n    tooLow: \"Thin lips. Filler can add volume if desired.\",\n  },\n};\n\n/**\n * Generate personalized advice based on metric score and value position.\n *\n * @param metricId - The metric identifier\n * @param score - Score from 0-10\n * @param value - Actual measured value\n * @param idealMin - Minimum of ideal range\n * @param idealMax - Maximum of ideal range\n * @returns Advice string for the metric\n */\nexport function generateAdvice(\n  metricId: string,\n  score: number,\n  value: number,\n  idealMin: number,\n  idealMax: number\n): string {\n  // Perfect score - no action needed\n  if (score >= 9.0) {\n    return \"Ideal proportions. No action needed.\";\n  }\n\n  // Get advice from database\n  const advice = ADVICE_DATABASE[metricId];\n  if (advice) {\n    if (value > idealMax) {\n      return advice.tooHigh;\n    } else if (value < idealMin) {\n      return advice.tooLow;\n    }\n  }\n\n  // Default fallback\n  if (value > idealMax) {\n    return `Value (${value.toFixed(2)}) is above the ideal range of ${idealMin.toFixed(1)}-${idealMax.toFixed(1)}.`;\n  } else if (value < idealMin) {\n    return `Value (${value.toFixed(2)}) is below the ideal range of ${idealMin.toFixed(1)}-${idealMax.toFixed(1)}.`;\n  } else {\n    return \"Value is within acceptable range but not optimal.\";\n  }\n}\n\n/**\n * Generate advice for a metric score result\n */\nexport function generateAdviceFromResult(result: MetricScoreResult): string {\n  return generateAdvice(\n    result.metricId,\n    result.standardizedScore,\n    result.value,\n    result.idealMin,\n    result.idealMax\n  );\n}\n\n// =============================================================================\n// GAUSSIAN SCORING (matches Python implementation)\n// =============================================================================\n\n/**\n * Calculate a score from 0-10 using Gaussian decay.\n * Matches the Python looksmax_engine.py implementation.\n *\n * @param value - The measured value\n * @param minRange - Minimum of ideal range\n * @param maxRange - Maximum of ideal range\n * @returns Score from 0-10\n */\nexport function calculateGaussianScore(\n  value: number,\n  minRange: number,\n  maxRange: number\n): number {\n  // Within ideal range = perfect score\n  if (value >= minRange && value <= maxRange) {\n    return 10.0;\n  }\n\n  let deviation: number;\n  let target: number;\n\n  if (value < minRange) {\n    deviation = minRange - value;\n    target = minRange;\n  } else {\n    deviation = value - maxRange;\n    target = maxRange;\n  }\n\n  // Prevent division by zero\n  if (target === 0) target = 1.0;\n\n  // Sigma is 10% of target value\n  let sigma = Math.abs(target) * 0.1;\n  if (sigma === 0) sigma = 1.0;\n\n  // Gaussian decay\n  const score = 10.0 * Math.exp(-0.5 * Math.pow(deviation / sigma, 2));\n  return Math.max(0.0, Math.min(10.0, score));\n}\n\n// =============================================================================\n// TOP/BOTTOM METRICS IDENTIFICATION\n// =============================================================================\n\nexport interface RankedMetric {\n  metricId: string;\n  name: string;\n  value: number;\n  score: number;\n  idealMin: number;\n  idealMax: number;\n  advice: string;\n  weightTier: 'high' | 'medium' | 'standard';\n  category: string;\n}\n\n/**\n * Get the top N metrics (strengths) sorted by score descending\n */\nexport function getTopMetrics(\n  measurements: MetricScoreResult[],\n  count: number = 3\n): RankedMetric[] {\n  return [...measurements]\n    .sort((a, b) => b.standardizedScore - a.standardizedScore)\n    .slice(0, count)\n    .map((m) => ({\n      metricId: m.metricId,\n      name: m.name,\n      value: m.value,\n      score: m.standardizedScore,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      advice: generateAdviceFromResult(m),\n      weightTier: getWeightTier(m.metricId),\n      category: m.category,\n    }));\n}\n\n/**\n * Get the bottom N metrics (areas to improve) sorted by score ascending\n */\nexport function getBottomMetrics(\n  measurements: MetricScoreResult[],\n  count: number = 3\n): RankedMetric[] {\n  return [...measurements]\n    .sort((a, b) => a.standardizedScore - b.standardizedScore)\n    .slice(0, count)\n    .map((m) => ({\n      metricId: m.metricId,\n      name: m.name,\n      value: m.value,\n      score: m.standardizedScore,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      advice: generateAdviceFromResult(m),\n      weightTier: getWeightTier(m.metricId),\n      category: m.category,\n    }));\n}\n\n// =============================================================================\n// QUALITY & SEVERITY HELPERS\n// =============================================================================\n\n/**\n * Get a human-readable quality description\n */\nexport function getQualityDescription(tier: QualityTier): string {\n  switch (tier) {\n    case 'ideal': return 'Ideal';\n    case 'excellent': return 'Excellent';\n    case 'good': return 'Good';\n    case 'below_average': return 'Below Average';\n  }\n}\n\n/**\n * Get a human-readable severity description\n */\nexport function getSeverityDescription(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'optimal': return 'Optimal';\n    case 'minor': return 'Minor Deviation';\n    case 'moderate': return 'Moderate Deviation';\n    case 'major': return 'Major Deviation';\n    case 'severe': return 'Severe Deviation';\n    case 'extremely_severe': return 'Extremely Severe';\n  }\n}\n\n/**\n * Get severity color for UI display\n */\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'optimal': return 'text-green-400';\n    case 'minor': return 'text-lime-400';\n    case 'moderate': return 'text-yellow-400';\n    case 'major': return 'text-orange-400';\n    case 'severe': return 'text-red-400';\n    case 'extremely_severe': return 'text-red-600';\n  }\n}\n\n/**\n * Get weight tier badge color\n */\nexport function getWeightTierColor(tier: 'high' | 'medium' | 'standard'): string {\n  switch (tier) {\n    case 'high': return 'bg-purple-500/20 text-purple-400 border-purple-500/30';\n    case 'medium': return 'bg-blue-500/20 text-blue-400 border-blue-500/30';\n    case 'standard': return 'bg-gray-500/20 text-gray-400 border-gray-500/30';\n  }\n}\n\n/**\n * Get weight tier label\n */\nexport function getWeightTierLabel(tier: 'high' | 'medium' | 'standard'): string {\n  switch (tier) {\n    case 'high': return 'High Impact (3x)';\n    case 'medium': return 'Medium Impact (2x)';\n    case 'standard': return 'Standard';\n  }\n}\n","numLines":595,"startLine":1,"totalLines":595}}}
{"parentUuid":"fe668d34-d183-4130-a700-e6b4cc58dceb","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AieX1Tdvdjg3ekCd2wRR1K","type":"tool_result","content":"     1→/**\n     2→ * Scoring Calculator\n     3→ * Core scoring algorithm functions extracted from harmony-scoring.ts\n     4→ *\n     5→ * Features:\n     6→ * - Exponential decay scoring with per-metric decay rates\n     7→ * - Bezier curve custom scoring for non-linear measurements\n     8→ * - Directional/Dimorphic scoring (polarity support)\n     9→ * - Quality tiers and severity levels\n    10→ */\n    11→\n    12→import {\n    13→  Point,\n    14→  QualityTier,\n    15→  SeverityLevel,\n    16→  MeasurementUnit,\n    17→  MetricConfig,\n    18→  CurvePoint,\n    19→  FlawMapping,\n    20→} from './types';\n    21→import { BEZIER_CURVES } from '@/lib/bezier-curves';\n    22→\n    23→// ============================================\n    24→// FLAW MAPPINGS\n    25→// ============================================\n    26→\n    27→export const METRIC_FLAW_MAPPINGS: Record<string, FlawMapping[]> = {\n    28→  anteriorFacialDepth: [\n    29→    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Anterior Facial Depth measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n    30→  ],\n    31→  bitemporalWidth: [\n    32→    { category: 'Upper Third', flawName: 'Narrow forehead', confidence: 'confirmed', reasoning: 'Reduced bitemporal width indicates a narrower than ideal forehead relative to the cheekbones. This disrupts facial harmony by creating a compressed hairline and forehead, altering the overall shape of the face.' },\n    33→  ],\n    34→  cheekboneHeight: [\n    35→    { category: 'Midface/Face Shape', flawName: 'Low-set cheekbones', confidence: 'confirmed', reasoning: 'Reduced cheekbone height indicates that the cheekbones are positioned lower than ideal. This disrupts facial harmony by creating an unpronounced appearance to the cheekbones and facial structure.' },\n    36→  ],\n    37→  cheekFullness: [\n    38→    { category: 'Midface/Face Shape', flawName: 'Hollow/Gaunt midface', confidence: 'confirmed', reasoning: 'Reduced cheek fullness indicates volume loss or hollow cheeks. This disrupts facial harmony by creating a gaunt or aged appearance, particularly important in South Asian and East Asian beauty standards.' },\n    39→  ],\n    40→  eyeAspectRatio: [\n    41→    { category: 'Eyes', flawName: 'Overly round eye shape', confidence: 'confirmed', reasoning: 'A reduced eye aspect ratio indicates overly narrow eyes relative to their height. This disrupts facial harmony by creating an overly surprised appearance and reducing angular definition.' },\n    42→  ],\n    43→  eyeSeparationRatio: [\n    44→    { category: 'Eyes', flawName: 'Close-set eyes', confidence: 'confirmed', reasoning: 'Reduced eye separation indicates close-set eyes. This disrupts facial harmony by making the eye area appear too compressed.' },\n    45→  ],\n    46→  eyebrowLowSetedness: [\n    47→    { category: 'Eyes', flawName: 'Medium-set eyebrows', confidence: 'confirmed', reasoning: 'Increased eyebrow low setedness indicates eyebrows that are positioned higher than ideal. This disrupts facial harmony by reducing the overall visual impact of the eyebrows and framing of the eyes.' },\n    48→  ],\n    49→  faceWidthToHeight: [\n    50→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced face width to height ratio indicates an overly long midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    51→  ],\n    52→  facialDepthToHeight: [\n    53→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'Reduced facial depth to height ratio indicates insufficient mid-face projection relative to height. This disrupts facial harmony by creating the appearance of a flat midface.' },\n    54→  ],\n    55→  gonialAngle: [\n    56→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony in the lower face.' },\n    57→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    58→  ],\n    59→  holdawayHLine: [\n    60→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'Decreased H-line indicates the lips are positioned too far in front of the line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    61→  ],\n    62→  interiorMidfaceProjectionAngle: [\n    63→    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Interior Midface Projection Angle measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n    64→  ],\n    65→  ipsilateralAlarAngle: [\n    66→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A decreased ipsilateral alar angle indicates an overly narrow interior midface. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    67→  ],\n    68→  jawFrontalAngle: [\n    69→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A narrower jaw frontal angle indicates a steeper jawline or overly wide chin. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    70→  ],\n    71→  jawSlope: [\n    72→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'The Jaw Slope measurement is above the ideal range. This disrupts facial harmony in the lower face.' },\n    73→  ],\n    74→  lateralCanthalTilt: [\n    75→    { category: 'Eyes', flawName: 'Insufficient eye tilt', confidence: 'confirmed', reasoning: 'A decreased lateral canthal tilt indicates insufficiently upturned eyes. This disrupts facial harmony by creating a less alert and youthful appearance.' },\n    76→  ],\n    77→  burstoneLowerLip: [\n    78→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the Burstone line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    79→  ],\n    80→  eLineLowerLip: [\n    81→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned too far in front of the E-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    82→  ],\n    83→  sLineLowerLip: [\n    84→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the S-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    85→  ],\n    86→  lowerThirdProportion: [\n    87→    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'The upper jaw is too long relative to lower jaw, possibly from a long upper jaw or short lower jaw, or a combination of both. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n    88→  ],\n    89→  mandibularPlaneAngle: [\n    90→    { category: 'Occlusion/Jaw Growth', flawName: 'Hyper-divergent jaw growth', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by elongating the lower face.' },\n    91→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony in the lower face.' },\n    92→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    93→  ],\n    94→  midfaceRatio: [\n    95→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    96→    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n    97→  ],\n    98→  nasofacialAngle: [\n    99→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A smaller nasofacial angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n   100→  ],\n   101→  nasofrontalAngle: [\n   102→    { category: 'Upper Third', flawName: 'Soft and weak brow ridge', confidence: 'confirmed', reasoning: 'An increased nasofrontal angle indicates reduced brow ridge prominence and angularity. This disrupts facial harmony by creating a less defined upper face.' },\n   103→  ],\n   104→  nasomentaAngle: [\n   105→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A larger nasomental angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n   106→  ],\n   107→  noseBridgeWidth: [\n   108→    { category: 'Nose', flawName: 'Overly narrow nose bridge', confidence: 'confirmed', reasoning: 'The Nose Bridge to Nose Width measurement is above the ideal range. This disrupts facial harmony by creating an unbalanced nasal profile.' },\n   109→  ],\n   110→  orbitalVector: [\n   111→    { category: 'Eyes', flawName: 'Sunken orbital region', confidence: 'confirmed', reasoning: 'A decreased orbital vector indicates insufficient projection and volume underneath the eye. This disrupts facial harmony due to the lacking volume underneath the eyes, reducing vibrancy and youthfulness.' },\n   112→  ],\n   113→  ramusToMandibleRatio: [\n   114→    { category: 'Jaw Shape', flawName: 'Short ramus', confidence: 'confirmed', reasoning: 'A reduced ramus-to-mandible ratio indicates a shorter than ideal vertical jawbone (ramus) when compared to the mandible. This disrupts facial harmony by reducing jaw height and definition.' },\n   115→  ],\n   116→  submentalCervicalAngle: [\n   117→    { category: 'Neck', flawName: 'Round neck region', confidence: 'confirmed', reasoning: 'An increased submental cervical angle indicates a round neck region, possibly from excess submental fat or tissue. This disrupts facial harmony by reducing neck definition.' },\n   118→  ],\n   119→  totalFacialWidthToHeight: [\n   120→    { category: 'Midface/Face Shape', flawName: 'Overly long face shape', confidence: 'confirmed', reasoning: 'An increased total facial width to height ratio indicates an overly long face relative to its height. This disrupts facial harmony by creating a vertically stretched appearance to the face.' },\n   121→  ],\n   122→};\n   123→\n   124→// ============================================\n   125→// CUSTOM BEZIER CURVES (Ethnicity-specific override)\n   126→// ============================================\n   127→\n   128→export const METRIC_CUSTOM_CURVES: Record<string, CurvePoint[]> = {\n   129→  faceWidthToHeight: [\n   130→    { x: 1.49, y: 0, leftHandleX: 1.44, leftHandleY: 0, rightHandleX: 1.55, rightHandleY: 0 },\n   131→    { x: 1.68, y: 1.05, leftHandleX: 1.62, leftHandleY: 0.36, rightHandleX: 1.71, rightHandleY: 1.58 },\n   132→    { x: 1.77, y: 3.07, leftHandleX: 1.74, leftHandleY: 2.15, rightHandleX: 1.79, rightHandleY: 3.88 },\n   133→    { x: 1.83, y: 5.83, leftHandleX: 1.8, leftHandleY: 4.64, rightHandleX: 1.84, rightHandleY: 6.85 },\n   134→    { x: 1.89, y: 8.7, leftHandleX: 1.88, leftHandleY: 8.3, rightHandleX: 1.92, rightHandleY: 9.5 },\n   135→    { x: 1.96, y: 10, leftHandleX: 1.96, leftHandleY: 10, rightHandleX: 1.96, rightHandleY: 10, fixed: true },\n   136→    { x: 2, y: 10, leftHandleX: 2, leftHandleY: 10, rightHandleX: 2, rightHandleY: 10 },\n   137→    { x: 2.07, y: 8.7, leftHandleX: 2.04, leftHandleY: 9.5, rightHandleX: 2.08, rightHandleY: 8.3 },\n   138→    { x: 2.13, y: 5.83, leftHandleX: 2.12, leftHandleY: 6.85, rightHandleX: 2.16, rightHandleY: 4.64 },\n   139→    { x: 2.19, y: 3.07, leftHandleX: 2.17, leftHandleY: 3.88, rightHandleX: 2.22, rightHandleY: 2.15 },\n   140→    { x: 2.28, y: 1.05, leftHandleX: 2.25, leftHandleY: 1.58, rightHandleX: 2.34, rightHandleY: 0.36 },\n   141→    { x: 2.47, y: 0, leftHandleX: 2.41, leftHandleY: 0, rightHandleX: 2.52, rightHandleY: 0 },\n   142→  ],\n   143→  lowerThirdProportion: [\n   144→    { x: 25.6, y: 0, leftHandleX: 24.8, leftHandleY: 0, rightHandleX: 26.4, rightHandleY: 0 },\n   145→    { x: 28.01, y: 1.58, leftHandleX: 27.23, leftHandleY: 0.53, rightHandleX: 28.27, rightHandleY: 1.97 },\n   146→    { x: 28.83, y: 3.21, leftHandleX: 28.62, leftHandleY: 2.59, rightHandleX: 29.03, rightHandleY: 3.76 },\n   147→    { x: 29.63, y: 5.85, leftHandleX: 29.38, leftHandleY: 4.64, rightHandleX: 29.84, rightHandleY: 6.61 },\n   148→    { x: 30.27, y: 8.56, leftHandleX: 30.1, leftHandleY: 7.71, rightHandleX: 30.52, rightHandleY: 9.42 },\n   149→    { x: 31, y: 10, leftHandleX: 30.88, leftHandleY: 10, rightHandleX: 31.13, rightHandleY: 10, fixed: true },\n   150→    { x: 33.5, y: 10, leftHandleX: 33.38, leftHandleY: 10, rightHandleX: 33.63, rightHandleY: 10 },\n   151→    { x: 34.23, y: 8.56, leftHandleX: 33.98, leftHandleY: 9.42, rightHandleX: 34.4, rightHandleY: 7.71 },\n   152→    { x: 34.87, y: 5.85, leftHandleX: 34.66, leftHandleY: 6.61, rightHandleX: 35.12, rightHandleY: 4.64 },\n   153→    { x: 35.67, y: 3.21, leftHandleX: 35.47, leftHandleY: 3.76, rightHandleX: 35.88, rightHandleY: 2.59 },\n   154→    { x: 36.49, y: 1.58, leftHandleX: 36.23, leftHandleY: 1.97, rightHandleX: 37.27, rightHandleY: 0.53 },\n   155→    { x: 38.9, y: 0, leftHandleX: 38.1, leftHandleY: 0, rightHandleX: 39.7, rightHandleY: 0 },\n   156→  ],\n   157→  eyeAspectRatio: [\n   158→    { x: 1.44, y: 0, leftHandleX: 1.18, leftHandleY: 0, rightHandleX: 1.75, rightHandleY: 0.38 },\n   159→    { x: 2.07, y: 1.66, leftHandleX: 1.96, leftHandleY: 1.08, rightHandleX: 2.24, rightHandleY: 2.63 },\n   160→    { x: 2.42, y: 4.34, leftHandleX: 2.35, leftHandleY: 3.6, rightHandleX: 2.52, rightHandleY: 5.5 },\n   161→    { x: 2.71, y: 7.96, leftHandleX: 2.65, leftHandleY: 7.13, rightHandleX: 2.8, rightHandleY: 9.08 },\n   162→    { x: 3, y: 10, leftHandleX: 2.98, leftHandleY: 10, rightHandleX: 3.03, rightHandleY: 10, fixed: true },\n   163→    { x: 3.5, y: 10, leftHandleX: 3.48, leftHandleY: 10, rightHandleX: 3.53, rightHandleY: 10 },\n   164→    { x: 3.79, y: 7.96, leftHandleX: 3.7, leftHandleY: 9.08, rightHandleX: 3.85, rightHandleY: 7.13 },\n   165→    { x: 4.08, y: 4.34, leftHandleX: 3.98, leftHandleY: 5.5, rightHandleX: 4.15, rightHandleY: 3.6 },\n   166→    { x: 4.43, y: 1.66, leftHandleX: 4.26, leftHandleY: 2.63, rightHandleX: 4.54, rightHandleY: 1.08 },\n   167→    { x: 5.06, y: 0, leftHandleX: 4.75, leftHandleY: 0.38, rightHandleX: 5.32, rightHandleY: 0 },\n   168→  ],\n   169→  // Note: Additional curves can be added from METRIC_CUSTOM_CURVES in harmony-scoring.ts\n   170→};\n   171→\n   172→// ============================================\n   173→// CORE SCORING FUNCTIONS\n   174→// ============================================\n   175→\n   176→/**\n   177→ * Exponential Decay Scoring Algorithm with Directional/Dimorphic Support\n   178→ *\n   179→ * Standard: score = maxScore * e^(-decayRate * deviation)\n   180→ *\n   181→ * Directional scoring (polarity):\n   182→ * - 'higher_is_better': Values above safeFloor but below ideal get softZoneScore\n   183→ *   Example: Canthal Tilt of 3 degrees is still positive/good, just not peak ideal (6-8 degrees)\n   184→ * - 'lower_is_better': Values below safeCeiling but above ideal get softZoneScore\n   185→ *   Example: Short philtrum is still attractive even if shorter than \"ideal\"\n   186→ */\n   187→export function calculateMetricScore(\n   188→  value: number,\n   189→  config: MetricConfig\n   190→): number {\n   191→  const {\n   192→    id,\n   193→    idealMin,\n   194→    idealMax,\n   195→    decayRate,\n   196→    maxScore,\n   197→    customCurve,\n   198→    polarity = 'balanced',\n   199→    safeFloor,\n   200→    safeCeiling,\n   201→    softZoneScore = 8.0, // Default \"Good\" score for acceptable-but-not-ideal values\n   202→  } = config;\n   203→\n   204→  // IMPORTANT: Check demographic-adjusted ideal range FIRST\n   205→  // This ensures that demographic overrides are respected even when Bezier curves exist\n   206→  // (Bezier curves are optimized for base ranges and don't auto-adjust for demographics)\n   207→  if (value >= idealMin && value <= idealMax) {\n   208→    return maxScore;\n   209→  }\n   210→\n   211→  // Use custom curve if available in config\n   212→  if (customCurve && customCurve.mode === 'custom') {\n   213→    const bezierScore = interpolateCustomCurve(value, customCurve.points, maxScore);\n   214→    // If Bezier returns -1, it means value is out of range with edge y=0\n   215→    // Fall through to exponential decay instead of returning 0\n   216→    if (bezierScore >= 0) {\n   217→      // Clamp to valid range [0, maxScore] to prevent Bezier overshoot\n   218→      return Math.max(0, Math.min(maxScore, bezierScore));\n   219→    }\n   220→  }\n   221→\n   222→  // Check for pre-defined Bezier curve from harmony curves (66 metrics)\n   223→  const bezierCurve = BEZIER_CURVES[id];\n   224→  if (bezierCurve && bezierCurve.mode === 'custom') {\n   225→    const bezierScore = interpolateCustomCurve(value, bezierCurve.points, maxScore);\n   226→    // If Bezier returns -1, it means value is out of range with edge y=0\n   227→    // Fall through to exponential decay instead of returning 0\n   228→    if (bezierScore >= 0) {\n   229→      // Clamp to valid range [0, maxScore] to prevent Bezier overshoot\n   230→      return Math.max(0, Math.min(maxScore, bezierScore));\n   231→    }\n   232→  }\n   233→\n   234→  // Handle directional/dimorphic scoring\n   235→  if (polarity === 'higher_is_better' && safeFloor !== undefined) {\n   236→    // Higher values are good. Only values below safeFloor are true weaknesses.\n   237→    if (value >= safeFloor && value < idealMin) {\n   238→      // Value is in the \"acceptable but not ideal\" zone\n   239→      // Give a passing score that decreases linearly as we approach the floor\n   240→      const zoneRange = idealMin - safeFloor;\n   241→      const distanceFromIdeal = idealMin - value;\n   242→      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n   243→      // Linear interpolation: idealMin -> maxScore, safeFloor -> softZoneScore\n   244→      return maxScore - t * (maxScore - softZoneScore);\n   245→    }\n   246→    if (value >= idealMax) {\n   247→      // Values above ideal are still excellent for 'higher_is_better'\n   248→      // Apply gentler decay (1/3 the normal rate)\n   249→      const deviation = value - idealMax;\n   250→      const gentleDecay = decayRate / 3;\n   251→      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n   252→    }\n   253→    // Below safeFloor - apply normal (or harsher) exponential decay\n   254→    if (value < safeFloor) {\n   255→      const deviation = safeFloor - value;\n   256→      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n   257→    }\n   258→  }\n   259→\n   260→  if (polarity === 'lower_is_better' && safeCeiling !== undefined) {\n   261→    // Lower values are good. Only values above safeCeiling are true weaknesses.\n   262→    if (value <= safeCeiling && value > idealMax) {\n   263→      // Value is in the \"acceptable but not ideal\" zone\n   264→      const zoneRange = safeCeiling - idealMax;\n   265→      const distanceFromIdeal = value - idealMax;\n   266→      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n   267→      // Linear interpolation: idealMax -> maxScore, safeCeiling -> softZoneScore\n   268→      return maxScore - t * (maxScore - softZoneScore);\n   269→    }\n   270→    if (value <= idealMin) {\n   271→      // Values below ideal are still excellent for 'lower_is_better'\n   272→      // Apply gentler decay (1/3 the normal rate)\n   273→      const deviation = idealMin - value;\n   274→      const gentleDecay = decayRate / 3;\n   275→      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n   276→    }\n   277→    // Above safeCeiling - apply normal exponential decay\n   278→    if (value > safeCeiling) {\n   279→      const deviation = value - safeCeiling;\n   280→      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n   281→    }\n   282→  }\n   283→\n   284→  // Default balanced scoring: deviation in either direction is equally bad\n   285→  const deviation = value < idealMin\n   286→    ? idealMin - value\n   287→    : value - idealMax;\n   288→\n   289→  // Exponential decay\n   290→  const score = maxScore * Math.exp(-decayRate * deviation);\n   291→\n   292→  return Math.max(0, Math.min(maxScore, score));\n   293→}\n   294→\n   295→/**\n   296→ * Check if a metric value is in an \"acceptable\" zone (not a true weakness).\n   297→ * Used by InsightsEngine to prevent false positives.\n   298→ */\n   299→export function isValueAcceptable(\n   300→  value: number,\n   301→  config: MetricConfig\n   302→): { acceptable: boolean; reason: string } {\n   303→  const {\n   304→    idealMin,\n   305→    idealMax,\n   306→    polarity = 'balanced',\n   307→    safeFloor,\n   308→    safeCeiling,\n   309→  } = config;\n   310→\n   311→  // Within ideal range is always acceptable\n   312→  if (value >= idealMin && value <= idealMax) {\n   313→    return { acceptable: true, reason: 'within_ideal' };\n   314→  }\n   315→\n   316→  // Check directional acceptability\n   317→  if (polarity === 'higher_is_better') {\n   318→    if (value >= idealMax) {\n   319→      return { acceptable: true, reason: 'above_ideal_higher_is_better' };\n   320→    }\n   321→    if (safeFloor !== undefined && value >= safeFloor) {\n   322→      return { acceptable: true, reason: 'above_safe_floor' };\n   323→    }\n   324→    // Below safe floor - true weakness\n   325→    return { acceptable: false, reason: 'below_safe_floor' };\n   326→  }\n   327→\n   328→  if (polarity === 'lower_is_better') {\n   329→    if (value <= idealMin) {\n   330→      return { acceptable: true, reason: 'below_ideal_lower_is_better' };\n   331→    }\n   332→    if (safeCeiling !== undefined && value <= safeCeiling) {\n   333→      return { acceptable: true, reason: 'below_safe_ceiling' };\n   334→    }\n   335→    // Above safe ceiling - true weakness\n   336→    return { acceptable: false, reason: 'above_safe_ceiling' };\n   337→  }\n   338→\n   339→  // Balanced polarity - outside ideal is not acceptable\n   340→  return { acceptable: false, reason: 'outside_ideal_balanced' };\n   341→}\n   342→\n   343→/**\n   344→ * Interpolate custom Bezier curve for scoring\n   345→ * Uses cubic Bezier interpolation with control handles for smooth curves\n   346→ *\n   347→ * IMPORTANT: When value is outside the curve range and the edge y-value is 0,\n   348→ * returns -1 to signal the caller should use exponential decay fallback.\n   349→ * This prevents artificially returning 0 for values just outside the curve.\n   350→ */\n   351→export function interpolateCustomCurve(\n   352→  value: number,\n   353→  points: CurvePoint[],\n   354→  maxScore: number\n   355→): number {\n   356→  void maxScore; // Reserved for future custom curve implementations\n   357→  if (points.length === 0) return -1; // Signal to use fallback\n   358→\n   359→  // Sort points by x value\n   360→  const sortedPoints = [...points].sort((a, b) => a.x - b.x);\n   361→\n   362→  // Handle out-of-range values\n   363→  // If edge y-value is 0, return -1 to signal exponential decay fallback should be used\n   364→  if (value <= sortedPoints[0].x) {\n   365→    const edgeY = sortedPoints[0].y;\n   366→    // If edge score is 0, signal to use exponential decay fallback\n   367→    return edgeY <= 0 ? -1 : edgeY;\n   368→  }\n   369→  if (value >= sortedPoints[sortedPoints.length - 1].x) {\n   370→    const edgeY = sortedPoints[sortedPoints.length - 1].y;\n   371→    // If edge score is 0, signal to use exponential decay fallback\n   372→    return edgeY <= 0 ? -1 : edgeY;\n   373→  }\n   374→\n   375→  // Find bracketing points\n   376→  let lowerIndex = 0;\n   377→  for (let i = 0; i < sortedPoints.length - 1; i++) {\n   378→    if (value >= sortedPoints[i].x && value <= sortedPoints[i + 1].x) {\n   379→      lowerIndex = i;\n   380→      break;\n   381→    }\n   382→  }\n   383→\n   384→  const p0 = sortedPoints[lowerIndex];\n   385→  const p3 = sortedPoints[lowerIndex + 1];\n   386→\n   387→  // Check if we have Bezier control handles\n   388→  const hasHandles = p0.rightHandleX !== undefined && p3.leftHandleX !== undefined;\n   389→\n   390→  if (hasHandles) {\n   391→    // Cubic Bezier interpolation with control points\n   392→    const p1x = p0.rightHandleX!;\n   393→    const p1y = p0.rightHandleY ?? p0.y;\n   394→    const p2x = p3.leftHandleX!;\n   395→    const p2y = p3.leftHandleY ?? p3.y;\n   396→\n   397→    // Find t parameter for given x value using Newton-Raphson iteration\n   398→    let t = (value - p0.x) / (p3.x - p0.x); // Initial guess\n   399→\n   400→    // Newton-Raphson iterations to find t where B_x(t) = value\n   401→    for (let iter = 0; iter < 10; iter++) {\n   402→      const bx = cubicBezier(p0.x, p1x, p2x, p3.x, t);\n   403→      const bxDerivative = cubicBezierDerivative(p0.x, p1x, p2x, p3.x, t);\n   404→\n   405→      if (Math.abs(bxDerivative) < 1e-10) break;\n   406→\n   407→      const newT = t - (bx - value) / bxDerivative;\n   408→      if (Math.abs(newT - t) < 1e-10) break;\n   409→      t = Math.max(0, Math.min(1, newT));\n   410→    }\n   411→\n   412→    // Calculate y using the found t parameter\n   413→    return cubicBezier(p0.y, p1y, p2y, p3.y, t);\n   414→  } else {\n   415→    // Smooth interpolation using Catmull-Rom spline\n   416→    // This provides smoother curves than linear interpolation\n   417→    const t = (value - p0.x) / (p3.x - p0.x);\n   418→\n   419→    // Get neighboring points for spline calculation\n   420→    const pMinus1 = lowerIndex > 0 ? sortedPoints[lowerIndex - 1] : p0;\n   421→    const p4 = lowerIndex + 2 < sortedPoints.length ? sortedPoints[lowerIndex + 2] : p3;\n   422→\n   423→    // Catmull-Rom spline interpolation\n   424→    return catmullRomSpline(pMinus1.y, p0.y, p3.y, p4.y, t);\n   425→  }\n   426→}\n   427→\n   428→/**\n   429→ * Cubic Bezier curve evaluation: B(t) = (1-t)^3*P0 + 3*(1-t)^2*t*P1 + 3*(1-t)*t^2*P2 + t^3*P3\n   430→ */\n   431→export function cubicBezier(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   432→  const mt = 1 - t;\n   433→  const mt2 = mt * mt;\n   434→  const mt3 = mt2 * mt;\n   435→  const t2 = t * t;\n   436→  const t3 = t2 * t;\n   437→  return mt3 * p0 + 3 * mt2 * t * p1 + 3 * mt * t2 * p2 + t3 * p3;\n   438→}\n   439→\n   440→/**\n   441→ * Cubic Bezier derivative: B'(t) = 3*(1-t)^2*(P1-P0) + 6*(1-t)*t*(P2-P1) + 3*t^2*(P3-P2)\n   442→ */\n   443→export function cubicBezierDerivative(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   444→  const mt = 1 - t;\n   445→  return 3 * mt * mt * (p1 - p0) + 6 * mt * t * (p2 - p1) + 3 * t * t * (p3 - p2);\n   446→}\n   447→\n   448→/**\n   449→ * Catmull-Rom spline interpolation for smooth curves without explicit handles\n   450→ */\n   451→export function catmullRomSpline(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   452→  const t2 = t * t;\n   453→  const t3 = t2 * t;\n   454→\n   455→  // Catmull-Rom coefficients with tension = 0.5\n   456→  const a = -0.5 * p0 + 1.5 * p1 - 1.5 * p2 + 0.5 * p3;\n   457→  const b = p0 - 2.5 * p1 + 2 * p2 - 0.5 * p3;\n   458→  const c = -0.5 * p0 + 0.5 * p2;\n   459→  const d = p1;\n   460→\n   461→  return a * t3 + b * t2 + c * t + d;\n   462→}\n   463→\n   464→/**\n   465→ * Calculate standardized score (0-10 normalized)\n   466→ * Clamps output to [0, 10] to prevent display issues from scoring edge cases\n   467→ */\n   468→export function standardizeScore(score: number, maxScore: number): number {\n   469→  const normalized = (score / maxScore) * 10;\n   470→  return Math.max(0, Math.min(10, normalized));\n   471→}\n   472→\n   473→/**\n   474→ * Determine quality tier based on score\n   475→ */\n   476→export function getQualityTier(score: number, maxScore: number = 10): QualityTier {\n   477→  const normalized = (score / maxScore) * 100;\n   478→\n   479→  if (normalized >= 90) return 'ideal';\n   480→  if (normalized >= 70) return 'excellent';\n   481→  if (normalized >= 50) return 'good';\n   482→  return 'below_average';\n   483→}\n   484→\n   485→/**\n   486→ * Determine severity level based on score\n   487→ */\n   488→export function getSeverityLevel(score: number, maxScore: number = 10): SeverityLevel {\n   489→  const normalized = (score / maxScore) * 100;\n   490→\n   491→  if (normalized >= 85) return 'optimal';\n   492→  if (normalized >= 70) return 'minor';\n   493→  if (normalized >= 50) return 'moderate';\n   494→  if (normalized >= 30) return 'major';\n   495→  if (normalized >= 15) return 'severe';\n   496→  return 'extremely_severe';\n   497→}\n   498→\n   499→/**\n   500→ * Calculate deviation description\n   501→ */\n   502→export function getDeviationDescription(\n   503→  value: number,\n   504→  idealMin: number,\n   505→  idealMax: number,\n   506→  unit: MeasurementUnit\n   507→): { deviation: number; direction: 'above' | 'below' | 'within'; description: string } {\n   508→  if (value >= idealMin && value <= idealMax) {\n   509→    return { deviation: 0, direction: 'within', description: 'within ideal range' };\n   510→  }\n   511→\n   512→  const unitLabel = getUnitLabel(unit);\n   513→\n   514→  if (value < idealMin) {\n   515→    const dev = idealMin - value;\n   516→    return {\n   517→      deviation: dev,\n   518→      direction: 'below',\n   519→      description: `${dev.toFixed(2)}${unitLabel} below ideal`,\n   520→    };\n   521→  }\n   522→\n   523→  const dev = value - idealMax;\n   524→  return {\n   525→    deviation: dev,\n   526→    direction: 'above',\n   527→    description: `${dev.toFixed(2)}${unitLabel} above ideal`,\n   528→  };\n   529→}\n   530→\n   531→/**\n   532→ * Get unit label for display\n   533→ */\n   534→export function getUnitLabel(unit: MeasurementUnit): string {\n   535→  switch (unit) {\n   536→    case 'ratio': return 'x';\n   537→    case 'percent': return '%';\n   538→    case 'degrees': return '\\u00B0';\n   539→    case 'mm': return 'mm';\n   540→    default: return '';\n   541→  }\n   542→}\n   543→\n   544→// ============================================\n   545→// GEOMETRY HELPERS\n   546→// ============================================\n   547→\n   548→/**\n   549→ * Calculate distance between two points\n   550→ */\n   551→export function distance(p1: Point, p2: Point): number {\n   552→  return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));\n   553→}\n   554→\n   555→/**\n   556→ * Calculate angle at vertex point (in degrees)\n   557→ */\n   558→export function calculateAngle(p1: Point, vertex: Point, p2: Point): number {\n   559→  const v1 = { x: p1.x - vertex.x, y: p1.y - vertex.y };\n   560→  const v2 = { x: p2.x - vertex.x, y: p2.y - vertex.y };\n   561→\n   562→  const dot = v1.x * v2.x + v1.y * v2.y;\n   563→  const cross = v1.x * v2.y - v1.y * v2.x;\n   564→\n   565→  const angle = Math.atan2(cross, dot) * (180 / Math.PI);\n   566→  return Math.abs(angle);\n   567→}\n   568→\n   569→/**\n   570→ * Calculate perpendicular distance from point to line (signed)\n   571→ */\n   572→export function perpendicularDistance(\n   573→  point: Point,\n   574→  lineStart: Point,\n   575→  lineEnd: Point\n   576→): number {\n   577→  const A = point.x - lineStart.x;\n   578→  const B = point.y - lineStart.y;\n   579→  const C = lineEnd.x - lineStart.x;\n   580→  const D = lineEnd.y - lineStart.y;\n   581→\n   582→  const dot = A * C + B * D;\n   583→  const lenSq = C * C + D * D;\n   584→  const param = lenSq !== 0 ? dot / lenSq : -1;\n   585→\n   586→  let xx: number, yy: number;\n   587→\n   588→  if (param < 0) {\n   589→    xx = lineStart.x;\n   590→    yy = lineStart.y;\n   591→  } else if (param > 1) {\n   592→    xx = lineEnd.x;\n   593→    yy = lineEnd.y;\n   594→  } else {\n   595→    xx = lineStart.x + param * C;\n   596→    yy = lineStart.y + param * D;\n   597→  }\n   598→\n   599→  const dx = point.x - xx;\n   600→  const dy = point.y - yy;\n   601→\n   602→  const sign =\n   603→    (lineEnd.y - lineStart.y) * point.x -\n   604→      (lineEnd.x - lineStart.x) * point.y +\n   605→      lineEnd.x * lineStart.y -\n   606→      lineEnd.y * lineStart.x >=\n   607→    0\n   608→      ? 1\n   609→      : -1;\n   610→\n   611→  return sign * Math.sqrt(dx * dx + dy * dy);\n   612→}\n   613→\n   614→// ============================================\n   615→// PERCENTILE & PSL CONVERSION\n   616→// ============================================\n   617→\n   618→/**\n   619→ * Calculate percentile from harmony score\n   620→ */\n   621→export function calculateHarmonyPercentile(score: number): number {\n   622→  // Based on normal distribution with mean=5, stdDev=1.5\n   623→  const mean = 5;\n   624→  const stdDev = 1.5;\n   625→  const z = (score - mean) / stdDev;\n   626→  return normalCDF(z) * 100;\n   627→}\n   628→\n   629→/**\n   630→ * Standard normal CDF approximation\n   631→ */\n   632→export function normalCDF(z: number): number {\n   633→  const a1 = 0.254829592;\n   634→  const a2 = -0.284496736;\n   635→  const a3 = 1.421413741;\n   636→  const a4 = -1.453152027;\n   637→  const a5 = 1.061405429;\n   638→  const p = 0.3275911;\n   639→\n   640→  const sign = z < 0 ? -1 : 1;\n   641→  const absZ = Math.abs(z) / Math.sqrt(2);\n   642→\n   643→  const t = 1.0 / (1.0 + p * absZ);\n   644→  const y = 1.0 - ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-absZ * absZ);\n   645→\n   646→  return 0.5 * (1.0 + sign * y);\n   647→}\n   648→\n   649→// ============================================\n   650→// PSL RATING CONVERSION\n   651→// ============================================\n   652→\n   653→export interface PSLRating {\n   654→  score: number;\n   655→  tier: string;\n   656→  percentile: number;\n   657→  description: string;\n   658→}\n   659→\n   660→/**\n   661→ * Convert harmony score to PSL rating\n   662→ */\n   663→export function convertToPSL(harmonyScore: number): PSLRating {\n   664→  // Convert 0-10 harmony to 3.0-7.5 PSL range\n   665→  const psl = 3.0 + (harmonyScore / 10) * 4.5;\n   666→  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n   667→\n   668→  let tier: string;\n   669→  let percentile: number;\n   670→\n   671→  if (clampedPSL >= 7.5) {\n   672→    tier = 'Top Model';\n   673→    percentile = 99.99;\n   674→  } else if (clampedPSL >= 7.0) {\n   675→    tier = 'Chad';\n   676→    percentile = 99.87;\n   677→  } else if (clampedPSL >= 6.5) {\n   678→    tier = 'Chadlite';\n   679→    percentile = 99.0;\n   680→  } else if (clampedPSL >= 6.0) {\n   681→    tier = 'High Tier Normie+';\n   682→    percentile = 97.25;\n   683→  } else if (clampedPSL >= 5.5) {\n   684→    tier = 'High Tier Normie';\n   685→    percentile = 90.0;\n   686→  } else if (clampedPSL >= 5.0) {\n   687→    tier = 'Mid Tier Normie+';\n   688→    percentile = 84.15;\n   689→  } else if (clampedPSL >= 4.5) {\n   690→    tier = 'Mid Tier Normie';\n   691→    percentile = 65.0;\n   692→  } else if (clampedPSL >= 4.0) {\n   693→    tier = 'Low Tier Normie';\n   694→    percentile = 50.0;\n   695→  } else if (clampedPSL >= 3.5) {\n   696→    tier = 'Below Average';\n   697→    percentile = 30.0;\n   698→  } else {\n   699→    tier = 'Subpar';\n   700→    percentile = 15.0;\n   701→  }\n   702→\n   703→  return {\n   704→    score: clampedPSL,\n   705→    tier,\n   706→    percentile,\n   707→    description: `${tier} (top ${(100 - percentile).toFixed(1)}%)`,\n   708→  };\n   709→}\n   710→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e47d65c1-0412-4934-8b46-2892fe0d14db","timestamp":"2025-12-26T06:49:39.276Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/calculator.ts","content":"/**\n * Scoring Calculator\n * Core scoring algorithm functions extracted from harmony-scoring.ts\n *\n * Features:\n * - Exponential decay scoring with per-metric decay rates\n * - Bezier curve custom scoring for non-linear measurements\n * - Directional/Dimorphic scoring (polarity support)\n * - Quality tiers and severity levels\n */\n\nimport {\n  Point,\n  QualityTier,\n  SeverityLevel,\n  MeasurementUnit,\n  MetricConfig,\n  CurvePoint,\n  FlawMapping,\n} from './types';\nimport { BEZIER_CURVES } from '@/lib/bezier-curves';\n\n// ============================================\n// FLAW MAPPINGS\n// ============================================\n\nexport const METRIC_FLAW_MAPPINGS: Record<string, FlawMapping[]> = {\n  anteriorFacialDepth: [\n    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Anterior Facial Depth measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n  ],\n  bitemporalWidth: [\n    { category: 'Upper Third', flawName: 'Narrow forehead', confidence: 'confirmed', reasoning: 'Reduced bitemporal width indicates a narrower than ideal forehead relative to the cheekbones. This disrupts facial harmony by creating a compressed hairline and forehead, altering the overall shape of the face.' },\n  ],\n  cheekboneHeight: [\n    { category: 'Midface/Face Shape', flawName: 'Low-set cheekbones', confidence: 'confirmed', reasoning: 'Reduced cheekbone height indicates that the cheekbones are positioned lower than ideal. This disrupts facial harmony by creating an unpronounced appearance to the cheekbones and facial structure.' },\n  ],\n  cheekFullness: [\n    { category: 'Midface/Face Shape', flawName: 'Hollow/Gaunt midface', confidence: 'confirmed', reasoning: 'Reduced cheek fullness indicates volume loss or hollow cheeks. This disrupts facial harmony by creating a gaunt or aged appearance, particularly important in South Asian and East Asian beauty standards.' },\n  ],\n  eyeAspectRatio: [\n    { category: 'Eyes', flawName: 'Overly round eye shape', confidence: 'confirmed', reasoning: 'A reduced eye aspect ratio indicates overly narrow eyes relative to their height. This disrupts facial harmony by creating an overly surprised appearance and reducing angular definition.' },\n  ],\n  eyeSeparationRatio: [\n    { category: 'Eyes', flawName: 'Close-set eyes', confidence: 'confirmed', reasoning: 'Reduced eye separation indicates close-set eyes. This disrupts facial harmony by making the eye area appear too compressed.' },\n  ],\n  eyebrowLowSetedness: [\n    { category: 'Eyes', flawName: 'Medium-set eyebrows', confidence: 'confirmed', reasoning: 'Increased eyebrow low setedness indicates eyebrows that are positioned higher than ideal. This disrupts facial harmony by reducing the overall visual impact of the eyebrows and framing of the eyes.' },\n  ],\n  faceWidthToHeight: [\n    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced face width to height ratio indicates an overly long midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n  ],\n  facialDepthToHeight: [\n    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'Reduced facial depth to height ratio indicates insufficient mid-face projection relative to height. This disrupts facial harmony by creating the appearance of a flat midface.' },\n  ],\n  gonialAngle: [\n    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony in the lower face.' },\n    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n  ],\n  holdawayHLine: [\n    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'Decreased H-line indicates the lips are positioned too far in front of the line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n  ],\n  interiorMidfaceProjectionAngle: [\n    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Interior Midface Projection Angle measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n  ],\n  ipsilateralAlarAngle: [\n    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A decreased ipsilateral alar angle indicates an overly narrow interior midface. This disrupts facial harmony by overemphasizing the middle of the face.' },\n  ],\n  jawFrontalAngle: [\n    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A narrower jaw frontal angle indicates a steeper jawline or overly wide chin. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n  ],\n  jawSlope: [\n    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'The Jaw Slope measurement is above the ideal range. This disrupts facial harmony in the lower face.' },\n  ],\n  lateralCanthalTilt: [\n    { category: 'Eyes', flawName: 'Insufficient eye tilt', confidence: 'confirmed', reasoning: 'A decreased lateral canthal tilt indicates insufficiently upturned eyes. This disrupts facial harmony by creating a less alert and youthful appearance.' },\n  ],\n  burstoneLowerLip: [\n    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the Burstone line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n  ],\n  eLineLowerLip: [\n    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned too far in front of the E-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n  ],\n  sLineLowerLip: [\n    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the S-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n  ],\n  lowerThirdProportion: [\n    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'The upper jaw is too long relative to lower jaw, possibly from a long upper jaw or short lower jaw, or a combination of both. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n  ],\n  mandibularPlaneAngle: [\n    { category: 'Occlusion/Jaw Growth', flawName: 'Hyper-divergent jaw growth', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by elongating the lower face.' },\n    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony in the lower face.' },\n    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n  ],\n  midfaceRatio: [\n    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n  ],\n  nasofacialAngle: [\n    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A smaller nasofacial angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n  ],\n  nasofrontalAngle: [\n    { category: 'Upper Third', flawName: 'Soft and weak brow ridge', confidence: 'confirmed', reasoning: 'An increased nasofrontal angle indicates reduced brow ridge prominence and angularity. This disrupts facial harmony by creating a less defined upper face.' },\n  ],\n  nasomentaAngle: [\n    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A larger nasomental angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n  ],\n  noseBridgeWidth: [\n    { category: 'Nose', flawName: 'Overly narrow nose bridge', confidence: 'confirmed', reasoning: 'The Nose Bridge to Nose Width measurement is above the ideal range. This disrupts facial harmony by creating an unbalanced nasal profile.' },\n  ],\n  orbitalVector: [\n    { category: 'Eyes', flawName: 'Sunken orbital region', confidence: 'confirmed', reasoning: 'A decreased orbital vector indicates insufficient projection and volume underneath the eye. This disrupts facial harmony due to the lacking volume underneath the eyes, reducing vibrancy and youthfulness.' },\n  ],\n  ramusToMandibleRatio: [\n    { category: 'Jaw Shape', flawName: 'Short ramus', confidence: 'confirmed', reasoning: 'A reduced ramus-to-mandible ratio indicates a shorter than ideal vertical jawbone (ramus) when compared to the mandible. This disrupts facial harmony by reducing jaw height and definition.' },\n  ],\n  submentalCervicalAngle: [\n    { category: 'Neck', flawName: 'Round neck region', confidence: 'confirmed', reasoning: 'An increased submental cervical angle indicates a round neck region, possibly from excess submental fat or tissue. This disrupts facial harmony by reducing neck definition.' },\n  ],\n  totalFacialWidthToHeight: [\n    { category: 'Midface/Face Shape', flawName: 'Overly long face shape', confidence: 'confirmed', reasoning: 'An increased total facial width to height ratio indicates an overly long face relative to its height. This disrupts facial harmony by creating a vertically stretched appearance to the face.' },\n  ],\n};\n\n// ============================================\n// CUSTOM BEZIER CURVES (Ethnicity-specific override)\n// ============================================\n\nexport const METRIC_CUSTOM_CURVES: Record<string, CurvePoint[]> = {\n  faceWidthToHeight: [\n    { x: 1.49, y: 0, leftHandleX: 1.44, leftHandleY: 0, rightHandleX: 1.55, rightHandleY: 0 },\n    { x: 1.68, y: 1.05, leftHandleX: 1.62, leftHandleY: 0.36, rightHandleX: 1.71, rightHandleY: 1.58 },\n    { x: 1.77, y: 3.07, leftHandleX: 1.74, leftHandleY: 2.15, rightHandleX: 1.79, rightHandleY: 3.88 },\n    { x: 1.83, y: 5.83, leftHandleX: 1.8, leftHandleY: 4.64, rightHandleX: 1.84, rightHandleY: 6.85 },\n    { x: 1.89, y: 8.7, leftHandleX: 1.88, leftHandleY: 8.3, rightHandleX: 1.92, rightHandleY: 9.5 },\n    { x: 1.96, y: 10, leftHandleX: 1.96, leftHandleY: 10, rightHandleX: 1.96, rightHandleY: 10, fixed: true },\n    { x: 2, y: 10, leftHandleX: 2, leftHandleY: 10, rightHandleX: 2, rightHandleY: 10 },\n    { x: 2.07, y: 8.7, leftHandleX: 2.04, leftHandleY: 9.5, rightHandleX: 2.08, rightHandleY: 8.3 },\n    { x: 2.13, y: 5.83, leftHandleX: 2.12, leftHandleY: 6.85, rightHandleX: 2.16, rightHandleY: 4.64 },\n    { x: 2.19, y: 3.07, leftHandleX: 2.17, leftHandleY: 3.88, rightHandleX: 2.22, rightHandleY: 2.15 },\n    { x: 2.28, y: 1.05, leftHandleX: 2.25, leftHandleY: 1.58, rightHandleX: 2.34, rightHandleY: 0.36 },\n    { x: 2.47, y: 0, leftHandleX: 2.41, leftHandleY: 0, rightHandleX: 2.52, rightHandleY: 0 },\n  ],\n  lowerThirdProportion: [\n    { x: 25.6, y: 0, leftHandleX: 24.8, leftHandleY: 0, rightHandleX: 26.4, rightHandleY: 0 },\n    { x: 28.01, y: 1.58, leftHandleX: 27.23, leftHandleY: 0.53, rightHandleX: 28.27, rightHandleY: 1.97 },\n    { x: 28.83, y: 3.21, leftHandleX: 28.62, leftHandleY: 2.59, rightHandleX: 29.03, rightHandleY: 3.76 },\n    { x: 29.63, y: 5.85, leftHandleX: 29.38, leftHandleY: 4.64, rightHandleX: 29.84, rightHandleY: 6.61 },\n    { x: 30.27, y: 8.56, leftHandleX: 30.1, leftHandleY: 7.71, rightHandleX: 30.52, rightHandleY: 9.42 },\n    { x: 31, y: 10, leftHandleX: 30.88, leftHandleY: 10, rightHandleX: 31.13, rightHandleY: 10, fixed: true },\n    { x: 33.5, y: 10, leftHandleX: 33.38, leftHandleY: 10, rightHandleX: 33.63, rightHandleY: 10 },\n    { x: 34.23, y: 8.56, leftHandleX: 33.98, leftHandleY: 9.42, rightHandleX: 34.4, rightHandleY: 7.71 },\n    { x: 34.87, y: 5.85, leftHandleX: 34.66, leftHandleY: 6.61, rightHandleX: 35.12, rightHandleY: 4.64 },\n    { x: 35.67, y: 3.21, leftHandleX: 35.47, leftHandleY: 3.76, rightHandleX: 35.88, rightHandleY: 2.59 },\n    { x: 36.49, y: 1.58, leftHandleX: 36.23, leftHandleY: 1.97, rightHandleX: 37.27, rightHandleY: 0.53 },\n    { x: 38.9, y: 0, leftHandleX: 38.1, leftHandleY: 0, rightHandleX: 39.7, rightHandleY: 0 },\n  ],\n  eyeAspectRatio: [\n    { x: 1.44, y: 0, leftHandleX: 1.18, leftHandleY: 0, rightHandleX: 1.75, rightHandleY: 0.38 },\n    { x: 2.07, y: 1.66, leftHandleX: 1.96, leftHandleY: 1.08, rightHandleX: 2.24, rightHandleY: 2.63 },\n    { x: 2.42, y: 4.34, leftHandleX: 2.35, leftHandleY: 3.6, rightHandleX: 2.52, rightHandleY: 5.5 },\n    { x: 2.71, y: 7.96, leftHandleX: 2.65, leftHandleY: 7.13, rightHandleX: 2.8, rightHandleY: 9.08 },\n    { x: 3, y: 10, leftHandleX: 2.98, leftHandleY: 10, rightHandleX: 3.03, rightHandleY: 10, fixed: true },\n    { x: 3.5, y: 10, leftHandleX: 3.48, leftHandleY: 10, rightHandleX: 3.53, rightHandleY: 10 },\n    { x: 3.79, y: 7.96, leftHandleX: 3.7, leftHandleY: 9.08, rightHandleX: 3.85, rightHandleY: 7.13 },\n    { x: 4.08, y: 4.34, leftHandleX: 3.98, leftHandleY: 5.5, rightHandleX: 4.15, rightHandleY: 3.6 },\n    { x: 4.43, y: 1.66, leftHandleX: 4.26, leftHandleY: 2.63, rightHandleX: 4.54, rightHandleY: 1.08 },\n    { x: 5.06, y: 0, leftHandleX: 4.75, leftHandleY: 0.38, rightHandleX: 5.32, rightHandleY: 0 },\n  ],\n  // Note: Additional curves can be added from METRIC_CUSTOM_CURVES in harmony-scoring.ts\n};\n\n// ============================================\n// CORE SCORING FUNCTIONS\n// ============================================\n\n/**\n * Exponential Decay Scoring Algorithm with Directional/Dimorphic Support\n *\n * Standard: score = maxScore * e^(-decayRate * deviation)\n *\n * Directional scoring (polarity):\n * - 'higher_is_better': Values above safeFloor but below ideal get softZoneScore\n *   Example: Canthal Tilt of 3 degrees is still positive/good, just not peak ideal (6-8 degrees)\n * - 'lower_is_better': Values below safeCeiling but above ideal get softZoneScore\n *   Example: Short philtrum is still attractive even if shorter than \"ideal\"\n */\nexport function calculateMetricScore(\n  value: number,\n  config: MetricConfig\n): number {\n  const {\n    id,\n    idealMin,\n    idealMax,\n    decayRate,\n    maxScore,\n    customCurve,\n    polarity = 'balanced',\n    safeFloor,\n    safeCeiling,\n    softZoneScore = 8.0, // Default \"Good\" score for acceptable-but-not-ideal values\n  } = config;\n\n  // IMPORTANT: Check demographic-adjusted ideal range FIRST\n  // This ensures that demographic overrides are respected even when Bezier curves exist\n  // (Bezier curves are optimized for base ranges and don't auto-adjust for demographics)\n  if (value >= idealMin && value <= idealMax) {\n    return maxScore;\n  }\n\n  // Use custom curve if available in config\n  if (customCurve && customCurve.mode === 'custom') {\n    const bezierScore = interpolateCustomCurve(value, customCurve.points, maxScore);\n    // If Bezier returns -1, it means value is out of range with edge y=0\n    // Fall through to exponential decay instead of returning 0\n    if (bezierScore >= 0) {\n      // Clamp to valid range [0, maxScore] to prevent Bezier overshoot\n      return Math.max(0, Math.min(maxScore, bezierScore));\n    }\n  }\n\n  // Check for pre-defined Bezier curve from harmony curves (66 metrics)\n  const bezierCurve = BEZIER_CURVES[id];\n  if (bezierCurve && bezierCurve.mode === 'custom') {\n    const bezierScore = interpolateCustomCurve(value, bezierCurve.points, maxScore);\n    // If Bezier returns -1, it means value is out of range with edge y=0\n    // Fall through to exponential decay instead of returning 0\n    if (bezierScore >= 0) {\n      // Clamp to valid range [0, maxScore] to prevent Bezier overshoot\n      return Math.max(0, Math.min(maxScore, bezierScore));\n    }\n  }\n\n  // Handle directional/dimorphic scoring\n  if (polarity === 'higher_is_better' && safeFloor !== undefined) {\n    // Higher values are good. Only values below safeFloor are true weaknesses.\n    if (value >= safeFloor && value < idealMin) {\n      // Value is in the \"acceptable but not ideal\" zone\n      // Give a passing score that decreases linearly as we approach the floor\n      const zoneRange = idealMin - safeFloor;\n      const distanceFromIdeal = idealMin - value;\n      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n      // Linear interpolation: idealMin -> maxScore, safeFloor -> softZoneScore\n      return maxScore - t * (maxScore - softZoneScore);\n    }\n    if (value >= idealMax) {\n      // Values above ideal are still excellent for 'higher_is_better'\n      // Apply gentler decay (1/3 the normal rate)\n      const deviation = value - idealMax;\n      const gentleDecay = decayRate / 3;\n      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n    }\n    // Below safeFloor - apply normal (or harsher) exponential decay\n    if (value < safeFloor) {\n      const deviation = safeFloor - value;\n      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n    }\n  }\n\n  if (polarity === 'lower_is_better' && safeCeiling !== undefined) {\n    // Lower values are good. Only values above safeCeiling are true weaknesses.\n    if (value <= safeCeiling && value > idealMax) {\n      // Value is in the \"acceptable but not ideal\" zone\n      const zoneRange = safeCeiling - idealMax;\n      const distanceFromIdeal = value - idealMax;\n      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n      // Linear interpolation: idealMax -> maxScore, safeCeiling -> softZoneScore\n      return maxScore - t * (maxScore - softZoneScore);\n    }\n    if (value <= idealMin) {\n      // Values below ideal are still excellent for 'lower_is_better'\n      // Apply gentler decay (1/3 the normal rate)\n      const deviation = idealMin - value;\n      const gentleDecay = decayRate / 3;\n      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n    }\n    // Above safeCeiling - apply normal exponential decay\n    if (value > safeCeiling) {\n      const deviation = value - safeCeiling;\n      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n    }\n  }\n\n  // Default balanced scoring: deviation in either direction is equally bad\n  const deviation = value < idealMin\n    ? idealMin - value\n    : value - idealMax;\n\n  // Exponential decay\n  const score = maxScore * Math.exp(-decayRate * deviation);\n\n  return Math.max(0, Math.min(maxScore, score));\n}\n\n/**\n * Check if a metric value is in an \"acceptable\" zone (not a true weakness).\n * Used by InsightsEngine to prevent false positives.\n */\nexport function isValueAcceptable(\n  value: number,\n  config: MetricConfig\n): { acceptable: boolean; reason: string } {\n  const {\n    idealMin,\n    idealMax,\n    polarity = 'balanced',\n    safeFloor,\n    safeCeiling,\n  } = config;\n\n  // Within ideal range is always acceptable\n  if (value >= idealMin && value <= idealMax) {\n    return { acceptable: true, reason: 'within_ideal' };\n  }\n\n  // Check directional acceptability\n  if (polarity === 'higher_is_better') {\n    if (value >= idealMax) {\n      return { acceptable: true, reason: 'above_ideal_higher_is_better' };\n    }\n    if (safeFloor !== undefined && value >= safeFloor) {\n      return { acceptable: true, reason: 'above_safe_floor' };\n    }\n    // Below safe floor - true weakness\n    return { acceptable: false, reason: 'below_safe_floor' };\n  }\n\n  if (polarity === 'lower_is_better') {\n    if (value <= idealMin) {\n      return { acceptable: true, reason: 'below_ideal_lower_is_better' };\n    }\n    if (safeCeiling !== undefined && value <= safeCeiling) {\n      return { acceptable: true, reason: 'below_safe_ceiling' };\n    }\n    // Above safe ceiling - true weakness\n    return { acceptable: false, reason: 'above_safe_ceiling' };\n  }\n\n  // Balanced polarity - outside ideal is not acceptable\n  return { acceptable: false, reason: 'outside_ideal_balanced' };\n}\n\n/**\n * Interpolate custom Bezier curve for scoring\n * Uses cubic Bezier interpolation with control handles for smooth curves\n *\n * IMPORTANT: When value is outside the curve range and the edge y-value is 0,\n * returns -1 to signal the caller should use exponential decay fallback.\n * This prevents artificially returning 0 for values just outside the curve.\n */\nexport function interpolateCustomCurve(\n  value: number,\n  points: CurvePoint[],\n  maxScore: number\n): number {\n  void maxScore; // Reserved for future custom curve implementations\n  if (points.length === 0) return -1; // Signal to use fallback\n\n  // Sort points by x value\n  const sortedPoints = [...points].sort((a, b) => a.x - b.x);\n\n  // Handle out-of-range values\n  // If edge y-value is 0, return -1 to signal exponential decay fallback should be used\n  if (value <= sortedPoints[0].x) {\n    const edgeY = sortedPoints[0].y;\n    // If edge score is 0, signal to use exponential decay fallback\n    return edgeY <= 0 ? -1 : edgeY;\n  }\n  if (value >= sortedPoints[sortedPoints.length - 1].x) {\n    const edgeY = sortedPoints[sortedPoints.length - 1].y;\n    // If edge score is 0, signal to use exponential decay fallback\n    return edgeY <= 0 ? -1 : edgeY;\n  }\n\n  // Find bracketing points\n  let lowerIndex = 0;\n  for (let i = 0; i < sortedPoints.length - 1; i++) {\n    if (value >= sortedPoints[i].x && value <= sortedPoints[i + 1].x) {\n      lowerIndex = i;\n      break;\n    }\n  }\n\n  const p0 = sortedPoints[lowerIndex];\n  const p3 = sortedPoints[lowerIndex + 1];\n\n  // Check if we have Bezier control handles\n  const hasHandles = p0.rightHandleX !== undefined && p3.leftHandleX !== undefined;\n\n  if (hasHandles) {\n    // Cubic Bezier interpolation with control points\n    const p1x = p0.rightHandleX!;\n    const p1y = p0.rightHandleY ?? p0.y;\n    const p2x = p3.leftHandleX!;\n    const p2y = p3.leftHandleY ?? p3.y;\n\n    // Find t parameter for given x value using Newton-Raphson iteration\n    let t = (value - p0.x) / (p3.x - p0.x); // Initial guess\n\n    // Newton-Raphson iterations to find t where B_x(t) = value\n    for (let iter = 0; iter < 10; iter++) {\n      const bx = cubicBezier(p0.x, p1x, p2x, p3.x, t);\n      const bxDerivative = cubicBezierDerivative(p0.x, p1x, p2x, p3.x, t);\n\n      if (Math.abs(bxDerivative) < 1e-10) break;\n\n      const newT = t - (bx - value) / bxDerivative;\n      if (Math.abs(newT - t) < 1e-10) break;\n      t = Math.max(0, Math.min(1, newT));\n    }\n\n    // Calculate y using the found t parameter\n    return cubicBezier(p0.y, p1y, p2y, p3.y, t);\n  } else {\n    // Smooth interpolation using Catmull-Rom spline\n    // This provides smoother curves than linear interpolation\n    const t = (value - p0.x) / (p3.x - p0.x);\n\n    // Get neighboring points for spline calculation\n    const pMinus1 = lowerIndex > 0 ? sortedPoints[lowerIndex - 1] : p0;\n    const p4 = lowerIndex + 2 < sortedPoints.length ? sortedPoints[lowerIndex + 2] : p3;\n\n    // Catmull-Rom spline interpolation\n    return catmullRomSpline(pMinus1.y, p0.y, p3.y, p4.y, t);\n  }\n}\n\n/**\n * Cubic Bezier curve evaluation: B(t) = (1-t)^3*P0 + 3*(1-t)^2*t*P1 + 3*(1-t)*t^2*P2 + t^3*P3\n */\nexport function cubicBezier(p0: number, p1: number, p2: number, p3: number, t: number): number {\n  const mt = 1 - t;\n  const mt2 = mt * mt;\n  const mt3 = mt2 * mt;\n  const t2 = t * t;\n  const t3 = t2 * t;\n  return mt3 * p0 + 3 * mt2 * t * p1 + 3 * mt * t2 * p2 + t3 * p3;\n}\n\n/**\n * Cubic Bezier derivative: B'(t) = 3*(1-t)^2*(P1-P0) + 6*(1-t)*t*(P2-P1) + 3*t^2*(P3-P2)\n */\nexport function cubicBezierDerivative(p0: number, p1: number, p2: number, p3: number, t: number): number {\n  const mt = 1 - t;\n  return 3 * mt * mt * (p1 - p0) + 6 * mt * t * (p2 - p1) + 3 * t * t * (p3 - p2);\n}\n\n/**\n * Catmull-Rom spline interpolation for smooth curves without explicit handles\n */\nexport function catmullRomSpline(p0: number, p1: number, p2: number, p3: number, t: number): number {\n  const t2 = t * t;\n  const t3 = t2 * t;\n\n  // Catmull-Rom coefficients with tension = 0.5\n  const a = -0.5 * p0 + 1.5 * p1 - 1.5 * p2 + 0.5 * p3;\n  const b = p0 - 2.5 * p1 + 2 * p2 - 0.5 * p3;\n  const c = -0.5 * p0 + 0.5 * p2;\n  const d = p1;\n\n  return a * t3 + b * t2 + c * t + d;\n}\n\n/**\n * Calculate standardized score (0-10 normalized)\n * Clamps output to [0, 10] to prevent display issues from scoring edge cases\n */\nexport function standardizeScore(score: number, maxScore: number): number {\n  const normalized = (score / maxScore) * 10;\n  return Math.max(0, Math.min(10, normalized));\n}\n\n/**\n * Determine quality tier based on score\n */\nexport function getQualityTier(score: number, maxScore: number = 10): QualityTier {\n  const normalized = (score / maxScore) * 100;\n\n  if (normalized >= 90) return 'ideal';\n  if (normalized >= 70) return 'excellent';\n  if (normalized >= 50) return 'good';\n  return 'below_average';\n}\n\n/**\n * Determine severity level based on score\n */\nexport function getSeverityLevel(score: number, maxScore: number = 10): SeverityLevel {\n  const normalized = (score / maxScore) * 100;\n\n  if (normalized >= 85) return 'optimal';\n  if (normalized >= 70) return 'minor';\n  if (normalized >= 50) return 'moderate';\n  if (normalized >= 30) return 'major';\n  if (normalized >= 15) return 'severe';\n  return 'extremely_severe';\n}\n\n/**\n * Calculate deviation description\n */\nexport function getDeviationDescription(\n  value: number,\n  idealMin: number,\n  idealMax: number,\n  unit: MeasurementUnit\n): { deviation: number; direction: 'above' | 'below' | 'within'; description: string } {\n  if (value >= idealMin && value <= idealMax) {\n    return { deviation: 0, direction: 'within', description: 'within ideal range' };\n  }\n\n  const unitLabel = getUnitLabel(unit);\n\n  if (value < idealMin) {\n    const dev = idealMin - value;\n    return {\n      deviation: dev,\n      direction: 'below',\n      description: `${dev.toFixed(2)}${unitLabel} below ideal`,\n    };\n  }\n\n  const dev = value - idealMax;\n  return {\n    deviation: dev,\n    direction: 'above',\n    description: `${dev.toFixed(2)}${unitLabel} above ideal`,\n  };\n}\n\n/**\n * Get unit label for display\n */\nexport function getUnitLabel(unit: MeasurementUnit): string {\n  switch (unit) {\n    case 'ratio': return 'x';\n    case 'percent': return '%';\n    case 'degrees': return '\\u00B0';\n    case 'mm': return 'mm';\n    default: return '';\n  }\n}\n\n// ============================================\n// GEOMETRY HELPERS\n// ============================================\n\n/**\n * Calculate distance between two points\n */\nexport function distance(p1: Point, p2: Point): number {\n  return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));\n}\n\n/**\n * Calculate angle at vertex point (in degrees)\n */\nexport function calculateAngle(p1: Point, vertex: Point, p2: Point): number {\n  const v1 = { x: p1.x - vertex.x, y: p1.y - vertex.y };\n  const v2 = { x: p2.x - vertex.x, y: p2.y - vertex.y };\n\n  const dot = v1.x * v2.x + v1.y * v2.y;\n  const cross = v1.x * v2.y - v1.y * v2.x;\n\n  const angle = Math.atan2(cross, dot) * (180 / Math.PI);\n  return Math.abs(angle);\n}\n\n/**\n * Calculate perpendicular distance from point to line (signed)\n */\nexport function perpendicularDistance(\n  point: Point,\n  lineStart: Point,\n  lineEnd: Point\n): number {\n  const A = point.x - lineStart.x;\n  const B = point.y - lineStart.y;\n  const C = lineEnd.x - lineStart.x;\n  const D = lineEnd.y - lineStart.y;\n\n  const dot = A * C + B * D;\n  const lenSq = C * C + D * D;\n  const param = lenSq !== 0 ? dot / lenSq : -1;\n\n  let xx: number, yy: number;\n\n  if (param < 0) {\n    xx = lineStart.x;\n    yy = lineStart.y;\n  } else if (param > 1) {\n    xx = lineEnd.x;\n    yy = lineEnd.y;\n  } else {\n    xx = lineStart.x + param * C;\n    yy = lineStart.y + param * D;\n  }\n\n  const dx = point.x - xx;\n  const dy = point.y - yy;\n\n  const sign =\n    (lineEnd.y - lineStart.y) * point.x -\n      (lineEnd.x - lineStart.x) * point.y +\n      lineEnd.x * lineStart.y -\n      lineEnd.y * lineStart.x >=\n    0\n      ? 1\n      : -1;\n\n  return sign * Math.sqrt(dx * dx + dy * dy);\n}\n\n// ============================================\n// PERCENTILE & PSL CONVERSION\n// ============================================\n\n/**\n * Calculate percentile from harmony score\n */\nexport function calculateHarmonyPercentile(score: number): number {\n  // Based on normal distribution with mean=5, stdDev=1.5\n  const mean = 5;\n  const stdDev = 1.5;\n  const z = (score - mean) / stdDev;\n  return normalCDF(z) * 100;\n}\n\n/**\n * Standard normal CDF approximation\n */\nexport function normalCDF(z: number): number {\n  const a1 = 0.254829592;\n  const a2 = -0.284496736;\n  const a3 = 1.421413741;\n  const a4 = -1.453152027;\n  const a5 = 1.061405429;\n  const p = 0.3275911;\n\n  const sign = z < 0 ? -1 : 1;\n  const absZ = Math.abs(z) / Math.sqrt(2);\n\n  const t = 1.0 / (1.0 + p * absZ);\n  const y = 1.0 - ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-absZ * absZ);\n\n  return 0.5 * (1.0 + sign * y);\n}\n\n// ============================================\n// PSL RATING CONVERSION\n// ============================================\n\nexport interface PSLRating {\n  score: number;\n  tier: string;\n  percentile: number;\n  description: string;\n}\n\n/**\n * Convert harmony score to PSL rating\n */\nexport function convertToPSL(harmonyScore: number): PSLRating {\n  // Convert 0-10 harmony to 3.0-7.5 PSL range\n  const psl = 3.0 + (harmonyScore / 10) * 4.5;\n  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n\n  let tier: string;\n  let percentile: number;\n\n  if (clampedPSL >= 7.5) {\n    tier = 'Top Model';\n    percentile = 99.99;\n  } else if (clampedPSL >= 7.0) {\n    tier = 'Chad';\n    percentile = 99.87;\n  } else if (clampedPSL >= 6.5) {\n    tier = 'Chadlite';\n    percentile = 99.0;\n  } else if (clampedPSL >= 6.0) {\n    tier = 'High Tier Normie+';\n    percentile = 97.25;\n  } else if (clampedPSL >= 5.5) {\n    tier = 'High Tier Normie';\n    percentile = 90.0;\n  } else if (clampedPSL >= 5.0) {\n    tier = 'Mid Tier Normie+';\n    percentile = 84.15;\n  } else if (clampedPSL >= 4.5) {\n    tier = 'Mid Tier Normie';\n    percentile = 65.0;\n  } else if (clampedPSL >= 4.0) {\n    tier = 'Low Tier Normie';\n    percentile = 50.0;\n  } else if (clampedPSL >= 3.5) {\n    tier = 'Below Average';\n    percentile = 30.0;\n  } else {\n    tier = 'Subpar';\n    percentile = 15.0;\n  }\n\n  return {\n    score: clampedPSL,\n    tier,\n    percentile,\n    description: `${tier} (top ${(100 - percentile).toFixed(1)}%)`,\n  };\n}\n","numLines":710,"startLine":1,"totalLines":710}}}
{"parentUuid":"e47d65c1-0412-4934-8b46-2892fe0d14db","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WBz76ih2UfrMqqTeJB37VZ","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\n     4→import { LandmarkPoint } from '@/lib/landmarks';\n     5→import {\n     6→  analyzeFrontProfile,\n     7→  analyzeSideProfile,\n     8→  analyzeHarmony,\n     9→  HarmonyAnalysis,\n    10→  MetricScoreResult,\n    11→  METRIC_CONFIGS,\n    12→  Ethnicity,\n    13→  Gender,\n    14→} from '@/lib/harmony-scoring';\n    15→import {\n    16→  calculateHarmonyScore,\n    17→  getTopMetrics,\n    18→  getBottomMetrics,\n    19→  HarmonyScoreResult,\n    20→  RankedMetric,\n    21→} from '@/lib/looksmax-scoring';\n    22→import { harmonyToPSL } from '@/lib/recommendations/severity';\n    23→import {\n    24→  classifyInsights,\n    25→  convertToStrength,\n    26→  convertToFlaw,\n    27→  INSIGHTS_DEFINITIONS,\n    28→} from '@/lib/insights-engine';\n    29→import { classifyMetric } from '@/lib/taxonomy';\n    30→import {\n    31→  Ratio,\n    32→  Strength,\n    33→  Flaw,\n    34→  Recommendation,\n    35→  ResultsTab,\n    36→  FullHarmonyAnalysis,\n    37→} from '@/types/results';\n    38→import { generateRecommendations } from '@/lib/results/analysis';\n    39→\n    40→// ============================================\n    41→// CONTEXT TYPES\n    42→// ============================================\n    43→\n    44→interface ResultsContextType {\n    45→  // Raw data\n    46→  frontLandmarks: LandmarkPoint[];\n    47→  sideLandmarks: LandmarkPoint[];\n    48→  gender: Gender;\n    49→  ethnicity: Ethnicity;\n    50→  frontPhoto: string;\n    51→  sidePhoto: string | null;\n    52→\n    53→  // Computed results\n    54→  harmonyAnalysis: FullHarmonyAnalysis | null;\n    55→  frontRatios: Ratio[];\n    56→  sideRatios: Ratio[];\n    57→  strengths: Strength[];\n    58→  flaws: Flaw[];\n    59→  recommendations: Recommendation[];\n    60→\n    61→  // Scores (now using weighted harmony from looksmax_engine.py)\n    62→  overallScore: number;\n    63→  frontScore: number;\n    64→  sideScore: number;\n    65→\n    66→  // Weighted Harmony Score (from looksmax_engine.py)\n    67→  harmonyScoreResult: HarmonyScoreResult | null;\n    68→  harmonyPercentage: number;  // 0-100% weighted harmony\n    69→\n    70→  // Top 3 strengths and bottom 3 areas to improve with advice\n    71→  topMetrics: RankedMetric[];\n    72→  bottomMetrics: RankedMetric[];\n    73→\n    74→  // PSL Rating (1-10 scale)\n    75→  pslRating: {\n    76→    psl: number;\n    77→    tier: string;\n    78→    percentile: number;\n    79→    description: string;\n    80→  };\n    81→\n    82→  // UI state\n    83→  activeTab: ResultsTab;\n    84→  setActiveTab: (tab: ResultsTab) => void;\n    85→  expandedMeasurementId: string | null;\n    86→  setExpandedMeasurementId: (id: string | null) => void;\n    87→  selectedVisualizationMetric: string | null;\n    88→  setSelectedVisualizationMetric: (id: string | null) => void;\n    89→  categoryFilter: string | null;\n    90→  setCategoryFilter: (category: string | null) => void;\n    91→  showLandmarkOverlay: boolean;\n    92→  setShowLandmarkOverlay: (show: boolean) => void;\n    93→\n    94→  // Actions\n    95→  setResultsData: (data: ResultsInputData) => void;\n    96→}\n    97→\n    98→interface ResultsInputData {\n    99→  frontLandmarks: LandmarkPoint[];\n   100→  sideLandmarks: LandmarkPoint[];\n   101→  frontPhoto: string;\n   102→  sidePhoto?: string;\n   103→  gender: Gender;\n   104→  ethnicity?: Ethnicity;\n   105→}\n   106→\n   107→// ============================================\n   108→// HELPER FUNCTIONS\n   109→// ============================================\n   110→\n   111→function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n   112→  switch (unit) {\n   113→    case 'ratio': return 'x';\n   114→    case 'percent': return '%';\n   115→    case 'degrees': return '°';\n   116→    case 'mm': return 'mm';\n   117→    default: return 'x';\n   118→  }\n   119→}\n   120→\n   121→function transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {\n   122→  const metricConfig = METRIC_CONFIGS[result.metricId];\n   123→\n   124→  // Generate illustration based on metric\n   125→  const illustration = generateIllustration(result.metricId, landmarks);\n   126→\n   127→  // Get flaw/strength mappings\n   128→  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n   129→\n   130→  // Classify metric using Harmony taxonomy\n   131→  const taxonomyClassification = classifyMetric(result.name, result.category);\n   132→\n   133→  // Clamp scores to valid 0-10 range for display (defense-in-depth)\n   134→  const clampedScore = Math.max(0, Math.min(10, result.standardizedScore));\n   135→\n   136→  return {\n   137→    id: result.metricId,\n   138→    name: result.name,\n   139→    value: result.value,\n   140→    score: clampedScore,  // Use standardized 0-10 score for UI display\n   141→    standardizedScore: clampedScore,\n   142→    unit: convertUnitToRatioUnit(result.unit),\n   143→    idealMin: result.idealMin,\n   144→    idealMax: result.idealMax,\n   145→    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n   146→    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n   147→    description: metricConfig?.description || '',\n   148→    category: result.category,\n   149→    qualityLevel: result.qualityTier,\n   150→    severity: result.severity,\n   151→    illustration,\n   152→    mayIndicateFlaws,\n   153→    mayIndicateStrengths,\n   154→    usedLandmarks: getUsedLandmarks(result.metricId),\n   155→    scoringCurveConfig: metricConfig ? {\n   156→      decayRate: metricConfig.decayRate,\n   157→      maxScore: metricConfig.maxScore,\n   158→    } : undefined,\n   159→    taxonomyPrimary: taxonomyClassification?.primary,\n   160→    taxonomySecondary: taxonomyClassification?.secondary,\n   161→  };\n   162→}\n   163→\n   164→// Enhanced illustration configuration type\n   165→interface IllustrationConfig {\n   166→  points: string[];\n   167→  lines: Array<{\n   168→    from: string;\n   169→    to: string;\n   170→    label?: string;\n   171→    color?: string;\n   172→    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n   173→  }>;\n   174→}\n   175→\n   176→// Comprehensive illustration configurations for all metrics\n   177→const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n   178→  // ==========================================\n   179→  // FACE SHAPE / PROPORTIONS\n   180→  // ==========================================\n   181→  faceWidthToHeight: {\n   182→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   183→    lines: [\n   184→      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n   185→      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n   186→    ],\n   187→  },\n   188→  totalFacialWidthToHeight: {\n   189→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   190→    lines: [\n   191→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   192→      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n   193→    ],\n   194→  },\n   195→  lowerThirdProportion: {\n   196→    points: ['subnasale', 'menton', 'trichion'],\n   197→    lines: [\n   198→      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n   199→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   200→    ],\n   201→  },\n   202→  middleThirdProportion: {\n   203→    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n   204→    lines: [\n   205→      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n   206→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   207→    ],\n   208→  },\n   209→  upperThirdProportion: {\n   210→    points: ['trichion', 'nasal_base', 'menton'],\n   211→    lines: [\n   212→      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n   213→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   214→    ],\n   215→  },\n   216→  bitemporalWidth: {\n   217→    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n   218→    lines: [\n   219→      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n   220→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n   221→    ],\n   222→  },\n   223→  cheekboneHeight: {\n   224→    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n   225→    lines: [\n   226→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n   227→      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n   228→    ],\n   229→  },\n   230→  midfaceRatio: {\n   231→    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n   232→    lines: [\n   233→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n   234→      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n   235→    ],\n   236→  },\n   237→\n   238→  // ==========================================\n   239→  // JAW MEASUREMENTS\n   240→  // ==========================================\n   241→  jawSlope: {\n   242→    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n   243→    lines: [\n   244→      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n   245→      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n   246→    ],\n   247→  },\n   248→  jawFrontalAngle: {\n   249→    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n   250→    lines: [\n   251→      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n   252→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n   253→    ],\n   254→  },\n   255→  bigonialWidth: {\n   256→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   257→    lines: [\n   258→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n   259→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   260→    ],\n   261→  },\n   262→  jawWidthRatio: {\n   263→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   264→    lines: [\n   265→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   266→      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n   267→    ],\n   268→  },\n   269→\n   270→  // ==========================================\n   271→  // EYE MEASUREMENTS\n   272→  // ==========================================\n   273→  lateralCanthalTilt: {\n   274→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n   275→    lines: [\n   276→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n   277→      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n   278→    ],\n   279→  },\n   280→  eyeAspectRatio: {\n   281→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n   282→    lines: [\n   283→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n   284→      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n   285→    ],\n   286→  },\n   287→  eyeSeparationRatio: {\n   288→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n   289→    lines: [\n   290→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   291→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   292→    ],\n   293→  },\n   294→  interpupillaryRatio: {\n   295→    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n   296→    lines: [\n   297→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   298→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   299→    ],\n   300→  },\n   301→  interpupillaryMouthWidthRatio: {\n   302→    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n   303→    lines: [\n   304→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   305→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   306→    ],\n   307→  },\n   308→  oneEyeApartTest: {\n   309→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n   310→    lines: [\n   311→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n   312→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n   313→    ],\n   314→  },\n   315→\n   316→  // ==========================================\n   317→  // EYEBROW MEASUREMENTS\n   318→  // ==========================================\n   319→  browLengthRatio: {\n   320→    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n   321→    lines: [\n   322→      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n   323→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   324→    ],\n   325→  },\n   326→  eyebrowTilt: {\n   327→    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n   328→    lines: [\n   329→      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n   330→      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n   331→    ],\n   332→  },\n   333→  eyebrowLowSetedness: {\n   334→    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n   335→    lines: [\n   336→      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n   337→    ],\n   338→  },\n   339→\n   340→  // ==========================================\n   341→  // NOSE MEASUREMENTS (FRONT)\n   342→  // ==========================================\n   343→  nasalIndex: {\n   344→    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n   345→    lines: [\n   346→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n   347→      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n   348→    ],\n   349→  },\n   350→  intercanthalNasalRatio: {\n   351→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n   352→    lines: [\n   353→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n   354→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   355→    ],\n   356→  },\n   357→  noseBridgeWidth: {\n   358→    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n   359→    lines: [\n   360→      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n   361→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n   362→    ],\n   363→  },\n   364→  noseTipPosition: {\n   365→    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n   366→    lines: [\n   367→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n   368→    ],\n   369→  },\n   370→\n   371→  // ==========================================\n   372→  // MOUTH/LIP MEASUREMENTS\n   373→  // ==========================================\n   374→  mouthNoseWidthRatio: {\n   375→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n   376→    lines: [\n   377→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   378→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n   379→    ],\n   380→  },\n   381→  lowerUpperLipRatio: {\n   382→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n   383→    lines: [\n   384→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n   385→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n   386→    ],\n   387→  },\n   388→  chinPhiltrumRatio: {\n   389→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n   390→    lines: [\n   391→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n   392→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n   393→    ],\n   394→  },\n   395→  mouthWidth: {\n   396→    points: ['left_cheilion', 'right_cheilion'],\n   397→    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n   398→  },\n   399→\n   400→  // ==========================================\n   401→  // CHIN MEASUREMENTS\n   402→  // ==========================================\n   403→  chinHeight: {\n   404→    points: ['labrale_inferius', 'menton'],\n   405→    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n   406→  },\n   407→\n   408→  // ==========================================\n   409→  // NECK MEASUREMENTS\n   410→  // ==========================================\n   411→  neckWidthRatio: {\n   412→    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n   413→    lines: [\n   414→      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n   415→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   416→    ],\n   417→  },\n   418→\n   419→  // ==========================================\n   420→  // SIDE PROFILE MEASUREMENTS\n   421→  // ==========================================\n   422→  gonialAngle: {\n   423→    points: ['tragus', 'gonionBottom', 'menton'],\n   424→    lines: [\n   425→      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   426→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   427→    ],\n   428→  },\n   429→  nasofrontalAngle: {\n   430→    points: ['glabella', 'nasion', 'pronasale'],\n   431→    lines: [\n   432→      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n   433→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   434→    ],\n   435→  },\n   436→  nasofacialAngle: {\n   437→    points: ['nasion', 'pronasale', 'pogonion'],\n   438→    lines: [\n   439→      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n   440→      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n   441→    ],\n   442→  },\n   443→  nasomentaAngle: {\n   444→    points: ['nasion', 'pronasale', 'pogonion'],\n   445→    lines: [\n   446→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   447→      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n   448→    ],\n   449→  },\n   450→  submentalCervicalAngle: {\n   451→    points: ['menton', 'cervicalPoint', 'neckPoint'],\n   452→    lines: [\n   453→      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n   454→      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n   455→    ],\n   456→  },\n   457→  facialDepthToHeight: {\n   458→    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n   459→    lines: [\n   460→      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n   461→      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n   462→    ],\n   463→  },\n   464→  anteriorFacialDepth: {\n   465→    points: ['glabella', 'pronasale', 'pogonion'],\n   466→    lines: [\n   467→      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n   468→      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n   469→    ],\n   470→  },\n   471→  mandibularPlaneAngle: {\n   472→    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n   473→    lines: [\n   474→      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n   475→      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n   476→    ],\n   477→  },\n   478→  ramusToMandibleRatio: {\n   479→    points: ['gonionTop', 'gonionBottom', 'menton'],\n   480→    lines: [\n   481→      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   482→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   483→    ],\n   484→  },\n   485→  orbitalVector: {\n   486→    points: ['cornealApex', 'orbitale', 'cheekbone'],\n   487→    lines: [\n   488→      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n   489→    ],\n   490→  },\n   491→  eLineLowerLip: {\n   492→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   493→    lines: [\n   494→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n   495→    ],\n   496→  },\n   497→  sLineLowerLip: {\n   498→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   499→    lines: [\n   500→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n   501→    ],\n   502→  },\n   503→  holdawayHLine: {\n   504→    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n   505→    lines: [\n   506→      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n   507→    ],\n   508→  },\n   509→  burstoneLowerLip: {\n   510→    points: ['subnasale', 'pogonion', 'labraleInferius'],\n   511→    lines: [\n   512→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n   513→    ],\n   514→  },\n   515→\n   516→  // ==========================================\n   517→  // ADDITIONAL FRONT PROFILE METRICS\n   518→  // ==========================================\n   519→  cupidsBowDepth: {\n   520→    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],\n   521→    lines: [\n   522→      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },\n   523→      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },\n   524→    ],\n   525→  },\n   526→  mouthCornerPosition: {\n   527→    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],\n   528→    lines: [\n   529→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },\n   530→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },\n   531→    ],\n   532→  },\n   533→  iaaJfaDeviation: {\n   534→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n   535→    lines: [\n   536→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },\n   537→      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },\n   538→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n   539→    ],\n   540→  },\n   541→  ipsilateralAlarAngle: {\n   542→    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],\n   543→    lines: [\n   544→      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },\n   545→      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },\n   546→    ],\n   547→  },\n   548→  earProtrusionAngle: {\n   549→    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],\n   550→    lines: [\n   551→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },\n   552→    ],\n   553→  },\n   554→  earProtrusionRatio: {\n   555→    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],\n   556→    lines: [\n   557→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },\n   558→      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },\n   559→    ],\n   560→  },\n   561→  mouthWidthToNoseRatio: {\n   562→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n   563→    lines: [\n   564→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   565→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n   566→    ],\n   567→  },\n   568→  lowerToUpperLipRatio: {\n   569→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n   570→    lines: [\n   571→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n   572→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n   573→    ],\n   574→  },\n   575→  chinToPhiltrumRatio: {\n   576→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n   577→    lines: [\n   578→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n   579→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n   580→    ],\n   581→  },\n   582→\n   583→  // ==========================================\n   584→  // ADDITIONAL SIDE PROFILE METRICS\n   585→  // ==========================================\n   586→  nasolabialAngle: {\n   587→    points: ['columella', 'subnasale', 'labraleSuperius'],\n   588→    lines: [\n   589→      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },\n   590→      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },\n   591→    ],\n   592→  },\n   593→  nasalTipAngle: {\n   594→    points: ['nasion', 'pronasale', 'columella'],\n   595→    lines: [\n   596→      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },\n   597→      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },\n   598→    ],\n   599→  },\n   600→  nasalProjection: {\n   601→    points: ['alar_crease', 'pronasale', 'subnasale'],\n   602→    lines: [\n   603→      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },\n   604→    ],\n   605→  },\n   606→  nasalWToHRatio: {\n   607→    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],\n   608→    lines: [\n   609→      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },\n   610→      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n   611→    ],\n   612→  },\n   613→  noseTipRotationAngle: {\n   614→    points: ['columella', 'subnasale', 'labraleSuperius'],\n   615→    lines: [\n   616→      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },\n   617→    ],\n   618→  },\n   619→  frankfortTipAngle: {\n   620→    points: ['porion', 'orbitale', 'pronasale'],\n   621→    lines: [\n   622→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   623→      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },\n   624→    ],\n   625→  },\n   626→  mentolabialAngle: {\n   627→    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],\n   628→    lines: [\n   629→      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },\n   630→      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },\n   631→    ],\n   632→  },\n   633→  zAngle: {\n   634→    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],\n   635→    lines: [\n   636→      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },\n   637→    ],\n   638→  },\n   639→  facialConvexityGlabella: {\n   640→    points: ['glabella', 'subnasale', 'pogonion'],\n   641→    lines: [\n   642→      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },\n   643→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   644→    ],\n   645→  },\n   646→  facialConvexityNasion: {\n   647→    points: ['nasion', 'subnasale', 'pogonion'],\n   648→    lines: [\n   649→      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },\n   650→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   651→    ],\n   652→  },\n   653→  totalFacialConvexity: {\n   654→    points: ['glabella', 'pronasale', 'pogonion'],\n   655→    lines: [\n   656→      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },\n   657→      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   658→    ],\n   659→  },\n   660→  interiorMidfaceProjectionAngle: {\n   661→    points: ['orbitale', 'subnasale', 'pronasale'],\n   662→    lines: [\n   663→      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },\n   664→      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },\n   665→    ],\n   666→  },\n   667→  recessionFromFrankfort: {\n   668→    points: ['porion', 'orbitale', 'pogonion'],\n   669→    lines: [\n   670→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   671→      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },\n   672→    ],\n   673→  },\n   674→  gonionToMouthLine: {\n   675→    points: ['gonionBottom', 'cheilion', 'tragus'],\n   676→    lines: [\n   677→      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },\n   678→    ],\n   679→  },\n   680→  eLineUpperLip: {\n   681→    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n   682→    lines: [\n   683→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n   684→    ],\n   685→  },\n   686→  sLineUpperLip: {\n   687→    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n   688→    lines: [\n   689→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n   690→    ],\n   691→  },\n   692→  burstoneUpperLip: {\n   693→    points: ['subnasale', 'pogonion', 'labraleSuperius'],\n   694→    lines: [\n   695→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n   696→    ],\n   697→  },\n   698→  chinProjection: {\n   699→    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],\n   700→    lines: [\n   701→      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },\n   702→    ],\n   703→  },\n   704→  recessionRelativeToFrankfort: {\n   705→    points: ['porion', 'orbitale', 'pogonion', 'menton'],\n   706→    lines: [\n   707→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   708→      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },\n   709→    ],\n   710→  },\n   711→  browridgeInclinationAngle: {\n   712→    points: ['glabella', 'trichion', 'nasion'],\n   713→    lines: [\n   714→      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },\n   715→      { from: 'glabella', to: 'nasion', color: '#67e8f9' },\n   716→    ],\n   717→  },\n   718→  upperForeheadSlope: {\n   719→    points: ['trichion', 'glabella', 'frankfortHorizontal'],\n   720→    lines: [\n   721→      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },\n   722→    ],\n   723→  },\n   724→  midfaceProjectionAngle: {\n   725→    points: ['orbitale', 'subnasale', 'pronasale'],\n   726→    lines: [\n   727→      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },\n   728→      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },\n   729→    ],\n   730→  },\n   731→};\n   732→\n   733→function generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {\n   734→  const landmarkMap: Record<string, LandmarkPoint> = {};\n   735→  landmarks.forEach(l => { landmarkMap[l.id] = l; });\n   736→\n   737→  const config = ILLUSTRATION_CONFIGS[metricId];\n   738→  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};\n   739→  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};\n   740→\n   741→  if (config) {\n   742→    config.points.forEach((pointId, i) => {\n   743→      if (landmarkMap[pointId]) {\n   744→        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };\n   745→      }\n   746→    });\n   747→    config.lines.forEach((line, i) => {\n   748→      lines[`line_${i}`] = {\n   749→        from: line.from,\n   750→        to: line.to,\n   751→        color: line.color || '#67e8f9',\n   752→        label: line.label,\n   753→        labelPosition: line.labelPosition,\n   754→      };\n   755→    });\n   756→  }\n   757→\n   758→  return { points, lines };\n   759→}\n   760→\n   761→function getUsedLandmarks(metricId: string): string[] {\n   762→  const landmarkMappings: Record<string, string[]> = {\n   763→    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   764→    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],\n   765→    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n   766→    ipd: ['left_pupila', 'right_pupila'],\n   767→    mouthWidth: ['left_cheilion', 'right_cheilion'],\n   768→    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],\n   769→    chinHeight: ['labrale_inferius', 'menton'],\n   770→    gonialAngle: ['tragus', 'gonionBottom', 'menton'],\n   771→  };\n   772→  return landmarkMappings[metricId] || [];\n   773→}\n   774→\n   775→function getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {\n   776→  const flawMappings: Record<string, { low: string[]; high: string[] }> = {\n   777→    faceWidthToHeight: {\n   778→      low: ['Narrow face', 'Vertically elongated face'],\n   779→      high: ['Wide face', 'Horizontally expanded face'],\n   780→    },\n   781→    lowerThirdProportion: {\n   782→      low: ['Short lower third', 'Deficient mandible'],\n   783→      high: ['Long lower third', 'Mandibular excess'],\n   784→    },\n   785→    lateralCanthalTilt: {\n   786→      low: ['Negative canthal tilt', 'Drooping eyes'],\n   787→      high: ['Excessive positive canthal tilt'],\n   788→    },\n   789→    nasalIndex: {\n   790→      low: ['Narrow nose', 'Leptorrhine nose'],\n   791→      high: ['Wide nose', 'Platyrrhine nose'],\n   792→    },\n   793→    gonialAngle: {\n   794→      low: ['Steep mandibular plane'],\n   795→      high: ['Flat mandibular plane', 'Weak jaw definition'],\n   796→    },\n   797→  };\n   798→\n   799→  const strengthMappings: Record<string, { ideal: string[] }> = {\n   800→    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },\n   801→    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },\n   802→    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },\n   803→    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },\n   804→  };\n   805→\n   806→  const mapping = flawMappings[result.metricId];\n   807→  const strengthMapping = strengthMappings[result.metricId];\n   808→\n   809→  let mayIndicateFlaws: string[] = [];\n   810→  let mayIndicateStrengths: string[] = [];\n   811→\n   812→  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {\n   813→    mayIndicateStrengths = strengthMapping?.ideal || [];\n   814→  } else if (mapping) {\n   815→    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;\n   816→  }\n   817→\n   818→  return { mayIndicateFlaws, mayIndicateStrengths };\n   819→}\n   820→\n   821→// Metric groupings for creating multi-ratio strengths\n   822→const STRENGTH_GROUPINGS: Record<string, {\n   823→  name: string;\n   824→  category: string;\n   825→  description: string;\n   826→  metrics: string[];\n   827→}> = {\n   828→  // Lip Proportions\n   829→  lipProportions: {\n   830→    name: 'Well Proportioned Lips',\n   831→    category: 'Lips',\n   832→    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',\n   833→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n   834→  },\n   835→  // Eye Proportions\n   836→  eyeProportions: {\n   837→    name: 'Harmonious Eye Proportions',\n   838→    category: 'Eyes',\n   839→    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',\n   840→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n   841→  },\n   842→  // Nose Proportions\n   843→  noseProportions: {\n   844→    name: 'Balanced Nasal Proportions',\n   845→    category: 'Nose',\n   846→    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',\n   847→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n   848→  },\n   849→  // Jaw Definition\n   850→  jawDefinition: {\n   851→    name: 'Well-Defined Jawline',\n   852→    category: 'Jaw Shape',\n   853→    description: 'The jawline displays strong definition with balanced angles and proportionate width.',\n   854→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n   855→  },\n   856→  // Chin Proportions\n   857→  chinProportions: {\n   858→    name: 'Balanced Chin Projection',\n   859→    category: 'Chin',\n   860→    description: 'The chin demonstrates ideal projection and proportions relative to the face.',\n   861→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n   862→  },\n   863→  // Facial Thirds\n   864→  facialThirds: {\n   865→    name: 'Balanced Facial Thirds',\n   866→    category: 'Face Proportions',\n   867→    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',\n   868→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n   869→  },\n   870→  // Midface\n   871→  midfaceBalance: {\n   872→    name: 'Harmonious Midface',\n   873→    category: 'Midface/Face Shape',\n   874→    description: 'The midface shows balanced proportions with well-positioned cheekbones.',\n   875→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n   876→  },\n   877→  // Forehead\n   878→  foreheadBalance: {\n   879→    name: 'Well-Proportioned Forehead',\n   880→    category: 'Forehead',\n   881→    description: 'The forehead displays ideal proportions in height and shape.',\n   882→    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],\n   883→  },\n   884→};\n   885→\n   886→function generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {\n   887→  const strengths: Strength[] = [];\n   888→  const usedMetricIds = new Set<string>();\n   889→\n   890→  // First pass: Create grouped strengths from related high-scoring metrics\n   891→  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {\n   892→    // Find all high-scoring measurements that belong to this group\n   893→    const groupMeasurements = analysis.measurements.filter(m =>\n   894→      groupConfig.metrics.includes(m.metricId) &&\n   895→      m.score >= 7.5 &&\n   896→      !usedMetricIds.has(m.metricId)\n   897→    );\n   898→\n   899→    // Only create a grouped strength if we have 2+ metrics with good scores\n   900→    if (groupMeasurements.length >= 2) {\n   901→      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n   902→      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n   903→\n   904→      // Mark these metrics as used\n   905→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n   906→\n   907→      // Create grouped strength with multiple contributing ratios\n   908→      strengths.push({\n   909→        id: `strength_group_${groupId}`,\n   910→        strengthName: groupConfig.name,\n   911→        summary: groupConfig.description,\n   912→        avgScore,\n   913→        qualityLevel: bestQuality,\n   914→        categoryName: groupConfig.category,\n   915→        responsibleRatios: groupMeasurements.map(m => ({\n   916→          ratioName: m.name,\n   917→          ratioId: m.metricId,\n   918→          score: m.score,\n   919→          value: m.value,\n   920→          idealMin: m.idealMin,\n   921→          idealMax: m.idealMax,\n   922→          unit: m.unit,\n   923→          category: m.category,\n   924→        })),\n   925→      });\n   926→    }\n   927→  });\n   928→\n   929→  // Second pass: Add remaining individual strengths that weren't grouped\n   930→  analysis.strengths.forEach((s, i) => {\n   931→    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n   932→\n   933→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n   934→\n   935→    strengths.push({\n   936→      id: `strength_${i}`,\n   937→      strengthName: s.metricName,\n   938→      summary: s.reasoning,\n   939→      avgScore: matchingMeasurement?.score || 8,\n   940→      qualityLevel: s.qualityTier,\n   941→      categoryName: s.category,\n   942→      responsibleRatios: [{\n   943→        ratioName: s.metricName,\n   944→        ratioId: s.metricId,\n   945→        score: matchingMeasurement?.score || 8,\n   946→        value: s.value,\n   947→        idealMin: matchingMeasurement?.idealMin || 0,\n   948→        idealMax: matchingMeasurement?.idealMax || 1,\n   949→        unit: matchingMeasurement?.unit || 'ratio',\n   950→        category: s.category,\n   951→      }],\n   952→    });\n   953→  });\n   954→\n   955→  // Sort by average score (highest first) then by number of contributing ratios\n   956→  return strengths.sort((a, b) => {\n   957→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n   958→      return b.responsibleRatios.length - a.responsibleRatios.length;\n   959→    }\n   960→    return b.avgScore - a.avgScore;\n   961→  });\n   962→}\n   963→\n   964→// Flaw groupings - similar to strength groupings but for areas of improvement\n   965→const FLAW_GROUPINGS: Record<string, {\n   966→  name: string;\n   967→  category: string;\n   968→  description: string;\n   969→  metrics: string[];\n   970→}> = {\n   971→  // Lip Issues\n   972→  lipIssues: {\n   973→    name: 'Lip Proportion Concerns',\n   974→    category: 'Lips',\n   975→    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',\n   976→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n   977→  },\n   978→  // Eye Issues\n   979→  eyeIssues: {\n   980→    name: 'Eye Shape Considerations',\n   981→    category: 'Eyes',\n   982→    description: 'The eye proportions or positioning could benefit from enhancement.',\n   983→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n   984→  },\n   985→  // Nose Issues\n   986→  noseIssues: {\n   987→    name: 'Nasal Proportion Concerns',\n   988→    category: 'Nose',\n   989→    description: 'The nasal proportions show deviations that affect facial harmony.',\n   990→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n   991→  },\n   992→  // Jaw Issues\n   993→  jawIssues: {\n   994→    name: 'Jawline Definition Concerns',\n   995→    category: 'Jaw Shape',\n   996→    description: 'The jawline structure shows areas that could be enhanced for better definition.',\n   997→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n   998→  },\n   999→  // Chin Issues\n  1000→  chinIssues: {\n  1001→    name: 'Chin Projection Concerns',\n  1002→    category: 'Chin',\n  1003→    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',\n  1004→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  1005→  },\n  1006→  // Face Proportion Issues\n  1007→  proportionIssues: {\n  1008→    name: 'Facial Proportion Imbalance',\n  1009→    category: 'Face Proportions',\n  1010→    description: 'The vertical face proportions show imbalance between facial thirds.',\n  1011→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  1012→  },\n  1013→  // Midface Issues\n  1014→  midfaceIssues: {\n  1015→    name: 'Midface Development Concerns',\n  1016→    category: 'Midface/Face Shape',\n  1017→    description: 'The midface shows areas that could benefit from enhanced projection or balance.',\n  1018→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  1019→  },\n  1020→};\n  1021→\n  1022→function generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  1023→  const flaws: Flaw[] = [];\n  1024→  const usedMetricIds = new Set<string>();\n  1025→  let rollingLost = 0;\n  1026→\n  1027→  // First pass: Create grouped flaws from related low-scoring metrics\n  1028→  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n  1029→    // Find all low-scoring measurements that belong to this group\n  1030→    const groupMeasurements = analysis.measurements.filter(m =>\n  1031→      groupConfig.metrics.includes(m.metricId) &&\n  1032→      m.score < 6 &&\n  1033→      !usedMetricIds.has(m.metricId)\n  1034→    );\n  1035→\n  1036→    // Only create a grouped flaw if we have 2+ metrics with low scores\n  1037→    if (groupMeasurements.length >= 2) {\n  1038→      // Mark these metrics as used\n  1039→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n  1040→\n  1041→      // Calculate total impact from all metrics in this group\n  1042→      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n  1043→      rollingLost += totalImpact;\n  1044→\n  1045→      // Create grouped flaw with multiple contributing ratios\n  1046→      flaws.push({\n  1047→        id: `flaw_group_${groupId}`,\n  1048→        flawName: groupConfig.name,\n  1049→        summary: groupConfig.description,\n  1050→        harmonyPercentageLost: totalImpact,\n  1051→        standardizedImpact: totalImpact / 10,\n  1052→        categoryName: groupConfig.category,\n  1053→        responsibleRatios: groupMeasurements.map(m => ({\n  1054→          ratioName: m.name,\n  1055→          ratioId: m.metricId,\n  1056→          score: m.score,\n  1057→          value: m.value,\n  1058→          idealMin: m.idealMin,\n  1059→          idealMax: m.idealMax,\n  1060→          unit: m.unit,\n  1061→          category: m.category,\n  1062→        })),\n  1063→        rollingPointsDeducted: rollingLost,\n  1064→        rollingHarmonyPercentageLost: rollingLost,\n  1065→        rollingStandardizedImpact: rollingLost / 10,\n  1066→      });\n  1067→    }\n  1068→  });\n  1069→\n  1070→  // Second pass: Add remaining individual flaws that weren't grouped\n  1071→  analysis.flaws.forEach((f, i) => {\n  1072→    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n  1073→\n  1074→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n  1075→    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n  1076→    rollingLost += impact;\n  1077→\n  1078→    flaws.push({\n  1079→      id: `flaw_${i}`,\n  1080→      flawName: f.metricName,\n  1081→      summary: f.reasoning,\n  1082→      harmonyPercentageLost: impact,\n  1083→      standardizedImpact: impact / 10,\n  1084→      categoryName: f.category,\n  1085→      responsibleRatios: [{\n  1086→        ratioName: f.metricName,\n  1087→        ratioId: f.metricId,\n  1088→        score: matchingMeasurement?.score || 3,\n  1089→        value: matchingMeasurement?.value || 0,\n  1090→        idealMin: matchingMeasurement?.idealMin || 0,\n  1091→        idealMax: matchingMeasurement?.idealMax || 1,\n  1092→        unit: matchingMeasurement?.unit || 'ratio',\n  1093→        category: f.category,\n  1094→      }],\n  1095→      rollingPointsDeducted: rollingLost,\n  1096→      rollingHarmonyPercentageLost: rollingLost,\n  1097→      rollingStandardizedImpact: rollingLost / 10,\n  1098→    });\n  1099→  });\n  1100→\n  1101→  // Sort by impact (highest first) then by number of contributing ratios\n  1102→  return flaws.sort((a, b) => {\n  1103→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n  1104→      return b.responsibleRatios.length - a.responsibleRatios.length;\n  1105→    }\n  1106→    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  1107→  });\n  1108→}\n  1109→\n  1110→// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions\n  1111→// have been moved to @/lib/results/analysis.ts to reduce bundle size\n  1112→// Import generateRecommendations from there instead\n  1113→// ============================================\n  1114→// CONTEXT CREATION\n  1115→// ============================================\n  1116→\n  1117→const ResultsContext = createContext<ResultsContextType | null>(null);\n  1118→\n  1119→export function useResults(): ResultsContextType {\n  1120→  const context = useContext(ResultsContext);\n  1121→  if (!context) {\n  1122→    throw new Error('useResults must be used within a ResultsProvider');\n  1123→  }\n  1124→  return context;\n  1125→}\n  1126→\n  1127→interface ResultsProviderProps {\n  1128→  children: ReactNode;\n  1129→  initialData?: ResultsInputData;\n  1130→}\n  1131→\n  1132→export function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  1133→  // Raw data state\n  1134→  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  1135→  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  1136→  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  1137→  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  1138→  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  1139→  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n  1140→\n  1141→  // UI state\n  1142→  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  1143→  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  1144→  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  1145→  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  1146→  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n  1147→\n  1148→  // Compute analysis results (now with demographic-specific scoring)\n  1149→  const analysisResults = useMemo(() => {\n  1150→    if (frontLandmarks.length === 0) {\n  1151→      return null;\n  1152→    }\n  1153→\n  1154→    try {\n  1155→      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n  1156→      const sideAnalysis = sideLandmarks.length > 0\n  1157→        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n  1158→        : null;\n  1159→      // analyzeHarmony expects landmarks directly, not analysis results\n  1160→      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n  1161→\n  1162→      return { frontAnalysis, sideAnalysis, harmony };\n  1163→    } catch (error) {\n  1164→      console.error('Analysis error:', error);\n  1165→      return null;\n  1166→    }\n  1167→  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n  1168→\n  1169→  // Transform to Ratio format\n  1170→  const frontRatios = useMemo(() => {\n  1171→    if (!analysisResults?.frontAnalysis) return [];\n  1172→    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  1173→  }, [analysisResults, frontLandmarks]);\n  1174→\n  1175→  const sideRatios = useMemo(() => {\n  1176→    if (!analysisResults?.sideAnalysis) return [];\n  1177→    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  1178→  }, [analysisResults, sideLandmarks]);\n  1179→\n  1180→  // Generate strengths and flaws using INSIGHTS-BASED classification\n  1181→  // This processes insights.json definitions: calculates avg score of affected metrics,\n  1182→  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  1183→  const { insightStrengths, insightFlaws } = useMemo(() => {\n  1184→    if (!analysisResults?.harmony) {\n  1185→      return { insightStrengths: [], insightFlaws: [] };\n  1186→    }\n  1187→\n  1188→    try {\n  1189→      // Classify using insights engine\n  1190→      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n  1191→        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n  1192→\n  1193→      // Convert to UI-compatible types\n  1194→      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n  1195→\n  1196→      let rollingLost = 0;\n  1197→      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n  1198→        const flaw = convertToFlaw(w, i, rollingLost);\n  1199→        rollingLost = flaw.rollingPointsDeducted || 0;\n  1200→        return flaw;\n  1201→      });\n  1202→\n  1203→      return { insightStrengths, insightFlaws };\n  1204→    } catch (error) {\n  1205→      console.error('[ResultsContext] Error in insights classification:', error);\n  1206→      return { insightStrengths: [], insightFlaws: [] };\n  1207→    }\n  1208→  }, [analysisResults]);\n  1209→\n  1210→  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  1211→  const groupingStrengths = useMemo(() => {\n  1212→    if (!analysisResults?.harmony) return [];\n  1213→    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  1214→  }, [analysisResults]);\n  1215→\n  1216→  const groupingFlaws = useMemo(() => {\n  1217→    if (!analysisResults?.harmony) return [];\n  1218→    return generateFlawsFromAnalysis(analysisResults.harmony);\n  1219→  }, [analysisResults]);\n  1220→\n  1221→  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)\n  1222→  const strengths = useMemo(() => {\n  1223→    // Use insights as primary source\n  1224→    const usedMetricIds = new Set<string>();\n  1225→    insightStrengths.forEach(s => {\n  1226→      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n  1227→    });\n  1228→\n  1229→    // Add grouping-based strengths that don't overlap\n  1230→    const nonOverlappingGrouping = groupingStrengths.filter(gs => {\n  1231→      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n  1232→      return !overlap;\n  1233→    });\n  1234→\n  1235→    return [...insightStrengths, ...nonOverlappingGrouping];\n  1236→  }, [insightStrengths, groupingStrengths]);\n  1237→\n  1238→  const flaws = useMemo(() => {\n  1239→    // Use insights as primary source\n  1240→    const usedMetricIds = new Set<string>();\n  1241→    insightFlaws.forEach(f => {\n  1242→      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n  1243→    });\n  1244→\n  1245→    // Add grouping-based flaws that don't overlap\n  1246→    const nonOverlappingGrouping = groupingFlaws.filter(gf => {\n  1247→      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n  1248→      return !overlap;\n  1249→    });\n  1250→\n  1251→    // Recalculate rolling totals for merged list\n  1252→    let rollingLost = 0;\n  1253→    const merged = [...insightFlaws, ...nonOverlappingGrouping];\n  1254→    return merged.map(f => {\n  1255→      rollingLost += f.harmonyPercentageLost;\n  1256→      return {\n  1257→        ...f,\n  1258→        rollingPointsDeducted: rollingLost,\n  1259→        rollingHarmonyPercentageLost: rollingLost,\n  1260→        rollingStandardizedImpact: rollingLost / 10,\n  1261→      };\n  1262→    });\n  1263→  }, [insightFlaws, groupingFlaws]);\n  1264→\n  1265→  // Generate recommendations with metric-aware matching and Bezier recalculation\n  1266→  const recommendations = useMemo(() => {\n  1267→    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);\n  1268→  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);\n  1269→\n  1270→  // Build full harmony analysis\n  1271→  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {\n  1272→    if (!analysisResults?.harmony) return null;\n  1273→\n  1274→    return {\n  1275→      standardizedScore: analysisResults.harmony.overallScore,\n  1276→      front: {\n  1277→        standardizedScore: analysisResults.harmony.frontScore,\n  1278→        ratios: frontRatios,\n  1279→      },\n  1280→      side: {\n  1281→        standardizedScore: analysisResults.harmony.sideScore,\n  1282→        ratios: sideRatios,\n  1283→      },\n  1284→      strengths,\n  1285→      flaws,\n  1286→    };\n  1287→  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);\n  1288→\n  1289→  // Calculate weighted harmony score using looksmax_engine.py algorithm\n  1290→  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {\n  1291→    if (!analysisResults?.harmony) return null;\n  1292→\n  1293→    const allMeasurements = analysisResults.harmony.measurements.map(m => ({\n  1294→      metricId: m.metricId,\n  1295→      standardizedScore: m.standardizedScore,\n  1296→    }));\n  1297→\n  1298→    return calculateHarmonyScore(allMeasurements);\n  1299→  }, [analysisResults]);\n  1300→\n  1301→  // Get top 3 and bottom 3 metrics with advice\n  1302→  const topMetrics = useMemo((): RankedMetric[] => {\n  1303→    if (!analysisResults?.harmony) return [];\n  1304→    return getTopMetrics(analysisResults.harmony.measurements, 3);\n  1305→  }, [analysisResults]);\n  1306→\n  1307→  const bottomMetrics = useMemo((): RankedMetric[] => {\n  1308→    if (!analysisResults?.harmony) return [];\n  1309→    return getBottomMetrics(analysisResults.harmony.measurements, 3);\n  1310→  }, [analysisResults]);\n  1311→\n  1312→  // Scores - now using weighted harmony with explicit clamping to 0-10\n  1313→  const rawHarmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;\n  1314→  const harmonyPercentage = Math.max(0, Math.min(100, rawHarmonyPercentage));\n  1315→\n  1316→  const rawOverallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;\n  1317→  const overallScore = Math.max(0, Math.min(10, rawOverallScore));\n  1318→\n  1319→  const rawFrontScore = analysisResults?.harmony?.frontScore || 0;\n  1320→  const frontScore = Math.max(0, Math.min(10, rawFrontScore));\n  1321→\n  1322→  const rawSideScore = analysisResults?.harmony?.sideScore || 0;\n  1323→  const sideScore = Math.max(0, Math.min(10, rawSideScore));\n  1324→\n  1325→  // PSL Rating (1-10 scale with tier/percentile)\n  1326→  const pslRating = useMemo(() => {\n  1327→    return harmonyToPSL(harmonyPercentage);\n  1328→  }, [harmonyPercentage]);\n  1329→\n  1330→  // Action to set all results data\n  1331→  const setResultsData = useCallback((data: ResultsInputData) => {\n  1332→    setFrontLandmarks(data.frontLandmarks);\n  1333→    setSideLandmarks(data.sideLandmarks);\n  1334→    setFrontPhoto(data.frontPhoto);\n  1335→    setSidePhoto(data.sidePhoto || null);\n  1336→    setGender(data.gender);\n  1337→    setEthnicity(data.ethnicity || 'other');\n  1338→  }, []);\n  1339→\n  1340→  // Memoize context value to prevent unnecessary re-renders\n  1341→  const value = useMemo<ResultsContextType>(() => ({\n  1342→    frontLandmarks,\n  1343→    sideLandmarks,\n  1344→    gender,\n  1345→    ethnicity,\n  1346→    frontPhoto,\n  1347→    sidePhoto,\n  1348→    harmonyAnalysis,\n  1349→    frontRatios,\n  1350→    sideRatios,\n  1351→    strengths,\n  1352→    flaws,\n  1353→    recommendations,\n  1354→    overallScore,\n  1355→    frontScore,\n  1356→    sideScore,\n  1357→    // Weighted harmony from looksmax_engine.py\n  1358→    harmonyScoreResult,\n  1359→    harmonyPercentage,\n  1360→    topMetrics,\n  1361→    bottomMetrics,\n  1362→    // PSL Rating\n  1363→    pslRating,\n  1364→    // UI state\n  1365→    activeTab,\n  1366→    setActiveTab,\n  1367→    expandedMeasurementId,\n  1368→    setExpandedMeasurementId,\n  1369→    selectedVisualizationMetric,\n  1370→    setSelectedVisualizationMetric,\n  1371→    categoryFilter,\n  1372→    setCategoryFilter,\n  1373→    showLandmarkOverlay,\n  1374→    setShowLandmarkOverlay,\n  1375→    setResultsData,\n  1376→  }), [\n  1377→    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,\n  1378→    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,\n  1379→    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,\n  1380→    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,\n  1381→    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,\n  1382→    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,\n  1383→    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,\n  1384→  ]);\n  1385→\n  1386→  return (\n  1387→    <ResultsContext.Provider value={value}>\n  1388→      {children}\n  1389→    </ResultsContext.Provider>\n  1390→  );\n  1391→}\n  1392→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"c208b7d2-027d-40cd-9a9c-e0d6cf387818","timestamp":"2025-12-26T06:49:39.293Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","content":"'use client';\n\nimport React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\nimport { LandmarkPoint } from '@/lib/landmarks';\nimport {\n  analyzeFrontProfile,\n  analyzeSideProfile,\n  analyzeHarmony,\n  HarmonyAnalysis,\n  MetricScoreResult,\n  METRIC_CONFIGS,\n  Ethnicity,\n  Gender,\n} from '@/lib/harmony-scoring';\nimport {\n  calculateHarmonyScore,\n  getTopMetrics,\n  getBottomMetrics,\n  HarmonyScoreResult,\n  RankedMetric,\n} from '@/lib/looksmax-scoring';\nimport { harmonyToPSL } from '@/lib/recommendations/severity';\nimport {\n  classifyInsights,\n  convertToStrength,\n  convertToFlaw,\n  INSIGHTS_DEFINITIONS,\n} from '@/lib/insights-engine';\nimport { classifyMetric } from '@/lib/taxonomy';\nimport {\n  Ratio,\n  Strength,\n  Flaw,\n  Recommendation,\n  ResultsTab,\n  FullHarmonyAnalysis,\n} from '@/types/results';\nimport { generateRecommendations } from '@/lib/results/analysis';\n\n// ============================================\n// CONTEXT TYPES\n// ============================================\n\ninterface ResultsContextType {\n  // Raw data\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  gender: Gender;\n  ethnicity: Ethnicity;\n  frontPhoto: string;\n  sidePhoto: string | null;\n\n  // Computed results\n  harmonyAnalysis: FullHarmonyAnalysis | null;\n  frontRatios: Ratio[];\n  sideRatios: Ratio[];\n  strengths: Strength[];\n  flaws: Flaw[];\n  recommendations: Recommendation[];\n\n  // Scores (now using weighted harmony from looksmax_engine.py)\n  overallScore: number;\n  frontScore: number;\n  sideScore: number;\n\n  // Weighted Harmony Score (from looksmax_engine.py)\n  harmonyScoreResult: HarmonyScoreResult | null;\n  harmonyPercentage: number;  // 0-100% weighted harmony\n\n  // Top 3 strengths and bottom 3 areas to improve with advice\n  topMetrics: RankedMetric[];\n  bottomMetrics: RankedMetric[];\n\n  // PSL Rating (1-10 scale)\n  pslRating: {\n    psl: number;\n    tier: string;\n    percentile: number;\n    description: string;\n  };\n\n  // UI state\n  activeTab: ResultsTab;\n  setActiveTab: (tab: ResultsTab) => void;\n  expandedMeasurementId: string | null;\n  setExpandedMeasurementId: (id: string | null) => void;\n  selectedVisualizationMetric: string | null;\n  setSelectedVisualizationMetric: (id: string | null) => void;\n  categoryFilter: string | null;\n  setCategoryFilter: (category: string | null) => void;\n  showLandmarkOverlay: boolean;\n  setShowLandmarkOverlay: (show: boolean) => void;\n\n  // Actions\n  setResultsData: (data: ResultsInputData) => void;\n}\n\ninterface ResultsInputData {\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  frontPhoto: string;\n  sidePhoto?: string;\n  gender: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// HELPER FUNCTIONS\n// ============================================\n\nfunction convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n  switch (unit) {\n    case 'ratio': return 'x';\n    case 'percent': return '%';\n    case 'degrees': return '°';\n    case 'mm': return 'mm';\n    default: return 'x';\n  }\n}\n\nfunction transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {\n  const metricConfig = METRIC_CONFIGS[result.metricId];\n\n  // Generate illustration based on metric\n  const illustration = generateIllustration(result.metricId, landmarks);\n\n  // Get flaw/strength mappings\n  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n\n  // Classify metric using Harmony taxonomy\n  const taxonomyClassification = classifyMetric(result.name, result.category);\n\n  // Clamp scores to valid 0-10 range for display (defense-in-depth)\n  const clampedScore = Math.max(0, Math.min(10, result.standardizedScore));\n\n  return {\n    id: result.metricId,\n    name: result.name,\n    value: result.value,\n    score: clampedScore,  // Use standardized 0-10 score for UI display\n    standardizedScore: clampedScore,\n    unit: convertUnitToRatioUnit(result.unit),\n    idealMin: result.idealMin,\n    idealMax: result.idealMax,\n    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n    description: metricConfig?.description || '',\n    category: result.category,\n    qualityLevel: result.qualityTier,\n    severity: result.severity,\n    illustration,\n    mayIndicateFlaws,\n    mayIndicateStrengths,\n    usedLandmarks: getUsedLandmarks(result.metricId),\n    scoringCurveConfig: metricConfig ? {\n      decayRate: metricConfig.decayRate,\n      maxScore: metricConfig.maxScore,\n    } : undefined,\n    taxonomyPrimary: taxonomyClassification?.primary,\n    taxonomySecondary: taxonomyClassification?.secondary,\n  };\n}\n\n// Enhanced illustration configuration type\ninterface IllustrationConfig {\n  points: string[];\n  lines: Array<{\n    from: string;\n    to: string;\n    label?: string;\n    color?: string;\n    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n  }>;\n}\n\n// Comprehensive illustration configurations for all metrics\nconst ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n  // ==========================================\n  // FACE SHAPE / PROPORTIONS\n  // ==========================================\n  faceWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n    ],\n  },\n  totalFacialWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n    ],\n  },\n  lowerThirdProportion: {\n    points: ['subnasale', 'menton', 'trichion'],\n    lines: [\n      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  middleThirdProportion: {\n    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n    lines: [\n      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  upperThirdProportion: {\n    points: ['trichion', 'nasal_base', 'menton'],\n    lines: [\n      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  bitemporalWidth: {\n    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n    ],\n  },\n  cheekboneHeight: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n    ],\n  },\n  midfaceRatio: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // JAW MEASUREMENTS\n  // ==========================================\n  jawSlope: {\n    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n    ],\n  },\n  jawFrontalAngle: {\n    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  bigonialWidth: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n    ],\n  },\n  jawWidthRatio: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n    ],\n  },\n\n  // ==========================================\n  // EYE MEASUREMENTS\n  // ==========================================\n  lateralCanthalTilt: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n    ],\n  },\n  eyeAspectRatio: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  eyeSeparationRatio: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryMouthWidthRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n    ],\n  },\n  oneEyeApartTest: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // EYEBROW MEASUREMENTS\n  // ==========================================\n  browLengthRatio: {\n    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  eyebrowTilt: {\n    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n    ],\n  },\n  eyebrowLowSetedness: {\n    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n    ],\n  },\n\n  // ==========================================\n  // NOSE MEASUREMENTS (FRONT)\n  // ==========================================\n  nasalIndex: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  intercanthalNasalRatio: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n    ],\n  },\n  noseBridgeWidth: {\n    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n    ],\n  },\n  noseTipPosition: {\n    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // MOUTH/LIP MEASUREMENTS\n  // ==========================================\n  mouthNoseWidthRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  mouthWidth: {\n    points: ['left_cheilion', 'right_cheilion'],\n    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n  },\n\n  // ==========================================\n  // CHIN MEASUREMENTS\n  // ==========================================\n  chinHeight: {\n    points: ['labrale_inferius', 'menton'],\n    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n  },\n\n  // ==========================================\n  // NECK MEASUREMENTS\n  // ==========================================\n  neckWidthRatio: {\n    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n    ],\n  },\n\n  // ==========================================\n  // SIDE PROFILE MEASUREMENTS\n  // ==========================================\n  gonialAngle: {\n    points: ['tragus', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  nasofrontalAngle: {\n    points: ['glabella', 'nasion', 'pronasale'],\n    lines: [\n      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  nasofacialAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n    ],\n  },\n  nasomentaAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n    ],\n  },\n  submentalCervicalAngle: {\n    points: ['menton', 'cervicalPoint', 'neckPoint'],\n    lines: [\n      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n    ],\n  },\n  facialDepthToHeight: {\n    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n    lines: [\n      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  anteriorFacialDepth: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n    ],\n  },\n  mandibularPlaneAngle: {\n    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n    lines: [\n      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n    ],\n  },\n  ramusToMandibleRatio: {\n    points: ['gonionTop', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  orbitalVector: {\n    points: ['cornealApex', 'orbitale', 'cheekbone'],\n    lines: [\n      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n    ],\n  },\n  eLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  holdawayHLine: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n    ],\n  },\n  burstoneLowerLip: {\n    points: ['subnasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL FRONT PROFILE METRICS\n  // ==========================================\n  cupidsBowDepth: {\n    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],\n    lines: [\n      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },\n      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },\n    ],\n  },\n  mouthCornerPosition: {\n    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },\n    ],\n  },\n  iaaJfaDeviation: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },\n      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  ipsilateralAlarAngle: {\n    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },\n      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },\n    ],\n  },\n  earProtrusionAngle: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },\n    ],\n  },\n  earProtrusionRatio: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },\n      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },\n    ],\n  },\n  mouthWidthToNoseRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerToUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinToPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL SIDE PROFILE METRICS\n  // ==========================================\n  nasolabialAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },\n      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },\n    ],\n  },\n  nasalTipAngle: {\n    points: ['nasion', 'pronasale', 'columella'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },\n      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },\n    ],\n  },\n  nasalProjection: {\n    points: ['alar_crease', 'pronasale', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },\n    ],\n  },\n  nasalWToHRatio: {\n    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },\n      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  noseTipRotationAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },\n    ],\n  },\n  frankfortTipAngle: {\n    points: ['porion', 'orbitale', 'pronasale'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },\n    ],\n  },\n  mentolabialAngle: {\n    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],\n    lines: [\n      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },\n      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  zAngle: {\n    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],\n    lines: [\n      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },\n    ],\n  },\n  facialConvexityGlabella: {\n    points: ['glabella', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  facialConvexityNasion: {\n    points: ['nasion', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  totalFacialConvexity: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },\n      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  interiorMidfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },\n      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },\n    ],\n  },\n  recessionFromFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  gonionToMouthLine: {\n    points: ['gonionBottom', 'cheilion', 'tragus'],\n    lines: [\n      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },\n    ],\n  },\n  eLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  burstoneUpperLip: {\n    points: ['subnasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n  chinProjection: {\n    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },\n    ],\n  },\n  recessionRelativeToFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion', 'menton'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  browridgeInclinationAngle: {\n    points: ['glabella', 'trichion', 'nasion'],\n    lines: [\n      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },\n      { from: 'glabella', to: 'nasion', color: '#67e8f9' },\n    ],\n  },\n  upperForeheadSlope: {\n    points: ['trichion', 'glabella', 'frankfortHorizontal'],\n    lines: [\n      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },\n    ],\n  },\n  midfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },\n      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },\n    ],\n  },\n};\n\nfunction generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {\n  const landmarkMap: Record<string, LandmarkPoint> = {};\n  landmarks.forEach(l => { landmarkMap[l.id] = l; });\n\n  const config = ILLUSTRATION_CONFIGS[metricId];\n  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};\n  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};\n\n  if (config) {\n    config.points.forEach((pointId, i) => {\n      if (landmarkMap[pointId]) {\n        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };\n      }\n    });\n    config.lines.forEach((line, i) => {\n      lines[`line_${i}`] = {\n        from: line.from,\n        to: line.to,\n        color: line.color || '#67e8f9',\n        label: line.label,\n        labelPosition: line.labelPosition,\n      };\n    });\n  }\n\n  return { points, lines };\n}\n\nfunction getUsedLandmarks(metricId: string): string[] {\n  const landmarkMappings: Record<string, string[]> = {\n    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],\n    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    ipd: ['left_pupila', 'right_pupila'],\n    mouthWidth: ['left_cheilion', 'right_cheilion'],\n    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],\n    chinHeight: ['labrale_inferius', 'menton'],\n    gonialAngle: ['tragus', 'gonionBottom', 'menton'],\n  };\n  return landmarkMappings[metricId] || [];\n}\n\nfunction getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {\n  const flawMappings: Record<string, { low: string[]; high: string[] }> = {\n    faceWidthToHeight: {\n      low: ['Narrow face', 'Vertically elongated face'],\n      high: ['Wide face', 'Horizontally expanded face'],\n    },\n    lowerThirdProportion: {\n      low: ['Short lower third', 'Deficient mandible'],\n      high: ['Long lower third', 'Mandibular excess'],\n    },\n    lateralCanthalTilt: {\n      low: ['Negative canthal tilt', 'Drooping eyes'],\n      high: ['Excessive positive canthal tilt'],\n    },\n    nasalIndex: {\n      low: ['Narrow nose', 'Leptorrhine nose'],\n      high: ['Wide nose', 'Platyrrhine nose'],\n    },\n    gonialAngle: {\n      low: ['Steep mandibular plane'],\n      high: ['Flat mandibular plane', 'Weak jaw definition'],\n    },\n  };\n\n  const strengthMappings: Record<string, { ideal: string[] }> = {\n    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },\n    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },\n    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },\n    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },\n  };\n\n  const mapping = flawMappings[result.metricId];\n  const strengthMapping = strengthMappings[result.metricId];\n\n  let mayIndicateFlaws: string[] = [];\n  let mayIndicateStrengths: string[] = [];\n\n  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {\n    mayIndicateStrengths = strengthMapping?.ideal || [];\n  } else if (mapping) {\n    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;\n  }\n\n  return { mayIndicateFlaws, mayIndicateStrengths };\n}\n\n// Metric groupings for creating multi-ratio strengths\nconst STRENGTH_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Proportions\n  lipProportions: {\n    name: 'Well Proportioned Lips',\n    category: 'Lips',\n    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Proportions\n  eyeProportions: {\n    name: 'Harmonious Eye Proportions',\n    category: 'Eyes',\n    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Proportions\n  noseProportions: {\n    name: 'Balanced Nasal Proportions',\n    category: 'Nose',\n    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Definition\n  jawDefinition: {\n    name: 'Well-Defined Jawline',\n    category: 'Jaw Shape',\n    description: 'The jawline displays strong definition with balanced angles and proportionate width.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Proportions\n  chinProportions: {\n    name: 'Balanced Chin Projection',\n    category: 'Chin',\n    description: 'The chin demonstrates ideal projection and proportions relative to the face.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Facial Thirds\n  facialThirds: {\n    name: 'Balanced Facial Thirds',\n    category: 'Face Proportions',\n    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface\n  midfaceBalance: {\n    name: 'Harmonious Midface',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows balanced proportions with well-positioned cheekbones.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n  // Forehead\n  foreheadBalance: {\n    name: 'Well-Proportioned Forehead',\n    category: 'Forehead',\n    description: 'The forehead displays ideal proportions in height and shape.',\n    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],\n  },\n};\n\nfunction generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {\n  const strengths: Strength[] = [];\n  const usedMetricIds = new Set<string>();\n\n  // First pass: Create grouped strengths from related high-scoring metrics\n  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all high-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score >= 7.5 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: matchingMeasurement?.score || 8,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: matchingMeasurement?.score || 8,\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });\n\n  // Sort by average score (highest first) then by number of contributing ratios\n  return strengths.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.avgScore - a.avgScore;\n  });\n}\n\n// Flaw groupings - similar to strength groupings but for areas of improvement\nconst FLAW_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Issues\n  lipIssues: {\n    name: 'Lip Proportion Concerns',\n    category: 'Lips',\n    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Issues\n  eyeIssues: {\n    name: 'Eye Shape Considerations',\n    category: 'Eyes',\n    description: 'The eye proportions or positioning could benefit from enhancement.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Issues\n  noseIssues: {\n    name: 'Nasal Proportion Concerns',\n    category: 'Nose',\n    description: 'The nasal proportions show deviations that affect facial harmony.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Issues\n  jawIssues: {\n    name: 'Jawline Definition Concerns',\n    category: 'Jaw Shape',\n    description: 'The jawline structure shows areas that could be enhanced for better definition.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Issues\n  chinIssues: {\n    name: 'Chin Projection Concerns',\n    category: 'Chin',\n    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Face Proportion Issues\n  proportionIssues: {\n    name: 'Facial Proportion Imbalance',\n    category: 'Face Proportions',\n    description: 'The vertical face proportions show imbalance between facial thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface Issues\n  midfaceIssues: {\n    name: 'Midface Development Concerns',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows areas that could benefit from enhanced projection or balance.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n};\n\nfunction generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  const flaws: Flaw[] = [];\n  const usedMetricIds = new Set<string>();\n  let rollingLost = 0;\n\n  // First pass: Create grouped flaws from related low-scoring metrics\n  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all low-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score < 6 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped flaw if we have 2+ metrics with low scores\n    if (groupMeasurements.length >= 2) {\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Calculate total impact from all metrics in this group\n      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n      rollingLost += totalImpact;\n\n      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: matchingMeasurement?.score || 3,\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });\n\n  // Sort by impact (highest first) then by number of contributing ratios\n  return flaws.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  });\n}\n\n// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions\n// have been moved to @/lib/results/analysis.ts to reduce bundle size\n// Import generateRecommendations from there instead\n// ============================================\n// CONTEXT CREATION\n// ============================================\n\nconst ResultsContext = createContext<ResultsContextType | null>(null);\n\nexport function useResults(): ResultsContextType {\n  const context = useContext(ResultsContext);\n  if (!context) {\n    throw new Error('useResults must be used within a ResultsProvider');\n  }\n  return context;\n}\n\ninterface ResultsProviderProps {\n  children: ReactNode;\n  initialData?: ResultsInputData;\n}\n\nexport function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  // Raw data state\n  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n\n  // UI state\n  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n\n  // Compute analysis results (now with demographic-specific scoring)\n  const analysisResults = useMemo(() => {\n    if (frontLandmarks.length === 0) {\n      return null;\n    }\n\n    try {\n      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n      const sideAnalysis = sideLandmarks.length > 0\n        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n        : null;\n      // analyzeHarmony expects landmarks directly, not analysis results\n      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n\n      return { frontAnalysis, sideAnalysis, harmony };\n    } catch (error) {\n      console.error('Analysis error:', error);\n      return null;\n    }\n  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n\n  // Transform to Ratio format\n  const frontRatios = useMemo(() => {\n    if (!analysisResults?.frontAnalysis) return [];\n    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  }, [analysisResults, frontLandmarks]);\n\n  const sideRatios = useMemo(() => {\n    if (!analysisResults?.sideAnalysis) return [];\n    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  }, [analysisResults, sideLandmarks]);\n\n  // Generate strengths and flaws using INSIGHTS-BASED classification\n  // This processes insights.json definitions: calculates avg score of affected metrics,\n  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  const { insightStrengths, insightFlaws } = useMemo(() => {\n    if (!analysisResults?.harmony) {\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n\n    try {\n      // Classify using insights engine\n      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n\n      // Convert to UI-compatible types\n      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n      let rollingLost = 0;\n      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n        const flaw = convertToFlaw(w, i, rollingLost);\n        rollingLost = flaw.rollingPointsDeducted || 0;\n        return flaw;\n      });\n\n      return { insightStrengths, insightFlaws };\n    } catch (error) {\n      console.error('[ResultsContext] Error in insights classification:', error);\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n  }, [analysisResults]);\n\n  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  const groupingStrengths = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  const groupingFlaws = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateFlawsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)\n  const strengths = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightStrengths.forEach(s => {\n      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based strengths that don't overlap\n    const nonOverlappingGrouping = groupingStrengths.filter(gs => {\n      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    return [...insightStrengths, ...nonOverlappingGrouping];\n  }, [insightStrengths, groupingStrengths]);\n\n  const flaws = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightFlaws.forEach(f => {\n      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based flaws that don't overlap\n    const nonOverlappingGrouping = groupingFlaws.filter(gf => {\n      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    // Recalculate rolling totals for merged list\n    let rollingLost = 0;\n    const merged = [...insightFlaws, ...nonOverlappingGrouping];\n    return merged.map(f => {\n      rollingLost += f.harmonyPercentageLost;\n      return {\n        ...f,\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      };\n    });\n  }, [insightFlaws, groupingFlaws]);\n\n  // Generate recommendations with metric-aware matching and Bezier recalculation\n  const recommendations = useMemo(() => {\n    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);\n  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);\n\n  // Build full harmony analysis\n  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {\n    if (!analysisResults?.harmony) return null;\n\n    return {\n      standardizedScore: analysisResults.harmony.overallScore,\n      front: {\n        standardizedScore: analysisResults.harmony.frontScore,\n        ratios: frontRatios,\n      },\n      side: {\n        standardizedScore: analysisResults.harmony.sideScore,\n        ratios: sideRatios,\n      },\n      strengths,\n      flaws,\n    };\n  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);\n\n  // Calculate weighted harmony score using looksmax_engine.py algorithm\n  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {\n    if (!analysisResults?.harmony) return null;\n\n    const allMeasurements = analysisResults.harmony.measurements.map(m => ({\n      metricId: m.metricId,\n      standardizedScore: m.standardizedScore,\n    }));\n\n    return calculateHarmonyScore(allMeasurements);\n  }, [analysisResults]);\n\n  // Get top 3 and bottom 3 metrics with advice\n  const topMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getTopMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  const bottomMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getBottomMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  // Scores - now using weighted harmony with explicit clamping to 0-10\n  const rawHarmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;\n  const harmonyPercentage = Math.max(0, Math.min(100, rawHarmonyPercentage));\n\n  const rawOverallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;\n  const overallScore = Math.max(0, Math.min(10, rawOverallScore));\n\n  const rawFrontScore = analysisResults?.harmony?.frontScore || 0;\n  const frontScore = Math.max(0, Math.min(10, rawFrontScore));\n\n  const rawSideScore = analysisResults?.harmony?.sideScore || 0;\n  const sideScore = Math.max(0, Math.min(10, rawSideScore));\n\n  // PSL Rating (1-10 scale with tier/percentile)\n  const pslRating = useMemo(() => {\n    return harmonyToPSL(harmonyPercentage);\n  }, [harmonyPercentage]);\n\n  // Action to set all results data\n  const setResultsData = useCallback((data: ResultsInputData) => {\n    setFrontLandmarks(data.frontLandmarks);\n    setSideLandmarks(data.sideLandmarks);\n    setFrontPhoto(data.frontPhoto);\n    setSidePhoto(data.sidePhoto || null);\n    setGender(data.gender);\n    setEthnicity(data.ethnicity || 'other');\n  }, []);\n\n  // Memoize context value to prevent unnecessary re-renders\n  const value = useMemo<ResultsContextType>(() => ({\n    frontLandmarks,\n    sideLandmarks,\n    gender,\n    ethnicity,\n    frontPhoto,\n    sidePhoto,\n    harmonyAnalysis,\n    frontRatios,\n    sideRatios,\n    strengths,\n    flaws,\n    recommendations,\n    overallScore,\n    frontScore,\n    sideScore,\n    // Weighted harmony from looksmax_engine.py\n    harmonyScoreResult,\n    harmonyPercentage,\n    topMetrics,\n    bottomMetrics,\n    // PSL Rating\n    pslRating,\n    // UI state\n    activeTab,\n    setActiveTab,\n    expandedMeasurementId,\n    setExpandedMeasurementId,\n    selectedVisualizationMetric,\n    setSelectedVisualizationMetric,\n    categoryFilter,\n    setCategoryFilter,\n    showLandmarkOverlay,\n    setShowLandmarkOverlay,\n    setResultsData,\n  }), [\n    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,\n    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,\n    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,\n    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,\n    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,\n    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,\n    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,\n  ]);\n\n  return (\n    <ResultsContext.Provider value={value}>\n      {children}\n    </ResultsContext.Provider>\n  );\n}\n","numLines":1392,"startLine":1,"totalLines":1392}}}
{"parentUuid":"c208b7d2-027d-40cd-9a9c-e0d6cf387818","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01THur9BN6oJ1QZU95hwZpCi","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { motion } from 'framer-motion';\n     4→import Image from 'next/image';\n     5→import { User, ScanFace, Sparkles, ChevronRight, TrendingUp, TrendingDown, Lightbulb, Ruler } from 'lucide-react';\n     6→import { useResults } from '@/contexts/ResultsContext';\n     7→import { useHeightOptional } from '@/contexts/HeightContext';\n     8→import { TabContent } from '../ResultsLayout';\n     9→import { ScoreBar, AnimatedScore, ShareButton, ExportButton } from '../shared';\n    10→import { KeyStrengthsSection, AreasOfImprovementSection } from '../cards/KeyStrengthsFlaws';\n    11→import { FacialRadarChart } from '../visualization/FacialRadarChart';\n    12→import { RatioDetailModal } from '../modals/RatioDetailModal';\n    13→import { getScoreColor, ResponsibleRatio, Ratio } from '@/types/results';\n    14→import { MetricScoreResult } from '@/lib/harmony-scoring';\n    15→import { RankedMetric, getWeightTierColor } from '@/lib/looksmax-scoring';\n    16→import { calculatePSL, getTierColor } from '@/lib/psl-calculator';\n    17→import { useState, useCallback, useMemo } from 'react';\n    18→\n    19→// ============================================\n    20→// SCORE SUMMARY CARDS\n    21→// ============================================\n    22→\n    23→interface ProfileScoreCardProps {\n    24→  title: string;\n    25→  score: number;\n    26→  icon: React.ReactNode;\n    27→  photo?: string;\n    28→  ratioCount: number;\n    29→  onClick?: () => void;\n    30→}\n    31→\n    32→function ProfileScoreCard({ title, score, icon, photo, ratioCount, onClick }: ProfileScoreCardProps) {\n    33→  const color = getScoreColor(score);\n    34→\n    35→  return (\n    36→    <motion.button\n    37→      onClick={onClick}\n    38→      className=\"bg-neutral-900/80 border border-neutral-800 rounded-xl p-4 hover:border-neutral-700 transition-all text-left w-full\"\n    39→      whileHover={{ scale: 1.02 }}\n    40→      whileTap={{ scale: 0.98 }}\n    41→    >\n    42→      <div className=\"flex items-center gap-4\">\n    43→        {/* Photo or icon */}\n    44→        <div className=\"relative w-16 h-16 rounded-lg overflow-hidden bg-neutral-800 flex-shrink-0\">\n    45→          {photo ? (\n    46→            <Image\n    47→              src={photo}\n    48→              alt={title}\n    49→              width={64}\n    50→              height={64}\n    51→              className=\"object-cover\"\n    52→              unoptimized\n    53→            />\n    54→          ) : (\n    55→            <div className=\"w-full h-full flex items-center justify-center\">\n    56→              {icon}\n    57→            </div>\n    58→          )}\n    59→        </div>\n    60→\n    61→        {/* Info */}\n    62→        <div className=\"flex-1\">\n    63→          <h3 className=\"text-sm font-medium text-neutral-400 mb-1\">{title}</h3>\n    64→          <div className=\"flex items-baseline gap-2\">\n    65→            <span className=\"text-2xl font-bold\" style={{ color }}>\n    66→              {score.toFixed(2)}\n    67→            </span>\n    68→            <span className=\"text-sm text-neutral-500\">/ 10</span>\n    69→          </div>\n    70→          <p className=\"text-xs text-neutral-500 mt-1\">{ratioCount} measurements</p>\n    71→        </div>\n    72→\n    73→        {/* Arrow */}\n    74→        <ChevronRight size={20} className=\"text-neutral-600\" />\n    75→      </div>\n    76→\n    77→      {/* Score bar */}\n    78→      <div className=\"mt-3\">\n    79→        <ScoreBar score={score} height={6} />\n    80→      </div>\n    81→    </motion.button>\n    82→  );\n    83→}\n    84→\n    85→// ============================================\n    86→// PSL PREVIEW CARD\n    87→// ============================================\n    88→\n    89→interface PSLPreviewCardProps {\n    90→  score: number;\n    91→  tier: string;\n    92→  tierColor: string;\n    93→  hasHeight: boolean;\n    94→  onClick: () => void;\n    95→}\n    96→\n    97→function PSLPreviewCard({ score, tier, tierColor, hasHeight, onClick }: PSLPreviewCardProps) {\n    98→  if (!hasHeight) {\n    99→    // Prompt to enter height\n   100→    return (\n   101→      <motion.button\n   102→        onClick={onClick}\n   103→        className=\"bg-neutral-900/80 border border-dashed border-neutral-700 rounded-xl p-4 hover:border-cyan-500/50 transition-all text-left w-full\"\n   104→        whileHover={{ scale: 1.02 }}\n   105→        whileTap={{ scale: 0.98 }}\n   106→      >\n   107→        <div className=\"flex items-center gap-4\">\n   108→          <div className=\"w-14 h-14 rounded-lg bg-cyan-500/20 flex items-center justify-center flex-shrink-0\">\n   109→            <Ruler size={24} className=\"text-cyan-400\" />\n   110→          </div>\n   111→          <div className=\"flex-1\">\n   112→            <h3 className=\"text-sm font-medium text-white mb-1\">Get Your PSL Rating</h3>\n   113→            <p className=\"text-xs text-neutral-400\">Enter your height to calculate your Pretty Scale Level score</p>\n   114→          </div>\n   115→          <ChevronRight size={20} className=\"text-cyan-400\" />\n   116→        </div>\n   117→      </motion.button>\n   118→    );\n   119→  }\n   120→\n   121→  return (\n   122→    <motion.button\n   123→      onClick={onClick}\n   124→      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-xl p-4 hover:border-cyan-500/30 transition-all text-left w-full\"\n   125→      whileHover={{ scale: 1.02 }}\n   126→      whileTap={{ scale: 0.98 }}\n   127→    >\n   128→      <div className=\"flex items-center gap-4\">\n   129→        {/* PSL Score */}\n   130→        <div className=\"w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0\" style={{ backgroundColor: `${tierColor}20` }}>\n   131→          <span className=\"text-2xl font-bold\" style={{ color: tierColor }}>\n   132→            {score.toFixed(1)}\n   133→          </span>\n   134→        </div>\n   135→\n   136→        {/* Info */}\n   137→        <div className=\"flex-1\">\n   138→          <div className=\"flex items-center gap-2 mb-1\">\n   139→            <h3 className=\"text-sm font-medium text-neutral-400\">PSL Rating</h3>\n   140→            <span className=\"text-xs px-2 py-0.5 rounded-full font-medium\" style={{ backgroundColor: `${tierColor}20`, color: tierColor }}>\n   141→              {tier}\n   142→            </span>\n   143→          </div>\n   144→          <p className=\"text-xs text-neutral-500\">Face (75%) + Height (20%) + Body (5%)</p>\n   145→        </div>\n   146→\n   147→        {/* Arrow */}\n   148→        <div className=\"flex flex-col items-end\">\n   149→          <span className=\"text-xs text-neutral-500 mb-1\">View Details</span>\n   150→          <ChevronRight size={20} className=\"text-neutral-600\" />\n   151→        </div>\n   152→      </div>\n   153→    </motion.button>\n   154→  );\n   155→}\n   156→\n   157→// ============================================\n   158→// QUICK INSIGHTS - TOP/BOTTOM METRICS WITH ADVICE\n   159→// ============================================\n   160→\n   161→interface MetricInsightCardProps {\n   162→  metric: RankedMetric;\n   163→  type: 'strength' | 'improvement';\n   164→  index: number;\n   165→}\n   166→\n   167→function MetricInsightCard({ metric, type, index }: MetricInsightCardProps) {\n   168→  const isStrength = type === 'strength';\n   169→  const color = getScoreColor(metric.score);\n   170→  const weightTierClass = getWeightTierColor(metric.weightTier);\n   171→\n   172→  return (\n   173→    <motion.div\n   174→      className={`bg-neutral-900/80 border rounded-xl p-4 ${\n   175→        isStrength ? 'border-green-500/30' : 'border-orange-500/30'\n   176→      }`}\n   177→      initial={{ opacity: 0, x: isStrength ? -20 : 20 }}\n   178→      animate={{ opacity: 1, x: 0 }}\n   179→      transition={{ delay: 0.1 * index }}\n   180→    >\n   181→      <div className=\"flex items-start gap-3\">\n   182→        <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${\n   183→          isStrength ? 'bg-green-500/20' : 'bg-orange-500/20'\n   184→        }`}>\n   185→          {isStrength ? (\n   186→            <TrendingUp size={16} className=\"text-green-400\" />\n   187→          ) : (\n   188→            <TrendingDown size={16} className=\"text-orange-400\" />\n   189→          )}\n   190→        </div>\n   191→\n   192→        <div className=\"flex-1 min-w-0\">\n   193→          <div className=\"flex items-center gap-2 mb-1\">\n   194→            <h4 className=\"font-medium text-white text-sm truncate\">{metric.name}</h4>\n   195→            <span className={`text-xs px-1.5 py-0.5 rounded border ${weightTierClass}`}>\n   196→              {metric.weightTier === 'high' ? '3x' : metric.weightTier === 'medium' ? '2x' : '1x'}\n   197→            </span>\n   198→          </div>\n   199→\n   200→          <div className=\"flex items-center gap-3 mb-2\">\n   201→            <span className=\"text-lg font-bold\" style={{ color }}>\n   202→              {metric.score.toFixed(1)}\n   203→            </span>\n   204→            <span className=\"text-xs text-neutral-500\">\n   205→              Ideal: {metric.idealMin.toFixed(1)} - {metric.idealMax.toFixed(1)}\n   206→            </span>\n   207→          </div>\n   208→\n   209→          {/* Advice */}\n   210→          <div className=\"flex items-start gap-2 mt-2 p-2 bg-neutral-800/50 rounded-lg\">\n   211→            <Lightbulb size={14} className={isStrength ? 'text-green-400 mt-0.5' : 'text-orange-400 mt-0.5'} />\n   212→            <p className=\"text-xs text-neutral-300 leading-relaxed\">{metric.advice}</p>\n   213→          </div>\n   214→        </div>\n   215→      </div>\n   216→    </motion.div>\n   217→  );\n   218→}\n   219→\n   220→interface QuickInsightsSectionProps {\n   221→  topMetrics: RankedMetric[];\n   222→  bottomMetrics: RankedMetric[];\n   223→}\n   224→\n   225→function QuickInsightsSection({ topMetrics, bottomMetrics }: QuickInsightsSectionProps) {\n   226→  if (topMetrics.length === 0 && bottomMetrics.length === 0) return null;\n   227→\n   228→  return (\n   229→    <div className=\"mb-8\">\n   230→      <h3 className=\"text-lg font-semibold text-white mb-4 flex items-center gap-2\">\n   231→        <Lightbulb size={20} className=\"text-cyan-400\" />\n   232→        Quick Insights\n   233→      </h3>\n   234→\n   235→      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n   236→        {/* Top 3 Strengths */}\n   237→        <div>\n   238→          <h4 className=\"text-sm font-medium text-green-400 mb-3 flex items-center gap-2\">\n   239→            <TrendingUp size={14} />\n   240→            Top Strengths\n   241→          </h4>\n   242→          <div className=\"space-y-3\">\n   243→            {topMetrics.map((metric, index) => (\n   244→              <MetricInsightCard\n   245→                key={metric.metricId}\n   246→                metric={metric}\n   247→                type=\"strength\"\n   248→                index={index}\n   249→              />\n   250→            ))}\n   251→          </div>\n   252→        </div>\n   253→\n   254→        {/* Bottom 3 - Areas to Improve */}\n   255→        <div>\n   256→          <h4 className=\"text-sm font-medium text-orange-400 mb-3 flex items-center gap-2\">\n   257→            <TrendingDown size={14} />\n   258→            Areas to Improve\n   259→          </h4>\n   260→          <div className=\"space-y-3\">\n   261→            {bottomMetrics.map((metric, index) => (\n   262→              <MetricInsightCard\n   263→                key={metric.metricId}\n   264→                metric={metric}\n   265→                type=\"improvement\"\n   266→                index={index}\n   267→              />\n   268→            ))}\n   269→          </div>\n   270→        </div>\n   271→      </div>\n   272→    </div>\n   273→  );\n   274→}\n   275→\n   276→// ============================================\n   277→// HARMONY SCORE DISPLAY (with AnimatedScore and Radar Chart)\n   278→// ============================================\n   279→\n   280→function HarmonyScoreDisplay() {\n   281→  const { overallScore, frontScore, sideScore, harmonyPercentage, harmonyScoreResult, pslRating } = useResults();\n   282→  const [showRadar, setShowRadar] = useState(true);\n   283→\n   284→  // Get tier color based on PSL\n   285→  const getTierColor = (psl: number) => {\n   286→    // Handle invalid PSL values\n   287→    if (typeof psl !== 'number' || !Number.isFinite(psl)) {\n   288→      return 'text-orange-400';\n   289→    }\n   290→    if (psl >= 7.0) return 'text-purple-400';\n   291→    if (psl >= 6.0) return 'text-cyan-400';\n   292→    if (psl >= 5.0) return 'text-green-400';\n   293→    if (psl >= 4.0) return 'text-yellow-400';\n   294→    return 'text-orange-400';\n   295→  };\n   296→\n   297→  // Safe values for display with fallbacks\n   298→  const safePslRating = useMemo(() => ({\n   299→    psl: typeof pslRating?.psl === 'number' && Number.isFinite(pslRating.psl) ? pslRating.psl : 3.0,\n   300→    tier: pslRating?.tier || 'Unknown',\n   301→    percentile: typeof pslRating?.percentile === 'number' && Number.isFinite(pslRating.percentile) ? pslRating.percentile : 50,\n   302→    description: pslRating?.description || 'Analysis pending',\n   303→  }), [pslRating]);\n   304→\n   305→  const safeHarmonyPercentage = typeof harmonyPercentage === 'number' && Number.isFinite(harmonyPercentage)\n   306→    ? harmonyPercentage\n   307→    : 0;\n   308→\n   309→  const safeFrontScore = typeof frontScore === 'number' && Number.isFinite(frontScore) ? frontScore : 0;\n   310→  const safeSideScore = typeof sideScore === 'number' && Number.isFinite(sideScore) ? sideScore : 0;\n   311→  const safeOverallScore = typeof overallScore === 'number' && Number.isFinite(overallScore) ? overallScore : 0;\n   312→\n   313→  return (\n   314→    <motion.div\n   315→      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6 md:p-8\"\n   316→      initial={{ opacity: 0, y: 20 }}\n   317→      animate={{ opacity: 1, y: 0 }}\n   318→      transition={{ duration: 0.5 }}\n   319→    >\n   320→      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\n   321→        {/* Left: Score Display */}\n   322→        <div className=\"text-center flex flex-col justify-center\">\n   323→          <h2 className=\"text-lg font-medium text-neutral-400 mb-2\">Weighted Harmony Score</h2>\n   324→\n   325→          {/* PSL Rating Badge */}\n   326→          <motion.div\n   327→            className=\"flex justify-center mb-3\"\n   328→            initial={{ scale: 0 }}\n   329→            animate={{ scale: 1 }}\n   330→            transition={{ delay: 0.2, type: 'spring' }}\n   331→          >\n   332→            <div className=\"px-5 py-2 bg-gradient-to-r from-neutral-800 to-neutral-900 border border-neutral-700 rounded-xl\">\n   333→              <div className=\"flex items-center gap-3\">\n   334→                <div className=\"text-center\">\n   335→                  <span className={`text-3xl font-bold ${getTierColor(safePslRating.psl)}`}>\n   336→                    {safePslRating.psl.toFixed(1)}\n   337→                  </span>\n   338→                  <span className=\"text-sm text-neutral-500 ml-1\">PSL</span>\n   339→                </div>\n   340→                <div className=\"h-8 w-px bg-neutral-700\" />\n   341→                <div className=\"text-left\">\n   342→                  <p className={`text-sm font-semibold ${getTierColor(safePslRating.psl)}`}>\n   343→                    {safePslRating.tier}\n   344→                  </p>\n   345→                  <p className=\"text-xs text-neutral-500\">\n   346→                    Top {(100 - safePslRating.percentile).toFixed(1)}%\n   347→                  </p>\n   348→                </div>\n   349→              </div>\n   350→            </div>\n   351→          </motion.div>\n   352→\n   353→          {/* Harmony Percentage Badge */}\n   354→          <motion.div\n   355→            className=\"flex justify-center mb-4\"\n   356→            initial={{ scale: 0 }}\n   357→            animate={{ scale: 1 }}\n   358→            transition={{ delay: 0.3, type: 'spring' }}\n   359→          >\n   360→            <div className=\"px-4 py-1 bg-gradient-to-r from-purple-500/20 to-cyan-500/20 border border-purple-500/30 rounded-full\">\n   361→              <span className=\"text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400\">\n   362→                {safeHarmonyPercentage.toFixed(1)}%\n   363→              </span>\n   364→              <span className=\"text-xs text-neutral-500 ml-2\">Harmony</span>\n   365→            </div>\n   366→          </motion.div>\n   367→\n   368→          {/* Animated Score */}\n   369→          <div className=\"flex justify-center mb-4\">\n   370→            <AnimatedScore\n   371→              score={safeOverallScore}\n   372→              duration={2.5}\n   373→              delay={0.5}\n   374→              showConfetti={true}\n   375→              confettiThreshold={7.5}\n   376→            />\n   377→          </div>\n   378→\n   379→          {/* Profile Breakdowns */}\n   380→          <div className=\"flex justify-center gap-8 mb-4\">\n   381→            <div className=\"text-center\">\n   382→              <p className=\"text-xs text-neutral-500 mb-1\">Front Profile</p>\n   383→              <p className=\"text-xl font-bold\" style={{ color: getScoreColor(safeFrontScore) }}>\n   384→                {safeFrontScore.toFixed(2)}\n   385→              </p>\n   386→            </div>\n   387→            <div className=\"w-px bg-neutral-800\" />\n   388→            <div className=\"text-center\">\n   389→              <p className=\"text-xs text-neutral-500 mb-1\">Side Profile</p>\n   390→              <p className=\"text-xl font-bold\" style={{ color: getScoreColor(safeSideScore) }}>\n   391→                {safeSideScore.toFixed(2)}\n   392→              </p>\n   393→            </div>\n   394→          </div>\n   395→\n   396→          {/* Weight Distribution */}\n   397→          {harmonyScoreResult && (\n   398→            <div className=\"flex justify-center gap-3 mb-4 text-xs\">\n   399→              <span className=\"px-2 py-1 rounded bg-purple-500/20 text-purple-400 border border-purple-500/30\">\n   400→                High Impact: {harmonyScoreResult.weightDistribution.highImpact.count}\n   401→              </span>\n   402→              <span className=\"px-2 py-1 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30\">\n   403→                Medium: {harmonyScoreResult.weightDistribution.mediumImpact.count}\n   404→              </span>\n   405→              <span className=\"px-2 py-1 rounded bg-gray-500/20 text-gray-400 border border-gray-500/30\">\n   406→                Standard: {harmonyScoreResult.weightDistribution.standard.count}\n   407→              </span>\n   408→            </div>\n   409→          )}\n   410→\n   411→          <p className=\"text-sm text-neutral-400 max-w-md mx-auto\">\n   412→            {safeHarmonyPercentage >= 80 ? 'Exceptional facial harmony. Your features are well-balanced and proportioned.' :\n   413→              safeHarmonyPercentage >= 60 ? 'Good facial harmony with some areas that could be optimized.' :\n   414→                safeHarmonyPercentage >= 40 ? 'Average facial harmony. Several areas have room for improvement.' :\n   415→                  'Below average facial harmony. Multiple areas could benefit from attention.'}\n   416→          </p>\n   417→        </div>\n   418→\n   419→        {/* Right: Radar Chart */}\n   420→        <div className=\"flex flex-col\">\n   421→          <div className=\"flex items-center justify-between mb-2\">\n   422→            <h3 className=\"text-sm font-medium text-neutral-400\">Category Breakdown</h3>\n   423→            <button\n   424→              onClick={() => setShowRadar(!showRadar)}\n   425→              className=\"text-xs text-cyan-400 hover:text-cyan-300 transition-colors\"\n   426→            >\n   427→              {showRadar ? 'Hide' : 'Show'}\n   428→            </button>\n   429→          </div>\n   430→          {showRadar && (\n   431→            <motion.div\n   432→              initial={{ opacity: 0, scale: 0.95 }}\n   433→              animate={{ opacity: 1, scale: 1 }}\n   434→              transition={{ duration: 0.5, delay: 0.3 }}\n   435→              className=\"flex-1 min-h-[280px]\"\n   436→            >\n   437→              <FacialRadarChart height={280} />\n   438→            </motion.div>\n   439→          )}\n   440→        </div>\n   441→      </div>\n   442→    </motion.div>\n   443→  );\n   444→}\n   445→\n   446→// ============================================\n   447→// OVERVIEW TAB\n   448→// ============================================\n   449→\n   450→export function OverviewTab() {\n   451→  const {\n   452→    overallScore,\n   453→    frontScore,\n   454→    sideScore,\n   455→    frontRatios,\n   456→    sideRatios,\n   457→    strengths,\n   458→    flaws,\n   459→    frontPhoto,\n   460→    sidePhoto,\n   461→    frontLandmarks,\n   462→    sideLandmarks,\n   463→    gender,\n   464→    ethnicity,\n   465→    setActiveTab,\n   466→    topMetrics,\n   467→    bottomMetrics,\n   468→    setSelectedVisualizationMetric,\n   469→  } = useResults();\n   470→\n   471→  const heightContext = useHeightOptional();\n   472→  const [selectedRatio, setSelectedRatio] = useState<MetricScoreResult | null>(null);\n   473→  const [isModalOpen, setIsModalOpen] = useState(false);\n   474→\n   475→  // Calculate PSL for the preview card\n   476→  const pslPreviewData = useMemo(() => {\n   477→    const heightCm = heightContext?.heightCm;\n   478→    if (!heightCm || !overallScore) {\n   479→      return { hasHeight: false, score: 0, tier: 'Unknown', tierColor: '#6b7280' };\n   480→    }\n   481→\n   482→    const pslResult = calculatePSL({\n   483→      faceScore: overallScore,\n   484→      heightCm,\n   485→      gender: gender || 'male',\n   486→    });\n   487→\n   488→    return {\n   489→      hasHeight: true,\n   490→      score: pslResult.score,\n   491→      tier: pslResult.tier,\n   492→      tierColor: getTierColor(pslResult.tier),\n   493→    };\n   494→  }, [heightContext?.heightCm, overallScore, gender]);\n   495→\n   496→  // All ratios combined for modal navigation\n   497→  const allRatios = useMemo(() => [...frontRatios, ...sideRatios], [frontRatios, sideRatios]);\n   498→\n   499→  // Current ratio index for navigation\n   500→  const currentRatioIndex = useMemo(() => {\n   501→    if (!selectedRatio) return -1;\n   502→    return allRatios.findIndex(r => r.id === selectedRatio.metricId);\n   503→  }, [selectedRatio, allRatios]);\n   504→\n   505→  // Convert Ratio to MetricScoreResult for modal\n   506→  const ratioToMetricResult = useCallback((ratio: Ratio): MetricScoreResult => {\n   507→    return {\n   508→      metricId: ratio.id,\n   509→      name: ratio.name,\n   510→      value: ratio.value,\n   511→      score: ratio.score,\n   512→      standardizedScore: ratio.standardizedScore,\n   513→      idealMin: ratio.idealMin,\n   514→      idealMax: ratio.idealMax,\n   515→      deviation: 0,\n   516→      deviationDirection: 'within',\n   517→      unit: ratio.unit === 'x' ? 'ratio' : ratio.unit === '%' ? 'percent' : ratio.unit === '°' ? 'degrees' : ratio.unit,\n   518→      category: ratio.category,\n   519→      qualityTier: ratio.qualityLevel,\n   520→      severity: ratio.severity,\n   521→    } as MetricScoreResult;\n   522→  }, []);\n   523→\n   524→  // Handle ratio click from strengths/flaws sections\n   525→  const handleRatioClick = useCallback((ratio: ResponsibleRatio, categoryName: string) => {\n   526→    // Find the full ratio data from frontRatios or sideRatios\n   527→    const fullRatio = allRatios.find(\n   528→      (r) => r.name === ratio.ratioName || r.id === ratio.ratioId\n   529→    );\n   530→\n   531→    // Update the visualization first (shows on face image)\n   532→    if (fullRatio) {\n   533→      setSelectedVisualizationMetric(fullRatio.id);\n   534→      setSelectedRatio(ratioToMetricResult(fullRatio));\n   535→    } else {\n   536→      // Create a minimal MetricScoreResult from ResponsibleRatio\n   537→      setSelectedVisualizationMetric(ratio.ratioId);\n   538→      setSelectedRatio({\n   539→        metricId: ratio.ratioId,\n   540→        name: ratio.ratioName,\n   541→        value: ratio.value,\n   542→        score: ratio.score,\n   543→        standardizedScore: ratio.score,\n   544→        idealMin: ratio.idealMin,\n   545→        idealMax: ratio.idealMax,\n   546→        deviation: 0,\n   547→        deviationDirection: 'within',\n   548→        unit: (ratio.unit as 'ratio' | 'percent' | 'degrees' | 'mm' | 'none') || 'ratio',\n   549→        category: ratio.category || categoryName,\n   550→        qualityTier: ratio.score >= 8 ? 'ideal' : ratio.score >= 6 ? 'excellent' : ratio.score >= 4 ? 'good' : 'below_average',\n   551→        severity: 'optimal',\n   552→      } as MetricScoreResult);\n   553→    }\n   554→    setIsModalOpen(true);\n   555→  }, [allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);\n   556→\n   557→  // Navigate to previous/next ratio in modal\n   558→  const handlePreviousRatio = useCallback(() => {\n   559→    if (currentRatioIndex > 0) {\n   560→      const prevRatio = allRatios[currentRatioIndex - 1];\n   561→      setSelectedRatio(ratioToMetricResult(prevRatio));\n   562→      setSelectedVisualizationMetric(prevRatio.id);\n   563→    }\n   564→  }, [currentRatioIndex, allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);\n   565→\n   566→  const handleNextRatio = useCallback(() => {\n   567→    if (currentRatioIndex < allRatios.length - 1) {\n   568→      const nextRatio = allRatios[currentRatioIndex + 1];\n   569→      setSelectedRatio(ratioToMetricResult(nextRatio));\n   570→      setSelectedVisualizationMetric(nextRatio.id);\n   571→    }\n   572→  }, [currentRatioIndex, allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);\n   573→\n   574→  // Determine if selected ratio is from side profile\n   575→  const isSideRatio = useMemo(() => {\n   576→    if (!selectedRatio) return false;\n   577→    const sideMetricIds = sideRatios.map(r => r.id);\n   578→    return sideMetricIds.includes(selectedRatio.metricId);\n   579→  }, [selectedRatio, sideRatios]);\n   580→\n   581→  // Memoized modal values (useMemo instead of useCallback for computed values)\n   582→  const modalPhoto = useMemo(() => {\n   583→    if (!selectedRatio) return frontPhoto;\n   584→    return isSideRatio ? (sidePhoto || frontPhoto) : frontPhoto;\n   585→  }, [selectedRatio, isSideRatio, frontPhoto, sidePhoto]);\n   586→\n   587→  const modalLandmarks = useMemo(() => {\n   588→    return isSideRatio ? (sideLandmarks || []) : (frontLandmarks || []);\n   589→  }, [isSideRatio, frontLandmarks, sideLandmarks]);\n   590→\n   591→  const modalProfileType = useMemo((): 'front' | 'side' => {\n   592→    return isSideRatio ? 'side' : 'front';\n   593→  }, [isSideRatio]);\n   594→\n   595→  return (\n   596→    <TabContent\n   597→      title=\"Overview\"\n   598→      subtitle=\"Your complete facial harmony analysis\"\n   599→      rightContent={\n   600→        <div className=\"flex items-center gap-2\">\n   601→          <ShareButton score={overallScore} frontScore={frontScore} sideScore={sideScore} />\n   602→          <ExportButton elementId=\"results-overview\" />\n   603→        </div>\n   604→      }\n   605→    >\n   606→      {/* Main content with ID for export */}\n   607→      <div id=\"results-overview\">\n   608→        {/* Harmony Score */}\n   609→        <div className=\"mb-8\">\n   610→          <HarmonyScoreDisplay />\n   611→        </div>\n   612→\n   613→        {/* Profile Scores */}\n   614→        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\n   615→          <ProfileScoreCard\n   616→            title=\"Front Profile\"\n   617→            score={frontScore}\n   618→            icon={<User size={24} className=\"text-neutral-600\" />}\n   619→            photo={frontPhoto}\n   620→            ratioCount={frontRatios.length}\n   621→            onClick={() => setActiveTab('front-ratios')}\n   622→          />\n   623→          <ProfileScoreCard\n   624→            title=\"Side Profile\"\n   625→            score={sideScore}\n   626→            icon={<ScanFace size={24} className=\"text-neutral-600\" />}\n   627→            photo={sidePhoto || undefined}\n   628→            ratioCount={sideRatios.length}\n   629→            onClick={() => setActiveTab('side-ratios')}\n   630→          />\n   631→        </div>\n   632→\n   633→        {/* PSL Preview Card */}\n   634→        <div className=\"mb-8\">\n   635→          <PSLPreviewCard\n   636→            score={pslPreviewData.score}\n   637→            tier={pslPreviewData.tier}\n   638→            tierColor={pslPreviewData.tierColor}\n   639→            hasHeight={pslPreviewData.hasHeight}\n   640→            onClick={() => setActiveTab('psl')}\n   641→          />\n   642→        </div>\n   643→\n   644→        {/* Quick Insights - Top/Bottom Metrics with Advice (from looksmax_engine.py) */}\n   645→        <QuickInsightsSection topMetrics={topMetrics} bottomMetrics={bottomMetrics} />\n   646→\n   647→        {/* Strengths & Flaws Grid - Harmony Style */}\n   648→        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8\">\n   649→          {/* Key Strengths */}\n   650→          <KeyStrengthsSection\n   651→            strengths={strengths}\n   652→            onRatioClick={handleRatioClick}\n   653→            initialShowCount={3}\n   654→          />\n   655→\n   656→          {/* Areas of Improvement */}\n   657→          <AreasOfImprovementSection\n   658→            flaws={flaws}\n   659→            onRatioClick={handleRatioClick}\n   660→            initialShowCount={3}\n   661→          />\n   662→        </div>\n   663→\n   664→        {/* Call to Action */}\n   665→        <motion.div\n   666→          className=\"bg-gradient-to-r from-cyan-500/20 to-blue-600/20 border border-cyan-500/30 rounded-xl p-6 flex items-center justify-between\"\n   667→          initial={{ opacity: 0 }}\n   668→          animate={{ opacity: 1 }}\n   669→          transition={{ delay: 0.5 }}\n   670→        >\n   671→          <div className=\"flex items-center gap-4\">\n   672→            <div className=\"w-12 h-12 rounded-xl bg-cyan-500/20 flex items-center justify-center\">\n   673→              <Sparkles size={24} className=\"text-cyan-400\" />\n   674→            </div>\n   675→            <div>\n   676→              <h3 className=\"font-semibold text-white\">Unlock Your Potential</h3>\n   677→              <p className=\"text-sm text-neutral-400\">\n   678→                See personalized recommendations to improve your harmony score\n   679→              </p>\n   680→            </div>\n   681→          </div>\n   682→          <button\n   683→            onClick={() => setActiveTab('plan')}\n   684→            className=\"px-4 py-2 bg-cyan-500 text-black font-medium rounded-lg hover:bg-cyan-400 transition-colors flex items-center gap-2\"\n   685→          >\n   686→            View Plan\n   687→            <ChevronRight size={16} />\n   688→          </button>\n   689→        </motion.div>\n   690→      </div>{/* End of results-overview */}\n   691→\n   692→      {/* Ratio Detail Modal */}\n   693→      <RatioDetailModal\n   694→        isOpen={isModalOpen}\n   695→        onClose={() => setIsModalOpen(false)}\n   696→        ratio={selectedRatio}\n   697→        onPrevious={handlePreviousRatio}\n   698→        onNext={handleNextRatio}\n   699→        hasPrevious={currentRatioIndex > 0}\n   700→        hasNext={currentRatioIndex < allRatios.length - 1}\n   701→        facePhoto={modalPhoto}\n   702→        landmarks={modalLandmarks}\n   703→        allRatios={allRatios}\n   704→        profileType={modalProfileType}\n   705→        gender={gender}\n   706→        ethnicity={ethnicity}\n   707→      />\n   708→    </TabContent>\n   709→  );\n   710→}\n   711→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7c21d24c-378c-4eb4-b303-c47ca2497fc0","timestamp":"2025-12-26T06:49:39.323Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx","content":"'use client';\n\nimport { motion } from 'framer-motion';\nimport Image from 'next/image';\nimport { User, ScanFace, Sparkles, ChevronRight, TrendingUp, TrendingDown, Lightbulb, Ruler } from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useHeightOptional } from '@/contexts/HeightContext';\nimport { TabContent } from '../ResultsLayout';\nimport { ScoreBar, AnimatedScore, ShareButton, ExportButton } from '../shared';\nimport { KeyStrengthsSection, AreasOfImprovementSection } from '../cards/KeyStrengthsFlaws';\nimport { FacialRadarChart } from '../visualization/FacialRadarChart';\nimport { RatioDetailModal } from '../modals/RatioDetailModal';\nimport { getScoreColor, ResponsibleRatio, Ratio } from '@/types/results';\nimport { MetricScoreResult } from '@/lib/harmony-scoring';\nimport { RankedMetric, getWeightTierColor } from '@/lib/looksmax-scoring';\nimport { calculatePSL, getTierColor } from '@/lib/psl-calculator';\nimport { useState, useCallback, useMemo } from 'react';\n\n// ============================================\n// SCORE SUMMARY CARDS\n// ============================================\n\ninterface ProfileScoreCardProps {\n  title: string;\n  score: number;\n  icon: React.ReactNode;\n  photo?: string;\n  ratioCount: number;\n  onClick?: () => void;\n}\n\nfunction ProfileScoreCard({ title, score, icon, photo, ratioCount, onClick }: ProfileScoreCardProps) {\n  const color = getScoreColor(score);\n\n  return (\n    <motion.button\n      onClick={onClick}\n      className=\"bg-neutral-900/80 border border-neutral-800 rounded-xl p-4 hover:border-neutral-700 transition-all text-left w-full\"\n      whileHover={{ scale: 1.02 }}\n      whileTap={{ scale: 0.98 }}\n    >\n      <div className=\"flex items-center gap-4\">\n        {/* Photo or icon */}\n        <div className=\"relative w-16 h-16 rounded-lg overflow-hidden bg-neutral-800 flex-shrink-0\">\n          {photo ? (\n            <Image\n              src={photo}\n              alt={title}\n              width={64}\n              height={64}\n              className=\"object-cover\"\n              unoptimized\n            />\n          ) : (\n            <div className=\"w-full h-full flex items-center justify-center\">\n              {icon}\n            </div>\n          )}\n        </div>\n\n        {/* Info */}\n        <div className=\"flex-1\">\n          <h3 className=\"text-sm font-medium text-neutral-400 mb-1\">{title}</h3>\n          <div className=\"flex items-baseline gap-2\">\n            <span className=\"text-2xl font-bold\" style={{ color }}>\n              {score.toFixed(2)}\n            </span>\n            <span className=\"text-sm text-neutral-500\">/ 10</span>\n          </div>\n          <p className=\"text-xs text-neutral-500 mt-1\">{ratioCount} measurements</p>\n        </div>\n\n        {/* Arrow */}\n        <ChevronRight size={20} className=\"text-neutral-600\" />\n      </div>\n\n      {/* Score bar */}\n      <div className=\"mt-3\">\n        <ScoreBar score={score} height={6} />\n      </div>\n    </motion.button>\n  );\n}\n\n// ============================================\n// PSL PREVIEW CARD\n// ============================================\n\ninterface PSLPreviewCardProps {\n  score: number;\n  tier: string;\n  tierColor: string;\n  hasHeight: boolean;\n  onClick: () => void;\n}\n\nfunction PSLPreviewCard({ score, tier, tierColor, hasHeight, onClick }: PSLPreviewCardProps) {\n  if (!hasHeight) {\n    // Prompt to enter height\n    return (\n      <motion.button\n        onClick={onClick}\n        className=\"bg-neutral-900/80 border border-dashed border-neutral-700 rounded-xl p-4 hover:border-cyan-500/50 transition-all text-left w-full\"\n        whileHover={{ scale: 1.02 }}\n        whileTap={{ scale: 0.98 }}\n      >\n        <div className=\"flex items-center gap-4\">\n          <div className=\"w-14 h-14 rounded-lg bg-cyan-500/20 flex items-center justify-center flex-shrink-0\">\n            <Ruler size={24} className=\"text-cyan-400\" />\n          </div>\n          <div className=\"flex-1\">\n            <h3 className=\"text-sm font-medium text-white mb-1\">Get Your PSL Rating</h3>\n            <p className=\"text-xs text-neutral-400\">Enter your height to calculate your Pretty Scale Level score</p>\n          </div>\n          <ChevronRight size={20} className=\"text-cyan-400\" />\n        </div>\n      </motion.button>\n    );\n  }\n\n  return (\n    <motion.button\n      onClick={onClick}\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-xl p-4 hover:border-cyan-500/30 transition-all text-left w-full\"\n      whileHover={{ scale: 1.02 }}\n      whileTap={{ scale: 0.98 }}\n    >\n      <div className=\"flex items-center gap-4\">\n        {/* PSL Score */}\n        <div className=\"w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0\" style={{ backgroundColor: `${tierColor}20` }}>\n          <span className=\"text-2xl font-bold\" style={{ color: tierColor }}>\n            {score.toFixed(1)}\n          </span>\n        </div>\n\n        {/* Info */}\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"text-sm font-medium text-neutral-400\">PSL Rating</h3>\n            <span className=\"text-xs px-2 py-0.5 rounded-full font-medium\" style={{ backgroundColor: `${tierColor}20`, color: tierColor }}>\n              {tier}\n            </span>\n          </div>\n          <p className=\"text-xs text-neutral-500\">Face (75%) + Height (20%) + Body (5%)</p>\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-end\">\n          <span className=\"text-xs text-neutral-500 mb-1\">View Details</span>\n          <ChevronRight size={20} className=\"text-neutral-600\" />\n        </div>\n      </div>\n    </motion.button>\n  );\n}\n\n// ============================================\n// QUICK INSIGHTS - TOP/BOTTOM METRICS WITH ADVICE\n// ============================================\n\ninterface MetricInsightCardProps {\n  metric: RankedMetric;\n  type: 'strength' | 'improvement';\n  index: number;\n}\n\nfunction MetricInsightCard({ metric, type, index }: MetricInsightCardProps) {\n  const isStrength = type === 'strength';\n  const color = getScoreColor(metric.score);\n  const weightTierClass = getWeightTierColor(metric.weightTier);\n\n  return (\n    <motion.div\n      className={`bg-neutral-900/80 border rounded-xl p-4 ${\n        isStrength ? 'border-green-500/30' : 'border-orange-500/30'\n      }`}\n      initial={{ opacity: 0, x: isStrength ? -20 : 20 }}\n      animate={{ opacity: 1, x: 0 }}\n      transition={{ delay: 0.1 * index }}\n    >\n      <div className=\"flex items-start gap-3\">\n        <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${\n          isStrength ? 'bg-green-500/20' : 'bg-orange-500/20'\n        }`}>\n          {isStrength ? (\n            <TrendingUp size={16} className=\"text-green-400\" />\n          ) : (\n            <TrendingDown size={16} className=\"text-orange-400\" />\n          )}\n        </div>\n\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h4 className=\"font-medium text-white text-sm truncate\">{metric.name}</h4>\n            <span className={`text-xs px-1.5 py-0.5 rounded border ${weightTierClass}`}>\n              {metric.weightTier === 'high' ? '3x' : metric.weightTier === 'medium' ? '2x' : '1x'}\n            </span>\n          </div>\n\n          <div className=\"flex items-center gap-3 mb-2\">\n            <span className=\"text-lg font-bold\" style={{ color }}>\n              {metric.score.toFixed(1)}\n            </span>\n            <span className=\"text-xs text-neutral-500\">\n              Ideal: {metric.idealMin.toFixed(1)} - {metric.idealMax.toFixed(1)}\n            </span>\n          </div>\n\n          {/* Advice */}\n          <div className=\"flex items-start gap-2 mt-2 p-2 bg-neutral-800/50 rounded-lg\">\n            <Lightbulb size={14} className={isStrength ? 'text-green-400 mt-0.5' : 'text-orange-400 mt-0.5'} />\n            <p className=\"text-xs text-neutral-300 leading-relaxed\">{metric.advice}</p>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\ninterface QuickInsightsSectionProps {\n  topMetrics: RankedMetric[];\n  bottomMetrics: RankedMetric[];\n}\n\nfunction QuickInsightsSection({ topMetrics, bottomMetrics }: QuickInsightsSectionProps) {\n  if (topMetrics.length === 0 && bottomMetrics.length === 0) return null;\n\n  return (\n    <div className=\"mb-8\">\n      <h3 className=\"text-lg font-semibold text-white mb-4 flex items-center gap-2\">\n        <Lightbulb size={20} className=\"text-cyan-400\" />\n        Quick Insights\n      </h3>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Top 3 Strengths */}\n        <div>\n          <h4 className=\"text-sm font-medium text-green-400 mb-3 flex items-center gap-2\">\n            <TrendingUp size={14} />\n            Top Strengths\n          </h4>\n          <div className=\"space-y-3\">\n            {topMetrics.map((metric, index) => (\n              <MetricInsightCard\n                key={metric.metricId}\n                metric={metric}\n                type=\"strength\"\n                index={index}\n              />\n            ))}\n          </div>\n        </div>\n\n        {/* Bottom 3 - Areas to Improve */}\n        <div>\n          <h4 className=\"text-sm font-medium text-orange-400 mb-3 flex items-center gap-2\">\n            <TrendingDown size={14} />\n            Areas to Improve\n          </h4>\n          <div className=\"space-y-3\">\n            {bottomMetrics.map((metric, index) => (\n              <MetricInsightCard\n                key={metric.metricId}\n                metric={metric}\n                type=\"improvement\"\n                index={index}\n              />\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// HARMONY SCORE DISPLAY (with AnimatedScore and Radar Chart)\n// ============================================\n\nfunction HarmonyScoreDisplay() {\n  const { overallScore, frontScore, sideScore, harmonyPercentage, harmonyScoreResult, pslRating } = useResults();\n  const [showRadar, setShowRadar] = useState(true);\n\n  // Get tier color based on PSL\n  const getTierColor = (psl: number) => {\n    // Handle invalid PSL values\n    if (typeof psl !== 'number' || !Number.isFinite(psl)) {\n      return 'text-orange-400';\n    }\n    if (psl >= 7.0) return 'text-purple-400';\n    if (psl >= 6.0) return 'text-cyan-400';\n    if (psl >= 5.0) return 'text-green-400';\n    if (psl >= 4.0) return 'text-yellow-400';\n    return 'text-orange-400';\n  };\n\n  // Safe values for display with fallbacks\n  const safePslRating = useMemo(() => ({\n    psl: typeof pslRating?.psl === 'number' && Number.isFinite(pslRating.psl) ? pslRating.psl : 3.0,\n    tier: pslRating?.tier || 'Unknown',\n    percentile: typeof pslRating?.percentile === 'number' && Number.isFinite(pslRating.percentile) ? pslRating.percentile : 50,\n    description: pslRating?.description || 'Analysis pending',\n  }), [pslRating]);\n\n  const safeHarmonyPercentage = typeof harmonyPercentage === 'number' && Number.isFinite(harmonyPercentage)\n    ? harmonyPercentage\n    : 0;\n\n  const safeFrontScore = typeof frontScore === 'number' && Number.isFinite(frontScore) ? frontScore : 0;\n  const safeSideScore = typeof sideScore === 'number' && Number.isFinite(sideScore) ? sideScore : 0;\n  const safeOverallScore = typeof overallScore === 'number' && Number.isFinite(overallScore) ? overallScore : 0;\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6 md:p-8\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.5 }}\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\n        {/* Left: Score Display */}\n        <div className=\"text-center flex flex-col justify-center\">\n          <h2 className=\"text-lg font-medium text-neutral-400 mb-2\">Weighted Harmony Score</h2>\n\n          {/* PSL Rating Badge */}\n          <motion.div\n            className=\"flex justify-center mb-3\"\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            transition={{ delay: 0.2, type: 'spring' }}\n          >\n            <div className=\"px-5 py-2 bg-gradient-to-r from-neutral-800 to-neutral-900 border border-neutral-700 rounded-xl\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"text-center\">\n                  <span className={`text-3xl font-bold ${getTierColor(safePslRating.psl)}`}>\n                    {safePslRating.psl.toFixed(1)}\n                  </span>\n                  <span className=\"text-sm text-neutral-500 ml-1\">PSL</span>\n                </div>\n                <div className=\"h-8 w-px bg-neutral-700\" />\n                <div className=\"text-left\">\n                  <p className={`text-sm font-semibold ${getTierColor(safePslRating.psl)}`}>\n                    {safePslRating.tier}\n                  </p>\n                  <p className=\"text-xs text-neutral-500\">\n                    Top {(100 - safePslRating.percentile).toFixed(1)}%\n                  </p>\n                </div>\n              </div>\n            </div>\n          </motion.div>\n\n          {/* Harmony Percentage Badge */}\n          <motion.div\n            className=\"flex justify-center mb-4\"\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            transition={{ delay: 0.3, type: 'spring' }}\n          >\n            <div className=\"px-4 py-1 bg-gradient-to-r from-purple-500/20 to-cyan-500/20 border border-purple-500/30 rounded-full\">\n              <span className=\"text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400\">\n                {safeHarmonyPercentage.toFixed(1)}%\n              </span>\n              <span className=\"text-xs text-neutral-500 ml-2\">Harmony</span>\n            </div>\n          </motion.div>\n\n          {/* Animated Score */}\n          <div className=\"flex justify-center mb-4\">\n            <AnimatedScore\n              score={safeOverallScore}\n              duration={2.5}\n              delay={0.5}\n              showConfetti={true}\n              confettiThreshold={7.5}\n            />\n          </div>\n\n          {/* Profile Breakdowns */}\n          <div className=\"flex justify-center gap-8 mb-4\">\n            <div className=\"text-center\">\n              <p className=\"text-xs text-neutral-500 mb-1\">Front Profile</p>\n              <p className=\"text-xl font-bold\" style={{ color: getScoreColor(safeFrontScore) }}>\n                {safeFrontScore.toFixed(2)}\n              </p>\n            </div>\n            <div className=\"w-px bg-neutral-800\" />\n            <div className=\"text-center\">\n              <p className=\"text-xs text-neutral-500 mb-1\">Side Profile</p>\n              <p className=\"text-xl font-bold\" style={{ color: getScoreColor(safeSideScore) }}>\n                {safeSideScore.toFixed(2)}\n              </p>\n            </div>\n          </div>\n\n          {/* Weight Distribution */}\n          {harmonyScoreResult && (\n            <div className=\"flex justify-center gap-3 mb-4 text-xs\">\n              <span className=\"px-2 py-1 rounded bg-purple-500/20 text-purple-400 border border-purple-500/30\">\n                High Impact: {harmonyScoreResult.weightDistribution.highImpact.count}\n              </span>\n              <span className=\"px-2 py-1 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30\">\n                Medium: {harmonyScoreResult.weightDistribution.mediumImpact.count}\n              </span>\n              <span className=\"px-2 py-1 rounded bg-gray-500/20 text-gray-400 border border-gray-500/30\">\n                Standard: {harmonyScoreResult.weightDistribution.standard.count}\n              </span>\n            </div>\n          )}\n\n          <p className=\"text-sm text-neutral-400 max-w-md mx-auto\">\n            {safeHarmonyPercentage >= 80 ? 'Exceptional facial harmony. Your features are well-balanced and proportioned.' :\n              safeHarmonyPercentage >= 60 ? 'Good facial harmony with some areas that could be optimized.' :\n                safeHarmonyPercentage >= 40 ? 'Average facial harmony. Several areas have room for improvement.' :\n                  'Below average facial harmony. Multiple areas could benefit from attention.'}\n          </p>\n        </div>\n\n        {/* Right: Radar Chart */}\n        <div className=\"flex flex-col\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <h3 className=\"text-sm font-medium text-neutral-400\">Category Breakdown</h3>\n            <button\n              onClick={() => setShowRadar(!showRadar)}\n              className=\"text-xs text-cyan-400 hover:text-cyan-300 transition-colors\"\n            >\n              {showRadar ? 'Hide' : 'Show'}\n            </button>\n          </div>\n          {showRadar && (\n            <motion.div\n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n              transition={{ duration: 0.5, delay: 0.3 }}\n              className=\"flex-1 min-h-[280px]\"\n            >\n              <FacialRadarChart height={280} />\n            </motion.div>\n          )}\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// ============================================\n// OVERVIEW TAB\n// ============================================\n\nexport function OverviewTab() {\n  const {\n    overallScore,\n    frontScore,\n    sideScore,\n    frontRatios,\n    sideRatios,\n    strengths,\n    flaws,\n    frontPhoto,\n    sidePhoto,\n    frontLandmarks,\n    sideLandmarks,\n    gender,\n    ethnicity,\n    setActiveTab,\n    topMetrics,\n    bottomMetrics,\n    setSelectedVisualizationMetric,\n  } = useResults();\n\n  const heightContext = useHeightOptional();\n  const [selectedRatio, setSelectedRatio] = useState<MetricScoreResult | null>(null);\n  const [isModalOpen, setIsModalOpen] = useState(false);\n\n  // Calculate PSL for the preview card\n  const pslPreviewData = useMemo(() => {\n    const heightCm = heightContext?.heightCm;\n    if (!heightCm || !overallScore) {\n      return { hasHeight: false, score: 0, tier: 'Unknown', tierColor: '#6b7280' };\n    }\n\n    const pslResult = calculatePSL({\n      faceScore: overallScore,\n      heightCm,\n      gender: gender || 'male',\n    });\n\n    return {\n      hasHeight: true,\n      score: pslResult.score,\n      tier: pslResult.tier,\n      tierColor: getTierColor(pslResult.tier),\n    };\n  }, [heightContext?.heightCm, overallScore, gender]);\n\n  // All ratios combined for modal navigation\n  const allRatios = useMemo(() => [...frontRatios, ...sideRatios], [frontRatios, sideRatios]);\n\n  // Current ratio index for navigation\n  const currentRatioIndex = useMemo(() => {\n    if (!selectedRatio) return -1;\n    return allRatios.findIndex(r => r.id === selectedRatio.metricId);\n  }, [selectedRatio, allRatios]);\n\n  // Convert Ratio to MetricScoreResult for modal\n  const ratioToMetricResult = useCallback((ratio: Ratio): MetricScoreResult => {\n    return {\n      metricId: ratio.id,\n      name: ratio.name,\n      value: ratio.value,\n      score: ratio.score,\n      standardizedScore: ratio.standardizedScore,\n      idealMin: ratio.idealMin,\n      idealMax: ratio.idealMax,\n      deviation: 0,\n      deviationDirection: 'within',\n      unit: ratio.unit === 'x' ? 'ratio' : ratio.unit === '%' ? 'percent' : ratio.unit === '°' ? 'degrees' : ratio.unit,\n      category: ratio.category,\n      qualityTier: ratio.qualityLevel,\n      severity: ratio.severity,\n    } as MetricScoreResult;\n  }, []);\n\n  // Handle ratio click from strengths/flaws sections\n  const handleRatioClick = useCallback((ratio: ResponsibleRatio, categoryName: string) => {\n    // Find the full ratio data from frontRatios or sideRatios\n    const fullRatio = allRatios.find(\n      (r) => r.name === ratio.ratioName || r.id === ratio.ratioId\n    );\n\n    // Update the visualization first (shows on face image)\n    if (fullRatio) {\n      setSelectedVisualizationMetric(fullRatio.id);\n      setSelectedRatio(ratioToMetricResult(fullRatio));\n    } else {\n      // Create a minimal MetricScoreResult from ResponsibleRatio\n      setSelectedVisualizationMetric(ratio.ratioId);\n      setSelectedRatio({\n        metricId: ratio.ratioId,\n        name: ratio.ratioName,\n        value: ratio.value,\n        score: ratio.score,\n        standardizedScore: ratio.score,\n        idealMin: ratio.idealMin,\n        idealMax: ratio.idealMax,\n        deviation: 0,\n        deviationDirection: 'within',\n        unit: (ratio.unit as 'ratio' | 'percent' | 'degrees' | 'mm' | 'none') || 'ratio',\n        category: ratio.category || categoryName,\n        qualityTier: ratio.score >= 8 ? 'ideal' : ratio.score >= 6 ? 'excellent' : ratio.score >= 4 ? 'good' : 'below_average',\n        severity: 'optimal',\n      } as MetricScoreResult);\n    }\n    setIsModalOpen(true);\n  }, [allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);\n\n  // Navigate to previous/next ratio in modal\n  const handlePreviousRatio = useCallback(() => {\n    if (currentRatioIndex > 0) {\n      const prevRatio = allRatios[currentRatioIndex - 1];\n      setSelectedRatio(ratioToMetricResult(prevRatio));\n      setSelectedVisualizationMetric(prevRatio.id);\n    }\n  }, [currentRatioIndex, allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);\n\n  const handleNextRatio = useCallback(() => {\n    if (currentRatioIndex < allRatios.length - 1) {\n      const nextRatio = allRatios[currentRatioIndex + 1];\n      setSelectedRatio(ratioToMetricResult(nextRatio));\n      setSelectedVisualizationMetric(nextRatio.id);\n    }\n  }, [currentRatioIndex, allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);\n\n  // Determine if selected ratio is from side profile\n  const isSideRatio = useMemo(() => {\n    if (!selectedRatio) return false;\n    const sideMetricIds = sideRatios.map(r => r.id);\n    return sideMetricIds.includes(selectedRatio.metricId);\n  }, [selectedRatio, sideRatios]);\n\n  // Memoized modal values (useMemo instead of useCallback for computed values)\n  const modalPhoto = useMemo(() => {\n    if (!selectedRatio) return frontPhoto;\n    return isSideRatio ? (sidePhoto || frontPhoto) : frontPhoto;\n  }, [selectedRatio, isSideRatio, frontPhoto, sidePhoto]);\n\n  const modalLandmarks = useMemo(() => {\n    return isSideRatio ? (sideLandmarks || []) : (frontLandmarks || []);\n  }, [isSideRatio, frontLandmarks, sideLandmarks]);\n\n  const modalProfileType = useMemo((): 'front' | 'side' => {\n    return isSideRatio ? 'side' : 'front';\n  }, [isSideRatio]);\n\n  return (\n    <TabContent\n      title=\"Overview\"\n      subtitle=\"Your complete facial harmony analysis\"\n      rightContent={\n        <div className=\"flex items-center gap-2\">\n          <ShareButton score={overallScore} frontScore={frontScore} sideScore={sideScore} />\n          <ExportButton elementId=\"results-overview\" />\n        </div>\n      }\n    >\n      {/* Main content with ID for export */}\n      <div id=\"results-overview\">\n        {/* Harmony Score */}\n        <div className=\"mb-8\">\n          <HarmonyScoreDisplay />\n        </div>\n\n        {/* Profile Scores */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\n          <ProfileScoreCard\n            title=\"Front Profile\"\n            score={frontScore}\n            icon={<User size={24} className=\"text-neutral-600\" />}\n            photo={frontPhoto}\n            ratioCount={frontRatios.length}\n            onClick={() => setActiveTab('front-ratios')}\n          />\n          <ProfileScoreCard\n            title=\"Side Profile\"\n            score={sideScore}\n            icon={<ScanFace size={24} className=\"text-neutral-600\" />}\n            photo={sidePhoto || undefined}\n            ratioCount={sideRatios.length}\n            onClick={() => setActiveTab('side-ratios')}\n          />\n        </div>\n\n        {/* PSL Preview Card */}\n        <div className=\"mb-8\">\n          <PSLPreviewCard\n            score={pslPreviewData.score}\n            tier={pslPreviewData.tier}\n            tierColor={pslPreviewData.tierColor}\n            hasHeight={pslPreviewData.hasHeight}\n            onClick={() => setActiveTab('psl')}\n          />\n        </div>\n\n        {/* Quick Insights - Top/Bottom Metrics with Advice (from looksmax_engine.py) */}\n        <QuickInsightsSection topMetrics={topMetrics} bottomMetrics={bottomMetrics} />\n\n        {/* Strengths & Flaws Grid - Harmony Style */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8\">\n          {/* Key Strengths */}\n          <KeyStrengthsSection\n            strengths={strengths}\n            onRatioClick={handleRatioClick}\n            initialShowCount={3}\n          />\n\n          {/* Areas of Improvement */}\n          <AreasOfImprovementSection\n            flaws={flaws}\n            onRatioClick={handleRatioClick}\n            initialShowCount={3}\n          />\n        </div>\n\n        {/* Call to Action */}\n        <motion.div\n          className=\"bg-gradient-to-r from-cyan-500/20 to-blue-600/20 border border-cyan-500/30 rounded-xl p-6 flex items-center justify-between\"\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          transition={{ delay: 0.5 }}\n        >\n          <div className=\"flex items-center gap-4\">\n            <div className=\"w-12 h-12 rounded-xl bg-cyan-500/20 flex items-center justify-center\">\n              <Sparkles size={24} className=\"text-cyan-400\" />\n            </div>\n            <div>\n              <h3 className=\"font-semibold text-white\">Unlock Your Potential</h3>\n              <p className=\"text-sm text-neutral-400\">\n                See personalized recommendations to improve your harmony score\n              </p>\n            </div>\n          </div>\n          <button\n            onClick={() => setActiveTab('plan')}\n            className=\"px-4 py-2 bg-cyan-500 text-black font-medium rounded-lg hover:bg-cyan-400 transition-colors flex items-center gap-2\"\n          >\n            View Plan\n            <ChevronRight size={16} />\n          </button>\n        </motion.div>\n      </div>{/* End of results-overview */}\n\n      {/* Ratio Detail Modal */}\n      <RatioDetailModal\n        isOpen={isModalOpen}\n        onClose={() => setIsModalOpen(false)}\n        ratio={selectedRatio}\n        onPrevious={handlePreviousRatio}\n        onNext={handleNextRatio}\n        hasPrevious={currentRatioIndex > 0}\n        hasNext={currentRatioIndex < allRatios.length - 1}\n        facePhoto={modalPhoto}\n        landmarks={modalLandmarks}\n        allRatios={allRatios}\n        profileType={modalProfileType}\n        gender={gender}\n        ethnicity={ethnicity}\n      />\n    </TabContent>\n  );\n}\n","numLines":711,"startLine":1,"totalLines":711}}}
{"parentUuid":"7c21d24c-378c-4eb4-b303-c47ca2497fc0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01V9pC5TotAJtNi2DrWEt7La","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me also check the `severity.ts` file mentioned in the bug report and the `harmony-scoring.ts` file to trace the data flow:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":56313,"cache_read_input_tokens":21954,"cache_creation":{"ephemeral_5m_input_tokens":56313,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUrSWg69ydn7CXP1BfuH","type":"assistant","uuid":"11105f14-423d-4256-92e2-e210efd767f2","timestamp":"2025-12-26T06:49:44.733Z"}
{"parentUuid":"11105f14-423d-4256-92e2-e210efd767f2","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01V9pC5TotAJtNi2DrWEt7La","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UNP5zAaZP7cdDPe4qfCyvz","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/severity.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":56313,"cache_read_input_tokens":21954,"cache_creation":{"ephemeral_5m_input_tokens":56313,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUrSWg69ydn7CXP1BfuH","type":"assistant","uuid":"a1cc5bcf-d11a-4b46-9871-44faad0fccb6","timestamp":"2025-12-26T06:49:45.703Z"}
{"parentUuid":"a1cc5bcf-d11a-4b46-9871-44faad0fccb6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01V9pC5TotAJtNi2DrWEt7La","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01L4XVo5xtn1H47XcvEoYnCQ","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/harmony-scoring.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":56313,"cache_read_input_tokens":21954,"cache_creation":{"ephemeral_5m_input_tokens":56313,"ephemeral_1h_input_tokens":0},"output_tokens":179,"service_tier":"standard"}},"requestId":"req_011CWUrSWg69ydn7CXP1BfuH","type":"assistant","uuid":"2d1f14af-d114-4ad8-88c0-fa7b05dd84fd","timestamp":"2025-12-26T06:49:46.596Z"}
{"parentUuid":"2d1f14af-d114-4ad8-88c0-fa7b05dd84fd","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UNP5zAaZP7cdDPe4qfCyvz","type":"tool_result","content":"     1→/**\n     2→ * Severity Classification System\n     3→ * Classifies metric deviations into severity levels with treatment recommendations\n     4→ */\n     5→\n     6→import { Severity, SeverityResult, SeverityThreshold, MetricIssueMapping, Gender } from './types';\n     7→\n     8→// ============================================\n     9→// SEVERITY THRESHOLDS BY METRIC\n    10→// ============================================\n    11→\n    12→export const SEVERITY_THRESHOLDS: SeverityThreshold[] = [\n    13→  // FRONT PROFILE METRICS\n    14→  {\n    15→    metric: 'fwhr',\n    16→    optimal: { min: 1.80, max: 2.00 },\n    17→    mild: { min: 1.65, max: 2.15 },\n    18→    moderate: { min: 1.55, max: 2.25 },\n    19→    severe: { min: 0, max: Infinity },\n    20→    unit: 'ratio',\n    21→    higherIsBetter: false, // mid-range is ideal\n    22→  },\n    23→  {\n    24→    metric: 'canthalTilt',\n    25→    optimal: { min: 4, max: 8 },\n    26→    mild: { min: 0, max: 10 },\n    27→    moderate: { min: -2, max: 12 },\n    28→    severe: { min: -Infinity, max: Infinity },\n    29→    unit: 'degrees',\n    30→    higherIsBetter: true,\n    31→  },\n    32→  {\n    33→    metric: 'facialThirdsUpper',\n    34→    optimal: { min: 30, max: 36 },\n    35→    mild: { min: 27, max: 39 },\n    36→    moderate: { min: 24, max: 42 },\n    37→    severe: { min: 0, max: Infinity },\n    38→    unit: 'percent',\n    39→  },\n    40→  {\n    41→    metric: 'facialThirdsMiddle',\n    42→    optimal: { min: 30, max: 36 },\n    43→    mild: { min: 27, max: 39 },\n    44→    moderate: { min: 24, max: 42 },\n    45→    severe: { min: 0, max: Infinity },\n    46→    unit: 'percent',\n    47→  },\n    48→  {\n    49→    metric: 'facialThirdsLower',\n    50→    optimal: { min: 30, max: 36 },\n    51→    mild: { min: 27, max: 39 },\n    52→    moderate: { min: 24, max: 42 },\n    53→    severe: { min: 0, max: Infinity },\n    54→    unit: 'percent',\n    55→  },\n    56→  {\n    57→    metric: 'nasalIndex',\n    58→    optimal: { min: 70, max: 85 },\n    59→    mild: { min: 65, max: 90 },\n    60→    moderate: { min: 60, max: 95 },\n    61→    severe: { min: 0, max: Infinity },\n    62→    unit: 'ratio',\n    63→  },\n    64→  {\n    65→    metric: 'interpupillaryDistance',\n    66→    optimal: { min: 44, max: 48 },\n    67→    mild: { min: 42, max: 50 },\n    68→    moderate: { min: 40, max: 52 },\n    69→    severe: { min: 0, max: Infinity },\n    70→    unit: 'percent',\n    71→  },\n    72→  {\n    73→    metric: 'mouthWidth',\n    74→    optimal: { min: 48, max: 54 },\n    75→    mild: { min: 44, max: 58 },\n    76→    moderate: { min: 40, max: 62 },\n    77→    severe: { min: 0, max: Infinity },\n    78→    unit: 'percent',\n    79→  },\n    80→  {\n    81→    metric: 'lipRatio',\n    82→    optimal: { min: 1.5, max: 2.0 },\n    83→    mild: { min: 1.2, max: 2.3 },\n    84→    moderate: { min: 1.0, max: 2.6 },\n    85→    severe: { min: 0, max: Infinity },\n    86→    unit: 'ratio',\n    87→  },\n    88→  {\n    89→    metric: 'jawWidthRatio',\n    90→    optimal: { min: 0.75, max: 0.80 },\n    91→    mild: { min: 0.72, max: 0.83 },\n    92→    moderate: { min: 0.68, max: 0.87 },\n    93→    severe: { min: 0, max: Infinity },\n    94→    unit: 'ratio',\n    95→  },\n    96→  {\n    97→    metric: 'facialSymmetry',\n    98→    optimal: { min: 95, max: 100 },\n    99→    mild: { min: 90, max: 100 },\n   100→    moderate: { min: 85, max: 100 },\n   101→    severe: { min: 0, max: 100 },\n   102→    unit: 'percent',\n   103→    higherIsBetter: true,\n   104→  },\n   105→  {\n   106→    metric: 'eyeSpacing',\n   107→    optimal: { min: 0.95, max: 1.05 },\n   108→    mild: { min: 0.90, max: 1.10 },\n   109→    moderate: { min: 0.85, max: 1.15 },\n   110→    severe: { min: 0, max: Infinity },\n   111→    unit: 'ratio',\n   112→  },\n   113→  {\n   114→    metric: 'noseWidth',\n   115→    optimal: { min: 0.95, max: 1.05 },\n   116→    mild: { min: 0.90, max: 1.10 },\n   117→    moderate: { min: 0.85, max: 1.15 },\n   118→    severe: { min: 0, max: Infinity },\n   119→    unit: 'ratio',\n   120→  },\n   121→  {\n   122→    metric: 'cheekboneWidth',\n   123→    optimal: { min: 0.85, max: 0.92 },\n   124→    mild: { min: 0.80, max: 0.97 },\n   125→    moderate: { min: 0.75, max: 1.02 },\n   126→    severe: { min: 0, max: Infinity },\n   127→    unit: 'ratio',\n   128→  },\n   129→\n   130→  // SIDE PROFILE METRICS\n   131→  {\n   132→    metric: 'gonialAngle',\n   133→    optimal: { min: 120, max: 130 },\n   134→    mild: { min: 115, max: 135 },\n   135→    moderate: { min: 110, max: 140 },\n   136→    severe: { min: 0, max: Infinity },\n   137→    unit: 'degrees',\n   138→  },\n   139→  {\n   140→    metric: 'nasolabialAngle',\n   141→    optimal: { min: 95, max: 110 }, // Gender-adjusted in functions\n   142→    mild: { min: 85, max: 115 },\n   143→    moderate: { min: 80, max: 120 },\n   144→    severe: { min: 0, max: Infinity },\n   145→    unit: 'degrees',\n   146→  },\n   147→  {\n   148→    metric: 'nasofrontalAngle',\n   149→    optimal: { min: 130, max: 140 },\n   150→    mild: { min: 125, max: 145 },\n   151→    moderate: { min: 120, max: 150 },\n   152→    severe: { min: 0, max: Infinity },\n   153→    unit: 'degrees',\n   154→  },\n   155→  {\n   156→    metric: 'chinProjection',\n   157→    optimal: { min: -4, max: 2 },\n   158→    mild: { min: -6, max: 4 },\n   159→    moderate: { min: -8, max: 6 },\n   160→    severe: { min: -Infinity, max: Infinity },\n   161→    unit: 'mm',\n   162→  },\n   163→  {\n   164→    metric: 'mentoLabialAngle',\n   165→    optimal: { min: 110, max: 130 },\n   166→    mild: { min: 100, max: 140 },\n   167→    moderate: { min: 90, max: 150 },\n   168→    severe: { min: 0, max: Infinity },\n   169→    unit: 'degrees',\n   170→  },\n   171→  {\n   172→    metric: 'facialConvexity',\n   173→    optimal: { min: 165, max: 175 },\n   174→    mild: { min: 160, max: 180 },\n   175→    moderate: { min: 155, max: 185 },\n   176→    severe: { min: 0, max: Infinity },\n   177→    unit: 'degrees',\n   178→  },\n   179→  {\n   180→    metric: 'eLineUpperLip',\n   181→    optimal: { min: -4, max: -1 },\n   182→    mild: { min: -6, max: 1 },\n   183→    moderate: { min: -8, max: 3 },\n   184→    severe: { min: -Infinity, max: Infinity },\n   185→    unit: 'mm',\n   186→  },\n   187→  {\n   188→    metric: 'eLineLowerLip',\n   189→    optimal: { min: -2, max: 1 },\n   190→    mild: { min: -4, max: 3 },\n   191→    moderate: { min: -6, max: 5 },\n   192→    severe: { min: -Infinity, max: Infinity },\n   193→    unit: 'mm',\n   194→  },\n   195→  {\n   196→    metric: 'submCervicalAngle',\n   197→    optimal: { min: 100, max: 120 },\n   198→    mild: { min: 90, max: 130 },\n   199→    moderate: { min: 80, max: 140 },\n   200→    severe: { min: 0, max: Infinity },\n   201→    unit: 'degrees',\n   202→  },\n   203→  {\n   204→    metric: 'totalFacialConvexity',\n   205→    optimal: { min: 135, max: 145 },\n   206→    mild: { min: 130, max: 150 },\n   207→    moderate: { min: 125, max: 155 },\n   208→    severe: { min: 0, max: Infinity },\n   209→    unit: 'degrees',\n   210→  },\n   211→];\n   212→\n   213→// ============================================\n   214→// METRIC TO ISSUE MAPPINGS\n   215→// ============================================\n   216→\n   217→export const METRIC_ISSUE_MAPPINGS: MetricIssueMapping[] = [\n   218→  // Front Profile\n   219→  {\n   220→    metric: 'fwhr',\n   221→    lowIssue: 'narrow_face',\n   222→    highIssue: 'wide_face',\n   223→    lowTreatments: ['cheek_filler', 'cheek_implants', 'jaw_implants'],\n   224→    highTreatments: ['botox_masseter', 'buccal_fat_removal', 'zygoma_reduction', 'mandible_reduction'],\n   225→  },\n   226→  {\n   227→    metric: 'canthalTilt',\n   228→    lowIssue: 'negative_canthal_tilt',\n   229→    highIssue: 'excessive_positive_tilt',\n   230→    lowTreatments: ['canthoplasty', 'pdo_threads', 'botox_brow_lift'],\n   231→    highTreatments: [], // Rarely treated\n   232→  },\n   233→  {\n   234→    metric: 'nasalIndex',\n   235→    lowIssue: 'narrow_nose',\n   236→    highIssue: 'wide_nose',\n   237→    lowTreatments: ['nose_filler'],\n   238→    highTreatments: ['rhinoplasty_reduction', 'nose_filler'],\n   239→  },\n   240→  {\n   241→    metric: 'lipRatio',\n   242→    lowIssue: 'thin_lower_lip',\n   243→    highIssue: 'thin_upper_lip',\n   244→    lowTreatments: ['lip_filler'],\n   245→    highTreatments: ['lip_filler', 'lip_lift'],\n   246→  },\n   247→  {\n   248→    metric: 'jawWidthRatio',\n   249→    lowIssue: 'narrow_jaw',\n   250→    highIssue: 'wide_jaw',\n   251→    lowTreatments: ['jaw_implants', 'jawline_filler'],\n   252→    highTreatments: ['botox_masseter', 'mandible_reduction'],\n   253→  },\n   254→  {\n   255→    metric: 'facialSymmetry',\n   256→    lowIssue: 'facial_asymmetry',\n   257→    highIssue: 'optimal',\n   258→    lowTreatments: ['filler_correction', 'botox_asymmetry', 'bimax'],\n   259→    highTreatments: [],\n   260→  },\n   261→  {\n   262→    metric: 'cheekboneWidth',\n   263→    lowIssue: 'flat_cheeks',\n   264→    highIssue: 'wide_cheekbones',\n   265→    lowTreatments: ['cheek_filler', 'cheek_implants'],\n   266→    highTreatments: ['zygoma_reduction'],\n   267→  },\n   268→\n   269→  // Side Profile\n   270→  {\n   271→    metric: 'gonialAngle',\n   272→    lowIssue: 'over_prominent_jaw',\n   273→    highIssue: 'weak_jaw',\n   274→    lowTreatments: ['mandible_reduction'],\n   275→    highTreatments: ['jaw_implants', 'jawline_filler', 'bsso'],\n   276→  },\n   277→  {\n   278→    metric: 'nasolabialAngle',\n   279→    lowIssue: 'droopy_nose_tip',\n   280→    highIssue: 'over_rotated_tip',\n   281→    lowTreatments: ['rhinoplasty_tip', 'nose_filler'],\n   282→    highTreatments: ['rhinoplasty_tip', 'rhinoplasty_reduction'],\n   283→  },\n   284→  {\n   285→    metric: 'chinProjection',\n   286→    lowIssue: 'recessed_chin',\n   287→    highIssue: 'prominent_chin',\n   288→    lowTreatments: ['genioplasty', 'chin_implant', 'chin_filler'],\n   289→    highTreatments: ['genioplasty'],\n   290→  },\n   291→  {\n   292→    metric: 'eLineUpperLip',\n   293→    lowIssue: 'lips_retrude',\n   294→    highIssue: 'lips_protrude',\n   295→    lowTreatments: ['lip_filler', 'bimax'],\n   296→    highTreatments: ['bimax', 'lip_reduction'],\n   297→  },\n   298→  {\n   299→    metric: 'eLineLowerLip',\n   300→    lowIssue: 'lips_retrude',\n   301→    highIssue: 'lips_protrude',\n   302→    lowTreatments: ['lip_filler', 'bimax'],\n   303→    highTreatments: ['bimax', 'lip_reduction'],\n   304→  },\n   305→  {\n   306→    metric: 'facialConvexity',\n   307→    lowIssue: 'concave_profile',\n   308→    highIssue: 'convex_profile',\n   309→    lowTreatments: ['bimax', 'chin_filler', 'lefort_1'],\n   310→    highTreatments: ['bimax', 'rhinoplasty_reduction'],\n   311→  },\n   312→  {\n   313→    metric: 'mentoLabialAngle',\n   314→    lowIssue: 'deep_mentolabial_fold',\n   315→    highIssue: 'flat_mentolabial_fold',\n   316→    lowTreatments: ['chin_filler', 'genioplasty'],\n   317→    highTreatments: [],\n   318→  },\n   319→  {\n   320→    metric: 'submCervicalAngle',\n   321→    lowIssue: 'undefined_neck_jaw',\n   322→    highIssue: 'excessive_neck_angle',\n   323→    lowTreatments: ['kybella', 'posture_correction', 'leanmaxxing'],\n   324→    highTreatments: [],\n   325→  },\n   326→];\n   327→\n   328→// ============================================\n   329→// SEVERITY CLASSIFICATION FUNCTIONS\n   330→// ============================================\n   331→\n   332→/**\n   333→ * Classify a score into a severity level\n   334→ */\n   335→export function classifyByScore(score: number): SeverityResult {\n   336→  if (score >= 85) {\n   337→    return {\n   338→      severity: 'optimal',\n   339→      label: 'Optimal',\n   340→      color: '#22c55e',\n   341→      icon: '✓',\n   342→      description: 'Excellent - within ideal range',\n   343→    };\n   344→  }\n   345→  if (score >= 70) {\n   346→    return {\n   347→      severity: 'mild',\n   348→      label: 'Good',\n   349→      color: '#84cc16',\n   350→      icon: '○',\n   351→      description: 'Good - minor deviation from ideal',\n   352→    };\n   353→  }\n   354→  if (score >= 50) {\n   355→    return {\n   356→      severity: 'moderate',\n   357→      label: 'Average',\n   358→      color: '#f59e0b',\n   359→      icon: '△',\n   360→      description: 'Average - noticeable deviation',\n   361→    };\n   362→  }\n   363→  return {\n   364→    severity: 'severe',\n   365→    label: 'Below Average',\n   366→    color: '#ef4444',\n   367→    icon: '✗',\n   368→    description: 'Below average - significant deviation',\n   369→  };\n   370→}\n   371→\n   372→/**\n   373→ * Get severity threshold for a specific metric\n   374→ */\n   375→export function getSeverityThreshold(metric: string): SeverityThreshold | undefined {\n   376→  return SEVERITY_THRESHOLDS.find(t => t.metric === metric);\n   377→}\n   378→\n   379→/**\n   380→ * Classify a metric value based on its specific thresholds\n   381→ */\n   382→export function classifyMetricValue(\n   383→  metric: string,\n   384→  value: number,\n   385→  gender?: Gender\n   386→): SeverityResult {\n   387→  const threshold = getSeverityThreshold(metric);\n   388→\n   389→  if (!threshold) {\n   390→    // Fallback to score-based classification if no threshold defined\n   391→    return classifyByScore(value);\n   392→  }\n   393→\n   394→  // Apply gender-specific adjustments\n   395→  const adjustedThreshold = { ...threshold };\n   396→  if (gender && metric === 'nasolabialAngle') {\n   397→    if (gender === 'male') {\n   398→      adjustedThreshold.optimal = { min: 90, max: 105 };\n   399→    } else {\n   400→      adjustedThreshold.optimal = { min: 100, max: 115 };\n   401→    }\n   402→  }\n   403→\n   404→  // Check which range the value falls into\n   405→  if (value >= adjustedThreshold.optimal.min && value <= adjustedThreshold.optimal.max) {\n   406→    return {\n   407→      severity: 'optimal',\n   408→      label: 'Optimal',\n   409→      color: '#22c55e',\n   410→      icon: '✓',\n   411→      description: `Within ideal range (${adjustedThreshold.optimal.min}-${adjustedThreshold.optimal.max}${adjustedThreshold.unit})`,\n   412→    };\n   413→  }\n   414→\n   415→  if (value >= adjustedThreshold.mild.min && value <= adjustedThreshold.mild.max) {\n   416→    return {\n   417→      severity: 'mild',\n   418→      label: 'Good',\n   419→      color: '#84cc16',\n   420→      icon: '○',\n   421→      description: 'Minor deviation from ideal',\n   422→    };\n   423→  }\n   424→\n   425→  if (value >= adjustedThreshold.moderate.min && value <= adjustedThreshold.moderate.max) {\n   426→    return {\n   427→      severity: 'moderate',\n   428→      label: 'Average',\n   429→      color: '#f59e0b',\n   430→      icon: '△',\n   431→      description: 'Noticeable deviation from ideal',\n   432→    };\n   433→  }\n   434→\n   435→  return {\n   436→    severity: 'severe',\n   437→    label: 'Below Average',\n   438→    color: '#ef4444',\n   439→    icon: '✗',\n   440→    description: 'Significant deviation from ideal',\n   441→  };\n   442→}\n   443→\n   444→/**\n   445→ * Calculate deviation from ideal for a metric\n   446→ */\n   447→export function calculateDeviation(\n   448→  metric: string,\n   449→  value: number\n   450→): { deviation: number; deviationPercent: number; direction: 'low' | 'high' | 'optimal' } {\n   451→  const threshold = getSeverityThreshold(metric);\n   452→\n   453→  if (!threshold) {\n   454→    return { deviation: 0, deviationPercent: 0, direction: 'optimal' };\n   455→  }\n   456→\n   457→  const idealMidpoint = (threshold.optimal.min + threshold.optimal.max) / 2;\n   458→  const deviation = value - idealMidpoint;\n   459→  const idealRange = threshold.optimal.max - threshold.optimal.min;\n   460→  const deviationPercent = (Math.abs(deviation) / idealRange) * 100;\n   461→\n   462→  let direction: 'low' | 'high' | 'optimal';\n   463→  if (value >= threshold.optimal.min && value <= threshold.optimal.max) {\n   464→    direction = 'optimal';\n   465→  } else if (value < threshold.optimal.min) {\n   466→    direction = 'low';\n   467→  } else {\n   468→    direction = 'high';\n   469→  }\n   470→\n   471→  return { deviation, deviationPercent, direction };\n   472→}\n   473→\n   474→/**\n   475→ * Get the issue name for a metric deviation\n   476→ */\n   477→export function getIssueForMetric(\n   478→  metric: string,\n   479→  direction: 'low' | 'high' | 'optimal'\n   480→): string | null {\n   481→  if (direction === 'optimal') return null;\n   482→\n   483→  const mapping = METRIC_ISSUE_MAPPINGS.find(m => m.metric === metric);\n   484→  if (!mapping) return null;\n   485→\n   486→  return direction === 'low' ? mapping.lowIssue : mapping.highIssue;\n   487→}\n   488→\n   489→/**\n   490→ * Get treatment IDs for a metric deviation\n   491→ */\n   492→export function getTreatmentIdsForMetric(\n   493→  metric: string,\n   494→  direction: 'low' | 'high' | 'optimal'\n   495→): string[] {\n   496→  if (direction === 'optimal') return [];\n   497→\n   498→  const mapping = METRIC_ISSUE_MAPPINGS.find(m => m.metric === metric);\n   499→  if (!mapping) return [];\n   500→\n   501→  return direction === 'low' ? mapping.lowTreatments : mapping.highTreatments;\n   502→}\n   503→\n   504→/**\n   505→ * Get overall severity from multiple metric analyses\n   506→ */\n   507→export function getOverallSeverity(severities: Severity[]): SeverityResult {\n   508→  const severeCount = severities.filter(s => s === 'severe').length;\n   509→  const moderateCount = severities.filter(s => s === 'moderate').length;\n   510→  const mildCount = severities.filter(s => s === 'mild').length;\n   511→\n   512→  // Weighted scoring\n   513→  const score = (\n   514→    (severities.filter(s => s === 'optimal').length * 100) +\n   515→    (mildCount * 75) +\n   516→    (moderateCount * 50) +\n   517→    (severeCount * 25)\n   518→  ) / severities.length;\n   519→\n   520→  return classifyByScore(score);\n   521→}\n   522→\n   523→/**\n   524→ * Prioritize metrics by severity and impact\n   525→ */\n   526→export function prioritizeMetrics(\n   527→  metricSeverities: Array<{ metric: string; severity: Severity; impact: number }>\n   528→): Array<{ metric: string; severity: Severity; priority: 'high' | 'medium' | 'low' }> {\n   529→  const severityWeight: Record<Severity, number> = {\n   530→    severe: 4,\n   531→    moderate: 3,\n   532→    mild: 2,\n   533→    optimal: 1,\n   534→  };\n   535→\n   536→  return metricSeverities\n   537→    .map(m => ({\n   538→      ...m,\n   539→      score: severityWeight[m.severity] * m.impact,\n   540→    }))\n   541→    .sort((a, b) => b.score - a.score)\n   542→    .map((m, index) => ({\n   543→      metric: m.metric,\n   544→      severity: m.severity,\n   545→      priority: index < 3 ? 'high' as const :\n   546→                index < 7 ? 'medium' as const :\n   547→                'low' as const,\n   548→    }));\n   549→}\n   550→\n   551→// ============================================\n   552→// PSL RATING CONVERSION\n   553→// ============================================\n   554→\n   555→/**\n   556→ * Convert harmony score to PSL rating using a non-linear transformation.\n   557→ *\n   558→ * PSL (Pretty Scale Level) is a different scale from harmony:\n   559→ * - Harmony: 0-100% based on weighted metric averages\n   560→ * - PSL: 3.0-7.5 scale with compressed distribution reflecting real-world attractiveness\n   561→ *\n   562→ * The transformation uses a power curve that:\n   563→ * 1. Makes high PSL scores harder to achieve (exponential difficulty at top)\n   564→ * 2. Creates better separation in the middle ranges\n   565→ * 3. Reflects that most people cluster in the 4.0-5.5 range\n   566→ */\n   567→export function harmonyToPSL(harmonyPercent: number): {\n   568→  psl: number;\n   569→  tier: string;\n   570→  percentile: number;\n   571→  description: string;\n   572→} {\n   573→  // Handle edge cases: NaN, Infinity, undefined, null\n   574→  // Treat invalid inputs as 0 (minimum harmony)\n   575→  let safeHarmonyPercent = harmonyPercent;\n   576→  if (\n   577→    typeof harmonyPercent !== 'number' ||\n   578→    !Number.isFinite(harmonyPercent) ||\n   579→    Number.isNaN(harmonyPercent)\n   580→  ) {\n   581→    safeHarmonyPercent = 0;\n   582→  }\n   583→\n   584→  // Clamp to valid range 0-100\n   585→  safeHarmonyPercent = Math.max(0, Math.min(100, safeHarmonyPercent));\n   586→\n   587→  // Non-linear transformation using a modified power curve\n   588→  // This creates a more realistic PSL distribution where:\n   589→  // - Low harmony maps to PSL 3.0-4.0 range (compressed)\n   590→  // - Mid harmony maps to PSL 4.0-5.5 range (expanded - most people here)\n   591→  // - High harmony maps to PSL 5.5-7.5 range (compressed - hard to achieve)\n   592→  //\n   593→  // Formula: PSL = 3.0 + 4.5 * ((harmony/100)^0.7)\n   594→  // The 0.7 exponent compresses high scores, making top PSL harder to achieve\n   595→  const normalizedHarmony = safeHarmonyPercent / 100;\n   596→  const transformedScore = Math.pow(normalizedHarmony, 0.7);\n   597→  const psl = 3.0 + transformedScore * 4.5;\n   598→  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n   599→\n   600→  // Determine tier\n   601→  let tier: string;\n   602→  let percentile: number;\n   603→  let description: string;\n   604→\n   605→  if (clampedPSL >= 7.5) {\n   606→    tier = 'Top Model';\n   607→    percentile = 99.99;\n   608→    description = 'Near perfection - world-class genetics';\n   609→  } else if (clampedPSL >= 7.0) {\n   610→    tier = 'Chad';\n   611→    percentile = 99.87;\n   612→    description = 'Exceptional - top 0.1%';\n   613→  } else if (clampedPSL >= 6.5) {\n   614→    tier = 'Chadlite';\n   615→    percentile = 99.0;\n   616→    description = 'Very attractive - top 1%';\n   617→  } else if (clampedPSL >= 6.0) {\n   618→    tier = 'High Tier Normie+';\n   619→    percentile = 97.25;\n   620→    description = 'Notably attractive - top 3%';\n   621→  } else if (clampedPSL >= 5.5) {\n   622→    tier = 'High Tier Normie';\n   623→    percentile = 90.0;\n   624→    description = 'Above average - top 10%';\n   625→  } else if (clampedPSL >= 5.0) {\n   626→    tier = 'Mid Tier Normie+';\n   627→    percentile = 84.15;\n   628→    description = 'Slightly above average';\n   629→  } else if (clampedPSL >= 4.5) {\n   630→    tier = 'Mid Tier Normie';\n   631→    percentile = 65.0;\n   632→    description = 'Average';\n   633→  } else if (clampedPSL >= 4.0) {\n   634→    tier = 'Low Tier Normie';\n   635→    percentile = 50.0;\n   636→    description = 'Median';\n   637→  } else if (clampedPSL >= 3.5) {\n   638→    tier = 'Below Average';\n   639→    percentile = 30.0;\n   640→    description = 'Below average';\n   641→  } else {\n   642→    tier = 'Subpar';\n   643→    percentile = 15.0;\n   644→    description = 'Noticeably below average';\n   645→  }\n   646→\n   647→  return {\n   648→    psl: Math.round(clampedPSL * 10) / 10,\n   649→    tier,\n   650→    percentile,\n   651→    description,\n   652→  };\n   653→}\n   654→\n   655→/**\n   656→ * Estimate potential PSL improvement from treatments\n   657→ */\n   658→export function estimatePotentialPSL(\n   659→  currentPSL: number,\n   660→  treatmentImprovements: number[]\n   661→): { potentialPSL: number; totalImprovement: number } {\n   662→  // Handle edge cases for currentPSL\n   663→  let safePSL = currentPSL;\n   664→  if (typeof currentPSL !== 'number' || !Number.isFinite(currentPSL) || Number.isNaN(currentPSL)) {\n   665→    safePSL = 3.0; // Default to minimum PSL\n   666→  }\n   667→  safePSL = Math.max(3.0, Math.min(7.5, safePSL));\n   668→\n   669→  // Handle edge cases for treatmentImprovements array\n   670→  if (!Array.isArray(treatmentImprovements) || treatmentImprovements.length === 0) {\n   671→    return {\n   672→      potentialPSL: Math.round(safePSL * 10) / 10,\n   673→      totalImprovement: 0,\n   674→    };\n   675→  }\n   676→\n   677→  // Filter out invalid improvement values\n   678→  const validImprovements = treatmentImprovements.filter(\n   679→    (imp) => typeof imp === 'number' && Number.isFinite(imp) && !Number.isNaN(imp) && imp > 0\n   680→  );\n   681→\n   682→  if (validImprovements.length === 0) {\n   683→    return {\n   684→      potentialPSL: Math.round(safePSL * 10) / 10,\n   685→      totalImprovement: 0,\n   686→    };\n   687→  }\n   688→\n   689→  // Sum improvements with diminishing returns\n   690→  const sortedImprovements = validImprovements.sort((a, b) => b - a);\n   691→\n   692→  let totalImprovement = 0;\n   693→  sortedImprovements.forEach((improvement, index) => {\n   694→    // Each subsequent improvement is reduced by 20%\n   695→    const diminishingFactor = Math.pow(0.8, index);\n   696→    totalImprovement += improvement * diminishingFactor;\n   697→  });\n   698→\n   699→  // Cap total improvement at realistic level\n   700→  const cappedImprovement = Math.min(totalImprovement, 2.5);\n   701→  const potentialPSL = Math.min(7.5, safePSL + cappedImprovement);\n   702→\n   703→  return {\n   704→    potentialPSL: Math.round(potentialPSL * 10) / 10,\n   705→    totalImprovement: Math.round(cappedImprovement * 10) / 10,\n   706→  };\n   707→}\n   708→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"66a7cbf3-afe0-4e9b-8a29-86f56b039a2a","timestamp":"2025-12-26T06:49:46.638Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/severity.ts","content":"/**\n * Severity Classification System\n * Classifies metric deviations into severity levels with treatment recommendations\n */\n\nimport { Severity, SeverityResult, SeverityThreshold, MetricIssueMapping, Gender } from './types';\n\n// ============================================\n// SEVERITY THRESHOLDS BY METRIC\n// ============================================\n\nexport const SEVERITY_THRESHOLDS: SeverityThreshold[] = [\n  // FRONT PROFILE METRICS\n  {\n    metric: 'fwhr',\n    optimal: { min: 1.80, max: 2.00 },\n    mild: { min: 1.65, max: 2.15 },\n    moderate: { min: 1.55, max: 2.25 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n    higherIsBetter: false, // mid-range is ideal\n  },\n  {\n    metric: 'canthalTilt',\n    optimal: { min: 4, max: 8 },\n    mild: { min: 0, max: 10 },\n    moderate: { min: -2, max: 12 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'degrees',\n    higherIsBetter: true,\n  },\n  {\n    metric: 'facialThirdsUpper',\n    optimal: { min: 30, max: 36 },\n    mild: { min: 27, max: 39 },\n    moderate: { min: 24, max: 42 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'facialThirdsMiddle',\n    optimal: { min: 30, max: 36 },\n    mild: { min: 27, max: 39 },\n    moderate: { min: 24, max: 42 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'facialThirdsLower',\n    optimal: { min: 30, max: 36 },\n    mild: { min: 27, max: 39 },\n    moderate: { min: 24, max: 42 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'nasalIndex',\n    optimal: { min: 70, max: 85 },\n    mild: { min: 65, max: 90 },\n    moderate: { min: 60, max: 95 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'interpupillaryDistance',\n    optimal: { min: 44, max: 48 },\n    mild: { min: 42, max: 50 },\n    moderate: { min: 40, max: 52 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'mouthWidth',\n    optimal: { min: 48, max: 54 },\n    mild: { min: 44, max: 58 },\n    moderate: { min: 40, max: 62 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'lipRatio',\n    optimal: { min: 1.5, max: 2.0 },\n    mild: { min: 1.2, max: 2.3 },\n    moderate: { min: 1.0, max: 2.6 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'jawWidthRatio',\n    optimal: { min: 0.75, max: 0.80 },\n    mild: { min: 0.72, max: 0.83 },\n    moderate: { min: 0.68, max: 0.87 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'facialSymmetry',\n    optimal: { min: 95, max: 100 },\n    mild: { min: 90, max: 100 },\n    moderate: { min: 85, max: 100 },\n    severe: { min: 0, max: 100 },\n    unit: 'percent',\n    higherIsBetter: true,\n  },\n  {\n    metric: 'eyeSpacing',\n    optimal: { min: 0.95, max: 1.05 },\n    mild: { min: 0.90, max: 1.10 },\n    moderate: { min: 0.85, max: 1.15 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'noseWidth',\n    optimal: { min: 0.95, max: 1.05 },\n    mild: { min: 0.90, max: 1.10 },\n    moderate: { min: 0.85, max: 1.15 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'cheekboneWidth',\n    optimal: { min: 0.85, max: 0.92 },\n    mild: { min: 0.80, max: 0.97 },\n    moderate: { min: 0.75, max: 1.02 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n\n  // SIDE PROFILE METRICS\n  {\n    metric: 'gonialAngle',\n    optimal: { min: 120, max: 130 },\n    mild: { min: 115, max: 135 },\n    moderate: { min: 110, max: 140 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'nasolabialAngle',\n    optimal: { min: 95, max: 110 }, // Gender-adjusted in functions\n    mild: { min: 85, max: 115 },\n    moderate: { min: 80, max: 120 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'nasofrontalAngle',\n    optimal: { min: 130, max: 140 },\n    mild: { min: 125, max: 145 },\n    moderate: { min: 120, max: 150 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'chinProjection',\n    optimal: { min: -4, max: 2 },\n    mild: { min: -6, max: 4 },\n    moderate: { min: -8, max: 6 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'mm',\n  },\n  {\n    metric: 'mentoLabialAngle',\n    optimal: { min: 110, max: 130 },\n    mild: { min: 100, max: 140 },\n    moderate: { min: 90, max: 150 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'facialConvexity',\n    optimal: { min: 165, max: 175 },\n    mild: { min: 160, max: 180 },\n    moderate: { min: 155, max: 185 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'eLineUpperLip',\n    optimal: { min: -4, max: -1 },\n    mild: { min: -6, max: 1 },\n    moderate: { min: -8, max: 3 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'mm',\n  },\n  {\n    metric: 'eLineLowerLip',\n    optimal: { min: -2, max: 1 },\n    mild: { min: -4, max: 3 },\n    moderate: { min: -6, max: 5 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'mm',\n  },\n  {\n    metric: 'submCervicalAngle',\n    optimal: { min: 100, max: 120 },\n    mild: { min: 90, max: 130 },\n    moderate: { min: 80, max: 140 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'totalFacialConvexity',\n    optimal: { min: 135, max: 145 },\n    mild: { min: 130, max: 150 },\n    moderate: { min: 125, max: 155 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n];\n\n// ============================================\n// METRIC TO ISSUE MAPPINGS\n// ============================================\n\nexport const METRIC_ISSUE_MAPPINGS: MetricIssueMapping[] = [\n  // Front Profile\n  {\n    metric: 'fwhr',\n    lowIssue: 'narrow_face',\n    highIssue: 'wide_face',\n    lowTreatments: ['cheek_filler', 'cheek_implants', 'jaw_implants'],\n    highTreatments: ['botox_masseter', 'buccal_fat_removal', 'zygoma_reduction', 'mandible_reduction'],\n  },\n  {\n    metric: 'canthalTilt',\n    lowIssue: 'negative_canthal_tilt',\n    highIssue: 'excessive_positive_tilt',\n    lowTreatments: ['canthoplasty', 'pdo_threads', 'botox_brow_lift'],\n    highTreatments: [], // Rarely treated\n  },\n  {\n    metric: 'nasalIndex',\n    lowIssue: 'narrow_nose',\n    highIssue: 'wide_nose',\n    lowTreatments: ['nose_filler'],\n    highTreatments: ['rhinoplasty_reduction', 'nose_filler'],\n  },\n  {\n    metric: 'lipRatio',\n    lowIssue: 'thin_lower_lip',\n    highIssue: 'thin_upper_lip',\n    lowTreatments: ['lip_filler'],\n    highTreatments: ['lip_filler', 'lip_lift'],\n  },\n  {\n    metric: 'jawWidthRatio',\n    lowIssue: 'narrow_jaw',\n    highIssue: 'wide_jaw',\n    lowTreatments: ['jaw_implants', 'jawline_filler'],\n    highTreatments: ['botox_masseter', 'mandible_reduction'],\n  },\n  {\n    metric: 'facialSymmetry',\n    lowIssue: 'facial_asymmetry',\n    highIssue: 'optimal',\n    lowTreatments: ['filler_correction', 'botox_asymmetry', 'bimax'],\n    highTreatments: [],\n  },\n  {\n    metric: 'cheekboneWidth',\n    lowIssue: 'flat_cheeks',\n    highIssue: 'wide_cheekbones',\n    lowTreatments: ['cheek_filler', 'cheek_implants'],\n    highTreatments: ['zygoma_reduction'],\n  },\n\n  // Side Profile\n  {\n    metric: 'gonialAngle',\n    lowIssue: 'over_prominent_jaw',\n    highIssue: 'weak_jaw',\n    lowTreatments: ['mandible_reduction'],\n    highTreatments: ['jaw_implants', 'jawline_filler', 'bsso'],\n  },\n  {\n    metric: 'nasolabialAngle',\n    lowIssue: 'droopy_nose_tip',\n    highIssue: 'over_rotated_tip',\n    lowTreatments: ['rhinoplasty_tip', 'nose_filler'],\n    highTreatments: ['rhinoplasty_tip', 'rhinoplasty_reduction'],\n  },\n  {\n    metric: 'chinProjection',\n    lowIssue: 'recessed_chin',\n    highIssue: 'prominent_chin',\n    lowTreatments: ['genioplasty', 'chin_implant', 'chin_filler'],\n    highTreatments: ['genioplasty'],\n  },\n  {\n    metric: 'eLineUpperLip',\n    lowIssue: 'lips_retrude',\n    highIssue: 'lips_protrude',\n    lowTreatments: ['lip_filler', 'bimax'],\n    highTreatments: ['bimax', 'lip_reduction'],\n  },\n  {\n    metric: 'eLineLowerLip',\n    lowIssue: 'lips_retrude',\n    highIssue: 'lips_protrude',\n    lowTreatments: ['lip_filler', 'bimax'],\n    highTreatments: ['bimax', 'lip_reduction'],\n  },\n  {\n    metric: 'facialConvexity',\n    lowIssue: 'concave_profile',\n    highIssue: 'convex_profile',\n    lowTreatments: ['bimax', 'chin_filler', 'lefort_1'],\n    highTreatments: ['bimax', 'rhinoplasty_reduction'],\n  },\n  {\n    metric: 'mentoLabialAngle',\n    lowIssue: 'deep_mentolabial_fold',\n    highIssue: 'flat_mentolabial_fold',\n    lowTreatments: ['chin_filler', 'genioplasty'],\n    highTreatments: [],\n  },\n  {\n    metric: 'submCervicalAngle',\n    lowIssue: 'undefined_neck_jaw',\n    highIssue: 'excessive_neck_angle',\n    lowTreatments: ['kybella', 'posture_correction', 'leanmaxxing'],\n    highTreatments: [],\n  },\n];\n\n// ============================================\n// SEVERITY CLASSIFICATION FUNCTIONS\n// ============================================\n\n/**\n * Classify a score into a severity level\n */\nexport function classifyByScore(score: number): SeverityResult {\n  if (score >= 85) {\n    return {\n      severity: 'optimal',\n      label: 'Optimal',\n      color: '#22c55e',\n      icon: '✓',\n      description: 'Excellent - within ideal range',\n    };\n  }\n  if (score >= 70) {\n    return {\n      severity: 'mild',\n      label: 'Good',\n      color: '#84cc16',\n      icon: '○',\n      description: 'Good - minor deviation from ideal',\n    };\n  }\n  if (score >= 50) {\n    return {\n      severity: 'moderate',\n      label: 'Average',\n      color: '#f59e0b',\n      icon: '△',\n      description: 'Average - noticeable deviation',\n    };\n  }\n  return {\n    severity: 'severe',\n    label: 'Below Average',\n    color: '#ef4444',\n    icon: '✗',\n    description: 'Below average - significant deviation',\n  };\n}\n\n/**\n * Get severity threshold for a specific metric\n */\nexport function getSeverityThreshold(metric: string): SeverityThreshold | undefined {\n  return SEVERITY_THRESHOLDS.find(t => t.metric === metric);\n}\n\n/**\n * Classify a metric value based on its specific thresholds\n */\nexport function classifyMetricValue(\n  metric: string,\n  value: number,\n  gender?: Gender\n): SeverityResult {\n  const threshold = getSeverityThreshold(metric);\n\n  if (!threshold) {\n    // Fallback to score-based classification if no threshold defined\n    return classifyByScore(value);\n  }\n\n  // Apply gender-specific adjustments\n  const adjustedThreshold = { ...threshold };\n  if (gender && metric === 'nasolabialAngle') {\n    if (gender === 'male') {\n      adjustedThreshold.optimal = { min: 90, max: 105 };\n    } else {\n      adjustedThreshold.optimal = { min: 100, max: 115 };\n    }\n  }\n\n  // Check which range the value falls into\n  if (value >= adjustedThreshold.optimal.min && value <= adjustedThreshold.optimal.max) {\n    return {\n      severity: 'optimal',\n      label: 'Optimal',\n      color: '#22c55e',\n      icon: '✓',\n      description: `Within ideal range (${adjustedThreshold.optimal.min}-${adjustedThreshold.optimal.max}${adjustedThreshold.unit})`,\n    };\n  }\n\n  if (value >= adjustedThreshold.mild.min && value <= adjustedThreshold.mild.max) {\n    return {\n      severity: 'mild',\n      label: 'Good',\n      color: '#84cc16',\n      icon: '○',\n      description: 'Minor deviation from ideal',\n    };\n  }\n\n  if (value >= adjustedThreshold.moderate.min && value <= adjustedThreshold.moderate.max) {\n    return {\n      severity: 'moderate',\n      label: 'Average',\n      color: '#f59e0b',\n      icon: '△',\n      description: 'Noticeable deviation from ideal',\n    };\n  }\n\n  return {\n    severity: 'severe',\n    label: 'Below Average',\n    color: '#ef4444',\n    icon: '✗',\n    description: 'Significant deviation from ideal',\n  };\n}\n\n/**\n * Calculate deviation from ideal for a metric\n */\nexport function calculateDeviation(\n  metric: string,\n  value: number\n): { deviation: number; deviationPercent: number; direction: 'low' | 'high' | 'optimal' } {\n  const threshold = getSeverityThreshold(metric);\n\n  if (!threshold) {\n    return { deviation: 0, deviationPercent: 0, direction: 'optimal' };\n  }\n\n  const idealMidpoint = (threshold.optimal.min + threshold.optimal.max) / 2;\n  const deviation = value - idealMidpoint;\n  const idealRange = threshold.optimal.max - threshold.optimal.min;\n  const deviationPercent = (Math.abs(deviation) / idealRange) * 100;\n\n  let direction: 'low' | 'high' | 'optimal';\n  if (value >= threshold.optimal.min && value <= threshold.optimal.max) {\n    direction = 'optimal';\n  } else if (value < threshold.optimal.min) {\n    direction = 'low';\n  } else {\n    direction = 'high';\n  }\n\n  return { deviation, deviationPercent, direction };\n}\n\n/**\n * Get the issue name for a metric deviation\n */\nexport function getIssueForMetric(\n  metric: string,\n  direction: 'low' | 'high' | 'optimal'\n): string | null {\n  if (direction === 'optimal') return null;\n\n  const mapping = METRIC_ISSUE_MAPPINGS.find(m => m.metric === metric);\n  if (!mapping) return null;\n\n  return direction === 'low' ? mapping.lowIssue : mapping.highIssue;\n}\n\n/**\n * Get treatment IDs for a metric deviation\n */\nexport function getTreatmentIdsForMetric(\n  metric: string,\n  direction: 'low' | 'high' | 'optimal'\n): string[] {\n  if (direction === 'optimal') return [];\n\n  const mapping = METRIC_ISSUE_MAPPINGS.find(m => m.metric === metric);\n  if (!mapping) return [];\n\n  return direction === 'low' ? mapping.lowTreatments : mapping.highTreatments;\n}\n\n/**\n * Get overall severity from multiple metric analyses\n */\nexport function getOverallSeverity(severities: Severity[]): SeverityResult {\n  const severeCount = severities.filter(s => s === 'severe').length;\n  const moderateCount = severities.filter(s => s === 'moderate').length;\n  const mildCount = severities.filter(s => s === 'mild').length;\n\n  // Weighted scoring\n  const score = (\n    (severities.filter(s => s === 'optimal').length * 100) +\n    (mildCount * 75) +\n    (moderateCount * 50) +\n    (severeCount * 25)\n  ) / severities.length;\n\n  return classifyByScore(score);\n}\n\n/**\n * Prioritize metrics by severity and impact\n */\nexport function prioritizeMetrics(\n  metricSeverities: Array<{ metric: string; severity: Severity; impact: number }>\n): Array<{ metric: string; severity: Severity; priority: 'high' | 'medium' | 'low' }> {\n  const severityWeight: Record<Severity, number> = {\n    severe: 4,\n    moderate: 3,\n    mild: 2,\n    optimal: 1,\n  };\n\n  return metricSeverities\n    .map(m => ({\n      ...m,\n      score: severityWeight[m.severity] * m.impact,\n    }))\n    .sort((a, b) => b.score - a.score)\n    .map((m, index) => ({\n      metric: m.metric,\n      severity: m.severity,\n      priority: index < 3 ? 'high' as const :\n                index < 7 ? 'medium' as const :\n                'low' as const,\n    }));\n}\n\n// ============================================\n// PSL RATING CONVERSION\n// ============================================\n\n/**\n * Convert harmony score to PSL rating using a non-linear transformation.\n *\n * PSL (Pretty Scale Level) is a different scale from harmony:\n * - Harmony: 0-100% based on weighted metric averages\n * - PSL: 3.0-7.5 scale with compressed distribution reflecting real-world attractiveness\n *\n * The transformation uses a power curve that:\n * 1. Makes high PSL scores harder to achieve (exponential difficulty at top)\n * 2. Creates better separation in the middle ranges\n * 3. Reflects that most people cluster in the 4.0-5.5 range\n */\nexport function harmonyToPSL(harmonyPercent: number): {\n  psl: number;\n  tier: string;\n  percentile: number;\n  description: string;\n} {\n  // Handle edge cases: NaN, Infinity, undefined, null\n  // Treat invalid inputs as 0 (minimum harmony)\n  let safeHarmonyPercent = harmonyPercent;\n  if (\n    typeof harmonyPercent !== 'number' ||\n    !Number.isFinite(harmonyPercent) ||\n    Number.isNaN(harmonyPercent)\n  ) {\n    safeHarmonyPercent = 0;\n  }\n\n  // Clamp to valid range 0-100\n  safeHarmonyPercent = Math.max(0, Math.min(100, safeHarmonyPercent));\n\n  // Non-linear transformation using a modified power curve\n  // This creates a more realistic PSL distribution where:\n  // - Low harmony maps to PSL 3.0-4.0 range (compressed)\n  // - Mid harmony maps to PSL 4.0-5.5 range (expanded - most people here)\n  // - High harmony maps to PSL 5.5-7.5 range (compressed - hard to achieve)\n  //\n  // Formula: PSL = 3.0 + 4.5 * ((harmony/100)^0.7)\n  // The 0.7 exponent compresses high scores, making top PSL harder to achieve\n  const normalizedHarmony = safeHarmonyPercent / 100;\n  const transformedScore = Math.pow(normalizedHarmony, 0.7);\n  const psl = 3.0 + transformedScore * 4.5;\n  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n\n  // Determine tier\n  let tier: string;\n  let percentile: number;\n  let description: string;\n\n  if (clampedPSL >= 7.5) {\n    tier = 'Top Model';\n    percentile = 99.99;\n    description = 'Near perfection - world-class genetics';\n  } else if (clampedPSL >= 7.0) {\n    tier = 'Chad';\n    percentile = 99.87;\n    description = 'Exceptional - top 0.1%';\n  } else if (clampedPSL >= 6.5) {\n    tier = 'Chadlite';\n    percentile = 99.0;\n    description = 'Very attractive - top 1%';\n  } else if (clampedPSL >= 6.0) {\n    tier = 'High Tier Normie+';\n    percentile = 97.25;\n    description = 'Notably attractive - top 3%';\n  } else if (clampedPSL >= 5.5) {\n    tier = 'High Tier Normie';\n    percentile = 90.0;\n    description = 'Above average - top 10%';\n  } else if (clampedPSL >= 5.0) {\n    tier = 'Mid Tier Normie+';\n    percentile = 84.15;\n    description = 'Slightly above average';\n  } else if (clampedPSL >= 4.5) {\n    tier = 'Mid Tier Normie';\n    percentile = 65.0;\n    description = 'Average';\n  } else if (clampedPSL >= 4.0) {\n    tier = 'Low Tier Normie';\n    percentile = 50.0;\n    description = 'Median';\n  } else if (clampedPSL >= 3.5) {\n    tier = 'Below Average';\n    percentile = 30.0;\n    description = 'Below average';\n  } else {\n    tier = 'Subpar';\n    percentile = 15.0;\n    description = 'Noticeably below average';\n  }\n\n  return {\n    psl: Math.round(clampedPSL * 10) / 10,\n    tier,\n    percentile,\n    description,\n  };\n}\n\n/**\n * Estimate potential PSL improvement from treatments\n */\nexport function estimatePotentialPSL(\n  currentPSL: number,\n  treatmentImprovements: number[]\n): { potentialPSL: number; totalImprovement: number } {\n  // Handle edge cases for currentPSL\n  let safePSL = currentPSL;\n  if (typeof currentPSL !== 'number' || !Number.isFinite(currentPSL) || Number.isNaN(currentPSL)) {\n    safePSL = 3.0; // Default to minimum PSL\n  }\n  safePSL = Math.max(3.0, Math.min(7.5, safePSL));\n\n  // Handle edge cases for treatmentImprovements array\n  if (!Array.isArray(treatmentImprovements) || treatmentImprovements.length === 0) {\n    return {\n      potentialPSL: Math.round(safePSL * 10) / 10,\n      totalImprovement: 0,\n    };\n  }\n\n  // Filter out invalid improvement values\n  const validImprovements = treatmentImprovements.filter(\n    (imp) => typeof imp === 'number' && Number.isFinite(imp) && !Number.isNaN(imp) && imp > 0\n  );\n\n  if (validImprovements.length === 0) {\n    return {\n      potentialPSL: Math.round(safePSL * 10) / 10,\n      totalImprovement: 0,\n    };\n  }\n\n  // Sum improvements with diminishing returns\n  const sortedImprovements = validImprovements.sort((a, b) => b - a);\n\n  let totalImprovement = 0;\n  sortedImprovements.forEach((improvement, index) => {\n    // Each subsequent improvement is reduced by 20%\n    const diminishingFactor = Math.pow(0.8, index);\n    totalImprovement += improvement * diminishingFactor;\n  });\n\n  // Cap total improvement at realistic level\n  const cappedImprovement = Math.min(totalImprovement, 2.5);\n  const potentialPSL = Math.min(7.5, safePSL + cappedImprovement);\n\n  return {\n    potentialPSL: Math.round(potentialPSL * 10) / 10,\n    totalImprovement: Math.round(cappedImprovement * 10) / 10,\n  };\n}\n","numLines":708,"startLine":1,"totalLines":708}}}
{"parentUuid":"66a7cbf3-afe0-4e9b-8a29-86f56b039a2a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01L4XVo5xtn1H47XcvEoYnCQ","type":"tool_result","content":"     1→/**\n     2→ * Harmony Facial Analysis Scoring System - Barrel Export\n     3→ *\n     4→ * This file re-exports all scoring functionality from modular files.\n     5→ * The actual implementations are split across:\n     6→ * - ./scoring/types.ts - Type definitions\n     7→ * - ./scoring/calculator.ts - Core scoring algorithms\n     8→ * - ./scoring/analyzer.ts - Profile analysis functions\n     9→ * - ./data/metric-configs.ts - Metric configurations\n    10→ * - ./data/demographic-overrides.ts - Ethnicity/gender overrides\n    11→ */\n    12→\n    13→// ============================================\n    14→// TYPE EXPORTS\n    15→// ============================================\n    16→export type {\n    17→  Point,\n    18→  QualityTier,\n    19→  SeverityLevel,\n    20→  MeasurementUnit,\n    21→  MetricPolarity,\n    22→  MetricConfig,\n    23→  BezierCurveConfig,\n    24→  CurvePoint,\n    25→  MetricScoreResult,\n    26→  HarmonyAnalysis,\n    27→  FlawAssessment,\n    28→  StrengthAssessment,\n    29→  Ethnicity,\n    30→  Gender,\n    31→  DemographicKey,\n    32→  DemographicOverride,\n    33→  DemographicOptions,\n    34→  FlawMapping,\n    35→  FrontProfileResults,\n    36→  SideProfileResults,\n    37→  PSLRating,\n    38→  LandmarkPoint,\n    39→} from './scoring/types';\n    40→\n    41→// ============================================\n    42→// CALCULATOR EXPORTS\n    43→// ============================================\n    44→export {\n    45→  calculateMetricScore,\n    46→  isValueAcceptable,\n    47→  interpolateCustomCurve,\n    48→  cubicBezier,\n    49→  cubicBezierDerivative,\n    50→  catmullRomSpline,\n    51→  standardizeScore,\n    52→  getQualityTier,\n    53→  getSeverityLevel,\n    54→  getDeviationDescription,\n    55→  getUnitLabel,\n    56→  distance,\n    57→  calculateAngle,\n    58→  perpendicularDistance,\n    59→  calculateHarmonyPercentile,\n    60→  normalCDF,\n    61→  convertToPSL,\n    62→  METRIC_FLAW_MAPPINGS,\n    63→  METRIC_CUSTOM_CURVES,\n    64→} from './scoring/calculator';\n    65→\n    66→// ============================================\n    67→// ANALYZER EXPORTS\n    68→// ============================================\n    69→export {\n    70→  getLandmark,\n    71→  scoreMeasurement,\n    72→  analyzeFrontProfile,\n    73→  analyzeSideProfile,\n    74→  analyzeHarmony,\n    75→} from './scoring/analyzer';\n    76→\n    77→// ============================================\n    78→// DATA EXPORTS\n    79→// ============================================\n    80→export { METRIC_CONFIGS, MEASUREMENT_CATEGORIES } from './data/metric-configs';\n    81→export { DEMOGRAPHIC_OVERRIDES, getMetricConfigForDemographics } from './data/demographic-overrides';\n    82→\n    83→// Re-export bezier curves for convenience\n    84→export { BEZIER_CURVES } from './bezier-curves';\n    85→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"122cd094-c20f-4b2c-870c-c12d53e30907","timestamp":"2025-12-26T06:49:46.638Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/harmony-scoring.ts","content":"/**\n * Harmony Facial Analysis Scoring System - Barrel Export\n *\n * This file re-exports all scoring functionality from modular files.\n * The actual implementations are split across:\n * - ./scoring/types.ts - Type definitions\n * - ./scoring/calculator.ts - Core scoring algorithms\n * - ./scoring/analyzer.ts - Profile analysis functions\n * - ./data/metric-configs.ts - Metric configurations\n * - ./data/demographic-overrides.ts - Ethnicity/gender overrides\n */\n\n// ============================================\n// TYPE EXPORTS\n// ============================================\nexport type {\n  Point,\n  QualityTier,\n  SeverityLevel,\n  MeasurementUnit,\n  MetricPolarity,\n  MetricConfig,\n  BezierCurveConfig,\n  CurvePoint,\n  MetricScoreResult,\n  HarmonyAnalysis,\n  FlawAssessment,\n  StrengthAssessment,\n  Ethnicity,\n  Gender,\n  DemographicKey,\n  DemographicOverride,\n  DemographicOptions,\n  FlawMapping,\n  FrontProfileResults,\n  SideProfileResults,\n  PSLRating,\n  LandmarkPoint,\n} from './scoring/types';\n\n// ============================================\n// CALCULATOR EXPORTS\n// ============================================\nexport {\n  calculateMetricScore,\n  isValueAcceptable,\n  interpolateCustomCurve,\n  cubicBezier,\n  cubicBezierDerivative,\n  catmullRomSpline,\n  standardizeScore,\n  getQualityTier,\n  getSeverityLevel,\n  getDeviationDescription,\n  getUnitLabel,\n  distance,\n  calculateAngle,\n  perpendicularDistance,\n  calculateHarmonyPercentile,\n  normalCDF,\n  convertToPSL,\n  METRIC_FLAW_MAPPINGS,\n  METRIC_CUSTOM_CURVES,\n} from './scoring/calculator';\n\n// ============================================\n// ANALYZER EXPORTS\n// ============================================\nexport {\n  getLandmark,\n  scoreMeasurement,\n  analyzeFrontProfile,\n  analyzeSideProfile,\n  analyzeHarmony,\n} from './scoring/analyzer';\n\n// ============================================\n// DATA EXPORTS\n// ============================================\nexport { METRIC_CONFIGS, MEASUREMENT_CATEGORIES } from './data/metric-configs';\nexport { DEMOGRAPHIC_OVERRIDES, getMetricConfigForDemographics } from './data/demographic-overrides';\n\n// Re-export bezier curves for convenience\nexport { BEZIER_CURVES } from './bezier-curves';\n","numLines":85,"startLine":1,"totalLines":85}}}
{"parentUuid":"122cd094-c20f-4b2c-870c-c12d53e30907","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_019kv3UyW2b7Fkqt37wuFNrq","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the `analyzer.ts` file where the scores are first produced, and also search for any other places where scores could exceed 10:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":11102,"cache_read_input_tokens":78267,"cache_creation":{"ephemeral_5m_input_tokens":11102,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrT3xXQ52uwVffVMkk4","type":"assistant","uuid":"c8e70e3f-1200-4206-b45d-53a119b059ec","timestamp":"2025-12-26T06:49:50.752Z"}
{"parentUuid":"c8e70e3f-1200-4206-b45d-53a119b059ec","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_019kv3UyW2b7Fkqt37wuFNrq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JCxFrWZAU4buiHgL4P4YW9","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/analyzer.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":11102,"cache_read_input_tokens":78267,"cache_creation":{"ephemeral_5m_input_tokens":11102,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrT3xXQ52uwVffVMkk4","type":"assistant","uuid":"921cb566-14cd-4100-8e46-6e02a8f00b8a","timestamp":"2025-12-26T06:49:51.930Z"}
{"parentUuid":"921cb566-14cd-4100-8e46-6e02a8f00b8a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_019kv3UyW2b7Fkqt37wuFNrq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ANMEDhZZae3Y4eWNwXXre9","name":"Grep","input":{"pattern":"\\.score\\s*[>]=?\\s*10|standardizedScore\\s*[>]=?\\s*10","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":11102,"cache_read_input_tokens":78267,"cache_creation":{"ephemeral_5m_input_tokens":11102,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrT3xXQ52uwVffVMkk4","type":"assistant","uuid":"1baeb485-a2c4-4d87-99c1-b1ae13210b67","timestamp":"2025-12-26T06:49:54.399Z"}
{"parentUuid":"1baeb485-a2c4-4d87-99c1-b1ae13210b67","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ANMEDhZZae3Y4eWNwXXre9","type":"tool_result","content":"No matches found"}]},"uuid":"8c4ffc90-c165-468c-8f58-cafbc419c26a","timestamp":"2025-12-26T06:49:54.832Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0}}
{"parentUuid":"8c4ffc90-c165-468c-8f58-cafbc419c26a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JCxFrWZAU4buiHgL4P4YW9","type":"tool_result","content":"     1→/**\n     2→ * Facial Profile Analyzer\n     3→ * High-level analysis functions for front and side profile measurements\n     4→ *\n     5→ * Features:\n     6→ * - 32+ front profile measurements\n     7→ * - 30+ side profile measurements\n     8→ * - Ethnicity-specific ideal ranges\n     9→ * - Combined harmony analysis\n    10→ */\n    11→\n    12→import {\n    13→  Point,\n    14→  MetricScoreResult,\n    15→  HarmonyAnalysis,\n    16→  FlawAssessment,\n    17→  StrengthAssessment,\n    18→  DemographicOptions,\n    19→  FrontProfileResults,\n    20→  SideProfileResults,\n    21→  Gender,\n    22→  Ethnicity,\n    23→} from './types';\n    24→\n    25→import {\n    26→  calculateMetricScore,\n    27→  getQualityTier,\n    28→  getSeverityLevel,\n    29→  distance,\n    30→  calculateAngle,\n    31→  perpendicularDistance,\n    32→  standardizeScore,\n    33→  calculateHarmonyPercentile,\n    34→  getDeviationDescription,\n    35→} from './calculator';\n    36→\n    37→import { METRIC_CONFIGS } from '@/lib/data/metric-configs';\n    38→import { getMetricConfigForDemographics } from '@/lib/data/demographic-overrides';\n    39→import { LandmarkPoint } from '@/lib/landmarks';\n    40→\n    41→// ============================================\n    42→// HELPER FUNCTIONS\n    43→// ============================================\n    44→\n    45→/**\n    46→ * Helper to get landmark by ID\n    47→ */\n    48→export function getLandmark(landmarks: LandmarkPoint[], id: string): Point | null {\n    49→  const lm = landmarks.find((l) => l.id === id);\n    50→  return lm ? { x: lm.x, y: lm.y } : null;\n    51→}\n    52→\n    53→// ============================================\n    54→// SCORE A SINGLE MEASUREMENT\n    55→// ============================================\n    56→\n    57→/**\n    58→ * Calculate complete score result for a measurement.\n    59→ * If demographics provided, uses demographic-specific ideal ranges.\n    60→ */\n    61→export function scoreMeasurement(\n    62→  metricId: string,\n    63→  value: number,\n    64→  demographics?: DemographicOptions\n    65→): MetricScoreResult | null {\n    66→  // Get config with demographic overrides if provided\n    67→  const config = demographics?.gender\n    68→    ? getMetricConfigForDemographics(metricId, demographics.gender, demographics.ethnicity || 'other', METRIC_CONFIGS)\n    69→    : METRIC_CONFIGS[metricId];\n    70→\n    71→  if (!config) return null;\n    72→\n    73→  const score = calculateMetricScore(value, config);\n    74→  const standardizedScore = standardizeScore(score, config.maxScore);\n    75→  const qualityTier = getQualityTier(score, config.maxScore);\n    76→  const severity = getSeverityLevel(score, config.maxScore);\n    77→  const { deviation, direction } = getDeviationDescription(\n    78→    value,\n    79→    config.idealMin,\n    80→    config.idealMax,\n    81→    config.unit\n    82→  );\n    83→\n    84→  return {\n    85→    metricId,\n    86→    name: config.name,\n    87→    value,\n    88→    score,\n    89→    standardizedScore,\n    90→    qualityTier,\n    91→    severity,\n    92→    idealMin: config.idealMin,\n    93→    idealMax: config.idealMax,\n    94→    deviation,\n    95→    deviationDirection: direction,\n    96→    unit: config.unit,\n    97→    category: config.category,\n    98→  };\n    99→}\n   100→\n   101→// ============================================\n   102→// FRONT PROFILE ANALYSIS\n   103→// ============================================\n   104→\n   105→/**\n   106→ * Calculate all front profile measurements from landmarks.\n   107→ * Now supports ethnicity-specific ideal ranges for more accurate scoring.\n   108→ */\n   109→export function analyzeFrontProfile(\n   110→  landmarks: LandmarkPoint[],\n   111→  gender: Gender = 'male',\n   112→  ethnicity: Ethnicity = 'other'\n   113→): FrontProfileResults {\n   114→  const measurements: MetricScoreResult[] = [];\n   115→  const demographics: DemographicOptions = { gender, ethnicity };\n   116→\n   117→  // Helper to add measurement if landmarks available\n   118→  const addMeasurement = (metricId: string, value: number | null) => {\n   119→    if (value !== null) {\n   120→      const result = scoreMeasurement(metricId, value, demographics);\n   121→      if (result) measurements.push(result);\n   122→    }\n   123→  };\n   124→\n   125→  // Get key landmarks\n   126→  const trichion = getLandmark(landmarks, 'trichion');\n   127→  const nasalBase = getLandmark(landmarks, 'nasal_base');\n   128→  const subnasale = getLandmark(landmarks, 'subnasale');\n   129→  const menton = getLandmark(landmarks, 'menton');\n   130→  const leftZygion = getLandmark(landmarks, 'left_zygion');\n   131→  const rightZygion = getLandmark(landmarks, 'right_zygion');\n   132→  const leftGonion = getLandmark(landmarks, 'left_gonion_inferior');\n   133→  const rightGonion = getLandmark(landmarks, 'right_gonion_inferior');\n   134→  const leftPupil = getLandmark(landmarks, 'left_pupila');\n   135→  const rightPupil = getLandmark(landmarks, 'right_pupila');\n   136→  const leftCanthusM = getLandmark(landmarks, 'left_canthus_medialis');\n   137→  const leftCanthusL = getLandmark(landmarks, 'left_canthus_lateralis');\n   138→  const rightCanthusM = getLandmark(landmarks, 'right_canthus_medialis');\n   139→  const rightCanthusL = getLandmark(landmarks, 'right_canthus_lateralis');\n   140→  void rightCanthusL; // Will be used for asymmetry measurements\n   141→  const leftAlaNasi = getLandmark(landmarks, 'left_ala_nasi');\n   142→  const rightAlaNasi = getLandmark(landmarks, 'right_ala_nasi');\n   143→  const leftCheilion = getLandmark(landmarks, 'left_cheilion');\n   144→  const rightCheilion = getLandmark(landmarks, 'right_cheilion');\n   145→  const labraleSuperius = getLandmark(landmarks, 'labrale_superius');\n   146→  const labraleInferius = getLandmark(landmarks, 'labrale_inferius');\n   147→\n   148→  // FACIAL THIRDS\n   149→  if (trichion && nasalBase && subnasale && menton) {\n   150→    const totalHeight = distance(trichion, menton);\n   151→    if (totalHeight > 0) {\n   152→      const upperThird = (distance(trichion, nasalBase) / totalHeight) * 100;\n   153→      const middleThird = (distance(nasalBase, subnasale) / totalHeight) * 100;\n   154→      const lowerThird = (distance(subnasale, menton) / totalHeight) * 100;\n   155→\n   156→      addMeasurement('upperThirdProportion', upperThird);\n   157→      addMeasurement('middleThirdProportion', middleThird);\n   158→      addMeasurement('lowerThirdProportion', lowerThird);\n   159→\n   160→      // Lower Third Internal Ratio (subnasale to stomion / subnasale to menton)\n   161→      const stomion = getLandmark(landmarks, 'mouth_middle');\n   162→      if (stomion) {\n   163→        const subnasaleToStomion = distance(subnasale, stomion);\n   164→        const subnasaleToMenton = distance(subnasale, menton);\n   165→        if (subnasaleToMenton > 0) {\n   166→          const lowerThirdAlt = (subnasaleToStomion / subnasaleToMenton) * 100;\n   167→          addMeasurement('lowerThirdProportionAlt', lowerThirdAlt);\n   168→        }\n   169→      }\n   170→    }\n   171→  }\n   172→\n   173→  // FACE WIDTH TO HEIGHT RATIO (FWHR)\n   174→  if (leftZygion && rightZygion && nasalBase && labraleSuperius) {\n   175→    const bizygomaticWidth = distance(leftZygion, rightZygion);\n   176→    const upperFaceHeight = distance(nasalBase, labraleSuperius);\n   177→    if (upperFaceHeight > 0) {\n   178→      addMeasurement('faceWidthToHeight', bizygomaticWidth / upperFaceHeight);\n   179→    }\n   180→  }\n   181→\n   182→  // TOTAL FACIAL WIDTH TO HEIGHT\n   183→  if (leftZygion && rightZygion && trichion && menton) {\n   184→    const cheekWidth = distance(leftZygion, rightZygion);\n   185→    const totalHeight = distance(trichion, menton);\n   186→    if (cheekWidth > 0) {\n   187→      addMeasurement('totalFacialWidthToHeight', totalHeight / cheekWidth);\n   188→    }\n   189→  }\n   190→\n   191→  // JAW WIDTH RATIO\n   192→  if (leftGonion && rightGonion && leftZygion && rightZygion) {\n   193→    const bigonialWidth = distance(leftGonion, rightGonion);\n   194→    const bizygomaticWidth = distance(leftZygion, rightZygion);\n   195→    if (bizygomaticWidth > 0) {\n   196→      const ratio = bigonialWidth / bizygomaticWidth;\n   197→      addMeasurement('jawWidthRatio', ratio);\n   198→      addMeasurement('bigonialWidth', ratio * 100);\n   199→    }\n   200→  }\n   201→\n   202→  // CANTHAL TILT\n   203→  // Positive tilt = lateral canthus is higher than medial (lower y in screen coords)\n   204→  // Use abs(deltaX) to avoid sign issues between left/right eye\n   205→  if (leftCanthusM && leftCanthusL) {\n   206→    const deltaY = leftCanthusM.y - leftCanthusL.y;  // positive if lateral is higher\n   207→    const deltaX = Math.abs(leftCanthusM.x - leftCanthusL.x);  // eye width (always positive)\n   208→    const angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);\n   209→    addMeasurement('lateralCanthalTilt', angle);\n   210→  }\n   211→\n   212→  // EYE ASPECT RATIO\n   213→  if (leftCanthusM && leftCanthusL) {\n   214→    const leftPalpSup = getLandmark(landmarks, 'left_palpebra_superior');\n   215→    const leftPalpInf = getLandmark(landmarks, 'left_palpebra_inferior');\n   216→    if (leftPalpSup && leftPalpInf) {\n   217→      const eyeWidth = distance(leftCanthusM, leftCanthusL);\n   218→      const eyeHeight = distance(leftPalpSup, leftPalpInf);\n   219→      if (eyeHeight > 0) {\n   220→        // Eye aspect ratio = width / height (ideal ~3.0-3.5 for almond shape)\n   221→        addMeasurement('eyeAspectRatio', eyeWidth / eyeHeight);\n   222→      }\n   223→    }\n   224→  }\n   225→\n   226→  // EYE SEPARATION RATIO\n   227→  if (leftCanthusM && rightCanthusM && leftZygion && rightZygion) {\n   228→    const intercanthal = distance(leftCanthusM, rightCanthusM);\n   229→    const bizygomatic = distance(leftZygion, rightZygion);\n   230→    if (bizygomatic > 0) {\n   231→      addMeasurement('eyeSeparationRatio', intercanthal / bizygomatic);\n   232→    }\n   233→  }\n   234→\n   235→  // IPD RATIO\n   236→  if (leftPupil && rightPupil && leftZygion && rightZygion) {\n   237→    const ipd = distance(leftPupil, rightPupil);\n   238→    const bizygomatic = distance(leftZygion, rightZygion);\n   239→    if (bizygomatic > 0) {\n   240→      addMeasurement('interpupillaryRatio', (ipd / bizygomatic) * 100);\n   241→    }\n   242→  }\n   243→\n   244→  // ONE EYE APART TEST\n   245→  if (leftCanthusM && rightCanthusM && leftCanthusL) {\n   246→    const intercanthal = distance(leftCanthusM, rightCanthusM);\n   247→    const eyeWidth = distance(leftCanthusM, leftCanthusL);\n   248→    if (eyeWidth > 0) {\n   249→      addMeasurement('oneEyeApartTest', intercanthal / eyeWidth);\n   250→    }\n   251→  }\n   252→\n   253→  // NASAL INDEX\n   254→  if (leftAlaNasi && rightAlaNasi && nasalBase && subnasale) {\n   255→    const nasalWidth = distance(leftAlaNasi, rightAlaNasi);\n   256→    const nasalHeight = distance(nasalBase, subnasale);\n   257→    if (nasalHeight > 0) {\n   258→      addMeasurement('nasalIndex', (nasalWidth / nasalHeight) * 100);\n   259→    }\n   260→  }\n   261→\n   262→  // INTERCANTHAL-NASAL WIDTH RATIO\n   263→  if (leftCanthusM && rightCanthusM && leftAlaNasi && rightAlaNasi) {\n   264→    const intercanthal = distance(leftCanthusM, rightCanthusM);\n   265→    const nasalWidth = distance(leftAlaNasi, rightAlaNasi);\n   266→    if (nasalWidth > 0) {\n   267→      addMeasurement('intercanthalNasalRatio', intercanthal / nasalWidth);\n   268→    }\n   269→  }\n   270→\n   271→  // MOUTH TO NOSE RATIO\n   272→  if (leftCheilion && rightCheilion && leftAlaNasi && rightAlaNasi) {\n   273→    const mouthWidth = distance(leftCheilion, rightCheilion);\n   274→    const nasalWidth = distance(leftAlaNasi, rightAlaNasi);\n   275→    if (nasalWidth > 0) {\n   276→      addMeasurement('mouthWidthToNoseRatio', mouthWidth / nasalWidth);\n   277→    }\n   278→  }\n   279→\n   280→  // IPD TO MOUTH WIDTH RATIO\n   281→  if (leftPupil && rightPupil && leftCheilion && rightCheilion) {\n   282→    const ipd = distance(leftPupil, rightPupil);\n   283→    const mouthWidth = distance(leftCheilion, rightCheilion);\n   284→    if (ipd > 0) {\n   285→      addMeasurement('interpupillaryMouthWidthRatio', mouthWidth / ipd);\n   286→    }\n   287→  }\n   288→\n   289→  // LIP RATIO\n   290→  if (labraleSuperius && labraleInferius && subnasale) {\n   291→    const mouthMiddle = getLandmark(landmarks, 'mouth_middle');\n   292→    if (mouthMiddle) {\n   293→      const upperLipHeight = distance(subnasale, labraleSuperius);\n   294→      const lowerLipHeight = distance(mouthMiddle, labraleInferius);\n   295→      if (upperLipHeight > 0) {\n   296→        addMeasurement('lowerToUpperLipRatio', lowerLipHeight / upperLipHeight);\n   297→      }\n   298→    }\n   299→  }\n   300→\n   301→  // MIDFACE RATIO\n   302→  if (leftZygion && rightZygion && nasalBase && subnasale) {\n   303→    const midfaceWidth = distance(leftZygion, rightZygion);\n   304→    const midfaceHeight = distance(nasalBase, subnasale);\n   305→    if (midfaceHeight > 0) {\n   306→      addMeasurement('midfaceRatio', midfaceWidth / midfaceHeight / 10); // Normalized\n   307→    }\n   308→  }\n   309→\n   310→  // CHEEK FULLNESS (Malar Convexity)\n   311→  // Measures how much the cheek protrudes outward from the line between zygion and gonion\n   312→  // Positive = Full/Youthful cheeks; Negative = Hollow/Gaunt cheeks\n   313→  const leftMalar = getLandmark(landmarks, 'left_malar');\n   314→  const rightMalar = getLandmark(landmarks, 'right_malar');\n   315→\n   316→  if (leftZygion && rightZygion && leftGonion && rightGonion && leftMalar && rightMalar) {\n   317→    // Helper: Calculate signed perpendicular distance from point to line\n   318→    const pointLineDistance = (p: Point, a: Point, b: Point): number => {\n   319→      // Cross product: (bx - ax)(py - ay) - (by - ay)(px - ax)\n   320→      const cross = (b.x - a.x) * (p.y - a.y) - (b.y - a.y) * (p.x - a.x);\n   321→      const lineLength = Math.sqrt(Math.pow(b.x - a.x, 2) + Math.pow(b.y - a.y, 2));\n   322→      return cross / lineLength;\n   323→    };\n   324→\n   325→    // Calculate convexity for both sides\n   326→    const rightFullness = Math.abs(pointLineDistance(rightMalar, rightZygion, rightGonion));\n   327→    const leftFullness = Math.abs(pointLineDistance(leftMalar, leftZygion, leftGonion));\n   328→\n   329→    // Normalize by face width to make scale-invariant\n   330→    const faceWidth = distance(leftZygion, rightZygion);\n   331→    if (faceWidth > 0) {\n   332→      const rawScore = (rightFullness + leftFullness) / 2;\n   333→      const normalizedScore = (rawScore / faceWidth) * 100;\n   334→      addMeasurement('cheekFullness', normalizedScore);\n   335→    }\n   336→  }\n   337→\n   338→  // CHIN WIDTH\n   339→  // Measures horizontal width of the mental protuberance (chin bone)\n   340→  // Uses left/right mentum lateralis landmarks (132, 361 in MediaPipe)\n   341→  const leftMentumLat = getLandmark(landmarks, 'left_mentum_lateralis');\n   342→  const rightMentumLat = getLandmark(landmarks, 'right_mentum_lateralis');\n   343→\n   344→  if (leftMentumLat && rightMentumLat && leftZygion && rightZygion) {\n   345→    const chinWidth = distance(leftMentumLat, rightMentumLat);\n   346→    const faceWidth = distance(leftZygion, rightZygion);\n   347→    if (faceWidth > 0) {\n   348→      const chinWidthPercent = (chinWidth / faceWidth) * 100;\n   349→      addMeasurement('chinWidth', chinWidthPercent);\n   350→    }\n   351→  }\n   352→\n   353→  // EYEBROW THICKNESS\n   354→  // Measures vertical height of eyebrow at thickest point\n   355→  // Landmarks: brow top (66, 296) and brow bottom (46, 276)\n   356→  const leftBrowTop = getLandmark(landmarks, 'left_supercilium_superior');  // 52 in mapping, but we need 66\n   357→  const leftBrowBottom = getLandmark(landmarks, 'left_supercilium_apex');  // 105 in mapping, but we need 46\n   358→  const rightBrowTop = getLandmark(landmarks, 'right_supercilium_superior');  // 282 in mapping, but we need 296\n   359→  const rightBrowBottom = getLandmark(landmarks, 'right_supercilium_apex');  // 334 in mapping, but we need 276\n   360→\n   361→  if (leftBrowTop && leftBrowBottom && rightBrowTop && rightBrowBottom && leftCanthusM && leftCanthusL) {\n   362→    const leftThickness = distance(leftBrowTop, leftBrowBottom);\n   363→    const rightThickness = distance(rightBrowTop, rightBrowBottom);\n   364→    const avgThickness = (leftThickness + rightThickness) / 2;\n   365→\n   366→    // Normalize by eye height to make scale-invariant\n   367→    const leftPalpSup = getLandmark(landmarks, 'left_palpebra_superior');\n   368→    const leftPalpInf = getLandmark(landmarks, 'left_palpebra_inferior');\n   369→    if (leftPalpSup && leftPalpInf) {\n   370→      const eyeHeight = distance(leftPalpSup, leftPalpInf);\n   371→      if (eyeHeight > 0) {\n   372→        const normalizedThickness = (avgThickness / eyeHeight) * 10.0;  // Scale factor\n   373→        addMeasurement('eyebrowThickness', normalizedThickness);\n   374→      }\n   375→    }\n   376→  }\n   377→\n   378→  // UPPER EYELID EXPOSURE\n   379→  // Measures visible skin between eyelash line and eyelid crease\n   380→  // Landmarks: crease (27, 257) and lid top/lash line (159, 386)\n   381→  if (leftCanthusM && leftCanthusL) {\n   382→    const leftPalpSup = getLandmark(landmarks, 'left_palpebra_superior');\n   383→    const leftPalpInf = getLandmark(landmarks, 'left_palpebra_inferior');\n   384→    const leftCrease = getLandmark(landmarks, 'left_pretarsal_skin_crease');\n   385→\n   386→    if (leftPalpSup && leftPalpInf && leftCrease) {\n   387→      // Distance from brow bone/crease to lash line\n   388→      const lidGap = distance(leftCrease, leftPalpSup);\n   389→\n   390→      // Normalize by total eye opening height\n   391→      const eyeOpen = distance(leftPalpSup, leftPalpInf);\n   392→      if (eyeOpen > 0) {\n   393→        const exposure = lidGap / eyeOpen;\n   394→        addMeasurement('upperEyelidExposure', exposure);\n   395→      }\n   396→    }\n   397→  }\n   398→\n   399→  // TEAR TROUGH DEPTH\n   400→  // Placeholder metric: Default to 0.2 (clean/good) since we can't measure depth from 2D landmarks\n   401→  // Future upgrade: Implement OpenCV color sampler to detect darkness under eyes\n   402→  // For now, assign a neutral/good value so it doesn't unfairly penalize users\n   403→  addMeasurement('tearTroughDepth', 0.2);\n   404→\n   405→  // Calculate category scores\n   406→  const categoryScores: Record<string, { total: number; count: number }> = {};\n   407→  for (const m of measurements) {\n   408→    if (!categoryScores[m.category]) {\n   409→      categoryScores[m.category] = { total: 0, count: 0 };\n   410→    }\n   411→    categoryScores[m.category].total += m.standardizedScore;\n   412→    categoryScores[m.category].count++;\n   413→  }\n   414→\n   415→  const categoryAvg: Record<string, number> = {};\n   416→  for (const [cat, data] of Object.entries(categoryScores)) {\n   417→    categoryAvg[cat] = data.count > 0 ? data.total / data.count : 0;\n   418→  }\n   419→\n   420→  // Calculate overall score (weighted average)\n   421→  let totalWeight = 0;\n   422→  let weightedSum = 0;\n   423→  for (const m of measurements) {\n   424→    const config = METRIC_CONFIGS[m.metricId];\n   425→    if (config) {\n   426→      weightedSum += m.standardizedScore * config.weight;\n   427→      totalWeight += config.weight;\n   428→    }\n   429→  }\n   430→\n   431→  const overallScore = totalWeight > 0 ? weightedSum / totalWeight : 0;\n   432→  const standardizedScoreValue = overallScore;\n   433→\n   434→  return {\n   435→    measurements,\n   436→    overallScore,\n   437→    standardizedScore: standardizedScoreValue,\n   438→    qualityTier: getQualityTier(overallScore),\n   439→    categoryScores: categoryAvg,\n   440→  };\n   441→}\n   442→\n   443→// ============================================\n   444→// SIDE PROFILE ANALYSIS\n   445→// ============================================\n   446→\n   447→/**\n   448→ * Calculate all side profile measurements from landmarks.\n   449→ * Now supports ethnicity-specific ideal ranges for more accurate scoring.\n   450→ */\n   451→export function analyzeSideProfile(\n   452→  landmarks: LandmarkPoint[],\n   453→  gender: Gender = 'male',\n   454→  ethnicity: Ethnicity = 'other'\n   455→): SideProfileResults {\n   456→  const measurements: MetricScoreResult[] = [];\n   457→  const demographics: DemographicOptions = { gender, ethnicity };\n   458→\n   459→  const addMeasurement = (metricId: string, value: number | null) => {\n   460→    if (value !== null) {\n   461→      const result = scoreMeasurement(metricId, value, demographics);\n   462→      if (result) measurements.push(result);\n   463→    }\n   464→  };\n   465→\n   466→  // Get key landmarks\n   467→  const glabella = getLandmark(landmarks, 'glabella');\n   468→  const nasion = getLandmark(landmarks, 'nasion');\n   469→  const rhinion = getLandmark(landmarks, 'rhinion');\n   470→  const pronasale = getLandmark(landmarks, 'pronasale');\n   471→  const columella = getLandmark(landmarks, 'columella');\n   472→  const subnasale = getLandmark(landmarks, 'subnasale');\n   473→  const labraleSuperius = getLandmark(landmarks, 'labraleSuperius');\n   474→  const labraleInferius = getLandmark(landmarks, 'labraleInferius');\n   475→  const sublabiale = getLandmark(landmarks, 'sublabiale');\n   476→  const pogonion = getLandmark(landmarks, 'pogonion');\n   477→  const menton = getLandmark(landmarks, 'menton');\n   478→  const tragus = getLandmark(landmarks, 'tragus');\n   479→  const gonionBottom = getLandmark(landmarks, 'gonionBottom');\n   480→  const cervicalPoint = getLandmark(landmarks, 'cervicalPoint');\n   481→  const orbitale = getLandmark(landmarks, 'orbitale');\n   482→  const porion = getLandmark(landmarks, 'porion');\n   483→\n   484→  // GONIAL ANGLE\n   485→  if (tragus && gonionBottom && menton) {\n   486→    const angle = calculateAngle(tragus, gonionBottom, menton);\n   487→    addMeasurement('gonialAngle', angle);\n   488→  }\n   489→\n   490→  // NASOLABIAL ANGLE\n   491→  if (columella && subnasale && labraleSuperius) {\n   492→    const angle = calculateAngle(columella, subnasale, labraleSuperius);\n   493→    addMeasurement('nasolabialAngle', angle);\n   494→  }\n   495→\n   496→  // NASOFRONTAL ANGLE\n   497→  if (glabella && nasion && rhinion) {\n   498→    const angle = calculateAngle(glabella, nasion, rhinion);\n   499→    addMeasurement('nasofrontalAngle', angle);\n   500→  }\n   501→\n   502→  // MENTOLABIAL ANGLE\n   503→  if (labraleInferius && sublabiale && pogonion) {\n   504→    const angle = calculateAngle(labraleInferius, sublabiale, pogonion);\n   505→    addMeasurement('mentolabialAngle', angle);\n   506→  }\n   507→\n   508→  // E-LINE MEASUREMENTS (Ricketts)\n   509→  // E-line runs from pronasale (nose tip) to soft tissue pogonion (chin)\n   510→  // Sign convention: positive = in front of line, negative = behind\n   511→  // perpendicularDistance returns positive for behind, so we negate\n   512→  if (pronasale && pogonion && labraleSuperius && labraleInferius) {\n   513→    const upperLipDist = perpendicularDistance(labraleSuperius, pronasale, pogonion);\n   514→    const lowerLipDist = perpendicularDistance(labraleInferius, pronasale, pogonion);\n   515→    // Negate to match sign convention (positive = protruding/in front)\n   516→    addMeasurement('eLineUpperLip', -upperLipDist);\n   517→    addMeasurement('eLineLowerLip', -lowerLipDist);\n   518→  }\n   519→\n   520→  // BURSTONE LINE MEASUREMENTS\n   521→  // Burstone line runs from subnasale to soft tissue pogonion\n   522→  // Sign convention: negative = behind line (ideal is -4.7 to -2.3 for upper, -2.8 to -1.2 for lower)\n   523→  if (subnasale && pogonion && labraleSuperius && labraleInferius) {\n   524→    const upperLipBurstone = perpendicularDistance(labraleSuperius, subnasale, pogonion);\n   525→    const lowerLipBurstone = perpendicularDistance(labraleInferius, subnasale, pogonion);\n   526→    // Negate to match sign convention (negative = behind)\n   527→    addMeasurement('burstoneUpperLip', -upperLipBurstone);\n   528→    addMeasurement('burstoneLowerLip', -lowerLipBurstone);\n   529→  }\n   530→\n   531→  // S-LINE MEASUREMENTS (Steiner)\n   532→  // S-line runs from columella (or subnasale) to soft tissue pogonion\n   533→  // Sign convention: positive = in front of line, negative = behind\n   534→  const sLineStart = columella || subnasale;\n   535→  if (sLineStart && pogonion && labraleSuperius && labraleInferius) {\n   536→    const upperLipSLine = perpendicularDistance(labraleSuperius, sLineStart, pogonion);\n   537→    const lowerLipSLine = perpendicularDistance(labraleInferius, sLineStart, pogonion);\n   538→    // Negate to match sign convention (positive = protruding/in front)\n   539→    addMeasurement('sLineUpperLip', -upperLipSLine);\n   540→    addMeasurement('sLineLowerLip', -lowerLipSLine);\n   541→  }\n   542→\n   543→  // HOLDAWAY H-LINE MEASUREMENT\n   544→  // H-line runs from upper lip (labrale superius) to soft tissue pogonion\n   545→  // Measures lower lip distance from this line\n   546→  // Sign convention: positive = in front of line (ideal 0-4mm)\n   547→  if (labraleSuperius && pogonion && labraleInferius) {\n   548→    const lowerLipHLine = perpendicularDistance(labraleInferius, labraleSuperius, pogonion);\n   549→    // Negate to match sign convention (positive = protruding/in front)\n   550→    addMeasurement('holdawayHLine', -lowerLipHLine);\n   551→  }\n   552→\n   553→  // NASOMENTAL ANGLE\n   554→  if (nasion && pronasale && pogonion) {\n   555→    const angle = calculateAngle(nasion, pronasale, pogonion);\n   556→    addMeasurement('nasomentaAngle', angle);\n   557→  }\n   558→\n   559→  // FACIAL CONVEXITY (GLABELLA)\n   560→  if (glabella && subnasale && pogonion) {\n   561→    const angle = calculateAngle(glabella, subnasale, pogonion);\n   562→    addMeasurement('facialConvexityGlabella', angle);\n   563→  }\n   564→\n   565→  // FACIAL CONVEXITY (NASION)\n   566→  if (nasion && subnasale && pogonion) {\n   567→    const angle = calculateAngle(nasion, subnasale, pogonion);\n   568→    addMeasurement('facialConvexityNasion', angle);\n   569→  }\n   570→\n   571→  // TOTAL FACIAL CONVEXITY\n   572→  if (glabella && pronasale && pogonion) {\n   573→    const angle = calculateAngle(glabella, pronasale, pogonion);\n   574→    addMeasurement('totalFacialConvexity', angle);\n   575→  }\n   576→\n   577→  // SUBMENTAL CERVICAL ANGLE\n   578→  if (menton && cervicalPoint && pogonion) {\n   579→    const neckPoint = getLandmark(landmarks, 'neckPoint');\n   580→    if (neckPoint) {\n   581→      const angle = calculateAngle(pogonion, menton, neckPoint);\n   582→      addMeasurement('submentalCervicalAngle', angle);\n   583→    }\n   584→  }\n   585→\n   586→  // NASAL PROJECTION (Goode ratio)\n   587→  if (pronasale && subnasale && nasion) {\n   588→    const projection = distance(pronasale, subnasale);\n   589→    const nasalLength = distance(nasion, pronasale);\n   590→    if (nasalLength > 0) {\n   591→      addMeasurement('nasalProjection', projection / nasalLength);\n   592→    }\n   593→  }\n   594→\n   595→  // NASOFACIAL ANGLE\n   596→  if (nasion && pronasale && pogonion) {\n   597→    // Angle between nose dorsum and facial plane\n   598→    const nasalDorsum = { x: pronasale.x - nasion.x, y: pronasale.y - nasion.y };\n   599→    const facialPlane = { x: pogonion.x - nasion.x, y: pogonion.y - nasion.y };\n   600→\n   601→    const dot = nasalDorsum.x * facialPlane.x + nasalDorsum.y * facialPlane.y;\n   602→    const mag1 = Math.sqrt(nasalDorsum.x ** 2 + nasalDorsum.y ** 2);\n   603→    const mag2 = Math.sqrt(facialPlane.x ** 2 + facialPlane.y ** 2);\n   604→\n   605→    if (mag1 > 0 && mag2 > 0) {\n   606→      const angle = Math.acos(dot / (mag1 * mag2)) * (180 / Math.PI);\n   607→      addMeasurement('nasofacialAngle', angle);\n   608→    }\n   609→  }\n   610→\n   611→  // MANDIBULAR PLANE ANGLE (using Frankfort horizontal)\n   612→  if (porion && orbitale && gonionBottom && menton) {\n   613→    // Frankfort horizontal is porion to orbitale\n   614→    // Mandibular plane is gonion to menton\n   615→    const fhAngle = Math.atan2(orbitale.y - porion.y, orbitale.x - porion.x);\n   616→    const mpAngle = Math.atan2(menton.y - gonionBottom.y, menton.x - gonionBottom.x);\n   617→    const angle = Math.abs(fhAngle - mpAngle) * (180 / Math.PI);\n   618→    addMeasurement('mandibularPlaneAngle', angle);\n   619→  }\n   620→\n   621→  // CHIN PROJECTION\n   622→  if (pogonion && subnasale) {\n   623→    // Distance from pogonion to vertical line through subnasale\n   624→    const projection = pogonion.x - subnasale.x;\n   625→    addMeasurement('chinProjection', projection);\n   626→  }\n   627→\n   628→  // Calculate category scores\n   629→  const categoryScores: Record<string, { total: number; count: number }> = {};\n   630→  for (const m of measurements) {\n   631→    if (!categoryScores[m.category]) {\n   632→      categoryScores[m.category] = { total: 0, count: 0 };\n   633→    }\n   634→    categoryScores[m.category].total += m.standardizedScore;\n   635→    categoryScores[m.category].count++;\n   636→  }\n   637→\n   638→  const categoryAvg: Record<string, number> = {};\n   639→  for (const [cat, data] of Object.entries(categoryScores)) {\n   640→    categoryAvg[cat] = data.count > 0 ? data.total / data.count : 0;\n   641→  }\n   642→\n   643→  // Calculate overall score\n   644→  let totalWeight = 0;\n   645→  let weightedSum = 0;\n   646→  for (const m of measurements) {\n   647→    const config = METRIC_CONFIGS[m.metricId];\n   648→    if (config) {\n   649→      weightedSum += m.standardizedScore * config.weight;\n   650→      totalWeight += config.weight;\n   651→    }\n   652→  }\n   653→\n   654→  const overallScore = totalWeight > 0 ? weightedSum / totalWeight : 0;\n   655→\n   656→  return {\n   657→    measurements,\n   658→    overallScore,\n   659→    standardizedScore: overallScore,\n   660→    qualityTier: getQualityTier(overallScore),\n   661→    categoryScores: categoryAvg,\n   662→  };\n   663→}\n   664→\n   665→// ============================================\n   666→// COMPLETE HARMONY ANALYSIS\n   667→// ============================================\n   668→\n   669→/**\n   670→ * Run complete facial harmony analysis.\n   671→ * Now supports ethnicity-specific ideal ranges for more accurate scoring.\n   672→ */\n   673→export function analyzeHarmony(\n   674→  frontLandmarks: LandmarkPoint[],\n   675→  sideLandmarks: LandmarkPoint[],\n   676→  gender: Gender = 'male',\n   677→  ethnicity: Ethnicity = 'other'\n   678→): HarmonyAnalysis {\n   679→  const frontResults = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n   680→  const sideResults = analyzeSideProfile(sideLandmarks, gender, ethnicity);\n   681→\n   682→  const allMeasurements = [...frontResults.measurements, ...sideResults.measurements];\n   683→\n   684→  // Combined category scores\n   685→  const allCategories: Record<string, { total: number; count: number }> = {};\n   686→  for (const m of allMeasurements) {\n   687→    if (!allCategories[m.category]) {\n   688→      allCategories[m.category] = { total: 0, count: 0 };\n   689→    }\n   690→    allCategories[m.category].total += m.standardizedScore;\n   691→    allCategories[m.category].count++;\n   692→  }\n   693→\n   694→  const categoryScores: Record<string, number> = {};\n   695→  for (const [cat, data] of Object.entries(allCategories)) {\n   696→    categoryScores[cat] = data.count > 0 ? data.total / data.count : 0;\n   697→  }\n   698→\n   699→  // Overall weighted score\n   700→  let totalWeight = 0;\n   701→  let weightedSum = 0;\n   702→  for (const m of allMeasurements) {\n   703→    const config = METRIC_CONFIGS[m.metricId];\n   704→    if (config) {\n   705→      weightedSum += m.standardizedScore * config.weight;\n   706→      totalWeight += config.weight;\n   707→    }\n   708→  }\n   709→\n   710→  const overallScore = totalWeight > 0 ? weightedSum / totalWeight : 0;\n   711→\n   712→  // Identify flaws (below average measurements)\n   713→  const flaws: FlawAssessment[] = allMeasurements\n   714→    .filter((m) => m.severity !== 'optimal' && m.severity !== 'minor')\n   715→    .map((m) => ({\n   716→      category: m.category,\n   717→      metricId: m.metricId,\n   718→      metricName: m.name,\n   719→      severity: m.severity,\n   720→      deviation: `${m.deviation.toFixed(2)} ${m.deviationDirection} ideal`,\n   721→      reasoning: `${m.name} is outside the ideal range`,\n   722→      confidence: m.severity === 'extremely_severe' || m.severity === 'severe'\n   723→        ? 'confirmed' as const\n   724→        : 'likely' as const,\n   725→    }))\n   726→    .sort((a, b) => {\n   727→      const severityOrder = { extremely_severe: 0, severe: 1, major: 2, moderate: 3 };\n   728→      return (severityOrder[a.severity as keyof typeof severityOrder] ?? 4) -\n   729→             (severityOrder[b.severity as keyof typeof severityOrder] ?? 4);\n   730→    });\n   731→\n   732→  // Identify strengths (ideal measurements)\n   733→  const strengths: StrengthAssessment[] = allMeasurements\n   734→    .filter((m) => m.qualityTier === 'ideal' || m.qualityTier === 'excellent')\n   735→    .map((m) => ({\n   736→      category: m.category,\n   737→      metricId: m.metricId,\n   738→      metricName: m.name,\n   739→      qualityTier: m.qualityTier,\n   740→      value: m.value,\n   741→      reasoning: `${m.name} is within the ${m.qualityTier} range`,\n   742→    }));\n   743→\n   744→  // Calculate percentile (based on population stats)\n   745→  const percentile = calculateHarmonyPercentile(overallScore);\n   746→\n   747→  return {\n   748→    overallScore,\n   749→    standardizedScore: overallScore,\n   750→    qualityTier: getQualityTier(overallScore),\n   751→    percentile,\n   752→    frontScore: frontResults.overallScore,\n   753→    sideScore: sideResults.overallScore,\n   754→    categoryScores,\n   755→    measurements: allMeasurements,\n   756→    flaws,\n   757→    strengths,\n   758→  };\n   759→}\n   760→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7167c7ce-fec4-4caf-ac7a-19c9d360e7c7","timestamp":"2025-12-26T06:49:54.946Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/analyzer.ts","content":"/**\n * Facial Profile Analyzer\n * High-level analysis functions for front and side profile measurements\n *\n * Features:\n * - 32+ front profile measurements\n * - 30+ side profile measurements\n * - Ethnicity-specific ideal ranges\n * - Combined harmony analysis\n */\n\nimport {\n  Point,\n  MetricScoreResult,\n  HarmonyAnalysis,\n  FlawAssessment,\n  StrengthAssessment,\n  DemographicOptions,\n  FrontProfileResults,\n  SideProfileResults,\n  Gender,\n  Ethnicity,\n} from './types';\n\nimport {\n  calculateMetricScore,\n  getQualityTier,\n  getSeverityLevel,\n  distance,\n  calculateAngle,\n  perpendicularDistance,\n  standardizeScore,\n  calculateHarmonyPercentile,\n  getDeviationDescription,\n} from './calculator';\n\nimport { METRIC_CONFIGS } from '@/lib/data/metric-configs';\nimport { getMetricConfigForDemographics } from '@/lib/data/demographic-overrides';\nimport { LandmarkPoint } from '@/lib/landmarks';\n\n// ============================================\n// HELPER FUNCTIONS\n// ============================================\n\n/**\n * Helper to get landmark by ID\n */\nexport function getLandmark(landmarks: LandmarkPoint[], id: string): Point | null {\n  const lm = landmarks.find((l) => l.id === id);\n  return lm ? { x: lm.x, y: lm.y } : null;\n}\n\n// ============================================\n// SCORE A SINGLE MEASUREMENT\n// ============================================\n\n/**\n * Calculate complete score result for a measurement.\n * If demographics provided, uses demographic-specific ideal ranges.\n */\nexport function scoreMeasurement(\n  metricId: string,\n  value: number,\n  demographics?: DemographicOptions\n): MetricScoreResult | null {\n  // Get config with demographic overrides if provided\n  const config = demographics?.gender\n    ? getMetricConfigForDemographics(metricId, demographics.gender, demographics.ethnicity || 'other', METRIC_CONFIGS)\n    : METRIC_CONFIGS[metricId];\n\n  if (!config) return null;\n\n  const score = calculateMetricScore(value, config);\n  const standardizedScore = standardizeScore(score, config.maxScore);\n  const qualityTier = getQualityTier(score, config.maxScore);\n  const severity = getSeverityLevel(score, config.maxScore);\n  const { deviation, direction } = getDeviationDescription(\n    value,\n    config.idealMin,\n    config.idealMax,\n    config.unit\n  );\n\n  return {\n    metricId,\n    name: config.name,\n    value,\n    score,\n    standardizedScore,\n    qualityTier,\n    severity,\n    idealMin: config.idealMin,\n    idealMax: config.idealMax,\n    deviation,\n    deviationDirection: direction,\n    unit: config.unit,\n    category: config.category,\n  };\n}\n\n// ============================================\n// FRONT PROFILE ANALYSIS\n// ============================================\n\n/**\n * Calculate all front profile measurements from landmarks.\n * Now supports ethnicity-specific ideal ranges for more accurate scoring.\n */\nexport function analyzeFrontProfile(\n  landmarks: LandmarkPoint[],\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'other'\n): FrontProfileResults {\n  const measurements: MetricScoreResult[] = [];\n  const demographics: DemographicOptions = { gender, ethnicity };\n\n  // Helper to add measurement if landmarks available\n  const addMeasurement = (metricId: string, value: number | null) => {\n    if (value !== null) {\n      const result = scoreMeasurement(metricId, value, demographics);\n      if (result) measurements.push(result);\n    }\n  };\n\n  // Get key landmarks\n  const trichion = getLandmark(landmarks, 'trichion');\n  const nasalBase = getLandmark(landmarks, 'nasal_base');\n  const subnasale = getLandmark(landmarks, 'subnasale');\n  const menton = getLandmark(landmarks, 'menton');\n  const leftZygion = getLandmark(landmarks, 'left_zygion');\n  const rightZygion = getLandmark(landmarks, 'right_zygion');\n  const leftGonion = getLandmark(landmarks, 'left_gonion_inferior');\n  const rightGonion = getLandmark(landmarks, 'right_gonion_inferior');\n  const leftPupil = getLandmark(landmarks, 'left_pupila');\n  const rightPupil = getLandmark(landmarks, 'right_pupila');\n  const leftCanthusM = getLandmark(landmarks, 'left_canthus_medialis');\n  const leftCanthusL = getLandmark(landmarks, 'left_canthus_lateralis');\n  const rightCanthusM = getLandmark(landmarks, 'right_canthus_medialis');\n  const rightCanthusL = getLandmark(landmarks, 'right_canthus_lateralis');\n  void rightCanthusL; // Will be used for asymmetry measurements\n  const leftAlaNasi = getLandmark(landmarks, 'left_ala_nasi');\n  const rightAlaNasi = getLandmark(landmarks, 'right_ala_nasi');\n  const leftCheilion = getLandmark(landmarks, 'left_cheilion');\n  const rightCheilion = getLandmark(landmarks, 'right_cheilion');\n  const labraleSuperius = getLandmark(landmarks, 'labrale_superius');\n  const labraleInferius = getLandmark(landmarks, 'labrale_inferius');\n\n  // FACIAL THIRDS\n  if (trichion && nasalBase && subnasale && menton) {\n    const totalHeight = distance(trichion, menton);\n    if (totalHeight > 0) {\n      const upperThird = (distance(trichion, nasalBase) / totalHeight) * 100;\n      const middleThird = (distance(nasalBase, subnasale) / totalHeight) * 100;\n      const lowerThird = (distance(subnasale, menton) / totalHeight) * 100;\n\n      addMeasurement('upperThirdProportion', upperThird);\n      addMeasurement('middleThirdProportion', middleThird);\n      addMeasurement('lowerThirdProportion', lowerThird);\n\n      // Lower Third Internal Ratio (subnasale to stomion / subnasale to menton)\n      const stomion = getLandmark(landmarks, 'mouth_middle');\n      if (stomion) {\n        const subnasaleToStomion = distance(subnasale, stomion);\n        const subnasaleToMenton = distance(subnasale, menton);\n        if (subnasaleToMenton > 0) {\n          const lowerThirdAlt = (subnasaleToStomion / subnasaleToMenton) * 100;\n          addMeasurement('lowerThirdProportionAlt', lowerThirdAlt);\n        }\n      }\n    }\n  }\n\n  // FACE WIDTH TO HEIGHT RATIO (FWHR)\n  if (leftZygion && rightZygion && nasalBase && labraleSuperius) {\n    const bizygomaticWidth = distance(leftZygion, rightZygion);\n    const upperFaceHeight = distance(nasalBase, labraleSuperius);\n    if (upperFaceHeight > 0) {\n      addMeasurement('faceWidthToHeight', bizygomaticWidth / upperFaceHeight);\n    }\n  }\n\n  // TOTAL FACIAL WIDTH TO HEIGHT\n  if (leftZygion && rightZygion && trichion && menton) {\n    const cheekWidth = distance(leftZygion, rightZygion);\n    const totalHeight = distance(trichion, menton);\n    if (cheekWidth > 0) {\n      addMeasurement('totalFacialWidthToHeight', totalHeight / cheekWidth);\n    }\n  }\n\n  // JAW WIDTH RATIO\n  if (leftGonion && rightGonion && leftZygion && rightZygion) {\n    const bigonialWidth = distance(leftGonion, rightGonion);\n    const bizygomaticWidth = distance(leftZygion, rightZygion);\n    if (bizygomaticWidth > 0) {\n      const ratio = bigonialWidth / bizygomaticWidth;\n      addMeasurement('jawWidthRatio', ratio);\n      addMeasurement('bigonialWidth', ratio * 100);\n    }\n  }\n\n  // CANTHAL TILT\n  // Positive tilt = lateral canthus is higher than medial (lower y in screen coords)\n  // Use abs(deltaX) to avoid sign issues between left/right eye\n  if (leftCanthusM && leftCanthusL) {\n    const deltaY = leftCanthusM.y - leftCanthusL.y;  // positive if lateral is higher\n    const deltaX = Math.abs(leftCanthusM.x - leftCanthusL.x);  // eye width (always positive)\n    const angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);\n    addMeasurement('lateralCanthalTilt', angle);\n  }\n\n  // EYE ASPECT RATIO\n  if (leftCanthusM && leftCanthusL) {\n    const leftPalpSup = getLandmark(landmarks, 'left_palpebra_superior');\n    const leftPalpInf = getLandmark(landmarks, 'left_palpebra_inferior');\n    if (leftPalpSup && leftPalpInf) {\n      const eyeWidth = distance(leftCanthusM, leftCanthusL);\n      const eyeHeight = distance(leftPalpSup, leftPalpInf);\n      if (eyeHeight > 0) {\n        // Eye aspect ratio = width / height (ideal ~3.0-3.5 for almond shape)\n        addMeasurement('eyeAspectRatio', eyeWidth / eyeHeight);\n      }\n    }\n  }\n\n  // EYE SEPARATION RATIO\n  if (leftCanthusM && rightCanthusM && leftZygion && rightZygion) {\n    const intercanthal = distance(leftCanthusM, rightCanthusM);\n    const bizygomatic = distance(leftZygion, rightZygion);\n    if (bizygomatic > 0) {\n      addMeasurement('eyeSeparationRatio', intercanthal / bizygomatic);\n    }\n  }\n\n  // IPD RATIO\n  if (leftPupil && rightPupil && leftZygion && rightZygion) {\n    const ipd = distance(leftPupil, rightPupil);\n    const bizygomatic = distance(leftZygion, rightZygion);\n    if (bizygomatic > 0) {\n      addMeasurement('interpupillaryRatio', (ipd / bizygomatic) * 100);\n    }\n  }\n\n  // ONE EYE APART TEST\n  if (leftCanthusM && rightCanthusM && leftCanthusL) {\n    const intercanthal = distance(leftCanthusM, rightCanthusM);\n    const eyeWidth = distance(leftCanthusM, leftCanthusL);\n    if (eyeWidth > 0) {\n      addMeasurement('oneEyeApartTest', intercanthal / eyeWidth);\n    }\n  }\n\n  // NASAL INDEX\n  if (leftAlaNasi && rightAlaNasi && nasalBase && subnasale) {\n    const nasalWidth = distance(leftAlaNasi, rightAlaNasi);\n    const nasalHeight = distance(nasalBase, subnasale);\n    if (nasalHeight > 0) {\n      addMeasurement('nasalIndex', (nasalWidth / nasalHeight) * 100);\n    }\n  }\n\n  // INTERCANTHAL-NASAL WIDTH RATIO\n  if (leftCanthusM && rightCanthusM && leftAlaNasi && rightAlaNasi) {\n    const intercanthal = distance(leftCanthusM, rightCanthusM);\n    const nasalWidth = distance(leftAlaNasi, rightAlaNasi);\n    if (nasalWidth > 0) {\n      addMeasurement('intercanthalNasalRatio', intercanthal / nasalWidth);\n    }\n  }\n\n  // MOUTH TO NOSE RATIO\n  if (leftCheilion && rightCheilion && leftAlaNasi && rightAlaNasi) {\n    const mouthWidth = distance(leftCheilion, rightCheilion);\n    const nasalWidth = distance(leftAlaNasi, rightAlaNasi);\n    if (nasalWidth > 0) {\n      addMeasurement('mouthWidthToNoseRatio', mouthWidth / nasalWidth);\n    }\n  }\n\n  // IPD TO MOUTH WIDTH RATIO\n  if (leftPupil && rightPupil && leftCheilion && rightCheilion) {\n    const ipd = distance(leftPupil, rightPupil);\n    const mouthWidth = distance(leftCheilion, rightCheilion);\n    if (ipd > 0) {\n      addMeasurement('interpupillaryMouthWidthRatio', mouthWidth / ipd);\n    }\n  }\n\n  // LIP RATIO\n  if (labraleSuperius && labraleInferius && subnasale) {\n    const mouthMiddle = getLandmark(landmarks, 'mouth_middle');\n    if (mouthMiddle) {\n      const upperLipHeight = distance(subnasale, labraleSuperius);\n      const lowerLipHeight = distance(mouthMiddle, labraleInferius);\n      if (upperLipHeight > 0) {\n        addMeasurement('lowerToUpperLipRatio', lowerLipHeight / upperLipHeight);\n      }\n    }\n  }\n\n  // MIDFACE RATIO\n  if (leftZygion && rightZygion && nasalBase && subnasale) {\n    const midfaceWidth = distance(leftZygion, rightZygion);\n    const midfaceHeight = distance(nasalBase, subnasale);\n    if (midfaceHeight > 0) {\n      addMeasurement('midfaceRatio', midfaceWidth / midfaceHeight / 10); // Normalized\n    }\n  }\n\n  // CHEEK FULLNESS (Malar Convexity)\n  // Measures how much the cheek protrudes outward from the line between zygion and gonion\n  // Positive = Full/Youthful cheeks; Negative = Hollow/Gaunt cheeks\n  const leftMalar = getLandmark(landmarks, 'left_malar');\n  const rightMalar = getLandmark(landmarks, 'right_malar');\n\n  if (leftZygion && rightZygion && leftGonion && rightGonion && leftMalar && rightMalar) {\n    // Helper: Calculate signed perpendicular distance from point to line\n    const pointLineDistance = (p: Point, a: Point, b: Point): number => {\n      // Cross product: (bx - ax)(py - ay) - (by - ay)(px - ax)\n      const cross = (b.x - a.x) * (p.y - a.y) - (b.y - a.y) * (p.x - a.x);\n      const lineLength = Math.sqrt(Math.pow(b.x - a.x, 2) + Math.pow(b.y - a.y, 2));\n      return cross / lineLength;\n    };\n\n    // Calculate convexity for both sides\n    const rightFullness = Math.abs(pointLineDistance(rightMalar, rightZygion, rightGonion));\n    const leftFullness = Math.abs(pointLineDistance(leftMalar, leftZygion, leftGonion));\n\n    // Normalize by face width to make scale-invariant\n    const faceWidth = distance(leftZygion, rightZygion);\n    if (faceWidth > 0) {\n      const rawScore = (rightFullness + leftFullness) / 2;\n      const normalizedScore = (rawScore / faceWidth) * 100;\n      addMeasurement('cheekFullness', normalizedScore);\n    }\n  }\n\n  // CHIN WIDTH\n  // Measures horizontal width of the mental protuberance (chin bone)\n  // Uses left/right mentum lateralis landmarks (132, 361 in MediaPipe)\n  const leftMentumLat = getLandmark(landmarks, 'left_mentum_lateralis');\n  const rightMentumLat = getLandmark(landmarks, 'right_mentum_lateralis');\n\n  if (leftMentumLat && rightMentumLat && leftZygion && rightZygion) {\n    const chinWidth = distance(leftMentumLat, rightMentumLat);\n    const faceWidth = distance(leftZygion, rightZygion);\n    if (faceWidth > 0) {\n      const chinWidthPercent = (chinWidth / faceWidth) * 100;\n      addMeasurement('chinWidth', chinWidthPercent);\n    }\n  }\n\n  // EYEBROW THICKNESS\n  // Measures vertical height of eyebrow at thickest point\n  // Landmarks: brow top (66, 296) and brow bottom (46, 276)\n  const leftBrowTop = getLandmark(landmarks, 'left_supercilium_superior');  // 52 in mapping, but we need 66\n  const leftBrowBottom = getLandmark(landmarks, 'left_supercilium_apex');  // 105 in mapping, but we need 46\n  const rightBrowTop = getLandmark(landmarks, 'right_supercilium_superior');  // 282 in mapping, but we need 296\n  const rightBrowBottom = getLandmark(landmarks, 'right_supercilium_apex');  // 334 in mapping, but we need 276\n\n  if (leftBrowTop && leftBrowBottom && rightBrowTop && rightBrowBottom && leftCanthusM && leftCanthusL) {\n    const leftThickness = distance(leftBrowTop, leftBrowBottom);\n    const rightThickness = distance(rightBrowTop, rightBrowBottom);\n    const avgThickness = (leftThickness + rightThickness) / 2;\n\n    // Normalize by eye height to make scale-invariant\n    const leftPalpSup = getLandmark(landmarks, 'left_palpebra_superior');\n    const leftPalpInf = getLandmark(landmarks, 'left_palpebra_inferior');\n    if (leftPalpSup && leftPalpInf) {\n      const eyeHeight = distance(leftPalpSup, leftPalpInf);\n      if (eyeHeight > 0) {\n        const normalizedThickness = (avgThickness / eyeHeight) * 10.0;  // Scale factor\n        addMeasurement('eyebrowThickness', normalizedThickness);\n      }\n    }\n  }\n\n  // UPPER EYELID EXPOSURE\n  // Measures visible skin between eyelash line and eyelid crease\n  // Landmarks: crease (27, 257) and lid top/lash line (159, 386)\n  if (leftCanthusM && leftCanthusL) {\n    const leftPalpSup = getLandmark(landmarks, 'left_palpebra_superior');\n    const leftPalpInf = getLandmark(landmarks, 'left_palpebra_inferior');\n    const leftCrease = getLandmark(landmarks, 'left_pretarsal_skin_crease');\n\n    if (leftPalpSup && leftPalpInf && leftCrease) {\n      // Distance from brow bone/crease to lash line\n      const lidGap = distance(leftCrease, leftPalpSup);\n\n      // Normalize by total eye opening height\n      const eyeOpen = distance(leftPalpSup, leftPalpInf);\n      if (eyeOpen > 0) {\n        const exposure = lidGap / eyeOpen;\n        addMeasurement('upperEyelidExposure', exposure);\n      }\n    }\n  }\n\n  // TEAR TROUGH DEPTH\n  // Placeholder metric: Default to 0.2 (clean/good) since we can't measure depth from 2D landmarks\n  // Future upgrade: Implement OpenCV color sampler to detect darkness under eyes\n  // For now, assign a neutral/good value so it doesn't unfairly penalize users\n  addMeasurement('tearTroughDepth', 0.2);\n\n  // Calculate category scores\n  const categoryScores: Record<string, { total: number; count: number }> = {};\n  for (const m of measurements) {\n    if (!categoryScores[m.category]) {\n      categoryScores[m.category] = { total: 0, count: 0 };\n    }\n    categoryScores[m.category].total += m.standardizedScore;\n    categoryScores[m.category].count++;\n  }\n\n  const categoryAvg: Record<string, number> = {};\n  for (const [cat, data] of Object.entries(categoryScores)) {\n    categoryAvg[cat] = data.count > 0 ? data.total / data.count : 0;\n  }\n\n  // Calculate overall score (weighted average)\n  let totalWeight = 0;\n  let weightedSum = 0;\n  for (const m of measurements) {\n    const config = METRIC_CONFIGS[m.metricId];\n    if (config) {\n      weightedSum += m.standardizedScore * config.weight;\n      totalWeight += config.weight;\n    }\n  }\n\n  const overallScore = totalWeight > 0 ? weightedSum / totalWeight : 0;\n  const standardizedScoreValue = overallScore;\n\n  return {\n    measurements,\n    overallScore,\n    standardizedScore: standardizedScoreValue,\n    qualityTier: getQualityTier(overallScore),\n    categoryScores: categoryAvg,\n  };\n}\n\n// ============================================\n// SIDE PROFILE ANALYSIS\n// ============================================\n\n/**\n * Calculate all side profile measurements from landmarks.\n * Now supports ethnicity-specific ideal ranges for more accurate scoring.\n */\nexport function analyzeSideProfile(\n  landmarks: LandmarkPoint[],\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'other'\n): SideProfileResults {\n  const measurements: MetricScoreResult[] = [];\n  const demographics: DemographicOptions = { gender, ethnicity };\n\n  const addMeasurement = (metricId: string, value: number | null) => {\n    if (value !== null) {\n      const result = scoreMeasurement(metricId, value, demographics);\n      if (result) measurements.push(result);\n    }\n  };\n\n  // Get key landmarks\n  const glabella = getLandmark(landmarks, 'glabella');\n  const nasion = getLandmark(landmarks, 'nasion');\n  const rhinion = getLandmark(landmarks, 'rhinion');\n  const pronasale = getLandmark(landmarks, 'pronasale');\n  const columella = getLandmark(landmarks, 'columella');\n  const subnasale = getLandmark(landmarks, 'subnasale');\n  const labraleSuperius = getLandmark(landmarks, 'labraleSuperius');\n  const labraleInferius = getLandmark(landmarks, 'labraleInferius');\n  const sublabiale = getLandmark(landmarks, 'sublabiale');\n  const pogonion = getLandmark(landmarks, 'pogonion');\n  const menton = getLandmark(landmarks, 'menton');\n  const tragus = getLandmark(landmarks, 'tragus');\n  const gonionBottom = getLandmark(landmarks, 'gonionBottom');\n  const cervicalPoint = getLandmark(landmarks, 'cervicalPoint');\n  const orbitale = getLandmark(landmarks, 'orbitale');\n  const porion = getLandmark(landmarks, 'porion');\n\n  // GONIAL ANGLE\n  if (tragus && gonionBottom && menton) {\n    const angle = calculateAngle(tragus, gonionBottom, menton);\n    addMeasurement('gonialAngle', angle);\n  }\n\n  // NASOLABIAL ANGLE\n  if (columella && subnasale && labraleSuperius) {\n    const angle = calculateAngle(columella, subnasale, labraleSuperius);\n    addMeasurement('nasolabialAngle', angle);\n  }\n\n  // NASOFRONTAL ANGLE\n  if (glabella && nasion && rhinion) {\n    const angle = calculateAngle(glabella, nasion, rhinion);\n    addMeasurement('nasofrontalAngle', angle);\n  }\n\n  // MENTOLABIAL ANGLE\n  if (labraleInferius && sublabiale && pogonion) {\n    const angle = calculateAngle(labraleInferius, sublabiale, pogonion);\n    addMeasurement('mentolabialAngle', angle);\n  }\n\n  // E-LINE MEASUREMENTS (Ricketts)\n  // E-line runs from pronasale (nose tip) to soft tissue pogonion (chin)\n  // Sign convention: positive = in front of line, negative = behind\n  // perpendicularDistance returns positive for behind, so we negate\n  if (pronasale && pogonion && labraleSuperius && labraleInferius) {\n    const upperLipDist = perpendicularDistance(labraleSuperius, pronasale, pogonion);\n    const lowerLipDist = perpendicularDistance(labraleInferius, pronasale, pogonion);\n    // Negate to match sign convention (positive = protruding/in front)\n    addMeasurement('eLineUpperLip', -upperLipDist);\n    addMeasurement('eLineLowerLip', -lowerLipDist);\n  }\n\n  // BURSTONE LINE MEASUREMENTS\n  // Burstone line runs from subnasale to soft tissue pogonion\n  // Sign convention: negative = behind line (ideal is -4.7 to -2.3 for upper, -2.8 to -1.2 for lower)\n  if (subnasale && pogonion && labraleSuperius && labraleInferius) {\n    const upperLipBurstone = perpendicularDistance(labraleSuperius, subnasale, pogonion);\n    const lowerLipBurstone = perpendicularDistance(labraleInferius, subnasale, pogonion);\n    // Negate to match sign convention (negative = behind)\n    addMeasurement('burstoneUpperLip', -upperLipBurstone);\n    addMeasurement('burstoneLowerLip', -lowerLipBurstone);\n  }\n\n  // S-LINE MEASUREMENTS (Steiner)\n  // S-line runs from columella (or subnasale) to soft tissue pogonion\n  // Sign convention: positive = in front of line, negative = behind\n  const sLineStart = columella || subnasale;\n  if (sLineStart && pogonion && labraleSuperius && labraleInferius) {\n    const upperLipSLine = perpendicularDistance(labraleSuperius, sLineStart, pogonion);\n    const lowerLipSLine = perpendicularDistance(labraleInferius, sLineStart, pogonion);\n    // Negate to match sign convention (positive = protruding/in front)\n    addMeasurement('sLineUpperLip', -upperLipSLine);\n    addMeasurement('sLineLowerLip', -lowerLipSLine);\n  }\n\n  // HOLDAWAY H-LINE MEASUREMENT\n  // H-line runs from upper lip (labrale superius) to soft tissue pogonion\n  // Measures lower lip distance from this line\n  // Sign convention: positive = in front of line (ideal 0-4mm)\n  if (labraleSuperius && pogonion && labraleInferius) {\n    const lowerLipHLine = perpendicularDistance(labraleInferius, labraleSuperius, pogonion);\n    // Negate to match sign convention (positive = protruding/in front)\n    addMeasurement('holdawayHLine', -lowerLipHLine);\n  }\n\n  // NASOMENTAL ANGLE\n  if (nasion && pronasale && pogonion) {\n    const angle = calculateAngle(nasion, pronasale, pogonion);\n    addMeasurement('nasomentaAngle', angle);\n  }\n\n  // FACIAL CONVEXITY (GLABELLA)\n  if (glabella && subnasale && pogonion) {\n    const angle = calculateAngle(glabella, subnasale, pogonion);\n    addMeasurement('facialConvexityGlabella', angle);\n  }\n\n  // FACIAL CONVEXITY (NASION)\n  if (nasion && subnasale && pogonion) {\n    const angle = calculateAngle(nasion, subnasale, pogonion);\n    addMeasurement('facialConvexityNasion', angle);\n  }\n\n  // TOTAL FACIAL CONVEXITY\n  if (glabella && pronasale && pogonion) {\n    const angle = calculateAngle(glabella, pronasale, pogonion);\n    addMeasurement('totalFacialConvexity', angle);\n  }\n\n  // SUBMENTAL CERVICAL ANGLE\n  if (menton && cervicalPoint && pogonion) {\n    const neckPoint = getLandmark(landmarks, 'neckPoint');\n    if (neckPoint) {\n      const angle = calculateAngle(pogonion, menton, neckPoint);\n      addMeasurement('submentalCervicalAngle', angle);\n    }\n  }\n\n  // NASAL PROJECTION (Goode ratio)\n  if (pronasale && subnasale && nasion) {\n    const projection = distance(pronasale, subnasale);\n    const nasalLength = distance(nasion, pronasale);\n    if (nasalLength > 0) {\n      addMeasurement('nasalProjection', projection / nasalLength);\n    }\n  }\n\n  // NASOFACIAL ANGLE\n  if (nasion && pronasale && pogonion) {\n    // Angle between nose dorsum and facial plane\n    const nasalDorsum = { x: pronasale.x - nasion.x, y: pronasale.y - nasion.y };\n    const facialPlane = { x: pogonion.x - nasion.x, y: pogonion.y - nasion.y };\n\n    const dot = nasalDorsum.x * facialPlane.x + nasalDorsum.y * facialPlane.y;\n    const mag1 = Math.sqrt(nasalDorsum.x ** 2 + nasalDorsum.y ** 2);\n    const mag2 = Math.sqrt(facialPlane.x ** 2 + facialPlane.y ** 2);\n\n    if (mag1 > 0 && mag2 > 0) {\n      const angle = Math.acos(dot / (mag1 * mag2)) * (180 / Math.PI);\n      addMeasurement('nasofacialAngle', angle);\n    }\n  }\n\n  // MANDIBULAR PLANE ANGLE (using Frankfort horizontal)\n  if (porion && orbitale && gonionBottom && menton) {\n    // Frankfort horizontal is porion to orbitale\n    // Mandibular plane is gonion to menton\n    const fhAngle = Math.atan2(orbitale.y - porion.y, orbitale.x - porion.x);\n    const mpAngle = Math.atan2(menton.y - gonionBottom.y, menton.x - gonionBottom.x);\n    const angle = Math.abs(fhAngle - mpAngle) * (180 / Math.PI);\n    addMeasurement('mandibularPlaneAngle', angle);\n  }\n\n  // CHIN PROJECTION\n  if (pogonion && subnasale) {\n    // Distance from pogonion to vertical line through subnasale\n    const projection = pogonion.x - subnasale.x;\n    addMeasurement('chinProjection', projection);\n  }\n\n  // Calculate category scores\n  const categoryScores: Record<string, { total: number; count: number }> = {};\n  for (const m of measurements) {\n    if (!categoryScores[m.category]) {\n      categoryScores[m.category] = { total: 0, count: 0 };\n    }\n    categoryScores[m.category].total += m.standardizedScore;\n    categoryScores[m.category].count++;\n  }\n\n  const categoryAvg: Record<string, number> = {};\n  for (const [cat, data] of Object.entries(categoryScores)) {\n    categoryAvg[cat] = data.count > 0 ? data.total / data.count : 0;\n  }\n\n  // Calculate overall score\n  let totalWeight = 0;\n  let weightedSum = 0;\n  for (const m of measurements) {\n    const config = METRIC_CONFIGS[m.metricId];\n    if (config) {\n      weightedSum += m.standardizedScore * config.weight;\n      totalWeight += config.weight;\n    }\n  }\n\n  const overallScore = totalWeight > 0 ? weightedSum / totalWeight : 0;\n\n  return {\n    measurements,\n    overallScore,\n    standardizedScore: overallScore,\n    qualityTier: getQualityTier(overallScore),\n    categoryScores: categoryAvg,\n  };\n}\n\n// ============================================\n// COMPLETE HARMONY ANALYSIS\n// ============================================\n\n/**\n * Run complete facial harmony analysis.\n * Now supports ethnicity-specific ideal ranges for more accurate scoring.\n */\nexport function analyzeHarmony(\n  frontLandmarks: LandmarkPoint[],\n  sideLandmarks: LandmarkPoint[],\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'other'\n): HarmonyAnalysis {\n  const frontResults = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n  const sideResults = analyzeSideProfile(sideLandmarks, gender, ethnicity);\n\n  const allMeasurements = [...frontResults.measurements, ...sideResults.measurements];\n\n  // Combined category scores\n  const allCategories: Record<string, { total: number; count: number }> = {};\n  for (const m of allMeasurements) {\n    if (!allCategories[m.category]) {\n      allCategories[m.category] = { total: 0, count: 0 };\n    }\n    allCategories[m.category].total += m.standardizedScore;\n    allCategories[m.category].count++;\n  }\n\n  const categoryScores: Record<string, number> = {};\n  for (const [cat, data] of Object.entries(allCategories)) {\n    categoryScores[cat] = data.count > 0 ? data.total / data.count : 0;\n  }\n\n  // Overall weighted score\n  let totalWeight = 0;\n  let weightedSum = 0;\n  for (const m of allMeasurements) {\n    const config = METRIC_CONFIGS[m.metricId];\n    if (config) {\n      weightedSum += m.standardizedScore * config.weight;\n      totalWeight += config.weight;\n    }\n  }\n\n  const overallScore = totalWeight > 0 ? weightedSum / totalWeight : 0;\n\n  // Identify flaws (below average measurements)\n  const flaws: FlawAssessment[] = allMeasurements\n    .filter((m) => m.severity !== 'optimal' && m.severity !== 'minor')\n    .map((m) => ({\n      category: m.category,\n      metricId: m.metricId,\n      metricName: m.name,\n      severity: m.severity,\n      deviation: `${m.deviation.toFixed(2)} ${m.deviationDirection} ideal`,\n      reasoning: `${m.name} is outside the ideal range`,\n      confidence: m.severity === 'extremely_severe' || m.severity === 'severe'\n        ? 'confirmed' as const\n        : 'likely' as const,\n    }))\n    .sort((a, b) => {\n      const severityOrder = { extremely_severe: 0, severe: 1, major: 2, moderate: 3 };\n      return (severityOrder[a.severity as keyof typeof severityOrder] ?? 4) -\n             (severityOrder[b.severity as keyof typeof severityOrder] ?? 4);\n    });\n\n  // Identify strengths (ideal measurements)\n  const strengths: StrengthAssessment[] = allMeasurements\n    .filter((m) => m.qualityTier === 'ideal' || m.qualityTier === 'excellent')\n    .map((m) => ({\n      category: m.category,\n      metricId: m.metricId,\n      metricName: m.name,\n      qualityTier: m.qualityTier,\n      value: m.value,\n      reasoning: `${m.name} is within the ${m.qualityTier} range`,\n    }));\n\n  // Calculate percentile (based on population stats)\n  const percentile = calculateHarmonyPercentile(overallScore);\n\n  return {\n    overallScore,\n    standardizedScore: overallScore,\n    qualityTier: getQualityTier(overallScore),\n    percentile,\n    frontScore: frontResults.overallScore,\n    sideScore: sideResults.overallScore,\n    categoryScores,\n    measurements: allMeasurements,\n    flaws,\n    strengths,\n  };\n}\n","numLines":760,"startLine":1,"totalLines":760}}}
{"parentUuid":"7167c7ce-fec4-4caf-ac7a-19c9d360e7c7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YKxzoRR6jLV98KAFJHZZnf","type":"message","role":"assistant","content":[{"type":"text","text":"Let me search for where scores might exceed 10 in a different way - looking at the ResponsibleRatio type and any places where scores are not clamped:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":34,"cache_creation_input_tokens":12392,"cache_read_input_tokens":89369,"cache_creation":{"ephemeral_5m_input_tokens":12392,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWUrTfbeDyi9PtMe77YJo","type":"assistant","uuid":"d21a0221-0e60-4e46-99be-bfc279c96389","timestamp":"2025-12-26T06:49:59.269Z"}
{"parentUuid":"d21a0221-0e60-4e46-99be-bfc279c96389","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YKxzoRR6jLV98KAFJHZZnf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CJu4JQMCa1xpq3yxYDkVqd","name":"Grep","input":{"pattern":"responsibleRatios|ResponsibleRatio","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":34,"cache_creation_input_tokens":12392,"cache_read_input_tokens":89369,"cache_creation":{"ephemeral_5m_input_tokens":12392,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWUrTfbeDyi9PtMe77YJo","type":"assistant","uuid":"a00fd2dd-7d65-4b76-be24-5236a1179081","timestamp":"2025-12-26T06:50:01.242Z"}
{"parentUuid":"a00fd2dd-7d65-4b76-be24-5236a1179081","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YKxzoRR6jLV98KAFJHZZnf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UUZj1hTjUvkjTMH2MBmfdK","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":34,"cache_creation_input_tokens":12392,"cache_read_input_tokens":89369,"cache_creation":{"ephemeral_5m_input_tokens":12392,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWUrTfbeDyi9PtMe77YJo","type":"assistant","uuid":"fd54e02d-f00a-44bc-af1f-72061630b5bc","timestamp":"2025-12-26T06:50:01.960Z"}
{"parentUuid":"fd54e02d-f00a-44bc-af1f-72061630b5bc","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UUZj1hTjUvkjTMH2MBmfdK","type":"tool_result","content":"     1→/**\n     2→ * Harmony-Style Results Page Types\n     3→ * Complete type definitions for the results UI\n     4→ */\n     5→\n     6→import { QualityTier, SeverityLevel, MeasurementUnit } from '@/lib/harmony-scoring';\n     7→\n     8→// ============================================\n     9→// ILLUSTRATION TYPES\n    10→// ============================================\n    11→\n    12→export interface IllustrationPoint {\n    13→  type: 'landmark' | 'calculated';\n    14→  landmarkId?: string;\n    15→  x?: number;\n    16→  y?: number;\n    17→  label?: string;\n    18→}\n    19→\n    20→export interface IllustrationLine {\n    21→  from: string;\n    22→  to: string;\n    23→  color: string;\n    24→  style?: 'solid' | 'dashed';\n    25→  label?: string;\n    26→  labelColor?: string;\n    27→  labelPosition?: 'start' | 'middle' | 'end';\n    28→}\n    29→\n    30→export interface RatioIllustration {\n    31→  points: Record<string, IllustrationPoint>;\n    32→  lines: Record<string, IllustrationLine>;\n    33→}\n    34→\n    35→// ============================================\n    36→// RATIO/MEASUREMENT TYPES\n    37→// ============================================\n    38→\n    39→export interface Ratio {\n    40→  id: string;\n    41→  name: string;\n    42→  value: number;\n    43→  score: number;  // 0-10 scale\n    44→  standardizedScore: number;\n    45→  unit: 'x' | 'mm' | '%' | '°';\n    46→  idealMin: number;\n    47→  idealMax: number;\n    48→  rangeMin: number;\n    49→  rangeMax: number;\n    50→  description: string;\n    51→  category: string;\n    52→  qualityLevel: QualityTier;\n    53→  severity: SeverityLevel;\n    54→  illustration: RatioIllustration;\n    55→  mayIndicateFlaws: string[];\n    56→  mayIndicateStrengths: string[];\n    57→  usedLandmarks: string[];\n    58→  scoringCurveConfig?: {\n    59→    decayRate: number;\n    60→    maxScore: number;\n    61→  };\n    62→  // Harmony Taxonomy classification\n    63→  taxonomyPrimary?: string;    // 'harmony' | 'dimorphism' | 'angularity' | 'features'\n    64→  taxonomySecondary?: string;  // Subcategory ID\n    65→}\n    66→\n    67→// ============================================\n    68→// STRENGTH/FLAW TYPES\n    69→// ============================================\n    70→\n    71→export interface ResponsibleRatio {\n    72→  ratioName: string;\n    73→  ratioId: string;\n    74→  score: number;\n    75→  value: number;\n    76→  isObfuscated?: boolean;\n    77→  // Additional properties for AI descriptions\n    78→  idealMin: number;\n    79→  idealMax: number;\n    80→  unit: string;\n    81→  category?: string;\n    82→}\n    83→\n    84→export interface Strength {\n    85→  id: string;\n    86→  strengthName: string;\n    87→  summary: string;\n    88→  avgScore: number;\n    89→  qualityLevel: QualityTier;\n    90→  categoryName: string;\n    91→  responsibleRatios: ResponsibleRatio[];\n    92→}\n    93→\n    94→export interface Flaw {\n    95→  id: string;\n    96→  flawName: string;\n    97→  summary: string;\n    98→  harmonyPercentageLost: number;\n    99→  standardizedImpact: number;\n   100→  categoryName: string;\n   101→  isOther?: boolean;\n   102→  responsibleRatios: ResponsibleRatio[];\n   103→  rollingPointsDeducted?: number;\n   104→  rollingHarmonyPercentageLost?: number;\n   105→  rollingStandardizedImpact?: number;\n   106→}\n   107→\n   108→// ============================================\n   109→// RECOMMENDATION TYPES\n   110→// ============================================\n   111→\n   112→export type RecommendationPhase = 'Surgical' | 'Minimally Invasive' | 'Foundational';\n   113→\n   114→export interface RecommendationTimeline {\n   115→  effect_start: 'immediate' | 'delayed' | 'gradual';\n   116→  full_results_weeks: number;\n   117→  full_results_weeks_max?: number;\n   118→}\n   119→\n   120→export interface RecommendationCost {\n   121→  type: 'flat' | 'per_month' | 'per_session';\n   122→  min: number;\n   123→  max: number;\n   124→  currency: string;\n   125→}\n   126→\n   127→export interface RatioImpact {\n   128→  ratioId: string;\n   129→  ratioName: string;\n   130→  direction: 'increase' | 'decrease' | 'both';\n   131→  percentageEffect: number;\n   132→}\n   133→\n   134→export interface Recommendation {\n   135→  ref_id: string;\n   136→  name: string;\n   137→  description: string;\n   138→  phase: RecommendationPhase;\n   139→  impact: number;  // 0-1 effectiveness score\n   140→  coverage: number;  // Number of metrics improved\n   141→  percentage: string;  // e.g., \"10-20%\"\n   142→  expectedImprovementRange?: { min: number; max: number };\n   143→  matchedFlaws: string[];\n   144→  matchedRatios: string[];\n   145→  ratios_impacted: RatioImpact[];\n   146→  timeline: RecommendationTimeline;\n   147→  cost: RecommendationCost;\n   148→  risks_side_effects: string | null;\n   149→  warnings: string[];\n   150→  gender: 'male' | 'female' | 'both';\n   151→}\n   152→\n   153→// ============================================\n   154→// HARMONY ANALYSIS TYPES\n   155→// ============================================\n   156→\n   157→export interface ProfileAnalysis {\n   158→  standardizedScore: number;\n   159→  ratios: Ratio[];\n   160→  overallAIDescription?: string | null;\n   161→}\n   162→\n   163→export interface FullHarmonyAnalysis {\n   164→  standardizedScore: number;\n   165→  front: ProfileAnalysis;\n   166→  side: ProfileAnalysis;\n   167→  strengths: Strength[];\n   168→  flaws: Flaw[];\n   169→}\n   170→\n   171→// ============================================\n   172→// FACE DATA TYPES\n   173→// ============================================\n   174→\n   175→export interface FaceData {\n   176→  id: string;\n   177→  userId?: string;\n   178→  frontPhotoUrl: string;\n   179→  sidePhotoUrl?: string;\n   180→  harmonyScore: number | null;\n   181→  frontHarmonyScore: number | null;\n   182→  sideHarmonyScore: number | null;\n   183→  gender: 'male' | 'female';\n   184→  race?: string;\n   185→  unlocked: boolean;\n   186→  actionPlanUnlocked: boolean;\n   187→  harmonyAnalysis: FullHarmonyAnalysis;\n   188→}\n   189→\n   190→// ============================================\n   191→// UI STATE TYPES\n   192→// ============================================\n   193→\n   194→export type ResultsTab =\n   195→  | 'overview'\n   196→  | 'front-ratios'\n   197→  | 'side-ratios'\n   198→  | 'leaderboard'\n   199→  | 'psl'\n   200→  | 'archetype'\n   201→  | 'plan'\n   202→  | 'community'\n   203→  | 'options'\n   204→  | 'support';\n   205→\n   206→// ============================================\n   207→// LEADERBOARD TYPES\n   208→// ============================================\n   209→\n   210→export interface UserRank {\n   211→  userId: string;\n   212→  score: number;\n   213→  globalRank: number;\n   214→  genderRank: number;\n   215→  percentile: number;\n   216→  totalUsers: number;\n   217→  genderTotal: number;\n   218→  anonymousName: string;\n   219→  updatedAt: string;\n   220→}\n   221→\n   222→export interface LeaderboardEntry {\n   223→  userId: string;\n   224→  rank: number;\n   225→  score: number;\n   226→  anonymousName: string;\n   227→  gender: 'male' | 'female';\n   228→  facePhotoUrl: string | null;\n   229→  isCurrentUser: boolean;\n   230→}\n   231→\n   232→export interface UserProfile extends Omit<LeaderboardEntry, 'isCurrentUser'> {\n   233→  topStrengths: string[];\n   234→  topImprovements: string[];\n   235→}\n   236→\n   237→export interface LeaderboardData {\n   238→  entries: LeaderboardEntry[];\n   239→  totalCount: number;\n   240→  userRank: UserRank | null;\n   241→}\n   242→\n   243→export interface ResultsUIState {\n   244→  activeTab: ResultsTab;\n   245→  expandedMeasurementId: string | null;\n   246→  selectedVisualizationMetric: string | null;\n   247→  categoryFilter: string | null;\n   248→  showLandmarkOverlay: boolean;\n   249→}\n   250→\n   251→// ============================================\n   252→// CATEGORY TYPES\n   253→// ============================================\n   254→\n   255→export interface MeasurementCategory {\n   256→  id: string;\n   257→  name: string;\n   258→  color: string;\n   259→  description: string;\n   260→}\n   261→\n   262→export const MEASUREMENT_CATEGORIES: MeasurementCategory[] = [\n   263→  { id: 'midface', name: 'Midface/Face Shape', color: '#67e8f9', description: 'Facial proportions and overall shape' },\n   264→  { id: 'jaw-growth', name: 'Occlusion/Jaw Growth', color: '#a78bfa', description: 'Jaw development and bite alignment' },\n   265→  { id: 'jaw-shape', name: 'Jaw Shape', color: '#f97316', description: 'Jawline contour and angles' },\n   266→  { id: 'upper-third', name: 'Upper Third', color: '#84cc16', description: 'Forehead and hairline proportions' },\n   267→  { id: 'eyes', name: 'Eyes', color: '#06b6d4', description: 'Eye shape, spacing, and canthal tilt' },\n   268→  { id: 'nose', name: 'Nose', color: '#fbbf24', description: 'Nasal proportions and angles' },\n   269→  { id: 'lips', name: 'Lips', color: '#ec4899', description: 'Lip proportions and projection' },\n   270→  { id: 'chin', name: 'Chin', color: '#ef4444', description: 'Chin projection and shape' },\n   271→  { id: 'neck', name: 'Neck', color: '#14b8a6', description: 'Neck angle and throat definition' },\n   272→  { id: 'other', name: 'Other', color: '#6b7280', description: 'Additional measurements' },\n   273→];\n   274→\n   275→// ============================================\n   276→// SCORE COLOR HELPERS\n   277→// ============================================\n   278→\n   279→export function getScoreColor(score: number): string {\n   280→  if (score >= 8) return '#67e8f9';  // Cyan - ideal\n   281→  if (score >= 6) return '#22c55e';  // Green - good\n   282→  if (score >= 4) return '#fbbf24';  // Yellow - fair\n   283→  return 'rgb(227, 67, 67)';         // Red - poor\n   284→}\n   285→\n   286→export function getQualityColor(quality: QualityTier): string {\n   287→  switch (quality) {\n   288→    case 'ideal': return '#67e8f9';\n   289→    case 'excellent': return '#22c55e';\n   290→    case 'good': return '#fbbf24';\n   291→    case 'below_average': return 'rgb(227, 67, 67)';\n   292→    default: return '#6b7280';\n   293→  }\n   294→}\n   295→\n   296→export function getSeverityColor(severity: SeverityLevel): string {\n   297→  switch (severity) {\n   298→    case 'optimal': return '#67e8f9';\n   299→    case 'minor': return '#22c55e';\n   300→    case 'moderate': return '#fbbf24';\n   301→    case 'major': return '#f97316';\n   302→    case 'severe': return '#ef4444';\n   303→    case 'extremely_severe': return '#dc2626';\n   304→    default: return '#6b7280';\n   305→  }\n   306→}\n   307→\n   308→export function getCategoryColor(categoryName: string): string {\n   309→  const cat = MEASUREMENT_CATEGORIES.find(c =>\n   310→    c.name.toLowerCase().includes(categoryName.toLowerCase()) ||\n   311→    categoryName.toLowerCase().includes(c.name.toLowerCase())\n   312→  );\n   313→  return cat?.color || '#6b7280';\n   314→}\n   315→\n   316→// ============================================\n   317→// UNIT FORMATTING\n   318→// ============================================\n   319→\n   320→export function formatUnit(unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n   321→  switch (unit) {\n   322→    case 'x':\n   323→    case 'ratio': return 'x';\n   324→    case 'mm': return 'mm';\n   325→    case '%':\n   326→    case 'percent': return '%';\n   327→    case '°':\n   328→    case 'degrees': return '°';\n   329→    default: return '';\n   330→  }\n   331→}\n   332→\n   333→export function formatValue(value: number, unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n   334→  const unitStr = formatUnit(unit);\n   335→  if (unit === '%' || unit === 'percent') {\n   336→    return `${value.toFixed(1)}${unitStr}`;\n   337→  }\n   338→  if (unit === '°' || unit === 'degrees') {\n   339→    return `${value.toFixed(1)}${unitStr}`;\n   340→  }\n   341→  return `${value.toFixed(2)}${unitStr}`;\n   342→}\n   343→\n   344→// ============================================\n   345→// PRODUCT & SUPPLEMENT TYPES\n   346→// ============================================\n   347→\n   348→export interface Product {\n   349→  id: string;\n   350→  name: string;\n   351→  brand: string;\n   352→  category: \"skin\" | \"hair\" | \"anti-aging\" | \"hormonal\" | \"bone\" | \"general\";\n   353→  affiliateLink: string;\n   354→  affiliateType: \"amazon\" | \"direct\";\n   355→  supplementId: string;\n   356→  priority: number;\n   357→  baseStackItem?: boolean;\n   358→}\n   359→\n   360→export interface ProductRecommendation {\n   361→  product: Product;\n   362→  state: \"flaw\" | \"ideal\";\n   363→  targetMetric: string;\n   364→  message: string;\n   365→  urgency: \"high\" | \"medium\" | \"low\";\n   366→  matchedMetrics: string[];\n   367→}\n   368→\n   369→export interface DailyStack {\n   370→  products: Product[];\n   371→  totalCostPerMonth: { min: number; max: number };\n   372→  timing: {\n   373→    morning: Product[];\n   374→    evening: Product[];\n   375→    anytime: Product[];\n   376→  };\n   377→  rationale: string;\n   378→}\n   379→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2bc22cf0-7e0a-4cc4-bf30-5be749ab14a4","timestamp":"2025-12-26T06:50:02.060Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","content":"/**\n * Harmony-Style Results Page Types\n * Complete type definitions for the results UI\n */\n\nimport { QualityTier, SeverityLevel, MeasurementUnit } from '@/lib/harmony-scoring';\n\n// ============================================\n// ILLUSTRATION TYPES\n// ============================================\n\nexport interface IllustrationPoint {\n  type: 'landmark' | 'calculated';\n  landmarkId?: string;\n  x?: number;\n  y?: number;\n  label?: string;\n}\n\nexport interface IllustrationLine {\n  from: string;\n  to: string;\n  color: string;\n  style?: 'solid' | 'dashed';\n  label?: string;\n  labelColor?: string;\n  labelPosition?: 'start' | 'middle' | 'end';\n}\n\nexport interface RatioIllustration {\n  points: Record<string, IllustrationPoint>;\n  lines: Record<string, IllustrationLine>;\n}\n\n// ============================================\n// RATIO/MEASUREMENT TYPES\n// ============================================\n\nexport interface Ratio {\n  id: string;\n  name: string;\n  value: number;\n  score: number;  // 0-10 scale\n  standardizedScore: number;\n  unit: 'x' | 'mm' | '%' | '°';\n  idealMin: number;\n  idealMax: number;\n  rangeMin: number;\n  rangeMax: number;\n  description: string;\n  category: string;\n  qualityLevel: QualityTier;\n  severity: SeverityLevel;\n  illustration: RatioIllustration;\n  mayIndicateFlaws: string[];\n  mayIndicateStrengths: string[];\n  usedLandmarks: string[];\n  scoringCurveConfig?: {\n    decayRate: number;\n    maxScore: number;\n  };\n  // Harmony Taxonomy classification\n  taxonomyPrimary?: string;    // 'harmony' | 'dimorphism' | 'angularity' | 'features'\n  taxonomySecondary?: string;  // Subcategory ID\n}\n\n// ============================================\n// STRENGTH/FLAW TYPES\n// ============================================\n\nexport interface ResponsibleRatio {\n  ratioName: string;\n  ratioId: string;\n  score: number;\n  value: number;\n  isObfuscated?: boolean;\n  // Additional properties for AI descriptions\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category?: string;\n}\n\nexport interface Strength {\n  id: string;\n  strengthName: string;\n  summary: string;\n  avgScore: number;\n  qualityLevel: QualityTier;\n  categoryName: string;\n  responsibleRatios: ResponsibleRatio[];\n}\n\nexport interface Flaw {\n  id: string;\n  flawName: string;\n  summary: string;\n  harmonyPercentageLost: number;\n  standardizedImpact: number;\n  categoryName: string;\n  isOther?: boolean;\n  responsibleRatios: ResponsibleRatio[];\n  rollingPointsDeducted?: number;\n  rollingHarmonyPercentageLost?: number;\n  rollingStandardizedImpact?: number;\n}\n\n// ============================================\n// RECOMMENDATION TYPES\n// ============================================\n\nexport type RecommendationPhase = 'Surgical' | 'Minimally Invasive' | 'Foundational';\n\nexport interface RecommendationTimeline {\n  effect_start: 'immediate' | 'delayed' | 'gradual';\n  full_results_weeks: number;\n  full_results_weeks_max?: number;\n}\n\nexport interface RecommendationCost {\n  type: 'flat' | 'per_month' | 'per_session';\n  min: number;\n  max: number;\n  currency: string;\n}\n\nexport interface RatioImpact {\n  ratioId: string;\n  ratioName: string;\n  direction: 'increase' | 'decrease' | 'both';\n  percentageEffect: number;\n}\n\nexport interface Recommendation {\n  ref_id: string;\n  name: string;\n  description: string;\n  phase: RecommendationPhase;\n  impact: number;  // 0-1 effectiveness score\n  coverage: number;  // Number of metrics improved\n  percentage: string;  // e.g., \"10-20%\"\n  expectedImprovementRange?: { min: number; max: number };\n  matchedFlaws: string[];\n  matchedRatios: string[];\n  ratios_impacted: RatioImpact[];\n  timeline: RecommendationTimeline;\n  cost: RecommendationCost;\n  risks_side_effects: string | null;\n  warnings: string[];\n  gender: 'male' | 'female' | 'both';\n}\n\n// ============================================\n// HARMONY ANALYSIS TYPES\n// ============================================\n\nexport interface ProfileAnalysis {\n  standardizedScore: number;\n  ratios: Ratio[];\n  overallAIDescription?: string | null;\n}\n\nexport interface FullHarmonyAnalysis {\n  standardizedScore: number;\n  front: ProfileAnalysis;\n  side: ProfileAnalysis;\n  strengths: Strength[];\n  flaws: Flaw[];\n}\n\n// ============================================\n// FACE DATA TYPES\n// ============================================\n\nexport interface FaceData {\n  id: string;\n  userId?: string;\n  frontPhotoUrl: string;\n  sidePhotoUrl?: string;\n  harmonyScore: number | null;\n  frontHarmonyScore: number | null;\n  sideHarmonyScore: number | null;\n  gender: 'male' | 'female';\n  race?: string;\n  unlocked: boolean;\n  actionPlanUnlocked: boolean;\n  harmonyAnalysis: FullHarmonyAnalysis;\n}\n\n// ============================================\n// UI STATE TYPES\n// ============================================\n\nexport type ResultsTab =\n  | 'overview'\n  | 'front-ratios'\n  | 'side-ratios'\n  | 'leaderboard'\n  | 'psl'\n  | 'archetype'\n  | 'plan'\n  | 'community'\n  | 'options'\n  | 'support';\n\n// ============================================\n// LEADERBOARD TYPES\n// ============================================\n\nexport interface UserRank {\n  userId: string;\n  score: number;\n  globalRank: number;\n  genderRank: number;\n  percentile: number;\n  totalUsers: number;\n  genderTotal: number;\n  anonymousName: string;\n  updatedAt: string;\n}\n\nexport interface LeaderboardEntry {\n  userId: string;\n  rank: number;\n  score: number;\n  anonymousName: string;\n  gender: 'male' | 'female';\n  facePhotoUrl: string | null;\n  isCurrentUser: boolean;\n}\n\nexport interface UserProfile extends Omit<LeaderboardEntry, 'isCurrentUser'> {\n  topStrengths: string[];\n  topImprovements: string[];\n}\n\nexport interface LeaderboardData {\n  entries: LeaderboardEntry[];\n  totalCount: number;\n  userRank: UserRank | null;\n}\n\nexport interface ResultsUIState {\n  activeTab: ResultsTab;\n  expandedMeasurementId: string | null;\n  selectedVisualizationMetric: string | null;\n  categoryFilter: string | null;\n  showLandmarkOverlay: boolean;\n}\n\n// ============================================\n// CATEGORY TYPES\n// ============================================\n\nexport interface MeasurementCategory {\n  id: string;\n  name: string;\n  color: string;\n  description: string;\n}\n\nexport const MEASUREMENT_CATEGORIES: MeasurementCategory[] = [\n  { id: 'midface', name: 'Midface/Face Shape', color: '#67e8f9', description: 'Facial proportions and overall shape' },\n  { id: 'jaw-growth', name: 'Occlusion/Jaw Growth', color: '#a78bfa', description: 'Jaw development and bite alignment' },\n  { id: 'jaw-shape', name: 'Jaw Shape', color: '#f97316', description: 'Jawline contour and angles' },\n  { id: 'upper-third', name: 'Upper Third', color: '#84cc16', description: 'Forehead and hairline proportions' },\n  { id: 'eyes', name: 'Eyes', color: '#06b6d4', description: 'Eye shape, spacing, and canthal tilt' },\n  { id: 'nose', name: 'Nose', color: '#fbbf24', description: 'Nasal proportions and angles' },\n  { id: 'lips', name: 'Lips', color: '#ec4899', description: 'Lip proportions and projection' },\n  { id: 'chin', name: 'Chin', color: '#ef4444', description: 'Chin projection and shape' },\n  { id: 'neck', name: 'Neck', color: '#14b8a6', description: 'Neck angle and throat definition' },\n  { id: 'other', name: 'Other', color: '#6b7280', description: 'Additional measurements' },\n];\n\n// ============================================\n// SCORE COLOR HELPERS\n// ============================================\n\nexport function getScoreColor(score: number): string {\n  if (score >= 8) return '#67e8f9';  // Cyan - ideal\n  if (score >= 6) return '#22c55e';  // Green - good\n  if (score >= 4) return '#fbbf24';  // Yellow - fair\n  return 'rgb(227, 67, 67)';         // Red - poor\n}\n\nexport function getQualityColor(quality: QualityTier): string {\n  switch (quality) {\n    case 'ideal': return '#67e8f9';\n    case 'excellent': return '#22c55e';\n    case 'good': return '#fbbf24';\n    case 'below_average': return 'rgb(227, 67, 67)';\n    default: return '#6b7280';\n  }\n}\n\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'optimal': return '#67e8f9';\n    case 'minor': return '#22c55e';\n    case 'moderate': return '#fbbf24';\n    case 'major': return '#f97316';\n    case 'severe': return '#ef4444';\n    case 'extremely_severe': return '#dc2626';\n    default: return '#6b7280';\n  }\n}\n\nexport function getCategoryColor(categoryName: string): string {\n  const cat = MEASUREMENT_CATEGORIES.find(c =>\n    c.name.toLowerCase().includes(categoryName.toLowerCase()) ||\n    categoryName.toLowerCase().includes(c.name.toLowerCase())\n  );\n  return cat?.color || '#6b7280';\n}\n\n// ============================================\n// UNIT FORMATTING\n// ============================================\n\nexport function formatUnit(unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n  switch (unit) {\n    case 'x':\n    case 'ratio': return 'x';\n    case 'mm': return 'mm';\n    case '%':\n    case 'percent': return '%';\n    case '°':\n    case 'degrees': return '°';\n    default: return '';\n  }\n}\n\nexport function formatValue(value: number, unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n  const unitStr = formatUnit(unit);\n  if (unit === '%' || unit === 'percent') {\n    return `${value.toFixed(1)}${unitStr}`;\n  }\n  if (unit === '°' || unit === 'degrees') {\n    return `${value.toFixed(1)}${unitStr}`;\n  }\n  return `${value.toFixed(2)}${unitStr}`;\n}\n\n// ============================================\n// PRODUCT & SUPPLEMENT TYPES\n// ============================================\n\nexport interface Product {\n  id: string;\n  name: string;\n  brand: string;\n  category: \"skin\" | \"hair\" | \"anti-aging\" | \"hormonal\" | \"bone\" | \"general\";\n  affiliateLink: string;\n  affiliateType: \"amazon\" | \"direct\";\n  supplementId: string;\n  priority: number;\n  baseStackItem?: boolean;\n}\n\nexport interface ProductRecommendation {\n  product: Product;\n  state: \"flaw\" | \"ideal\";\n  targetMetric: string;\n  message: string;\n  urgency: \"high\" | \"medium\" | \"low\";\n  matchedMetrics: string[];\n}\n\nexport interface DailyStack {\n  products: Product[];\n  totalCostPerMonth: { min: number; max: number };\n  timing: {\n    morning: Product[];\n    evening: Product[];\n    anytime: Product[];\n  };\n  rationale: string;\n}\n","numLines":379,"startLine":1,"totalLines":379}}}
{"parentUuid":"2bc22cf0-7e0a-4cc4-bf30-5be749ab14a4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CJu4JQMCa1xpq3yxYDkVqd","type":"tool_result","content":"src/types/results.ts:71:export interface ResponsibleRatio {\nsrc/types/results.ts:91:  responsibleRatios: ResponsibleRatio[];\nsrc/types/results.ts:102:  responsibleRatios: ResponsibleRatio[];"}]},"uuid":"504c1f58-9359-4272-a86b-d673e91af09b","timestamp":"2025-12-26T06:50:02.390Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"src/types/results.ts:71:export interface ResponsibleRatio {\nsrc/types/results.ts:91:  responsibleRatios: ResponsibleRatio[];\nsrc/types/results.ts:102:  responsibleRatios: ResponsibleRatio[];","numLines":3}}
{"parentUuid":"504c1f58-9359-4272-a86b-d673e91af09b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_017QBAc2wPGH99H7oeeRhkKG","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the `insights-engine.ts` which is mentioned as converting data to strength/flaw - this is where the `responsibleRatios.score` might not be clamped:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4565,"cache_creation_input_tokens":452,"cache_read_input_tokens":101761,"cache_creation":{"ephemeral_5m_input_tokens":452,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrUDQKhKA6PkMmEaUXP","type":"assistant","uuid":"f0648925-0c69-4d34-9600-a9b43b4f22b9","timestamp":"2025-12-26T06:50:06.282Z"}
{"parentUuid":"f0648925-0c69-4d34-9600-a9b43b4f22b9","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_017QBAc2wPGH99H7oeeRhkKG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01S6UG7cx7zWeMwhC3VeQidX","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4565,"cache_creation_input_tokens":452,"cache_read_input_tokens":101761,"cache_creation":{"ephemeral_5m_input_tokens":452,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrUDQKhKA6PkMmEaUXP","type":"assistant","uuid":"ca39d67b-bffb-4e2d-bcf9-07662afba5f0","timestamp":"2025-12-26T06:50:07.437Z"}
{"parentUuid":"ca39d67b-bffb-4e2d-bcf9-07662afba5f0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01S6UG7cx7zWeMwhC3VeQidX","type":"tool_result","content":"     1→/**\n     2→ * Insights Engine\n     3→ *\n     4→ * Processes insight definitions from insights.json and classifies them\n     5→ * as strengths or areas of improvement based on user's metric scores.\n     6→ *\n     7→ * Logic:\n     8→ * - For each insight definition, calculate average score of affected metrics\n     9→ * - Weakness: if avg score < threshold → classify with severity label\n    10→ * - Strength: if avg score > threshold → classify with grade label\n    11→ *\n    12→ * Z-Score Based 5-Tier Severity Logic:\n    13→ * - Ideal (Green): User is inside the ideal range\n    14→ * - Good (Blue): Within 0.5 Standard Deviation of the mean (|z| < 0.5)\n    15→ * - Fair (Cyan): Between 0.5 and 1 Standard Deviation (0.5 ≤ |z| < 1)\n    16→ * - Moderate (Yellow): Between 1 and 2 Standard Deviations (1 ≤ |z| < 2)\n    17→ * - Severe (Red): More than 2 Standard Deviations away (|z| ≥ 2)\n    18→ *\n    19→ * Severity Labels (Weaknesses):\n    20→ *   0-3 = \"Severe\"\n    21→ *   3-5 = \"Moderate\"\n    22→ *   5-7 = \"Minor\"\n    23→ *\n    24→ * Grade Labels (Strengths):\n    25→ *   8-9   = \"Good\"\n    26→ *   9-9.5 = \"Excellent\"\n    27→ *   9.5-10 = \"Ideal\"\n    28→ */\n    29→\n    30→import { Strength, Flaw } from '@/types/results';\n    31→import { MetricScoreResult, METRIC_CONFIGS, isValueAcceptable } from '@/lib/harmony-scoring';\n    32→\n    33→// ============================================\n    34→// MASTER SCORING DATABASE (Z-Score Based)\n    35→// ============================================\n    36→\n    37→export type SeverityLevel = 'ideal' | 'good' | 'fair' | 'moderate' | 'severe';\n    38→export type Gender = 'male' | 'female';\n    39→export type Ethnicity = 'white' | 'black' | 'east_asian' | 'south_asian' | 'hispanic' | 'middle_eastern' | 'native_american' | 'pacific_islander';\n    40→\n    41→export interface MasterMetricConfig {\n    42→  ideal: [number, number];  // [min, max] ideal range\n    43→  mean: number;             // Population mean\n    44→  std_dev: number;          // Standard deviation\n    45→  flaws?: {\n    46→    low?: string[];         // Flaws when value is too low\n    47→    high?: string[];        // Flaws when value is too high\n    48→  };\n    49→}\n    50→\n    51→// Base/Default standards (White Male baseline)\n    52→export const MASTER_SCORING_DB: Record<string, MasterMetricConfig> = {\n    53→  // MIDFACE & PROPORTIONS\n    54→  \"midface_ratio\": {\n    55→    ideal: [0.97, 1.00],\n    56→    mean: 1.0,\n    57→    std_dev: 0.115,\n    58→    flaws: { low: [\"Long midface\", \"Long upper jaw\"] }\n    59→  },\n    60→  \"faceWidthToHeight\": {\n    61→    ideal: [1.30, 1.45],\n    62→    mean: 1.38,\n    63→    std_dev: 0.08,\n    64→    flaws: {\n    65→      low: [\"Overly long face\", \"Narrow face\"],\n    66→      high: [\"Wide face\", \"Short face\"]\n    67→    }\n    68→  },\n    69→  \"totalFacialWidthToHeight\": {\n    70→    ideal: [1.25, 1.40],\n    71→    mean: 1.33,\n    72→    std_dev: 0.075,\n    73→    flaws: {\n    74→      low: [\"Long face shape\"],\n    75→      high: [\"Wide face shape\"]\n    76→    }\n    77→  },\n    78→  \"upperThirdProportion\": {\n    79→    ideal: [0.30, 0.36],\n    80→    mean: 0.33,\n    81→    std_dev: 0.03,\n    82→    flaws: {\n    83→      low: [\"Short forehead\"],\n    84→      high: [\"Long forehead\"]\n    85→    }\n    86→  },\n    87→  \"middleThirdProportion\": {\n    88→    ideal: [0.30, 0.36],\n    89→    mean: 0.33,\n    90→    std_dev: 0.03,\n    91→    flaws: {\n    92→      low: [\"Short midface\"],\n    93→      high: [\"Long midface\"]\n    94→    }\n    95→  },\n    96→  \"lowerThirdProportion\": {\n    97→    ideal: [0.30, 0.36],\n    98→    mean: 0.33,\n    99→    std_dev: 0.03,\n   100→    flaws: {\n   101→      low: [\"Short lower face\"],\n   102→      high: [\"Long lower face\"]\n   103→    }\n   104→  },\n   105→\n   106→  // EYE SPACING & IPD\n   107→  \"eye_separation_ratio\": {\n   108→    ideal: [0.45, 0.47],\n   109→    mean: 0.46,\n   110→    std_dev: 0.03,\n   111→    flaws: {\n   112→      low: [\"Close-set eyes\"],\n   113→      high: [\"Wide-set eyes\"]\n   114→    }\n   115→  },\n   116→  \"interpupillaryRatio\": {\n   117→    ideal: [0.44, 0.48],\n   118→    mean: 0.46,\n   119→    std_dev: 0.025,\n   120→    flaws: {\n   121→      low: [\"Close-set eyes\"],\n   122→      high: [\"Wide-set eyes\"]\n   123→    }\n   124→  },\n   125→  \"oneEyeApartTest\": {\n   126→    ideal: [0.95, 1.05],\n   127→    mean: 1.0,\n   128→    std_dev: 0.08,\n   129→    flaws: {\n   130→      low: [\"Close-set eyes\"],\n   131→      high: [\"Wide-set eyes\"]\n   132→    }\n   133→  },\n   134→  \"intercanthalWidth\": {\n   135→    ideal: [30, 35],\n   136→    mean: 32.5,\n   137→    std_dev: 2.5,\n   138→    flaws: {\n   139→      low: [\"Narrow eye spacing\"],\n   140→      high: [\"Wide eye spacing\"]\n   141→    }\n   142→  },\n   143→\n   144→  // EYE SHAPE & FEATURES\n   145→  \"lateralCanthalTilt\": {\n   146→    ideal: [6, 8],\n   147→    mean: 5.0,\n   148→    std_dev: 3.5,\n   149→    flaws: {\n   150→      low: [\"Negative canthal tilt\", \"Downturned eyes\"],\n   151→      high: [\"Excessively upturned eyes\"]\n   152→    }\n   153→  },\n   154→  \"eyeAspectRatio\": {\n   155→    ideal: [0.30, 0.35],\n   156→    mean: 0.32,\n   157→    std_dev: 0.04,\n   158→    flaws: {\n   159→      low: [\"Narrow eyes\"],\n   160→      high: [\"Round eyes\"]\n   161→    }\n   162→  },\n   163→  \"palpebralFissureLength\": {\n   164→    ideal: [28, 32],\n   165→    mean: 30.0,\n   166→    std_dev: 2.5,\n   167→    flaws: {\n   168→      low: [\"Small eyes\"],\n   169→      high: [\"Large eyes\"]\n   170→    }\n   171→  },\n   172→  \"eyeWidth\": {\n   173→    ideal: [28, 32],\n   174→    mean: 30.0,\n   175→    std_dev: 2.0,\n   176→    flaws: {\n   177→      low: [\"Narrow eyes\"],\n   178→      high: [\"Wide eyes\"]\n   179→    }\n   180→  },\n   181→  \"upperEyelidExposure\": {\n   182→    ideal: [0.5, 1.2],\n   183→    mean: 0.85,\n   184→    std_dev: 0.35,\n   185→    flaws: {\n   186→      low: [\"Hooded eyes\"],\n   187→      high: [\"Excessive upper lid exposure\"]\n   188→    }\n   189→  },\n   190→  \"tearTroughDepth\": {\n   191→    ideal: [0.0, 0.3],\n   192→    mean: 0.15,\n   193→    std_dev: 0.15,\n   194→    flaws: {\n   195→      high: [\"Dark circles / Tear troughs\", \"Under-eye hollowness\"]\n   196→    }\n   197→  },\n   198→\n   199→  // JAW ANGLES & STRUCTURE\n   200→  \"gonial_angle\": {\n   201→    ideal: [115, 125],\n   202→    mean: 118.0,\n   203→    std_dev: 6.5,\n   204→    flaws: {\n   205→      high: [\"Weak/soft jaw structure\", \"Rounded jaw\"]\n   206→    }\n   207→  },\n   208→  \"mandibularPlaneAngle\": {\n   209→    ideal: [20, 28],\n   210→    mean: 24.0,\n   211→    std_dev: 4.0,\n   212→    flaws: {\n   213→      low: [\"Flat mandibular plane\"],\n   214→      high: [\"Steep mandibular plane\", \"Hyper-divergent jaw\"]\n   215→    }\n   216→  },\n   217→  \"jawFrontalAngle\": {\n   218→    ideal: [125, 135],\n   219→    mean: 130.0,\n   220→    std_dev: 5.0,\n   221→    flaws: {\n   222→      low: [\"Steep jaw\"],\n   223→      high: [\"Flat jaw angle\"]\n   224→    }\n   225→  },\n   226→  \"jawSlope\": {\n   227→    ideal: [25, 35],\n   228→    mean: 30.0,\n   229→    std_dev: 5.0,\n   230→    flaws: {\n   231→      low: [\"Flat jawline\"],\n   232→      high: [\"Steep jawline\"]\n   233→    }\n   234→  },\n   235→\n   236→  // JAW WIDTH\n   237→  \"jawWidthRatio\": {\n   238→    ideal: [0.85, 0.95],\n   239→    mean: 0.90,\n   240→    std_dev: 0.05,\n   241→    flaws: {\n   242→      low: [\"Narrow jaw\"],\n   243→      high: [\"Wide jaw\"]\n   244→    }\n   245→  },\n   246→  \"bigonialWidth\": {\n   247→    ideal: [110, 125],\n   248→    mean: 117.5,\n   249→    std_dev: 7.5,\n   250→    flaws: {\n   251→      low: [\"Narrow jaw width\"],\n   252→      high: [\"Excessively wide jaw\"]\n   253→    }\n   254→  },\n   255→\n   256→  // CHEEKBONES\n   257→  \"cheekbone_height\": {\n   258→    ideal: [83.0, 100.0],\n   259→    mean: 85.0,\n   260→    std_dev: 5.0,\n   261→    flaws: {\n   262→      low: [\"Low-set cheekbones\", \"Flat midface\"]\n   263→    }\n   264→  },\n   265→  \"cheekboneWidth\": {\n   266→    ideal: [130, 145],\n   267→    mean: 137.5,\n   268→    std_dev: 7.5,\n   269→    flaws: {\n   270→      low: [\"Narrow cheekbones\"],\n   271→      high: [\"Wide cheekbones\"]\n   272→    }\n   273→  },\n   274→\n   275→  // CHIN\n   276→  \"chinPhiltrumRatio\": {\n   277→    ideal: [1.8, 2.2],\n   278→    mean: 2.0,\n   279→    std_dev: 0.2,\n   280→    flaws: {\n   281→      low: [\"Recessed chin\", \"Short chin\"],\n   282→      high: [\"Long chin\", \"Projected chin\"]\n   283→    }\n   284→  },\n   285→  \"chinHeight\": {\n   286→    ideal: [35, 45],\n   287→    mean: 40.0,\n   288→    std_dev: 5.0,\n   289→    flaws: {\n   290→      low: [\"Short chin\"],\n   291→      high: [\"Long chin\"]\n   292→    }\n   293→  },\n   294→  \"chinWidth\": {\n   295→    ideal: [35, 45],\n   296→    mean: 40.0,\n   297→    std_dev: 5.0,\n   298→    flaws: {\n   299→      low: [\"Pointed/Narrow chin\"],\n   300→      high: [\"Wide chin\"]\n   301→    }\n   302→  },\n   303→\n   304→  // NOSE ANGLES\n   305→  \"nasalTipAngle\": {\n   306→    ideal: [95, 115],\n   307→    mean: 105.0,\n   308→    std_dev: 10.0,\n   309→    flaws: {\n   310→      low: [\"Droopy nasal tip\"],\n   311→      high: [\"Upturned nasal tip\"]\n   312→    }\n   313→  },\n   314→  \"nasolabialAngle\": {\n   315→    ideal: [95, 110],\n   316→    mean: 102.5,\n   317→    std_dev: 7.5,\n   318→    flaws: {\n   319→      low: [\"Droopy nasal tip\"],\n   320→      high: [\"Upturned nose\"]\n   321→    }\n   322→  },\n   323→  \"nasofrontalAngle\": {\n   324→    ideal: [115, 135],\n   325→    mean: 125.0,\n   326→    std_dev: 10.0,\n   327→    flaws: {\n   328→      low: [\"Deep nasal root\"],\n   329→      high: [\"Flat nasal root\"]\n   330→    }\n   331→  },\n   332→  \"nasofacialAngle\": {\n   333→    ideal: [30, 40],\n   334→    mean: 35.0,\n   335→    std_dev: 5.0,\n   336→    flaws: {\n   337→      low: [\"Flat nose profile\"],\n   338→      high: [\"Overprojected nose\"]\n   339→    }\n   340→  },\n   341→  \"nasomentaAngle\": {\n   342→    ideal: [120, 135],\n   343→    mean: 127.5,\n   344→    std_dev: 7.5,\n   345→    flaws: {\n   346→      low: [\"Convex profile\"],\n   347→      high: [\"Concave profile\"]\n   348→    }\n   349→  },\n   350→\n   351→  // NOSE WIDTH & PROPORTIONS\n   352→  \"nasalIndex\": {\n   353→    ideal: [65, 75],\n   354→    mean: 70.0,\n   355→    std_dev: 5.0,\n   356→    flaws: {\n   357→      low: [\"Narrow nose\"],\n   358→      high: [\"Wide nose\", \"Bulbous nose\"]\n   359→    }\n   360→  },\n   361→  \"noseWidth\": {\n   362→    ideal: [35, 42],\n   363→    mean: 38.5,\n   364→    std_dev: 3.5,\n   365→    flaws: {\n   366→      low: [\"Narrow nose\"],\n   367→      high: [\"Wide nasal base\"]\n   368→    }\n   369→  },\n   370→  \"noseBridgeWidth\": {\n   371→    ideal: [12, 18],\n   372→    mean: 15.0,\n   373→    std_dev: 3.0,\n   374→    flaws: {\n   375→      low: [\"Narrow nose bridge\"],\n   376→      high: [\"Wide nose bridge\"]\n   377→    }\n   378→  },\n   379→  \"nasalProjection\": {\n   380→    ideal: [16, 22],\n   381→    mean: 19.0,\n   382→    std_dev: 3.0,\n   383→    flaws: {\n   384→      low: [\"Underprojected nose\"],\n   385→      high: [\"Overprojected nose\"]\n   386→    }\n   387→  },\n   388→  \"noseLengthRatio\": {\n   389→    ideal: [0.45, 0.55],\n   390→    mean: 0.50,\n   391→    std_dev: 0.05,\n   392→    flaws: {\n   393→      low: [\"Short nose\"],\n   394→      high: [\"Long nose\"]\n   395→    }\n   396→  },\n   397→\n   398→  // LIPS & PHILTRUM\n   399→  \"lipRatio\": {\n   400→    ideal: [1.4, 1.6],\n   401→    mean: 1.5,\n   402→    std_dev: 0.15,\n   403→    flaws: {\n   404→      low: [\"Thin upper lip\"],\n   405→      high: [\"Thick upper lip\"]\n   406→    }\n   407→  },\n   408→  \"philtrumLength\": {\n   409→    ideal: [11, 15],\n   410→    mean: 13.0,\n   411→    std_dev: 2.0,\n   412→    flaws: {\n   413→      low: [\"Short philtrum\"],\n   414→      high: [\"Long philtrum\"]\n   415→    }\n   416→  },\n   417→  \"upperLipHeight\": {\n   418→    ideal: [18, 24],\n   419→    mean: 21.0,\n   420→    std_dev: 3.0,\n   421→    flaws: {\n   422→      low: [\"Thin upper lip\"],\n   423→      high: [\"Thick upper lip\"]\n   424→    }\n   425→  },\n   426→  \"lipChinDistance\": {\n   427→    ideal: [40, 50],\n   428→    mean: 45.0,\n   429→    std_dev: 5.0,\n   430→    flaws: {\n   431→      low: [\"Short lower third\"],\n   432→      high: [\"Long lower third\"]\n   433→    }\n   434→  },\n   435→  \"upperLipProjection\": {\n   436→    ideal: [-2, 2],\n   437→    mean: 0.0,\n   438→    std_dev: 2.0,\n   439→    flaws: {\n   440→      low: [\"Recessed upper lip\"],\n   441→      high: [\"Protruding upper lip\"]\n   442→    }\n   443→  },\n   444→  \"lowerLipProjection\": {\n   445→    ideal: [-1, 3],\n   446→    mean: 1.0,\n   447→    std_dev: 2.0,\n   448→    flaws: {\n   449→      low: [\"Recessed lower lip\"],\n   450→      high: [\"Protruding lower lip\"]\n   451→    }\n   452→  },\n   453→  \"cupidsBowDepth\": {\n   454→    ideal: [3, 6],\n   455→    mean: 4.5,\n   456→    std_dev: 1.5,\n   457→    flaws: {\n   458→      low: [\"Flat cupid's bow\"],\n   459→      high: [\"Pronounced cupid's bow\"]\n   460→    }\n   461→  },\n   462→\n   463→  // EYEBROWS\n   464→  \"eyebrowHeight\": {\n   465→    ideal: [8, 14],\n   466→    mean: 11.0,\n   467→    std_dev: 3.0,\n   468→    flaws: {\n   469→      low: [\"Low-set eyebrows\"],\n   470→      high: [\"High eyebrows\"]\n   471→    }\n   472→  },\n   473→  \"browLengthRatio\": {\n   474→    ideal: [0.50, 0.60],\n   475→    mean: 0.55,\n   476→    std_dev: 0.05,\n   477→    flaws: {\n   478→      low: [\"Short eyebrows\"],\n   479→      high: [\"Long eyebrows\"]\n   480→    }\n   481→  },\n   482→  \"browLengthToFaceWidth\": {\n   483→    ideal: [0.30, 0.38],\n   484→    mean: 0.34,\n   485→    std_dev: 0.04,\n   486→    flaws: {\n   487→      low: [\"Short eyebrows\"],\n   488→      high: [\"Long eyebrows\"]\n   489→    }\n   490→  },\n   491→  \"browridgeInclinationAngle\": {\n   492→    ideal: [10, 20],\n   493→    mean: 15.0,\n   494→    std_dev: 5.0,\n   495→    flaws: {\n   496→      low: [\"Flat brow ridge\"],\n   497→      high: [\"Prominent brow ridge\"]\n   498→    }\n   499→  },\n   500→  \"eyebrowThickness\": {\n   501→    ideal: [1.5, 3.0],\n   502→    mean: 2.25,\n   503→    std_dev: 0.75,\n   504→    flaws: {\n   505→      low: [\"Sparse/Weak eyebrows\"],\n   506→      high: [\"Overly thick eyebrows\"]\n   507→    }\n   508→  },\n   509→\n   510→  // FOREHEAD\n   511→  \"foreheadHeight\": {\n   512→    ideal: [55, 70],\n   513→    mean: 62.5,\n   514→    std_dev: 7.5,\n   515→    flaws: {\n   516→      low: [\"Short forehead\"],\n   517→      high: [\"Tall forehead\"]\n   518→    }\n   519→  },\n   520→  \"bitemporalWidth\": {\n   521→    ideal: [120, 135],\n   522→    mean: 127.5,\n   523→    std_dev: 7.5,\n   524→    flaws: {\n   525→      low: [\"Narrow forehead\"],\n   526→      high: [\"Wide forehead\"]\n   527→    }\n   528→  },\n   529→\n   530→  // PROFILE & DEPTH\n   531→  \"facialDepthToHeight\": {\n   532→    ideal: [0.75, 0.85],\n   533→    mean: 0.80,\n   534→    std_dev: 0.05,\n   535→    flaws: {\n   536→      low: [\"Flat facial profile\"],\n   537→      high: [\"Overprojected profile\"]\n   538→    }\n   539→  },\n   540→  \"anteriorFacialDepth\": {\n   541→    ideal: [115, 130],\n   542→    mean: 122.5,\n   543→    std_dev: 7.5,\n   544→    flaws: {\n   545→      low: [\"Shallow face depth\"],\n   546→      high: [\"Deep face projection\"]\n   547→    }\n   548→  },\n   549→  \"totalProfileAngle\": {\n   550→    ideal: [165, 175],\n   551→    mean: 170.0,\n   552→    std_dev: 5.0,\n   553→    flaws: {\n   554→      low: [\"Convex profile\"],\n   555→      high: [\"Concave profile\"]\n   556→    }\n   557→  },\n   558→\n   559→  // ASYMMETRY\n   560→  \"facialAsymmetryIndex\": {\n   561→    ideal: [0, 3],\n   562→    mean: 2.0,\n   563→    std_dev: 1.5,\n   564→    flaws: {\n   565→      high: [\"Facial asymmetry\"]\n   566→    }\n   567→  },\n   568→  \"eyeAsymmetry\": {\n   569→    ideal: [0, 2],\n   570→    mean: 1.0,\n   571→    std_dev: 1.0,\n   572→    flaws: {\n   573→      high: [\"Eye asymmetry\"]\n   574→    }\n   575→  },\n   576→  \"jawAsymmetry\": {\n   577→    ideal: [0, 3],\n   578→    mean: 1.5,\n   579→    std_dev: 1.5,\n   580→    flaws: {\n   581→      high: [\"Jaw asymmetry\"]\n   582→    }\n   583→  },\n   584→\n   585→  // OTHER\n   586→  \"recessionFrankfort\": {\n   587→    ideal: [-2, 2],\n   588→    mean: 0.0,\n   589→    std_dev: 2.0,\n   590→    flaws: {\n   591→      low: [\"Maxillary recession\"],\n   592→      high: [\"Maxillary protrusion\"]\n   593→    }\n   594→  },\n   595→  \"neckWidth\": {\n   596→    ideal: [110, 130],\n   597→    mean: 120.0,\n   598→    std_dev: 10.0,\n   599→    flaws: {\n   600→      low: [\"Narrow neck\"],\n   601→      high: [\"Wide neck\"]\n   602→    }\n   603→  },\n   604→  \"neckToJawRatio\": {\n   605→    ideal: [0.90, 1.10],\n   606→    mean: 1.0,\n   607→    std_dev: 0.10,\n   608→    flaws: {\n   609→      low: [\"Narrow neck\"],\n   610→      high: [\"Thick neck\"]\n   611→    }\n   612→  }\n   613→};\n   614→\n   615→// ============================================\n   616→// ETHNICITY-SPECIFIC OVERRIDES\n   617→// ============================================\n   618→\n   619→/**\n   620→ * Ethnicity and gender-specific metric standards\n   621→ * These override the base MASTER_SCORING_DB values for specific populations\n   622→ */\n   623→export const ETHNICITY_OVERRIDES: Record<string, Record<string, Partial<MasterMetricConfig>>> = {\n   624→  // ========================================\n   625→  // MALE WHITE STANDARDS (Neoclassical Baseline)\n   626→  // ========================================\n   627→  \"male_white\": {\n   628→    // NOSE WIDTH - Strict 1:1 ratio (Eye Width = Nose Width)\n   629→    \"noseWidth\": {\n   630→      ideal: [35, 42],  // Corresponds to alar_base_ratio [0.98, 1.05]\n   631→      mean: 38.5,\n   632→      std_dev: 3.5,\n   633→      flaws: {\n   634→        high: [\"Wide nasal base\"]\n   635→      }\n   636→    },\n   637→\n   638→    // MIDFACE - Prefers compact midface (Hunter look)\n   639→    \"midface_ratio\": {\n   640→      ideal: [0.95, 1.02],\n   641→      mean: 0.985,\n   642→      std_dev: 0.035,\n   643→      flaws: {\n   644→        low: [\"Long midface\"]\n   645→      }\n   646→    },\n   647→\n   648→    // JAW - Square/Robust jaw preference\n   649→    \"gonial_angle\": {\n   650→      ideal: [115.0, 125.0],\n   651→      mean: 120.0,\n   652→      std_dev: 5.0,\n   653→      flaws: {\n   654→        high: [\"Weak/Soft jaw structure\"]\n   655→      }\n   656→    },\n   657→\n   658→    // FACE WIDTH - Standard Mesoprosopic range\n   659→    \"faceWidthToHeight\": {\n   660→      ideal: [1.90, 2.05],\n   661→      mean: 1.975,\n   662→      std_dev: 0.075,\n   663→      flaws: {\n   664→        low: [\"Narrow face\"],\n   665→        high: [\"Short/Wide face\"]\n   666→      }\n   667→    },\n   668→\n   669→    // EYE TILT - Neutral to slightly positive\n   670→    \"lateralCanthalTilt\": {\n   671→      ideal: [4.0, 8.0],\n   672→      mean: 6.0,\n   673→      std_dev: 2.0,\n   674→      flaws: {\n   675→        low: [\"Negative canthal tilt\"]\n   676→      }\n   677→    },\n   678→\n   679→    // LOWER FACE BALANCE\n   680→    \"chinPhiltrumRatio\": {\n   681→      ideal: [2.10, 2.30],\n   682→      mean: 2.20,\n   683→      std_dev: 0.10,\n   684→      flaws: {\n   685→        low: [\"Long philtrum / Short chin\"]\n   686→      }\n   687→    }\n   688→  },\n   689→\n   690→  // ========================================\n   691→  // MALE BLACK / AFRICAN STANDARDS\n   692→  // ========================================\n   693→  \"male_black\": {\n   694→    // NOSE WIDTH - Significantly wider tolerance\n   695→    \"noseWidth\": {\n   696→      ideal: [40, 50],  // Wider range (corresponds to alar_base_ratio [1.12, 1.25])\n   697→      mean: 45.0,\n   698→      std_dev: 5.0,\n   699→      flaws: {\n   700→        high: [\"Wide nasal base\"]\n   701→      }\n   702→    },\n   703→    \"nasalIndex\": {\n   704→      ideal: [80, 95],  // Wider nasal index\n   705→      mean: 87.5,\n   706→      std_dev: 7.5,\n   707→      flaws: {\n   708→        high: [\"Wide nose\"]\n   709→      }\n   710→    },\n   711→\n   712→    // LIPS - Prefers fuller lips\n   713→    \"lipRatio\": {\n   714→      ideal: [1.2, 1.5],\n   715→      mean: 1.35,\n   716→      std_dev: 0.15,\n   717→      flaws: {\n   718→        low: [\"Thin lips\"]\n   719→      }\n   720→    },\n   721→\n   722→    // PHILTRUM - Shorter visible philtrum is ideal\n   723→    \"philtrumLength\": {\n   724→      ideal: [11.0, 14.0],\n   725→      mean: 12.5,\n   726→      std_dev: 1.5,\n   727→      flaws: {\n   728→        high: [\"Long philtrum\"]\n   729→      }\n   730→    },\n   731→\n   732→    // CHIN - Adjusts for natural forward mouth projection (Prognathism)\n   733→    \"chinPhiltrumRatio\": {\n   734→      ideal: [1.80, 2.10],  // Lower range to account for prognathism\n   735→      mean: 1.95,\n   736→      std_dev: 0.15,\n   737→      flaws: {\n   738→        low: [\"Recessed chin\"]\n   739→      }\n   740→    }\n   741→  },\n   742→\n   743→  // ========================================\n   744→  // MALE EAST ASIAN STANDARDS\n   745→  // ========================================\n   746→  \"male_east_asian\": {\n   747→    // EYE SPACING - Shifted WIDER for East Asian males\n   748→    \"eye_separation_ratio\": {\n   749→      ideal: [0.48, 0.53],  // Shifted wider (0.46 is \"close-set\" here)\n   750→      mean: 0.505,\n   751→      std_dev: 0.025,\n   752→      flaws: {\n   753→        low: [\"Close-set eyes\"],\n   754→        high: [\"Wide-set eyes\"]\n   755→      }\n   756→    },\n   757→    \"interpupillaryRatio\": {\n   758→      ideal: [0.48, 0.53],\n   759→      mean: 0.505,\n   760→      std_dev: 0.025,\n   761→      flaws: {\n   762→        low: [\"Close-set eyes\"],\n   763→        high: [\"Wide-set eyes\"]\n   764→      }\n   765→    },\n   766→\n   767→    // EYE SHAPE - Prefers narrower/longer eyes (Hunter Eyes)\n   768→    \"eyeAspectRatio\": {\n   769→      ideal: [0.25, 0.29],  // Lower ratio = more elongated\n   770→      mean: 0.27,\n   771→      std_dev: 0.02,\n   772→      flaws: {\n   773→        low: [\"Overly narrow eyes\"],\n   774→        high: [\"Overly round eye shape\"]\n   775→      }\n   776→    },\n   777→    \"palpebralFissureLength\": {\n   778→      ideal: [29, 33],\n   779→      mean: 31.0,\n   780→      std_dev: 2.0,\n   781→      flaws: {\n   782→        low: [\"Small eyes\"],\n   783→        high: [\"Large eyes\"]\n   784→      }\n   785→    },\n   786→\n   787→    // NOSE - Asian noses typically allowed to be wider\n   788→    \"nasalIndex\": {\n   789→      ideal: [75, 85],\n   790→      mean: 80.0,\n   791→      std_dev: 5.0,\n   792→      flaws: {\n   793→        high: [\"Wide nose\"]\n   794→      }\n   795→    },\n   796→    \"noseWidth\": {\n   797→      ideal: [38, 45],\n   798→      mean: 41.5,\n   799→      std_dev: 3.5,\n   800→      flaws: {\n   801→        low: [\"Narrow nose\"],\n   802→        high: [\"Very wide nasal base\"]\n   803→      }\n   804→    },\n   805→    \"noseBridgeWidth\": {\n   806→      ideal: [14, 20],\n   807→      mean: 17.0,\n   808→      std_dev: 3.0,\n   809→      flaws: {\n   810→        low: [\"Narrow nose bridge\"],\n   811→        high: [\"Wide nose bridge\"]\n   812→      }\n   813→    },\n   814→\n   815→    // CHEEKS - Rewards slightly fuller cheeks (Youth/K-Pop aesthetic)\n   816→    \"cheekbone_height\": {\n   817→      ideal: [80.0, 95.0],\n   818→      mean: 87.5,\n   819→      std_dev: 7.5,\n   820→      flaws: {\n   821→        low: [\"Gaunt/Hollow face\"]\n   822→      }\n   823→    },\n   824→\n   825→    // JAW - Slightly softer angles acceptable\n   826→    \"gonial_angle\": {\n   827→      ideal: [118, 128],\n   828→      mean: 123.0,\n   829→      std_dev: 5.0,\n   830→      flaws: {\n   831→        high: [\"Weak/soft jaw structure\"]\n   832→      }\n   833→    },\n   834→    \"mandibularPlaneAngle\": {\n   835→      ideal: [20, 30],\n   836→      mean: 25.0,\n   837→      std_dev: 5.0,\n   838→      flaws: {\n   839→        low: [\"Flat mandibular plane\"],\n   840→        high: [\"Steep mandibular plane\"]\n   841→      }\n   842→    },\n   843→\n   844→    // FACIAL PROPORTIONS - Wider faces more common\n   845→    \"faceWidthToHeight\": {\n   846→      ideal: [1.35, 1.50],\n   847→      mean: 1.425,\n   848→      std_dev: 0.075,\n   849→      flaws: {\n   850→        low: [\"Long face\"],\n   851→        high: [\"Very wide face\"]\n   852→      }\n   853→    },\n   854→    \"totalFacialWidthToHeight\": {\n   855→      ideal: [1.30, 1.45],\n   856→      mean: 1.375,\n   857→      std_dev: 0.075,\n   858→      flaws: {\n   859→        low: [\"Long face shape\"],\n   860→        high: [\"Wide face shape\"]\n   861→      }\n   862→    }\n   863→  },\n   864→\n   865→  // ========================================\n   866→  // MALE SOUTH ASIAN STANDARDS\n   867→  // ========================================\n   868→  \"male_south_asian\": {\n   869→    // NOSE WIDTH - Slightly wider tolerance than White\n   870→    \"noseWidth\": {\n   871→      ideal: [36, 43],  // alar_base_ratio [1.00, 1.08]\n   872→      mean: 39.5,\n   873→      std_dev: 3.5,\n   874→      flaws: {\n   875→        high: [\"Wide nasal base\"]\n   876→      }\n   877→    },\n   878→\n   879→    // TEAR TROUGH - VERY STRICT. High penalty for dark circles\n   880→    \"tearTroughDepth\": {\n   881→      ideal: [0.0, 0.5],\n   882→      mean: 0.25,\n   883→      std_dev: 0.25,\n   884→      flaws: {\n   885→        high: [\"Dark circles / Tear troughs\"]\n   886→      }\n   887→    },\n   888→\n   889→    // UPPER EYELID - Often prefers visible lid platform\n   890→    \"upperEyelidExposure\": {\n   891→      ideal: [0.5, 2.0],\n   892→      mean: 1.25,\n   893→      std_dev: 0.75,\n   894→      flaws: {\n   895→        low: [\"Hooded eyes\"]\n   896→      }\n   897→    },\n   898→\n   899→    // CHEEKS - Penalizes \"Gaunt\" looks heavily\n   900→    \"cheekbone_height\": {\n   901→      ideal: [83.0, 95.0],\n   902→      mean: 89.0,\n   903→      std_dev: 6.0,\n   904→      flaws: {\n   905→        low: [\"Volume loss / Gauntness\"]\n   906→      }\n   907→    }\n   908→  },\n   909→\n   910→  // ========================================\n   911→  // MALE HISPANIC STANDARDS (\"The Bridge Model\")\n   912→  // ========================================\n   913→  \"male_hispanic\": {\n   914→    // FACE WIDTH - Rewards broader, more robust face shapes (Mestizo)\n   915→    \"faceWidthToHeight\": {\n   916→      ideal: [1.95, 2.10],\n   917→      mean: 2.025,\n   918→      std_dev: 0.075,\n   919→      flaws: {\n   920→        low: [\"Long/Narrow face\"]\n   921→      }\n   922→    },\n   923→\n   924→    // NOSE WIDTH - Bridge tolerance (Wider than White, narrower than Black)\n   925→    \"noseWidth\": {\n   926→      ideal: [36, 44],  // alar_base_ratio [1.00, 1.12]\n   927→      mean: 40.0,\n   928→      std_dev: 4.0,\n   929→      flaws: {\n   930→        high: [\"Wide nasal base\"]\n   931→      }\n   932→    },\n   933→\n   934→    // EYE TILT - Strong preference for positive tilt\n   935→    \"lateralCanthalTilt\": {\n   936→      ideal: [6.0, 12.0],\n   937→      mean: 9.0,\n   938→      std_dev: 3.0,\n   939→      flaws: {\n   940→        low: [\"Negative/Neutral canthal tilt\"]\n   941→      }\n   942→    }\n   943→  },\n   944→\n   945→  // ========================================\n   946→  // MALE MIDDLE EASTERN STANDARDS\n   947→  // ========================================\n   948→  \"male_middle_eastern\": {\n   949→    // EYEBROW THICKNESS - Prefers significantly thicker/darker brows\n   950→    \"eyebrowThickness\": {\n   951→      ideal: [2.0, 4.0],\n   952→      mean: 3.0,\n   953→      std_dev: 1.0,\n   954→      flaws: {\n   955→        low: [\"Sparse/Weak eyebrows\"],\n   956→        high: [\"Unibrow\"]\n   957→      }\n   958→    },\n   959→\n   960→    // NASOLABIAL ANGLE - Penalizes droopy tip (<90) or hooked noses\n   961→    \"nasolabialAngle\": {\n   962→      ideal: [90.0, 100.0],\n   963→      mean: 95.0,\n   964→      std_dev: 5.0,\n   965→      flaws: {\n   966→        low: [\"Droopy nose tip / Hooked nose\"]\n   967→      }\n   968→    },\n   969→\n   970→    // EYE TILT - Strong preference for Almond/Hunter eye shape\n   971→    \"lateralCanthalTilt\": {\n   972→      ideal: [4.0, 10.0],\n   973→      mean: 7.0,\n   974→      std_dev: 3.0,\n   975→      flaws: {\n   976→        low: [\"Downturned eyes\"]\n   977→      }\n   978→    },\n   979→\n   980→    // MIDFACE - Similar to White model (Compact is better)\n   981→    \"midface_ratio\": {\n   982→      ideal: [0.95, 1.02],\n   983→      mean: 0.985,\n   984→      std_dev: 0.035,\n   985→      flaws: {\n   986→        low: [\"Long midface\"]\n   987→      }\n   988→    }\n   989→  },\n   990→\n   991→  // ========================================\n   992→  // MALE PACIFIC ISLANDER STANDARDS (\"The Warrior Skull\")\n   993→  // ========================================\n   994→  \"male_pacific_islander\": {\n   995→    // FACE WIDTH - The Highest Width Standard (Very broad)\n   996→    \"faceWidthToHeight\": {\n   997→      ideal: [2.10, 2.30],\n   998→      mean: 2.20,\n   999→      std_dev: 0.10,\n  1000→      flaws: {\n  1001→        low: [\"Narrow/Long face\"]\n  1002→      }\n  1003→    },\n  1004→\n  1005→    // NOSE WIDTH - Wide tolerance\n  1006→    \"noseWidth\": {\n  1007→      ideal: [38, 48],  // alar_base_ratio [1.05, 1.20]\n  1008→      mean: 43.0,\n  1009→      std_dev: 5.0,\n  1010→      flaws: {\n  1011→        high: [\"Wide nasal base\"]\n  1012→      }\n  1013→    },\n  1014→\n  1015→    // CHEEKS - Rewards high mass/robustness\n  1016→    \"cheekbone_height\": {\n  1017→      ideal: [85.0, 100.0],\n  1018→      mean: 92.5,\n  1019→      std_dev: 7.5,\n  1020→      flaws: {\n  1021→        low: [\"Gaunt/Weak face structure\"]\n  1022→      }\n  1023→    },\n  1024→\n  1025→    // CHIN WIDTH - Prefers a very broad, square chin\n  1026→    \"chinWidth\": {\n  1027→      ideal: [40.0, 50.0],\n  1028→      mean: 45.0,\n  1029→      std_dev: 5.0,\n  1030→      flaws: {\n  1031→        low: [\"Pointed/Narrow chin\"]\n  1032→      }\n  1033→    }\n  1034→  },\n  1035→\n  1036→  \"male_native_american\": {\n  1037→    \"faceWidthToHeight\": {\n  1038→      ideal: [2.00, 2.20],\n  1039→      mean: 2.10,\n  1040→      std_dev: 0.10,\n  1041→      flaws: {\n  1042→        low: [\"Narrow face\"],\n  1043→        high: [\"Wide face\"]\n  1044→      }\n  1045→    },\n  1046→\n  1047→    \"nasalIndex\": {\n  1048→      ideal: [75, 90],\n  1049→      mean: 82.5,\n  1050→      std_dev: 7.5,\n  1051→      flaws: {\n  1052→        low: [\"Narrow nose\"],\n  1053→        high: [\"Wide nose\"]\n  1054→      }\n  1055→    },\n  1056→\n  1057→    \"cheekbone_height\": {\n  1058→      ideal: [80.0, 95.0],\n  1059→      mean: 87.5,\n  1060→      std_dev: 7.5,\n  1061→      flaws: {\n  1062→        low: [\"Flat cheekbones\"]\n  1063→      }\n  1064→    },\n  1065→\n  1066→    \"gonialAngle\": {\n  1067→      ideal: [115, 125],\n  1068→      mean: 120,\n  1069→      std_dev: 5,\n  1070→      flaws: {\n  1071→        low: [\"Weak jaw\"],\n  1072→        high: [\"Harsh jaw angle\"]\n  1073→      }\n  1074→    },\n  1075→\n  1076→    \"chinWidth\": {\n  1077→      ideal: [38.0, 48.0],\n  1078→      mean: 43.0,\n  1079→      std_dev: 5.0,\n  1080→      flaws: {\n  1081→        low: [\"Narrow chin\"]\n  1082→      }\n  1083→    }\n  1084→  },\n  1085→\n  1086→  // ========================================\n  1087→  // FEMALE ETHNICITIES (The \"Missing Link\")\n  1088→  // ========================================\n  1089→\n  1090→  \"female_white\": {\n  1091→    // NOSE WIDTH - Strict Rule of Fifths for feminine harmony\n  1092→    \"alar_base_ratio\": {\n  1093→      ideal: [0.98, 1.05],\n  1094→      mean: 1.015,\n  1095→      std_dev: 0.035,\n  1096→      flaws: {\n  1097→        high: [\"Wide nasal base\"]\n  1098→      }\n  1099→    },\n  1100→\n  1101→    // FACE WIDTH - Prefers oval/narrow feminine proportions\n  1102→    \"fwhr\": {\n  1103→      ideal: [1.45, 1.53],\n  1104→      mean: 1.49,\n  1105→      std_dev: 0.04,\n  1106→      flaws: {\n  1107→        low: [\"Long/Narrow face\"],\n  1108→        high: [\"Wide face\"]\n  1109→      }\n  1110→    },\n  1111→\n  1112→    // JAW - Soft, tapered feminine jawline\n  1113→    \"gonial_angle\": {\n  1114→      ideal: [122.0, 130.0],\n  1115→      mean: 126.0,\n  1116→      std_dev: 4.0,\n  1117→      flaws: {\n  1118→        low: [\"Sharp/Masculine jaw angle\"],\n  1119→        high: [\"Weak/Overly soft jawline\"]\n  1120→      }\n  1121→    },\n  1122→\n  1123→    // EYE TILT - Neutral to positive preferred\n  1124→    \"canthal_tilt\": {\n  1125→      ideal: [4.0, 9.0],\n  1126→      mean: 6.5,\n  1127→      std_dev: 2.5,\n  1128→      flaws: {\n  1129→        low: [\"Negative/Downturned eyes\"]\n  1130→      }\n  1131→    },\n  1132→\n  1133→    // CHIN-PHILTRUM - Golden Ratio balance\n  1134→    \"chin_philtrum_ratio\": {\n  1135→      ideal: [2.0, 2.2],\n  1136→      mean: 2.1,\n  1137→      std_dev: 0.1,\n  1138→      flaws: {\n  1139→        low: [\"Recessed chin\"],\n  1140→        high: [\"Protruding chin\"]\n  1141→      }\n  1142→    }\n  1143→  },\n  1144→\n  1145→  \"female_black\": {\n  1146→    // LIPS - High volume preference (fuller lips)\n  1147→    \"lipRatio\": {\n  1148→      ideal: [1.3, 1.6],\n  1149→      mean: 1.45,\n  1150→      std_dev: 0.15,\n  1151→      flaws: {\n  1152→        low: [\"Thin lips\"]\n  1153→      }\n  1154→    },\n  1155→\n  1156→    // NOSE WIDTH - Wider tolerance for ethnic variation\n  1157→    \"alar_base_ratio\": {\n  1158→      ideal: [1.05, 1.15],\n  1159→      mean: 1.10,\n  1160→      std_dev: 0.05,\n  1161→      flaws: {\n  1162→        high: [\"Very wide nasal base\"]\n  1163→      }\n  1164→    },\n  1165→\n  1166→    // CHIN - Allows forward projection (natural prognathism)\n  1167→    \"chin_projection\": {\n  1168→      ideal: [0.0, 5.0],\n  1169→      mean: 2.5,\n  1170→      std_dev: 2.5,\n  1171→      flaws: {\n  1172→        high: [\"Excessive chin projection\"]\n  1173→      }\n  1174→    },\n  1175→\n  1176→    // JAW - Soft feminine jawline\n  1177→    \"gonial_angle\": {\n  1178→      ideal: [120.0, 130.0],\n  1179→      mean: 125.0,\n  1180→      std_dev: 5.0,\n  1181→      flaws: {\n  1182→        low: [\"Sharp jaw angle\"],\n  1183→        high: [\"Weak jawline\"]\n  1184→      }\n  1185→    }\n  1186→  },\n  1187→\n  1188→  \"female_east_asian\": {\n  1189→    // EYE SPACING - Wide-set neotenous preference\n  1190→    \"eye_separation_ratio\": {\n  1191→      ideal: [46.3, 47.5],\n  1192→      mean: 46.9,\n  1193→      std_dev: 0.6,\n  1194→      flaws: {\n  1195→        low: [\"Close-set eyes\"],\n  1196→        high: [\"Very wide-set eyes\"]\n  1197→      }\n  1198→    },\n  1199→\n  1200→    // JAW - Tapered V-shape feminine ideal\n  1201→    \"gonial_angle\": {\n  1202→      ideal: [120.0, 126.0],\n  1203→      mean: 123.0,\n  1204→      std_dev: 3.0,\n  1205→      flaws: {\n  1206→        low: [\"Sharp V-line jaw\"],\n  1207→        high: [\"Weak/Square jawline\"]\n  1208→      }\n  1209→    },\n  1210→\n  1211→    // EYEBROWS - Higher set brows (youthful feminine)\n  1212→    \"eyebrow_height\": {\n  1213→      ideal: [0.85, 1.30],\n  1214→      mean: 1.075,\n  1215→      std_dev: 0.225,\n  1216→      flaws: {\n  1217→        low: [\"Low-set/Heavy brows\"],\n  1218→        high: [\"Very high-arched brows\"]\n  1219→      }\n  1220→    },\n  1221→\n  1222→    // LOWER FACE - Compact lower third (neotenous)\n  1223→    \"lower_third_ratio\": {\n  1224→      ideal: [29.6, 32.7],\n  1225→      mean: 31.15,\n  1226→      std_dev: 1.55,\n  1227→      flaws: {\n  1228→        low: [\"Very short lower face\"],\n  1229→        high: [\"Long lower face\"]\n  1230→      }\n  1231→    }\n  1232→  },\n  1233→\n  1234→  \"female_south_asian\": {\n  1235→    // TEAR TROUGHS - Very strict on dark circles\n  1236→    \"tear_trough_depth\": {\n  1237→      ideal: [0.0, 0.5],\n  1238→      mean: 0.25,\n  1239→      std_dev: 0.25,\n  1240→      flaws: {\n  1241→        high: [\"Dark circles / Deep tear troughs\"]\n  1242→      }\n  1243→    },\n  1244→\n  1245→    // CHEEKS - Rewards midface volume (youthful fullness)\n  1246→    \"cheek_fullness\": {\n  1247→      ideal: [1.0, 2.0],\n  1248→      mean: 1.5,\n  1249→      std_dev: 0.5,\n  1250→      flaws: {\n  1251→        low: [\"Gaunt/Hollow cheeks\"]\n  1252→      }\n  1253→    },\n  1254→\n  1255→    // SKIN - High penalty for uneven skin tone\n  1256→    \"skin_uniformity\": {\n  1257→      ideal: [0.92, 1.0],\n  1258→      mean: 0.96,\n  1259→      std_dev: 0.04,\n  1260→      flaws: {\n  1261→        low: [\"Uneven skin tone / Pigmentation\"]\n  1262→      }\n  1263→    },\n  1264→\n  1265→    // NOSE WIDTH - Intermediate tolerance\n  1266→    \"alar_base_ratio\": {\n  1267→      ideal: [1.00, 1.08],\n  1268→      mean: 1.04,\n  1269→      std_dev: 0.04,\n  1270→      flaws: {\n  1271→        high: [\"Wide nasal base\"]\n  1272→      }\n  1273→    }\n  1274→  },\n  1275→\n  1276→  \"female_hispanic\": {\n  1277→    // FACE WIDTH - Broader Mestiza tolerance\n  1278→    \"fwhr\": {\n  1279→      ideal: [1.50, 1.62],\n  1280→      mean: 1.56,\n  1281→      std_dev: 0.06,\n  1282→      flaws: {\n  1283→        low: [\"Long/Narrow face\"],\n  1284→        high: [\"Very wide face\"]\n  1285→      }\n  1286→    },\n  1287→\n  1288→    // EYE TILT - Strong almond eye preference\n  1289→    \"canthal_tilt\": {\n  1290→      ideal: [6.0, 12.0],\n  1291→      mean: 9.0,\n  1292→      std_dev: 3.0,\n  1293→      flaws: {\n  1294→        low: [\"Neutral/Downturned eyes\"]\n  1295→      }\n  1296→    },\n  1297→\n  1298→    // NOSE WIDTH - Intermediate width tolerance\n  1299→    \"alar_base_ratio\": {\n  1300→      ideal: [1.00, 1.10],\n  1301→      mean: 1.05,\n  1302→      std_dev: 0.05,\n  1303→      flaws: {\n  1304→        high: [\"Wide nasal base\"]\n  1305→      }\n  1306→    },\n  1307→\n  1308→    // LIPS - Voluptuous preference\n  1309→    \"lipRatio\": {\n  1310→      ideal: [1.1, 1.35],\n  1311→      mean: 1.225,\n  1312→      std_dev: 0.125,\n  1313→      flaws: {\n  1314→        low: [\"Thin lips\"]\n  1315→      }\n  1316→    }\n  1317→  },\n  1318→\n  1319→  \"female_middle_eastern\": {\n  1320→    // EYEBROWS - Dense/Thick brows preference\n  1321→    \"eyebrow_thickness\": {\n  1322→      ideal: [1.5, 3.0],\n  1323→      mean: 2.25,\n  1324→      std_dev: 0.75,\n  1325→      flaws: {\n  1326→        low: [\"Sparse/Thin eyebrows\"],\n  1327→        high: [\"Unibrow\"]\n  1328→      }\n  1329→    },\n  1330→\n  1331→    // NOSE - Refined/Upturned tip\n  1332→    \"nasolabial_angle\": {\n  1333→      ideal: [95.0, 105.0],\n  1334→      mean: 100.0,\n  1335→      std_dev: 5.0,\n  1336→      flaws: {\n  1337→        low: [\"Droopy nose tip\"],\n  1338→        high: [\"Overly upturned nose\"]\n  1339→      }\n  1340→    },\n  1341→\n  1342→    // EYE TILT - Foxy/Hunter feminine eye shape\n  1343→    \"canthal_tilt\": {\n  1344→      ideal: [5.0, 10.0],\n  1345→      mean: 7.5,\n  1346→      std_dev: 2.5,\n  1347→      flaws: {\n  1348→        low: [\"Downturned eyes\"]\n  1349→      }\n  1350→    },\n  1351→\n  1352→    // EYELID - Low exposure preferred\n  1353→    \"upper_eyelid_exposure\": {\n  1354→      ideal: [0.5, 1.5],\n  1355→      mean: 1.0,\n  1356→      std_dev: 0.5,\n  1357→      flaws: {\n  1358→        low: [\"Hooded eyes\"],\n  1359→        high: [\"Excessive eyelid exposure\"]\n  1360→      }\n  1361→    }\n  1362→  },\n  1363→\n  1364→  \"female_native_american\": {\n  1365→    // FACE WIDTH - Wide/High cheekbone structure\n  1366→    \"fwhr\": {\n  1367→      ideal: [1.52, 1.65],\n  1368→      mean: 1.585,\n  1369→      std_dev: 0.065,\n  1370→      flaws: {\n  1371→        low: [\"Narrow face\"],\n  1372→        high: [\"Very wide face\"]\n  1373→      }\n  1374→    },\n  1375→\n  1376→    // CHEEKBONES - High definition/prominence\n  1377→    \"cheekbone_prominence\": {\n  1378→      ideal: [1.5, 2.5],\n  1379→      mean: 2.0,\n  1380→      std_dev: 0.5,\n  1381→      flaws: {\n  1382→        low: [\"Flat cheekbones\"],\n  1383→        high: [\"Overly prominent cheekbones\"]\n  1384→      }\n  1385→    },\n  1386→\n  1387→    // JAW - Stronger jaw tolerance\n  1388→    \"gonial_angle\": {\n  1389→      ideal: [115.0, 125.0],\n  1390→      mean: 120.0,\n  1391→      std_dev: 5.0,\n  1392→      flaws: {\n  1393→        low: [\"Very sharp jaw\"],\n  1394→        high: [\"Weak jawline\"]\n  1395→      }\n  1396→    },\n  1397→\n  1398→    // EYE TILT - Positive tilt preference\n  1399→    \"canthal_tilt\": {\n  1400→      ideal: [5.0, 11.0],\n  1401→      mean: 8.0,\n  1402→      std_dev: 3.0,\n  1403→      flaws: {\n  1404→        low: [\"Downturned eyes\"]\n  1405→      }\n  1406→    }\n  1407→  },\n  1408→\n  1409→  \"female_pacific_islander\": {\n  1410→    // FACE WIDTH - Widest/Robust facial structure\n  1411→    \"fwhr\": {\n  1412→      ideal: [1.55, 1.70],\n  1413→      mean: 1.625,\n  1414→      std_dev: 0.075,\n  1415→      flaws: {\n  1416→        low: [\"Narrow face\"],\n  1417→        high: [\"Very wide face\"]\n  1418→      }\n  1419→    },\n  1420→\n  1421→    // CHEEKS - High volume/softness preference\n  1422→    \"cheek_fullness\": {\n  1423→      ideal: [1.2, 2.5],\n  1424→      mean: 1.85,\n  1425→      std_dev: 0.65,\n  1426→      flaws: {\n  1427→        low: [\"Gaunt/Hollow cheeks\"]\n  1428→      }\n  1429→    },\n  1430→\n  1431→    // NOSE WIDTH - Wide nose tolerance\n  1432→    \"alar_base_ratio\": {\n  1433→      ideal: [1.05, 1.15],\n  1434→      mean: 1.10,\n  1435→      std_dev: 0.05,\n  1436→      flaws: {\n  1437→        high: [\"Very wide nasal base\"]\n  1438→      }\n  1439→    },\n  1440→\n  1441→    // LIPS - Full lips preference\n  1442→    \"lipRatio\": {\n  1443→      ideal: [1.25, 1.50],\n  1444→      mean: 1.375,\n  1445→      std_dev: 0.125,\n  1446→      flaws: {\n  1447→        low: [\"Thin lips\"]\n  1448→      }\n  1449→    }\n  1450→  }\n  1451→};\n  1452→\n  1453→/**\n  1454→ * Get the appropriate metric configuration for a given gender and ethnicity\n  1455→ * Falls back to base config if no override exists\n  1456→ */\n  1457→export function getMetricConfig(\n  1458→  metricId: string,\n  1459→  gender: Gender = 'male',\n  1460→  ethnicity: Ethnicity = 'white'\n  1461→): MasterMetricConfig | undefined {\n  1462→  const key = `${gender}_${ethnicity}`;\n  1463→  const override = ETHNICITY_OVERRIDES[key]?.[metricId];\n  1464→  const baseConfig = MASTER_SCORING_DB[metricId];\n  1465→\n  1466→  if (!baseConfig) return undefined;\n  1467→\n  1468→  // Merge override with base config\n  1469→  if (override) {\n  1470→    return {\n  1471→      ...baseConfig,\n  1472→      ...override,\n  1473→      flaws: {\n  1474→        ...baseConfig.flaws,\n  1475→        ...override.flaws\n  1476→      }\n  1477→    } as MasterMetricConfig;\n  1478→  }\n  1479→\n  1480→  return baseConfig;\n  1481→}\n  1482→\n  1483→// ============================================\n  1484→// Z-SCORE SEVERITY FUNCTIONS\n  1485→// ============================================\n  1486→\n  1487→/**\n  1488→ * Calculate Z-score for a given value\n  1489→ * Z = (value - mean) / std_dev\n  1490→ */\n  1491→export function calculateZScore(value: number, mean: number, stdDev: number): number {\n  1492→  if (stdDev === 0) return 0;\n  1493→  return Math.abs((value - mean) / stdDev);\n  1494→}\n  1495→\n  1496→/**\n  1497→ * Determine severity level based on Z-score and ideal range (5-tier system)\n  1498→ * - Ideal: Value is within ideal range\n  1499→ * - Good: |z| < 0.5 (within 0.5 standard deviation)\n  1500→ * - Fair: 0.5 ≤ |z| < 1 (between 0.5-1 standard deviations)\n  1501→ * - Moderate: 1 ≤ |z| < 2 (between 1-2 standard deviations)\n  1502→ * - Severe: |z| ≥ 2 (more than 2 standard deviations away)\n  1503→ */\n  1504→export function getSeverityFromZScore(\n  1505→  value: number,\n  1506→  config: MasterMetricConfig\n  1507→): { severity: SeverityLevel; zScore: number; isInIdeal: boolean } {\n  1508→  const { ideal, mean, std_dev } = config;\n  1509→  const isInIdeal = value >= ideal[0] && value <= ideal[1];\n  1510→  const zScore = calculateZScore(value, mean, std_dev);\n  1511→\n  1512→  let severity: SeverityLevel;\n  1513→  if (isInIdeal) {\n  1514→    severity = 'ideal';\n  1515→  } else if (zScore < 0.5) {\n  1516→    severity = 'good';\n  1517→  } else if (zScore < 1) {\n  1518→    severity = 'fair';\n  1519→  } else if (zScore < 2) {\n  1520→    severity = 'moderate';\n  1521→  } else {\n  1522→    severity = 'severe';\n  1523→  }\n  1524→\n  1525→  return { severity, zScore, isInIdeal };\n  1526→}\n  1527→\n  1528→/**\n  1529→ * Get severity for a metric value with ethnicity/gender awareness\n  1530→ */\n  1531→export function getSeverityForMetric(\n  1532→  metricId: string,\n  1533→  value: number,\n  1534→  gender: Gender = 'male',\n  1535→  ethnicity: Ethnicity = 'white'\n  1536→): { severity: SeverityLevel; zScore: number; isInIdeal: boolean; config: MasterMetricConfig } | null {\n  1537→  const config = getMetricConfig(metricId, gender, ethnicity);\n  1538→  if (!config) return null;\n  1539→\n  1540→  const result = getSeverityFromZScore(value, config);\n  1541→  return { ...result, config };\n  1542→}\n  1543→\n  1544→/**\n  1545→ * Get badge color for severity level (5-tier)\n  1546→ */\n  1547→export function getSeverityColor(severity: SeverityLevel): string {\n  1548→  switch (severity) {\n  1549→    case 'ideal': return 'green';\n  1550→    case 'good': return 'blue';\n  1551→    case 'fair': return 'cyan';\n  1552→    case 'moderate': return 'yellow';\n  1553→    case 'severe': return 'red';\n  1554→    default: return 'gray';\n  1555→  }\n  1556→}\n  1557→\n  1558→/**\n  1559→ * Get severity label for display (5-tier)\n  1560→ */\n  1561→export function getSeverityLabel(severity: SeverityLevel): string {\n  1562→  switch (severity) {\n  1563→    case 'ideal': return 'Ideal';\n  1564→    case 'good': return 'Good';\n  1565→    case 'fair': return 'Fair';\n  1566→    case 'moderate': return 'Moderate';\n  1567→    case 'severe': return 'Severe';\n  1568→    default: return 'Unknown';\n  1569→  }\n  1570→}\n  1571→\n  1572→// ============================================\n  1573→// INSIGHT DEFINITION TYPES\n  1574→// ============================================\n  1575→\n  1576→export interface InsightSeverityLogic {\n  1577→  metrics: string[];  // Display names of metrics (e.g., \"Face Width to Height Ratio\")\n  1578→  threshold: number;  // Score threshold for classification\n  1579→}\n  1580→\n  1581→export interface WeaknessSeverityLabels {\n  1582→  minor: string;\n  1583→  moderate: string;\n  1584→  severe: string;\n  1585→}\n  1586→\n  1587→export interface StrengthGradeLabels {\n  1588→  good: string;\n  1589→  excellent: string;\n  1590→  ideal: string;\n  1591→}\n  1592→\n  1593→export interface InsightContent {\n  1594→  description: string;\n  1595→  severity_labels?: WeaknessSeverityLabels;  // For weaknesses\n  1596→  grade_labels?: StrengthGradeLabels;        // For strengths\n  1597→}\n  1598→\n  1599→export interface InsightDefinition {\n  1600→  id: string;\n  1601→  title: string;\n  1602→  type: 'weakness' | 'strength';\n  1603→  severity_logic: InsightSeverityLogic;\n  1604→  content: InsightContent;\n  1605→}\n  1606→\n  1607→// ============================================\n  1608→// CLASSIFICATION RESULT TYPES\n  1609→// ============================================\n  1610→\n  1611→export type WeaknessSeverity = 'severe' | 'moderate' | 'minor';\n  1612→export type StrengthGrade = 'ideal' | 'excellent' | 'good';\n  1613→\n  1614→export interface ClassifiedWeakness {\n  1615→  insightId: string;\n  1616→  title: string;\n  1617→  description: string;\n  1618→  severity: WeaknessSeverity;\n  1619→  severityLabel: string;  // Custom label from definition (e.g., \"Extremely Long\")\n  1620→  avgScore: number;\n  1621→  matchedMetrics: MatchedMetric[];\n  1622→}\n  1623→\n  1624→export interface ClassifiedStrength {\n  1625→  insightId: string;\n  1626→  title: string;\n  1627→  description: string;\n  1628→  grade: StrengthGrade;\n  1629→  gradeLabel: string;  // Custom label from definition (e.g., \"Ideal\")\n  1630→  avgScore: number;\n  1631→  matchedMetrics: MatchedMetric[];\n  1632→}\n  1633→\n  1634→export interface MatchedMetric {\n  1635→  metricId: string;\n  1636→  metricName: string;\n  1637→  score: number;\n  1638→  value: number;\n  1639→  idealMin: number;\n  1640→  idealMax: number;\n  1641→  unit: string;\n  1642→  category: string;\n  1643→}\n  1644→\n  1645→export interface InsightClassificationResult {\n  1646→  strengths: ClassifiedStrength[];\n  1647→  weaknesses: ClassifiedWeakness[];\n  1648→}\n  1649→\n  1650→// ============================================\n  1651→// INSIGHTS DATABASE\n  1652→// ============================================\n  1653→\n  1654→export const INSIGHTS_DEFINITIONS: InsightDefinition[] = [\n  1655→  {\n  1656→    id: \"long_midface\",\n  1657→    title: \"Long Midface\",\n  1658→    type: \"weakness\",\n  1659→    severity_logic: {\n  1660→      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\", \"Ipsilateral Alar Angle\"],\n  1661→      threshold: 6.0\n  1662→    },\n  1663→    content: {\n  1664→      description: \"The middle of the face is elongated, creating an unbalanced vertical proportion.\",\n  1665→      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Extremely Long\" }\n  1666→    }\n  1667→  },\n  1668→  {\n  1669→    id: \"short_midface\",\n  1670→    title: \"Short Midface\",\n  1671→    type: \"strength\",\n  1672→    severity_logic: {\n  1673→      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\"],\n  1674→      threshold: 8.0\n  1675→    },\n  1676→    content: {\n  1677→      description: \"The midface has ideal vertical proportions, contributing to facial harmony.\",\n  1678→      grade_labels: { good: \"Proportionate\", excellent: \"Well-Balanced\", ideal: \"Ideal\" }\n  1679→    }\n  1680→  },\n  1681→  {\n  1682→    id: \"weak_jaw\",\n  1683→    title: \"Weak/Soft Jaw Structure\",\n  1684→    type: \"weakness\",\n  1685→    severity_logic: {\n  1686→      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Chin to Philtrum Ratio\", \"Jaw Slope\"],\n  1687→      threshold: 5.0\n  1688→    },\n  1689→    content: {\n  1690→      description: \"The jaw has a softer, rounder shape, often less angular and robust than the ideal.\",\n  1691→      severity_labels: { minor: \"Soft\", moderate: \"Recessed\", severe: \"Weak\" }\n  1692→    }\n  1693→  },\n  1694→  {\n  1695→    id: \"strong_jaw\",\n  1696→    title: \"Strong Jaw Definition\",\n  1697→    type: \"strength\",\n  1698→    severity_logic: {\n  1699→      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Jaw Width Ratio\", \"Bigonial Width\"],\n  1700→      threshold: 8.0\n  1701→    },\n  1702→    content: {\n  1703→      description: \"The jaw displays strong definition with well-defined angles and proportionate width.\",\n  1704→      grade_labels: { good: \"Defined\", excellent: \"Strong\", ideal: \"Ideal Angular\" }\n  1705→    }\n  1706→  },\n  1707→  {\n  1708→    id: \"refined_nasal_tip\",\n  1709→    title: \"Refined Nasal Tip\",\n  1710→    type: \"strength\",\n  1711→    severity_logic: {\n  1712→      metrics: [\"Nasal Tip Angle\", \"Nose Tip Position\", \"Frankfort-tip Angle\"],\n  1713→      threshold: 8.5\n  1714→    },\n  1715→    content: {\n  1716→      description: \"This contributes to a harmonious nasal profile due to the nasal tip being well-defined and proportionate.\",\n  1717→      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n  1718→    }\n  1719→  },\n  1720→  {\n  1721→    id: \"bulbous_nose\",\n  1722→    title: \"Bulbous Nasal Tip\",\n  1723→    type: \"weakness\",\n  1724→    severity_logic: {\n  1725→      metrics: [\"Nasal Index\", \"Nose Width\", \"Nasal Tip Angle\"],\n  1726→      threshold: 5.5\n  1727→    },\n  1728→    content: {\n  1729→      description: \"The nasal tip appears rounded and less defined, affecting nasal aesthetics.\",\n  1730→      severity_labels: { minor: \"Slightly Rounded\", moderate: \"Rounded\", severe: \"Bulbous\" }\n  1731→    }\n  1732→  },\n  1733→  {\n  1734→    id: \"ideal_upper_lip\",\n  1735→    title: \"Well-Positioned Upper Lip\",\n  1736→    type: \"strength\",\n  1737→    severity_logic: {\n  1738→      metrics: [\"Upper Lip E-Line Position\", \"Upper Lip S-Line Position\", \"Nasolabial Angle\"],\n  1739→      threshold: 9.0\n  1740→    },\n  1741→    content: {\n  1742→      description: \"This contributes to a harmonious mouth region due to the upper lip sitting neither too far forward nor too far back.\",\n  1743→      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n  1744→    }\n  1745→  },\n  1746→  {\n  1747→    id: \"negative_canthal_tilt\",\n  1748→    title: \"Negative Canthal Tilt\",\n  1749→    type: \"weakness\",\n  1750→    severity_logic: {\n  1751→      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n  1752→      threshold: 5.0\n  1753→    },\n  1754→    content: {\n  1755→      description: \"The outer corners of the eyes sit lower than the inner corners, creating a downturned appearance.\",\n  1756→      severity_labels: { minor: \"Slight Downturn\", moderate: \"Noticeable\", severe: \"Pronounced\" }\n  1757→    }\n  1758→  },\n  1759→  {\n  1760→    id: \"positive_canthal_tilt\",\n  1761→    title: \"Positive Canthal Tilt\",\n  1762→    type: \"strength\",\n  1763→    severity_logic: {\n  1764→      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n  1765→      threshold: 8.0\n  1766→    },\n  1767→    content: {\n  1768→      description: \"The outer corners of the eyes are elevated, creating an attractive upswept eye shape.\",\n  1769→      grade_labels: { good: \"Slight Upturn\", excellent: \"Well-Tilted\", ideal: \"Hunter Eyes\" }\n  1770→    }\n  1771→  },\n  1772→  {\n  1773→    id: \"balanced_facial_thirds\",\n  1774→    title: \"Balanced Facial Thirds\",\n  1775→    type: \"strength\",\n  1776→    severity_logic: {\n  1777→      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n  1778→      threshold: 8.5\n  1779→    },\n  1780→    content: {\n  1781→      description: \"The face displays well-balanced vertical proportions across all three facial thirds.\",\n  1782→      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfectly Proportioned\" }\n  1783→    }\n  1784→  },\n  1785→  {\n  1786→    id: \"imbalanced_thirds\",\n  1787→    title: \"Facial Third Imbalance\",\n  1788→    type: \"weakness\",\n  1789→    severity_logic: {\n  1790→      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n  1791→      threshold: 5.5\n  1792→    },\n  1793→    content: {\n  1794→      description: \"The vertical face proportions show imbalance between the three facial thirds.\",\n  1795→      severity_labels: { minor: \"Slight Imbalance\", moderate: \"Noticeable Disproportion\", severe: \"Significant Imbalance\" }\n  1796→    }\n  1797→  },\n  1798→  {\n  1799→    id: \"high_cheekbones\",\n  1800→    title: \"High Cheekbones\",\n  1801→    type: \"strength\",\n  1802→    severity_logic: {\n  1803→      metrics: [\"Cheekbone Height\", \"Cheekbone Width\", \"Midface Ratio\"],\n  1804→      threshold: 8.5\n  1805→    },\n  1806→    content: {\n  1807→      description: \"Well-positioned cheekbones that create attractive facial contours and catch light beautifully.\",\n  1808→      grade_labels: { good: \"Visible\", excellent: \"Prominent\", ideal: \"Model-Tier\" }\n  1809→    }\n  1810→  },\n  1811→  {\n  1812→    id: \"flat_midface\",\n  1813→    title: \"Flat Midface\",\n  1814→    type: \"weakness\",\n  1815→    severity_logic: {\n  1816→      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Total Facial Width to Height\"],\n  1817→      threshold: 5.0\n  1818→    },\n  1819→    content: {\n  1820→      description: \"The midface lacks forward projection, resulting in flatter facial contours.\",\n  1821→      severity_labels: { minor: \"Slightly Flat\", moderate: \"Underprojected\", severe: \"Recessed\" }\n  1822→    }\n  1823→  },\n  1824→  {\n  1825→    id: \"ideal_lip_ratio\",\n  1826→    title: \"Ideal Lip Proportions\",\n  1827→    type: \"strength\",\n  1828→    severity_logic: {\n  1829→      metrics: [\"Lip Ratio\", \"Philtrum Length\", \"Lip Chin Distance\"],\n  1830→      threshold: 8.5\n  1831→    },\n  1832→    content: {\n  1833→      description: \"The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio.\",\n  1834→      grade_labels: { good: \"Balanced\", excellent: \"Well-Proportioned\", ideal: \"Perfect Ratio\" }\n  1835→    }\n  1836→  },\n  1837→  {\n  1838→    id: \"thin_lips\",\n  1839→    title: \"Thin Lip Profile\",\n  1840→    type: \"weakness\",\n  1841→    severity_logic: {\n  1842→      metrics: [\"Lip Ratio\", \"Upper Lip Projection\", \"Lower Lip Projection\"],\n  1843→      threshold: 5.0\n  1844→    },\n  1845→    content: {\n  1846→      description: \"The lips appear thinner than ideal proportions, affecting lower face harmony.\",\n  1847→      severity_labels: { minor: \"Slightly Thin\", moderate: \"Thin\", severe: \"Very Thin\" }\n  1848→    }\n  1849→  },\n  1850→  {\n  1851→    id: \"ideal_ipd\",\n  1852→    title: \"Ideal Eye Spacing\",\n  1853→    type: \"strength\",\n  1854→    severity_logic: {\n  1855→      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n  1856→      threshold: 8.5\n  1857→    },\n  1858→    content: {\n  1859→      description: \"The eyes are ideally spaced, creating facial balance and attractiveness.\",\n  1860→      grade_labels: { good: \"Good Spacing\", excellent: \"Ideal Distance\", ideal: \"Perfect IPD\" }\n  1861→    }\n  1862→  },\n  1863→  {\n  1864→    id: \"wide_set_eyes\",\n  1865→    title: \"Wide-Set Eyes\",\n  1866→    type: \"weakness\",\n  1867→    severity_logic: {\n  1868→      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n  1869→      threshold: 5.5\n  1870→    },\n  1871→    content: {\n  1872→      description: \"The eyes are spaced wider apart than the aesthetic ideal.\",\n  1873→      severity_labels: { minor: \"Slightly Wide\", moderate: \"Noticeably Wide\", severe: \"Very Wide\" }\n  1874→    }\n  1875→  },\n  1876→  {\n  1877→    id: \"close_set_eyes\",\n  1878→    title: \"Close-Set Eyes\",\n  1879→    type: \"weakness\",\n  1880→    severity_logic: {\n  1881→      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"Intercanthal Width\"],\n  1882→      threshold: 5.5\n  1883→    },\n  1884→    content: {\n  1885→      description: \"The eyes are positioned closer together than the aesthetic ideal.\",\n  1886→      severity_labels: { minor: \"Slightly Close\", moderate: \"Noticeably Close\", severe: \"Very Close\" }\n  1887→    }\n  1888→  },\n  1889→  {\n  1890→    id: \"ideal_nose_projection\",\n  1891→    title: \"Ideal Nasal Projection\",\n  1892→    type: \"strength\",\n  1893→    severity_logic: {\n  1894→      metrics: [\"Nasofrontal Angle\", \"Nasofacial Angle\", \"Nasomenta Angle\"],\n  1895→      threshold: 8.5\n  1896→    },\n  1897→    content: {\n  1898→      description: \"The nose has ideal forward projection relative to the face, creating profile harmony.\",\n  1899→      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect Projection\" }\n  1900→    }\n  1901→  },\n  1902→  {\n  1903→    id: \"recessed_chin\",\n  1904→    title: \"Recessed Chin\",\n  1905→    type: \"weakness\",\n  1906→    severity_logic: {\n  1907→      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Facial Depth to Height\"],\n  1908→      threshold: 5.0\n  1909→    },\n  1910→    content: {\n  1911→      description: \"The chin sits behind the ideal position, affecting profile balance.\",\n  1912→      severity_labels: { minor: \"Slightly Recessed\", moderate: \"Recessed\", severe: \"Severely Recessed\" }\n  1913→    }\n  1914→  },\n  1915→  {\n  1916→    id: \"ideal_chin_projection\",\n  1917→    title: \"Ideal Chin Projection\",\n  1918→    type: \"strength\",\n  1919→    severity_logic: {\n  1920→      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Anterior Facial Depth\"],\n  1921→      threshold: 8.5\n  1922→    },\n  1923→    content: {\n  1924→      description: \"The chin demonstrates ideal projection and proportions relative to the face.\",\n  1925→      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect\" }\n  1926→    }\n  1927→  },\n  1928→  {\n  1929→    id: \"long_philtrum\",\n  1930→    title: \"Long Philtrum\",\n  1931→    type: \"weakness\",\n  1932→    severity_logic: {\n  1933→      metrics: [\"Philtrum Length\", \"Lip Chin Distance\", \"Upper Lip Height\"],\n  1934→      threshold: 5.5\n  1935→    },\n  1936→    content: {\n  1937→      description: \"The distance between nose and upper lip is longer than ideal.\",\n  1938→      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n  1939→    }\n  1940→  },\n  1941→  {\n  1942→    id: \"short_philtrum\",\n  1943→    title: \"Short Philtrum\",\n  1944→    type: \"strength\",\n  1945→    severity_logic: {\n  1946→      metrics: [\"Philtrum Length\", \"Upper Lip Height\"],\n  1947→      threshold: 8.0\n  1948→    },\n  1949→    content: {\n  1950→      description: \"The philtrum has ideal or shorter length, considered youthful and attractive.\",\n  1951→      grade_labels: { good: \"Good Length\", excellent: \"Short\", ideal: \"Ideal\" }\n  1952→    }\n  1953→  },\n  1954→  {\n  1955→    id: \"wide_nose\",\n  1956→    title: \"Wide Nasal Base\",\n  1957→    type: \"weakness\",\n  1958→    severity_logic: {\n  1959→      metrics: [\"Nasal Index\", \"Intercanthal Nasal Ratio\", \"Nose Bridge Width\"],\n  1960→      threshold: 5.0\n  1961→    },\n  1962→    content: {\n  1963→      description: \"The base of the nose is wider than the aesthetic ideal for facial harmony.\",\n  1964→      severity_labels: { minor: \"Slightly Wide\", moderate: \"Wide\", severe: \"Very Wide\" }\n  1965→    }\n  1966→  },\n  1967→  {\n  1968→    id: \"ideal_brow_position\",\n  1969→    title: \"Ideal Brow Position\",\n  1970→    type: \"strength\",\n  1971→    severity_logic: {\n  1972→      metrics: [\"Eyebrow Height\", \"Brow Length Ratio\"],\n  1973→      threshold: 8.0\n  1974→    },\n  1975→    content: {\n  1976→      description: \"The eyebrows are ideally positioned relative to the eyes and facial structure.\",\n  1977→      grade_labels: { good: \"Good Position\", excellent: \"Well-Arched\", ideal: \"Perfect Frame\" }\n  1978→    }\n  1979→  },\n  1980→  {\n  1981→    id: \"narrow_jaw\",\n  1982→    title: \"Narrow Jaw\",\n  1983→    type: \"weakness\",\n  1984→    severity_logic: {\n  1985→      metrics: [\"Jaw Width Ratio\", \"Bigonial Width\", \"Jaw Frontal Angle\"],\n  1986→      threshold: 5.0\n  1987→    },\n  1988→    content: {\n  1989→      description: \"The jaw is narrower than ideal, affecting lower face width and definition.\",\n  1990→      severity_labels: { minor: \"Slightly Narrow\", moderate: \"Narrow\", severe: \"Very Narrow\" }\n  1991→    }\n  1992→  },\n  1993→  {\n  1994→    id: \"steep_mandibular_plane\",\n  1995→    title: \"Steep Mandibular Plane\",\n  1996→    type: \"weakness\",\n  1997→    severity_logic: {\n  1998→      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n  1999→      threshold: 5.0\n  2000→    },\n  2001→    content: {\n  2002→      description: \"The mandibular plane angle is steeper than ideal, often indicating vertical growth pattern.\",\n  2003→      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n  2004→    }\n  2005→  },\n  2006→  // ============================================\n  2007→  // INSIGHT DEFINITIONS (element.html / element1.html)\n  2008→  // ============================================\n  2009→  // --- WEAKNESSES ---\n  2010→  {\n  2011→    id: \"steep_jaw\",\n  2012→    title: \"Steep Jaw\",\n  2013→    type: \"weakness\",\n  2014→    severity_logic: {\n  2015→      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Jaw Frontal Angle\"],\n  2016→      threshold: 6.0\n  2017→    },\n  2018→    content: {\n  2019→      description: \"The jaw angles sharply downward, creating a narrow or pointed chin effect.\",\n  2020→      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n  2021→    }\n  2022→  },\n  2023→  {\n  2024→    id: \"maxillary_recession\",\n  2025→    title: \"Maxillary Recession\",\n  2026→    type: \"weakness\",\n  2027→    severity_logic: {\n  2028→      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Facial Depth to Height Ratio\"],\n  2029→      threshold: 6.0\n  2030→    },\n  2031→    content: {\n  2032→      description: \"The upper jaw is less forward than ideal, reducing midface projection and facial harmony.\",\n  2033→      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n  2034→    }\n  2035→  },\n  2036→  {\n  2037→    id: \"mandibular_recession\",\n  2038→    title: \"Mandibular Recession\",\n  2039→    type: \"weakness\",\n  2040→    severity_logic: {\n  2041→      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\"],\n  2042→      threshold: 6.0\n  2043→    },\n  2044→    content: {\n  2045→      description: \"The lower jaw is set back, creating a less prominent chin and an unbalanced profile.\",\n  2046→      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n  2047→    }\n  2048→  },\n  2049→  {\n  2050→    id: \"underprojected_chin\",\n  2051→    title: \"Underprojected Chin\",\n  2052→    type: \"weakness\",\n  2053→    severity_logic: {\n  2054→      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\", \"Chin Height\"],\n  2055→      threshold: 6.0\n  2056→    },\n  2057→    content: {\n  2058→      description: \"The chin lacks forward projection, creating a weak lower face appearance.\",\n  2059→      severity_labels: { minor: \"Slightly Weak\", moderate: \"Underprojected\", severe: \"Severely Underprojected\" }\n  2060→    }\n  2061→  },\n  2062→  {\n  2063→    id: \"overly_long_face\",\n  2064→    title: \"Overly Long Face Shape\",\n  2065→    type: \"weakness\",\n  2066→    severity_logic: {\n  2067→      metrics: [\"Total Facial Width to Height Ratio\", \"Face Width to Height Ratio\"],\n  2068→      threshold: 6.0\n  2069→    },\n  2070→    content: {\n  2071→      description: \"The face is excessively tall and narrow, creating an elongated appearance.\",\n  2072→      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n  2073→    }\n  2074→  },\n  2075→  {\n  2076→    id: \"hyper_divergent_jaw\",\n  2077→    title: \"Hyper-Divergent Jaw Growth\",\n  2078→    type: \"weakness\",\n  2079→    severity_logic: {\n  2080→      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n  2081→      threshold: 5.5\n  2082→    },\n  2083→    content: {\n  2084→      description: \"The jaw grows with an overly steep angle, resulting in a long or narrow lower face. This can indicate malocclusion.\",\n  2085→      severity_labels: { minor: \"Mildly Divergent\", moderate: \"Divergent\", severe: \"Hyper-Divergent\" }\n  2086→    }\n  2087→  },\n  2088→  {\n  2089→    id: \"weak_brow_ridge\",\n  2090→    title: \"Soft/Weak Brow Ridge\",\n  2091→    type: \"weakness\",\n  2092→    severity_logic: {\n  2093→      metrics: [\"Browridge Inclination Angle\", \"Eyebrow Height\"],\n  2094→      threshold: 5.5\n  2095→    },\n  2096→    content: {\n  2097→      description: \"The forehead has a softer, less prominent ridge than the ideal, reducing masculine definition.\",\n  2098→      severity_labels: { minor: \"Slightly Soft\", moderate: \"Soft\", severe: \"Very Weak\" }\n  2099→    }\n  2100→  },\n  2101→  {\n  2102→    id: \"droopy_nasal_tip\",\n  2103→    title: \"Droopy Nasal Tip\",\n  2104→    type: \"weakness\",\n  2105→    severity_logic: {\n  2106→      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\", \"Nasofacial Angle\"],\n  2107→      threshold: 5.5\n  2108→    },\n  2109→    content: {\n  2110→      description: \"The nasal tip points downward more than ideal, creating a drooping appearance.\",\n  2111→      severity_labels: { minor: \"Slightly Droopy\", moderate: \"Droopy\", severe: \"Very Droopy\" }\n  2112→    }\n  2113→  },\n  2114→  {\n  2115→    id: \"overprojected_nose\",\n  2116→    title: \"Overprojected Nose\",\n  2117→    type: \"weakness\",\n  2118→    severity_logic: {\n  2119→      metrics: [\"Nasal Projection\", \"Nasofacial Angle\", \"Nose Length Ratio\"],\n  2120→      threshold: 5.5\n  2121→    },\n  2122→    content: {\n  2123→      description: \"The nose projects too far forward relative to the face, creating imbalance.\",\n  2124→      severity_labels: { minor: \"Slightly Projected\", moderate: \"Overprojected\", severe: \"Very Overprojected\" }\n  2125→    }\n  2126→  },\n  2127→  {\n  2128→    id: \"small_eyes\",\n  2129→    title: \"Small Eyes\",\n  2130→    type: \"weakness\",\n  2131→    severity_logic: {\n  2132→      metrics: [\"Eye Aspect Ratio\", \"Palpebral Fissure Length\", \"Eye Width\"],\n  2133→      threshold: 5.5\n  2134→    },\n  2135→    content: {\n  2136→      description: \"The eyes appear smaller than the aesthetic ideal relative to the face.\",\n  2137→      severity_labels: { minor: \"Slightly Small\", moderate: \"Small\", severe: \"Very Small\" }\n  2138→    }\n  2139→  },\n  2140→  {\n  2141→    id: \"low_set_eyebrows\",\n  2142→    title: \"Low-Set Eyebrows\",\n  2143→    type: \"weakness\",\n  2144→    severity_logic: {\n  2145→      metrics: [\"Eyebrow Height\", \"Brow to Hairline Distance\"],\n  2146→      threshold: 5.5\n  2147→    },\n  2148→    content: {\n  2149→      description: \"The eyebrows sit lower than ideal, reducing the visible upper eyelid space.\",\n  2150→      severity_labels: { minor: \"Slightly Low\", moderate: \"Low\", severe: \"Very Low\" }\n  2151→    }\n  2152→  },\n  2153→  {\n  2154→    id: \"asymmetrical_face\",\n  2155→    title: \"Facial Asymmetry\",\n  2156→    type: \"weakness\",\n  2157→    severity_logic: {\n  2158→      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n  2159→      threshold: 5.5\n  2160→    },\n  2161→    content: {\n  2162→      description: \"The left and right sides of the face show noticeable differences in proportion or position.\",\n  2163→      severity_labels: { minor: \"Slight Asymmetry\", moderate: \"Noticeable Asymmetry\", severe: \"Significant Asymmetry\" }\n  2164→    }\n  2165→  },\n  2166→  // --- STRENGTHS ---\n  2167→  {\n  2168→    id: \"good_jaw_width\",\n  2169→    title: \"Good Jaw Width\",\n  2170→    type: \"strength\",\n  2171→    severity_logic: {\n  2172→      metrics: [\"Bigonial Width\", \"Jaw Width Ratio\", \"Jaw Frontal Angle\"],\n  2173→      threshold: 8.5\n  2174→    },\n  2175→    content: {\n  2176→      description: \"This contributes to a pleasant jaw contour due to the jaw being neither too wide nor too narrow.\",\n  2177→      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n  2178→    }\n  2179→  },\n  2180→  {\n  2181→    id: \"good_forehead_slope\",\n  2182→    title: \"Good Forehead Slope\",\n  2183→    type: \"strength\",\n  2184→    severity_logic: {\n  2185→      metrics: [\"Browridge Inclination Angle\", \"Forehead Height\"],\n  2186→      threshold: 8.5\n  2187→    },\n  2188→    content: {\n  2189→      description: \"This contributes to a pleasant forehead contour by indicating that the forehead is neither too steep nor too flat.\",\n  2190→      grade_labels: { good: \"Good Slope\", excellent: \"Well-Angled\", ideal: \"Ideal Slope\" }\n  2191→    }\n  2192→  },\n  2193→  {\n  2194→    id: \"good_cupids_bow\",\n  2195→    title: \"Good Cupid's Bow Depth\",\n  2196→    type: \"strength\",\n  2197→    severity_logic: {\n  2198→      metrics: [\"Cupids Bow Depth\", \"Upper Lip Height\"],\n  2199→      threshold: 8.5\n  2200→    },\n  2201→    content: {\n  2202→      description: \"This contributes to a harmonious lip region due to the cupid's bow having ideal definition and depth.\",\n  2203→      grade_labels: { good: \"Defined\", excellent: \"Well-Defined\", ideal: \"Perfectly Defined\" }\n  2204→    }\n  2205→  },\n  2206→  {\n  2207→    id: \"good_eyebrow_length\",\n  2208→    title: \"Good Eyebrow Length\",\n  2209→    type: \"strength\",\n  2210→    severity_logic: {\n  2211→      metrics: [\"Brow Length to Face Width Ratio\", \"Brow Length Ratio\"],\n  2212→      threshold: 8.5\n  2213→    },\n  2214→    content: {\n  2215→      description: \"This contributes to a harmonious eye region due to the eyebrows having ideal horizontal length relative to face width.\",\n  2216→      grade_labels: { good: \"Good Length\", excellent: \"Well-Proportioned\", ideal: \"Ideal Length\" }\n  2217→    }\n  2218→  },\n  2219→  {\n  2220→    id: \"good_neck_width\",\n  2221→    title: \"Good Neck Width\",\n  2222→    type: \"strength\",\n  2223→    severity_logic: {\n  2224→      metrics: [\"Neck Width\", \"Neck to Jaw Ratio\"],\n  2225→      threshold: 8.5\n  2226→    },\n  2227→    content: {\n  2228→      description: \"This contributes to a harmonious lower face due to the neck being neither too wide nor too thin.\",\n  2229→      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n  2230→    }\n  2231→  },\n  2232→  {\n  2233→    id: \"ideal_nasolabial_angle\",\n  2234→    title: \"Ideal Nasolabial Angle\",\n  2235→    type: \"strength\",\n  2236→    severity_logic: {\n  2237→      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\"],\n  2238→      threshold: 8.5\n  2239→    },\n  2240→    content: {\n  2241→      description: \"The angle between nose and upper lip is in the ideal range, creating profile harmony.\",\n  2242→      grade_labels: { good: \"Good Angle\", excellent: \"Well-Angled\", ideal: \"Perfect Angle\" }\n  2243→    }\n  2244→  },\n  2245→  {\n  2246→    id: \"ideal_facial_depth\",\n  2247→    title: \"Ideal Facial Depth\",\n  2248→    type: \"strength\",\n  2249→    severity_logic: {\n  2250→      metrics: [\"Facial Depth to Height Ratio\", \"Anterior Facial Depth\"],\n  2251→      threshold: 8.5\n  2252→    },\n  2253→    content: {\n  2254→      description: \"The face has ideal forward projection creating attractive three-dimensional contours.\",\n  2255→      grade_labels: { good: \"Good Depth\", excellent: \"Well-Projected\", ideal: \"Ideal Projection\" }\n  2256→    }\n  2257→  },\n  2258→  {\n  2259→    id: \"ideal_eye_shape\",\n  2260→    title: \"Ideal Eye Shape\",\n  2261→    type: \"strength\",\n  2262→    severity_logic: {\n  2263→      metrics: [\"Eye Aspect Ratio\", \"Lateral Canthal Tilt\", \"Palpebral Fissure Length\"],\n  2264→      threshold: 8.5\n  2265→    },\n  2266→    content: {\n  2267→      description: \"The eyes have an attractive almond shape with ideal proportions and tilt.\",\n  2268→      grade_labels: { good: \"Attractive\", excellent: \"Well-Shaped\", ideal: \"Hunter Eyes\" }\n  2269→    }\n  2270→  },\n  2271→  {\n  2272→    id: \"harmonious_profile\",\n  2273→    title: \"Harmonious Profile\",\n  2274→    type: \"strength\",\n  2275→    severity_logic: {\n  2276→      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Total Profile Angle\"],\n  2277→      threshold: 8.5\n  2278→    },\n  2279→    content: {\n  2280→      description: \"The facial profile shows excellent balance between nose, lips, and chin positions.\",\n  2281→      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfect Profile\" }\n  2282→    }\n  2283→  },\n  2284→  {\n  2285→    id: \"good_facial_symmetry\",\n  2286→    title: \"Good Facial Symmetry\",\n  2287→    type: \"strength\",\n  2288→    severity_logic: {\n  2289→      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n  2290→      threshold: 8.5\n  2291→    },\n  2292→    content: {\n  2293→      description: \"The face displays excellent bilateral symmetry, a key component of attractiveness.\",\n  2294→      grade_labels: { good: \"Symmetric\", excellent: \"Very Symmetric\", ideal: \"Near-Perfect Symmetry\" }\n  2295→    }\n  2296→  }\n  2297→];\n  2298→\n  2299→// ============================================\n  2300→// METRIC NAME MAPPING\n  2301→// ============================================\n  2302→\n  2303→// Map display names to metric IDs for lookup\n  2304→const METRIC_NAME_TO_ID: Record<string, string> = {\n  2305→  // Face Shape/Proportions\n  2306→  \"Face Width to Height Ratio\": \"faceWidthToHeight\",\n  2307→  \"Total Facial Width to Height\": \"totalFacialWidthToHeight\",\n  2308→  \"Total Facial Width to Height Ratio\": \"totalFacialWidthToHeight\",\n  2309→  \"Midface Ratio\": \"midfaceRatio\",\n  2310→  \"Upper Third Proportion\": \"upperThirdProportion\",\n  2311→  \"Middle Third Proportion\": \"middleThirdProportion\",\n  2312→  \"Lower Third Proportion\": \"lowerThirdProportion\",\n  2313→  \"Cheekbone Height\": \"cheekboneHeight\",\n  2314→  \"Cheekbone Width\": \"cheekboneWidth\",\n  2315→  \"Bitemporal Width\": \"bitemporalWidth\",\n  2316→  \"Forehead Height\": \"foreheadHeight\",\n  2317→  \"Facial Asymmetry Index\": \"facialAsymmetryIndex\",\n  2318→\n  2319→  // Jaw\n  2320→  \"Gonial Angle\": \"gonialAngle\",\n  2321→  \"Mandibular Plane Angle\": \"mandibularPlaneAngle\",\n  2322→  \"Jaw Width Ratio\": \"jawWidthRatio\",\n  2323→  \"Bigonial Width\": \"bigonialWidth\",\n  2324→  \"Jaw Frontal Angle\": \"jawFrontalAngle\",\n  2325→  \"Jaw Slope\": \"jawSlope\",\n  2326→  \"Jaw Asymmetry\": \"jawAsymmetry\",\n  2327→\n  2328→  // Chin\n  2329→  \"Chin to Philtrum Ratio\": \"chinPhiltrumRatio\",\n  2330→  \"Chin Height\": \"chinHeight\",\n  2331→  \"Facial Depth to Height\": \"facialDepthToHeight\",\n  2332→  \"Facial Depth to Height Ratio\": \"facialDepthToHeight\",\n  2333→  \"Anterior Facial Depth\": \"anteriorFacialDepth\",\n  2334→  \"Recession Relative to Frankfort Plane\": \"recessionFrankfort\",\n  2335→\n  2336→  // Eyes\n  2337→  \"Lateral Canthal Tilt\": \"lateralCanthalTilt\",\n  2338→  \"Eye Aspect Ratio\": \"eyeAspectRatio\",\n  2339→  \"Eye Separation Ratio\": \"eyeSeparationRatio\",\n  2340→  \"Interpupillary Ratio\": \"interpupillaryRatio\",\n  2341→  \"One Eye Apart Test\": \"oneEyeApartTest\",\n  2342→  \"Intercanthal Width\": \"intercanthalWidth\",\n  2343→  \"Eyebrow Height\": \"eyebrowHeight\",\n  2344→  \"Brow Length Ratio\": \"browLengthRatio\",\n  2345→  \"Brow Length to Face Width Ratio\": \"browLengthToFaceWidth\",\n  2346→  \"Palpebral Fissure Length\": \"palpebralFissureLength\",\n  2347→  \"Eye Width\": \"eyeWidth\",\n  2348→  \"Eye Asymmetry\": \"eyeAsymmetry\",\n  2349→  \"Brow to Hairline Distance\": \"browToHairlineDistance\",\n  2350→\n  2351→  // Brow\n  2352→  \"Browridge Inclination Angle\": \"browridgeInclinationAngle\",\n  2353→\n  2354→  // Nose\n  2355→  \"Nasal Index\": \"nasalIndex\",\n  2356→  \"Nasal Tip Angle\": \"nasalTipAngle\",\n  2357→  \"Nose Tip Position\": \"noseTipPosition\",\n  2358→  \"Frankfort-tip Angle\": \"frankfortTipAngle\",\n  2359→  \"Nasofrontal Angle\": \"nasofrontalAngle\",\n  2360→  \"Nasofacial Angle\": \"nasofacialAngle\",\n  2361→  \"Nasomenta Angle\": \"nasomentaAngle\",\n  2362→  \"Nasomental Angle\": \"nasomentaAngle\",\n  2363→  \"Intercanthal Nasal Ratio\": \"intercanthalNasalRatio\",\n  2364→  \"Nose Bridge Width\": \"noseBridgeWidth\",\n  2365→  \"Nose Width\": \"noseWidth\",\n  2366→  \"Nasal Projection\": \"nasalProjection\",\n  2367→  \"Nose Length Ratio\": \"noseLengthRatio\",\n  2368→  \"Ipsilateral Alar Angle\": \"ipsilateralAlarAngle\",\n  2369→\n  2370→  // Lips\n  2371→  \"Lip Ratio\": \"lipRatio\",\n  2372→  \"Philtrum Length\": \"philtrumLength\",\n  2373→  \"Upper Lip Projection\": \"upperLipProjection\",\n  2374→  \"Lower Lip Projection\": \"lowerLipProjection\",\n  2375→  \"Lip Chin Distance\": \"lipChinDistance\",\n  2376→  \"Upper Lip Height\": \"upperLipHeight\",\n  2377→  \"Upper Lip E-Line Position\": \"upperLipELine\",\n  2378→  \"Upper Lip S-Line Position\": \"upperLipSLine\",\n  2379→  \"Nasolabial Angle\": \"nasolabialAngle\",\n  2380→  \"Cupids Bow Depth\": \"cupidsBowDepth\",\n  2381→\n  2382→  // Neck\n  2383→  \"Neck Width\": \"neckWidth\",\n  2384→  \"Neck to Jaw Ratio\": \"neckToJawRatio\",\n  2385→\n  2386→  // Profile\n  2387→  \"Total Profile Angle\": \"totalProfileAngle\",\n  2388→};\n  2389→\n  2390→// ============================================\n  2391→// CLASSIFICATION FUNCTIONS\n  2392→// ============================================\n  2393→\n  2394→/**\n  2395→ * Get weakness severity based on average score\n  2396→ * 0-3 = \"Severe\", 3-5 = \"Moderate\", 5-7 = \"Minor\"\n  2397→ */\n  2398→function getWeaknessSeverity(avgScore: number): WeaknessSeverity {\n  2399→  if (avgScore <= 3) return 'severe';\n  2400→  if (avgScore <= 5) return 'moderate';\n  2401→  return 'minor';\n  2402→}\n  2403→\n  2404→/**\n  2405→ * Get strength grade based on average score\n  2406→ * 8-9 = \"Good\", 9-9.5 = \"Excellent\", 9.5-10 = \"Ideal\"\n  2407→ */\n  2408→function getStrengthGrade(avgScore: number): StrengthGrade {\n  2409→  if (avgScore >= 9.5) return 'ideal';\n  2410→  if (avgScore >= 9) return 'excellent';\n  2411→  return 'good';\n  2412→}\n  2413→\n  2414→/**\n  2415→ * Find metric by display name from measurements array\n  2416→ */\n  2417→function findMetricByName(\n  2418→  metricName: string,\n  2419→  measurements: MetricScoreResult[]\n  2420→): MetricScoreResult | undefined {\n  2421→  // First try direct ID mapping\n  2422→  const metricId = METRIC_NAME_TO_ID[metricName];\n  2423→  if (metricId) {\n  2424→    return measurements.find(m => m.metricId === metricId);\n  2425→  }\n  2426→\n  2427→  // Fallback: try fuzzy matching on name\n  2428→  const normalizedName = metricName.toLowerCase().replace(/[^a-z0-9]/g, '');\n  2429→  return measurements.find(m => {\n  2430→    const normalizedMetricName = m.name.toLowerCase().replace(/[^a-z0-9]/g, '');\n  2431→    return normalizedMetricName.includes(normalizedName) ||\n  2432→           normalizedName.includes(normalizedMetricName);\n  2433→  });\n  2434→}\n  2435→\n  2436→/**\n  2437→ * Check if a metric should be considered a \"false positive\" weakness.\n  2438→ * This handles directional/dimorphic metrics where low scores don't mean weakness.\n  2439→ *\n  2440→ * Example: Canthal Tilt of 3° gets a low score (not in 6-8° ideal range)\n  2441→ * but is still a POSITIVE trait, not a weakness.\n  2442→ */\n  2443→function isFalsePositiveWeakness(metric: MatchedMetric): boolean {\n  2444→  const config = METRIC_CONFIGS[metric.metricId];\n  2445→  if (!config) return false;\n  2446→\n  2447→  // Check if the value is actually acceptable based on polarity\n  2448→  const { acceptable } = isValueAcceptable(metric.value, config);\n  2449→  return acceptable;\n  2450→}\n  2451→\n  2452→/**\n  2453→ * Process all insight definitions against user's measurements\n  2454→ */\n  2455→export function classifyInsights(\n  2456→  measurements: MetricScoreResult[],\n  2457→  insightDefinitions: InsightDefinition[] = INSIGHTS_DEFINITIONS\n  2458→): InsightClassificationResult {\n  2459→  const strengths: ClassifiedStrength[] = [];\n  2460→  const weaknesses: ClassifiedWeakness[] = [];\n  2461→\n  2462→  for (const insight of insightDefinitions) {\n  2463→    const { metrics, threshold } = insight.severity_logic;\n  2464→\n  2465→    // Find matching measurements for this insight\n  2466→    const matchedMetrics: MatchedMetric[] = [];\n  2467→    for (const metricName of metrics) {\n  2468→      const measurement = findMetricByName(metricName, measurements);\n  2469→      if (measurement) {\n  2470→        matchedMetrics.push({\n  2471→          metricId: measurement.metricId,\n  2472→          metricName: measurement.name,\n  2473→          score: measurement.score,\n  2474→          value: measurement.value,\n  2475→          idealMin: measurement.idealMin,\n  2476→          idealMax: measurement.idealMax,\n  2477→          unit: measurement.unit,\n  2478→          category: measurement.category,\n  2479→        });\n  2480→      }\n  2481→    }\n  2482→\n  2483→    // Skip if no metrics matched (need at least 1)\n  2484→    if (matchedMetrics.length === 0) continue;\n  2485→\n  2486→    // Calculate average score\n  2487→    const avgScore = matchedMetrics.reduce((sum, m) => sum + m.score, 0) / matchedMetrics.length;\n  2488→\n  2489→    // Classify based on type and threshold\n  2490→    if (insight.type === 'weakness') {\n  2491→      // Weakness: avg < threshold → add to areas of improvement\n  2492→      if (avgScore < threshold) {\n  2493→        // ========== FALSE POSITIVE CHECK ==========\n  2494→        // Before adding to weaknesses, check if ANY of the matched metrics\n  2495→        // are actually in an \"acceptable\" zone based on their polarity.\n  2496→        // If so, this is a false positive and should be skipped or reclassified.\n  2497→        const falsePositiveMetrics = matchedMetrics.filter(isFalsePositiveWeakness);\n  2498→\n  2499→        // If ALL matched metrics are false positives, skip this weakness entirely\n  2500→        if (falsePositiveMetrics.length === matchedMetrics.length) {\n  2501→          // This is a false positive weakness - the values are actually acceptable\n  2502→          // Consider adding to strengths if scores are decent\n  2503→          if (avgScore >= 6) {\n  2504→            strengths.push({\n  2505→              insightId: `${insight.id}_acceptable`,\n  2506→              title: insight.title.replace('Negative', 'Neutral').replace('Weak', 'Moderate'),\n  2507→              description: `While not in the peak ideal range, the measured values are within acceptable limits.`,\n  2508→              grade: 'good',\n  2509→              gradeLabel: 'Acceptable',\n  2510→              avgScore,\n  2511→              matchedMetrics,\n  2512→            });\n  2513→          }\n  2514→          continue; // Skip adding as weakness\n  2515→        }\n  2516→\n  2517→        // If SOME metrics are false positives, filter them out\n  2518→        const trueWeaknessMetrics = matchedMetrics.filter(m => !isFalsePositiveWeakness(m));\n  2519→        if (trueWeaknessMetrics.length === 0) continue;\n  2520→\n  2521→        // Recalculate average with only true weakness metrics\n  2522→        const trueAvgScore = trueWeaknessMetrics.reduce((sum, m) => sum + m.score, 0) / trueWeaknessMetrics.length;\n  2523→\n  2524→        // Only add as weakness if true average is still below threshold\n  2525→        if (trueAvgScore < threshold) {\n  2526→          const severity = getWeaknessSeverity(trueAvgScore);\n  2527→          const labels = insight.content.severity_labels;\n  2528→          const severityLabel = labels?.[severity] || severity;\n  2529→\n  2530→          weaknesses.push({\n  2531→            insightId: insight.id,\n  2532→            title: insight.title,\n  2533→            description: insight.content.description,\n  2534→            severity,\n  2535→            severityLabel,\n  2536→            avgScore: trueAvgScore,\n  2537→            matchedMetrics: trueWeaknessMetrics,\n  2538→          });\n  2539→        }\n  2540→      }\n  2541→    } else {\n  2542→      // Strength: avg > threshold → add to key strengths\n  2543→      if (avgScore > threshold) {\n  2544→        const grade = getStrengthGrade(avgScore);\n  2545→        const labels = insight.content.grade_labels;\n  2546→        const gradeLabel = labels?.[grade] || grade;\n  2547→\n  2548→        strengths.push({\n  2549→          insightId: insight.id,\n  2550→          title: insight.title,\n  2551→          description: insight.content.description,\n  2552→          grade,\n  2553→          gradeLabel,\n  2554→          avgScore,\n  2555→          matchedMetrics,\n  2556→        });\n  2557→      }\n  2558→    }\n  2559→  }\n  2560→\n  2561→  // Sort by score (weaknesses by lowest score first, strengths by highest first)\n  2562→  weaknesses.sort((a, b) => a.avgScore - b.avgScore);\n  2563→  strengths.sort((a, b) => b.avgScore - a.avgScore);\n  2564→\n  2565→  return { strengths, weaknesses };\n  2566→}\n  2567→\n  2568→/**\n  2569→ * Convert ClassifiedStrength to Strength type for UI compatibility\n  2570→ */\n  2571→export function convertToStrength(classified: ClassifiedStrength): Strength {\n  2572→  return {\n  2573→    id: `insight_strength_${classified.insightId}`,\n  2574→    strengthName: `${classified.title} (${classified.gradeLabel})`,\n  2575→    summary: classified.description,\n  2576→    avgScore: classified.avgScore,\n  2577→    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n  2578→                  classified.grade === 'excellent' ? 'excellent' : 'good',\n  2579→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2580→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2581→      ratioName: m.metricName,\n  2582→      ratioId: m.metricId,\n  2583→      score: m.score,\n  2584→      value: m.value,\n  2585→      idealMin: m.idealMin,\n  2586→      idealMax: m.idealMax,\n  2587→      unit: m.unit,\n  2588→      category: m.category,\n  2589→    })),\n  2590→  };\n  2591→}\n  2592→\n  2593→/**\n  2594→ * Convert ClassifiedWeakness to Flaw type for UI compatibility\n  2595→ */\n  2596→export function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  2597→  const impact = (10 - classified.avgScore) * 0.5;\n  2598→  const newRollingLost = rollingLost + impact;\n  2599→\n  2600→  return {\n  2601→    id: `insight_flaw_${classified.insightId}`,\n  2602→    flawName: `${classified.title} (${classified.severityLabel})`,\n  2603→    summary: classified.description,\n  2604→    harmonyPercentageLost: impact,\n  2605→    standardizedImpact: impact / 10,\n  2606→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2607→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2608→      ratioName: m.metricName,\n  2609→      ratioId: m.metricId,\n  2610→      score: m.score,\n  2611→      value: m.value,\n  2612→      idealMin: m.idealMin,\n  2613→      idealMax: m.idealMax,\n  2614→      unit: m.unit,\n  2615→      category: m.category,\n  2616→    })),\n  2617→    rollingPointsDeducted: newRollingLost,\n  2618→    rollingHarmonyPercentageLost: newRollingLost,\n  2619→    rollingStandardizedImpact: newRollingLost / 10,\n  2620→  };\n  2621→}\n  2622→\n  2623→/**\n  2624→ * Main function: Generate strengths and flaws from measurements using insights\n  2625→ */\n  2626→export function generateInsightBasedResults(\n  2627→  measurements: MetricScoreResult[]\n  2628→): { strengths: Strength[]; flaws: Flaw[] } {\n  2629→  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);\n  2630→\n  2631→  // Convert to UI-compatible types\n  2632→  const strengths = classifiedStrengths.map((s) => convertToStrength(s));\n  2633→\n  2634→  let rollingLost = 0;\n  2635→  const flaws = classifiedWeaknesses.map((w, i) => {\n  2636→    const flaw = convertToFlaw(w, i, rollingLost);\n  2637→    rollingLost = flaw.rollingPointsDeducted || 0;\n  2638→    return flaw;\n  2639→  });\n  2640→\n  2641→  return { strengths, flaws };\n  2642→}\n  2643→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"832d838f-ee55-44d2-8d62-cda78f28a902","timestamp":"2025-12-26T06:50:07.617Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","content":"/**\n * Insights Engine\n *\n * Processes insight definitions from insights.json and classifies them\n * as strengths or areas of improvement based on user's metric scores.\n *\n * Logic:\n * - For each insight definition, calculate average score of affected metrics\n * - Weakness: if avg score < threshold → classify with severity label\n * - Strength: if avg score > threshold → classify with grade label\n *\n * Z-Score Based 5-Tier Severity Logic:\n * - Ideal (Green): User is inside the ideal range\n * - Good (Blue): Within 0.5 Standard Deviation of the mean (|z| < 0.5)\n * - Fair (Cyan): Between 0.5 and 1 Standard Deviation (0.5 ≤ |z| < 1)\n * - Moderate (Yellow): Between 1 and 2 Standard Deviations (1 ≤ |z| < 2)\n * - Severe (Red): More than 2 Standard Deviations away (|z| ≥ 2)\n *\n * Severity Labels (Weaknesses):\n *   0-3 = \"Severe\"\n *   3-5 = \"Moderate\"\n *   5-7 = \"Minor\"\n *\n * Grade Labels (Strengths):\n *   8-9   = \"Good\"\n *   9-9.5 = \"Excellent\"\n *   9.5-10 = \"Ideal\"\n */\n\nimport { Strength, Flaw } from '@/types/results';\nimport { MetricScoreResult, METRIC_CONFIGS, isValueAcceptable } from '@/lib/harmony-scoring';\n\n// ============================================\n// MASTER SCORING DATABASE (Z-Score Based)\n// ============================================\n\nexport type SeverityLevel = 'ideal' | 'good' | 'fair' | 'moderate' | 'severe';\nexport type Gender = 'male' | 'female';\nexport type Ethnicity = 'white' | 'black' | 'east_asian' | 'south_asian' | 'hispanic' | 'middle_eastern' | 'native_american' | 'pacific_islander';\n\nexport interface MasterMetricConfig {\n  ideal: [number, number];  // [min, max] ideal range\n  mean: number;             // Population mean\n  std_dev: number;          // Standard deviation\n  flaws?: {\n    low?: string[];         // Flaws when value is too low\n    high?: string[];        // Flaws when value is too high\n  };\n}\n\n// Base/Default standards (White Male baseline)\nexport const MASTER_SCORING_DB: Record<string, MasterMetricConfig> = {\n  // MIDFACE & PROPORTIONS\n  \"midface_ratio\": {\n    ideal: [0.97, 1.00],\n    mean: 1.0,\n    std_dev: 0.115,\n    flaws: { low: [\"Long midface\", \"Long upper jaw\"] }\n  },\n  \"faceWidthToHeight\": {\n    ideal: [1.30, 1.45],\n    mean: 1.38,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Overly long face\", \"Narrow face\"],\n      high: [\"Wide face\", \"Short face\"]\n    }\n  },\n  \"totalFacialWidthToHeight\": {\n    ideal: [1.25, 1.40],\n    mean: 1.33,\n    std_dev: 0.075,\n    flaws: {\n      low: [\"Long face shape\"],\n      high: [\"Wide face shape\"]\n    }\n  },\n  \"upperThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Long forehead\"]\n    }\n  },\n  \"middleThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short midface\"],\n      high: [\"Long midface\"]\n    }\n  },\n  \"lowerThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short lower face\"],\n      high: [\"Long lower face\"]\n    }\n  },\n\n  // EYE SPACING & IPD\n  \"eye_separation_ratio\": {\n    ideal: [0.45, 0.47],\n    mean: 0.46,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"interpupillaryRatio\": {\n    ideal: [0.44, 0.48],\n    mean: 0.46,\n    std_dev: 0.025,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"oneEyeApartTest\": {\n    ideal: [0.95, 1.05],\n    mean: 1.0,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"intercanthalWidth\": {\n    ideal: [30, 35],\n    mean: 32.5,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Narrow eye spacing\"],\n      high: [\"Wide eye spacing\"]\n    }\n  },\n\n  // EYE SHAPE & FEATURES\n  \"lateralCanthalTilt\": {\n    ideal: [6, 8],\n    mean: 5.0,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Negative canthal tilt\", \"Downturned eyes\"],\n      high: [\"Excessively upturned eyes\"]\n    }\n  },\n  \"eyeAspectRatio\": {\n    ideal: [0.30, 0.35],\n    mean: 0.32,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Round eyes\"]\n    }\n  },\n  \"palpebralFissureLength\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Small eyes\"],\n      high: [\"Large eyes\"]\n    }\n  },\n  \"eyeWidth\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Wide eyes\"]\n    }\n  },\n  \"upperEyelidExposure\": {\n    ideal: [0.5, 1.2],\n    mean: 0.85,\n    std_dev: 0.35,\n    flaws: {\n      low: [\"Hooded eyes\"],\n      high: [\"Excessive upper lid exposure\"]\n    }\n  },\n  \"tearTroughDepth\": {\n    ideal: [0.0, 0.3],\n    mean: 0.15,\n    std_dev: 0.15,\n    flaws: {\n      high: [\"Dark circles / Tear troughs\", \"Under-eye hollowness\"]\n    }\n  },\n\n  // JAW ANGLES & STRUCTURE\n  \"gonial_angle\": {\n    ideal: [115, 125],\n    mean: 118.0,\n    std_dev: 6.5,\n    flaws: {\n      high: [\"Weak/soft jaw structure\", \"Rounded jaw\"]\n    }\n  },\n  \"mandibularPlaneAngle\": {\n    ideal: [20, 28],\n    mean: 24.0,\n    std_dev: 4.0,\n    flaws: {\n      low: [\"Flat mandibular plane\"],\n      high: [\"Steep mandibular plane\", \"Hyper-divergent jaw\"]\n    }\n  },\n  \"jawFrontalAngle\": {\n    ideal: [125, 135],\n    mean: 130.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Steep jaw\"],\n      high: [\"Flat jaw angle\"]\n    }\n  },\n  \"jawSlope\": {\n    ideal: [25, 35],\n    mean: 30.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat jawline\"],\n      high: [\"Steep jawline\"]\n    }\n  },\n\n  // JAW WIDTH\n  \"jawWidthRatio\": {\n    ideal: [0.85, 0.95],\n    mean: 0.90,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Narrow jaw\"],\n      high: [\"Wide jaw\"]\n    }\n  },\n  \"bigonialWidth\": {\n    ideal: [110, 125],\n    mean: 117.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow jaw width\"],\n      high: [\"Excessively wide jaw\"]\n    }\n  },\n\n  // CHEEKBONES\n  \"cheekbone_height\": {\n    ideal: [83.0, 100.0],\n    mean: 85.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Low-set cheekbones\", \"Flat midface\"]\n    }\n  },\n  \"cheekboneWidth\": {\n    ideal: [130, 145],\n    mean: 137.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow cheekbones\"],\n      high: [\"Wide cheekbones\"]\n    }\n  },\n\n  // CHIN\n  \"chinPhiltrumRatio\": {\n    ideal: [1.8, 2.2],\n    mean: 2.0,\n    std_dev: 0.2,\n    flaws: {\n      low: [\"Recessed chin\", \"Short chin\"],\n      high: [\"Long chin\", \"Projected chin\"]\n    }\n  },\n  \"chinHeight\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short chin\"],\n      high: [\"Long chin\"]\n    }\n  },\n  \"chinWidth\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Pointed/Narrow chin\"],\n      high: [\"Wide chin\"]\n    }\n  },\n\n  // NOSE ANGLES\n  \"nasalTipAngle\": {\n    ideal: [95, 115],\n    mean: 105.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nasal tip\"]\n    }\n  },\n  \"nasolabialAngle\": {\n    ideal: [95, 110],\n    mean: 102.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nose\"]\n    }\n  },\n  \"nasofrontalAngle\": {\n    ideal: [115, 135],\n    mean: 125.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Deep nasal root\"],\n      high: [\"Flat nasal root\"]\n    }\n  },\n  \"nasofacialAngle\": {\n    ideal: [30, 40],\n    mean: 35.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat nose profile\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"nasomentaAngle\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // NOSE WIDTH & PROPORTIONS\n  \"nasalIndex\": {\n    ideal: [65, 75],\n    mean: 70.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nose\", \"Bulbous nose\"]\n    }\n  },\n  \"noseWidth\": {\n    ideal: [35, 42],\n    mean: 38.5,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nasal base\"]\n    }\n  },\n  \"noseBridgeWidth\": {\n    ideal: [12, 18],\n    mean: 15.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Narrow nose bridge\"],\n      high: [\"Wide nose bridge\"]\n    }\n  },\n  \"nasalProjection\": {\n    ideal: [16, 22],\n    mean: 19.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Underprojected nose\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"noseLengthRatio\": {\n    ideal: [0.45, 0.55],\n    mean: 0.50,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short nose\"],\n      high: [\"Long nose\"]\n    }\n  },\n\n  // LIPS & PHILTRUM\n  \"lipRatio\": {\n    ideal: [1.4, 1.6],\n    mean: 1.5,\n    std_dev: 0.15,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"philtrumLength\": {\n    ideal: [11, 15],\n    mean: 13.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Short philtrum\"],\n      high: [\"Long philtrum\"]\n    }\n  },\n  \"upperLipHeight\": {\n    ideal: [18, 24],\n    mean: 21.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"lipChinDistance\": {\n    ideal: [40, 50],\n    mean: 45.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short lower third\"],\n      high: [\"Long lower third\"]\n    }\n  },\n  \"upperLipProjection\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed upper lip\"],\n      high: [\"Protruding upper lip\"]\n    }\n  },\n  \"lowerLipProjection\": {\n    ideal: [-1, 3],\n    mean: 1.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed lower lip\"],\n      high: [\"Protruding lower lip\"]\n    }\n  },\n  \"cupidsBowDepth\": {\n    ideal: [3, 6],\n    mean: 4.5,\n    std_dev: 1.5,\n    flaws: {\n      low: [\"Flat cupid's bow\"],\n      high: [\"Pronounced cupid's bow\"]\n    }\n  },\n\n  // EYEBROWS\n  \"eyebrowHeight\": {\n    ideal: [8, 14],\n    mean: 11.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Low-set eyebrows\"],\n      high: [\"High eyebrows\"]\n    }\n  },\n  \"browLengthRatio\": {\n    ideal: [0.50, 0.60],\n    mean: 0.55,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browLengthToFaceWidth\": {\n    ideal: [0.30, 0.38],\n    mean: 0.34,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browridgeInclinationAngle\": {\n    ideal: [10, 20],\n    mean: 15.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat brow ridge\"],\n      high: [\"Prominent brow ridge\"]\n    }\n  },\n  \"eyebrowThickness\": {\n    ideal: [1.5, 3.0],\n    mean: 2.25,\n    std_dev: 0.75,\n    flaws: {\n      low: [\"Sparse/Weak eyebrows\"],\n      high: [\"Overly thick eyebrows\"]\n    }\n  },\n\n  // FOREHEAD\n  \"foreheadHeight\": {\n    ideal: [55, 70],\n    mean: 62.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Tall forehead\"]\n    }\n  },\n  \"bitemporalWidth\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow forehead\"],\n      high: [\"Wide forehead\"]\n    }\n  },\n\n  // PROFILE & DEPTH\n  \"facialDepthToHeight\": {\n    ideal: [0.75, 0.85],\n    mean: 0.80,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Flat facial profile\"],\n      high: [\"Overprojected profile\"]\n    }\n  },\n  \"anteriorFacialDepth\": {\n    ideal: [115, 130],\n    mean: 122.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Shallow face depth\"],\n      high: [\"Deep face projection\"]\n    }\n  },\n  \"totalProfileAngle\": {\n    ideal: [165, 175],\n    mean: 170.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // ASYMMETRY\n  \"facialAsymmetryIndex\": {\n    ideal: [0, 3],\n    mean: 2.0,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Facial asymmetry\"]\n    }\n  },\n  \"eyeAsymmetry\": {\n    ideal: [0, 2],\n    mean: 1.0,\n    std_dev: 1.0,\n    flaws: {\n      high: [\"Eye asymmetry\"]\n    }\n  },\n  \"jawAsymmetry\": {\n    ideal: [0, 3],\n    mean: 1.5,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Jaw asymmetry\"]\n    }\n  },\n\n  // OTHER\n  \"recessionFrankfort\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Maxillary recession\"],\n      high: [\"Maxillary protrusion\"]\n    }\n  },\n  \"neckWidth\": {\n    ideal: [110, 130],\n    mean: 120.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Wide neck\"]\n    }\n  },\n  \"neckToJawRatio\": {\n    ideal: [0.90, 1.10],\n    mean: 1.0,\n    std_dev: 0.10,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Thick neck\"]\n    }\n  }\n};\n\n// ============================================\n// ETHNICITY-SPECIFIC OVERRIDES\n// ============================================\n\n/**\n * Ethnicity and gender-specific metric standards\n * These override the base MASTER_SCORING_DB values for specific populations\n */\nexport const ETHNICITY_OVERRIDES: Record<string, Record<string, Partial<MasterMetricConfig>>> = {\n  // ========================================\n  // MALE WHITE STANDARDS (Neoclassical Baseline)\n  // ========================================\n  \"male_white\": {\n    // NOSE WIDTH - Strict 1:1 ratio (Eye Width = Nose Width)\n    \"noseWidth\": {\n      ideal: [35, 42],  // Corresponds to alar_base_ratio [0.98, 1.05]\n      mean: 38.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // MIDFACE - Prefers compact midface (Hunter look)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    },\n\n    // JAW - Square/Robust jaw preference\n    \"gonial_angle\": {\n      ideal: [115.0, 125.0],\n      mean: 120.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/Soft jaw structure\"]\n      }\n    },\n\n    // FACE WIDTH - Standard Mesoprosopic range\n    \"faceWidthToHeight\": {\n      ideal: [1.90, 2.05],\n      mean: 1.975,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Short/Wide face\"]\n      }\n    },\n\n    // EYE TILT - Neutral to slightly positive\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 8.0],\n      mean: 6.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Negative canthal tilt\"]\n      }\n    },\n\n    // LOWER FACE BALANCE\n    \"chinPhiltrumRatio\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Long philtrum / Short chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE BLACK / AFRICAN STANDARDS\n  // ========================================\n  \"male_black\": {\n    // NOSE WIDTH - Significantly wider tolerance\n    \"noseWidth\": {\n      ideal: [40, 50],  // Wider range (corresponds to alar_base_ratio [1.12, 1.25])\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n    \"nasalIndex\": {\n      ideal: [80, 95],  // Wider nasal index\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n\n    // LIPS - Prefers fuller lips\n    \"lipRatio\": {\n      ideal: [1.2, 1.5],\n      mean: 1.35,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    },\n\n    // PHILTRUM - Shorter visible philtrum is ideal\n    \"philtrumLength\": {\n      ideal: [11.0, 14.0],\n      mean: 12.5,\n      std_dev: 1.5,\n      flaws: {\n        high: [\"Long philtrum\"]\n      }\n    },\n\n    // CHIN - Adjusts for natural forward mouth projection (Prognathism)\n    \"chinPhiltrumRatio\": {\n      ideal: [1.80, 2.10],  // Lower range to account for prognathism\n      mean: 1.95,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Recessed chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE EAST ASIAN STANDARDS\n  // ========================================\n  \"male_east_asian\": {\n    // EYE SPACING - Shifted WIDER for East Asian males\n    \"eye_separation_ratio\": {\n      ideal: [0.48, 0.53],  // Shifted wider (0.46 is \"close-set\" here)\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n    \"interpupillaryRatio\": {\n      ideal: [0.48, 0.53],\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n\n    // EYE SHAPE - Prefers narrower/longer eyes (Hunter Eyes)\n    \"eyeAspectRatio\": {\n      ideal: [0.25, 0.29],  // Lower ratio = more elongated\n      mean: 0.27,\n      std_dev: 0.02,\n      flaws: {\n        low: [\"Overly narrow eyes\"],\n        high: [\"Overly round eye shape\"]\n      }\n    },\n    \"palpebralFissureLength\": {\n      ideal: [29, 33],\n      mean: 31.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Small eyes\"],\n        high: [\"Large eyes\"]\n      }\n    },\n\n    // NOSE - Asian noses typically allowed to be wider\n    \"nasalIndex\": {\n      ideal: [75, 85],\n      mean: 80.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n    \"noseWidth\": {\n      ideal: [38, 45],\n      mean: 41.5,\n      std_dev: 3.5,\n      flaws: {\n        low: [\"Narrow nose\"],\n        high: [\"Very wide nasal base\"]\n      }\n    },\n    \"noseBridgeWidth\": {\n      ideal: [14, 20],\n      mean: 17.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Narrow nose bridge\"],\n        high: [\"Wide nose bridge\"]\n      }\n    },\n\n    // CHEEKS - Rewards slightly fuller cheeks (Youth/K-Pop aesthetic)\n    \"cheekbone_height\": {\n      ideal: [80.0, 95.0],\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Hollow face\"]\n      }\n    },\n\n    // JAW - Slightly softer angles acceptable\n    \"gonial_angle\": {\n      ideal: [118, 128],\n      mean: 123.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/soft jaw structure\"]\n      }\n    },\n    \"mandibularPlaneAngle\": {\n      ideal: [20, 30],\n      mean: 25.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Flat mandibular plane\"],\n        high: [\"Steep mandibular plane\"]\n      }\n    },\n\n    // FACIAL PROPORTIONS - Wider faces more common\n    \"faceWidthToHeight\": {\n      ideal: [1.35, 1.50],\n      mean: 1.425,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n    \"totalFacialWidthToHeight\": {\n      ideal: [1.30, 1.45],\n      mean: 1.375,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face shape\"],\n        high: [\"Wide face shape\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE SOUTH ASIAN STANDARDS\n  // ========================================\n  \"male_south_asian\": {\n    // NOSE WIDTH - Slightly wider tolerance than White\n    \"noseWidth\": {\n      ideal: [36, 43],  // alar_base_ratio [1.00, 1.08]\n      mean: 39.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // TEAR TROUGH - VERY STRICT. High penalty for dark circles\n    \"tearTroughDepth\": {\n      ideal: [0.0, 0.5],\n      mean: 0.25,\n      std_dev: 0.25,\n      flaws: {\n        high: [\"Dark circles / Tear troughs\"]\n      }\n    },\n\n    // UPPER EYELID - Often prefers visible lid platform\n    \"upperEyelidExposure\": {\n      ideal: [0.5, 2.0],\n      mean: 1.25,\n      std_dev: 0.75,\n      flaws: {\n        low: [\"Hooded eyes\"]\n      }\n    },\n\n    // CHEEKS - Penalizes \"Gaunt\" looks heavily\n    \"cheekbone_height\": {\n      ideal: [83.0, 95.0],\n      mean: 89.0,\n      std_dev: 6.0,\n      flaws: {\n        low: [\"Volume loss / Gauntness\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE HISPANIC STANDARDS (\"The Bridge Model\")\n  // ========================================\n  \"male_hispanic\": {\n    // FACE WIDTH - Rewards broader, more robust face shapes (Mestizo)\n    \"faceWidthToHeight\": {\n      ideal: [1.95, 2.10],\n      mean: 2.025,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long/Narrow face\"]\n      }\n    },\n\n    // NOSE WIDTH - Bridge tolerance (Wider than White, narrower than Black)\n    \"noseWidth\": {\n      ideal: [36, 44],  // alar_base_ratio [1.00, 1.12]\n      mean: 40.0,\n      std_dev: 4.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for positive tilt\n    \"lateralCanthalTilt\": {\n      ideal: [6.0, 12.0],\n      mean: 9.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Negative/Neutral canthal tilt\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE MIDDLE EASTERN STANDARDS\n  // ========================================\n  \"male_middle_eastern\": {\n    // EYEBROW THICKNESS - Prefers significantly thicker/darker brows\n    \"eyebrowThickness\": {\n      ideal: [2.0, 4.0],\n      mean: 3.0,\n      std_dev: 1.0,\n      flaws: {\n        low: [\"Sparse/Weak eyebrows\"],\n        high: [\"Unibrow\"]\n      }\n    },\n\n    // NASOLABIAL ANGLE - Penalizes droopy tip (<90) or hooked noses\n    \"nasolabialAngle\": {\n      ideal: [90.0, 100.0],\n      mean: 95.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Droopy nose tip / Hooked nose\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for Almond/Hunter eye shape\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 10.0],\n      mean: 7.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    },\n\n    // MIDFACE - Similar to White model (Compact is better)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE PACIFIC ISLANDER STANDARDS (\"The Warrior Skull\")\n  // ========================================\n  \"male_pacific_islander\": {\n    // FACE WIDTH - The Highest Width Standard (Very broad)\n    \"faceWidthToHeight\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Narrow/Long face\"]\n      }\n    },\n\n    // NOSE WIDTH - Wide tolerance\n    \"noseWidth\": {\n      ideal: [38, 48],  // alar_base_ratio [1.05, 1.20]\n      mean: 43.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // CHEEKS - Rewards high mass/robustness\n    \"cheekbone_height\": {\n      ideal: [85.0, 100.0],\n      mean: 92.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Weak face structure\"]\n      }\n    },\n\n    // CHIN WIDTH - Prefers a very broad, square chin\n    \"chinWidth\": {\n      ideal: [40.0, 50.0],\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Pointed/Narrow chin\"]\n      }\n    }\n  },\n\n  \"male_native_american\": {\n    \"faceWidthToHeight\": {\n      ideal: [2.00, 2.20],\n      mean: 2.10,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Wide face\"]\n      }\n    },\n\n    \"nasalIndex\": {\n      ideal: [75, 90],\n      mean: 82.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Narrow nose\"],\n        high: [\"Wide nose\"]\n      }\n    },\n\n    \"cheekbone_height\": {\n      ideal: [80.0, 95.0],\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Flat cheekbones\"]\n      }\n    },\n\n    \"gonialAngle\": {\n      ideal: [115, 125],\n      mean: 120,\n      std_dev: 5,\n      flaws: {\n        low: [\"Weak jaw\"],\n        high: [\"Harsh jaw angle\"]\n      }\n    },\n\n    \"chinWidth\": {\n      ideal: [38.0, 48.0],\n      mean: 43.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Narrow chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // FEMALE ETHNICITIES (The \"Missing Link\")\n  // ========================================\n\n  \"female_white\": {\n    // NOSE WIDTH - Strict Rule of Fifths for feminine harmony\n    \"alar_base_ratio\": {\n      ideal: [0.98, 1.05],\n      mean: 1.015,\n      std_dev: 0.035,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // FACE WIDTH - Prefers oval/narrow feminine proportions\n    \"fwhr\": {\n      ideal: [1.45, 1.53],\n      mean: 1.49,\n      std_dev: 0.04,\n      flaws: {\n        low: [\"Long/Narrow face\"],\n        high: [\"Wide face\"]\n      }\n    },\n\n    // JAW - Soft, tapered feminine jawline\n    \"gonial_angle\": {\n      ideal: [122.0, 130.0],\n      mean: 126.0,\n      std_dev: 4.0,\n      flaws: {\n        low: [\"Sharp/Masculine jaw angle\"],\n        high: [\"Weak/Overly soft jawline\"]\n      }\n    },\n\n    // EYE TILT - Neutral to positive preferred\n    \"canthal_tilt\": {\n      ideal: [4.0, 9.0],\n      mean: 6.5,\n      std_dev: 2.5,\n      flaws: {\n        low: [\"Negative/Downturned eyes\"]\n      }\n    },\n\n    // CHIN-PHILTRUM - Golden Ratio balance\n    \"chin_philtrum_ratio\": {\n      ideal: [2.0, 2.2],\n      mean: 2.1,\n      std_dev: 0.1,\n      flaws: {\n        low: [\"Recessed chin\"],\n        high: [\"Protruding chin\"]\n      }\n    }\n  },\n\n  \"female_black\": {\n    // LIPS - High volume preference (fuller lips)\n    \"lipRatio\": {\n      ideal: [1.3, 1.6],\n      mean: 1.45,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    },\n\n    // NOSE WIDTH - Wider tolerance for ethnic variation\n    \"alar_base_ratio\": {\n      ideal: [1.05, 1.15],\n      mean: 1.10,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Very wide nasal base\"]\n      }\n    },\n\n    // CHIN - Allows forward projection (natural prognathism)\n    \"chin_projection\": {\n      ideal: [0.0, 5.0],\n      mean: 2.5,\n      std_dev: 2.5,\n      flaws: {\n        high: [\"Excessive chin projection\"]\n      }\n    },\n\n    // JAW - Soft feminine jawline\n    \"gonial_angle\": {\n      ideal: [120.0, 130.0],\n      mean: 125.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Sharp jaw angle\"],\n        high: [\"Weak jawline\"]\n      }\n    }\n  },\n\n  \"female_east_asian\": {\n    // EYE SPACING - Wide-set neotenous preference\n    \"eye_separation_ratio\": {\n      ideal: [46.3, 47.5],\n      mean: 46.9,\n      std_dev: 0.6,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Very wide-set eyes\"]\n      }\n    },\n\n    // JAW - Tapered V-shape feminine ideal\n    \"gonial_angle\": {\n      ideal: [120.0, 126.0],\n      mean: 123.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Sharp V-line jaw\"],\n        high: [\"Weak/Square jawline\"]\n      }\n    },\n\n    // EYEBROWS - Higher set brows (youthful feminine)\n    \"eyebrow_height\": {\n      ideal: [0.85, 1.30],\n      mean: 1.075,\n      std_dev: 0.225,\n      flaws: {\n        low: [\"Low-set/Heavy brows\"],\n        high: [\"Very high-arched brows\"]\n      }\n    },\n\n    // LOWER FACE - Compact lower third (neotenous)\n    \"lower_third_ratio\": {\n      ideal: [29.6, 32.7],\n      mean: 31.15,\n      std_dev: 1.55,\n      flaws: {\n        low: [\"Very short lower face\"],\n        high: [\"Long lower face\"]\n      }\n    }\n  },\n\n  \"female_south_asian\": {\n    // TEAR TROUGHS - Very strict on dark circles\n    \"tear_trough_depth\": {\n      ideal: [0.0, 0.5],\n      mean: 0.25,\n      std_dev: 0.25,\n      flaws: {\n        high: [\"Dark circles / Deep tear troughs\"]\n      }\n    },\n\n    // CHEEKS - Rewards midface volume (youthful fullness)\n    \"cheek_fullness\": {\n      ideal: [1.0, 2.0],\n      mean: 1.5,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Gaunt/Hollow cheeks\"]\n      }\n    },\n\n    // SKIN - High penalty for uneven skin tone\n    \"skin_uniformity\": {\n      ideal: [0.92, 1.0],\n      mean: 0.96,\n      std_dev: 0.04,\n      flaws: {\n        low: [\"Uneven skin tone / Pigmentation\"]\n      }\n    },\n\n    // NOSE WIDTH - Intermediate tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.00, 1.08],\n      mean: 1.04,\n      std_dev: 0.04,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    }\n  },\n\n  \"female_hispanic\": {\n    // FACE WIDTH - Broader Mestiza tolerance\n    \"fwhr\": {\n      ideal: [1.50, 1.62],\n      mean: 1.56,\n      std_dev: 0.06,\n      flaws: {\n        low: [\"Long/Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // EYE TILT - Strong almond eye preference\n    \"canthal_tilt\": {\n      ideal: [6.0, 12.0],\n      mean: 9.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Neutral/Downturned eyes\"]\n      }\n    },\n\n    // NOSE WIDTH - Intermediate width tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.00, 1.10],\n      mean: 1.05,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // LIPS - Voluptuous preference\n    \"lipRatio\": {\n      ideal: [1.1, 1.35],\n      mean: 1.225,\n      std_dev: 0.125,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    }\n  },\n\n  \"female_middle_eastern\": {\n    // EYEBROWS - Dense/Thick brows preference\n    \"eyebrow_thickness\": {\n      ideal: [1.5, 3.0],\n      mean: 2.25,\n      std_dev: 0.75,\n      flaws: {\n        low: [\"Sparse/Thin eyebrows\"],\n        high: [\"Unibrow\"]\n      }\n    },\n\n    // NOSE - Refined/Upturned tip\n    \"nasolabial_angle\": {\n      ideal: [95.0, 105.0],\n      mean: 100.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Droopy nose tip\"],\n        high: [\"Overly upturned nose\"]\n      }\n    },\n\n    // EYE TILT - Foxy/Hunter feminine eye shape\n    \"canthal_tilt\": {\n      ideal: [5.0, 10.0],\n      mean: 7.5,\n      std_dev: 2.5,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    },\n\n    // EYELID - Low exposure preferred\n    \"upper_eyelid_exposure\": {\n      ideal: [0.5, 1.5],\n      mean: 1.0,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Hooded eyes\"],\n        high: [\"Excessive eyelid exposure\"]\n      }\n    }\n  },\n\n  \"female_native_american\": {\n    // FACE WIDTH - Wide/High cheekbone structure\n    \"fwhr\": {\n      ideal: [1.52, 1.65],\n      mean: 1.585,\n      std_dev: 0.065,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // CHEEKBONES - High definition/prominence\n    \"cheekbone_prominence\": {\n      ideal: [1.5, 2.5],\n      mean: 2.0,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Flat cheekbones\"],\n        high: [\"Overly prominent cheekbones\"]\n      }\n    },\n\n    // JAW - Stronger jaw tolerance\n    \"gonial_angle\": {\n      ideal: [115.0, 125.0],\n      mean: 120.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Very sharp jaw\"],\n        high: [\"Weak jawline\"]\n      }\n    },\n\n    // EYE TILT - Positive tilt preference\n    \"canthal_tilt\": {\n      ideal: [5.0, 11.0],\n      mean: 8.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    }\n  },\n\n  \"female_pacific_islander\": {\n    // FACE WIDTH - Widest/Robust facial structure\n    \"fwhr\": {\n      ideal: [1.55, 1.70],\n      mean: 1.625,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // CHEEKS - High volume/softness preference\n    \"cheek_fullness\": {\n      ideal: [1.2, 2.5],\n      mean: 1.85,\n      std_dev: 0.65,\n      flaws: {\n        low: [\"Gaunt/Hollow cheeks\"]\n      }\n    },\n\n    // NOSE WIDTH - Wide nose tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.05, 1.15],\n      mean: 1.10,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Very wide nasal base\"]\n      }\n    },\n\n    // LIPS - Full lips preference\n    \"lipRatio\": {\n      ideal: [1.25, 1.50],\n      mean: 1.375,\n      std_dev: 0.125,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    }\n  }\n};\n\n/**\n * Get the appropriate metric configuration for a given gender and ethnicity\n * Falls back to base config if no override exists\n */\nexport function getMetricConfig(\n  metricId: string,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): MasterMetricConfig | undefined {\n  const key = `${gender}_${ethnicity}`;\n  const override = ETHNICITY_OVERRIDES[key]?.[metricId];\n  const baseConfig = MASTER_SCORING_DB[metricId];\n\n  if (!baseConfig) return undefined;\n\n  // Merge override with base config\n  if (override) {\n    return {\n      ...baseConfig,\n      ...override,\n      flaws: {\n        ...baseConfig.flaws,\n        ...override.flaws\n      }\n    } as MasterMetricConfig;\n  }\n\n  return baseConfig;\n}\n\n// ============================================\n// Z-SCORE SEVERITY FUNCTIONS\n// ============================================\n\n/**\n * Calculate Z-score for a given value\n * Z = (value - mean) / std_dev\n */\nexport function calculateZScore(value: number, mean: number, stdDev: number): number {\n  if (stdDev === 0) return 0;\n  return Math.abs((value - mean) / stdDev);\n}\n\n/**\n * Determine severity level based on Z-score and ideal range (5-tier system)\n * - Ideal: Value is within ideal range\n * - Good: |z| < 0.5 (within 0.5 standard deviation)\n * - Fair: 0.5 ≤ |z| < 1 (between 0.5-1 standard deviations)\n * - Moderate: 1 ≤ |z| < 2 (between 1-2 standard deviations)\n * - Severe: |z| ≥ 2 (more than 2 standard deviations away)\n */\nexport function getSeverityFromZScore(\n  value: number,\n  config: MasterMetricConfig\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean } {\n  const { ideal, mean, std_dev } = config;\n  const isInIdeal = value >= ideal[0] && value <= ideal[1];\n  const zScore = calculateZScore(value, mean, std_dev);\n\n  let severity: SeverityLevel;\n  if (isInIdeal) {\n    severity = 'ideal';\n  } else if (zScore < 0.5) {\n    severity = 'good';\n  } else if (zScore < 1) {\n    severity = 'fair';\n  } else if (zScore < 2) {\n    severity = 'moderate';\n  } else {\n    severity = 'severe';\n  }\n\n  return { severity, zScore, isInIdeal };\n}\n\n/**\n * Get severity for a metric value with ethnicity/gender awareness\n */\nexport function getSeverityForMetric(\n  metricId: string,\n  value: number,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean; config: MasterMetricConfig } | null {\n  const config = getMetricConfig(metricId, gender, ethnicity);\n  if (!config) return null;\n\n  const result = getSeverityFromZScore(value, config);\n  return { ...result, config };\n}\n\n/**\n * Get badge color for severity level (5-tier)\n */\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'green';\n    case 'good': return 'blue';\n    case 'fair': return 'cyan';\n    case 'moderate': return 'yellow';\n    case 'severe': return 'red';\n    default: return 'gray';\n  }\n}\n\n/**\n * Get severity label for display (5-tier)\n */\nexport function getSeverityLabel(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'Ideal';\n    case 'good': return 'Good';\n    case 'fair': return 'Fair';\n    case 'moderate': return 'Moderate';\n    case 'severe': return 'Severe';\n    default: return 'Unknown';\n  }\n}\n\n// ============================================\n// INSIGHT DEFINITION TYPES\n// ============================================\n\nexport interface InsightSeverityLogic {\n  metrics: string[];  // Display names of metrics (e.g., \"Face Width to Height Ratio\")\n  threshold: number;  // Score threshold for classification\n}\n\nexport interface WeaknessSeverityLabels {\n  minor: string;\n  moderate: string;\n  severe: string;\n}\n\nexport interface StrengthGradeLabels {\n  good: string;\n  excellent: string;\n  ideal: string;\n}\n\nexport interface InsightContent {\n  description: string;\n  severity_labels?: WeaknessSeverityLabels;  // For weaknesses\n  grade_labels?: StrengthGradeLabels;        // For strengths\n}\n\nexport interface InsightDefinition {\n  id: string;\n  title: string;\n  type: 'weakness' | 'strength';\n  severity_logic: InsightSeverityLogic;\n  content: InsightContent;\n}\n\n// ============================================\n// CLASSIFICATION RESULT TYPES\n// ============================================\n\nexport type WeaknessSeverity = 'severe' | 'moderate' | 'minor';\nexport type StrengthGrade = 'ideal' | 'excellent' | 'good';\n\nexport interface ClassifiedWeakness {\n  insightId: string;\n  title: string;\n  description: string;\n  severity: WeaknessSeverity;\n  severityLabel: string;  // Custom label from definition (e.g., \"Extremely Long\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface ClassifiedStrength {\n  insightId: string;\n  title: string;\n  description: string;\n  grade: StrengthGrade;\n  gradeLabel: string;  // Custom label from definition (e.g., \"Ideal\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface MatchedMetric {\n  metricId: string;\n  metricName: string;\n  score: number;\n  value: number;\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category: string;\n}\n\nexport interface InsightClassificationResult {\n  strengths: ClassifiedStrength[];\n  weaknesses: ClassifiedWeakness[];\n}\n\n// ============================================\n// INSIGHTS DATABASE\n// ============================================\n\nexport const INSIGHTS_DEFINITIONS: InsightDefinition[] = [\n  {\n    id: \"long_midface\",\n    title: \"Long Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\", \"Ipsilateral Alar Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The middle of the face is elongated, creating an unbalanced vertical proportion.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Extremely Long\" }\n    }\n  },\n  {\n    id: \"short_midface\",\n    title: \"Short Midface\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The midface has ideal vertical proportions, contributing to facial harmony.\",\n      grade_labels: { good: \"Proportionate\", excellent: \"Well-Balanced\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"weak_jaw\",\n    title: \"Weak/Soft Jaw Structure\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Chin to Philtrum Ratio\", \"Jaw Slope\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw has a softer, rounder shape, often less angular and robust than the ideal.\",\n      severity_labels: { minor: \"Soft\", moderate: \"Recessed\", severe: \"Weak\" }\n    }\n  },\n  {\n    id: \"strong_jaw\",\n    title: \"Strong Jaw Definition\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Jaw Width Ratio\", \"Bigonial Width\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The jaw displays strong definition with well-defined angles and proportionate width.\",\n      grade_labels: { good: \"Defined\", excellent: \"Strong\", ideal: \"Ideal Angular\" }\n    }\n  },\n  {\n    id: \"refined_nasal_tip\",\n    title: \"Refined Nasal Tip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasal Tip Angle\", \"Nose Tip Position\", \"Frankfort-tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious nasal profile due to the nasal tip being well-defined and proportionate.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"bulbous_nose\",\n    title: \"Bulbous Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Nose Width\", \"Nasal Tip Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip appears rounded and less defined, affecting nasal aesthetics.\",\n      severity_labels: { minor: \"Slightly Rounded\", moderate: \"Rounded\", severe: \"Bulbous\" }\n    }\n  },\n  {\n    id: \"ideal_upper_lip\",\n    title: \"Well-Positioned Upper Lip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Lip E-Line Position\", \"Upper Lip S-Line Position\", \"Nasolabial Angle\"],\n      threshold: 9.0\n    },\n    content: {\n      description: \"This contributes to a harmonious mouth region due to the upper lip sitting neither too far forward nor too far back.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"negative_canthal_tilt\",\n    title: \"Negative Canthal Tilt\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The outer corners of the eyes sit lower than the inner corners, creating a downturned appearance.\",\n      severity_labels: { minor: \"Slight Downturn\", moderate: \"Noticeable\", severe: \"Pronounced\" }\n    }\n  },\n  {\n    id: \"positive_canthal_tilt\",\n    title: \"Positive Canthal Tilt\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The outer corners of the eyes are elevated, creating an attractive upswept eye shape.\",\n      grade_labels: { good: \"Slight Upturn\", excellent: \"Well-Tilted\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"balanced_facial_thirds\",\n    title: \"Balanced Facial Thirds\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays well-balanced vertical proportions across all three facial thirds.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfectly Proportioned\" }\n    }\n  },\n  {\n    id: \"imbalanced_thirds\",\n    title: \"Facial Third Imbalance\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The vertical face proportions show imbalance between the three facial thirds.\",\n      severity_labels: { minor: \"Slight Imbalance\", moderate: \"Noticeable Disproportion\", severe: \"Significant Imbalance\" }\n    }\n  },\n  {\n    id: \"high_cheekbones\",\n    title: \"High Cheekbones\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Cheekbone Width\", \"Midface Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"Well-positioned cheekbones that create attractive facial contours and catch light beautifully.\",\n      grade_labels: { good: \"Visible\", excellent: \"Prominent\", ideal: \"Model-Tier\" }\n    }\n  },\n  {\n    id: \"flat_midface\",\n    title: \"Flat Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Total Facial Width to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The midface lacks forward projection, resulting in flatter facial contours.\",\n      severity_labels: { minor: \"Slightly Flat\", moderate: \"Underprojected\", severe: \"Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_lip_ratio\",\n    title: \"Ideal Lip Proportions\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Philtrum Length\", \"Lip Chin Distance\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Well-Proportioned\", ideal: \"Perfect Ratio\" }\n    }\n  },\n  {\n    id: \"thin_lips\",\n    title: \"Thin Lip Profile\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Upper Lip Projection\", \"Lower Lip Projection\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The lips appear thinner than ideal proportions, affecting lower face harmony.\",\n      severity_labels: { minor: \"Slightly Thin\", moderate: \"Thin\", severe: \"Very Thin\" }\n    }\n  },\n  {\n    id: \"ideal_ipd\",\n    title: \"Ideal Eye Spacing\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes are ideally spaced, creating facial balance and attractiveness.\",\n      grade_labels: { good: \"Good Spacing\", excellent: \"Ideal Distance\", ideal: \"Perfect IPD\" }\n    }\n  },\n  {\n    id: \"wide_set_eyes\",\n    title: \"Wide-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are spaced wider apart than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Noticeably Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"close_set_eyes\",\n    title: \"Close-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"Intercanthal Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are positioned closer together than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Close\", moderate: \"Noticeably Close\", severe: \"Very Close\" }\n    }\n  },\n  {\n    id: \"ideal_nose_projection\",\n    title: \"Ideal Nasal Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofrontal Angle\", \"Nasofacial Angle\", \"Nasomenta Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The nose has ideal forward projection relative to the face, creating profile harmony.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect Projection\" }\n    }\n  },\n  {\n    id: \"recessed_chin\",\n    title: \"Recessed Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Facial Depth to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The chin sits behind the ideal position, affecting profile balance.\",\n      severity_labels: { minor: \"Slightly Recessed\", moderate: \"Recessed\", severe: \"Severely Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_chin_projection\",\n    title: \"Ideal Chin Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The chin demonstrates ideal projection and proportions relative to the face.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect\" }\n    }\n  },\n  {\n    id: \"long_philtrum\",\n    title: \"Long Philtrum\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Lip Chin Distance\", \"Upper Lip Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The distance between nose and upper lip is longer than ideal.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"short_philtrum\",\n    title: \"Short Philtrum\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Upper Lip Height\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The philtrum has ideal or shorter length, considered youthful and attractive.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Short\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"wide_nose\",\n    title: \"Wide Nasal Base\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Intercanthal Nasal Ratio\", \"Nose Bridge Width\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The base of the nose is wider than the aesthetic ideal for facial harmony.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"ideal_brow_position\",\n    title: \"Ideal Brow Position\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow Length Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The eyebrows are ideally positioned relative to the eyes and facial structure.\",\n      grade_labels: { good: \"Good Position\", excellent: \"Well-Arched\", ideal: \"Perfect Frame\" }\n    }\n  },\n  {\n    id: \"narrow_jaw\",\n    title: \"Narrow Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Jaw Width Ratio\", \"Bigonial Width\", \"Jaw Frontal Angle\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw is narrower than ideal, affecting lower face width and definition.\",\n      severity_labels: { minor: \"Slightly Narrow\", moderate: \"Narrow\", severe: \"Very Narrow\" }\n    }\n  },\n  {\n    id: \"steep_mandibular_plane\",\n    title: \"Steep Mandibular Plane\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The mandibular plane angle is steeper than ideal, often indicating vertical growth pattern.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  // ============================================\n  // INSIGHT DEFINITIONS (element.html / element1.html)\n  // ============================================\n  // --- WEAKNESSES ---\n  {\n    id: \"steep_jaw\",\n    title: \"Steep Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Jaw Frontal Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The jaw angles sharply downward, creating a narrow or pointed chin effect.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  {\n    id: \"maxillary_recession\",\n    title: \"Maxillary Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Facial Depth to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The upper jaw is less forward than ideal, reducing midface projection and facial harmony.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"mandibular_recession\",\n    title: \"Mandibular Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The lower jaw is set back, creating a less prominent chin and an unbalanced profile.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"underprojected_chin\",\n    title: \"Underprojected Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\", \"Chin Height\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The chin lacks forward projection, creating a weak lower face appearance.\",\n      severity_labels: { minor: \"Slightly Weak\", moderate: \"Underprojected\", severe: \"Severely Underprojected\" }\n    }\n  },\n  {\n    id: \"overly_long_face\",\n    title: \"Overly Long Face Shape\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Total Facial Width to Height Ratio\", \"Face Width to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The face is excessively tall and narrow, creating an elongated appearance.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"hyper_divergent_jaw\",\n    title: \"Hyper-Divergent Jaw Growth\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The jaw grows with an overly steep angle, resulting in a long or narrow lower face. This can indicate malocclusion.\",\n      severity_labels: { minor: \"Mildly Divergent\", moderate: \"Divergent\", severe: \"Hyper-Divergent\" }\n    }\n  },\n  {\n    id: \"weak_brow_ridge\",\n    title: \"Soft/Weak Brow Ridge\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Eyebrow Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The forehead has a softer, less prominent ridge than the ideal, reducing masculine definition.\",\n      severity_labels: { minor: \"Slightly Soft\", moderate: \"Soft\", severe: \"Very Weak\" }\n    }\n  },\n  {\n    id: \"droopy_nasal_tip\",\n    title: \"Droopy Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\", \"Nasofacial Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip points downward more than ideal, creating a drooping appearance.\",\n      severity_labels: { minor: \"Slightly Droopy\", moderate: \"Droopy\", severe: \"Very Droopy\" }\n    }\n  },\n  {\n    id: \"overprojected_nose\",\n    title: \"Overprojected Nose\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Projection\", \"Nasofacial Angle\", \"Nose Length Ratio\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nose projects too far forward relative to the face, creating imbalance.\",\n      severity_labels: { minor: \"Slightly Projected\", moderate: \"Overprojected\", severe: \"Very Overprojected\" }\n    }\n  },\n  {\n    id: \"small_eyes\",\n    title: \"Small Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Palpebral Fissure Length\", \"Eye Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes appear smaller than the aesthetic ideal relative to the face.\",\n      severity_labels: { minor: \"Slightly Small\", moderate: \"Small\", severe: \"Very Small\" }\n    }\n  },\n  {\n    id: \"low_set_eyebrows\",\n    title: \"Low-Set Eyebrows\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow to Hairline Distance\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyebrows sit lower than ideal, reducing the visible upper eyelid space.\",\n      severity_labels: { minor: \"Slightly Low\", moderate: \"Low\", severe: \"Very Low\" }\n    }\n  },\n  {\n    id: \"asymmetrical_face\",\n    title: \"Facial Asymmetry\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The left and right sides of the face show noticeable differences in proportion or position.\",\n      severity_labels: { minor: \"Slight Asymmetry\", moderate: \"Noticeable Asymmetry\", severe: \"Significant Asymmetry\" }\n    }\n  },\n  // --- STRENGTHS ---\n  {\n    id: \"good_jaw_width\",\n    title: \"Good Jaw Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Bigonial Width\", \"Jaw Width Ratio\", \"Jaw Frontal Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant jaw contour due to the jaw being neither too wide nor too narrow.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"good_forehead_slope\",\n    title: \"Good Forehead Slope\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Forehead Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant forehead contour by indicating that the forehead is neither too steep nor too flat.\",\n      grade_labels: { good: \"Good Slope\", excellent: \"Well-Angled\", ideal: \"Ideal Slope\" }\n    }\n  },\n  {\n    id: \"good_cupids_bow\",\n    title: \"Good Cupid's Bow Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cupids Bow Depth\", \"Upper Lip Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lip region due to the cupid's bow having ideal definition and depth.\",\n      grade_labels: { good: \"Defined\", excellent: \"Well-Defined\", ideal: \"Perfectly Defined\" }\n    }\n  },\n  {\n    id: \"good_eyebrow_length\",\n    title: \"Good Eyebrow Length\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Brow Length to Face Width Ratio\", \"Brow Length Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious eye region due to the eyebrows having ideal horizontal length relative to face width.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Well-Proportioned\", ideal: \"Ideal Length\" }\n    }\n  },\n  {\n    id: \"good_neck_width\",\n    title: \"Good Neck Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Neck Width\", \"Neck to Jaw Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lower face due to the neck being neither too wide nor too thin.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"ideal_nasolabial_angle\",\n    title: \"Ideal Nasolabial Angle\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The angle between nose and upper lip is in the ideal range, creating profile harmony.\",\n      grade_labels: { good: \"Good Angle\", excellent: \"Well-Angled\", ideal: \"Perfect Angle\" }\n    }\n  },\n  {\n    id: \"ideal_facial_depth\",\n    title: \"Ideal Facial Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Depth to Height Ratio\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face has ideal forward projection creating attractive three-dimensional contours.\",\n      grade_labels: { good: \"Good Depth\", excellent: \"Well-Projected\", ideal: \"Ideal Projection\" }\n    }\n  },\n  {\n    id: \"ideal_eye_shape\",\n    title: \"Ideal Eye Shape\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Lateral Canthal Tilt\", \"Palpebral Fissure Length\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes have an attractive almond shape with ideal proportions and tilt.\",\n      grade_labels: { good: \"Attractive\", excellent: \"Well-Shaped\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"harmonious_profile\",\n    title: \"Harmonious Profile\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Total Profile Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The facial profile shows excellent balance between nose, lips, and chin positions.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfect Profile\" }\n    }\n  },\n  {\n    id: \"good_facial_symmetry\",\n    title: \"Good Facial Symmetry\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays excellent bilateral symmetry, a key component of attractiveness.\",\n      grade_labels: { good: \"Symmetric\", excellent: \"Very Symmetric\", ideal: \"Near-Perfect Symmetry\" }\n    }\n  }\n];\n\n// ============================================\n// METRIC NAME MAPPING\n// ============================================\n\n// Map display names to metric IDs for lookup\nconst METRIC_NAME_TO_ID: Record<string, string> = {\n  // Face Shape/Proportions\n  \"Face Width to Height Ratio\": \"faceWidthToHeight\",\n  \"Total Facial Width to Height\": \"totalFacialWidthToHeight\",\n  \"Total Facial Width to Height Ratio\": \"totalFacialWidthToHeight\",\n  \"Midface Ratio\": \"midfaceRatio\",\n  \"Upper Third Proportion\": \"upperThirdProportion\",\n  \"Middle Third Proportion\": \"middleThirdProportion\",\n  \"Lower Third Proportion\": \"lowerThirdProportion\",\n  \"Cheekbone Height\": \"cheekboneHeight\",\n  \"Cheekbone Width\": \"cheekboneWidth\",\n  \"Bitemporal Width\": \"bitemporalWidth\",\n  \"Forehead Height\": \"foreheadHeight\",\n  \"Facial Asymmetry Index\": \"facialAsymmetryIndex\",\n\n  // Jaw\n  \"Gonial Angle\": \"gonialAngle\",\n  \"Mandibular Plane Angle\": \"mandibularPlaneAngle\",\n  \"Jaw Width Ratio\": \"jawWidthRatio\",\n  \"Bigonial Width\": \"bigonialWidth\",\n  \"Jaw Frontal Angle\": \"jawFrontalAngle\",\n  \"Jaw Slope\": \"jawSlope\",\n  \"Jaw Asymmetry\": \"jawAsymmetry\",\n\n  // Chin\n  \"Chin to Philtrum Ratio\": \"chinPhiltrumRatio\",\n  \"Chin Height\": \"chinHeight\",\n  \"Facial Depth to Height\": \"facialDepthToHeight\",\n  \"Facial Depth to Height Ratio\": \"facialDepthToHeight\",\n  \"Anterior Facial Depth\": \"anteriorFacialDepth\",\n  \"Recession Relative to Frankfort Plane\": \"recessionFrankfort\",\n\n  // Eyes\n  \"Lateral Canthal Tilt\": \"lateralCanthalTilt\",\n  \"Eye Aspect Ratio\": \"eyeAspectRatio\",\n  \"Eye Separation Ratio\": \"eyeSeparationRatio\",\n  \"Interpupillary Ratio\": \"interpupillaryRatio\",\n  \"One Eye Apart Test\": \"oneEyeApartTest\",\n  \"Intercanthal Width\": \"intercanthalWidth\",\n  \"Eyebrow Height\": \"eyebrowHeight\",\n  \"Brow Length Ratio\": \"browLengthRatio\",\n  \"Brow Length to Face Width Ratio\": \"browLengthToFaceWidth\",\n  \"Palpebral Fissure Length\": \"palpebralFissureLength\",\n  \"Eye Width\": \"eyeWidth\",\n  \"Eye Asymmetry\": \"eyeAsymmetry\",\n  \"Brow to Hairline Distance\": \"browToHairlineDistance\",\n\n  // Brow\n  \"Browridge Inclination Angle\": \"browridgeInclinationAngle\",\n\n  // Nose\n  \"Nasal Index\": \"nasalIndex\",\n  \"Nasal Tip Angle\": \"nasalTipAngle\",\n  \"Nose Tip Position\": \"noseTipPosition\",\n  \"Frankfort-tip Angle\": \"frankfortTipAngle\",\n  \"Nasofrontal Angle\": \"nasofrontalAngle\",\n  \"Nasofacial Angle\": \"nasofacialAngle\",\n  \"Nasomenta Angle\": \"nasomentaAngle\",\n  \"Nasomental Angle\": \"nasomentaAngle\",\n  \"Intercanthal Nasal Ratio\": \"intercanthalNasalRatio\",\n  \"Nose Bridge Width\": \"noseBridgeWidth\",\n  \"Nose Width\": \"noseWidth\",\n  \"Nasal Projection\": \"nasalProjection\",\n  \"Nose Length Ratio\": \"noseLengthRatio\",\n  \"Ipsilateral Alar Angle\": \"ipsilateralAlarAngle\",\n\n  // Lips\n  \"Lip Ratio\": \"lipRatio\",\n  \"Philtrum Length\": \"philtrumLength\",\n  \"Upper Lip Projection\": \"upperLipProjection\",\n  \"Lower Lip Projection\": \"lowerLipProjection\",\n  \"Lip Chin Distance\": \"lipChinDistance\",\n  \"Upper Lip Height\": \"upperLipHeight\",\n  \"Upper Lip E-Line Position\": \"upperLipELine\",\n  \"Upper Lip S-Line Position\": \"upperLipSLine\",\n  \"Nasolabial Angle\": \"nasolabialAngle\",\n  \"Cupids Bow Depth\": \"cupidsBowDepth\",\n\n  // Neck\n  \"Neck Width\": \"neckWidth\",\n  \"Neck to Jaw Ratio\": \"neckToJawRatio\",\n\n  // Profile\n  \"Total Profile Angle\": \"totalProfileAngle\",\n};\n\n// ============================================\n// CLASSIFICATION FUNCTIONS\n// ============================================\n\n/**\n * Get weakness severity based on average score\n * 0-3 = \"Severe\", 3-5 = \"Moderate\", 5-7 = \"Minor\"\n */\nfunction getWeaknessSeverity(avgScore: number): WeaknessSeverity {\n  if (avgScore <= 3) return 'severe';\n  if (avgScore <= 5) return 'moderate';\n  return 'minor';\n}\n\n/**\n * Get strength grade based on average score\n * 8-9 = \"Good\", 9-9.5 = \"Excellent\", 9.5-10 = \"Ideal\"\n */\nfunction getStrengthGrade(avgScore: number): StrengthGrade {\n  if (avgScore >= 9.5) return 'ideal';\n  if (avgScore >= 9) return 'excellent';\n  return 'good';\n}\n\n/**\n * Find metric by display name from measurements array\n */\nfunction findMetricByName(\n  metricName: string,\n  measurements: MetricScoreResult[]\n): MetricScoreResult | undefined {\n  // First try direct ID mapping\n  const metricId = METRIC_NAME_TO_ID[metricName];\n  if (metricId) {\n    return measurements.find(m => m.metricId === metricId);\n  }\n\n  // Fallback: try fuzzy matching on name\n  const normalizedName = metricName.toLowerCase().replace(/[^a-z0-9]/g, '');\n  return measurements.find(m => {\n    const normalizedMetricName = m.name.toLowerCase().replace(/[^a-z0-9]/g, '');\n    return normalizedMetricName.includes(normalizedName) ||\n           normalizedName.includes(normalizedMetricName);\n  });\n}\n\n/**\n * Check if a metric should be considered a \"false positive\" weakness.\n * This handles directional/dimorphic metrics where low scores don't mean weakness.\n *\n * Example: Canthal Tilt of 3° gets a low score (not in 6-8° ideal range)\n * but is still a POSITIVE trait, not a weakness.\n */\nfunction isFalsePositiveWeakness(metric: MatchedMetric): boolean {\n  const config = METRIC_CONFIGS[metric.metricId];\n  if (!config) return false;\n\n  // Check if the value is actually acceptable based on polarity\n  const { acceptable } = isValueAcceptable(metric.value, config);\n  return acceptable;\n}\n\n/**\n * Process all insight definitions against user's measurements\n */\nexport function classifyInsights(\n  measurements: MetricScoreResult[],\n  insightDefinitions: InsightDefinition[] = INSIGHTS_DEFINITIONS\n): InsightClassificationResult {\n  const strengths: ClassifiedStrength[] = [];\n  const weaknesses: ClassifiedWeakness[] = [];\n\n  for (const insight of insightDefinitions) {\n    const { metrics, threshold } = insight.severity_logic;\n\n    // Find matching measurements for this insight\n    const matchedMetrics: MatchedMetric[] = [];\n    for (const metricName of metrics) {\n      const measurement = findMetricByName(metricName, measurements);\n      if (measurement) {\n        matchedMetrics.push({\n          metricId: measurement.metricId,\n          metricName: measurement.name,\n          score: measurement.score,\n          value: measurement.value,\n          idealMin: measurement.idealMin,\n          idealMax: measurement.idealMax,\n          unit: measurement.unit,\n          category: measurement.category,\n        });\n      }\n    }\n\n    // Skip if no metrics matched (need at least 1)\n    if (matchedMetrics.length === 0) continue;\n\n    // Calculate average score\n    const avgScore = matchedMetrics.reduce((sum, m) => sum + m.score, 0) / matchedMetrics.length;\n\n    // Classify based on type and threshold\n    if (insight.type === 'weakness') {\n      // Weakness: avg < threshold → add to areas of improvement\n      if (avgScore < threshold) {\n        // ========== FALSE POSITIVE CHECK ==========\n        // Before adding to weaknesses, check if ANY of the matched metrics\n        // are actually in an \"acceptable\" zone based on their polarity.\n        // If so, this is a false positive and should be skipped or reclassified.\n        const falsePositiveMetrics = matchedMetrics.filter(isFalsePositiveWeakness);\n\n        // If ALL matched metrics are false positives, skip this weakness entirely\n        if (falsePositiveMetrics.length === matchedMetrics.length) {\n          // This is a false positive weakness - the values are actually acceptable\n          // Consider adding to strengths if scores are decent\n          if (avgScore >= 6) {\n            strengths.push({\n              insightId: `${insight.id}_acceptable`,\n              title: insight.title.replace('Negative', 'Neutral').replace('Weak', 'Moderate'),\n              description: `While not in the peak ideal range, the measured values are within acceptable limits.`,\n              grade: 'good',\n              gradeLabel: 'Acceptable',\n              avgScore,\n              matchedMetrics,\n            });\n          }\n          continue; // Skip adding as weakness\n        }\n\n        // If SOME metrics are false positives, filter them out\n        const trueWeaknessMetrics = matchedMetrics.filter(m => !isFalsePositiveWeakness(m));\n        if (trueWeaknessMetrics.length === 0) continue;\n\n        // Recalculate average with only true weakness metrics\n        const trueAvgScore = trueWeaknessMetrics.reduce((sum, m) => sum + m.score, 0) / trueWeaknessMetrics.length;\n\n        // Only add as weakness if true average is still below threshold\n        if (trueAvgScore < threshold) {\n          const severity = getWeaknessSeverity(trueAvgScore);\n          const labels = insight.content.severity_labels;\n          const severityLabel = labels?.[severity] || severity;\n\n          weaknesses.push({\n            insightId: insight.id,\n            title: insight.title,\n            description: insight.content.description,\n            severity,\n            severityLabel,\n            avgScore: trueAvgScore,\n            matchedMetrics: trueWeaknessMetrics,\n          });\n        }\n      }\n    } else {\n      // Strength: avg > threshold → add to key strengths\n      if (avgScore > threshold) {\n        const grade = getStrengthGrade(avgScore);\n        const labels = insight.content.grade_labels;\n        const gradeLabel = labels?.[grade] || grade;\n\n        strengths.push({\n          insightId: insight.id,\n          title: insight.title,\n          description: insight.content.description,\n          grade,\n          gradeLabel,\n          avgScore,\n          matchedMetrics,\n        });\n      }\n    }\n  }\n\n  // Sort by score (weaknesses by lowest score first, strengths by highest first)\n  weaknesses.sort((a, b) => a.avgScore - b.avgScore);\n  strengths.sort((a, b) => b.avgScore - a.avgScore);\n\n  return { strengths, weaknesses };\n}\n\n/**\n * Convert ClassifiedStrength to Strength type for UI compatibility\n */\nexport function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: classified.avgScore,\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  const impact = (10 - classified.avgScore) * 0.5;\n  const newRollingLost = rollingLost + impact;\n\n  return {\n    id: `insight_flaw_${classified.insightId}`,\n    flawName: `${classified.title} (${classified.severityLabel})`,\n    summary: classified.description,\n    harmonyPercentageLost: impact,\n    standardizedImpact: impact / 10,\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,\n    rollingHarmonyPercentageLost: newRollingLost,\n    rollingStandardizedImpact: newRollingLost / 10,\n  };\n}\n\n/**\n * Main function: Generate strengths and flaws from measurements using insights\n */\nexport function generateInsightBasedResults(\n  measurements: MetricScoreResult[]\n): { strengths: Strength[]; flaws: Flaw[] } {\n  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);\n\n  // Convert to UI-compatible types\n  const strengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n  let rollingLost = 0;\n  const flaws = classifiedWeaknesses.map((w, i) => {\n    const flaw = convertToFlaw(w, i, rollingLost);\n    rollingLost = flaw.rollingPointsDeducted || 0;\n    return flaw;\n  });\n\n  return { strengths, flaws };\n}\n","numLines":2643,"startLine":1,"totalLines":2643}}}
{"parentUuid":"832d838f-ee55-44d2-8d62-cda78f28a902","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RVjPLhMPPa6oV8yNcVc9WS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011q4uzrhuAPKHR3yZoEKtZG","name":"TodoWrite","input":{"todos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"completed","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"in_progress","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"pending","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"pending","activeForm":"Verifying fix with lint and tsc"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":39183,"cache_read_input_tokens":102213,"cache_creation":{"ephemeral_5m_input_tokens":39183,"ephemeral_1h_input_tokens":0},"output_tokens":195,"service_tier":"standard"}},"requestId":"req_011CWUrUbrCC7M2AouSGMKXb","type":"assistant","uuid":"99d627d7-84d5-4c30-9966-befb86a9b2a6","timestamp":"2025-12-26T06:50:15.155Z"}
{"parentUuid":"99d627d7-84d5-4c30-9966-befb86a9b2a6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011q4uzrhuAPKHR3yZoEKtZG","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"5ad6f7b5-90c2-44ec-93c8-6b7cecc6667d","timestamp":"2025-12-26T06:50:15.188Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"completed","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"in_progress","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"pending","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"pending","activeForm":"Verifying fix with lint and tsc"}]}}
{"parentUuid":"5ad6f7b5-90c2-44ec-93c8-6b7cecc6667d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_0159NRsqyvP98b86ut46Y4Bk","type":"message","role":"assistant","content":[{"type":"text","text":"Now I need to read the persisted files that contain the core scoring logic:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":63968,"cache_read_input_tokens":12494,"cache_creation":{"ephemeral_5m_input_tokens":63968,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUrVA5vb3HjE6RtREdpT","type":"assistant","uuid":"128665c8-7ac5-4ee6-aacd-1fd9924a4674","timestamp":"2025-12-26T06:50:19.105Z"}
{"parentUuid":"128665c8-7ac5-4ee6-aacd-1fd9924a4674","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_0159NRsqyvP98b86ut46Y4Bk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UaFoEGjVQfkh2LmuADs9S1","name":"Read","input":{"file_path":"/Users/imorgado/.claude/projects/-Users-imorgado-LOOKSMAXX-looksmaxx-app/4e0d04e8-56ad-4bca-9e4b-36b62804ea66/tool-results/toolu_01AieX1Tdvdjg3ekCd2wRR1K.txt"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":63968,"cache_read_input_tokens":12494,"cache_creation":{"ephemeral_5m_input_tokens":63968,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUrVA5vb3HjE6RtREdpT","type":"assistant","uuid":"9c88fe03-6626-40f9-ac9d-1f54157e3dbf","timestamp":"2025-12-26T06:50:23.043Z"}
{"parentUuid":"9c88fe03-6626-40f9-ac9d-1f54157e3dbf","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_0159NRsqyvP98b86ut46Y4Bk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01H5NBrWRbRN6tXNppwgPNLM","name":"Read","input":{"file_path":"/Users/imorgado/.claude/projects/-Users-imorgado-LOOKSMAXX-looksmaxx-app/4e0d04e8-56ad-4bca-9e4b-36b62804ea66/tool-results/toolu_01WBz76ih2UfrMqqTeJB37VZ.txt"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":63968,"cache_read_input_tokens":12494,"cache_creation":{"ephemeral_5m_input_tokens":63968,"ephemeral_1h_input_tokens":0},"output_tokens":273,"service_tier":"standard"}},"requestId":"req_011CWUrVA5vb3HjE6RtREdpT","type":"assistant","uuid":"8ef6968a-ac9f-4cff-92a6-d53de994a53d","timestamp":"2025-12-26T06:50:24.847Z"}
{"parentUuid":"8ef6968a-ac9f-4cff-92a6-d53de994a53d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UaFoEGjVQfkh2LmuADs9S1","type":"tool_result","content":"     1→     1→/**\n     2→     2→ * Scoring Calculator\n     3→     3→ * Core scoring algorithm functions extracted from harmony-scoring.ts\n     4→     4→ *\n     5→     5→ * Features:\n     6→     6→ * - Exponential decay scoring with per-metric decay rates\n     7→     7→ * - Bezier curve custom scoring for non-linear measurements\n     8→     8→ * - Directional/Dimorphic scoring (polarity support)\n     9→     9→ * - Quality tiers and severity levels\n    10→    10→ */\n    11→    11→\n    12→    12→import {\n    13→    13→  Point,\n    14→    14→  QualityTier,\n    15→    15→  SeverityLevel,\n    16→    16→  MeasurementUnit,\n    17→    17→  MetricConfig,\n    18→    18→  CurvePoint,\n    19→    19→  FlawMapping,\n    20→    20→} from './types';\n    21→    21→import { BEZIER_CURVES } from '@/lib/bezier-curves';\n    22→    22→\n    23→    23→// ============================================\n    24→    24→// FLAW MAPPINGS\n    25→    25→// ============================================\n    26→    26→\n    27→    27→export const METRIC_FLAW_MAPPINGS: Record<string, FlawMapping[]> = {\n    28→    28→  anteriorFacialDepth: [\n    29→    29→    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Anterior Facial Depth measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n    30→    30→  ],\n    31→    31→  bitemporalWidth: [\n    32→    32→    { category: 'Upper Third', flawName: 'Narrow forehead', confidence: 'confirmed', reasoning: 'Reduced bitemporal width indicates a narrower than ideal forehead relative to the cheekbones. This disrupts facial harmony by creating a compressed hairline and forehead, altering the overall shape of the face.' },\n    33→    33→  ],\n    34→    34→  cheekboneHeight: [\n    35→    35→    { category: 'Midface/Face Shape', flawName: 'Low-set cheekbones', confidence: 'confirmed', reasoning: 'Reduced cheekbone height indicates that the cheekbones are positioned lower than ideal. This disrupts facial harmony by creating an unpronounced appearance to the cheekbones and facial structure.' },\n    36→    36→  ],\n    37→    37→  cheekFullness: [\n    38→    38→    { category: 'Midface/Face Shape', flawName: 'Hollow/Gaunt midface', confidence: 'confirmed', reasoning: 'Reduced cheek fullness indicates volume loss or hollow cheeks. This disrupts facial harmony by creating a gaunt or aged appearance, particularly important in South Asian and East Asian beauty standards.' },\n    39→    39→  ],\n    40→    40→  eyeAspectRatio: [\n    41→    41→    { category: 'Eyes', flawName: 'Overly round eye shape', confidence: 'confirmed', reasoning: 'A reduced eye aspect ratio indicates overly narrow eyes relative to their height. This disrupts facial harmony by creating an overly surprised appearance and reducing angular definition.' },\n    42→    42→  ],\n    43→    43→  eyeSeparationRatio: [\n    44→    44→    { category: 'Eyes', flawName: 'Close-set eyes', confidence: 'confirmed', reasoning: 'Reduced eye separation indicates close-set eyes. This disrupts facial harmony by making the eye area appear too compressed.' },\n    45→    45→  ],\n    46→    46→  eyebrowLowSetedness: [\n    47→    47→    { category: 'Eyes', flawName: 'Medium-set eyebrows', confidence: 'confirmed', reasoning: 'Increased eyebrow low setedness indicates eyebrows that are positioned higher than ideal. This disrupts facial harmony by reducing the overall visual impact of the eyebrows and framing of the eyes.' },\n    48→    48→  ],\n    49→    49→  faceWidthToHeight: [\n    50→    50→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced face width to height ratio indicates an overly long midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    51→    51→  ],\n    52→    52→  facialDepthToHeight: [\n    53→    53→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'Reduced facial depth to height ratio indicates insufficient mid-face projection relative to height. This disrupts facial harmony by creating the appearance of a flat midface.' },\n    54→    54→  ],\n    55→    55→  gonialAngle: [\n    56→    56→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony in the lower face.' },\n    57→    57→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    58→    58→  ],\n    59→    59→  holdawayHLine: [\n    60→    60→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'Decreased H-line indicates the lips are positioned too far in front of the line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    61→    61→  ],\n    62→    62→  interiorMidfaceProjectionAngle: [\n    63→    63→    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Interior Midface Projection Angle measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n    64→    64→  ],\n    65→    65→  ipsilateralAlarAngle: [\n    66→    66→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A decreased ipsilateral alar angle indicates an overly narrow interior midface. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    67→    67→  ],\n    68→    68→  jawFrontalAngle: [\n    69→    69→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A narrower jaw frontal angle indicates a steeper jawline or overly wide chin. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    70→    70→  ],\n    71→    71→  jawSlope: [\n    72→    72→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'The Jaw Slope measurement is above the ideal range. This disrupts facial harmony in the lower face.' },\n    73→    73→  ],\n    74→    74→  lateralCanthalTilt: [\n    75→    75→    { category: 'Eyes', flawName: 'Insufficient eye tilt', confidence: 'confirmed', reasoning: 'A decreased lateral canthal tilt indicates insufficiently upturned eyes. This disrupts facial harmony by creating a less alert and youthful appearance.' },\n    76→    76→  ],\n    77→    77→  burstoneLowerLip: [\n    78→    78→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the Burstone line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    79→    79→  ],\n    80→    80→  eLineLowerLip: [\n    81→    81→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned too far in front of the E-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    82→    82→  ],\n    83→    83→  sLineLowerLip: [\n    84→    84→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the S-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    85→    85→  ],\n    86→    86→  lowerThirdProportion: [\n    87→    87→    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'The upper jaw is too long relative to lower jaw, possibly from a long upper jaw or short lower jaw, or a combination of both. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n    88→    88→  ],\n    89→    89→  mandibularPlaneAngle: [\n    90→    90→    { category: 'Occlusion/Jaw Growth', flawName: 'Hyper-divergent jaw growth', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by elongating the lower face.' },\n    91→    91→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony in the lower face.' },\n    92→    92→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    93→    93→  ],\n    94→    94→  midfaceRatio: [\n    95→    95→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    96→    96→    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n    97→    97→  ],\n    98→    98→  nasofacialAngle: [\n    99→    99→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A smaller nasofacial angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n   100→   100→  ],\n   101→   101→  nasofrontalAngle: [\n   102→   102→    { category: 'Upper Third', flawName: 'Soft and weak brow ridge', confidence: 'confirmed', reasoning: 'An increased nasofrontal angle indicates reduced brow ridge prominence and angularity. This disrupts facial harmony by creating a less defined upper face.' },\n   103→   103→  ],\n   104→   104→  nasomentaAngle: [\n   105→   105→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A larger nasomental angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n   106→   106→  ],\n   107→   107→  noseBridgeWidth: [\n   108→   108→    { category: 'Nose', flawName: 'Overly narrow nose bridge', confidence: 'confirmed', reasoning: 'The Nose Bridge to Nose Width measurement is above the ideal range. This disrupts facial harmony by creating an unbalanced nasal profile.' },\n   109→   109→  ],\n   110→   110→  orbitalVector: [\n   111→   111→    { category: 'Eyes', flawName: 'Sunken orbital region', confidence: 'confirmed', reasoning: 'A decreased orbital vector indicates insufficient projection and volume underneath the eye. This disrupts facial harmony due to the lacking volume underneath the eyes, reducing vibrancy and youthfulness.' },\n   112→   112→  ],\n   113→   113→  ramusToMandibleRatio: [\n   114→   114→    { category: 'Jaw Shape', flawName: 'Short ramus', confidence: 'confirmed', reasoning: 'A reduced ramus-to-mandible ratio indicates a shorter than ideal vertical jawbone (ramus) when compared to the mandible. This disrupts facial harmony by reducing jaw height and definition.' },\n   115→   115→  ],\n   116→   116→  submentalCervicalAngle: [\n   117→   117→    { category: 'Neck', flawName: 'Round neck region', confidence: 'confirmed', reasoning: 'An increased submental cervical angle indicates a round neck region, possibly from excess submental fat or tissue. This disrupts facial harmony by reducing neck definition.' },\n   118→   118→  ],\n   119→   119→  totalFacialWidthToHeight: [\n   120→   120→    { category: 'Midface/Face Shape', flawName: 'Overly long face shape', confidence: 'confirmed', reasoning: 'An increased total facial width to height ratio indicates an overly long face relative to its height. This disrupts facial harmony by creating a vertically stretched appearance to the face.' },\n   121→   121→  ],\n   122→   122→};\n   123→   123→\n   124→   124→// ============================================\n   125→   125→// CUSTOM BEZIER CURVES (Ethnicity-specific override)\n   126→   126→// ============================================\n   127→   127→\n   128→   128→export const METRIC_CUSTOM_CURVES: Record<string, CurvePoint[]> = {\n   129→   129→  faceWidthToHeight: [\n   130→   130→    { x: 1.49, y: 0, leftHandleX: 1.44, leftHandleY: 0, rightHandleX: 1.55, rightHandleY: 0 },\n   131→   131→    { x: 1.68, y: 1.05, leftHandleX: 1.62, leftHandleY: 0.36, rightHandleX: 1.71, rightHandleY: 1.58 },\n   132→   132→    { x: 1.77, y: 3.07, leftHandleX: 1.74, leftHandleY: 2.15, rightHandleX: 1.79, rightHandleY: 3.88 },\n   133→   133→    { x: 1.83, y: 5.83, leftHandleX: 1.8, leftHandleY: 4.64, rightHandleX: 1.84, rightHandleY: 6.85 },\n   134→   134→    { x: 1.89, y: 8.7, leftHandleX: 1.88, leftHandleY: 8.3, rightHandleX: 1.92, rightHandleY: 9.5 },\n   135→   135→    { x: 1.96, y: 10, leftHandleX: 1.96, leftHandleY: 10, rightHandleX: 1.96, rightHandleY: 10, fixed: true },\n   136→   136→    { x: 2, y: 10, leftHandleX: 2, leftHandleY: 10, rightHandleX: 2, rightHandleY: 10 },\n   137→   137→    { x: 2.07, y: 8.7, leftHandleX: 2.04, leftHandleY: 9.5, rightHandleX: 2.08, rightHandleY: 8.3 },\n   138→   138→    { x: 2.13, y: 5.83, leftHandleX: 2.12, leftHandleY: 6.85, rightHandleX: 2.16, rightHandleY: 4.64 },\n   139→   139→    { x: 2.19, y: 3.07, leftHandleX: 2.17, leftHandleY: 3.88, rightHandleX: 2.22, rightHandleY: 2.15 },\n   140→   140→    { x: 2.28, y: 1.05, leftHandleX: 2.25, leftHandleY: 1.58, rightHandleX: 2.34, rightHandleY: 0.36 },\n   141→   141→    { x: 2.47, y: 0, leftHandleX: 2.41, leftHandleY: 0, rightHandleX: 2.52, rightHandleY: 0 },\n   142→   142→  ],\n   143→   143→  lowerThirdProportion: [\n   144→   144→    { x: 25.6, y: 0, leftHandleX: 24.8, leftHandleY: 0, rightHandleX: 26.4, rightHandleY: 0 },\n   145→   145→    { x: 28.01, y: 1.58, leftHandleX: 27.23, leftHandleY: 0.53, rightHandleX: 28.27, rightHandleY: 1.97 },\n   146→   146→    { x: 28.83, y: 3.21, leftHandleX: 28.62, leftHandleY: 2.59, rightHandleX: 29.03, rightHandleY: 3.76 },\n   147→   147→    { x: 29.63, y: 5.85, leftHandleX: 29.38, leftHandleY: 4.64, rightHandleX: 29.84, rightHandleY: 6.61 },\n   148→   148→    { x: 30.27, y: 8.56, leftHandleX: 30.1, leftHandleY: 7.71, rightHandleX: 30.52, rightHandleY: 9.42 },\n   149→   149→    { x: 31, y: 10, leftHandleX: 30.88, leftHandleY: 10, rightHandleX: 31.13, rightHandleY: 10, fixed: true },\n   150→   150→    { x: 33.5, y: 10, leftHandleX: 33.38, leftHandleY: 10, rightHandleX: 33.63, rightHandleY: 10 },\n   151→   151→    { x: 34.23, y: 8.56, leftHandleX: 33.98, leftHandleY: 9.42, rightHandleX: 34.4, rightHandleY: 7.71 },\n   152→   152→    { x: 34.87, y: 5.85, leftHandleX: 34.66, leftHandleY: 6.61, rightHandleX: 35.12, rightHandleY: 4.64 },\n   153→   153→    { x: 35.67, y: 3.21, leftHandleX: 35.47, leftHandleY: 3.76, rightHandleX: 35.88, rightHandleY: 2.59 },\n   154→   154→    { x: 36.49, y: 1.58, leftHandleX: 36.23, leftHandleY: 1.97, rightHandleX: 37.27, rightHandleY: 0.53 },\n   155→   155→    { x: 38.9, y: 0, leftHandleX: 38.1, leftHandleY: 0, rightHandleX: 39.7, rightHandleY: 0 },\n   156→   156→  ],\n   157→   157→  eyeAspectRatio: [\n   158→   158→    { x: 1.44, y: 0, leftHandleX: 1.18, leftHandleY: 0, rightHandleX: 1.75, rightHandleY: 0.38 },\n   159→   159→    { x: 2.07, y: 1.66, leftHandleX: 1.96, leftHandleY: 1.08, rightHandleX: 2.24, rightHandleY: 2.63 },\n   160→   160→    { x: 2.42, y: 4.34, leftHandleX: 2.35, leftHandleY: 3.6, rightHandleX: 2.52, rightHandleY: 5.5 },\n   161→   161→    { x: 2.71, y: 7.96, leftHandleX: 2.65, leftHandleY: 7.13, rightHandleX: 2.8, rightHandleY: 9.08 },\n   162→   162→    { x: 3, y: 10, leftHandleX: 2.98, leftHandleY: 10, rightHandleX: 3.03, rightHandleY: 10, fixed: true },\n   163→   163→    { x: 3.5, y: 10, leftHandleX: 3.48, leftHandleY: 10, rightHandleX: 3.53, rightHandleY: 10 },\n   164→   164→    { x: 3.79, y: 7.96, leftHandleX: 3.7, leftHandleY: 9.08, rightHandleX: 3.85, rightHandleY: 7.13 },\n   165→   165→    { x: 4.08, y: 4.34, leftHandleX: 3.98, leftHandleY: 5.5, rightHandleX: 4.15, rightHandleY: 3.6 },\n   166→   166→    { x: 4.43, y: 1.66, leftHandleX: 4.26, leftHandleY: 2.63, rightHandleX: 4.54, rightHandleY: 1.08 },\n   167→   167→    { x: 5.06, y: 0, leftHandleX: 4.75, leftHandleY: 0.38, rightHandleX: 5.32, rightHandleY: 0 },\n   168→   168→  ],\n   169→   169→  // Note: Additional curves can be added from METRIC_CUSTOM_CURVES in harmony-scoring.ts\n   170→   170→};\n   171→   171→\n   172→   172→// ============================================\n   173→   173→// CORE SCORING FUNCTIONS\n   174→   174→// ============================================\n   175→   175→\n   176→   176→/**\n   177→   177→ * Exponential Decay Scoring Algorithm with Directional/Dimorphic Support\n   178→   178→ *\n   179→   179→ * Standard: score = maxScore * e^(-decayRate * deviation)\n   180→   180→ *\n   181→   181→ * Directional scoring (polarity):\n   182→   182→ * - 'higher_is_better': Values above safeFloor but below ideal get softZoneScore\n   183→   183→ *   Example: Canthal Tilt of 3 degrees is still positive/good, just not peak ideal (6-8 degrees)\n   184→   184→ * - 'lower_is_better': Values below safeCeiling but above ideal get softZoneScore\n   185→   185→ *   Example: Short philtrum is still attractive even if shorter than \"ideal\"\n   186→   186→ */\n   187→   187→export function calculateMetricScore(\n   188→   188→  value: number,\n   189→   189→  config: MetricConfig\n   190→   190→): number {\n   191→   191→  const {\n   192→   192→    id,\n   193→   193→    idealMin,\n   194→   194→    idealMax,\n   195→   195→    decayRate,\n   196→   196→    maxScore,\n   197→   197→    customCurve,\n   198→   198→    polarity = 'balanced',\n   199→   199→    safeFloor,\n   200→   200→    safeCeiling,\n   201→   201→    softZoneScore = 8.0, // Default \"Good\" score for acceptable-but-not-ideal values\n   202→   202→  } = config;\n   203→   203→\n   204→   204→  // IMPORTANT: Check demographic-adjusted ideal range FIRST\n   205→   205→  // This ensures that demographic overrides are respected even when Bezier curves exist\n   206→   206→  // (Bezier curves are optimized for base ranges and don't auto-adjust for demographics)\n   207→   207→  if (value >= idealMin && value <= idealMax) {\n   208→   208→    return maxScore;\n   209→   209→  }\n   210→   210→\n   211→   211→  // Use custom curve if available in config\n   212→   212→  if (customCurve && customCurve.mode === 'custom') {\n   213→   213→    const bezierScore = interpolateCustomCurve(value, customCurve.points, maxScore);\n   214→   214→    // If Bezier returns -1, it means value is out of range with edge y=0\n   215→   215→    // Fall through to exponential decay instead of returning 0\n   216→   216→    if (bezierScore >= 0) {\n   217→   217→      // Clamp to valid range [0, maxScore] to prevent Bezier overshoot\n   218→   218→      return Math.max(0, Math.min(maxScore, bezierScore));\n   219→   219→    }\n   220→   220→  }\n   221→   221→\n   222→   222→  // Check for pre-defined Bezier curve from harmony curves (66 metrics)\n   223→   223→  const bezierCurve = BEZIER_CURVES[id];\n   224→   224→  if (bezierCurve && bezierCurve.mode === 'custom') {\n   225→   225→    const bezierScore = interpolateCustomCurve(value, bezierCurve.points, maxScore);\n   226→   226→    // If Bezier returns -1, it means value is out of range with edge y=0\n   227→   227→    // Fall through to exponential decay instead of returning 0\n   228→   228→    if (bezierScore >= 0) {\n   229→   229→      // Clamp to valid range [0, maxScore] to prevent Bezier overshoot\n   230→   230→      return Math.max(0, Math.min(maxScore, bezierScore));\n   231→   231→    }\n   232→   232→  }\n   233→   233→\n   234→   234→  // Handle directional/dimorphic scoring\n   235→   235→  if (polarity === 'higher_is_better' && safeFloor !== undefined) {\n   236→   236→    // Higher values are good. Only values below safeFloor are true weaknesses.\n   237→   237→    if (value >= safeFloor && value < idealMin) {\n   238→   238→      // Value is in the \"acceptable but not ideal\" zone\n   239→   239→      // Give a passing score that decreases linearly as we approach the floor\n   240→   240→      const zoneRange = idealMin - safeFloor;\n   241→   241→      const distanceFromIdeal = idealMin - value;\n   242→   242→      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n   243→   243→      // Linear interpolation: idealMin -> maxScore, safeFloor -> softZoneScore\n   244→   244→      return maxScore - t * (maxScore - softZoneScore);\n   245→   245→    }\n   246→   246→    if (value >= idealMax) {\n   247→   247→      // Values above ideal are still excellent for 'higher_is_better'\n   248→   248→      // Apply gentler decay (1/3 the normal rate)\n   249→   249→      const deviation = value - idealMax;\n   250→   250→      const gentleDecay = decayRate / 3;\n   251→   251→      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n   252→   252→    }\n   253→   253→    // Below safeFloor - apply normal (or harsher) exponential decay\n   254→   254→    if (value < safeFloor) {\n   255→   255→      const deviation = safeFloor - value;\n   256→   256→      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n   257→   257→    }\n   258→   258→  }\n   259→   259→\n   260→   260→  if (polarity === 'lower_is_better' && safeCeiling !== undefined) {\n   261→   261→    // Lower values are good. Only values above safeCeiling are true weaknesses.\n   262→   262→    if (value <= safeCeiling && value > idealMax) {\n   263→   263→      // Value is in the \"acceptable but not ideal\" zone\n   264→   264→      const zoneRange = safeCeiling - idealMax;\n   265→   265→      const distanceFromIdeal = value - idealMax;\n   266→   266→      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n   267→   267→      // Linear interpolation: idealMax -> maxScore, safeCeiling -> softZoneScore\n   268→   268→      return maxScore - t * (maxScore - softZoneScore);\n   269→   269→    }\n   270→   270→    if (value <= idealMin) {\n   271→   271→      // Values below ideal are still excellent for 'lower_is_better'\n   272→   272→      // Apply gentler decay (1/3 the normal rate)\n   273→   273→      const deviation = idealMin - value;\n   274→   274→      const gentleDecay = decayRate / 3;\n   275→   275→      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n   276→   276→    }\n   277→   277→    // Above safeCeiling - apply normal exponential decay\n   278→   278→    if (value > safeCeiling) {\n   279→   279→      const deviation = value - safeCeiling;\n   280→   280→      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n   281→   281→    }\n   282→   282→  }\n   283→   283→\n   284→   284→  // Default balanced scoring: deviation in either direction is equally bad\n   285→   285→  const deviation = value < idealMin\n   286→   286→    ? idealMin - value\n   287→   287→    : value - idealMax;\n   288→   288→\n   289→   289→  // Exponential decay\n   290→   290→  const score = maxScore * Math.exp(-decayRate * deviation);\n   291→   291→\n   292→   292→  return Math.max(0, Math.min(maxScore, score));\n   293→   293→}\n   294→   294→\n   295→   295→/**\n   296→   296→ * Check if a metric value is in an \"acceptable\" zone (not a true weakness).\n   297→   297→ * Used by InsightsEngine to prevent false positives.\n   298→   298→ */\n   299→   299→export function isValueAcceptable(\n   300→   300→  value: number,\n   301→   301→  config: MetricConfig\n   302→   302→): { acceptable: boolean; reason: string } {\n   303→   303→  const {\n   304→   304→    idealMin,\n   305→   305→    idealMax,\n   306→   306→    polarity = 'balanced',\n   307→   307→    safeFloor,\n   308→   308→    safeCeiling,\n   309→   309→  } = config;\n   310→   310→\n   311→   311→  // Within ideal range is always acceptable\n   312→   312→  if (value >= idealMin && value <= idealMax) {\n   313→   313→    return { acceptable: true, reason: 'within_ideal' };\n   314→   314→  }\n   315→   315→\n   316→   316→  // Check directional acceptability\n   317→   317→  if (polarity === 'higher_is_better') {\n   318→   318→    if (value >= idealMax) {\n   319→   319→      return { acceptable: true, reason: 'above_ideal_higher_is_better' };\n   320→   320→    }\n   321→   321→    if (safeFloor !== undefined && value >= safeFloor) {\n   322→   322→      return { acceptable: true, reason: 'above_safe_floor' };\n   323→   323→    }\n   324→   324→    // Below safe floor - true weakness\n   325→   325→    return { acceptable: false, reason: 'below_safe_floor' };\n   326→   326→  }\n   327→   327→\n   328→   328→  if (polarity === 'lower_is_better') {\n   329→   329→    if (value <= idealMin) {\n   330→   330→      return { acceptable: true, reason: 'below_ideal_lower_is_better' };\n   331→   331→    }\n   332→   332→    if (safeCeiling !== undefined && value <= safeCeiling) {\n   333→   333→      return { acceptable: true, reason: 'below_safe_ceiling' };\n   334→   334→    }\n   335→   335→    // Above safe ceiling - true weakness\n   336→   336→    return { acceptable: false, reason: 'above_safe_ceiling' };\n   337→   337→  }\n   338→   338→\n   339→   339→  // Balanced polarity - outside ideal is not acceptable\n   340→   340→  return { acceptable: false, reason: 'outside_ideal_balanced' };\n   341→   341→}\n   342→   342→\n   343→   343→/**\n   344→   344→ * Interpolate custom Bezier curve for scoring\n   345→   345→ * Uses cubic Bezier interpolation with control handles for smooth curves\n   346→   346→ *\n   347→   347→ * IMPORTANT: When value is outside the curve range and the edge y-value is 0,\n   348→   348→ * returns -1 to signal the caller should use exponential decay fallback.\n   349→   349→ * This prevents artificially returning 0 for values just outside the curve.\n   350→   350→ */\n   351→   351→export function interpolateCustomCurve(\n   352→   352→  value: number,\n   353→   353→  points: CurvePoint[],\n   354→   354→  maxScore: number\n   355→   355→): number {\n   356→   356→  void maxScore; // Reserved for future custom curve implementations\n   357→   357→  if (points.length === 0) return -1; // Signal to use fallback\n   358→   358→\n   359→   359→  // Sort points by x value\n   360→   360→  const sortedPoints = [...points].sort((a, b) => a.x - b.x);\n   361→   361→\n   362→   362→  // Handle out-of-range values\n   363→   363→  // If edge y-value is 0, return -1 to signal exponential decay fallback should be used\n   364→   364→  if (value <= sortedPoints[0].x) {\n   365→   365→    const edgeY = sortedPoints[0].y;\n   366→   366→    // If edge score is 0, signal to use exponential decay fallback\n   367→   367→    return edgeY <= 0 ? -1 : edgeY;\n   368→   368→  }\n   369→   369→  if (value >= sortedPoints[sortedPoints.length - 1].x) {\n   370→   370→    const edgeY = sortedPoints[sortedPoints.length - 1].y;\n   371→   371→    // If edge score is 0, signal to use exponential decay fallback\n   372→   372→    return edgeY <= 0 ? -1 : edgeY;\n   373→   373→  }\n   374→   374→\n   375→   375→  // Find bracketing points\n   376→   376→  let lowerIndex = 0;\n   377→   377→  for (let i = 0; i < sortedPoints.length - 1; i++) {\n   378→   378→    if (value >= sortedPoints[i].x && value <= sortedPoints[i + 1].x) {\n   379→   379→      lowerIndex = i;\n   380→   380→      break;\n   381→   381→    }\n   382→   382→  }\n   383→   383→\n   384→   384→  const p0 = sortedPoints[lowerIndex];\n   385→   385→  const p3 = sortedPoints[lowerIndex + 1];\n   386→   386→\n   387→   387→  // Check if we have Bezier control handles\n   388→   388→  const hasHandles = p0.rightHandleX !== undefined && p3.leftHandleX !== undefined;\n   389→   389→\n   390→   390→  if (hasHandles) {\n   391→   391→    // Cubic Bezier interpolation with control points\n   392→   392→    const p1x = p0.rightHandleX!;\n   393→   393→    const p1y = p0.rightHandleY ?? p0.y;\n   394→   394→    const p2x = p3.leftHandleX!;\n   395→   395→    const p2y = p3.leftHandleY ?? p3.y;\n   396→   396→\n   397→   397→    // Find t parameter for given x value using Newton-Raphson iteration\n   398→   398→    let t = (value - p0.x) / (p3.x - p0.x); // Initial guess\n   399→   399→\n   400→   400→    // Newton-Raphson iterations to find t where B_x(t) = value\n   401→   401→    for (let iter = 0; iter < 10; iter++) {\n   402→   402→      const bx = cubicBezier(p0.x, p1x, p2x, p3.x, t);\n   403→   403→      const bxDerivative = cubicBezierDerivative(p0.x, p1x, p2x, p3.x, t);\n   404→   404→\n   405→   405→      if (Math.abs(bxDerivative) < 1e-10) break;\n   406→   406→\n   407→   407→      const newT = t - (bx - value) / bxDerivative;\n   408→   408→      if (Math.abs(newT - t) < 1e-10) break;\n   409→   409→      t = Math.max(0, Math.min(1, newT));\n   410→   410→    }\n   411→   411→\n   412→   412→    // Calculate y using the found t parameter\n   413→   413→    return cubicBezier(p0.y, p1y, p2y, p3.y, t);\n   414→   414→  } else {\n   415→   415→    // Smooth interpolation using Catmull-Rom spline\n   416→   416→    // This provides smoother curves than linear interpolation\n   417→   417→    const t = (value - p0.x) / (p3.x - p0.x);\n   418→   418→\n   419→   419→    // Get neighboring points for spline calculation\n   420→   420→    const pMinus1 = lowerIndex > 0 ? sortedPoints[lowerIndex - 1] : p0;\n   421→   421→    const p4 = lowerIndex + 2 < sortedPoints.length ? sortedPoints[lowerIndex + 2] : p3;\n   422→   422→\n   423→   423→    // Catmull-Rom spline interpolation\n   424→   424→    return catmullRomSpline(pMinus1.y, p0.y, p3.y, p4.y, t);\n   425→   425→  }\n   426→   426→}\n   427→   427→\n   428→   428→/**\n   429→   429→ * Cubic Bezier curve evaluation: B(t) = (1-t)^3*P0 + 3*(1-t)^2*t*P1 + 3*(1-t)*t^2*P2 + t^3*P3\n   430→   430→ */\n   431→   431→export function cubicBezier(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   432→   432→  const mt = 1 - t;\n   433→   433→  const mt2 = mt * mt;\n   434→   434→  const mt3 = mt2 * mt;\n   435→   435→  const t2 = t * t;\n   436→   436→  const t3 = t2 * t;\n   437→   437→  return mt3 * p0 + 3 * mt2 * t * p1 + 3 * mt * t2 * p2 + t3 * p3;\n   438→   438→}\n   439→   439→\n   440→   440→/**\n   441→   441→ * Cubic Bezier derivative: B'(t) = 3*(1-t)^2*(P1-P0) + 6*(1-t)*t*(P2-P1) + 3*t^2*(P3-P2)\n   442→   442→ */\n   443→   443→export function cubicBezierDerivative(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   444→   444→  const mt = 1 - t;\n   445→   445→  return 3 * mt * mt * (p1 - p0) + 6 * mt * t * (p2 - p1) + 3 * t * t * (p3 - p2);\n   446→   446→}\n   447→   447→\n   448→   448→/**\n   449→   449→ * Catmull-Rom spline interpolation for smooth curves without explicit handles\n   450→   450→ */\n   451→   451→export function catmullRomSpline(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   452→   452→  const t2 = t * t;\n   453→   453→  const t3 = t2 * t;\n   454→   454→\n   455→   455→  // Catmull-Rom coefficients with tension = 0.5\n   456→   456→  const a = -0.5 * p0 + 1.5 * p1 - 1.5 * p2 + 0.5 * p3;\n   457→   457→  const b = p0 - 2.5 * p1 + 2 * p2 - 0.5 * p3;\n   458→   458→  const c = -0.5 * p0 + 0.5 * p2;\n   459→   459→  const d = p1;\n   460→   460→\n   461→   461→  return a * t3 + b * t2 + c * t + d;\n   462→   462→}\n   463→   463→\n   464→   464→/**\n   465→   465→ * Calculate standardized score (0-10 normalized)\n   466→   466→ * Clamps output to [0, 10] to prevent display issues from scoring edge cases\n   467→   467→ */\n   468→   468→export function standardizeScore(score: number, maxScore: number): number {\n   469→   469→  const normalized = (score / maxScore) * 10;\n   470→   470→  return Math.max(0, Math.min(10, normalized));\n   471→   471→}\n   472→   472→\n   473→   473→/**\n   474→   474→ * Determine quality tier based on score\n   475→   475→ */\n   476→   476→export function getQualityTier(score: number, maxScore: number = 10): QualityTier {\n   477→   477→  const normalized = (score / maxScore) * 100;\n   478→   478→\n   479→   479→  if (normalized >= 90) return 'ideal';\n   480→   480→  if (normalized >= 70) return 'excellent';\n   481→   481→  if (normalized >= 50) return 'good';\n   482→   482→  return 'below_average';\n   483→   483→}\n   484→   484→\n   485→   485→/**\n   486→   486→ * Determine severity level based on score\n   487→   487→ */\n   488→   488→export function getSeverityLevel(score: number, maxScore: number = 10): SeverityLevel {\n   489→   489→  const normalized = (score / maxScore) * 100;\n   490→   490→\n   491→   491→  if (normalized >= 85) return 'optimal';\n   492→   492→  if (normalized >= 70) return 'minor';\n   493→   493→  if (normalized >= 50) return 'moderate';\n   494→   494→  if (normalized >= 30) return 'major';\n   495→   495→  if (normalized >= 15) return 'severe';\n   496→   496→  return 'extremely_severe';\n   497→   497→}\n   498→   498→\n   499→   499→/**\n   500→   500→ * Calculate deviation description\n   501→   501→ */\n   502→   502→export function getDeviationDescription(\n   503→   503→  value: number,\n   504→   504→  idealMin: number,\n   505→   505→  idealMax: number,\n   506→   506→  unit: MeasurementUnit\n   507→   507→): { deviation: number; direction: 'above' | 'below' | 'within'; description: string } {\n   508→   508→  if (value >= idealMin && value <= idealMax) {\n   509→   509→    return { deviation: 0, direction: 'within', description: 'within ideal range' };\n   510→   510→  }\n   511→   511→\n   512→   512→  const unitLabel = getUnitLabel(unit);\n   513→   513→\n   514→   514→  if (value < idealMin) {\n   515→   515→    const dev = idealMin - value;\n   516→   516→    return {\n   517→   517→      deviation: dev,\n   518→   518→      direction: 'below',\n   519→   519→      description: `${dev.toFixed(2)}${unitLabel} below ideal`,\n   520→   520→    };\n   521→   521→  }\n   522→   522→\n   523→   523→  const dev = value - idealMax;\n   524→   524→  return {\n   525→   525→    deviation: dev,\n   526→   526→    direction: 'above',\n   527→   527→    description: `${dev.toFixed(2)}${unitLabel} above ideal`,\n   528→   528→  };\n   529→   529→}\n   530→   530→\n   531→   531→/**\n   532→   532→ * Get unit label for display\n   533→   533→ */\n   534→   534→export function getUnitLabel(unit: MeasurementUnit): string {\n   535→   535→  switch (unit) {\n   536→   536→    case 'ratio': return 'x';\n   537→   537→    case 'percent': return '%';\n   538→   538→    case 'degrees': return '\\u00B0';\n   539→   539→    case 'mm': return 'mm';\n   540→   540→    default: return '';\n   541→   541→  }\n   542→   542→}\n   543→   543→\n   544→   544→// ============================================\n   545→   545→// GEOMETRY HELPERS\n   546→   546→// ============================================\n   547→   547→\n   548→   548→/**\n   549→   549→ * Calculate distance between two points\n   550→   550→ */\n   551→   551→export function distance(p1: Point, p2: Point): number {\n   552→   552→  return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));\n   553→   553→}\n   554→   554→\n   555→   555→/**\n   556→   556→ * Calculate angle at vertex point (in degrees)\n   557→   557→ */\n   558→   558→export function calculateAngle(p1: Point, vertex: Point, p2: Point): number {\n   559→   559→  const v1 = { x: p1.x - vertex.x, y: p1.y - vertex.y };\n   560→   560→  const v2 = { x: p2.x - vertex.x, y: p2.y - vertex.y };\n   561→   561→\n   562→   562→  const dot = v1.x * v2.x + v1.y * v2.y;\n   563→   563→  const cross = v1.x * v2.y - v1.y * v2.x;\n   564→   564→\n   565→   565→  const angle = Math.atan2(cross, dot) * (180 / Math.PI);\n   566→   566→  return Math.abs(angle);\n   567→   567→}\n   568→   568→\n   569→   569→/**\n   570→   570→ * Calculate perpendicular distance from point to line (signed)\n   571→   571→ */\n   572→   572→export function perpendicularDistance(\n   573→   573→  point: Point,\n   574→   574→  lineStart: Point,\n   575→   575→  lineEnd: Point\n   576→   576→): number {\n   577→   577→  const A = point.x - lineStart.x;\n   578→   578→  const B = point.y - lineStart.y;\n   579→   579→  const C = lineEnd.x - lineStart.x;\n   580→   580→  const D = lineEnd.y - lineStart.y;\n   581→   581→\n   582→   582→  const dot = A * C + B * D;\n   583→   583→  const lenSq = C * C + D * D;\n   584→   584→  const param = lenSq !== 0 ? dot / lenSq : -1;\n   585→   585→\n   586→   586→  let xx: number, yy: number;\n   587→   587→\n   588→   588→  if (param < 0) {\n   589→   589→    xx = lineStart.x;\n   590→   590→    yy = lineStart.y;\n   591→   591→  } else if (param > 1) {\n   592→   592→    xx = lineEnd.x;\n   593→   593→    yy = lineEnd.y;\n   594→   594→  } else {\n   595→   595→    xx = lineStart.x + param * C;\n   596→   596→    yy = lineStart.y + param * D;\n   597→   597→  }\n   598→   598→\n   599→   599→  const dx = point.x - xx;\n   600→   600→  const dy = point.y - yy;\n   601→   601→\n   602→   602→  const sign =\n   603→   603→    (lineEnd.y - lineStart.y) * point.x -\n   604→   604→      (lineEnd.x - lineStart.x) * point.y +\n   605→   605→      lineEnd.x * lineStart.y -\n   606→   606→      lineEnd.y * lineStart.x >=\n   607→   607→    0\n   608→   608→      ? 1\n   609→   609→      : -1;\n   610→   610→\n   611→   611→  return sign * Math.sqrt(dx * dx + dy * dy);\n   612→   612→}\n   613→   613→\n   614→   614→// ============================================\n   615→   615→// PERCENTILE & PSL CONVERSION\n   616→   616→// ============================================\n   617→   617→\n   618→   618→/**\n   619→   619→ * Calculate percentile from harmony score\n   620→   620→ */\n   621→   621→export function calculateHarmonyPercentile(score: number): number {\n   622→   622→  // Based on normal distribution with mean=5, stdDev=1.5\n   623→   623→  const mean = 5;\n   624→   624→  const stdDev = 1.5;\n   625→   625→  const z = (score - mean) / stdDev;\n   626→   626→  return normalCDF(z) * 100;\n   627→   627→}\n   628→   628→\n   629→   629→/**\n   630→   630→ * Standard normal CDF approximation\n   631→   631→ */\n   632→   632→export function normalCDF(z: number): number {\n   633→   633→  const a1 = 0.254829592;\n   634→   634→  const a2 = -0.284496736;\n   635→   635→  const a3 = 1.421413741;\n   636→   636→  const a4 = -1.453152027;\n   637→   637→  const a5 = 1.061405429;\n   638→   638→  const p = 0.3275911;\n   639→   639→\n   640→   640→  const sign = z < 0 ? -1 : 1;\n   641→   641→  const absZ = Math.abs(z) / Math.sqrt(2);\n   642→   642→\n   643→   643→  const t = 1.0 / (1.0 + p * absZ);\n   644→   644→  const y = 1.0 - ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-absZ * absZ);\n   645→   645→\n   646→   646→  return 0.5 * (1.0 + sign * y);\n   647→   647→}\n   648→   648→\n   649→   649→// ============================================\n   650→   650→// PSL RATING CONVERSION\n   651→   651→// ============================================\n   652→   652→\n   653→   653→export interface PSLRating {\n   654→   654→  score: number;\n   655→   655→  tier: string;\n   656→   656→  percentile: number;\n   657→   657→  description: string;\n   658→   658→}\n   659→   659→\n   660→   660→/**\n   661→   661→ * Convert harmony score to PSL rating\n   662→   662→ */\n   663→   663→export function convertToPSL(harmonyScore: number): PSLRating {\n   664→   664→  // Convert 0-10 harmony to 3.0-7.5 PSL range\n   665→   665→  const psl = 3.0 + (harmonyScore / 10) * 4.5;\n   666→   666→  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n   667→   667→\n   668→   668→  let tier: string;\n   669→   669→  let percentile: number;\n   670→   670→\n   671→   671→  if (clampedPSL >= 7.5) {\n   672→   672→    tier = 'Top Model';\n   673→   673→    percentile = 99.99;\n   674→   674→  } else if (clampedPSL >= 7.0) {\n   675→   675→    tier = 'Chad';\n   676→   676→    percentile = 99.87;\n   677→   677→  } else if (clampedPSL >= 6.5) {\n   678→   678→    tier = 'Chadlite';\n   679→   679→    percentile = 99.0;\n   680→   680→  } else if (clampedPSL >= 6.0) {\n   681→   681→    tier = 'High Tier Normie+';\n   682→   682→    percentile = 97.25;\n   683→   683→  } else if (clampedPSL >= 5.5) {\n   684→   684→    tier = 'High Tier Normie';\n   685→   685→    percentile = 90.0;\n   686→   686→  } else if (clampedPSL >= 5.0) {\n   687→   687→    tier = 'Mid Tier Normie+';\n   688→   688→    percentile = 84.15;\n   689→   689→  } else if (clampedPSL >= 4.5) {\n   690→   690→    tier = 'Mid Tier Normie';\n   691→   691→    percentile = 65.0;\n   692→   692→  } else if (clampedPSL >= 4.0) {\n   693→   693→    tier = 'Low Tier Normie';\n   694→   694→    percentile = 50.0;\n   695→   695→  } else if (clampedPSL >= 3.5) {\n   696→   696→    tier = 'Below Average';\n   697→   697→    percentile = 30.0;\n   698→   698→  } else {\n   699→   699→    tier = 'Subpar';\n   700→   700→    percentile = 15.0;\n   701→   701→  }\n   702→   702→\n   703→   703→  return {\n   704→   704→    score: clampedPSL,\n   705→   705→    tier,\n   706→   706→    percentile,\n   707→   707→    description: `${tier} (top ${(100 - percentile).toFixed(1)}%)`,\n   708→   708→  };\n   709→   709→}\n   710→   710→\n   711→\n   712→<system-reminder>\n   713→Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n   714→</system-reminder>\n   715→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d727bb80-c696-4892-8d07-5787af368d5a","timestamp":"2025-12-26T06:50:25.029Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/.claude/projects/-Users-imorgado-LOOKSMAXX-looksmaxx-app/4e0d04e8-56ad-4bca-9e4b-36b62804ea66/tool-results/toolu_01AieX1Tdvdjg3ekCd2wRR1K.txt","content":"     1→/**\n     2→ * Scoring Calculator\n     3→ * Core scoring algorithm functions extracted from harmony-scoring.ts\n     4→ *\n     5→ * Features:\n     6→ * - Exponential decay scoring with per-metric decay rates\n     7→ * - Bezier curve custom scoring for non-linear measurements\n     8→ * - Directional/Dimorphic scoring (polarity support)\n     9→ * - Quality tiers and severity levels\n    10→ */\n    11→\n    12→import {\n    13→  Point,\n    14→  QualityTier,\n    15→  SeverityLevel,\n    16→  MeasurementUnit,\n    17→  MetricConfig,\n    18→  CurvePoint,\n    19→  FlawMapping,\n    20→} from './types';\n    21→import { BEZIER_CURVES } from '@/lib/bezier-curves';\n    22→\n    23→// ============================================\n    24→// FLAW MAPPINGS\n    25→// ============================================\n    26→\n    27→export const METRIC_FLAW_MAPPINGS: Record<string, FlawMapping[]> = {\n    28→  anteriorFacialDepth: [\n    29→    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Anterior Facial Depth measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n    30→  ],\n    31→  bitemporalWidth: [\n    32→    { category: 'Upper Third', flawName: 'Narrow forehead', confidence: 'confirmed', reasoning: 'Reduced bitemporal width indicates a narrower than ideal forehead relative to the cheekbones. This disrupts facial harmony by creating a compressed hairline and forehead, altering the overall shape of the face.' },\n    33→  ],\n    34→  cheekboneHeight: [\n    35→    { category: 'Midface/Face Shape', flawName: 'Low-set cheekbones', confidence: 'confirmed', reasoning: 'Reduced cheekbone height indicates that the cheekbones are positioned lower than ideal. This disrupts facial harmony by creating an unpronounced appearance to the cheekbones and facial structure.' },\n    36→  ],\n    37→  cheekFullness: [\n    38→    { category: 'Midface/Face Shape', flawName: 'Hollow/Gaunt midface', confidence: 'confirmed', reasoning: 'Reduced cheek fullness indicates volume loss or hollow cheeks. This disrupts facial harmony by creating a gaunt or aged appearance, particularly important in South Asian and East Asian beauty standards.' },\n    39→  ],\n    40→  eyeAspectRatio: [\n    41→    { category: 'Eyes', flawName: 'Overly round eye shape', confidence: 'confirmed', reasoning: 'A reduced eye aspect ratio indicates overly narrow eyes relative to their height. This disrupts facial harmony by creating an overly surprised appearance and reducing angular definition.' },\n    42→  ],\n    43→  eyeSeparationRatio: [\n    44→    { category: 'Eyes', flawName: 'Close-set eyes', confidence: 'confirmed', reasoning: 'Reduced eye separation indicates close-set eyes. This disrupts facial harmony by making the eye area appear too compressed.' },\n    45→  ],\n    46→  eyebrowLowSetedness: [\n    47→    { category: 'Eyes', flawName: 'Medium-set eyebrows', confidence: 'confirmed', reasoning: 'Increased eyebrow low setedness indicates eyebrows that are positioned higher than ideal. This disrupts facial harmony by reducing the overall visual impact of the eyebrows and framing of the eyes.' },\n    48→  ],\n    49→  faceWidthToHeight: [\n    50→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced face width to height ratio indicates an overly long midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    51→  ],\n    52→  facialDepthToHeight: [\n    53→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'Reduced facial depth to height ratio indicates insufficient mid-face projection relative to height. This disrupts facial harmony by creating the appearance of a flat midface.' },\n    54→  ],\n    55→  gonialAngle: [\n    56→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony in the lower face.' },\n    57→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    58→  ],\n    59→  holdawayHLine: [\n    60→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'Decreased H-line indicates the lips are positioned too far in front of the line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    61→  ],\n    62→  interiorMidfaceProjectionAngle: [\n    63→    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Interior Midface Projection Angle measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n    64→  ],\n    65→  ipsilateralAlarAngle: [\n    66→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A decreased ipsilateral alar angle indicates an overly narrow interior midface. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    67→  ],\n    68→  jawFrontalAngle: [\n    69→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A narrower jaw frontal angle indicates a steeper jawline or overly wide chin. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    70→  ],\n    71→  jawSlope: [\n    72→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'The Jaw Slope measurement is above the ideal range. This disrupts facial harmony in the lower face.' },\n    73→  ],\n    74→  lateralCanthalTilt: [\n    75→    { category: 'Eyes', flawName: 'Insufficient eye tilt', confidence: 'confirmed', reasoning: 'A decreased lateral canthal tilt indicates insufficiently upturned eyes. This disrupts facial harmony by creating a less alert and youthful appearance.' },\n    76→  ],\n    77→  burstoneLowerLip: [\n    78→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the Burstone line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    79→  ],\n    80→  eLineLowerLip: [\n    81→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned too far in front of the E-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    82→  ],\n    83→  sLineLowerLip: [\n    84→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the S-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    85→  ],\n    86→  lowerThirdProportion: [\n    87→    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'The upper jaw is too long relative to lower jaw, possibly from a long upper jaw or short lower jaw, or a combination of both. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n    88→  ],\n    89→  mandibularPlaneAngle: [\n    90→    { category: 'Occlusion/Jaw Growth', flawName: 'Hyper-divergent jaw growth', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by elongating the lower face.' },\n    91→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony in the lower face.' },\n    92→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    93→  ],\n    94→  midfaceRatio: [\n    95→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    96→    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n    97→  ],\n    98→  nasofacialAngle: [\n    99→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A smaller nasofacial angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n   100→  ],\n   101→  nasofrontalAngle: [\n   102→    { category: 'Upper Third', flawName: 'Soft and weak brow ridge', confidence: 'confirmed', reasoning: 'An increased nasofrontal angle indicates reduced brow ridge prominence and angularity. This disrupts facial harmony by creating a less defined upper face.' },\n   103→  ],\n   104→  nasomentaAngle: [\n   105→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A larger nasomental angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n   106→  ],\n   107→  noseBridgeWidth: [\n   108→    { category: 'Nose', flawName: 'Overly narrow nose bridge', confidence: 'confirmed', reasoning: 'The Nose Bridge to Nose Width measurement is above the ideal range. This disrupts facial harmony by creating an unbalanced nasal profile.' },\n   109→  ],\n   110→  orbitalVector: [\n   111→    { category: 'Eyes', flawName: 'Sunken orbital region', confidence: 'confirmed', reasoning: 'A decreased orbital vector indicates insufficient projection and volume underneath the eye. This disrupts facial harmony due to the lacking volume underneath the eyes, reducing vibrancy and youthfulness.' },\n   112→  ],\n   113→  ramusToMandibleRatio: [\n   114→    { category: 'Jaw Shape', flawName: 'Short ramus', confidence: 'confirmed', reasoning: 'A reduced ramus-to-mandible ratio indicates a shorter than ideal vertical jawbone (ramus) when compared to the mandible. This disrupts facial harmony by reducing jaw height and definition.' },\n   115→  ],\n   116→  submentalCervicalAngle: [\n   117→    { category: 'Neck', flawName: 'Round neck region', confidence: 'confirmed', reasoning: 'An increased submental cervical angle indicates a round neck region, possibly from excess submental fat or tissue. This disrupts facial harmony by reducing neck definition.' },\n   118→  ],\n   119→  totalFacialWidthToHeight: [\n   120→    { category: 'Midface/Face Shape', flawName: 'Overly long face shape', confidence: 'confirmed', reasoning: 'An increased total facial width to height ratio indicates an overly long face relative to its height. This disrupts facial harmony by creating a vertically stretched appearance to the face.' },\n   121→  ],\n   122→};\n   123→\n   124→// ============================================\n   125→// CUSTOM BEZIER CURVES (Ethnicity-specific override)\n   126→// ============================================\n   127→\n   128→export const METRIC_CUSTOM_CURVES: Record<string, CurvePoint[]> = {\n   129→  faceWidthToHeight: [\n   130→    { x: 1.49, y: 0, leftHandleX: 1.44, leftHandleY: 0, rightHandleX: 1.55, rightHandleY: 0 },\n   131→    { x: 1.68, y: 1.05, leftHandleX: 1.62, leftHandleY: 0.36, rightHandleX: 1.71, rightHandleY: 1.58 },\n   132→    { x: 1.77, y: 3.07, leftHandleX: 1.74, leftHandleY: 2.15, rightHandleX: 1.79, rightHandleY: 3.88 },\n   133→    { x: 1.83, y: 5.83, leftHandleX: 1.8, leftHandleY: 4.64, rightHandleX: 1.84, rightHandleY: 6.85 },\n   134→    { x: 1.89, y: 8.7, leftHandleX: 1.88, leftHandleY: 8.3, rightHandleX: 1.92, rightHandleY: 9.5 },\n   135→    { x: 1.96, y: 10, leftHandleX: 1.96, leftHandleY: 10, rightHandleX: 1.96, rightHandleY: 10, fixed: true },\n   136→    { x: 2, y: 10, leftHandleX: 2, leftHandleY: 10, rightHandleX: 2, rightHandleY: 10 },\n   137→    { x: 2.07, y: 8.7, leftHandleX: 2.04, leftHandleY: 9.5, rightHandleX: 2.08, rightHandleY: 8.3 },\n   138→    { x: 2.13, y: 5.83, leftHandleX: 2.12, leftHandleY: 6.85, rightHandleX: 2.16, rightHandleY: 4.64 },\n   139→    { x: 2.19, y: 3.07, leftHandleX: 2.17, leftHandleY: 3.88, rightHandleX: 2.22, rightHandleY: 2.15 },\n   140→    { x: 2.28, y: 1.05, leftHandleX: 2.25, leftHandleY: 1.58, rightHandleX: 2.34, rightHandleY: 0.36 },\n   141→    { x: 2.47, y: 0, leftHandleX: 2.41, leftHandleY: 0, rightHandleX: 2.52, rightHandleY: 0 },\n   142→  ],\n   143→  lowerThirdProportion: [\n   144→    { x: 25.6, y: 0, leftHandleX: 24.8, leftHandleY: 0, rightHandleX: 26.4, rightHandleY: 0 },\n   145→    { x: 28.01, y: 1.58, leftHandleX: 27.23, leftHandleY: 0.53, rightHandleX: 28.27, rightHandleY: 1.97 },\n   146→    { x: 28.83, y: 3.21, leftHandleX: 28.62, leftHandleY: 2.59, rightHandleX: 29.03, rightHandleY: 3.76 },\n   147→    { x: 29.63, y: 5.85, leftHandleX: 29.38, leftHandleY: 4.64, rightHandleX: 29.84, rightHandleY: 6.61 },\n   148→    { x: 30.27, y: 8.56, leftHandleX: 30.1, leftHandleY: 7.71, rightHandleX: 30.52, rightHandleY: 9.42 },\n   149→    { x: 31, y: 10, leftHandleX: 30.88, leftHandleY: 10, rightHandleX: 31.13, rightHandleY: 10, fixed: true },\n   150→    { x: 33.5, y: 10, leftHandleX: 33.38, leftHandleY: 10, rightHandleX: 33.63, rightHandleY: 10 },\n   151→    { x: 34.23, y: 8.56, leftHandleX: 33.98, leftHandleY: 9.42, rightHandleX: 34.4, rightHandleY: 7.71 },\n   152→    { x: 34.87, y: 5.85, leftHandleX: 34.66, leftHandleY: 6.61, rightHandleX: 35.12, rightHandleY: 4.64 },\n   153→    { x: 35.67, y: 3.21, leftHandleX: 35.47, leftHandleY: 3.76, rightHandleX: 35.88, rightHandleY: 2.59 },\n   154→    { x: 36.49, y: 1.58, leftHandleX: 36.23, leftHandleY: 1.97, rightHandleX: 37.27, rightHandleY: 0.53 },\n   155→    { x: 38.9, y: 0, leftHandleX: 38.1, leftHandleY: 0, rightHandleX: 39.7, rightHandleY: 0 },\n   156→  ],\n   157→  eyeAspectRatio: [\n   158→    { x: 1.44, y: 0, leftHandleX: 1.18, leftHandleY: 0, rightHandleX: 1.75, rightHandleY: 0.38 },\n   159→    { x: 2.07, y: 1.66, leftHandleX: 1.96, leftHandleY: 1.08, rightHandleX: 2.24, rightHandleY: 2.63 },\n   160→    { x: 2.42, y: 4.34, leftHandleX: 2.35, leftHandleY: 3.6, rightHandleX: 2.52, rightHandleY: 5.5 },\n   161→    { x: 2.71, y: 7.96, leftHandleX: 2.65, leftHandleY: 7.13, rightHandleX: 2.8, rightHandleY: 9.08 },\n   162→    { x: 3, y: 10, leftHandleX: 2.98, leftHandleY: 10, rightHandleX: 3.03, rightHandleY: 10, fixed: true },\n   163→    { x: 3.5, y: 10, leftHandleX: 3.48, leftHandleY: 10, rightHandleX: 3.53, rightHandleY: 10 },\n   164→    { x: 3.79, y: 7.96, leftHandleX: 3.7, leftHandleY: 9.08, rightHandleX: 3.85, rightHandleY: 7.13 },\n   165→    { x: 4.08, y: 4.34, leftHandleX: 3.98, leftHandleY: 5.5, rightHandleX: 4.15, rightHandleY: 3.6 },\n   166→    { x: 4.43, y: 1.66, leftHandleX: 4.26, leftHandleY: 2.63, rightHandleX: 4.54, rightHandleY: 1.08 },\n   167→    { x: 5.06, y: 0, leftHandleX: 4.75, leftHandleY: 0.38, rightHandleX: 5.32, rightHandleY: 0 },\n   168→  ],\n   169→  // Note: Additional curves can be added from METRIC_CUSTOM_CURVES in harmony-scoring.ts\n   170→};\n   171→\n   172→// ============================================\n   173→// CORE SCORING FUNCTIONS\n   174→// ============================================\n   175→\n   176→/**\n   177→ * Exponential Decay Scoring Algorithm with Directional/Dimorphic Support\n   178→ *\n   179→ * Standard: score = maxScore * e^(-decayRate * deviation)\n   180→ *\n   181→ * Directional scoring (polarity):\n   182→ * - 'higher_is_better': Values above safeFloor but below ideal get softZoneScore\n   183→ *   Example: Canthal Tilt of 3 degrees is still positive/good, just not peak ideal (6-8 degrees)\n   184→ * - 'lower_is_better': Values below safeCeiling but above ideal get softZoneScore\n   185→ *   Example: Short philtrum is still attractive even if shorter than \"ideal\"\n   186→ */\n   187→export function calculateMetricScore(\n   188→  value: number,\n   189→  config: MetricConfig\n   190→): number {\n   191→  const {\n   192→    id,\n   193→    idealMin,\n   194→    idealMax,\n   195→    decayRate,\n   196→    maxScore,\n   197→    customCurve,\n   198→    polarity = 'balanced',\n   199→    safeFloor,\n   200→    safeCeiling,\n   201→    softZoneScore = 8.0, // Default \"Good\" score for acceptable-but-not-ideal values\n   202→  } = config;\n   203→\n   204→  // IMPORTANT: Check demographic-adjusted ideal range FIRST\n   205→  // This ensures that demographic overrides are respected even when Bezier curves exist\n   206→  // (Bezier curves are optimized for base ranges and don't auto-adjust for demographics)\n   207→  if (value >= idealMin && value <= idealMax) {\n   208→    return maxScore;\n   209→  }\n   210→\n   211→  // Use custom curve if available in config\n   212→  if (customCurve && customCurve.mode === 'custom') {\n   213→    const bezierScore = interpolateCustomCurve(value, customCurve.points, maxScore);\n   214→    // If Bezier returns -1, it means value is out of range with edge y=0\n   215→    // Fall through to exponential decay instead of returning 0\n   216→    if (bezierScore >= 0) {\n   217→      // Clamp to valid range [0, maxScore] to prevent Bezier overshoot\n   218→      return Math.max(0, Math.min(maxScore, bezierScore));\n   219→    }\n   220→  }\n   221→\n   222→  // Check for pre-defined Bezier curve from harmony curves (66 metrics)\n   223→  const bezierCurve = BEZIER_CURVES[id];\n   224→  if (bezierCurve && bezierCurve.mode === 'custom') {\n   225→    const bezierScore = interpolateCustomCurve(value, bezierCurve.points, maxScore);\n   226→    // If Bezier returns -1, it means value is out of range with edge y=0\n   227→    // Fall through to exponential decay instead of returning 0\n   228→    if (bezierScore >= 0) {\n   229→      // Clamp to valid range [0, maxScore] to prevent Bezier overshoot\n   230→      return Math.max(0, Math.min(maxScore, bezierScore));\n   231→    }\n   232→  }\n   233→\n   234→  // Handle directional/dimorphic scoring\n   235→  if (polarity === 'higher_is_better' && safeFloor !== undefined) {\n   236→    // Higher values are good. Only values below safeFloor are true weaknesses.\n   237→    if (value >= safeFloor && value < idealMin) {\n   238→      // Value is in the \"acceptable but not ideal\" zone\n   239→      // Give a passing score that decreases linearly as we approach the floor\n   240→      const zoneRange = idealMin - safeFloor;\n   241→      const distanceFromIdeal = idealMin - value;\n   242→      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n   243→      // Linear interpolation: idealMin -> maxScore, safeFloor -> softZoneScore\n   244→      return maxScore - t * (maxScore - softZoneScore);\n   245→    }\n   246→    if (value >= idealMax) {\n   247→      // Values above ideal are still excellent for 'higher_is_better'\n   248→      // Apply gentler decay (1/3 the normal rate)\n   249→      const deviation = value - idealMax;\n   250→      const gentleDecay = decayRate / 3;\n   251→      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n   252→    }\n   253→    // Below safeFloor - apply normal (or harsher) exponential decay\n   254→    if (value < safeFloor) {\n   255→      const deviation = safeFloor - value;\n   256→      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n   257→    }\n   258→  }\n   259→\n   260→  if (polarity === 'lower_is_better' && safeCeiling !== undefined) {\n   261→    // Lower values are good. Only values above safeCeiling are true weaknesses.\n   262→    if (value <= safeCeiling && value > idealMax) {\n   263→      // Value is in the \"acceptable but not ideal\" zone\n   264→      const zoneRange = safeCeiling - idealMax;\n   265→      const distanceFromIdeal = value - idealMax;\n   266→      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n   267→      // Linear interpolation: idealMax -> maxScore, safeCeiling -> softZoneScore\n   268→      return maxScore - t * (maxScore - softZoneScore);\n   269→    }\n   270→    if (value <= idealMin) {\n   271→      // Values below ideal are still excellent for 'lower_is_better'\n   272→      // Apply gentler decay (1/3 the normal rate)\n   273→      const deviation = idealMin - value;\n   274→      const gentleDecay = decayRate / 3;\n   275→      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n   276→    }\n   277→    // Above safeCeiling - apply normal exponential decay\n   278→    if (value > safeCeiling) {\n   279→      const deviation = value - safeCeiling;\n   280→      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n   281→    }\n   282→  }\n   283→\n   284→  // Default balanced scoring: deviation in either direction is equally bad\n   285→  const deviation = value < idealMin\n   286→    ? idealMin - value\n   287→    : value - idealMax;\n   288→\n   289→  // Exponential decay\n   290→  const score = maxScore * Math.exp(-decayRate * deviation);\n   291→\n   292→  return Math.max(0, Math.min(maxScore, score));\n   293→}\n   294→\n   295→/**\n   296→ * Check if a metric value is in an \"acceptable\" zone (not a true weakness).\n   297→ * Used by InsightsEngine to prevent false positives.\n   298→ */\n   299→export function isValueAcceptable(\n   300→  value: number,\n   301→  config: MetricConfig\n   302→): { acceptable: boolean; reason: string } {\n   303→  const {\n   304→    idealMin,\n   305→    idealMax,\n   306→    polarity = 'balanced',\n   307→    safeFloor,\n   308→    safeCeiling,\n   309→  } = config;\n   310→\n   311→  // Within ideal range is always acceptable\n   312→  if (value >= idealMin && value <= idealMax) {\n   313→    return { acceptable: true, reason: 'within_ideal' };\n   314→  }\n   315→\n   316→  // Check directional acceptability\n   317→  if (polarity === 'higher_is_better') {\n   318→    if (value >= idealMax) {\n   319→      return { acceptable: true, reason: 'above_ideal_higher_is_better' };\n   320→    }\n   321→    if (safeFloor !== undefined && value >= safeFloor) {\n   322→      return { acceptable: true, reason: 'above_safe_floor' };\n   323→    }\n   324→    // Below safe floor - true weakness\n   325→    return { acceptable: false, reason: 'below_safe_floor' };\n   326→  }\n   327→\n   328→  if (polarity === 'lower_is_better') {\n   329→    if (value <= idealMin) {\n   330→      return { acceptable: true, reason: 'below_ideal_lower_is_better' };\n   331→    }\n   332→    if (safeCeiling !== undefined && value <= safeCeiling) {\n   333→      return { acceptable: true, reason: 'below_safe_ceiling' };\n   334→    }\n   335→    // Above safe ceiling - true weakness\n   336→    return { acceptable: false, reason: 'above_safe_ceiling' };\n   337→  }\n   338→\n   339→  // Balanced polarity - outside ideal is not acceptable\n   340→  return { acceptable: false, reason: 'outside_ideal_balanced' };\n   341→}\n   342→\n   343→/**\n   344→ * Interpolate custom Bezier curve for scoring\n   345→ * Uses cubic Bezier interpolation with control handles for smooth curves\n   346→ *\n   347→ * IMPORTANT: When value is outside the curve range and the edge y-value is 0,\n   348→ * returns -1 to signal the caller should use exponential decay fallback.\n   349→ * This prevents artificially returning 0 for values just outside the curve.\n   350→ */\n   351→export function interpolateCustomCurve(\n   352→  value: number,\n   353→  points: CurvePoint[],\n   354→  maxScore: number\n   355→): number {\n   356→  void maxScore; // Reserved for future custom curve implementations\n   357→  if (points.length === 0) return -1; // Signal to use fallback\n   358→\n   359→  // Sort points by x value\n   360→  const sortedPoints = [...points].sort((a, b) => a.x - b.x);\n   361→\n   362→  // Handle out-of-range values\n   363→  // If edge y-value is 0, return -1 to signal exponential decay fallback should be used\n   364→  if (value <= sortedPoints[0].x) {\n   365→    const edgeY = sortedPoints[0].y;\n   366→    // If edge score is 0, signal to use exponential decay fallback\n   367→    return edgeY <= 0 ? -1 : edgeY;\n   368→  }\n   369→  if (value >= sortedPoints[sortedPoints.length - 1].x) {\n   370→    const edgeY = sortedPoints[sortedPoints.length - 1].y;\n   371→    // If edge score is 0, signal to use exponential decay fallback\n   372→    return edgeY <= 0 ? -1 : edgeY;\n   373→  }\n   374→\n   375→  // Find bracketing points\n   376→  let lowerIndex = 0;\n   377→  for (let i = 0; i < sortedPoints.length - 1; i++) {\n   378→    if (value >= sortedPoints[i].x && value <= sortedPoints[i + 1].x) {\n   379→      lowerIndex = i;\n   380→      break;\n   381→    }\n   382→  }\n   383→\n   384→  const p0 = sortedPoints[lowerIndex];\n   385→  const p3 = sortedPoints[lowerIndex + 1];\n   386→\n   387→  // Check if we have Bezier control handles\n   388→  const hasHandles = p0.rightHandleX !== undefined && p3.leftHandleX !== undefined;\n   389→\n   390→  if (hasHandles) {\n   391→    // Cubic Bezier interpolation with control points\n   392→    const p1x = p0.rightHandleX!;\n   393→    const p1y = p0.rightHandleY ?? p0.y;\n   394→    const p2x = p3.leftHandleX!;\n   395→    const p2y = p3.leftHandleY ?? p3.y;\n   396→\n   397→    // Find t parameter for given x value using Newton-Raphson iteration\n   398→    let t = (value - p0.x) / (p3.x - p0.x); // Initial guess\n   399→\n   400→    // Newton-Raphson iterations to find t where B_x(t) = value\n   401→    for (let iter = 0; iter < 10; iter++) {\n   402→      const bx = cubicBezier(p0.x, p1x, p2x, p3.x, t);\n   403→      const bxDerivative = cubicBezierDerivative(p0.x, p1x, p2x, p3.x, t);\n   404→\n   405→      if (Math.abs(bxDerivative) < 1e-10) break;\n   406→\n   407→      const newT = t - (bx - value) / bxDerivative;\n   408→      if (Math.abs(newT - t) < 1e-10) break;\n   409→      t = Math.max(0, Math.min(1, newT));\n   410→    }\n   411→\n   412→    // Calculate y using the found t parameter\n   413→    return cubicBezier(p0.y, p1y, p2y, p3.y, t);\n   414→  } else {\n   415→    // Smooth interpolation using Catmull-Rom spline\n   416→    // This provides smoother curves than linear interpolation\n   417→    const t = (value - p0.x) / (p3.x - p0.x);\n   418→\n   419→    // Get neighboring points for spline calculation\n   420→    const pMinus1 = lowerIndex > 0 ? sortedPoints[lowerIndex - 1] : p0;\n   421→    const p4 = lowerIndex + 2 < sortedPoints.length ? sortedPoints[lowerIndex + 2] : p3;\n   422→\n   423→    // Catmull-Rom spline interpolation\n   424→    return catmullRomSpline(pMinus1.y, p0.y, p3.y, p4.y, t);\n   425→  }\n   426→}\n   427→\n   428→/**\n   429→ * Cubic Bezier curve evaluation: B(t) = (1-t)^3*P0 + 3*(1-t)^2*t*P1 + 3*(1-t)*t^2*P2 + t^3*P3\n   430→ */\n   431→export function cubicBezier(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   432→  const mt = 1 - t;\n   433→  const mt2 = mt * mt;\n   434→  const mt3 = mt2 * mt;\n   435→  const t2 = t * t;\n   436→  const t3 = t2 * t;\n   437→  return mt3 * p0 + 3 * mt2 * t * p1 + 3 * mt * t2 * p2 + t3 * p3;\n   438→}\n   439→\n   440→/**\n   441→ * Cubic Bezier derivative: B'(t) = 3*(1-t)^2*(P1-P0) + 6*(1-t)*t*(P2-P1) + 3*t^2*(P3-P2)\n   442→ */\n   443→export function cubicBezierDerivative(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   444→  const mt = 1 - t;\n   445→  return 3 * mt * mt * (p1 - p0) + 6 * mt * t * (p2 - p1) + 3 * t * t * (p3 - p2);\n   446→}\n   447→\n   448→/**\n   449→ * Catmull-Rom spline interpolation for smooth curves without explicit handles\n   450→ */\n   451→export function catmullRomSpline(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   452→  const t2 = t * t;\n   453→  const t3 = t2 * t;\n   454→\n   455→  // Catmull-Rom coefficients with tension = 0.5\n   456→  const a = -0.5 * p0 + 1.5 * p1 - 1.5 * p2 + 0.5 * p3;\n   457→  const b = p0 - 2.5 * p1 + 2 * p2 - 0.5 * p3;\n   458→  const c = -0.5 * p0 + 0.5 * p2;\n   459→  const d = p1;\n   460→\n   461→  return a * t3 + b * t2 + c * t + d;\n   462→}\n   463→\n   464→/**\n   465→ * Calculate standardized score (0-10 normalized)\n   466→ * Clamps output to [0, 10] to prevent display issues from scoring edge cases\n   467→ */\n   468→export function standardizeScore(score: number, maxScore: number): number {\n   469→  const normalized = (score / maxScore) * 10;\n   470→  return Math.max(0, Math.min(10, normalized));\n   471→}\n   472→\n   473→/**\n   474→ * Determine quality tier based on score\n   475→ */\n   476→export function getQualityTier(score: number, maxScore: number = 10): QualityTier {\n   477→  const normalized = (score / maxScore) * 100;\n   478→\n   479→  if (normalized >= 90) return 'ideal';\n   480→  if (normalized >= 70) return 'excellent';\n   481→  if (normalized >= 50) return 'good';\n   482→  return 'below_average';\n   483→}\n   484→\n   485→/**\n   486→ * Determine severity level based on score\n   487→ */\n   488→export function getSeverityLevel(score: number, maxScore: number = 10): SeverityLevel {\n   489→  const normalized = (score / maxScore) * 100;\n   490→\n   491→  if (normalized >= 85) return 'optimal';\n   492→  if (normalized >= 70) return 'minor';\n   493→  if (normalized >= 50) return 'moderate';\n   494→  if (normalized >= 30) return 'major';\n   495→  if (normalized >= 15) return 'severe';\n   496→  return 'extremely_severe';\n   497→}\n   498→\n   499→/**\n   500→ * Calculate deviation description\n   501→ */\n   502→export function getDeviationDescription(\n   503→  value: number,\n   504→  idealMin: number,\n   505→  idealMax: number,\n   506→  unit: MeasurementUnit\n   507→): { deviation: number; direction: 'above' | 'below' | 'within'; description: string } {\n   508→  if (value >= idealMin && value <= idealMax) {\n   509→    return { deviation: 0, direction: 'within', description: 'within ideal range' };\n   510→  }\n   511→\n   512→  const unitLabel = getUnitLabel(unit);\n   513→\n   514→  if (value < idealMin) {\n   515→    const dev = idealMin - value;\n   516→    return {\n   517→      deviation: dev,\n   518→      direction: 'below',\n   519→      description: `${dev.toFixed(2)}${unitLabel} below ideal`,\n   520→    };\n   521→  }\n   522→\n   523→  const dev = value - idealMax;\n   524→  return {\n   525→    deviation: dev,\n   526→    direction: 'above',\n   527→    description: `${dev.toFixed(2)}${unitLabel} above ideal`,\n   528→  };\n   529→}\n   530→\n   531→/**\n   532→ * Get unit label for display\n   533→ */\n   534→export function getUnitLabel(unit: MeasurementUnit): string {\n   535→  switch (unit) {\n   536→    case 'ratio': return 'x';\n   537→    case 'percent': return '%';\n   538→    case 'degrees': return '\\u00B0';\n   539→    case 'mm': return 'mm';\n   540→    default: return '';\n   541→  }\n   542→}\n   543→\n   544→// ============================================\n   545→// GEOMETRY HELPERS\n   546→// ============================================\n   547→\n   548→/**\n   549→ * Calculate distance between two points\n   550→ */\n   551→export function distance(p1: Point, p2: Point): number {\n   552→  return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));\n   553→}\n   554→\n   555→/**\n   556→ * Calculate angle at vertex point (in degrees)\n   557→ */\n   558→export function calculateAngle(p1: Point, vertex: Point, p2: Point): number {\n   559→  const v1 = { x: p1.x - vertex.x, y: p1.y - vertex.y };\n   560→  const v2 = { x: p2.x - vertex.x, y: p2.y - vertex.y };\n   561→\n   562→  const dot = v1.x * v2.x + v1.y * v2.y;\n   563→  const cross = v1.x * v2.y - v1.y * v2.x;\n   564→\n   565→  const angle = Math.atan2(cross, dot) * (180 / Math.PI);\n   566→  return Math.abs(angle);\n   567→}\n   568→\n   569→/**\n   570→ * Calculate perpendicular distance from point to line (signed)\n   571→ */\n   572→export function perpendicularDistance(\n   573→  point: Point,\n   574→  lineStart: Point,\n   575→  lineEnd: Point\n   576→): number {\n   577→  const A = point.x - lineStart.x;\n   578→  const B = point.y - lineStart.y;\n   579→  const C = lineEnd.x - lineStart.x;\n   580→  const D = lineEnd.y - lineStart.y;\n   581→\n   582→  const dot = A * C + B * D;\n   583→  const lenSq = C * C + D * D;\n   584→  const param = lenSq !== 0 ? dot / lenSq : -1;\n   585→\n   586→  let xx: number, yy: number;\n   587→\n   588→  if (param < 0) {\n   589→    xx = lineStart.x;\n   590→    yy = lineStart.y;\n   591→  } else if (param > 1) {\n   592→    xx = lineEnd.x;\n   593→    yy = lineEnd.y;\n   594→  } else {\n   595→    xx = lineStart.x + param * C;\n   596→    yy = lineStart.y + param * D;\n   597→  }\n   598→\n   599→  const dx = point.x - xx;\n   600→  const dy = point.y - yy;\n   601→\n   602→  const sign =\n   603→    (lineEnd.y - lineStart.y) * point.x -\n   604→      (lineEnd.x - lineStart.x) * point.y +\n   605→      lineEnd.x * lineStart.y -\n   606→      lineEnd.y * lineStart.x >=\n   607→    0\n   608→      ? 1\n   609→      : -1;\n   610→\n   611→  return sign * Math.sqrt(dx * dx + dy * dy);\n   612→}\n   613→\n   614→// ============================================\n   615→// PERCENTILE & PSL CONVERSION\n   616→// ============================================\n   617→\n   618→/**\n   619→ * Calculate percentile from harmony score\n   620→ */\n   621→export function calculateHarmonyPercentile(score: number): number {\n   622→  // Based on normal distribution with mean=5, stdDev=1.5\n   623→  const mean = 5;\n   624→  const stdDev = 1.5;\n   625→  const z = (score - mean) / stdDev;\n   626→  return normalCDF(z) * 100;\n   627→}\n   628→\n   629→/**\n   630→ * Standard normal CDF approximation\n   631→ */\n   632→export function normalCDF(z: number): number {\n   633→  const a1 = 0.254829592;\n   634→  const a2 = -0.284496736;\n   635→  const a3 = 1.421413741;\n   636→  const a4 = -1.453152027;\n   637→  const a5 = 1.061405429;\n   638→  const p = 0.3275911;\n   639→\n   640→  const sign = z < 0 ? -1 : 1;\n   641→  const absZ = Math.abs(z) / Math.sqrt(2);\n   642→\n   643→  const t = 1.0 / (1.0 + p * absZ);\n   644→  const y = 1.0 - ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-absZ * absZ);\n   645→\n   646→  return 0.5 * (1.0 + sign * y);\n   647→}\n   648→\n   649→// ============================================\n   650→// PSL RATING CONVERSION\n   651→// ============================================\n   652→\n   653→export interface PSLRating {\n   654→  score: number;\n   655→  tier: string;\n   656→  percentile: number;\n   657→  description: string;\n   658→}\n   659→\n   660→/**\n   661→ * Convert harmony score to PSL rating\n   662→ */\n   663→export function convertToPSL(harmonyScore: number): PSLRating {\n   664→  // Convert 0-10 harmony to 3.0-7.5 PSL range\n   665→  const psl = 3.0 + (harmonyScore / 10) * 4.5;\n   666→  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n   667→\n   668→  let tier: string;\n   669→  let percentile: number;\n   670→\n   671→  if (clampedPSL >= 7.5) {\n   672→    tier = 'Top Model';\n   673→    percentile = 99.99;\n   674→  } else if (clampedPSL >= 7.0) {\n   675→    tier = 'Chad';\n   676→    percentile = 99.87;\n   677→  } else if (clampedPSL >= 6.5) {\n   678→    tier = 'Chadlite';\n   679→    percentile = 99.0;\n   680→  } else if (clampedPSL >= 6.0) {\n   681→    tier = 'High Tier Normie+';\n   682→    percentile = 97.25;\n   683→  } else if (clampedPSL >= 5.5) {\n   684→    tier = 'High Tier Normie';\n   685→    percentile = 90.0;\n   686→  } else if (clampedPSL >= 5.0) {\n   687→    tier = 'Mid Tier Normie+';\n   688→    percentile = 84.15;\n   689→  } else if (clampedPSL >= 4.5) {\n   690→    tier = 'Mid Tier Normie';\n   691→    percentile = 65.0;\n   692→  } else if (clampedPSL >= 4.0) {\n   693→    tier = 'Low Tier Normie';\n   694→    percentile = 50.0;\n   695→  } else if (clampedPSL >= 3.5) {\n   696→    tier = 'Below Average';\n   697→    percentile = 30.0;\n   698→  } else {\n   699→    tier = 'Subpar';\n   700→    percentile = 15.0;\n   701→  }\n   702→\n   703→  return {\n   704→    score: clampedPSL,\n   705→    tier,\n   706→    percentile,\n   707→    description: `${tier} (top ${(100 - percentile).toFixed(1)}%)`,\n   708→  };\n   709→}\n   710→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n","numLines":715,"startLine":1,"totalLines":715}}}
{"parentUuid":"d727bb80-c696-4892-8d07-5787af368d5a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01H5NBrWRbRN6tXNppwgPNLM","type":"tool_result","content":"     1→     1→'use client';\n     2→     2→\n     3→     3→import React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\n     4→     4→import { LandmarkPoint } from '@/lib/landmarks';\n     5→     5→import {\n     6→     6→  analyzeFrontProfile,\n     7→     7→  analyzeSideProfile,\n     8→     8→  analyzeHarmony,\n     9→     9→  HarmonyAnalysis,\n    10→    10→  MetricScoreResult,\n    11→    11→  METRIC_CONFIGS,\n    12→    12→  Ethnicity,\n    13→    13→  Gender,\n    14→    14→} from '@/lib/harmony-scoring';\n    15→    15→import {\n    16→    16→  calculateHarmonyScore,\n    17→    17→  getTopMetrics,\n    18→    18→  getBottomMetrics,\n    19→    19→  HarmonyScoreResult,\n    20→    20→  RankedMetric,\n    21→    21→} from '@/lib/looksmax-scoring';\n    22→    22→import { harmonyToPSL } from '@/lib/recommendations/severity';\n    23→    23→import {\n    24→    24→  classifyInsights,\n    25→    25→  convertToStrength,\n    26→    26→  convertToFlaw,\n    27→    27→  INSIGHTS_DEFINITIONS,\n    28→    28→} from '@/lib/insights-engine';\n    29→    29→import { classifyMetric } from '@/lib/taxonomy';\n    30→    30→import {\n    31→    31→  Ratio,\n    32→    32→  Strength,\n    33→    33→  Flaw,\n    34→    34→  Recommendation,\n    35→    35→  ResultsTab,\n    36→    36→  FullHarmonyAnalysis,\n    37→    37→} from '@/types/results';\n    38→    38→import { generateRecommendations } from '@/lib/results/analysis';\n    39→    39→\n    40→    40→// ============================================\n    41→    41→// CONTEXT TYPES\n    42→    42→// ============================================\n    43→    43→\n    44→    44→interface ResultsContextType {\n    45→    45→  // Raw data\n    46→    46→  frontLandmarks: LandmarkPoint[];\n    47→    47→  sideLandmarks: LandmarkPoint[];\n    48→    48→  gender: Gender;\n    49→    49→  ethnicity: Ethnicity;\n    50→    50→  frontPhoto: string;\n    51→    51→  sidePhoto: string | null;\n    52→    52→\n    53→    53→  // Computed results\n    54→    54→  harmonyAnalysis: FullHarmonyAnalysis | null;\n    55→    55→  frontRatios: Ratio[];\n    56→    56→  sideRatios: Ratio[];\n    57→    57→  strengths: Strength[];\n    58→    58→  flaws: Flaw[];\n    59→    59→  recommendations: Recommendation[];\n    60→    60→\n    61→    61→  // Scores (now using weighted harmony from looksmax_engine.py)\n    62→    62→  overallScore: number;\n    63→    63→  frontScore: number;\n    64→    64→  sideScore: number;\n    65→    65→\n    66→    66→  // Weighted Harmony Score (from looksmax_engine.py)\n    67→    67→  harmonyScoreResult: HarmonyScoreResult | null;\n    68→    68→  harmonyPercentage: number;  // 0-100% weighted harmony\n    69→    69→\n    70→    70→  // Top 3 strengths and bottom 3 areas to improve with advice\n    71→    71→  topMetrics: RankedMetric[];\n    72→    72→  bottomMetrics: RankedMetric[];\n    73→    73→\n    74→    74→  // PSL Rating (1-10 scale)\n    75→    75→  pslRating: {\n    76→    76→    psl: number;\n    77→    77→    tier: string;\n    78→    78→    percentile: number;\n    79→    79→    description: string;\n    80→    80→  };\n    81→    81→\n    82→    82→  // UI state\n    83→    83→  activeTab: ResultsTab;\n    84→    84→  setActiveTab: (tab: ResultsTab) => void;\n    85→    85→  expandedMeasurementId: string | null;\n    86→    86→  setExpandedMeasurementId: (id: string | null) => void;\n    87→    87→  selectedVisualizationMetric: string | null;\n    88→    88→  setSelectedVisualizationMetric: (id: string | null) => void;\n    89→    89→  categoryFilter: string | null;\n    90→    90→  setCategoryFilter: (category: string | null) => void;\n    91→    91→  showLandmarkOverlay: boolean;\n    92→    92→  setShowLandmarkOverlay: (show: boolean) => void;\n    93→    93→\n    94→    94→  // Actions\n    95→    95→  setResultsData: (data: ResultsInputData) => void;\n    96→    96→}\n    97→    97→\n    98→    98→interface ResultsInputData {\n    99→    99→  frontLandmarks: LandmarkPoint[];\n   100→   100→  sideLandmarks: LandmarkPoint[];\n   101→   101→  frontPhoto: string;\n   102→   102→  sidePhoto?: string;\n   103→   103→  gender: Gender;\n   104→   104→  ethnicity?: Ethnicity;\n   105→   105→}\n   106→   106→\n   107→   107→// ============================================\n   108→   108→// HELPER FUNCTIONS\n   109→   109→// ============================================\n   110→   110→\n   111→   111→function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n   112→   112→  switch (unit) {\n   113→   113→    case 'ratio': return 'x';\n   114→   114→    case 'percent': return '%';\n   115→   115→    case 'degrees': return '°';\n   116→   116→    case 'mm': return 'mm';\n   117→   117→    default: return 'x';\n   118→   118→  }\n   119→   119→}\n   120→   120→\n   121→   121→function transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {\n   122→   122→  const metricConfig = METRIC_CONFIGS[result.metricId];\n   123→   123→\n   124→   124→  // Generate illustration based on metric\n   125→   125→  const illustration = generateIllustration(result.metricId, landmarks);\n   126→   126→\n   127→   127→  // Get flaw/strength mappings\n   128→   128→  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n   129→   129→\n   130→   130→  // Classify metric using Harmony taxonomy\n   131→   131→  const taxonomyClassification = classifyMetric(result.name, result.category);\n   132→   132→\n   133→   133→  // Clamp scores to valid 0-10 range for display (defense-in-depth)\n   134→   134→  const clampedScore = Math.max(0, Math.min(10, result.standardizedScore));\n   135→   135→\n   136→   136→  return {\n   137→   137→    id: result.metricId,\n   138→   138→    name: result.name,\n   139→   139→    value: result.value,\n   140→   140→    score: clampedScore,  // Use standardized 0-10 score for UI display\n   141→   141→    standardizedScore: clampedScore,\n   142→   142→    unit: convertUnitToRatioUnit(result.unit),\n   143→   143→    idealMin: result.idealMin,\n   144→   144→    idealMax: result.idealMax,\n   145→   145→    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n   146→   146→    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n   147→   147→    description: metricConfig?.description || '',\n   148→   148→    category: result.category,\n   149→   149→    qualityLevel: result.qualityTier,\n   150→   150→    severity: result.severity,\n   151→   151→    illustration,\n   152→   152→    mayIndicateFlaws,\n   153→   153→    mayIndicateStrengths,\n   154→   154→    usedLandmarks: getUsedLandmarks(result.metricId),\n   155→   155→    scoringCurveConfig: metricConfig ? {\n   156→   156→      decayRate: metricConfig.decayRate,\n   157→   157→      maxScore: metricConfig.maxScore,\n   158→   158→    } : undefined,\n   159→   159→    taxonomyPrimary: taxonomyClassification?.primary,\n   160→   160→    taxonomySecondary: taxonomyClassification?.secondary,\n   161→   161→  };\n   162→   162→}\n   163→   163→\n   164→   164→// Enhanced illustration configuration type\n   165→   165→interface IllustrationConfig {\n   166→   166→  points: string[];\n   167→   167→  lines: Array<{\n   168→   168→    from: string;\n   169→   169→    to: string;\n   170→   170→    label?: string;\n   171→   171→    color?: string;\n   172→   172→    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n   173→   173→  }>;\n   174→   174→}\n   175→   175→\n   176→   176→// Comprehensive illustration configurations for all metrics\n   177→   177→const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n   178→   178→  // ==========================================\n   179→   179→  // FACE SHAPE / PROPORTIONS\n   180→   180→  // ==========================================\n   181→   181→  faceWidthToHeight: {\n   182→   182→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   183→   183→    lines: [\n   184→   184→      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n   185→   185→      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n   186→   186→    ],\n   187→   187→  },\n   188→   188→  totalFacialWidthToHeight: {\n   189→   189→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   190→   190→    lines: [\n   191→   191→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   192→   192→      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n   193→   193→    ],\n   194→   194→  },\n   195→   195→  lowerThirdProportion: {\n   196→   196→    points: ['subnasale', 'menton', 'trichion'],\n   197→   197→    lines: [\n   198→   198→      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n   199→   199→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   200→   200→    ],\n   201→   201→  },\n   202→   202→  middleThirdProportion: {\n   203→   203→    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n   204→   204→    lines: [\n   205→   205→      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n   206→   206→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   207→   207→    ],\n   208→   208→  },\n   209→   209→  upperThirdProportion: {\n   210→   210→    points: ['trichion', 'nasal_base', 'menton'],\n   211→   211→    lines: [\n   212→   212→      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n   213→   213→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   214→   214→    ],\n   215→   215→  },\n   216→   216→  bitemporalWidth: {\n   217→   217→    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n   218→   218→    lines: [\n   219→   219→      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n   220→   220→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n   221→   221→    ],\n   222→   222→  },\n   223→   223→  cheekboneHeight: {\n   224→   224→    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n   225→   225→    lines: [\n   226→   226→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n   227→   227→      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n   228→   228→    ],\n   229→   229→  },\n   230→   230→  midfaceRatio: {\n   231→   231→    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n   232→   232→    lines: [\n   233→   233→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n   234→   234→      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n   235→   235→    ],\n   236→   236→  },\n   237→   237→\n   238→   238→  // ==========================================\n   239→   239→  // JAW MEASUREMENTS\n   240→   240→  // ==========================================\n   241→   241→  jawSlope: {\n   242→   242→    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n   243→   243→    lines: [\n   244→   244→      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n   245→   245→      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n   246→   246→    ],\n   247→   247→  },\n   248→   248→  jawFrontalAngle: {\n   249→   249→    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n   250→   250→    lines: [\n   251→   251→      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n   252→   252→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n   253→   253→    ],\n   254→   254→  },\n   255→   255→  bigonialWidth: {\n   256→   256→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   257→   257→    lines: [\n   258→   258→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n   259→   259→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   260→   260→    ],\n   261→   261→  },\n   262→   262→  jawWidthRatio: {\n   263→   263→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   264→   264→    lines: [\n   265→   265→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   266→   266→      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n   267→   267→    ],\n   268→   268→  },\n   269→   269→\n   270→   270→  // ==========================================\n   271→   271→  // EYE MEASUREMENTS\n   272→   272→  // ==========================================\n   273→   273→  lateralCanthalTilt: {\n   274→   274→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n   275→   275→    lines: [\n   276→   276→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n   277→   277→      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n   278→   278→    ],\n   279→   279→  },\n   280→   280→  eyeAspectRatio: {\n   281→   281→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n   282→   282→    lines: [\n   283→   283→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n   284→   284→      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n   285→   285→    ],\n   286→   286→  },\n   287→   287→  eyeSeparationRatio: {\n   288→   288→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n   289→   289→    lines: [\n   290→   290→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   291→   291→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   292→   292→    ],\n   293→   293→  },\n   294→   294→  interpupillaryRatio: {\n   295→   295→    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n   296→   296→    lines: [\n   297→   297→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   298→   298→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   299→   299→    ],\n   300→   300→  },\n   301→   301→  interpupillaryMouthWidthRatio: {\n   302→   302→    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n   303→   303→    lines: [\n   304→   304→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   305→   305→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   306→   306→    ],\n   307→   307→  },\n   308→   308→  oneEyeApartTest: {\n   309→   309→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n   310→   310→    lines: [\n   311→   311→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n   312→   312→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n   313→   313→    ],\n   314→   314→  },\n   315→   315→\n   316→   316→  // ==========================================\n   317→   317→  // EYEBROW MEASUREMENTS\n   318→   318→  // ==========================================\n   319→   319→  browLengthRatio: {\n   320→   320→    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n   321→   321→    lines: [\n   322→   322→      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n   323→   323→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   324→   324→    ],\n   325→   325→  },\n   326→   326→  eyebrowTilt: {\n   327→   327→    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n   328→   328→    lines: [\n   329→   329→      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n   330→   330→      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n   331→   331→    ],\n   332→   332→  },\n   333→   333→  eyebrowLowSetedness: {\n   334→   334→    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n   335→   335→    lines: [\n   336→   336→      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n   337→   337→    ],\n   338→   338→  },\n   339→   339→\n   340→   340→  // ==========================================\n   341→   341→  // NOSE MEASUREMENTS (FRONT)\n   342→   342→  // ==========================================\n   343→   343→  nasalIndex: {\n   344→   344→    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n   345→   345→    lines: [\n   346→   346→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n   347→   347→      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n   348→   348→    ],\n   349→   349→  },\n   350→   350→  intercanthalNasalRatio: {\n   351→   351→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n   352→   352→    lines: [\n   353→   353→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n   354→   354→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   355→   355→    ],\n   356→   356→  },\n   357→   357→  noseBridgeWidth: {\n   358→   358→    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n   359→   359→    lines: [\n   360→   360→      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n   361→   361→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n   362→   362→    ],\n   363→   363→  },\n   364→   364→  noseTipPosition: {\n   365→   365→    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n   366→   366→    lines: [\n   367→   367→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n   368→   368→    ],\n   369→   369→  },\n   370→   370→\n   371→   371→  // ==========================================\n   372→   372→  // MOUTH/LIP MEASUREMENTS\n   373→   373→  // ==========================================\n   374→   374→  mouthNoseWidthRatio: {\n   375→   375→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n   376→   376→    lines: [\n   377→   377→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   378→   378→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n   379→   379→    ],\n   380→   380→  },\n   381→   381→  lowerUpperLipRatio: {\n   382→   382→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n   383→   383→    lines: [\n   384→   384→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n   385→   385→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n   386→   386→    ],\n   387→   387→  },\n   388→   388→  chinPhiltrumRatio: {\n   389→   389→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n   390→   390→    lines: [\n   391→   391→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n   392→   392→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n   393→   393→    ],\n   394→   394→  },\n   395→   395→  mouthWidth: {\n   396→   396→    points: ['left_cheilion', 'right_cheilion'],\n   397→   397→    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n   398→   398→  },\n   399→   399→\n   400→   400→  // ==========================================\n   401→   401→  // CHIN MEASUREMENTS\n   402→   402→  // ==========================================\n   403→   403→  chinHeight: {\n   404→   404→    points: ['labrale_inferius', 'menton'],\n   405→   405→    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n   406→   406→  },\n   407→   407→\n   408→   408→  // ==========================================\n   409→   409→  // NECK MEASUREMENTS\n   410→   410→  // ==========================================\n   411→   411→  neckWidthRatio: {\n   412→   412→    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n   413→   413→    lines: [\n   414→   414→      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n   415→   415→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   416→   416→    ],\n   417→   417→  },\n   418→   418→\n   419→   419→  // ==========================================\n   420→   420→  // SIDE PROFILE MEASUREMENTS\n   421→   421→  // ==========================================\n   422→   422→  gonialAngle: {\n   423→   423→    points: ['tragus', 'gonionBottom', 'menton'],\n   424→   424→    lines: [\n   425→   425→      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   426→   426→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   427→   427→    ],\n   428→   428→  },\n   429→   429→  nasofrontalAngle: {\n   430→   430→    points: ['glabella', 'nasion', 'pronasale'],\n   431→   431→    lines: [\n   432→   432→      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n   433→   433→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   434→   434→    ],\n   435→   435→  },\n   436→   436→  nasofacialAngle: {\n   437→   437→    points: ['nasion', 'pronasale', 'pogonion'],\n   438→   438→    lines: [\n   439→   439→      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n   440→   440→      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n   441→   441→    ],\n   442→   442→  },\n   443→   443→  nasomentaAngle: {\n   444→   444→    points: ['nasion', 'pronasale', 'pogonion'],\n   445→   445→    lines: [\n   446→   446→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   447→   447→      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n   448→   448→    ],\n   449→   449→  },\n   450→   450→  submentalCervicalAngle: {\n   451→   451→    points: ['menton', 'cervicalPoint', 'neckPoint'],\n   452→   452→    lines: [\n   453→   453→      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n   454→   454→      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n   455→   455→    ],\n   456→   456→  },\n   457→   457→  facialDepthToHeight: {\n   458→   458→    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n   459→   459→    lines: [\n   460→   460→      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n   461→   461→      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n   462→   462→    ],\n   463→   463→  },\n   464→   464→  anteriorFacialDepth: {\n   465→   465→    points: ['glabella', 'pronasale', 'pogonion'],\n   466→   466→    lines: [\n   467→   467→      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n   468→   468→      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n   469→   469→    ],\n   470→   470→  },\n   471→   471→  mandibularPlaneAngle: {\n   472→   472→    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n   473→   473→    lines: [\n   474→   474→      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n   475→   475→      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n   476→   476→    ],\n   477→   477→  },\n   478→   478→  ramusToMandibleRatio: {\n   479→   479→    points: ['gonionTop', 'gonionBottom', 'menton'],\n   480→   480→    lines: [\n   481→   481→      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   482→   482→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   483→   483→    ],\n   484→   484→  },\n   485→   485→  orbitalVector: {\n   486→   486→    points: ['cornealApex', 'orbitale', 'cheekbone'],\n   487→   487→    lines: [\n   488→   488→      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n   489→   489→    ],\n   490→   490→  },\n   491→   491→  eLineLowerLip: {\n   492→   492→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   493→   493→    lines: [\n   494→   494→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n   495→   495→    ],\n   496→   496→  },\n   497→   497→  sLineLowerLip: {\n   498→   498→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   499→   499→    lines: [\n   500→   500→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n   501→   501→    ],\n   502→   502→  },\n   503→   503→  holdawayHLine: {\n   504→   504→    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n   505→   505→    lines: [\n   506→   506→      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n   507→   507→    ],\n   508→   508→  },\n   509→   509→  burstoneLowerLip: {\n   510→   510→    points: ['subnasale', 'pogonion', 'labraleInferius'],\n   511→   511→    lines: [\n   512→   512→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n   513→   513→    ],\n   514→   514→  },\n   515→   515→\n   516→   516→  // ==========================================\n   517→   517→  // ADDITIONAL FRONT PROFILE METRICS\n   518→   518→  // ==========================================\n   519→   519→  cupidsBowDepth: {\n   520→   520→    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],\n   521→   521→    lines: [\n   522→   522→      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },\n   523→   523→      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },\n   524→   524→    ],\n   525→   525→  },\n   526→   526→  mouthCornerPosition: {\n   527→   527→    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],\n   528→   528→    lines: [\n   529→   529→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },\n   530→   530→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },\n   531→   531→    ],\n   532→   532→  },\n   533→   533→  iaaJfaDeviation: {\n   534→   534→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n   535→   535→    lines: [\n   536→   536→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },\n   537→   537→      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },\n   538→   538→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n   539→   539→    ],\n   540→   540→  },\n   541→   541→  ipsilateralAlarAngle: {\n   542→   542→    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],\n   543→   543→    lines: [\n   544→   544→      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },\n   545→   545→      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },\n   546→   546→    ],\n   547→   547→  },\n   548→   548→  earProtrusionAngle: {\n   549→   549→    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],\n   550→   550→    lines: [\n   551→   551→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },\n   552→   552→    ],\n   553→   553→  },\n   554→   554→  earProtrusionRatio: {\n   555→   555→    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],\n   556→   556→    lines: [\n   557→   557→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },\n   558→   558→      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },\n   559→   559→    ],\n   560→   560→  },\n   561→   561→  mouthWidthToNoseRatio: {\n   562→   562→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n   563→   563→    lines: [\n   564→   564→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   565→   565→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n   566→   566→    ],\n   567→   567→  },\n   568→   568→  lowerToUpperLipRatio: {\n   569→   569→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n   570→   570→    lines: [\n   571→   571→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n   572→   572→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n   573→   573→    ],\n   574→   574→  },\n   575→   575→  chinToPhiltrumRatio: {\n   576→   576→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n   577→   577→    lines: [\n   578→   578→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n   579→   579→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n   580→   580→    ],\n   581→   581→  },\n   582→   582→\n   583→   583→  // ==========================================\n   584→   584→  // ADDITIONAL SIDE PROFILE METRICS\n   585→   585→  // ==========================================\n   586→   586→  nasolabialAngle: {\n   587→   587→    points: ['columella', 'subnasale', 'labraleSuperius'],\n   588→   588→    lines: [\n   589→   589→      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },\n   590→   590→      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },\n   591→   591→    ],\n   592→   592→  },\n   593→   593→  nasalTipAngle: {\n   594→   594→    points: ['nasion', 'pronasale', 'columella'],\n   595→   595→    lines: [\n   596→   596→      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },\n   597→   597→      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },\n   598→   598→    ],\n   599→   599→  },\n   600→   600→  nasalProjection: {\n   601→   601→    points: ['alar_crease', 'pronasale', 'subnasale'],\n   602→   602→    lines: [\n   603→   603→      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },\n   604→   604→    ],\n   605→   605→  },\n   606→   606→  nasalWToHRatio: {\n   607→   607→    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],\n   608→   608→    lines: [\n   609→   609→      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },\n   610→   610→      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n   611→   611→    ],\n   612→   612→  },\n   613→   613→  noseTipRotationAngle: {\n   614→   614→    points: ['columella', 'subnasale', 'labraleSuperius'],\n   615→   615→    lines: [\n   616→   616→      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },\n   617→   617→    ],\n   618→   618→  },\n   619→   619→  frankfortTipAngle: {\n   620→   620→    points: ['porion', 'orbitale', 'pronasale'],\n   621→   621→    lines: [\n   622→   622→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   623→   623→      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },\n   624→   624→    ],\n   625→   625→  },\n   626→   626→  mentolabialAngle: {\n   627→   627→    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],\n   628→   628→    lines: [\n   629→   629→      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },\n   630→   630→      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },\n   631→   631→    ],\n   632→   632→  },\n   633→   633→  zAngle: {\n   634→   634→    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],\n   635→   635→    lines: [\n   636→   636→      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },\n   637→   637→    ],\n   638→   638→  },\n   639→   639→  facialConvexityGlabella: {\n   640→   640→    points: ['glabella', 'subnasale', 'pogonion'],\n   641→   641→    lines: [\n   642→   642→      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },\n   643→   643→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   644→   644→    ],\n   645→   645→  },\n   646→   646→  facialConvexityNasion: {\n   647→   647→    points: ['nasion', 'subnasale', 'pogonion'],\n   648→   648→    lines: [\n   649→   649→      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },\n   650→   650→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   651→   651→    ],\n   652→   652→  },\n   653→   653→  totalFacialConvexity: {\n   654→   654→    points: ['glabella', 'pronasale', 'pogonion'],\n   655→   655→    lines: [\n   656→   656→      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },\n   657→   657→      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   658→   658→    ],\n   659→   659→  },\n   660→   660→  interiorMidfaceProjectionAngle: {\n   661→   661→    points: ['orbitale', 'subnasale', 'pronasale'],\n   662→   662→    lines: [\n   663→   663→      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },\n   664→   664→      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },\n   665→   665→    ],\n   666→   666→  },\n   667→   667→  recessionFromFrankfort: {\n   668→   668→    points: ['porion', 'orbitale', 'pogonion'],\n   669→   669→    lines: [\n   670→   670→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   671→   671→      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },\n   672→   672→    ],\n   673→   673→  },\n   674→   674→  gonionToMouthLine: {\n   675→   675→    points: ['gonionBottom', 'cheilion', 'tragus'],\n   676→   676→    lines: [\n   677→   677→      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },\n   678→   678→    ],\n   679→   679→  },\n   680→   680→  eLineUpperLip: {\n   681→   681→    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n   682→   682→    lines: [\n   683→   683→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n   684→   684→    ],\n   685→   685→  },\n   686→   686→  sLineUpperLip: {\n   687→   687→    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n   688→   688→    lines: [\n   689→   689→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n   690→   690→    ],\n   691→   691→  },\n   692→   692→  burstoneUpperLip: {\n   693→   693→    points: ['subnasale', 'pogonion', 'labraleSuperius'],\n   694→   694→    lines: [\n   695→   695→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n   696→   696→    ],\n   697→   697→  },\n   698→   698→  chinProjection: {\n   699→   699→    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],\n   700→   700→    lines: [\n   701→   701→      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },\n   702→   702→    ],\n   703→   703→  },\n   704→   704→  recessionRelativeToFrankfort: {\n   705→   705→    points: ['porion', 'orbitale', 'pogonion', 'menton'],\n   706→   706→    lines: [\n   707→   707→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   708→   708→      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },\n   709→   709→    ],\n   710→   710→  },\n   711→   711→  browridgeInclinationAngle: {\n   712→   712→    points: ['glabella', 'trichion', 'nasion'],\n   713→   713→    lines: [\n   714→   714→      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },\n   715→   715→      { from: 'glabella', to: 'nasion', color: '#67e8f9' },\n   716→   716→    ],\n   717→   717→  },\n   718→   718→  upperForeheadSlope: {\n   719→   719→    points: ['trichion', 'glabella', 'frankfortHorizontal'],\n   720→   720→    lines: [\n   721→   721→      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },\n   722→   722→    ],\n   723→   723→  },\n   724→   724→  midfaceProjectionAngle: {\n   725→   725→    points: ['orbitale', 'subnasale', 'pronasale'],\n   726→   726→    lines: [\n   727→   727→      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },\n   728→   728→      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },\n   729→   729→    ],\n   730→   730→  },\n   731→   731→};\n   732→   732→\n   733→   733→function generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {\n   734→   734→  const landmarkMap: Record<string, LandmarkPoint> = {};\n   735→   735→  landmarks.forEach(l => { landmarkMap[l.id] = l; });\n   736→   736→\n   737→   737→  const config = ILLUSTRATION_CONFIGS[metricId];\n   738→   738→  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};\n   739→   739→  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};\n   740→   740→\n   741→   741→  if (config) {\n   742→   742→    config.points.forEach((pointId, i) => {\n   743→   743→      if (landmarkMap[pointId]) {\n   744→   744→        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };\n   745→   745→      }\n   746→   746→    });\n   747→   747→    config.lines.forEach((line, i) => {\n   748→   748→      lines[`line_${i}`] = {\n   749→   749→        from: line.from,\n   750→   750→        to: line.to,\n   751→   751→        color: line.color || '#67e8f9',\n   752→   752→        label: line.label,\n   753→   753→        labelPosition: line.labelPosition,\n   754→   754→      };\n   755→   755→    });\n   756→   756→  }\n   757→   757→\n   758→   758→  return { points, lines };\n   759→   759→}\n   760→   760→\n   761→   761→function getUsedLandmarks(metricId: string): string[] {\n   762→   762→  const landmarkMappings: Record<string, string[]> = {\n   763→   763→    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   764→   764→    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],\n   765→   765→    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n   766→   766→    ipd: ['left_pupila', 'right_pupila'],\n   767→   767→    mouthWidth: ['left_cheilion', 'right_cheilion'],\n   768→   768→    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],\n   769→   769→    chinHeight: ['labrale_inferius', 'menton'],\n   770→   770→    gonialAngle: ['tragus', 'gonionBottom', 'menton'],\n   771→   771→  };\n   772→   772→  return landmarkMappings[metricId] || [];\n   773→   773→}\n   774→   774→\n   775→   775→function getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {\n   776→   776→  const flawMappings: Record<string, { low: string[]; high: string[] }> = {\n   777→   777→    faceWidthToHeight: {\n   778→   778→      low: ['Narrow face', 'Vertically elongated face'],\n   779→   779→      high: ['Wide face', 'Horizontally expanded face'],\n   780→   780→    },\n   781→   781→    lowerThirdProportion: {\n   782→   782→      low: ['Short lower third', 'Deficient mandible'],\n   783→   783→      high: ['Long lower third', 'Mandibular excess'],\n   784→   784→    },\n   785→   785→    lateralCanthalTilt: {\n   786→   786→      low: ['Negative canthal tilt', 'Drooping eyes'],\n   787→   787→      high: ['Excessive positive canthal tilt'],\n   788→   788→    },\n   789→   789→    nasalIndex: {\n   790→   790→      low: ['Narrow nose', 'Leptorrhine nose'],\n   791→   791→      high: ['Wide nose', 'Platyrrhine nose'],\n   792→   792→    },\n   793→   793→    gonialAngle: {\n   794→   794→      low: ['Steep mandibular plane'],\n   795→   795→      high: ['Flat mandibular plane', 'Weak jaw definition'],\n   796→   796→    },\n   797→   797→  };\n   798→   798→\n   799→   799→  const strengthMappings: Record<string, { ideal: string[] }> = {\n   800→   800→    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },\n   801→   801→    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },\n   802→   802→    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },\n   803→   803→    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },\n   804→   804→  };\n   805→   805→\n   806→   806→  const mapping = flawMappings[result.metricId];\n   807→   807→  const strengthMapping = strengthMappings[result.metricId];\n   808→   808→\n   809→   809→  let mayIndicateFlaws: string[] = [];\n   810→   810→  let mayIndicateStrengths: string[] = [];\n   811→   811→\n   812→   812→  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {\n   813→   813→    mayIndicateStrengths = strengthMapping?.ideal || [];\n   814→   814→  } else if (mapping) {\n   815→   815→    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;\n   816→   816→  }\n   817→   817→\n   818→   818→  return { mayIndicateFlaws, mayIndicateStrengths };\n   819→   819→}\n   820→   820→\n   821→   821→// Metric groupings for creating multi-ratio strengths\n   822→   822→const STRENGTH_GROUPINGS: Record<string, {\n   823→   823→  name: string;\n   824→   824→  category: string;\n   825→   825→  description: string;\n   826→   826→  metrics: string[];\n   827→   827→}> = {\n   828→   828→  // Lip Proportions\n   829→   829→  lipProportions: {\n   830→   830→    name: 'Well Proportioned Lips',\n   831→   831→    category: 'Lips',\n   832→   832→    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',\n   833→   833→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n   834→   834→  },\n   835→   835→  // Eye Proportions\n   836→   836→  eyeProportions: {\n   837→   837→    name: 'Harmonious Eye Proportions',\n   838→   838→    category: 'Eyes',\n   839→   839→    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',\n   840→   840→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n   841→   841→  },\n   842→   842→  // Nose Proportions\n   843→   843→  noseProportions: {\n   844→   844→    name: 'Balanced Nasal Proportions',\n   845→   845→    category: 'Nose',\n   846→   846→    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',\n   847→   847→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n   848→   848→  },\n   849→   849→  // Jaw Definition\n   850→   850→  jawDefinition: {\n   851→   851→    name: 'Well-Defined Jawline',\n   852→   852→    category: 'Jaw Shape',\n   853→   853→    description: 'The jawline displays strong definition with balanced angles and proportionate width.',\n   854→   854→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n   855→   855→  },\n   856→   856→  // Chin Proportions\n   857→   857→  chinProportions: {\n   858→   858→    name: 'Balanced Chin Projection',\n   859→   859→    category: 'Chin',\n   860→   860→    description: 'The chin demonstrates ideal projection and proportions relative to the face.',\n   861→   861→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n   862→   862→  },\n   863→   863→  // Facial Thirds\n   864→   864→  facialThirds: {\n   865→   865→    name: 'Balanced Facial Thirds',\n   866→   866→    category: 'Face Proportions',\n   867→   867→    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',\n   868→   868→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n   869→   869→  },\n   870→   870→  // Midface\n   871→   871→  midfaceBalance: {\n   872→   872→    name: 'Harmonious Midface',\n   873→   873→    category: 'Midface/Face Shape',\n   874→   874→    description: 'The midface shows balanced proportions with well-positioned cheekbones.',\n   875→   875→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n   876→   876→  },\n   877→   877→  // Forehead\n   878→   878→  foreheadBalance: {\n   879→   879→    name: 'Well-Proportioned Forehead',\n   880→   880→    category: 'Forehead',\n   881→   881→    description: 'The forehead displays ideal proportions in height and shape.',\n   882→   882→    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],\n   883→   883→  },\n   884→   884→};\n   885→   885→\n   886→   886→function generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {\n   887→   887→  const strengths: Strength[] = [];\n   888→   888→  const usedMetricIds = new Set<string>();\n   889→   889→\n   890→   890→  // First pass: Create grouped strengths from related high-scoring metrics\n   891→   891→  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {\n   892→   892→    // Find all high-scoring measurements that belong to this group\n   893→   893→    const groupMeasurements = analysis.measurements.filter(m =>\n   894→   894→      groupConfig.metrics.includes(m.metricId) &&\n   895→   895→      m.score >= 7.5 &&\n   896→   896→      !usedMetricIds.has(m.metricId)\n   897→   897→    );\n   898→   898→\n   899→   899→    // Only create a grouped strength if we have 2+ metrics with good scores\n   900→   900→    if (groupMeasurements.length >= 2) {\n   901→   901→      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n   902→   902→      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n   903→   903→\n   904→   904→      // Mark these metrics as used\n   905→   905→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n   906→   906→\n   907→   907→      // Create grouped strength with multiple contributing ratios\n   908→   908→      strengths.push({\n   909→   909→        id: `strength_group_${groupId}`,\n   910→   910→        strengthName: groupConfig.name,\n   911→   911→        summary: groupConfig.description,\n   912→   912→        avgScore,\n   913→   913→        qualityLevel: bestQuality,\n   914→   914→        categoryName: groupConfig.category,\n   915→   915→        responsibleRatios: groupMeasurements.map(m => ({\n   916→   916→          ratioName: m.name,\n   917→   917→          ratioId: m.metricId,\n   918→   918→          score: m.score,\n   919→   919→          value: m.value,\n   920→   920→          idealMin: m.idealMin,\n   921→   921→          idealMax: m.idealMax,\n   922→   922→          unit: m.unit,\n   923→   923→          category: m.category,\n   924→   924→        })),\n   925→   925→      });\n   926→   926→    }\n   927→   927→  });\n   928→   928→\n   929→   929→  // Second pass: Add remaining individual strengths that weren't grouped\n   930→   930→  analysis.strengths.forEach((s, i) => {\n   931→   931→    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n   932→   932→\n   933→   933→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n   934→   934→\n   935→   935→    strengths.push({\n   936→   936→      id: `strength_${i}`,\n   937→   937→      strengthName: s.metricName,\n   938→   938→      summary: s.reasoning,\n   939→   939→      avgScore: matchingMeasurement?.score || 8,\n   940→   940→      qualityLevel: s.qualityTier,\n   941→   941→      categoryName: s.category,\n   942→   942→      responsibleRatios: [{\n   943→   943→        ratioName: s.metricName,\n   944→   944→        ratioId: s.metricId,\n   945→   945→        score: matchingMeasurement?.score || 8,\n   946→   946→        value: s.value,\n   947→   947→        idealMin: matchingMeasurement?.idealMin || 0,\n   948→   948→        idealMax: matchingMeasurement?.idealMax || 1,\n   949→   949→        unit: matchingMeasurement?.unit || 'ratio',\n   950→   950→        category: s.category,\n   951→   951→      }],\n   952→   952→    });\n   953→   953→  });\n   954→   954→\n   955→   955→  // Sort by average score (highest first) then by number of contributing ratios\n   956→   956→  return strengths.sort((a, b) => {\n   957→   957→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n   958→   958→      return b.responsibleRatios.length - a.responsibleRatios.length;\n   959→   959→    }\n   960→   960→    return b.avgScore - a.avgScore;\n   961→   961→  });\n   962→   962→}\n   963→   963→\n   964→   964→// Flaw groupings - similar to strength groupings but for areas of improvement\n   965→   965→const FLAW_GROUPINGS: Record<string, {\n   966→   966→  name: string;\n   967→   967→  category: string;\n   968→   968→  description: string;\n   969→   969→  metrics: string[];\n   970→   970→}> = {\n   971→   971→  // Lip Issues\n   972→   972→  lipIssues: {\n   973→   973→    name: 'Lip Proportion Concerns',\n   974→   974→    category: 'Lips',\n   975→   975→    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',\n   976→   976→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n   977→   977→  },\n   978→   978→  // Eye Issues\n   979→   979→  eyeIssues: {\n   980→   980→    name: 'Eye Shape Considerations',\n   981→   981→    category: 'Eyes',\n   982→   982→    description: 'The eye proportions or positioning could benefit from enhancement.',\n   983→   983→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n   984→   984→  },\n   985→   985→  // Nose Issues\n   986→   986→  noseIssues: {\n   987→   987→    name: 'Nasal Proportion Concerns',\n   988→   988→    category: 'Nose',\n   989→   989→    description: 'The nasal proportions show deviations that affect facial harmony.',\n   990→   990→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n   991→   991→  },\n   992→   992→  // Jaw Issues\n   993→   993→  jawIssues: {\n   994→   994→    name: 'Jawline Definition Concerns',\n   995→   995→    category: 'Jaw Shape',\n   996→   996→    description: 'The jawline structure shows areas that could be enhanced for better definition.',\n   997→   997→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n   998→   998→  },\n   999→   999→  // Chin Issues\n  1000→  1000→  chinIssues: {\n  1001→  1001→    name: 'Chin Projection Concerns',\n  1002→  1002→    category: 'Chin',\n  1003→  1003→    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',\n  1004→  1004→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  1005→  1005→  },\n  1006→  1006→  // Face Proportion Issues\n  1007→  1007→  proportionIssues: {\n  1008→  1008→    name: 'Facial Proportion Imbalance',\n  1009→  1009→    category: 'Face Proportions',\n  1010→  1010→    description: 'The vertical face proportions show imbalance between facial thirds.',\n  1011→  1011→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  1012→  1012→  },\n  1013→  1013→  // Midface Issues\n  1014→  1014→  midfaceIssues: {\n  1015→  1015→    name: 'Midface Development Concerns',\n  1016→  1016→    category: 'Midface/Face Shape',\n  1017→  1017→    description: 'The midface shows areas that could benefit from enhanced projection or balance.',\n  1018→  1018→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  1019→  1019→  },\n  1020→  1020→};\n  1021→  1021→\n  1022→  1022→function generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  1023→  1023→  const flaws: Flaw[] = [];\n  1024→  1024→  const usedMetricIds = new Set<string>();\n  1025→  1025→  let rollingLost = 0;\n  1026→  1026→\n  1027→  1027→  // First pass: Create grouped flaws from related low-scoring metrics\n  1028→  1028→  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n  1029→  1029→    // Find all low-scoring measurements that belong to this group\n  1030→  1030→    const groupMeasurements = analysis.measurements.filter(m =>\n  1031→  1031→      groupConfig.metrics.includes(m.metricId) &&\n  1032→  1032→      m.score < 6 &&\n  1033→  1033→      !usedMetricIds.has(m.metricId)\n  1034→  1034→    );\n  1035→  1035→\n  1036→  1036→    // Only create a grouped flaw if we have 2+ metrics with low scores\n  1037→  1037→    if (groupMeasurements.length >= 2) {\n  1038→  1038→      // Mark these metrics as used\n  1039→  1039→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n  1040→  1040→\n  1041→  1041→      // Calculate total impact from all metrics in this group\n  1042→  1042→      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n  1043→  1043→      rollingLost += totalImpact;\n  1044→  1044→\n  1045→  1045→      // Create grouped flaw with multiple contributing ratios\n  1046→  1046→      flaws.push({\n  1047→  1047→        id: `flaw_group_${groupId}`,\n  1048→  1048→        flawName: groupConfig.name,\n  1049→  1049→        summary: groupConfig.description,\n  1050→  1050→        harmonyPercentageLost: totalImpact,\n  1051→  1051→        standardizedImpact: totalImpact / 10,\n  1052→  1052→        categoryName: groupConfig.category,\n  1053→  1053→        responsibleRatios: groupMeasurements.map(m => ({\n  1054→  1054→          ratioName: m.name,\n  1055→  1055→          ratioId: m.metricId,\n  1056→  1056→          score: m.score,\n  1057→  1057→          value: m.value,\n  1058→  1058→          idealMin: m.idealMin,\n  1059→  1059→          idealMax: m.idealMax,\n  1060→  1060→          unit: m.unit,\n  1061→  1061→          category: m.category,\n  1062→  1062→        })),\n  1063→  1063→        rollingPointsDeducted: rollingLost,\n  1064→  1064→        rollingHarmonyPercentageLost: rollingLost,\n  1065→  1065→        rollingStandardizedImpact: rollingLost / 10,\n  1066→  1066→      });\n  1067→  1067→    }\n  1068→  1068→  });\n  1069→  1069→\n  1070→  1070→  // Second pass: Add remaining individual flaws that weren't grouped\n  1071→  1071→  analysis.flaws.forEach((f, i) => {\n  1072→  1072→    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n  1073→  1073→\n  1074→  1074→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n  1075→  1075→    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n  1076→  1076→    rollingLost += impact;\n  1077→  1077→\n  1078→  1078→    flaws.push({\n  1079→  1079→      id: `flaw_${i}`,\n  1080→  1080→      flawName: f.metricName,\n  1081→  1081→      summary: f.reasoning,\n  1082→  1082→      harmonyPercentageLost: impact,\n  1083→  1083→      standardizedImpact: impact / 10,\n  1084→  1084→      categoryName: f.category,\n  1085→  1085→      responsibleRatios: [{\n  1086→  1086→        ratioName: f.metricName,\n  1087→  1087→        ratioId: f.metricId,\n  1088→  1088→        score: matchingMeasurement?.score || 3,\n  1089→  1089→        value: matchingMeasurement?.value || 0,\n  1090→  1090→        idealMin: matchingMeasurement?.idealMin || 0,\n  1091→  1091→        idealMax: matchingMeasurement?.idealMax || 1,\n  1092→  1092→        unit: matchingMeasurement?.unit || 'ratio',\n  1093→  1093→        category: f.category,\n  1094→  1094→      }],\n  1095→  1095→      rollingPointsDeducted: rollingLost,\n  1096→  1096→      rollingHarmonyPercentageLost: rollingLost,\n  1097→  1097→      rollingStandardizedImpact: rollingLost / 10,\n  1098→  1098→    });\n  1099→  1099→  });\n  1100→  1100→\n  1101→  1101→  // Sort by impact (highest first) then by number of contributing ratios\n  1102→  1102→  return flaws.sort((a, b) => {\n  1103→  1103→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n  1104→  1104→      return b.responsibleRatios.length - a.responsibleRatios.length;\n  1105→  1105→    }\n  1106→  1106→    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  1107→  1107→  });\n  1108→  1108→}\n  1109→  1109→\n  1110→  1110→// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions\n  1111→  1111→// have been moved to @/lib/results/analysis.ts to reduce bundle size\n  1112→  1112→// Import generateRecommendations from there instead\n  1113→  1113→// ============================================\n  1114→  1114→// CONTEXT CREATION\n  1115→  1115→// ============================================\n  1116→  1116→\n  1117→  1117→const ResultsContext = createContext<ResultsContextType | null>(null);\n  1118→  1118→\n  1119→  1119→export function useResults(): ResultsContextType {\n  1120→  1120→  const context = useContext(ResultsContext);\n  1121→  1121→  if (!context) {\n  1122→  1122→    throw new Error('useResults must be used within a ResultsProvider');\n  1123→  1123→  }\n  1124→  1124→  return context;\n  1125→  1125→}\n  1126→  1126→\n  1127→  1127→interface ResultsProviderProps {\n  1128→  1128→  children: ReactNode;\n  1129→  1129→  initialData?: ResultsInputData;\n  1130→  1130→}\n  1131→  1131→\n  1132→  1132→export function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  1133→  1133→  // Raw data state\n  1134→  1134→  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  1135→  1135→  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  1136→  1136→  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  1137→  1137→  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  1138→  1138→  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  1139→  1139→  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n  1140→  1140→\n  1141→  1141→  // UI state\n  1142→  1142→  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  1143→  1143→  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  1144→  1144→  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  1145→  1145→  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  1146→  1146→  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n  1147→  1147→\n  1148→  1148→  // Compute analysis results (now with demographic-specific scoring)\n  1149→  1149→  const analysisResults = useMemo(() => {\n  1150→  1150→    if (frontLandmarks.length === 0) {\n  1151→  1151→      return null;\n  1152→  1152→    }\n  1153→  1153→\n  1154→  1154→    try {\n  1155→  1155→      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n  1156→  1156→      const sideAnalysis = sideLandmarks.length > 0\n  1157→  1157→        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n  1158→  1158→        : null;\n  1159→  1159→      // analyzeHarmony expects landmarks directly, not analysis results\n  1160→  1160→      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n  1161→  1161→\n  1162→  1162→      return { frontAnalysis, sideAnalysis, harmony };\n  1163→  1163→    } catch (error) {\n  1164→  1164→      console.error('Analysis error:', error);\n  1165→  1165→      return null;\n  1166→  1166→    }\n  1167→  1167→  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n  1168→  1168→\n  1169→  1169→  // Transform to Ratio format\n  1170→  1170→  const frontRatios = useMemo(() => {\n  1171→  1171→    if (!analysisResults?.frontAnalysis) return [];\n  1172→  1172→    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  1173→  1173→  }, [analysisResults, frontLandmarks]);\n  1174→  1174→\n  1175→  1175→  const sideRatios = useMemo(() => {\n  1176→  1176→    if (!analysisResults?.sideAnalysis) return [];\n  1177→  1177→    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  1178→  1178→  }, [analysisResults, sideLandmarks]);\n  1179→  1179→\n  1180→  1180→  // Generate strengths and flaws using INSIGHTS-BASED classification\n  1181→  1181→  // This processes insights.json definitions: calculates avg score of affected metrics,\n  1182→  1182→  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  1183→  1183→  const { insightStrengths, insightFlaws } = useMemo(() => {\n  1184→  1184→    if (!analysisResults?.harmony) {\n  1185→  1185→      return { insightStrengths: [], insightFlaws: [] };\n  1186→  1186→    }\n  1187→  1187→\n  1188→  1188→    try {\n  1189→  1189→      // Classify using insights engine\n  1190→  1190→      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n  1191→  1191→        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n  1192→  1192→\n  1193→  1193→      // Convert to UI-compatible types\n  1194→  1194→      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n  1195→  1195→\n  1196→  1196→      let rollingLost = 0;\n  1197→  1197→      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n  1198→  1198→        const flaw = convertToFlaw(w, i, rollingLost);\n  1199→  1199→        rollingLost = flaw.rollingPointsDeducted || 0;\n  1200→  1200→        return flaw;\n  1201→  1201→      });\n  1202→  1202→\n  1203→  1203→      return { insightStrengths, insightFlaws };\n  1204→  1204→    } catch (error) {\n  1205→  1205→      console.error('[ResultsContext] Error in insights classification:', error);\n  1206→  1206→      return { insightStrengths: [], insightFlaws: [] };\n  1207→  1207→    }\n  1208→  1208→  }, [analysisResults]);\n  1209→  1209→\n  1210→  1210→  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  1211→  1211→  const groupingStrengths = useMemo(() => {\n  1212→  1212→    if (!analysisResults?.harmony) return [];\n  1213→  1213→    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  1214→  1214→  }, [analysisResults]);\n  1215→  1215→\n  1216→  1216→  const groupingFlaws = useMemo(() => {\n  1217→  1217→    if (!analysisResults?.harmony) return [];\n  1218→  1218→    return generateFlawsFromAnalysis(analysisResults.harmony);\n  1219→  1219→  }, [analysisResults]);\n  1220→  1220→\n  1221→  1221→  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)\n  1222→  1222→  const strengths = useMemo(() => {\n  1223→  1223→    // Use insights as primary source\n  1224→  1224→    const usedMetricIds = new Set<string>();\n  1225→  1225→    insightStrengths.forEach(s => {\n  1226→  1226→      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n  1227→  1227→    });\n  1228→  1228→\n  1229→  1229→    // Add grouping-based strengths that don't overlap\n  1230→  1230→    const nonOverlappingGrouping = groupingStrengths.filter(gs => {\n  1231→  1231→      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n  1232→  1232→      return !overlap;\n  1233→  1233→    });\n  1234→  1234→\n  1235→  1235→    return [...insightStrengths, ...nonOverlappingGrouping];\n  1236→  1236→  }, [insightStrengths, groupingStrengths]);\n  1237→  1237→\n  1238→  1238→  const flaws = useMemo(() => {\n  1239→  1239→    // Use insights as primary source\n  1240→  1240→    const usedMetricIds = new Set<string>();\n  1241→  1241→    insightFlaws.forEach(f => {\n  1242→  1242→      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n  1243→  1243→    });\n  1244→  1244→\n  1245→  1245→    // Add grouping-based flaws that don't overlap\n  1246→  1246→    const nonOverlappingGrouping = groupingFlaws.filter(gf => {\n  1247→  1247→      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n  1248→  1248→      return !overlap;\n  1249→  1249→    });\n  1250→  1250→\n  1251→  1251→    // Recalculate rolling totals for merged list\n  1252→  1252→    let rollingLost = 0;\n  1253→  1253→    const merged = [...insightFlaws, ...nonOverlappingGrouping];\n  1254→  1254→    return merged.map(f => {\n  1255→  1255→      rollingLost += f.harmonyPercentageLost;\n  1256→  1256→      return {\n  1257→  1257→        ...f,\n  1258→  1258→        rollingPointsDeducted: rollingLost,\n  1259→  1259→        rollingHarmonyPercentageLost: rollingLost,\n  1260→  1260→        rollingStandardizedImpact: rollingLost / 10,\n  1261→  1261→      };\n  1262→  1262→    });\n  1263→  1263→  }, [insightFlaws, groupingFlaws]);\n  1264→  1264→\n  1265→  1265→  // Generate recommendations with metric-aware matching and Bezier recalculation\n  1266→  1266→  const recommendations = useMemo(() => {\n  1267→  1267→    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);\n  1268→  1268→  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);\n  1269→  1269→\n  1270→  1270→  // Build full harmony analysis\n  1271→  1271→  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {\n  1272→  1272→    if (!analysisResults?.harmony) return null;\n  1273→  1273→\n  1274→  1274→    return {\n  1275→  1275→      standardizedScore: analysisResults.harmony.overallScore,\n  1276→  1276→      front: {\n  1277→  1277→        standardizedScore: analysisResults.harmony.frontScore,\n  1278→  1278→        ratios: frontRatios,\n  1279→  1279→      },\n  1280→  1280→      side: {\n  1281→  1281→        standardizedScore: analysisResults.harmony.sideScore,\n  1282→  1282→        ratios: sideRatios,\n  1283→  1283→      },\n  1284→  1284→      strengths,\n  1285→  1285→      flaws,\n  1286→  1286→    };\n  1287→  1287→  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);\n  1288→  1288→\n  1289→  1289→  // Calculate weighted harmony score using looksmax_engine.py algorithm\n  1290→  1290→  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {\n  1291→  1291→    if (!analysisResults?.harmony) return null;\n  1292→  1292→\n  1293→  1293→    const allMeasurements = analysisResults.harmony.measurements.map(m => ({\n  1294→  1294→      metricId: m.metricId,\n  1295→  1295→      standardizedScore: m.standardizedScore,\n  1296→  1296→    }));\n  1297→  1297→\n  1298→  1298→    return calculateHarmonyScore(allMeasurements);\n  1299→  1299→  }, [analysisResults]);\n  1300→  1300→\n  1301→  1301→  // Get top 3 and bottom 3 metrics with advice\n  1302→  1302→  const topMetrics = useMemo((): RankedMetric[] => {\n  1303→  1303→    if (!analysisResults?.harmony) return [];\n  1304→  1304→    return getTopMetrics(analysisResults.harmony.measurements, 3);\n  1305→  1305→  }, [analysisResults]);\n  1306→  1306→\n  1307→  1307→  const bottomMetrics = useMemo((): RankedMetric[] => {\n  1308→  1308→    if (!analysisResults?.harmony) return [];\n  1309→  1309→    return getBottomMetrics(analysisResults.harmony.measurements, 3);\n  1310→  1310→  }, [analysisResults]);\n  1311→  1311→\n  1312→  1312→  // Scores - now using weighted harmony with explicit clamping to 0-10\n  1313→  1313→  const rawHarmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;\n  1314→  1314→  const harmonyPercentage = Math.max(0, Math.min(100, rawHarmonyPercentage));\n  1315→  1315→\n  1316→  1316→  const rawOverallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;\n  1317→  1317→  const overallScore = Math.max(0, Math.min(10, rawOverallScore));\n  1318→  1318→\n  1319→  1319→  const rawFrontScore = analysisResults?.harmony?.frontScore || 0;\n  1320→  1320→  const frontScore = Math.max(0, Math.min(10, rawFrontScore));\n  1321→  1321→\n  1322→  1322→  const rawSideScore = analysisResults?.harmony?.sideScore || 0;\n  1323→  1323→  const sideScore = Math.max(0, Math.min(10, rawSideScore));\n  1324→  1324→\n  1325→  1325→  // PSL Rating (1-10 scale with tier/percentile)\n  1326→  1326→  const pslRating = useMemo(() => {\n  1327→  1327→    return harmonyToPSL(harmonyPercentage);\n  1328→  1328→  }, [harmonyPercentage]);\n  1329→  1329→\n  1330→  1330→  // Action to set all results data\n  1331→  1331→  const setResultsData = useCallback((data: ResultsInputData) => {\n  1332→  1332→    setFrontLandmarks(data.frontLandmarks);\n  1333→  1333→    setSideLandmarks(data.sideLandmarks);\n  1334→  1334→    setFrontPhoto(data.frontPhoto);\n  1335→  1335→    setSidePhoto(data.sidePhoto || null);\n  1336→  1336→    setGender(data.gender);\n  1337→  1337→    setEthnicity(data.ethnicity || 'other');\n  1338→  1338→  }, []);\n  1339→  1339→\n  1340→  1340→  // Memoize context value to prevent unnecessary re-renders\n  1341→  1341→  const value = useMemo<ResultsContextType>(() => ({\n  1342→  1342→    frontLandmarks,\n  1343→  1343→    sideLandmarks,\n  1344→  1344→    gender,\n  1345→  1345→    ethnicity,\n  1346→  1346→    frontPhoto,\n  1347→  1347→    sidePhoto,\n  1348→  1348→    harmonyAnalysis,\n  1349→  1349→    frontRatios,\n  1350→  1350→    sideRatios,\n  1351→  1351→    strengths,\n  1352→  1352→    flaws,\n  1353→  1353→    recommendations,\n  1354→  1354→    overallScore,\n  1355→  1355→    frontScore,\n  1356→  1356→    sideScore,\n  1357→  1357→    // Weighted harmony from looksmax_engine.py\n  1358→  1358→    harmonyScoreResult,\n  1359→  1359→    harmonyPercentage,\n  1360→  1360→    topMetrics,\n  1361→  1361→    bottomMetrics,\n  1362→  1362→    // PSL Rating\n  1363→  1363→    pslRating,\n  1364→  1364→    // UI state\n  1365→  1365→    activeTab,\n  1366→  1366→    setActiveTab,\n  1367→  1367→    expandedMeasurementId,\n  1368→  1368→    setExpandedMeasurementId,\n  1369→  1369→    selectedVisualizationMetric,\n  1370→  1370→    setSelectedVisualizationMetric,\n  1371→  1371→    categoryFilter,\n  1372→  1372→    setCategoryFilter,\n  1373→  1373→    showLandmarkOverlay,\n  1374→  1374→    setShowLandmarkOverlay,\n  1375→  1375→    setResultsData,\n  1376→  1376→  }), [\n  1377→  1377→    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,\n  1378→  1378→    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,\n  1379→  1379→    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,\n  1380→  1380→    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,\n  1381→  1381→    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,\n  1382→  1382→    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,\n  1383→  1383→    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,\n  1384→  1384→  ]);\n  1385→  1385→\n  1386→  1386→  return (\n  1387→  1387→    <ResultsContext.Provider value={value}>\n  1388→  1388→      {children}\n  1389→  1389→    </ResultsContext.Provider>\n  1390→  1390→  );\n  1391→  1391→}\n  1392→  1392→\n  1393→\n  1394→<system-reminder>\n  1395→Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n  1396→</system-reminder>\n  1397→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7393c5db-0313-428a-bb57-18597cc05277","timestamp":"2025-12-26T06:50:25.049Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/.claude/projects/-Users-imorgado-LOOKSMAXX-looksmaxx-app/4e0d04e8-56ad-4bca-9e4b-36b62804ea66/tool-results/toolu_01WBz76ih2UfrMqqTeJB37VZ.txt","content":"     1→'use client';\n     2→\n     3→import React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\n     4→import { LandmarkPoint } from '@/lib/landmarks';\n     5→import {\n     6→  analyzeFrontProfile,\n     7→  analyzeSideProfile,\n     8→  analyzeHarmony,\n     9→  HarmonyAnalysis,\n    10→  MetricScoreResult,\n    11→  METRIC_CONFIGS,\n    12→  Ethnicity,\n    13→  Gender,\n    14→} from '@/lib/harmony-scoring';\n    15→import {\n    16→  calculateHarmonyScore,\n    17→  getTopMetrics,\n    18→  getBottomMetrics,\n    19→  HarmonyScoreResult,\n    20→  RankedMetric,\n    21→} from '@/lib/looksmax-scoring';\n    22→import { harmonyToPSL } from '@/lib/recommendations/severity';\n    23→import {\n    24→  classifyInsights,\n    25→  convertToStrength,\n    26→  convertToFlaw,\n    27→  INSIGHTS_DEFINITIONS,\n    28→} from '@/lib/insights-engine';\n    29→import { classifyMetric } from '@/lib/taxonomy';\n    30→import {\n    31→  Ratio,\n    32→  Strength,\n    33→  Flaw,\n    34→  Recommendation,\n    35→  ResultsTab,\n    36→  FullHarmonyAnalysis,\n    37→} from '@/types/results';\n    38→import { generateRecommendations } from '@/lib/results/analysis';\n    39→\n    40→// ============================================\n    41→// CONTEXT TYPES\n    42→// ============================================\n    43→\n    44→interface ResultsContextType {\n    45→  // Raw data\n    46→  frontLandmarks: LandmarkPoint[];\n    47→  sideLandmarks: LandmarkPoint[];\n    48→  gender: Gender;\n    49→  ethnicity: Ethnicity;\n    50→  frontPhoto: string;\n    51→  sidePhoto: string | null;\n    52→\n    53→  // Computed results\n    54→  harmonyAnalysis: FullHarmonyAnalysis | null;\n    55→  frontRatios: Ratio[];\n    56→  sideRatios: Ratio[];\n    57→  strengths: Strength[];\n    58→  flaws: Flaw[];\n    59→  recommendations: Recommendation[];\n    60→\n    61→  // Scores (now using weighted harmony from looksmax_engine.py)\n    62→  overallScore: number;\n    63→  frontScore: number;\n    64→  sideScore: number;\n    65→\n    66→  // Weighted Harmony Score (from looksmax_engine.py)\n    67→  harmonyScoreResult: HarmonyScoreResult | null;\n    68→  harmonyPercentage: number;  // 0-100% weighted harmony\n    69→\n    70→  // Top 3 strengths and bottom 3 areas to improve with advice\n    71→  topMetrics: RankedMetric[];\n    72→  bottomMetrics: RankedMetric[];\n    73→\n    74→  // PSL Rating (1-10 scale)\n    75→  pslRating: {\n    76→    psl: number;\n    77→    tier: string;\n    78→    percentile: number;\n    79→    description: string;\n    80→  };\n    81→\n    82→  // UI state\n    83→  activeTab: ResultsTab;\n    84→  setActiveTab: (tab: ResultsTab) => void;\n    85→  expandedMeasurementId: string | null;\n    86→  setExpandedMeasurementId: (id: string | null) => void;\n    87→  selectedVisualizationMetric: string | null;\n    88→  setSelectedVisualizationMetric: (id: string | null) => void;\n    89→  categoryFilter: string | null;\n    90→  setCategoryFilter: (category: string | null) => void;\n    91→  showLandmarkOverlay: boolean;\n    92→  setShowLandmarkOverlay: (show: boolean) => void;\n    93→\n    94→  // Actions\n    95→  setResultsData: (data: ResultsInputData) => void;\n    96→}\n    97→\n    98→interface ResultsInputData {\n    99→  frontLandmarks: LandmarkPoint[];\n   100→  sideLandmarks: LandmarkPoint[];\n   101→  frontPhoto: string;\n   102→  sidePhoto?: string;\n   103→  gender: Gender;\n   104→  ethnicity?: Ethnicity;\n   105→}\n   106→\n   107→// ============================================\n   108→// HELPER FUNCTIONS\n   109→// ============================================\n   110→\n   111→function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n   112→  switch (unit) {\n   113→    case 'ratio': return 'x';\n   114→    case 'percent': return '%';\n   115→    case 'degrees': return '°';\n   116→    case 'mm': return 'mm';\n   117→    default: return 'x';\n   118→  }\n   119→}\n   120→\n   121→function transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {\n   122→  const metricConfig = METRIC_CONFIGS[result.metricId];\n   123→\n   124→  // Generate illustration based on metric\n   125→  const illustration = generateIllustration(result.metricId, landmarks);\n   126→\n   127→  // Get flaw/strength mappings\n   128→  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n   129→\n   130→  // Classify metric using Harmony taxonomy\n   131→  const taxonomyClassification = classifyMetric(result.name, result.category);\n   132→\n   133→  // Clamp scores to valid 0-10 range for display (defense-in-depth)\n   134→  const clampedScore = Math.max(0, Math.min(10, result.standardizedScore));\n   135→\n   136→  return {\n   137→    id: result.metricId,\n   138→    name: result.name,\n   139→    value: result.value,\n   140→    score: clampedScore,  // Use standardized 0-10 score for UI display\n   141→    standardizedScore: clampedScore,\n   142→    unit: convertUnitToRatioUnit(result.unit),\n   143→    idealMin: result.idealMin,\n   144→    idealMax: result.idealMax,\n   145→    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n   146→    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n   147→    description: metricConfig?.description || '',\n   148→    category: result.category,\n   149→    qualityLevel: result.qualityTier,\n   150→    severity: result.severity,\n   151→    illustration,\n   152→    mayIndicateFlaws,\n   153→    mayIndicateStrengths,\n   154→    usedLandmarks: getUsedLandmarks(result.metricId),\n   155→    scoringCurveConfig: metricConfig ? {\n   156→      decayRate: metricConfig.decayRate,\n   157→      maxScore: metricConfig.maxScore,\n   158→    } : undefined,\n   159→    taxonomyPrimary: taxonomyClassification?.primary,\n   160→    taxonomySecondary: taxonomyClassification?.secondary,\n   161→  };\n   162→}\n   163→\n   164→// Enhanced illustration configuration type\n   165→interface IllustrationConfig {\n   166→  points: string[];\n   167→  lines: Array<{\n   168→    from: string;\n   169→    to: string;\n   170→    label?: string;\n   171→    color?: string;\n   172→    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n   173→  }>;\n   174→}\n   175→\n   176→// Comprehensive illustration configurations for all metrics\n   177→const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n   178→  // ==========================================\n   179→  // FACE SHAPE / PROPORTIONS\n   180→  // ==========================================\n   181→  faceWidthToHeight: {\n   182→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   183→    lines: [\n   184→      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n   185→      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n   186→    ],\n   187→  },\n   188→  totalFacialWidthToHeight: {\n   189→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   190→    lines: [\n   191→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   192→      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n   193→    ],\n   194→  },\n   195→  lowerThirdProportion: {\n   196→    points: ['subnasale', 'menton', 'trichion'],\n   197→    lines: [\n   198→      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n   199→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   200→    ],\n   201→  },\n   202→  middleThirdProportion: {\n   203→    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n   204→    lines: [\n   205→      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n   206→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   207→    ],\n   208→  },\n   209→  upperThirdProportion: {\n   210→    points: ['trichion', 'nasal_base', 'menton'],\n   211→    lines: [\n   212→      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n   213→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   214→    ],\n   215→  },\n   216→  bitemporalWidth: {\n   217→    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n   218→    lines: [\n   219→      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n   220→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n   221→    ],\n   222→  },\n   223→  cheekboneHeight: {\n   224→    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n   225→    lines: [\n   226→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n   227→      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n   228→    ],\n   229→  },\n   230→  midfaceRatio: {\n   231→    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n   232→    lines: [\n   233→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n   234→      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n   235→    ],\n   236→  },\n   237→\n   238→  // ==========================================\n   239→  // JAW MEASUREMENTS\n   240→  // ==========================================\n   241→  jawSlope: {\n   242→    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n   243→    lines: [\n   244→      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n   245→      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n   246→    ],\n   247→  },\n   248→  jawFrontalAngle: {\n   249→    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n   250→    lines: [\n   251→      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n   252→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n   253→    ],\n   254→  },\n   255→  bigonialWidth: {\n   256→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   257→    lines: [\n   258→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n   259→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   260→    ],\n   261→  },\n   262→  jawWidthRatio: {\n   263→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   264→    lines: [\n   265→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   266→      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n   267→    ],\n   268→  },\n   269→\n   270→  // ==========================================\n   271→  // EYE MEASUREMENTS\n   272→  // ==========================================\n   273→  lateralCanthalTilt: {\n   274→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n   275→    lines: [\n   276→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n   277→      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n   278→    ],\n   279→  },\n   280→  eyeAspectRatio: {\n   281→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n   282→    lines: [\n   283→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n   284→      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n   285→    ],\n   286→  },\n   287→  eyeSeparationRatio: {\n   288→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n   289→    lines: [\n   290→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   291→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   292→    ],\n   293→  },\n   294→  interpupillaryRatio: {\n   295→    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n   296→    lines: [\n   297→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   298→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   299→    ],\n   300→  },\n   301→  interpupillaryMouthWidthRatio: {\n   302→    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n   303→    lines: [\n   304→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   305→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   306→    ],\n   307→  },\n   308→  oneEyeApartTest: {\n   309→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n   310→    lines: [\n   311→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n   312→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n   313→    ],\n   314→  },\n   315→\n   316→  // ==========================================\n   317→  // EYEBROW MEASUREMENTS\n   318→  // ==========================================\n   319→  browLengthRatio: {\n   320→    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n   321→    lines: [\n   322→      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n   323→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   324→    ],\n   325→  },\n   326→  eyebrowTilt: {\n   327→    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n   328→    lines: [\n   329→      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n   330→      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n   331→    ],\n   332→  },\n   333→  eyebrowLowSetedness: {\n   334→    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n   335→    lines: [\n   336→      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n   337→    ],\n   338→  },\n   339→\n   340→  // ==========================================\n   341→  // NOSE MEASUREMENTS (FRONT)\n   342→  // ==========================================\n   343→  nasalIndex: {\n   344→    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n   345→    lines: [\n   346→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n   347→      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n   348→    ],\n   349→  },\n   350→  intercanthalNasalRatio: {\n   351→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n   352→    lines: [\n   353→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n   354→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   355→    ],\n   356→  },\n   357→  noseBridgeWidth: {\n   358→    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n   359→    lines: [\n   360→      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n   361→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n   362→    ],\n   363→  },\n   364→  noseTipPosition: {\n   365→    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n   366→    lines: [\n   367→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n   368→    ],\n   369→  },\n   370→\n   371→  // ==========================================\n   372→  // MOUTH/LIP MEASUREMENTS\n   373→  // ==========================================\n   374→  mouthNoseWidthRatio: {\n   375→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n   376→    lines: [\n   377→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   378→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n   379→    ],\n   380→  },\n   381→  lowerUpperLipRatio: {\n   382→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n   383→    lines: [\n   384→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n   385→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n   386→    ],\n   387→  },\n   388→  chinPhiltrumRatio: {\n   389→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n   390→    lines: [\n   391→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n   392→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n   393→    ],\n   394→  },\n   395→  mouthWidth: {\n   396→    points: ['left_cheilion', 'right_cheilion'],\n   397→    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n   398→  },\n   399→\n   400→  // ==========================================\n   401→  // CHIN MEASUREMENTS\n   402→  // ==========================================\n   403→  chinHeight: {\n   404→    points: ['labrale_inferius', 'menton'],\n   405→    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n   406→  },\n   407→\n   408→  // ==========================================\n   409→  // NECK MEASUREMENTS\n   410→  // ==========================================\n   411→  neckWidthRatio: {\n   412→    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n   413→    lines: [\n   414→      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n   415→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   416→    ],\n   417→  },\n   418→\n   419→  // ==========================================\n   420→  // SIDE PROFILE MEASUREMENTS\n   421→  // ==========================================\n   422→  gonialAngle: {\n   423→    points: ['tragus', 'gonionBottom', 'menton'],\n   424→    lines: [\n   425→      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   426→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   427→    ],\n   428→  },\n   429→  nasofrontalAngle: {\n   430→    points: ['glabella', 'nasion', 'pronasale'],\n   431→    lines: [\n   432→      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n   433→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   434→    ],\n   435→  },\n   436→  nasofacialAngle: {\n   437→    points: ['nasion', 'pronasale', 'pogonion'],\n   438→    lines: [\n   439→      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n   440→      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n   441→    ],\n   442→  },\n   443→  nasomentaAngle: {\n   444→    points: ['nasion', 'pronasale', 'pogonion'],\n   445→    lines: [\n   446→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   447→      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n   448→    ],\n   449→  },\n   450→  submentalCervicalAngle: {\n   451→    points: ['menton', 'cervicalPoint', 'neckPoint'],\n   452→    lines: [\n   453→      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n   454→      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n   455→    ],\n   456→  },\n   457→  facialDepthToHeight: {\n   458→    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n   459→    lines: [\n   460→      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n   461→      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n   462→    ],\n   463→  },\n   464→  anteriorFacialDepth: {\n   465→    points: ['glabella', 'pronasale', 'pogonion'],\n   466→    lines: [\n   467→      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n   468→      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n   469→    ],\n   470→  },\n   471→  mandibularPlaneAngle: {\n   472→    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n   473→    lines: [\n   474→      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n   475→      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n   476→    ],\n   477→  },\n   478→  ramusToMandibleRatio: {\n   479→    points: ['gonionTop', 'gonionBottom', 'menton'],\n   480→    lines: [\n   481→      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   482→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   483→    ],\n   484→  },\n   485→  orbitalVector: {\n   486→    points: ['cornealApex', 'orbitale', 'cheekbone'],\n   487→    lines: [\n   488→      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n   489→    ],\n   490→  },\n   491→  eLineLowerLip: {\n   492→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   493→    lines: [\n   494→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n   495→    ],\n   496→  },\n   497→  sLineLowerLip: {\n   498→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   499→    lines: [\n   500→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n   501→    ],\n   502→  },\n   503→  holdawayHLine: {\n   504→    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n   505→    lines: [\n   506→      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n   507→    ],\n   508→  },\n   509→  burstoneLowerLip: {\n   510→    points: ['subnasale', 'pogonion', 'labraleInferius'],\n   511→    lines: [\n   512→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n   513→    ],\n   514→  },\n   515→\n   516→  // ==========================================\n   517→  // ADDITIONAL FRONT PROFILE METRICS\n   518→  // ==========================================\n   519→  cupidsBowDepth: {\n   520→    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],\n   521→    lines: [\n   522→      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },\n   523→      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },\n   524→    ],\n   525→  },\n   526→  mouthCornerPosition: {\n   527→    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],\n   528→    lines: [\n   529→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },\n   530→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },\n   531→    ],\n   532→  },\n   533→  iaaJfaDeviation: {\n   534→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n   535→    lines: [\n   536→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },\n   537→      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },\n   538→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n   539→    ],\n   540→  },\n   541→  ipsilateralAlarAngle: {\n   542→    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],\n   543→    lines: [\n   544→      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },\n   545→      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },\n   546→    ],\n   547→  },\n   548→  earProtrusionAngle: {\n   549→    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],\n   550→    lines: [\n   551→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },\n   552→    ],\n   553→  },\n   554→  earProtrusionRatio: {\n   555→    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],\n   556→    lines: [\n   557→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },\n   558→      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },\n   559→    ],\n   560→  },\n   561→  mouthWidthToNoseRatio: {\n   562→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n   563→    lines: [\n   564→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   565→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n   566→    ],\n   567→  },\n   568→  lowerToUpperLipRatio: {\n   569→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n   570→    lines: [\n   571→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n   572→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n   573→    ],\n   574→  },\n   575→  chinToPhiltrumRatio: {\n   576→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n   577→    lines: [\n   578→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n   579→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n   580→    ],\n   581→  },\n   582→\n   583→  // ==========================================\n   584→  // ADDITIONAL SIDE PROFILE METRICS\n   585→  // ==========================================\n   586→  nasolabialAngle: {\n   587→    points: ['columella', 'subnasale', 'labraleSuperius'],\n   588→    lines: [\n   589→      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },\n   590→      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },\n   591→    ],\n   592→  },\n   593→  nasalTipAngle: {\n   594→    points: ['nasion', 'pronasale', 'columella'],\n   595→    lines: [\n   596→      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },\n   597→      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },\n   598→    ],\n   599→  },\n   600→  nasalProjection: {\n   601→    points: ['alar_crease', 'pronasale', 'subnasale'],\n   602→    lines: [\n   603→      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },\n   604→    ],\n   605→  },\n   606→  nasalWToHRatio: {\n   607→    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],\n   608→    lines: [\n   609→      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },\n   610→      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n   611→    ],\n   612→  },\n   613→  noseTipRotationAngle: {\n   614→    points: ['columella', 'subnasale', 'labraleSuperius'],\n   615→    lines: [\n   616→      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },\n   617→    ],\n   618→  },\n   619→  frankfortTipAngle: {\n   620→    points: ['porion', 'orbitale', 'pronasale'],\n   621→    lines: [\n   622→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   623→      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },\n   624→    ],\n   625→  },\n   626→  mentolabialAngle: {\n   627→    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],\n   628→    lines: [\n   629→      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },\n   630→      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },\n   631→    ],\n   632→  },\n   633→  zAngle: {\n   634→    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],\n   635→    lines: [\n   636→      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },\n   637→    ],\n   638→  },\n   639→  facialConvexityGlabella: {\n   640→    points: ['glabella', 'subnasale', 'pogonion'],\n   641→    lines: [\n   642→      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },\n   643→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   644→    ],\n   645→  },\n   646→  facialConvexityNasion: {\n   647→    points: ['nasion', 'subnasale', 'pogonion'],\n   648→    lines: [\n   649→      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },\n   650→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   651→    ],\n   652→  },\n   653→  totalFacialConvexity: {\n   654→    points: ['glabella', 'pronasale', 'pogonion'],\n   655→    lines: [\n   656→      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },\n   657→      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   658→    ],\n   659→  },\n   660→  interiorMidfaceProjectionAngle: {\n   661→    points: ['orbitale', 'subnasale', 'pronasale'],\n   662→    lines: [\n   663→      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },\n   664→      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },\n   665→    ],\n   666→  },\n   667→  recessionFromFrankfort: {\n   668→    points: ['porion', 'orbitale', 'pogonion'],\n   669→    lines: [\n   670→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   671→      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },\n   672→    ],\n   673→  },\n   674→  gonionToMouthLine: {\n   675→    points: ['gonionBottom', 'cheilion', 'tragus'],\n   676→    lines: [\n   677→      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },\n   678→    ],\n   679→  },\n   680→  eLineUpperLip: {\n   681→    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n   682→    lines: [\n   683→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n   684→    ],\n   685→  },\n   686→  sLineUpperLip: {\n   687→    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n   688→    lines: [\n   689→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n   690→    ],\n   691→  },\n   692→  burstoneUpperLip: {\n   693→    points: ['subnasale', 'pogonion', 'labraleSuperius'],\n   694→    lines: [\n   695→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n   696→    ],\n   697→  },\n   698→  chinProjection: {\n   699→    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],\n   700→    lines: [\n   701→      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },\n   702→    ],\n   703→  },\n   704→  recessionRelativeToFrankfort: {\n   705→    points: ['porion', 'orbitale', 'pogonion', 'menton'],\n   706→    lines: [\n   707→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   708→      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },\n   709→    ],\n   710→  },\n   711→  browridgeInclinationAngle: {\n   712→    points: ['glabella', 'trichion', 'nasion'],\n   713→    lines: [\n   714→      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },\n   715→      { from: 'glabella', to: 'nasion', color: '#67e8f9' },\n   716→    ],\n   717→  },\n   718→  upperForeheadSlope: {\n   719→    points: ['trichion', 'glabella', 'frankfortHorizontal'],\n   720→    lines: [\n   721→      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },\n   722→    ],\n   723→  },\n   724→  midfaceProjectionAngle: {\n   725→    points: ['orbitale', 'subnasale', 'pronasale'],\n   726→    lines: [\n   727→      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },\n   728→      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },\n   729→    ],\n   730→  },\n   731→};\n   732→\n   733→function generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {\n   734→  const landmarkMap: Record<string, LandmarkPoint> = {};\n   735→  landmarks.forEach(l => { landmarkMap[l.id] = l; });\n   736→\n   737→  const config = ILLUSTRATION_CONFIGS[metricId];\n   738→  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};\n   739→  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};\n   740→\n   741→  if (config) {\n   742→    config.points.forEach((pointId, i) => {\n   743→      if (landmarkMap[pointId]) {\n   744→        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };\n   745→      }\n   746→    });\n   747→    config.lines.forEach((line, i) => {\n   748→      lines[`line_${i}`] = {\n   749→        from: line.from,\n   750→        to: line.to,\n   751→        color: line.color || '#67e8f9',\n   752→        label: line.label,\n   753→        labelPosition: line.labelPosition,\n   754→      };\n   755→    });\n   756→  }\n   757→\n   758→  return { points, lines };\n   759→}\n   760→\n   761→function getUsedLandmarks(metricId: string): string[] {\n   762→  const landmarkMappings: Record<string, string[]> = {\n   763→    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   764→    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],\n   765→    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n   766→    ipd: ['left_pupila', 'right_pupila'],\n   767→    mouthWidth: ['left_cheilion', 'right_cheilion'],\n   768→    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],\n   769→    chinHeight: ['labrale_inferius', 'menton'],\n   770→    gonialAngle: ['tragus', 'gonionBottom', 'menton'],\n   771→  };\n   772→  return landmarkMappings[metricId] || [];\n   773→}\n   774→\n   775→function getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {\n   776→  const flawMappings: Record<string, { low: string[]; high: string[] }> = {\n   777→    faceWidthToHeight: {\n   778→      low: ['Narrow face', 'Vertically elongated face'],\n   779→      high: ['Wide face', 'Horizontally expanded face'],\n   780→    },\n   781→    lowerThirdProportion: {\n   782→      low: ['Short lower third', 'Deficient mandible'],\n   783→      high: ['Long lower third', 'Mandibular excess'],\n   784→    },\n   785→    lateralCanthalTilt: {\n   786→      low: ['Negative canthal tilt', 'Drooping eyes'],\n   787→      high: ['Excessive positive canthal tilt'],\n   788→    },\n   789→    nasalIndex: {\n   790→      low: ['Narrow nose', 'Leptorrhine nose'],\n   791→      high: ['Wide nose', 'Platyrrhine nose'],\n   792→    },\n   793→    gonialAngle: {\n   794→      low: ['Steep mandibular plane'],\n   795→      high: ['Flat mandibular plane', 'Weak jaw definition'],\n   796→    },\n   797→  };\n   798→\n   799→  const strengthMappings: Record<string, { ideal: string[] }> = {\n   800→    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },\n   801→    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },\n   802→    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },\n   803→    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },\n   804→  };\n   805→\n   806→  const mapping = flawMappings[result.metricId];\n   807→  const strengthMapping = strengthMappings[result.metricId];\n   808→\n   809→  let mayIndicateFlaws: string[] = [];\n   810→  let mayIndicateStrengths: string[] = [];\n   811→\n   812→  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {\n   813→    mayIndicateStrengths = strengthMapping?.ideal || [];\n   814→  } else if (mapping) {\n   815→    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;\n   816→  }\n   817→\n   818→  return { mayIndicateFlaws, mayIndicateStrengths };\n   819→}\n   820→\n   821→// Metric groupings for creating multi-ratio strengths\n   822→const STRENGTH_GROUPINGS: Record<string, {\n   823→  name: string;\n   824→  category: string;\n   825→  description: string;\n   826→  metrics: string[];\n   827→}> = {\n   828→  // Lip Proportions\n   829→  lipProportions: {\n   830→    name: 'Well Proportioned Lips',\n   831→    category: 'Lips',\n   832→    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',\n   833→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n   834→  },\n   835→  // Eye Proportions\n   836→  eyeProportions: {\n   837→    name: 'Harmonious Eye Proportions',\n   838→    category: 'Eyes',\n   839→    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',\n   840→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n   841→  },\n   842→  // Nose Proportions\n   843→  noseProportions: {\n   844→    name: 'Balanced Nasal Proportions',\n   845→    category: 'Nose',\n   846→    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',\n   847→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n   848→  },\n   849→  // Jaw Definition\n   850→  jawDefinition: {\n   851→    name: 'Well-Defined Jawline',\n   852→    category: 'Jaw Shape',\n   853→    description: 'The jawline displays strong definition with balanced angles and proportionate width.',\n   854→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n   855→  },\n   856→  // Chin Proportions\n   857→  chinProportions: {\n   858→    name: 'Balanced Chin Projection',\n   859→    category: 'Chin',\n   860→    description: 'The chin demonstrates ideal projection and proportions relative to the face.',\n   861→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n   862→  },\n   863→  // Facial Thirds\n   864→  facialThirds: {\n   865→    name: 'Balanced Facial Thirds',\n   866→    category: 'Face Proportions',\n   867→    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',\n   868→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n   869→  },\n   870→  // Midface\n   871→  midfaceBalance: {\n   872→    name: 'Harmonious Midface',\n   873→    category: 'Midface/Face Shape',\n   874→    description: 'The midface shows balanced proportions with well-positioned cheekbones.',\n   875→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n   876→  },\n   877→  // Forehead\n   878→  foreheadBalance: {\n   879→    name: 'Well-Proportioned Forehead',\n   880→    category: 'Forehead',\n   881→    description: 'The forehead displays ideal proportions in height and shape.',\n   882→    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],\n   883→  },\n   884→};\n   885→\n   886→function generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {\n   887→  const strengths: Strength[] = [];\n   888→  const usedMetricIds = new Set<string>();\n   889→\n   890→  // First pass: Create grouped strengths from related high-scoring metrics\n   891→  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {\n   892→    // Find all high-scoring measurements that belong to this group\n   893→    const groupMeasurements = analysis.measurements.filter(m =>\n   894→      groupConfig.metrics.includes(m.metricId) &&\n   895→      m.score >= 7.5 &&\n   896→      !usedMetricIds.has(m.metricId)\n   897→    );\n   898→\n   899→    // Only create a grouped strength if we have 2+ metrics with good scores\n   900→    if (groupMeasurements.length >= 2) {\n   901→      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n   902→      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n   903→\n   904→      // Mark these metrics as used\n   905→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n   906→\n   907→      // Create grouped strength with multiple contributing ratios\n   908→      strengths.push({\n   909→        id: `strength_group_${groupId}`,\n   910→        strengthName: groupConfig.name,\n   911→        summary: groupConfig.description,\n   912→        avgScore,\n   913→        qualityLevel: bestQuality,\n   914→        categoryName: groupConfig.category,\n   915→        responsibleRatios: groupMeasurements.map(m => ({\n   916→          ratioName: m.name,\n   917→          ratioId: m.metricId,\n   918→          score: m.score,\n   919→          value: m.value,\n   920→          idealMin: m.idealMin,\n   921→          idealMax: m.idealMax,\n   922→          unit: m.unit,\n   923→          category: m.category,\n   924→        })),\n   925→      });\n   926→    }\n   927→  });\n   928→\n   929→  // Second pass: Add remaining individual strengths that weren't grouped\n   930→  analysis.strengths.forEach((s, i) => {\n   931→    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n   932→\n   933→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n   934→\n   935→    strengths.push({\n   936→      id: `strength_${i}`,\n   937→      strengthName: s.metricName,\n   938→      summary: s.reasoning,\n   939→      avgScore: matchingMeasurement?.score || 8,\n   940→      qualityLevel: s.qualityTier,\n   941→      categoryName: s.category,\n   942→      responsibleRatios: [{\n   943→        ratioName: s.metricName,\n   944→        ratioId: s.metricId,\n   945→        score: matchingMeasurement?.score || 8,\n   946→        value: s.value,\n   947→        idealMin: matchingMeasurement?.idealMin || 0,\n   948→        idealMax: matchingMeasurement?.idealMax || 1,\n   949→        unit: matchingMeasurement?.unit || 'ratio',\n   950→        category: s.category,\n   951→      }],\n   952→    });\n   953→  });\n   954→\n   955→  // Sort by average score (highest first) then by number of contributing ratios\n   956→  return strengths.sort((a, b) => {\n   957→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n   958→      return b.responsibleRatios.length - a.responsibleRatios.length;\n   959→    }\n   960→    return b.avgScore - a.avgScore;\n   961→  });\n   962→}\n   963→\n   964→// Flaw groupings - similar to strength groupings but for areas of improvement\n   965→const FLAW_GROUPINGS: Record<string, {\n   966→  name: string;\n   967→  category: string;\n   968→  description: string;\n   969→  metrics: string[];\n   970→}> = {\n   971→  // Lip Issues\n   972→  lipIssues: {\n   973→    name: 'Lip Proportion Concerns',\n   974→    category: 'Lips',\n   975→    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',\n   976→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n   977→  },\n   978→  // Eye Issues\n   979→  eyeIssues: {\n   980→    name: 'Eye Shape Considerations',\n   981→    category: 'Eyes',\n   982→    description: 'The eye proportions or positioning could benefit from enhancement.',\n   983→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n   984→  },\n   985→  // Nose Issues\n   986→  noseIssues: {\n   987→    name: 'Nasal Proportion Concerns',\n   988→    category: 'Nose',\n   989→    description: 'The nasal proportions show deviations that affect facial harmony.',\n   990→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n   991→  },\n   992→  // Jaw Issues\n   993→  jawIssues: {\n   994→    name: 'Jawline Definition Concerns',\n   995→    category: 'Jaw Shape',\n   996→    description: 'The jawline structure shows areas that could be enhanced for better definition.',\n   997→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n   998→  },\n   999→  // Chin Issues\n  1000→  chinIssues: {\n  1001→    name: 'Chin Projection Concerns',\n  1002→    category: 'Chin',\n  1003→    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',\n  1004→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  1005→  },\n  1006→  // Face Proportion Issues\n  1007→  proportionIssues: {\n  1008→    name: 'Facial Proportion Imbalance',\n  1009→    category: 'Face Proportions',\n  1010→    description: 'The vertical face proportions show imbalance between facial thirds.',\n  1011→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  1012→  },\n  1013→  // Midface Issues\n  1014→  midfaceIssues: {\n  1015→    name: 'Midface Development Concerns',\n  1016→    category: 'Midface/Face Shape',\n  1017→    description: 'The midface shows areas that could benefit from enhanced projection or balance.',\n  1018→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  1019→  },\n  1020→};\n  1021→\n  1022→function generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  1023→  const flaws: Flaw[] = [];\n  1024→  const usedMetricIds = new Set<string>();\n  1025→  let rollingLost = 0;\n  1026→\n  1027→  // First pass: Create grouped flaws from related low-scoring metrics\n  1028→  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n  1029→    // Find all low-scoring measurements that belong to this group\n  1030→    const groupMeasurements = analysis.measurements.filter(m =>\n  1031→      groupConfig.metrics.includes(m.metricId) &&\n  1032→      m.score < 6 &&\n  1033→      !usedMetricIds.has(m.metricId)\n  1034→    );\n  1035→\n  1036→    // Only create a grouped flaw if we have 2+ metrics with low scores\n  1037→    if (groupMeasurements.length >= 2) {\n  1038→      // Mark these metrics as used\n  1039→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n  1040→\n  1041→      // Calculate total impact from all metrics in this group\n  1042→      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n  1043→      rollingLost += totalImpact;\n  1044→\n  1045→      // Create grouped flaw with multiple contributing ratios\n  1046→      flaws.push({\n  1047→        id: `flaw_group_${groupId}`,\n  1048→        flawName: groupConfig.name,\n  1049→        summary: groupConfig.description,\n  1050→        harmonyPercentageLost: totalImpact,\n  1051→        standardizedImpact: totalImpact / 10,\n  1052→        categoryName: groupConfig.category,\n  1053→        responsibleRatios: groupMeasurements.map(m => ({\n  1054→          ratioName: m.name,\n  1055→          ratioId: m.metricId,\n  1056→          score: m.score,\n  1057→          value: m.value,\n  1058→          idealMin: m.idealMin,\n  1059→          idealMax: m.idealMax,\n  1060→          unit: m.unit,\n  1061→          category: m.category,\n  1062→        })),\n  1063→        rollingPointsDeducted: rollingLost,\n  1064→        rollingHarmonyPercentageLost: rollingLost,\n  1065→        rollingStandardizedImpact: rollingLost / 10,\n  1066→      });\n  1067→    }\n  1068→  });\n  1069→\n  1070→  // Second pass: Add remaining individual flaws that weren't grouped\n  1071→  analysis.flaws.forEach((f, i) => {\n  1072→    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n  1073→\n  1074→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n  1075→    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n  1076→    rollingLost += impact;\n  1077→\n  1078→    flaws.push({\n  1079→      id: `flaw_${i}`,\n  1080→      flawName: f.metricName,\n  1081→      summary: f.reasoning,\n  1082→      harmonyPercentageLost: impact,\n  1083→      standardizedImpact: impact / 10,\n  1084→      categoryName: f.category,\n  1085→      responsibleRatios: [{\n  1086→        ratioName: f.metricName,\n  1087→        ratioId: f.metricId,\n  1088→        score: matchingMeasurement?.score || 3,\n  1089→        value: matchingMeasurement?.value || 0,\n  1090→        idealMin: matchingMeasurement?.idealMin || 0,\n  1091→        idealMax: matchingMeasurement?.idealMax || 1,\n  1092→        unit: matchingMeasurement?.unit || 'ratio',\n  1093→        category: f.category,\n  1094→      }],\n  1095→      rollingPointsDeducted: rollingLost,\n  1096→      rollingHarmonyPercentageLost: rollingLost,\n  1097→      rollingStandardizedImpact: rollingLost / 10,\n  1098→    });\n  1099→  });\n  1100→\n  1101→  // Sort by impact (highest first) then by number of contributing ratios\n  1102→  return flaws.sort((a, b) => {\n  1103→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n  1104→      return b.responsibleRatios.length - a.responsibleRatios.length;\n  1105→    }\n  1106→    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  1107→  });\n  1108→}\n  1109→\n  1110→// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions\n  1111→// have been moved to @/lib/results/analysis.ts to reduce bundle size\n  1112→// Import generateRecommendations from there instead\n  1113→// ============================================\n  1114→// CONTEXT CREATION\n  1115→// ============================================\n  1116→\n  1117→const ResultsContext = createContext<ResultsContextType | null>(null);\n  1118→\n  1119→export function useResults(): ResultsContextType {\n  1120→  const context = useContext(ResultsContext);\n  1121→  if (!context) {\n  1122→    throw new Error('useResults must be used within a ResultsProvider');\n  1123→  }\n  1124→  return context;\n  1125→}\n  1126→\n  1127→interface ResultsProviderProps {\n  1128→  children: ReactNode;\n  1129→  initialData?: ResultsInputData;\n  1130→}\n  1131→\n  1132→export function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  1133→  // Raw data state\n  1134→  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  1135→  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  1136→  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  1137→  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  1138→  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  1139→  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n  1140→\n  1141→  // UI state\n  1142→  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  1143→  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  1144→  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  1145→  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  1146→  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n  1147→\n  1148→  // Compute analysis results (now with demographic-specific scoring)\n  1149→  const analysisResults = useMemo(() => {\n  1150→    if (frontLandmarks.length === 0) {\n  1151→      return null;\n  1152→    }\n  1153→\n  1154→    try {\n  1155→      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n  1156→      const sideAnalysis = sideLandmarks.length > 0\n  1157→        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n  1158→        : null;\n  1159→      // analyzeHarmony expects landmarks directly, not analysis results\n  1160→      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n  1161→\n  1162→      return { frontAnalysis, sideAnalysis, harmony };\n  1163→    } catch (error) {\n  1164→      console.error('Analysis error:', error);\n  1165→      return null;\n  1166→    }\n  1167→  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n  1168→\n  1169→  // Transform to Ratio format\n  1170→  const frontRatios = useMemo(() => {\n  1171→    if (!analysisResults?.frontAnalysis) return [];\n  1172→    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  1173→  }, [analysisResults, frontLandmarks]);\n  1174→\n  1175→  const sideRatios = useMemo(() => {\n  1176→    if (!analysisResults?.sideAnalysis) return [];\n  1177→    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  1178→  }, [analysisResults, sideLandmarks]);\n  1179→\n  1180→  // Generate strengths and flaws using INSIGHTS-BASED classification\n  1181→  // This processes insights.json definitions: calculates avg score of affected metrics,\n  1182→  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  1183→  const { insightStrengths, insightFlaws } = useMemo(() => {\n  1184→    if (!analysisResults?.harmony) {\n  1185→      return { insightStrengths: [], insightFlaws: [] };\n  1186→    }\n  1187→\n  1188→    try {\n  1189→      // Classify using insights engine\n  1190→      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n  1191→        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n  1192→\n  1193→      // Convert to UI-compatible types\n  1194→      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n  1195→\n  1196→      let rollingLost = 0;\n  1197→      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n  1198→        const flaw = convertToFlaw(w, i, rollingLost);\n  1199→        rollingLost = flaw.rollingPointsDeducted || 0;\n  1200→        return flaw;\n  1201→      });\n  1202→\n  1203→      return { insightStrengths, insightFlaws };\n  1204→    } catch (error) {\n  1205→      console.error('[ResultsContext] Error in insights classification:', error);\n  1206→      return { insightStrengths: [], insightFlaws: [] };\n  1207→    }\n  1208→  }, [analysisResults]);\n  1209→\n  1210→  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  1211→  const groupingStrengths = useMemo(() => {\n  1212→    if (!analysisResults?.harmony) return [];\n  1213→    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  1214→  }, [analysisResults]);\n  1215→\n  1216→  const groupingFlaws = useMemo(() => {\n  1217→    if (!analysisResults?.harmony) return [];\n  1218→    return generateFlawsFromAnalysis(analysisResults.harmony);\n  1219→  }, [analysisResults]);\n  1220→\n  1221→  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)\n  1222→  const strengths = useMemo(() => {\n  1223→    // Use insights as primary source\n  1224→    const usedMetricIds = new Set<string>();\n  1225→    insightStrengths.forEach(s => {\n  1226→      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n  1227→    });\n  1228→\n  1229→    // Add grouping-based strengths that don't overlap\n  1230→    const nonOverlappingGrouping = groupingStrengths.filter(gs => {\n  1231→      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n  1232→      return !overlap;\n  1233→    });\n  1234→\n  1235→    return [...insightStrengths, ...nonOverlappingGrouping];\n  1236→  }, [insightStrengths, groupingStrengths]);\n  1237→\n  1238→  const flaws = useMemo(() => {\n  1239→    // Use insights as primary source\n  1240→    const usedMetricIds = new Set<string>();\n  1241→    insightFlaws.forEach(f => {\n  1242→      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n  1243→    });\n  1244→\n  1245→    // Add grouping-based flaws that don't overlap\n  1246→    const nonOverlappingGrouping = groupingFlaws.filter(gf => {\n  1247→      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n  1248→      return !overlap;\n  1249→    });\n  1250→\n  1251→    // Recalculate rolling totals for merged list\n  1252→    let rollingLost = 0;\n  1253→    const merged = [...insightFlaws, ...nonOverlappingGrouping];\n  1254→    return merged.map(f => {\n  1255→      rollingLost += f.harmonyPercentageLost;\n  1256→      return {\n  1257→        ...f,\n  1258→        rollingPointsDeducted: rollingLost,\n  1259→        rollingHarmonyPercentageLost: rollingLost,\n  1260→        rollingStandardizedImpact: rollingLost / 10,\n  1261→      };\n  1262→    });\n  1263→  }, [insightFlaws, groupingFlaws]);\n  1264→\n  1265→  // Generate recommendations with metric-aware matching and Bezier recalculation\n  1266→  const recommendations = useMemo(() => {\n  1267→    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);\n  1268→  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);\n  1269→\n  1270→  // Build full harmony analysis\n  1271→  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {\n  1272→    if (!analysisResults?.harmony) return null;\n  1273→\n  1274→    return {\n  1275→      standardizedScore: analysisResults.harmony.overallScore,\n  1276→      front: {\n  1277→        standardizedScore: analysisResults.harmony.frontScore,\n  1278→        ratios: frontRatios,\n  1279→      },\n  1280→      side: {\n  1281→        standardizedScore: analysisResults.harmony.sideScore,\n  1282→        ratios: sideRatios,\n  1283→      },\n  1284→      strengths,\n  1285→      flaws,\n  1286→    };\n  1287→  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);\n  1288→\n  1289→  // Calculate weighted harmony score using looksmax_engine.py algorithm\n  1290→  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {\n  1291→    if (!analysisResults?.harmony) return null;\n  1292→\n  1293→    const allMeasurements = analysisResults.harmony.measurements.map(m => ({\n  1294→      metricId: m.metricId,\n  1295→      standardizedScore: m.standardizedScore,\n  1296→    }));\n  1297→\n  1298→    return calculateHarmonyScore(allMeasurements);\n  1299→  }, [analysisResults]);\n  1300→\n  1301→  // Get top 3 and bottom 3 metrics with advice\n  1302→  const topMetrics = useMemo((): RankedMetric[] => {\n  1303→    if (!analysisResults?.harmony) return [];\n  1304→    return getTopMetrics(analysisResults.harmony.measurements, 3);\n  1305→  }, [analysisResults]);\n  1306→\n  1307→  const bottomMetrics = useMemo((): RankedMetric[] => {\n  1308→    if (!analysisResults?.harmony) return [];\n  1309→    return getBottomMetrics(analysisResults.harmony.measurements, 3);\n  1310→  }, [analysisResults]);\n  1311→\n  1312→  // Scores - now using weighted harmony with explicit clamping to 0-10\n  1313→  const rawHarmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;\n  1314→  const harmonyPercentage = Math.max(0, Math.min(100, rawHarmonyPercentage));\n  1315→\n  1316→  const rawOverallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;\n  1317→  const overallScore = Math.max(0, Math.min(10, rawOverallScore));\n  1318→\n  1319→  const rawFrontScore = analysisResults?.harmony?.frontScore || 0;\n  1320→  const frontScore = Math.max(0, Math.min(10, rawFrontScore));\n  1321→\n  1322→  const rawSideScore = analysisResults?.harmony?.sideScore || 0;\n  1323→  const sideScore = Math.max(0, Math.min(10, rawSideScore));\n  1324→\n  1325→  // PSL Rating (1-10 scale with tier/percentile)\n  1326→  const pslRating = useMemo(() => {\n  1327→    return harmonyToPSL(harmonyPercentage);\n  1328→  }, [harmonyPercentage]);\n  1329→\n  1330→  // Action to set all results data\n  1331→  const setResultsData = useCallback((data: ResultsInputData) => {\n  1332→    setFrontLandmarks(data.frontLandmarks);\n  1333→    setSideLandmarks(data.sideLandmarks);\n  1334→    setFrontPhoto(data.frontPhoto);\n  1335→    setSidePhoto(data.sidePhoto || null);\n  1336→    setGender(data.gender);\n  1337→    setEthnicity(data.ethnicity || 'other');\n  1338→  }, []);\n  1339→\n  1340→  // Memoize context value to prevent unnecessary re-renders\n  1341→  const value = useMemo<ResultsContextType>(() => ({\n  1342→    frontLandmarks,\n  1343→    sideLandmarks,\n  1344→    gender,\n  1345→    ethnicity,\n  1346→    frontPhoto,\n  1347→    sidePhoto,\n  1348→    harmonyAnalysis,\n  1349→    frontRatios,\n  1350→    sideRatios,\n  1351→    strengths,\n  1352→    flaws,\n  1353→    recommendations,\n  1354→    overallScore,\n  1355→    frontScore,\n  1356→    sideScore,\n  1357→    // Weighted harmony from looksmax_engine.py\n  1358→    harmonyScoreResult,\n  1359→    harmonyPercentage,\n  1360→    topMetrics,\n  1361→    bottomMetrics,\n  1362→    // PSL Rating\n  1363→    pslRating,\n  1364→    // UI state\n  1365→    activeTab,\n  1366→    setActiveTab,\n  1367→    expandedMeasurementId,\n  1368→    setExpandedMeasurementId,\n  1369→    selectedVisualizationMetric,\n  1370→    setSelectedVisualizationMetric,\n  1371→    categoryFilter,\n  1372→    setCategoryFilter,\n  1373→    showLandmarkOverlay,\n  1374→    setShowLandmarkOverlay,\n  1375→    setResultsData,\n  1376→  }), [\n  1377→    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,\n  1378→    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,\n  1379→    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,\n  1380→    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,\n  1381→    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,\n  1382→    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,\n  1383→    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,\n  1384→  ]);\n  1385→\n  1386→  return (\n  1387→    <ResultsContext.Provider value={value}>\n  1388→      {children}\n  1389→    </ResultsContext.Provider>\n  1390→  );\n  1391→}\n  1392→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n","numLines":1397,"startLine":1,"totalLines":1397}}}
{"parentUuid":"7393c5db-0313-428a-bb57-18597cc05277","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_018Yh7MQPvsmVr5md5YPVrZn","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the looksmax-scoring.ts file and severity.ts to understand the full data flow:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":44178,"cache_read_input_tokens":76462,"cache_creation":{"ephemeral_5m_input_tokens":44178,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrVtAF6FPVCS6d6X6kS","type":"assistant","uuid":"e7260a8c-130e-4736-b9aa-0374ca639a8d","timestamp":"2025-12-26T06:50:35.202Z"}
{"parentUuid":"e7260a8c-130e-4736-b9aa-0374ca639a8d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_018Yh7MQPvsmVr5md5YPVrZn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GdMUMKVHGFoCWk5QkwwZJv","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/looksmax-scoring.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":44178,"cache_read_input_tokens":76462,"cache_creation":{"ephemeral_5m_input_tokens":44178,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrVtAF6FPVCS6d6X6kS","type":"assistant","uuid":"23d78053-b442-4b6b-9f10-6d1a7fd22f46","timestamp":"2025-12-26T06:50:36.253Z"}
{"parentUuid":"23d78053-b442-4b6b-9f10-6d1a7fd22f46","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_018Yh7MQPvsmVr5md5YPVrZn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FjrhhEGFAKUxchUWpFWbyH","name":"Read","input":{"file_path":"/Users/imorgado/.claude/projects/-Users-imorgado-LOOKSMAXX-looksmaxx-app/4e0d04e8-56ad-4bca-9e4b-36b62804ea66/tool-results/toolu_01UNP5zAaZP7cdDPe4qfCyvz.txt","offset":1,"limit":300}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":44178,"cache_read_input_tokens":76462,"cache_creation":{"ephemeral_5m_input_tokens":44178,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrVtAF6FPVCS6d6X6kS","type":"assistant","uuid":"4f3ba71b-3878-4a8d-8ce6-4ec1c0459ad8","timestamp":"2025-12-26T06:50:40.105Z"}
{"parentUuid":"4f3ba71b-3878-4a8d-8ce6-4ec1c0459ad8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GdMUMKVHGFoCWk5QkwwZJv","type":"tool_result","content":"     1→/**\n     2→ * LOOKSMAX Scoring Engine\n     3→ * Ported from looksmax_engine.py - Presentation Layer\n     4→ *\n     5→ * Features:\n     6→ * - Weighted Harmony Score calculation (3.0x, 2.0x, 1.0x tiers)\n     7→ * - Metric-specific advice generation\n     8→ * - Gaussian scoring with exponential decay\n     9→ */\n    10→\n    11→import type { MetricScoreResult, QualityTier, SeverityLevel } from './harmony-scoring';\n    12→\n    13→// =============================================================================\n    14→// HARMONY SCORE WEIGHTS\n    15→// =============================================================================\n    16→\n    17→/**\n    18→ * High Impact Metrics (3.0x weight)\n    19→ * Core facial harmony indicators that have the greatest effect on overall attractiveness\n    20→ */\n    21→export const HIGH_IMPACT_METRICS = new Set([\n    22→  'faceWidthToHeight',\n    23→  'midfaceRatio',\n    24→  'lateralCanthalTilt',\n    25→  'gonialAngle',\n    26→  'mandibularPlaneAngle',\n    27→  'chinToPhiltrumRatio',\n    28→]);\n    29→\n    30→/**\n    31→ * Medium Impact Metrics (2.0x weight)\n    32→ * Secondary aesthetic factors\n    33→ */\n    34→export const MEDIUM_IMPACT_METRICS = new Set([\n    35→  'noseBridgeToNoseWidth',\n    36→  'nasolabialAngle',\n    37→  'cheekboneHeight',\n    38→  'ramusToMandibleRatio',\n    39→]);\n    40→\n    41→/**\n    42→ * Get the weight multiplier for a metric\n    43→ */\n    44→export function getMetricWeight(metricId: string): number {\n    45→  if (HIGH_IMPACT_METRICS.has(metricId)) return 3.0;\n    46→  if (MEDIUM_IMPACT_METRICS.has(metricId)) return 2.0;\n    47→  return 1.0;\n    48→}\n    49→\n    50→/**\n    51→ * Get weight tier name for display\n    52→ */\n    53→export function getWeightTier(metricId: string): 'high' | 'medium' | 'standard' {\n    54→  if (HIGH_IMPACT_METRICS.has(metricId)) return 'high';\n    55→  if (MEDIUM_IMPACT_METRICS.has(metricId)) return 'medium';\n    56→  return 'standard';\n    57→}\n    58→\n    59→// =============================================================================\n    60→// WEIGHTED HARMONY SCORE CALCULATION\n    61→// =============================================================================\n    62→\n    63→export interface HarmonyScoreResult {\n    64→  /** Weighted harmony percentage (0-100%) */\n    65→  harmonyPercentage: number;\n    66→  /** Weighted average score (0-10 scale) */\n    67→  weightedAverage: number;\n    68→  /** Unweighted average for comparison */\n    69→  unweightedAverage: number;\n    70→  /** Breakdown by weight tier */\n    71→  weightDistribution: {\n    72→    highImpact: { count: number; avgScore: number };\n    73→    mediumImpact: { count: number; avgScore: number };\n    74→    standard: { count: number; avgScore: number };\n    75→  };\n    76→}\n    77→\n    78→/**\n    79→ * Calculate the weighted Harmony Score from scored measurements.\n    80→ * Uses 3-tier weighting: High (3x), Medium (2x), Standard (1x)\n    81→ *\n    82→ * Formula: Σ(Score × Weight) / Σ(Weights) → percentage\n    83→ */\n    84→export function calculateHarmonyScore(\n    85→  measurements: Array<{ metricId: string; standardizedScore: number }>\n    86→): HarmonyScoreResult {\n    87→  let totalWeightedScore = 0;\n    88→  let totalWeight = 0;\n    89→  let unweightedTotal = 0;\n    90→\n    91→  const tiers = {\n    92→    high: { total: 0, count: 0 },\n    93→    medium: { total: 0, count: 0 },\n    94→    standard: { total: 0, count: 0 },\n    95→  };\n    96→\n    97→  for (const m of measurements) {\n    98→    const weight = getMetricWeight(m.metricId);\n    99→    const tier = getWeightTier(m.metricId);\n   100→\n   101→    totalWeightedScore += m.standardizedScore * weight;\n   102→    totalWeight += weight;\n   103→    unweightedTotal += m.standardizedScore;\n   104→\n   105→    tiers[tier].total += m.standardizedScore;\n   106→    tiers[tier].count++;\n   107→  }\n   108→\n   109→  const rawWeightedAverage = totalWeight > 0 ? totalWeightedScore / totalWeight : 0;\n   110→  const rawUnweightedAverage = measurements.length > 0 ? unweightedTotal / measurements.length : 0;\n   111→\n   112→  // Clamp averages to 0-10 range to prevent any edge case overflows\n   113→  const weightedAverage = Math.max(0, Math.min(10, rawWeightedAverage));\n   114→  const unweightedAverage = Math.max(0, Math.min(10, rawUnweightedAverage));\n   115→  const harmonyPercentage = Math.max(0, Math.min(100, (weightedAverage / 10) * 100));\n   116→\n   117→  // Helper to clamp tier averages to 0-10\n   118→  const clampAvg = (total: number, count: number): number => {\n   119→    if (count === 0) return 0;\n   120→    return Math.max(0, Math.min(10, total / count));\n   121→  };\n   122→\n   123→  return {\n   124→    harmonyPercentage,\n   125→    weightedAverage,\n   126→    unweightedAverage,\n   127→    weightDistribution: {\n   128→      highImpact: {\n   129→        count: tiers.high.count,\n   130→        avgScore: clampAvg(tiers.high.total, tiers.high.count),\n   131→      },\n   132→      mediumImpact: {\n   133→        count: tiers.medium.count,\n   134→        avgScore: clampAvg(tiers.medium.total, tiers.medium.count),\n   135→      },\n   136→      standard: {\n   137→        count: tiers.standard.count,\n   138→        avgScore: clampAvg(tiers.standard.total, tiers.standard.count),\n   139→      },\n   140→    },\n   141→  };\n   142→}\n   143→\n   144→// =============================================================================\n   145→// ADVICE ENGINE - METRIC-SPECIFIC FEEDBACK STRINGS\n   146→// =============================================================================\n   147→\n   148→interface AdviceEntry {\n   149→  tooHigh: string;\n   150→  tooLow: string;\n   151→}\n   152→\n   153→/**\n   154→ * Comprehensive advice database for all metrics\n   155→ * Keys match metric IDs from harmony-scoring.ts\n   156→ */\n   157→export const ADVICE_DATABASE: Record<string, AdviceEntry> = {\n   158→  // === HIGH IMPACT METRICS ===\n   159→  faceWidthToHeight: {\n   160→    tooHigh: \"Face appears wider. Consider hairstyles that add vertical length.\",\n   161→    tooLow: \"Face is elongated. Hairstyles with side volume can add balance.\",\n   162→  },\n   163→  midfaceRatio: {\n   164→    tooHigh: \"Midface is elongated. This can project maturity but may benefit from framing.\",\n   165→    tooLow: \"Midface is compact. This is often a dimorphic and youthful trait.\",\n   166→  },\n   167→  lateralCanthalTilt: {\n   168→    tooHigh: \"Eyes have significant positive tilt. Very dimorphic - no action needed.\",\n   169→    tooLow: \"Eyes have negative tilt. Consider brow-maxxing or temporal area work.\",\n   170→  },\n   171→  gonialAngle: {\n   172→    tooHigh: \"Jaw angle is steep (obtuse). Lowering body fat or chewing hard gum may improve definition.\",\n   173→    tooLow: \"Jaw angle is very sharp. Strong masculine trait - no action typically needed.\",\n   174→  },\n   175→  mandibularPlaneAngle: {\n   176→    tooHigh: \"Steep mandibular plane (long face type). May benefit from mewing or jaw work.\",\n   177→    tooLow: \"Flat mandibular plane. This is typically a favorable trait.\",\n   178→  },\n   179→  chinToPhiltrumRatio: {\n   180→    tooHigh: \"Chin is long relative to philtrum. Generally masculine; no action needed.\",\n   181→    tooLow: \"Philtrum is long relative to chin. Upper lip lifting or chin augmentation options exist.\",\n   182→  },\n   183→\n   184→  // === MEDIUM IMPACT METRICS ===\n   185→  noseBridgeToNoseWidth: {\n   186→    tooHigh: \"Nose appears narrow relative to bridge. This is typically favorable.\",\n   187→    tooLow: \"Nose is wide relative to bridge. Nostril work can refine proportions.\",\n   188→  },\n   189→  nasolabialAngle: {\n   190→    tooHigh: \"Nose tip points upward. Can appear more feminine; tip refinement may help.\",\n   191→    tooLow: \"Nose tip points downward (droopy). Tip rotation procedures can improve profile.\",\n   192→  },\n   193→  cheekboneHeight: {\n   194→    tooHigh: \"Cheekbones are exceptionally high. Very aesthetic - no action needed.\",\n   195→    tooLow: \"Cheekbones are lower set. Malar augmentation or filler can enhance projection.\",\n   196→  },\n   197→  cheekFullness: {\n   198→    tooHigh: \"Very full cheeks. Consider facial contouring if seeking a leaner look.\",\n   199→    tooLow: \"Hollow or gaunt cheeks. Malar filler or fat grafting can restore volume.\",\n   200→  },\n   201→  ramusToMandibleRatio: {\n   202→    tooHigh: \"Short mandibular body. Jaw angle implants may improve proportions.\",\n   203→    tooLow: \"Long mandibular body. This is typically favorable for facial width.\",\n   204→  },\n   205→\n   206→  // === FRONT PROFILE METRICS ===\n   207→  jawSlope: {\n   208→    tooHigh: \"Jaw slopes steeply. Consider gonial angle enhancement.\",\n   209→    tooLow: \"Jaw has minimal slope. Strong horizontal projection is present.\",\n   210→  },\n   211→  totalFacialWidthToHeight: {\n   212→    tooHigh: \"Face is very wide relative to height. Can appear robust/masculine.\",\n   213→    tooLow: \"Face is very tall relative to width. Hairstyles with width can balance.\",\n   214→  },\n   215→  mouthWidthToNoseRatio: {\n   216→    tooHigh: \"Wide mouth relative to nose. Typically attractive; no action needed.\",\n   217→    tooLow: \"Narrow mouth relative to nose. Lip exercises may help.\",\n   218→  },\n   219→  lowerThirdProportion: {\n   220→    tooHigh: \"Lower face is long. May benefit from vertical reduction options.\",\n   221→    tooLow: \"Lower face is short. Chin augmentation can add vertical height.\",\n   222→  },\n   223→  ipsilateralAlarAngle: {\n   224→    tooHigh: \"Nostril angle is wide. Alar reduction may refine the nose.\",\n   225→    tooLow: \"Nostril angle is narrow. Typically favorable; no action needed.\",\n   226→  },\n   227→  jawFrontalAngle: {\n   228→    tooHigh: \"Jaw is V-shaped. Gonial angle widening may add presence.\",\n   229→    tooLow: \"Jaw is very U-shaped/wide. Strong masculine trait.\",\n   230→  },\n   231→  eyeAspectRatio: {\n   232→    tooHigh: \"Eyes are horizontally elongated. Hunter eyes are typically desirable.\",\n   233→    tooLow: \"Eyes are more round. Lateral canthoplasty can elongate.\",\n   234→  },\n   235→  bitemporalWidth: {\n   236→    tooHigh: \"Wide temples relative to face. Full head of hair can balance.\",\n   237→    tooLow: \"Narrow temples. Can appear more refined/gracile.\",\n   238→  },\n   239→  eyebrowLowSetedness: {\n   240→    tooHigh: \"Brows are low-set (hooded). Creates intense look; browlift if too heavy.\",\n   241→    tooLow: \"Brows are high-set. More open look; brow products can add fullness.\",\n   242→  },\n   243→  eyeSeparationRatio: {\n   244→    tooHigh: \"Eyes are widely set. Creates softer look; no action typically needed.\",\n   245→    tooLow: \"Eyes are closely set. Can appear intense; glasses can balance.\",\n   246→  },\n   247→  bigonialWidth: {\n   248→    tooHigh: \"Wide jaw relative to cheekbones. Strong masculine trait.\",\n   249→    tooLow: \"Narrow jaw relative to cheekbones. Jaw angle widening may add presence.\",\n   250→  },\n   251→  lowerToUpperLipRatio: {\n   252→    tooHigh: \"Lower lip is much fuller. Very aesthetic; no action needed.\",\n   253→    tooLow: \"Upper lip is fuller. Standard proportion; lip flip may balance.\",\n   254→  },\n   255→  eyebrowTilt: {\n   256→    tooHigh: \"Brows tilt significantly upward. Can appear expressive.\",\n   257→    tooLow: \"Brows are flat or downturned. Can appear more stoic.\",\n   258→  },\n   259→\n   260→  // === SIDE PROFILE METRICS ===\n   261→  recessionRelativeToFrankfort: {\n   262→    tooHigh: \"Significant lower jaw recession. Advancement surgery may help.\",\n   263→    tooLow: \"Jaw projects forward strongly. Very masculine; monitor overbite.\",\n   264→  },\n   265→  facialDepthToHeightRatio: {\n   266→    tooHigh: \"Face is very deep relative to height. Strong forward growth.\",\n   267→    tooLow: \"Face is flat relative to height. May benefit from midface/chin work.\",\n   268→  },\n   269→  interiorMidfaceProjectionAngle: {\n   270→    tooHigh: \"Midface projects significantly. Strong forward growth.\",\n   271→    tooLow: \"Flat midface. Cheekbone augmentation may improve profile.\",\n   272→  },\n   273→  nasofrontalAngle: {\n   274→    tooHigh: \"Deep nasofrontal angle. Creates dramatic brow/nose transition.\",\n   275→    tooLow: \"Shallow nasofrontal angle. Brow work may add definition.\",\n   276→  },\n   277→  gonionToMouthLine: {\n   278→    tooHigh: \"Gonion is low relative to mouth. May appear long-faced.\",\n   279→    tooLow: \"Gonion is high relative to mouth. Compact proportions.\",\n   280→  },\n   281→  lowerLipSLinePosition: {\n   282→    tooHigh: \"Lower lip protrudes past S-line. May indicate maxillary retrusion.\",\n   283→    tooLow: \"Lower lip is behind S-line. Well-balanced profile.\",\n   284→  },\n   285→  zAngle: {\n   286→    tooHigh: \"Profile is very upright/vertical. May appear flat.\",\n   287→    tooLow: \"Profile is convex. Standard Western ideal.\",\n   288→  },\n   289→  nasomentaAngle: {\n   290→    tooHigh: \"Nose-chin line is obtuse. May indicate weak chin.\",\n   291→    tooLow: \"Nose-chin line is acute. Strong chin projection.\",\n   292→  },\n   293→  submentalCervicalAngle: {\n   294→    tooHigh: \"Weak chin-neck angle. May benefit from submental lipo or implant.\",\n   295→    tooLow: \"Sharp chin-neck angle. Excellent definition.\",\n   296→  },\n   297→  nasofacialAngle: {\n   298→    tooHigh: \"Large angle between nose and face. Strong nose or recessed face.\",\n   299→    tooLow: \"Small angle. Well-integrated nose.\",\n   300→  },\n   301→  holdawayHLine: {\n   302→    tooHigh: \"Lips project significantly. Monitor for bimax protrusion.\",\n   303→    tooLow: \"Flat lip line. May appear retruded; filler can add volume.\",\n   304→  },\n   305→  mentolabialAngle: {\n   306→    tooHigh: \"Deep mentolabial fold. Can appear aged; filler can soften.\",\n   307→    tooLow: \"Shallow mentolabial fold. Youthful and balanced.\",\n   308→  },\n   309→  eLineLowerLip: {\n   310→    tooHigh: \"Lower lip protrudes past E-line. May benefit from orthodontics.\",\n   311→    tooLow: \"Lower lip is behind E-line. Balanced or retruded.\",\n   312→  },\n   313→  eLineUpperLip: {\n   314→    tooHigh: \"Upper lip protrudes past E-line. May benefit from orthodontics.\",\n   315→    tooLow: \"Upper lip is behind E-line. Balanced or retruded.\",\n   316→  },\n   317→  nasalTipAngle: {\n   318→    tooHigh: \"Nose tip is rotated upward. Can appear feminine.\",\n   319→    tooLow: \"Nose tip droops. Tip rotation surgery can improve.\",\n   320→  },\n   321→  nasalProjection: {\n   322→    tooHigh: \"Large nose projection. Reduction rhinoplasty may refine.\",\n   323→    tooLow: \"Minimal nose projection. Augmentation rhinoplasty may enhance.\",\n   324→  },\n   325→  nasalWToHRatio: {\n   326→    tooHigh: \"Wide nose relative to height. Narrowing procedures exist.\",\n   327→    tooLow: \"Narrow nose. Typically favorable; no action needed.\",\n   328→  },\n   329→  facialConvexityGlabella: {\n   330→    tooHigh: \"Convex profile. Strong midface projection.\",\n   331→    tooLow: \"Flat or concave profile. May benefit from augmentation.\",\n   332→  },\n   333→  facialConvexityNasion: {\n   334→    tooHigh: \"Convex profile from nasion. Good forward growth.\",\n   335→    tooLow: \"Straight or concave profile. May appear flat.\",\n   336→  },\n   337→  totalFacialConvexity: {\n   338→    tooHigh: \"Very convex total profile. Midface is prominent.\",\n   339→    tooLow: \"Flat total profile. Forward growth options may help.\",\n   340→  },\n   341→  upperForeheadSlope: {\n   342→    tooHigh: \"Sloped forehead. More masculine/primal appearance.\",\n   343→    tooLow: \"Upright forehead. More neotenous appearance.\",\n   344→  },\n   345→  browridgeInclinationAngle: {\n   346→    tooHigh: \"Prominent browridge angle. Strong masculine trait.\",\n   347→    tooLow: \"Flat browridge. Implants can add definition.\",\n   348→  },\n   349→  upperThirdProportion: {\n   350→    tooHigh: \"Upper third is long. Large forehead; can be offset with hair styling.\",\n   351→    tooLow: \"Upper third is short. Compact proportions.\",\n   352→  },\n   353→  middleThirdProportion: {\n   354→    tooHigh: \"Middle third is long. May appear long-faced.\",\n   355→    tooLow: \"Middle third is short. Compact midface.\",\n   356→  },\n   357→  chinProjection: {\n   358→    tooHigh: \"Strong chin projection. Very masculine trait.\",\n   359→    tooLow: \"Weak chin projection. Genioplasty or implant can improve.\",\n   360→  },\n   361→  lipRatio: {\n   362→    tooHigh: \"Full lips. Typically attractive; no action needed.\",\n   363→    tooLow: \"Thin lips. Filler can add volume if desired.\",\n   364→  },\n   365→};\n   366→\n   367→/**\n   368→ * Generate personalized advice based on metric score and value position.\n   369→ *\n   370→ * @param metricId - The metric identifier\n   371→ * @param score - Score from 0-10\n   372→ * @param value - Actual measured value\n   373→ * @param idealMin - Minimum of ideal range\n   374→ * @param idealMax - Maximum of ideal range\n   375→ * @returns Advice string for the metric\n   376→ */\n   377→export function generateAdvice(\n   378→  metricId: string,\n   379→  score: number,\n   380→  value: number,\n   381→  idealMin: number,\n   382→  idealMax: number\n   383→): string {\n   384→  // Perfect score - no action needed\n   385→  if (score >= 9.0) {\n   386→    return \"Ideal proportions. No action needed.\";\n   387→  }\n   388→\n   389→  // Get advice from database\n   390→  const advice = ADVICE_DATABASE[metricId];\n   391→  if (advice) {\n   392→    if (value > idealMax) {\n   393→      return advice.tooHigh;\n   394→    } else if (value < idealMin) {\n   395→      return advice.tooLow;\n   396→    }\n   397→  }\n   398→\n   399→  // Default fallback\n   400→  if (value > idealMax) {\n   401→    return `Value (${value.toFixed(2)}) is above the ideal range of ${idealMin.toFixed(1)}-${idealMax.toFixed(1)}.`;\n   402→  } else if (value < idealMin) {\n   403→    return `Value (${value.toFixed(2)}) is below the ideal range of ${idealMin.toFixed(1)}-${idealMax.toFixed(1)}.`;\n   404→  } else {\n   405→    return \"Value is within acceptable range but not optimal.\";\n   406→  }\n   407→}\n   408→\n   409→/**\n   410→ * Generate advice for a metric score result\n   411→ */\n   412→export function generateAdviceFromResult(result: MetricScoreResult): string {\n   413→  return generateAdvice(\n   414→    result.metricId,\n   415→    result.standardizedScore,\n   416→    result.value,\n   417→    result.idealMin,\n   418→    result.idealMax\n   419→  );\n   420→}\n   421→\n   422→// =============================================================================\n   423→// GAUSSIAN SCORING (matches Python implementation)\n   424→// =============================================================================\n   425→\n   426→/**\n   427→ * Calculate a score from 0-10 using Gaussian decay.\n   428→ * Matches the Python looksmax_engine.py implementation.\n   429→ *\n   430→ * @param value - The measured value\n   431→ * @param minRange - Minimum of ideal range\n   432→ * @param maxRange - Maximum of ideal range\n   433→ * @returns Score from 0-10\n   434→ */\n   435→export function calculateGaussianScore(\n   436→  value: number,\n   437→  minRange: number,\n   438→  maxRange: number\n   439→): number {\n   440→  // Within ideal range = perfect score\n   441→  if (value >= minRange && value <= maxRange) {\n   442→    return 10.0;\n   443→  }\n   444→\n   445→  let deviation: number;\n   446→  let target: number;\n   447→\n   448→  if (value < minRange) {\n   449→    deviation = minRange - value;\n   450→    target = minRange;\n   451→  } else {\n   452→    deviation = value - maxRange;\n   453→    target = maxRange;\n   454→  }\n   455→\n   456→  // Prevent division by zero\n   457→  if (target === 0) target = 1.0;\n   458→\n   459→  // Sigma is 10% of target value\n   460→  let sigma = Math.abs(target) * 0.1;\n   461→  if (sigma === 0) sigma = 1.0;\n   462→\n   463→  // Gaussian decay\n   464→  const score = 10.0 * Math.exp(-0.5 * Math.pow(deviation / sigma, 2));\n   465→  return Math.max(0.0, Math.min(10.0, score));\n   466→}\n   467→\n   468→// =============================================================================\n   469→// TOP/BOTTOM METRICS IDENTIFICATION\n   470→// =============================================================================\n   471→\n   472→export interface RankedMetric {\n   473→  metricId: string;\n   474→  name: string;\n   475→  value: number;\n   476→  score: number;\n   477→  idealMin: number;\n   478→  idealMax: number;\n   479→  advice: string;\n   480→  weightTier: 'high' | 'medium' | 'standard';\n   481→  category: string;\n   482→}\n   483→\n   484→/**\n   485→ * Get the top N metrics (strengths) sorted by score descending\n   486→ */\n   487→export function getTopMetrics(\n   488→  measurements: MetricScoreResult[],\n   489→  count: number = 3\n   490→): RankedMetric[] {\n   491→  return [...measurements]\n   492→    .sort((a, b) => b.standardizedScore - a.standardizedScore)\n   493→    .slice(0, count)\n   494→    .map((m) => ({\n   495→      metricId: m.metricId,\n   496→      name: m.name,\n   497→      value: m.value,\n   498→      score: m.standardizedScore,\n   499→      idealMin: m.idealMin,\n   500→      idealMax: m.idealMax,\n   501→      advice: generateAdviceFromResult(m),\n   502→      weightTier: getWeightTier(m.metricId),\n   503→      category: m.category,\n   504→    }));\n   505→}\n   506→\n   507→/**\n   508→ * Get the bottom N metrics (areas to improve) sorted by score ascending\n   509→ */\n   510→export function getBottomMetrics(\n   511→  measurements: MetricScoreResult[],\n   512→  count: number = 3\n   513→): RankedMetric[] {\n   514→  return [...measurements]\n   515→    .sort((a, b) => a.standardizedScore - b.standardizedScore)\n   516→    .slice(0, count)\n   517→    .map((m) => ({\n   518→      metricId: m.metricId,\n   519→      name: m.name,\n   520→      value: m.value,\n   521→      score: m.standardizedScore,\n   522→      idealMin: m.idealMin,\n   523→      idealMax: m.idealMax,\n   524→      advice: generateAdviceFromResult(m),\n   525→      weightTier: getWeightTier(m.metricId),\n   526→      category: m.category,\n   527→    }));\n   528→}\n   529→\n   530→// =============================================================================\n   531→// QUALITY & SEVERITY HELPERS\n   532→// =============================================================================\n   533→\n   534→/**\n   535→ * Get a human-readable quality description\n   536→ */\n   537→export function getQualityDescription(tier: QualityTier): string {\n   538→  switch (tier) {\n   539→    case 'ideal': return 'Ideal';\n   540→    case 'excellent': return 'Excellent';\n   541→    case 'good': return 'Good';\n   542→    case 'below_average': return 'Below Average';\n   543→  }\n   544→}\n   545→\n   546→/**\n   547→ * Get a human-readable severity description\n   548→ */\n   549→export function getSeverityDescription(severity: SeverityLevel): string {\n   550→  switch (severity) {\n   551→    case 'optimal': return 'Optimal';\n   552→    case 'minor': return 'Minor Deviation';\n   553→    case 'moderate': return 'Moderate Deviation';\n   554→    case 'major': return 'Major Deviation';\n   555→    case 'severe': return 'Severe Deviation';\n   556→    case 'extremely_severe': return 'Extremely Severe';\n   557→  }\n   558→}\n   559→\n   560→/**\n   561→ * Get severity color for UI display\n   562→ */\n   563→export function getSeverityColor(severity: SeverityLevel): string {\n   564→  switch (severity) {\n   565→    case 'optimal': return 'text-green-400';\n   566→    case 'minor': return 'text-lime-400';\n   567→    case 'moderate': return 'text-yellow-400';\n   568→    case 'major': return 'text-orange-400';\n   569→    case 'severe': return 'text-red-400';\n   570→    case 'extremely_severe': return 'text-red-600';\n   571→  }\n   572→}\n   573→\n   574→/**\n   575→ * Get weight tier badge color\n   576→ */\n   577→export function getWeightTierColor(tier: 'high' | 'medium' | 'standard'): string {\n   578→  switch (tier) {\n   579→    case 'high': return 'bg-purple-500/20 text-purple-400 border-purple-500/30';\n   580→    case 'medium': return 'bg-blue-500/20 text-blue-400 border-blue-500/30';\n   581→    case 'standard': return 'bg-gray-500/20 text-gray-400 border-gray-500/30';\n   582→  }\n   583→}\n   584→\n   585→/**\n   586→ * Get weight tier label\n   587→ */\n   588→export function getWeightTierLabel(tier: 'high' | 'medium' | 'standard'): string {\n   589→  switch (tier) {\n   590→    case 'high': return 'High Impact (3x)';\n   591→    case 'medium': return 'Medium Impact (2x)';\n   592→    case 'standard': return 'Standard';\n   593→  }\n   594→}\n   595→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2e5ca614-dac1-444b-846c-d86790eb0f07","timestamp":"2025-12-26T06:50:40.204Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/looksmax-scoring.ts","content":"/**\n * LOOKSMAX Scoring Engine\n * Ported from looksmax_engine.py - Presentation Layer\n *\n * Features:\n * - Weighted Harmony Score calculation (3.0x, 2.0x, 1.0x tiers)\n * - Metric-specific advice generation\n * - Gaussian scoring with exponential decay\n */\n\nimport type { MetricScoreResult, QualityTier, SeverityLevel } from './harmony-scoring';\n\n// =============================================================================\n// HARMONY SCORE WEIGHTS\n// =============================================================================\n\n/**\n * High Impact Metrics (3.0x weight)\n * Core facial harmony indicators that have the greatest effect on overall attractiveness\n */\nexport const HIGH_IMPACT_METRICS = new Set([\n  'faceWidthToHeight',\n  'midfaceRatio',\n  'lateralCanthalTilt',\n  'gonialAngle',\n  'mandibularPlaneAngle',\n  'chinToPhiltrumRatio',\n]);\n\n/**\n * Medium Impact Metrics (2.0x weight)\n * Secondary aesthetic factors\n */\nexport const MEDIUM_IMPACT_METRICS = new Set([\n  'noseBridgeToNoseWidth',\n  'nasolabialAngle',\n  'cheekboneHeight',\n  'ramusToMandibleRatio',\n]);\n\n/**\n * Get the weight multiplier for a metric\n */\nexport function getMetricWeight(metricId: string): number {\n  if (HIGH_IMPACT_METRICS.has(metricId)) return 3.0;\n  if (MEDIUM_IMPACT_METRICS.has(metricId)) return 2.0;\n  return 1.0;\n}\n\n/**\n * Get weight tier name for display\n */\nexport function getWeightTier(metricId: string): 'high' | 'medium' | 'standard' {\n  if (HIGH_IMPACT_METRICS.has(metricId)) return 'high';\n  if (MEDIUM_IMPACT_METRICS.has(metricId)) return 'medium';\n  return 'standard';\n}\n\n// =============================================================================\n// WEIGHTED HARMONY SCORE CALCULATION\n// =============================================================================\n\nexport interface HarmonyScoreResult {\n  /** Weighted harmony percentage (0-100%) */\n  harmonyPercentage: number;\n  /** Weighted average score (0-10 scale) */\n  weightedAverage: number;\n  /** Unweighted average for comparison */\n  unweightedAverage: number;\n  /** Breakdown by weight tier */\n  weightDistribution: {\n    highImpact: { count: number; avgScore: number };\n    mediumImpact: { count: number; avgScore: number };\n    standard: { count: number; avgScore: number };\n  };\n}\n\n/**\n * Calculate the weighted Harmony Score from scored measurements.\n * Uses 3-tier weighting: High (3x), Medium (2x), Standard (1x)\n *\n * Formula: Σ(Score × Weight) / Σ(Weights) → percentage\n */\nexport function calculateHarmonyScore(\n  measurements: Array<{ metricId: string; standardizedScore: number }>\n): HarmonyScoreResult {\n  let totalWeightedScore = 0;\n  let totalWeight = 0;\n  let unweightedTotal = 0;\n\n  const tiers = {\n    high: { total: 0, count: 0 },\n    medium: { total: 0, count: 0 },\n    standard: { total: 0, count: 0 },\n  };\n\n  for (const m of measurements) {\n    const weight = getMetricWeight(m.metricId);\n    const tier = getWeightTier(m.metricId);\n\n    totalWeightedScore += m.standardizedScore * weight;\n    totalWeight += weight;\n    unweightedTotal += m.standardizedScore;\n\n    tiers[tier].total += m.standardizedScore;\n    tiers[tier].count++;\n  }\n\n  const rawWeightedAverage = totalWeight > 0 ? totalWeightedScore / totalWeight : 0;\n  const rawUnweightedAverage = measurements.length > 0 ? unweightedTotal / measurements.length : 0;\n\n  // Clamp averages to 0-10 range to prevent any edge case overflows\n  const weightedAverage = Math.max(0, Math.min(10, rawWeightedAverage));\n  const unweightedAverage = Math.max(0, Math.min(10, rawUnweightedAverage));\n  const harmonyPercentage = Math.max(0, Math.min(100, (weightedAverage / 10) * 100));\n\n  // Helper to clamp tier averages to 0-10\n  const clampAvg = (total: number, count: number): number => {\n    if (count === 0) return 0;\n    return Math.max(0, Math.min(10, total / count));\n  };\n\n  return {\n    harmonyPercentage,\n    weightedAverage,\n    unweightedAverage,\n    weightDistribution: {\n      highImpact: {\n        count: tiers.high.count,\n        avgScore: clampAvg(tiers.high.total, tiers.high.count),\n      },\n      mediumImpact: {\n        count: tiers.medium.count,\n        avgScore: clampAvg(tiers.medium.total, tiers.medium.count),\n      },\n      standard: {\n        count: tiers.standard.count,\n        avgScore: clampAvg(tiers.standard.total, tiers.standard.count),\n      },\n    },\n  };\n}\n\n// =============================================================================\n// ADVICE ENGINE - METRIC-SPECIFIC FEEDBACK STRINGS\n// =============================================================================\n\ninterface AdviceEntry {\n  tooHigh: string;\n  tooLow: string;\n}\n\n/**\n * Comprehensive advice database for all metrics\n * Keys match metric IDs from harmony-scoring.ts\n */\nexport const ADVICE_DATABASE: Record<string, AdviceEntry> = {\n  // === HIGH IMPACT METRICS ===\n  faceWidthToHeight: {\n    tooHigh: \"Face appears wider. Consider hairstyles that add vertical length.\",\n    tooLow: \"Face is elongated. Hairstyles with side volume can add balance.\",\n  },\n  midfaceRatio: {\n    tooHigh: \"Midface is elongated. This can project maturity but may benefit from framing.\",\n    tooLow: \"Midface is compact. This is often a dimorphic and youthful trait.\",\n  },\n  lateralCanthalTilt: {\n    tooHigh: \"Eyes have significant positive tilt. Very dimorphic - no action needed.\",\n    tooLow: \"Eyes have negative tilt. Consider brow-maxxing or temporal area work.\",\n  },\n  gonialAngle: {\n    tooHigh: \"Jaw angle is steep (obtuse). Lowering body fat or chewing hard gum may improve definition.\",\n    tooLow: \"Jaw angle is very sharp. Strong masculine trait - no action typically needed.\",\n  },\n  mandibularPlaneAngle: {\n    tooHigh: \"Steep mandibular plane (long face type). May benefit from mewing or jaw work.\",\n    tooLow: \"Flat mandibular plane. This is typically a favorable trait.\",\n  },\n  chinToPhiltrumRatio: {\n    tooHigh: \"Chin is long relative to philtrum. Generally masculine; no action needed.\",\n    tooLow: \"Philtrum is long relative to chin. Upper lip lifting or chin augmentation options exist.\",\n  },\n\n  // === MEDIUM IMPACT METRICS ===\n  noseBridgeToNoseWidth: {\n    tooHigh: \"Nose appears narrow relative to bridge. This is typically favorable.\",\n    tooLow: \"Nose is wide relative to bridge. Nostril work can refine proportions.\",\n  },\n  nasolabialAngle: {\n    tooHigh: \"Nose tip points upward. Can appear more feminine; tip refinement may help.\",\n    tooLow: \"Nose tip points downward (droopy). Tip rotation procedures can improve profile.\",\n  },\n  cheekboneHeight: {\n    tooHigh: \"Cheekbones are exceptionally high. Very aesthetic - no action needed.\",\n    tooLow: \"Cheekbones are lower set. Malar augmentation or filler can enhance projection.\",\n  },\n  cheekFullness: {\n    tooHigh: \"Very full cheeks. Consider facial contouring if seeking a leaner look.\",\n    tooLow: \"Hollow or gaunt cheeks. Malar filler or fat grafting can restore volume.\",\n  },\n  ramusToMandibleRatio: {\n    tooHigh: \"Short mandibular body. Jaw angle implants may improve proportions.\",\n    tooLow: \"Long mandibular body. This is typically favorable for facial width.\",\n  },\n\n  // === FRONT PROFILE METRICS ===\n  jawSlope: {\n    tooHigh: \"Jaw slopes steeply. Consider gonial angle enhancement.\",\n    tooLow: \"Jaw has minimal slope. Strong horizontal projection is present.\",\n  },\n  totalFacialWidthToHeight: {\n    tooHigh: \"Face is very wide relative to height. Can appear robust/masculine.\",\n    tooLow: \"Face is very tall relative to width. Hairstyles with width can balance.\",\n  },\n  mouthWidthToNoseRatio: {\n    tooHigh: \"Wide mouth relative to nose. Typically attractive; no action needed.\",\n    tooLow: \"Narrow mouth relative to nose. Lip exercises may help.\",\n  },\n  lowerThirdProportion: {\n    tooHigh: \"Lower face is long. May benefit from vertical reduction options.\",\n    tooLow: \"Lower face is short. Chin augmentation can add vertical height.\",\n  },\n  ipsilateralAlarAngle: {\n    tooHigh: \"Nostril angle is wide. Alar reduction may refine the nose.\",\n    tooLow: \"Nostril angle is narrow. Typically favorable; no action needed.\",\n  },\n  jawFrontalAngle: {\n    tooHigh: \"Jaw is V-shaped. Gonial angle widening may add presence.\",\n    tooLow: \"Jaw is very U-shaped/wide. Strong masculine trait.\",\n  },\n  eyeAspectRatio: {\n    tooHigh: \"Eyes are horizontally elongated. Hunter eyes are typically desirable.\",\n    tooLow: \"Eyes are more round. Lateral canthoplasty can elongate.\",\n  },\n  bitemporalWidth: {\n    tooHigh: \"Wide temples relative to face. Full head of hair can balance.\",\n    tooLow: \"Narrow temples. Can appear more refined/gracile.\",\n  },\n  eyebrowLowSetedness: {\n    tooHigh: \"Brows are low-set (hooded). Creates intense look; browlift if too heavy.\",\n    tooLow: \"Brows are high-set. More open look; brow products can add fullness.\",\n  },\n  eyeSeparationRatio: {\n    tooHigh: \"Eyes are widely set. Creates softer look; no action typically needed.\",\n    tooLow: \"Eyes are closely set. Can appear intense; glasses can balance.\",\n  },\n  bigonialWidth: {\n    tooHigh: \"Wide jaw relative to cheekbones. Strong masculine trait.\",\n    tooLow: \"Narrow jaw relative to cheekbones. Jaw angle widening may add presence.\",\n  },\n  lowerToUpperLipRatio: {\n    tooHigh: \"Lower lip is much fuller. Very aesthetic; no action needed.\",\n    tooLow: \"Upper lip is fuller. Standard proportion; lip flip may balance.\",\n  },\n  eyebrowTilt: {\n    tooHigh: \"Brows tilt significantly upward. Can appear expressive.\",\n    tooLow: \"Brows are flat or downturned. Can appear more stoic.\",\n  },\n\n  // === SIDE PROFILE METRICS ===\n  recessionRelativeToFrankfort: {\n    tooHigh: \"Significant lower jaw recession. Advancement surgery may help.\",\n    tooLow: \"Jaw projects forward strongly. Very masculine; monitor overbite.\",\n  },\n  facialDepthToHeightRatio: {\n    tooHigh: \"Face is very deep relative to height. Strong forward growth.\",\n    tooLow: \"Face is flat relative to height. May benefit from midface/chin work.\",\n  },\n  interiorMidfaceProjectionAngle: {\n    tooHigh: \"Midface projects significantly. Strong forward growth.\",\n    tooLow: \"Flat midface. Cheekbone augmentation may improve profile.\",\n  },\n  nasofrontalAngle: {\n    tooHigh: \"Deep nasofrontal angle. Creates dramatic brow/nose transition.\",\n    tooLow: \"Shallow nasofrontal angle. Brow work may add definition.\",\n  },\n  gonionToMouthLine: {\n    tooHigh: \"Gonion is low relative to mouth. May appear long-faced.\",\n    tooLow: \"Gonion is high relative to mouth. Compact proportions.\",\n  },\n  lowerLipSLinePosition: {\n    tooHigh: \"Lower lip protrudes past S-line. May indicate maxillary retrusion.\",\n    tooLow: \"Lower lip is behind S-line. Well-balanced profile.\",\n  },\n  zAngle: {\n    tooHigh: \"Profile is very upright/vertical. May appear flat.\",\n    tooLow: \"Profile is convex. Standard Western ideal.\",\n  },\n  nasomentaAngle: {\n    tooHigh: \"Nose-chin line is obtuse. May indicate weak chin.\",\n    tooLow: \"Nose-chin line is acute. Strong chin projection.\",\n  },\n  submentalCervicalAngle: {\n    tooHigh: \"Weak chin-neck angle. May benefit from submental lipo or implant.\",\n    tooLow: \"Sharp chin-neck angle. Excellent definition.\",\n  },\n  nasofacialAngle: {\n    tooHigh: \"Large angle between nose and face. Strong nose or recessed face.\",\n    tooLow: \"Small angle. Well-integrated nose.\",\n  },\n  holdawayHLine: {\n    tooHigh: \"Lips project significantly. Monitor for bimax protrusion.\",\n    tooLow: \"Flat lip line. May appear retruded; filler can add volume.\",\n  },\n  mentolabialAngle: {\n    tooHigh: \"Deep mentolabial fold. Can appear aged; filler can soften.\",\n    tooLow: \"Shallow mentolabial fold. Youthful and balanced.\",\n  },\n  eLineLowerLip: {\n    tooHigh: \"Lower lip protrudes past E-line. May benefit from orthodontics.\",\n    tooLow: \"Lower lip is behind E-line. Balanced or retruded.\",\n  },\n  eLineUpperLip: {\n    tooHigh: \"Upper lip protrudes past E-line. May benefit from orthodontics.\",\n    tooLow: \"Upper lip is behind E-line. Balanced or retruded.\",\n  },\n  nasalTipAngle: {\n    tooHigh: \"Nose tip is rotated upward. Can appear feminine.\",\n    tooLow: \"Nose tip droops. Tip rotation surgery can improve.\",\n  },\n  nasalProjection: {\n    tooHigh: \"Large nose projection. Reduction rhinoplasty may refine.\",\n    tooLow: \"Minimal nose projection. Augmentation rhinoplasty may enhance.\",\n  },\n  nasalWToHRatio: {\n    tooHigh: \"Wide nose relative to height. Narrowing procedures exist.\",\n    tooLow: \"Narrow nose. Typically favorable; no action needed.\",\n  },\n  facialConvexityGlabella: {\n    tooHigh: \"Convex profile. Strong midface projection.\",\n    tooLow: \"Flat or concave profile. May benefit from augmentation.\",\n  },\n  facialConvexityNasion: {\n    tooHigh: \"Convex profile from nasion. Good forward growth.\",\n    tooLow: \"Straight or concave profile. May appear flat.\",\n  },\n  totalFacialConvexity: {\n    tooHigh: \"Very convex total profile. Midface is prominent.\",\n    tooLow: \"Flat total profile. Forward growth options may help.\",\n  },\n  upperForeheadSlope: {\n    tooHigh: \"Sloped forehead. More masculine/primal appearance.\",\n    tooLow: \"Upright forehead. More neotenous appearance.\",\n  },\n  browridgeInclinationAngle: {\n    tooHigh: \"Prominent browridge angle. Strong masculine trait.\",\n    tooLow: \"Flat browridge. Implants can add definition.\",\n  },\n  upperThirdProportion: {\n    tooHigh: \"Upper third is long. Large forehead; can be offset with hair styling.\",\n    tooLow: \"Upper third is short. Compact proportions.\",\n  },\n  middleThirdProportion: {\n    tooHigh: \"Middle third is long. May appear long-faced.\",\n    tooLow: \"Middle third is short. Compact midface.\",\n  },\n  chinProjection: {\n    tooHigh: \"Strong chin projection. Very masculine trait.\",\n    tooLow: \"Weak chin projection. Genioplasty or implant can improve.\",\n  },\n  lipRatio: {\n    tooHigh: \"Full lips. Typically attractive; no action needed.\",\n    tooLow: \"Thin lips. Filler can add volume if desired.\",\n  },\n};\n\n/**\n * Generate personalized advice based on metric score and value position.\n *\n * @param metricId - The metric identifier\n * @param score - Score from 0-10\n * @param value - Actual measured value\n * @param idealMin - Minimum of ideal range\n * @param idealMax - Maximum of ideal range\n * @returns Advice string for the metric\n */\nexport function generateAdvice(\n  metricId: string,\n  score: number,\n  value: number,\n  idealMin: number,\n  idealMax: number\n): string {\n  // Perfect score - no action needed\n  if (score >= 9.0) {\n    return \"Ideal proportions. No action needed.\";\n  }\n\n  // Get advice from database\n  const advice = ADVICE_DATABASE[metricId];\n  if (advice) {\n    if (value > idealMax) {\n      return advice.tooHigh;\n    } else if (value < idealMin) {\n      return advice.tooLow;\n    }\n  }\n\n  // Default fallback\n  if (value > idealMax) {\n    return `Value (${value.toFixed(2)}) is above the ideal range of ${idealMin.toFixed(1)}-${idealMax.toFixed(1)}.`;\n  } else if (value < idealMin) {\n    return `Value (${value.toFixed(2)}) is below the ideal range of ${idealMin.toFixed(1)}-${idealMax.toFixed(1)}.`;\n  } else {\n    return \"Value is within acceptable range but not optimal.\";\n  }\n}\n\n/**\n * Generate advice for a metric score result\n */\nexport function generateAdviceFromResult(result: MetricScoreResult): string {\n  return generateAdvice(\n    result.metricId,\n    result.standardizedScore,\n    result.value,\n    result.idealMin,\n    result.idealMax\n  );\n}\n\n// =============================================================================\n// GAUSSIAN SCORING (matches Python implementation)\n// =============================================================================\n\n/**\n * Calculate a score from 0-10 using Gaussian decay.\n * Matches the Python looksmax_engine.py implementation.\n *\n * @param value - The measured value\n * @param minRange - Minimum of ideal range\n * @param maxRange - Maximum of ideal range\n * @returns Score from 0-10\n */\nexport function calculateGaussianScore(\n  value: number,\n  minRange: number,\n  maxRange: number\n): number {\n  // Within ideal range = perfect score\n  if (value >= minRange && value <= maxRange) {\n    return 10.0;\n  }\n\n  let deviation: number;\n  let target: number;\n\n  if (value < minRange) {\n    deviation = minRange - value;\n    target = minRange;\n  } else {\n    deviation = value - maxRange;\n    target = maxRange;\n  }\n\n  // Prevent division by zero\n  if (target === 0) target = 1.0;\n\n  // Sigma is 10% of target value\n  let sigma = Math.abs(target) * 0.1;\n  if (sigma === 0) sigma = 1.0;\n\n  // Gaussian decay\n  const score = 10.0 * Math.exp(-0.5 * Math.pow(deviation / sigma, 2));\n  return Math.max(0.0, Math.min(10.0, score));\n}\n\n// =============================================================================\n// TOP/BOTTOM METRICS IDENTIFICATION\n// =============================================================================\n\nexport interface RankedMetric {\n  metricId: string;\n  name: string;\n  value: number;\n  score: number;\n  idealMin: number;\n  idealMax: number;\n  advice: string;\n  weightTier: 'high' | 'medium' | 'standard';\n  category: string;\n}\n\n/**\n * Get the top N metrics (strengths) sorted by score descending\n */\nexport function getTopMetrics(\n  measurements: MetricScoreResult[],\n  count: number = 3\n): RankedMetric[] {\n  return [...measurements]\n    .sort((a, b) => b.standardizedScore - a.standardizedScore)\n    .slice(0, count)\n    .map((m) => ({\n      metricId: m.metricId,\n      name: m.name,\n      value: m.value,\n      score: m.standardizedScore,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      advice: generateAdviceFromResult(m),\n      weightTier: getWeightTier(m.metricId),\n      category: m.category,\n    }));\n}\n\n/**\n * Get the bottom N metrics (areas to improve) sorted by score ascending\n */\nexport function getBottomMetrics(\n  measurements: MetricScoreResult[],\n  count: number = 3\n): RankedMetric[] {\n  return [...measurements]\n    .sort((a, b) => a.standardizedScore - b.standardizedScore)\n    .slice(0, count)\n    .map((m) => ({\n      metricId: m.metricId,\n      name: m.name,\n      value: m.value,\n      score: m.standardizedScore,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      advice: generateAdviceFromResult(m),\n      weightTier: getWeightTier(m.metricId),\n      category: m.category,\n    }));\n}\n\n// =============================================================================\n// QUALITY & SEVERITY HELPERS\n// =============================================================================\n\n/**\n * Get a human-readable quality description\n */\nexport function getQualityDescription(tier: QualityTier): string {\n  switch (tier) {\n    case 'ideal': return 'Ideal';\n    case 'excellent': return 'Excellent';\n    case 'good': return 'Good';\n    case 'below_average': return 'Below Average';\n  }\n}\n\n/**\n * Get a human-readable severity description\n */\nexport function getSeverityDescription(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'optimal': return 'Optimal';\n    case 'minor': return 'Minor Deviation';\n    case 'moderate': return 'Moderate Deviation';\n    case 'major': return 'Major Deviation';\n    case 'severe': return 'Severe Deviation';\n    case 'extremely_severe': return 'Extremely Severe';\n  }\n}\n\n/**\n * Get severity color for UI display\n */\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'optimal': return 'text-green-400';\n    case 'minor': return 'text-lime-400';\n    case 'moderate': return 'text-yellow-400';\n    case 'major': return 'text-orange-400';\n    case 'severe': return 'text-red-400';\n    case 'extremely_severe': return 'text-red-600';\n  }\n}\n\n/**\n * Get weight tier badge color\n */\nexport function getWeightTierColor(tier: 'high' | 'medium' | 'standard'): string {\n  switch (tier) {\n    case 'high': return 'bg-purple-500/20 text-purple-400 border-purple-500/30';\n    case 'medium': return 'bg-blue-500/20 text-blue-400 border-blue-500/30';\n    case 'standard': return 'bg-gray-500/20 text-gray-400 border-gray-500/30';\n  }\n}\n\n/**\n * Get weight tier label\n */\nexport function getWeightTierLabel(tier: 'high' | 'medium' | 'standard'): string {\n  switch (tier) {\n    case 'high': return 'High Impact (3x)';\n    case 'medium': return 'Medium Impact (2x)';\n    case 'standard': return 'Standard';\n  }\n}\n","numLines":595,"startLine":1,"totalLines":595}}}
{"parentUuid":"2e5ca614-dac1-444b-846c-d86790eb0f07","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FjrhhEGFAKUxchUWpFWbyH","type":"tool_result","content":"     1→     1→/**\n     2→     2→ * Severity Classification System\n     3→     3→ * Classifies metric deviations into severity levels with treatment recommendations\n     4→     4→ */\n     5→     5→\n     6→     6→import { Severity, SeverityResult, SeverityThreshold, MetricIssueMapping, Gender } from './types';\n     7→     7→\n     8→     8→// ============================================\n     9→     9→// SEVERITY THRESHOLDS BY METRIC\n    10→    10→// ============================================\n    11→    11→\n    12→    12→export const SEVERITY_THRESHOLDS: SeverityThreshold[] = [\n    13→    13→  // FRONT PROFILE METRICS\n    14→    14→  {\n    15→    15→    metric: 'fwhr',\n    16→    16→    optimal: { min: 1.80, max: 2.00 },\n    17→    17→    mild: { min: 1.65, max: 2.15 },\n    18→    18→    moderate: { min: 1.55, max: 2.25 },\n    19→    19→    severe: { min: 0, max: Infinity },\n    20→    20→    unit: 'ratio',\n    21→    21→    higherIsBetter: false, // mid-range is ideal\n    22→    22→  },\n    23→    23→  {\n    24→    24→    metric: 'canthalTilt',\n    25→    25→    optimal: { min: 4, max: 8 },\n    26→    26→    mild: { min: 0, max: 10 },\n    27→    27→    moderate: { min: -2, max: 12 },\n    28→    28→    severe: { min: -Infinity, max: Infinity },\n    29→    29→    unit: 'degrees',\n    30→    30→    higherIsBetter: true,\n    31→    31→  },\n    32→    32→  {\n    33→    33→    metric: 'facialThirdsUpper',\n    34→    34→    optimal: { min: 30, max: 36 },\n    35→    35→    mild: { min: 27, max: 39 },\n    36→    36→    moderate: { min: 24, max: 42 },\n    37→    37→    severe: { min: 0, max: Infinity },\n    38→    38→    unit: 'percent',\n    39→    39→  },\n    40→    40→  {\n    41→    41→    metric: 'facialThirdsMiddle',\n    42→    42→    optimal: { min: 30, max: 36 },\n    43→    43→    mild: { min: 27, max: 39 },\n    44→    44→    moderate: { min: 24, max: 42 },\n    45→    45→    severe: { min: 0, max: Infinity },\n    46→    46→    unit: 'percent',\n    47→    47→  },\n    48→    48→  {\n    49→    49→    metric: 'facialThirdsLower',\n    50→    50→    optimal: { min: 30, max: 36 },\n    51→    51→    mild: { min: 27, max: 39 },\n    52→    52→    moderate: { min: 24, max: 42 },\n    53→    53→    severe: { min: 0, max: Infinity },\n    54→    54→    unit: 'percent',\n    55→    55→  },\n    56→    56→  {\n    57→    57→    metric: 'nasalIndex',\n    58→    58→    optimal: { min: 70, max: 85 },\n    59→    59→    mild: { min: 65, max: 90 },\n    60→    60→    moderate: { min: 60, max: 95 },\n    61→    61→    severe: { min: 0, max: Infinity },\n    62→    62→    unit: 'ratio',\n    63→    63→  },\n    64→    64→  {\n    65→    65→    metric: 'interpupillaryDistance',\n    66→    66→    optimal: { min: 44, max: 48 },\n    67→    67→    mild: { min: 42, max: 50 },\n    68→    68→    moderate: { min: 40, max: 52 },\n    69→    69→    severe: { min: 0, max: Infinity },\n    70→    70→    unit: 'percent',\n    71→    71→  },\n    72→    72→  {\n    73→    73→    metric: 'mouthWidth',\n    74→    74→    optimal: { min: 48, max: 54 },\n    75→    75→    mild: { min: 44, max: 58 },\n    76→    76→    moderate: { min: 40, max: 62 },\n    77→    77→    severe: { min: 0, max: Infinity },\n    78→    78→    unit: 'percent',\n    79→    79→  },\n    80→    80→  {\n    81→    81→    metric: 'lipRatio',\n    82→    82→    optimal: { min: 1.5, max: 2.0 },\n    83→    83→    mild: { min: 1.2, max: 2.3 },\n    84→    84→    moderate: { min: 1.0, max: 2.6 },\n    85→    85→    severe: { min: 0, max: Infinity },\n    86→    86→    unit: 'ratio',\n    87→    87→  },\n    88→    88→  {\n    89→    89→    metric: 'jawWidthRatio',\n    90→    90→    optimal: { min: 0.75, max: 0.80 },\n    91→    91→    mild: { min: 0.72, max: 0.83 },\n    92→    92→    moderate: { min: 0.68, max: 0.87 },\n    93→    93→    severe: { min: 0, max: Infinity },\n    94→    94→    unit: 'ratio',\n    95→    95→  },\n    96→    96→  {\n    97→    97→    metric: 'facialSymmetry',\n    98→    98→    optimal: { min: 95, max: 100 },\n    99→    99→    mild: { min: 90, max: 100 },\n   100→   100→    moderate: { min: 85, max: 100 },\n   101→   101→    severe: { min: 0, max: 100 },\n   102→   102→    unit: 'percent',\n   103→   103→    higherIsBetter: true,\n   104→   104→  },\n   105→   105→  {\n   106→   106→    metric: 'eyeSpacing',\n   107→   107→    optimal: { min: 0.95, max: 1.05 },\n   108→   108→    mild: { min: 0.90, max: 1.10 },\n   109→   109→    moderate: { min: 0.85, max: 1.15 },\n   110→   110→    severe: { min: 0, max: Infinity },\n   111→   111→    unit: 'ratio',\n   112→   112→  },\n   113→   113→  {\n   114→   114→    metric: 'noseWidth',\n   115→   115→    optimal: { min: 0.95, max: 1.05 },\n   116→   116→    mild: { min: 0.90, max: 1.10 },\n   117→   117→    moderate: { min: 0.85, max: 1.15 },\n   118→   118→    severe: { min: 0, max: Infinity },\n   119→   119→    unit: 'ratio',\n   120→   120→  },\n   121→   121→  {\n   122→   122→    metric: 'cheekboneWidth',\n   123→   123→    optimal: { min: 0.85, max: 0.92 },\n   124→   124→    mild: { min: 0.80, max: 0.97 },\n   125→   125→    moderate: { min: 0.75, max: 1.02 },\n   126→   126→    severe: { min: 0, max: Infinity },\n   127→   127→    unit: 'ratio',\n   128→   128→  },\n   129→   129→\n   130→   130→  // SIDE PROFILE METRICS\n   131→   131→  {\n   132→   132→    metric: 'gonialAngle',\n   133→   133→    optimal: { min: 120, max: 130 },\n   134→   134→    mild: { min: 115, max: 135 },\n   135→   135→    moderate: { min: 110, max: 140 },\n   136→   136→    severe: { min: 0, max: Infinity },\n   137→   137→    unit: 'degrees',\n   138→   138→  },\n   139→   139→  {\n   140→   140→    metric: 'nasolabialAngle',\n   141→   141→    optimal: { min: 95, max: 110 }, // Gender-adjusted in functions\n   142→   142→    mild: { min: 85, max: 115 },\n   143→   143→    moderate: { min: 80, max: 120 },\n   144→   144→    severe: { min: 0, max: Infinity },\n   145→   145→    unit: 'degrees',\n   146→   146→  },\n   147→   147→  {\n   148→   148→    metric: 'nasofrontalAngle',\n   149→   149→    optimal: { min: 130, max: 140 },\n   150→   150→    mild: { min: 125, max: 145 },\n   151→   151→    moderate: { min: 120, max: 150 },\n   152→   152→    severe: { min: 0, max: Infinity },\n   153→   153→    unit: 'degrees',\n   154→   154→  },\n   155→   155→  {\n   156→   156→    metric: 'chinProjection',\n   157→   157→    optimal: { min: -4, max: 2 },\n   158→   158→    mild: { min: -6, max: 4 },\n   159→   159→    moderate: { min: -8, max: 6 },\n   160→   160→    severe: { min: -Infinity, max: Infinity },\n   161→   161→    unit: 'mm',\n   162→   162→  },\n   163→   163→  {\n   164→   164→    metric: 'mentoLabialAngle',\n   165→   165→    optimal: { min: 110, max: 130 },\n   166→   166→    mild: { min: 100, max: 140 },\n   167→   167→    moderate: { min: 90, max: 150 },\n   168→   168→    severe: { min: 0, max: Infinity },\n   169→   169→    unit: 'degrees',\n   170→   170→  },\n   171→   171→  {\n   172→   172→    metric: 'facialConvexity',\n   173→   173→    optimal: { min: 165, max: 175 },\n   174→   174→    mild: { min: 160, max: 180 },\n   175→   175→    moderate: { min: 155, max: 185 },\n   176→   176→    severe: { min: 0, max: Infinity },\n   177→   177→    unit: 'degrees',\n   178→   178→  },\n   179→   179→  {\n   180→   180→    metric: 'eLineUpperLip',\n   181→   181→    optimal: { min: -4, max: -1 },\n   182→   182→    mild: { min: -6, max: 1 },\n   183→   183→    moderate: { min: -8, max: 3 },\n   184→   184→    severe: { min: -Infinity, max: Infinity },\n   185→   185→    unit: 'mm',\n   186→   186→  },\n   187→   187→  {\n   188→   188→    metric: 'eLineLowerLip',\n   189→   189→    optimal: { min: -2, max: 1 },\n   190→   190→    mild: { min: -4, max: 3 },\n   191→   191→    moderate: { min: -6, max: 5 },\n   192→   192→    severe: { min: -Infinity, max: Infinity },\n   193→   193→    unit: 'mm',\n   194→   194→  },\n   195→   195→  {\n   196→   196→    metric: 'submCervicalAngle',\n   197→   197→    optimal: { min: 100, max: 120 },\n   198→   198→    mild: { min: 90, max: 130 },\n   199→   199→    moderate: { min: 80, max: 140 },\n   200→   200→    severe: { min: 0, max: Infinity },\n   201→   201→    unit: 'degrees',\n   202→   202→  },\n   203→   203→  {\n   204→   204→    metric: 'totalFacialConvexity',\n   205→   205→    optimal: { min: 135, max: 145 },\n   206→   206→    mild: { min: 130, max: 150 },\n   207→   207→    moderate: { min: 125, max: 155 },\n   208→   208→    severe: { min: 0, max: Infinity },\n   209→   209→    unit: 'degrees',\n   210→   210→  },\n   211→   211→];\n   212→   212→\n   213→   213→// ============================================\n   214→   214→// METRIC TO ISSUE MAPPINGS\n   215→   215→// ============================================\n   216→   216→\n   217→   217→export const METRIC_ISSUE_MAPPINGS: MetricIssueMapping[] = [\n   218→   218→  // Front Profile\n   219→   219→  {\n   220→   220→    metric: 'fwhr',\n   221→   221→    lowIssue: 'narrow_face',\n   222→   222→    highIssue: 'wide_face',\n   223→   223→    lowTreatments: ['cheek_filler', 'cheek_implants', 'jaw_implants'],\n   224→   224→    highTreatments: ['botox_masseter', 'buccal_fat_removal', 'zygoma_reduction', 'mandible_reduction'],\n   225→   225→  },\n   226→   226→  {\n   227→   227→    metric: 'canthalTilt',\n   228→   228→    lowIssue: 'negative_canthal_tilt',\n   229→   229→    highIssue: 'excessive_positive_tilt',\n   230→   230→    lowTreatments: ['canthoplasty', 'pdo_threads', 'botox_brow_lift'],\n   231→   231→    highTreatments: [], // Rarely treated\n   232→   232→  },\n   233→   233→  {\n   234→   234→    metric: 'nasalIndex',\n   235→   235→    lowIssue: 'narrow_nose',\n   236→   236→    highIssue: 'wide_nose',\n   237→   237→    lowTreatments: ['nose_filler'],\n   238→   238→    highTreatments: ['rhinoplasty_reduction', 'nose_filler'],\n   239→   239→  },\n   240→   240→  {\n   241→   241→    metric: 'lipRatio',\n   242→   242→    lowIssue: 'thin_lower_lip',\n   243→   243→    highIssue: 'thin_upper_lip',\n   244→   244→    lowTreatments: ['lip_filler'],\n   245→   245→    highTreatments: ['lip_filler', 'lip_lift'],\n   246→   246→  },\n   247→   247→  {\n   248→   248→    metric: 'jawWidthRatio',\n   249→   249→    lowIssue: 'narrow_jaw',\n   250→   250→    highIssue: 'wide_jaw',\n   251→   251→    lowTreatments: ['jaw_implants', 'jawline_filler'],\n   252→   252→    highTreatments: ['botox_masseter', 'mandible_reduction'],\n   253→   253→  },\n   254→   254→  {\n   255→   255→    metric: 'facialSymmetry',\n   256→   256→    lowIssue: 'facial_asymmetry',\n   257→   257→    highIssue: 'optimal',\n   258→   258→    lowTreatments: ['filler_correction', 'botox_asymmetry', 'bimax'],\n   259→   259→    highTreatments: [],\n   260→   260→  },\n   261→   261→  {\n   262→   262→    metric: 'cheekboneWidth',\n   263→   263→    lowIssue: 'flat_cheeks',\n   264→   264→    highIssue: 'wide_cheekbones',\n   265→   265→    lowTreatments: ['cheek_filler', 'cheek_implants'],\n   266→   266→    highTreatments: ['zygoma_reduction'],\n   267→   267→  },\n   268→   268→\n   269→   269→  // Side Profile\n   270→   270→  {\n   271→   271→    metric: 'gonialAngle',\n   272→   272→    lowIssue: 'over_prominent_jaw',\n   273→   273→    highIssue: 'weak_jaw',\n   274→   274→    lowTreatments: ['mandible_reduction'],\n   275→   275→    highTreatments: ['jaw_implants', 'jawline_filler', 'bsso'],\n   276→   276→  },\n   277→   277→  {\n   278→   278→    metric: 'nasolabialAngle',\n   279→   279→    lowIssue: 'droopy_nose_tip',\n   280→   280→    highIssue: 'over_rotated_tip',\n   281→   281→    lowTreatments: ['rhinoplasty_tip', 'nose_filler'],\n   282→   282→    highTreatments: ['rhinoplasty_tip', 'rhinoplasty_reduction'],\n   283→   283→  },\n   284→   284→  {\n   285→   285→    metric: 'chinProjection',\n   286→   286→    lowIssue: 'recessed_chin',\n   287→   287→    highIssue: 'prominent_chin',\n   288→   288→    lowTreatments: ['genioplasty', 'chin_implant', 'chin_filler'],\n   289→   289→    highTreatments: ['genioplasty'],\n   290→   290→  },\n   291→   291→  {\n   292→   292→    metric: 'eLineUpperLip',\n   293→   293→    lowIssue: 'lips_retrude',\n   294→   294→    highIssue: 'lips_protrude',\n   295→   295→    lowTreatments: ['lip_filler', 'bimax'],\n   296→   296→    highTreatments: ['bimax', 'lip_reduction'],\n   297→   297→  },\n   298→   298→  {\n   299→   299→    metric: 'eLineLowerLip',\n   300→   300→    lowIssue: 'lips_retrude',\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3a94f895-db34-4c5f-b93f-ae28d2a93fbd","timestamp":"2025-12-26T06:50:40.205Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/.claude/projects/-Users-imorgado-LOOKSMAXX-looksmaxx-app/4e0d04e8-56ad-4bca-9e4b-36b62804ea66/tool-results/toolu_01UNP5zAaZP7cdDPe4qfCyvz.txt","content":"     1→/**\n     2→ * Severity Classification System\n     3→ * Classifies metric deviations into severity levels with treatment recommendations\n     4→ */\n     5→\n     6→import { Severity, SeverityResult, SeverityThreshold, MetricIssueMapping, Gender } from './types';\n     7→\n     8→// ============================================\n     9→// SEVERITY THRESHOLDS BY METRIC\n    10→// ============================================\n    11→\n    12→export const SEVERITY_THRESHOLDS: SeverityThreshold[] = [\n    13→  // FRONT PROFILE METRICS\n    14→  {\n    15→    metric: 'fwhr',\n    16→    optimal: { min: 1.80, max: 2.00 },\n    17→    mild: { min: 1.65, max: 2.15 },\n    18→    moderate: { min: 1.55, max: 2.25 },\n    19→    severe: { min: 0, max: Infinity },\n    20→    unit: 'ratio',\n    21→    higherIsBetter: false, // mid-range is ideal\n    22→  },\n    23→  {\n    24→    metric: 'canthalTilt',\n    25→    optimal: { min: 4, max: 8 },\n    26→    mild: { min: 0, max: 10 },\n    27→    moderate: { min: -2, max: 12 },\n    28→    severe: { min: -Infinity, max: Infinity },\n    29→    unit: 'degrees',\n    30→    higherIsBetter: true,\n    31→  },\n    32→  {\n    33→    metric: 'facialThirdsUpper',\n    34→    optimal: { min: 30, max: 36 },\n    35→    mild: { min: 27, max: 39 },\n    36→    moderate: { min: 24, max: 42 },\n    37→    severe: { min: 0, max: Infinity },\n    38→    unit: 'percent',\n    39→  },\n    40→  {\n    41→    metric: 'facialThirdsMiddle',\n    42→    optimal: { min: 30, max: 36 },\n    43→    mild: { min: 27, max: 39 },\n    44→    moderate: { min: 24, max: 42 },\n    45→    severe: { min: 0, max: Infinity },\n    46→    unit: 'percent',\n    47→  },\n    48→  {\n    49→    metric: 'facialThirdsLower',\n    50→    optimal: { min: 30, max: 36 },\n    51→    mild: { min: 27, max: 39 },\n    52→    moderate: { min: 24, max: 42 },\n    53→    severe: { min: 0, max: Infinity },\n    54→    unit: 'percent',\n    55→  },\n    56→  {\n    57→    metric: 'nasalIndex',\n    58→    optimal: { min: 70, max: 85 },\n    59→    mild: { min: 65, max: 90 },\n    60→    moderate: { min: 60, max: 95 },\n    61→    severe: { min: 0, max: Infinity },\n    62→    unit: 'ratio',\n    63→  },\n    64→  {\n    65→    metric: 'interpupillaryDistance',\n    66→    optimal: { min: 44, max: 48 },\n    67→    mild: { min: 42, max: 50 },\n    68→    moderate: { min: 40, max: 52 },\n    69→    severe: { min: 0, max: Infinity },\n    70→    unit: 'percent',\n    71→  },\n    72→  {\n    73→    metric: 'mouthWidth',\n    74→    optimal: { min: 48, max: 54 },\n    75→    mild: { min: 44, max: 58 },\n    76→    moderate: { min: 40, max: 62 },\n    77→    severe: { min: 0, max: Infinity },\n    78→    unit: 'percent',\n    79→  },\n    80→  {\n    81→    metric: 'lipRatio',\n    82→    optimal: { min: 1.5, max: 2.0 },\n    83→    mild: { min: 1.2, max: 2.3 },\n    84→    moderate: { min: 1.0, max: 2.6 },\n    85→    severe: { min: 0, max: Infinity },\n    86→    unit: 'ratio',\n    87→  },\n    88→  {\n    89→    metric: 'jawWidthRatio',\n    90→    optimal: { min: 0.75, max: 0.80 },\n    91→    mild: { min: 0.72, max: 0.83 },\n    92→    moderate: { min: 0.68, max: 0.87 },\n    93→    severe: { min: 0, max: Infinity },\n    94→    unit: 'ratio',\n    95→  },\n    96→  {\n    97→    metric: 'facialSymmetry',\n    98→    optimal: { min: 95, max: 100 },\n    99→    mild: { min: 90, max: 100 },\n   100→    moderate: { min: 85, max: 100 },\n   101→    severe: { min: 0, max: 100 },\n   102→    unit: 'percent',\n   103→    higherIsBetter: true,\n   104→  },\n   105→  {\n   106→    metric: 'eyeSpacing',\n   107→    optimal: { min: 0.95, max: 1.05 },\n   108→    mild: { min: 0.90, max: 1.10 },\n   109→    moderate: { min: 0.85, max: 1.15 },\n   110→    severe: { min: 0, max: Infinity },\n   111→    unit: 'ratio',\n   112→  },\n   113→  {\n   114→    metric: 'noseWidth',\n   115→    optimal: { min: 0.95, max: 1.05 },\n   116→    mild: { min: 0.90, max: 1.10 },\n   117→    moderate: { min: 0.85, max: 1.15 },\n   118→    severe: { min: 0, max: Infinity },\n   119→    unit: 'ratio',\n   120→  },\n   121→  {\n   122→    metric: 'cheekboneWidth',\n   123→    optimal: { min: 0.85, max: 0.92 },\n   124→    mild: { min: 0.80, max: 0.97 },\n   125→    moderate: { min: 0.75, max: 1.02 },\n   126→    severe: { min: 0, max: Infinity },\n   127→    unit: 'ratio',\n   128→  },\n   129→\n   130→  // SIDE PROFILE METRICS\n   131→  {\n   132→    metric: 'gonialAngle',\n   133→    optimal: { min: 120, max: 130 },\n   134→    mild: { min: 115, max: 135 },\n   135→    moderate: { min: 110, max: 140 },\n   136→    severe: { min: 0, max: Infinity },\n   137→    unit: 'degrees',\n   138→  },\n   139→  {\n   140→    metric: 'nasolabialAngle',\n   141→    optimal: { min: 95, max: 110 }, // Gender-adjusted in functions\n   142→    mild: { min: 85, max: 115 },\n   143→    moderate: { min: 80, max: 120 },\n   144→    severe: { min: 0, max: Infinity },\n   145→    unit: 'degrees',\n   146→  },\n   147→  {\n   148→    metric: 'nasofrontalAngle',\n   149→    optimal: { min: 130, max: 140 },\n   150→    mild: { min: 125, max: 145 },\n   151→    moderate: { min: 120, max: 150 },\n   152→    severe: { min: 0, max: Infinity },\n   153→    unit: 'degrees',\n   154→  },\n   155→  {\n   156→    metric: 'chinProjection',\n   157→    optimal: { min: -4, max: 2 },\n   158→    mild: { min: -6, max: 4 },\n   159→    moderate: { min: -8, max: 6 },\n   160→    severe: { min: -Infinity, max: Infinity },\n   161→    unit: 'mm',\n   162→  },\n   163→  {\n   164→    metric: 'mentoLabialAngle',\n   165→    optimal: { min: 110, max: 130 },\n   166→    mild: { min: 100, max: 140 },\n   167→    moderate: { min: 90, max: 150 },\n   168→    severe: { min: 0, max: Infinity },\n   169→    unit: 'degrees',\n   170→  },\n   171→  {\n   172→    metric: 'facialConvexity',\n   173→    optimal: { min: 165, max: 175 },\n   174→    mild: { min: 160, max: 180 },\n   175→    moderate: { min: 155, max: 185 },\n   176→    severe: { min: 0, max: Infinity },\n   177→    unit: 'degrees',\n   178→  },\n   179→  {\n   180→    metric: 'eLineUpperLip',\n   181→    optimal: { min: -4, max: -1 },\n   182→    mild: { min: -6, max: 1 },\n   183→    moderate: { min: -8, max: 3 },\n   184→    severe: { min: -Infinity, max: Infinity },\n   185→    unit: 'mm',\n   186→  },\n   187→  {\n   188→    metric: 'eLineLowerLip',\n   189→    optimal: { min: -2, max: 1 },\n   190→    mild: { min: -4, max: 3 },\n   191→    moderate: { min: -6, max: 5 },\n   192→    severe: { min: -Infinity, max: Infinity },\n   193→    unit: 'mm',\n   194→  },\n   195→  {\n   196→    metric: 'submCervicalAngle',\n   197→    optimal: { min: 100, max: 120 },\n   198→    mild: { min: 90, max: 130 },\n   199→    moderate: { min: 80, max: 140 },\n   200→    severe: { min: 0, max: Infinity },\n   201→    unit: 'degrees',\n   202→  },\n   203→  {\n   204→    metric: 'totalFacialConvexity',\n   205→    optimal: { min: 135, max: 145 },\n   206→    mild: { min: 130, max: 150 },\n   207→    moderate: { min: 125, max: 155 },\n   208→    severe: { min: 0, max: Infinity },\n   209→    unit: 'degrees',\n   210→  },\n   211→];\n   212→\n   213→// ============================================\n   214→// METRIC TO ISSUE MAPPINGS\n   215→// ============================================\n   216→\n   217→export const METRIC_ISSUE_MAPPINGS: MetricIssueMapping[] = [\n   218→  // Front Profile\n   219→  {\n   220→    metric: 'fwhr',\n   221→    lowIssue: 'narrow_face',\n   222→    highIssue: 'wide_face',\n   223→    lowTreatments: ['cheek_filler', 'cheek_implants', 'jaw_implants'],\n   224→    highTreatments: ['botox_masseter', 'buccal_fat_removal', 'zygoma_reduction', 'mandible_reduction'],\n   225→  },\n   226→  {\n   227→    metric: 'canthalTilt',\n   228→    lowIssue: 'negative_canthal_tilt',\n   229→    highIssue: 'excessive_positive_tilt',\n   230→    lowTreatments: ['canthoplasty', 'pdo_threads', 'botox_brow_lift'],\n   231→    highTreatments: [], // Rarely treated\n   232→  },\n   233→  {\n   234→    metric: 'nasalIndex',\n   235→    lowIssue: 'narrow_nose',\n   236→    highIssue: 'wide_nose',\n   237→    lowTreatments: ['nose_filler'],\n   238→    highTreatments: ['rhinoplasty_reduction', 'nose_filler'],\n   239→  },\n   240→  {\n   241→    metric: 'lipRatio',\n   242→    lowIssue: 'thin_lower_lip',\n   243→    highIssue: 'thin_upper_lip',\n   244→    lowTreatments: ['lip_filler'],\n   245→    highTreatments: ['lip_filler', 'lip_lift'],\n   246→  },\n   247→  {\n   248→    metric: 'jawWidthRatio',\n   249→    lowIssue: 'narrow_jaw',\n   250→    highIssue: 'wide_jaw',\n   251→    lowTreatments: ['jaw_implants', 'jawline_filler'],\n   252→    highTreatments: ['botox_masseter', 'mandible_reduction'],\n   253→  },\n   254→  {\n   255→    metric: 'facialSymmetry',\n   256→    lowIssue: 'facial_asymmetry',\n   257→    highIssue: 'optimal',\n   258→    lowTreatments: ['filler_correction', 'botox_asymmetry', 'bimax'],\n   259→    highTreatments: [],\n   260→  },\n   261→  {\n   262→    metric: 'cheekboneWidth',\n   263→    lowIssue: 'flat_cheeks',\n   264→    highIssue: 'wide_cheekbones',\n   265→    lowTreatments: ['cheek_filler', 'cheek_implants'],\n   266→    highTreatments: ['zygoma_reduction'],\n   267→  },\n   268→\n   269→  // Side Profile\n   270→  {\n   271→    metric: 'gonialAngle',\n   272→    lowIssue: 'over_prominent_jaw',\n   273→    highIssue: 'weak_jaw',\n   274→    lowTreatments: ['mandible_reduction'],\n   275→    highTreatments: ['jaw_implants', 'jawline_filler', 'bsso'],\n   276→  },\n   277→  {\n   278→    metric: 'nasolabialAngle',\n   279→    lowIssue: 'droopy_nose_tip',\n   280→    highIssue: 'over_rotated_tip',\n   281→    lowTreatments: ['rhinoplasty_tip', 'nose_filler'],\n   282→    highTreatments: ['rhinoplasty_tip', 'rhinoplasty_reduction'],\n   283→  },\n   284→  {\n   285→    metric: 'chinProjection',\n   286→    lowIssue: 'recessed_chin',\n   287→    highIssue: 'prominent_chin',\n   288→    lowTreatments: ['genioplasty', 'chin_implant', 'chin_filler'],\n   289→    highTreatments: ['genioplasty'],\n   290→  },\n   291→  {\n   292→    metric: 'eLineUpperLip',\n   293→    lowIssue: 'lips_retrude',\n   294→    highIssue: 'lips_protrude',\n   295→    lowTreatments: ['lip_filler', 'bimax'],\n   296→    highTreatments: ['bimax', 'lip_reduction'],\n   297→  },\n   298→  {\n   299→    metric: 'eLineLowerLip',\n   300→    lowIssue: 'lips_retrude',","numLines":300,"startLine":1,"totalLines":713}}}
{"parentUuid":"3a94f895-db34-4c5f-b93f-ae28d2a93fbd","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_011viVYB2whftGukfxc53Sa7","type":"message","role":"assistant","content":[{"type":"text","text":"I now have a comprehensive understanding of the codebase. Let me trace where scores exceed 10:\n\n## Bug Summary\nContributing ratios (e.g., \"short midface\", \"high cheekbones\") displayed in strength/flaw cards show scores exceeding 10/10.\n\n## Root Cause Analysis\n\nBased on my analysis of the code flow, I found **THREE LOCATIONS** where unclamped scores leak through:\n\n1. **`src/lib/insights-engine.ts:2583-2590`** - In `convertToStrength()`, the `responsibleRatios.score` is directly copied from `MatchedMetric.score` without clamping.\n\n2. **`src/lib/insights-engine.ts:2607-2617`** - In `convertToFlaw()`, the `responsibleRatios.score` is directly copied without clamping.\n\n3. **`src/contexts/ResultsContext.tsx:916-926`** and **`src/contexts/ResultsContext.tsx:1053-1066`** - In `generateStrengthsFromAnalysis()` and `generateFlawsFromAnalysis()`, the `responsibleRatios` are created from measurements without clamping the `score` field.\n\nThe root issue is that while `transformToRatio()` at line 134 properly clamps scores:\n```typescript\nconst clampedScore = Math.max(0, Math.min(10, result.standardizedScore));\n```\n\nThe `responsibleRatios` in strengths and flaws are created from `matchedMetrics` and `groupMeasurements` which use the raw `m.score` value that can exceed 10 due to Bezier curve overshoot or other edge cases.\n\nLet me implement the fix:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":14147,"cache_read_input_tokens":120640,"cache_creation":{"ephemeral_5m_input_tokens":14147,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUrX1Bwd2sowVxsYWvre","type":"assistant","uuid":"312cda97-0414-4132-a3b8-1b5bfcd3c5a1","timestamp":"2025-12-26T06:50:53.479Z"}
{"parentUuid":"312cda97-0414-4132-a3b8-1b5bfcd3c5a1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_011viVYB2whftGukfxc53Sa7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01G43UPoDo1CjPynh2bTjNQM","name":"TodoWrite","input":{"todos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"completed","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"completed","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"in_progress","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"pending","activeForm":"Verifying fix with lint and tsc"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":14147,"cache_read_input_tokens":120640,"cache_creation":{"ephemeral_5m_input_tokens":14147,"ephemeral_1h_input_tokens":0},"output_tokens":606,"service_tier":"standard"}},"requestId":"req_011CWUrX1Bwd2sowVxsYWvre","type":"assistant","uuid":"0493382d-2140-435a-ac3f-546b19b0cc63","timestamp":"2025-12-26T06:50:56.866Z"}
{"parentUuid":"0493382d-2140-435a-ac3f-546b19b0cc63","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01G43UPoDo1CjPynh2bTjNQM","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"ff3811e9-4715-480b-bae6-fa9ca2f3025d","timestamp":"2025-12-26T06:50:56.907Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"completed","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"completed","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"in_progress","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"pending","activeForm":"Verifying fix with lint and tsc"}]}}
{"parentUuid":"ff3811e9-4715-480b-bae6-fa9ca2f3025d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KPGjhKtbBzVvwBoMsWp8wS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GtcRknc63DqSFXVMkJJ7Na","name":"Read","input":{"file_path":"/Users/imorgado/.claude/projects/-Users-imorgado-LOOKSMAXX-looksmaxx-app/4e0d04e8-56ad-4bca-9e4b-36b62804ea66/tool-results/toolu_01S6UG7cx7zWeMwhC3VeQidX.txt"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":71482,"cache_read_input_tokens":12494,"cache_creation":{"ephemeral_5m_input_tokens":71482,"ephemeral_1h_input_tokens":0},"output_tokens":137,"service_tier":"standard"}},"requestId":"req_011CWUrYEPU65p6mH55npt1w","type":"assistant","uuid":"4b501288-833c-42bf-8f74-7170a09f8e19","timestamp":"2025-12-26T06:51:05.526Z"}
{"parentUuid":"4b501288-833c-42bf-8f74-7170a09f8e19","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"File content (34487 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","is_error":true,"tool_use_id":"toolu_01GtcRknc63DqSFXVMkJJ7Na"}]},"uuid":"6c0aba38-32c7-4002-9b19-0bfb07e75f68","timestamp":"2025-12-26T06:51:05.719Z","toolUseResult":"Error: File content (34487 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content."}
{"parentUuid":"6c0aba38-32c7-4002-9b19-0bfb07e75f68","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_014MBX1dHQXvcV7Vg9mpB3Mq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011cDb4shogaDexzM17LmLjE","name":"Read","input":{"file_path":"/Users/imorgado/.claude/projects/-Users-imorgado-LOOKSMAXX-looksmaxx-app/4e0d04e8-56ad-4bca-9e4b-36b62804ea66/tool-results/toolu_01S6UG7cx7zWeMwhC3VeQidX.txt","offset":1,"limit":600}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":200,"cache_read_input_tokens":83976,"cache_creation":{"ephemeral_5m_input_tokens":200,"ephemeral_1h_input_tokens":0},"output_tokens":20,"service_tier":"standard"}},"requestId":"req_011CWUrYuArC6p5cQYY2Mpz1","type":"assistant","uuid":"2a6f2e1e-516a-4481-a51a-6dec620ac2c0","timestamp":"2025-12-26T06:51:12.116Z"}
{"parentUuid":"2a6f2e1e-516a-4481-a51a-6dec620ac2c0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011cDb4shogaDexzM17LmLjE","type":"tool_result","content":"     1→     1→/**\n     2→     2→ * Insights Engine\n     3→     3→ *\n     4→     4→ * Processes insight definitions from insights.json and classifies them\n     5→     5→ * as strengths or areas of improvement based on user's metric scores.\n     6→     6→ *\n     7→     7→ * Logic:\n     8→     8→ * - For each insight definition, calculate average score of affected metrics\n     9→     9→ * - Weakness: if avg score < threshold → classify with severity label\n    10→    10→ * - Strength: if avg score > threshold → classify with grade label\n    11→    11→ *\n    12→    12→ * Z-Score Based 5-Tier Severity Logic:\n    13→    13→ * - Ideal (Green): User is inside the ideal range\n    14→    14→ * - Good (Blue): Within 0.5 Standard Deviation of the mean (|z| < 0.5)\n    15→    15→ * - Fair (Cyan): Between 0.5 and 1 Standard Deviation (0.5 ≤ |z| < 1)\n    16→    16→ * - Moderate (Yellow): Between 1 and 2 Standard Deviations (1 ≤ |z| < 2)\n    17→    17→ * - Severe (Red): More than 2 Standard Deviations away (|z| ≥ 2)\n    18→    18→ *\n    19→    19→ * Severity Labels (Weaknesses):\n    20→    20→ *   0-3 = \"Severe\"\n    21→    21→ *   3-5 = \"Moderate\"\n    22→    22→ *   5-7 = \"Minor\"\n    23→    23→ *\n    24→    24→ * Grade Labels (Strengths):\n    25→    25→ *   8-9   = \"Good\"\n    26→    26→ *   9-9.5 = \"Excellent\"\n    27→    27→ *   9.5-10 = \"Ideal\"\n    28→    28→ */\n    29→    29→\n    30→    30→import { Strength, Flaw } from '@/types/results';\n    31→    31→import { MetricScoreResult, METRIC_CONFIGS, isValueAcceptable } from '@/lib/harmony-scoring';\n    32→    32→\n    33→    33→// ============================================\n    34→    34→// MASTER SCORING DATABASE (Z-Score Based)\n    35→    35→// ============================================\n    36→    36→\n    37→    37→export type SeverityLevel = 'ideal' | 'good' | 'fair' | 'moderate' | 'severe';\n    38→    38→export type Gender = 'male' | 'female';\n    39→    39→export type Ethnicity = 'white' | 'black' | 'east_asian' | 'south_asian' | 'hispanic' | 'middle_eastern' | 'native_american' | 'pacific_islander';\n    40→    40→\n    41→    41→export interface MasterMetricConfig {\n    42→    42→  ideal: [number, number];  // [min, max] ideal range\n    43→    43→  mean: number;             // Population mean\n    44→    44→  std_dev: number;          // Standard deviation\n    45→    45→  flaws?: {\n    46→    46→    low?: string[];         // Flaws when value is too low\n    47→    47→    high?: string[];        // Flaws when value is too high\n    48→    48→  };\n    49→    49→}\n    50→    50→\n    51→    51→// Base/Default standards (White Male baseline)\n    52→    52→export const MASTER_SCORING_DB: Record<string, MasterMetricConfig> = {\n    53→    53→  // MIDFACE & PROPORTIONS\n    54→    54→  \"midface_ratio\": {\n    55→    55→    ideal: [0.97, 1.00],\n    56→    56→    mean: 1.0,\n    57→    57→    std_dev: 0.115,\n    58→    58→    flaws: { low: [\"Long midface\", \"Long upper jaw\"] }\n    59→    59→  },\n    60→    60→  \"faceWidthToHeight\": {\n    61→    61→    ideal: [1.30, 1.45],\n    62→    62→    mean: 1.38,\n    63→    63→    std_dev: 0.08,\n    64→    64→    flaws: {\n    65→    65→      low: [\"Overly long face\", \"Narrow face\"],\n    66→    66→      high: [\"Wide face\", \"Short face\"]\n    67→    67→    }\n    68→    68→  },\n    69→    69→  \"totalFacialWidthToHeight\": {\n    70→    70→    ideal: [1.25, 1.40],\n    71→    71→    mean: 1.33,\n    72→    72→    std_dev: 0.075,\n    73→    73→    flaws: {\n    74→    74→      low: [\"Long face shape\"],\n    75→    75→      high: [\"Wide face shape\"]\n    76→    76→    }\n    77→    77→  },\n    78→    78→  \"upperThirdProportion\": {\n    79→    79→    ideal: [0.30, 0.36],\n    80→    80→    mean: 0.33,\n    81→    81→    std_dev: 0.03,\n    82→    82→    flaws: {\n    83→    83→      low: [\"Short forehead\"],\n    84→    84→      high: [\"Long forehead\"]\n    85→    85→    }\n    86→    86→  },\n    87→    87→  \"middleThirdProportion\": {\n    88→    88→    ideal: [0.30, 0.36],\n    89→    89→    mean: 0.33,\n    90→    90→    std_dev: 0.03,\n    91→    91→    flaws: {\n    92→    92→      low: [\"Short midface\"],\n    93→    93→      high: [\"Long midface\"]\n    94→    94→    }\n    95→    95→  },\n    96→    96→  \"lowerThirdProportion\": {\n    97→    97→    ideal: [0.30, 0.36],\n    98→    98→    mean: 0.33,\n    99→    99→    std_dev: 0.03,\n   100→   100→    flaws: {\n   101→   101→      low: [\"Short lower face\"],\n   102→   102→      high: [\"Long lower face\"]\n   103→   103→    }\n   104→   104→  },\n   105→   105→\n   106→   106→  // EYE SPACING & IPD\n   107→   107→  \"eye_separation_ratio\": {\n   108→   108→    ideal: [0.45, 0.47],\n   109→   109→    mean: 0.46,\n   110→   110→    std_dev: 0.03,\n   111→   111→    flaws: {\n   112→   112→      low: [\"Close-set eyes\"],\n   113→   113→      high: [\"Wide-set eyes\"]\n   114→   114→    }\n   115→   115→  },\n   116→   116→  \"interpupillaryRatio\": {\n   117→   117→    ideal: [0.44, 0.48],\n   118→   118→    mean: 0.46,\n   119→   119→    std_dev: 0.025,\n   120→   120→    flaws: {\n   121→   121→      low: [\"Close-set eyes\"],\n   122→   122→      high: [\"Wide-set eyes\"]\n   123→   123→    }\n   124→   124→  },\n   125→   125→  \"oneEyeApartTest\": {\n   126→   126→    ideal: [0.95, 1.05],\n   127→   127→    mean: 1.0,\n   128→   128→    std_dev: 0.08,\n   129→   129→    flaws: {\n   130→   130→      low: [\"Close-set eyes\"],\n   131→   131→      high: [\"Wide-set eyes\"]\n   132→   132→    }\n   133→   133→  },\n   134→   134→  \"intercanthalWidth\": {\n   135→   135→    ideal: [30, 35],\n   136→   136→    mean: 32.5,\n   137→   137→    std_dev: 2.5,\n   138→   138→    flaws: {\n   139→   139→      low: [\"Narrow eye spacing\"],\n   140→   140→      high: [\"Wide eye spacing\"]\n   141→   141→    }\n   142→   142→  },\n   143→   143→\n   144→   144→  // EYE SHAPE & FEATURES\n   145→   145→  \"lateralCanthalTilt\": {\n   146→   146→    ideal: [6, 8],\n   147→   147→    mean: 5.0,\n   148→   148→    std_dev: 3.5,\n   149→   149→    flaws: {\n   150→   150→      low: [\"Negative canthal tilt\", \"Downturned eyes\"],\n   151→   151→      high: [\"Excessively upturned eyes\"]\n   152→   152→    }\n   153→   153→  },\n   154→   154→  \"eyeAspectRatio\": {\n   155→   155→    ideal: [0.30, 0.35],\n   156→   156→    mean: 0.32,\n   157→   157→    std_dev: 0.04,\n   158→   158→    flaws: {\n   159→   159→      low: [\"Narrow eyes\"],\n   160→   160→      high: [\"Round eyes\"]\n   161→   161→    }\n   162→   162→  },\n   163→   163→  \"palpebralFissureLength\": {\n   164→   164→    ideal: [28, 32],\n   165→   165→    mean: 30.0,\n   166→   166→    std_dev: 2.5,\n   167→   167→    flaws: {\n   168→   168→      low: [\"Small eyes\"],\n   169→   169→      high: [\"Large eyes\"]\n   170→   170→    }\n   171→   171→  },\n   172→   172→  \"eyeWidth\": {\n   173→   173→    ideal: [28, 32],\n   174→   174→    mean: 30.0,\n   175→   175→    std_dev: 2.0,\n   176→   176→    flaws: {\n   177→   177→      low: [\"Narrow eyes\"],\n   178→   178→      high: [\"Wide eyes\"]\n   179→   179→    }\n   180→   180→  },\n   181→   181→  \"upperEyelidExposure\": {\n   182→   182→    ideal: [0.5, 1.2],\n   183→   183→    mean: 0.85,\n   184→   184→    std_dev: 0.35,\n   185→   185→    flaws: {\n   186→   186→      low: [\"Hooded eyes\"],\n   187→   187→      high: [\"Excessive upper lid exposure\"]\n   188→   188→    }\n   189→   189→  },\n   190→   190→  \"tearTroughDepth\": {\n   191→   191→    ideal: [0.0, 0.3],\n   192→   192→    mean: 0.15,\n   193→   193→    std_dev: 0.15,\n   194→   194→    flaws: {\n   195→   195→      high: [\"Dark circles / Tear troughs\", \"Under-eye hollowness\"]\n   196→   196→    }\n   197→   197→  },\n   198→   198→\n   199→   199→  // JAW ANGLES & STRUCTURE\n   200→   200→  \"gonial_angle\": {\n   201→   201→    ideal: [115, 125],\n   202→   202→    mean: 118.0,\n   203→   203→    std_dev: 6.5,\n   204→   204→    flaws: {\n   205→   205→      high: [\"Weak/soft jaw structure\", \"Rounded jaw\"]\n   206→   206→    }\n   207→   207→  },\n   208→   208→  \"mandibularPlaneAngle\": {\n   209→   209→    ideal: [20, 28],\n   210→   210→    mean: 24.0,\n   211→   211→    std_dev: 4.0,\n   212→   212→    flaws: {\n   213→   213→      low: [\"Flat mandibular plane\"],\n   214→   214→      high: [\"Steep mandibular plane\", \"Hyper-divergent jaw\"]\n   215→   215→    }\n   216→   216→  },\n   217→   217→  \"jawFrontalAngle\": {\n   218→   218→    ideal: [125, 135],\n   219→   219→    mean: 130.0,\n   220→   220→    std_dev: 5.0,\n   221→   221→    flaws: {\n   222→   222→      low: [\"Steep jaw\"],\n   223→   223→      high: [\"Flat jaw angle\"]\n   224→   224→    }\n   225→   225→  },\n   226→   226→  \"jawSlope\": {\n   227→   227→    ideal: [25, 35],\n   228→   228→    mean: 30.0,\n   229→   229→    std_dev: 5.0,\n   230→   230→    flaws: {\n   231→   231→      low: [\"Flat jawline\"],\n   232→   232→      high: [\"Steep jawline\"]\n   233→   233→    }\n   234→   234→  },\n   235→   235→\n   236→   236→  // JAW WIDTH\n   237→   237→  \"jawWidthRatio\": {\n   238→   238→    ideal: [0.85, 0.95],\n   239→   239→    mean: 0.90,\n   240→   240→    std_dev: 0.05,\n   241→   241→    flaws: {\n   242→   242→      low: [\"Narrow jaw\"],\n   243→   243→      high: [\"Wide jaw\"]\n   244→   244→    }\n   245→   245→  },\n   246→   246→  \"bigonialWidth\": {\n   247→   247→    ideal: [110, 125],\n   248→   248→    mean: 117.5,\n   249→   249→    std_dev: 7.5,\n   250→   250→    flaws: {\n   251→   251→      low: [\"Narrow jaw width\"],\n   252→   252→      high: [\"Excessively wide jaw\"]\n   253→   253→    }\n   254→   254→  },\n   255→   255→\n   256→   256→  // CHEEKBONES\n   257→   257→  \"cheekbone_height\": {\n   258→   258→    ideal: [83.0, 100.0],\n   259→   259→    mean: 85.0,\n   260→   260→    std_dev: 5.0,\n   261→   261→    flaws: {\n   262→   262→      low: [\"Low-set cheekbones\", \"Flat midface\"]\n   263→   263→    }\n   264→   264→  },\n   265→   265→  \"cheekboneWidth\": {\n   266→   266→    ideal: [130, 145],\n   267→   267→    mean: 137.5,\n   268→   268→    std_dev: 7.5,\n   269→   269→    flaws: {\n   270→   270→      low: [\"Narrow cheekbones\"],\n   271→   271→      high: [\"Wide cheekbones\"]\n   272→   272→    }\n   273→   273→  },\n   274→   274→\n   275→   275→  // CHIN\n   276→   276→  \"chinPhiltrumRatio\": {\n   277→   277→    ideal: [1.8, 2.2],\n   278→   278→    mean: 2.0,\n   279→   279→    std_dev: 0.2,\n   280→   280→    flaws: {\n   281→   281→      low: [\"Recessed chin\", \"Short chin\"],\n   282→   282→      high: [\"Long chin\", \"Projected chin\"]\n   283→   283→    }\n   284→   284→  },\n   285→   285→  \"chinHeight\": {\n   286→   286→    ideal: [35, 45],\n   287→   287→    mean: 40.0,\n   288→   288→    std_dev: 5.0,\n   289→   289→    flaws: {\n   290→   290→      low: [\"Short chin\"],\n   291→   291→      high: [\"Long chin\"]\n   292→   292→    }\n   293→   293→  },\n   294→   294→  \"chinWidth\": {\n   295→   295→    ideal: [35, 45],\n   296→   296→    mean: 40.0,\n   297→   297→    std_dev: 5.0,\n   298→   298→    flaws: {\n   299→   299→      low: [\"Pointed/Narrow chin\"],\n   300→   300→      high: [\"Wide chin\"]\n   301→   301→    }\n   302→   302→  },\n   303→   303→\n   304→   304→  // NOSE ANGLES\n   305→   305→  \"nasalTipAngle\": {\n   306→   306→    ideal: [95, 115],\n   307→   307→    mean: 105.0,\n   308→   308→    std_dev: 10.0,\n   309→   309→    flaws: {\n   310→   310→      low: [\"Droopy nasal tip\"],\n   311→   311→      high: [\"Upturned nasal tip\"]\n   312→   312→    }\n   313→   313→  },\n   314→   314→  \"nasolabialAngle\": {\n   315→   315→    ideal: [95, 110],\n   316→   316→    mean: 102.5,\n   317→   317→    std_dev: 7.5,\n   318→   318→    flaws: {\n   319→   319→      low: [\"Droopy nasal tip\"],\n   320→   320→      high: [\"Upturned nose\"]\n   321→   321→    }\n   322→   322→  },\n   323→   323→  \"nasofrontalAngle\": {\n   324→   324→    ideal: [115, 135],\n   325→   325→    mean: 125.0,\n   326→   326→    std_dev: 10.0,\n   327→   327→    flaws: {\n   328→   328→      low: [\"Deep nasal root\"],\n   329→   329→      high: [\"Flat nasal root\"]\n   330→   330→    }\n   331→   331→  },\n   332→   332→  \"nasofacialAngle\": {\n   333→   333→    ideal: [30, 40],\n   334→   334→    mean: 35.0,\n   335→   335→    std_dev: 5.0,\n   336→   336→    flaws: {\n   337→   337→      low: [\"Flat nose profile\"],\n   338→   338→      high: [\"Overprojected nose\"]\n   339→   339→    }\n   340→   340→  },\n   341→   341→  \"nasomentaAngle\": {\n   342→   342→    ideal: [120, 135],\n   343→   343→    mean: 127.5,\n   344→   344→    std_dev: 7.5,\n   345→   345→    flaws: {\n   346→   346→      low: [\"Convex profile\"],\n   347→   347→      high: [\"Concave profile\"]\n   348→   348→    }\n   349→   349→  },\n   350→   350→\n   351→   351→  // NOSE WIDTH & PROPORTIONS\n   352→   352→  \"nasalIndex\": {\n   353→   353→    ideal: [65, 75],\n   354→   354→    mean: 70.0,\n   355→   355→    std_dev: 5.0,\n   356→   356→    flaws: {\n   357→   357→      low: [\"Narrow nose\"],\n   358→   358→      high: [\"Wide nose\", \"Bulbous nose\"]\n   359→   359→    }\n   360→   360→  },\n   361→   361→  \"noseWidth\": {\n   362→   362→    ideal: [35, 42],\n   363→   363→    mean: 38.5,\n   364→   364→    std_dev: 3.5,\n   365→   365→    flaws: {\n   366→   366→      low: [\"Narrow nose\"],\n   367→   367→      high: [\"Wide nasal base\"]\n   368→   368→    }\n   369→   369→  },\n   370→   370→  \"noseBridgeWidth\": {\n   371→   371→    ideal: [12, 18],\n   372→   372→    mean: 15.0,\n   373→   373→    std_dev: 3.0,\n   374→   374→    flaws: {\n   375→   375→      low: [\"Narrow nose bridge\"],\n   376→   376→      high: [\"Wide nose bridge\"]\n   377→   377→    }\n   378→   378→  },\n   379→   379→  \"nasalProjection\": {\n   380→   380→    ideal: [16, 22],\n   381→   381→    mean: 19.0,\n   382→   382→    std_dev: 3.0,\n   383→   383→    flaws: {\n   384→   384→      low: [\"Underprojected nose\"],\n   385→   385→      high: [\"Overprojected nose\"]\n   386→   386→    }\n   387→   387→  },\n   388→   388→  \"noseLengthRatio\": {\n   389→   389→    ideal: [0.45, 0.55],\n   390→   390→    mean: 0.50,\n   391→   391→    std_dev: 0.05,\n   392→   392→    flaws: {\n   393→   393→      low: [\"Short nose\"],\n   394→   394→      high: [\"Long nose\"]\n   395→   395→    }\n   396→   396→  },\n   397→   397→\n   398→   398→  // LIPS & PHILTRUM\n   399→   399→  \"lipRatio\": {\n   400→   400→    ideal: [1.4, 1.6],\n   401→   401→    mean: 1.5,\n   402→   402→    std_dev: 0.15,\n   403→   403→    flaws: {\n   404→   404→      low: [\"Thin upper lip\"],\n   405→   405→      high: [\"Thick upper lip\"]\n   406→   406→    }\n   407→   407→  },\n   408→   408→  \"philtrumLength\": {\n   409→   409→    ideal: [11, 15],\n   410→   410→    mean: 13.0,\n   411→   411→    std_dev: 2.0,\n   412→   412→    flaws: {\n   413→   413→      low: [\"Short philtrum\"],\n   414→   414→      high: [\"Long philtrum\"]\n   415→   415→    }\n   416→   416→  },\n   417→   417→  \"upperLipHeight\": {\n   418→   418→    ideal: [18, 24],\n   419→   419→    mean: 21.0,\n   420→   420→    std_dev: 3.0,\n   421→   421→    flaws: {\n   422→   422→      low: [\"Thin upper lip\"],\n   423→   423→      high: [\"Thick upper lip\"]\n   424→   424→    }\n   425→   425→  },\n   426→   426→  \"lipChinDistance\": {\n   427→   427→    ideal: [40, 50],\n   428→   428→    mean: 45.0,\n   429→   429→    std_dev: 5.0,\n   430→   430→    flaws: {\n   431→   431→      low: [\"Short lower third\"],\n   432→   432→      high: [\"Long lower third\"]\n   433→   433→    }\n   434→   434→  },\n   435→   435→  \"upperLipProjection\": {\n   436→   436→    ideal: [-2, 2],\n   437→   437→    mean: 0.0,\n   438→   438→    std_dev: 2.0,\n   439→   439→    flaws: {\n   440→   440→      low: [\"Recessed upper lip\"],\n   441→   441→      high: [\"Protruding upper lip\"]\n   442→   442→    }\n   443→   443→  },\n   444→   444→  \"lowerLipProjection\": {\n   445→   445→    ideal: [-1, 3],\n   446→   446→    mean: 1.0,\n   447→   447→    std_dev: 2.0,\n   448→   448→    flaws: {\n   449→   449→      low: [\"Recessed lower lip\"],\n   450→   450→      high: [\"Protruding lower lip\"]\n   451→   451→    }\n   452→   452→  },\n   453→   453→  \"cupidsBowDepth\": {\n   454→   454→    ideal: [3, 6],\n   455→   455→    mean: 4.5,\n   456→   456→    std_dev: 1.5,\n   457→   457→    flaws: {\n   458→   458→      low: [\"Flat cupid's bow\"],\n   459→   459→      high: [\"Pronounced cupid's bow\"]\n   460→   460→    }\n   461→   461→  },\n   462→   462→\n   463→   463→  // EYEBROWS\n   464→   464→  \"eyebrowHeight\": {\n   465→   465→    ideal: [8, 14],\n   466→   466→    mean: 11.0,\n   467→   467→    std_dev: 3.0,\n   468→   468→    flaws: {\n   469→   469→      low: [\"Low-set eyebrows\"],\n   470→   470→      high: [\"High eyebrows\"]\n   471→   471→    }\n   472→   472→  },\n   473→   473→  \"browLengthRatio\": {\n   474→   474→    ideal: [0.50, 0.60],\n   475→   475→    mean: 0.55,\n   476→   476→    std_dev: 0.05,\n   477→   477→    flaws: {\n   478→   478→      low: [\"Short eyebrows\"],\n   479→   479→      high: [\"Long eyebrows\"]\n   480→   480→    }\n   481→   481→  },\n   482→   482→  \"browLengthToFaceWidth\": {\n   483→   483→    ideal: [0.30, 0.38],\n   484→   484→    mean: 0.34,\n   485→   485→    std_dev: 0.04,\n   486→   486→    flaws: {\n   487→   487→      low: [\"Short eyebrows\"],\n   488→   488→      high: [\"Long eyebrows\"]\n   489→   489→    }\n   490→   490→  },\n   491→   491→  \"browridgeInclinationAngle\": {\n   492→   492→    ideal: [10, 20],\n   493→   493→    mean: 15.0,\n   494→   494→    std_dev: 5.0,\n   495→   495→    flaws: {\n   496→   496→      low: [\"Flat brow ridge\"],\n   497→   497→      high: [\"Prominent brow ridge\"]\n   498→   498→    }\n   499→   499→  },\n   500→   500→  \"eyebrowThickness\": {\n   501→   501→    ideal: [1.5, 3.0],\n   502→   502→    mean: 2.25,\n   503→   503→    std_dev: 0.75,\n   504→   504→    flaws: {\n   505→   505→      low: [\"Sparse/Weak eyebrows\"],\n   506→   506→      high: [\"Overly thick eyebrows\"]\n   507→   507→    }\n   508→   508→  },\n   509→   509→\n   510→   510→  // FOREHEAD\n   511→   511→  \"foreheadHeight\": {\n   512→   512→    ideal: [55, 70],\n   513→   513→    mean: 62.5,\n   514→   514→    std_dev: 7.5,\n   515→   515→    flaws: {\n   516→   516→      low: [\"Short forehead\"],\n   517→   517→      high: [\"Tall forehead\"]\n   518→   518→    }\n   519→   519→  },\n   520→   520→  \"bitemporalWidth\": {\n   521→   521→    ideal: [120, 135],\n   522→   522→    mean: 127.5,\n   523→   523→    std_dev: 7.5,\n   524→   524→    flaws: {\n   525→   525→      low: [\"Narrow forehead\"],\n   526→   526→      high: [\"Wide forehead\"]\n   527→   527→    }\n   528→   528→  },\n   529→   529→\n   530→   530→  // PROFILE & DEPTH\n   531→   531→  \"facialDepthToHeight\": {\n   532→   532→    ideal: [0.75, 0.85],\n   533→   533→    mean: 0.80,\n   534→   534→    std_dev: 0.05,\n   535→   535→    flaws: {\n   536→   536→      low: [\"Flat facial profile\"],\n   537→   537→      high: [\"Overprojected profile\"]\n   538→   538→    }\n   539→   539→  },\n   540→   540→  \"anteriorFacialDepth\": {\n   541→   541→    ideal: [115, 130],\n   542→   542→    mean: 122.5,\n   543→   543→    std_dev: 7.5,\n   544→   544→    flaws: {\n   545→   545→      low: [\"Shallow face depth\"],\n   546→   546→      high: [\"Deep face projection\"]\n   547→   547→    }\n   548→   548→  },\n   549→   549→  \"totalProfileAngle\": {\n   550→   550→    ideal: [165, 175],\n   551→   551→    mean: 170.0,\n   552→   552→    std_dev: 5.0,\n   553→   553→    flaws: {\n   554→   554→      low: [\"Convex profile\"],\n   555→   555→      high: [\"Concave profile\"]\n   556→   556→    }\n   557→   557→  },\n   558→   558→\n   559→   559→  // ASYMMETRY\n   560→   560→  \"facialAsymmetryIndex\": {\n   561→   561→    ideal: [0, 3],\n   562→   562→    mean: 2.0,\n   563→   563→    std_dev: 1.5,\n   564→   564→    flaws: {\n   565→   565→      high: [\"Facial asymmetry\"]\n   566→   566→    }\n   567→   567→  },\n   568→   568→  \"eyeAsymmetry\": {\n   569→   569→    ideal: [0, 2],\n   570→   570→    mean: 1.0,\n   571→   571→    std_dev: 1.0,\n   572→   572→    flaws: {\n   573→   573→      high: [\"Eye asymmetry\"]\n   574→   574→    }\n   575→   575→  },\n   576→   576→  \"jawAsymmetry\": {\n   577→   577→    ideal: [0, 3],\n   578→   578→    mean: 1.5,\n   579→   579→    std_dev: 1.5,\n   580→   580→    flaws: {\n   581→   581→      high: [\"Jaw asymmetry\"]\n   582→   582→    }\n   583→   583→  },\n   584→   584→\n   585→   585→  // OTHER\n   586→   586→  \"recessionFrankfort\": {\n   587→   587→    ideal: [-2, 2],\n   588→   588→    mean: 0.0,\n   589→   589→    std_dev: 2.0,\n   590→   590→    flaws: {\n   591→   591→      low: [\"Maxillary recession\"],\n   592→   592→      high: [\"Maxillary protrusion\"]\n   593→   593→    }\n   594→   594→  },\n   595→   595→  \"neckWidth\": {\n   596→   596→    ideal: [110, 130],\n   597→   597→    mean: 120.0,\n   598→   598→    std_dev: 10.0,\n   599→   599→    flaws: {\n   600→   600→      low: [\"Narrow neck\"],\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"77fdd869-29f2-4886-b237-74c21c22ada0","timestamp":"2025-12-26T06:51:12.243Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/.claude/projects/-Users-imorgado-LOOKSMAXX-looksmaxx-app/4e0d04e8-56ad-4bca-9e4b-36b62804ea66/tool-results/toolu_01S6UG7cx7zWeMwhC3VeQidX.txt","content":"     1→/**\n     2→ * Insights Engine\n     3→ *\n     4→ * Processes insight definitions from insights.json and classifies them\n     5→ * as strengths or areas of improvement based on user's metric scores.\n     6→ *\n     7→ * Logic:\n     8→ * - For each insight definition, calculate average score of affected metrics\n     9→ * - Weakness: if avg score < threshold → classify with severity label\n    10→ * - Strength: if avg score > threshold → classify with grade label\n    11→ *\n    12→ * Z-Score Based 5-Tier Severity Logic:\n    13→ * - Ideal (Green): User is inside the ideal range\n    14→ * - Good (Blue): Within 0.5 Standard Deviation of the mean (|z| < 0.5)\n    15→ * - Fair (Cyan): Between 0.5 and 1 Standard Deviation (0.5 ≤ |z| < 1)\n    16→ * - Moderate (Yellow): Between 1 and 2 Standard Deviations (1 ≤ |z| < 2)\n    17→ * - Severe (Red): More than 2 Standard Deviations away (|z| ≥ 2)\n    18→ *\n    19→ * Severity Labels (Weaknesses):\n    20→ *   0-3 = \"Severe\"\n    21→ *   3-5 = \"Moderate\"\n    22→ *   5-7 = \"Minor\"\n    23→ *\n    24→ * Grade Labels (Strengths):\n    25→ *   8-9   = \"Good\"\n    26→ *   9-9.5 = \"Excellent\"\n    27→ *   9.5-10 = \"Ideal\"\n    28→ */\n    29→\n    30→import { Strength, Flaw } from '@/types/results';\n    31→import { MetricScoreResult, METRIC_CONFIGS, isValueAcceptable } from '@/lib/harmony-scoring';\n    32→\n    33→// ============================================\n    34→// MASTER SCORING DATABASE (Z-Score Based)\n    35→// ============================================\n    36→\n    37→export type SeverityLevel = 'ideal' | 'good' | 'fair' | 'moderate' | 'severe';\n    38→export type Gender = 'male' | 'female';\n    39→export type Ethnicity = 'white' | 'black' | 'east_asian' | 'south_asian' | 'hispanic' | 'middle_eastern' | 'native_american' | 'pacific_islander';\n    40→\n    41→export interface MasterMetricConfig {\n    42→  ideal: [number, number];  // [min, max] ideal range\n    43→  mean: number;             // Population mean\n    44→  std_dev: number;          // Standard deviation\n    45→  flaws?: {\n    46→    low?: string[];         // Flaws when value is too low\n    47→    high?: string[];        // Flaws when value is too high\n    48→  };\n    49→}\n    50→\n    51→// Base/Default standards (White Male baseline)\n    52→export const MASTER_SCORING_DB: Record<string, MasterMetricConfig> = {\n    53→  // MIDFACE & PROPORTIONS\n    54→  \"midface_ratio\": {\n    55→    ideal: [0.97, 1.00],\n    56→    mean: 1.0,\n    57→    std_dev: 0.115,\n    58→    flaws: { low: [\"Long midface\", \"Long upper jaw\"] }\n    59→  },\n    60→  \"faceWidthToHeight\": {\n    61→    ideal: [1.30, 1.45],\n    62→    mean: 1.38,\n    63→    std_dev: 0.08,\n    64→    flaws: {\n    65→      low: [\"Overly long face\", \"Narrow face\"],\n    66→      high: [\"Wide face\", \"Short face\"]\n    67→    }\n    68→  },\n    69→  \"totalFacialWidthToHeight\": {\n    70→    ideal: [1.25, 1.40],\n    71→    mean: 1.33,\n    72→    std_dev: 0.075,\n    73→    flaws: {\n    74→      low: [\"Long face shape\"],\n    75→      high: [\"Wide face shape\"]\n    76→    }\n    77→  },\n    78→  \"upperThirdProportion\": {\n    79→    ideal: [0.30, 0.36],\n    80→    mean: 0.33,\n    81→    std_dev: 0.03,\n    82→    flaws: {\n    83→      low: [\"Short forehead\"],\n    84→      high: [\"Long forehead\"]\n    85→    }\n    86→  },\n    87→  \"middleThirdProportion\": {\n    88→    ideal: [0.30, 0.36],\n    89→    mean: 0.33,\n    90→    std_dev: 0.03,\n    91→    flaws: {\n    92→      low: [\"Short midface\"],\n    93→      high: [\"Long midface\"]\n    94→    }\n    95→  },\n    96→  \"lowerThirdProportion\": {\n    97→    ideal: [0.30, 0.36],\n    98→    mean: 0.33,\n    99→    std_dev: 0.03,\n   100→    flaws: {\n   101→      low: [\"Short lower face\"],\n   102→      high: [\"Long lower face\"]\n   103→    }\n   104→  },\n   105→\n   106→  // EYE SPACING & IPD\n   107→  \"eye_separation_ratio\": {\n   108→    ideal: [0.45, 0.47],\n   109→    mean: 0.46,\n   110→    std_dev: 0.03,\n   111→    flaws: {\n   112→      low: [\"Close-set eyes\"],\n   113→      high: [\"Wide-set eyes\"]\n   114→    }\n   115→  },\n   116→  \"interpupillaryRatio\": {\n   117→    ideal: [0.44, 0.48],\n   118→    mean: 0.46,\n   119→    std_dev: 0.025,\n   120→    flaws: {\n   121→      low: [\"Close-set eyes\"],\n   122→      high: [\"Wide-set eyes\"]\n   123→    }\n   124→  },\n   125→  \"oneEyeApartTest\": {\n   126→    ideal: [0.95, 1.05],\n   127→    mean: 1.0,\n   128→    std_dev: 0.08,\n   129→    flaws: {\n   130→      low: [\"Close-set eyes\"],\n   131→      high: [\"Wide-set eyes\"]\n   132→    }\n   133→  },\n   134→  \"intercanthalWidth\": {\n   135→    ideal: [30, 35],\n   136→    mean: 32.5,\n   137→    std_dev: 2.5,\n   138→    flaws: {\n   139→      low: [\"Narrow eye spacing\"],\n   140→      high: [\"Wide eye spacing\"]\n   141→    }\n   142→  },\n   143→\n   144→  // EYE SHAPE & FEATURES\n   145→  \"lateralCanthalTilt\": {\n   146→    ideal: [6, 8],\n   147→    mean: 5.0,\n   148→    std_dev: 3.5,\n   149→    flaws: {\n   150→      low: [\"Negative canthal tilt\", \"Downturned eyes\"],\n   151→      high: [\"Excessively upturned eyes\"]\n   152→    }\n   153→  },\n   154→  \"eyeAspectRatio\": {\n   155→    ideal: [0.30, 0.35],\n   156→    mean: 0.32,\n   157→    std_dev: 0.04,\n   158→    flaws: {\n   159→      low: [\"Narrow eyes\"],\n   160→      high: [\"Round eyes\"]\n   161→    }\n   162→  },\n   163→  \"palpebralFissureLength\": {\n   164→    ideal: [28, 32],\n   165→    mean: 30.0,\n   166→    std_dev: 2.5,\n   167→    flaws: {\n   168→      low: [\"Small eyes\"],\n   169→      high: [\"Large eyes\"]\n   170→    }\n   171→  },\n   172→  \"eyeWidth\": {\n   173→    ideal: [28, 32],\n   174→    mean: 30.0,\n   175→    std_dev: 2.0,\n   176→    flaws: {\n   177→      low: [\"Narrow eyes\"],\n   178→      high: [\"Wide eyes\"]\n   179→    }\n   180→  },\n   181→  \"upperEyelidExposure\": {\n   182→    ideal: [0.5, 1.2],\n   183→    mean: 0.85,\n   184→    std_dev: 0.35,\n   185→    flaws: {\n   186→      low: [\"Hooded eyes\"],\n   187→      high: [\"Excessive upper lid exposure\"]\n   188→    }\n   189→  },\n   190→  \"tearTroughDepth\": {\n   191→    ideal: [0.0, 0.3],\n   192→    mean: 0.15,\n   193→    std_dev: 0.15,\n   194→    flaws: {\n   195→      high: [\"Dark circles / Tear troughs\", \"Under-eye hollowness\"]\n   196→    }\n   197→  },\n   198→\n   199→  // JAW ANGLES & STRUCTURE\n   200→  \"gonial_angle\": {\n   201→    ideal: [115, 125],\n   202→    mean: 118.0,\n   203→    std_dev: 6.5,\n   204→    flaws: {\n   205→      high: [\"Weak/soft jaw structure\", \"Rounded jaw\"]\n   206→    }\n   207→  },\n   208→  \"mandibularPlaneAngle\": {\n   209→    ideal: [20, 28],\n   210→    mean: 24.0,\n   211→    std_dev: 4.0,\n   212→    flaws: {\n   213→      low: [\"Flat mandibular plane\"],\n   214→      high: [\"Steep mandibular plane\", \"Hyper-divergent jaw\"]\n   215→    }\n   216→  },\n   217→  \"jawFrontalAngle\": {\n   218→    ideal: [125, 135],\n   219→    mean: 130.0,\n   220→    std_dev: 5.0,\n   221→    flaws: {\n   222→      low: [\"Steep jaw\"],\n   223→      high: [\"Flat jaw angle\"]\n   224→    }\n   225→  },\n   226→  \"jawSlope\": {\n   227→    ideal: [25, 35],\n   228→    mean: 30.0,\n   229→    std_dev: 5.0,\n   230→    flaws: {\n   231→      low: [\"Flat jawline\"],\n   232→      high: [\"Steep jawline\"]\n   233→    }\n   234→  },\n   235→\n   236→  // JAW WIDTH\n   237→  \"jawWidthRatio\": {\n   238→    ideal: [0.85, 0.95],\n   239→    mean: 0.90,\n   240→    std_dev: 0.05,\n   241→    flaws: {\n   242→      low: [\"Narrow jaw\"],\n   243→      high: [\"Wide jaw\"]\n   244→    }\n   245→  },\n   246→  \"bigonialWidth\": {\n   247→    ideal: [110, 125],\n   248→    mean: 117.5,\n   249→    std_dev: 7.5,\n   250→    flaws: {\n   251→      low: [\"Narrow jaw width\"],\n   252→      high: [\"Excessively wide jaw\"]\n   253→    }\n   254→  },\n   255→\n   256→  // CHEEKBONES\n   257→  \"cheekbone_height\": {\n   258→    ideal: [83.0, 100.0],\n   259→    mean: 85.0,\n   260→    std_dev: 5.0,\n   261→    flaws: {\n   262→      low: [\"Low-set cheekbones\", \"Flat midface\"]\n   263→    }\n   264→  },\n   265→  \"cheekboneWidth\": {\n   266→    ideal: [130, 145],\n   267→    mean: 137.5,\n   268→    std_dev: 7.5,\n   269→    flaws: {\n   270→      low: [\"Narrow cheekbones\"],\n   271→      high: [\"Wide cheekbones\"]\n   272→    }\n   273→  },\n   274→\n   275→  // CHIN\n   276→  \"chinPhiltrumRatio\": {\n   277→    ideal: [1.8, 2.2],\n   278→    mean: 2.0,\n   279→    std_dev: 0.2,\n   280→    flaws: {\n   281→      low: [\"Recessed chin\", \"Short chin\"],\n   282→      high: [\"Long chin\", \"Projected chin\"]\n   283→    }\n   284→  },\n   285→  \"chinHeight\": {\n   286→    ideal: [35, 45],\n   287→    mean: 40.0,\n   288→    std_dev: 5.0,\n   289→    flaws: {\n   290→      low: [\"Short chin\"],\n   291→      high: [\"Long chin\"]\n   292→    }\n   293→  },\n   294→  \"chinWidth\": {\n   295→    ideal: [35, 45],\n   296→    mean: 40.0,\n   297→    std_dev: 5.0,\n   298→    flaws: {\n   299→      low: [\"Pointed/Narrow chin\"],\n   300→      high: [\"Wide chin\"]\n   301→    }\n   302→  },\n   303→\n   304→  // NOSE ANGLES\n   305→  \"nasalTipAngle\": {\n   306→    ideal: [95, 115],\n   307→    mean: 105.0,\n   308→    std_dev: 10.0,\n   309→    flaws: {\n   310→      low: [\"Droopy nasal tip\"],\n   311→      high: [\"Upturned nasal tip\"]\n   312→    }\n   313→  },\n   314→  \"nasolabialAngle\": {\n   315→    ideal: [95, 110],\n   316→    mean: 102.5,\n   317→    std_dev: 7.5,\n   318→    flaws: {\n   319→      low: [\"Droopy nasal tip\"],\n   320→      high: [\"Upturned nose\"]\n   321→    }\n   322→  },\n   323→  \"nasofrontalAngle\": {\n   324→    ideal: [115, 135],\n   325→    mean: 125.0,\n   326→    std_dev: 10.0,\n   327→    flaws: {\n   328→      low: [\"Deep nasal root\"],\n   329→      high: [\"Flat nasal root\"]\n   330→    }\n   331→  },\n   332→  \"nasofacialAngle\": {\n   333→    ideal: [30, 40],\n   334→    mean: 35.0,\n   335→    std_dev: 5.0,\n   336→    flaws: {\n   337→      low: [\"Flat nose profile\"],\n   338→      high: [\"Overprojected nose\"]\n   339→    }\n   340→  },\n   341→  \"nasomentaAngle\": {\n   342→    ideal: [120, 135],\n   343→    mean: 127.5,\n   344→    std_dev: 7.5,\n   345→    flaws: {\n   346→      low: [\"Convex profile\"],\n   347→      high: [\"Concave profile\"]\n   348→    }\n   349→  },\n   350→\n   351→  // NOSE WIDTH & PROPORTIONS\n   352→  \"nasalIndex\": {\n   353→    ideal: [65, 75],\n   354→    mean: 70.0,\n   355→    std_dev: 5.0,\n   356→    flaws: {\n   357→      low: [\"Narrow nose\"],\n   358→      high: [\"Wide nose\", \"Bulbous nose\"]\n   359→    }\n   360→  },\n   361→  \"noseWidth\": {\n   362→    ideal: [35, 42],\n   363→    mean: 38.5,\n   364→    std_dev: 3.5,\n   365→    flaws: {\n   366→      low: [\"Narrow nose\"],\n   367→      high: [\"Wide nasal base\"]\n   368→    }\n   369→  },\n   370→  \"noseBridgeWidth\": {\n   371→    ideal: [12, 18],\n   372→    mean: 15.0,\n   373→    std_dev: 3.0,\n   374→    flaws: {\n   375→      low: [\"Narrow nose bridge\"],\n   376→      high: [\"Wide nose bridge\"]\n   377→    }\n   378→  },\n   379→  \"nasalProjection\": {\n   380→    ideal: [16, 22],\n   381→    mean: 19.0,\n   382→    std_dev: 3.0,\n   383→    flaws: {\n   384→      low: [\"Underprojected nose\"],\n   385→      high: [\"Overprojected nose\"]\n   386→    }\n   387→  },\n   388→  \"noseLengthRatio\": {\n   389→    ideal: [0.45, 0.55],\n   390→    mean: 0.50,\n   391→    std_dev: 0.05,\n   392→    flaws: {\n   393→      low: [\"Short nose\"],\n   394→      high: [\"Long nose\"]\n   395→    }\n   396→  },\n   397→\n   398→  // LIPS & PHILTRUM\n   399→  \"lipRatio\": {\n   400→    ideal: [1.4, 1.6],\n   401→    mean: 1.5,\n   402→    std_dev: 0.15,\n   403→    flaws: {\n   404→      low: [\"Thin upper lip\"],\n   405→      high: [\"Thick upper lip\"]\n   406→    }\n   407→  },\n   408→  \"philtrumLength\": {\n   409→    ideal: [11, 15],\n   410→    mean: 13.0,\n   411→    std_dev: 2.0,\n   412→    flaws: {\n   413→      low: [\"Short philtrum\"],\n   414→      high: [\"Long philtrum\"]\n   415→    }\n   416→  },\n   417→  \"upperLipHeight\": {\n   418→    ideal: [18, 24],\n   419→    mean: 21.0,\n   420→    std_dev: 3.0,\n   421→    flaws: {\n   422→      low: [\"Thin upper lip\"],\n   423→      high: [\"Thick upper lip\"]\n   424→    }\n   425→  },\n   426→  \"lipChinDistance\": {\n   427→    ideal: [40, 50],\n   428→    mean: 45.0,\n   429→    std_dev: 5.0,\n   430→    flaws: {\n   431→      low: [\"Short lower third\"],\n   432→      high: [\"Long lower third\"]\n   433→    }\n   434→  },\n   435→  \"upperLipProjection\": {\n   436→    ideal: [-2, 2],\n   437→    mean: 0.0,\n   438→    std_dev: 2.0,\n   439→    flaws: {\n   440→      low: [\"Recessed upper lip\"],\n   441→      high: [\"Protruding upper lip\"]\n   442→    }\n   443→  },\n   444→  \"lowerLipProjection\": {\n   445→    ideal: [-1, 3],\n   446→    mean: 1.0,\n   447→    std_dev: 2.0,\n   448→    flaws: {\n   449→      low: [\"Recessed lower lip\"],\n   450→      high: [\"Protruding lower lip\"]\n   451→    }\n   452→  },\n   453→  \"cupidsBowDepth\": {\n   454→    ideal: [3, 6],\n   455→    mean: 4.5,\n   456→    std_dev: 1.5,\n   457→    flaws: {\n   458→      low: [\"Flat cupid's bow\"],\n   459→      high: [\"Pronounced cupid's bow\"]\n   460→    }\n   461→  },\n   462→\n   463→  // EYEBROWS\n   464→  \"eyebrowHeight\": {\n   465→    ideal: [8, 14],\n   466→    mean: 11.0,\n   467→    std_dev: 3.0,\n   468→    flaws: {\n   469→      low: [\"Low-set eyebrows\"],\n   470→      high: [\"High eyebrows\"]\n   471→    }\n   472→  },\n   473→  \"browLengthRatio\": {\n   474→    ideal: [0.50, 0.60],\n   475→    mean: 0.55,\n   476→    std_dev: 0.05,\n   477→    flaws: {\n   478→      low: [\"Short eyebrows\"],\n   479→      high: [\"Long eyebrows\"]\n   480→    }\n   481→  },\n   482→  \"browLengthToFaceWidth\": {\n   483→    ideal: [0.30, 0.38],\n   484→    mean: 0.34,\n   485→    std_dev: 0.04,\n   486→    flaws: {\n   487→      low: [\"Short eyebrows\"],\n   488→      high: [\"Long eyebrows\"]\n   489→    }\n   490→  },\n   491→  \"browridgeInclinationAngle\": {\n   492→    ideal: [10, 20],\n   493→    mean: 15.0,\n   494→    std_dev: 5.0,\n   495→    flaws: {\n   496→      low: [\"Flat brow ridge\"],\n   497→      high: [\"Prominent brow ridge\"]\n   498→    }\n   499→  },\n   500→  \"eyebrowThickness\": {\n   501→    ideal: [1.5, 3.0],\n   502→    mean: 2.25,\n   503→    std_dev: 0.75,\n   504→    flaws: {\n   505→      low: [\"Sparse/Weak eyebrows\"],\n   506→      high: [\"Overly thick eyebrows\"]\n   507→    }\n   508→  },\n   509→\n   510→  // FOREHEAD\n   511→  \"foreheadHeight\": {\n   512→    ideal: [55, 70],\n   513→    mean: 62.5,\n   514→    std_dev: 7.5,\n   515→    flaws: {\n   516→      low: [\"Short forehead\"],\n   517→      high: [\"Tall forehead\"]\n   518→    }\n   519→  },\n   520→  \"bitemporalWidth\": {\n   521→    ideal: [120, 135],\n   522→    mean: 127.5,\n   523→    std_dev: 7.5,\n   524→    flaws: {\n   525→      low: [\"Narrow forehead\"],\n   526→      high: [\"Wide forehead\"]\n   527→    }\n   528→  },\n   529→\n   530→  // PROFILE & DEPTH\n   531→  \"facialDepthToHeight\": {\n   532→    ideal: [0.75, 0.85],\n   533→    mean: 0.80,\n   534→    std_dev: 0.05,\n   535→    flaws: {\n   536→      low: [\"Flat facial profile\"],\n   537→      high: [\"Overprojected profile\"]\n   538→    }\n   539→  },\n   540→  \"anteriorFacialDepth\": {\n   541→    ideal: [115, 130],\n   542→    mean: 122.5,\n   543→    std_dev: 7.5,\n   544→    flaws: {\n   545→      low: [\"Shallow face depth\"],\n   546→      high: [\"Deep face projection\"]\n   547→    }\n   548→  },\n   549→  \"totalProfileAngle\": {\n   550→    ideal: [165, 175],\n   551→    mean: 170.0,\n   552→    std_dev: 5.0,\n   553→    flaws: {\n   554→      low: [\"Convex profile\"],\n   555→      high: [\"Concave profile\"]\n   556→    }\n   557→  },\n   558→\n   559→  // ASYMMETRY\n   560→  \"facialAsymmetryIndex\": {\n   561→    ideal: [0, 3],\n   562→    mean: 2.0,\n   563→    std_dev: 1.5,\n   564→    flaws: {\n   565→      high: [\"Facial asymmetry\"]\n   566→    }\n   567→  },\n   568→  \"eyeAsymmetry\": {\n   569→    ideal: [0, 2],\n   570→    mean: 1.0,\n   571→    std_dev: 1.0,\n   572→    flaws: {\n   573→      high: [\"Eye asymmetry\"]\n   574→    }\n   575→  },\n   576→  \"jawAsymmetry\": {\n   577→    ideal: [0, 3],\n   578→    mean: 1.5,\n   579→    std_dev: 1.5,\n   580→    flaws: {\n   581→      high: [\"Jaw asymmetry\"]\n   582→    }\n   583→  },\n   584→\n   585→  // OTHER\n   586→  \"recessionFrankfort\": {\n   587→    ideal: [-2, 2],\n   588→    mean: 0.0,\n   589→    std_dev: 2.0,\n   590→    flaws: {\n   591→      low: [\"Maxillary recession\"],\n   592→      high: [\"Maxillary protrusion\"]\n   593→    }\n   594→  },\n   595→  \"neckWidth\": {\n   596→    ideal: [110, 130],\n   597→    mean: 120.0,\n   598→    std_dev: 10.0,\n   599→    flaws: {\n   600→      low: [\"Narrow neck\"],","numLines":600,"startLine":1,"totalLines":2648}}}
{"parentUuid":"77fdd869-29f2-4886-b237-74c21c22ada0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01E2wRwNNkDhN1BvAjtBW4w5","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me search for the `convertToStrength` and `convertToFlaw` functions specifically:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":9028,"cache_read_input_tokens":84176,"cache_creation":{"ephemeral_5m_input_tokens":9028,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUrZN47qjpEBoYvQp4VF","type":"assistant","uuid":"848a2469-10f5-4fe6-8820-83f97dabc5d0","timestamp":"2025-12-26T06:51:19.219Z"}
{"parentUuid":"848a2469-10f5-4fe6-8820-83f97dabc5d0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01E2wRwNNkDhN1BvAjtBW4w5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018BrrrRVEdwpp9FWvsAcPsj","name":"Grep","input":{"pattern":"export function convertToStrength|export function convertToFlaw","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":9028,"cache_read_input_tokens":84176,"cache_creation":{"ephemeral_5m_input_tokens":9028,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUrZN47qjpEBoYvQp4VF","type":"assistant","uuid":"98c5de6a-d09c-45f3-81d9-ca5a1db7e137","timestamp":"2025-12-26T06:51:21.313Z"}
{"parentUuid":"98c5de6a-d09c-45f3-81d9-ca5a1db7e137","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018BrrrRVEdwpp9FWvsAcPsj","type":"tool_result","content":"src/lib/insights-engine.ts:2571:export function convertToStrength(classified: ClassifiedStrength): Strength {\nsrc/lib/insights-engine.ts:2596:export function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {"}]},"uuid":"c04d8923-918c-4296-8162-ebf7cfbe4b1c","timestamp":"2025-12-26T06:51:21.909Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"src/lib/insights-engine.ts:2571:export function convertToStrength(classified: ClassifiedStrength): Strength {\nsrc/lib/insights-engine.ts:2596:export function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {","numLines":2}}
{"parentUuid":"c04d8923-918c-4296-8162-ebf7cfbe4b1c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01K5mXXf9Bdi2koQ5sLUGJXC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Pb9wFdwBun4rsFoFPqHaaU","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","offset":2565,"limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":249,"cache_read_input_tokens":93204,"cache_creation":{"ephemeral_5m_input_tokens":249,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWUra5LZcGAkD1zvD5kYE","type":"assistant","uuid":"1d7fbe29-8a39-4a9a-9f5b-381ddc953362","timestamp":"2025-12-26T06:51:27.617Z"}
{"parentUuid":"1d7fbe29-8a39-4a9a-9f5b-381ddc953362","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Pb9wFdwBun4rsFoFPqHaaU","type":"tool_result","content":"  2565→  return { strengths, weaknesses };\n  2566→}\n  2567→\n  2568→/**\n  2569→ * Convert ClassifiedStrength to Strength type for UI compatibility\n  2570→ */\n  2571→export function convertToStrength(classified: ClassifiedStrength): Strength {\n  2572→  return {\n  2573→    id: `insight_strength_${classified.insightId}`,\n  2574→    strengthName: `${classified.title} (${classified.gradeLabel})`,\n  2575→    summary: classified.description,\n  2576→    avgScore: classified.avgScore,\n  2577→    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n  2578→                  classified.grade === 'excellent' ? 'excellent' : 'good',\n  2579→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2580→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2581→      ratioName: m.metricName,\n  2582→      ratioId: m.metricId,\n  2583→      score: m.score,\n  2584→      value: m.value,\n  2585→      idealMin: m.idealMin,\n  2586→      idealMax: m.idealMax,\n  2587→      unit: m.unit,\n  2588→      category: m.category,\n  2589→    })),\n  2590→  };\n  2591→}\n  2592→\n  2593→/**\n  2594→ * Convert ClassifiedWeakness to Flaw type for UI compatibility\n  2595→ */\n  2596→export function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  2597→  const impact = (10 - classified.avgScore) * 0.5;\n  2598→  const newRollingLost = rollingLost + impact;\n  2599→\n  2600→  return {\n  2601→    id: `insight_flaw_${classified.insightId}`,\n  2602→    flawName: `${classified.title} (${classified.severityLabel})`,\n  2603→    summary: classified.description,\n  2604→    harmonyPercentageLost: impact,\n  2605→    standardizedImpact: impact / 10,\n  2606→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2607→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2608→      ratioName: m.metricName,\n  2609→      ratioId: m.metricId,\n  2610→      score: m.score,\n  2611→      value: m.value,\n  2612→      idealMin: m.idealMin,\n  2613→      idealMax: m.idealMax,\n  2614→      unit: m.unit,\n  2615→      category: m.category,\n  2616→    })),\n  2617→    rollingPointsDeducted: newRollingLost,\n  2618→    rollingHarmonyPercentageLost: newRollingLost,\n  2619→    rollingStandardizedImpact: newRollingLost / 10,\n  2620→  };\n  2621→}\n  2622→\n  2623→/**\n  2624→ * Main function: Generate strengths and flaws from measurements using insights\n  2625→ */\n  2626→export function generateInsightBasedResults(\n  2627→  measurements: MetricScoreResult[]\n  2628→): { strengths: Strength[]; flaws: Flaw[] } {\n  2629→  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);\n  2630→\n  2631→  // Convert to UI-compatible types\n  2632→  const strengths = classifiedStrengths.map((s) => convertToStrength(s));\n  2633→\n  2634→  let rollingLost = 0;\n  2635→  const flaws = classifiedWeaknesses.map((w, i) => {\n  2636→    const flaw = convertToFlaw(w, i, rollingLost);\n  2637→    rollingLost = flaw.rollingPointsDeducted || 0;\n  2638→    return flaw;\n  2639→  });\n  2640→\n  2641→  return { strengths, flaws };\n  2642→}\n  2643→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"230d6993-891f-4c1c-a1eb-f2ed84e1e20c","timestamp":"2025-12-26T06:51:27.697Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","content":"  return { strengths, weaknesses };\n}\n\n/**\n * Convert ClassifiedStrength to Strength type for UI compatibility\n */\nexport function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: classified.avgScore,\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  const impact = (10 - classified.avgScore) * 0.5;\n  const newRollingLost = rollingLost + impact;\n\n  return {\n    id: `insight_flaw_${classified.insightId}`,\n    flawName: `${classified.title} (${classified.severityLabel})`,\n    summary: classified.description,\n    harmonyPercentageLost: impact,\n    standardizedImpact: impact / 10,\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,\n    rollingHarmonyPercentageLost: newRollingLost,\n    rollingStandardizedImpact: newRollingLost / 10,\n  };\n}\n\n/**\n * Main function: Generate strengths and flaws from measurements using insights\n */\nexport function generateInsightBasedResults(\n  measurements: MetricScoreResult[]\n): { strengths: Strength[]; flaws: Flaw[] } {\n  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);\n\n  // Convert to UI-compatible types\n  const strengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n  let rollingLost = 0;\n  const flaws = classifiedWeaknesses.map((w, i) => {\n    const flaw = convertToFlaw(w, i, rollingLost);\n    rollingLost = flaw.rollingPointsDeducted || 0;\n    return flaw;\n  });\n\n  return { strengths, flaws };\n}\n","numLines":79,"startLine":2565,"totalLines":2643}}}
{"parentUuid":"230d6993-891f-4c1c-a1eb-f2ed84e1e20c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01N2HewAPRFrLszWQYWd2UVF","type":"message","role":"assistant","content":[{"type":"text","text":"Now I've identified all the locations. The issue is at:\n1. Line 2583 in `convertToStrength`: `score: m.score` - not clamped\n2. Line 2610 in `convertToFlaw`: `score: m.score` - not clamped\n3. Lines 916 and 1056 in `ResultsContext.tsx` - `score: m.score` not clamped\n\nLet me also check what else produces those scores by looking at the generator functions in ResultsContext:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1373,"cache_read_input_tokens":93453,"cache_creation":{"ephemeral_5m_input_tokens":1373,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUraW5M74uAewq97bYvj","type":"assistant","uuid":"5e8fce52-e403-4db6-b641-3f36f2e2c18b","timestamp":"2025-12-26T06:51:34.856Z"}
{"parentUuid":"5e8fce52-e403-4db6-b641-3f36f2e2c18b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01N2HewAPRFrLszWQYWd2UVF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NriuvEjZFestZAgXKAgUbh","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","offset":906,"limit":60}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1373,"cache_read_input_tokens":93453,"cache_creation":{"ephemeral_5m_input_tokens":1373,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUraW5M74uAewq97bYvj","type":"assistant","uuid":"74c0ea8e-c624-4bf0-859b-d9f3db80ca71","timestamp":"2025-12-26T06:51:36.333Z"}
{"parentUuid":"74c0ea8e-c624-4bf0-859b-d9f3db80ca71","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NriuvEjZFestZAgXKAgUbh","type":"tool_result","content":"   906→\n   907→      // Create grouped strength with multiple contributing ratios\n   908→      strengths.push({\n   909→        id: `strength_group_${groupId}`,\n   910→        strengthName: groupConfig.name,\n   911→        summary: groupConfig.description,\n   912→        avgScore,\n   913→        qualityLevel: bestQuality,\n   914→        categoryName: groupConfig.category,\n   915→        responsibleRatios: groupMeasurements.map(m => ({\n   916→          ratioName: m.name,\n   917→          ratioId: m.metricId,\n   918→          score: m.score,\n   919→          value: m.value,\n   920→          idealMin: m.idealMin,\n   921→          idealMax: m.idealMax,\n   922→          unit: m.unit,\n   923→          category: m.category,\n   924→        })),\n   925→      });\n   926→    }\n   927→  });\n   928→\n   929→  // Second pass: Add remaining individual strengths that weren't grouped\n   930→  analysis.strengths.forEach((s, i) => {\n   931→    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n   932→\n   933→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n   934→\n   935→    strengths.push({\n   936→      id: `strength_${i}`,\n   937→      strengthName: s.metricName,\n   938→      summary: s.reasoning,\n   939→      avgScore: matchingMeasurement?.score || 8,\n   940→      qualityLevel: s.qualityTier,\n   941→      categoryName: s.category,\n   942→      responsibleRatios: [{\n   943→        ratioName: s.metricName,\n   944→        ratioId: s.metricId,\n   945→        score: matchingMeasurement?.score || 8,\n   946→        value: s.value,\n   947→        idealMin: matchingMeasurement?.idealMin || 0,\n   948→        idealMax: matchingMeasurement?.idealMax || 1,\n   949→        unit: matchingMeasurement?.unit || 'ratio',\n   950→        category: s.category,\n   951→      }],\n   952→    });\n   953→  });\n   954→\n   955→  // Sort by average score (highest first) then by number of contributing ratios\n   956→  return strengths.sort((a, b) => {\n   957→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n   958→      return b.responsibleRatios.length - a.responsibleRatios.length;\n   959→    }\n   960→    return b.avgScore - a.avgScore;\n   961→  });\n   962→}\n   963→\n   964→// Flaw groupings - similar to strength groupings but for areas of improvement\n   965→const FLAW_GROUPINGS: Record<string, {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6edcd78b-cf4b-4503-98a4-1743c14ea320","timestamp":"2025-12-26T06:51:36.407Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","content":"\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: matchingMeasurement?.score || 8,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: matchingMeasurement?.score || 8,\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });\n\n  // Sort by average score (highest first) then by number of contributing ratios\n  return strengths.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.avgScore - a.avgScore;\n  });\n}\n\n// Flaw groupings - similar to strength groupings but for areas of improvement\nconst FLAW_GROUPINGS: Record<string, {","numLines":60,"startLine":906,"totalLines":1392}}}
{"parentUuid":"6edcd78b-cf4b-4503-98a4-1743c14ea320","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QgtSA6z1ePJPyKAWKQV8jE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013ecjvUz2C1McqXCSN7EdKN","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","offset":1040,"limit":65}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1216,"cache_read_input_tokens":94826,"cache_creation":{"ephemeral_5m_input_tokens":1216,"ephemeral_1h_input_tokens":0},"output_tokens":18,"service_tier":"standard"}},"requestId":"req_011CWUrb9X7FJ78wQccXwpe4","type":"assistant","uuid":"ce75aff5-18c4-4d7b-b773-82b6edc1033b","timestamp":"2025-12-26T06:51:43.036Z"}
{"parentUuid":"ce75aff5-18c4-4d7b-b773-82b6edc1033b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013ecjvUz2C1McqXCSN7EdKN","type":"tool_result","content":"  1040→\n  1041→      // Calculate total impact from all metrics in this group\n  1042→      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n  1043→      rollingLost += totalImpact;\n  1044→\n  1045→      // Create grouped flaw with multiple contributing ratios\n  1046→      flaws.push({\n  1047→        id: `flaw_group_${groupId}`,\n  1048→        flawName: groupConfig.name,\n  1049→        summary: groupConfig.description,\n  1050→        harmonyPercentageLost: totalImpact,\n  1051→        standardizedImpact: totalImpact / 10,\n  1052→        categoryName: groupConfig.category,\n  1053→        responsibleRatios: groupMeasurements.map(m => ({\n  1054→          ratioName: m.name,\n  1055→          ratioId: m.metricId,\n  1056→          score: m.score,\n  1057→          value: m.value,\n  1058→          idealMin: m.idealMin,\n  1059→          idealMax: m.idealMax,\n  1060→          unit: m.unit,\n  1061→          category: m.category,\n  1062→        })),\n  1063→        rollingPointsDeducted: rollingLost,\n  1064→        rollingHarmonyPercentageLost: rollingLost,\n  1065→        rollingStandardizedImpact: rollingLost / 10,\n  1066→      });\n  1067→    }\n  1068→  });\n  1069→\n  1070→  // Second pass: Add remaining individual flaws that weren't grouped\n  1071→  analysis.flaws.forEach((f, i) => {\n  1072→    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n  1073→\n  1074→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n  1075→    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n  1076→    rollingLost += impact;\n  1077→\n  1078→    flaws.push({\n  1079→      id: `flaw_${i}`,\n  1080→      flawName: f.metricName,\n  1081→      summary: f.reasoning,\n  1082→      harmonyPercentageLost: impact,\n  1083→      standardizedImpact: impact / 10,\n  1084→      categoryName: f.category,\n  1085→      responsibleRatios: [{\n  1086→        ratioName: f.metricName,\n  1087→        ratioId: f.metricId,\n  1088→        score: matchingMeasurement?.score || 3,\n  1089→        value: matchingMeasurement?.value || 0,\n  1090→        idealMin: matchingMeasurement?.idealMin || 0,\n  1091→        idealMax: matchingMeasurement?.idealMax || 1,\n  1092→        unit: matchingMeasurement?.unit || 'ratio',\n  1093→        category: f.category,\n  1094→      }],\n  1095→      rollingPointsDeducted: rollingLost,\n  1096→      rollingHarmonyPercentageLost: rollingLost,\n  1097→      rollingStandardizedImpact: rollingLost / 10,\n  1098→    });\n  1099→  });\n  1100→\n  1101→  // Sort by impact (highest first) then by number of contributing ratios\n  1102→  return flaws.sort((a, b) => {\n  1103→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n  1104→      return b.responsibleRatios.length - a.responsibleRatios.length;\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2daa8611-a604-45cb-b6af-167944362676","timestamp":"2025-12-26T06:51:43.104Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","content":"\n      // Calculate total impact from all metrics in this group\n      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n      rollingLost += totalImpact;\n\n      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: matchingMeasurement?.score || 3,\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });\n\n  // Sort by impact (highest first) then by number of contributing ratios\n  return flaws.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;","numLines":65,"startLine":1040,"totalLines":1392}}}
{"parentUuid":"2daa8611-a604-45cb-b6af-167944362676","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HFsW4ynEfKjx71pbQ2kQ1t","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a complete picture. Let me fix all the locations. There are **6 locations** that need clamping:\n\n**In `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts`:**\n1. Line 2583: `score: m.score` -> needs clamping\n2. Line 2610: `score: m.score` -> needs clamping\n\n**In `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx`:**\n3. Line 918: `score: m.score` -> needs clamping\n4. Line 945: `score: matchingMeasurement?.score || 8` -> needs clamping\n5. Line 1056: `score: m.score` -> needs clamping\n6. Line 1088: `score: matchingMeasurement?.score || 3` -> needs clamping\n\nLet me fix these:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1254,"cache_read_input_tokens":96042,"cache_creation":{"ephemeral_5m_input_tokens":1254,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWUrbe46NWrNCkVxCKWik","type":"assistant","uuid":"ec0d7127-9f5f-4537-afec-97fe12e14de3","timestamp":"2025-12-26T06:51:51.433Z"}
{"parentUuid":"ec0d7127-9f5f-4537-afec-97fe12e14de3","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HFsW4ynEfKjx71pbQ2kQ1t","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ft7wnSRD8Fpgb3FTL8M7Jt","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","old_string":"    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {","new_string":"    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1254,"cache_read_input_tokens":96042,"cache_creation":{"ephemeral_5m_input_tokens":1254,"ephemeral_1h_input_tokens":0},"output_tokens":692,"service_tier":"standard"}},"requestId":"req_011CWUrbe46NWrNCkVxCKWik","type":"assistant","uuid":"41838976-1840-45d2-8cef-f7d4741a7ce0","timestamp":"2025-12-26T06:51:57.801Z"}
{"parentUuid":"41838976-1840-45d2-8cef-f7d4741a7ce0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ft7wnSRD8Fpgb3FTL8M7Jt","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2576→    avgScore: classified.avgScore,\n  2577→    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n  2578→                  classified.grade === 'excellent' ? 'excellent' : 'good',\n  2579→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2580→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2581→      ratioName: m.metricName,\n  2582→      ratioId: m.metricId,\n  2583→      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n  2584→      value: m.value,\n  2585→      idealMin: m.idealMin,\n  2586→      idealMax: m.idealMax,\n  2587→      unit: m.unit,\n  2588→      category: m.category,\n  2589→    })),\n  2590→  };\n  2591→}\n  2592→\n  2593→/**\n  2594→ * Convert ClassifiedWeakness to Flaw type for UI compatibility\n  2595→ */\n  2596→export function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  2597→  const impact = (10 - classified.avgScore) * 0.5;\n  2598→  const newRollingLost = rollingLost + impact;\n  2599→\n  2600→  return {"}]},"uuid":"da33a6b5-07c1-4070-be0c-d87a8653e424","timestamp":"2025-12-26T06:51:57.851Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","oldString":"    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {","newString":"    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {","originalFile":"/**\n * Insights Engine\n *\n * Processes insight definitions from insights.json and classifies them\n * as strengths or areas of improvement based on user's metric scores.\n *\n * Logic:\n * - For each insight definition, calculate average score of affected metrics\n * - Weakness: if avg score < threshold → classify with severity label\n * - Strength: if avg score > threshold → classify with grade label\n *\n * Z-Score Based 5-Tier Severity Logic:\n * - Ideal (Green): User is inside the ideal range\n * - Good (Blue): Within 0.5 Standard Deviation of the mean (|z| < 0.5)\n * - Fair (Cyan): Between 0.5 and 1 Standard Deviation (0.5 ≤ |z| < 1)\n * - Moderate (Yellow): Between 1 and 2 Standard Deviations (1 ≤ |z| < 2)\n * - Severe (Red): More than 2 Standard Deviations away (|z| ≥ 2)\n *\n * Severity Labels (Weaknesses):\n *   0-3 = \"Severe\"\n *   3-5 = \"Moderate\"\n *   5-7 = \"Minor\"\n *\n * Grade Labels (Strengths):\n *   8-9   = \"Good\"\n *   9-9.5 = \"Excellent\"\n *   9.5-10 = \"Ideal\"\n */\n\nimport { Strength, Flaw } from '@/types/results';\nimport { MetricScoreResult, METRIC_CONFIGS, isValueAcceptable } from '@/lib/harmony-scoring';\n\n// ============================================\n// MASTER SCORING DATABASE (Z-Score Based)\n// ============================================\n\nexport type SeverityLevel = 'ideal' | 'good' | 'fair' | 'moderate' | 'severe';\nexport type Gender = 'male' | 'female';\nexport type Ethnicity = 'white' | 'black' | 'east_asian' | 'south_asian' | 'hispanic' | 'middle_eastern' | 'native_american' | 'pacific_islander';\n\nexport interface MasterMetricConfig {\n  ideal: [number, number];  // [min, max] ideal range\n  mean: number;             // Population mean\n  std_dev: number;          // Standard deviation\n  flaws?: {\n    low?: string[];         // Flaws when value is too low\n    high?: string[];        // Flaws when value is too high\n  };\n}\n\n// Base/Default standards (White Male baseline)\nexport const MASTER_SCORING_DB: Record<string, MasterMetricConfig> = {\n  // MIDFACE & PROPORTIONS\n  \"midface_ratio\": {\n    ideal: [0.97, 1.00],\n    mean: 1.0,\n    std_dev: 0.115,\n    flaws: { low: [\"Long midface\", \"Long upper jaw\"] }\n  },\n  \"faceWidthToHeight\": {\n    ideal: [1.30, 1.45],\n    mean: 1.38,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Overly long face\", \"Narrow face\"],\n      high: [\"Wide face\", \"Short face\"]\n    }\n  },\n  \"totalFacialWidthToHeight\": {\n    ideal: [1.25, 1.40],\n    mean: 1.33,\n    std_dev: 0.075,\n    flaws: {\n      low: [\"Long face shape\"],\n      high: [\"Wide face shape\"]\n    }\n  },\n  \"upperThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Long forehead\"]\n    }\n  },\n  \"middleThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short midface\"],\n      high: [\"Long midface\"]\n    }\n  },\n  \"lowerThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short lower face\"],\n      high: [\"Long lower face\"]\n    }\n  },\n\n  // EYE SPACING & IPD\n  \"eye_separation_ratio\": {\n    ideal: [0.45, 0.47],\n    mean: 0.46,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"interpupillaryRatio\": {\n    ideal: [0.44, 0.48],\n    mean: 0.46,\n    std_dev: 0.025,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"oneEyeApartTest\": {\n    ideal: [0.95, 1.05],\n    mean: 1.0,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"intercanthalWidth\": {\n    ideal: [30, 35],\n    mean: 32.5,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Narrow eye spacing\"],\n      high: [\"Wide eye spacing\"]\n    }\n  },\n\n  // EYE SHAPE & FEATURES\n  \"lateralCanthalTilt\": {\n    ideal: [6, 8],\n    mean: 5.0,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Negative canthal tilt\", \"Downturned eyes\"],\n      high: [\"Excessively upturned eyes\"]\n    }\n  },\n  \"eyeAspectRatio\": {\n    ideal: [0.30, 0.35],\n    mean: 0.32,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Round eyes\"]\n    }\n  },\n  \"palpebralFissureLength\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Small eyes\"],\n      high: [\"Large eyes\"]\n    }\n  },\n  \"eyeWidth\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Wide eyes\"]\n    }\n  },\n  \"upperEyelidExposure\": {\n    ideal: [0.5, 1.2],\n    mean: 0.85,\n    std_dev: 0.35,\n    flaws: {\n      low: [\"Hooded eyes\"],\n      high: [\"Excessive upper lid exposure\"]\n    }\n  },\n  \"tearTroughDepth\": {\n    ideal: [0.0, 0.3],\n    mean: 0.15,\n    std_dev: 0.15,\n    flaws: {\n      high: [\"Dark circles / Tear troughs\", \"Under-eye hollowness\"]\n    }\n  },\n\n  // JAW ANGLES & STRUCTURE\n  \"gonial_angle\": {\n    ideal: [115, 125],\n    mean: 118.0,\n    std_dev: 6.5,\n    flaws: {\n      high: [\"Weak/soft jaw structure\", \"Rounded jaw\"]\n    }\n  },\n  \"mandibularPlaneAngle\": {\n    ideal: [20, 28],\n    mean: 24.0,\n    std_dev: 4.0,\n    flaws: {\n      low: [\"Flat mandibular plane\"],\n      high: [\"Steep mandibular plane\", \"Hyper-divergent jaw\"]\n    }\n  },\n  \"jawFrontalAngle\": {\n    ideal: [125, 135],\n    mean: 130.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Steep jaw\"],\n      high: [\"Flat jaw angle\"]\n    }\n  },\n  \"jawSlope\": {\n    ideal: [25, 35],\n    mean: 30.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat jawline\"],\n      high: [\"Steep jawline\"]\n    }\n  },\n\n  // JAW WIDTH\n  \"jawWidthRatio\": {\n    ideal: [0.85, 0.95],\n    mean: 0.90,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Narrow jaw\"],\n      high: [\"Wide jaw\"]\n    }\n  },\n  \"bigonialWidth\": {\n    ideal: [110, 125],\n    mean: 117.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow jaw width\"],\n      high: [\"Excessively wide jaw\"]\n    }\n  },\n\n  // CHEEKBONES\n  \"cheekbone_height\": {\n    ideal: [83.0, 100.0],\n    mean: 85.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Low-set cheekbones\", \"Flat midface\"]\n    }\n  },\n  \"cheekboneWidth\": {\n    ideal: [130, 145],\n    mean: 137.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow cheekbones\"],\n      high: [\"Wide cheekbones\"]\n    }\n  },\n\n  // CHIN\n  \"chinPhiltrumRatio\": {\n    ideal: [1.8, 2.2],\n    mean: 2.0,\n    std_dev: 0.2,\n    flaws: {\n      low: [\"Recessed chin\", \"Short chin\"],\n      high: [\"Long chin\", \"Projected chin\"]\n    }\n  },\n  \"chinHeight\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short chin\"],\n      high: [\"Long chin\"]\n    }\n  },\n  \"chinWidth\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Pointed/Narrow chin\"],\n      high: [\"Wide chin\"]\n    }\n  },\n\n  // NOSE ANGLES\n  \"nasalTipAngle\": {\n    ideal: [95, 115],\n    mean: 105.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nasal tip\"]\n    }\n  },\n  \"nasolabialAngle\": {\n    ideal: [95, 110],\n    mean: 102.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nose\"]\n    }\n  },\n  \"nasofrontalAngle\": {\n    ideal: [115, 135],\n    mean: 125.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Deep nasal root\"],\n      high: [\"Flat nasal root\"]\n    }\n  },\n  \"nasofacialAngle\": {\n    ideal: [30, 40],\n    mean: 35.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat nose profile\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"nasomentaAngle\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // NOSE WIDTH & PROPORTIONS\n  \"nasalIndex\": {\n    ideal: [65, 75],\n    mean: 70.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nose\", \"Bulbous nose\"]\n    }\n  },\n  \"noseWidth\": {\n    ideal: [35, 42],\n    mean: 38.5,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nasal base\"]\n    }\n  },\n  \"noseBridgeWidth\": {\n    ideal: [12, 18],\n    mean: 15.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Narrow nose bridge\"],\n      high: [\"Wide nose bridge\"]\n    }\n  },\n  \"nasalProjection\": {\n    ideal: [16, 22],\n    mean: 19.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Underprojected nose\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"noseLengthRatio\": {\n    ideal: [0.45, 0.55],\n    mean: 0.50,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short nose\"],\n      high: [\"Long nose\"]\n    }\n  },\n\n  // LIPS & PHILTRUM\n  \"lipRatio\": {\n    ideal: [1.4, 1.6],\n    mean: 1.5,\n    std_dev: 0.15,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"philtrumLength\": {\n    ideal: [11, 15],\n    mean: 13.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Short philtrum\"],\n      high: [\"Long philtrum\"]\n    }\n  },\n  \"upperLipHeight\": {\n    ideal: [18, 24],\n    mean: 21.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"lipChinDistance\": {\n    ideal: [40, 50],\n    mean: 45.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short lower third\"],\n      high: [\"Long lower third\"]\n    }\n  },\n  \"upperLipProjection\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed upper lip\"],\n      high: [\"Protruding upper lip\"]\n    }\n  },\n  \"lowerLipProjection\": {\n    ideal: [-1, 3],\n    mean: 1.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed lower lip\"],\n      high: [\"Protruding lower lip\"]\n    }\n  },\n  \"cupidsBowDepth\": {\n    ideal: [3, 6],\n    mean: 4.5,\n    std_dev: 1.5,\n    flaws: {\n      low: [\"Flat cupid's bow\"],\n      high: [\"Pronounced cupid's bow\"]\n    }\n  },\n\n  // EYEBROWS\n  \"eyebrowHeight\": {\n    ideal: [8, 14],\n    mean: 11.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Low-set eyebrows\"],\n      high: [\"High eyebrows\"]\n    }\n  },\n  \"browLengthRatio\": {\n    ideal: [0.50, 0.60],\n    mean: 0.55,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browLengthToFaceWidth\": {\n    ideal: [0.30, 0.38],\n    mean: 0.34,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browridgeInclinationAngle\": {\n    ideal: [10, 20],\n    mean: 15.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat brow ridge\"],\n      high: [\"Prominent brow ridge\"]\n    }\n  },\n  \"eyebrowThickness\": {\n    ideal: [1.5, 3.0],\n    mean: 2.25,\n    std_dev: 0.75,\n    flaws: {\n      low: [\"Sparse/Weak eyebrows\"],\n      high: [\"Overly thick eyebrows\"]\n    }\n  },\n\n  // FOREHEAD\n  \"foreheadHeight\": {\n    ideal: [55, 70],\n    mean: 62.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Tall forehead\"]\n    }\n  },\n  \"bitemporalWidth\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow forehead\"],\n      high: [\"Wide forehead\"]\n    }\n  },\n\n  // PROFILE & DEPTH\n  \"facialDepthToHeight\": {\n    ideal: [0.75, 0.85],\n    mean: 0.80,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Flat facial profile\"],\n      high: [\"Overprojected profile\"]\n    }\n  },\n  \"anteriorFacialDepth\": {\n    ideal: [115, 130],\n    mean: 122.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Shallow face depth\"],\n      high: [\"Deep face projection\"]\n    }\n  },\n  \"totalProfileAngle\": {\n    ideal: [165, 175],\n    mean: 170.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // ASYMMETRY\n  \"facialAsymmetryIndex\": {\n    ideal: [0, 3],\n    mean: 2.0,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Facial asymmetry\"]\n    }\n  },\n  \"eyeAsymmetry\": {\n    ideal: [0, 2],\n    mean: 1.0,\n    std_dev: 1.0,\n    flaws: {\n      high: [\"Eye asymmetry\"]\n    }\n  },\n  \"jawAsymmetry\": {\n    ideal: [0, 3],\n    mean: 1.5,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Jaw asymmetry\"]\n    }\n  },\n\n  // OTHER\n  \"recessionFrankfort\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Maxillary recession\"],\n      high: [\"Maxillary protrusion\"]\n    }\n  },\n  \"neckWidth\": {\n    ideal: [110, 130],\n    mean: 120.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Wide neck\"]\n    }\n  },\n  \"neckToJawRatio\": {\n    ideal: [0.90, 1.10],\n    mean: 1.0,\n    std_dev: 0.10,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Thick neck\"]\n    }\n  }\n};\n\n// ============================================\n// ETHNICITY-SPECIFIC OVERRIDES\n// ============================================\n\n/**\n * Ethnicity and gender-specific metric standards\n * These override the base MASTER_SCORING_DB values for specific populations\n */\nexport const ETHNICITY_OVERRIDES: Record<string, Record<string, Partial<MasterMetricConfig>>> = {\n  // ========================================\n  // MALE WHITE STANDARDS (Neoclassical Baseline)\n  // ========================================\n  \"male_white\": {\n    // NOSE WIDTH - Strict 1:1 ratio (Eye Width = Nose Width)\n    \"noseWidth\": {\n      ideal: [35, 42],  // Corresponds to alar_base_ratio [0.98, 1.05]\n      mean: 38.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // MIDFACE - Prefers compact midface (Hunter look)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    },\n\n    // JAW - Square/Robust jaw preference\n    \"gonial_angle\": {\n      ideal: [115.0, 125.0],\n      mean: 120.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/Soft jaw structure\"]\n      }\n    },\n\n    // FACE WIDTH - Standard Mesoprosopic range\n    \"faceWidthToHeight\": {\n      ideal: [1.90, 2.05],\n      mean: 1.975,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Short/Wide face\"]\n      }\n    },\n\n    // EYE TILT - Neutral to slightly positive\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 8.0],\n      mean: 6.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Negative canthal tilt\"]\n      }\n    },\n\n    // LOWER FACE BALANCE\n    \"chinPhiltrumRatio\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Long philtrum / Short chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE BLACK / AFRICAN STANDARDS\n  // ========================================\n  \"male_black\": {\n    // NOSE WIDTH - Significantly wider tolerance\n    \"noseWidth\": {\n      ideal: [40, 50],  // Wider range (corresponds to alar_base_ratio [1.12, 1.25])\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n    \"nasalIndex\": {\n      ideal: [80, 95],  // Wider nasal index\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n\n    // LIPS - Prefers fuller lips\n    \"lipRatio\": {\n      ideal: [1.2, 1.5],\n      mean: 1.35,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    },\n\n    // PHILTRUM - Shorter visible philtrum is ideal\n    \"philtrumLength\": {\n      ideal: [11.0, 14.0],\n      mean: 12.5,\n      std_dev: 1.5,\n      flaws: {\n        high: [\"Long philtrum\"]\n      }\n    },\n\n    // CHIN - Adjusts for natural forward mouth projection (Prognathism)\n    \"chinPhiltrumRatio\": {\n      ideal: [1.80, 2.10],  // Lower range to account for prognathism\n      mean: 1.95,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Recessed chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE EAST ASIAN STANDARDS\n  // ========================================\n  \"male_east_asian\": {\n    // EYE SPACING - Shifted WIDER for East Asian males\n    \"eye_separation_ratio\": {\n      ideal: [0.48, 0.53],  // Shifted wider (0.46 is \"close-set\" here)\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n    \"interpupillaryRatio\": {\n      ideal: [0.48, 0.53],\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n\n    // EYE SHAPE - Prefers narrower/longer eyes (Hunter Eyes)\n    \"eyeAspectRatio\": {\n      ideal: [0.25, 0.29],  // Lower ratio = more elongated\n      mean: 0.27,\n      std_dev: 0.02,\n      flaws: {\n        low: [\"Overly narrow eyes\"],\n        high: [\"Overly round eye shape\"]\n      }\n    },\n    \"palpebralFissureLength\": {\n      ideal: [29, 33],\n      mean: 31.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Small eyes\"],\n        high: [\"Large eyes\"]\n      }\n    },\n\n    // NOSE - Asian noses typically allowed to be wider\n    \"nasalIndex\": {\n      ideal: [75, 85],\n      mean: 80.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n    \"noseWidth\": {\n      ideal: [38, 45],\n      mean: 41.5,\n      std_dev: 3.5,\n      flaws: {\n        low: [\"Narrow nose\"],\n        high: [\"Very wide nasal base\"]\n      }\n    },\n    \"noseBridgeWidth\": {\n      ideal: [14, 20],\n      mean: 17.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Narrow nose bridge\"],\n        high: [\"Wide nose bridge\"]\n      }\n    },\n\n    // CHEEKS - Rewards slightly fuller cheeks (Youth/K-Pop aesthetic)\n    \"cheekbone_height\": {\n      ideal: [80.0, 95.0],\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Hollow face\"]\n      }\n    },\n\n    // JAW - Slightly softer angles acceptable\n    \"gonial_angle\": {\n      ideal: [118, 128],\n      mean: 123.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/soft jaw structure\"]\n      }\n    },\n    \"mandibularPlaneAngle\": {\n      ideal: [20, 30],\n      mean: 25.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Flat mandibular plane\"],\n        high: [\"Steep mandibular plane\"]\n      }\n    },\n\n    // FACIAL PROPORTIONS - Wider faces more common\n    \"faceWidthToHeight\": {\n      ideal: [1.35, 1.50],\n      mean: 1.425,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n    \"totalFacialWidthToHeight\": {\n      ideal: [1.30, 1.45],\n      mean: 1.375,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face shape\"],\n        high: [\"Wide face shape\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE SOUTH ASIAN STANDARDS\n  // ========================================\n  \"male_south_asian\": {\n    // NOSE WIDTH - Slightly wider tolerance than White\n    \"noseWidth\": {\n      ideal: [36, 43],  // alar_base_ratio [1.00, 1.08]\n      mean: 39.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // TEAR TROUGH - VERY STRICT. High penalty for dark circles\n    \"tearTroughDepth\": {\n      ideal: [0.0, 0.5],\n      mean: 0.25,\n      std_dev: 0.25,\n      flaws: {\n        high: [\"Dark circles / Tear troughs\"]\n      }\n    },\n\n    // UPPER EYELID - Often prefers visible lid platform\n    \"upperEyelidExposure\": {\n      ideal: [0.5, 2.0],\n      mean: 1.25,\n      std_dev: 0.75,\n      flaws: {\n        low: [\"Hooded eyes\"]\n      }\n    },\n\n    // CHEEKS - Penalizes \"Gaunt\" looks heavily\n    \"cheekbone_height\": {\n      ideal: [83.0, 95.0],\n      mean: 89.0,\n      std_dev: 6.0,\n      flaws: {\n        low: [\"Volume loss / Gauntness\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE HISPANIC STANDARDS (\"The Bridge Model\")\n  // ========================================\n  \"male_hispanic\": {\n    // FACE WIDTH - Rewards broader, more robust face shapes (Mestizo)\n    \"faceWidthToHeight\": {\n      ideal: [1.95, 2.10],\n      mean: 2.025,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long/Narrow face\"]\n      }\n    },\n\n    // NOSE WIDTH - Bridge tolerance (Wider than White, narrower than Black)\n    \"noseWidth\": {\n      ideal: [36, 44],  // alar_base_ratio [1.00, 1.12]\n      mean: 40.0,\n      std_dev: 4.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for positive tilt\n    \"lateralCanthalTilt\": {\n      ideal: [6.0, 12.0],\n      mean: 9.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Negative/Neutral canthal tilt\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE MIDDLE EASTERN STANDARDS\n  // ========================================\n  \"male_middle_eastern\": {\n    // EYEBROW THICKNESS - Prefers significantly thicker/darker brows\n    \"eyebrowThickness\": {\n      ideal: [2.0, 4.0],\n      mean: 3.0,\n      std_dev: 1.0,\n      flaws: {\n        low: [\"Sparse/Weak eyebrows\"],\n        high: [\"Unibrow\"]\n      }\n    },\n\n    // NASOLABIAL ANGLE - Penalizes droopy tip (<90) or hooked noses\n    \"nasolabialAngle\": {\n      ideal: [90.0, 100.0],\n      mean: 95.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Droopy nose tip / Hooked nose\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for Almond/Hunter eye shape\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 10.0],\n      mean: 7.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    },\n\n    // MIDFACE - Similar to White model (Compact is better)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE PACIFIC ISLANDER STANDARDS (\"The Warrior Skull\")\n  // ========================================\n  \"male_pacific_islander\": {\n    // FACE WIDTH - The Highest Width Standard (Very broad)\n    \"faceWidthToHeight\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Narrow/Long face\"]\n      }\n    },\n\n    // NOSE WIDTH - Wide tolerance\n    \"noseWidth\": {\n      ideal: [38, 48],  // alar_base_ratio [1.05, 1.20]\n      mean: 43.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // CHEEKS - Rewards high mass/robustness\n    \"cheekbone_height\": {\n      ideal: [85.0, 100.0],\n      mean: 92.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Weak face structure\"]\n      }\n    },\n\n    // CHIN WIDTH - Prefers a very broad, square chin\n    \"chinWidth\": {\n      ideal: [40.0, 50.0],\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Pointed/Narrow chin\"]\n      }\n    }\n  },\n\n  \"male_native_american\": {\n    \"faceWidthToHeight\": {\n      ideal: [2.00, 2.20],\n      mean: 2.10,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Wide face\"]\n      }\n    },\n\n    \"nasalIndex\": {\n      ideal: [75, 90],\n      mean: 82.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Narrow nose\"],\n        high: [\"Wide nose\"]\n      }\n    },\n\n    \"cheekbone_height\": {\n      ideal: [80.0, 95.0],\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Flat cheekbones\"]\n      }\n    },\n\n    \"gonialAngle\": {\n      ideal: [115, 125],\n      mean: 120,\n      std_dev: 5,\n      flaws: {\n        low: [\"Weak jaw\"],\n        high: [\"Harsh jaw angle\"]\n      }\n    },\n\n    \"chinWidth\": {\n      ideal: [38.0, 48.0],\n      mean: 43.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Narrow chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // FEMALE ETHNICITIES (The \"Missing Link\")\n  // ========================================\n\n  \"female_white\": {\n    // NOSE WIDTH - Strict Rule of Fifths for feminine harmony\n    \"alar_base_ratio\": {\n      ideal: [0.98, 1.05],\n      mean: 1.015,\n      std_dev: 0.035,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // FACE WIDTH - Prefers oval/narrow feminine proportions\n    \"fwhr\": {\n      ideal: [1.45, 1.53],\n      mean: 1.49,\n      std_dev: 0.04,\n      flaws: {\n        low: [\"Long/Narrow face\"],\n        high: [\"Wide face\"]\n      }\n    },\n\n    // JAW - Soft, tapered feminine jawline\n    \"gonial_angle\": {\n      ideal: [122.0, 130.0],\n      mean: 126.0,\n      std_dev: 4.0,\n      flaws: {\n        low: [\"Sharp/Masculine jaw angle\"],\n        high: [\"Weak/Overly soft jawline\"]\n      }\n    },\n\n    // EYE TILT - Neutral to positive preferred\n    \"canthal_tilt\": {\n      ideal: [4.0, 9.0],\n      mean: 6.5,\n      std_dev: 2.5,\n      flaws: {\n        low: [\"Negative/Downturned eyes\"]\n      }\n    },\n\n    // CHIN-PHILTRUM - Golden Ratio balance\n    \"chin_philtrum_ratio\": {\n      ideal: [2.0, 2.2],\n      mean: 2.1,\n      std_dev: 0.1,\n      flaws: {\n        low: [\"Recessed chin\"],\n        high: [\"Protruding chin\"]\n      }\n    }\n  },\n\n  \"female_black\": {\n    // LIPS - High volume preference (fuller lips)\n    \"lipRatio\": {\n      ideal: [1.3, 1.6],\n      mean: 1.45,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    },\n\n    // NOSE WIDTH - Wider tolerance for ethnic variation\n    \"alar_base_ratio\": {\n      ideal: [1.05, 1.15],\n      mean: 1.10,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Very wide nasal base\"]\n      }\n    },\n\n    // CHIN - Allows forward projection (natural prognathism)\n    \"chin_projection\": {\n      ideal: [0.0, 5.0],\n      mean: 2.5,\n      std_dev: 2.5,\n      flaws: {\n        high: [\"Excessive chin projection\"]\n      }\n    },\n\n    // JAW - Soft feminine jawline\n    \"gonial_angle\": {\n      ideal: [120.0, 130.0],\n      mean: 125.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Sharp jaw angle\"],\n        high: [\"Weak jawline\"]\n      }\n    }\n  },\n\n  \"female_east_asian\": {\n    // EYE SPACING - Wide-set neotenous preference\n    \"eye_separation_ratio\": {\n      ideal: [46.3, 47.5],\n      mean: 46.9,\n      std_dev: 0.6,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Very wide-set eyes\"]\n      }\n    },\n\n    // JAW - Tapered V-shape feminine ideal\n    \"gonial_angle\": {\n      ideal: [120.0, 126.0],\n      mean: 123.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Sharp V-line jaw\"],\n        high: [\"Weak/Square jawline\"]\n      }\n    },\n\n    // EYEBROWS - Higher set brows (youthful feminine)\n    \"eyebrow_height\": {\n      ideal: [0.85, 1.30],\n      mean: 1.075,\n      std_dev: 0.225,\n      flaws: {\n        low: [\"Low-set/Heavy brows\"],\n        high: [\"Very high-arched brows\"]\n      }\n    },\n\n    // LOWER FACE - Compact lower third (neotenous)\n    \"lower_third_ratio\": {\n      ideal: [29.6, 32.7],\n      mean: 31.15,\n      std_dev: 1.55,\n      flaws: {\n        low: [\"Very short lower face\"],\n        high: [\"Long lower face\"]\n      }\n    }\n  },\n\n  \"female_south_asian\": {\n    // TEAR TROUGHS - Very strict on dark circles\n    \"tear_trough_depth\": {\n      ideal: [0.0, 0.5],\n      mean: 0.25,\n      std_dev: 0.25,\n      flaws: {\n        high: [\"Dark circles / Deep tear troughs\"]\n      }\n    },\n\n    // CHEEKS - Rewards midface volume (youthful fullness)\n    \"cheek_fullness\": {\n      ideal: [1.0, 2.0],\n      mean: 1.5,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Gaunt/Hollow cheeks\"]\n      }\n    },\n\n    // SKIN - High penalty for uneven skin tone\n    \"skin_uniformity\": {\n      ideal: [0.92, 1.0],\n      mean: 0.96,\n      std_dev: 0.04,\n      flaws: {\n        low: [\"Uneven skin tone / Pigmentation\"]\n      }\n    },\n\n    // NOSE WIDTH - Intermediate tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.00, 1.08],\n      mean: 1.04,\n      std_dev: 0.04,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    }\n  },\n\n  \"female_hispanic\": {\n    // FACE WIDTH - Broader Mestiza tolerance\n    \"fwhr\": {\n      ideal: [1.50, 1.62],\n      mean: 1.56,\n      std_dev: 0.06,\n      flaws: {\n        low: [\"Long/Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // EYE TILT - Strong almond eye preference\n    \"canthal_tilt\": {\n      ideal: [6.0, 12.0],\n      mean: 9.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Neutral/Downturned eyes\"]\n      }\n    },\n\n    // NOSE WIDTH - Intermediate width tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.00, 1.10],\n      mean: 1.05,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // LIPS - Voluptuous preference\n    \"lipRatio\": {\n      ideal: [1.1, 1.35],\n      mean: 1.225,\n      std_dev: 0.125,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    }\n  },\n\n  \"female_middle_eastern\": {\n    // EYEBROWS - Dense/Thick brows preference\n    \"eyebrow_thickness\": {\n      ideal: [1.5, 3.0],\n      mean: 2.25,\n      std_dev: 0.75,\n      flaws: {\n        low: [\"Sparse/Thin eyebrows\"],\n        high: [\"Unibrow\"]\n      }\n    },\n\n    // NOSE - Refined/Upturned tip\n    \"nasolabial_angle\": {\n      ideal: [95.0, 105.0],\n      mean: 100.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Droopy nose tip\"],\n        high: [\"Overly upturned nose\"]\n      }\n    },\n\n    // EYE TILT - Foxy/Hunter feminine eye shape\n    \"canthal_tilt\": {\n      ideal: [5.0, 10.0],\n      mean: 7.5,\n      std_dev: 2.5,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    },\n\n    // EYELID - Low exposure preferred\n    \"upper_eyelid_exposure\": {\n      ideal: [0.5, 1.5],\n      mean: 1.0,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Hooded eyes\"],\n        high: [\"Excessive eyelid exposure\"]\n      }\n    }\n  },\n\n  \"female_native_american\": {\n    // FACE WIDTH - Wide/High cheekbone structure\n    \"fwhr\": {\n      ideal: [1.52, 1.65],\n      mean: 1.585,\n      std_dev: 0.065,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // CHEEKBONES - High definition/prominence\n    \"cheekbone_prominence\": {\n      ideal: [1.5, 2.5],\n      mean: 2.0,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Flat cheekbones\"],\n        high: [\"Overly prominent cheekbones\"]\n      }\n    },\n\n    // JAW - Stronger jaw tolerance\n    \"gonial_angle\": {\n      ideal: [115.0, 125.0],\n      mean: 120.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Very sharp jaw\"],\n        high: [\"Weak jawline\"]\n      }\n    },\n\n    // EYE TILT - Positive tilt preference\n    \"canthal_tilt\": {\n      ideal: [5.0, 11.0],\n      mean: 8.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    }\n  },\n\n  \"female_pacific_islander\": {\n    // FACE WIDTH - Widest/Robust facial structure\n    \"fwhr\": {\n      ideal: [1.55, 1.70],\n      mean: 1.625,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // CHEEKS - High volume/softness preference\n    \"cheek_fullness\": {\n      ideal: [1.2, 2.5],\n      mean: 1.85,\n      std_dev: 0.65,\n      flaws: {\n        low: [\"Gaunt/Hollow cheeks\"]\n      }\n    },\n\n    // NOSE WIDTH - Wide nose tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.05, 1.15],\n      mean: 1.10,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Very wide nasal base\"]\n      }\n    },\n\n    // LIPS - Full lips preference\n    \"lipRatio\": {\n      ideal: [1.25, 1.50],\n      mean: 1.375,\n      std_dev: 0.125,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    }\n  }\n};\n\n/**\n * Get the appropriate metric configuration for a given gender and ethnicity\n * Falls back to base config if no override exists\n */\nexport function getMetricConfig(\n  metricId: string,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): MasterMetricConfig | undefined {\n  const key = `${gender}_${ethnicity}`;\n  const override = ETHNICITY_OVERRIDES[key]?.[metricId];\n  const baseConfig = MASTER_SCORING_DB[metricId];\n\n  if (!baseConfig) return undefined;\n\n  // Merge override with base config\n  if (override) {\n    return {\n      ...baseConfig,\n      ...override,\n      flaws: {\n        ...baseConfig.flaws,\n        ...override.flaws\n      }\n    } as MasterMetricConfig;\n  }\n\n  return baseConfig;\n}\n\n// ============================================\n// Z-SCORE SEVERITY FUNCTIONS\n// ============================================\n\n/**\n * Calculate Z-score for a given value\n * Z = (value - mean) / std_dev\n */\nexport function calculateZScore(value: number, mean: number, stdDev: number): number {\n  if (stdDev === 0) return 0;\n  return Math.abs((value - mean) / stdDev);\n}\n\n/**\n * Determine severity level based on Z-score and ideal range (5-tier system)\n * - Ideal: Value is within ideal range\n * - Good: |z| < 0.5 (within 0.5 standard deviation)\n * - Fair: 0.5 ≤ |z| < 1 (between 0.5-1 standard deviations)\n * - Moderate: 1 ≤ |z| < 2 (between 1-2 standard deviations)\n * - Severe: |z| ≥ 2 (more than 2 standard deviations away)\n */\nexport function getSeverityFromZScore(\n  value: number,\n  config: MasterMetricConfig\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean } {\n  const { ideal, mean, std_dev } = config;\n  const isInIdeal = value >= ideal[0] && value <= ideal[1];\n  const zScore = calculateZScore(value, mean, std_dev);\n\n  let severity: SeverityLevel;\n  if (isInIdeal) {\n    severity = 'ideal';\n  } else if (zScore < 0.5) {\n    severity = 'good';\n  } else if (zScore < 1) {\n    severity = 'fair';\n  } else if (zScore < 2) {\n    severity = 'moderate';\n  } else {\n    severity = 'severe';\n  }\n\n  return { severity, zScore, isInIdeal };\n}\n\n/**\n * Get severity for a metric value with ethnicity/gender awareness\n */\nexport function getSeverityForMetric(\n  metricId: string,\n  value: number,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean; config: MasterMetricConfig } | null {\n  const config = getMetricConfig(metricId, gender, ethnicity);\n  if (!config) return null;\n\n  const result = getSeverityFromZScore(value, config);\n  return { ...result, config };\n}\n\n/**\n * Get badge color for severity level (5-tier)\n */\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'green';\n    case 'good': return 'blue';\n    case 'fair': return 'cyan';\n    case 'moderate': return 'yellow';\n    case 'severe': return 'red';\n    default: return 'gray';\n  }\n}\n\n/**\n * Get severity label for display (5-tier)\n */\nexport function getSeverityLabel(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'Ideal';\n    case 'good': return 'Good';\n    case 'fair': return 'Fair';\n    case 'moderate': return 'Moderate';\n    case 'severe': return 'Severe';\n    default: return 'Unknown';\n  }\n}\n\n// ============================================\n// INSIGHT DEFINITION TYPES\n// ============================================\n\nexport interface InsightSeverityLogic {\n  metrics: string[];  // Display names of metrics (e.g., \"Face Width to Height Ratio\")\n  threshold: number;  // Score threshold for classification\n}\n\nexport interface WeaknessSeverityLabels {\n  minor: string;\n  moderate: string;\n  severe: string;\n}\n\nexport interface StrengthGradeLabels {\n  good: string;\n  excellent: string;\n  ideal: string;\n}\n\nexport interface InsightContent {\n  description: string;\n  severity_labels?: WeaknessSeverityLabels;  // For weaknesses\n  grade_labels?: StrengthGradeLabels;        // For strengths\n}\n\nexport interface InsightDefinition {\n  id: string;\n  title: string;\n  type: 'weakness' | 'strength';\n  severity_logic: InsightSeverityLogic;\n  content: InsightContent;\n}\n\n// ============================================\n// CLASSIFICATION RESULT TYPES\n// ============================================\n\nexport type WeaknessSeverity = 'severe' | 'moderate' | 'minor';\nexport type StrengthGrade = 'ideal' | 'excellent' | 'good';\n\nexport interface ClassifiedWeakness {\n  insightId: string;\n  title: string;\n  description: string;\n  severity: WeaknessSeverity;\n  severityLabel: string;  // Custom label from definition (e.g., \"Extremely Long\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface ClassifiedStrength {\n  insightId: string;\n  title: string;\n  description: string;\n  grade: StrengthGrade;\n  gradeLabel: string;  // Custom label from definition (e.g., \"Ideal\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface MatchedMetric {\n  metricId: string;\n  metricName: string;\n  score: number;\n  value: number;\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category: string;\n}\n\nexport interface InsightClassificationResult {\n  strengths: ClassifiedStrength[];\n  weaknesses: ClassifiedWeakness[];\n}\n\n// ============================================\n// INSIGHTS DATABASE\n// ============================================\n\nexport const INSIGHTS_DEFINITIONS: InsightDefinition[] = [\n  {\n    id: \"long_midface\",\n    title: \"Long Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\", \"Ipsilateral Alar Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The middle of the face is elongated, creating an unbalanced vertical proportion.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Extremely Long\" }\n    }\n  },\n  {\n    id: \"short_midface\",\n    title: \"Short Midface\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The midface has ideal vertical proportions, contributing to facial harmony.\",\n      grade_labels: { good: \"Proportionate\", excellent: \"Well-Balanced\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"weak_jaw\",\n    title: \"Weak/Soft Jaw Structure\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Chin to Philtrum Ratio\", \"Jaw Slope\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw has a softer, rounder shape, often less angular and robust than the ideal.\",\n      severity_labels: { minor: \"Soft\", moderate: \"Recessed\", severe: \"Weak\" }\n    }\n  },\n  {\n    id: \"strong_jaw\",\n    title: \"Strong Jaw Definition\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Jaw Width Ratio\", \"Bigonial Width\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The jaw displays strong definition with well-defined angles and proportionate width.\",\n      grade_labels: { good: \"Defined\", excellent: \"Strong\", ideal: \"Ideal Angular\" }\n    }\n  },\n  {\n    id: \"refined_nasal_tip\",\n    title: \"Refined Nasal Tip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasal Tip Angle\", \"Nose Tip Position\", \"Frankfort-tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious nasal profile due to the nasal tip being well-defined and proportionate.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"bulbous_nose\",\n    title: \"Bulbous Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Nose Width\", \"Nasal Tip Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip appears rounded and less defined, affecting nasal aesthetics.\",\n      severity_labels: { minor: \"Slightly Rounded\", moderate: \"Rounded\", severe: \"Bulbous\" }\n    }\n  },\n  {\n    id: \"ideal_upper_lip\",\n    title: \"Well-Positioned Upper Lip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Lip E-Line Position\", \"Upper Lip S-Line Position\", \"Nasolabial Angle\"],\n      threshold: 9.0\n    },\n    content: {\n      description: \"This contributes to a harmonious mouth region due to the upper lip sitting neither too far forward nor too far back.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"negative_canthal_tilt\",\n    title: \"Negative Canthal Tilt\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The outer corners of the eyes sit lower than the inner corners, creating a downturned appearance.\",\n      severity_labels: { minor: \"Slight Downturn\", moderate: \"Noticeable\", severe: \"Pronounced\" }\n    }\n  },\n  {\n    id: \"positive_canthal_tilt\",\n    title: \"Positive Canthal Tilt\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The outer corners of the eyes are elevated, creating an attractive upswept eye shape.\",\n      grade_labels: { good: \"Slight Upturn\", excellent: \"Well-Tilted\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"balanced_facial_thirds\",\n    title: \"Balanced Facial Thirds\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays well-balanced vertical proportions across all three facial thirds.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfectly Proportioned\" }\n    }\n  },\n  {\n    id: \"imbalanced_thirds\",\n    title: \"Facial Third Imbalance\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The vertical face proportions show imbalance between the three facial thirds.\",\n      severity_labels: { minor: \"Slight Imbalance\", moderate: \"Noticeable Disproportion\", severe: \"Significant Imbalance\" }\n    }\n  },\n  {\n    id: \"high_cheekbones\",\n    title: \"High Cheekbones\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Cheekbone Width\", \"Midface Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"Well-positioned cheekbones that create attractive facial contours and catch light beautifully.\",\n      grade_labels: { good: \"Visible\", excellent: \"Prominent\", ideal: \"Model-Tier\" }\n    }\n  },\n  {\n    id: \"flat_midface\",\n    title: \"Flat Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Total Facial Width to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The midface lacks forward projection, resulting in flatter facial contours.\",\n      severity_labels: { minor: \"Slightly Flat\", moderate: \"Underprojected\", severe: \"Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_lip_ratio\",\n    title: \"Ideal Lip Proportions\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Philtrum Length\", \"Lip Chin Distance\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Well-Proportioned\", ideal: \"Perfect Ratio\" }\n    }\n  },\n  {\n    id: \"thin_lips\",\n    title: \"Thin Lip Profile\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Upper Lip Projection\", \"Lower Lip Projection\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The lips appear thinner than ideal proportions, affecting lower face harmony.\",\n      severity_labels: { minor: \"Slightly Thin\", moderate: \"Thin\", severe: \"Very Thin\" }\n    }\n  },\n  {\n    id: \"ideal_ipd\",\n    title: \"Ideal Eye Spacing\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes are ideally spaced, creating facial balance and attractiveness.\",\n      grade_labels: { good: \"Good Spacing\", excellent: \"Ideal Distance\", ideal: \"Perfect IPD\" }\n    }\n  },\n  {\n    id: \"wide_set_eyes\",\n    title: \"Wide-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are spaced wider apart than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Noticeably Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"close_set_eyes\",\n    title: \"Close-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"Intercanthal Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are positioned closer together than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Close\", moderate: \"Noticeably Close\", severe: \"Very Close\" }\n    }\n  },\n  {\n    id: \"ideal_nose_projection\",\n    title: \"Ideal Nasal Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofrontal Angle\", \"Nasofacial Angle\", \"Nasomenta Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The nose has ideal forward projection relative to the face, creating profile harmony.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect Projection\" }\n    }\n  },\n  {\n    id: \"recessed_chin\",\n    title: \"Recessed Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Facial Depth to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The chin sits behind the ideal position, affecting profile balance.\",\n      severity_labels: { minor: \"Slightly Recessed\", moderate: \"Recessed\", severe: \"Severely Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_chin_projection\",\n    title: \"Ideal Chin Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The chin demonstrates ideal projection and proportions relative to the face.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect\" }\n    }\n  },\n  {\n    id: \"long_philtrum\",\n    title: \"Long Philtrum\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Lip Chin Distance\", \"Upper Lip Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The distance between nose and upper lip is longer than ideal.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"short_philtrum\",\n    title: \"Short Philtrum\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Upper Lip Height\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The philtrum has ideal or shorter length, considered youthful and attractive.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Short\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"wide_nose\",\n    title: \"Wide Nasal Base\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Intercanthal Nasal Ratio\", \"Nose Bridge Width\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The base of the nose is wider than the aesthetic ideal for facial harmony.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"ideal_brow_position\",\n    title: \"Ideal Brow Position\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow Length Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The eyebrows are ideally positioned relative to the eyes and facial structure.\",\n      grade_labels: { good: \"Good Position\", excellent: \"Well-Arched\", ideal: \"Perfect Frame\" }\n    }\n  },\n  {\n    id: \"narrow_jaw\",\n    title: \"Narrow Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Jaw Width Ratio\", \"Bigonial Width\", \"Jaw Frontal Angle\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw is narrower than ideal, affecting lower face width and definition.\",\n      severity_labels: { minor: \"Slightly Narrow\", moderate: \"Narrow\", severe: \"Very Narrow\" }\n    }\n  },\n  {\n    id: \"steep_mandibular_plane\",\n    title: \"Steep Mandibular Plane\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The mandibular plane angle is steeper than ideal, often indicating vertical growth pattern.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  // ============================================\n  // INSIGHT DEFINITIONS (element.html / element1.html)\n  // ============================================\n  // --- WEAKNESSES ---\n  {\n    id: \"steep_jaw\",\n    title: \"Steep Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Jaw Frontal Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The jaw angles sharply downward, creating a narrow or pointed chin effect.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  {\n    id: \"maxillary_recession\",\n    title: \"Maxillary Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Facial Depth to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The upper jaw is less forward than ideal, reducing midface projection and facial harmony.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"mandibular_recession\",\n    title: \"Mandibular Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The lower jaw is set back, creating a less prominent chin and an unbalanced profile.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"underprojected_chin\",\n    title: \"Underprojected Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\", \"Chin Height\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The chin lacks forward projection, creating a weak lower face appearance.\",\n      severity_labels: { minor: \"Slightly Weak\", moderate: \"Underprojected\", severe: \"Severely Underprojected\" }\n    }\n  },\n  {\n    id: \"overly_long_face\",\n    title: \"Overly Long Face Shape\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Total Facial Width to Height Ratio\", \"Face Width to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The face is excessively tall and narrow, creating an elongated appearance.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"hyper_divergent_jaw\",\n    title: \"Hyper-Divergent Jaw Growth\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The jaw grows with an overly steep angle, resulting in a long or narrow lower face. This can indicate malocclusion.\",\n      severity_labels: { minor: \"Mildly Divergent\", moderate: \"Divergent\", severe: \"Hyper-Divergent\" }\n    }\n  },\n  {\n    id: \"weak_brow_ridge\",\n    title: \"Soft/Weak Brow Ridge\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Eyebrow Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The forehead has a softer, less prominent ridge than the ideal, reducing masculine definition.\",\n      severity_labels: { minor: \"Slightly Soft\", moderate: \"Soft\", severe: \"Very Weak\" }\n    }\n  },\n  {\n    id: \"droopy_nasal_tip\",\n    title: \"Droopy Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\", \"Nasofacial Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip points downward more than ideal, creating a drooping appearance.\",\n      severity_labels: { minor: \"Slightly Droopy\", moderate: \"Droopy\", severe: \"Very Droopy\" }\n    }\n  },\n  {\n    id: \"overprojected_nose\",\n    title: \"Overprojected Nose\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Projection\", \"Nasofacial Angle\", \"Nose Length Ratio\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nose projects too far forward relative to the face, creating imbalance.\",\n      severity_labels: { minor: \"Slightly Projected\", moderate: \"Overprojected\", severe: \"Very Overprojected\" }\n    }\n  },\n  {\n    id: \"small_eyes\",\n    title: \"Small Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Palpebral Fissure Length\", \"Eye Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes appear smaller than the aesthetic ideal relative to the face.\",\n      severity_labels: { minor: \"Slightly Small\", moderate: \"Small\", severe: \"Very Small\" }\n    }\n  },\n  {\n    id: \"low_set_eyebrows\",\n    title: \"Low-Set Eyebrows\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow to Hairline Distance\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyebrows sit lower than ideal, reducing the visible upper eyelid space.\",\n      severity_labels: { minor: \"Slightly Low\", moderate: \"Low\", severe: \"Very Low\" }\n    }\n  },\n  {\n    id: \"asymmetrical_face\",\n    title: \"Facial Asymmetry\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The left and right sides of the face show noticeable differences in proportion or position.\",\n      severity_labels: { minor: \"Slight Asymmetry\", moderate: \"Noticeable Asymmetry\", severe: \"Significant Asymmetry\" }\n    }\n  },\n  // --- STRENGTHS ---\n  {\n    id: \"good_jaw_width\",\n    title: \"Good Jaw Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Bigonial Width\", \"Jaw Width Ratio\", \"Jaw Frontal Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant jaw contour due to the jaw being neither too wide nor too narrow.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"good_forehead_slope\",\n    title: \"Good Forehead Slope\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Forehead Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant forehead contour by indicating that the forehead is neither too steep nor too flat.\",\n      grade_labels: { good: \"Good Slope\", excellent: \"Well-Angled\", ideal: \"Ideal Slope\" }\n    }\n  },\n  {\n    id: \"good_cupids_bow\",\n    title: \"Good Cupid's Bow Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cupids Bow Depth\", \"Upper Lip Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lip region due to the cupid's bow having ideal definition and depth.\",\n      grade_labels: { good: \"Defined\", excellent: \"Well-Defined\", ideal: \"Perfectly Defined\" }\n    }\n  },\n  {\n    id: \"good_eyebrow_length\",\n    title: \"Good Eyebrow Length\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Brow Length to Face Width Ratio\", \"Brow Length Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious eye region due to the eyebrows having ideal horizontal length relative to face width.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Well-Proportioned\", ideal: \"Ideal Length\" }\n    }\n  },\n  {\n    id: \"good_neck_width\",\n    title: \"Good Neck Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Neck Width\", \"Neck to Jaw Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lower face due to the neck being neither too wide nor too thin.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"ideal_nasolabial_angle\",\n    title: \"Ideal Nasolabial Angle\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The angle between nose and upper lip is in the ideal range, creating profile harmony.\",\n      grade_labels: { good: \"Good Angle\", excellent: \"Well-Angled\", ideal: \"Perfect Angle\" }\n    }\n  },\n  {\n    id: \"ideal_facial_depth\",\n    title: \"Ideal Facial Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Depth to Height Ratio\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face has ideal forward projection creating attractive three-dimensional contours.\",\n      grade_labels: { good: \"Good Depth\", excellent: \"Well-Projected\", ideal: \"Ideal Projection\" }\n    }\n  },\n  {\n    id: \"ideal_eye_shape\",\n    title: \"Ideal Eye Shape\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Lateral Canthal Tilt\", \"Palpebral Fissure Length\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes have an attractive almond shape with ideal proportions and tilt.\",\n      grade_labels: { good: \"Attractive\", excellent: \"Well-Shaped\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"harmonious_profile\",\n    title: \"Harmonious Profile\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Total Profile Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The facial profile shows excellent balance between nose, lips, and chin positions.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfect Profile\" }\n    }\n  },\n  {\n    id: \"good_facial_symmetry\",\n    title: \"Good Facial Symmetry\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays excellent bilateral symmetry, a key component of attractiveness.\",\n      grade_labels: { good: \"Symmetric\", excellent: \"Very Symmetric\", ideal: \"Near-Perfect Symmetry\" }\n    }\n  }\n];\n\n// ============================================\n// METRIC NAME MAPPING\n// ============================================\n\n// Map display names to metric IDs for lookup\nconst METRIC_NAME_TO_ID: Record<string, string> = {\n  // Face Shape/Proportions\n  \"Face Width to Height Ratio\": \"faceWidthToHeight\",\n  \"Total Facial Width to Height\": \"totalFacialWidthToHeight\",\n  \"Total Facial Width to Height Ratio\": \"totalFacialWidthToHeight\",\n  \"Midface Ratio\": \"midfaceRatio\",\n  \"Upper Third Proportion\": \"upperThirdProportion\",\n  \"Middle Third Proportion\": \"middleThirdProportion\",\n  \"Lower Third Proportion\": \"lowerThirdProportion\",\n  \"Cheekbone Height\": \"cheekboneHeight\",\n  \"Cheekbone Width\": \"cheekboneWidth\",\n  \"Bitemporal Width\": \"bitemporalWidth\",\n  \"Forehead Height\": \"foreheadHeight\",\n  \"Facial Asymmetry Index\": \"facialAsymmetryIndex\",\n\n  // Jaw\n  \"Gonial Angle\": \"gonialAngle\",\n  \"Mandibular Plane Angle\": \"mandibularPlaneAngle\",\n  \"Jaw Width Ratio\": \"jawWidthRatio\",\n  \"Bigonial Width\": \"bigonialWidth\",\n  \"Jaw Frontal Angle\": \"jawFrontalAngle\",\n  \"Jaw Slope\": \"jawSlope\",\n  \"Jaw Asymmetry\": \"jawAsymmetry\",\n\n  // Chin\n  \"Chin to Philtrum Ratio\": \"chinPhiltrumRatio\",\n  \"Chin Height\": \"chinHeight\",\n  \"Facial Depth to Height\": \"facialDepthToHeight\",\n  \"Facial Depth to Height Ratio\": \"facialDepthToHeight\",\n  \"Anterior Facial Depth\": \"anteriorFacialDepth\",\n  \"Recession Relative to Frankfort Plane\": \"recessionFrankfort\",\n\n  // Eyes\n  \"Lateral Canthal Tilt\": \"lateralCanthalTilt\",\n  \"Eye Aspect Ratio\": \"eyeAspectRatio\",\n  \"Eye Separation Ratio\": \"eyeSeparationRatio\",\n  \"Interpupillary Ratio\": \"interpupillaryRatio\",\n  \"One Eye Apart Test\": \"oneEyeApartTest\",\n  \"Intercanthal Width\": \"intercanthalWidth\",\n  \"Eyebrow Height\": \"eyebrowHeight\",\n  \"Brow Length Ratio\": \"browLengthRatio\",\n  \"Brow Length to Face Width Ratio\": \"browLengthToFaceWidth\",\n  \"Palpebral Fissure Length\": \"palpebralFissureLength\",\n  \"Eye Width\": \"eyeWidth\",\n  \"Eye Asymmetry\": \"eyeAsymmetry\",\n  \"Brow to Hairline Distance\": \"browToHairlineDistance\",\n\n  // Brow\n  \"Browridge Inclination Angle\": \"browridgeInclinationAngle\",\n\n  // Nose\n  \"Nasal Index\": \"nasalIndex\",\n  \"Nasal Tip Angle\": \"nasalTipAngle\",\n  \"Nose Tip Position\": \"noseTipPosition\",\n  \"Frankfort-tip Angle\": \"frankfortTipAngle\",\n  \"Nasofrontal Angle\": \"nasofrontalAngle\",\n  \"Nasofacial Angle\": \"nasofacialAngle\",\n  \"Nasomenta Angle\": \"nasomentaAngle\",\n  \"Nasomental Angle\": \"nasomentaAngle\",\n  \"Intercanthal Nasal Ratio\": \"intercanthalNasalRatio\",\n  \"Nose Bridge Width\": \"noseBridgeWidth\",\n  \"Nose Width\": \"noseWidth\",\n  \"Nasal Projection\": \"nasalProjection\",\n  \"Nose Length Ratio\": \"noseLengthRatio\",\n  \"Ipsilateral Alar Angle\": \"ipsilateralAlarAngle\",\n\n  // Lips\n  \"Lip Ratio\": \"lipRatio\",\n  \"Philtrum Length\": \"philtrumLength\",\n  \"Upper Lip Projection\": \"upperLipProjection\",\n  \"Lower Lip Projection\": \"lowerLipProjection\",\n  \"Lip Chin Distance\": \"lipChinDistance\",\n  \"Upper Lip Height\": \"upperLipHeight\",\n  \"Upper Lip E-Line Position\": \"upperLipELine\",\n  \"Upper Lip S-Line Position\": \"upperLipSLine\",\n  \"Nasolabial Angle\": \"nasolabialAngle\",\n  \"Cupids Bow Depth\": \"cupidsBowDepth\",\n\n  // Neck\n  \"Neck Width\": \"neckWidth\",\n  \"Neck to Jaw Ratio\": \"neckToJawRatio\",\n\n  // Profile\n  \"Total Profile Angle\": \"totalProfileAngle\",\n};\n\n// ============================================\n// CLASSIFICATION FUNCTIONS\n// ============================================\n\n/**\n * Get weakness severity based on average score\n * 0-3 = \"Severe\", 3-5 = \"Moderate\", 5-7 = \"Minor\"\n */\nfunction getWeaknessSeverity(avgScore: number): WeaknessSeverity {\n  if (avgScore <= 3) return 'severe';\n  if (avgScore <= 5) return 'moderate';\n  return 'minor';\n}\n\n/**\n * Get strength grade based on average score\n * 8-9 = \"Good\", 9-9.5 = \"Excellent\", 9.5-10 = \"Ideal\"\n */\nfunction getStrengthGrade(avgScore: number): StrengthGrade {\n  if (avgScore >= 9.5) return 'ideal';\n  if (avgScore >= 9) return 'excellent';\n  return 'good';\n}\n\n/**\n * Find metric by display name from measurements array\n */\nfunction findMetricByName(\n  metricName: string,\n  measurements: MetricScoreResult[]\n): MetricScoreResult | undefined {\n  // First try direct ID mapping\n  const metricId = METRIC_NAME_TO_ID[metricName];\n  if (metricId) {\n    return measurements.find(m => m.metricId === metricId);\n  }\n\n  // Fallback: try fuzzy matching on name\n  const normalizedName = metricName.toLowerCase().replace(/[^a-z0-9]/g, '');\n  return measurements.find(m => {\n    const normalizedMetricName = m.name.toLowerCase().replace(/[^a-z0-9]/g, '');\n    return normalizedMetricName.includes(normalizedName) ||\n           normalizedName.includes(normalizedMetricName);\n  });\n}\n\n/**\n * Check if a metric should be considered a \"false positive\" weakness.\n * This handles directional/dimorphic metrics where low scores don't mean weakness.\n *\n * Example: Canthal Tilt of 3° gets a low score (not in 6-8° ideal range)\n * but is still a POSITIVE trait, not a weakness.\n */\nfunction isFalsePositiveWeakness(metric: MatchedMetric): boolean {\n  const config = METRIC_CONFIGS[metric.metricId];\n  if (!config) return false;\n\n  // Check if the value is actually acceptable based on polarity\n  const { acceptable } = isValueAcceptable(metric.value, config);\n  return acceptable;\n}\n\n/**\n * Process all insight definitions against user's measurements\n */\nexport function classifyInsights(\n  measurements: MetricScoreResult[],\n  insightDefinitions: InsightDefinition[] = INSIGHTS_DEFINITIONS\n): InsightClassificationResult {\n  const strengths: ClassifiedStrength[] = [];\n  const weaknesses: ClassifiedWeakness[] = [];\n\n  for (const insight of insightDefinitions) {\n    const { metrics, threshold } = insight.severity_logic;\n\n    // Find matching measurements for this insight\n    const matchedMetrics: MatchedMetric[] = [];\n    for (const metricName of metrics) {\n      const measurement = findMetricByName(metricName, measurements);\n      if (measurement) {\n        matchedMetrics.push({\n          metricId: measurement.metricId,\n          metricName: measurement.name,\n          score: measurement.score,\n          value: measurement.value,\n          idealMin: measurement.idealMin,\n          idealMax: measurement.idealMax,\n          unit: measurement.unit,\n          category: measurement.category,\n        });\n      }\n    }\n\n    // Skip if no metrics matched (need at least 1)\n    if (matchedMetrics.length === 0) continue;\n\n    // Calculate average score\n    const avgScore = matchedMetrics.reduce((sum, m) => sum + m.score, 0) / matchedMetrics.length;\n\n    // Classify based on type and threshold\n    if (insight.type === 'weakness') {\n      // Weakness: avg < threshold → add to areas of improvement\n      if (avgScore < threshold) {\n        // ========== FALSE POSITIVE CHECK ==========\n        // Before adding to weaknesses, check if ANY of the matched metrics\n        // are actually in an \"acceptable\" zone based on their polarity.\n        // If so, this is a false positive and should be skipped or reclassified.\n        const falsePositiveMetrics = matchedMetrics.filter(isFalsePositiveWeakness);\n\n        // If ALL matched metrics are false positives, skip this weakness entirely\n        if (falsePositiveMetrics.length === matchedMetrics.length) {\n          // This is a false positive weakness - the values are actually acceptable\n          // Consider adding to strengths if scores are decent\n          if (avgScore >= 6) {\n            strengths.push({\n              insightId: `${insight.id}_acceptable`,\n              title: insight.title.replace('Negative', 'Neutral').replace('Weak', 'Moderate'),\n              description: `While not in the peak ideal range, the measured values are within acceptable limits.`,\n              grade: 'good',\n              gradeLabel: 'Acceptable',\n              avgScore,\n              matchedMetrics,\n            });\n          }\n          continue; // Skip adding as weakness\n        }\n\n        // If SOME metrics are false positives, filter them out\n        const trueWeaknessMetrics = matchedMetrics.filter(m => !isFalsePositiveWeakness(m));\n        if (trueWeaknessMetrics.length === 0) continue;\n\n        // Recalculate average with only true weakness metrics\n        const trueAvgScore = trueWeaknessMetrics.reduce((sum, m) => sum + m.score, 0) / trueWeaknessMetrics.length;\n\n        // Only add as weakness if true average is still below threshold\n        if (trueAvgScore < threshold) {\n          const severity = getWeaknessSeverity(trueAvgScore);\n          const labels = insight.content.severity_labels;\n          const severityLabel = labels?.[severity] || severity;\n\n          weaknesses.push({\n            insightId: insight.id,\n            title: insight.title,\n            description: insight.content.description,\n            severity,\n            severityLabel,\n            avgScore: trueAvgScore,\n            matchedMetrics: trueWeaknessMetrics,\n          });\n        }\n      }\n    } else {\n      // Strength: avg > threshold → add to key strengths\n      if (avgScore > threshold) {\n        const grade = getStrengthGrade(avgScore);\n        const labels = insight.content.grade_labels;\n        const gradeLabel = labels?.[grade] || grade;\n\n        strengths.push({\n          insightId: insight.id,\n          title: insight.title,\n          description: insight.content.description,\n          grade,\n          gradeLabel,\n          avgScore,\n          matchedMetrics,\n        });\n      }\n    }\n  }\n\n  // Sort by score (weaknesses by lowest score first, strengths by highest first)\n  weaknesses.sort((a, b) => a.avgScore - b.avgScore);\n  strengths.sort((a, b) => b.avgScore - a.avgScore);\n\n  return { strengths, weaknesses };\n}\n\n/**\n * Convert ClassifiedStrength to Strength type for UI compatibility\n */\nexport function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: classified.avgScore,\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  const impact = (10 - classified.avgScore) * 0.5;\n  const newRollingLost = rollingLost + impact;\n\n  return {\n    id: `insight_flaw_${classified.insightId}`,\n    flawName: `${classified.title} (${classified.severityLabel})`,\n    summary: classified.description,\n    harmonyPercentageLost: impact,\n    standardizedImpact: impact / 10,\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,\n    rollingHarmonyPercentageLost: newRollingLost,\n    rollingStandardizedImpact: newRollingLost / 10,\n  };\n}\n\n/**\n * Main function: Generate strengths and flaws from measurements using insights\n */\nexport function generateInsightBasedResults(\n  measurements: MetricScoreResult[]\n): { strengths: Strength[]; flaws: Flaw[] } {\n  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);\n\n  // Convert to UI-compatible types\n  const strengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n  let rollingLost = 0;\n  const flaws = classifiedWeaknesses.map((w, i) => {\n    const flaw = convertToFlaw(w, i, rollingLost);\n    rollingLost = flaw.rollingPointsDeducted || 0;\n    return flaw;\n  });\n\n  return { strengths, flaws };\n}\n","structuredPatch":[{"oldStart":2580,"oldLines":7,"newStart":2580,"newLines":7,"lines":["     responsibleRatios: classified.matchedMetrics.map(m => ({","       ratioName: m.metricName,","       ratioId: m.metricId,","-      score: m.score,","+      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow","       value: m.value,","       idealMin: m.idealMin,","       idealMax: m.idealMax,"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"da33a6b5-07c1-4070-be0c-d87a8653e424","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XCcsakh4hhSASQcNutHfhH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RKhQE8CFbEFVAXNX6qaFnA","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","old_string":"    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,","new_string":"    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1261,"cache_read_input_tokens":97296,"cache_creation":{"ephemeral_5m_input_tokens":1261,"ephemeral_1h_input_tokens":0},"output_tokens":376,"service_tier":"standard"}},"requestId":"req_011CWUrciwZUTmroHDNJXXJ6","type":"assistant","uuid":"77cc38a2-b636-4c9c-86e6-a091c2bf125f","timestamp":"2025-12-26T06:52:06.064Z"}
{"parentUuid":"77cc38a2-b636-4c9c-86e6-a091c2bf125f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RKhQE8CFbEFVAXNX6qaFnA","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2603→    summary: classified.description,\n  2604→    harmonyPercentageLost: impact,\n  2605→    standardizedImpact: impact / 10,\n  2606→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2607→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2608→      ratioName: m.metricName,\n  2609→      ratioId: m.metricId,\n  2610→      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n  2611→      value: m.value,\n  2612→      idealMin: m.idealMin,\n  2613→      idealMax: m.idealMax,\n  2614→      unit: m.unit,\n  2615→      category: m.category,\n  2616→    })),\n  2617→    rollingPointsDeducted: newRollingLost,\n  2618→    rollingHarmonyPercentageLost: newRollingLost,\n  2619→    rollingStandardizedImpact: newRollingLost / 10,\n  2620→  };\n  2621→}"}]},"uuid":"65267124-3172-42a3-a8d7-709d29a339f0","timestamp":"2025-12-26T06:52:06.110Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","oldString":"    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,","newString":"    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,","originalFile":"/**\n * Insights Engine\n *\n * Processes insight definitions from insights.json and classifies them\n * as strengths or areas of improvement based on user's metric scores.\n *\n * Logic:\n * - For each insight definition, calculate average score of affected metrics\n * - Weakness: if avg score < threshold → classify with severity label\n * - Strength: if avg score > threshold → classify with grade label\n *\n * Z-Score Based 5-Tier Severity Logic:\n * - Ideal (Green): User is inside the ideal range\n * - Good (Blue): Within 0.5 Standard Deviation of the mean (|z| < 0.5)\n * - Fair (Cyan): Between 0.5 and 1 Standard Deviation (0.5 ≤ |z| < 1)\n * - Moderate (Yellow): Between 1 and 2 Standard Deviations (1 ≤ |z| < 2)\n * - Severe (Red): More than 2 Standard Deviations away (|z| ≥ 2)\n *\n * Severity Labels (Weaknesses):\n *   0-3 = \"Severe\"\n *   3-5 = \"Moderate\"\n *   5-7 = \"Minor\"\n *\n * Grade Labels (Strengths):\n *   8-9   = \"Good\"\n *   9-9.5 = \"Excellent\"\n *   9.5-10 = \"Ideal\"\n */\n\nimport { Strength, Flaw } from '@/types/results';\nimport { MetricScoreResult, METRIC_CONFIGS, isValueAcceptable } from '@/lib/harmony-scoring';\n\n// ============================================\n// MASTER SCORING DATABASE (Z-Score Based)\n// ============================================\n\nexport type SeverityLevel = 'ideal' | 'good' | 'fair' | 'moderate' | 'severe';\nexport type Gender = 'male' | 'female';\nexport type Ethnicity = 'white' | 'black' | 'east_asian' | 'south_asian' | 'hispanic' | 'middle_eastern' | 'native_american' | 'pacific_islander';\n\nexport interface MasterMetricConfig {\n  ideal: [number, number];  // [min, max] ideal range\n  mean: number;             // Population mean\n  std_dev: number;          // Standard deviation\n  flaws?: {\n    low?: string[];         // Flaws when value is too low\n    high?: string[];        // Flaws when value is too high\n  };\n}\n\n// Base/Default standards (White Male baseline)\nexport const MASTER_SCORING_DB: Record<string, MasterMetricConfig> = {\n  // MIDFACE & PROPORTIONS\n  \"midface_ratio\": {\n    ideal: [0.97, 1.00],\n    mean: 1.0,\n    std_dev: 0.115,\n    flaws: { low: [\"Long midface\", \"Long upper jaw\"] }\n  },\n  \"faceWidthToHeight\": {\n    ideal: [1.30, 1.45],\n    mean: 1.38,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Overly long face\", \"Narrow face\"],\n      high: [\"Wide face\", \"Short face\"]\n    }\n  },\n  \"totalFacialWidthToHeight\": {\n    ideal: [1.25, 1.40],\n    mean: 1.33,\n    std_dev: 0.075,\n    flaws: {\n      low: [\"Long face shape\"],\n      high: [\"Wide face shape\"]\n    }\n  },\n  \"upperThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Long forehead\"]\n    }\n  },\n  \"middleThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short midface\"],\n      high: [\"Long midface\"]\n    }\n  },\n  \"lowerThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short lower face\"],\n      high: [\"Long lower face\"]\n    }\n  },\n\n  // EYE SPACING & IPD\n  \"eye_separation_ratio\": {\n    ideal: [0.45, 0.47],\n    mean: 0.46,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"interpupillaryRatio\": {\n    ideal: [0.44, 0.48],\n    mean: 0.46,\n    std_dev: 0.025,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"oneEyeApartTest\": {\n    ideal: [0.95, 1.05],\n    mean: 1.0,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"intercanthalWidth\": {\n    ideal: [30, 35],\n    mean: 32.5,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Narrow eye spacing\"],\n      high: [\"Wide eye spacing\"]\n    }\n  },\n\n  // EYE SHAPE & FEATURES\n  \"lateralCanthalTilt\": {\n    ideal: [6, 8],\n    mean: 5.0,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Negative canthal tilt\", \"Downturned eyes\"],\n      high: [\"Excessively upturned eyes\"]\n    }\n  },\n  \"eyeAspectRatio\": {\n    ideal: [0.30, 0.35],\n    mean: 0.32,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Round eyes\"]\n    }\n  },\n  \"palpebralFissureLength\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Small eyes\"],\n      high: [\"Large eyes\"]\n    }\n  },\n  \"eyeWidth\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Wide eyes\"]\n    }\n  },\n  \"upperEyelidExposure\": {\n    ideal: [0.5, 1.2],\n    mean: 0.85,\n    std_dev: 0.35,\n    flaws: {\n      low: [\"Hooded eyes\"],\n      high: [\"Excessive upper lid exposure\"]\n    }\n  },\n  \"tearTroughDepth\": {\n    ideal: [0.0, 0.3],\n    mean: 0.15,\n    std_dev: 0.15,\n    flaws: {\n      high: [\"Dark circles / Tear troughs\", \"Under-eye hollowness\"]\n    }\n  },\n\n  // JAW ANGLES & STRUCTURE\n  \"gonial_angle\": {\n    ideal: [115, 125],\n    mean: 118.0,\n    std_dev: 6.5,\n    flaws: {\n      high: [\"Weak/soft jaw structure\", \"Rounded jaw\"]\n    }\n  },\n  \"mandibularPlaneAngle\": {\n    ideal: [20, 28],\n    mean: 24.0,\n    std_dev: 4.0,\n    flaws: {\n      low: [\"Flat mandibular plane\"],\n      high: [\"Steep mandibular plane\", \"Hyper-divergent jaw\"]\n    }\n  },\n  \"jawFrontalAngle\": {\n    ideal: [125, 135],\n    mean: 130.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Steep jaw\"],\n      high: [\"Flat jaw angle\"]\n    }\n  },\n  \"jawSlope\": {\n    ideal: [25, 35],\n    mean: 30.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat jawline\"],\n      high: [\"Steep jawline\"]\n    }\n  },\n\n  // JAW WIDTH\n  \"jawWidthRatio\": {\n    ideal: [0.85, 0.95],\n    mean: 0.90,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Narrow jaw\"],\n      high: [\"Wide jaw\"]\n    }\n  },\n  \"bigonialWidth\": {\n    ideal: [110, 125],\n    mean: 117.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow jaw width\"],\n      high: [\"Excessively wide jaw\"]\n    }\n  },\n\n  // CHEEKBONES\n  \"cheekbone_height\": {\n    ideal: [83.0, 100.0],\n    mean: 85.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Low-set cheekbones\", \"Flat midface\"]\n    }\n  },\n  \"cheekboneWidth\": {\n    ideal: [130, 145],\n    mean: 137.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow cheekbones\"],\n      high: [\"Wide cheekbones\"]\n    }\n  },\n\n  // CHIN\n  \"chinPhiltrumRatio\": {\n    ideal: [1.8, 2.2],\n    mean: 2.0,\n    std_dev: 0.2,\n    flaws: {\n      low: [\"Recessed chin\", \"Short chin\"],\n      high: [\"Long chin\", \"Projected chin\"]\n    }\n  },\n  \"chinHeight\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short chin\"],\n      high: [\"Long chin\"]\n    }\n  },\n  \"chinWidth\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Pointed/Narrow chin\"],\n      high: [\"Wide chin\"]\n    }\n  },\n\n  // NOSE ANGLES\n  \"nasalTipAngle\": {\n    ideal: [95, 115],\n    mean: 105.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nasal tip\"]\n    }\n  },\n  \"nasolabialAngle\": {\n    ideal: [95, 110],\n    mean: 102.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nose\"]\n    }\n  },\n  \"nasofrontalAngle\": {\n    ideal: [115, 135],\n    mean: 125.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Deep nasal root\"],\n      high: [\"Flat nasal root\"]\n    }\n  },\n  \"nasofacialAngle\": {\n    ideal: [30, 40],\n    mean: 35.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat nose profile\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"nasomentaAngle\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // NOSE WIDTH & PROPORTIONS\n  \"nasalIndex\": {\n    ideal: [65, 75],\n    mean: 70.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nose\", \"Bulbous nose\"]\n    }\n  },\n  \"noseWidth\": {\n    ideal: [35, 42],\n    mean: 38.5,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nasal base\"]\n    }\n  },\n  \"noseBridgeWidth\": {\n    ideal: [12, 18],\n    mean: 15.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Narrow nose bridge\"],\n      high: [\"Wide nose bridge\"]\n    }\n  },\n  \"nasalProjection\": {\n    ideal: [16, 22],\n    mean: 19.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Underprojected nose\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"noseLengthRatio\": {\n    ideal: [0.45, 0.55],\n    mean: 0.50,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short nose\"],\n      high: [\"Long nose\"]\n    }\n  },\n\n  // LIPS & PHILTRUM\n  \"lipRatio\": {\n    ideal: [1.4, 1.6],\n    mean: 1.5,\n    std_dev: 0.15,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"philtrumLength\": {\n    ideal: [11, 15],\n    mean: 13.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Short philtrum\"],\n      high: [\"Long philtrum\"]\n    }\n  },\n  \"upperLipHeight\": {\n    ideal: [18, 24],\n    mean: 21.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"lipChinDistance\": {\n    ideal: [40, 50],\n    mean: 45.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short lower third\"],\n      high: [\"Long lower third\"]\n    }\n  },\n  \"upperLipProjection\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed upper lip\"],\n      high: [\"Protruding upper lip\"]\n    }\n  },\n  \"lowerLipProjection\": {\n    ideal: [-1, 3],\n    mean: 1.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed lower lip\"],\n      high: [\"Protruding lower lip\"]\n    }\n  },\n  \"cupidsBowDepth\": {\n    ideal: [3, 6],\n    mean: 4.5,\n    std_dev: 1.5,\n    flaws: {\n      low: [\"Flat cupid's bow\"],\n      high: [\"Pronounced cupid's bow\"]\n    }\n  },\n\n  // EYEBROWS\n  \"eyebrowHeight\": {\n    ideal: [8, 14],\n    mean: 11.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Low-set eyebrows\"],\n      high: [\"High eyebrows\"]\n    }\n  },\n  \"browLengthRatio\": {\n    ideal: [0.50, 0.60],\n    mean: 0.55,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browLengthToFaceWidth\": {\n    ideal: [0.30, 0.38],\n    mean: 0.34,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browridgeInclinationAngle\": {\n    ideal: [10, 20],\n    mean: 15.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat brow ridge\"],\n      high: [\"Prominent brow ridge\"]\n    }\n  },\n  \"eyebrowThickness\": {\n    ideal: [1.5, 3.0],\n    mean: 2.25,\n    std_dev: 0.75,\n    flaws: {\n      low: [\"Sparse/Weak eyebrows\"],\n      high: [\"Overly thick eyebrows\"]\n    }\n  },\n\n  // FOREHEAD\n  \"foreheadHeight\": {\n    ideal: [55, 70],\n    mean: 62.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Tall forehead\"]\n    }\n  },\n  \"bitemporalWidth\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow forehead\"],\n      high: [\"Wide forehead\"]\n    }\n  },\n\n  // PROFILE & DEPTH\n  \"facialDepthToHeight\": {\n    ideal: [0.75, 0.85],\n    mean: 0.80,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Flat facial profile\"],\n      high: [\"Overprojected profile\"]\n    }\n  },\n  \"anteriorFacialDepth\": {\n    ideal: [115, 130],\n    mean: 122.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Shallow face depth\"],\n      high: [\"Deep face projection\"]\n    }\n  },\n  \"totalProfileAngle\": {\n    ideal: [165, 175],\n    mean: 170.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // ASYMMETRY\n  \"facialAsymmetryIndex\": {\n    ideal: [0, 3],\n    mean: 2.0,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Facial asymmetry\"]\n    }\n  },\n  \"eyeAsymmetry\": {\n    ideal: [0, 2],\n    mean: 1.0,\n    std_dev: 1.0,\n    flaws: {\n      high: [\"Eye asymmetry\"]\n    }\n  },\n  \"jawAsymmetry\": {\n    ideal: [0, 3],\n    mean: 1.5,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Jaw asymmetry\"]\n    }\n  },\n\n  // OTHER\n  \"recessionFrankfort\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Maxillary recession\"],\n      high: [\"Maxillary protrusion\"]\n    }\n  },\n  \"neckWidth\": {\n    ideal: [110, 130],\n    mean: 120.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Wide neck\"]\n    }\n  },\n  \"neckToJawRatio\": {\n    ideal: [0.90, 1.10],\n    mean: 1.0,\n    std_dev: 0.10,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Thick neck\"]\n    }\n  }\n};\n\n// ============================================\n// ETHNICITY-SPECIFIC OVERRIDES\n// ============================================\n\n/**\n * Ethnicity and gender-specific metric standards\n * These override the base MASTER_SCORING_DB values for specific populations\n */\nexport const ETHNICITY_OVERRIDES: Record<string, Record<string, Partial<MasterMetricConfig>>> = {\n  // ========================================\n  // MALE WHITE STANDARDS (Neoclassical Baseline)\n  // ========================================\n  \"male_white\": {\n    // NOSE WIDTH - Strict 1:1 ratio (Eye Width = Nose Width)\n    \"noseWidth\": {\n      ideal: [35, 42],  // Corresponds to alar_base_ratio [0.98, 1.05]\n      mean: 38.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // MIDFACE - Prefers compact midface (Hunter look)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    },\n\n    // JAW - Square/Robust jaw preference\n    \"gonial_angle\": {\n      ideal: [115.0, 125.0],\n      mean: 120.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/Soft jaw structure\"]\n      }\n    },\n\n    // FACE WIDTH - Standard Mesoprosopic range\n    \"faceWidthToHeight\": {\n      ideal: [1.90, 2.05],\n      mean: 1.975,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Short/Wide face\"]\n      }\n    },\n\n    // EYE TILT - Neutral to slightly positive\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 8.0],\n      mean: 6.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Negative canthal tilt\"]\n      }\n    },\n\n    // LOWER FACE BALANCE\n    \"chinPhiltrumRatio\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Long philtrum / Short chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE BLACK / AFRICAN STANDARDS\n  // ========================================\n  \"male_black\": {\n    // NOSE WIDTH - Significantly wider tolerance\n    \"noseWidth\": {\n      ideal: [40, 50],  // Wider range (corresponds to alar_base_ratio [1.12, 1.25])\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n    \"nasalIndex\": {\n      ideal: [80, 95],  // Wider nasal index\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n\n    // LIPS - Prefers fuller lips\n    \"lipRatio\": {\n      ideal: [1.2, 1.5],\n      mean: 1.35,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    },\n\n    // PHILTRUM - Shorter visible philtrum is ideal\n    \"philtrumLength\": {\n      ideal: [11.0, 14.0],\n      mean: 12.5,\n      std_dev: 1.5,\n      flaws: {\n        high: [\"Long philtrum\"]\n      }\n    },\n\n    // CHIN - Adjusts for natural forward mouth projection (Prognathism)\n    \"chinPhiltrumRatio\": {\n      ideal: [1.80, 2.10],  // Lower range to account for prognathism\n      mean: 1.95,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Recessed chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE EAST ASIAN STANDARDS\n  // ========================================\n  \"male_east_asian\": {\n    // EYE SPACING - Shifted WIDER for East Asian males\n    \"eye_separation_ratio\": {\n      ideal: [0.48, 0.53],  // Shifted wider (0.46 is \"close-set\" here)\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n    \"interpupillaryRatio\": {\n      ideal: [0.48, 0.53],\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n\n    // EYE SHAPE - Prefers narrower/longer eyes (Hunter Eyes)\n    \"eyeAspectRatio\": {\n      ideal: [0.25, 0.29],  // Lower ratio = more elongated\n      mean: 0.27,\n      std_dev: 0.02,\n      flaws: {\n        low: [\"Overly narrow eyes\"],\n        high: [\"Overly round eye shape\"]\n      }\n    },\n    \"palpebralFissureLength\": {\n      ideal: [29, 33],\n      mean: 31.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Small eyes\"],\n        high: [\"Large eyes\"]\n      }\n    },\n\n    // NOSE - Asian noses typically allowed to be wider\n    \"nasalIndex\": {\n      ideal: [75, 85],\n      mean: 80.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n    \"noseWidth\": {\n      ideal: [38, 45],\n      mean: 41.5,\n      std_dev: 3.5,\n      flaws: {\n        low: [\"Narrow nose\"],\n        high: [\"Very wide nasal base\"]\n      }\n    },\n    \"noseBridgeWidth\": {\n      ideal: [14, 20],\n      mean: 17.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Narrow nose bridge\"],\n        high: [\"Wide nose bridge\"]\n      }\n    },\n\n    // CHEEKS - Rewards slightly fuller cheeks (Youth/K-Pop aesthetic)\n    \"cheekbone_height\": {\n      ideal: [80.0, 95.0],\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Hollow face\"]\n      }\n    },\n\n    // JAW - Slightly softer angles acceptable\n    \"gonial_angle\": {\n      ideal: [118, 128],\n      mean: 123.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/soft jaw structure\"]\n      }\n    },\n    \"mandibularPlaneAngle\": {\n      ideal: [20, 30],\n      mean: 25.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Flat mandibular plane\"],\n        high: [\"Steep mandibular plane\"]\n      }\n    },\n\n    // FACIAL PROPORTIONS - Wider faces more common\n    \"faceWidthToHeight\": {\n      ideal: [1.35, 1.50],\n      mean: 1.425,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n    \"totalFacialWidthToHeight\": {\n      ideal: [1.30, 1.45],\n      mean: 1.375,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face shape\"],\n        high: [\"Wide face shape\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE SOUTH ASIAN STANDARDS\n  // ========================================\n  \"male_south_asian\": {\n    // NOSE WIDTH - Slightly wider tolerance than White\n    \"noseWidth\": {\n      ideal: [36, 43],  // alar_base_ratio [1.00, 1.08]\n      mean: 39.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // TEAR TROUGH - VERY STRICT. High penalty for dark circles\n    \"tearTroughDepth\": {\n      ideal: [0.0, 0.5],\n      mean: 0.25,\n      std_dev: 0.25,\n      flaws: {\n        high: [\"Dark circles / Tear troughs\"]\n      }\n    },\n\n    // UPPER EYELID - Often prefers visible lid platform\n    \"upperEyelidExposure\": {\n      ideal: [0.5, 2.0],\n      mean: 1.25,\n      std_dev: 0.75,\n      flaws: {\n        low: [\"Hooded eyes\"]\n      }\n    },\n\n    // CHEEKS - Penalizes \"Gaunt\" looks heavily\n    \"cheekbone_height\": {\n      ideal: [83.0, 95.0],\n      mean: 89.0,\n      std_dev: 6.0,\n      flaws: {\n        low: [\"Volume loss / Gauntness\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE HISPANIC STANDARDS (\"The Bridge Model\")\n  // ========================================\n  \"male_hispanic\": {\n    // FACE WIDTH - Rewards broader, more robust face shapes (Mestizo)\n    \"faceWidthToHeight\": {\n      ideal: [1.95, 2.10],\n      mean: 2.025,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long/Narrow face\"]\n      }\n    },\n\n    // NOSE WIDTH - Bridge tolerance (Wider than White, narrower than Black)\n    \"noseWidth\": {\n      ideal: [36, 44],  // alar_base_ratio [1.00, 1.12]\n      mean: 40.0,\n      std_dev: 4.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for positive tilt\n    \"lateralCanthalTilt\": {\n      ideal: [6.0, 12.0],\n      mean: 9.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Negative/Neutral canthal tilt\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE MIDDLE EASTERN STANDARDS\n  // ========================================\n  \"male_middle_eastern\": {\n    // EYEBROW THICKNESS - Prefers significantly thicker/darker brows\n    \"eyebrowThickness\": {\n      ideal: [2.0, 4.0],\n      mean: 3.0,\n      std_dev: 1.0,\n      flaws: {\n        low: [\"Sparse/Weak eyebrows\"],\n        high: [\"Unibrow\"]\n      }\n    },\n\n    // NASOLABIAL ANGLE - Penalizes droopy tip (<90) or hooked noses\n    \"nasolabialAngle\": {\n      ideal: [90.0, 100.0],\n      mean: 95.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Droopy nose tip / Hooked nose\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for Almond/Hunter eye shape\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 10.0],\n      mean: 7.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    },\n\n    // MIDFACE - Similar to White model (Compact is better)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE PACIFIC ISLANDER STANDARDS (\"The Warrior Skull\")\n  // ========================================\n  \"male_pacific_islander\": {\n    // FACE WIDTH - The Highest Width Standard (Very broad)\n    \"faceWidthToHeight\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Narrow/Long face\"]\n      }\n    },\n\n    // NOSE WIDTH - Wide tolerance\n    \"noseWidth\": {\n      ideal: [38, 48],  // alar_base_ratio [1.05, 1.20]\n      mean: 43.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // CHEEKS - Rewards high mass/robustness\n    \"cheekbone_height\": {\n      ideal: [85.0, 100.0],\n      mean: 92.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Weak face structure\"]\n      }\n    },\n\n    // CHIN WIDTH - Prefers a very broad, square chin\n    \"chinWidth\": {\n      ideal: [40.0, 50.0],\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Pointed/Narrow chin\"]\n      }\n    }\n  },\n\n  \"male_native_american\": {\n    \"faceWidthToHeight\": {\n      ideal: [2.00, 2.20],\n      mean: 2.10,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Wide face\"]\n      }\n    },\n\n    \"nasalIndex\": {\n      ideal: [75, 90],\n      mean: 82.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Narrow nose\"],\n        high: [\"Wide nose\"]\n      }\n    },\n\n    \"cheekbone_height\": {\n      ideal: [80.0, 95.0],\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Flat cheekbones\"]\n      }\n    },\n\n    \"gonialAngle\": {\n      ideal: [115, 125],\n      mean: 120,\n      std_dev: 5,\n      flaws: {\n        low: [\"Weak jaw\"],\n        high: [\"Harsh jaw angle\"]\n      }\n    },\n\n    \"chinWidth\": {\n      ideal: [38.0, 48.0],\n      mean: 43.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Narrow chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // FEMALE ETHNICITIES (The \"Missing Link\")\n  // ========================================\n\n  \"female_white\": {\n    // NOSE WIDTH - Strict Rule of Fifths for feminine harmony\n    \"alar_base_ratio\": {\n      ideal: [0.98, 1.05],\n      mean: 1.015,\n      std_dev: 0.035,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // FACE WIDTH - Prefers oval/narrow feminine proportions\n    \"fwhr\": {\n      ideal: [1.45, 1.53],\n      mean: 1.49,\n      std_dev: 0.04,\n      flaws: {\n        low: [\"Long/Narrow face\"],\n        high: [\"Wide face\"]\n      }\n    },\n\n    // JAW - Soft, tapered feminine jawline\n    \"gonial_angle\": {\n      ideal: [122.0, 130.0],\n      mean: 126.0,\n      std_dev: 4.0,\n      flaws: {\n        low: [\"Sharp/Masculine jaw angle\"],\n        high: [\"Weak/Overly soft jawline\"]\n      }\n    },\n\n    // EYE TILT - Neutral to positive preferred\n    \"canthal_tilt\": {\n      ideal: [4.0, 9.0],\n      mean: 6.5,\n      std_dev: 2.5,\n      flaws: {\n        low: [\"Negative/Downturned eyes\"]\n      }\n    },\n\n    // CHIN-PHILTRUM - Golden Ratio balance\n    \"chin_philtrum_ratio\": {\n      ideal: [2.0, 2.2],\n      mean: 2.1,\n      std_dev: 0.1,\n      flaws: {\n        low: [\"Recessed chin\"],\n        high: [\"Protruding chin\"]\n      }\n    }\n  },\n\n  \"female_black\": {\n    // LIPS - High volume preference (fuller lips)\n    \"lipRatio\": {\n      ideal: [1.3, 1.6],\n      mean: 1.45,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    },\n\n    // NOSE WIDTH - Wider tolerance for ethnic variation\n    \"alar_base_ratio\": {\n      ideal: [1.05, 1.15],\n      mean: 1.10,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Very wide nasal base\"]\n      }\n    },\n\n    // CHIN - Allows forward projection (natural prognathism)\n    \"chin_projection\": {\n      ideal: [0.0, 5.0],\n      mean: 2.5,\n      std_dev: 2.5,\n      flaws: {\n        high: [\"Excessive chin projection\"]\n      }\n    },\n\n    // JAW - Soft feminine jawline\n    \"gonial_angle\": {\n      ideal: [120.0, 130.0],\n      mean: 125.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Sharp jaw angle\"],\n        high: [\"Weak jawline\"]\n      }\n    }\n  },\n\n  \"female_east_asian\": {\n    // EYE SPACING - Wide-set neotenous preference\n    \"eye_separation_ratio\": {\n      ideal: [46.3, 47.5],\n      mean: 46.9,\n      std_dev: 0.6,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Very wide-set eyes\"]\n      }\n    },\n\n    // JAW - Tapered V-shape feminine ideal\n    \"gonial_angle\": {\n      ideal: [120.0, 126.0],\n      mean: 123.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Sharp V-line jaw\"],\n        high: [\"Weak/Square jawline\"]\n      }\n    },\n\n    // EYEBROWS - Higher set brows (youthful feminine)\n    \"eyebrow_height\": {\n      ideal: [0.85, 1.30],\n      mean: 1.075,\n      std_dev: 0.225,\n      flaws: {\n        low: [\"Low-set/Heavy brows\"],\n        high: [\"Very high-arched brows\"]\n      }\n    },\n\n    // LOWER FACE - Compact lower third (neotenous)\n    \"lower_third_ratio\": {\n      ideal: [29.6, 32.7],\n      mean: 31.15,\n      std_dev: 1.55,\n      flaws: {\n        low: [\"Very short lower face\"],\n        high: [\"Long lower face\"]\n      }\n    }\n  },\n\n  \"female_south_asian\": {\n    // TEAR TROUGHS - Very strict on dark circles\n    \"tear_trough_depth\": {\n      ideal: [0.0, 0.5],\n      mean: 0.25,\n      std_dev: 0.25,\n      flaws: {\n        high: [\"Dark circles / Deep tear troughs\"]\n      }\n    },\n\n    // CHEEKS - Rewards midface volume (youthful fullness)\n    \"cheek_fullness\": {\n      ideal: [1.0, 2.0],\n      mean: 1.5,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Gaunt/Hollow cheeks\"]\n      }\n    },\n\n    // SKIN - High penalty for uneven skin tone\n    \"skin_uniformity\": {\n      ideal: [0.92, 1.0],\n      mean: 0.96,\n      std_dev: 0.04,\n      flaws: {\n        low: [\"Uneven skin tone / Pigmentation\"]\n      }\n    },\n\n    // NOSE WIDTH - Intermediate tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.00, 1.08],\n      mean: 1.04,\n      std_dev: 0.04,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    }\n  },\n\n  \"female_hispanic\": {\n    // FACE WIDTH - Broader Mestiza tolerance\n    \"fwhr\": {\n      ideal: [1.50, 1.62],\n      mean: 1.56,\n      std_dev: 0.06,\n      flaws: {\n        low: [\"Long/Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // EYE TILT - Strong almond eye preference\n    \"canthal_tilt\": {\n      ideal: [6.0, 12.0],\n      mean: 9.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Neutral/Downturned eyes\"]\n      }\n    },\n\n    // NOSE WIDTH - Intermediate width tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.00, 1.10],\n      mean: 1.05,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // LIPS - Voluptuous preference\n    \"lipRatio\": {\n      ideal: [1.1, 1.35],\n      mean: 1.225,\n      std_dev: 0.125,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    }\n  },\n\n  \"female_middle_eastern\": {\n    // EYEBROWS - Dense/Thick brows preference\n    \"eyebrow_thickness\": {\n      ideal: [1.5, 3.0],\n      mean: 2.25,\n      std_dev: 0.75,\n      flaws: {\n        low: [\"Sparse/Thin eyebrows\"],\n        high: [\"Unibrow\"]\n      }\n    },\n\n    // NOSE - Refined/Upturned tip\n    \"nasolabial_angle\": {\n      ideal: [95.0, 105.0],\n      mean: 100.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Droopy nose tip\"],\n        high: [\"Overly upturned nose\"]\n      }\n    },\n\n    // EYE TILT - Foxy/Hunter feminine eye shape\n    \"canthal_tilt\": {\n      ideal: [5.0, 10.0],\n      mean: 7.5,\n      std_dev: 2.5,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    },\n\n    // EYELID - Low exposure preferred\n    \"upper_eyelid_exposure\": {\n      ideal: [0.5, 1.5],\n      mean: 1.0,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Hooded eyes\"],\n        high: [\"Excessive eyelid exposure\"]\n      }\n    }\n  },\n\n  \"female_native_american\": {\n    // FACE WIDTH - Wide/High cheekbone structure\n    \"fwhr\": {\n      ideal: [1.52, 1.65],\n      mean: 1.585,\n      std_dev: 0.065,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // CHEEKBONES - High definition/prominence\n    \"cheekbone_prominence\": {\n      ideal: [1.5, 2.5],\n      mean: 2.0,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Flat cheekbones\"],\n        high: [\"Overly prominent cheekbones\"]\n      }\n    },\n\n    // JAW - Stronger jaw tolerance\n    \"gonial_angle\": {\n      ideal: [115.0, 125.0],\n      mean: 120.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Very sharp jaw\"],\n        high: [\"Weak jawline\"]\n      }\n    },\n\n    // EYE TILT - Positive tilt preference\n    \"canthal_tilt\": {\n      ideal: [5.0, 11.0],\n      mean: 8.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    }\n  },\n\n  \"female_pacific_islander\": {\n    // FACE WIDTH - Widest/Robust facial structure\n    \"fwhr\": {\n      ideal: [1.55, 1.70],\n      mean: 1.625,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // CHEEKS - High volume/softness preference\n    \"cheek_fullness\": {\n      ideal: [1.2, 2.5],\n      mean: 1.85,\n      std_dev: 0.65,\n      flaws: {\n        low: [\"Gaunt/Hollow cheeks\"]\n      }\n    },\n\n    // NOSE WIDTH - Wide nose tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.05, 1.15],\n      mean: 1.10,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Very wide nasal base\"]\n      }\n    },\n\n    // LIPS - Full lips preference\n    \"lipRatio\": {\n      ideal: [1.25, 1.50],\n      mean: 1.375,\n      std_dev: 0.125,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    }\n  }\n};\n\n/**\n * Get the appropriate metric configuration for a given gender and ethnicity\n * Falls back to base config if no override exists\n */\nexport function getMetricConfig(\n  metricId: string,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): MasterMetricConfig | undefined {\n  const key = `${gender}_${ethnicity}`;\n  const override = ETHNICITY_OVERRIDES[key]?.[metricId];\n  const baseConfig = MASTER_SCORING_DB[metricId];\n\n  if (!baseConfig) return undefined;\n\n  // Merge override with base config\n  if (override) {\n    return {\n      ...baseConfig,\n      ...override,\n      flaws: {\n        ...baseConfig.flaws,\n        ...override.flaws\n      }\n    } as MasterMetricConfig;\n  }\n\n  return baseConfig;\n}\n\n// ============================================\n// Z-SCORE SEVERITY FUNCTIONS\n// ============================================\n\n/**\n * Calculate Z-score for a given value\n * Z = (value - mean) / std_dev\n */\nexport function calculateZScore(value: number, mean: number, stdDev: number): number {\n  if (stdDev === 0) return 0;\n  return Math.abs((value - mean) / stdDev);\n}\n\n/**\n * Determine severity level based on Z-score and ideal range (5-tier system)\n * - Ideal: Value is within ideal range\n * - Good: |z| < 0.5 (within 0.5 standard deviation)\n * - Fair: 0.5 ≤ |z| < 1 (between 0.5-1 standard deviations)\n * - Moderate: 1 ≤ |z| < 2 (between 1-2 standard deviations)\n * - Severe: |z| ≥ 2 (more than 2 standard deviations away)\n */\nexport function getSeverityFromZScore(\n  value: number,\n  config: MasterMetricConfig\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean } {\n  const { ideal, mean, std_dev } = config;\n  const isInIdeal = value >= ideal[0] && value <= ideal[1];\n  const zScore = calculateZScore(value, mean, std_dev);\n\n  let severity: SeverityLevel;\n  if (isInIdeal) {\n    severity = 'ideal';\n  } else if (zScore < 0.5) {\n    severity = 'good';\n  } else if (zScore < 1) {\n    severity = 'fair';\n  } else if (zScore < 2) {\n    severity = 'moderate';\n  } else {\n    severity = 'severe';\n  }\n\n  return { severity, zScore, isInIdeal };\n}\n\n/**\n * Get severity for a metric value with ethnicity/gender awareness\n */\nexport function getSeverityForMetric(\n  metricId: string,\n  value: number,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean; config: MasterMetricConfig } | null {\n  const config = getMetricConfig(metricId, gender, ethnicity);\n  if (!config) return null;\n\n  const result = getSeverityFromZScore(value, config);\n  return { ...result, config };\n}\n\n/**\n * Get badge color for severity level (5-tier)\n */\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'green';\n    case 'good': return 'blue';\n    case 'fair': return 'cyan';\n    case 'moderate': return 'yellow';\n    case 'severe': return 'red';\n    default: return 'gray';\n  }\n}\n\n/**\n * Get severity label for display (5-tier)\n */\nexport function getSeverityLabel(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'Ideal';\n    case 'good': return 'Good';\n    case 'fair': return 'Fair';\n    case 'moderate': return 'Moderate';\n    case 'severe': return 'Severe';\n    default: return 'Unknown';\n  }\n}\n\n// ============================================\n// INSIGHT DEFINITION TYPES\n// ============================================\n\nexport interface InsightSeverityLogic {\n  metrics: string[];  // Display names of metrics (e.g., \"Face Width to Height Ratio\")\n  threshold: number;  // Score threshold for classification\n}\n\nexport interface WeaknessSeverityLabels {\n  minor: string;\n  moderate: string;\n  severe: string;\n}\n\nexport interface StrengthGradeLabels {\n  good: string;\n  excellent: string;\n  ideal: string;\n}\n\nexport interface InsightContent {\n  description: string;\n  severity_labels?: WeaknessSeverityLabels;  // For weaknesses\n  grade_labels?: StrengthGradeLabels;        // For strengths\n}\n\nexport interface InsightDefinition {\n  id: string;\n  title: string;\n  type: 'weakness' | 'strength';\n  severity_logic: InsightSeverityLogic;\n  content: InsightContent;\n}\n\n// ============================================\n// CLASSIFICATION RESULT TYPES\n// ============================================\n\nexport type WeaknessSeverity = 'severe' | 'moderate' | 'minor';\nexport type StrengthGrade = 'ideal' | 'excellent' | 'good';\n\nexport interface ClassifiedWeakness {\n  insightId: string;\n  title: string;\n  description: string;\n  severity: WeaknessSeverity;\n  severityLabel: string;  // Custom label from definition (e.g., \"Extremely Long\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface ClassifiedStrength {\n  insightId: string;\n  title: string;\n  description: string;\n  grade: StrengthGrade;\n  gradeLabel: string;  // Custom label from definition (e.g., \"Ideal\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface MatchedMetric {\n  metricId: string;\n  metricName: string;\n  score: number;\n  value: number;\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category: string;\n}\n\nexport interface InsightClassificationResult {\n  strengths: ClassifiedStrength[];\n  weaknesses: ClassifiedWeakness[];\n}\n\n// ============================================\n// INSIGHTS DATABASE\n// ============================================\n\nexport const INSIGHTS_DEFINITIONS: InsightDefinition[] = [\n  {\n    id: \"long_midface\",\n    title: \"Long Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\", \"Ipsilateral Alar Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The middle of the face is elongated, creating an unbalanced vertical proportion.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Extremely Long\" }\n    }\n  },\n  {\n    id: \"short_midface\",\n    title: \"Short Midface\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The midface has ideal vertical proportions, contributing to facial harmony.\",\n      grade_labels: { good: \"Proportionate\", excellent: \"Well-Balanced\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"weak_jaw\",\n    title: \"Weak/Soft Jaw Structure\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Chin to Philtrum Ratio\", \"Jaw Slope\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw has a softer, rounder shape, often less angular and robust than the ideal.\",\n      severity_labels: { minor: \"Soft\", moderate: \"Recessed\", severe: \"Weak\" }\n    }\n  },\n  {\n    id: \"strong_jaw\",\n    title: \"Strong Jaw Definition\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Jaw Width Ratio\", \"Bigonial Width\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The jaw displays strong definition with well-defined angles and proportionate width.\",\n      grade_labels: { good: \"Defined\", excellent: \"Strong\", ideal: \"Ideal Angular\" }\n    }\n  },\n  {\n    id: \"refined_nasal_tip\",\n    title: \"Refined Nasal Tip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasal Tip Angle\", \"Nose Tip Position\", \"Frankfort-tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious nasal profile due to the nasal tip being well-defined and proportionate.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"bulbous_nose\",\n    title: \"Bulbous Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Nose Width\", \"Nasal Tip Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip appears rounded and less defined, affecting nasal aesthetics.\",\n      severity_labels: { minor: \"Slightly Rounded\", moderate: \"Rounded\", severe: \"Bulbous\" }\n    }\n  },\n  {\n    id: \"ideal_upper_lip\",\n    title: \"Well-Positioned Upper Lip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Lip E-Line Position\", \"Upper Lip S-Line Position\", \"Nasolabial Angle\"],\n      threshold: 9.0\n    },\n    content: {\n      description: \"This contributes to a harmonious mouth region due to the upper lip sitting neither too far forward nor too far back.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"negative_canthal_tilt\",\n    title: \"Negative Canthal Tilt\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The outer corners of the eyes sit lower than the inner corners, creating a downturned appearance.\",\n      severity_labels: { minor: \"Slight Downturn\", moderate: \"Noticeable\", severe: \"Pronounced\" }\n    }\n  },\n  {\n    id: \"positive_canthal_tilt\",\n    title: \"Positive Canthal Tilt\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The outer corners of the eyes are elevated, creating an attractive upswept eye shape.\",\n      grade_labels: { good: \"Slight Upturn\", excellent: \"Well-Tilted\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"balanced_facial_thirds\",\n    title: \"Balanced Facial Thirds\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays well-balanced vertical proportions across all three facial thirds.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfectly Proportioned\" }\n    }\n  },\n  {\n    id: \"imbalanced_thirds\",\n    title: \"Facial Third Imbalance\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The vertical face proportions show imbalance between the three facial thirds.\",\n      severity_labels: { minor: \"Slight Imbalance\", moderate: \"Noticeable Disproportion\", severe: \"Significant Imbalance\" }\n    }\n  },\n  {\n    id: \"high_cheekbones\",\n    title: \"High Cheekbones\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Cheekbone Width\", \"Midface Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"Well-positioned cheekbones that create attractive facial contours and catch light beautifully.\",\n      grade_labels: { good: \"Visible\", excellent: \"Prominent\", ideal: \"Model-Tier\" }\n    }\n  },\n  {\n    id: \"flat_midface\",\n    title: \"Flat Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Total Facial Width to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The midface lacks forward projection, resulting in flatter facial contours.\",\n      severity_labels: { minor: \"Slightly Flat\", moderate: \"Underprojected\", severe: \"Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_lip_ratio\",\n    title: \"Ideal Lip Proportions\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Philtrum Length\", \"Lip Chin Distance\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Well-Proportioned\", ideal: \"Perfect Ratio\" }\n    }\n  },\n  {\n    id: \"thin_lips\",\n    title: \"Thin Lip Profile\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Upper Lip Projection\", \"Lower Lip Projection\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The lips appear thinner than ideal proportions, affecting lower face harmony.\",\n      severity_labels: { minor: \"Slightly Thin\", moderate: \"Thin\", severe: \"Very Thin\" }\n    }\n  },\n  {\n    id: \"ideal_ipd\",\n    title: \"Ideal Eye Spacing\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes are ideally spaced, creating facial balance and attractiveness.\",\n      grade_labels: { good: \"Good Spacing\", excellent: \"Ideal Distance\", ideal: \"Perfect IPD\" }\n    }\n  },\n  {\n    id: \"wide_set_eyes\",\n    title: \"Wide-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are spaced wider apart than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Noticeably Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"close_set_eyes\",\n    title: \"Close-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"Intercanthal Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are positioned closer together than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Close\", moderate: \"Noticeably Close\", severe: \"Very Close\" }\n    }\n  },\n  {\n    id: \"ideal_nose_projection\",\n    title: \"Ideal Nasal Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofrontal Angle\", \"Nasofacial Angle\", \"Nasomenta Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The nose has ideal forward projection relative to the face, creating profile harmony.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect Projection\" }\n    }\n  },\n  {\n    id: \"recessed_chin\",\n    title: \"Recessed Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Facial Depth to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The chin sits behind the ideal position, affecting profile balance.\",\n      severity_labels: { minor: \"Slightly Recessed\", moderate: \"Recessed\", severe: \"Severely Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_chin_projection\",\n    title: \"Ideal Chin Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The chin demonstrates ideal projection and proportions relative to the face.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect\" }\n    }\n  },\n  {\n    id: \"long_philtrum\",\n    title: \"Long Philtrum\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Lip Chin Distance\", \"Upper Lip Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The distance between nose and upper lip is longer than ideal.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"short_philtrum\",\n    title: \"Short Philtrum\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Upper Lip Height\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The philtrum has ideal or shorter length, considered youthful and attractive.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Short\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"wide_nose\",\n    title: \"Wide Nasal Base\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Intercanthal Nasal Ratio\", \"Nose Bridge Width\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The base of the nose is wider than the aesthetic ideal for facial harmony.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"ideal_brow_position\",\n    title: \"Ideal Brow Position\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow Length Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The eyebrows are ideally positioned relative to the eyes and facial structure.\",\n      grade_labels: { good: \"Good Position\", excellent: \"Well-Arched\", ideal: \"Perfect Frame\" }\n    }\n  },\n  {\n    id: \"narrow_jaw\",\n    title: \"Narrow Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Jaw Width Ratio\", \"Bigonial Width\", \"Jaw Frontal Angle\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw is narrower than ideal, affecting lower face width and definition.\",\n      severity_labels: { minor: \"Slightly Narrow\", moderate: \"Narrow\", severe: \"Very Narrow\" }\n    }\n  },\n  {\n    id: \"steep_mandibular_plane\",\n    title: \"Steep Mandibular Plane\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The mandibular plane angle is steeper than ideal, often indicating vertical growth pattern.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  // ============================================\n  // INSIGHT DEFINITIONS (element.html / element1.html)\n  // ============================================\n  // --- WEAKNESSES ---\n  {\n    id: \"steep_jaw\",\n    title: \"Steep Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Jaw Frontal Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The jaw angles sharply downward, creating a narrow or pointed chin effect.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  {\n    id: \"maxillary_recession\",\n    title: \"Maxillary Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Facial Depth to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The upper jaw is less forward than ideal, reducing midface projection and facial harmony.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"mandibular_recession\",\n    title: \"Mandibular Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The lower jaw is set back, creating a less prominent chin and an unbalanced profile.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"underprojected_chin\",\n    title: \"Underprojected Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\", \"Chin Height\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The chin lacks forward projection, creating a weak lower face appearance.\",\n      severity_labels: { minor: \"Slightly Weak\", moderate: \"Underprojected\", severe: \"Severely Underprojected\" }\n    }\n  },\n  {\n    id: \"overly_long_face\",\n    title: \"Overly Long Face Shape\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Total Facial Width to Height Ratio\", \"Face Width to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The face is excessively tall and narrow, creating an elongated appearance.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"hyper_divergent_jaw\",\n    title: \"Hyper-Divergent Jaw Growth\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The jaw grows with an overly steep angle, resulting in a long or narrow lower face. This can indicate malocclusion.\",\n      severity_labels: { minor: \"Mildly Divergent\", moderate: \"Divergent\", severe: \"Hyper-Divergent\" }\n    }\n  },\n  {\n    id: \"weak_brow_ridge\",\n    title: \"Soft/Weak Brow Ridge\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Eyebrow Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The forehead has a softer, less prominent ridge than the ideal, reducing masculine definition.\",\n      severity_labels: { minor: \"Slightly Soft\", moderate: \"Soft\", severe: \"Very Weak\" }\n    }\n  },\n  {\n    id: \"droopy_nasal_tip\",\n    title: \"Droopy Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\", \"Nasofacial Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip points downward more than ideal, creating a drooping appearance.\",\n      severity_labels: { minor: \"Slightly Droopy\", moderate: \"Droopy\", severe: \"Very Droopy\" }\n    }\n  },\n  {\n    id: \"overprojected_nose\",\n    title: \"Overprojected Nose\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Projection\", \"Nasofacial Angle\", \"Nose Length Ratio\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nose projects too far forward relative to the face, creating imbalance.\",\n      severity_labels: { minor: \"Slightly Projected\", moderate: \"Overprojected\", severe: \"Very Overprojected\" }\n    }\n  },\n  {\n    id: \"small_eyes\",\n    title: \"Small Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Palpebral Fissure Length\", \"Eye Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes appear smaller than the aesthetic ideal relative to the face.\",\n      severity_labels: { minor: \"Slightly Small\", moderate: \"Small\", severe: \"Very Small\" }\n    }\n  },\n  {\n    id: \"low_set_eyebrows\",\n    title: \"Low-Set Eyebrows\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow to Hairline Distance\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyebrows sit lower than ideal, reducing the visible upper eyelid space.\",\n      severity_labels: { minor: \"Slightly Low\", moderate: \"Low\", severe: \"Very Low\" }\n    }\n  },\n  {\n    id: \"asymmetrical_face\",\n    title: \"Facial Asymmetry\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The left and right sides of the face show noticeable differences in proportion or position.\",\n      severity_labels: { minor: \"Slight Asymmetry\", moderate: \"Noticeable Asymmetry\", severe: \"Significant Asymmetry\" }\n    }\n  },\n  // --- STRENGTHS ---\n  {\n    id: \"good_jaw_width\",\n    title: \"Good Jaw Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Bigonial Width\", \"Jaw Width Ratio\", \"Jaw Frontal Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant jaw contour due to the jaw being neither too wide nor too narrow.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"good_forehead_slope\",\n    title: \"Good Forehead Slope\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Forehead Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant forehead contour by indicating that the forehead is neither too steep nor too flat.\",\n      grade_labels: { good: \"Good Slope\", excellent: \"Well-Angled\", ideal: \"Ideal Slope\" }\n    }\n  },\n  {\n    id: \"good_cupids_bow\",\n    title: \"Good Cupid's Bow Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cupids Bow Depth\", \"Upper Lip Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lip region due to the cupid's bow having ideal definition and depth.\",\n      grade_labels: { good: \"Defined\", excellent: \"Well-Defined\", ideal: \"Perfectly Defined\" }\n    }\n  },\n  {\n    id: \"good_eyebrow_length\",\n    title: \"Good Eyebrow Length\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Brow Length to Face Width Ratio\", \"Brow Length Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious eye region due to the eyebrows having ideal horizontal length relative to face width.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Well-Proportioned\", ideal: \"Ideal Length\" }\n    }\n  },\n  {\n    id: \"good_neck_width\",\n    title: \"Good Neck Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Neck Width\", \"Neck to Jaw Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lower face due to the neck being neither too wide nor too thin.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"ideal_nasolabial_angle\",\n    title: \"Ideal Nasolabial Angle\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The angle between nose and upper lip is in the ideal range, creating profile harmony.\",\n      grade_labels: { good: \"Good Angle\", excellent: \"Well-Angled\", ideal: \"Perfect Angle\" }\n    }\n  },\n  {\n    id: \"ideal_facial_depth\",\n    title: \"Ideal Facial Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Depth to Height Ratio\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face has ideal forward projection creating attractive three-dimensional contours.\",\n      grade_labels: { good: \"Good Depth\", excellent: \"Well-Projected\", ideal: \"Ideal Projection\" }\n    }\n  },\n  {\n    id: \"ideal_eye_shape\",\n    title: \"Ideal Eye Shape\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Lateral Canthal Tilt\", \"Palpebral Fissure Length\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes have an attractive almond shape with ideal proportions and tilt.\",\n      grade_labels: { good: \"Attractive\", excellent: \"Well-Shaped\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"harmonious_profile\",\n    title: \"Harmonious Profile\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Total Profile Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The facial profile shows excellent balance between nose, lips, and chin positions.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfect Profile\" }\n    }\n  },\n  {\n    id: \"good_facial_symmetry\",\n    title: \"Good Facial Symmetry\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays excellent bilateral symmetry, a key component of attractiveness.\",\n      grade_labels: { good: \"Symmetric\", excellent: \"Very Symmetric\", ideal: \"Near-Perfect Symmetry\" }\n    }\n  }\n];\n\n// ============================================\n// METRIC NAME MAPPING\n// ============================================\n\n// Map display names to metric IDs for lookup\nconst METRIC_NAME_TO_ID: Record<string, string> = {\n  // Face Shape/Proportions\n  \"Face Width to Height Ratio\": \"faceWidthToHeight\",\n  \"Total Facial Width to Height\": \"totalFacialWidthToHeight\",\n  \"Total Facial Width to Height Ratio\": \"totalFacialWidthToHeight\",\n  \"Midface Ratio\": \"midfaceRatio\",\n  \"Upper Third Proportion\": \"upperThirdProportion\",\n  \"Middle Third Proportion\": \"middleThirdProportion\",\n  \"Lower Third Proportion\": \"lowerThirdProportion\",\n  \"Cheekbone Height\": \"cheekboneHeight\",\n  \"Cheekbone Width\": \"cheekboneWidth\",\n  \"Bitemporal Width\": \"bitemporalWidth\",\n  \"Forehead Height\": \"foreheadHeight\",\n  \"Facial Asymmetry Index\": \"facialAsymmetryIndex\",\n\n  // Jaw\n  \"Gonial Angle\": \"gonialAngle\",\n  \"Mandibular Plane Angle\": \"mandibularPlaneAngle\",\n  \"Jaw Width Ratio\": \"jawWidthRatio\",\n  \"Bigonial Width\": \"bigonialWidth\",\n  \"Jaw Frontal Angle\": \"jawFrontalAngle\",\n  \"Jaw Slope\": \"jawSlope\",\n  \"Jaw Asymmetry\": \"jawAsymmetry\",\n\n  // Chin\n  \"Chin to Philtrum Ratio\": \"chinPhiltrumRatio\",\n  \"Chin Height\": \"chinHeight\",\n  \"Facial Depth to Height\": \"facialDepthToHeight\",\n  \"Facial Depth to Height Ratio\": \"facialDepthToHeight\",\n  \"Anterior Facial Depth\": \"anteriorFacialDepth\",\n  \"Recession Relative to Frankfort Plane\": \"recessionFrankfort\",\n\n  // Eyes\n  \"Lateral Canthal Tilt\": \"lateralCanthalTilt\",\n  \"Eye Aspect Ratio\": \"eyeAspectRatio\",\n  \"Eye Separation Ratio\": \"eyeSeparationRatio\",\n  \"Interpupillary Ratio\": \"interpupillaryRatio\",\n  \"One Eye Apart Test\": \"oneEyeApartTest\",\n  \"Intercanthal Width\": \"intercanthalWidth\",\n  \"Eyebrow Height\": \"eyebrowHeight\",\n  \"Brow Length Ratio\": \"browLengthRatio\",\n  \"Brow Length to Face Width Ratio\": \"browLengthToFaceWidth\",\n  \"Palpebral Fissure Length\": \"palpebralFissureLength\",\n  \"Eye Width\": \"eyeWidth\",\n  \"Eye Asymmetry\": \"eyeAsymmetry\",\n  \"Brow to Hairline Distance\": \"browToHairlineDistance\",\n\n  // Brow\n  \"Browridge Inclination Angle\": \"browridgeInclinationAngle\",\n\n  // Nose\n  \"Nasal Index\": \"nasalIndex\",\n  \"Nasal Tip Angle\": \"nasalTipAngle\",\n  \"Nose Tip Position\": \"noseTipPosition\",\n  \"Frankfort-tip Angle\": \"frankfortTipAngle\",\n  \"Nasofrontal Angle\": \"nasofrontalAngle\",\n  \"Nasofacial Angle\": \"nasofacialAngle\",\n  \"Nasomenta Angle\": \"nasomentaAngle\",\n  \"Nasomental Angle\": \"nasomentaAngle\",\n  \"Intercanthal Nasal Ratio\": \"intercanthalNasalRatio\",\n  \"Nose Bridge Width\": \"noseBridgeWidth\",\n  \"Nose Width\": \"noseWidth\",\n  \"Nasal Projection\": \"nasalProjection\",\n  \"Nose Length Ratio\": \"noseLengthRatio\",\n  \"Ipsilateral Alar Angle\": \"ipsilateralAlarAngle\",\n\n  // Lips\n  \"Lip Ratio\": \"lipRatio\",\n  \"Philtrum Length\": \"philtrumLength\",\n  \"Upper Lip Projection\": \"upperLipProjection\",\n  \"Lower Lip Projection\": \"lowerLipProjection\",\n  \"Lip Chin Distance\": \"lipChinDistance\",\n  \"Upper Lip Height\": \"upperLipHeight\",\n  \"Upper Lip E-Line Position\": \"upperLipELine\",\n  \"Upper Lip S-Line Position\": \"upperLipSLine\",\n  \"Nasolabial Angle\": \"nasolabialAngle\",\n  \"Cupids Bow Depth\": \"cupidsBowDepth\",\n\n  // Neck\n  \"Neck Width\": \"neckWidth\",\n  \"Neck to Jaw Ratio\": \"neckToJawRatio\",\n\n  // Profile\n  \"Total Profile Angle\": \"totalProfileAngle\",\n};\n\n// ============================================\n// CLASSIFICATION FUNCTIONS\n// ============================================\n\n/**\n * Get weakness severity based on average score\n * 0-3 = \"Severe\", 3-5 = \"Moderate\", 5-7 = \"Minor\"\n */\nfunction getWeaknessSeverity(avgScore: number): WeaknessSeverity {\n  if (avgScore <= 3) return 'severe';\n  if (avgScore <= 5) return 'moderate';\n  return 'minor';\n}\n\n/**\n * Get strength grade based on average score\n * 8-9 = \"Good\", 9-9.5 = \"Excellent\", 9.5-10 = \"Ideal\"\n */\nfunction getStrengthGrade(avgScore: number): StrengthGrade {\n  if (avgScore >= 9.5) return 'ideal';\n  if (avgScore >= 9) return 'excellent';\n  return 'good';\n}\n\n/**\n * Find metric by display name from measurements array\n */\nfunction findMetricByName(\n  metricName: string,\n  measurements: MetricScoreResult[]\n): MetricScoreResult | undefined {\n  // First try direct ID mapping\n  const metricId = METRIC_NAME_TO_ID[metricName];\n  if (metricId) {\n    return measurements.find(m => m.metricId === metricId);\n  }\n\n  // Fallback: try fuzzy matching on name\n  const normalizedName = metricName.toLowerCase().replace(/[^a-z0-9]/g, '');\n  return measurements.find(m => {\n    const normalizedMetricName = m.name.toLowerCase().replace(/[^a-z0-9]/g, '');\n    return normalizedMetricName.includes(normalizedName) ||\n           normalizedName.includes(normalizedMetricName);\n  });\n}\n\n/**\n * Check if a metric should be considered a \"false positive\" weakness.\n * This handles directional/dimorphic metrics where low scores don't mean weakness.\n *\n * Example: Canthal Tilt of 3° gets a low score (not in 6-8° ideal range)\n * but is still a POSITIVE trait, not a weakness.\n */\nfunction isFalsePositiveWeakness(metric: MatchedMetric): boolean {\n  const config = METRIC_CONFIGS[metric.metricId];\n  if (!config) return false;\n\n  // Check if the value is actually acceptable based on polarity\n  const { acceptable } = isValueAcceptable(metric.value, config);\n  return acceptable;\n}\n\n/**\n * Process all insight definitions against user's measurements\n */\nexport function classifyInsights(\n  measurements: MetricScoreResult[],\n  insightDefinitions: InsightDefinition[] = INSIGHTS_DEFINITIONS\n): InsightClassificationResult {\n  const strengths: ClassifiedStrength[] = [];\n  const weaknesses: ClassifiedWeakness[] = [];\n\n  for (const insight of insightDefinitions) {\n    const { metrics, threshold } = insight.severity_logic;\n\n    // Find matching measurements for this insight\n    const matchedMetrics: MatchedMetric[] = [];\n    for (const metricName of metrics) {\n      const measurement = findMetricByName(metricName, measurements);\n      if (measurement) {\n        matchedMetrics.push({\n          metricId: measurement.metricId,\n          metricName: measurement.name,\n          score: measurement.score,\n          value: measurement.value,\n          idealMin: measurement.idealMin,\n          idealMax: measurement.idealMax,\n          unit: measurement.unit,\n          category: measurement.category,\n        });\n      }\n    }\n\n    // Skip if no metrics matched (need at least 1)\n    if (matchedMetrics.length === 0) continue;\n\n    // Calculate average score\n    const avgScore = matchedMetrics.reduce((sum, m) => sum + m.score, 0) / matchedMetrics.length;\n\n    // Classify based on type and threshold\n    if (insight.type === 'weakness') {\n      // Weakness: avg < threshold → add to areas of improvement\n      if (avgScore < threshold) {\n        // ========== FALSE POSITIVE CHECK ==========\n        // Before adding to weaknesses, check if ANY of the matched metrics\n        // are actually in an \"acceptable\" zone based on their polarity.\n        // If so, this is a false positive and should be skipped or reclassified.\n        const falsePositiveMetrics = matchedMetrics.filter(isFalsePositiveWeakness);\n\n        // If ALL matched metrics are false positives, skip this weakness entirely\n        if (falsePositiveMetrics.length === matchedMetrics.length) {\n          // This is a false positive weakness - the values are actually acceptable\n          // Consider adding to strengths if scores are decent\n          if (avgScore >= 6) {\n            strengths.push({\n              insightId: `${insight.id}_acceptable`,\n              title: insight.title.replace('Negative', 'Neutral').replace('Weak', 'Moderate'),\n              description: `While not in the peak ideal range, the measured values are within acceptable limits.`,\n              grade: 'good',\n              gradeLabel: 'Acceptable',\n              avgScore,\n              matchedMetrics,\n            });\n          }\n          continue; // Skip adding as weakness\n        }\n\n        // If SOME metrics are false positives, filter them out\n        const trueWeaknessMetrics = matchedMetrics.filter(m => !isFalsePositiveWeakness(m));\n        if (trueWeaknessMetrics.length === 0) continue;\n\n        // Recalculate average with only true weakness metrics\n        const trueAvgScore = trueWeaknessMetrics.reduce((sum, m) => sum + m.score, 0) / trueWeaknessMetrics.length;\n\n        // Only add as weakness if true average is still below threshold\n        if (trueAvgScore < threshold) {\n          const severity = getWeaknessSeverity(trueAvgScore);\n          const labels = insight.content.severity_labels;\n          const severityLabel = labels?.[severity] || severity;\n\n          weaknesses.push({\n            insightId: insight.id,\n            title: insight.title,\n            description: insight.content.description,\n            severity,\n            severityLabel,\n            avgScore: trueAvgScore,\n            matchedMetrics: trueWeaknessMetrics,\n          });\n        }\n      }\n    } else {\n      // Strength: avg > threshold → add to key strengths\n      if (avgScore > threshold) {\n        const grade = getStrengthGrade(avgScore);\n        const labels = insight.content.grade_labels;\n        const gradeLabel = labels?.[grade] || grade;\n\n        strengths.push({\n          insightId: insight.id,\n          title: insight.title,\n          description: insight.content.description,\n          grade,\n          gradeLabel,\n          avgScore,\n          matchedMetrics,\n        });\n      }\n    }\n  }\n\n  // Sort by score (weaknesses by lowest score first, strengths by highest first)\n  weaknesses.sort((a, b) => a.avgScore - b.avgScore);\n  strengths.sort((a, b) => b.avgScore - a.avgScore);\n\n  return { strengths, weaknesses };\n}\n\n/**\n * Convert ClassifiedStrength to Strength type for UI compatibility\n */\nexport function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: classified.avgScore,\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  const impact = (10 - classified.avgScore) * 0.5;\n  const newRollingLost = rollingLost + impact;\n\n  return {\n    id: `insight_flaw_${classified.insightId}`,\n    flawName: `${classified.title} (${classified.severityLabel})`,\n    summary: classified.description,\n    harmonyPercentageLost: impact,\n    standardizedImpact: impact / 10,\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: m.score,\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,\n    rollingHarmonyPercentageLost: newRollingLost,\n    rollingStandardizedImpact: newRollingLost / 10,\n  };\n}\n\n/**\n * Main function: Generate strengths and flaws from measurements using insights\n */\nexport function generateInsightBasedResults(\n  measurements: MetricScoreResult[]\n): { strengths: Strength[]; flaws: Flaw[] } {\n  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);\n\n  // Convert to UI-compatible types\n  const strengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n  let rollingLost = 0;\n  const flaws = classifiedWeaknesses.map((w, i) => {\n    const flaw = convertToFlaw(w, i, rollingLost);\n    rollingLost = flaw.rollingPointsDeducted || 0;\n    return flaw;\n  });\n\n  return { strengths, flaws };\n}\n","structuredPatch":[{"oldStart":2607,"oldLines":7,"newStart":2607,"newLines":7,"lines":["     responsibleRatios: classified.matchedMetrics.map(m => ({","       ratioName: m.metricName,","       ratioId: m.metricId,","-      score: m.score,","+      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow","       value: m.value,","       idealMin: m.idealMin,","       idealMax: m.idealMax,"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"65267124-3172-42a3-a8d7-709d29a339f0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RySMoWvy3UdJd6u3wLR4kv","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me fix the locations in `ResultsContext.tsx`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":761,"cache_read_input_tokens":98557,"cache_creation":{"ephemeral_5m_input_tokens":761,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrdLNmwEmkiYrTQar2U","type":"assistant","uuid":"f8a9cc41-7c66-4cca-9a88-022cc87f9118","timestamp":"2025-12-26T06:52:11.676Z"}
{"parentUuid":"f8a9cc41-7c66-4cca-9a88-022cc87f9118","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RySMoWvy3UdJd6u3wLR4kv","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QDdnhjps6JpQX4LYpE3bFo","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","old_string":"        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: matchingMeasurement?.score || 8,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: matchingMeasurement?.score || 8,\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });","new_string":"        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 8));\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: clampedScore,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: clampedScore,  // Use clamped score\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":761,"cache_read_input_tokens":98557,"cache_creation":{"ephemeral_5m_input_tokens":761,"ephemeral_1h_input_tokens":0},"output_tokens":967,"service_tier":"standard"}},"requestId":"req_011CWUrdLNmwEmkiYrTQar2U","type":"assistant","uuid":"184b9cc8-c2b0-4c89-9f1b-04ee4bd54d6b","timestamp":"2025-12-26T06:52:23.372Z"}
{"parentUuid":"184b9cc8-c2b0-4c89-9f1b-04ee4bd54d6b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QDdnhjps6JpQX4LYpE3bFo","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   911→        summary: groupConfig.description,\n   912→        avgScore,\n   913→        qualityLevel: bestQuality,\n   914→        categoryName: groupConfig.category,\n   915→        responsibleRatios: groupMeasurements.map(m => ({\n   916→          ratioName: m.name,\n   917→          ratioId: m.metricId,\n   918→          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n   919→          value: m.value,\n   920→          idealMin: m.idealMin,\n   921→          idealMax: m.idealMax,\n   922→          unit: m.unit,\n   923→          category: m.category,\n   924→        })),\n   925→      });\n   926→    }\n   927→  });\n   928→\n   929→  // Second pass: Add remaining individual strengths that weren't grouped\n   930→  analysis.strengths.forEach((s, i) => {\n   931→    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n   932→\n   933→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n   934→    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 8));\n   935→\n   936→    strengths.push({\n   937→      id: `strength_${i}`,\n   938→      strengthName: s.metricName,\n   939→      summary: s.reasoning,\n   940→      avgScore: clampedScore,\n   941→      qualityLevel: s.qualityTier,\n   942→      categoryName: s.category,\n   943→      responsibleRatios: [{\n   944→        ratioName: s.metricName,\n   945→        ratioId: s.metricId,\n   946→        score: clampedScore,  // Use clamped score\n   947→        value: s.value,\n   948→        idealMin: matchingMeasurement?.idealMin || 0,\n   949→        idealMax: matchingMeasurement?.idealMax || 1,\n   950→        unit: matchingMeasurement?.unit || 'ratio',\n   951→        category: s.category,\n   952→      }],\n   953→    });\n   954→  });\n   955→\n   956→  // Sort by average score (highest first) then by number of contributing ratios\n   957→  return strengths.sort((a, b) => {\n   958→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {"}]},"uuid":"12c0ff3e-cd68-416a-a697-dae939d490e6","timestamp":"2025-12-26T06:52:23.415Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","oldString":"        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: matchingMeasurement?.score || 8,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: matchingMeasurement?.score || 8,\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });","newString":"        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 8));\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: clampedScore,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: clampedScore,  // Use clamped score\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });","originalFile":"'use client';\n\nimport React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\nimport { LandmarkPoint } from '@/lib/landmarks';\nimport {\n  analyzeFrontProfile,\n  analyzeSideProfile,\n  analyzeHarmony,\n  HarmonyAnalysis,\n  MetricScoreResult,\n  METRIC_CONFIGS,\n  Ethnicity,\n  Gender,\n} from '@/lib/harmony-scoring';\nimport {\n  calculateHarmonyScore,\n  getTopMetrics,\n  getBottomMetrics,\n  HarmonyScoreResult,\n  RankedMetric,\n} from '@/lib/looksmax-scoring';\nimport { harmonyToPSL } from '@/lib/recommendations/severity';\nimport {\n  classifyInsights,\n  convertToStrength,\n  convertToFlaw,\n  INSIGHTS_DEFINITIONS,\n} from '@/lib/insights-engine';\nimport { classifyMetric } from '@/lib/taxonomy';\nimport {\n  Ratio,\n  Strength,\n  Flaw,\n  Recommendation,\n  ResultsTab,\n  FullHarmonyAnalysis,\n} from '@/types/results';\nimport { generateRecommendations } from '@/lib/results/analysis';\n\n// ============================================\n// CONTEXT TYPES\n// ============================================\n\ninterface ResultsContextType {\n  // Raw data\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  gender: Gender;\n  ethnicity: Ethnicity;\n  frontPhoto: string;\n  sidePhoto: string | null;\n\n  // Computed results\n  harmonyAnalysis: FullHarmonyAnalysis | null;\n  frontRatios: Ratio[];\n  sideRatios: Ratio[];\n  strengths: Strength[];\n  flaws: Flaw[];\n  recommendations: Recommendation[];\n\n  // Scores (now using weighted harmony from looksmax_engine.py)\n  overallScore: number;\n  frontScore: number;\n  sideScore: number;\n\n  // Weighted Harmony Score (from looksmax_engine.py)\n  harmonyScoreResult: HarmonyScoreResult | null;\n  harmonyPercentage: number;  // 0-100% weighted harmony\n\n  // Top 3 strengths and bottom 3 areas to improve with advice\n  topMetrics: RankedMetric[];\n  bottomMetrics: RankedMetric[];\n\n  // PSL Rating (1-10 scale)\n  pslRating: {\n    psl: number;\n    tier: string;\n    percentile: number;\n    description: string;\n  };\n\n  // UI state\n  activeTab: ResultsTab;\n  setActiveTab: (tab: ResultsTab) => void;\n  expandedMeasurementId: string | null;\n  setExpandedMeasurementId: (id: string | null) => void;\n  selectedVisualizationMetric: string | null;\n  setSelectedVisualizationMetric: (id: string | null) => void;\n  categoryFilter: string | null;\n  setCategoryFilter: (category: string | null) => void;\n  showLandmarkOverlay: boolean;\n  setShowLandmarkOverlay: (show: boolean) => void;\n\n  // Actions\n  setResultsData: (data: ResultsInputData) => void;\n}\n\ninterface ResultsInputData {\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  frontPhoto: string;\n  sidePhoto?: string;\n  gender: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// HELPER FUNCTIONS\n// ============================================\n\nfunction convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n  switch (unit) {\n    case 'ratio': return 'x';\n    case 'percent': return '%';\n    case 'degrees': return '°';\n    case 'mm': return 'mm';\n    default: return 'x';\n  }\n}\n\nfunction transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {\n  const metricConfig = METRIC_CONFIGS[result.metricId];\n\n  // Generate illustration based on metric\n  const illustration = generateIllustration(result.metricId, landmarks);\n\n  // Get flaw/strength mappings\n  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n\n  // Classify metric using Harmony taxonomy\n  const taxonomyClassification = classifyMetric(result.name, result.category);\n\n  // Clamp scores to valid 0-10 range for display (defense-in-depth)\n  const clampedScore = Math.max(0, Math.min(10, result.standardizedScore));\n\n  return {\n    id: result.metricId,\n    name: result.name,\n    value: result.value,\n    score: clampedScore,  // Use standardized 0-10 score for UI display\n    standardizedScore: clampedScore,\n    unit: convertUnitToRatioUnit(result.unit),\n    idealMin: result.idealMin,\n    idealMax: result.idealMax,\n    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n    description: metricConfig?.description || '',\n    category: result.category,\n    qualityLevel: result.qualityTier,\n    severity: result.severity,\n    illustration,\n    mayIndicateFlaws,\n    mayIndicateStrengths,\n    usedLandmarks: getUsedLandmarks(result.metricId),\n    scoringCurveConfig: metricConfig ? {\n      decayRate: metricConfig.decayRate,\n      maxScore: metricConfig.maxScore,\n    } : undefined,\n    taxonomyPrimary: taxonomyClassification?.primary,\n    taxonomySecondary: taxonomyClassification?.secondary,\n  };\n}\n\n// Enhanced illustration configuration type\ninterface IllustrationConfig {\n  points: string[];\n  lines: Array<{\n    from: string;\n    to: string;\n    label?: string;\n    color?: string;\n    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n  }>;\n}\n\n// Comprehensive illustration configurations for all metrics\nconst ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n  // ==========================================\n  // FACE SHAPE / PROPORTIONS\n  // ==========================================\n  faceWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n    ],\n  },\n  totalFacialWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n    ],\n  },\n  lowerThirdProportion: {\n    points: ['subnasale', 'menton', 'trichion'],\n    lines: [\n      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  middleThirdProportion: {\n    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n    lines: [\n      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  upperThirdProportion: {\n    points: ['trichion', 'nasal_base', 'menton'],\n    lines: [\n      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  bitemporalWidth: {\n    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n    ],\n  },\n  cheekboneHeight: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n    ],\n  },\n  midfaceRatio: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // JAW MEASUREMENTS\n  // ==========================================\n  jawSlope: {\n    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n    ],\n  },\n  jawFrontalAngle: {\n    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  bigonialWidth: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n    ],\n  },\n  jawWidthRatio: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n    ],\n  },\n\n  // ==========================================\n  // EYE MEASUREMENTS\n  // ==========================================\n  lateralCanthalTilt: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n    ],\n  },\n  eyeAspectRatio: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  eyeSeparationRatio: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryMouthWidthRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n    ],\n  },\n  oneEyeApartTest: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // EYEBROW MEASUREMENTS\n  // ==========================================\n  browLengthRatio: {\n    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  eyebrowTilt: {\n    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n    ],\n  },\n  eyebrowLowSetedness: {\n    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n    ],\n  },\n\n  // ==========================================\n  // NOSE MEASUREMENTS (FRONT)\n  // ==========================================\n  nasalIndex: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  intercanthalNasalRatio: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n    ],\n  },\n  noseBridgeWidth: {\n    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n    ],\n  },\n  noseTipPosition: {\n    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // MOUTH/LIP MEASUREMENTS\n  // ==========================================\n  mouthNoseWidthRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  mouthWidth: {\n    points: ['left_cheilion', 'right_cheilion'],\n    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n  },\n\n  // ==========================================\n  // CHIN MEASUREMENTS\n  // ==========================================\n  chinHeight: {\n    points: ['labrale_inferius', 'menton'],\n    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n  },\n\n  // ==========================================\n  // NECK MEASUREMENTS\n  // ==========================================\n  neckWidthRatio: {\n    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n    ],\n  },\n\n  // ==========================================\n  // SIDE PROFILE MEASUREMENTS\n  // ==========================================\n  gonialAngle: {\n    points: ['tragus', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  nasofrontalAngle: {\n    points: ['glabella', 'nasion', 'pronasale'],\n    lines: [\n      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  nasofacialAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n    ],\n  },\n  nasomentaAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n    ],\n  },\n  submentalCervicalAngle: {\n    points: ['menton', 'cervicalPoint', 'neckPoint'],\n    lines: [\n      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n    ],\n  },\n  facialDepthToHeight: {\n    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n    lines: [\n      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  anteriorFacialDepth: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n    ],\n  },\n  mandibularPlaneAngle: {\n    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n    lines: [\n      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n    ],\n  },\n  ramusToMandibleRatio: {\n    points: ['gonionTop', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  orbitalVector: {\n    points: ['cornealApex', 'orbitale', 'cheekbone'],\n    lines: [\n      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n    ],\n  },\n  eLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  holdawayHLine: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n    ],\n  },\n  burstoneLowerLip: {\n    points: ['subnasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL FRONT PROFILE METRICS\n  // ==========================================\n  cupidsBowDepth: {\n    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],\n    lines: [\n      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },\n      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },\n    ],\n  },\n  mouthCornerPosition: {\n    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },\n    ],\n  },\n  iaaJfaDeviation: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },\n      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  ipsilateralAlarAngle: {\n    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },\n      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },\n    ],\n  },\n  earProtrusionAngle: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },\n    ],\n  },\n  earProtrusionRatio: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },\n      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },\n    ],\n  },\n  mouthWidthToNoseRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerToUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinToPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL SIDE PROFILE METRICS\n  // ==========================================\n  nasolabialAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },\n      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },\n    ],\n  },\n  nasalTipAngle: {\n    points: ['nasion', 'pronasale', 'columella'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },\n      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },\n    ],\n  },\n  nasalProjection: {\n    points: ['alar_crease', 'pronasale', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },\n    ],\n  },\n  nasalWToHRatio: {\n    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },\n      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  noseTipRotationAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },\n    ],\n  },\n  frankfortTipAngle: {\n    points: ['porion', 'orbitale', 'pronasale'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },\n    ],\n  },\n  mentolabialAngle: {\n    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],\n    lines: [\n      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },\n      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  zAngle: {\n    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],\n    lines: [\n      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },\n    ],\n  },\n  facialConvexityGlabella: {\n    points: ['glabella', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  facialConvexityNasion: {\n    points: ['nasion', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  totalFacialConvexity: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },\n      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  interiorMidfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },\n      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },\n    ],\n  },\n  recessionFromFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  gonionToMouthLine: {\n    points: ['gonionBottom', 'cheilion', 'tragus'],\n    lines: [\n      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },\n    ],\n  },\n  eLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  burstoneUpperLip: {\n    points: ['subnasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n  chinProjection: {\n    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },\n    ],\n  },\n  recessionRelativeToFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion', 'menton'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  browridgeInclinationAngle: {\n    points: ['glabella', 'trichion', 'nasion'],\n    lines: [\n      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },\n      { from: 'glabella', to: 'nasion', color: '#67e8f9' },\n    ],\n  },\n  upperForeheadSlope: {\n    points: ['trichion', 'glabella', 'frankfortHorizontal'],\n    lines: [\n      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },\n    ],\n  },\n  midfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },\n      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },\n    ],\n  },\n};\n\nfunction generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {\n  const landmarkMap: Record<string, LandmarkPoint> = {};\n  landmarks.forEach(l => { landmarkMap[l.id] = l; });\n\n  const config = ILLUSTRATION_CONFIGS[metricId];\n  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};\n  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};\n\n  if (config) {\n    config.points.forEach((pointId, i) => {\n      if (landmarkMap[pointId]) {\n        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };\n      }\n    });\n    config.lines.forEach((line, i) => {\n      lines[`line_${i}`] = {\n        from: line.from,\n        to: line.to,\n        color: line.color || '#67e8f9',\n        label: line.label,\n        labelPosition: line.labelPosition,\n      };\n    });\n  }\n\n  return { points, lines };\n}\n\nfunction getUsedLandmarks(metricId: string): string[] {\n  const landmarkMappings: Record<string, string[]> = {\n    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],\n    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    ipd: ['left_pupila', 'right_pupila'],\n    mouthWidth: ['left_cheilion', 'right_cheilion'],\n    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],\n    chinHeight: ['labrale_inferius', 'menton'],\n    gonialAngle: ['tragus', 'gonionBottom', 'menton'],\n  };\n  return landmarkMappings[metricId] || [];\n}\n\nfunction getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {\n  const flawMappings: Record<string, { low: string[]; high: string[] }> = {\n    faceWidthToHeight: {\n      low: ['Narrow face', 'Vertically elongated face'],\n      high: ['Wide face', 'Horizontally expanded face'],\n    },\n    lowerThirdProportion: {\n      low: ['Short lower third', 'Deficient mandible'],\n      high: ['Long lower third', 'Mandibular excess'],\n    },\n    lateralCanthalTilt: {\n      low: ['Negative canthal tilt', 'Drooping eyes'],\n      high: ['Excessive positive canthal tilt'],\n    },\n    nasalIndex: {\n      low: ['Narrow nose', 'Leptorrhine nose'],\n      high: ['Wide nose', 'Platyrrhine nose'],\n    },\n    gonialAngle: {\n      low: ['Steep mandibular plane'],\n      high: ['Flat mandibular plane', 'Weak jaw definition'],\n    },\n  };\n\n  const strengthMappings: Record<string, { ideal: string[] }> = {\n    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },\n    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },\n    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },\n    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },\n  };\n\n  const mapping = flawMappings[result.metricId];\n  const strengthMapping = strengthMappings[result.metricId];\n\n  let mayIndicateFlaws: string[] = [];\n  let mayIndicateStrengths: string[] = [];\n\n  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {\n    mayIndicateStrengths = strengthMapping?.ideal || [];\n  } else if (mapping) {\n    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;\n  }\n\n  return { mayIndicateFlaws, mayIndicateStrengths };\n}\n\n// Metric groupings for creating multi-ratio strengths\nconst STRENGTH_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Proportions\n  lipProportions: {\n    name: 'Well Proportioned Lips',\n    category: 'Lips',\n    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Proportions\n  eyeProportions: {\n    name: 'Harmonious Eye Proportions',\n    category: 'Eyes',\n    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Proportions\n  noseProportions: {\n    name: 'Balanced Nasal Proportions',\n    category: 'Nose',\n    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Definition\n  jawDefinition: {\n    name: 'Well-Defined Jawline',\n    category: 'Jaw Shape',\n    description: 'The jawline displays strong definition with balanced angles and proportionate width.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Proportions\n  chinProportions: {\n    name: 'Balanced Chin Projection',\n    category: 'Chin',\n    description: 'The chin demonstrates ideal projection and proportions relative to the face.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Facial Thirds\n  facialThirds: {\n    name: 'Balanced Facial Thirds',\n    category: 'Face Proportions',\n    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface\n  midfaceBalance: {\n    name: 'Harmonious Midface',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows balanced proportions with well-positioned cheekbones.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n  // Forehead\n  foreheadBalance: {\n    name: 'Well-Proportioned Forehead',\n    category: 'Forehead',\n    description: 'The forehead displays ideal proportions in height and shape.',\n    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],\n  },\n};\n\nfunction generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {\n  const strengths: Strength[] = [];\n  const usedMetricIds = new Set<string>();\n\n  // First pass: Create grouped strengths from related high-scoring metrics\n  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all high-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score >= 7.5 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: matchingMeasurement?.score || 8,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: matchingMeasurement?.score || 8,\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });\n\n  // Sort by average score (highest first) then by number of contributing ratios\n  return strengths.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.avgScore - a.avgScore;\n  });\n}\n\n// Flaw groupings - similar to strength groupings but for areas of improvement\nconst FLAW_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Issues\n  lipIssues: {\n    name: 'Lip Proportion Concerns',\n    category: 'Lips',\n    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Issues\n  eyeIssues: {\n    name: 'Eye Shape Considerations',\n    category: 'Eyes',\n    description: 'The eye proportions or positioning could benefit from enhancement.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Issues\n  noseIssues: {\n    name: 'Nasal Proportion Concerns',\n    category: 'Nose',\n    description: 'The nasal proportions show deviations that affect facial harmony.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Issues\n  jawIssues: {\n    name: 'Jawline Definition Concerns',\n    category: 'Jaw Shape',\n    description: 'The jawline structure shows areas that could be enhanced for better definition.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Issues\n  chinIssues: {\n    name: 'Chin Projection Concerns',\n    category: 'Chin',\n    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Face Proportion Issues\n  proportionIssues: {\n    name: 'Facial Proportion Imbalance',\n    category: 'Face Proportions',\n    description: 'The vertical face proportions show imbalance between facial thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface Issues\n  midfaceIssues: {\n    name: 'Midface Development Concerns',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows areas that could benefit from enhanced projection or balance.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n};\n\nfunction generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  const flaws: Flaw[] = [];\n  const usedMetricIds = new Set<string>();\n  let rollingLost = 0;\n\n  // First pass: Create grouped flaws from related low-scoring metrics\n  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all low-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score < 6 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped flaw if we have 2+ metrics with low scores\n    if (groupMeasurements.length >= 2) {\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Calculate total impact from all metrics in this group\n      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n      rollingLost += totalImpact;\n\n      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: matchingMeasurement?.score || 3,\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });\n\n  // Sort by impact (highest first) then by number of contributing ratios\n  return flaws.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  });\n}\n\n// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions\n// have been moved to @/lib/results/analysis.ts to reduce bundle size\n// Import generateRecommendations from there instead\n// ============================================\n// CONTEXT CREATION\n// ============================================\n\nconst ResultsContext = createContext<ResultsContextType | null>(null);\n\nexport function useResults(): ResultsContextType {\n  const context = useContext(ResultsContext);\n  if (!context) {\n    throw new Error('useResults must be used within a ResultsProvider');\n  }\n  return context;\n}\n\ninterface ResultsProviderProps {\n  children: ReactNode;\n  initialData?: ResultsInputData;\n}\n\nexport function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  // Raw data state\n  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n\n  // UI state\n  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n\n  // Compute analysis results (now with demographic-specific scoring)\n  const analysisResults = useMemo(() => {\n    if (frontLandmarks.length === 0) {\n      return null;\n    }\n\n    try {\n      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n      const sideAnalysis = sideLandmarks.length > 0\n        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n        : null;\n      // analyzeHarmony expects landmarks directly, not analysis results\n      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n\n      return { frontAnalysis, sideAnalysis, harmony };\n    } catch (error) {\n      console.error('Analysis error:', error);\n      return null;\n    }\n  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n\n  // Transform to Ratio format\n  const frontRatios = useMemo(() => {\n    if (!analysisResults?.frontAnalysis) return [];\n    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  }, [analysisResults, frontLandmarks]);\n\n  const sideRatios = useMemo(() => {\n    if (!analysisResults?.sideAnalysis) return [];\n    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  }, [analysisResults, sideLandmarks]);\n\n  // Generate strengths and flaws using INSIGHTS-BASED classification\n  // This processes insights.json definitions: calculates avg score of affected metrics,\n  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  const { insightStrengths, insightFlaws } = useMemo(() => {\n    if (!analysisResults?.harmony) {\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n\n    try {\n      // Classify using insights engine\n      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n\n      // Convert to UI-compatible types\n      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n      let rollingLost = 0;\n      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n        const flaw = convertToFlaw(w, i, rollingLost);\n        rollingLost = flaw.rollingPointsDeducted || 0;\n        return flaw;\n      });\n\n      return { insightStrengths, insightFlaws };\n    } catch (error) {\n      console.error('[ResultsContext] Error in insights classification:', error);\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n  }, [analysisResults]);\n\n  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  const groupingStrengths = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  const groupingFlaws = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateFlawsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)\n  const strengths = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightStrengths.forEach(s => {\n      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based strengths that don't overlap\n    const nonOverlappingGrouping = groupingStrengths.filter(gs => {\n      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    return [...insightStrengths, ...nonOverlappingGrouping];\n  }, [insightStrengths, groupingStrengths]);\n\n  const flaws = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightFlaws.forEach(f => {\n      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based flaws that don't overlap\n    const nonOverlappingGrouping = groupingFlaws.filter(gf => {\n      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    // Recalculate rolling totals for merged list\n    let rollingLost = 0;\n    const merged = [...insightFlaws, ...nonOverlappingGrouping];\n    return merged.map(f => {\n      rollingLost += f.harmonyPercentageLost;\n      return {\n        ...f,\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      };\n    });\n  }, [insightFlaws, groupingFlaws]);\n\n  // Generate recommendations with metric-aware matching and Bezier recalculation\n  const recommendations = useMemo(() => {\n    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);\n  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);\n\n  // Build full harmony analysis\n  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {\n    if (!analysisResults?.harmony) return null;\n\n    return {\n      standardizedScore: analysisResults.harmony.overallScore,\n      front: {\n        standardizedScore: analysisResults.harmony.frontScore,\n        ratios: frontRatios,\n      },\n      side: {\n        standardizedScore: analysisResults.harmony.sideScore,\n        ratios: sideRatios,\n      },\n      strengths,\n      flaws,\n    };\n  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);\n\n  // Calculate weighted harmony score using looksmax_engine.py algorithm\n  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {\n    if (!analysisResults?.harmony) return null;\n\n    const allMeasurements = analysisResults.harmony.measurements.map(m => ({\n      metricId: m.metricId,\n      standardizedScore: m.standardizedScore,\n    }));\n\n    return calculateHarmonyScore(allMeasurements);\n  }, [analysisResults]);\n\n  // Get top 3 and bottom 3 metrics with advice\n  const topMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getTopMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  const bottomMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getBottomMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  // Scores - now using weighted harmony with explicit clamping to 0-10\n  const rawHarmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;\n  const harmonyPercentage = Math.max(0, Math.min(100, rawHarmonyPercentage));\n\n  const rawOverallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;\n  const overallScore = Math.max(0, Math.min(10, rawOverallScore));\n\n  const rawFrontScore = analysisResults?.harmony?.frontScore || 0;\n  const frontScore = Math.max(0, Math.min(10, rawFrontScore));\n\n  const rawSideScore = analysisResults?.harmony?.sideScore || 0;\n  const sideScore = Math.max(0, Math.min(10, rawSideScore));\n\n  // PSL Rating (1-10 scale with tier/percentile)\n  const pslRating = useMemo(() => {\n    return harmonyToPSL(harmonyPercentage);\n  }, [harmonyPercentage]);\n\n  // Action to set all results data\n  const setResultsData = useCallback((data: ResultsInputData) => {\n    setFrontLandmarks(data.frontLandmarks);\n    setSideLandmarks(data.sideLandmarks);\n    setFrontPhoto(data.frontPhoto);\n    setSidePhoto(data.sidePhoto || null);\n    setGender(data.gender);\n    setEthnicity(data.ethnicity || 'other');\n  }, []);\n\n  // Memoize context value to prevent unnecessary re-renders\n  const value = useMemo<ResultsContextType>(() => ({\n    frontLandmarks,\n    sideLandmarks,\n    gender,\n    ethnicity,\n    frontPhoto,\n    sidePhoto,\n    harmonyAnalysis,\n    frontRatios,\n    sideRatios,\n    strengths,\n    flaws,\n    recommendations,\n    overallScore,\n    frontScore,\n    sideScore,\n    // Weighted harmony from looksmax_engine.py\n    harmonyScoreResult,\n    harmonyPercentage,\n    topMetrics,\n    bottomMetrics,\n    // PSL Rating\n    pslRating,\n    // UI state\n    activeTab,\n    setActiveTab,\n    expandedMeasurementId,\n    setExpandedMeasurementId,\n    selectedVisualizationMetric,\n    setSelectedVisualizationMetric,\n    categoryFilter,\n    setCategoryFilter,\n    showLandmarkOverlay,\n    setShowLandmarkOverlay,\n    setResultsData,\n  }), [\n    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,\n    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,\n    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,\n    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,\n    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,\n    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,\n    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,\n  ]);\n\n  return (\n    <ResultsContext.Provider value={value}>\n      {children}\n    </ResultsContext.Provider>\n  );\n}\n","structuredPatch":[{"oldStart":915,"oldLines":7,"newStart":915,"newLines":7,"lines":["         responsibleRatios: groupMeasurements.map(m => ({","           ratioName: m.name,","           ratioId: m.metricId,","-          score: m.score,","+          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow","           value: m.value,","           idealMin: m.idealMin,","           idealMax: m.idealMax,"]},{"oldStart":931,"oldLines":18,"newStart":931,"newLines":19,"lines":["     if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group"," ","     const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);","+    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 8));"," ","     strengths.push({","       id: `strength_${i}`,","       strengthName: s.metricName,","       summary: s.reasoning,","-      avgScore: matchingMeasurement?.score || 8,","+      avgScore: clampedScore,","       qualityLevel: s.qualityTier,","       categoryName: s.category,","       responsibleRatios: [{","         ratioName: s.metricName,","         ratioId: s.metricId,","-        score: matchingMeasurement?.score || 8,","+        score: clampedScore,  // Use clamped score","         value: s.value,","         idealMin: matchingMeasurement?.idealMin || 0,","         idealMax: matchingMeasurement?.idealMax || 1,"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"12c0ff3e-cd68-416a-a697-dae939d490e6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JC6mofvRFixDPUzqr1TEi4","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me fix the flaw generation functions in ResultsContext:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1820,"cache_read_input_tokens":99318,"cache_creation":{"ephemeral_5m_input_tokens":1820,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWUrecJ1jKY2VDAnvSjqs","type":"assistant","uuid":"8c602127-d1e0-4ef8-b648-16d95c4daefd","timestamp":"2025-12-26T06:52:26.608Z"}
{"parentUuid":"8c602127-d1e0-4ef8-b648-16d95c4daefd","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JC6mofvRFixDPUzqr1TEi4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CamC5EmNEBgCccYaiaQ5qD","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","old_string":"      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: matchingMeasurement?.score || 3,\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });","new_string":"      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 3));\n    const impact = matchingMeasurement ? (10 - clampedScore) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: clampedScore,  // Use clamped score\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1820,"cache_read_input_tokens":99318,"cache_creation":{"ephemeral_5m_input_tokens":1820,"ephemeral_1h_input_tokens":0},"output_tokens":1462,"service_tier":"standard"}},"requestId":"req_011CWUrecJ1jKY2VDAnvSjqs","type":"assistant","uuid":"f3e321bd-2b9f-4bd4-9cde-6eae622e969a","timestamp":"2025-12-26T06:52:44.114Z"}
{"parentUuid":"f3e321bd-2b9f-4bd4-9cde-6eae622e969a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CamC5EmNEBgCccYaiaQ5qD","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1042→      // Calculate total impact from all metrics in this group\n  1043→      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n  1044→      rollingLost += totalImpact;\n  1045→\n  1046→      // Create grouped flaw with multiple contributing ratios\n  1047→      flaws.push({\n  1048→        id: `flaw_group_${groupId}`,\n  1049→        flawName: groupConfig.name,\n  1050→        summary: groupConfig.description,\n  1051→        harmonyPercentageLost: totalImpact,\n  1052→        standardizedImpact: totalImpact / 10,\n  1053→        categoryName: groupConfig.category,\n  1054→        responsibleRatios: groupMeasurements.map(m => ({\n  1055→          ratioName: m.name,\n  1056→          ratioId: m.metricId,\n  1057→          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n  1058→          value: m.value,\n  1059→          idealMin: m.idealMin,\n  1060→          idealMax: m.idealMax,\n  1061→          unit: m.unit,\n  1062→          category: m.category,\n  1063→        })),\n  1064→        rollingPointsDeducted: rollingLost,\n  1065→        rollingHarmonyPercentageLost: rollingLost,\n  1066→        rollingStandardizedImpact: rollingLost / 10,\n  1067→      });\n  1068→    }\n  1069→  });\n  1070→\n  1071→  // Second pass: Add remaining individual flaws that weren't grouped\n  1072→  analysis.flaws.forEach((f, i) => {\n  1073→    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n  1074→\n  1075→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n  1076→    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 3));\n  1077→    const impact = matchingMeasurement ? (10 - clampedScore) * 0.5 : 2;\n  1078→    rollingLost += impact;\n  1079→\n  1080→    flaws.push({\n  1081→      id: `flaw_${i}`,\n  1082→      flawName: f.metricName,\n  1083→      summary: f.reasoning,\n  1084→      harmonyPercentageLost: impact,\n  1085→      standardizedImpact: impact / 10,\n  1086→      categoryName: f.category,\n  1087→      responsibleRatios: [{\n  1088→        ratioName: f.metricName,\n  1089→        ratioId: f.metricId,\n  1090→        score: clampedScore,  // Use clamped score\n  1091→        value: matchingMeasurement?.value || 0,\n  1092→        idealMin: matchingMeasurement?.idealMin || 0,\n  1093→        idealMax: matchingMeasurement?.idealMax || 1,\n  1094→        unit: matchingMeasurement?.unit || 'ratio',\n  1095→        category: f.category,\n  1096→      }],\n  1097→      rollingPointsDeducted: rollingLost,\n  1098→      rollingHarmonyPercentageLost: rollingLost,\n  1099→      rollingStandardizedImpact: rollingLost / 10,\n  1100→    });\n  1101→  });\n  1102→\n  1103→  // Sort by impact (highest first) then by number of contributing ratios\n  1104→  return flaws.sort((a, b) => {\n  1105→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {"}]},"uuid":"1a55ee0b-d21f-4108-b97f-2dae7b1b7d17","timestamp":"2025-12-26T06:52:44.151Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","oldString":"      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: matchingMeasurement?.score || 3,\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });","newString":"      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 3));\n    const impact = matchingMeasurement ? (10 - clampedScore) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: clampedScore,  // Use clamped score\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });","originalFile":"'use client';\n\nimport React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\nimport { LandmarkPoint } from '@/lib/landmarks';\nimport {\n  analyzeFrontProfile,\n  analyzeSideProfile,\n  analyzeHarmony,\n  HarmonyAnalysis,\n  MetricScoreResult,\n  METRIC_CONFIGS,\n  Ethnicity,\n  Gender,\n} from '@/lib/harmony-scoring';\nimport {\n  calculateHarmonyScore,\n  getTopMetrics,\n  getBottomMetrics,\n  HarmonyScoreResult,\n  RankedMetric,\n} from '@/lib/looksmax-scoring';\nimport { harmonyToPSL } from '@/lib/recommendations/severity';\nimport {\n  classifyInsights,\n  convertToStrength,\n  convertToFlaw,\n  INSIGHTS_DEFINITIONS,\n} from '@/lib/insights-engine';\nimport { classifyMetric } from '@/lib/taxonomy';\nimport {\n  Ratio,\n  Strength,\n  Flaw,\n  Recommendation,\n  ResultsTab,\n  FullHarmonyAnalysis,\n} from '@/types/results';\nimport { generateRecommendations } from '@/lib/results/analysis';\n\n// ============================================\n// CONTEXT TYPES\n// ============================================\n\ninterface ResultsContextType {\n  // Raw data\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  gender: Gender;\n  ethnicity: Ethnicity;\n  frontPhoto: string;\n  sidePhoto: string | null;\n\n  // Computed results\n  harmonyAnalysis: FullHarmonyAnalysis | null;\n  frontRatios: Ratio[];\n  sideRatios: Ratio[];\n  strengths: Strength[];\n  flaws: Flaw[];\n  recommendations: Recommendation[];\n\n  // Scores (now using weighted harmony from looksmax_engine.py)\n  overallScore: number;\n  frontScore: number;\n  sideScore: number;\n\n  // Weighted Harmony Score (from looksmax_engine.py)\n  harmonyScoreResult: HarmonyScoreResult | null;\n  harmonyPercentage: number;  // 0-100% weighted harmony\n\n  // Top 3 strengths and bottom 3 areas to improve with advice\n  topMetrics: RankedMetric[];\n  bottomMetrics: RankedMetric[];\n\n  // PSL Rating (1-10 scale)\n  pslRating: {\n    psl: number;\n    tier: string;\n    percentile: number;\n    description: string;\n  };\n\n  // UI state\n  activeTab: ResultsTab;\n  setActiveTab: (tab: ResultsTab) => void;\n  expandedMeasurementId: string | null;\n  setExpandedMeasurementId: (id: string | null) => void;\n  selectedVisualizationMetric: string | null;\n  setSelectedVisualizationMetric: (id: string | null) => void;\n  categoryFilter: string | null;\n  setCategoryFilter: (category: string | null) => void;\n  showLandmarkOverlay: boolean;\n  setShowLandmarkOverlay: (show: boolean) => void;\n\n  // Actions\n  setResultsData: (data: ResultsInputData) => void;\n}\n\ninterface ResultsInputData {\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  frontPhoto: string;\n  sidePhoto?: string;\n  gender: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// HELPER FUNCTIONS\n// ============================================\n\nfunction convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n  switch (unit) {\n    case 'ratio': return 'x';\n    case 'percent': return '%';\n    case 'degrees': return '°';\n    case 'mm': return 'mm';\n    default: return 'x';\n  }\n}\n\nfunction transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {\n  const metricConfig = METRIC_CONFIGS[result.metricId];\n\n  // Generate illustration based on metric\n  const illustration = generateIllustration(result.metricId, landmarks);\n\n  // Get flaw/strength mappings\n  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n\n  // Classify metric using Harmony taxonomy\n  const taxonomyClassification = classifyMetric(result.name, result.category);\n\n  // Clamp scores to valid 0-10 range for display (defense-in-depth)\n  const clampedScore = Math.max(0, Math.min(10, result.standardizedScore));\n\n  return {\n    id: result.metricId,\n    name: result.name,\n    value: result.value,\n    score: clampedScore,  // Use standardized 0-10 score for UI display\n    standardizedScore: clampedScore,\n    unit: convertUnitToRatioUnit(result.unit),\n    idealMin: result.idealMin,\n    idealMax: result.idealMax,\n    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n    description: metricConfig?.description || '',\n    category: result.category,\n    qualityLevel: result.qualityTier,\n    severity: result.severity,\n    illustration,\n    mayIndicateFlaws,\n    mayIndicateStrengths,\n    usedLandmarks: getUsedLandmarks(result.metricId),\n    scoringCurveConfig: metricConfig ? {\n      decayRate: metricConfig.decayRate,\n      maxScore: metricConfig.maxScore,\n    } : undefined,\n    taxonomyPrimary: taxonomyClassification?.primary,\n    taxonomySecondary: taxonomyClassification?.secondary,\n  };\n}\n\n// Enhanced illustration configuration type\ninterface IllustrationConfig {\n  points: string[];\n  lines: Array<{\n    from: string;\n    to: string;\n    label?: string;\n    color?: string;\n    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n  }>;\n}\n\n// Comprehensive illustration configurations for all metrics\nconst ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n  // ==========================================\n  // FACE SHAPE / PROPORTIONS\n  // ==========================================\n  faceWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n    ],\n  },\n  totalFacialWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n    ],\n  },\n  lowerThirdProportion: {\n    points: ['subnasale', 'menton', 'trichion'],\n    lines: [\n      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  middleThirdProportion: {\n    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n    lines: [\n      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  upperThirdProportion: {\n    points: ['trichion', 'nasal_base', 'menton'],\n    lines: [\n      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  bitemporalWidth: {\n    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n    ],\n  },\n  cheekboneHeight: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n    ],\n  },\n  midfaceRatio: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // JAW MEASUREMENTS\n  // ==========================================\n  jawSlope: {\n    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n    ],\n  },\n  jawFrontalAngle: {\n    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  bigonialWidth: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n    ],\n  },\n  jawWidthRatio: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n    ],\n  },\n\n  // ==========================================\n  // EYE MEASUREMENTS\n  // ==========================================\n  lateralCanthalTilt: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n    ],\n  },\n  eyeAspectRatio: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  eyeSeparationRatio: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryMouthWidthRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n    ],\n  },\n  oneEyeApartTest: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // EYEBROW MEASUREMENTS\n  // ==========================================\n  browLengthRatio: {\n    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  eyebrowTilt: {\n    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n    ],\n  },\n  eyebrowLowSetedness: {\n    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n    ],\n  },\n\n  // ==========================================\n  // NOSE MEASUREMENTS (FRONT)\n  // ==========================================\n  nasalIndex: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  intercanthalNasalRatio: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n    ],\n  },\n  noseBridgeWidth: {\n    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n    ],\n  },\n  noseTipPosition: {\n    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // MOUTH/LIP MEASUREMENTS\n  // ==========================================\n  mouthNoseWidthRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  mouthWidth: {\n    points: ['left_cheilion', 'right_cheilion'],\n    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n  },\n\n  // ==========================================\n  // CHIN MEASUREMENTS\n  // ==========================================\n  chinHeight: {\n    points: ['labrale_inferius', 'menton'],\n    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n  },\n\n  // ==========================================\n  // NECK MEASUREMENTS\n  // ==========================================\n  neckWidthRatio: {\n    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n    ],\n  },\n\n  // ==========================================\n  // SIDE PROFILE MEASUREMENTS\n  // ==========================================\n  gonialAngle: {\n    points: ['tragus', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  nasofrontalAngle: {\n    points: ['glabella', 'nasion', 'pronasale'],\n    lines: [\n      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  nasofacialAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n    ],\n  },\n  nasomentaAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n    ],\n  },\n  submentalCervicalAngle: {\n    points: ['menton', 'cervicalPoint', 'neckPoint'],\n    lines: [\n      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n    ],\n  },\n  facialDepthToHeight: {\n    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n    lines: [\n      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  anteriorFacialDepth: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n    ],\n  },\n  mandibularPlaneAngle: {\n    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n    lines: [\n      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n    ],\n  },\n  ramusToMandibleRatio: {\n    points: ['gonionTop', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  orbitalVector: {\n    points: ['cornealApex', 'orbitale', 'cheekbone'],\n    lines: [\n      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n    ],\n  },\n  eLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  holdawayHLine: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n    ],\n  },\n  burstoneLowerLip: {\n    points: ['subnasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL FRONT PROFILE METRICS\n  // ==========================================\n  cupidsBowDepth: {\n    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],\n    lines: [\n      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },\n      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },\n    ],\n  },\n  mouthCornerPosition: {\n    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },\n    ],\n  },\n  iaaJfaDeviation: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },\n      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  ipsilateralAlarAngle: {\n    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },\n      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },\n    ],\n  },\n  earProtrusionAngle: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },\n    ],\n  },\n  earProtrusionRatio: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },\n      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },\n    ],\n  },\n  mouthWidthToNoseRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerToUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinToPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL SIDE PROFILE METRICS\n  // ==========================================\n  nasolabialAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },\n      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },\n    ],\n  },\n  nasalTipAngle: {\n    points: ['nasion', 'pronasale', 'columella'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },\n      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },\n    ],\n  },\n  nasalProjection: {\n    points: ['alar_crease', 'pronasale', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },\n    ],\n  },\n  nasalWToHRatio: {\n    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },\n      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  noseTipRotationAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },\n    ],\n  },\n  frankfortTipAngle: {\n    points: ['porion', 'orbitale', 'pronasale'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },\n    ],\n  },\n  mentolabialAngle: {\n    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],\n    lines: [\n      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },\n      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  zAngle: {\n    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],\n    lines: [\n      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },\n    ],\n  },\n  facialConvexityGlabella: {\n    points: ['glabella', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  facialConvexityNasion: {\n    points: ['nasion', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  totalFacialConvexity: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },\n      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  interiorMidfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },\n      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },\n    ],\n  },\n  recessionFromFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  gonionToMouthLine: {\n    points: ['gonionBottom', 'cheilion', 'tragus'],\n    lines: [\n      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },\n    ],\n  },\n  eLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  burstoneUpperLip: {\n    points: ['subnasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n  chinProjection: {\n    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },\n    ],\n  },\n  recessionRelativeToFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion', 'menton'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  browridgeInclinationAngle: {\n    points: ['glabella', 'trichion', 'nasion'],\n    lines: [\n      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },\n      { from: 'glabella', to: 'nasion', color: '#67e8f9' },\n    ],\n  },\n  upperForeheadSlope: {\n    points: ['trichion', 'glabella', 'frankfortHorizontal'],\n    lines: [\n      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },\n    ],\n  },\n  midfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },\n      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },\n    ],\n  },\n};\n\nfunction generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {\n  const landmarkMap: Record<string, LandmarkPoint> = {};\n  landmarks.forEach(l => { landmarkMap[l.id] = l; });\n\n  const config = ILLUSTRATION_CONFIGS[metricId];\n  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};\n  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};\n\n  if (config) {\n    config.points.forEach((pointId, i) => {\n      if (landmarkMap[pointId]) {\n        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };\n      }\n    });\n    config.lines.forEach((line, i) => {\n      lines[`line_${i}`] = {\n        from: line.from,\n        to: line.to,\n        color: line.color || '#67e8f9',\n        label: line.label,\n        labelPosition: line.labelPosition,\n      };\n    });\n  }\n\n  return { points, lines };\n}\n\nfunction getUsedLandmarks(metricId: string): string[] {\n  const landmarkMappings: Record<string, string[]> = {\n    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],\n    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    ipd: ['left_pupila', 'right_pupila'],\n    mouthWidth: ['left_cheilion', 'right_cheilion'],\n    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],\n    chinHeight: ['labrale_inferius', 'menton'],\n    gonialAngle: ['tragus', 'gonionBottom', 'menton'],\n  };\n  return landmarkMappings[metricId] || [];\n}\n\nfunction getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {\n  const flawMappings: Record<string, { low: string[]; high: string[] }> = {\n    faceWidthToHeight: {\n      low: ['Narrow face', 'Vertically elongated face'],\n      high: ['Wide face', 'Horizontally expanded face'],\n    },\n    lowerThirdProportion: {\n      low: ['Short lower third', 'Deficient mandible'],\n      high: ['Long lower third', 'Mandibular excess'],\n    },\n    lateralCanthalTilt: {\n      low: ['Negative canthal tilt', 'Drooping eyes'],\n      high: ['Excessive positive canthal tilt'],\n    },\n    nasalIndex: {\n      low: ['Narrow nose', 'Leptorrhine nose'],\n      high: ['Wide nose', 'Platyrrhine nose'],\n    },\n    gonialAngle: {\n      low: ['Steep mandibular plane'],\n      high: ['Flat mandibular plane', 'Weak jaw definition'],\n    },\n  };\n\n  const strengthMappings: Record<string, { ideal: string[] }> = {\n    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },\n    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },\n    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },\n    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },\n  };\n\n  const mapping = flawMappings[result.metricId];\n  const strengthMapping = strengthMappings[result.metricId];\n\n  let mayIndicateFlaws: string[] = [];\n  let mayIndicateStrengths: string[] = [];\n\n  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {\n    mayIndicateStrengths = strengthMapping?.ideal || [];\n  } else if (mapping) {\n    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;\n  }\n\n  return { mayIndicateFlaws, mayIndicateStrengths };\n}\n\n// Metric groupings for creating multi-ratio strengths\nconst STRENGTH_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Proportions\n  lipProportions: {\n    name: 'Well Proportioned Lips',\n    category: 'Lips',\n    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Proportions\n  eyeProportions: {\n    name: 'Harmonious Eye Proportions',\n    category: 'Eyes',\n    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Proportions\n  noseProportions: {\n    name: 'Balanced Nasal Proportions',\n    category: 'Nose',\n    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Definition\n  jawDefinition: {\n    name: 'Well-Defined Jawline',\n    category: 'Jaw Shape',\n    description: 'The jawline displays strong definition with balanced angles and proportionate width.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Proportions\n  chinProportions: {\n    name: 'Balanced Chin Projection',\n    category: 'Chin',\n    description: 'The chin demonstrates ideal projection and proportions relative to the face.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Facial Thirds\n  facialThirds: {\n    name: 'Balanced Facial Thirds',\n    category: 'Face Proportions',\n    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface\n  midfaceBalance: {\n    name: 'Harmonious Midface',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows balanced proportions with well-positioned cheekbones.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n  // Forehead\n  foreheadBalance: {\n    name: 'Well-Proportioned Forehead',\n    category: 'Forehead',\n    description: 'The forehead displays ideal proportions in height and shape.',\n    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],\n  },\n};\n\nfunction generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {\n  const strengths: Strength[] = [];\n  const usedMetricIds = new Set<string>();\n\n  // First pass: Create grouped strengths from related high-scoring metrics\n  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all high-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score >= 7.5 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 8));\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: clampedScore,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: clampedScore,  // Use clamped score\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });\n\n  // Sort by average score (highest first) then by number of contributing ratios\n  return strengths.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.avgScore - a.avgScore;\n  });\n}\n\n// Flaw groupings - similar to strength groupings but for areas of improvement\nconst FLAW_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Issues\n  lipIssues: {\n    name: 'Lip Proportion Concerns',\n    category: 'Lips',\n    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Issues\n  eyeIssues: {\n    name: 'Eye Shape Considerations',\n    category: 'Eyes',\n    description: 'The eye proportions or positioning could benefit from enhancement.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Issues\n  noseIssues: {\n    name: 'Nasal Proportion Concerns',\n    category: 'Nose',\n    description: 'The nasal proportions show deviations that affect facial harmony.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Issues\n  jawIssues: {\n    name: 'Jawline Definition Concerns',\n    category: 'Jaw Shape',\n    description: 'The jawline structure shows areas that could be enhanced for better definition.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Issues\n  chinIssues: {\n    name: 'Chin Projection Concerns',\n    category: 'Chin',\n    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Face Proportion Issues\n  proportionIssues: {\n    name: 'Facial Proportion Imbalance',\n    category: 'Face Proportions',\n    description: 'The vertical face proportions show imbalance between facial thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface Issues\n  midfaceIssues: {\n    name: 'Midface Development Concerns',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows areas that could benefit from enhanced projection or balance.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n};\n\nfunction generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  const flaws: Flaw[] = [];\n  const usedMetricIds = new Set<string>();\n  let rollingLost = 0;\n\n  // First pass: Create grouped flaws from related low-scoring metrics\n  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all low-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score < 6 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped flaw if we have 2+ metrics with low scores\n    if (groupMeasurements.length >= 2) {\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Calculate total impact from all metrics in this group\n      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n      rollingLost += totalImpact;\n\n      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: matchingMeasurement?.score || 3,\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });\n\n  // Sort by impact (highest first) then by number of contributing ratios\n  return flaws.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  });\n}\n\n// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions\n// have been moved to @/lib/results/analysis.ts to reduce bundle size\n// Import generateRecommendations from there instead\n// ============================================\n// CONTEXT CREATION\n// ============================================\n\nconst ResultsContext = createContext<ResultsContextType | null>(null);\n\nexport function useResults(): ResultsContextType {\n  const context = useContext(ResultsContext);\n  if (!context) {\n    throw new Error('useResults must be used within a ResultsProvider');\n  }\n  return context;\n}\n\ninterface ResultsProviderProps {\n  children: ReactNode;\n  initialData?: ResultsInputData;\n}\n\nexport function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  // Raw data state\n  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n\n  // UI state\n  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n\n  // Compute analysis results (now with demographic-specific scoring)\n  const analysisResults = useMemo(() => {\n    if (frontLandmarks.length === 0) {\n      return null;\n    }\n\n    try {\n      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n      const sideAnalysis = sideLandmarks.length > 0\n        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n        : null;\n      // analyzeHarmony expects landmarks directly, not analysis results\n      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n\n      return { frontAnalysis, sideAnalysis, harmony };\n    } catch (error) {\n      console.error('Analysis error:', error);\n      return null;\n    }\n  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n\n  // Transform to Ratio format\n  const frontRatios = useMemo(() => {\n    if (!analysisResults?.frontAnalysis) return [];\n    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  }, [analysisResults, frontLandmarks]);\n\n  const sideRatios = useMemo(() => {\n    if (!analysisResults?.sideAnalysis) return [];\n    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  }, [analysisResults, sideLandmarks]);\n\n  // Generate strengths and flaws using INSIGHTS-BASED classification\n  // This processes insights.json definitions: calculates avg score of affected metrics,\n  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  const { insightStrengths, insightFlaws } = useMemo(() => {\n    if (!analysisResults?.harmony) {\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n\n    try {\n      // Classify using insights engine\n      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n\n      // Convert to UI-compatible types\n      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n      let rollingLost = 0;\n      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n        const flaw = convertToFlaw(w, i, rollingLost);\n        rollingLost = flaw.rollingPointsDeducted || 0;\n        return flaw;\n      });\n\n      return { insightStrengths, insightFlaws };\n    } catch (error) {\n      console.error('[ResultsContext] Error in insights classification:', error);\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n  }, [analysisResults]);\n\n  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  const groupingStrengths = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  const groupingFlaws = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateFlawsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)\n  const strengths = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightStrengths.forEach(s => {\n      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based strengths that don't overlap\n    const nonOverlappingGrouping = groupingStrengths.filter(gs => {\n      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    return [...insightStrengths, ...nonOverlappingGrouping];\n  }, [insightStrengths, groupingStrengths]);\n\n  const flaws = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightFlaws.forEach(f => {\n      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based flaws that don't overlap\n    const nonOverlappingGrouping = groupingFlaws.filter(gf => {\n      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    // Recalculate rolling totals for merged list\n    let rollingLost = 0;\n    const merged = [...insightFlaws, ...nonOverlappingGrouping];\n    return merged.map(f => {\n      rollingLost += f.harmonyPercentageLost;\n      return {\n        ...f,\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      };\n    });\n  }, [insightFlaws, groupingFlaws]);\n\n  // Generate recommendations with metric-aware matching and Bezier recalculation\n  const recommendations = useMemo(() => {\n    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);\n  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);\n\n  // Build full harmony analysis\n  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {\n    if (!analysisResults?.harmony) return null;\n\n    return {\n      standardizedScore: analysisResults.harmony.overallScore,\n      front: {\n        standardizedScore: analysisResults.harmony.frontScore,\n        ratios: frontRatios,\n      },\n      side: {\n        standardizedScore: analysisResults.harmony.sideScore,\n        ratios: sideRatios,\n      },\n      strengths,\n      flaws,\n    };\n  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);\n\n  // Calculate weighted harmony score using looksmax_engine.py algorithm\n  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {\n    if (!analysisResults?.harmony) return null;\n\n    const allMeasurements = analysisResults.harmony.measurements.map(m => ({\n      metricId: m.metricId,\n      standardizedScore: m.standardizedScore,\n    }));\n\n    return calculateHarmonyScore(allMeasurements);\n  }, [analysisResults]);\n\n  // Get top 3 and bottom 3 metrics with advice\n  const topMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getTopMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  const bottomMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getBottomMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  // Scores - now using weighted harmony with explicit clamping to 0-10\n  const rawHarmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;\n  const harmonyPercentage = Math.max(0, Math.min(100, rawHarmonyPercentage));\n\n  const rawOverallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;\n  const overallScore = Math.max(0, Math.min(10, rawOverallScore));\n\n  const rawFrontScore = analysisResults?.harmony?.frontScore || 0;\n  const frontScore = Math.max(0, Math.min(10, rawFrontScore));\n\n  const rawSideScore = analysisResults?.harmony?.sideScore || 0;\n  const sideScore = Math.max(0, Math.min(10, rawSideScore));\n\n  // PSL Rating (1-10 scale with tier/percentile)\n  const pslRating = useMemo(() => {\n    return harmonyToPSL(harmonyPercentage);\n  }, [harmonyPercentage]);\n\n  // Action to set all results data\n  const setResultsData = useCallback((data: ResultsInputData) => {\n    setFrontLandmarks(data.frontLandmarks);\n    setSideLandmarks(data.sideLandmarks);\n    setFrontPhoto(data.frontPhoto);\n    setSidePhoto(data.sidePhoto || null);\n    setGender(data.gender);\n    setEthnicity(data.ethnicity || 'other');\n  }, []);\n\n  // Memoize context value to prevent unnecessary re-renders\n  const value = useMemo<ResultsContextType>(() => ({\n    frontLandmarks,\n    sideLandmarks,\n    gender,\n    ethnicity,\n    frontPhoto,\n    sidePhoto,\n    harmonyAnalysis,\n    frontRatios,\n    sideRatios,\n    strengths,\n    flaws,\n    recommendations,\n    overallScore,\n    frontScore,\n    sideScore,\n    // Weighted harmony from looksmax_engine.py\n    harmonyScoreResult,\n    harmonyPercentage,\n    topMetrics,\n    bottomMetrics,\n    // PSL Rating\n    pslRating,\n    // UI state\n    activeTab,\n    setActiveTab,\n    expandedMeasurementId,\n    setExpandedMeasurementId,\n    selectedVisualizationMetric,\n    setSelectedVisualizationMetric,\n    categoryFilter,\n    setCategoryFilter,\n    showLandmarkOverlay,\n    setShowLandmarkOverlay,\n    setResultsData,\n  }), [\n    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,\n    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,\n    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,\n    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,\n    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,\n    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,\n    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,\n  ]);\n\n  return (\n    <ResultsContext.Provider value={value}>\n      {children}\n    </ResultsContext.Provider>\n  );\n}\n","structuredPatch":[{"oldStart":1054,"oldLines":7,"newStart":1054,"newLines":7,"lines":["         responsibleRatios: groupMeasurements.map(m => ({","           ratioName: m.name,","           ratioId: m.metricId,","-          score: m.score,","+          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow","           value: m.value,","           idealMin: m.idealMin,","           idealMax: m.idealMax,"]},{"oldStart":1073,"oldLines":7,"newStart":1073,"newLines":8,"lines":["     if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group"," ","     const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);","-    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;","+    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 3));","+    const impact = matchingMeasurement ? (10 - clampedScore) * 0.5 : 2;","     rollingLost += impact;"," ","     flaws.push({"]},{"oldStart":1086,"oldLines":7,"newStart":1087,"newLines":7,"lines":["       responsibleRatios: [{","         ratioName: f.metricName,","         ratioId: f.metricId,","-        score: matchingMeasurement?.score || 3,","+        score: clampedScore,  // Use clamped score","         value: matchingMeasurement?.value || 0,","         idealMin: matchingMeasurement?.idealMin || 0,","         idealMax: matchingMeasurement?.idealMax || 1,"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"1a55ee0b-d21f-4108-b97f-2dae7b1b7d17","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_014rkb3VazdnvVxAc7XQuasB","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me also check if there's a similar issue in the avgScore calculation in the strength groupings. Let me check:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2603,"cache_read_input_tokens":101138,"cache_creation":{"ephemeral_5m_input_tokens":2603,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUrg95xSKXdCqMuWHAiV","type":"assistant","uuid":"9ac934b4-72c1-4cdf-a3da-50cdf04242f2","timestamp":"2025-12-26T06:52:47.756Z"}
{"parentUuid":"9ac934b4-72c1-4cdf-a3da-50cdf04242f2","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_014rkb3VazdnvVxAc7XQuasB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UVJ1f5ZMKduzrbnVRtU7eF","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","offset":893,"limit":25}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2603,"cache_read_input_tokens":101138,"cache_creation":{"ephemeral_5m_input_tokens":2603,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWUrg95xSKXdCqMuWHAiV","type":"assistant","uuid":"fd471839-d20b-42be-a51a-6310cbd7de9b","timestamp":"2025-12-26T06:52:49.226Z"}
{"parentUuid":"fd471839-d20b-42be-a51a-6310cbd7de9b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UVJ1f5ZMKduzrbnVRtU7eF","type":"tool_result","content":"   893→    const groupMeasurements = analysis.measurements.filter(m =>\n   894→      groupConfig.metrics.includes(m.metricId) &&\n   895→      m.score >= 7.5 &&\n   896→      !usedMetricIds.has(m.metricId)\n   897→    );\n   898→\n   899→    // Only create a grouped strength if we have 2+ metrics with good scores\n   900→    if (groupMeasurements.length >= 2) {\n   901→      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n   902→      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n   903→\n   904→      // Mark these metrics as used\n   905→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n   906→\n   907→      // Create grouped strength with multiple contributing ratios\n   908→      strengths.push({\n   909→        id: `strength_group_${groupId}`,\n   910→        strengthName: groupConfig.name,\n   911→        summary: groupConfig.description,\n   912→        avgScore,\n   913→        qualityLevel: bestQuality,\n   914→        categoryName: groupConfig.category,\n   915→        responsibleRatios: groupMeasurements.map(m => ({\n   916→          ratioName: m.name,\n   917→          ratioId: m.metricId,\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6dbe3a8c-6430-485b-8ace-553865158a2e","timestamp":"2025-12-26T06:52:49.286Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","content":"    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score >= 7.5 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,","numLines":25,"startLine":893,"totalLines":1394}}}
{"parentUuid":"6dbe3a8c-6430-485b-8ace-553865158a2e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CgPx4CRhVNQo6x1MZZQ9Fx","type":"message","role":"assistant","content":[{"type":"text","text":"I see that `avgScore` at line 901 and 912 also needs clamping. Let me fix that:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":736,"cache_read_input_tokens":103741,"cache_creation":{"ephemeral_5m_input_tokens":736,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrgWsPN71swt28cepah","type":"assistant","uuid":"d7b40518-a781-428a-945e-251bdeb12b0b","timestamp":"2025-12-26T06:52:53.734Z"}
{"parentUuid":"d7b40518-a781-428a-945e-251bdeb12b0b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CgPx4CRhVNQo6x1MZZQ9Fx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CWpGG7oJbN4nkAxSHd7RRw","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","old_string":"    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,","new_string":"    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const rawAvgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const avgScore = Math.max(0, Math.min(10, rawAvgScore));  // Clamp to 0-10\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":736,"cache_read_input_tokens":103741,"cache_creation":{"ephemeral_5m_input_tokens":736,"ephemeral_1h_input_tokens":0},"output_tokens":594,"service_tier":"standard"}},"requestId":"req_011CWUrgWsPN71swt28cepah","type":"assistant","uuid":"bb924a7d-a901-4bac-bab3-2fcb19a96bcf","timestamp":"2025-12-26T06:52:59.794Z"}
{"parentUuid":"bb924a7d-a901-4bac-bab3-2fcb19a96bcf","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CWpGG7oJbN4nkAxSHd7RRw","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   895→      m.score >= 7.5 &&\n   896→      !usedMetricIds.has(m.metricId)\n   897→    );\n   898→\n   899→    // Only create a grouped strength if we have 2+ metrics with good scores\n   900→    if (groupMeasurements.length >= 2) {\n   901→      const rawAvgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n   902→      const avgScore = Math.max(0, Math.min(10, rawAvgScore));  // Clamp to 0-10\n   903→      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n   904→\n   905→      // Mark these metrics as used\n   906→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n   907→\n   908→      // Create grouped strength with multiple contributing ratios\n   909→      strengths.push({\n   910→        id: `strength_group_${groupId}`,\n   911→        strengthName: groupConfig.name,\n   912→        summary: groupConfig.description,\n   913→        avgScore,\n   914→        qualityLevel: bestQuality,\n   915→        categoryName: groupConfig.category,\n   916→        responsibleRatios: groupMeasurements.map(m => ({\n   917→          ratioName: m.name,\n   918→          ratioId: m.metricId,"}]},"uuid":"c488ee09-a5f7-4e35-bb6f-bb697e2ae47a","timestamp":"2025-12-26T06:52:59.835Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","oldString":"    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,","newString":"    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const rawAvgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const avgScore = Math.max(0, Math.min(10, rawAvgScore));  // Clamp to 0-10\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,","originalFile":"'use client';\n\nimport React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\nimport { LandmarkPoint } from '@/lib/landmarks';\nimport {\n  analyzeFrontProfile,\n  analyzeSideProfile,\n  analyzeHarmony,\n  HarmonyAnalysis,\n  MetricScoreResult,\n  METRIC_CONFIGS,\n  Ethnicity,\n  Gender,\n} from '@/lib/harmony-scoring';\nimport {\n  calculateHarmonyScore,\n  getTopMetrics,\n  getBottomMetrics,\n  HarmonyScoreResult,\n  RankedMetric,\n} from '@/lib/looksmax-scoring';\nimport { harmonyToPSL } from '@/lib/recommendations/severity';\nimport {\n  classifyInsights,\n  convertToStrength,\n  convertToFlaw,\n  INSIGHTS_DEFINITIONS,\n} from '@/lib/insights-engine';\nimport { classifyMetric } from '@/lib/taxonomy';\nimport {\n  Ratio,\n  Strength,\n  Flaw,\n  Recommendation,\n  ResultsTab,\n  FullHarmonyAnalysis,\n} from '@/types/results';\nimport { generateRecommendations } from '@/lib/results/analysis';\n\n// ============================================\n// CONTEXT TYPES\n// ============================================\n\ninterface ResultsContextType {\n  // Raw data\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  gender: Gender;\n  ethnicity: Ethnicity;\n  frontPhoto: string;\n  sidePhoto: string | null;\n\n  // Computed results\n  harmonyAnalysis: FullHarmonyAnalysis | null;\n  frontRatios: Ratio[];\n  sideRatios: Ratio[];\n  strengths: Strength[];\n  flaws: Flaw[];\n  recommendations: Recommendation[];\n\n  // Scores (now using weighted harmony from looksmax_engine.py)\n  overallScore: number;\n  frontScore: number;\n  sideScore: number;\n\n  // Weighted Harmony Score (from looksmax_engine.py)\n  harmonyScoreResult: HarmonyScoreResult | null;\n  harmonyPercentage: number;  // 0-100% weighted harmony\n\n  // Top 3 strengths and bottom 3 areas to improve with advice\n  topMetrics: RankedMetric[];\n  bottomMetrics: RankedMetric[];\n\n  // PSL Rating (1-10 scale)\n  pslRating: {\n    psl: number;\n    tier: string;\n    percentile: number;\n    description: string;\n  };\n\n  // UI state\n  activeTab: ResultsTab;\n  setActiveTab: (tab: ResultsTab) => void;\n  expandedMeasurementId: string | null;\n  setExpandedMeasurementId: (id: string | null) => void;\n  selectedVisualizationMetric: string | null;\n  setSelectedVisualizationMetric: (id: string | null) => void;\n  categoryFilter: string | null;\n  setCategoryFilter: (category: string | null) => void;\n  showLandmarkOverlay: boolean;\n  setShowLandmarkOverlay: (show: boolean) => void;\n\n  // Actions\n  setResultsData: (data: ResultsInputData) => void;\n}\n\ninterface ResultsInputData {\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  frontPhoto: string;\n  sidePhoto?: string;\n  gender: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// HELPER FUNCTIONS\n// ============================================\n\nfunction convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n  switch (unit) {\n    case 'ratio': return 'x';\n    case 'percent': return '%';\n    case 'degrees': return '°';\n    case 'mm': return 'mm';\n    default: return 'x';\n  }\n}\n\nfunction transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {\n  const metricConfig = METRIC_CONFIGS[result.metricId];\n\n  // Generate illustration based on metric\n  const illustration = generateIllustration(result.metricId, landmarks);\n\n  // Get flaw/strength mappings\n  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n\n  // Classify metric using Harmony taxonomy\n  const taxonomyClassification = classifyMetric(result.name, result.category);\n\n  // Clamp scores to valid 0-10 range for display (defense-in-depth)\n  const clampedScore = Math.max(0, Math.min(10, result.standardizedScore));\n\n  return {\n    id: result.metricId,\n    name: result.name,\n    value: result.value,\n    score: clampedScore,  // Use standardized 0-10 score for UI display\n    standardizedScore: clampedScore,\n    unit: convertUnitToRatioUnit(result.unit),\n    idealMin: result.idealMin,\n    idealMax: result.idealMax,\n    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n    description: metricConfig?.description || '',\n    category: result.category,\n    qualityLevel: result.qualityTier,\n    severity: result.severity,\n    illustration,\n    mayIndicateFlaws,\n    mayIndicateStrengths,\n    usedLandmarks: getUsedLandmarks(result.metricId),\n    scoringCurveConfig: metricConfig ? {\n      decayRate: metricConfig.decayRate,\n      maxScore: metricConfig.maxScore,\n    } : undefined,\n    taxonomyPrimary: taxonomyClassification?.primary,\n    taxonomySecondary: taxonomyClassification?.secondary,\n  };\n}\n\n// Enhanced illustration configuration type\ninterface IllustrationConfig {\n  points: string[];\n  lines: Array<{\n    from: string;\n    to: string;\n    label?: string;\n    color?: string;\n    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n  }>;\n}\n\n// Comprehensive illustration configurations for all metrics\nconst ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n  // ==========================================\n  // FACE SHAPE / PROPORTIONS\n  // ==========================================\n  faceWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n    ],\n  },\n  totalFacialWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n    ],\n  },\n  lowerThirdProportion: {\n    points: ['subnasale', 'menton', 'trichion'],\n    lines: [\n      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  middleThirdProportion: {\n    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n    lines: [\n      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  upperThirdProportion: {\n    points: ['trichion', 'nasal_base', 'menton'],\n    lines: [\n      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  bitemporalWidth: {\n    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n    ],\n  },\n  cheekboneHeight: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n    ],\n  },\n  midfaceRatio: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // JAW MEASUREMENTS\n  // ==========================================\n  jawSlope: {\n    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n    ],\n  },\n  jawFrontalAngle: {\n    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  bigonialWidth: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n    ],\n  },\n  jawWidthRatio: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n    ],\n  },\n\n  // ==========================================\n  // EYE MEASUREMENTS\n  // ==========================================\n  lateralCanthalTilt: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n    ],\n  },\n  eyeAspectRatio: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  eyeSeparationRatio: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryMouthWidthRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n    ],\n  },\n  oneEyeApartTest: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // EYEBROW MEASUREMENTS\n  // ==========================================\n  browLengthRatio: {\n    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  eyebrowTilt: {\n    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n    ],\n  },\n  eyebrowLowSetedness: {\n    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n    ],\n  },\n\n  // ==========================================\n  // NOSE MEASUREMENTS (FRONT)\n  // ==========================================\n  nasalIndex: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  intercanthalNasalRatio: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n    ],\n  },\n  noseBridgeWidth: {\n    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n    ],\n  },\n  noseTipPosition: {\n    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // MOUTH/LIP MEASUREMENTS\n  // ==========================================\n  mouthNoseWidthRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  mouthWidth: {\n    points: ['left_cheilion', 'right_cheilion'],\n    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n  },\n\n  // ==========================================\n  // CHIN MEASUREMENTS\n  // ==========================================\n  chinHeight: {\n    points: ['labrale_inferius', 'menton'],\n    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n  },\n\n  // ==========================================\n  // NECK MEASUREMENTS\n  // ==========================================\n  neckWidthRatio: {\n    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n    ],\n  },\n\n  // ==========================================\n  // SIDE PROFILE MEASUREMENTS\n  // ==========================================\n  gonialAngle: {\n    points: ['tragus', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  nasofrontalAngle: {\n    points: ['glabella', 'nasion', 'pronasale'],\n    lines: [\n      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  nasofacialAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n    ],\n  },\n  nasomentaAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n    ],\n  },\n  submentalCervicalAngle: {\n    points: ['menton', 'cervicalPoint', 'neckPoint'],\n    lines: [\n      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n    ],\n  },\n  facialDepthToHeight: {\n    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n    lines: [\n      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  anteriorFacialDepth: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n    ],\n  },\n  mandibularPlaneAngle: {\n    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n    lines: [\n      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n    ],\n  },\n  ramusToMandibleRatio: {\n    points: ['gonionTop', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  orbitalVector: {\n    points: ['cornealApex', 'orbitale', 'cheekbone'],\n    lines: [\n      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n    ],\n  },\n  eLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  holdawayHLine: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n    ],\n  },\n  burstoneLowerLip: {\n    points: ['subnasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL FRONT PROFILE METRICS\n  // ==========================================\n  cupidsBowDepth: {\n    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],\n    lines: [\n      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },\n      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },\n    ],\n  },\n  mouthCornerPosition: {\n    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },\n    ],\n  },\n  iaaJfaDeviation: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },\n      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  ipsilateralAlarAngle: {\n    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },\n      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },\n    ],\n  },\n  earProtrusionAngle: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },\n    ],\n  },\n  earProtrusionRatio: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },\n      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },\n    ],\n  },\n  mouthWidthToNoseRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerToUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinToPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL SIDE PROFILE METRICS\n  // ==========================================\n  nasolabialAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },\n      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },\n    ],\n  },\n  nasalTipAngle: {\n    points: ['nasion', 'pronasale', 'columella'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },\n      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },\n    ],\n  },\n  nasalProjection: {\n    points: ['alar_crease', 'pronasale', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },\n    ],\n  },\n  nasalWToHRatio: {\n    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },\n      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  noseTipRotationAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },\n    ],\n  },\n  frankfortTipAngle: {\n    points: ['porion', 'orbitale', 'pronasale'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },\n    ],\n  },\n  mentolabialAngle: {\n    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],\n    lines: [\n      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },\n      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  zAngle: {\n    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],\n    lines: [\n      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },\n    ],\n  },\n  facialConvexityGlabella: {\n    points: ['glabella', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  facialConvexityNasion: {\n    points: ['nasion', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  totalFacialConvexity: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },\n      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  interiorMidfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },\n      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },\n    ],\n  },\n  recessionFromFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  gonionToMouthLine: {\n    points: ['gonionBottom', 'cheilion', 'tragus'],\n    lines: [\n      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },\n    ],\n  },\n  eLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  burstoneUpperLip: {\n    points: ['subnasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n  chinProjection: {\n    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },\n    ],\n  },\n  recessionRelativeToFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion', 'menton'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  browridgeInclinationAngle: {\n    points: ['glabella', 'trichion', 'nasion'],\n    lines: [\n      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },\n      { from: 'glabella', to: 'nasion', color: '#67e8f9' },\n    ],\n  },\n  upperForeheadSlope: {\n    points: ['trichion', 'glabella', 'frankfortHorizontal'],\n    lines: [\n      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },\n    ],\n  },\n  midfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },\n      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },\n    ],\n  },\n};\n\nfunction generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {\n  const landmarkMap: Record<string, LandmarkPoint> = {};\n  landmarks.forEach(l => { landmarkMap[l.id] = l; });\n\n  const config = ILLUSTRATION_CONFIGS[metricId];\n  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};\n  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};\n\n  if (config) {\n    config.points.forEach((pointId, i) => {\n      if (landmarkMap[pointId]) {\n        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };\n      }\n    });\n    config.lines.forEach((line, i) => {\n      lines[`line_${i}`] = {\n        from: line.from,\n        to: line.to,\n        color: line.color || '#67e8f9',\n        label: line.label,\n        labelPosition: line.labelPosition,\n      };\n    });\n  }\n\n  return { points, lines };\n}\n\nfunction getUsedLandmarks(metricId: string): string[] {\n  const landmarkMappings: Record<string, string[]> = {\n    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],\n    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    ipd: ['left_pupila', 'right_pupila'],\n    mouthWidth: ['left_cheilion', 'right_cheilion'],\n    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],\n    chinHeight: ['labrale_inferius', 'menton'],\n    gonialAngle: ['tragus', 'gonionBottom', 'menton'],\n  };\n  return landmarkMappings[metricId] || [];\n}\n\nfunction getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {\n  const flawMappings: Record<string, { low: string[]; high: string[] }> = {\n    faceWidthToHeight: {\n      low: ['Narrow face', 'Vertically elongated face'],\n      high: ['Wide face', 'Horizontally expanded face'],\n    },\n    lowerThirdProportion: {\n      low: ['Short lower third', 'Deficient mandible'],\n      high: ['Long lower third', 'Mandibular excess'],\n    },\n    lateralCanthalTilt: {\n      low: ['Negative canthal tilt', 'Drooping eyes'],\n      high: ['Excessive positive canthal tilt'],\n    },\n    nasalIndex: {\n      low: ['Narrow nose', 'Leptorrhine nose'],\n      high: ['Wide nose', 'Platyrrhine nose'],\n    },\n    gonialAngle: {\n      low: ['Steep mandibular plane'],\n      high: ['Flat mandibular plane', 'Weak jaw definition'],\n    },\n  };\n\n  const strengthMappings: Record<string, { ideal: string[] }> = {\n    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },\n    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },\n    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },\n    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },\n  };\n\n  const mapping = flawMappings[result.metricId];\n  const strengthMapping = strengthMappings[result.metricId];\n\n  let mayIndicateFlaws: string[] = [];\n  let mayIndicateStrengths: string[] = [];\n\n  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {\n    mayIndicateStrengths = strengthMapping?.ideal || [];\n  } else if (mapping) {\n    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;\n  }\n\n  return { mayIndicateFlaws, mayIndicateStrengths };\n}\n\n// Metric groupings for creating multi-ratio strengths\nconst STRENGTH_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Proportions\n  lipProportions: {\n    name: 'Well Proportioned Lips',\n    category: 'Lips',\n    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Proportions\n  eyeProportions: {\n    name: 'Harmonious Eye Proportions',\n    category: 'Eyes',\n    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Proportions\n  noseProportions: {\n    name: 'Balanced Nasal Proportions',\n    category: 'Nose',\n    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Definition\n  jawDefinition: {\n    name: 'Well-Defined Jawline',\n    category: 'Jaw Shape',\n    description: 'The jawline displays strong definition with balanced angles and proportionate width.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Proportions\n  chinProportions: {\n    name: 'Balanced Chin Projection',\n    category: 'Chin',\n    description: 'The chin demonstrates ideal projection and proportions relative to the face.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Facial Thirds\n  facialThirds: {\n    name: 'Balanced Facial Thirds',\n    category: 'Face Proportions',\n    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface\n  midfaceBalance: {\n    name: 'Harmonious Midface',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows balanced proportions with well-positioned cheekbones.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n  // Forehead\n  foreheadBalance: {\n    name: 'Well-Proportioned Forehead',\n    category: 'Forehead',\n    description: 'The forehead displays ideal proportions in height and shape.',\n    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],\n  },\n};\n\nfunction generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {\n  const strengths: Strength[] = [];\n  const usedMetricIds = new Set<string>();\n\n  // First pass: Create grouped strengths from related high-scoring metrics\n  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all high-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score >= 7.5 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 8));\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: clampedScore,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: clampedScore,  // Use clamped score\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });\n\n  // Sort by average score (highest first) then by number of contributing ratios\n  return strengths.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.avgScore - a.avgScore;\n  });\n}\n\n// Flaw groupings - similar to strength groupings but for areas of improvement\nconst FLAW_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Issues\n  lipIssues: {\n    name: 'Lip Proportion Concerns',\n    category: 'Lips',\n    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Issues\n  eyeIssues: {\n    name: 'Eye Shape Considerations',\n    category: 'Eyes',\n    description: 'The eye proportions or positioning could benefit from enhancement.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Issues\n  noseIssues: {\n    name: 'Nasal Proportion Concerns',\n    category: 'Nose',\n    description: 'The nasal proportions show deviations that affect facial harmony.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Issues\n  jawIssues: {\n    name: 'Jawline Definition Concerns',\n    category: 'Jaw Shape',\n    description: 'The jawline structure shows areas that could be enhanced for better definition.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Issues\n  chinIssues: {\n    name: 'Chin Projection Concerns',\n    category: 'Chin',\n    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Face Proportion Issues\n  proportionIssues: {\n    name: 'Facial Proportion Imbalance',\n    category: 'Face Proportions',\n    description: 'The vertical face proportions show imbalance between facial thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface Issues\n  midfaceIssues: {\n    name: 'Midface Development Concerns',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows areas that could benefit from enhanced projection or balance.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n};\n\nfunction generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  const flaws: Flaw[] = [];\n  const usedMetricIds = new Set<string>();\n  let rollingLost = 0;\n\n  // First pass: Create grouped flaws from related low-scoring metrics\n  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all low-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score < 6 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped flaw if we have 2+ metrics with low scores\n    if (groupMeasurements.length >= 2) {\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Calculate total impact from all metrics in this group\n      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n      rollingLost += totalImpact;\n\n      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const clampedScore = Math.max(0, Math.min(10, matchingMeasurement?.score || 3));\n    const impact = matchingMeasurement ? (10 - clampedScore) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: clampedScore,  // Use clamped score\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });\n\n  // Sort by impact (highest first) then by number of contributing ratios\n  return flaws.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  });\n}\n\n// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions\n// have been moved to @/lib/results/analysis.ts to reduce bundle size\n// Import generateRecommendations from there instead\n// ============================================\n// CONTEXT CREATION\n// ============================================\n\nconst ResultsContext = createContext<ResultsContextType | null>(null);\n\nexport function useResults(): ResultsContextType {\n  const context = useContext(ResultsContext);\n  if (!context) {\n    throw new Error('useResults must be used within a ResultsProvider');\n  }\n  return context;\n}\n\ninterface ResultsProviderProps {\n  children: ReactNode;\n  initialData?: ResultsInputData;\n}\n\nexport function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  // Raw data state\n  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n\n  // UI state\n  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n\n  // Compute analysis results (now with demographic-specific scoring)\n  const analysisResults = useMemo(() => {\n    if (frontLandmarks.length === 0) {\n      return null;\n    }\n\n    try {\n      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n      const sideAnalysis = sideLandmarks.length > 0\n        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n        : null;\n      // analyzeHarmony expects landmarks directly, not analysis results\n      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n\n      return { frontAnalysis, sideAnalysis, harmony };\n    } catch (error) {\n      console.error('Analysis error:', error);\n      return null;\n    }\n  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n\n  // Transform to Ratio format\n  const frontRatios = useMemo(() => {\n    if (!analysisResults?.frontAnalysis) return [];\n    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  }, [analysisResults, frontLandmarks]);\n\n  const sideRatios = useMemo(() => {\n    if (!analysisResults?.sideAnalysis) return [];\n    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  }, [analysisResults, sideLandmarks]);\n\n  // Generate strengths and flaws using INSIGHTS-BASED classification\n  // This processes insights.json definitions: calculates avg score of affected metrics,\n  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  const { insightStrengths, insightFlaws } = useMemo(() => {\n    if (!analysisResults?.harmony) {\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n\n    try {\n      // Classify using insights engine\n      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n\n      // Convert to UI-compatible types\n      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n      let rollingLost = 0;\n      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n        const flaw = convertToFlaw(w, i, rollingLost);\n        rollingLost = flaw.rollingPointsDeducted || 0;\n        return flaw;\n      });\n\n      return { insightStrengths, insightFlaws };\n    } catch (error) {\n      console.error('[ResultsContext] Error in insights classification:', error);\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n  }, [analysisResults]);\n\n  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  const groupingStrengths = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  const groupingFlaws = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateFlawsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)\n  const strengths = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightStrengths.forEach(s => {\n      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based strengths that don't overlap\n    const nonOverlappingGrouping = groupingStrengths.filter(gs => {\n      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    return [...insightStrengths, ...nonOverlappingGrouping];\n  }, [insightStrengths, groupingStrengths]);\n\n  const flaws = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightFlaws.forEach(f => {\n      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based flaws that don't overlap\n    const nonOverlappingGrouping = groupingFlaws.filter(gf => {\n      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    // Recalculate rolling totals for merged list\n    let rollingLost = 0;\n    const merged = [...insightFlaws, ...nonOverlappingGrouping];\n    return merged.map(f => {\n      rollingLost += f.harmonyPercentageLost;\n      return {\n        ...f,\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      };\n    });\n  }, [insightFlaws, groupingFlaws]);\n\n  // Generate recommendations with metric-aware matching and Bezier recalculation\n  const recommendations = useMemo(() => {\n    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);\n  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);\n\n  // Build full harmony analysis\n  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {\n    if (!analysisResults?.harmony) return null;\n\n    return {\n      standardizedScore: analysisResults.harmony.overallScore,\n      front: {\n        standardizedScore: analysisResults.harmony.frontScore,\n        ratios: frontRatios,\n      },\n      side: {\n        standardizedScore: analysisResults.harmony.sideScore,\n        ratios: sideRatios,\n      },\n      strengths,\n      flaws,\n    };\n  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);\n\n  // Calculate weighted harmony score using looksmax_engine.py algorithm\n  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {\n    if (!analysisResults?.harmony) return null;\n\n    const allMeasurements = analysisResults.harmony.measurements.map(m => ({\n      metricId: m.metricId,\n      standardizedScore: m.standardizedScore,\n    }));\n\n    return calculateHarmonyScore(allMeasurements);\n  }, [analysisResults]);\n\n  // Get top 3 and bottom 3 metrics with advice\n  const topMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getTopMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  const bottomMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getBottomMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  // Scores - now using weighted harmony with explicit clamping to 0-10\n  const rawHarmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;\n  const harmonyPercentage = Math.max(0, Math.min(100, rawHarmonyPercentage));\n\n  const rawOverallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;\n  const overallScore = Math.max(0, Math.min(10, rawOverallScore));\n\n  const rawFrontScore = analysisResults?.harmony?.frontScore || 0;\n  const frontScore = Math.max(0, Math.min(10, rawFrontScore));\n\n  const rawSideScore = analysisResults?.harmony?.sideScore || 0;\n  const sideScore = Math.max(0, Math.min(10, rawSideScore));\n\n  // PSL Rating (1-10 scale with tier/percentile)\n  const pslRating = useMemo(() => {\n    return harmonyToPSL(harmonyPercentage);\n  }, [harmonyPercentage]);\n\n  // Action to set all results data\n  const setResultsData = useCallback((data: ResultsInputData) => {\n    setFrontLandmarks(data.frontLandmarks);\n    setSideLandmarks(data.sideLandmarks);\n    setFrontPhoto(data.frontPhoto);\n    setSidePhoto(data.sidePhoto || null);\n    setGender(data.gender);\n    setEthnicity(data.ethnicity || 'other');\n  }, []);\n\n  // Memoize context value to prevent unnecessary re-renders\n  const value = useMemo<ResultsContextType>(() => ({\n    frontLandmarks,\n    sideLandmarks,\n    gender,\n    ethnicity,\n    frontPhoto,\n    sidePhoto,\n    harmonyAnalysis,\n    frontRatios,\n    sideRatios,\n    strengths,\n    flaws,\n    recommendations,\n    overallScore,\n    frontScore,\n    sideScore,\n    // Weighted harmony from looksmax_engine.py\n    harmonyScoreResult,\n    harmonyPercentage,\n    topMetrics,\n    bottomMetrics,\n    // PSL Rating\n    pslRating,\n    // UI state\n    activeTab,\n    setActiveTab,\n    expandedMeasurementId,\n    setExpandedMeasurementId,\n    selectedVisualizationMetric,\n    setSelectedVisualizationMetric,\n    categoryFilter,\n    setCategoryFilter,\n    showLandmarkOverlay,\n    setShowLandmarkOverlay,\n    setResultsData,\n  }), [\n    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,\n    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,\n    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,\n    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,\n    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,\n    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,\n    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,\n  ]);\n\n  return (\n    <ResultsContext.Provider value={value}>\n      {children}\n    </ResultsContext.Provider>\n  );\n}\n","structuredPatch":[{"oldStart":898,"oldLines":7,"newStart":898,"newLines":8,"lines":[" ","     // Only create a grouped strength if we have 2+ metrics with good scores","     if (groupMeasurements.length >= 2) {","-      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;","+      const rawAvgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;","+      const avgScore = Math.max(0, Math.min(10, rawAvgScore));  // Clamp to 0-10","       const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';"," ","       // Mark these metrics as used"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"c488ee09-a5f7-4e35-bb6f-bb697e2ae47a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TYyHq14LYLQRFJUKkb3MPa","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me also check and fix the `avgScore` clamping in the insights-engine.ts `convertToStrength` function:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1061,"cache_read_input_tokens":104477,"cache_creation":{"ephemeral_5m_input_tokens":1061,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrhJ2zoqDJErMbKW141","type":"assistant","uuid":"aa783bc6-12ee-4d3c-95fc-983f1b1727b7","timestamp":"2025-12-26T06:53:03.988Z"}
{"parentUuid":"aa783bc6-12ee-4d3c-95fc-983f1b1727b7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TYyHq14LYLQRFJUKkb3MPa","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PPMy1xnf4fuCWpgrKn3Ak9","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","offset":2571,"limit":25}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1061,"cache_read_input_tokens":104477,"cache_creation":{"ephemeral_5m_input_tokens":1061,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrhJ2zoqDJErMbKW141","type":"assistant","uuid":"547dc927-919e-42ed-991b-e66f90ec8be5","timestamp":"2025-12-26T06:53:05.137Z"}
{"parentUuid":"547dc927-919e-42ed-991b-e66f90ec8be5","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PPMy1xnf4fuCWpgrKn3Ak9","type":"tool_result","content":"  2571→export function convertToStrength(classified: ClassifiedStrength): Strength {\n  2572→  return {\n  2573→    id: `insight_strength_${classified.insightId}`,\n  2574→    strengthName: `${classified.title} (${classified.gradeLabel})`,\n  2575→    summary: classified.description,\n  2576→    avgScore: classified.avgScore,\n  2577→    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n  2578→                  classified.grade === 'excellent' ? 'excellent' : 'good',\n  2579→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2580→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2581→      ratioName: m.metricName,\n  2582→      ratioId: m.metricId,\n  2583→      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n  2584→      value: m.value,\n  2585→      idealMin: m.idealMin,\n  2586→      idealMax: m.idealMax,\n  2587→      unit: m.unit,\n  2588→      category: m.category,\n  2589→    })),\n  2590→  };\n  2591→}\n  2592→\n  2593→/**\n  2594→ * Convert ClassifiedWeakness to Flaw type for UI compatibility\n  2595→ */\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"88bc3d14-bfc4-4fe0-8e38-cbc50344fc43","timestamp":"2025-12-26T06:53:05.213Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","content":"export function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: classified.avgScore,\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */","numLines":25,"startLine":2571,"totalLines":2643}}}
{"parentUuid":"88bc3d14-bfc4-4fe0-8e38-cbc50344fc43","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01R2pcfCSDuNLkK3Sg5fnp5i","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01L4pwaaGCorhwHdrLbbrTXd","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","old_string":"export function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: classified.avgScore,\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',","new_string":"export function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: Math.max(0, Math.min(10, classified.avgScore)),  // Clamp to 0-10\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":733,"cache_read_input_tokens":105538,"cache_creation":{"ephemeral_5m_input_tokens":733,"ephemeral_1h_input_tokens":0},"output_tokens":373,"service_tier":"standard"}},"requestId":"req_011CWUrhiLjafPfxjs5VGPcB","type":"assistant","uuid":"310ee6bb-9e38-477f-804c-66f398f95f1b","timestamp":"2025-12-26T06:53:12.144Z"}
{"parentUuid":"310ee6bb-9e38-477f-804c-66f398f95f1b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01L4pwaaGCorhwHdrLbbrTXd","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2567→\n  2568→/**\n  2569→ * Convert ClassifiedStrength to Strength type for UI compatibility\n  2570→ */\n  2571→export function convertToStrength(classified: ClassifiedStrength): Strength {\n  2572→  return {\n  2573→    id: `insight_strength_${classified.insightId}`,\n  2574→    strengthName: `${classified.title} (${classified.gradeLabel})`,\n  2575→    summary: classified.description,\n  2576→    avgScore: Math.max(0, Math.min(10, classified.avgScore)),  // Clamp to 0-10\n  2577→    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n  2578→                  classified.grade === 'excellent' ? 'excellent' : 'good',\n  2579→    categoryName: classified.matchedMetrics[0]?.category || 'General',\n  2580→    responsibleRatios: classified.matchedMetrics.map(m => ({\n  2581→      ratioName: m.metricName,\n  2582→      ratioId: m.metricId,"}]},"uuid":"8e69c6ed-6c1d-4a67-a1ae-579bac7e4944","timestamp":"2025-12-26T06:53:12.187Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts","oldString":"export function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: classified.avgScore,\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',","newString":"export function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: Math.max(0, Math.min(10, classified.avgScore)),  // Clamp to 0-10\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',","originalFile":"/**\n * Insights Engine\n *\n * Processes insight definitions from insights.json and classifies them\n * as strengths or areas of improvement based on user's metric scores.\n *\n * Logic:\n * - For each insight definition, calculate average score of affected metrics\n * - Weakness: if avg score < threshold → classify with severity label\n * - Strength: if avg score > threshold → classify with grade label\n *\n * Z-Score Based 5-Tier Severity Logic:\n * - Ideal (Green): User is inside the ideal range\n * - Good (Blue): Within 0.5 Standard Deviation of the mean (|z| < 0.5)\n * - Fair (Cyan): Between 0.5 and 1 Standard Deviation (0.5 ≤ |z| < 1)\n * - Moderate (Yellow): Between 1 and 2 Standard Deviations (1 ≤ |z| < 2)\n * - Severe (Red): More than 2 Standard Deviations away (|z| ≥ 2)\n *\n * Severity Labels (Weaknesses):\n *   0-3 = \"Severe\"\n *   3-5 = \"Moderate\"\n *   5-7 = \"Minor\"\n *\n * Grade Labels (Strengths):\n *   8-9   = \"Good\"\n *   9-9.5 = \"Excellent\"\n *   9.5-10 = \"Ideal\"\n */\n\nimport { Strength, Flaw } from '@/types/results';\nimport { MetricScoreResult, METRIC_CONFIGS, isValueAcceptable } from '@/lib/harmony-scoring';\n\n// ============================================\n// MASTER SCORING DATABASE (Z-Score Based)\n// ============================================\n\nexport type SeverityLevel = 'ideal' | 'good' | 'fair' | 'moderate' | 'severe';\nexport type Gender = 'male' | 'female';\nexport type Ethnicity = 'white' | 'black' | 'east_asian' | 'south_asian' | 'hispanic' | 'middle_eastern' | 'native_american' | 'pacific_islander';\n\nexport interface MasterMetricConfig {\n  ideal: [number, number];  // [min, max] ideal range\n  mean: number;             // Population mean\n  std_dev: number;          // Standard deviation\n  flaws?: {\n    low?: string[];         // Flaws when value is too low\n    high?: string[];        // Flaws when value is too high\n  };\n}\n\n// Base/Default standards (White Male baseline)\nexport const MASTER_SCORING_DB: Record<string, MasterMetricConfig> = {\n  // MIDFACE & PROPORTIONS\n  \"midface_ratio\": {\n    ideal: [0.97, 1.00],\n    mean: 1.0,\n    std_dev: 0.115,\n    flaws: { low: [\"Long midface\", \"Long upper jaw\"] }\n  },\n  \"faceWidthToHeight\": {\n    ideal: [1.30, 1.45],\n    mean: 1.38,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Overly long face\", \"Narrow face\"],\n      high: [\"Wide face\", \"Short face\"]\n    }\n  },\n  \"totalFacialWidthToHeight\": {\n    ideal: [1.25, 1.40],\n    mean: 1.33,\n    std_dev: 0.075,\n    flaws: {\n      low: [\"Long face shape\"],\n      high: [\"Wide face shape\"]\n    }\n  },\n  \"upperThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Long forehead\"]\n    }\n  },\n  \"middleThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short midface\"],\n      high: [\"Long midface\"]\n    }\n  },\n  \"lowerThirdProportion\": {\n    ideal: [0.30, 0.36],\n    mean: 0.33,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Short lower face\"],\n      high: [\"Long lower face\"]\n    }\n  },\n\n  // EYE SPACING & IPD\n  \"eye_separation_ratio\": {\n    ideal: [0.45, 0.47],\n    mean: 0.46,\n    std_dev: 0.03,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"interpupillaryRatio\": {\n    ideal: [0.44, 0.48],\n    mean: 0.46,\n    std_dev: 0.025,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"oneEyeApartTest\": {\n    ideal: [0.95, 1.05],\n    mean: 1.0,\n    std_dev: 0.08,\n    flaws: {\n      low: [\"Close-set eyes\"],\n      high: [\"Wide-set eyes\"]\n    }\n  },\n  \"intercanthalWidth\": {\n    ideal: [30, 35],\n    mean: 32.5,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Narrow eye spacing\"],\n      high: [\"Wide eye spacing\"]\n    }\n  },\n\n  // EYE SHAPE & FEATURES\n  \"lateralCanthalTilt\": {\n    ideal: [6, 8],\n    mean: 5.0,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Negative canthal tilt\", \"Downturned eyes\"],\n      high: [\"Excessively upturned eyes\"]\n    }\n  },\n  \"eyeAspectRatio\": {\n    ideal: [0.30, 0.35],\n    mean: 0.32,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Round eyes\"]\n    }\n  },\n  \"palpebralFissureLength\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.5,\n    flaws: {\n      low: [\"Small eyes\"],\n      high: [\"Large eyes\"]\n    }\n  },\n  \"eyeWidth\": {\n    ideal: [28, 32],\n    mean: 30.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Narrow eyes\"],\n      high: [\"Wide eyes\"]\n    }\n  },\n  \"upperEyelidExposure\": {\n    ideal: [0.5, 1.2],\n    mean: 0.85,\n    std_dev: 0.35,\n    flaws: {\n      low: [\"Hooded eyes\"],\n      high: [\"Excessive upper lid exposure\"]\n    }\n  },\n  \"tearTroughDepth\": {\n    ideal: [0.0, 0.3],\n    mean: 0.15,\n    std_dev: 0.15,\n    flaws: {\n      high: [\"Dark circles / Tear troughs\", \"Under-eye hollowness\"]\n    }\n  },\n\n  // JAW ANGLES & STRUCTURE\n  \"gonial_angle\": {\n    ideal: [115, 125],\n    mean: 118.0,\n    std_dev: 6.5,\n    flaws: {\n      high: [\"Weak/soft jaw structure\", \"Rounded jaw\"]\n    }\n  },\n  \"mandibularPlaneAngle\": {\n    ideal: [20, 28],\n    mean: 24.0,\n    std_dev: 4.0,\n    flaws: {\n      low: [\"Flat mandibular plane\"],\n      high: [\"Steep mandibular plane\", \"Hyper-divergent jaw\"]\n    }\n  },\n  \"jawFrontalAngle\": {\n    ideal: [125, 135],\n    mean: 130.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Steep jaw\"],\n      high: [\"Flat jaw angle\"]\n    }\n  },\n  \"jawSlope\": {\n    ideal: [25, 35],\n    mean: 30.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat jawline\"],\n      high: [\"Steep jawline\"]\n    }\n  },\n\n  // JAW WIDTH\n  \"jawWidthRatio\": {\n    ideal: [0.85, 0.95],\n    mean: 0.90,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Narrow jaw\"],\n      high: [\"Wide jaw\"]\n    }\n  },\n  \"bigonialWidth\": {\n    ideal: [110, 125],\n    mean: 117.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow jaw width\"],\n      high: [\"Excessively wide jaw\"]\n    }\n  },\n\n  // CHEEKBONES\n  \"cheekbone_height\": {\n    ideal: [83.0, 100.0],\n    mean: 85.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Low-set cheekbones\", \"Flat midface\"]\n    }\n  },\n  \"cheekboneWidth\": {\n    ideal: [130, 145],\n    mean: 137.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow cheekbones\"],\n      high: [\"Wide cheekbones\"]\n    }\n  },\n\n  // CHIN\n  \"chinPhiltrumRatio\": {\n    ideal: [1.8, 2.2],\n    mean: 2.0,\n    std_dev: 0.2,\n    flaws: {\n      low: [\"Recessed chin\", \"Short chin\"],\n      high: [\"Long chin\", \"Projected chin\"]\n    }\n  },\n  \"chinHeight\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short chin\"],\n      high: [\"Long chin\"]\n    }\n  },\n  \"chinWidth\": {\n    ideal: [35, 45],\n    mean: 40.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Pointed/Narrow chin\"],\n      high: [\"Wide chin\"]\n    }\n  },\n\n  // NOSE ANGLES\n  \"nasalTipAngle\": {\n    ideal: [95, 115],\n    mean: 105.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nasal tip\"]\n    }\n  },\n  \"nasolabialAngle\": {\n    ideal: [95, 110],\n    mean: 102.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Droopy nasal tip\"],\n      high: [\"Upturned nose\"]\n    }\n  },\n  \"nasofrontalAngle\": {\n    ideal: [115, 135],\n    mean: 125.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Deep nasal root\"],\n      high: [\"Flat nasal root\"]\n    }\n  },\n  \"nasofacialAngle\": {\n    ideal: [30, 40],\n    mean: 35.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat nose profile\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"nasomentaAngle\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // NOSE WIDTH & PROPORTIONS\n  \"nasalIndex\": {\n    ideal: [65, 75],\n    mean: 70.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nose\", \"Bulbous nose\"]\n    }\n  },\n  \"noseWidth\": {\n    ideal: [35, 42],\n    mean: 38.5,\n    std_dev: 3.5,\n    flaws: {\n      low: [\"Narrow nose\"],\n      high: [\"Wide nasal base\"]\n    }\n  },\n  \"noseBridgeWidth\": {\n    ideal: [12, 18],\n    mean: 15.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Narrow nose bridge\"],\n      high: [\"Wide nose bridge\"]\n    }\n  },\n  \"nasalProjection\": {\n    ideal: [16, 22],\n    mean: 19.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Underprojected nose\"],\n      high: [\"Overprojected nose\"]\n    }\n  },\n  \"noseLengthRatio\": {\n    ideal: [0.45, 0.55],\n    mean: 0.50,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short nose\"],\n      high: [\"Long nose\"]\n    }\n  },\n\n  // LIPS & PHILTRUM\n  \"lipRatio\": {\n    ideal: [1.4, 1.6],\n    mean: 1.5,\n    std_dev: 0.15,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"philtrumLength\": {\n    ideal: [11, 15],\n    mean: 13.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Short philtrum\"],\n      high: [\"Long philtrum\"]\n    }\n  },\n  \"upperLipHeight\": {\n    ideal: [18, 24],\n    mean: 21.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Thin upper lip\"],\n      high: [\"Thick upper lip\"]\n    }\n  },\n  \"lipChinDistance\": {\n    ideal: [40, 50],\n    mean: 45.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Short lower third\"],\n      high: [\"Long lower third\"]\n    }\n  },\n  \"upperLipProjection\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed upper lip\"],\n      high: [\"Protruding upper lip\"]\n    }\n  },\n  \"lowerLipProjection\": {\n    ideal: [-1, 3],\n    mean: 1.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Recessed lower lip\"],\n      high: [\"Protruding lower lip\"]\n    }\n  },\n  \"cupidsBowDepth\": {\n    ideal: [3, 6],\n    mean: 4.5,\n    std_dev: 1.5,\n    flaws: {\n      low: [\"Flat cupid's bow\"],\n      high: [\"Pronounced cupid's bow\"]\n    }\n  },\n\n  // EYEBROWS\n  \"eyebrowHeight\": {\n    ideal: [8, 14],\n    mean: 11.0,\n    std_dev: 3.0,\n    flaws: {\n      low: [\"Low-set eyebrows\"],\n      high: [\"High eyebrows\"]\n    }\n  },\n  \"browLengthRatio\": {\n    ideal: [0.50, 0.60],\n    mean: 0.55,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browLengthToFaceWidth\": {\n    ideal: [0.30, 0.38],\n    mean: 0.34,\n    std_dev: 0.04,\n    flaws: {\n      low: [\"Short eyebrows\"],\n      high: [\"Long eyebrows\"]\n    }\n  },\n  \"browridgeInclinationAngle\": {\n    ideal: [10, 20],\n    mean: 15.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Flat brow ridge\"],\n      high: [\"Prominent brow ridge\"]\n    }\n  },\n  \"eyebrowThickness\": {\n    ideal: [1.5, 3.0],\n    mean: 2.25,\n    std_dev: 0.75,\n    flaws: {\n      low: [\"Sparse/Weak eyebrows\"],\n      high: [\"Overly thick eyebrows\"]\n    }\n  },\n\n  // FOREHEAD\n  \"foreheadHeight\": {\n    ideal: [55, 70],\n    mean: 62.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Short forehead\"],\n      high: [\"Tall forehead\"]\n    }\n  },\n  \"bitemporalWidth\": {\n    ideal: [120, 135],\n    mean: 127.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Narrow forehead\"],\n      high: [\"Wide forehead\"]\n    }\n  },\n\n  // PROFILE & DEPTH\n  \"facialDepthToHeight\": {\n    ideal: [0.75, 0.85],\n    mean: 0.80,\n    std_dev: 0.05,\n    flaws: {\n      low: [\"Flat facial profile\"],\n      high: [\"Overprojected profile\"]\n    }\n  },\n  \"anteriorFacialDepth\": {\n    ideal: [115, 130],\n    mean: 122.5,\n    std_dev: 7.5,\n    flaws: {\n      low: [\"Shallow face depth\"],\n      high: [\"Deep face projection\"]\n    }\n  },\n  \"totalProfileAngle\": {\n    ideal: [165, 175],\n    mean: 170.0,\n    std_dev: 5.0,\n    flaws: {\n      low: [\"Convex profile\"],\n      high: [\"Concave profile\"]\n    }\n  },\n\n  // ASYMMETRY\n  \"facialAsymmetryIndex\": {\n    ideal: [0, 3],\n    mean: 2.0,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Facial asymmetry\"]\n    }\n  },\n  \"eyeAsymmetry\": {\n    ideal: [0, 2],\n    mean: 1.0,\n    std_dev: 1.0,\n    flaws: {\n      high: [\"Eye asymmetry\"]\n    }\n  },\n  \"jawAsymmetry\": {\n    ideal: [0, 3],\n    mean: 1.5,\n    std_dev: 1.5,\n    flaws: {\n      high: [\"Jaw asymmetry\"]\n    }\n  },\n\n  // OTHER\n  \"recessionFrankfort\": {\n    ideal: [-2, 2],\n    mean: 0.0,\n    std_dev: 2.0,\n    flaws: {\n      low: [\"Maxillary recession\"],\n      high: [\"Maxillary protrusion\"]\n    }\n  },\n  \"neckWidth\": {\n    ideal: [110, 130],\n    mean: 120.0,\n    std_dev: 10.0,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Wide neck\"]\n    }\n  },\n  \"neckToJawRatio\": {\n    ideal: [0.90, 1.10],\n    mean: 1.0,\n    std_dev: 0.10,\n    flaws: {\n      low: [\"Narrow neck\"],\n      high: [\"Thick neck\"]\n    }\n  }\n};\n\n// ============================================\n// ETHNICITY-SPECIFIC OVERRIDES\n// ============================================\n\n/**\n * Ethnicity and gender-specific metric standards\n * These override the base MASTER_SCORING_DB values for specific populations\n */\nexport const ETHNICITY_OVERRIDES: Record<string, Record<string, Partial<MasterMetricConfig>>> = {\n  // ========================================\n  // MALE WHITE STANDARDS (Neoclassical Baseline)\n  // ========================================\n  \"male_white\": {\n    // NOSE WIDTH - Strict 1:1 ratio (Eye Width = Nose Width)\n    \"noseWidth\": {\n      ideal: [35, 42],  // Corresponds to alar_base_ratio [0.98, 1.05]\n      mean: 38.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // MIDFACE - Prefers compact midface (Hunter look)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    },\n\n    // JAW - Square/Robust jaw preference\n    \"gonial_angle\": {\n      ideal: [115.0, 125.0],\n      mean: 120.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/Soft jaw structure\"]\n      }\n    },\n\n    // FACE WIDTH - Standard Mesoprosopic range\n    \"faceWidthToHeight\": {\n      ideal: [1.90, 2.05],\n      mean: 1.975,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Short/Wide face\"]\n      }\n    },\n\n    // EYE TILT - Neutral to slightly positive\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 8.0],\n      mean: 6.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Negative canthal tilt\"]\n      }\n    },\n\n    // LOWER FACE BALANCE\n    \"chinPhiltrumRatio\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Long philtrum / Short chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE BLACK / AFRICAN STANDARDS\n  // ========================================\n  \"male_black\": {\n    // NOSE WIDTH - Significantly wider tolerance\n    \"noseWidth\": {\n      ideal: [40, 50],  // Wider range (corresponds to alar_base_ratio [1.12, 1.25])\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n    \"nasalIndex\": {\n      ideal: [80, 95],  // Wider nasal index\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n\n    // LIPS - Prefers fuller lips\n    \"lipRatio\": {\n      ideal: [1.2, 1.5],\n      mean: 1.35,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    },\n\n    // PHILTRUM - Shorter visible philtrum is ideal\n    \"philtrumLength\": {\n      ideal: [11.0, 14.0],\n      mean: 12.5,\n      std_dev: 1.5,\n      flaws: {\n        high: [\"Long philtrum\"]\n      }\n    },\n\n    // CHIN - Adjusts for natural forward mouth projection (Prognathism)\n    \"chinPhiltrumRatio\": {\n      ideal: [1.80, 2.10],  // Lower range to account for prognathism\n      mean: 1.95,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Recessed chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE EAST ASIAN STANDARDS\n  // ========================================\n  \"male_east_asian\": {\n    // EYE SPACING - Shifted WIDER for East Asian males\n    \"eye_separation_ratio\": {\n      ideal: [0.48, 0.53],  // Shifted wider (0.46 is \"close-set\" here)\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n    \"interpupillaryRatio\": {\n      ideal: [0.48, 0.53],\n      mean: 0.505,\n      std_dev: 0.025,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Wide-set eyes\"]\n      }\n    },\n\n    // EYE SHAPE - Prefers narrower/longer eyes (Hunter Eyes)\n    \"eyeAspectRatio\": {\n      ideal: [0.25, 0.29],  // Lower ratio = more elongated\n      mean: 0.27,\n      std_dev: 0.02,\n      flaws: {\n        low: [\"Overly narrow eyes\"],\n        high: [\"Overly round eye shape\"]\n      }\n    },\n    \"palpebralFissureLength\": {\n      ideal: [29, 33],\n      mean: 31.0,\n      std_dev: 2.0,\n      flaws: {\n        low: [\"Small eyes\"],\n        high: [\"Large eyes\"]\n      }\n    },\n\n    // NOSE - Asian noses typically allowed to be wider\n    \"nasalIndex\": {\n      ideal: [75, 85],\n      mean: 80.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nose\"]\n      }\n    },\n    \"noseWidth\": {\n      ideal: [38, 45],\n      mean: 41.5,\n      std_dev: 3.5,\n      flaws: {\n        low: [\"Narrow nose\"],\n        high: [\"Very wide nasal base\"]\n      }\n    },\n    \"noseBridgeWidth\": {\n      ideal: [14, 20],\n      mean: 17.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Narrow nose bridge\"],\n        high: [\"Wide nose bridge\"]\n      }\n    },\n\n    // CHEEKS - Rewards slightly fuller cheeks (Youth/K-Pop aesthetic)\n    \"cheekbone_height\": {\n      ideal: [80.0, 95.0],\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Hollow face\"]\n      }\n    },\n\n    // JAW - Slightly softer angles acceptable\n    \"gonial_angle\": {\n      ideal: [118, 128],\n      mean: 123.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Weak/soft jaw structure\"]\n      }\n    },\n    \"mandibularPlaneAngle\": {\n      ideal: [20, 30],\n      mean: 25.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Flat mandibular plane\"],\n        high: [\"Steep mandibular plane\"]\n      }\n    },\n\n    // FACIAL PROPORTIONS - Wider faces more common\n    \"faceWidthToHeight\": {\n      ideal: [1.35, 1.50],\n      mean: 1.425,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n    \"totalFacialWidthToHeight\": {\n      ideal: [1.30, 1.45],\n      mean: 1.375,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long face shape\"],\n        high: [\"Wide face shape\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE SOUTH ASIAN STANDARDS\n  // ========================================\n  \"male_south_asian\": {\n    // NOSE WIDTH - Slightly wider tolerance than White\n    \"noseWidth\": {\n      ideal: [36, 43],  // alar_base_ratio [1.00, 1.08]\n      mean: 39.5,\n      std_dev: 3.5,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // TEAR TROUGH - VERY STRICT. High penalty for dark circles\n    \"tearTroughDepth\": {\n      ideal: [0.0, 0.5],\n      mean: 0.25,\n      std_dev: 0.25,\n      flaws: {\n        high: [\"Dark circles / Tear troughs\"]\n      }\n    },\n\n    // UPPER EYELID - Often prefers visible lid platform\n    \"upperEyelidExposure\": {\n      ideal: [0.5, 2.0],\n      mean: 1.25,\n      std_dev: 0.75,\n      flaws: {\n        low: [\"Hooded eyes\"]\n      }\n    },\n\n    // CHEEKS - Penalizes \"Gaunt\" looks heavily\n    \"cheekbone_height\": {\n      ideal: [83.0, 95.0],\n      mean: 89.0,\n      std_dev: 6.0,\n      flaws: {\n        low: [\"Volume loss / Gauntness\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE HISPANIC STANDARDS (\"The Bridge Model\")\n  // ========================================\n  \"male_hispanic\": {\n    // FACE WIDTH - Rewards broader, more robust face shapes (Mestizo)\n    \"faceWidthToHeight\": {\n      ideal: [1.95, 2.10],\n      mean: 2.025,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Long/Narrow face\"]\n      }\n    },\n\n    // NOSE WIDTH - Bridge tolerance (Wider than White, narrower than Black)\n    \"noseWidth\": {\n      ideal: [36, 44],  // alar_base_ratio [1.00, 1.12]\n      mean: 40.0,\n      std_dev: 4.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for positive tilt\n    \"lateralCanthalTilt\": {\n      ideal: [6.0, 12.0],\n      mean: 9.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Negative/Neutral canthal tilt\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE MIDDLE EASTERN STANDARDS\n  // ========================================\n  \"male_middle_eastern\": {\n    // EYEBROW THICKNESS - Prefers significantly thicker/darker brows\n    \"eyebrowThickness\": {\n      ideal: [2.0, 4.0],\n      mean: 3.0,\n      std_dev: 1.0,\n      flaws: {\n        low: [\"Sparse/Weak eyebrows\"],\n        high: [\"Unibrow\"]\n      }\n    },\n\n    // NASOLABIAL ANGLE - Penalizes droopy tip (<90) or hooked noses\n    \"nasolabialAngle\": {\n      ideal: [90.0, 100.0],\n      mean: 95.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Droopy nose tip / Hooked nose\"]\n      }\n    },\n\n    // EYE TILT - Strong preference for Almond/Hunter eye shape\n    \"lateralCanthalTilt\": {\n      ideal: [4.0, 10.0],\n      mean: 7.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    },\n\n    // MIDFACE - Similar to White model (Compact is better)\n    \"midface_ratio\": {\n      ideal: [0.95, 1.02],\n      mean: 0.985,\n      std_dev: 0.035,\n      flaws: {\n        low: [\"Long midface\"]\n      }\n    }\n  },\n\n  // ========================================\n  // MALE PACIFIC ISLANDER STANDARDS (\"The Warrior Skull\")\n  // ========================================\n  \"male_pacific_islander\": {\n    // FACE WIDTH - The Highest Width Standard (Very broad)\n    \"faceWidthToHeight\": {\n      ideal: [2.10, 2.30],\n      mean: 2.20,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Narrow/Long face\"]\n      }\n    },\n\n    // NOSE WIDTH - Wide tolerance\n    \"noseWidth\": {\n      ideal: [38, 48],  // alar_base_ratio [1.05, 1.20]\n      mean: 43.0,\n      std_dev: 5.0,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // CHEEKS - Rewards high mass/robustness\n    \"cheekbone_height\": {\n      ideal: [85.0, 100.0],\n      mean: 92.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Gaunt/Weak face structure\"]\n      }\n    },\n\n    // CHIN WIDTH - Prefers a very broad, square chin\n    \"chinWidth\": {\n      ideal: [40.0, 50.0],\n      mean: 45.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Pointed/Narrow chin\"]\n      }\n    }\n  },\n\n  \"male_native_american\": {\n    \"faceWidthToHeight\": {\n      ideal: [2.00, 2.20],\n      mean: 2.10,\n      std_dev: 0.10,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Wide face\"]\n      }\n    },\n\n    \"nasalIndex\": {\n      ideal: [75, 90],\n      mean: 82.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Narrow nose\"],\n        high: [\"Wide nose\"]\n      }\n    },\n\n    \"cheekbone_height\": {\n      ideal: [80.0, 95.0],\n      mean: 87.5,\n      std_dev: 7.5,\n      flaws: {\n        low: [\"Flat cheekbones\"]\n      }\n    },\n\n    \"gonialAngle\": {\n      ideal: [115, 125],\n      mean: 120,\n      std_dev: 5,\n      flaws: {\n        low: [\"Weak jaw\"],\n        high: [\"Harsh jaw angle\"]\n      }\n    },\n\n    \"chinWidth\": {\n      ideal: [38.0, 48.0],\n      mean: 43.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Narrow chin\"]\n      }\n    }\n  },\n\n  // ========================================\n  // FEMALE ETHNICITIES (The \"Missing Link\")\n  // ========================================\n\n  \"female_white\": {\n    // NOSE WIDTH - Strict Rule of Fifths for feminine harmony\n    \"alar_base_ratio\": {\n      ideal: [0.98, 1.05],\n      mean: 1.015,\n      std_dev: 0.035,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // FACE WIDTH - Prefers oval/narrow feminine proportions\n    \"fwhr\": {\n      ideal: [1.45, 1.53],\n      mean: 1.49,\n      std_dev: 0.04,\n      flaws: {\n        low: [\"Long/Narrow face\"],\n        high: [\"Wide face\"]\n      }\n    },\n\n    // JAW - Soft, tapered feminine jawline\n    \"gonial_angle\": {\n      ideal: [122.0, 130.0],\n      mean: 126.0,\n      std_dev: 4.0,\n      flaws: {\n        low: [\"Sharp/Masculine jaw angle\"],\n        high: [\"Weak/Overly soft jawline\"]\n      }\n    },\n\n    // EYE TILT - Neutral to positive preferred\n    \"canthal_tilt\": {\n      ideal: [4.0, 9.0],\n      mean: 6.5,\n      std_dev: 2.5,\n      flaws: {\n        low: [\"Negative/Downturned eyes\"]\n      }\n    },\n\n    // CHIN-PHILTRUM - Golden Ratio balance\n    \"chin_philtrum_ratio\": {\n      ideal: [2.0, 2.2],\n      mean: 2.1,\n      std_dev: 0.1,\n      flaws: {\n        low: [\"Recessed chin\"],\n        high: [\"Protruding chin\"]\n      }\n    }\n  },\n\n  \"female_black\": {\n    // LIPS - High volume preference (fuller lips)\n    \"lipRatio\": {\n      ideal: [1.3, 1.6],\n      mean: 1.45,\n      std_dev: 0.15,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    },\n\n    // NOSE WIDTH - Wider tolerance for ethnic variation\n    \"alar_base_ratio\": {\n      ideal: [1.05, 1.15],\n      mean: 1.10,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Very wide nasal base\"]\n      }\n    },\n\n    // CHIN - Allows forward projection (natural prognathism)\n    \"chin_projection\": {\n      ideal: [0.0, 5.0],\n      mean: 2.5,\n      std_dev: 2.5,\n      flaws: {\n        high: [\"Excessive chin projection\"]\n      }\n    },\n\n    // JAW - Soft feminine jawline\n    \"gonial_angle\": {\n      ideal: [120.0, 130.0],\n      mean: 125.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Sharp jaw angle\"],\n        high: [\"Weak jawline\"]\n      }\n    }\n  },\n\n  \"female_east_asian\": {\n    // EYE SPACING - Wide-set neotenous preference\n    \"eye_separation_ratio\": {\n      ideal: [46.3, 47.5],\n      mean: 46.9,\n      std_dev: 0.6,\n      flaws: {\n        low: [\"Close-set eyes\"],\n        high: [\"Very wide-set eyes\"]\n      }\n    },\n\n    // JAW - Tapered V-shape feminine ideal\n    \"gonial_angle\": {\n      ideal: [120.0, 126.0],\n      mean: 123.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Sharp V-line jaw\"],\n        high: [\"Weak/Square jawline\"]\n      }\n    },\n\n    // EYEBROWS - Higher set brows (youthful feminine)\n    \"eyebrow_height\": {\n      ideal: [0.85, 1.30],\n      mean: 1.075,\n      std_dev: 0.225,\n      flaws: {\n        low: [\"Low-set/Heavy brows\"],\n        high: [\"Very high-arched brows\"]\n      }\n    },\n\n    // LOWER FACE - Compact lower third (neotenous)\n    \"lower_third_ratio\": {\n      ideal: [29.6, 32.7],\n      mean: 31.15,\n      std_dev: 1.55,\n      flaws: {\n        low: [\"Very short lower face\"],\n        high: [\"Long lower face\"]\n      }\n    }\n  },\n\n  \"female_south_asian\": {\n    // TEAR TROUGHS - Very strict on dark circles\n    \"tear_trough_depth\": {\n      ideal: [0.0, 0.5],\n      mean: 0.25,\n      std_dev: 0.25,\n      flaws: {\n        high: [\"Dark circles / Deep tear troughs\"]\n      }\n    },\n\n    // CHEEKS - Rewards midface volume (youthful fullness)\n    \"cheek_fullness\": {\n      ideal: [1.0, 2.0],\n      mean: 1.5,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Gaunt/Hollow cheeks\"]\n      }\n    },\n\n    // SKIN - High penalty for uneven skin tone\n    \"skin_uniformity\": {\n      ideal: [0.92, 1.0],\n      mean: 0.96,\n      std_dev: 0.04,\n      flaws: {\n        low: [\"Uneven skin tone / Pigmentation\"]\n      }\n    },\n\n    // NOSE WIDTH - Intermediate tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.00, 1.08],\n      mean: 1.04,\n      std_dev: 0.04,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    }\n  },\n\n  \"female_hispanic\": {\n    // FACE WIDTH - Broader Mestiza tolerance\n    \"fwhr\": {\n      ideal: [1.50, 1.62],\n      mean: 1.56,\n      std_dev: 0.06,\n      flaws: {\n        low: [\"Long/Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // EYE TILT - Strong almond eye preference\n    \"canthal_tilt\": {\n      ideal: [6.0, 12.0],\n      mean: 9.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Neutral/Downturned eyes\"]\n      }\n    },\n\n    // NOSE WIDTH - Intermediate width tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.00, 1.10],\n      mean: 1.05,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Wide nasal base\"]\n      }\n    },\n\n    // LIPS - Voluptuous preference\n    \"lipRatio\": {\n      ideal: [1.1, 1.35],\n      mean: 1.225,\n      std_dev: 0.125,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    }\n  },\n\n  \"female_middle_eastern\": {\n    // EYEBROWS - Dense/Thick brows preference\n    \"eyebrow_thickness\": {\n      ideal: [1.5, 3.0],\n      mean: 2.25,\n      std_dev: 0.75,\n      flaws: {\n        low: [\"Sparse/Thin eyebrows\"],\n        high: [\"Unibrow\"]\n      }\n    },\n\n    // NOSE - Refined/Upturned tip\n    \"nasolabial_angle\": {\n      ideal: [95.0, 105.0],\n      mean: 100.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Droopy nose tip\"],\n        high: [\"Overly upturned nose\"]\n      }\n    },\n\n    // EYE TILT - Foxy/Hunter feminine eye shape\n    \"canthal_tilt\": {\n      ideal: [5.0, 10.0],\n      mean: 7.5,\n      std_dev: 2.5,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    },\n\n    // EYELID - Low exposure preferred\n    \"upper_eyelid_exposure\": {\n      ideal: [0.5, 1.5],\n      mean: 1.0,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Hooded eyes\"],\n        high: [\"Excessive eyelid exposure\"]\n      }\n    }\n  },\n\n  \"female_native_american\": {\n    // FACE WIDTH - Wide/High cheekbone structure\n    \"fwhr\": {\n      ideal: [1.52, 1.65],\n      mean: 1.585,\n      std_dev: 0.065,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // CHEEKBONES - High definition/prominence\n    \"cheekbone_prominence\": {\n      ideal: [1.5, 2.5],\n      mean: 2.0,\n      std_dev: 0.5,\n      flaws: {\n        low: [\"Flat cheekbones\"],\n        high: [\"Overly prominent cheekbones\"]\n      }\n    },\n\n    // JAW - Stronger jaw tolerance\n    \"gonial_angle\": {\n      ideal: [115.0, 125.0],\n      mean: 120.0,\n      std_dev: 5.0,\n      flaws: {\n        low: [\"Very sharp jaw\"],\n        high: [\"Weak jawline\"]\n      }\n    },\n\n    // EYE TILT - Positive tilt preference\n    \"canthal_tilt\": {\n      ideal: [5.0, 11.0],\n      mean: 8.0,\n      std_dev: 3.0,\n      flaws: {\n        low: [\"Downturned eyes\"]\n      }\n    }\n  },\n\n  \"female_pacific_islander\": {\n    // FACE WIDTH - Widest/Robust facial structure\n    \"fwhr\": {\n      ideal: [1.55, 1.70],\n      mean: 1.625,\n      std_dev: 0.075,\n      flaws: {\n        low: [\"Narrow face\"],\n        high: [\"Very wide face\"]\n      }\n    },\n\n    // CHEEKS - High volume/softness preference\n    \"cheek_fullness\": {\n      ideal: [1.2, 2.5],\n      mean: 1.85,\n      std_dev: 0.65,\n      flaws: {\n        low: [\"Gaunt/Hollow cheeks\"]\n      }\n    },\n\n    // NOSE WIDTH - Wide nose tolerance\n    \"alar_base_ratio\": {\n      ideal: [1.05, 1.15],\n      mean: 1.10,\n      std_dev: 0.05,\n      flaws: {\n        high: [\"Very wide nasal base\"]\n      }\n    },\n\n    // LIPS - Full lips preference\n    \"lipRatio\": {\n      ideal: [1.25, 1.50],\n      mean: 1.375,\n      std_dev: 0.125,\n      flaws: {\n        low: [\"Thin lips\"]\n      }\n    }\n  }\n};\n\n/**\n * Get the appropriate metric configuration for a given gender and ethnicity\n * Falls back to base config if no override exists\n */\nexport function getMetricConfig(\n  metricId: string,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): MasterMetricConfig | undefined {\n  const key = `${gender}_${ethnicity}`;\n  const override = ETHNICITY_OVERRIDES[key]?.[metricId];\n  const baseConfig = MASTER_SCORING_DB[metricId];\n\n  if (!baseConfig) return undefined;\n\n  // Merge override with base config\n  if (override) {\n    return {\n      ...baseConfig,\n      ...override,\n      flaws: {\n        ...baseConfig.flaws,\n        ...override.flaws\n      }\n    } as MasterMetricConfig;\n  }\n\n  return baseConfig;\n}\n\n// ============================================\n// Z-SCORE SEVERITY FUNCTIONS\n// ============================================\n\n/**\n * Calculate Z-score for a given value\n * Z = (value - mean) / std_dev\n */\nexport function calculateZScore(value: number, mean: number, stdDev: number): number {\n  if (stdDev === 0) return 0;\n  return Math.abs((value - mean) / stdDev);\n}\n\n/**\n * Determine severity level based on Z-score and ideal range (5-tier system)\n * - Ideal: Value is within ideal range\n * - Good: |z| < 0.5 (within 0.5 standard deviation)\n * - Fair: 0.5 ≤ |z| < 1 (between 0.5-1 standard deviations)\n * - Moderate: 1 ≤ |z| < 2 (between 1-2 standard deviations)\n * - Severe: |z| ≥ 2 (more than 2 standard deviations away)\n */\nexport function getSeverityFromZScore(\n  value: number,\n  config: MasterMetricConfig\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean } {\n  const { ideal, mean, std_dev } = config;\n  const isInIdeal = value >= ideal[0] && value <= ideal[1];\n  const zScore = calculateZScore(value, mean, std_dev);\n\n  let severity: SeverityLevel;\n  if (isInIdeal) {\n    severity = 'ideal';\n  } else if (zScore < 0.5) {\n    severity = 'good';\n  } else if (zScore < 1) {\n    severity = 'fair';\n  } else if (zScore < 2) {\n    severity = 'moderate';\n  } else {\n    severity = 'severe';\n  }\n\n  return { severity, zScore, isInIdeal };\n}\n\n/**\n * Get severity for a metric value with ethnicity/gender awareness\n */\nexport function getSeverityForMetric(\n  metricId: string,\n  value: number,\n  gender: Gender = 'male',\n  ethnicity: Ethnicity = 'white'\n): { severity: SeverityLevel; zScore: number; isInIdeal: boolean; config: MasterMetricConfig } | null {\n  const config = getMetricConfig(metricId, gender, ethnicity);\n  if (!config) return null;\n\n  const result = getSeverityFromZScore(value, config);\n  return { ...result, config };\n}\n\n/**\n * Get badge color for severity level (5-tier)\n */\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'green';\n    case 'good': return 'blue';\n    case 'fair': return 'cyan';\n    case 'moderate': return 'yellow';\n    case 'severe': return 'red';\n    default: return 'gray';\n  }\n}\n\n/**\n * Get severity label for display (5-tier)\n */\nexport function getSeverityLabel(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'ideal': return 'Ideal';\n    case 'good': return 'Good';\n    case 'fair': return 'Fair';\n    case 'moderate': return 'Moderate';\n    case 'severe': return 'Severe';\n    default: return 'Unknown';\n  }\n}\n\n// ============================================\n// INSIGHT DEFINITION TYPES\n// ============================================\n\nexport interface InsightSeverityLogic {\n  metrics: string[];  // Display names of metrics (e.g., \"Face Width to Height Ratio\")\n  threshold: number;  // Score threshold for classification\n}\n\nexport interface WeaknessSeverityLabels {\n  minor: string;\n  moderate: string;\n  severe: string;\n}\n\nexport interface StrengthGradeLabels {\n  good: string;\n  excellent: string;\n  ideal: string;\n}\n\nexport interface InsightContent {\n  description: string;\n  severity_labels?: WeaknessSeverityLabels;  // For weaknesses\n  grade_labels?: StrengthGradeLabels;        // For strengths\n}\n\nexport interface InsightDefinition {\n  id: string;\n  title: string;\n  type: 'weakness' | 'strength';\n  severity_logic: InsightSeverityLogic;\n  content: InsightContent;\n}\n\n// ============================================\n// CLASSIFICATION RESULT TYPES\n// ============================================\n\nexport type WeaknessSeverity = 'severe' | 'moderate' | 'minor';\nexport type StrengthGrade = 'ideal' | 'excellent' | 'good';\n\nexport interface ClassifiedWeakness {\n  insightId: string;\n  title: string;\n  description: string;\n  severity: WeaknessSeverity;\n  severityLabel: string;  // Custom label from definition (e.g., \"Extremely Long\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface ClassifiedStrength {\n  insightId: string;\n  title: string;\n  description: string;\n  grade: StrengthGrade;\n  gradeLabel: string;  // Custom label from definition (e.g., \"Ideal\")\n  avgScore: number;\n  matchedMetrics: MatchedMetric[];\n}\n\nexport interface MatchedMetric {\n  metricId: string;\n  metricName: string;\n  score: number;\n  value: number;\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category: string;\n}\n\nexport interface InsightClassificationResult {\n  strengths: ClassifiedStrength[];\n  weaknesses: ClassifiedWeakness[];\n}\n\n// ============================================\n// INSIGHTS DATABASE\n// ============================================\n\nexport const INSIGHTS_DEFINITIONS: InsightDefinition[] = [\n  {\n    id: \"long_midface\",\n    title: \"Long Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\", \"Ipsilateral Alar Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The middle of the face is elongated, creating an unbalanced vertical proportion.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Extremely Long\" }\n    }\n  },\n  {\n    id: \"short_midface\",\n    title: \"Short Midface\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Face Width to Height Ratio\", \"Midface Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The midface has ideal vertical proportions, contributing to facial harmony.\",\n      grade_labels: { good: \"Proportionate\", excellent: \"Well-Balanced\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"weak_jaw\",\n    title: \"Weak/Soft Jaw Structure\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Chin to Philtrum Ratio\", \"Jaw Slope\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw has a softer, rounder shape, often less angular and robust than the ideal.\",\n      severity_labels: { minor: \"Soft\", moderate: \"Recessed\", severe: \"Weak\" }\n    }\n  },\n  {\n    id: \"strong_jaw\",\n    title: \"Strong Jaw Definition\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Gonial Angle\", \"Mandibular Plane Angle\", \"Jaw Width Ratio\", \"Bigonial Width\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The jaw displays strong definition with well-defined angles and proportionate width.\",\n      grade_labels: { good: \"Defined\", excellent: \"Strong\", ideal: \"Ideal Angular\" }\n    }\n  },\n  {\n    id: \"refined_nasal_tip\",\n    title: \"Refined Nasal Tip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasal Tip Angle\", \"Nose Tip Position\", \"Frankfort-tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious nasal profile due to the nasal tip being well-defined and proportionate.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"bulbous_nose\",\n    title: \"Bulbous Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Nose Width\", \"Nasal Tip Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip appears rounded and less defined, affecting nasal aesthetics.\",\n      severity_labels: { minor: \"Slightly Rounded\", moderate: \"Rounded\", severe: \"Bulbous\" }\n    }\n  },\n  {\n    id: \"ideal_upper_lip\",\n    title: \"Well-Positioned Upper Lip\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Lip E-Line Position\", \"Upper Lip S-Line Position\", \"Nasolabial Angle\"],\n      threshold: 9.0\n    },\n    content: {\n      description: \"This contributes to a harmonious mouth region due to the upper lip sitting neither too far forward nor too far back.\",\n      grade_labels: { good: \"Good\", excellent: \"Excellent\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"negative_canthal_tilt\",\n    title: \"Negative Canthal Tilt\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The outer corners of the eyes sit lower than the inner corners, creating a downturned appearance.\",\n      severity_labels: { minor: \"Slight Downturn\", moderate: \"Noticeable\", severe: \"Pronounced\" }\n    }\n  },\n  {\n    id: \"positive_canthal_tilt\",\n    title: \"Positive Canthal Tilt\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The outer corners of the eyes are elevated, creating an attractive upswept eye shape.\",\n      grade_labels: { good: \"Slight Upturn\", excellent: \"Well-Tilted\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"balanced_facial_thirds\",\n    title: \"Balanced Facial Thirds\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays well-balanced vertical proportions across all three facial thirds.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfectly Proportioned\" }\n    }\n  },\n  {\n    id: \"imbalanced_thirds\",\n    title: \"Facial Third Imbalance\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Upper Third Proportion\", \"Middle Third Proportion\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The vertical face proportions show imbalance between the three facial thirds.\",\n      severity_labels: { minor: \"Slight Imbalance\", moderate: \"Noticeable Disproportion\", severe: \"Significant Imbalance\" }\n    }\n  },\n  {\n    id: \"high_cheekbones\",\n    title: \"High Cheekbones\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Cheekbone Width\", \"Midface Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"Well-positioned cheekbones that create attractive facial contours and catch light beautifully.\",\n      grade_labels: { good: \"Visible\", excellent: \"Prominent\", ideal: \"Model-Tier\" }\n    }\n  },\n  {\n    id: \"flat_midface\",\n    title: \"Flat Midface\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Total Facial Width to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The midface lacks forward projection, resulting in flatter facial contours.\",\n      severity_labels: { minor: \"Slightly Flat\", moderate: \"Underprojected\", severe: \"Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_lip_ratio\",\n    title: \"Ideal Lip Proportions\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Philtrum Length\", \"Lip Chin Distance\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Well-Proportioned\", ideal: \"Perfect Ratio\" }\n    }\n  },\n  {\n    id: \"thin_lips\",\n    title: \"Thin Lip Profile\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Lip Ratio\", \"Upper Lip Projection\", \"Lower Lip Projection\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The lips appear thinner than ideal proportions, affecting lower face harmony.\",\n      severity_labels: { minor: \"Slightly Thin\", moderate: \"Thin\", severe: \"Very Thin\" }\n    }\n  },\n  {\n    id: \"ideal_ipd\",\n    title: \"Ideal Eye Spacing\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes are ideally spaced, creating facial balance and attractiveness.\",\n      grade_labels: { good: \"Good Spacing\", excellent: \"Ideal Distance\", ideal: \"Perfect IPD\" }\n    }\n  },\n  {\n    id: \"wide_set_eyes\",\n    title: \"Wide-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"One Eye Apart Test\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are spaced wider apart than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Noticeably Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"close_set_eyes\",\n    title: \"Close-Set Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Interpupillary Ratio\", \"Eye Separation Ratio\", \"Intercanthal Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes are positioned closer together than the aesthetic ideal.\",\n      severity_labels: { minor: \"Slightly Close\", moderate: \"Noticeably Close\", severe: \"Very Close\" }\n    }\n  },\n  {\n    id: \"ideal_nose_projection\",\n    title: \"Ideal Nasal Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofrontal Angle\", \"Nasofacial Angle\", \"Nasomenta Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The nose has ideal forward projection relative to the face, creating profile harmony.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect Projection\" }\n    }\n  },\n  {\n    id: \"recessed_chin\",\n    title: \"Recessed Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Facial Depth to Height\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The chin sits behind the ideal position, affecting profile balance.\",\n      severity_labels: { minor: \"Slightly Recessed\", moderate: \"Recessed\", severe: \"Severely Recessed\" }\n    }\n  },\n  {\n    id: \"ideal_chin_projection\",\n    title: \"Ideal Chin Projection\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Chin Height\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The chin demonstrates ideal projection and proportions relative to the face.\",\n      grade_labels: { good: \"Good\", excellent: \"Well-Projected\", ideal: \"Perfect\" }\n    }\n  },\n  {\n    id: \"long_philtrum\",\n    title: \"Long Philtrum\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Lip Chin Distance\", \"Upper Lip Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The distance between nose and upper lip is longer than ideal.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"short_philtrum\",\n    title: \"Short Philtrum\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Philtrum Length\", \"Upper Lip Height\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The philtrum has ideal or shorter length, considered youthful and attractive.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Short\", ideal: \"Ideal\" }\n    }\n  },\n  {\n    id: \"wide_nose\",\n    title: \"Wide Nasal Base\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Index\", \"Intercanthal Nasal Ratio\", \"Nose Bridge Width\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The base of the nose is wider than the aesthetic ideal for facial harmony.\",\n      severity_labels: { minor: \"Slightly Wide\", moderate: \"Wide\", severe: \"Very Wide\" }\n    }\n  },\n  {\n    id: \"ideal_brow_position\",\n    title: \"Ideal Brow Position\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow Length Ratio\"],\n      threshold: 8.0\n    },\n    content: {\n      description: \"The eyebrows are ideally positioned relative to the eyes and facial structure.\",\n      grade_labels: { good: \"Good Position\", excellent: \"Well-Arched\", ideal: \"Perfect Frame\" }\n    }\n  },\n  {\n    id: \"narrow_jaw\",\n    title: \"Narrow Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Jaw Width Ratio\", \"Bigonial Width\", \"Jaw Frontal Angle\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The jaw is narrower than ideal, affecting lower face width and definition.\",\n      severity_labels: { minor: \"Slightly Narrow\", moderate: \"Narrow\", severe: \"Very Narrow\" }\n    }\n  },\n  {\n    id: \"steep_mandibular_plane\",\n    title: \"Steep Mandibular Plane\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.0\n    },\n    content: {\n      description: \"The mandibular plane angle is steeper than ideal, often indicating vertical growth pattern.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  // ============================================\n  // INSIGHT DEFINITIONS (element.html / element1.html)\n  // ============================================\n  // --- WEAKNESSES ---\n  {\n    id: \"steep_jaw\",\n    title: \"Steep Jaw\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Jaw Frontal Angle\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The jaw angles sharply downward, creating a narrow or pointed chin effect.\",\n      severity_labels: { minor: \"Slightly Steep\", moderate: \"Steep\", severe: \"Very Steep\" }\n    }\n  },\n  {\n    id: \"maxillary_recession\",\n    title: \"Maxillary Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Facial Depth to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The upper jaw is less forward than ideal, reducing midface projection and facial harmony.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"mandibular_recession\",\n    title: \"Mandibular Recession\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The lower jaw is set back, creating a less prominent chin and an unbalanced profile.\",\n      severity_labels: { minor: \"Slight Recession\", moderate: \"Noticeable Recession\", severe: \"Severe Recession\" }\n    }\n  },\n  {\n    id: \"underprojected_chin\",\n    title: \"Underprojected Chin\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Recession Relative to Frankfort Plane\", \"Chin to Philtrum Ratio\", \"Chin Height\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The chin lacks forward projection, creating a weak lower face appearance.\",\n      severity_labels: { minor: \"Slightly Weak\", moderate: \"Underprojected\", severe: \"Severely Underprojected\" }\n    }\n  },\n  {\n    id: \"overly_long_face\",\n    title: \"Overly Long Face Shape\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Total Facial Width to Height Ratio\", \"Face Width to Height Ratio\"],\n      threshold: 6.0\n    },\n    content: {\n      description: \"The face is excessively tall and narrow, creating an elongated appearance.\",\n      severity_labels: { minor: \"Slightly Long\", moderate: \"Long\", severe: \"Very Long\" }\n    }\n  },\n  {\n    id: \"hyper_divergent_jaw\",\n    title: \"Hyper-Divergent Jaw Growth\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Mandibular Plane Angle\", \"Gonial Angle\", \"Lower Third Proportion\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The jaw grows with an overly steep angle, resulting in a long or narrow lower face. This can indicate malocclusion.\",\n      severity_labels: { minor: \"Mildly Divergent\", moderate: \"Divergent\", severe: \"Hyper-Divergent\" }\n    }\n  },\n  {\n    id: \"weak_brow_ridge\",\n    title: \"Soft/Weak Brow Ridge\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Eyebrow Height\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The forehead has a softer, less prominent ridge than the ideal, reducing masculine definition.\",\n      severity_labels: { minor: \"Slightly Soft\", moderate: \"Soft\", severe: \"Very Weak\" }\n    }\n  },\n  {\n    id: \"droopy_nasal_tip\",\n    title: \"Droopy Nasal Tip\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\", \"Nasofacial Angle\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nasal tip points downward more than ideal, creating a drooping appearance.\",\n      severity_labels: { minor: \"Slightly Droopy\", moderate: \"Droopy\", severe: \"Very Droopy\" }\n    }\n  },\n  {\n    id: \"overprojected_nose\",\n    title: \"Overprojected Nose\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Nasal Projection\", \"Nasofacial Angle\", \"Nose Length Ratio\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The nose projects too far forward relative to the face, creating imbalance.\",\n      severity_labels: { minor: \"Slightly Projected\", moderate: \"Overprojected\", severe: \"Very Overprojected\" }\n    }\n  },\n  {\n    id: \"small_eyes\",\n    title: \"Small Eyes\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Palpebral Fissure Length\", \"Eye Width\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyes appear smaller than the aesthetic ideal relative to the face.\",\n      severity_labels: { minor: \"Slightly Small\", moderate: \"Small\", severe: \"Very Small\" }\n    }\n  },\n  {\n    id: \"low_set_eyebrows\",\n    title: \"Low-Set Eyebrows\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Eyebrow Height\", \"Brow to Hairline Distance\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The eyebrows sit lower than ideal, reducing the visible upper eyelid space.\",\n      severity_labels: { minor: \"Slightly Low\", moderate: \"Low\", severe: \"Very Low\" }\n    }\n  },\n  {\n    id: \"asymmetrical_face\",\n    title: \"Facial Asymmetry\",\n    type: \"weakness\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 5.5\n    },\n    content: {\n      description: \"The left and right sides of the face show noticeable differences in proportion or position.\",\n      severity_labels: { minor: \"Slight Asymmetry\", moderate: \"Noticeable Asymmetry\", severe: \"Significant Asymmetry\" }\n    }\n  },\n  // --- STRENGTHS ---\n  {\n    id: \"good_jaw_width\",\n    title: \"Good Jaw Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Bigonial Width\", \"Jaw Width Ratio\", \"Jaw Frontal Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant jaw contour due to the jaw being neither too wide nor too narrow.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"good_forehead_slope\",\n    title: \"Good Forehead Slope\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Browridge Inclination Angle\", \"Forehead Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a pleasant forehead contour by indicating that the forehead is neither too steep nor too flat.\",\n      grade_labels: { good: \"Good Slope\", excellent: \"Well-Angled\", ideal: \"Ideal Slope\" }\n    }\n  },\n  {\n    id: \"good_cupids_bow\",\n    title: \"Good Cupid's Bow Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Cupids Bow Depth\", \"Upper Lip Height\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lip region due to the cupid's bow having ideal definition and depth.\",\n      grade_labels: { good: \"Defined\", excellent: \"Well-Defined\", ideal: \"Perfectly Defined\" }\n    }\n  },\n  {\n    id: \"good_eyebrow_length\",\n    title: \"Good Eyebrow Length\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Brow Length to Face Width Ratio\", \"Brow Length Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious eye region due to the eyebrows having ideal horizontal length relative to face width.\",\n      grade_labels: { good: \"Good Length\", excellent: \"Well-Proportioned\", ideal: \"Ideal Length\" }\n    }\n  },\n  {\n    id: \"good_neck_width\",\n    title: \"Good Neck Width\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Neck Width\", \"Neck to Jaw Ratio\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"This contributes to a harmonious lower face due to the neck being neither too wide nor too thin.\",\n      grade_labels: { good: \"Good Width\", excellent: \"Well-Proportioned\", ideal: \"Ideal Width\" }\n    }\n  },\n  {\n    id: \"ideal_nasolabial_angle\",\n    title: \"Ideal Nasolabial Angle\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasolabial Angle\", \"Nasal Tip Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The angle between nose and upper lip is in the ideal range, creating profile harmony.\",\n      grade_labels: { good: \"Good Angle\", excellent: \"Well-Angled\", ideal: \"Perfect Angle\" }\n    }\n  },\n  {\n    id: \"ideal_facial_depth\",\n    title: \"Ideal Facial Depth\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Depth to Height Ratio\", \"Anterior Facial Depth\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face has ideal forward projection creating attractive three-dimensional contours.\",\n      grade_labels: { good: \"Good Depth\", excellent: \"Well-Projected\", ideal: \"Ideal Projection\" }\n    }\n  },\n  {\n    id: \"ideal_eye_shape\",\n    title: \"Ideal Eye Shape\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Eye Aspect Ratio\", \"Lateral Canthal Tilt\", \"Palpebral Fissure Length\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The eyes have an attractive almond shape with ideal proportions and tilt.\",\n      grade_labels: { good: \"Attractive\", excellent: \"Well-Shaped\", ideal: \"Hunter Eyes\" }\n    }\n  },\n  {\n    id: \"harmonious_profile\",\n    title: \"Harmonious Profile\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Nasofacial Angle\", \"Nasomental Angle\", \"Total Profile Angle\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The facial profile shows excellent balance between nose, lips, and chin positions.\",\n      grade_labels: { good: \"Balanced\", excellent: \"Harmonious\", ideal: \"Perfect Profile\" }\n    }\n  },\n  {\n    id: \"good_facial_symmetry\",\n    title: \"Good Facial Symmetry\",\n    type: \"strength\",\n    severity_logic: {\n      metrics: [\"Facial Asymmetry Index\", \"Eye Asymmetry\", \"Jaw Asymmetry\"],\n      threshold: 8.5\n    },\n    content: {\n      description: \"The face displays excellent bilateral symmetry, a key component of attractiveness.\",\n      grade_labels: { good: \"Symmetric\", excellent: \"Very Symmetric\", ideal: \"Near-Perfect Symmetry\" }\n    }\n  }\n];\n\n// ============================================\n// METRIC NAME MAPPING\n// ============================================\n\n// Map display names to metric IDs for lookup\nconst METRIC_NAME_TO_ID: Record<string, string> = {\n  // Face Shape/Proportions\n  \"Face Width to Height Ratio\": \"faceWidthToHeight\",\n  \"Total Facial Width to Height\": \"totalFacialWidthToHeight\",\n  \"Total Facial Width to Height Ratio\": \"totalFacialWidthToHeight\",\n  \"Midface Ratio\": \"midfaceRatio\",\n  \"Upper Third Proportion\": \"upperThirdProportion\",\n  \"Middle Third Proportion\": \"middleThirdProportion\",\n  \"Lower Third Proportion\": \"lowerThirdProportion\",\n  \"Cheekbone Height\": \"cheekboneHeight\",\n  \"Cheekbone Width\": \"cheekboneWidth\",\n  \"Bitemporal Width\": \"bitemporalWidth\",\n  \"Forehead Height\": \"foreheadHeight\",\n  \"Facial Asymmetry Index\": \"facialAsymmetryIndex\",\n\n  // Jaw\n  \"Gonial Angle\": \"gonialAngle\",\n  \"Mandibular Plane Angle\": \"mandibularPlaneAngle\",\n  \"Jaw Width Ratio\": \"jawWidthRatio\",\n  \"Bigonial Width\": \"bigonialWidth\",\n  \"Jaw Frontal Angle\": \"jawFrontalAngle\",\n  \"Jaw Slope\": \"jawSlope\",\n  \"Jaw Asymmetry\": \"jawAsymmetry\",\n\n  // Chin\n  \"Chin to Philtrum Ratio\": \"chinPhiltrumRatio\",\n  \"Chin Height\": \"chinHeight\",\n  \"Facial Depth to Height\": \"facialDepthToHeight\",\n  \"Facial Depth to Height Ratio\": \"facialDepthToHeight\",\n  \"Anterior Facial Depth\": \"anteriorFacialDepth\",\n  \"Recession Relative to Frankfort Plane\": \"recessionFrankfort\",\n\n  // Eyes\n  \"Lateral Canthal Tilt\": \"lateralCanthalTilt\",\n  \"Eye Aspect Ratio\": \"eyeAspectRatio\",\n  \"Eye Separation Ratio\": \"eyeSeparationRatio\",\n  \"Interpupillary Ratio\": \"interpupillaryRatio\",\n  \"One Eye Apart Test\": \"oneEyeApartTest\",\n  \"Intercanthal Width\": \"intercanthalWidth\",\n  \"Eyebrow Height\": \"eyebrowHeight\",\n  \"Brow Length Ratio\": \"browLengthRatio\",\n  \"Brow Length to Face Width Ratio\": \"browLengthToFaceWidth\",\n  \"Palpebral Fissure Length\": \"palpebralFissureLength\",\n  \"Eye Width\": \"eyeWidth\",\n  \"Eye Asymmetry\": \"eyeAsymmetry\",\n  \"Brow to Hairline Distance\": \"browToHairlineDistance\",\n\n  // Brow\n  \"Browridge Inclination Angle\": \"browridgeInclinationAngle\",\n\n  // Nose\n  \"Nasal Index\": \"nasalIndex\",\n  \"Nasal Tip Angle\": \"nasalTipAngle\",\n  \"Nose Tip Position\": \"noseTipPosition\",\n  \"Frankfort-tip Angle\": \"frankfortTipAngle\",\n  \"Nasofrontal Angle\": \"nasofrontalAngle\",\n  \"Nasofacial Angle\": \"nasofacialAngle\",\n  \"Nasomenta Angle\": \"nasomentaAngle\",\n  \"Nasomental Angle\": \"nasomentaAngle\",\n  \"Intercanthal Nasal Ratio\": \"intercanthalNasalRatio\",\n  \"Nose Bridge Width\": \"noseBridgeWidth\",\n  \"Nose Width\": \"noseWidth\",\n  \"Nasal Projection\": \"nasalProjection\",\n  \"Nose Length Ratio\": \"noseLengthRatio\",\n  \"Ipsilateral Alar Angle\": \"ipsilateralAlarAngle\",\n\n  // Lips\n  \"Lip Ratio\": \"lipRatio\",\n  \"Philtrum Length\": \"philtrumLength\",\n  \"Upper Lip Projection\": \"upperLipProjection\",\n  \"Lower Lip Projection\": \"lowerLipProjection\",\n  \"Lip Chin Distance\": \"lipChinDistance\",\n  \"Upper Lip Height\": \"upperLipHeight\",\n  \"Upper Lip E-Line Position\": \"upperLipELine\",\n  \"Upper Lip S-Line Position\": \"upperLipSLine\",\n  \"Nasolabial Angle\": \"nasolabialAngle\",\n  \"Cupids Bow Depth\": \"cupidsBowDepth\",\n\n  // Neck\n  \"Neck Width\": \"neckWidth\",\n  \"Neck to Jaw Ratio\": \"neckToJawRatio\",\n\n  // Profile\n  \"Total Profile Angle\": \"totalProfileAngle\",\n};\n\n// ============================================\n// CLASSIFICATION FUNCTIONS\n// ============================================\n\n/**\n * Get weakness severity based on average score\n * 0-3 = \"Severe\", 3-5 = \"Moderate\", 5-7 = \"Minor\"\n */\nfunction getWeaknessSeverity(avgScore: number): WeaknessSeverity {\n  if (avgScore <= 3) return 'severe';\n  if (avgScore <= 5) return 'moderate';\n  return 'minor';\n}\n\n/**\n * Get strength grade based on average score\n * 8-9 = \"Good\", 9-9.5 = \"Excellent\", 9.5-10 = \"Ideal\"\n */\nfunction getStrengthGrade(avgScore: number): StrengthGrade {\n  if (avgScore >= 9.5) return 'ideal';\n  if (avgScore >= 9) return 'excellent';\n  return 'good';\n}\n\n/**\n * Find metric by display name from measurements array\n */\nfunction findMetricByName(\n  metricName: string,\n  measurements: MetricScoreResult[]\n): MetricScoreResult | undefined {\n  // First try direct ID mapping\n  const metricId = METRIC_NAME_TO_ID[metricName];\n  if (metricId) {\n    return measurements.find(m => m.metricId === metricId);\n  }\n\n  // Fallback: try fuzzy matching on name\n  const normalizedName = metricName.toLowerCase().replace(/[^a-z0-9]/g, '');\n  return measurements.find(m => {\n    const normalizedMetricName = m.name.toLowerCase().replace(/[^a-z0-9]/g, '');\n    return normalizedMetricName.includes(normalizedName) ||\n           normalizedName.includes(normalizedMetricName);\n  });\n}\n\n/**\n * Check if a metric should be considered a \"false positive\" weakness.\n * This handles directional/dimorphic metrics where low scores don't mean weakness.\n *\n * Example: Canthal Tilt of 3° gets a low score (not in 6-8° ideal range)\n * but is still a POSITIVE trait, not a weakness.\n */\nfunction isFalsePositiveWeakness(metric: MatchedMetric): boolean {\n  const config = METRIC_CONFIGS[metric.metricId];\n  if (!config) return false;\n\n  // Check if the value is actually acceptable based on polarity\n  const { acceptable } = isValueAcceptable(metric.value, config);\n  return acceptable;\n}\n\n/**\n * Process all insight definitions against user's measurements\n */\nexport function classifyInsights(\n  measurements: MetricScoreResult[],\n  insightDefinitions: InsightDefinition[] = INSIGHTS_DEFINITIONS\n): InsightClassificationResult {\n  const strengths: ClassifiedStrength[] = [];\n  const weaknesses: ClassifiedWeakness[] = [];\n\n  for (const insight of insightDefinitions) {\n    const { metrics, threshold } = insight.severity_logic;\n\n    // Find matching measurements for this insight\n    const matchedMetrics: MatchedMetric[] = [];\n    for (const metricName of metrics) {\n      const measurement = findMetricByName(metricName, measurements);\n      if (measurement) {\n        matchedMetrics.push({\n          metricId: measurement.metricId,\n          metricName: measurement.name,\n          score: measurement.score,\n          value: measurement.value,\n          idealMin: measurement.idealMin,\n          idealMax: measurement.idealMax,\n          unit: measurement.unit,\n          category: measurement.category,\n        });\n      }\n    }\n\n    // Skip if no metrics matched (need at least 1)\n    if (matchedMetrics.length === 0) continue;\n\n    // Calculate average score\n    const avgScore = matchedMetrics.reduce((sum, m) => sum + m.score, 0) / matchedMetrics.length;\n\n    // Classify based on type and threshold\n    if (insight.type === 'weakness') {\n      // Weakness: avg < threshold → add to areas of improvement\n      if (avgScore < threshold) {\n        // ========== FALSE POSITIVE CHECK ==========\n        // Before adding to weaknesses, check if ANY of the matched metrics\n        // are actually in an \"acceptable\" zone based on their polarity.\n        // If so, this is a false positive and should be skipped or reclassified.\n        const falsePositiveMetrics = matchedMetrics.filter(isFalsePositiveWeakness);\n\n        // If ALL matched metrics are false positives, skip this weakness entirely\n        if (falsePositiveMetrics.length === matchedMetrics.length) {\n          // This is a false positive weakness - the values are actually acceptable\n          // Consider adding to strengths if scores are decent\n          if (avgScore >= 6) {\n            strengths.push({\n              insightId: `${insight.id}_acceptable`,\n              title: insight.title.replace('Negative', 'Neutral').replace('Weak', 'Moderate'),\n              description: `While not in the peak ideal range, the measured values are within acceptable limits.`,\n              grade: 'good',\n              gradeLabel: 'Acceptable',\n              avgScore,\n              matchedMetrics,\n            });\n          }\n          continue; // Skip adding as weakness\n        }\n\n        // If SOME metrics are false positives, filter them out\n        const trueWeaknessMetrics = matchedMetrics.filter(m => !isFalsePositiveWeakness(m));\n        if (trueWeaknessMetrics.length === 0) continue;\n\n        // Recalculate average with only true weakness metrics\n        const trueAvgScore = trueWeaknessMetrics.reduce((sum, m) => sum + m.score, 0) / trueWeaknessMetrics.length;\n\n        // Only add as weakness if true average is still below threshold\n        if (trueAvgScore < threshold) {\n          const severity = getWeaknessSeverity(trueAvgScore);\n          const labels = insight.content.severity_labels;\n          const severityLabel = labels?.[severity] || severity;\n\n          weaknesses.push({\n            insightId: insight.id,\n            title: insight.title,\n            description: insight.content.description,\n            severity,\n            severityLabel,\n            avgScore: trueAvgScore,\n            matchedMetrics: trueWeaknessMetrics,\n          });\n        }\n      }\n    } else {\n      // Strength: avg > threshold → add to key strengths\n      if (avgScore > threshold) {\n        const grade = getStrengthGrade(avgScore);\n        const labels = insight.content.grade_labels;\n        const gradeLabel = labels?.[grade] || grade;\n\n        strengths.push({\n          insightId: insight.id,\n          title: insight.title,\n          description: insight.content.description,\n          grade,\n          gradeLabel,\n          avgScore,\n          matchedMetrics,\n        });\n      }\n    }\n  }\n\n  // Sort by score (weaknesses by lowest score first, strengths by highest first)\n  weaknesses.sort((a, b) => a.avgScore - b.avgScore);\n  strengths.sort((a, b) => b.avgScore - a.avgScore);\n\n  return { strengths, weaknesses };\n}\n\n/**\n * Convert ClassifiedStrength to Strength type for UI compatibility\n */\nexport function convertToStrength(classified: ClassifiedStrength): Strength {\n  return {\n    id: `insight_strength_${classified.insightId}`,\n    strengthName: `${classified.title} (${classified.gradeLabel})`,\n    summary: classified.description,\n    avgScore: classified.avgScore,\n    qualityLevel: classified.grade === 'ideal' ? 'ideal' :\n                  classified.grade === 'excellent' ? 'excellent' : 'good',\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n  };\n}\n\n/**\n * Convert ClassifiedWeakness to Flaw type for UI compatibility\n */\nexport function convertToFlaw(classified: ClassifiedWeakness, index: number, rollingLost: number): Flaw {\n  const impact = (10 - classified.avgScore) * 0.5;\n  const newRollingLost = rollingLost + impact;\n\n  return {\n    id: `insight_flaw_${classified.insightId}`,\n    flawName: `${classified.title} (${classified.severityLabel})`,\n    summary: classified.description,\n    harmonyPercentageLost: impact,\n    standardizedImpact: impact / 10,\n    categoryName: classified.matchedMetrics[0]?.category || 'General',\n    responsibleRatios: classified.matchedMetrics.map(m => ({\n      ratioName: m.metricName,\n      ratioId: m.metricId,\n      score: Math.max(0, Math.min(10, m.score)),  // Clamp to 0-10 to prevent display overflow\n      value: m.value,\n      idealMin: m.idealMin,\n      idealMax: m.idealMax,\n      unit: m.unit,\n      category: m.category,\n    })),\n    rollingPointsDeducted: newRollingLost,\n    rollingHarmonyPercentageLost: newRollingLost,\n    rollingStandardizedImpact: newRollingLost / 10,\n  };\n}\n\n/**\n * Main function: Generate strengths and flaws from measurements using insights\n */\nexport function generateInsightBasedResults(\n  measurements: MetricScoreResult[]\n): { strengths: Strength[]; flaws: Flaw[] } {\n  const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } = classifyInsights(measurements);\n\n  // Convert to UI-compatible types\n  const strengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n  let rollingLost = 0;\n  const flaws = classifiedWeaknesses.map((w, i) => {\n    const flaw = convertToFlaw(w, i, rollingLost);\n    rollingLost = flaw.rollingPointsDeducted || 0;\n    return flaw;\n  });\n\n  return { strengths, flaws };\n}\n","structuredPatch":[{"oldStart":2573,"oldLines":7,"newStart":2573,"newLines":7,"lines":["     id: `insight_strength_${classified.insightId}`,","     strengthName: `${classified.title} (${classified.gradeLabel})`,","     summary: classified.description,","-    avgScore: classified.avgScore,","+    avgScore: Math.max(0, Math.min(10, classified.avgScore)),  // Clamp to 0-10","     qualityLevel: classified.grade === 'ideal' ? 'ideal' :","                   classified.grade === 'excellent' ? 'excellent' : 'good',","     categoryName: classified.matchedMetrics[0]?.category || 'General',"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"8e69c6ed-6c1d-4a67-a1ae-579bac7e4944","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GSZxXSYgtcn4GowwiQ7xYc","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the todo and run the verification:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":729,"cache_read_input_tokens":106271,"cache_creation":{"ephemeral_5m_input_tokens":729,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUriCk2XrNqmNLJNPbp6","type":"assistant","uuid":"16e87513-5c29-4429-a1bc-2042070a37df","timestamp":"2025-12-26T06:53:15.961Z"}
{"parentUuid":"16e87513-5c29-4429-a1bc-2042070a37df","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GSZxXSYgtcn4GowwiQ7xYc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QJ7km3AMR8JyWHSeGQogsg","name":"TodoWrite","input":{"todos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"completed","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"completed","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"completed","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"in_progress","activeForm":"Verifying fix with lint and tsc"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":729,"cache_read_input_tokens":106271,"cache_creation":{"ephemeral_5m_input_tokens":729,"ephemeral_1h_input_tokens":0},"output_tokens":207,"service_tier":"standard"}},"requestId":"req_011CWUriCk2XrNqmNLJNPbp6","type":"assistant","uuid":"481204e8-ee62-415c-87ca-6f0c5c0db618","timestamp":"2025-12-26T06:53:19.750Z"}
{"parentUuid":"481204e8-ee62-415c-87ca-6f0c5c0db618","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QJ7km3AMR8JyWHSeGQogsg","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"5f7f61d4-7e11-44c2-8c9e-7452fbd03c17","timestamp":"2025-12-26T06:53:19.783Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"completed","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"completed","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"completed","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"in_progress","activeForm":"Verifying fix with lint and tsc"}]}}
{"parentUuid":"5f7f61d4-7e11-44c2-8c9e-7452fbd03c17","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vw29PaQCcxHsCEBCuYMnJf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014m5BV2rtpqREvoxkzar2NC","name":"Bash","input":{"command":"npm run lint 2>&1","description":"Run ESLint to verify no errors","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":249,"cache_read_input_tokens":107000,"cache_creation":{"ephemeral_5m_input_tokens":249,"ephemeral_1h_input_tokens":0},"output_tokens":23,"service_tier":"standard"}},"requestId":"req_011CWUrimDeWLWrUT1gqVXk8","type":"assistant","uuid":"79448e14-c4aa-462b-a8a5-d95a76a10bf8","timestamp":"2025-12-26T06:53:23.987Z"}
{"parentUuid":"79448e14-c4aa-462b-a8a5-d95a76a10bf8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014m5BV2rtpqREvoxkzar2NC","type":"tool_result","content":"> looksmaxx-app@0.1.0 lint\n> next lint\n\n\n./src/components/results/modals/UserProfileModal.tsx\n108:21  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/tabs/LeaderboardTab.tsx\n170:27  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\ninfo  - Need to disable some ESLint rules? Learn more here: https://nextjs.org/docs/basic-features/eslint#disabling-rules","is_error":false}]},"uuid":"b68302ef-9177-4472-97e1-1371ca937023","timestamp":"2025-12-26T06:53:25.729Z","toolUseResult":{"stdout":"> looksmaxx-app@0.1.0 lint\n> next lint\n\n\n./src/components/results/modals/UserProfileModal.tsx\n108:21  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/tabs/LeaderboardTab.tsx\n170:27  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\ninfo  - Need to disable some ESLint rules? Learn more here: https://nextjs.org/docs/basic-features/eslint#disabling-rules","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"b68302ef-9177-4472-97e1-1371ca937023","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FPm1ZE319vSo6N5ENPWH3g","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01D7EU3Dfv6456by634Qnn1U","name":"Bash","input":{"command":"npx tsc --noEmit 2>&1","description":"Run TypeScript compiler to verify no type errors","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":363,"cache_read_input_tokens":107249,"cache_creation":{"ephemeral_5m_input_tokens":363,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWUrjChpwbD2K4xjfxChU","type":"assistant","uuid":"082dc24a-34a4-41c4-8468-7da6954cddf4","timestamp":"2025-12-26T06:53:31.422Z"}
{"parentUuid":"082dc24a-34a4-41c4-8468-7da6954cddf4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01D7EU3Dfv6456by634Qnn1U","type":"tool_result","content":"","is_error":false}]},"uuid":"941eca7d-bf01-406c-b0b7-88ef05073c32","timestamp":"2025-12-26T06:53:33.422Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"941eca7d-bf01-406c-b0b7-88ef05073c32","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_018aA3mqA6ZNDJELvJzt5SXn","type":"message","role":"assistant","content":[{"type":"text","text":"Both lint and tsc pass. Now let me update the todo:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":132,"cache_read_input_tokens":107612,"cache_creation":{"ephemeral_5m_input_tokens":132,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrjmeDvDSBMQeLHDQks","type":"assistant","uuid":"6f1f0e0c-e95a-4194-9e51-c15631772ce5","timestamp":"2025-12-26T06:53:37.337Z"}
{"parentUuid":"6f1f0e0c-e95a-4194-9e51-c15631772ce5","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_018aA3mqA6ZNDJELvJzt5SXn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01R8FD3oUEgDF4EgwvMDWF3H","name":"TodoWrite","input":{"todos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"completed","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"completed","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"completed","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"completed","activeForm":"Verifying fix with lint and tsc"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":132,"cache_read_input_tokens":107612,"cache_creation":{"ephemeral_5m_input_tokens":132,"ephemeral_1h_input_tokens":0},"output_tokens":208,"service_tier":"standard"}},"requestId":"req_011CWUrjmeDvDSBMQeLHDQks","type":"assistant","uuid":"f057cc68-1945-4b01-9a8e-5984dea53d90","timestamp":"2025-12-26T06:53:39.188Z"}
{"parentUuid":"f057cc68-1945-4b01-9a8e-5984dea53d90","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01R8FD3oUEgDF4EgwvMDWF3H","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"f53a1d42-5043-4573-bf10-03d9e9ebc26b","timestamp":"2025-12-26T06:53:39.224Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Investigate where scores exceed 10 in the scoring system","status":"completed","activeForm":"Investigating score overflow bug"},{"content":"Identify all exit points where unclamped values leak through","status":"completed","activeForm":"Identifying unclamped exit points"},{"content":"Add proper clamping at all exit points","status":"completed","activeForm":"Adding clamping at exit points"},{"content":"Verify fix with lint and tsc","status":"completed","activeForm":"Verifying fix with lint and tsc"}]}}
{"parentUuid":"f53a1d42-5043-4573-bf10-03d9e9ebc26b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4e0d04e8-56ad-4bca-9e4b-36b62804ea66","version":"2.0.76","gitBranch":"main","agentId":"a369d51","slug":"shiny-hatching-balloon","message":{"model":"claude-opus-4-5-20251101","id":"msg_018SM8S25zMgFZURqBQJqEAF","type":"message","role":"assistant","content":[{"type":"text","text":"## Bug Summary\nContributing ratios in strengths/flaws (e.g., \"Short Midface\", \"High Cheekbones\") displayed scores exceeding 10/10.\n\n## Root Cause\nThe bug originated from **unclamped scores** in the data transformation layer. While `transformToRatio()` and `standardizeScore()` properly clamped scores to 0-10, the `responsibleRatios` arrays in strengths and flaws were populated from raw measurement data without clamping.\n\nThe Bezier curve interpolation (`interpolateCustomCurve()`) can produce values slightly above 10 due to numerical precision in the cubic Bezier calculations, and the catmull-rom spline can overshoot at control point transitions. These unclamped values then flowed through to the UI.\n\n**Files with root cause:**\n- `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts:2576,2583,2610` - `convertToStrength()` and `convertToFlaw()` used raw `m.score` values\n- `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx:901,918,945,1056,1088` - `generateStrengthsFromAnalysis()` and `generateFlawsFromAnalysis()` used raw measurement scores\n\n## Trace Path\n1. Error manifests in UI: \"Midface Ratio: 10.3/10\" displayed in strength/flaw cards\n2. Called by `OverviewTab.tsx` which displays `responsibleRatios[i].score`\n3. `responsibleRatios` populated in `convertToStrength()`/`convertToFlaw()` in insights-engine.ts\n4. Also populated in `generateStrengthsFromAnalysis()`/`generateFlawsFromAnalysis()` in ResultsContext.tsx\n5. ROOT CAUSE: Raw `m.score` values from `classifiedStrengths.matchedMetrics` and `analysis.measurements` used without clamping\n\n## Fix\nAdded `Math.max(0, Math.min(10, score))` clamping at all 8 exit points:\n\n**In `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/insights-engine.ts`:**\n- Line 2576: `avgScore: Math.max(0, Math.min(10, classified.avgScore))`\n- Line 2583: `score: Math.max(0, Math.min(10, m.score))`\n- Line 2610: `score: Math.max(0, Math.min(10, m.score))`\n\n**In `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx`:**\n- Line 902: `const avgScore = Math.max(0, Math.min(10, rawAvgScore))`\n- Line 918: `score: Math.max(0, Math.min(10, m.score))`\n- Line 934/946: Created `clampedScore` variable and used it for both `avgScore` and `score`\n- Line 1057: `score: Math.max(0, Math.min(10, m.score))`\n- Line 1076/1090: Created `clampedScore` variable and used it for `score` and impact calculation\n\n## Verification\n- ESLint: Pass (only existing `<img>` warnings, no new errors)\n- TypeScript: Pass (no type errors)\n\n## Prevention\nThe fix implements defense-in-depth by clamping at the data transformation layer, ensuring that regardless of upstream scoring edge cases (Bezier overshoot, numerical precision), all scores reaching the UI are guaranteed to be in the 0-10 range."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":250,"cache_read_input_tokens":107744,"cache_creation":{"ephemeral_5m_input_tokens":250,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUrkCcQ5cvDseSkM3R1b","type":"assistant","uuid":"74553afd-601e-4cd1-8eb5-0cd7f2a48786","timestamp":"2025-12-26T06:54:01.695Z"}
