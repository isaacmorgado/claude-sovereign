{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":"Explore the LOOKSMAXX codebase to determine if the following treatment/advice features from changes.md have been implemented:\n\n1. **Treatment Metadata** - Check `src/lib/advice-engine.ts` for:\n   - `priority_score` field (1-5 scale)\n   - `effectiveness` object with level, score, confidence\n   - `ratios_impacted` data showing which metrics a procedure affects\n   - `recovery_weeks`, `duration_months`, `cost_range`, `risk_level` fields\n\n2. **Impact Tables** - Check if there are quantitative procedure→metric mappings (e.g., \"Jaw Filler increases Bigonial Width by 3%\")\n\n3. **PlanTab UI** - Check `src/components/results/tabs/PlanTab.tsx` or similar:\n   - Does it show priority ordering?\n   - Does it show effectiveness ratings?\n   - Is there cumulative potential improvement calculation?\n\n4. **Outcome Predictions** - Are there any before/after visualization overlays or predicted metric values post-treatment?\n\nReport what you find with specific file paths and line numbers where relevant."},"uuid":"706c9bf9-1516-4c7b-b7df-997194ee21ba","timestamp":"2025-12-24T20:18:55.144Z"}
{"parentUuid":"706c9bf9-1516-4c7b-b7df-997194ee21ba","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TRmZ1anpnrQn5c48wuxSGb","type":"message","role":"assistant","content":[{"type":"text","text":"I'll systematically explore the LOOKSMAXX codebase to check for these treatment/advice features. Let me start by examining the key files mentioned."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":13822,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":13822,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWS8XvurXXTv79FfnBXaz","type":"assistant","uuid":"b9b37468-a999-43c4-89bd-4fc1e0677d07","timestamp":"2025-12-24T20:18:56.552Z"}
{"parentUuid":"b9b37468-a999-43c4-89bd-4fc1e0677d07","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01TRmZ1anpnrQn5c48wuxSGb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01R5nNwJGWEpEKe173W2u7dJ","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":13822,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":13822,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWS8XvurXXTv79FfnBXaz","type":"assistant","uuid":"acafd180-874a-4468-8c37-e4992072866c","timestamp":"2025-12-24T20:18:56.816Z"}
{"parentUuid":"acafd180-874a-4468-8c37-e4992072866c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01R5nNwJGWEpEKe173W2u7dJ","type":"tool_result","content":"     1→/**\n     2→ * Advice Engine - Client-side implementation matching the Python AdviceEngine\n     3→ * Processes plans.json trigger rules against user metrics\n     4→ */\n     5→\n     6→import { Plan } from '@/components/results/cards/PlanActionCard';\n     7→\n     8→// ============================================\n     9→// TYPES\n    10→// ============================================\n    11→\n    12→interface Threshold {\n    13→  operator: '<' | '>';\n    14→  value: number;\n    15→}\n    16→\n    17→interface TriggerRules {\n    18→  metrics: string[];\n    19→  condition: 'OR' | 'AND';\n    20→  thresholds: Record<string, Threshold>;\n    21→}\n    22→\n    23→// FaceIQ-style effectiveness rating\n    24→interface Effectiveness {\n    25→  level: 'high' | 'medium' | 'low';\n    26→  score: number;  // 1-5\n    27→  confidence: number;  // 0-1\n    28→}\n    29→\n    30→// How a treatment impacts a specific ratio\n    31→interface RatioImpact {\n    32→  direction: 'increase' | 'decrease';\n    33→  percentage: number;  // Expected % change\n    34→}\n    35→\n    36→interface PlanContent {\n    37→  description: string;\n    38→  cost_min: number;\n    39→  cost_max: number;\n    40→  time_min?: string;\n    41→  time_max?: string;\n    42→  risks?: string;\n    43→  citations?: string[];\n    44→  tags?: string[];\n    45→  // FaceIQ parity - new metadata fields\n    46→  priority_score?: number;  // 1-5, higher = more important\n    47→  effectiveness?: Effectiveness;\n    48→  ratios_impacted?: Record<string, RatioImpact>;\n    49→  pillars?: string[];  // e.g., ['angularity', 'harmony', 'symmetry']\n    50→}\n    51→\n    52→interface RawPlan {\n    53→  id: string;\n    54→  title: string;\n    55→  trigger_rules: TriggerRules;\n    56→  content: PlanContent;\n    57→}\n    58→\n    59→interface TriggerResult {\n    60→  metric: string;\n    61→  value: number;\n    62→  threshold: number;\n    63→  operator: '<' | '>';\n    64→}\n    65→\n    66→// ============================================\n    67→// PLANS DATA (from plans.json)\n    68→// ============================================\n    69→\n    70→export const PLANS: RawPlan[] = [\n    71→  {\n    72→    id: \"jaw_fillers\",\n    73→    title: \"Jaw Fillers\",\n    74→    trigger_rules: {\n    75→      metrics: [\"Gonial Angle\", \"Bigonial Width\", \"Ramus to Mandible Ratio\"],\n    76→      condition: \"OR\",\n    77→      thresholds: {\n    78→        \"Gonial Angle\": { operator: \">\", value: 128.0 },\n    79→        \"Bigonial Width\": { operator: \"<\", value: 90.0 },\n    80→        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.5 }\n    81→      }\n    82→    },\n    83→    content: {\n    84→      description: \"Injectable dermal fillers (hyaluronic acid or hydroxyapatite) to enhance jawline definition, gonial angle sharpness, and mandibular border projection. Common products: Radiesse, Sculptra, Juvederm Voluma. Targets masseter hollow, prejowl sulcus, and mandibular angle.\",\n    85→      cost_min: 600,\n    86→      cost_max: 2500,\n    87→      time_min: \"6 months\",\n    88→      time_max: \"18 months\",\n    89→      risks: \"Vascular occlusion, asymmetry, swelling.\",\n    90→      citations: [\"Al-Khafaji et al., 2023\"],\n    91→      tags: [\"Minimally Invasive\"],\n    92→      priority_score: 4,\n    93→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n    94→      ratios_impacted: {\n    95→        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 },\n    96→        \"Bigonial Width\": { direction: \"increase\", percentage: 4 },\n    97→        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 2 }\n    98→      },\n    99→      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n   100→    }\n   101→  },\n   102→  {\n   103→    id: \"cheekbone_fillers\",\n   104→    title: \"Cheekbone Fillers\",\n   105→    trigger_rules: {\n   106→      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n   107→      condition: \"OR\",\n   108→      thresholds: {\n   109→        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n   110→        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.75 }\n   111→      }\n   112→    },\n   113→    content: {\n   114→      description: \"Malar augmentation via hyaluronic acid fillers placed at the zygomatic arch and submalar region. Products: Juvederm Voluma, Restylane Lyft. Enhances ogee curve, anterior cheek projection, and lateral zygomatic width for improved facial angularity.\",\n   115→      cost_min: 650,\n   116→      cost_max: 2500,\n   117→      time_min: \"6 months\",\n   118→      time_max: \"18 months\",\n   119→      risks: \"Asymmetry, filler migration.\",\n   120→      citations: [\"Trinh & Gupta, 2021\"],\n   121→      tags: [\"Minimally Invasive\"],\n   122→      priority_score: 4,\n   123→      effectiveness: { level: 'high', score: 5, confidence: 0.85 },\n   124→      ratios_impacted: {\n   125→        \"Cheekbone Height\": { direction: \"increase\", percentage: 4 },\n   126→        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 2 },\n   127→        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 }\n   128→      },\n   129→      pillars: [\"angularity\", \"harmony\", \"youthfulness\"]\n   130→    }\n   131→  },\n   132→  {\n   133→    id: \"beard_growth\",\n   134→    title: \"Beard / Stubble Growth\",\n   135→    trigger_rules: {\n   136→      metrics: [\"Chin to Philtrum Ratio\", \"Gonial Angle\"],\n   137→      condition: \"OR\",\n   138→      thresholds: {\n   139→        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.8 },\n   140→        \"Gonial Angle\": { operator: \">\", value: 126.0 }\n   141→      }\n   142→    },\n   143→    content: {\n   144→      description: \"Strategic facial hair growth (5-10mm stubble or full beard) to optically enhance jawline definition, camouflage gonial angle softness, and create visual chin projection. Consider minoxidil 5% foam if low coverage. Trim to maintain sharp mandibular border.\",\n   145→      cost_min: 0,\n   146→      cost_max: 20,\n   147→      time_min: \"1 month\",\n   148→      time_max: \"3 months\",\n   149→      risks: \"None\",\n   150→      citations: [\"Dixson et al., 2016\"],\n   151→      tags: [\"Foundational\", \"Free\"],\n   152→      priority_score: 2,\n   153→      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n   154→      ratios_impacted: {\n   155→        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 5 },\n   156→        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 }\n   157→      },\n   158→      pillars: [\"masculinity\", \"camouflage\"]\n   159→    }\n   160→  },\n   161→  {\n   162→    id: \"lip_filler\",\n   163→    title: \"Lip Filler\",\n   164→    trigger_rules: {\n   165→      metrics: [\"Lower Lip to Upper Lip Ratio\"],\n   166→      condition: \"OR\",\n   167→      thresholds: {\n   168→        \"Lower Lip to Upper Lip Ratio\": { operator: \"<\", value: 1.0 }\n   169→      }\n   170→    },\n   171→    content: {\n   172→      description: \"Lip augmentation via hyaluronic acid fillers (Restylane, Juvederm) to enhance vermillion border, cupid's bow definition, and lip ratio balance. Can target vermillion height, philtral columns, or tubercles. Alternative: surgical lip lift (bullhorn or corner lift) for permanent results.\",\n   173→      cost_min: 500,\n   174→      cost_max: 1200,\n   175→      time_min: \"6 months\",\n   176→      time_max: \"12 months\",\n   177→      risks: \"Migration, bruising.\",\n   178→      citations: [\"Hernandez et al., 2023\"],\n   179→      tags: [\"Minimally Invasive\"],\n   180→      priority_score: 3,\n   181→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n   182→      ratios_impacted: {\n   183→        \"Lower Lip to Upper Lip Ratio\": { direction: \"increase\", percentage: 15 }\n   184→      },\n   185→      pillars: [\"harmony\", \"femininity\", \"youthfulness\"]\n   186→    }\n   187→  },\n   188→  {\n   189→    id: \"weight_loss_protocol\",\n   190→    title: \"Fat Loss Protocol (High Protein + Cardio)\",\n   191→    trigger_rules: {\n   192→      metrics: [\"Cheekbone Height\", \"Jaw Slope\"],\n   193→      condition: \"OR\",\n   194→      thresholds: {\n   195→        \"Cheekbone Height\": { operator: \"<\", value: 65.0 },\n   196→        \"Jaw Slope\": { operator: \">\", value: 140.0 }\n   197→      }\n   198→    },\n   199→    content: {\n   200→      description: \"Caloric deficit protocol targeting 8-12% body fat to debloat buccal fat pads and reveal zygomatic, mandibular, and maxillary bone structure. High-protein intake (1.6-2.2g/kg), fasted cardio, and sodium/water management. Consider buccal fat removal surgery if structure remains obscured at low body fat.\",\n   201→      cost_min: 200,\n   202→      cost_max: 1000,\n   203→      time_min: \"3 months\",\n   204→      time_max: \"12 months\",\n   205→      risks: \"None\",\n   206→      citations: [\"Moon & Koh, 2020\"],\n   207→      tags: [\"Foundational\"],\n   208→      priority_score: 5,\n   209→      effectiveness: { level: 'high', score: 4, confidence: 0.90 },\n   210→      ratios_impacted: {\n   211→        \"Cheekbone Height\": { direction: \"increase\", percentage: 8 },\n   212→        \"Jaw Slope\": { direction: \"decrease\", percentage: 5 },\n   213→        \"Bigonial Width\": { direction: \"increase\", percentage: 3 }\n   214→      },\n   215→      pillars: [\"angularity\", \"bone_structure\", \"definition\"]\n   216→    }\n   217→  },\n   218→  {\n   219→    id: \"mewing_posture\",\n   220→    title: \"Mewing & Posture Correction\",\n   221→    trigger_rules: {\n   222→      metrics: [\"Midface Ratio\", \"Nasolabial Angle\"],\n   223→      condition: \"OR\",\n   224→      thresholds: {\n   225→        \"Midface Ratio\": { operator: \">\", value: 1.05 },\n   226→        \"Nasolabial Angle\": { operator: \"<\", value: 90.0 }\n   227→      }\n   228→    },\n   229→    content: {\n   230→      description: \"Orthotropic tongue posture: entire tongue (posterior third critical) pressed against palate, teeth in light contact, nasal breathing. Aims to stimulate maxillary protraction, improve mandibular posture, and enhance gonial angle over time. Combine with proper head/neck alignment and chin tucks.\",\n   231→      cost_min: 0,\n   232→      cost_max: 0,\n   233→      time_min: \"12 months\",\n   234→      time_max: \"Lifetime\",\n   235→      risks: \"None if performed correctly.\",\n   236→      citations: [\"Mew J. et al., 2014\"],\n   237→      tags: [\"Foundational\", \"Free\"],\n   238→      priority_score: 3,\n   239→      effectiveness: { level: 'low', score: 2, confidence: 0.50 },\n   240→      ratios_impacted: {\n   241→        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 },\n   242→        \"Nasolabial Angle\": { direction: \"increase\", percentage: 3 },\n   243→        \"Gonial Angle\": { direction: \"decrease\", percentage: 2 }\n   244→      },\n   245→      pillars: [\"bone_structure\", \"posture\", \"long_term\"]\n   246→    }\n   247→  },\n   248→  {\n   249→    id: \"rhinoplasty\",\n   250→    title: \"Rhinoplasty\",\n   251→    trigger_rules: {\n   252→      metrics: [\"Nasal Projection\", \"Nasal W to H Ratio\", \"Nasolabial Angle\"],\n   253→      condition: \"OR\",\n   254→      thresholds: {\n   255→        \"Nasal Projection\": { operator: \">\", value: 0.75 },\n   256→        \"Nasal W to H Ratio\": { operator: \">\", value: 0.85 },\n   257→        \"Nasolabial Angle\": { operator: \"<\", value: 85.0 }\n   258→      }\n   259→    },\n   260→    content: {\n   261→      description: \"Comprehensive nasal surgery: dorsal hump reduction, osteotomies for width correction, tip plasty for bulbous refinement, alarplasty for alar base narrowing, cephalic trim for tip rotation, septoplasty for deviation. Can address nasal index, nasolabial angle, nasofrontal angle, and tip projection.\",\n   262→      cost_min: 5000,\n   263→      cost_max: 15000,\n   264→      time_min: \"6 months\",\n   265→      time_max: \"12 months\",\n   266→      risks: \"Infection, asymmetry, breathing issues, revision surgery.\",\n   267→      citations: [\"Rohrich RJ et al., 2010\", \"Foda HM, 2008\"],\n   268→      tags: [\"Surgical\"],\n   269→      priority_score: 5,\n   270→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n   271→      ratios_impacted: {\n   272→        \"Nasal Projection\": { direction: \"decrease\", percentage: 10 },\n   273→        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 8 },\n   274→        \"Nasolabial Angle\": { direction: \"increase\", percentage: 12 },\n   275→        \"Nasal Index\": { direction: \"decrease\", percentage: 6 }\n   276→      },\n   277→      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n   278→    }\n   279→  },\n   280→  {\n   281→    id: \"genioplasty\",\n   282→    title: \"Sliding Genioplasty (Chin Surgery)\",\n   283→    trigger_rules: {\n   284→      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\"],\n   285→      condition: \"OR\",\n   286→      thresholds: {\n   287→        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.5 },\n   288→        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 15.0 }\n   289→      }\n   290→    },\n   291→    content: {\n   292→      description: \"Osseous genioplasty: horizontal advancement or setback of the chin via osteotomy and titanium plate fixation. Can also adjust vertical height (reduction/augmentation) and transverse width. Alternative: alloplastic chin implant (silicone/Medpor) for pure augmentation. Improves chin-philtrum ratio and profile convexity.\",\n   293→      cost_min: 4000,\n   294→      cost_max: 12000,\n   295→      time_min: \"3 months\",\n   296→      time_max: \"12 months\",\n   297→      risks: \"Numbness, infection, asymmetry.\",\n   298→      citations: [\"Park JH et al., 2018\"],\n   299→      tags: [\"Surgical\"],\n   300→      priority_score: 5,\n   301→      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n   302→      ratios_impacted: {\n   303→        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 20 },\n   304→        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 15 },\n   305→        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 5 }\n   306→      },\n   307→      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n   308→    }\n   309→  },\n   310→  {\n   311→    id: \"canthoplasty\",\n   312→    title: \"Canthoplasty (Eye Corner Surgery)\",\n   313→    trigger_rules: {\n   314→      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n   315→      condition: \"AND\",\n   316→      thresholds: {\n   317→        \"Lateral Canthal Tilt\": { operator: \"<\", value: 4.0 },\n   318→        \"Eye Aspect Ratio\": { operator: \"<\", value: 2.8 }\n   319→      }\n   320→    },\n   321→    content: {\n   322→      description: \"Lateral canthoplasty or canthopexy: surgical elevation and fixation of the lateral canthal tendon to increase positive canthal tilt angle. Techniques include tarsal strip, lateral canthal suspension, or almond eye surgery. Can be combined with lower blepharoplasty. Addresses negative canthal tilt and downturned eye appearance.\",\n   323→      cost_min: 3000,\n   324→      cost_max: 8000,\n   325→      time_min: \"2 months\",\n   326→      time_max: \"6 months\",\n   327→      risks: \"Scarring, asymmetry, dry eyes.\",\n   328→      citations: [\"Rhee SC et al., 2017\", \"Chen WP, 2016\"],\n   329→      tags: [\"Surgical\"],\n   330→      priority_score: 4,\n   331→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n   332→      ratios_impacted: {\n   333→        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 40 },\n   334→        \"Eye Aspect Ratio\": { direction: \"increase\", percentage: 10 }\n   335→      },\n   336→      pillars: [\"youthfulness\", \"alertness\", \"femininity\"]\n   337→    }\n   338→  },\n   339→  {\n   340→    id: \"brow_lift\",\n   341→    title: \"Brow Lift / Browridge Enhancement\",\n   342→    trigger_rules: {\n   343→      metrics: [\"Eyebrow Low Setedness\", \"Browridge Inclination Angle\"],\n   344→      condition: \"OR\",\n   345→      thresholds: {\n   346→        \"Eyebrow Low Setedness\": { operator: \">\", value: 2.0 },\n   347→        \"Browridge Inclination Angle\": { operator: \"<\", value: 10.0 }\n   348→      }\n   349→    },\n   350→    content: {\n   351→      description: \"Brow elevation via endoscopic browlift, temporal lift, or direct browplasty to reduce hooding and increase eyebrow height. For browridge: supraorbital rim augmentation with PMMA, hydroxyapatite paste, or custom implants. Botox for brow arch shaping. Addresses low-set brows and flat browridge inclination.\",\n   352→      cost_min: 1500,\n   353→      cost_max: 10000,\n   354→      time_min: \"1 month\",\n   355→      time_max: \"6 months\",\n   356→      risks: \"Asymmetry, numbness, unnatural appearance.\",\n   357→      citations: [\"Mendelson B et al., 2015\"],\n   358→      tags: [\"Surgical\", \"Minimally Invasive\"],\n   359→      priority_score: 3,\n   360→      effectiveness: { level: 'medium', score: 4, confidence: 0.75 },\n   361→      ratios_impacted: {\n   362→        \"Eyebrow Low Setedness\": { direction: \"decrease\", percentage: 30 },\n   363→        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 20 }\n   364→      },\n   365→      pillars: [\"youthfulness\", \"masculinity\", \"upper_third\"]\n   366→    }\n   367→  },\n   368→  // ============================================\n   369→  // NEW PROCEDURES FROM FACEIQ PARITY\n   370→  // ============================================\n   371→  {\n   372→    id: \"kybella\",\n   373→    title: \"Kybella (Double Chin Removal)\",\n   374→    trigger_rules: {\n   375→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   376→      condition: \"OR\",\n   377→      thresholds: {\n   378→        \"Submental Cervical Angle\": { operator: \">\", value: 130.0 },\n   379→        \"Neck Width\": { operator: \">\", value: 95.0 }\n   380→      }\n   381→    },\n   382→    content: {\n   383→      description: \"Injectable deoxycholic acid (Kybella/ATX-101) to permanently dissolve submental fat. Multiple sessions required (2-6 treatments, 4-6 weeks apart). Destroys fat cell membranes, eliminating double chin without surgery. FDA-approved for moderate-to-severe submental fullness.\",\n   384→      cost_min: 1200,\n   385→      cost_max: 3000,\n   386→      time_min: \"2 months\",\n   387→      time_max: \"6 months\",\n   388→      risks: \"Swelling, bruising, numbness, pain, nerve injury causing asymmetric smile, asymmetry, difficulty swallowing.\",\n   389→      citations: [\"Jones DH et al., 2016\", \"Ascher B et al., 2017\"],\n   390→      tags: [\"Minimally Invasive\"],\n   391→      priority_score: 3,\n   392→      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n   393→      ratios_impacted: {\n   394→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n   395→        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n   396→      },\n   397→      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n   398→    }\n   399→  },\n   400→  {\n   401→    id: \"cryolipolysis\",\n   402→    title: \"Cryolipolysis (Fat Freezing)\",\n   403→    trigger_rules: {\n   404→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   405→      condition: \"OR\",\n   406→      thresholds: {\n   407→        \"Submental Cervical Angle\": { operator: \">\", value: 125.0 },\n   408→        \"Neck Width\": { operator: \">\", value: 90.0 }\n   409→      }\n   410→    },\n   411→    content: {\n   412→      description: \"Non-invasive fat reduction via controlled cooling (CoolSculpting). Targets stubborn subcutaneous fat without surgery by crystallizing fat cells which are then naturally eliminated. FDA-cleared for submental area, flanks, abdomen. Results visible in 2-4 months.\",\n   413→      cost_min: 750,\n   414→      cost_max: 2500,\n   415→      time_min: \"2 months\",\n   416→      time_max: \"4 months\",\n   417→      risks: \"Temporary erythema/swelling, bruising, numbness/paresthesia, pain, paradoxical adipose hyperplasia (rare), frostbite, hyperpigmentation.\",\n   418→      citations: [\"Ingargiola MJ et al., 2015\", \"Kilmer SL et al., 2017\"],\n   419→      tags: [\"Minimally Invasive\"],\n   420→      priority_score: 2,\n   421→      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n   422→      ratios_impacted: {\n   423→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 12 },\n   424→        \"Neck Width\": { direction: \"decrease\", percentage: 8 }\n   425→      },\n   426→      pillars: [\"definition\", \"non_invasive\", \"neck\"]\n   427→    }\n   428→  },\n   429→  {\n   430→    id: \"chin_implant\",\n   431→    title: \"Chin Implant (Mentoplasty)\",\n   432→    trigger_rules: {\n   433→      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\", \"Facial Convexity\"],\n   434→      condition: \"OR\",\n   435→      thresholds: {\n   436→        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.6 },\n   437→        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 12.0 },\n   438→        \"Facial Convexity\": { operator: \"<\", value: 165.0 }\n   439→      }\n   440→    },\n   441→    content: {\n   442→      description: \"Alloplastic chin augmentation using silicone or Medpor implants placed through submental or intraoral incision. Provides permanent chin projection and width enhancement. Alternative to sliding genioplasty for pure augmentation without bone cutting. Custom implants available for precise contouring.\",\n   443→      cost_min: 3000,\n   444→      cost_max: 8000,\n   445→      time_min: \"2 weeks\",\n   446→      time_max: \"3 months\",\n   447→      risks: \"Infection, implant migration, bone erosion, asymmetry, numbness, capsular contracture, implant extrusion.\",\n   448→      citations: [\"Yaremchuk MJ, 2013\", \"Binder WJ et al., 2008\"],\n   449→      tags: [\"Surgical\"],\n   450→      priority_score: 4,\n   451→      effectiveness: { level: 'high', score: 4, confidence: 0.88 },\n   452→      ratios_impacted: {\n   453→        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 18 },\n   454→        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 12 },\n   455→        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 4 }\n   456→      },\n   457→      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n   458→    }\n   459→  },\n   460→  {\n   461→    id: \"buccal_fat_removal\",\n   462→    title: \"Buccal Fat Removal (Bichectomy)\",\n   463→    trigger_rules: {\n   464→      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n   465→      condition: \"AND\",\n   466→      thresholds: {\n   467→        \"Cheekbone Height\": { operator: \"<\", value: 70.0 },\n   468→        \"Face Width to Height Ratio\": { operator: \">\", value: 1.55 }\n   469→      }\n   470→    },\n   471→    content: {\n   472→      description: \"Surgical excision of buccal fat pads through intraoral incision to slim the lower cheeks and enhance facial angularity. Creates more defined cheekbone-to-jaw contour. Best for patients with naturally round faces at low body fat. Results are permanent and irreversible.\",\n   473→      cost_min: 2500,\n   474→      cost_max: 6000,\n   475→      time_min: \"2 weeks\",\n   476→      time_max: \"6 months\",\n   477→      risks: \"Facial nerve damage, asymmetry, over-resection causing gaunt appearance, infection, hematoma, parotid duct injury.\",\n   478→      citations: [\"Tarallo M et al., 2018\", \"Moura LB et al., 2018\"],\n   479→      tags: [\"Surgical\"],\n   480→      priority_score: 3,\n   481→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n   482→      ratios_impacted: {\n   483→        \"Cheekbone Height\": { direction: \"increase\", percentage: 6 },\n   484→        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 3 }\n   485→      },\n   486→      pillars: [\"angularity\", \"definition\", \"bone_structure\"]\n   487→    }\n   488→  },\n   489→  {\n   490→    id: \"alarplasty\",\n   491→    title: \"Alarplasty (Alar Base Reduction)\",\n   492→    trigger_rules: {\n   493→      metrics: [\"Nasal W to H Ratio\", \"Alar Base Width\"],\n   494→      condition: \"OR\",\n   495→      thresholds: {\n   496→        \"Nasal W to H Ratio\": { operator: \">\", value: 0.80 },\n   497→        \"Alar Base Width\": { operator: \">\", value: 35.0 }\n   498→      }\n   499→    },\n   500→    content: {\n   501→      description: \"Surgical narrowing of the nasal alar base through wedge excision. Reduces nostril width and alar flare. Can be performed alone or combined with rhinoplasty. Weir excision for nostril sill, alar wedge for flaring. Hidden incision placement minimizes visible scarring.\",\n   502→      cost_min: 2000,\n   503→      cost_max: 5000,\n   504→      time_min: \"2 weeks\",\n   505→      time_max: \"3 months\",\n   506→      risks: \"Visible scarring, asymmetry, over-narrowing, nostril distortion, poor wound healing.\",\n   507→      citations: [\"Rohrich RJ et al., 2009\", \"Ingels K et al., 2015\"],\n   508→      tags: [\"Surgical\"],\n   509→      priority_score: 3,\n   510→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n   511→      ratios_impacted: {\n   512→        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 12 },\n   513→        \"Nasal Index\": { direction: \"decrease\", percentage: 8 }\n   514→      },\n   515→      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n   516→    }\n   517→  },\n   518→  {\n   519→    id: \"canthopexy\",\n   520→    title: \"Canthopexy (Lateral Canthal Suspension)\",\n   521→    trigger_rules: {\n   522→      metrics: [\"Lateral Canthal Tilt\", \"Lower Eyelid Position\"],\n   523→      condition: \"OR\",\n   524→      thresholds: {\n   525→        \"Lateral Canthal Tilt\": { operator: \"<\", value: 3.0 },\n   526→        \"Lower Eyelid Position\": { operator: \">\", value: 1.5 }\n   527→      }\n   528→    },\n   529→    content: {\n   530→      description: \"Suture suspension of the lateral canthal tendon to tighten lower eyelid and prevent sagging. Less invasive than canthoplasty (no tendon cutting). Supports eye shape, prevents scleral show, and can provide subtle upward tilt. Often combined with blepharoplasty.\",\n   531→      cost_min: 2500,\n   532→      cost_max: 6000,\n   533→      time_min: \"2 weeks\",\n   534→      time_max: \"3 months\",\n   535→      risks: \"Asymmetry, under/overcorrection, dry eyes, ectropion, scarring, temporary swelling.\",\n   536→      citations: [\"Hester TR et al., 2000\", \"Codner MA et al., 2008\"],\n   537→      tags: [\"Surgical\"],\n   538→      priority_score: 3,\n   539→      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n   540→      ratios_impacted: {\n   541→        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 20 }\n   542→      },\n   543→      pillars: [\"youthfulness\", \"alertness\", \"eye_area\"]\n   544→    }\n   545→  },\n   546→  {\n   547→    id: \"neck_lift\",\n   548→    title: \"Neck Lift (Platysmaplasty)\",\n   549→    trigger_rules: {\n   550→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   551→      condition: \"OR\",\n   552→      thresholds: {\n   553→        \"Submental Cervical Angle\": { operator: \">\", value: 135.0 },\n   554→        \"Neck Width\": { operator: \">\", value: 100.0 }\n   555→      }\n   556→    },\n   557→    content: {\n   558→      description: \"Comprehensive neck rejuvenation: platysma muscle tightening (platysmaplasty), submental liposuction, excess skin removal, and possible digastric muscle reduction. Addresses turkey neck, platysmal banding, submental fullness, and skin laxity. Can include submental tuck or deep plane techniques.\",\n   559→      cost_min: 5000,\n   560→      cost_max: 15000,\n   561→      time_min: \"3 weeks\",\n   562→      time_max: \"6 months\",\n   563→      risks: \"Hematoma, nerve injury, skin necrosis, asymmetry, visible scarring, skin irregularities, prolonged swelling.\",\n   564→      citations: [\"Feldman JJ, 2006\", \"Ellenbogen R et al., 2014\"],\n   565→      tags: [\"Surgical\"],\n   566→      priority_score: 4,\n   567→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n   568→      ratios_impacted: {\n   569→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 25 },\n   570→        \"Neck Width\": { direction: \"decrease\", percentage: 15 }\n   571→      },\n   572→      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n   573→    }\n   574→  },\n   575→  {\n   576→    id: \"septoplasty\",\n   577→    title: \"Septoplasty (Deviated Septum Correction)\",\n   578→    trigger_rules: {\n   579→      metrics: [\"Nasal Deviation\", \"Nasal Symmetry\"],\n   580→      condition: \"OR\",\n   581→      thresholds: {\n   582→        \"Nasal Deviation\": { operator: \">\", value: 5.0 },\n   583→        \"Nasal Symmetry\": { operator: \"<\", value: 0.90 }\n   584→      }\n   585→    },\n   586→    content: {\n   587→      description: \"Surgical correction of deviated nasal septum to improve nasal airflow and symmetry. Performed through closed endonasal approach. Can be functional (breathing) or cosmetic (straightening). Often combined with rhinoplasty (septorhinoplasty) for comprehensive nasal reshaping.\",\n   588→      cost_min: 3000,\n   589→      cost_max: 10000,\n   590→      time_min: \"1 week\",\n   591→      time_max: \"3 months\",\n   592→      risks: \"Septal perforation, persistent deviation, saddle nose, numbness, infection, bleeding, CSF leak (rare).\",\n   593→      citations: [\"Rohrich RJ et al., 2011\", \"Fettman N et al., 2009\"],\n   594→      tags: [\"Surgical\"],\n   595→      priority_score: 2,\n   596→      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n   597→      ratios_impacted: {\n   598→        \"Nasal Deviation\": { direction: \"decrease\", percentage: 80 },\n   599→        \"Nasal Symmetry\": { direction: \"increase\", percentage: 10 }\n   600→      },\n   601→      pillars: [\"symmetry\", \"function\", \"breathing\"]\n   602→    }\n   603→  },\n   604→  {\n   605→    id: \"lip_lift\",\n   606→    title: \"Lip Lift (Bullhorn/Subnasal Lip Lift)\",\n   607→    trigger_rules: {\n   608→      metrics: [\"Philtrum Length\", \"Upper Lip Vermilion Height\", \"Midface Ratio\"],\n   609→      condition: \"OR\",\n   610→      thresholds: {\n   611→        \"Philtrum Length\": { operator: \">\", value: 15.0 },\n   612→        \"Upper Lip Vermilion Height\": { operator: \"<\", value: 7.0 },\n   613→        \"Midface Ratio\": { operator: \">\", value: 1.1 }\n   614→      }\n   615→    },\n   616→    content: {\n   617→      description: \"Surgical shortening of the philtrum by removing skin at the base of the nose (bullhorn excision). Permanently increases upper lip vermilion show and reduces long upper lip appearance. Alternative to filler for long philtrum correction. Scar hidden in nasal base crease.\",\n   618→      cost_min: 3500,\n   619→      cost_max: 8000,\n   620→      time_min: \"2 weeks\",\n   621→      time_max: \"6 months\",\n   622→      risks: \"Visible scarring, asymmetry, over-shortening, distorted nostril base, wound dehiscence, prolonged swelling.\",\n   623→      citations: [\"Austin HW, 1986\", \"Santanché P et al., 2014\"],\n   624→      tags: [\"Surgical\"],\n   625→      priority_score: 4,\n   626→      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n   627→      ratios_impacted: {\n   628→        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 25 },\n   629→        \"Midface Ratio\": { direction: \"decrease\", percentage: 8 }\n   630→      },\n   631→      pillars: [\"youthfulness\", \"harmony\", \"lip_area\"]\n   632→    }\n   633→  },\n   634→  {\n   635→    id: \"jaw_implants\",\n   636→    title: \"Jaw Implants (Mandibular Augmentation)\",\n   637→    trigger_rules: {\n   638→      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Ramus to Mandible Ratio\"],\n   639→      condition: \"OR\",\n   640→      thresholds: {\n   641→        \"Bigonial Width\": { operator: \"<\", value: 85.0 },\n   642→        \"Gonial Angle\": { operator: \">\", value: 130.0 },\n   643→        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.45 }\n   644→      }\n   645→    },\n   646→    content: {\n   647→      description: \"Alloplastic mandibular augmentation using silicone, Medpor, or custom PEEK implants. Enhances jaw width (bigonial), gonial angle definition, and mandibular border projection. Placed through intraoral incision. Custom wraparound implants available for comprehensive jaw enhancement.\",\n   648→      cost_min: 6000,\n   649→      cost_max: 20000,\n   650→      time_min: \"3 weeks\",\n   651→      time_max: \"6 months\",\n   652→      risks: \"Infection, implant migration, bone erosion, asymmetry, mental nerve injury, capsular contracture, masseter atrophy.\",\n   653→      citations: [\"Yaremchuk MJ, 2006\", \"Rao LK et al., 2011\"],\n   654→      tags: [\"Surgical\"],\n   655→      priority_score: 5,\n   656→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n   657→      ratios_impacted: {\n   658→        \"Bigonial Width\": { direction: \"increase\", percentage: 12 },\n   659→        \"Gonial Angle\": { direction: \"decrease\", percentage: 8 },\n   660→        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 6 }\n   661→      },\n   662→      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n   663→    }\n   664→  },\n   665→  {\n   666→    id: \"midface_implants\",\n   667→    title: \"Midface Implants (Malar/Submalar)\",\n   668→    trigger_rules: {\n   669→      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Face Width to Height Ratio\"],\n   670→      condition: \"OR\",\n   671→      thresholds: {\n   672→        \"Cheekbone Height\": { operator: \"<\", value: 55.0 },\n   673→        \"Midface Ratio\": { operator: \">\", value: 1.15 },\n   674→        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.65 }\n   675→      }\n   676→    },\n   677→    content: {\n   678→      description: \"Alloplastic augmentation of the malar (cheekbone) and/or submalar region using silicone or Medpor implants. Enhances midface projection, cheekbone prominence, and overall facial width. Custom implants available. Alternative to fat grafting for permanent midface volume.\",\n   679→      cost_min: 5000,\n   680→      cost_max: 15000,\n   681→      time_min: \"3 weeks\",\n   682→      time_max: \"6 months\",\n   683→      risks: \"Infection, implant migration, asymmetry, nerve injury (infraorbital), bone erosion, capsular contracture, visibility.\",\n   684→      citations: [\"Terino EO, 2000\", \"Binder WJ et al., 2007\"],\n   685→      tags: [\"Surgical\"],\n   686→      priority_score: 4,\n   687→      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n   688→      ratios_impacted: {\n   689→        \"Cheekbone Height\": { direction: \"increase\", percentage: 10 },\n   690→        \"Midface Ratio\": { direction: \"decrease\", percentage: 6 },\n   691→        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 4 }\n   692→      },\n   693→      pillars: [\"angularity\", \"harmony\", \"bone_structure\"]\n   694→    }\n   695→  },\n   696→  {\n   697→    id: \"submental_liposuction\",\n   698→    title: \"Submental Liposuction\",\n   699→    trigger_rules: {\n   700→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   701→      condition: \"AND\",\n   702→      thresholds: {\n   703→        \"Submental Cervical Angle\": { operator: \">\", value: 120.0 },\n   704→        \"Neck Width\": { operator: \">\", value: 85.0 }\n   705→      }\n   706→    },\n   707→    content: {\n   708→      description: \"Surgical removal of excess fat beneath the chin via small cannula through submental incision. Refines jawline contour and improves neck definition. Can be combined with skin tightening or platysmaplasty. Best for younger patients with good skin elasticity.\",\n   709→      cost_min: 2000,\n   710→      cost_max: 5000,\n   711→      time_min: \"1 week\",\n   712→      time_max: \"3 months\",\n   713→      risks: \"Contour irregularities, asymmetry, nerve injury, skin laxity, hematoma, seroma, prolonged swelling.\",\n   714→      citations: [\"Rohrich RJ et al., 2007\", \"Giampapa VC et al., 2000\"],\n   715→      tags: [\"Surgical\"],\n   716→      priority_score: 3,\n   717→      effectiveness: { level: 'medium', score: 4, confidence: 0.82 },\n   718→      ratios_impacted: {\n   719→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n   720→        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n   721→      },\n   722→      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n   723→    }\n   724→  },\n   725→  {\n   726→    id: \"submentoplasty\",\n   727→    title: \"Submentoplasty (Submental Tuck)\",\n   728→    trigger_rules: {\n   729→      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n   730→      condition: \"OR\",\n   731→      thresholds: {\n   732→        \"Submental Cervical Angle\": { operator: \">\", value: 140.0 },\n   733→        \"Neck Width\": { operator: \">\", value: 105.0 }\n   734→      }\n   735→    },\n   736→    content: {\n   737→      description: \"Direct excision of submental skin/fat with platysma muscle plication through small chin incision. Tightens central neck muscles and removes excess tissue. More aggressive than liposuction alone, less extensive than full neck lift. Also called cervicoplasty.\",\n   738→      cost_min: 3500,\n   739→      cost_max: 8000,\n   740→      time_min: \"2 weeks\",\n   741→      time_max: \"4 months\",\n   742→      risks: \"Visible scarring, hematoma, nerve injury, skin necrosis, asymmetry, contour irregularities.\",\n   743→      citations: [\"Giampapa VC et al., 2000\", \"Ellenbogen R et al., 2014\"],\n   744→      tags: [\"Surgical\"],\n   745→      priority_score: 4,\n   746→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n   747→      ratios_impacted: {\n   748→        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 20 },\n   749→        \"Neck Width\": { direction: \"decrease\", percentage: 12 }\n   750→      },\n   751→      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n   752→    }\n   753→  },\n   754→  {\n   755→    id: \"fat_grafting\",\n   756→    title: \"Fat Grafting (Facial Lipofilling)\",\n   757→    trigger_rules: {\n   758→      metrics: [\"Cheekbone Height\", \"Under-Eye Hollowness\", \"Temple Volume\"],\n   759→      condition: \"OR\",\n   760→      thresholds: {\n   761→        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n   762→        \"Under-Eye Hollowness\": { operator: \">\", value: 3.0 },\n   763→        \"Temple Volume\": { operator: \"<\", value: 0.8 }\n   764→      }\n   765→    },\n   766→    content: {\n   767→      description: \"Autologous fat transfer: fat harvested from body (abdomen, thighs), processed, and injected for facial volumization. Microfat for volume (cheeks, temples, jawline), nanofat for skin rejuvenation. Natural permanent filler with 40-60% long-term retention. Multiple sessions may be needed.\",\n   768→      cost_min: 4000,\n   769→      cost_max: 12000,\n   770→      time_min: \"1 month\",\n   771→      time_max: \"6 months\",\n   772→      risks: \"Fat resorption, asymmetry, lumpiness, oil cysts, infection, embolism (rare), over/under-correction.\",\n   773→      citations: [\"Coleman SR, 2006\", \"Khouri RK et al., 2014\"],\n   774→      tags: [\"Surgical\"],\n   775→      priority_score: 3,\n   776→      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n   777→      ratios_impacted: {\n   778→        \"Cheekbone Height\": { direction: \"increase\", percentage: 5 },\n   779→        \"Tear Trough Depth\": { direction: \"decrease\", percentage: 40 }\n   780→      },\n   781→      pillars: [\"youthfulness\", \"volume\", \"natural\"]\n   782→    }\n   783→  },\n   784→  {\n   785→    id: \"supraorbital_implants\",\n   786→    title: \"Supraorbital Rim Implants (Browridge)\",\n   787→    trigger_rules: {\n   788→      metrics: [\"Browridge Inclination Angle\", \"Supraorbital Projection\"],\n   789→      condition: \"OR\",\n   790→      thresholds: {\n   791→        \"Browridge Inclination Angle\": { operator: \"<\", value: 8.0 },\n   792→        \"Supraorbital Projection\": { operator: \"<\", value: 0.85 }\n   793→      }\n   794→    },\n   795→    content: {\n   796→      description: \"Custom or standard implants placed along the supraorbital rim to enhance browridge projection and definition. Creates more prominent brow bone for masculine appearance. Often custom-designed from CT scans. Placed through coronal or endoscopic approach.\",\n   797→      cost_min: 8000,\n   798→      cost_max: 25000,\n   799→      time_min: \"3 weeks\",\n   800→      time_max: \"6 months\",\n   801→      risks: \"Infection, implant migration, asymmetry, nerve injury, frontal sinus violation, visible/palpable implant, bone erosion.\",\n   802→      citations: [\"Yaremchuk MJ, 2003\", \"Spiegel JH, 2011\"],\n   803→      tags: [\"Surgical\"],\n   804→      priority_score: 3,\n   805→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n   806→      ratios_impacted: {\n   807→        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 30 }\n   808→      },\n   809→      pillars: [\"masculinity\", \"bone_structure\", \"upper_third\"]\n   810→    }\n   811→  },\n   812→  {\n   813→    id: \"lip_reduction\",\n   814→    title: \"Lip Reduction Surgery (Reduction Cheiloplasty)\",\n   815→    trigger_rules: {\n   816→      metrics: [\"Lip Thickness\", \"Lower Lip to Upper Lip Ratio\"],\n   817→      condition: \"OR\",\n   818→      thresholds: {\n   819→        \"Lip Thickness\": { operator: \">\", value: 18.0 },\n   820→        \"Lower Lip to Upper Lip Ratio\": { operator: \">\", value: 2.2 }\n   821→      }\n   822→    },\n   823→    content: {\n   824→      description: \"Surgical removal of excess lip tissue through incision along wet-dry border to reduce lip volume and projection. Improves proportion between lips and surrounding features. Separate procedures for upper and lower lips. Permanent alternative to reversible fillers.\",\n   825→      cost_min: 2500,\n   826→      cost_max: 6000,\n   827→      time_min: \"2 weeks\",\n   828→      time_max: \"3 months\",\n   829→      risks: \"Visible scarring, asymmetry, over-reduction, numbness, altered sensation, wound dehiscence.\",\n   830→      citations: [\"Fanous N, 2007\", \"Garcia RM et al., 2016\"],\n   831→      tags: [\"Surgical\"],\n   832→      priority_score: 2,\n   833→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n   834→      ratios_impacted: {\n   835→        \"Lower Lip to Upper Lip Ratio\": { direction: \"decrease\", percentage: 20 }\n   836→      },\n   837→      pillars: [\"harmony\", \"balance\", \"lip_area\"]\n   838→    }\n   839→  },\n   840→  {\n   841→    id: \"jaw_reduction\",\n   842→    title: \"Jaw Reduction Surgery (V-Line Surgery)\",\n   843→    trigger_rules: {\n   844→      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Face Width to Height Ratio\"],\n   845→      condition: \"AND\",\n   846→      thresholds: {\n   847→        \"Bigonial Width\": { operator: \">\", value: 120.0 },\n   848→        \"Gonial Angle\": { operator: \"<\", value: 115.0 },\n   849→        \"Face Width to Height Ratio\": { operator: \">\", value: 1.65 }\n   850→      }\n   851→    },\n   852→    content: {\n   853→      description: \"Mandibular angle resection and contouring to slim and feminize the lower face, creating V-line effect. Osteotomy of mandibular angle, possible chin tapering (T-osteotomy), and masseter reduction. Popular in East Asian aesthetic surgery. Performed through intraoral approach.\",\n   854→      cost_min: 8000,\n   855→      cost_max: 25000,\n   856→      time_min: \"1 month\",\n   857→      time_max: \"6 months\",\n   858→      risks: \"Facial nerve injury, asymmetry, over-reduction, bone necrosis, infection, prolonged swelling, numbness.\",\n   859→      citations: [\"Yang DB et al., 2014\", \"Jin H et al., 2013\"],\n   860→      tags: [\"Surgical\"],\n   861→      priority_score: 4,\n   862→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n   863→      ratios_impacted: {\n   864→        \"Bigonial Width\": { direction: \"decrease\", percentage: 15 },\n   865→        \"Gonial Angle\": { direction: \"increase\", percentage: 10 },\n   866→        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 8 }\n   867→      },\n   868→      pillars: [\"femininity\", \"harmony\", \"bone_structure\"]\n   869→    }\n   870→  },\n   871→  {\n   872→    id: \"bimaxillary_osteotomy\",\n   873→    title: \"Bimaxillary Osteotomy (Double Jaw Surgery)\",\n   874→    trigger_rules: {\n   875→      metrics: [\"Facial Convexity\", \"Recession Relative to Frankfort Plane\", \"Midface Ratio\"],\n   876→      condition: \"AND\",\n   877→      thresholds: {\n   878→        \"Facial Convexity\": { operator: \"<\", value: 160.0 },\n   879→        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 18.0 },\n   880→        \"Midface Ratio\": { operator: \">\", value: 1.2 }\n   881→      }\n   882→    },\n   883→    content: {\n   884→      description: \"Simultaneous repositioning of both maxilla (Le Fort I) and mandible (BSSO) to correct facial disharmony and skeletal malocclusion. Addresses severe class II/III relationships, facial asymmetry, and vertical excess. Requires orthodontic preparation. Most comprehensive facial skeletal surgery.\",\n   885→      cost_min: 20000,\n   886→      cost_max: 60000,\n   887→      time_min: \"3 months\",\n   888→      time_max: \"12 months\",\n   889→      risks: \"Nerve injury, infection, relapse, TMJ dysfunction, malocclusion, bleeding, airway compromise, need for revision.\",\n   890→      citations: [\"Proffit WR et al., 2013\", \"Wolford LM et al., 2003\"],\n   891→      tags: [\"Surgical\"],\n   892→      priority_score: 5,\n   893→      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n   894→      ratios_impacted: {\n   895→        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 15 },\n   896→        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 20 },\n   897→        \"Midface Ratio\": { direction: \"decrease\", percentage: 10 }\n   898→      },\n   899→      pillars: [\"profile\", \"bone_structure\", \"comprehensive\"]\n   900→    }\n   901→  }\n   902→];\n   903→\n   904→// ============================================\n   905→// ADVICE ENGINE CLASS\n   906→// ============================================\n   907→\n   908→export class AdviceEngine {\n   909→  private plans: RawPlan[];\n   910→\n   911→  constructor(customPlans?: RawPlan[]) {\n   912→    this.plans = customPlans || PLANS;\n   913→  }\n   914→\n   915→  /**\n   916→   * Check if a single threshold condition is met\n   917→   */\n   918→  private checkThreshold(userValue: number, operator: '<' | '>', thresholdValue: number): boolean {\n   919→    if (operator === '<') {\n   920→      return userValue < thresholdValue;\n   921→    }\n   922→    return userValue > thresholdValue;\n   923→  }\n   924→\n   925→  /**\n   926→   * Evaluate trigger rules against user metrics\n   927→   */\n   928→  private evaluateTriggerRules(\n   929→    triggerRules: TriggerRules,\n   930→    metricsDict: Record<string, number>\n   931→  ): { isTriggered: boolean; triggeredMetrics: TriggerResult[] } {\n   932→    const { metrics, thresholds, condition } = triggerRules;\n   933→    const triggeredMetrics: TriggerResult[] = [];\n   934→    const results: boolean[] = [];\n   935→\n   936→    for (const metricName of metrics) {\n   937→      if (!(metricName in metricsDict)) continue;\n   938→      if (!(metricName in thresholds)) continue;\n   939→\n   940→      const userValue = metricsDict[metricName];\n   941→      const { operator, value: thresholdValue } = thresholds[metricName];\n   942→      const isMet = this.checkThreshold(userValue, operator, thresholdValue);\n   943→\n   944→      if (isMet) {\n   945→        triggeredMetrics.push({\n   946→          metric: metricName,\n   947→          value: userValue,\n   948→          threshold: thresholdValue,\n   949→          operator\n   950→        });\n   951→      }\n   952→\n   953→      results.push(isMet);\n   954→    }\n   955→\n   956→    const isTriggered = condition === 'AND'\n   957→      ? results.length > 0 && results.every(r => r)\n   958→      : results.some(r => r);\n   959→\n   960→    return { isTriggered, triggeredMetrics };\n   961→  }\n   962→\n   963→  /**\n   964→   * Get all recommendations that match the user's metrics\n   965→   *\n   966→   * @param metricsDict - Raw metric values\n   967→   * @param severityDict - Severity classifications (ideal/good/moderate/severe) for each metric\n   968→   *                       If a metric is 'ideal', it will NOT trigger remediation plans\n   969→   */\n   970→  getRecommendations(\n   971→    metricsDict: Record<string, number>,\n   972→    severityDict?: Record<string, string>\n   973→  ): Plan[] {\n   974→    const recommendations: Plan[] = [];\n   975→\n   976→    for (const rawPlan of this.plans) {\n   977→      const { isTriggered, triggeredMetrics } = this.evaluateTriggerRules(\n   978→        rawPlan.trigger_rules,\n   979→        metricsDict\n   980→      );\n   981→\n   982→      // If severity data is provided, filter out metrics that are already ideal\n   983→      if (isTriggered && severityDict) {\n   984→        // Check if ALL triggered metrics are outside ideal range\n   985→        const hasActualFlaw = triggeredMetrics.some(tm => {\n   986→          const severity = severityDict[tm.metric];\n   987→          // Only trigger if severity is NOT ideal (i.e., it's good/moderate/severe)\n   988→          return severity && severity !== 'ideal';\n   989→        });\n   990→\n   991→        // Skip this plan if all triggered metrics are already ideal\n   992→        if (!hasActualFlaw) {\n   993→          continue;\n   994→        }\n   995→      }\n   996→\n   997→      if (isTriggered) {\n   998→        recommendations.push({\n   999→          id: rawPlan.id,\n  1000→          title: rawPlan.title,\n  1001→          content: {\n  1002→            description: rawPlan.content.description,\n  1003→            cost_min: rawPlan.content.cost_min,\n  1004→            cost_max: rawPlan.content.cost_max,\n  1005→            time_min: rawPlan.content.time_min || 'Unknown',\n  1006→            time_max: rawPlan.content.time_max || 'Unknown',\n  1007→            risks: rawPlan.content.risks || 'Consult a professional.',\n  1008→            citations: rawPlan.content.citations || [],\n  1009→            tags: rawPlan.content.tags\n  1010→          },\n  1011→          trigger_reason: triggeredMetrics\n  1012→        });\n  1013→      }\n  1014→    }\n  1015→\n  1016→    return recommendations;\n  1017→  }\n  1018→\n  1019→  /**\n  1020→   * Get recommendations sorted by cost (cheapest first)\n  1021→   */\n  1022→  getRecommendationsByCost(\n  1023→    metricsDict: Record<string, number>,\n  1024→    severityDict?: Record<string, string>\n  1025→  ): Plan[] {\n  1026→    return this.getRecommendations(metricsDict, severityDict).sort(\n  1027→      (a, b) => a.content.cost_min - b.content.cost_min\n  1028→    );\n  1029→  }\n  1030→\n  1031→  /**\n  1032→   * Get recommendations grouped by phase/tag\n  1033→   */\n  1034→  getRecommendationsByPhase(\n  1035→    metricsDict: Record<string, number>,\n  1036→    severityDict?: Record<string, string>\n  1037→  ): Record<string, Plan[]> {\n  1038→    const recommendations = this.getRecommendations(metricsDict, severityDict);\n  1039→    const grouped: Record<string, Plan[]> = {\n  1040→      'Foundational': [],\n  1041→      'Minimally Invasive': [],\n  1042→      'Surgical': []\n  1043→    };\n  1044→\n  1045→    for (const rec of recommendations) {\n  1046→      const tags = rec.content.tags || [];\n  1047→      if (tags.includes('Foundational')) {\n  1048→        grouped['Foundational'].push(rec);\n  1049→      } else if (tags.includes('Surgical')) {\n  1050→        grouped['Surgical'].push(rec);\n  1051→      } else if (tags.includes('Minimally Invasive')) {\n  1052→        grouped['Minimally Invasive'].push(rec);\n  1053→      } else {\n  1054→        grouped['Minimally Invasive'].push(rec); // Default\n  1055→      }\n  1056→    }\n  1057→\n  1058→    return grouped;\n  1059→  }\n  1060→}\n  1061→\n  1062→// ============================================\n  1063→// SINGLETON INSTANCE\n  1064→// ============================================\n  1065→\n  1066→export const adviceEngine = new AdviceEngine();\n  1067→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6a9aa0dc-5600-45bd-8ff1-b9f35f77477b","timestamp":"2025-12-24T20:18:56.992Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts","content":"/**\n * Advice Engine - Client-side implementation matching the Python AdviceEngine\n * Processes plans.json trigger rules against user metrics\n */\n\nimport { Plan } from '@/components/results/cards/PlanActionCard';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface Threshold {\n  operator: '<' | '>';\n  value: number;\n}\n\ninterface TriggerRules {\n  metrics: string[];\n  condition: 'OR' | 'AND';\n  thresholds: Record<string, Threshold>;\n}\n\n// FaceIQ-style effectiveness rating\ninterface Effectiveness {\n  level: 'high' | 'medium' | 'low';\n  score: number;  // 1-5\n  confidence: number;  // 0-1\n}\n\n// How a treatment impacts a specific ratio\ninterface RatioImpact {\n  direction: 'increase' | 'decrease';\n  percentage: number;  // Expected % change\n}\n\ninterface PlanContent {\n  description: string;\n  cost_min: number;\n  cost_max: number;\n  time_min?: string;\n  time_max?: string;\n  risks?: string;\n  citations?: string[];\n  tags?: string[];\n  // FaceIQ parity - new metadata fields\n  priority_score?: number;  // 1-5, higher = more important\n  effectiveness?: Effectiveness;\n  ratios_impacted?: Record<string, RatioImpact>;\n  pillars?: string[];  // e.g., ['angularity', 'harmony', 'symmetry']\n}\n\ninterface RawPlan {\n  id: string;\n  title: string;\n  trigger_rules: TriggerRules;\n  content: PlanContent;\n}\n\ninterface TriggerResult {\n  metric: string;\n  value: number;\n  threshold: number;\n  operator: '<' | '>';\n}\n\n// ============================================\n// PLANS DATA (from plans.json)\n// ============================================\n\nexport const PLANS: RawPlan[] = [\n  {\n    id: \"jaw_fillers\",\n    title: \"Jaw Fillers\",\n    trigger_rules: {\n      metrics: [\"Gonial Angle\", \"Bigonial Width\", \"Ramus to Mandible Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Gonial Angle\": { operator: \">\", value: 128.0 },\n        \"Bigonial Width\": { operator: \"<\", value: 90.0 },\n        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.5 }\n      }\n    },\n    content: {\n      description: \"Injectable dermal fillers (hyaluronic acid or hydroxyapatite) to enhance jawline definition, gonial angle sharpness, and mandibular border projection. Common products: Radiesse, Sculptra, Juvederm Voluma. Targets masseter hollow, prejowl sulcus, and mandibular angle.\",\n      cost_min: 600,\n      cost_max: 2500,\n      time_min: \"6 months\",\n      time_max: \"18 months\",\n      risks: \"Vascular occlusion, asymmetry, swelling.\",\n      citations: [\"Al-Khafaji et al., 2023\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 },\n        \"Bigonial Width\": { direction: \"increase\", percentage: 4 },\n        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 2 }\n      },\n      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"cheekbone_fillers\",\n    title: \"Cheekbone Fillers\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.75 }\n      }\n    },\n    content: {\n      description: \"Malar augmentation via hyaluronic acid fillers placed at the zygomatic arch and submalar region. Products: Juvederm Voluma, Restylane Lyft. Enhances ogee curve, anterior cheek projection, and lateral zygomatic width for improved facial angularity.\",\n      cost_min: 650,\n      cost_max: 2500,\n      time_min: \"6 months\",\n      time_max: \"18 months\",\n      risks: \"Asymmetry, filler migration.\",\n      citations: [\"Trinh & Gupta, 2021\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.85 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 4 },\n        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 2 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 }\n      },\n      pillars: [\"angularity\", \"harmony\", \"youthfulness\"]\n    }\n  },\n  {\n    id: \"beard_growth\",\n    title: \"Beard / Stubble Growth\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Gonial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.8 },\n        \"Gonial Angle\": { operator: \">\", value: 126.0 }\n      }\n    },\n    content: {\n      description: \"Strategic facial hair growth (5-10mm stubble or full beard) to optically enhance jawline definition, camouflage gonial angle softness, and create visual chin projection. Consider minoxidil 5% foam if low coverage. Trim to maintain sharp mandibular border.\",\n      cost_min: 0,\n      cost_max: 20,\n      time_min: \"1 month\",\n      time_max: \"3 months\",\n      risks: \"None\",\n      citations: [\"Dixson et al., 2016\"],\n      tags: [\"Foundational\", \"Free\"],\n      priority_score: 2,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 5 },\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 3 }\n      },\n      pillars: [\"masculinity\", \"camouflage\"]\n    }\n  },\n  {\n    id: \"lip_filler\",\n    title: \"Lip Filler\",\n    trigger_rules: {\n      metrics: [\"Lower Lip to Upper Lip Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lower Lip to Upper Lip Ratio\": { operator: \"<\", value: 1.0 }\n      }\n    },\n    content: {\n      description: \"Lip augmentation via hyaluronic acid fillers (Restylane, Juvederm) to enhance vermillion border, cupid's bow definition, and lip ratio balance. Can target vermillion height, philtral columns, or tubercles. Alternative: surgical lip lift (bullhorn or corner lift) for permanent results.\",\n      cost_min: 500,\n      cost_max: 1200,\n      time_min: \"6 months\",\n      time_max: \"12 months\",\n      risks: \"Migration, bruising.\",\n      citations: [\"Hernandez et al., 2023\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Lower Lip to Upper Lip Ratio\": { direction: \"increase\", percentage: 15 }\n      },\n      pillars: [\"harmony\", \"femininity\", \"youthfulness\"]\n    }\n  },\n  {\n    id: \"weight_loss_protocol\",\n    title: \"Fat Loss Protocol (High Protein + Cardio)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Jaw Slope\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 65.0 },\n        \"Jaw Slope\": { operator: \">\", value: 140.0 }\n      }\n    },\n    content: {\n      description: \"Caloric deficit protocol targeting 8-12% body fat to debloat buccal fat pads and reveal zygomatic, mandibular, and maxillary bone structure. High-protein intake (1.6-2.2g/kg), fasted cardio, and sodium/water management. Consider buccal fat removal surgery if structure remains obscured at low body fat.\",\n      cost_min: 200,\n      cost_max: 1000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"None\",\n      citations: [\"Moon & Koh, 2020\"],\n      tags: [\"Foundational\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 4, confidence: 0.90 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 8 },\n        \"Jaw Slope\": { direction: \"decrease\", percentage: 5 },\n        \"Bigonial Width\": { direction: \"increase\", percentage: 3 }\n      },\n      pillars: [\"angularity\", \"bone_structure\", \"definition\"]\n    }\n  },\n  {\n    id: \"mewing_posture\",\n    title: \"Mewing & Posture Correction\",\n    trigger_rules: {\n      metrics: [\"Midface Ratio\", \"Nasolabial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Midface Ratio\": { operator: \">\", value: 1.05 },\n        \"Nasolabial Angle\": { operator: \"<\", value: 90.0 }\n      }\n    },\n    content: {\n      description: \"Orthotropic tongue posture: entire tongue (posterior third critical) pressed against palate, teeth in light contact, nasal breathing. Aims to stimulate maxillary protraction, improve mandibular posture, and enhance gonial angle over time. Combine with proper head/neck alignment and chin tucks.\",\n      cost_min: 0,\n      cost_max: 0,\n      time_min: \"12 months\",\n      time_max: \"Lifetime\",\n      risks: \"None if performed correctly.\",\n      citations: [\"Mew J. et al., 2014\"],\n      tags: [\"Foundational\", \"Free\"],\n      priority_score: 3,\n      effectiveness: { level: 'low', score: 2, confidence: 0.50 },\n      ratios_impacted: {\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 2 },\n        \"Nasolabial Angle\": { direction: \"increase\", percentage: 3 },\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 2 }\n      },\n      pillars: [\"bone_structure\", \"posture\", \"long_term\"]\n    }\n  },\n  {\n    id: \"rhinoplasty\",\n    title: \"Rhinoplasty\",\n    trigger_rules: {\n      metrics: [\"Nasal Projection\", \"Nasal W to H Ratio\", \"Nasolabial Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal Projection\": { operator: \">\", value: 0.75 },\n        \"Nasal W to H Ratio\": { operator: \">\", value: 0.85 },\n        \"Nasolabial Angle\": { operator: \"<\", value: 85.0 }\n      }\n    },\n    content: {\n      description: \"Comprehensive nasal surgery: dorsal hump reduction, osteotomies for width correction, tip plasty for bulbous refinement, alarplasty for alar base narrowing, cephalic trim for tip rotation, septoplasty for deviation. Can address nasal index, nasolabial angle, nasofrontal angle, and tip projection.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"6 months\",\n      time_max: \"12 months\",\n      risks: \"Infection, asymmetry, breathing issues, revision surgery.\",\n      citations: [\"Rohrich RJ et al., 2010\", \"Foda HM, 2008\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Nasal Projection\": { direction: \"decrease\", percentage: 10 },\n        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 8 },\n        \"Nasolabial Angle\": { direction: \"increase\", percentage: 12 },\n        \"Nasal Index\": { direction: \"decrease\", percentage: 6 }\n      },\n      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n    }\n  },\n  {\n    id: \"genioplasty\",\n    title: \"Sliding Genioplasty (Chin Surgery)\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.5 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 15.0 }\n      }\n    },\n    content: {\n      description: \"Osseous genioplasty: horizontal advancement or setback of the chin via osteotomy and titanium plate fixation. Can also adjust vertical height (reduction/augmentation) and transverse width. Alternative: alloplastic chin implant (silicone/Medpor) for pure augmentation. Improves chin-philtrum ratio and profile convexity.\",\n      cost_min: 4000,\n      cost_max: 12000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"Numbness, infection, asymmetry.\",\n      citations: [\"Park JH et al., 2018\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 20 },\n        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 15 },\n        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 5 }\n      },\n      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"canthoplasty\",\n    title: \"Canthoplasty (Eye Corner Surgery)\",\n    trigger_rules: {\n      metrics: [\"Lateral Canthal Tilt\", \"Eye Aspect Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Lateral Canthal Tilt\": { operator: \"<\", value: 4.0 },\n        \"Eye Aspect Ratio\": { operator: \"<\", value: 2.8 }\n      }\n    },\n    content: {\n      description: \"Lateral canthoplasty or canthopexy: surgical elevation and fixation of the lateral canthal tendon to increase positive canthal tilt angle. Techniques include tarsal strip, lateral canthal suspension, or almond eye surgery. Can be combined with lower blepharoplasty. Addresses negative canthal tilt and downturned eye appearance.\",\n      cost_min: 3000,\n      cost_max: 8000,\n      time_min: \"2 months\",\n      time_max: \"6 months\",\n      risks: \"Scarring, asymmetry, dry eyes.\",\n      citations: [\"Rhee SC et al., 2017\", \"Chen WP, 2016\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 40 },\n        \"Eye Aspect Ratio\": { direction: \"increase\", percentage: 10 }\n      },\n      pillars: [\"youthfulness\", \"alertness\", \"femininity\"]\n    }\n  },\n  {\n    id: \"brow_lift\",\n    title: \"Brow Lift / Browridge Enhancement\",\n    trigger_rules: {\n      metrics: [\"Eyebrow Low Setedness\", \"Browridge Inclination Angle\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Eyebrow Low Setedness\": { operator: \">\", value: 2.0 },\n        \"Browridge Inclination Angle\": { operator: \"<\", value: 10.0 }\n      }\n    },\n    content: {\n      description: \"Brow elevation via endoscopic browlift, temporal lift, or direct browplasty to reduce hooding and increase eyebrow height. For browridge: supraorbital rim augmentation with PMMA, hydroxyapatite paste, or custom implants. Botox for brow arch shaping. Addresses low-set brows and flat browridge inclination.\",\n      cost_min: 1500,\n      cost_max: 10000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Asymmetry, numbness, unnatural appearance.\",\n      citations: [\"Mendelson B et al., 2015\"],\n      tags: [\"Surgical\", \"Minimally Invasive\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 4, confidence: 0.75 },\n      ratios_impacted: {\n        \"Eyebrow Low Setedness\": { direction: \"decrease\", percentage: 30 },\n        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 20 }\n      },\n      pillars: [\"youthfulness\", \"masculinity\", \"upper_third\"]\n    }\n  },\n  // ============================================\n  // NEW PROCEDURES FROM FACEIQ PARITY\n  // ============================================\n  {\n    id: \"kybella\",\n    title: \"Kybella (Double Chin Removal)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 130.0 },\n        \"Neck Width\": { operator: \">\", value: 95.0 }\n      }\n    },\n    content: {\n      description: \"Injectable deoxycholic acid (Kybella/ATX-101) to permanently dissolve submental fat. Multiple sessions required (2-6 treatments, 4-6 weeks apart). Destroys fat cell membranes, eliminating double chin without surgery. FDA-approved for moderate-to-severe submental fullness.\",\n      cost_min: 1200,\n      cost_max: 3000,\n      time_min: \"2 months\",\n      time_max: \"6 months\",\n      risks: \"Swelling, bruising, numbness, pain, nerve injury causing asymmetric smile, asymmetry, difficulty swallowing.\",\n      citations: [\"Jones DH et al., 2016\", \"Ascher B et al., 2017\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"cryolipolysis\",\n    title: \"Cryolipolysis (Fat Freezing)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 125.0 },\n        \"Neck Width\": { operator: \">\", value: 90.0 }\n      }\n    },\n    content: {\n      description: \"Non-invasive fat reduction via controlled cooling (CoolSculpting). Targets stubborn subcutaneous fat without surgery by crystallizing fat cells which are then naturally eliminated. FDA-cleared for submental area, flanks, abdomen. Results visible in 2-4 months.\",\n      cost_min: 750,\n      cost_max: 2500,\n      time_min: \"2 months\",\n      time_max: \"4 months\",\n      risks: \"Temporary erythema/swelling, bruising, numbness/paresthesia, pain, paradoxical adipose hyperplasia (rare), frostbite, hyperpigmentation.\",\n      citations: [\"Ingargiola MJ et al., 2015\", \"Kilmer SL et al., 2017\"],\n      tags: [\"Minimally Invasive\"],\n      priority_score: 2,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 12 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"definition\", \"non_invasive\", \"neck\"]\n    }\n  },\n  {\n    id: \"chin_implant\",\n    title: \"Chin Implant (Mentoplasty)\",\n    trigger_rules: {\n      metrics: [\"Chin to Philtrum Ratio\", \"Recession Relative to Frankfort Plane\", \"Facial Convexity\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Chin to Philtrum Ratio\": { operator: \"<\", value: 1.6 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 12.0 },\n        \"Facial Convexity\": { operator: \"<\", value: 165.0 }\n      }\n    },\n    content: {\n      description: \"Alloplastic chin augmentation using silicone or Medpor implants placed through submental or intraoral incision. Provides permanent chin projection and width enhancement. Alternative to sliding genioplasty for pure augmentation without bone cutting. Custom implants available for precise contouring.\",\n      cost_min: 3000,\n      cost_max: 8000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Infection, implant migration, bone erosion, asymmetry, numbness, capsular contracture, implant extrusion.\",\n      citations: [\"Yaremchuk MJ, 2013\", \"Binder WJ et al., 2008\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.88 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 18 },\n        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 12 },\n        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 4 }\n      },\n      pillars: [\"profile\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"buccal_fat_removal\",\n    title: \"Buccal Fat Removal (Bichectomy)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Face Width to Height Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 70.0 },\n        \"Face Width to Height Ratio\": { operator: \">\", value: 1.55 }\n      }\n    },\n    content: {\n      description: \"Surgical excision of buccal fat pads through intraoral incision to slim the lower cheeks and enhance facial angularity. Creates more defined cheekbone-to-jaw contour. Best for patients with naturally round faces at low body fat. Results are permanent and irreversible.\",\n      cost_min: 2500,\n      cost_max: 6000,\n      time_min: \"2 weeks\",\n      time_max: \"6 months\",\n      risks: \"Facial nerve damage, asymmetry, over-resection causing gaunt appearance, infection, hematoma, parotid duct injury.\",\n      citations: [\"Tarallo M et al., 2018\", \"Moura LB et al., 2018\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 6 },\n        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 3 }\n      },\n      pillars: [\"angularity\", \"definition\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"alarplasty\",\n    title: \"Alarplasty (Alar Base Reduction)\",\n    trigger_rules: {\n      metrics: [\"Nasal W to H Ratio\", \"Alar Base Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal W to H Ratio\": { operator: \">\", value: 0.80 },\n        \"Alar Base Width\": { operator: \">\", value: 35.0 }\n      }\n    },\n    content: {\n      description: \"Surgical narrowing of the nasal alar base through wedge excision. Reduces nostril width and alar flare. Can be performed alone or combined with rhinoplasty. Weir excision for nostril sill, alar wedge for flaring. Hidden incision placement minimizes visible scarring.\",\n      cost_min: 2000,\n      cost_max: 5000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Visible scarring, asymmetry, over-narrowing, nostril distortion, poor wound healing.\",\n      citations: [\"Rohrich RJ et al., 2009\", \"Ingels K et al., 2015\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Nasal W to H Ratio\": { direction: \"decrease\", percentage: 12 },\n        \"Nasal Index\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"harmony\", \"profile\", \"ethnicity_specific\"]\n    }\n  },\n  {\n    id: \"canthopexy\",\n    title: \"Canthopexy (Lateral Canthal Suspension)\",\n    trigger_rules: {\n      metrics: [\"Lateral Canthal Tilt\", \"Lower Eyelid Position\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lateral Canthal Tilt\": { operator: \"<\", value: 3.0 },\n        \"Lower Eyelid Position\": { operator: \">\", value: 1.5 }\n      }\n    },\n    content: {\n      description: \"Suture suspension of the lateral canthal tendon to tighten lower eyelid and prevent sagging. Less invasive than canthoplasty (no tendon cutting). Supports eye shape, prevents scleral show, and can provide subtle upward tilt. Often combined with blepharoplasty.\",\n      cost_min: 2500,\n      cost_max: 6000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Asymmetry, under/overcorrection, dry eyes, ectropion, scarring, temporary swelling.\",\n      citations: [\"Hester TR et al., 2000\", \"Codner MA et al., 2008\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n      ratios_impacted: {\n        \"Lateral Canthal Tilt\": { direction: \"increase\", percentage: 20 }\n      },\n      pillars: [\"youthfulness\", \"alertness\", \"eye_area\"]\n    }\n  },\n  {\n    id: \"neck_lift\",\n    title: \"Neck Lift (Platysmaplasty)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 135.0 },\n        \"Neck Width\": { operator: \">\", value: 100.0 }\n      }\n    },\n    content: {\n      description: \"Comprehensive neck rejuvenation: platysma muscle tightening (platysmaplasty), submental liposuction, excess skin removal, and possible digastric muscle reduction. Addresses turkey neck, platysmal banding, submental fullness, and skin laxity. Can include submental tuck or deep plane techniques.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Hematoma, nerve injury, skin necrosis, asymmetry, visible scarring, skin irregularities, prolonged swelling.\",\n      citations: [\"Feldman JJ, 2006\", \"Ellenbogen R et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 25 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 15 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"septoplasty\",\n    title: \"Septoplasty (Deviated Septum Correction)\",\n    trigger_rules: {\n      metrics: [\"Nasal Deviation\", \"Nasal Symmetry\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Nasal Deviation\": { operator: \">\", value: 5.0 },\n        \"Nasal Symmetry\": { operator: \"<\", value: 0.90 }\n      }\n    },\n    content: {\n      description: \"Surgical correction of deviated nasal septum to improve nasal airflow and symmetry. Performed through closed endonasal approach. Can be functional (breathing) or cosmetic (straightening). Often combined with rhinoplasty (septorhinoplasty) for comprehensive nasal reshaping.\",\n      cost_min: 3000,\n      cost_max: 10000,\n      time_min: \"1 week\",\n      time_max: \"3 months\",\n      risks: \"Septal perforation, persistent deviation, saddle nose, numbness, infection, bleeding, CSF leak (rare).\",\n      citations: [\"Rohrich RJ et al., 2011\", \"Fettman N et al., 2009\"],\n      tags: [\"Surgical\"],\n      priority_score: 2,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },\n      ratios_impacted: {\n        \"Nasal Deviation\": { direction: \"decrease\", percentage: 80 },\n        \"Nasal Symmetry\": { direction: \"increase\", percentage: 10 }\n      },\n      pillars: [\"symmetry\", \"function\", \"breathing\"]\n    }\n  },\n  {\n    id: \"lip_lift\",\n    title: \"Lip Lift (Bullhorn/Subnasal Lip Lift)\",\n    trigger_rules: {\n      metrics: [\"Philtrum Length\", \"Upper Lip Vermilion Height\", \"Midface Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Philtrum Length\": { operator: \">\", value: 15.0 },\n        \"Upper Lip Vermilion Height\": { operator: \"<\", value: 7.0 },\n        \"Midface Ratio\": { operator: \">\", value: 1.1 }\n      }\n    },\n    content: {\n      description: \"Surgical shortening of the philtrum by removing skin at the base of the nose (bullhorn excision). Permanently increases upper lip vermilion show and reduces long upper lip appearance. Alternative to filler for long philtrum correction. Scar hidden in nasal base crease.\",\n      cost_min: 3500,\n      cost_max: 8000,\n      time_min: \"2 weeks\",\n      time_max: \"6 months\",\n      risks: \"Visible scarring, asymmetry, over-shortening, distorted nostril base, wound dehiscence, prolonged swelling.\",\n      citations: [\"Austin HW, 1986\", \"Santanché P et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n      ratios_impacted: {\n        \"Chin to Philtrum Ratio\": { direction: \"increase\", percentage: 25 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"youthfulness\", \"harmony\", \"lip_area\"]\n    }\n  },\n  {\n    id: \"jaw_implants\",\n    title: \"Jaw Implants (Mandibular Augmentation)\",\n    trigger_rules: {\n      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Ramus to Mandible Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Bigonial Width\": { operator: \"<\", value: 85.0 },\n        \"Gonial Angle\": { operator: \">\", value: 130.0 },\n        \"Ramus to Mandible Ratio\": { operator: \"<\", value: 0.45 }\n      }\n    },\n    content: {\n      description: \"Alloplastic mandibular augmentation using silicone, Medpor, or custom PEEK implants. Enhances jaw width (bigonial), gonial angle definition, and mandibular border projection. Placed through intraoral incision. Custom wraparound implants available for comprehensive jaw enhancement.\",\n      cost_min: 6000,\n      cost_max: 20000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Infection, implant migration, bone erosion, asymmetry, mental nerve injury, capsular contracture, masseter atrophy.\",\n      citations: [\"Yaremchuk MJ, 2006\", \"Rao LK et al., 2011\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Bigonial Width\": { direction: \"increase\", percentage: 12 },\n        \"Gonial Angle\": { direction: \"decrease\", percentage: 8 },\n        \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 6 }\n      },\n      pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"midface_implants\",\n    title: \"Midface Implants (Malar/Submalar)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Midface Ratio\", \"Face Width to Height Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 55.0 },\n        \"Midface Ratio\": { operator: \">\", value: 1.15 },\n        \"Face Width to Height Ratio\": { operator: \"<\", value: 1.65 }\n      }\n    },\n    content: {\n      description: \"Alloplastic augmentation of the malar (cheekbone) and/or submalar region using silicone or Medpor implants. Enhances midface projection, cheekbone prominence, and overall facial width. Custom implants available. Alternative to fat grafting for permanent midface volume.\",\n      cost_min: 5000,\n      cost_max: 15000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Infection, implant migration, asymmetry, nerve injury (infraorbital), bone erosion, capsular contracture, visibility.\",\n      citations: [\"Terino EO, 2000\", \"Binder WJ et al., 2007\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.88 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 10 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 6 },\n        \"Face Width to Height Ratio\": { direction: \"increase\", percentage: 4 }\n      },\n      pillars: [\"angularity\", \"harmony\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"submental_liposuction\",\n    title: \"Submental Liposuction\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 120.0 },\n        \"Neck Width\": { operator: \">\", value: 85.0 }\n      }\n    },\n    content: {\n      description: \"Surgical removal of excess fat beneath the chin via small cannula through submental incision. Refines jawline contour and improves neck definition. Can be combined with skin tightening or platysmaplasty. Best for younger patients with good skin elasticity.\",\n      cost_min: 2000,\n      cost_max: 5000,\n      time_min: \"1 week\",\n      time_max: \"3 months\",\n      risks: \"Contour irregularities, asymmetry, nerve injury, skin laxity, hematoma, seroma, prolonged swelling.\",\n      citations: [\"Rohrich RJ et al., 2007\", \"Giampapa VC et al., 2000\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 4, confidence: 0.82 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 15 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 10 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"submentoplasty\",\n    title: \"Submentoplasty (Submental Tuck)\",\n    trigger_rules: {\n      metrics: [\"Submental Cervical Angle\", \"Neck Width\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Submental Cervical Angle\": { operator: \">\", value: 140.0 },\n        \"Neck Width\": { operator: \">\", value: 105.0 }\n      }\n    },\n    content: {\n      description: \"Direct excision of submental skin/fat with platysma muscle plication through small chin incision. Tightens central neck muscles and removes excess tissue. More aggressive than liposuction alone, less extensive than full neck lift. Also called cervicoplasty.\",\n      cost_min: 3500,\n      cost_max: 8000,\n      time_min: \"2 weeks\",\n      time_max: \"4 months\",\n      risks: \"Visible scarring, hematoma, nerve injury, skin necrosis, asymmetry, contour irregularities.\",\n      citations: [\"Giampapa VC et al., 2000\", \"Ellenbogen R et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Submental Cervical Angle\": { direction: \"decrease\", percentage: 20 },\n        \"Neck Width\": { direction: \"decrease\", percentage: 12 }\n      },\n      pillars: [\"definition\", \"youthfulness\", \"neck\"]\n    }\n  },\n  {\n    id: \"fat_grafting\",\n    title: \"Fat Grafting (Facial Lipofilling)\",\n    trigger_rules: {\n      metrics: [\"Cheekbone Height\", \"Under-Eye Hollowness\", \"Temple Volume\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Cheekbone Height\": { operator: \"<\", value: 60.0 },\n        \"Under-Eye Hollowness\": { operator: \">\", value: 3.0 },\n        \"Temple Volume\": { operator: \"<\", value: 0.8 }\n      }\n    },\n    content: {\n      description: \"Autologous fat transfer: fat harvested from body (abdomen, thighs), processed, and injected for facial volumization. Microfat for volume (cheeks, temples, jawline), nanofat for skin rejuvenation. Natural permanent filler with 40-60% long-term retention. Multiple sessions may be needed.\",\n      cost_min: 4000,\n      cost_max: 12000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Fat resorption, asymmetry, lumpiness, oil cysts, infection, embolism (rare), over/under-correction.\",\n      citations: [\"Coleman SR, 2006\", \"Khouri RK et al., 2014\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },\n      ratios_impacted: {\n        \"Cheekbone Height\": { direction: \"increase\", percentage: 5 },\n        \"Tear Trough Depth\": { direction: \"decrease\", percentage: 40 }\n      },\n      pillars: [\"youthfulness\", \"volume\", \"natural\"]\n    }\n  },\n  {\n    id: \"supraorbital_implants\",\n    title: \"Supraorbital Rim Implants (Browridge)\",\n    trigger_rules: {\n      metrics: [\"Browridge Inclination Angle\", \"Supraorbital Projection\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Browridge Inclination Angle\": { operator: \"<\", value: 8.0 },\n        \"Supraorbital Projection\": { operator: \"<\", value: 0.85 }\n      }\n    },\n    content: {\n      description: \"Custom or standard implants placed along the supraorbital rim to enhance browridge projection and definition. Creates more prominent brow bone for masculine appearance. Often custom-designed from CT scans. Placed through coronal or endoscopic approach.\",\n      cost_min: 8000,\n      cost_max: 25000,\n      time_min: \"3 weeks\",\n      time_max: \"6 months\",\n      risks: \"Infection, implant migration, asymmetry, nerve injury, frontal sinus violation, visible/palpable implant, bone erosion.\",\n      citations: [\"Yaremchuk MJ, 2003\", \"Spiegel JH, 2011\"],\n      tags: [\"Surgical\"],\n      priority_score: 3,\n      effectiveness: { level: 'high', score: 4, confidence: 0.80 },\n      ratios_impacted: {\n        \"Browridge Inclination Angle\": { direction: \"increase\", percentage: 30 }\n      },\n      pillars: [\"masculinity\", \"bone_structure\", \"upper_third\"]\n    }\n  },\n  {\n    id: \"lip_reduction\",\n    title: \"Lip Reduction Surgery (Reduction Cheiloplasty)\",\n    trigger_rules: {\n      metrics: [\"Lip Thickness\", \"Lower Lip to Upper Lip Ratio\"],\n      condition: \"OR\",\n      thresholds: {\n        \"Lip Thickness\": { operator: \">\", value: 18.0 },\n        \"Lower Lip to Upper Lip Ratio\": { operator: \">\", value: 2.2 }\n      }\n    },\n    content: {\n      description: \"Surgical removal of excess lip tissue through incision along wet-dry border to reduce lip volume and projection. Improves proportion between lips and surrounding features. Separate procedures for upper and lower lips. Permanent alternative to reversible fillers.\",\n      cost_min: 2500,\n      cost_max: 6000,\n      time_min: \"2 weeks\",\n      time_max: \"3 months\",\n      risks: \"Visible scarring, asymmetry, over-reduction, numbness, altered sensation, wound dehiscence.\",\n      citations: [\"Fanous N, 2007\", \"Garcia RM et al., 2016\"],\n      tags: [\"Surgical\"],\n      priority_score: 2,\n      effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n      ratios_impacted: {\n        \"Lower Lip to Upper Lip Ratio\": { direction: \"decrease\", percentage: 20 }\n      },\n      pillars: [\"harmony\", \"balance\", \"lip_area\"]\n    }\n  },\n  {\n    id: \"jaw_reduction\",\n    title: \"Jaw Reduction Surgery (V-Line Surgery)\",\n    trigger_rules: {\n      metrics: [\"Bigonial Width\", \"Gonial Angle\", \"Face Width to Height Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Bigonial Width\": { operator: \">\", value: 120.0 },\n        \"Gonial Angle\": { operator: \"<\", value: 115.0 },\n        \"Face Width to Height Ratio\": { operator: \">\", value: 1.65 }\n      }\n    },\n    content: {\n      description: \"Mandibular angle resection and contouring to slim and feminize the lower face, creating V-line effect. Osteotomy of mandibular angle, possible chin tapering (T-osteotomy), and masseter reduction. Popular in East Asian aesthetic surgery. Performed through intraoral approach.\",\n      cost_min: 8000,\n      cost_max: 25000,\n      time_min: \"1 month\",\n      time_max: \"6 months\",\n      risks: \"Facial nerve injury, asymmetry, over-reduction, bone necrosis, infection, prolonged swelling, numbness.\",\n      citations: [\"Yang DB et al., 2014\", \"Jin H et al., 2013\"],\n      tags: [\"Surgical\"],\n      priority_score: 4,\n      effectiveness: { level: 'high', score: 5, confidence: 0.90 },\n      ratios_impacted: {\n        \"Bigonial Width\": { direction: \"decrease\", percentage: 15 },\n        \"Gonial Angle\": { direction: \"increase\", percentage: 10 },\n        \"Face Width to Height Ratio\": { direction: \"decrease\", percentage: 8 }\n      },\n      pillars: [\"femininity\", \"harmony\", \"bone_structure\"]\n    }\n  },\n  {\n    id: \"bimaxillary_osteotomy\",\n    title: \"Bimaxillary Osteotomy (Double Jaw Surgery)\",\n    trigger_rules: {\n      metrics: [\"Facial Convexity\", \"Recession Relative to Frankfort Plane\", \"Midface Ratio\"],\n      condition: \"AND\",\n      thresholds: {\n        \"Facial Convexity\": { operator: \"<\", value: 160.0 },\n        \"Recession Relative to Frankfort Plane\": { operator: \">\", value: 18.0 },\n        \"Midface Ratio\": { operator: \">\", value: 1.2 }\n      }\n    },\n    content: {\n      description: \"Simultaneous repositioning of both maxilla (Le Fort I) and mandible (BSSO) to correct facial disharmony and skeletal malocclusion. Addresses severe class II/III relationships, facial asymmetry, and vertical excess. Requires orthodontic preparation. Most comprehensive facial skeletal surgery.\",\n      cost_min: 20000,\n      cost_max: 60000,\n      time_min: \"3 months\",\n      time_max: \"12 months\",\n      risks: \"Nerve injury, infection, relapse, TMJ dysfunction, malocclusion, bleeding, airway compromise, need for revision.\",\n      citations: [\"Proffit WR et al., 2013\", \"Wolford LM et al., 2003\"],\n      tags: [\"Surgical\"],\n      priority_score: 5,\n      effectiveness: { level: 'high', score: 5, confidence: 0.92 },\n      ratios_impacted: {\n        \"Facial Convexity (Nasion)\": { direction: \"increase\", percentage: 15 },\n        \"Recession Relative to Frankfort Plane\": { direction: \"decrease\", percentage: 20 },\n        \"Midface Ratio\": { direction: \"decrease\", percentage: 10 }\n      },\n      pillars: [\"profile\", \"bone_structure\", \"comprehensive\"]\n    }\n  }\n];\n\n// ============================================\n// ADVICE ENGINE CLASS\n// ============================================\n\nexport class AdviceEngine {\n  private plans: RawPlan[];\n\n  constructor(customPlans?: RawPlan[]) {\n    this.plans = customPlans || PLANS;\n  }\n\n  /**\n   * Check if a single threshold condition is met\n   */\n  private checkThreshold(userValue: number, operator: '<' | '>', thresholdValue: number): boolean {\n    if (operator === '<') {\n      return userValue < thresholdValue;\n    }\n    return userValue > thresholdValue;\n  }\n\n  /**\n   * Evaluate trigger rules against user metrics\n   */\n  private evaluateTriggerRules(\n    triggerRules: TriggerRules,\n    metricsDict: Record<string, number>\n  ): { isTriggered: boolean; triggeredMetrics: TriggerResult[] } {\n    const { metrics, thresholds, condition } = triggerRules;\n    const triggeredMetrics: TriggerResult[] = [];\n    const results: boolean[] = [];\n\n    for (const metricName of metrics) {\n      if (!(metricName in metricsDict)) continue;\n      if (!(metricName in thresholds)) continue;\n\n      const userValue = metricsDict[metricName];\n      const { operator, value: thresholdValue } = thresholds[metricName];\n      const isMet = this.checkThreshold(userValue, operator, thresholdValue);\n\n      if (isMet) {\n        triggeredMetrics.push({\n          metric: metricName,\n          value: userValue,\n          threshold: thresholdValue,\n          operator\n        });\n      }\n\n      results.push(isMet);\n    }\n\n    const isTriggered = condition === 'AND'\n      ? results.length > 0 && results.every(r => r)\n      : results.some(r => r);\n\n    return { isTriggered, triggeredMetrics };\n  }\n\n  /**\n   * Get all recommendations that match the user's metrics\n   *\n   * @param metricsDict - Raw metric values\n   * @param severityDict - Severity classifications (ideal/good/moderate/severe) for each metric\n   *                       If a metric is 'ideal', it will NOT trigger remediation plans\n   */\n  getRecommendations(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Plan[] {\n    const recommendations: Plan[] = [];\n\n    for (const rawPlan of this.plans) {\n      const { isTriggered, triggeredMetrics } = this.evaluateTriggerRules(\n        rawPlan.trigger_rules,\n        metricsDict\n      );\n\n      // If severity data is provided, filter out metrics that are already ideal\n      if (isTriggered && severityDict) {\n        // Check if ALL triggered metrics are outside ideal range\n        const hasActualFlaw = triggeredMetrics.some(tm => {\n          const severity = severityDict[tm.metric];\n          // Only trigger if severity is NOT ideal (i.e., it's good/moderate/severe)\n          return severity && severity !== 'ideal';\n        });\n\n        // Skip this plan if all triggered metrics are already ideal\n        if (!hasActualFlaw) {\n          continue;\n        }\n      }\n\n      if (isTriggered) {\n        recommendations.push({\n          id: rawPlan.id,\n          title: rawPlan.title,\n          content: {\n            description: rawPlan.content.description,\n            cost_min: rawPlan.content.cost_min,\n            cost_max: rawPlan.content.cost_max,\n            time_min: rawPlan.content.time_min || 'Unknown',\n            time_max: rawPlan.content.time_max || 'Unknown',\n            risks: rawPlan.content.risks || 'Consult a professional.',\n            citations: rawPlan.content.citations || [],\n            tags: rawPlan.content.tags\n          },\n          trigger_reason: triggeredMetrics\n        });\n      }\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Get recommendations sorted by cost (cheapest first)\n   */\n  getRecommendationsByCost(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Plan[] {\n    return this.getRecommendations(metricsDict, severityDict).sort(\n      (a, b) => a.content.cost_min - b.content.cost_min\n    );\n  }\n\n  /**\n   * Get recommendations grouped by phase/tag\n   */\n  getRecommendationsByPhase(\n    metricsDict: Record<string, number>,\n    severityDict?: Record<string, string>\n  ): Record<string, Plan[]> {\n    const recommendations = this.getRecommendations(metricsDict, severityDict);\n    const grouped: Record<string, Plan[]> = {\n      'Foundational': [],\n      'Minimally Invasive': [],\n      'Surgical': []\n    };\n\n    for (const rec of recommendations) {\n      const tags = rec.content.tags || [];\n      if (tags.includes('Foundational')) {\n        grouped['Foundational'].push(rec);\n      } else if (tags.includes('Surgical')) {\n        grouped['Surgical'].push(rec);\n      } else if (tags.includes('Minimally Invasive')) {\n        grouped['Minimally Invasive'].push(rec);\n      } else {\n        grouped['Minimally Invasive'].push(rec); // Default\n      }\n    }\n\n    return grouped;\n  }\n}\n\n// ============================================\n// SINGLETON INSTANCE\n// ============================================\n\nexport const adviceEngine = new AdviceEngine();\n","numLines":1067,"startLine":1,"totalLines":1067}}}
{"parentUuid":"6a9aa0dc-5600-45bd-8ff1-b9f35f77477b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CgHemSzbvQgnbfJyHGM3EB","type":"message","role":"assistant","content":[{"type":"text","text":"Great! The advice engine is comprehensive. Now let me check for the PlanTab UI and outcome predictions:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":17715,"cache_read_input_tokens":13822,"cache_creation":{"ephemeral_5m_input_tokens":17715,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWS8Y4uKHThuL6rLVXZmJ","type":"assistant","uuid":"7a1f3d87-bfbc-4ba4-834d-69e8198f3248","timestamp":"2025-12-24T20:18:58.953Z"}
{"parentUuid":"7a1f3d87-bfbc-4ba4-834d-69e8198f3248","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CgHemSzbvQgnbfJyHGM3EB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KSgfqxEwu39nQrsxzuQDXP","name":"Glob","input":{"pattern":"**/PlanTab.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":17715,"cache_read_input_tokens":13822,"cache_creation":{"ephemeral_5m_input_tokens":17715,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWS8Y4uKHThuL6rLVXZmJ","type":"assistant","uuid":"f0d81c6a-1ab8-4b67-ab3c-709ce04eef19","timestamp":"2025-12-24T20:18:59.122Z"}
{"parentUuid":"f0d81c6a-1ab8-4b67-ab3c-709ce04eef19","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CgHemSzbvQgnbfJyHGM3EB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XDFChHy6Xf6oDUDjCTDF7i","name":"Glob","input":{"pattern":"**/results/**/*.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":17715,"cache_read_input_tokens":13822,"cache_creation":{"ephemeral_5m_input_tokens":17715,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWS8Y4uKHThuL6rLVXZmJ","type":"assistant","uuid":"d89d3d45-6506-4f09-90d3-0456f3183dff","timestamp":"2025-12-24T20:18:59.297Z"}
{"parentUuid":"d89d3d45-6506-4f09-90d3-0456f3183dff","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XDFChHy6Xf6oDUDjCTDF7i","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/IdealRangeBar.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/SupportTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/RecommendationCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FacialRadarChart.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/AnimatedScore.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ShareButton.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ExportButton.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OptionsTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/MeasurementCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/GradientRangeBar.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/layout.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StrengthFlawCards.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/PlanActionCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/RatioDetailModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/KeyStrengthsFlaws.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/page.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/MetricDetailModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/RatiosTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/RankBadge.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/index.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/Results.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/UserProfileModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/LeaderboardTab.tsx"}]},"uuid":"cf26093a-c2f4-4e44-83e1-dfd74df76058","timestamp":"2025-12-24T20:18:59.741Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/IdealRangeBar.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/SupportTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/RecommendationCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FacialRadarChart.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/AnimatedScore.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ShareButton.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ExportButton.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OptionsTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/MeasurementCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/GradientRangeBar.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/layout.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StrengthFlawCards.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/PlanActionCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/RatioDetailModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/KeyStrengthsFlaws.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/results/page.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/MetricDetailModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/RatiosTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/RankBadge.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/index.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/Results.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/UserProfileModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/LeaderboardTab.tsx"],"durationMs":399,"numFiles":29,"truncated":false}}
{"parentUuid":"cf26093a-c2f4-4e44-83e1-dfd74df76058","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KSgfqxEwu39nQrsxzuQDXP","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx"}]},"uuid":"18ff48fe-179a-42e8-a66a-70fda8d174ec","timestamp":"2025-12-24T20:18:59.862Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx"],"durationMs":519,"numFiles":1,"truncated":false}}
{"parentUuid":"18ff48fe-179a-42e8-a66a-70fda8d174ec","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01UaSwruGqC9TvF8VuGehCsq","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the PlanTab file:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1034,"cache_creation_input_tokens":224,"cache_read_input_tokens":31537,"cache_creation":{"ephemeral_5m_input_tokens":224,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWS8YHAko7nDUKxMrLAVi","type":"assistant","uuid":"cd5c4b1a-1633-4341-bb7e-c491638def9b","timestamp":"2025-12-24T20:19:01.589Z"}
{"parentUuid":"cd5c4b1a-1633-4341-bb7e-c491638def9b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01UaSwruGqC9TvF8VuGehCsq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KJxmu8kzz6cbXuFoVjP3Zb","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1034,"cache_creation_input_tokens":224,"cache_read_input_tokens":31537,"cache_creation":{"ephemeral_5m_input_tokens":224,"ephemeral_1h_input_tokens":0},"output_tokens":96,"service_tier":"standard"}},"requestId":"req_011CWS8YHAko7nDUKxMrLAVi","type":"assistant","uuid":"78b341da-5a89-422c-b59f-5d4d66ca93c8","timestamp":"2025-12-24T20:19:01.892Z"}
{"parentUuid":"78b341da-5a89-422c-b59f-5d4d66ca93c8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KJxmu8kzz6cbXuFoVjP3Zb","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useState, useMemo, useCallback } from 'react';\n     4→import { motion, AnimatePresence } from 'framer-motion';\n     5→import {\n     6→  Sparkles,\n     7→  TrendingUp,\n     8→  Target,\n     9→  Zap,\n    10→  ChevronRight,\n    11→  Lock,\n    12→} from 'lucide-react';\n    13→import { useResults } from '@/contexts/ResultsContext';\n    14→import { TabContent } from '../ResultsLayout';\n    15→import { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\n    16→import { ScoreCircle, PhaseBadge } from '../shared';\n    17→import { RecommendationPhase } from '@/types/results';\n    18→\n    19→// ============================================\n    20→// POTENTIAL SCORE CARD\n    21→// ============================================\n    22→\n    23→function PotentialScoreCard() {\n    24→  const { overallScore, recommendations } = useResults();\n    25→\n    26→  // Calculate potential improvement\n    27→  const potentialImprovement = useMemo(() => {\n    28→    if (recommendations.length === 0) return 0;\n    29→    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    30→    return Math.min(totalImpact * 1.5, 10 - overallScore);\n    31→  }, [recommendations, overallScore]);\n    32→\n    33→  const potentialScore = Math.min(10, overallScore + potentialImprovement);\n    34→\n    35→  return (\n    36→    <motion.div\n    37→      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n    38→      initial={{ opacity: 0, y: 20 }}\n    39→      animate={{ opacity: 1, y: 0 }}\n    40→    >\n    41→      <div className=\"flex items-center gap-2 mb-4\">\n    42→        <Sparkles size={20} className=\"text-cyan-400\" />\n    43→        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n    44→      </div>\n    45→\n    46→      <div className=\"flex items-center justify-center gap-8 mb-6\">\n    47→        {/* Current */}\n    48→        <div className=\"text-center\">\n    49→          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n    50→          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n    51→        </div>\n    52→\n    53→        {/* Arrow */}\n    54→        <div className=\"flex flex-col items-center gap-1\">\n    55→          <ChevronRight size={24} className=\"text-cyan-400\" />\n    56→          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n    57→        </div>\n    58→\n    59→        {/* Potential */}\n    60→        <div className=\"text-center\">\n    61→          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n    62→          <div className=\"relative\">\n    63→            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n    64→            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n    65→              <TrendingUp size={12} className=\"text-black\" />\n    66→            </div>\n    67→          </div>\n    68→        </div>\n    69→      </div>\n    70→\n    71→      <p className=\"text-sm text-neutral-400 text-center\">\n    72→        Following our recommendations could improve your harmony score by up to{' '}\n    73→        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n    74→      </p>\n    75→    </motion.div>\n    76→  );\n    77→}\n    78→\n    79→// ============================================\n    80→// PHASE FILTER\n    81→// ============================================\n    82→\n    83→interface PhaseFilterProps {\n    84→  selectedPhase: RecommendationPhase | null;\n    85→  onSelect: (phase: RecommendationPhase | null) => void;\n    86→  counts: Record<RecommendationPhase, number>;\n    87→}\n    88→\n    89→function PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n    90→  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n    91→\n    92→  return (\n    93→    <div className=\"flex flex-wrap gap-2\">\n    94→      <button\n    95→        onClick={() => onSelect(null)}\n    96→        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${\n    97→          selectedPhase === null\n    98→            ? 'bg-cyan-500 text-black'\n    99→            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n   100→        }`}\n   101→      >\n   102→        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n   103→      </button>\n   104→      {phases.map(phase => (\n   105→        <button\n   106→          key={phase}\n   107→          onClick={() => onSelect(phase)}\n   108→          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${\n   109→            selectedPhase === phase\n   110→              ? 'bg-neutral-700 text-white'\n   111→              : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n   112→          }`}\n   113→        >\n   114→          <PhaseBadge phase={phase} size=\"sm\" />\n   115→          ({counts[phase] || 0})\n   116→        </button>\n   117→      ))}\n   118→    </div>\n   119→  );\n   120→}\n   121→\n   122→// ============================================\n   123→// ORDER OF OPERATIONS\n   124→// ============================================\n   125→\n   126→function OrderOfOperations() {\n   127→  return (\n   128→    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n   129→      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n   130→        <Target size={16} className=\"text-cyan-400\" />\n   131→        Recommended Order\n   132→      </h4>\n   133→      <div className=\"space-y-3\">\n   134→        <div className=\"flex items-start gap-3\">\n   135→          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n   136→            <span className=\"text-xs font-bold text-green-400\">1</span>\n   137→          </div>\n   138→          <div>\n   139→            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n   140→            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n   141→          </div>\n   142→        </div>\n   143→        <div className=\"flex items-start gap-3\">\n   144→          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n   145→            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n   146→          </div>\n   147→          <div>\n   148→            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n   149→            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n   150→          </div>\n   151→        </div>\n   152→        <div className=\"flex items-start gap-3\">\n   153→          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n   154→            <span className=\"text-xs font-bold text-red-400\">3</span>\n   155→          </div>\n   156→          <div>\n   157→            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n   158→            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n   159→          </div>\n   160→        </div>\n   161→      </div>\n   162→    </div>\n   163→  );\n   164→}\n   165→\n   166→// ============================================\n   167→// PLAN TAB\n   168→// ============================================\n   169→\n   170→export function PlanTab() {\n   171→  const { recommendations, flaws, gender, ethnicity } = useResults();\n   172→  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n   173→  const [expandedId, setExpandedId] = useState<string | null>(null);\n   174→  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n   175→  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n   176→\n   177→  // Count recommendations by phase\n   178→  const phaseCounts = useMemo(() => {\n   179→    const counts: Record<RecommendationPhase, number> = {\n   180→      'Foundational': 0,\n   181→      'Minimally Invasive': 0,\n   182→      'Surgical': 0,\n   183→    };\n   184→    recommendations.forEach(r => {\n   185→      if (!removedIds.has(r.ref_id)) {\n   186→        counts[r.phase]++;\n   187→      }\n   188→    });\n   189→    return counts;\n   190→  }, [recommendations, removedIds]);\n   191→\n   192→  // Filter recommendations\n   193→  const filteredRecommendations = useMemo(() => {\n   194→    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n   195→    if (selectedPhase) {\n   196→      filtered = filtered.filter(r => r.phase === selectedPhase);\n   197→    }\n   198→    return filtered;\n   199→  }, [recommendations, selectedPhase, removedIds]);\n   200→\n   201→  const hasRecommendations = filteredRecommendations.length > 0;\n   202→\n   203→  // Handle mark complete\n   204→  const handleMarkComplete = useCallback((id: string) => {\n   205→    setCompletedIds(prev => {\n   206→      const newSet = new Set(prev);\n   207→      if (newSet.has(id)) {\n   208→        newSet.delete(id);\n   209→      } else {\n   210→        newSet.add(id);\n   211→      }\n   212→      return newSet;\n   213→    });\n   214→  }, []);\n   215→\n   216→  // Handle remove\n   217→  const handleRemove = useCallback((id: string) => {\n   218→    setRemovedIds(prev => {\n   219→      const newSet = new Set(prev);\n   220→      newSet.add(id);\n   221→      return newSet;\n   222→    });\n   223→    if (expandedId === id) {\n   224→      setExpandedId(null);\n   225→    }\n   226→  }, [expandedId]);\n   227→\n   228→  return (\n   229→    <TabContent\n   230→      title=\"Your Plan & Potential\"\n   231→      subtitle=\"Personalized recommendations based on your analysis\"\n   232→    >\n   233→      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n   234→        {/* Main Content */}\n   235→        <div className=\"lg:col-span-2 space-y-6\">\n   236→          {/* Potential Score */}\n   237→          <PotentialScoreCard />\n   238→\n   239→          {/* Phase Filter */}\n   240→          <PhaseFilter\n   241→            selectedPhase={selectedPhase}\n   242→            onSelect={setSelectedPhase}\n   243→            counts={phaseCounts}\n   244→          />\n   245→\n   246→          {/* Recommendations List */}\n   247→          {hasRecommendations ? (\n   248→            <motion.div className=\"space-y-4\" layout>\n   249→              <AnimatePresence mode=\"popLayout\">\n   250→                {filteredRecommendations.map((rec, index) => (\n   251→                  <motion.div\n   252→                    key={rec.ref_id}\n   253→                    layout\n   254→                    initial={{ opacity: 0, y: 20 }}\n   255→                    animate={{ opacity: 1, y: 0 }}\n   256→                    exit={{ opacity: 0, y: -20 }}\n   257→                    transition={{ duration: 0.2, delay: index * 0.05 }}\n   258→                  >\n   259→                    <EnhancedRecommendationCard\n   260→                      recommendation={rec}\n   261→                      rank={index + 1}\n   262→                      isExpanded={expandedId === rec.ref_id}\n   263→                      onToggle={() => setExpandedId(\n   264→                        expandedId === rec.ref_id ? null : rec.ref_id\n   265→                      )}\n   266→                      onMarkComplete={handleMarkComplete}\n   267→                      onRemove={handleRemove}\n   268→                      isCompleted={completedIds.has(rec.ref_id)}\n   269→                      gender={gender}\n   270→                      ethnicity={ethnicity}\n   271→                    />\n   272→                  </motion.div>\n   273→                ))}\n   274→              </AnimatePresence>\n   275→            </motion.div>\n   276→          ) : (\n   277→            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n   278→              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n   279→              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n   280→              <p className=\"text-neutral-500 mb-4\">\n   281→                Complete a facial analysis to get personalized recommendations\n   282→              </p>\n   283→            </div>\n   284→          )}\n   285→        </div>\n   286→\n   287→        {/* Sidebar */}\n   288→        <div className=\"space-y-6\">\n   289→          {/* Order of Operations */}\n   290→          <OrderOfOperations />\n   291→\n   292→          {/* My Plan Summary */}\n   293→          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n   294→            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n   295→              <Zap size={16} className=\"text-yellow-400\" />\n   296→              My Plan\n   297→            </h4>\n   298→            <div className=\"text-center py-6\">\n   299→              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n   300→                <Lock size={20} className=\"text-neutral-600\" />\n   301→              </div>\n   302→              <p className=\"text-sm text-neutral-500 mb-3\">\n   303→                Add recommendations to build your personalized plan\n   304→              </p>\n   305→              <p className=\"text-xs text-neutral-600\">\n   306→                0 items selected\n   307→              </p>\n   308→            </div>\n   309→          </div>\n   310→\n   311→          {/* Issues Summary */}\n   312→          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n   313→            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n   314→            <div className=\"space-y-2\">\n   315→              {flaws.slice(0, 5).map(flaw => (\n   316→                <div\n   317→                  key={flaw.id}\n   318→                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n   319→                >\n   320→                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n   321→                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n   322→                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n   323→                  </span>\n   324→                </div>\n   325→              ))}\n   326→              {flaws.length === 0 && (\n   327→                <p className=\"text-sm text-neutral-500 text-center py-4\">\n   328→                  No issues detected\n   329→                </p>\n   330→              )}\n   331→            </div>\n   332→          </div>\n   333→        </div>\n   334→      </div>\n   335→    </TabContent>\n   336→  );\n   337→}\n   338→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"187f9aca-b533-4f27-afd5-986c26afd5fd","timestamp":"2025-12-24T20:19:01.947Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","content":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Sparkles,\n  TrendingUp,\n  Target,\n  Zap,\n  ChevronRight,\n  Lock,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { TabContent } from '../ResultsLayout';\nimport { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';\nimport { ScoreCircle, PhaseBadge } from '../shared';\nimport { RecommendationPhase } from '@/types/results';\n\n// ============================================\n// POTENTIAL SCORE CARD\n// ============================================\n\nfunction PotentialScoreCard() {\n  const { overallScore, recommendations } = useResults();\n\n  // Calculate potential improvement\n  const potentialImprovement = useMemo(() => {\n    if (recommendations.length === 0) return 0;\n    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n    return Math.min(totalImpact * 1.5, 10 - overallScore);\n  }, [recommendations, overallScore]);\n\n  const potentialScore = Math.min(10, overallScore + potentialImprovement);\n\n  return (\n    <motion.div\n      className=\"bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Sparkles size={20} className=\"text-cyan-400\" />\n        <h3 className=\"font-semibold text-white\">Your Potential</h3>\n      </div>\n\n      <div className=\"flex items-center justify-center gap-8 mb-6\">\n        {/* Current */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Current</p>\n          <ScoreCircle score={overallScore} size=\"lg\" animate={false} />\n        </div>\n\n        {/* Arrow */}\n        <div className=\"flex flex-col items-center gap-1\">\n          <ChevronRight size={24} className=\"text-cyan-400\" />\n          <span className=\"text-xs text-green-400\">+{potentialImprovement.toFixed(1)}</span>\n        </div>\n\n        {/* Potential */}\n        <div className=\"text-center\">\n          <p className=\"text-xs text-neutral-500 mb-2\">Potential</p>\n          <div className=\"relative\">\n            <ScoreCircle score={potentialScore} size=\"lg\" animate={false} />\n            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center\">\n              <TrendingUp size={12} className=\"text-black\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <p className=\"text-sm text-neutral-400 text-center\">\n        Following our recommendations could improve your harmony score by up to{' '}\n        <span className=\"text-green-400 font-medium\">+{potentialImprovement.toFixed(1)} points</span>\n      </p>\n    </motion.div>\n  );\n}\n\n// ============================================\n// PHASE FILTER\n// ============================================\n\ninterface PhaseFilterProps {\n  selectedPhase: RecommendationPhase | null;\n  onSelect: (phase: RecommendationPhase | null) => void;\n  counts: Record<RecommendationPhase, number>;\n}\n\nfunction PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {\n  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];\n\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <button\n        onClick={() => onSelect(null)}\n        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${\n          selectedPhase === null\n            ? 'bg-cyan-500 text-black'\n            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n        }`}\n      >\n        All ({Object.values(counts).reduce((a, b) => a + b, 0)})\n      </button>\n      {phases.map(phase => (\n        <button\n          key={phase}\n          onClick={() => onSelect(phase)}\n          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${\n            selectedPhase === phase\n              ? 'bg-neutral-700 text-white'\n              : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'\n          }`}\n        >\n          <PhaseBadge phase={phase} size=\"sm\" />\n          ({counts[phase] || 0})\n        </button>\n      ))}\n    </div>\n  );\n}\n\n// ============================================\n// ORDER OF OPERATIONS\n// ============================================\n\nfunction OrderOfOperations() {\n  return (\n    <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n      <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n        <Target size={16} className=\"text-cyan-400\" />\n        Recommended Order\n      </h4>\n      <div className=\"space-y-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-green-400\">1</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Start with Foundational</p>\n            <p className=\"text-xs text-neutral-500\">Low-cost, no-risk improvements that anyone can do</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-yellow-400\">2</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Consider Minimally Invasive</p>\n            <p className=\"text-xs text-neutral-500\">Temporary or reversible options with moderate impact</p>\n          </div>\n        </div>\n        <div className=\"flex items-start gap-3\">\n          <div className=\"w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5\">\n            <span className=\"text-xs font-bold text-red-400\">3</span>\n          </div>\n          <div>\n            <p className=\"text-sm font-medium text-white\">Evaluate Surgical Options</p>\n            <p className=\"text-xs text-neutral-500\">Permanent solutions for significant improvements</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// PLAN TAB\n// ============================================\n\nexport function PlanTab() {\n  const { recommendations, flaws, gender, ethnicity } = useResults();\n  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());\n  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());\n\n  // Count recommendations by phase\n  const phaseCounts = useMemo(() => {\n    const counts: Record<RecommendationPhase, number> = {\n      'Foundational': 0,\n      'Minimally Invasive': 0,\n      'Surgical': 0,\n    };\n    recommendations.forEach(r => {\n      if (!removedIds.has(r.ref_id)) {\n        counts[r.phase]++;\n      }\n    });\n    return counts;\n  }, [recommendations, removedIds]);\n\n  // Filter recommendations\n  const filteredRecommendations = useMemo(() => {\n    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));\n    if (selectedPhase) {\n      filtered = filtered.filter(r => r.phase === selectedPhase);\n    }\n    return filtered;\n  }, [recommendations, selectedPhase, removedIds]);\n\n  const hasRecommendations = filteredRecommendations.length > 0;\n\n  // Handle mark complete\n  const handleMarkComplete = useCallback((id: string) => {\n    setCompletedIds(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(id)) {\n        newSet.delete(id);\n      } else {\n        newSet.add(id);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Handle remove\n  const handleRemove = useCallback((id: string) => {\n    setRemovedIds(prev => {\n      const newSet = new Set(prev);\n      newSet.add(id);\n      return newSet;\n    });\n    if (expandedId === id) {\n      setExpandedId(null);\n    }\n  }, [expandedId]);\n\n  return (\n    <TabContent\n      title=\"Your Plan & Potential\"\n      subtitle=\"Personalized recommendations based on your analysis\"\n    >\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Main Content */}\n        <div className=\"lg:col-span-2 space-y-6\">\n          {/* Potential Score */}\n          <PotentialScoreCard />\n\n          {/* Phase Filter */}\n          <PhaseFilter\n            selectedPhase={selectedPhase}\n            onSelect={setSelectedPhase}\n            counts={phaseCounts}\n          />\n\n          {/* Recommendations List */}\n          {hasRecommendations ? (\n            <motion.div className=\"space-y-4\" layout>\n              <AnimatePresence mode=\"popLayout\">\n                {filteredRecommendations.map((rec, index) => (\n                  <motion.div\n                    key={rec.ref_id}\n                    layout\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -20 }}\n                    transition={{ duration: 0.2, delay: index * 0.05 }}\n                  >\n                    <EnhancedRecommendationCard\n                      recommendation={rec}\n                      rank={index + 1}\n                      isExpanded={expandedId === rec.ref_id}\n                      onToggle={() => setExpandedId(\n                        expandedId === rec.ref_id ? null : rec.ref_id\n                      )}\n                      onMarkComplete={handleMarkComplete}\n                      onRemove={handleRemove}\n                      isCompleted={completedIds.has(rec.ref_id)}\n                      gender={gender}\n                      ethnicity={ethnicity}\n                    />\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </motion.div>\n          ) : (\n            <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center\">\n              <Sparkles size={48} className=\"mx-auto text-neutral-700 mb-4\" />\n              <h3 className=\"text-lg font-medium text-white mb-2\">No Recommendations Yet</h3>\n              <p className=\"text-neutral-500 mb-4\">\n                Complete a facial analysis to get personalized recommendations\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Sidebar */}\n        <div className=\"space-y-6\">\n          {/* Order of Operations */}\n          <OrderOfOperations />\n\n          {/* My Plan Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3 flex items-center gap-2\">\n              <Zap size={16} className=\"text-yellow-400\" />\n              My Plan\n            </h4>\n            <div className=\"text-center py-6\">\n              <div className=\"w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center\">\n                <Lock size={20} className=\"text-neutral-600\" />\n              </div>\n              <p className=\"text-sm text-neutral-500 mb-3\">\n                Add recommendations to build your personalized plan\n              </p>\n              <p className=\"text-xs text-neutral-600\">\n                0 items selected\n              </p>\n            </div>\n          </div>\n\n          {/* Issues Summary */}\n          <div className=\"bg-neutral-900/50 border border-neutral-800 rounded-xl p-4\">\n            <h4 className=\"font-medium text-white mb-3\">Detected Issues</h4>\n            <div className=\"space-y-2\">\n              {flaws.slice(0, 5).map(flaw => (\n                <div\n                  key={flaw.id}\n                  className=\"flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg\"\n                >\n                  <span className=\"text-sm text-neutral-300 truncate\">{flaw.flawName}</span>\n                  <span className=\"text-xs text-red-400 flex-shrink-0\">\n                    -{flaw.harmonyPercentageLost.toFixed(1)}%\n                  </span>\n                </div>\n              ))}\n              {flaws.length === 0 && (\n                <p className=\"text-sm text-neutral-500 text-center py-4\">\n                  No issues detected\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n    </TabContent>\n  );\n}\n","numLines":338,"startLine":1,"totalLines":338}}}
{"parentUuid":"187f9aca-b533-4f27-afd5-986c26afd5fd","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01G7ua9avXSZMWyzyfgc6GHJ","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the EnhancedRecommendationCard:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":6107,"cache_read_input_tokens":31761,"cache_creation":{"ephemeral_5m_input_tokens":6107,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWS8YS81vBJvvRPUZN1KB","type":"assistant","uuid":"3022eb3a-1406-4d22-a41c-d34c90506d7d","timestamp":"2025-12-24T20:19:03.196Z"}
{"parentUuid":"3022eb3a-1406-4d22-a41c-d34c90506d7d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01G7ua9avXSZMWyzyfgc6GHJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KcFVmthjEeqmGt1psxRNfH","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":6107,"cache_read_input_tokens":31761,"cache_creation":{"ephemeral_5m_input_tokens":6107,"ephemeral_1h_input_tokens":0},"output_tokens":107,"service_tier":"standard"}},"requestId":"req_011CWS8YS81vBJvvRPUZN1KB","type":"assistant","uuid":"0953265b-52a2-4a12-b734-a296f64106e1","timestamp":"2025-12-24T20:19:03.680Z"}
{"parentUuid":"0953265b-52a2-4a12-b734-a296f64106e1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KcFVmthjEeqmGt1psxRNfH","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useState, useCallback, useMemo } from 'react';\n     4→import { motion, AnimatePresence } from 'framer-motion';\n     5→import {\n     6→  ChevronDown,\n     7→  Clock,\n     8→  DollarSign,\n     9→  AlertTriangle,\n    10→  Target,\n    11→  Info,\n    12→  BookOpen,\n    13→  CheckCircle,\n    14→  Trash2,\n    15→  Plus,\n    16→  Sparkles,\n    17→  ExternalLink,\n    18→} from 'lucide-react';\n    19→import { Recommendation } from '@/types/results';\n    20→import { Gender, Ethnicity } from '@/lib/faceiq-scoring';\n    21→\n    22→// ============================================\n    23→// TYPES\n    24→// ============================================\n    25→\n    26→interface EnhancedRecommendationCardProps {\n    27→  recommendation: Recommendation;\n    28→  isExpanded?: boolean;\n    29→  onToggle?: () => void;\n    30→  rank?: number;\n    31→  onMarkComplete?: (id: string) => void;\n    32→  onRemove?: (id: string) => void;\n    33→  isCompleted?: boolean;\n    34→  gender?: Gender;\n    35→  ethnicity?: Ethnicity;\n    36→}\n    37→\n    38→// ============================================\n    39→// RESEARCH CITATIONS DATABASE\n    40→// ============================================\n    41→\n    42→interface ResearchCitation {\n    43→  title: string;\n    44→  authors: string;\n    45→  journal: string;\n    46→  year: number;\n    47→  doi?: string;\n    48→  summary: string;\n    49→  procedureRefs: string[];  // Matches recommendation ref_id\n    50→  genderRelevance?: 'male' | 'female' | 'both';\n    51→  ethnicityRelevance?: Ethnicity[];\n    52→}\n    53→\n    54→const RESEARCH_CITATIONS: ResearchCitation[] = [\n    55→  // Rhinoplasty Research\n    56→  {\n    57→    title: 'Ethnic Considerations in Rhinoplasty',\n    58→    authors: 'Rohrich RJ, Bolden K',\n    59→    journal: 'Plastic and Reconstructive Surgery',\n    60→    year: 2010,\n    61→    doi: '10.1097/PRS.0b013e3181c6b2b7',\n    62→    summary: 'Discusses the importance of preserving ethnic identity while achieving aesthetic goals in rhinoplasty across different ethnicities.',\n    63→    procedureRefs: ['SUR-02', 'MIN-04'],\n    64→    genderRelevance: 'both',\n    65→    ethnicityRelevance: ['black', 'east_asian', 'south_asian', 'middle_eastern', 'hispanic'],\n    66→  },\n    67→  {\n    68→    title: 'The Male Rhinoplasty',\n    69→    authors: 'Foda HM',\n    70→    journal: 'Facial Plastic Surgery',\n    71→    year: 2008,\n    72→    summary: 'Examines unique considerations for male rhinoplasty including maintaining masculine features and avoiding feminization.',\n    73→    procedureRefs: ['SUR-02', 'MIN-04'],\n    74→    genderRelevance: 'male',\n    75→  },\n    76→  // Jaw/Chin Research\n    77→  {\n    78→    title: 'Sliding Genioplasty: A Systematic Review',\n    79→    authors: 'Park JH, Tae-Hoon K',\n    80→    journal: 'Journal of Oral and Maxillofacial Surgery',\n    81→    year: 2018,\n    82→    summary: 'Comprehensive analysis of chin advancement outcomes and patient satisfaction rates across demographics.',\n    83→    procedureRefs: ['SUR-01', 'MIN-02'],\n    84→    genderRelevance: 'both',\n    85→  },\n    86→  {\n    87→    title: 'Gender Differences in Jaw Angle Aesthetics',\n    88→    authors: 'Kim YH, Cho J',\n    89→    journal: 'Aesthetic Plastic Surgery',\n    90→    year: 2020,\n    91→    summary: 'Research on ideal jaw angle parameters for males (90-110°) versus females (110-120°).',\n    92→    procedureRefs: ['SUR-03', 'MIN-03'],\n    93→    genderRelevance: 'both',\n    94→  },\n    95→  {\n    96→    title: 'Mandibular Angle Augmentation in Asian Patients',\n    97→    authors: 'Lee YJ, Park KS',\n    98→    journal: 'Asian Journal of Beauty and Cosmetology',\n    99→    year: 2019,\n   100→    summary: 'Study on jaw angle enhancement specific to East Asian facial structure and aesthetic preferences.',\n   101→    procedureRefs: ['SUR-03', 'MIN-03'],\n   102→    genderRelevance: 'both',\n   103→    ethnicityRelevance: ['east_asian', 'south_asian'],\n   104→  },\n   105→  // Lip Research\n   106→  {\n   107→    title: 'Ideal Lip Proportions Across Ethnicities',\n   108→    authors: 'Farkas LG, Katic MJ',\n   109→    journal: 'Aesthetic Surgery Journal',\n   110→    year: 2003,\n   111→    summary: 'Anthropometric study establishing ethnic-specific ideal lip ratios and proportions.',\n   112→    procedureRefs: ['MIN-01', 'FND-01'],\n   113→    genderRelevance: 'both',\n   114→    ethnicityRelevance: ['white', 'black', 'east_asian', 'hispanic'],\n   115→  },\n   116→  {\n   117→    title: 'Lip Enhancement in African American Patients',\n   118→    authors: 'Mack WP',\n   119→    journal: 'Facial Plastic Surgery Clinics',\n   120→    year: 2014,\n   121→    summary: 'Guidelines for maintaining ethnic characteristics while enhancing lip aesthetics.',\n   122→    procedureRefs: ['MIN-01'],\n   123→    genderRelevance: 'both',\n   124→    ethnicityRelevance: ['black'],\n   125→  },\n   126→  // Eye/Canthal Research\n   127→  {\n   128→    title: 'Canthal Tilt and Facial Attractiveness',\n   129→    authors: 'Rhee SC, et al.',\n   130→    journal: 'Plastic and Reconstructive Surgery',\n   131→    year: 2017,\n   132→    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n   133→    procedureRefs: ['SUR-05', 'MIN-04'],\n   134→    genderRelevance: 'both',\n   135→  },\n   136→  {\n   137→    title: 'Asian Blepharoplasty and Canthopexy',\n   138→    authors: 'Chen WP',\n   139→    journal: 'Ophthalmic Plastic Surgery',\n   140→    year: 2016,\n   141→    summary: 'Specific techniques for Asian eyelid surgery that preserve ethnic identity while enhancing eye shape.',\n   142→    procedureRefs: ['SUR-05'],\n   143→    genderRelevance: 'both',\n   144→    ethnicityRelevance: ['east_asian', 'south_asian'],\n   145→  },\n   146→  // Midface/Cheek Research\n   147→  {\n   148→    title: 'Cheekbone Enhancement for Facial Harmony',\n   149→    authors: 'Mendelson B, Wong CH',\n   150→    journal: 'Clinics in Plastic Surgery',\n   151→    year: 2015,\n   152→    summary: 'Analysis of malar augmentation effects on overall facial harmony and perceived attractiveness.',\n   153→    procedureRefs: ['SUR-06', 'MIN-05'],\n   154→    genderRelevance: 'both',\n   155→  },\n   156→  {\n   157→    title: 'Midface Aesthetics in Middle Eastern Populations',\n   158→    authors: 'Rohrich RJ, et al.',\n   159→    journal: 'Aesthetic Surgery Journal',\n   160→    year: 2021,\n   161→    summary: 'Ethnic considerations for midface enhancement in Middle Eastern patients.',\n   162→    procedureRefs: ['SUR-06', 'MIN-05'],\n   163→    genderRelevance: 'both',\n   164→    ethnicityRelevance: ['middle_eastern'],\n   165→  },\n   166→  // Foundational/Non-Surgical Research\n   167→  {\n   168→    title: 'Mewing and Orthotropic Treatment',\n   169→    authors: 'Mew J, Mew M',\n   170→    journal: 'International Journal of Orthodontics',\n   171→    year: 2014,\n   172→    summary: 'Research on proper tongue posture and its effects on facial development and structure.',\n   173→    procedureRefs: ['FND-02', 'FND-03'],\n   174→    genderRelevance: 'both',\n   175→  },\n   176→  {\n   177→    title: 'Effects of Body Composition on Facial Aesthetics',\n   178→    authors: 'Morrison CS, et al.',\n   179→    journal: 'Aesthetic Surgery Journal',\n   180→    year: 2017,\n   181→    summary: 'Study on how body fat percentage affects facial definition and perceived attractiveness.',\n   182→    procedureRefs: ['FND-04', 'FND-05'],\n   183→    genderRelevance: 'both',\n   184→  },\n   185→  {\n   186→    title: 'Grooming and First Impressions',\n   187→    authors: 'Phelan C, Etcoff N',\n   188→    journal: 'Journal of Applied Social Psychology',\n   189→    year: 2011,\n   190→    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n   191→    procedureRefs: ['FND-04', 'FND-05'],\n   192→    genderRelevance: 'both',\n   193→  },\n   194→  // Orthognathic Research\n   195→  {\n   196→    title: 'Bimaxillary Surgery Outcomes',\n   197→    authors: 'Rustemeyer J, et al.',\n   198→    journal: 'Journal of Cranio-Maxillofacial Surgery',\n   199→    year: 2019,\n   200→    summary: 'Long-term outcomes and patient satisfaction following double jaw surgery.',\n   201→    procedureRefs: ['SUR-04'],\n   202→    genderRelevance: 'both',\n   203→  },\n   204→  // General Attractiveness Research\n   205→  {\n   206→    title: 'Cross-Cultural Facial Attractiveness',\n   207→    authors: 'Perrett DI, et al.',\n   208→    journal: 'Nature',\n   209→    year: 1998,\n   210→    summary: 'Landmark study on universal vs. culture-specific aspects of facial attractiveness.',\n   211→    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06'],\n   212→    genderRelevance: 'both',\n   213→  },\n   214→  {\n   215→    title: 'Golden Ratios in Facial Beauty',\n   216→    authors: 'Marquardt SR',\n   217→    journal: 'International Journal of Cosmetic Surgery',\n   218→    year: 2002,\n   219→    summary: 'Analysis of mathematical proportions and their relationship to perceived facial beauty.',\n   220→    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06', 'MIN-01', 'MIN-02'],\n   221→    genderRelevance: 'both',\n   222→  },\n   223→];\n   224→\n   225→function getRelevantCitations(\n   226→  procedureRefId: string,\n   227→  gender?: Gender,\n   228→  ethnicity?: Ethnicity\n   229→): ResearchCitation[] {\n   230→  // Calculate relevance score for sorting\n   231→  function calculateRelevance(citation: ResearchCitation): number {\n   232→    let score = 0;\n   233→\n   234→    // Base score: procedure is in the list\n   235→    if (!citation.procedureRefs.includes(procedureRefId)) return -1;\n   236→\n   237→    // Procedure specificity: fewer refs = more specific to this procedure (+20 max)\n   238→    score += Math.max(0, 20 - (citation.procedureRefs.length * 3));\n   239→\n   240→    // Gender relevance scoring\n   241→    if (gender && citation.genderRelevance) {\n   242→      if (citation.genderRelevance === gender) {\n   243→        // Exact gender match - highest priority (+30)\n   244→        score += 30;\n   245→      } else if (citation.genderRelevance === 'both') {\n   246→        // General/both - neutral (+10)\n   247→        score += 10;\n   248→      } else {\n   249→        // Wrong gender - exclude\n   250→        return -1;\n   251→      }\n   252→    } else {\n   253→      // No gender specified or citation has no gender preference\n   254→      score += 10;\n   255→    }\n   256→\n   257→    // Ethnicity relevance scoring\n   258→    if (ethnicity && ethnicity !== 'other' && citation.ethnicityRelevance) {\n   259→      if (citation.ethnicityRelevance.includes(ethnicity)) {\n   260→        // Exact ethnicity match - high priority (+25)\n   261→        score += 25;\n   262→        // Bonus for ethnicity-specific studies (fewer ethnicities = more focused)\n   263→        score += Math.max(0, 15 - (citation.ethnicityRelevance.length * 2));\n   264→      } else {\n   265→        // Citation is ethnicity-specific but doesn't match user - lower priority\n   266→        // Still include unless very specific (1-2 ethnicities)\n   267→        if (citation.ethnicityRelevance.length <= 2) {\n   268→          return -1; // Too specific for different ethnicity\n   269→        }\n   270→        score += 5; // General enough to still be useful\n   271→      }\n   272→    } else {\n   273→      // No ethnicity filter or citation applies to all\n   274→      score += 10;\n   275→    }\n   276→\n   277→    // Recency bonus: newer studies slightly preferred\n   278→    const yearBonus = Math.max(0, (citation.year - 2000) * 0.5);\n   279→    score += yearBonus;\n   280→\n   281→    return score;\n   282→  }\n   283→\n   284→  // Filter, score, sort, and take top 3\n   285→  return RESEARCH_CITATIONS\n   286→    .map(citation => ({ citation, relevance: calculateRelevance(citation) }))\n   287→    .filter(item => item.relevance >= 0)\n   288→    .sort((a, b) => b.relevance - a.relevance)\n   289→    .slice(0, 3)\n   290→    .map(item => item.citation);\n   291→}\n   292→\n   293→interface TrackerState {\n   294→  notes: string;\n   295→  checklist: Array<{ id: string; text: string; completed: boolean }>;\n   296→}\n   297→\n   298→// ============================================\n   299→// PHASE BADGE (Dark Theme)\n   300→// ============================================\n   301→\n   302→function PhaseBadge({ phase }: { phase: string }) {\n   303→  const getPhaseConfig = () => {\n   304→    switch (phase) {\n   305→      case 'Foundational':\n   306→        return {\n   307→          bg: 'bg-emerald-500/20',\n   308→          text: 'text-emerald-400',\n   309→          border: 'border-emerald-500/30',\n   310→        };\n   311→      case 'Minimally Invasive':\n   312→        return {\n   313→          bg: 'bg-blue-500/20',\n   314→          text: 'text-blue-400',\n   315→          border: 'border-blue-500/30',\n   316→        };\n   317→      case 'Surgical':\n   318→        return {\n   319→          bg: 'bg-purple-500/20',\n   320→          text: 'text-purple-400',\n   321→          border: 'border-purple-500/30',\n   322→        };\n   323→      default:\n   324→        return {\n   325→          bg: 'bg-neutral-500/20',\n   326→          text: 'text-neutral-400',\n   327→          border: 'border-neutral-500/30',\n   328→        };\n   329→    }\n   330→  };\n   331→\n   332→  const config = getPhaseConfig();\n   333→\n   334→  return (\n   335→    <span\n   336→      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}\n   337→    >\n   338→      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}\n   339→    </span>\n   340→  );\n   341→}\n   342→\n   343→// ============================================\n   344→// IMPACT BADGE\n   345→// ============================================\n   346→\n   347→function ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {\n   348→  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);\n   349→\n   350→  return (\n   351→    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n   352→      <span className=\"flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0\">\n   353→        <Sparkles className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n   354→        {formattedImpact}\n   355→      </span>\n   356→      {(frontImpact !== undefined || sideImpact !== undefined) && (\n   357→        <span className=\"hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0\">\n   358→          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n   359→            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}\n   360→          </span>\n   361→          <span className=\"text-neutral-600\">|</span>\n   362→          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n   363→            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}\n   364→          </span>\n   365→        </span>\n   366→      )}\n   367→    </div>\n   368→  );\n   369→}\n   370→\n   371→// ============================================\n   372→// IMPROVEMENT TAG\n   373→// ============================================\n   374→\n   375→function ImprovementTag({ text }: { text: string }) {\n   376→  return (\n   377→    <div className=\"inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm\">\n   378→      <CheckCircle className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0\" />\n   379→      <span className=\"truncate\">{text}</span>\n   380→    </div>\n   381→  );\n   382→}\n   383→\n   384→// ============================================\n   385→// SECTION HEADER\n   386→// ============================================\n   387→\n   388→function SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {\n   389→  return (\n   390→    <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3\">\n   391→      <Icon className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n   392→      {title}\n   393→    </h4>\n   394→  );\n   395→}\n   396→\n   397→// ============================================\n   398→// MY TRACKER SECTION\n   399→// ============================================\n   400→\n   401→function MyTracker({\n   402→  tracker,\n   403→  onNotesChange,\n   404→  onAddChecklistItem,\n   405→  onToggleChecklistItem,\n   406→  onRemoveChecklistItem\n   407→}: {\n   408→  tracker: TrackerState;\n   409→  onNotesChange: (notes: string) => void;\n   410→  onAddChecklistItem: () => void;\n   411→  onToggleChecklistItem: (id: string) => void;\n   412→  onRemoveChecklistItem: (id: string) => void;\n   413→}) {\n   414→  return (\n   415→    <div className=\"md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full\">\n   416→      <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4\">\n   417→        <BookOpen className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n   418→        My Tracker\n   419→      </h4>\n   420→      <div className=\"space-y-3 sm:space-y-4\">\n   421→        {/* Personal Notes */}\n   422→        <div className=\"space-y-1 sm:space-y-1.5\">\n   423→          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400\">Personal Notes</label>\n   424→          <textarea\n   425→            value={tracker.notes}\n   426→            onChange={(e) => onNotesChange(e.target.value)}\n   427→            className=\"w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all\"\n   428→            placeholder=\"Track progress, questions, dates...\"\n   429→          />\n   430→        </div>\n   431→\n   432→        {/* Checklist */}\n   433→        <div className=\"space-y-1.5 sm:space-y-2 pt-1 sm:pt-2\">\n   434→          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center\">\n   435→            <span>Checklist</span>\n   436→            <button\n   437→              onClick={onAddChecklistItem}\n   438→              className=\"text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors\"\n   439→            >\n   440→              <Plus className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n   441→              Add\n   442→            </button>\n   443→          </label>\n   444→          <div className=\"space-y-1.5 sm:space-y-2\">\n   445→            {tracker.checklist.length === 0 ? (\n   446→              <div className=\"text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50\">\n   447→                No tasks yet\n   448→              </div>\n   449→            ) : (\n   450→              tracker.checklist.map((item) => (\n   451→                <div\n   452→                  key={item.id}\n   453→                  className=\"flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg\"\n   454→                >\n   455→                  <button\n   456→                    onClick={() => onToggleChecklistItem(item.id)}\n   457→                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${\n   458→                      item.completed\n   459→                        ? 'bg-emerald-500 border-emerald-500'\n   460→                        : 'border-neutral-600 hover:border-neutral-500'\n   461→                    }`}\n   462→                  >\n   463→                    {item.completed && <CheckCircle className=\"w-3 h-3 text-black\" />}\n   464→                  </button>\n   465→                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>\n   466→                    {item.text}\n   467→                  </span>\n   468→                  <button\n   469→                    onClick={() => onRemoveChecklistItem(item.id)}\n   470→                    className=\"text-neutral-600 hover:text-red-400 transition-colors\"\n   471→                  >\n   472→                    <Trash2 className=\"w-3 h-3\" />\n   473→                  </button>\n   474→                </div>\n   475→              ))\n   476→            )}\n   477→          </div>\n   478→        </div>\n   479→      </div>\n   480→    </div>\n   481→  );\n   482→}\n   483→\n   484→// ============================================\n   485→// MAIN ENHANCED RECOMMENDATION CARD\n   486→// ============================================\n   487→\n   488→export function EnhancedRecommendationCard({\n   489→  recommendation,\n   490→  isExpanded = false,\n   491→  onToggle,\n   492→  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n   493→  rank,\n   494→  onMarkComplete,\n   495→  onRemove,\n   496→  isCompleted = false,\n   497→  gender,\n   498→  ethnicity,\n   499→}: EnhancedRecommendationCardProps) {\n   500→  // Tracker state (would be persisted in real app)\n   501→  const [tracker, setTracker] = useState<TrackerState>({\n   502→    notes: '',\n   503→    checklist: [],\n   504→  });\n   505→\n   506→  // Get relevant research citations based on procedure, gender, and ethnicity\n   507→  const citations = useMemo(() => {\n   508→    return getRelevantCitations(recommendation.ref_id, gender, ethnicity);\n   509→  }, [recommendation.ref_id, gender, ethnicity]);\n   510→\n   511→  const handleNotesChange = useCallback((notes: string) => {\n   512→    setTracker(prev => ({ ...prev, notes }));\n   513→  }, []);\n   514→\n   515→  const handleAddChecklistItem = useCallback(() => {\n   516→    const text = window.prompt('Enter task:');\n   517→    if (text) {\n   518→      setTracker(prev => ({\n   519→        ...prev,\n   520→        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],\n   521→      }));\n   522→    }\n   523→  }, []);\n   524→\n   525→  const handleToggleChecklistItem = useCallback((id: string) => {\n   526→    setTracker(prev => ({\n   527→      ...prev,\n   528→      checklist: prev.checklist.map(item =>\n   529→        item.id === id ? { ...item, completed: !item.completed } : item\n   530→      ),\n   531→    }));\n   532→  }, []);\n   533→\n   534→  const handleRemoveChecklistItem = useCallback((id: string) => {\n   535→    setTracker(prev => ({\n   536→      ...prev,\n   537→      checklist: prev.checklist.filter(item => item.id !== id),\n   538→    }));\n   539→  }, []);\n   540→\n   541→  // Format cost\n   542→  const formatCost = () => {\n   543→    const { min, max, type } = recommendation.cost;\n   544→    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';\n   545→    if (min === max) {\n   546→      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n   547→    }\n   548→    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n   549→  };\n   550→\n   551→  // Format timeline\n   552→  const formatTimeline = () => {\n   553→    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;\n   554→    if (full_results_weeks_max) {\n   555→      return `${full_results_weeks}-${full_results_weeks_max} weeks`;\n   556→    }\n   557→    if (full_results_weeks >= 52) {\n   558→      const months = Math.round(full_results_weeks / 4);\n   559→      return `${months} months`;\n   560→    }\n   561→    return `${full_results_weeks} weeks`;\n   562→  };\n   563→\n   564→  // Get effectiveness level\n   565→  const getEffectiveness = () => {\n   566→    if (recommendation.impact >= 0.7) return 'high';\n   567→    if (recommendation.impact >= 0.4) return 'moderate';\n   568→    return 'low';\n   569→  };\n   570→\n   571→  return (\n   572→    <motion.div\n   573→      layout\n   574→      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${\n   575→        isExpanded\n   576→          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'\n   577→          : 'border-neutral-800 hover:border-neutral-700'\n   578→      } ${isCompleted ? 'opacity-60' : ''}`}\n   579→    >\n   580→      {/* Header - Clickable */}\n   581→      <div className=\"p-3.5 sm:p-5 cursor-pointer\" onClick={onToggle}>\n   582→        <div className=\"space-y-3 sm:space-y-4\">\n   583→          <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4\">\n   584→            <div className=\"flex-1 min-w-0\">\n   585→              <div className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2\">\n   586→                <h3 className=\"text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white\">\n   587→                  {recommendation.name}\n   588→                </h3>\n   589→                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n   590→                  <PhaseBadge phase={recommendation.phase} />\n   591→                  <ImpactBadge impact={recommendation.impact} />\n   592→                </div>\n   593→              </div>\n   594→              <p className=\"text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none\">\n   595→                {recommendation.description}\n   596→              </p>\n   597→            </div>\n   598→\n   599→            {/* Action buttons */}\n   600→            <div className=\"flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto\">\n   601→              {onMarkComplete && (\n   602→                <button\n   603→                  onClick={(e) => {\n   604→                    e.stopPropagation();\n   605→                    onMarkComplete(recommendation.ref_id);\n   606→                  }}\n   607→                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${\n   608→                    isCompleted\n   609→                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'\n   610→                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'\n   611→                  }`}\n   612→                  title=\"Mark as complete\"\n   613→                >\n   614→                  <CheckCircle className=\"w-4 h-4\" />\n   615→                </button>\n   616→              )}\n   617→              {onRemove && (\n   618→                <button\n   619→                  onClick={(e) => {\n   620→                    e.stopPropagation();\n   621→                    onRemove(recommendation.ref_id);\n   622→                  }}\n   623→                  className=\"p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10\"\n   624→                  title=\"Remove action\"\n   625→                >\n   626→                  <Trash2 className=\"w-4 h-4\" />\n   627→                </button>\n   628→              )}\n   629→            </div>\n   630→          </div>\n   631→\n   632→          {/* Quick stats row */}\n   633→          <div className=\"flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400\">\n   634→            <div className=\"flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5\">\n   635→              <div className=\"flex items-center gap-1 sm:gap-1.5\" title=\"Estimated Cost\">\n   636→                <DollarSign className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n   637→                <span className=\"font-medium text-neutral-300\">{formatCost()}</span>\n   638→              </div>\n   639→              {recommendation.timeline.full_results_weeks > 0 && (\n   640→                <div className=\"flex items-center gap-1 sm:gap-1.5\">\n   641→                  <Clock className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n   642→                  <span className=\"font-medium text-neutral-300\">{formatTimeline()}</span>\n   643→                </div>\n   644→              )}\n   645→            </div>\n   646→            <button\n   647→              className=\"flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white\"\n   648→            >\n   649→              {isExpanded ? 'Less' : 'More'}\n   650→              <ChevronDown\n   651→                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n   652→              />\n   653→            </button>\n   654→          </div>\n   655→        </div>\n   656→      </div>\n   657→\n   658→      {/* Expanded Content */}\n   659→      <AnimatePresence initial={false}>\n   660→        {isExpanded && (\n   661→          <motion.div\n   662→            initial={{ height: 0, opacity: 0 }}\n   663→            animate={{ height: 'auto', opacity: 1 }}\n   664→            exit={{ height: 0, opacity: 0 }}\n   665→            transition={{ duration: 0.3 }}\n   666→            className=\"overflow-hidden\"\n   667→          >\n   668→            <div className=\"border-t border-neutral-800 bg-neutral-900/50\">\n   669→              <div className=\"grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800\">\n   670→                {/* Main Content */}\n   671→                <div className=\"md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6\">\n   672→                  {/* Improvements */}\n   673→                  <div>\n   674→                    <SectionHeader icon={Target} title=\"Improvements\" />\n   675→                    <div className=\"space-y-2 sm:space-y-3\">\n   676→                      <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\n   677→                        {recommendation.matchedFlaws.map((flaw, i) => (\n   678→                          <ImprovementTag key={i} text={flaw} />\n   679→                        ))}\n   680→                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (\n   681→                          <ImprovementTag key={i} text={ratio} />\n   682→                        ))}\n   683→                      </div>\n   684→                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n   685→                        <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n   686→                          <div className=\"text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase\">Effectiveness</div>\n   687→                          <div className=\"h-1 w-1 rounded-full bg-neutral-600\" />\n   688→                          <div className=\"font-medium text-white capitalize text-xs sm:text-sm\">{getEffectiveness()}</div>\n   689→                        </div>\n   690→                      </div>\n   691→                    </div>\n   692→                  </div>\n   693→\n   694→                  {/* How It Helps */}\n   695→                  <div>\n   696→                    <SectionHeader icon={Info} title=\"How It Helps\" />\n   697→                    <div className=\"space-y-1.5 sm:space-y-2\">\n   698→                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n   699→                        <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n   700→                          {recommendation.description}\n   701→                        </p>\n   702→                      </div>\n   703→                      {recommendation.ratios_impacted.length > 0 && (\n   704→                        <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n   705→                          <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n   706→                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}\n   707→                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.\n   708→                          </p>\n   709→                        </div>\n   710→                      )}\n   711→                    </div>\n   712→                  </div>\n   713→\n   714→                  {/* Logistics & Timeline */}\n   715→                  {recommendation.timeline.full_results_weeks > 0 && (\n   716→                    <div>\n   717→                      <SectionHeader icon={Clock} title=\"Logistics & Timeline\" />\n   718→                      <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\n   719→                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n   720→                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n   721→                            Effect Starts\n   722→                          </span>\n   723→                          <span className=\"text-xs sm:text-sm font-medium text-white capitalize\">\n   724→                            {recommendation.timeline.effect_start}\n   725→                          </span>\n   726→                        </div>\n   727→                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n   728→                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n   729→                            Full Results\n   730→                          </span>\n   731→                          <span className=\"text-xs sm:text-sm font-medium text-white\">\n   732→                            {formatTimeline()}\n   733→                          </span>\n   734→                        </div>\n   735→                      </div>\n   736→                    </div>\n   737→                  )}\n   738→\n   739→                  {/* Considerations */}\n   740→                  <div>\n   741→                    <SectionHeader icon={AlertTriangle} title=\"Considerations\" />\n   742→                    <div className=\"space-y-2 sm:space-y-3\">\n   743→                      {/* Prerequisites */}\n   744→                      {recommendation.warnings.length > 0 && (\n   745→                        <div className=\"bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm\">\n   746→                          <span className=\"font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">Prerequisites</span>\n   747→                          <p className=\"text-blue-300/80 text-[11px] sm:text-xs leading-relaxed\">\n   748→                            {recommendation.warnings[0]}\n   749→                          </p>\n   750→                        </div>\n   751→                      )}\n   752→\n   753→                      {/* Risks & Side Effects */}\n   754→                      {recommendation.risks_side_effects && (\n   755→                        <div className=\"bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm\">\n   756→                          <span className=\"font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">\n   757→                            Risks & Side Effects\n   758→                          </span>\n   759→                          <p className=\"text-amber-300/80 text-[11px] sm:text-xs leading-relaxed\">\n   760→                            {recommendation.risks_side_effects}\n   761→                          </p>\n   762→                        </div>\n   763→                      )}\n   764→                    </div>\n   765→                  </div>\n   766→\n   767→                  {/* Notes & Warnings */}\n   768→                  {recommendation.warnings.length > 1 && (\n   769→                    <div className=\"text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic\">\n   770→                      {recommendation.warnings.slice(1).join(' ')}\n   771→                    </div>\n   772→                  )}\n   773→\n   774→                  {/* Research Citations */}\n   775→                  <div className=\"bg-cyan-500/10 p-3 sm:p-4 rounded-lg border border-cyan-500/30\">\n   776→                    <div className=\"flex items-center gap-2 mb-3\">\n   777→                      <BookOpen size={14} className=\"text-cyan-400\" />\n   778→                      <span className=\"font-semibold text-cyan-400 text-xs sm:text-sm\">Research & Evidence</span>\n   779→                      {ethnicity && ethnicity !== 'other' && (\n   780→                        <span className=\"text-[9px] px-1.5 py-0.5 bg-cyan-500/20 rounded text-cyan-300 capitalize\">\n   781→                          {ethnicity.replace('_', ' ')} focus\n   782→                        </span>\n   783→                      )}\n   784→                    </div>\n   785→                    {citations.length > 0 ? (\n   786→                      <div className=\"space-y-2.5\">\n   787→                        {citations.map((citation, idx) => (\n   788→                          <div key={idx} className=\"text-[11px] sm:text-xs bg-neutral-900/50 p-2.5 rounded-lg border border-neutral-700/50\">\n   789→                            <div className=\"flex items-start justify-between gap-2\">\n   790→                              <div className=\"flex-1\">\n   791→                                <div className=\"font-medium text-cyan-300 mb-0.5 line-clamp-2\">\n   792→                                  {citation.title}\n   793→                                </div>\n   794→                                <div className=\"text-neutral-500 text-[10px] mb-1\">\n   795→                                  {citation.authors} • {citation.journal} ({citation.year})\n   796→                                </div>\n   797→                                <div className=\"text-neutral-400 leading-relaxed\">\n   798→                                  {citation.summary}\n   799→                                </div>\n   800→                              </div>\n   801→                              {citation.doi && (\n   802→                                <a\n   803→                                  href={`https://doi.org/${citation.doi}`}\n   804→                                  target=\"_blank\"\n   805→                                  rel=\"noopener noreferrer\"\n   806→                                  className=\"flex-shrink-0 p-1 text-cyan-400 hover:text-cyan-300 transition-colors\"\n   807→                                  title=\"View full paper\"\n   808→                                >\n   809→                                  <ExternalLink size={12} />\n   810→                                </a>\n   811→                              )}\n   812→                            </div>\n   813→                          </div>\n   814→                        ))}\n   815→                      </div>\n   816→                    ) : (\n   817→                      <div className=\"text-[11px] sm:text-xs text-cyan-300/70\">\n   818→                        {recommendation.matchedFlaws.length > 0\n   819→                          ? 'Based on facial analysis and established aesthetic research. More specific citations coming soon.'\n   820→                          : 'No specific research citations available for this recommendation.'}\n   821→                      </div>\n   822→                    )}\n   823→                  </div>\n   824→                </div>\n   825→\n   826→                {/* My Tracker Sidebar */}\n   827→                <MyTracker\n   828→                  tracker={tracker}\n   829→                  onNotesChange={handleNotesChange}\n   830→                  onAddChecklistItem={handleAddChecklistItem}\n   831→                  onToggleChecklistItem={handleToggleChecklistItem}\n   832→                  onRemoveChecklistItem={handleRemoveChecklistItem}\n   833→                />\n   834→              </div>\n   835→            </div>\n   836→          </motion.div>\n   837→        )}\n   838→      </AnimatePresence>\n   839→    </motion.div>\n   840→  );\n   841→}\n   842→\n   843→export default EnhancedRecommendationCard;\n   844→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2fc2d3aa-3753-49af-b9b0-54444a0491b7","timestamp":"2025-12-24T20:19:03.874Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","content":"'use client';\n\nimport { useState, useCallback, useMemo } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  ChevronDown,\n  Clock,\n  DollarSign,\n  AlertTriangle,\n  Target,\n  Info,\n  BookOpen,\n  CheckCircle,\n  Trash2,\n  Plus,\n  Sparkles,\n  ExternalLink,\n} from 'lucide-react';\nimport { Recommendation } from '@/types/results';\nimport { Gender, Ethnicity } from '@/lib/faceiq-scoring';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface EnhancedRecommendationCardProps {\n  recommendation: Recommendation;\n  isExpanded?: boolean;\n  onToggle?: () => void;\n  rank?: number;\n  onMarkComplete?: (id: string) => void;\n  onRemove?: (id: string) => void;\n  isCompleted?: boolean;\n  gender?: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// RESEARCH CITATIONS DATABASE\n// ============================================\n\ninterface ResearchCitation {\n  title: string;\n  authors: string;\n  journal: string;\n  year: number;\n  doi?: string;\n  summary: string;\n  procedureRefs: string[];  // Matches recommendation ref_id\n  genderRelevance?: 'male' | 'female' | 'both';\n  ethnicityRelevance?: Ethnicity[];\n}\n\nconst RESEARCH_CITATIONS: ResearchCitation[] = [\n  // Rhinoplasty Research\n  {\n    title: 'Ethnic Considerations in Rhinoplasty',\n    authors: 'Rohrich RJ, Bolden K',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2010,\n    doi: '10.1097/PRS.0b013e3181c6b2b7',\n    summary: 'Discusses the importance of preserving ethnic identity while achieving aesthetic goals in rhinoplasty across different ethnicities.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black', 'east_asian', 'south_asian', 'middle_eastern', 'hispanic'],\n  },\n  {\n    title: 'The Male Rhinoplasty',\n    authors: 'Foda HM',\n    journal: 'Facial Plastic Surgery',\n    year: 2008,\n    summary: 'Examines unique considerations for male rhinoplasty including maintaining masculine features and avoiding feminization.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'male',\n  },\n  // Jaw/Chin Research\n  {\n    title: 'Sliding Genioplasty: A Systematic Review',\n    authors: 'Park JH, Tae-Hoon K',\n    journal: 'Journal of Oral and Maxillofacial Surgery',\n    year: 2018,\n    summary: 'Comprehensive analysis of chin advancement outcomes and patient satisfaction rates across demographics.',\n    procedureRefs: ['SUR-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Gender Differences in Jaw Angle Aesthetics',\n    authors: 'Kim YH, Cho J',\n    journal: 'Aesthetic Plastic Surgery',\n    year: 2020,\n    summary: 'Research on ideal jaw angle parameters for males (90-110°) versus females (110-120°).',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Mandibular Angle Augmentation in Asian Patients',\n    authors: 'Lee YJ, Park KS',\n    journal: 'Asian Journal of Beauty and Cosmetology',\n    year: 2019,\n    summary: 'Study on jaw angle enhancement specific to East Asian facial structure and aesthetic preferences.',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Lip Research\n  {\n    title: 'Ideal Lip Proportions Across Ethnicities',\n    authors: 'Farkas LG, Katic MJ',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2003,\n    summary: 'Anthropometric study establishing ethnic-specific ideal lip ratios and proportions.',\n    procedureRefs: ['MIN-01', 'FND-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['white', 'black', 'east_asian', 'hispanic'],\n  },\n  {\n    title: 'Lip Enhancement in African American Patients',\n    authors: 'Mack WP',\n    journal: 'Facial Plastic Surgery Clinics',\n    year: 2014,\n    summary: 'Guidelines for maintaining ethnic characteristics while enhancing lip aesthetics.',\n    procedureRefs: ['MIN-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black'],\n  },\n  // Eye/Canthal Research\n  {\n    title: 'Canthal Tilt and Facial Attractiveness',\n    authors: 'Rhee SC, et al.',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2017,\n    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n    procedureRefs: ['SUR-05', 'MIN-04'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Asian Blepharoplasty and Canthopexy',\n    authors: 'Chen WP',\n    journal: 'Ophthalmic Plastic Surgery',\n    year: 2016,\n    summary: 'Specific techniques for Asian eyelid surgery that preserve ethnic identity while enhancing eye shape.',\n    procedureRefs: ['SUR-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Midface/Cheek Research\n  {\n    title: 'Cheekbone Enhancement for Facial Harmony',\n    authors: 'Mendelson B, Wong CH',\n    journal: 'Clinics in Plastic Surgery',\n    year: 2015,\n    summary: 'Analysis of malar augmentation effects on overall facial harmony and perceived attractiveness.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Midface Aesthetics in Middle Eastern Populations',\n    authors: 'Rohrich RJ, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2021,\n    summary: 'Ethnic considerations for midface enhancement in Middle Eastern patients.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['middle_eastern'],\n  },\n  // Foundational/Non-Surgical Research\n  {\n    title: 'Mewing and Orthotropic Treatment',\n    authors: 'Mew J, Mew M',\n    journal: 'International Journal of Orthodontics',\n    year: 2014,\n    summary: 'Research on proper tongue posture and its effects on facial development and structure.',\n    procedureRefs: ['FND-02', 'FND-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Effects of Body Composition on Facial Aesthetics',\n    authors: 'Morrison CS, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2017,\n    summary: 'Study on how body fat percentage affects facial definition and perceived attractiveness.',\n    procedureRefs: ['FND-04', 'FND-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Grooming and First Impressions',\n    authors: 'Phelan C, Etcoff N',\n    journal: 'Journal of Applied Social Psychology',\n    year: 2011,\n    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n    procedureRefs: ['FND-04', 'FND-05'],\n    genderRelevance: 'both',\n  },\n  // Orthognathic Research\n  {\n    title: 'Bimaxillary Surgery Outcomes',\n    authors: 'Rustemeyer J, et al.',\n    journal: 'Journal of Cranio-Maxillofacial Surgery',\n    year: 2019,\n    summary: 'Long-term outcomes and patient satisfaction following double jaw surgery.',\n    procedureRefs: ['SUR-04'],\n    genderRelevance: 'both',\n  },\n  // General Attractiveness Research\n  {\n    title: 'Cross-Cultural Facial Attractiveness',\n    authors: 'Perrett DI, et al.',\n    journal: 'Nature',\n    year: 1998,\n    summary: 'Landmark study on universal vs. culture-specific aspects of facial attractiveness.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Golden Ratios in Facial Beauty',\n    authors: 'Marquardt SR',\n    journal: 'International Journal of Cosmetic Surgery',\n    year: 2002,\n    summary: 'Analysis of mathematical proportions and their relationship to perceived facial beauty.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06', 'MIN-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n];\n\nfunction getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  // Calculate relevance score for sorting\n  function calculateRelevance(citation: ResearchCitation): number {\n    let score = 0;\n\n    // Base score: procedure is in the list\n    if (!citation.procedureRefs.includes(procedureRefId)) return -1;\n\n    // Procedure specificity: fewer refs = more specific to this procedure (+20 max)\n    score += Math.max(0, 20 - (citation.procedureRefs.length * 3));\n\n    // Gender relevance scoring\n    if (gender && citation.genderRelevance) {\n      if (citation.genderRelevance === gender) {\n        // Exact gender match - highest priority (+30)\n        score += 30;\n      } else if (citation.genderRelevance === 'both') {\n        // General/both - neutral (+10)\n        score += 10;\n      } else {\n        // Wrong gender - exclude\n        return -1;\n      }\n    } else {\n      // No gender specified or citation has no gender preference\n      score += 10;\n    }\n\n    // Ethnicity relevance scoring\n    if (ethnicity && ethnicity !== 'other' && citation.ethnicityRelevance) {\n      if (citation.ethnicityRelevance.includes(ethnicity)) {\n        // Exact ethnicity match - high priority (+25)\n        score += 25;\n        // Bonus for ethnicity-specific studies (fewer ethnicities = more focused)\n        score += Math.max(0, 15 - (citation.ethnicityRelevance.length * 2));\n      } else {\n        // Citation is ethnicity-specific but doesn't match user - lower priority\n        // Still include unless very specific (1-2 ethnicities)\n        if (citation.ethnicityRelevance.length <= 2) {\n          return -1; // Too specific for different ethnicity\n        }\n        score += 5; // General enough to still be useful\n      }\n    } else {\n      // No ethnicity filter or citation applies to all\n      score += 10;\n    }\n\n    // Recency bonus: newer studies slightly preferred\n    const yearBonus = Math.max(0, (citation.year - 2000) * 0.5);\n    score += yearBonus;\n\n    return score;\n  }\n\n  // Filter, score, sort, and take top 3\n  return RESEARCH_CITATIONS\n    .map(citation => ({ citation, relevance: calculateRelevance(citation) }))\n    .filter(item => item.relevance >= 0)\n    .sort((a, b) => b.relevance - a.relevance)\n    .slice(0, 3)\n    .map(item => item.citation);\n}\n\ninterface TrackerState {\n  notes: string;\n  checklist: Array<{ id: string; text: string; completed: boolean }>;\n}\n\n// ============================================\n// PHASE BADGE (Dark Theme)\n// ============================================\n\nfunction PhaseBadge({ phase }: { phase: string }) {\n  const getPhaseConfig = () => {\n    switch (phase) {\n      case 'Foundational':\n        return {\n          bg: 'bg-emerald-500/20',\n          text: 'text-emerald-400',\n          border: 'border-emerald-500/30',\n        };\n      case 'Minimally Invasive':\n        return {\n          bg: 'bg-blue-500/20',\n          text: 'text-blue-400',\n          border: 'border-blue-500/30',\n        };\n      case 'Surgical':\n        return {\n          bg: 'bg-purple-500/20',\n          text: 'text-purple-400',\n          border: 'border-purple-500/30',\n        };\n      default:\n        return {\n          bg: 'bg-neutral-500/20',\n          text: 'text-neutral-400',\n          border: 'border-neutral-500/30',\n        };\n    }\n  };\n\n  const config = getPhaseConfig();\n\n  return (\n    <span\n      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}\n    >\n      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}\n    </span>\n  );\n}\n\n// ============================================\n// IMPACT BADGE\n// ============================================\n\nfunction ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {\n  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);\n\n  return (\n    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n      <span className=\"flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0\">\n        <Sparkles className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n        {formattedImpact}\n      </span>\n      {(frontImpact !== undefined || sideImpact !== undefined) && (\n        <span className=\"hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0\">\n          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}\n          </span>\n          <span className=\"text-neutral-600\">|</span>\n          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}\n          </span>\n        </span>\n      )}\n    </div>\n  );\n}\n\n// ============================================\n// IMPROVEMENT TAG\n// ============================================\n\nfunction ImprovementTag({ text }: { text: string }) {\n  return (\n    <div className=\"inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm\">\n      <CheckCircle className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0\" />\n      <span className=\"truncate\">{text}</span>\n    </div>\n  );\n}\n\n// ============================================\n// SECTION HEADER\n// ============================================\n\nfunction SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {\n  return (\n    <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3\">\n      <Icon className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n      {title}\n    </h4>\n  );\n}\n\n// ============================================\n// MY TRACKER SECTION\n// ============================================\n\nfunction MyTracker({\n  tracker,\n  onNotesChange,\n  onAddChecklistItem,\n  onToggleChecklistItem,\n  onRemoveChecklistItem\n}: {\n  tracker: TrackerState;\n  onNotesChange: (notes: string) => void;\n  onAddChecklistItem: () => void;\n  onToggleChecklistItem: (id: string) => void;\n  onRemoveChecklistItem: (id: string) => void;\n}) {\n  return (\n    <div className=\"md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full\">\n      <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4\">\n        <BookOpen className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n        My Tracker\n      </h4>\n      <div className=\"space-y-3 sm:space-y-4\">\n        {/* Personal Notes */}\n        <div className=\"space-y-1 sm:space-y-1.5\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400\">Personal Notes</label>\n          <textarea\n            value={tracker.notes}\n            onChange={(e) => onNotesChange(e.target.value)}\n            className=\"w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all\"\n            placeholder=\"Track progress, questions, dates...\"\n          />\n        </div>\n\n        {/* Checklist */}\n        <div className=\"space-y-1.5 sm:space-y-2 pt-1 sm:pt-2\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center\">\n            <span>Checklist</span>\n            <button\n              onClick={onAddChecklistItem}\n              className=\"text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors\"\n            >\n              <Plus className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n              Add\n            </button>\n          </label>\n          <div className=\"space-y-1.5 sm:space-y-2\">\n            {tracker.checklist.length === 0 ? (\n              <div className=\"text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50\">\n                No tasks yet\n              </div>\n            ) : (\n              tracker.checklist.map((item) => (\n                <div\n                  key={item.id}\n                  className=\"flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg\"\n                >\n                  <button\n                    onClick={() => onToggleChecklistItem(item.id)}\n                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${\n                      item.completed\n                        ? 'bg-emerald-500 border-emerald-500'\n                        : 'border-neutral-600 hover:border-neutral-500'\n                    }`}\n                  >\n                    {item.completed && <CheckCircle className=\"w-3 h-3 text-black\" />}\n                  </button>\n                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>\n                    {item.text}\n                  </span>\n                  <button\n                    onClick={() => onRemoveChecklistItem(item.id)}\n                    className=\"text-neutral-600 hover:text-red-400 transition-colors\"\n                  >\n                    <Trash2 className=\"w-3 h-3\" />\n                  </button>\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// MAIN ENHANCED RECOMMENDATION CARD\n// ============================================\n\nexport function EnhancedRecommendationCard({\n  recommendation,\n  isExpanded = false,\n  onToggle,\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  rank,\n  onMarkComplete,\n  onRemove,\n  isCompleted = false,\n  gender,\n  ethnicity,\n}: EnhancedRecommendationCardProps) {\n  // Tracker state (would be persisted in real app)\n  const [tracker, setTracker] = useState<TrackerState>({\n    notes: '',\n    checklist: [],\n  });\n\n  // Get relevant research citations based on procedure, gender, and ethnicity\n  const citations = useMemo(() => {\n    return getRelevantCitations(recommendation.ref_id, gender, ethnicity);\n  }, [recommendation.ref_id, gender, ethnicity]);\n\n  const handleNotesChange = useCallback((notes: string) => {\n    setTracker(prev => ({ ...prev, notes }));\n  }, []);\n\n  const handleAddChecklistItem = useCallback(() => {\n    const text = window.prompt('Enter task:');\n    if (text) {\n      setTracker(prev => ({\n        ...prev,\n        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],\n      }));\n    }\n  }, []);\n\n  const handleToggleChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.map(item =>\n        item.id === id ? { ...item, completed: !item.completed } : item\n      ),\n    }));\n  }, []);\n\n  const handleRemoveChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.filter(item => item.id !== id),\n    }));\n  }, []);\n\n  // Format cost\n  const formatCost = () => {\n    const { min, max, type } = recommendation.cost;\n    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';\n    if (min === max) {\n      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n    }\n    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n  };\n\n  // Format timeline\n  const formatTimeline = () => {\n    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;\n    if (full_results_weeks_max) {\n      return `${full_results_weeks}-${full_results_weeks_max} weeks`;\n    }\n    if (full_results_weeks >= 52) {\n      const months = Math.round(full_results_weeks / 4);\n      return `${months} months`;\n    }\n    return `${full_results_weeks} weeks`;\n  };\n\n  // Get effectiveness level\n  const getEffectiveness = () => {\n    if (recommendation.impact >= 0.7) return 'high';\n    if (recommendation.impact >= 0.4) return 'moderate';\n    return 'low';\n  };\n\n  return (\n    <motion.div\n      layout\n      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${\n        isExpanded\n          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'\n          : 'border-neutral-800 hover:border-neutral-700'\n      } ${isCompleted ? 'opacity-60' : ''}`}\n    >\n      {/* Header - Clickable */}\n      <div className=\"p-3.5 sm:p-5 cursor-pointer\" onClick={onToggle}>\n        <div className=\"space-y-3 sm:space-y-4\">\n          <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2\">\n                <h3 className=\"text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white\">\n                  {recommendation.name}\n                </h3>\n                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n                  <PhaseBadge phase={recommendation.phase} />\n                  <ImpactBadge impact={recommendation.impact} />\n                </div>\n              </div>\n              <p className=\"text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none\">\n                {recommendation.description}\n              </p>\n            </div>\n\n            {/* Action buttons */}\n            <div className=\"flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto\">\n              {onMarkComplete && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onMarkComplete(recommendation.ref_id);\n                  }}\n                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${\n                    isCompleted\n                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'\n                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'\n                  }`}\n                  title=\"Mark as complete\"\n                >\n                  <CheckCircle className=\"w-4 h-4\" />\n                </button>\n              )}\n              {onRemove && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onRemove(recommendation.ref_id);\n                  }}\n                  className=\"p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10\"\n                  title=\"Remove action\"\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </button>\n              )}\n            </div>\n          </div>\n\n          {/* Quick stats row */}\n          <div className=\"flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400\">\n            <div className=\"flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5\">\n              <div className=\"flex items-center gap-1 sm:gap-1.5\" title=\"Estimated Cost\">\n                <DollarSign className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                <span className=\"font-medium text-neutral-300\">{formatCost()}</span>\n              </div>\n              {recommendation.timeline.full_results_weeks > 0 && (\n                <div className=\"flex items-center gap-1 sm:gap-1.5\">\n                  <Clock className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                  <span className=\"font-medium text-neutral-300\">{formatTimeline()}</span>\n                </div>\n              )}\n            </div>\n            <button\n              className=\"flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white\"\n            >\n              {isExpanded ? 'Less' : 'More'}\n              <ChevronDown\n                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n              />\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded Content */}\n      <AnimatePresence initial={false}>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.3 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"border-t border-neutral-800 bg-neutral-900/50\">\n              <div className=\"grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800\">\n                {/* Main Content */}\n                <div className=\"md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6\">\n                  {/* Improvements */}\n                  <div>\n                    <SectionHeader icon={Target} title=\"Improvements\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\n                        {recommendation.matchedFlaws.map((flaw, i) => (\n                          <ImprovementTag key={i} text={flaw} />\n                        ))}\n                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (\n                          <ImprovementTag key={i} text={ratio} />\n                        ))}\n                      </div>\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n                          <div className=\"text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase\">Effectiveness</div>\n                          <div className=\"h-1 w-1 rounded-full bg-neutral-600\" />\n                          <div className=\"font-medium text-white capitalize text-xs sm:text-sm\">{getEffectiveness()}</div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* How It Helps */}\n                  <div>\n                    <SectionHeader icon={Info} title=\"How It Helps\" />\n                    <div className=\"space-y-1.5 sm:space-y-2\">\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                          {recommendation.description}\n                        </p>\n                      </div>\n                      {recommendation.ratios_impacted.length > 0 && (\n                        <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                          <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}\n                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Logistics & Timeline */}\n                  {recommendation.timeline.full_results_weeks > 0 && (\n                    <div>\n                      <SectionHeader icon={Clock} title=\"Logistics & Timeline\" />\n                      <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Effect Starts\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white capitalize\">\n                            {recommendation.timeline.effect_start}\n                          </span>\n                        </div>\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Full Results\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white\">\n                            {formatTimeline()}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Considerations */}\n                  <div>\n                    <SectionHeader icon={AlertTriangle} title=\"Considerations\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      {/* Prerequisites */}\n                      {recommendation.warnings.length > 0 && (\n                        <div className=\"bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm\">\n                          <span className=\"font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">Prerequisites</span>\n                          <p className=\"text-blue-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.warnings[0]}\n                          </p>\n                        </div>\n                      )}\n\n                      {/* Risks & Side Effects */}\n                      {recommendation.risks_side_effects && (\n                        <div className=\"bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm\">\n                          <span className=\"font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">\n                            Risks & Side Effects\n                          </span>\n                          <p className=\"text-amber-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.risks_side_effects}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Notes & Warnings */}\n                  {recommendation.warnings.length > 1 && (\n                    <div className=\"text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic\">\n                      {recommendation.warnings.slice(1).join(' ')}\n                    </div>\n                  )}\n\n                  {/* Research Citations */}\n                  <div className=\"bg-cyan-500/10 p-3 sm:p-4 rounded-lg border border-cyan-500/30\">\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <BookOpen size={14} className=\"text-cyan-400\" />\n                      <span className=\"font-semibold text-cyan-400 text-xs sm:text-sm\">Research & Evidence</span>\n                      {ethnicity && ethnicity !== 'other' && (\n                        <span className=\"text-[9px] px-1.5 py-0.5 bg-cyan-500/20 rounded text-cyan-300 capitalize\">\n                          {ethnicity.replace('_', ' ')} focus\n                        </span>\n                      )}\n                    </div>\n                    {citations.length > 0 ? (\n                      <div className=\"space-y-2.5\">\n                        {citations.map((citation, idx) => (\n                          <div key={idx} className=\"text-[11px] sm:text-xs bg-neutral-900/50 p-2.5 rounded-lg border border-neutral-700/50\">\n                            <div className=\"flex items-start justify-between gap-2\">\n                              <div className=\"flex-1\">\n                                <div className=\"font-medium text-cyan-300 mb-0.5 line-clamp-2\">\n                                  {citation.title}\n                                </div>\n                                <div className=\"text-neutral-500 text-[10px] mb-1\">\n                                  {citation.authors} • {citation.journal} ({citation.year})\n                                </div>\n                                <div className=\"text-neutral-400 leading-relaxed\">\n                                  {citation.summary}\n                                </div>\n                              </div>\n                              {citation.doi && (\n                                <a\n                                  href={`https://doi.org/${citation.doi}`}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"flex-shrink-0 p-1 text-cyan-400 hover:text-cyan-300 transition-colors\"\n                                  title=\"View full paper\"\n                                >\n                                  <ExternalLink size={12} />\n                                </a>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-[11px] sm:text-xs text-cyan-300/70\">\n                        {recommendation.matchedFlaws.length > 0\n                          ? 'Based on facial analysis and established aesthetic research. More specific citations coming soon.'\n                          : 'No specific research citations available for this recommendation.'}\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* My Tracker Sidebar */}\n                <MyTracker\n                  tracker={tracker}\n                  onNotesChange={handleNotesChange}\n                  onAddChecklistItem={handleAddChecklistItem}\n                  onToggleChecklistItem={handleToggleChecklistItem}\n                  onRemoveChecklistItem={handleRemoveChecklistItem}\n                />\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\nexport default EnhancedRecommendationCard;\n","numLines":844,"startLine":1,"totalLines":844}}}
{"parentUuid":"2fc2d3aa-3753-49af-b9b0-54444a0491b7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0186hBwek2Qx5kzUMKmmg9Mm","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check if there are any before/after visualizations or outcome prediction files:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":13544,"cache_read_input_tokens":37868,"cache_creation":{"ephemeral_5m_input_tokens":13544,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWS8YaP6i1hRzYXKbn5Wm","type":"assistant","uuid":"3fe18d9a-ad93-44c6-b6ac-a65829bd8363","timestamp":"2025-12-24T20:19:05.808Z"}
{"parentUuid":"3fe18d9a-ad93-44c6-b6ac-a65829bd8363","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0186hBwek2Qx5kzUMKmmg9Mm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BAvaXCSJrbNzQQ7jjE8rVM","name":"Glob","input":{"pattern":"**/visualization/**/*.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":13544,"cache_read_input_tokens":37868,"cache_creation":{"ephemeral_5m_input_tokens":13544,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWS8YaP6i1hRzYXKbn5Wm","type":"assistant","uuid":"298778d5-c019-4b73-8686-adfbf6ef2700","timestamp":"2025-12-24T20:19:06.075Z"}
{"parentUuid":"298778d5-c019-4b73-8686-adfbf6ef2700","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0186hBwek2Qx5kzUMKmmg9Mm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XCTRgxoM4Ejy5XAQUbXucg","name":"Grep","input":{"pattern":"before|after|overlay|prediction|potential","type":"tsx","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":13544,"cache_read_input_tokens":37868,"cache_creation":{"ephemeral_5m_input_tokens":13544,"ephemeral_1h_input_tokens":0},"output_tokens":177,"service_tier":"standard"}},"requestId":"req_011CWS8YaP6i1hRzYXKbn5Wm","type":"assistant","uuid":"5711d8c6-8881-4b40-91e4-1ee18a0326f5","timestamp":"2025-12-24T20:19:06.783Z"}
{"parentUuid":"5711d8c6-8881-4b40-91e4-1ee18a0326f5","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BAvaXCSJrbNzQQ7jjE8rVM","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/IdealRangeBar.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FacialRadarChart.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/GradientRangeBar.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx"}]},"uuid":"3f4d094f-3105-4519-8184-0fe75c2fc027","timestamp":"2025-12-24T20:19:07.259Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/IdealRangeBar.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FacialRadarChart.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/GradientRangeBar.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx"],"durationMs":423,"numFiles":4,"truncated":false}}
{"parentUuid":"3f4d094f-3105-4519-8184-0fe75c2fc027","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XCTRgxoM4Ejy5XAQUbXucg","type":"tool_result","content":"No files found"}]},"uuid":"6b0bd82f-9a7e-41f5-88b9-cb6b71eca83d","timestamp":"2025-12-24T20:19:07.318Z","toolUseResult":{"mode":"files_with_matches","filenames":[],"numFiles":0}}
{"parentUuid":"6b0bd82f-9a7e-41f5-88b9-cb6b71eca83d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PB8o4yhedEViWPJX2stWTC","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the FaceOverlay component to see if it has before/after visualization:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":524,"cache_read_input_tokens":51412,"cache_creation":{"ephemeral_5m_input_tokens":524,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWS8YqA6vTYa3BSaQjRoQ","type":"assistant","uuid":"cb830cf5-abe7-453f-a30d-f8b4bb15c94c","timestamp":"2025-12-24T20:19:08.969Z"}
{"parentUuid":"cb830cf5-abe7-453f-a30d-f8b4bb15c94c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01PB8o4yhedEViWPJX2stWTC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01T4p6U2x3dwQhC34UHbyAtD","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":524,"cache_read_input_tokens":51412,"cache_creation":{"ephemeral_5m_input_tokens":524,"ephemeral_1h_input_tokens":0},"output_tokens":106,"service_tier":"standard"}},"requestId":"req_011CWS8YqA6vTYa3BSaQjRoQ","type":"assistant","uuid":"5f67076d-01ad-4c1d-8eb0-ccdf3a22447b","timestamp":"2025-12-24T20:19:09.204Z"}
{"parentUuid":"5f67076d-01ad-4c1d-8eb0-ccdf3a22447b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01T4p6U2x3dwQhC34UHbyAtD","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useMemo, useState, useEffect, useRef } from 'react';\n     4→import { motion, AnimatePresence } from 'framer-motion';\n     5→import Image from 'next/image';\n     6→import { Eye, ZoomIn, ZoomOut, Maximize2, Crosshair } from 'lucide-react';\n     7→import { LandmarkPoint } from '@/lib/landmarks';\n     8→import { Ratio, getScoreColor, getCategoryColor } from '@/types/results';\n     9→\n    10→interface FaceOverlayProps {\n    11→  photo: string;\n    12→  landmarks: LandmarkPoint[];\n    13→  selectedRatio: Ratio | null;\n    14→  profileType: 'front' | 'side';\n    15→  showAllLandmarks?: boolean;\n    16→  compact?: boolean; // For smaller inline previews\n    17→}\n    18→\n    19→interface ImageDimensions {\n    20→  naturalWidth: number;\n    21→  naturalHeight: number;\n    22→  aspectRatio: number;\n    23→}\n    24→\n    25→// Calculate label position along a line\n    26→function getLabelPosition(\n    27→  x1: number, y1: number, x2: number, y2: number,\n    28→  position: 'start' | 'middle' | 'end' = 'middle'\n    29→): { x: number; y: number; anchor: string } {\n    30→  const t = position === 'start' ? 0.15 : position === 'end' ? 0.85 : 0.5;\n    31→  const x = x1 + (x2 - x1) * t;\n    32→  const y = y1 + (y2 - y1) * t;\n    33→\n    34→  // Calculate perpendicular offset for label\n    35→  const dx = x2 - x1;\n    36→  const dy = y2 - y1;\n    37→  const len = Math.sqrt(dx * dx + dy * dy);\n    38→  const offsetX = len > 0 ? (-dy / len) * 2.5 : 0;\n    39→  const offsetY = len > 0 ? (dx / len) * 2.5 : 0;\n    40→\n    41→  return {\n    42→    x: x + offsetX,\n    43→    y: y + offsetY,\n    44→    anchor: dx > 0 ? 'start' : 'end'\n    45→  };\n    46→}\n    47→\n    48→// Calculate angle between three points (in degrees)\n    49→function calculateAngle(p1: { x: number; y: number }, vertex: { x: number; y: number }, p3: { x: number; y: number }): number {\n    50→  const v1 = { x: p1.x - vertex.x, y: p1.y - vertex.y };\n    51→  const v2 = { x: p3.x - vertex.x, y: p3.y - vertex.y };\n    52→\n    53→  const dot = v1.x * v2.x + v1.y * v2.y;\n    54→  const cross = v1.x * v2.y - v1.y * v2.x;\n    55→\n    56→  return Math.atan2(Math.abs(cross), dot) * (180 / Math.PI);\n    57→}\n    58→\n    59→export function FaceOverlay({\n    60→  photo,\n    61→  landmarks,\n    62→  selectedRatio,\n    63→  profileType,\n    64→  showAllLandmarks: initialShowAllLandmarks = false,\n    65→  compact = false,\n    66→}: FaceOverlayProps) {\n    67→  const [zoom, setZoom] = useState(1);\n    68→  const [showAllLandmarks, setShowAllLandmarks] = useState(initialShowAllLandmarks);\n    69→  const [imageDimensions, setImageDimensions] = useState<ImageDimensions | null>(null);\n    70→  const containerRef = useRef<HTMLDivElement>(null);\n    71→\n    72→  // Load image dimensions for proper aspect ratio handling\n    73→  useEffect(() => {\n    74→    const img = new window.Image();\n    75→    img.onload = () => {\n    76→      setImageDimensions({\n    77→        naturalWidth: img.naturalWidth,\n    78→        naturalHeight: img.naturalHeight,\n    79→        aspectRatio: img.naturalWidth / img.naturalHeight,\n    80→      });\n    81→    };\n    82→    img.src = photo;\n    83→  }, [photo]);\n    84→\n    85→  // Get landmark positions by ID\n    86→  const landmarkMap = useMemo(() => {\n    87→    const map: Record<string, LandmarkPoint> = {};\n    88→    landmarks.forEach(l => {\n    89→      map[l.id] = l;\n    90→    });\n    91→    return map;\n    92→  }, [landmarks]);\n    93→\n    94→  // Compute viewBox dimensions based on image aspect ratio\n    95→  const viewBoxDimensions = useMemo(() => {\n    96→    if (!imageDimensions) {\n    97→      // Default 3:4 portrait aspect ratio\n    98→      return { width: 75, height: 100, viewBox: '0 0 75 100' };\n    99→    }\n   100→    const ar = imageDimensions.aspectRatio;\n   101→    if (ar >= 1) {\n   102→      // Landscape or square: width = 100, height = 100/ar\n   103→      const width = 100;\n   104→      const height = 100 / ar;\n   105→      return { width, height, viewBox: `0 0 ${width} ${height}` };\n   106→    } else {\n   107→      // Portrait: width = 100*ar, height = 100\n   108→      const width = 100 * ar;\n   109→      const height = 100;\n   110→      return { width, height, viewBox: `0 0 ${width} ${height}` };\n   111→    }\n   112→  }, [imageDimensions]);\n   113→\n   114→  // Get lines, points, and labels to draw for selected ratio\n   115→  const visualizationData = useMemo(() => {\n   116→    if (!selectedRatio?.illustration) return null;\n   117→\n   118→    const { width: vbW, height: vbH } = viewBoxDimensions;\n   119→\n   120→    const points: Array<{ x: number; y: number; id: string; label?: string }> = [];\n   121→    const lines: Array<{\n   122→      x1: number; y1: number; x2: number; y2: number;\n   123→      color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end'\n   124→    }> = [];\n   125→    const angles: Array<{\n   126→      vertex: { x: number; y: number };\n   127→      p1: { x: number; y: number };\n   128→      p2: { x: number; y: number };\n   129→      color: string;\n   130→      angle: number;\n   131→    }> = [];\n   132→\n   133→    // Process points\n   134→    Object.entries(selectedRatio.illustration.points).forEach(([key, point]) => {\n   135→      if (point.type === 'landmark' && point.landmarkId) {\n   136→        const landmark = landmarkMap[point.landmarkId];\n   137→        if (landmark) {\n   138→          points.push({\n   139→            x: landmark.x * vbW,\n   140→            y: landmark.y * vbH,\n   141→            id: point.landmarkId,\n   142→            label: landmark.label,\n   143→          });\n   144→        }\n   145→      } else if (point.x !== undefined && point.y !== undefined) {\n   146→        points.push({\n   147→          x: point.x * vbW,\n   148→          y: point.y * vbH,\n   149→          id: key,\n   150→          label: point.label,\n   151→        });\n   152→      }\n   153→    });\n   154→\n   155→    // Process lines\n   156→    Object.entries(selectedRatio.illustration.lines).forEach(([, line]) => {\n   157→      const fromLandmark = landmarkMap[line.from];\n   158→      const toLandmark = landmarkMap[line.to];\n   159→\n   160→      if (fromLandmark && toLandmark) {\n   161→        lines.push({\n   162→          x1: fromLandmark.x * vbW,\n   163→          y1: fromLandmark.y * vbH,\n   164→          x2: toLandmark.x * vbW,\n   165→          y2: toLandmark.y * vbH,\n   166→          color: line.color || getCategoryColor(selectedRatio.category),\n   167→          label: line.label,\n   168→          labelPosition: line.labelPosition,\n   169→        });\n   170→      }\n   171→    });\n   172→\n   173→    // Detect if this is an angle measurement (3 connected points forming an angle)\n   174→    // Look for patterns like: line1 ends where line2 starts (shared vertex)\n   175→    // Use relative tolerance based on viewBox size\n   176→    const tolerance = Math.max(vbW, vbH) * 0.01;\n   177→\n   178→    if (lines.length === 2) {\n   179→      const l1 = lines[0];\n   180→      const l2 = lines[1];\n   181→\n   182→      // Check for shared vertex\n   183→      let sharedVertex: { x: number; y: number } | null = null;\n   184→      let p1: { x: number; y: number } | null = null;\n   185→      let p2: { x: number; y: number } | null = null;\n   186→\n   187→      // l1 end connects to l2 start\n   188→      if (Math.abs(l1.x2 - l2.x1) < tolerance && Math.abs(l1.y2 - l2.y1) < tolerance) {\n   189→        sharedVertex = { x: l1.x2, y: l1.y2 };\n   190→        p1 = { x: l1.x1, y: l1.y1 };\n   191→        p2 = { x: l2.x2, y: l2.y2 };\n   192→      }\n   193→      // l1 start connects to l2 start\n   194→      else if (Math.abs(l1.x1 - l2.x1) < tolerance && Math.abs(l1.y1 - l2.y1) < tolerance) {\n   195→        sharedVertex = { x: l1.x1, y: l1.y1 };\n   196→        p1 = { x: l1.x2, y: l1.y2 };\n   197→        p2 = { x: l2.x2, y: l2.y2 };\n   198→      }\n   199→      // l1 end connects to l2 end\n   200→      else if (Math.abs(l1.x2 - l2.x2) < tolerance && Math.abs(l1.y2 - l2.y2) < tolerance) {\n   201→        sharedVertex = { x: l1.x2, y: l1.y2 };\n   202→        p1 = { x: l1.x1, y: l1.y1 };\n   203→        p2 = { x: l2.x1, y: l2.y1 };\n   204→      }\n   205→      // l1 start connects to l2 end\n   206→      else if (Math.abs(l1.x1 - l2.x2) < tolerance && Math.abs(l1.y1 - l2.y2) < tolerance) {\n   207→        sharedVertex = { x: l1.x1, y: l1.y1 };\n   208→        p1 = { x: l1.x2, y: l1.y2 };\n   209→        p2 = { x: l2.x1, y: l2.y1 };\n   210→      }\n   211→\n   212→      if (sharedVertex && p1 && p2) {\n   213→        const angle = calculateAngle(p1, sharedVertex, p2);\n   214→        angles.push({\n   215→          vertex: sharedVertex,\n   216→          p1,\n   217→          p2,\n   218→          color: l1.color,\n   219→          angle,\n   220→        });\n   221→      }\n   222→    }\n   223→\n   224→    return { points, lines, angles };\n   225→  }, [selectedRatio, landmarkMap, viewBoxDimensions]);\n   226→\n   227→  // Generate arc path for angle visualization\n   228→  const generateArcPath = (\n   229→    vertex: { x: number; y: number },\n   230→    p1: { x: number; y: number },\n   231→    p2: { x: number; y: number },\n   232→    radius: number = 4\n   233→  ): string => {\n   234→    // Calculate angles for the arc\n   235→    const angle1 = Math.atan2(p1.y - vertex.y, p1.x - vertex.x);\n   236→    const angle2 = Math.atan2(p2.y - vertex.y, p2.x - vertex.x);\n   237→\n   238→    // Arc endpoints\n   239→    const x1 = vertex.x + radius * Math.cos(angle1);\n   240→    const y1 = vertex.y + radius * Math.sin(angle1);\n   241→    const x2 = vertex.x + radius * Math.cos(angle2);\n   242→    const y2 = vertex.y + radius * Math.sin(angle2);\n   243→\n   244→    // Determine if we should use the large arc\n   245→    let angleDiff = angle2 - angle1;\n   246→    if (angleDiff < 0) angleDiff += 2 * Math.PI;\n   247→    const largeArc = angleDiff > Math.PI ? 1 : 0;\n   248→\n   249→    return `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`;\n   250→  };\n   251→\n   252→  return (\n   253→    <div className={`bg-neutral-900/80 border border-neutral-800 rounded-xl overflow-hidden ${compact ? 'text-xs' : ''}`}>\n   254→      {/* Header */}\n   255→      {!compact && (\n   256→        <div className=\"p-3 border-b border-neutral-800 flex items-center justify-between\">\n   257→          <h4 className=\"text-sm font-medium text-white\">\n   258→            {profileType === 'front' ? 'Front' : 'Side'} Profile\n   259→          </h4>\n   260→          <div className=\"flex items-center gap-1\">\n   261→            {/* Landmark toggle */}\n   262→            <button\n   263→              onClick={() => setShowAllLandmarks(!showAllLandmarks)}\n   264→              className={`p-1.5 rounded transition-colors ${\n   265→                showAllLandmarks\n   266→                  ? 'bg-cyan-500/20 text-cyan-400'\n   267→                  : 'hover:bg-neutral-800 text-neutral-500'\n   268→              }`}\n   269→              title={showAllLandmarks ? 'Hide all landmarks' : 'Show all landmarks'}\n   270→            >\n   271→              <Crosshair size={16} />\n   272→            </button>\n   273→\n   274→            <div className=\"w-px h-4 bg-neutral-700 mx-1\" />\n   275→\n   276→            <button\n   277→              onClick={() => setZoom(z => Math.max(1, z - 0.25))}\n   278→              className=\"p-1.5 hover:bg-neutral-800 rounded transition-colors\"\n   279→              disabled={zoom <= 1}\n   280→            >\n   281→              <ZoomOut size={16} className={zoom <= 1 ? 'text-neutral-700' : 'text-neutral-500'} />\n   282→            </button>\n   283→            <span className=\"text-xs text-neutral-500 w-10 text-center\">{Math.round(zoom * 100)}%</span>\n   284→            <button\n   285→              onClick={() => setZoom(z => Math.min(2, z + 0.25))}\n   286→              className=\"p-1.5 hover:bg-neutral-800 rounded transition-colors\"\n   287→              disabled={zoom >= 2}\n   288→            >\n   289→              <ZoomIn size={16} className={zoom >= 2 ? 'text-neutral-700' : 'text-neutral-500'} />\n   290→            </button>\n   291→            {zoom !== 1 && (\n   292→              <button\n   293→                onClick={() => setZoom(1)}\n   294→                className=\"p-1.5 hover:bg-neutral-800 rounded transition-colors ml-1\"\n   295→              >\n   296→                <Maximize2 size={16} className=\"text-neutral-500\" />\n   297→              </button>\n   298→            )}\n   299→          </div>\n   300→        </div>\n   301→      )}\n   302→\n   303→      {/* Image container */}\n   304→      <div\n   305→        ref={containerRef}\n   306→        className={`relative ${compact ? 'aspect-square' : 'aspect-[3/4]'} bg-neutral-950 overflow-hidden`}\n   307→      >\n   308→        {/* Photo with zoom */}\n   309→        <div\n   310→          className=\"absolute inset-0 transition-transform duration-200 ease-out\"\n   311→          style={{\n   312→            transform: `scale(${zoom})`,\n   313→            transformOrigin: 'center center'\n   314→          }}\n   315→        >\n   316→          <Image\n   317→            src={photo}\n   318→            alt={`${profileType} profile`}\n   319→            fill\n   320→            className=\"object-contain\"\n   321→            unoptimized\n   322→          />\n   323→\n   324→          {/* SVG Overlay - matches object-contain positioning */}\n   325→          <svg\n   326→            className=\"absolute inset-0 w-full h-full pointer-events-none\"\n   327→            viewBox={viewBoxDimensions.viewBox}\n   328→            preserveAspectRatio=\"xMidYMid meet\"\n   329→          >\n   330→            {/* Defs for filters and gradients */}\n   331→            <defs>\n   332→              <filter id=\"glow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\n   333→                <feGaussianBlur stdDeviation=\"0.5\" result=\"coloredBlur\"/>\n   334→                <feMerge>\n   335→                  <feMergeNode in=\"coloredBlur\"/>\n   336→                  <feMergeNode in=\"SourceGraphic\"/>\n   337→                </feMerge>\n   338→              </filter>\n   339→              <filter id=\"dropShadow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\n   340→                <feDropShadow dx=\"0\" dy=\"0\" stdDeviation=\"0.3\" floodOpacity=\"0.8\"/>\n   341→              </filter>\n   342→            </defs>\n   343→\n   344→            {/* All landmarks (optional) */}\n   345→            {showAllLandmarks && landmarks.map((landmark) => {\n   346→              const { width: vbW, height: vbH } = viewBoxDimensions;\n   347→              const baseSize = Math.max(vbW, vbH);\n   348→\n   349→              return (\n   350→                <g key={landmark.id}>\n   351→                  {/* Outer glow */}\n   352→                  <circle\n   353→                    cx={landmark.x * vbW}\n   354→                    cy={landmark.y * vbH}\n   355→                    r={baseSize * 0.012}\n   356→                    fill=\"#67e8f9\"\n   357→                    opacity=\"0.25\"\n   358→                  />\n   359→                  {/* Main point */}\n   360→                  <circle\n   361→                    cx={landmark.x * vbW}\n   362→                    cy={landmark.y * vbH}\n   363→                    r={baseSize * 0.005}\n   364→                    fill=\"#67e8f9\"\n   365→                    stroke=\"#0e7490\"\n   366→                    strokeWidth={baseSize * 0.002}\n   367→                  />\n   368→                </g>\n   369→              );\n   370→            })}\n   371→\n   372→            {/* Selected ratio visualization */}\n   373→            <AnimatePresence>\n   374→              {visualizationData && (() => {\n   375→                // Calculate relative sizes based on viewBox\n   376→                const { width: vbW, height: vbH } = viewBoxDimensions;\n   377→                const baseSize = Math.max(vbW, vbH);\n   378→                const strokeGlow = baseSize * 0.012;\n   379→                const strokeMain = baseSize * 0.005;\n   380→                const fontSize = baseSize * 0.02;\n   381→                const pointRadiusOuter = baseSize * 0.02;\n   382→                const pointRadiusRing = baseSize * 0.012;\n   383→                const pointRadiusInner = baseSize * 0.006;\n   384→                const arcRadius = baseSize * 0.05;\n   385→\n   386→                return (\n   387→                  <g filter=\"url(#glow)\">\n   388→                    {/* Lines with glow effect */}\n   389→                    {visualizationData.lines.map((line, i) => (\n   390→                      <g key={`line-group-${i}`}>\n   391→                        {/* Glow/shadow line */}\n   392→                        <motion.line\n   393→                          x1={line.x1}\n   394→                          y1={line.y1}\n   395→                          x2={line.x2}\n   396→                          y2={line.y2}\n   397→                          stroke={line.color}\n   398→                          strokeWidth={strokeGlow}\n   399→                          strokeLinecap=\"round\"\n   400→                          opacity=\"0.3\"\n   401→                          initial={{ pathLength: 0 }}\n   402→                          animate={{ pathLength: 1 }}\n   403→                          exit={{ pathLength: 0 }}\n   404→                          transition={{ duration: 0.5 }}\n   405→                        />\n   406→                        {/* Main line */}\n   407→                        <motion.line\n   408→                          x1={line.x1}\n   409→                          y1={line.y1}\n   410→                          x2={line.x2}\n   411→                          y2={line.y2}\n   412→                          stroke={line.color}\n   413→                          strokeWidth={strokeMain}\n   414→                          strokeLinecap=\"round\"\n   415→                          initial={{ pathLength: 0, opacity: 0 }}\n   416→                          animate={{ pathLength: 1, opacity: 1 }}\n   417→                          exit={{ pathLength: 0, opacity: 0 }}\n   418→                          transition={{ duration: 0.5 }}\n   419→                        />\n   420→                        {/* Line label */}\n   421→                        {line.label && !compact && (\n   422→                          <motion.g\n   423→                            initial={{ opacity: 0 }}\n   424→                            animate={{ opacity: 1 }}\n   425→                            exit={{ opacity: 0 }}\n   426→                            transition={{ delay: 0.3 }}\n   427→                          >\n   428→                            {(() => {\n   429→                              const labelPos = getLabelPosition(\n   430→                                line.x1, line.y1, line.x2, line.y2,\n   431→                                line.labelPosition || 'middle'\n   432→                              );\n   433→                              const labelPadding = fontSize * 0.5;\n   434→                              return (\n   435→                                <>\n   436→                                  {/* Label background */}\n   437→                                  <rect\n   438→                                    x={labelPos.x - labelPadding}\n   439→                                    y={labelPos.y - fontSize * 0.7}\n   440→                                    width={line.label.length * fontSize * 0.65 + labelPadding * 2}\n   441→                                    height={fontSize * 1.4}\n   442→                                    fill=\"rgba(0,0,0,0.75)\"\n   443→                                    rx={fontSize * 0.2}\n   444→                                  />\n   445→                                  {/* Label text */}\n   446→                                  <text\n   447→                                    x={labelPos.x}\n   448→                                    y={labelPos.y}\n   449→                                    fill={line.color}\n   450→                                    fontSize={fontSize}\n   451→                                    fontWeight=\"600\"\n   452→                                    fontFamily=\"system-ui, sans-serif\"\n   453→                                    dominantBaseline=\"middle\"\n   454→                                    textAnchor=\"start\"\n   455→                                  >\n   456→                                    {line.label}\n   457→                                  </text>\n   458→                                </>\n   459→                              );\n   460→                            })()}\n   461→                          </motion.g>\n   462→                        )}\n   463→                      </g>\n   464→                    ))}\n   465→\n   466→                    {/* Angle arcs */}\n   467→                    {visualizationData.angles.map((angle, i) => (\n   468→                      <motion.g key={`angle-${i}`}>\n   469→                        {/* Arc */}\n   470→                        <motion.path\n   471→                          d={generateArcPath(angle.vertex, angle.p1, angle.p2, arcRadius)}\n   472→                          fill=\"none\"\n   473→                          stroke={angle.color}\n   474→                          strokeWidth={strokeMain * 0.8}\n   475→                          strokeDasharray={`${baseSize * 0.01} ${baseSize * 0.005}`}\n   476→                          initial={{ pathLength: 0, opacity: 0 }}\n   477→                          animate={{ pathLength: 1, opacity: 0.8 }}\n   478→                          exit={{ pathLength: 0, opacity: 0 }}\n   479→                          transition={{ duration: 0.5, delay: 0.2 }}\n   480→                        />\n   481→                        {/* Angle value label */}\n   482→                        {!compact && (\n   483→                          <motion.g\n   484→                            initial={{ opacity: 0, scale: 0 }}\n   485→                            animate={{ opacity: 1, scale: 1 }}\n   486→                            exit={{ opacity: 0, scale: 0 }}\n   487→                            transition={{ delay: 0.5 }}\n   488→                          >\n   489→                            <rect\n   490→                              x={angle.vertex.x + fontSize}\n   491→                              y={angle.vertex.y - fontSize * 1.5}\n   492→                              width={fontSize * 2.8}\n   493→                              height={fontSize * 1.4}\n   494→                              fill=\"rgba(0,0,0,0.8)\"\n   495→                              rx={fontSize * 0.2}\n   496→                            />\n   497→                            <text\n   498→                              x={angle.vertex.x + fontSize * 2.4}\n   499→                              y={angle.vertex.y - fontSize * 0.8}\n   500→                              fill={angle.color}\n   501→                              fontSize={fontSize}\n   502→                              fontWeight=\"bold\"\n   503→                              fontFamily=\"system-ui, sans-serif\"\n   504→                              textAnchor=\"middle\"\n   505→                              dominantBaseline=\"middle\"\n   506→                            >\n   507→                              {Math.round(angle.angle)}°\n   508→                            </text>\n   509→                          </motion.g>\n   510→                        )}\n   511→                      </motion.g>\n   512→                    ))}\n   513→\n   514→                    {/* Points with enhanced styling */}\n   515→                    {visualizationData.points.map((point, i) => (\n   516→                      <motion.g\n   517→                        key={`point-${i}`}\n   518→                        initial={{ scale: 0, opacity: 0 }}\n   519→                        animate={{ scale: 1, opacity: 1 }}\n   520→                        exit={{ scale: 0, opacity: 0 }}\n   521→                        transition={{ duration: 0.3, delay: i * 0.05 }}\n   522→                      >\n   523→                        {/* Outer glow pulse */}\n   524→                        <motion.circle\n   525→                          cx={point.x}\n   526→                          cy={point.y}\n   527→                          r={pointRadiusOuter}\n   528→                          fill={getCategoryColor(selectedRatio?.category || '')}\n   529→                          opacity=\"0.15\"\n   530→                          animate={{\n   531→                            r: [pointRadiusOuter, pointRadiusOuter * 1.25, pointRadiusOuter],\n   532→                            opacity: [0.15, 0.25, 0.15]\n   533→                          }}\n   534→                          transition={{\n   535→                            duration: 2,\n   536→                            repeat: Infinity,\n   537→                            ease: \"easeInOut\"\n   538→                          }}\n   539→                        />\n   540→                        {/* Outer ring */}\n   541→                        <circle\n   542→                          cx={point.x}\n   543→                          cy={point.y}\n   544→                          r={pointRadiusRing}\n   545→                          fill=\"none\"\n   546→                          stroke={getCategoryColor(selectedRatio?.category || '')}\n   547→                          strokeWidth={pointRadiusInner * 0.3}\n   548→                          opacity=\"0.5\"\n   549→                        />\n   550→                        {/* Inner dot */}\n   551→                        <circle\n   552→                          cx={point.x}\n   553→                          cy={point.y}\n   554→                          r={pointRadiusInner}\n   555→                          fill=\"#fff\"\n   556→                          stroke={getCategoryColor(selectedRatio?.category || '')}\n   557→                          strokeWidth={pointRadiusInner * 0.25}\n   558→                        />\n   559→                      </motion.g>\n   560→                    ))}\n   561→                  </g>\n   562→                );\n   563→              })()}\n   564→            </AnimatePresence>\n   565→          </svg>\n   566→        </div>\n   567→\n   568→        {/* No selection message */}\n   569→        {!selectedRatio && (\n   570→          <div className=\"absolute inset-0 flex items-center justify-center bg-black/40\">\n   571→            <div className=\"text-center p-4\">\n   572→              <Eye size={compact ? 24 : 32} className=\"mx-auto text-neutral-600 mb-2\" />\n   573→              <p className={`text-neutral-500 ${compact ? 'text-xs' : 'text-sm'}`}>\n   574→                {compact ? 'Click a ratio to visualize' : 'Expand a measurement card\\nto see it visualized here'}\n   575→              </p>\n   576→            </div>\n   577→          </div>\n   578→        )}\n   579→      </div>\n   580→\n   581→      {/* Selected ratio info */}\n   582→      {selectedRatio && !compact && (\n   583→        <motion.div\n   584→          className=\"p-3 border-t border-neutral-800\"\n   585→          initial={{ opacity: 0, y: 10 }}\n   586→          animate={{ opacity: 1, y: 0 }}\n   587→        >\n   588→          <div className=\"flex items-center justify-between\">\n   589→            <div>\n   590→              <h5 className=\"text-sm font-medium text-white\">{selectedRatio.name}</h5>\n   591→              <p className=\"text-xs text-neutral-500\">{selectedRatio.category}</p>\n   592→            </div>\n   593→            <div\n   594→              className=\"px-2 py-1 rounded text-sm font-bold\"\n   595→              style={{\n   596→                backgroundColor: `${getScoreColor(selectedRatio.score)}15`,\n   597→                color: getScoreColor(selectedRatio.score),\n   598→              }}\n   599→            >\n   600→              {selectedRatio.score.toFixed(1)}\n   601→            </div>\n   602→          </div>\n   603→\n   604→          {/* Landmarks used */}\n   605→          {selectedRatio.usedLandmarks && selectedRatio.usedLandmarks.length > 0 && (\n   606→            <div className=\"mt-2\">\n   607→              <p className=\"text-xs text-neutral-500 mb-1\">Landmarks used:</p>\n   608→              <div className=\"flex flex-wrap gap-1\">\n   609→                {selectedRatio.usedLandmarks.slice(0, 4).map(id => {\n   610→                  const landmark = landmarkMap[id];\n   611→                  return (\n   612→                    <span\n   613→                      key={id}\n   614→                      className=\"px-1.5 py-0.5 bg-neutral-800 rounded text-[10px] text-neutral-400\"\n   615→                    >\n   616→                      {landmark?.label || id}\n   617→                    </span>\n   618→                  );\n   619→                })}\n   620→                {selectedRatio.usedLandmarks.length > 4 && (\n   621→                  <span className=\"px-1.5 py-0.5 text-[10px] text-neutral-500\">\n   622→                    +{selectedRatio.usedLandmarks.length - 4} more\n   623→                  </span>\n   624→                )}\n   625→              </div>\n   626→            </div>\n   627→          )}\n   628→        </motion.div>\n   629→      )}\n   630→\n   631→      {/* Compact info bar */}\n   632→      {selectedRatio && compact && (\n   633→        <div className=\"px-2 py-1.5 border-t border-neutral-800 flex items-center justify-between\">\n   634→          <span className=\"text-xs text-white truncate\">{selectedRatio.name}</span>\n   635→          <span\n   636→            className=\"text-xs font-bold ml-2\"\n   637→            style={{ color: getScoreColor(selectedRatio.score) }}\n   638→          >\n   639→            {selectedRatio.score.toFixed(1)}\n   640→          </span>\n   641→        </div>\n   642→      )}\n   643→    </div>\n   644→  );\n   645→}\n   646→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"192103e3-6613-43fa-93b4-bf7005d4b71a","timestamp":"2025-12-24T20:19:09.248Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx","content":"'use client';\n\nimport { useMemo, useState, useEffect, useRef } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport Image from 'next/image';\nimport { Eye, ZoomIn, ZoomOut, Maximize2, Crosshair } from 'lucide-react';\nimport { LandmarkPoint } from '@/lib/landmarks';\nimport { Ratio, getScoreColor, getCategoryColor } from '@/types/results';\n\ninterface FaceOverlayProps {\n  photo: string;\n  landmarks: LandmarkPoint[];\n  selectedRatio: Ratio | null;\n  profileType: 'front' | 'side';\n  showAllLandmarks?: boolean;\n  compact?: boolean; // For smaller inline previews\n}\n\ninterface ImageDimensions {\n  naturalWidth: number;\n  naturalHeight: number;\n  aspectRatio: number;\n}\n\n// Calculate label position along a line\nfunction getLabelPosition(\n  x1: number, y1: number, x2: number, y2: number,\n  position: 'start' | 'middle' | 'end' = 'middle'\n): { x: number; y: number; anchor: string } {\n  const t = position === 'start' ? 0.15 : position === 'end' ? 0.85 : 0.5;\n  const x = x1 + (x2 - x1) * t;\n  const y = y1 + (y2 - y1) * t;\n\n  // Calculate perpendicular offset for label\n  const dx = x2 - x1;\n  const dy = y2 - y1;\n  const len = Math.sqrt(dx * dx + dy * dy);\n  const offsetX = len > 0 ? (-dy / len) * 2.5 : 0;\n  const offsetY = len > 0 ? (dx / len) * 2.5 : 0;\n\n  return {\n    x: x + offsetX,\n    y: y + offsetY,\n    anchor: dx > 0 ? 'start' : 'end'\n  };\n}\n\n// Calculate angle between three points (in degrees)\nfunction calculateAngle(p1: { x: number; y: number }, vertex: { x: number; y: number }, p3: { x: number; y: number }): number {\n  const v1 = { x: p1.x - vertex.x, y: p1.y - vertex.y };\n  const v2 = { x: p3.x - vertex.x, y: p3.y - vertex.y };\n\n  const dot = v1.x * v2.x + v1.y * v2.y;\n  const cross = v1.x * v2.y - v1.y * v2.x;\n\n  return Math.atan2(Math.abs(cross), dot) * (180 / Math.PI);\n}\n\nexport function FaceOverlay({\n  photo,\n  landmarks,\n  selectedRatio,\n  profileType,\n  showAllLandmarks: initialShowAllLandmarks = false,\n  compact = false,\n}: FaceOverlayProps) {\n  const [zoom, setZoom] = useState(1);\n  const [showAllLandmarks, setShowAllLandmarks] = useState(initialShowAllLandmarks);\n  const [imageDimensions, setImageDimensions] = useState<ImageDimensions | null>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  // Load image dimensions for proper aspect ratio handling\n  useEffect(() => {\n    const img = new window.Image();\n    img.onload = () => {\n      setImageDimensions({\n        naturalWidth: img.naturalWidth,\n        naturalHeight: img.naturalHeight,\n        aspectRatio: img.naturalWidth / img.naturalHeight,\n      });\n    };\n    img.src = photo;\n  }, [photo]);\n\n  // Get landmark positions by ID\n  const landmarkMap = useMemo(() => {\n    const map: Record<string, LandmarkPoint> = {};\n    landmarks.forEach(l => {\n      map[l.id] = l;\n    });\n    return map;\n  }, [landmarks]);\n\n  // Compute viewBox dimensions based on image aspect ratio\n  const viewBoxDimensions = useMemo(() => {\n    if (!imageDimensions) {\n      // Default 3:4 portrait aspect ratio\n      return { width: 75, height: 100, viewBox: '0 0 75 100' };\n    }\n    const ar = imageDimensions.aspectRatio;\n    if (ar >= 1) {\n      // Landscape or square: width = 100, height = 100/ar\n      const width = 100;\n      const height = 100 / ar;\n      return { width, height, viewBox: `0 0 ${width} ${height}` };\n    } else {\n      // Portrait: width = 100*ar, height = 100\n      const width = 100 * ar;\n      const height = 100;\n      return { width, height, viewBox: `0 0 ${width} ${height}` };\n    }\n  }, [imageDimensions]);\n\n  // Get lines, points, and labels to draw for selected ratio\n  const visualizationData = useMemo(() => {\n    if (!selectedRatio?.illustration) return null;\n\n    const { width: vbW, height: vbH } = viewBoxDimensions;\n\n    const points: Array<{ x: number; y: number; id: string; label?: string }> = [];\n    const lines: Array<{\n      x1: number; y1: number; x2: number; y2: number;\n      color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end'\n    }> = [];\n    const angles: Array<{\n      vertex: { x: number; y: number };\n      p1: { x: number; y: number };\n      p2: { x: number; y: number };\n      color: string;\n      angle: number;\n    }> = [];\n\n    // Process points\n    Object.entries(selectedRatio.illustration.points).forEach(([key, point]) => {\n      if (point.type === 'landmark' && point.landmarkId) {\n        const landmark = landmarkMap[point.landmarkId];\n        if (landmark) {\n          points.push({\n            x: landmark.x * vbW,\n            y: landmark.y * vbH,\n            id: point.landmarkId,\n            label: landmark.label,\n          });\n        }\n      } else if (point.x !== undefined && point.y !== undefined) {\n        points.push({\n          x: point.x * vbW,\n          y: point.y * vbH,\n          id: key,\n          label: point.label,\n        });\n      }\n    });\n\n    // Process lines\n    Object.entries(selectedRatio.illustration.lines).forEach(([, line]) => {\n      const fromLandmark = landmarkMap[line.from];\n      const toLandmark = landmarkMap[line.to];\n\n      if (fromLandmark && toLandmark) {\n        lines.push({\n          x1: fromLandmark.x * vbW,\n          y1: fromLandmark.y * vbH,\n          x2: toLandmark.x * vbW,\n          y2: toLandmark.y * vbH,\n          color: line.color || getCategoryColor(selectedRatio.category),\n          label: line.label,\n          labelPosition: line.labelPosition,\n        });\n      }\n    });\n\n    // Detect if this is an angle measurement (3 connected points forming an angle)\n    // Look for patterns like: line1 ends where line2 starts (shared vertex)\n    // Use relative tolerance based on viewBox size\n    const tolerance = Math.max(vbW, vbH) * 0.01;\n\n    if (lines.length === 2) {\n      const l1 = lines[0];\n      const l2 = lines[1];\n\n      // Check for shared vertex\n      let sharedVertex: { x: number; y: number } | null = null;\n      let p1: { x: number; y: number } | null = null;\n      let p2: { x: number; y: number } | null = null;\n\n      // l1 end connects to l2 start\n      if (Math.abs(l1.x2 - l2.x1) < tolerance && Math.abs(l1.y2 - l2.y1) < tolerance) {\n        sharedVertex = { x: l1.x2, y: l1.y2 };\n        p1 = { x: l1.x1, y: l1.y1 };\n        p2 = { x: l2.x2, y: l2.y2 };\n      }\n      // l1 start connects to l2 start\n      else if (Math.abs(l1.x1 - l2.x1) < tolerance && Math.abs(l1.y1 - l2.y1) < tolerance) {\n        sharedVertex = { x: l1.x1, y: l1.y1 };\n        p1 = { x: l1.x2, y: l1.y2 };\n        p2 = { x: l2.x2, y: l2.y2 };\n      }\n      // l1 end connects to l2 end\n      else if (Math.abs(l1.x2 - l2.x2) < tolerance && Math.abs(l1.y2 - l2.y2) < tolerance) {\n        sharedVertex = { x: l1.x2, y: l1.y2 };\n        p1 = { x: l1.x1, y: l1.y1 };\n        p2 = { x: l2.x1, y: l2.y1 };\n      }\n      // l1 start connects to l2 end\n      else if (Math.abs(l1.x1 - l2.x2) < tolerance && Math.abs(l1.y1 - l2.y2) < tolerance) {\n        sharedVertex = { x: l1.x1, y: l1.y1 };\n        p1 = { x: l1.x2, y: l1.y2 };\n        p2 = { x: l2.x1, y: l2.y1 };\n      }\n\n      if (sharedVertex && p1 && p2) {\n        const angle = calculateAngle(p1, sharedVertex, p2);\n        angles.push({\n          vertex: sharedVertex,\n          p1,\n          p2,\n          color: l1.color,\n          angle,\n        });\n      }\n    }\n\n    return { points, lines, angles };\n  }, [selectedRatio, landmarkMap, viewBoxDimensions]);\n\n  // Generate arc path for angle visualization\n  const generateArcPath = (\n    vertex: { x: number; y: number },\n    p1: { x: number; y: number },\n    p2: { x: number; y: number },\n    radius: number = 4\n  ): string => {\n    // Calculate angles for the arc\n    const angle1 = Math.atan2(p1.y - vertex.y, p1.x - vertex.x);\n    const angle2 = Math.atan2(p2.y - vertex.y, p2.x - vertex.x);\n\n    // Arc endpoints\n    const x1 = vertex.x + radius * Math.cos(angle1);\n    const y1 = vertex.y + radius * Math.sin(angle1);\n    const x2 = vertex.x + radius * Math.cos(angle2);\n    const y2 = vertex.y + radius * Math.sin(angle2);\n\n    // Determine if we should use the large arc\n    let angleDiff = angle2 - angle1;\n    if (angleDiff < 0) angleDiff += 2 * Math.PI;\n    const largeArc = angleDiff > Math.PI ? 1 : 0;\n\n    return `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`;\n  };\n\n  return (\n    <div className={`bg-neutral-900/80 border border-neutral-800 rounded-xl overflow-hidden ${compact ? 'text-xs' : ''}`}>\n      {/* Header */}\n      {!compact && (\n        <div className=\"p-3 border-b border-neutral-800 flex items-center justify-between\">\n          <h4 className=\"text-sm font-medium text-white\">\n            {profileType === 'front' ? 'Front' : 'Side'} Profile\n          </h4>\n          <div className=\"flex items-center gap-1\">\n            {/* Landmark toggle */}\n            <button\n              onClick={() => setShowAllLandmarks(!showAllLandmarks)}\n              className={`p-1.5 rounded transition-colors ${\n                showAllLandmarks\n                  ? 'bg-cyan-500/20 text-cyan-400'\n                  : 'hover:bg-neutral-800 text-neutral-500'\n              }`}\n              title={showAllLandmarks ? 'Hide all landmarks' : 'Show all landmarks'}\n            >\n              <Crosshair size={16} />\n            </button>\n\n            <div className=\"w-px h-4 bg-neutral-700 mx-1\" />\n\n            <button\n              onClick={() => setZoom(z => Math.max(1, z - 0.25))}\n              className=\"p-1.5 hover:bg-neutral-800 rounded transition-colors\"\n              disabled={zoom <= 1}\n            >\n              <ZoomOut size={16} className={zoom <= 1 ? 'text-neutral-700' : 'text-neutral-500'} />\n            </button>\n            <span className=\"text-xs text-neutral-500 w-10 text-center\">{Math.round(zoom * 100)}%</span>\n            <button\n              onClick={() => setZoom(z => Math.min(2, z + 0.25))}\n              className=\"p-1.5 hover:bg-neutral-800 rounded transition-colors\"\n              disabled={zoom >= 2}\n            >\n              <ZoomIn size={16} className={zoom >= 2 ? 'text-neutral-700' : 'text-neutral-500'} />\n            </button>\n            {zoom !== 1 && (\n              <button\n                onClick={() => setZoom(1)}\n                className=\"p-1.5 hover:bg-neutral-800 rounded transition-colors ml-1\"\n              >\n                <Maximize2 size={16} className=\"text-neutral-500\" />\n              </button>\n            )}\n          </div>\n        </div>\n      )}\n\n      {/* Image container */}\n      <div\n        ref={containerRef}\n        className={`relative ${compact ? 'aspect-square' : 'aspect-[3/4]'} bg-neutral-950 overflow-hidden`}\n      >\n        {/* Photo with zoom */}\n        <div\n          className=\"absolute inset-0 transition-transform duration-200 ease-out\"\n          style={{\n            transform: `scale(${zoom})`,\n            transformOrigin: 'center center'\n          }}\n        >\n          <Image\n            src={photo}\n            alt={`${profileType} profile`}\n            fill\n            className=\"object-contain\"\n            unoptimized\n          />\n\n          {/* SVG Overlay - matches object-contain positioning */}\n          <svg\n            className=\"absolute inset-0 w-full h-full pointer-events-none\"\n            viewBox={viewBoxDimensions.viewBox}\n            preserveAspectRatio=\"xMidYMid meet\"\n          >\n            {/* Defs for filters and gradients */}\n            <defs>\n              <filter id=\"glow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\n                <feGaussianBlur stdDeviation=\"0.5\" result=\"coloredBlur\"/>\n                <feMerge>\n                  <feMergeNode in=\"coloredBlur\"/>\n                  <feMergeNode in=\"SourceGraphic\"/>\n                </feMerge>\n              </filter>\n              <filter id=\"dropShadow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\n                <feDropShadow dx=\"0\" dy=\"0\" stdDeviation=\"0.3\" floodOpacity=\"0.8\"/>\n              </filter>\n            </defs>\n\n            {/* All landmarks (optional) */}\n            {showAllLandmarks && landmarks.map((landmark) => {\n              const { width: vbW, height: vbH } = viewBoxDimensions;\n              const baseSize = Math.max(vbW, vbH);\n\n              return (\n                <g key={landmark.id}>\n                  {/* Outer glow */}\n                  <circle\n                    cx={landmark.x * vbW}\n                    cy={landmark.y * vbH}\n                    r={baseSize * 0.012}\n                    fill=\"#67e8f9\"\n                    opacity=\"0.25\"\n                  />\n                  {/* Main point */}\n                  <circle\n                    cx={landmark.x * vbW}\n                    cy={landmark.y * vbH}\n                    r={baseSize * 0.005}\n                    fill=\"#67e8f9\"\n                    stroke=\"#0e7490\"\n                    strokeWidth={baseSize * 0.002}\n                  />\n                </g>\n              );\n            })}\n\n            {/* Selected ratio visualization */}\n            <AnimatePresence>\n              {visualizationData && (() => {\n                // Calculate relative sizes based on viewBox\n                const { width: vbW, height: vbH } = viewBoxDimensions;\n                const baseSize = Math.max(vbW, vbH);\n                const strokeGlow = baseSize * 0.012;\n                const strokeMain = baseSize * 0.005;\n                const fontSize = baseSize * 0.02;\n                const pointRadiusOuter = baseSize * 0.02;\n                const pointRadiusRing = baseSize * 0.012;\n                const pointRadiusInner = baseSize * 0.006;\n                const arcRadius = baseSize * 0.05;\n\n                return (\n                  <g filter=\"url(#glow)\">\n                    {/* Lines with glow effect */}\n                    {visualizationData.lines.map((line, i) => (\n                      <g key={`line-group-${i}`}>\n                        {/* Glow/shadow line */}\n                        <motion.line\n                          x1={line.x1}\n                          y1={line.y1}\n                          x2={line.x2}\n                          y2={line.y2}\n                          stroke={line.color}\n                          strokeWidth={strokeGlow}\n                          strokeLinecap=\"round\"\n                          opacity=\"0.3\"\n                          initial={{ pathLength: 0 }}\n                          animate={{ pathLength: 1 }}\n                          exit={{ pathLength: 0 }}\n                          transition={{ duration: 0.5 }}\n                        />\n                        {/* Main line */}\n                        <motion.line\n                          x1={line.x1}\n                          y1={line.y1}\n                          x2={line.x2}\n                          y2={line.y2}\n                          stroke={line.color}\n                          strokeWidth={strokeMain}\n                          strokeLinecap=\"round\"\n                          initial={{ pathLength: 0, opacity: 0 }}\n                          animate={{ pathLength: 1, opacity: 1 }}\n                          exit={{ pathLength: 0, opacity: 0 }}\n                          transition={{ duration: 0.5 }}\n                        />\n                        {/* Line label */}\n                        {line.label && !compact && (\n                          <motion.g\n                            initial={{ opacity: 0 }}\n                            animate={{ opacity: 1 }}\n                            exit={{ opacity: 0 }}\n                            transition={{ delay: 0.3 }}\n                          >\n                            {(() => {\n                              const labelPos = getLabelPosition(\n                                line.x1, line.y1, line.x2, line.y2,\n                                line.labelPosition || 'middle'\n                              );\n                              const labelPadding = fontSize * 0.5;\n                              return (\n                                <>\n                                  {/* Label background */}\n                                  <rect\n                                    x={labelPos.x - labelPadding}\n                                    y={labelPos.y - fontSize * 0.7}\n                                    width={line.label.length * fontSize * 0.65 + labelPadding * 2}\n                                    height={fontSize * 1.4}\n                                    fill=\"rgba(0,0,0,0.75)\"\n                                    rx={fontSize * 0.2}\n                                  />\n                                  {/* Label text */}\n                                  <text\n                                    x={labelPos.x}\n                                    y={labelPos.y}\n                                    fill={line.color}\n                                    fontSize={fontSize}\n                                    fontWeight=\"600\"\n                                    fontFamily=\"system-ui, sans-serif\"\n                                    dominantBaseline=\"middle\"\n                                    textAnchor=\"start\"\n                                  >\n                                    {line.label}\n                                  </text>\n                                </>\n                              );\n                            })()}\n                          </motion.g>\n                        )}\n                      </g>\n                    ))}\n\n                    {/* Angle arcs */}\n                    {visualizationData.angles.map((angle, i) => (\n                      <motion.g key={`angle-${i}`}>\n                        {/* Arc */}\n                        <motion.path\n                          d={generateArcPath(angle.vertex, angle.p1, angle.p2, arcRadius)}\n                          fill=\"none\"\n                          stroke={angle.color}\n                          strokeWidth={strokeMain * 0.8}\n                          strokeDasharray={`${baseSize * 0.01} ${baseSize * 0.005}`}\n                          initial={{ pathLength: 0, opacity: 0 }}\n                          animate={{ pathLength: 1, opacity: 0.8 }}\n                          exit={{ pathLength: 0, opacity: 0 }}\n                          transition={{ duration: 0.5, delay: 0.2 }}\n                        />\n                        {/* Angle value label */}\n                        {!compact && (\n                          <motion.g\n                            initial={{ opacity: 0, scale: 0 }}\n                            animate={{ opacity: 1, scale: 1 }}\n                            exit={{ opacity: 0, scale: 0 }}\n                            transition={{ delay: 0.5 }}\n                          >\n                            <rect\n                              x={angle.vertex.x + fontSize}\n                              y={angle.vertex.y - fontSize * 1.5}\n                              width={fontSize * 2.8}\n                              height={fontSize * 1.4}\n                              fill=\"rgba(0,0,0,0.8)\"\n                              rx={fontSize * 0.2}\n                            />\n                            <text\n                              x={angle.vertex.x + fontSize * 2.4}\n                              y={angle.vertex.y - fontSize * 0.8}\n                              fill={angle.color}\n                              fontSize={fontSize}\n                              fontWeight=\"bold\"\n                              fontFamily=\"system-ui, sans-serif\"\n                              textAnchor=\"middle\"\n                              dominantBaseline=\"middle\"\n                            >\n                              {Math.round(angle.angle)}°\n                            </text>\n                          </motion.g>\n                        )}\n                      </motion.g>\n                    ))}\n\n                    {/* Points with enhanced styling */}\n                    {visualizationData.points.map((point, i) => (\n                      <motion.g\n                        key={`point-${i}`}\n                        initial={{ scale: 0, opacity: 0 }}\n                        animate={{ scale: 1, opacity: 1 }}\n                        exit={{ scale: 0, opacity: 0 }}\n                        transition={{ duration: 0.3, delay: i * 0.05 }}\n                      >\n                        {/* Outer glow pulse */}\n                        <motion.circle\n                          cx={point.x}\n                          cy={point.y}\n                          r={pointRadiusOuter}\n                          fill={getCategoryColor(selectedRatio?.category || '')}\n                          opacity=\"0.15\"\n                          animate={{\n                            r: [pointRadiusOuter, pointRadiusOuter * 1.25, pointRadiusOuter],\n                            opacity: [0.15, 0.25, 0.15]\n                          }}\n                          transition={{\n                            duration: 2,\n                            repeat: Infinity,\n                            ease: \"easeInOut\"\n                          }}\n                        />\n                        {/* Outer ring */}\n                        <circle\n                          cx={point.x}\n                          cy={point.y}\n                          r={pointRadiusRing}\n                          fill=\"none\"\n                          stroke={getCategoryColor(selectedRatio?.category || '')}\n                          strokeWidth={pointRadiusInner * 0.3}\n                          opacity=\"0.5\"\n                        />\n                        {/* Inner dot */}\n                        <circle\n                          cx={point.x}\n                          cy={point.y}\n                          r={pointRadiusInner}\n                          fill=\"#fff\"\n                          stroke={getCategoryColor(selectedRatio?.category || '')}\n                          strokeWidth={pointRadiusInner * 0.25}\n                        />\n                      </motion.g>\n                    ))}\n                  </g>\n                );\n              })()}\n            </AnimatePresence>\n          </svg>\n        </div>\n\n        {/* No selection message */}\n        {!selectedRatio && (\n          <div className=\"absolute inset-0 flex items-center justify-center bg-black/40\">\n            <div className=\"text-center p-4\">\n              <Eye size={compact ? 24 : 32} className=\"mx-auto text-neutral-600 mb-2\" />\n              <p className={`text-neutral-500 ${compact ? 'text-xs' : 'text-sm'}`}>\n                {compact ? 'Click a ratio to visualize' : 'Expand a measurement card\\nto see it visualized here'}\n              </p>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Selected ratio info */}\n      {selectedRatio && !compact && (\n        <motion.div\n          className=\"p-3 border-t border-neutral-800\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n        >\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h5 className=\"text-sm font-medium text-white\">{selectedRatio.name}</h5>\n              <p className=\"text-xs text-neutral-500\">{selectedRatio.category}</p>\n            </div>\n            <div\n              className=\"px-2 py-1 rounded text-sm font-bold\"\n              style={{\n                backgroundColor: `${getScoreColor(selectedRatio.score)}15`,\n                color: getScoreColor(selectedRatio.score),\n              }}\n            >\n              {selectedRatio.score.toFixed(1)}\n            </div>\n          </div>\n\n          {/* Landmarks used */}\n          {selectedRatio.usedLandmarks && selectedRatio.usedLandmarks.length > 0 && (\n            <div className=\"mt-2\">\n              <p className=\"text-xs text-neutral-500 mb-1\">Landmarks used:</p>\n              <div className=\"flex flex-wrap gap-1\">\n                {selectedRatio.usedLandmarks.slice(0, 4).map(id => {\n                  const landmark = landmarkMap[id];\n                  return (\n                    <span\n                      key={id}\n                      className=\"px-1.5 py-0.5 bg-neutral-800 rounded text-[10px] text-neutral-400\"\n                    >\n                      {landmark?.label || id}\n                    </span>\n                  );\n                })}\n                {selectedRatio.usedLandmarks.length > 4 && (\n                  <span className=\"px-1.5 py-0.5 text-[10px] text-neutral-500\">\n                    +{selectedRatio.usedLandmarks.length - 4} more\n                  </span>\n                )}\n              </div>\n            </div>\n          )}\n        </motion.div>\n      )}\n\n      {/* Compact info bar */}\n      {selectedRatio && compact && (\n        <div className=\"px-2 py-1.5 border-t border-neutral-800 flex items-center justify-between\">\n          <span className=\"text-xs text-white truncate\">{selectedRatio.name}</span>\n          <span\n            className=\"text-xs font-bold ml-2\"\n            style={{ color: getScoreColor(selectedRatio.score) }}\n          >\n            {selectedRatio.score.toFixed(1)}\n          </span>\n        </div>\n      )}\n    </div>\n  );\n}\n","numLines":646,"startLine":1,"totalLines":646}}}
{"parentUuid":"192103e3-6613-43fa-93b4-bf7005d4b71a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JS3FwjDD141FdEDxAoCeKF","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check if there's any impact/effectiveness calculation in the recommendations engine:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":9608,"cache_read_input_tokens":51936,"cache_creation":{"ephemeral_5m_input_tokens":9608,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWS8YyQCjD7j13kQeZj34","type":"assistant","uuid":"9a78ee8c-733c-4e33-b667-58b631814337","timestamp":"2025-12-24T20:19:10.775Z"}
{"parentUuid":"9a78ee8c-733c-4e33-b667-58b631814337","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JS3FwjDD141FdEDxAoCeKF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014C8f3a9wjaQDEiDUUCG9Bu","name":"Grep","input":{"pattern":"impact|effectiveness|potentialScore","type":"ts","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":9608,"cache_read_input_tokens":51936,"cache_creation":{"ephemeral_5m_input_tokens":9608,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWS8YyQCjD7j13kQeZj34","type":"assistant","uuid":"4c3f4d4f-0ae4-4ce6-acb1-4a389c642e34","timestamp":"2025-12-24T20:19:11.449Z"}
{"parentUuid":"4c3f4d4f-0ae4-4ce6-acb1-4a389c642e34","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JS3FwjDD141FdEDxAoCeKF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0134paVeyPahY1r7sUutsgAh","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":9608,"cache_read_input_tokens":51936,"cache_creation":{"ephemeral_5m_input_tokens":9608,"ephemeral_1h_input_tokens":0},"output_tokens":193,"service_tier":"standard"}},"requestId":"req_011CWS8YyQCjD7j13kQeZj34","type":"assistant","uuid":"cceb5919-ae94-4d17-80ce-c6b7fcd9bd2b","timestamp":"2025-12-24T20:19:11.719Z"}
{"parentUuid":"cceb5919-ae94-4d17-80ce-c6b7fcd9bd2b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"EISDIR: illegal operation on a directory, read","is_error":true,"tool_use_id":"toolu_0134paVeyPahY1r7sUutsgAh"}]},"uuid":"ce33ad3c-2d62-4225-be9a-835525154f8d","timestamp":"2025-12-24T20:19:11.771Z","toolUseResult":"Error: EISDIR: illegal operation on a directory, read"}
{"parentUuid":"ce33ad3c-2d62-4225-be9a-835525154f8d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014C8f3a9wjaQDEiDUUCG9Bu","type":"tool_result","content":"Found 7 files\nsrc/lib/recommendations/engine.ts\nsrc/lib/recommendations/severity.ts\nsrc/lib/recommendations/hardmaxxing.ts\nsrc/lib/recommendations/supplements.ts\nsrc/lib/recommendations/softmaxxing.ts\nsrc/lib/recommendations/nonSurgical.ts\nsrc/lib/recommendations/types.ts"}]},"uuid":"8a376c23-3ae8-4727-80ee-987766595956","timestamp":"2025-12-24T20:19:12.070Z","toolUseResult":{"mode":"files_with_matches","filenames":["src/lib/recommendations/engine.ts","src/lib/recommendations/severity.ts","src/lib/recommendations/hardmaxxing.ts","src/lib/recommendations/supplements.ts","src/lib/recommendations/softmaxxing.ts","src/lib/recommendations/nonSurgical.ts","src/lib/recommendations/types.ts"],"numFiles":7}}
{"parentUuid":"8a376c23-3ae8-4727-80ee-987766595956","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XawnfoiA8Scosd6tijWjLk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FUJaAYWgHefC5boG8gVesz","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":37,"cache_creation_input_tokens":452,"cache_read_input_tokens":61544,"cache_creation":{"ephemeral_5m_input_tokens":452,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CWS8ZBSFcUiafbngY3i4r","type":"assistant","uuid":"ecb9a9cd-7d7e-4a88-870e-4e086681d3f4","timestamp":"2025-12-24T20:19:14.838Z"}
{"parentUuid":"ecb9a9cd-7d7e-4a88-870e-4e086681d3f4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XawnfoiA8Scosd6tijWjLk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016Mm9m1GoQiNr2N2JhHcpkh","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/severity.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":37,"cache_creation_input_tokens":452,"cache_read_input_tokens":61544,"cache_creation":{"ephemeral_5m_input_tokens":452,"ephemeral_1h_input_tokens":0},"output_tokens":145,"service_tier":"standard"}},"requestId":"req_011CWS8ZBSFcUiafbngY3i4r","type":"assistant","uuid":"2d7e456c-0b6c-4bad-8ca2-c58502b7f14e","timestamp":"2025-12-24T20:19:15.057Z"}
{"parentUuid":"2d7e456c-0b6c-4bad-8ca2-c58502b7f14e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FUJaAYWgHefC5boG8gVesz","type":"tool_result","content":"     1→/**\n     2→ * Recommendation Engine\n     3→ * Analyzes facial metrics and generates personalized treatment recommendations\n     4→ */\n     5→\n     6→import {\n     7→  Treatment,\n     8→  Surgery,\n     9→  Supplement,\n    10→  TreatmentRecommendation,\n    11→  MetricAnalysis,\n    12→  RecommendationPlan,\n    13→  OrderOfOperation,\n    14→  TreatmentCategory,\n    15→  Gender,\n    16→  ProfileType,\n    17→} from './types';\n    18→import { SOFTMAXXING_TREATMENTS } from './softmaxxing';\n    19→import { SURGICAL_TREATMENTS } from './hardmaxxing';\n    20→import { SUPPLEMENTS } from './supplements';\n    21→import { NON_SURGICAL_TREATMENTS } from './nonSurgical';\n    22→import {\n    23→  classifyMetricValue,\n    24→  calculateDeviation,\n    25→  getIssueForMetric,\n    26→  getTreatmentIdsForMetric,\n    27→  getOverallSeverity,\n    28→  harmonyToPSL,\n    29→  estimatePotentialPSL,\n    30→} from './severity';\n    31→\n    32→// ============================================\n    33→// ALL TREATMENTS COMBINED\n    34→// ============================================\n    35→\n    36→const ALL_TREATMENTS: (Treatment | Surgery)[] = [\n    37→  ...SOFTMAXXING_TREATMENTS,\n    38→  ...NON_SURGICAL_TREATMENTS,\n    39→  ...SURGICAL_TREATMENTS,\n    40→];\n    41→\n    42→// ============================================\n    43→// METRIC ANALYSIS\n    44→// ============================================\n    45→\n    46→export interface MetricInput {\n    47→  metricId: string;\n    48→  metricName: string;\n    49→  currentValue: number;\n    50→  idealValue: number;\n    51→  idealRange: { min: number; max: number };\n    52→  score: number;\n    53→  profileType: ProfileType;\n    54→}\n    55→\n    56→/**\n    57→ * Analyze a single metric and determine severity\n    58→ */\n    59→export function analyzeMetric(\n    60→  input: MetricInput,\n    61→  gender?: Gender\n    62→): MetricAnalysis {\n    63→  const { deviation, deviationPercent, direction } = calculateDeviation(\n    64→    input.metricId,\n    65→    input.currentValue\n    66→  );\n    67→\n    68→  const severity = classifyMetricValue(input.metricId, input.currentValue, gender);\n    69→  const issue = getIssueForMetric(input.metricId, direction);\n    70→\n    71→  return {\n    72→    metricId: input.metricId,\n    73→    metricName: input.metricName,\n    74→    currentValue: input.currentValue,\n    75→    idealValue: input.idealValue,\n    76→    idealRange: input.idealRange,\n    77→    deviation,\n    78→    deviationPercent,\n    79→    score: input.score,\n    80→    severity,\n    81→    issue: issue || undefined,\n    82→    profileType: input.profileType,\n    83→  };\n    84→}\n    85→\n    86→/**\n    87→ * Analyze all metrics and sort by severity\n    88→ */\n    89→export function analyzeAllMetrics(\n    90→  metrics: MetricInput[],\n    91→  gender?: Gender\n    92→): MetricAnalysis[] {\n    93→  const analyses = metrics.map(m => analyzeMetric(m, gender));\n    94→\n    95→  // Sort by severity (severe first) then by score (lowest first)\n    96→  const severityOrder = { severe: 0, moderate: 1, mild: 2, optimal: 3 };\n    97→\n    98→  return analyses.sort((a, b) => {\n    99→    const severityDiff = severityOrder[a.severity.severity] - severityOrder[b.severity.severity];\n   100→    if (severityDiff !== 0) return severityDiff;\n   101→    return a.score - b.score;\n   102→  });\n   103→}\n   104→\n   105→// ============================================\n   106→// TREATMENT MATCHING\n   107→// ============================================\n   108→\n   109→/**\n   110→ * Find treatment by ID\n   111→ */\n   112→export function findTreatment(id: string): Treatment | Surgery | Supplement | undefined {\n   113→  const treatment = ALL_TREATMENTS.find(t => t.id === id);\n   114→  if (treatment) return treatment;\n   115→\n   116→  return SUPPLEMENTS.find(s => s.id === id);\n   117→}\n   118→\n   119→/**\n   120→ * Find treatments that target a specific issue\n   121→ */\n   122→export function findTreatmentsForIssue(issue: string): (Treatment | Surgery)[] {\n   123→  return ALL_TREATMENTS.filter(t =>\n   124→    t.targetIssues.some(i =>\n   125→      i.toLowerCase().includes(issue.toLowerCase()) ||\n   126→      issue.toLowerCase().includes(i.toLowerCase())\n   127→    )\n   128→  );\n   129→}\n   130→\n   131→/**\n   132→ * Find treatments that target a specific metric\n   133→ */\n   134→export function findTreatmentsForMetric(metricId: string): (Treatment | Surgery)[] {\n   135→  return ALL_TREATMENTS.filter(t =>\n   136→    t.targetMetrics.some(m =>\n   137→      m.toLowerCase().includes(metricId.toLowerCase()) ||\n   138→      metricId.toLowerCase().includes(m.toLowerCase())\n   139→    )\n   140→  );\n   141→}\n   142→\n   143→/**\n   144→ * Score treatment relevance for a metric analysis\n   145→ */\n   146→function scoreTreatmentRelevance(\n   147→  treatment: Treatment | Surgery,\n   148→  analysis: MetricAnalysis\n   149→): number {\n   150→  let score = 0;\n   151→\n   152→  // Check if treatment targets this metric\n   153→  const targetsMetric = treatment.targetMetrics.some(m =>\n   154→    m.toLowerCase().includes(analysis.metricId.toLowerCase())\n   155→  );\n   156→  if (targetsMetric) score += 30;\n   157→\n   158→  // Check if treatment addresses the issue\n   159→  if (analysis.issue) {\n   160→    const addressesIssue = treatment.targetIssues.some(i =>\n   161→      i.toLowerCase().includes(analysis.issue!.toLowerCase()) ||\n   162→      analysis.issue!.toLowerCase().includes(i.toLowerCase())\n   163→    );\n   164→    if (addressesIssue) score += 40;\n   165→  }\n   166→\n   167→  // Factor in severity\n   168→  const severityMultiplier = {\n   169→    severe: 1.5,\n   170→    moderate: 1.2,\n   171→    mild: 1.0,\n   172→    optimal: 0.3,\n   173→  };\n   174→  score *= severityMultiplier[analysis.severity.severity];\n   175→\n   176→  // Factor in treatment effectiveness\n   177→  score += treatment.effectiveness * 2;\n   178→\n   179→  // Factor in PSL improvement potential\n   180→  const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n   181→  score += avgPSLImprovement * 10;\n   182→\n   183→  return Math.round(score);\n   184→}\n   185→\n   186→/**\n   187→ * Generate treatment recommendations for a metric analysis\n   188→ */\n   189→export function getRecommendationsForMetric(\n   190→  analysis: MetricAnalysis,\n   191→  gender?: Gender,\n   192→  maxRecommendations: number = 5\n   193→): TreatmentRecommendation[] {\n   194→  if (analysis.severity.severity === 'optimal') {\n   195→    return []; // No treatment needed for optimal metrics\n   196→  }\n   197→\n   198→  // Get treatment IDs from mapping\n   199→  const { direction } = calculateDeviation(analysis.metricId, analysis.currentValue);\n   200→  const treatmentIds = getTreatmentIdsForMetric(analysis.metricId, direction);\n   201→\n   202→  // Find matching treatments\n   203→  let treatments: (Treatment | Surgery)[] = [];\n   204→\n   205→  // First, add treatments from the mapping\n   206→  for (const id of treatmentIds) {\n   207→    const treatment = findTreatment(id);\n   208→    if (treatment && 'category' in treatment && treatment.category !== undefined) {\n   209→      treatments.push(treatment as Treatment | Surgery);\n   210→    }\n   211→  }\n   212→\n   213→  // Then, find additional treatments that target this metric or issue\n   214→  const additionalTreatments = [\n   215→    ...findTreatmentsForMetric(analysis.metricId),\n   216→    ...(analysis.issue ? findTreatmentsForIssue(analysis.issue) : []),\n   217→  ];\n   218→\n   219→  // Remove duplicates\n   220→  const seenIds = treatments.map(t => t.id);\n   221→  for (const t of additionalTreatments) {\n   222→    if (!seenIds.includes(t.id)) {\n   223→      seenIds.push(t.id);\n   224→      treatments.push(t);\n   225→    }\n   226→  }\n   227→\n   228→  // Filter by gender if specified\n   229→  if (gender) {\n   230→    treatments = treatments.filter(t =>\n   231→      !t.genderSpecific || t.genderSpecific === gender\n   232→    );\n   233→  }\n   234→\n   235→  // Score and rank treatments\n   236→  const scoredTreatments = treatments.map(treatment => ({\n   237→    treatment,\n   238→    relevanceScore: scoreTreatmentRelevance(treatment, analysis),\n   239→  }));\n   240→\n   241→  // Sort by relevance score\n   242→  scoredTreatments.sort((a, b) => b.relevanceScore - a.relevanceScore);\n   243→\n   244→  // Create recommendations\n   245→  return scoredTreatments.slice(0, maxRecommendations).map(({ treatment, relevanceScore }) => {\n   246→    const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n   247→\n   248→    return {\n   249→      treatment,\n   250→      priority: relevanceScore >= 60 ? 'high' as const :\n   251→                relevanceScore >= 40 ? 'medium' as const :\n   252→                'low' as const,\n   253→      relevanceScore,\n   254→      targetMetrics: [analysis.metricId],\n   255→      estimatedImprovement: avgPSLImprovement,\n   256→      reasoning: generateReasoning(treatment, analysis),\n   257→    };\n   258→  });\n   259→}\n   260→\n   261→/**\n   262→ * Generate human-readable reasoning for a recommendation\n   263→ */\n   264→function generateReasoning(\n   265→  treatment: Treatment | Surgery,\n   266→  analysis: MetricAnalysis\n   267→): string {\n   268→  const parts: string[] = [];\n   269→\n   270→  // Issue description\n   271→  if (analysis.issue) {\n   272→    parts.push(`Addresses ${analysis.issue.replace(/_/g, ' ')}`);\n   273→  }\n   274→\n   275→  // Effectiveness\n   276→  parts.push(`Effectiveness: ${treatment.effectiveness}/10`);\n   277→\n   278→  // PSL improvement\n   279→  const pslRange = `${treatment.pslImprovement.min}-${treatment.pslImprovement.max}`;\n   280→  parts.push(`Expected improvement: ${pslRange} PSL points`);\n   281→\n   282→  // Timeline\n   283→  parts.push(`Results in: ${treatment.timelineToResults}`);\n   284→\n   285→  return parts.join('. ') + '.';\n   286→}\n   287→\n   288→// ============================================\n   289→// RECOMMENDATION PLAN GENERATION\n   290→// ============================================\n   291→\n   292→/**\n   293→ * Generate a comprehensive recommendation plan\n   294→ */\n   295→export function generateRecommendationPlan(\n   296→  metrics: MetricInput[],\n   297→  overallScore: number,\n   298→  harmonyPercent: number,\n   299→  gender?: Gender\n   300→): RecommendationPlan {\n   301→  // Analyze all metrics\n   302→  const metricAnalyses = analyzeAllMetrics(metrics, gender);\n   303→\n   304→  // Determine strengths and weaknesses\n   305→  const strengths = metricAnalyses.filter(m =>\n   306→    m.severity.severity === 'optimal' || m.score >= 85\n   307→  );\n   308→  const weaknesses = metricAnalyses.filter(m =>\n   309→    m.severity.severity !== 'optimal' && m.score < 85\n   310→  );\n   311→\n   312→  // Get recommendations for each weakness\n   313→  const allRecommendations: TreatmentRecommendation[] = [];\n   314→  for (const weakness of weaknesses) {\n   315→    const recs = getRecommendationsForMetric(weakness, gender);\n   316→    allRecommendations.push(...recs);\n   317→  }\n   318→\n   319→  // Deduplicate recommendations (same treatment might help multiple metrics)\n   320→  const uniqueRecommendations = deduplicateRecommendations(allRecommendations);\n   321→\n   322→  // Categorize recommendations\n   323→  const lifestyle = uniqueRecommendations.filter(r =>\n   324→    r.treatment.category === 'lifestyle' || r.treatment.category === 'softmaxxing'\n   325→  );\n   326→  const softmaxxing = uniqueRecommendations.filter(r =>\n   327→    r.treatment.category === 'softmaxxing'\n   328→  );\n   329→  const nonSurgical = uniqueRecommendations.filter(r =>\n   330→    r.treatment.category === 'non_surgical'\n   331→  );\n   332→  const minimallyInvasive = uniqueRecommendations.filter(r =>\n   333→    r.treatment.category === 'minimally_invasive'\n   334→  );\n   335→  const surgical = uniqueRecommendations.filter(r =>\n   336→    r.treatment.category === 'surgical'\n   337→  );\n   338→\n   339→  // Get supplement recommendations\n   340→  const supplements = getSupplementRecommendations(weaknesses, gender);\n   341→\n   342→  // Calculate PSL ratings\n   343→  const pslRating = harmonyToPSL(harmonyPercent);\n   344→  const treatmentImprovements = uniqueRecommendations.map(r => r.estimatedImprovement);\n   345→  const potentialPSL = estimatePotentialPSL(pslRating.psl, treatmentImprovements);\n   346→\n   347→  // Generate order of operations\n   348→  const orderOfOperations = generateOrderOfOperations(uniqueRecommendations);\n   349→\n   350→  // Get overall severity\n   351→  const overallSeverity = getOverallSeverity(metricAnalyses.map(m => m.severity.severity));\n   352→\n   353→  return {\n   354→    overallScore,\n   355→    overallSeverity,\n   356→    harmonyScore: harmonyPercent,\n   357→    percentile: pslRating.percentile,\n   358→    metricAnalyses,\n   359→    strengths,\n   360→    weaknesses,\n   361→    lifestyle,\n   362→    softmaxxing,\n   363→    nonSurgical,\n   364→    minimallyInvasive,\n   365→    surgical,\n   366→    supplements,\n   367→    currentPSL: pslRating.psl,\n   368→    potentialPSL: potentialPSL.potentialPSL,\n   369→    potentialImprovement: potentialPSL.totalImprovement,\n   370→    orderOfOperations,\n   371→  };\n   372→}\n   373→\n   374→/**\n   375→ * Deduplicate recommendations, combining target metrics for same treatment\n   376→ */\n   377→function deduplicateRecommendations(\n   378→  recommendations: TreatmentRecommendation[]\n   379→): TreatmentRecommendation[] {\n   380→  const byId = new Map<string, TreatmentRecommendation>();\n   381→\n   382→  for (const rec of recommendations) {\n   383→    const existing = byId.get(rec.treatment.id);\n   384→    if (existing) {\n   385→      // Combine target metrics (deduplicate using filter)\n   386→      const combined = [...existing.targetMetrics, ...rec.targetMetrics];\n   387→      existing.targetMetrics = combined.filter((m, i) => combined.indexOf(m) === i);\n   388→\n   389→      // Take higher relevance score\n   390→      existing.relevanceScore = Math.max(existing.relevanceScore, rec.relevanceScore);\n   391→\n   392→      // Update priority based on new relevance\n   393→      existing.priority = existing.relevanceScore >= 60 ? 'high' :\n   394→                         existing.relevanceScore >= 40 ? 'medium' :\n   395→                         'low';\n   396→    } else {\n   397→      byId.set(rec.treatment.id, { ...rec });\n   398→    }\n   399→  }\n   400→\n   401→  return Array.from(byId.values()).sort((a, b) => b.relevanceScore - a.relevanceScore);\n   402→}\n   403→\n   404→/**\n   405→ * Get supplement recommendations based on weaknesses\n   406→ */\n   407→function getSupplementRecommendations(\n   408→  weaknesses: MetricAnalysis[],\n   409→  gender?: Gender\n   410→): TreatmentRecommendation[] {\n   411→  const recommendations: TreatmentRecommendation[] = [];\n   412→\n   413→  // Map weakness types to supplement categories\n   414→  const hasSkinIssues = weaknesses.some(w =>\n   415→    w.issue?.includes('skin') || w.metricId.includes('skin')\n   416→  );\n   417→  const hasHairIssues = weaknesses.some(w =>\n   418→    w.issue?.includes('hair') || w.metricId.includes('hairline')\n   419→  );\n   420→  const hasGeneralAging = weaknesses.some(w =>\n   421→    w.issue?.includes('aging') || w.severity.severity === 'moderate' || w.severity.severity === 'severe'\n   422→  );\n   423→\n   424→  // Helper to create supplement recommendation\n   425→  const createSupplementRec = (\n   426→    supp: Supplement,\n   427→    priority: 'high' | 'medium' | 'low',\n   428→    relevanceScore: number,\n   429→    targetMetrics: string[],\n   430→    reasoning: string\n   431→  ): TreatmentRecommendation => ({\n   432→    treatment: {\n   433→      id: supp.id,\n   434→      name: supp.name,\n   435→      category: 'lifestyle',\n   436→      description: supp.description,\n   437→      howItWorks: `Dosage: ${supp.dosage} ${supp.frequency}`,\n   438→      effectiveness: supp.effectiveness,\n   439→      evidenceLevel: supp.evidenceLevel,\n   440→      pslImprovement: { min: 0.05, max: 0.15 },\n   441→      costLevel: supp.costPerMonth.max > 30 ? 'medium' : 'low',\n   442→      costRange: { min: supp.costPerMonth.min, max: supp.costPerMonth.max, currency: 'USD' },\n   443→      costFrequency: 'monthly',\n   444→      timelineToResults: supp.timelineToResults,\n   445→      resultsDuration: 'Ongoing with continued use',\n   446→      maintenanceRequired: true,\n   447→      maintenanceFrequency: supp.frequency,\n   448→      recoveryTime: 'None',\n   449→      downtime: 'None',\n   450→      painLevel: 'none',\n   451→      riskLevel: supp.riskLevel,\n   452→      sideEffects: supp.sideEffects,\n   453→      contraindications: supp.contraindications,\n   454→      targetMetrics,\n   455→      targetIssues: supp.targetBenefits,\n   456→      notes: supp.notes,\n   457→      sources: supp.sources,\n   458→    },\n   459→    priority,\n   460→    relevanceScore,\n   461→    targetMetrics,\n   462→    estimatedImprovement: 0.1,\n   463→    reasoning,\n   464→  });\n   465→\n   466→  // Add relevant supplements\n   467→  if (hasSkinIssues || hasGeneralAging) {\n   468→    const skinSupplements = SUPPLEMENTS.filter(s =>\n   469→      s.category === 'skin' || s.category === 'anti-aging'\n   470→    );\n   471→    for (const supp of skinSupplements.slice(0, 3)) {\n   472→      recommendations.push(createSupplementRec(\n   473→        supp,\n   474→        'medium',\n   475→        50,\n   476→        ['skin_quality'],\n   477→        `${supp.name} supports skin health and anti-aging.`\n   478→      ));\n   479→    }\n   480→  }\n   481→\n   482→  if (hasHairIssues && gender === 'male') {\n   483→    const hairSupplements = SUPPLEMENTS.filter(s => s.category === 'hair');\n   484→    for (const supp of hairSupplements.slice(0, 3)) {\n   485→      recommendations.push(createSupplementRec(\n   486→        supp,\n   487→        'medium',\n   488→        45,\n   489→        ['hairline'],\n   490→        `${supp.name} supports hair health.`\n   491→      ));\n   492→    }\n   493→  }\n   494→\n   495→  // Always recommend foundational supplements\n   496→  const foundational = SUPPLEMENTS.filter(s =>\n   497→    ['vitamin_d3', 'omega_3', 'magnesium'].includes(s.id)\n   498→  );\n   499→  for (const supp of foundational) {\n   500→    if (!recommendations.some(r => r.treatment.id === supp.id)) {\n   501→      recommendations.push(createSupplementRec(\n   502→        supp,\n   503→        'low',\n   504→        30,\n   505→        ['general_health'],\n   506→        `${supp.name} supports overall health and wellbeing.`\n   507→      ));\n   508→    }\n   509→  }\n   510→\n   511→  return recommendations.slice(0, 10);\n   512→}\n   513→\n   514→/**\n   515→ * Generate order of operations for treatments\n   516→ */\n   517→function generateOrderOfOperations(\n   518→  recommendations: TreatmentRecommendation[]\n   519→): OrderOfOperation[] {\n   520→  const operations: OrderOfOperation[] = [];\n   521→\n   522→  // Define category order: lifestyle -> softmaxxing -> non-surgical -> minimally invasive -> surgical\n   523→  const categoryOrder: TreatmentCategory[] = [\n   524→    'lifestyle',\n   525→    'softmaxxing',\n   526→    'non_surgical',\n   527→    'minimally_invasive',\n   528→    'surgical',\n   529→  ];\n   530→\n   531→  // Group by category (only for valid treatment categories)\n   532→  const validCategories: TreatmentCategory[] = ['lifestyle', 'softmaxxing', 'non_surgical', 'minimally_invasive', 'surgical'];\n   533→  const byCategory = new Map<TreatmentCategory, TreatmentRecommendation[]>();\n   534→  for (const rec of recommendations) {\n   535→    const cat = rec.treatment.category as TreatmentCategory;\n   536→    if (validCategories.includes(cat)) {\n   537→      if (!byCategory.has(cat)) {\n   538→        byCategory.set(cat, []);\n   539→      }\n   540→      byCategory.get(cat)!.push(rec);\n   541→    }\n   542→  }\n   543→\n   544→  let step = 1;\n   545→  for (const category of categoryOrder) {\n   546→    const recs = byCategory.get(category) || [];\n   547→    // Sort by priority and relevance\n   548→    recs.sort((a, b) => {\n   549→      if (a.priority !== b.priority) {\n   550→        const priorityOrder = { high: 0, medium: 1, low: 2 };\n   551→        return priorityOrder[a.priority] - priorityOrder[b.priority];\n   552→      }\n   553→      return b.relevanceScore - a.relevanceScore;\n   554→    });\n   555→\n   556→    for (const rec of recs.slice(0, 3)) { // Max 3 per category\n   557→      const treatment = rec.treatment as Treatment | Surgery;\n   558→      const operation: OrderOfOperation = {\n   559→        step,\n   560→        category,\n   561→        treatment,\n   562→        reasoning: getStepReasoning(step, category),\n   563→      };\n   564→\n   565→      // Add prerequisites for surgical procedures\n   566→      if (category === 'surgical') {\n   567→        operation.prerequisites = ['Complete non-surgical options first', 'Consult with board-certified surgeon'];\n   568→        operation.waitTime = '6-12 months recovery between major procedures';\n   569→      }\n   570→\n   571→      operations.push(operation);\n   572→      step++;\n   573→    }\n   574→  }\n   575→\n   576→  return operations;\n   577→}\n   578→\n   579→/**\n   580→ * Generate reasoning for a step in order of operations\n   581→ */\n   582→function getStepReasoning(\n   583→  step: number,\n   584→  category: TreatmentCategory\n   585→): string {\n   586→  if (step === 1) {\n   587→    return 'Start with foundational changes before considering more invasive options.';\n   588→  }\n   589→\n   590→  if (category === 'lifestyle' || category === 'softmaxxing') {\n   591→    return 'Low-risk, reversible changes that can provide noticeable improvement.';\n   592→  }\n   593→\n   594→  if (category === 'non_surgical') {\n   595→    return 'Non-invasive treatments with minimal downtime to test results before committing to surgery.';\n   596→  }\n   597→\n   598→  if (category === 'minimally_invasive') {\n   599→    return 'Minimally invasive procedures can provide significant results with less risk than surgery.';\n   600→  }\n   601→\n   602→  if (category === 'surgical') {\n   603→    return 'Consider surgery only after exhausting less invasive options and with realistic expectations.';\n   604→  }\n   605→\n   606→  return '';\n   607→}\n   608→\n   609→// ============================================\n   610→// UTILITY FUNCTIONS\n   611→// ============================================\n   612→\n   613→/**\n   614→ * Get top priority recommendations across all categories\n   615→ */\n   616→export function getTopRecommendations(\n   617→  plan: RecommendationPlan,\n   618→  count: number = 5\n   619→): TreatmentRecommendation[] {\n   620→  const all = [\n   621→    ...plan.lifestyle,\n   622→    ...plan.softmaxxing,\n   623→    ...plan.nonSurgical,\n   624→    ...plan.minimallyInvasive,\n   625→    ...plan.surgical,\n   626→  ];\n   627→\n   628→  return all\n   629→    .sort((a, b) => b.relevanceScore - a.relevanceScore)\n   630→    .slice(0, count);\n   631→}\n   632→\n   633→/**\n   634→ * Get recommendations filtered by cost level\n   635→ */\n   636→export function getRecommendationsByCost(\n   637→  plan: RecommendationPlan,\n   638→  maxCost: 'free' | 'low' | 'medium' | 'high' | 'very_high'\n   639→): TreatmentRecommendation[] {\n   640→  const costOrder = ['free', 'low', 'medium', 'high', 'very_high'];\n   641→  const maxCostIndex = costOrder.indexOf(maxCost);\n   642→\n   643→  const all = [\n   644→    ...plan.lifestyle,\n   645→    ...plan.softmaxxing,\n   646→    ...plan.nonSurgical,\n   647→    ...plan.minimallyInvasive,\n   648→    ...plan.surgical,\n   649→  ];\n   650→\n   651→  return all.filter(r => {\n   652→    const treatment = r.treatment as Treatment;\n   653→    if ('costLevel' in treatment) {\n   654→      return costOrder.indexOf(treatment.costLevel) <= maxCostIndex;\n   655→    }\n   656→    return true;\n   657→  });\n   658→}\n   659→\n   660→/**\n   661→ * Get recommendations with minimal downtime\n   662→ */\n   663→export function getNoDowntimeRecommendations(\n   664→  plan: RecommendationPlan\n   665→): TreatmentRecommendation[] {\n   666→  const all = [\n   667→    ...plan.lifestyle,\n   668→    ...plan.softmaxxing,\n   669→    ...plan.nonSurgical,\n   670→    ...plan.minimallyInvasive,\n   671→  ];\n   672→\n   673→  return all.filter(r => {\n   674→    const treatment = r.treatment as Treatment;\n   675→    if ('downtime' in treatment) {\n   676→      const downtime = treatment.downtime.toLowerCase();\n   677→      return downtime.includes('none') || downtime.includes('minimal');\n   678→    }\n   679→    return true;\n   680→  });\n   681→}\n   682→\n   683→/**\n   684→ * Format cost for display\n   685→ */\n   686→export function formatCost(treatment: Treatment | Surgery): string {\n   687→  const { min, max, currency } = treatment.costRange;\n   688→  const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : currency;\n   689→\n   690→  if (min === max) {\n   691→    return `${symbol}${min.toLocaleString()}`;\n   692→  }\n   693→\n   694→  return `${symbol}${min.toLocaleString()} - ${symbol}${max.toLocaleString()}`;\n   695→}\n   696→\n   697→/**\n   698→ * Get summary statistics for a plan\n   699→ */\n   700→export function getPlanSummary(plan: RecommendationPlan): {\n   701→  totalRecommendations: number;\n   702→  highPriority: number;\n   703→  mediumPriority: number;\n   704→  lowPriority: number;\n   705→  categoryCounts: Record<string, number>;\n   706→  estimatedTotalImprovement: number;\n   707→} {\n   708→  const all = [\n   709→    ...plan.lifestyle,\n   710→    ...plan.softmaxxing,\n   711→    ...plan.nonSurgical,\n   712→    ...plan.minimallyInvasive,\n   713→    ...plan.surgical,\n   714→  ];\n   715→\n   716→  return {\n   717→    totalRecommendations: all.length,\n   718→    highPriority: all.filter(r => r.priority === 'high').length,\n   719→    mediumPriority: all.filter(r => r.priority === 'medium').length,\n   720→    lowPriority: all.filter(r => r.priority === 'low').length,\n   721→    categoryCounts: {\n   722→      lifestyle: plan.lifestyle.length,\n   723→      softmaxxing: plan.softmaxxing.length,\n   724→      nonSurgical: plan.nonSurgical.length,\n   725→      minimallyInvasive: plan.minimallyInvasive.length,\n   726→      surgical: plan.surgical.length,\n   727→      supplements: plan.supplements.length,\n   728→    },\n   729→    estimatedTotalImprovement: plan.potentialImprovement,\n   730→  };\n   731→}\n   732→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d2931fe3-54c3-4c54-a250-1c715d810ab6","timestamp":"2025-12-24T20:19:15.094Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts","content":"/**\n * Recommendation Engine\n * Analyzes facial metrics and generates personalized treatment recommendations\n */\n\nimport {\n  Treatment,\n  Surgery,\n  Supplement,\n  TreatmentRecommendation,\n  MetricAnalysis,\n  RecommendationPlan,\n  OrderOfOperation,\n  TreatmentCategory,\n  Gender,\n  ProfileType,\n} from './types';\nimport { SOFTMAXXING_TREATMENTS } from './softmaxxing';\nimport { SURGICAL_TREATMENTS } from './hardmaxxing';\nimport { SUPPLEMENTS } from './supplements';\nimport { NON_SURGICAL_TREATMENTS } from './nonSurgical';\nimport {\n  classifyMetricValue,\n  calculateDeviation,\n  getIssueForMetric,\n  getTreatmentIdsForMetric,\n  getOverallSeverity,\n  harmonyToPSL,\n  estimatePotentialPSL,\n} from './severity';\n\n// ============================================\n// ALL TREATMENTS COMBINED\n// ============================================\n\nconst ALL_TREATMENTS: (Treatment | Surgery)[] = [\n  ...SOFTMAXXING_TREATMENTS,\n  ...NON_SURGICAL_TREATMENTS,\n  ...SURGICAL_TREATMENTS,\n];\n\n// ============================================\n// METRIC ANALYSIS\n// ============================================\n\nexport interface MetricInput {\n  metricId: string;\n  metricName: string;\n  currentValue: number;\n  idealValue: number;\n  idealRange: { min: number; max: number };\n  score: number;\n  profileType: ProfileType;\n}\n\n/**\n * Analyze a single metric and determine severity\n */\nexport function analyzeMetric(\n  input: MetricInput,\n  gender?: Gender\n): MetricAnalysis {\n  const { deviation, deviationPercent, direction } = calculateDeviation(\n    input.metricId,\n    input.currentValue\n  );\n\n  const severity = classifyMetricValue(input.metricId, input.currentValue, gender);\n  const issue = getIssueForMetric(input.metricId, direction);\n\n  return {\n    metricId: input.metricId,\n    metricName: input.metricName,\n    currentValue: input.currentValue,\n    idealValue: input.idealValue,\n    idealRange: input.idealRange,\n    deviation,\n    deviationPercent,\n    score: input.score,\n    severity,\n    issue: issue || undefined,\n    profileType: input.profileType,\n  };\n}\n\n/**\n * Analyze all metrics and sort by severity\n */\nexport function analyzeAllMetrics(\n  metrics: MetricInput[],\n  gender?: Gender\n): MetricAnalysis[] {\n  const analyses = metrics.map(m => analyzeMetric(m, gender));\n\n  // Sort by severity (severe first) then by score (lowest first)\n  const severityOrder = { severe: 0, moderate: 1, mild: 2, optimal: 3 };\n\n  return analyses.sort((a, b) => {\n    const severityDiff = severityOrder[a.severity.severity] - severityOrder[b.severity.severity];\n    if (severityDiff !== 0) return severityDiff;\n    return a.score - b.score;\n  });\n}\n\n// ============================================\n// TREATMENT MATCHING\n// ============================================\n\n/**\n * Find treatment by ID\n */\nexport function findTreatment(id: string): Treatment | Surgery | Supplement | undefined {\n  const treatment = ALL_TREATMENTS.find(t => t.id === id);\n  if (treatment) return treatment;\n\n  return SUPPLEMENTS.find(s => s.id === id);\n}\n\n/**\n * Find treatments that target a specific issue\n */\nexport function findTreatmentsForIssue(issue: string): (Treatment | Surgery)[] {\n  return ALL_TREATMENTS.filter(t =>\n    t.targetIssues.some(i =>\n      i.toLowerCase().includes(issue.toLowerCase()) ||\n      issue.toLowerCase().includes(i.toLowerCase())\n    )\n  );\n}\n\n/**\n * Find treatments that target a specific metric\n */\nexport function findTreatmentsForMetric(metricId: string): (Treatment | Surgery)[] {\n  return ALL_TREATMENTS.filter(t =>\n    t.targetMetrics.some(m =>\n      m.toLowerCase().includes(metricId.toLowerCase()) ||\n      metricId.toLowerCase().includes(m.toLowerCase())\n    )\n  );\n}\n\n/**\n * Score treatment relevance for a metric analysis\n */\nfunction scoreTreatmentRelevance(\n  treatment: Treatment | Surgery,\n  analysis: MetricAnalysis\n): number {\n  let score = 0;\n\n  // Check if treatment targets this metric\n  const targetsMetric = treatment.targetMetrics.some(m =>\n    m.toLowerCase().includes(analysis.metricId.toLowerCase())\n  );\n  if (targetsMetric) score += 30;\n\n  // Check if treatment addresses the issue\n  if (analysis.issue) {\n    const addressesIssue = treatment.targetIssues.some(i =>\n      i.toLowerCase().includes(analysis.issue!.toLowerCase()) ||\n      analysis.issue!.toLowerCase().includes(i.toLowerCase())\n    );\n    if (addressesIssue) score += 40;\n  }\n\n  // Factor in severity\n  const severityMultiplier = {\n    severe: 1.5,\n    moderate: 1.2,\n    mild: 1.0,\n    optimal: 0.3,\n  };\n  score *= severityMultiplier[analysis.severity.severity];\n\n  // Factor in treatment effectiveness\n  score += treatment.effectiveness * 2;\n\n  // Factor in PSL improvement potential\n  const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n  score += avgPSLImprovement * 10;\n\n  return Math.round(score);\n}\n\n/**\n * Generate treatment recommendations for a metric analysis\n */\nexport function getRecommendationsForMetric(\n  analysis: MetricAnalysis,\n  gender?: Gender,\n  maxRecommendations: number = 5\n): TreatmentRecommendation[] {\n  if (analysis.severity.severity === 'optimal') {\n    return []; // No treatment needed for optimal metrics\n  }\n\n  // Get treatment IDs from mapping\n  const { direction } = calculateDeviation(analysis.metricId, analysis.currentValue);\n  const treatmentIds = getTreatmentIdsForMetric(analysis.metricId, direction);\n\n  // Find matching treatments\n  let treatments: (Treatment | Surgery)[] = [];\n\n  // First, add treatments from the mapping\n  for (const id of treatmentIds) {\n    const treatment = findTreatment(id);\n    if (treatment && 'category' in treatment && treatment.category !== undefined) {\n      treatments.push(treatment as Treatment | Surgery);\n    }\n  }\n\n  // Then, find additional treatments that target this metric or issue\n  const additionalTreatments = [\n    ...findTreatmentsForMetric(analysis.metricId),\n    ...(analysis.issue ? findTreatmentsForIssue(analysis.issue) : []),\n  ];\n\n  // Remove duplicates\n  const seenIds = treatments.map(t => t.id);\n  for (const t of additionalTreatments) {\n    if (!seenIds.includes(t.id)) {\n      seenIds.push(t.id);\n      treatments.push(t);\n    }\n  }\n\n  // Filter by gender if specified\n  if (gender) {\n    treatments = treatments.filter(t =>\n      !t.genderSpecific || t.genderSpecific === gender\n    );\n  }\n\n  // Score and rank treatments\n  const scoredTreatments = treatments.map(treatment => ({\n    treatment,\n    relevanceScore: scoreTreatmentRelevance(treatment, analysis),\n  }));\n\n  // Sort by relevance score\n  scoredTreatments.sort((a, b) => b.relevanceScore - a.relevanceScore);\n\n  // Create recommendations\n  return scoredTreatments.slice(0, maxRecommendations).map(({ treatment, relevanceScore }) => {\n    const avgPSLImprovement = (treatment.pslImprovement.min + treatment.pslImprovement.max) / 2;\n\n    return {\n      treatment,\n      priority: relevanceScore >= 60 ? 'high' as const :\n                relevanceScore >= 40 ? 'medium' as const :\n                'low' as const,\n      relevanceScore,\n      targetMetrics: [analysis.metricId],\n      estimatedImprovement: avgPSLImprovement,\n      reasoning: generateReasoning(treatment, analysis),\n    };\n  });\n}\n\n/**\n * Generate human-readable reasoning for a recommendation\n */\nfunction generateReasoning(\n  treatment: Treatment | Surgery,\n  analysis: MetricAnalysis\n): string {\n  const parts: string[] = [];\n\n  // Issue description\n  if (analysis.issue) {\n    parts.push(`Addresses ${analysis.issue.replace(/_/g, ' ')}`);\n  }\n\n  // Effectiveness\n  parts.push(`Effectiveness: ${treatment.effectiveness}/10`);\n\n  // PSL improvement\n  const pslRange = `${treatment.pslImprovement.min}-${treatment.pslImprovement.max}`;\n  parts.push(`Expected improvement: ${pslRange} PSL points`);\n\n  // Timeline\n  parts.push(`Results in: ${treatment.timelineToResults}`);\n\n  return parts.join('. ') + '.';\n}\n\n// ============================================\n// RECOMMENDATION PLAN GENERATION\n// ============================================\n\n/**\n * Generate a comprehensive recommendation plan\n */\nexport function generateRecommendationPlan(\n  metrics: MetricInput[],\n  overallScore: number,\n  harmonyPercent: number,\n  gender?: Gender\n): RecommendationPlan {\n  // Analyze all metrics\n  const metricAnalyses = analyzeAllMetrics(metrics, gender);\n\n  // Determine strengths and weaknesses\n  const strengths = metricAnalyses.filter(m =>\n    m.severity.severity === 'optimal' || m.score >= 85\n  );\n  const weaknesses = metricAnalyses.filter(m =>\n    m.severity.severity !== 'optimal' && m.score < 85\n  );\n\n  // Get recommendations for each weakness\n  const allRecommendations: TreatmentRecommendation[] = [];\n  for (const weakness of weaknesses) {\n    const recs = getRecommendationsForMetric(weakness, gender);\n    allRecommendations.push(...recs);\n  }\n\n  // Deduplicate recommendations (same treatment might help multiple metrics)\n  const uniqueRecommendations = deduplicateRecommendations(allRecommendations);\n\n  // Categorize recommendations\n  const lifestyle = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'lifestyle' || r.treatment.category === 'softmaxxing'\n  );\n  const softmaxxing = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'softmaxxing'\n  );\n  const nonSurgical = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'non_surgical'\n  );\n  const minimallyInvasive = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'minimally_invasive'\n  );\n  const surgical = uniqueRecommendations.filter(r =>\n    r.treatment.category === 'surgical'\n  );\n\n  // Get supplement recommendations\n  const supplements = getSupplementRecommendations(weaknesses, gender);\n\n  // Calculate PSL ratings\n  const pslRating = harmonyToPSL(harmonyPercent);\n  const treatmentImprovements = uniqueRecommendations.map(r => r.estimatedImprovement);\n  const potentialPSL = estimatePotentialPSL(pslRating.psl, treatmentImprovements);\n\n  // Generate order of operations\n  const orderOfOperations = generateOrderOfOperations(uniqueRecommendations);\n\n  // Get overall severity\n  const overallSeverity = getOverallSeverity(metricAnalyses.map(m => m.severity.severity));\n\n  return {\n    overallScore,\n    overallSeverity,\n    harmonyScore: harmonyPercent,\n    percentile: pslRating.percentile,\n    metricAnalyses,\n    strengths,\n    weaknesses,\n    lifestyle,\n    softmaxxing,\n    nonSurgical,\n    minimallyInvasive,\n    surgical,\n    supplements,\n    currentPSL: pslRating.psl,\n    potentialPSL: potentialPSL.potentialPSL,\n    potentialImprovement: potentialPSL.totalImprovement,\n    orderOfOperations,\n  };\n}\n\n/**\n * Deduplicate recommendations, combining target metrics for same treatment\n */\nfunction deduplicateRecommendations(\n  recommendations: TreatmentRecommendation[]\n): TreatmentRecommendation[] {\n  const byId = new Map<string, TreatmentRecommendation>();\n\n  for (const rec of recommendations) {\n    const existing = byId.get(rec.treatment.id);\n    if (existing) {\n      // Combine target metrics (deduplicate using filter)\n      const combined = [...existing.targetMetrics, ...rec.targetMetrics];\n      existing.targetMetrics = combined.filter((m, i) => combined.indexOf(m) === i);\n\n      // Take higher relevance score\n      existing.relevanceScore = Math.max(existing.relevanceScore, rec.relevanceScore);\n\n      // Update priority based on new relevance\n      existing.priority = existing.relevanceScore >= 60 ? 'high' :\n                         existing.relevanceScore >= 40 ? 'medium' :\n                         'low';\n    } else {\n      byId.set(rec.treatment.id, { ...rec });\n    }\n  }\n\n  return Array.from(byId.values()).sort((a, b) => b.relevanceScore - a.relevanceScore);\n}\n\n/**\n * Get supplement recommendations based on weaknesses\n */\nfunction getSupplementRecommendations(\n  weaknesses: MetricAnalysis[],\n  gender?: Gender\n): TreatmentRecommendation[] {\n  const recommendations: TreatmentRecommendation[] = [];\n\n  // Map weakness types to supplement categories\n  const hasSkinIssues = weaknesses.some(w =>\n    w.issue?.includes('skin') || w.metricId.includes('skin')\n  );\n  const hasHairIssues = weaknesses.some(w =>\n    w.issue?.includes('hair') || w.metricId.includes('hairline')\n  );\n  const hasGeneralAging = weaknesses.some(w =>\n    w.issue?.includes('aging') || w.severity.severity === 'moderate' || w.severity.severity === 'severe'\n  );\n\n  // Helper to create supplement recommendation\n  const createSupplementRec = (\n    supp: Supplement,\n    priority: 'high' | 'medium' | 'low',\n    relevanceScore: number,\n    targetMetrics: string[],\n    reasoning: string\n  ): TreatmentRecommendation => ({\n    treatment: {\n      id: supp.id,\n      name: supp.name,\n      category: 'lifestyle',\n      description: supp.description,\n      howItWorks: `Dosage: ${supp.dosage} ${supp.frequency}`,\n      effectiveness: supp.effectiveness,\n      evidenceLevel: supp.evidenceLevel,\n      pslImprovement: { min: 0.05, max: 0.15 },\n      costLevel: supp.costPerMonth.max > 30 ? 'medium' : 'low',\n      costRange: { min: supp.costPerMonth.min, max: supp.costPerMonth.max, currency: 'USD' },\n      costFrequency: 'monthly',\n      timelineToResults: supp.timelineToResults,\n      resultsDuration: 'Ongoing with continued use',\n      maintenanceRequired: true,\n      maintenanceFrequency: supp.frequency,\n      recoveryTime: 'None',\n      downtime: 'None',\n      painLevel: 'none',\n      riskLevel: supp.riskLevel,\n      sideEffects: supp.sideEffects,\n      contraindications: supp.contraindications,\n      targetMetrics,\n      targetIssues: supp.targetBenefits,\n      notes: supp.notes,\n      sources: supp.sources,\n    },\n    priority,\n    relevanceScore,\n    targetMetrics,\n    estimatedImprovement: 0.1,\n    reasoning,\n  });\n\n  // Add relevant supplements\n  if (hasSkinIssues || hasGeneralAging) {\n    const skinSupplements = SUPPLEMENTS.filter(s =>\n      s.category === 'skin' || s.category === 'anti-aging'\n    );\n    for (const supp of skinSupplements.slice(0, 3)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'medium',\n        50,\n        ['skin_quality'],\n        `${supp.name} supports skin health and anti-aging.`\n      ));\n    }\n  }\n\n  if (hasHairIssues && gender === 'male') {\n    const hairSupplements = SUPPLEMENTS.filter(s => s.category === 'hair');\n    for (const supp of hairSupplements.slice(0, 3)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'medium',\n        45,\n        ['hairline'],\n        `${supp.name} supports hair health.`\n      ));\n    }\n  }\n\n  // Always recommend foundational supplements\n  const foundational = SUPPLEMENTS.filter(s =>\n    ['vitamin_d3', 'omega_3', 'magnesium'].includes(s.id)\n  );\n  for (const supp of foundational) {\n    if (!recommendations.some(r => r.treatment.id === supp.id)) {\n      recommendations.push(createSupplementRec(\n        supp,\n        'low',\n        30,\n        ['general_health'],\n        `${supp.name} supports overall health and wellbeing.`\n      ));\n    }\n  }\n\n  return recommendations.slice(0, 10);\n}\n\n/**\n * Generate order of operations for treatments\n */\nfunction generateOrderOfOperations(\n  recommendations: TreatmentRecommendation[]\n): OrderOfOperation[] {\n  const operations: OrderOfOperation[] = [];\n\n  // Define category order: lifestyle -> softmaxxing -> non-surgical -> minimally invasive -> surgical\n  const categoryOrder: TreatmentCategory[] = [\n    'lifestyle',\n    'softmaxxing',\n    'non_surgical',\n    'minimally_invasive',\n    'surgical',\n  ];\n\n  // Group by category (only for valid treatment categories)\n  const validCategories: TreatmentCategory[] = ['lifestyle', 'softmaxxing', 'non_surgical', 'minimally_invasive', 'surgical'];\n  const byCategory = new Map<TreatmentCategory, TreatmentRecommendation[]>();\n  for (const rec of recommendations) {\n    const cat = rec.treatment.category as TreatmentCategory;\n    if (validCategories.includes(cat)) {\n      if (!byCategory.has(cat)) {\n        byCategory.set(cat, []);\n      }\n      byCategory.get(cat)!.push(rec);\n    }\n  }\n\n  let step = 1;\n  for (const category of categoryOrder) {\n    const recs = byCategory.get(category) || [];\n    // Sort by priority and relevance\n    recs.sort((a, b) => {\n      if (a.priority !== b.priority) {\n        const priorityOrder = { high: 0, medium: 1, low: 2 };\n        return priorityOrder[a.priority] - priorityOrder[b.priority];\n      }\n      return b.relevanceScore - a.relevanceScore;\n    });\n\n    for (const rec of recs.slice(0, 3)) { // Max 3 per category\n      const treatment = rec.treatment as Treatment | Surgery;\n      const operation: OrderOfOperation = {\n        step,\n        category,\n        treatment,\n        reasoning: getStepReasoning(step, category),\n      };\n\n      // Add prerequisites for surgical procedures\n      if (category === 'surgical') {\n        operation.prerequisites = ['Complete non-surgical options first', 'Consult with board-certified surgeon'];\n        operation.waitTime = '6-12 months recovery between major procedures';\n      }\n\n      operations.push(operation);\n      step++;\n    }\n  }\n\n  return operations;\n}\n\n/**\n * Generate reasoning for a step in order of operations\n */\nfunction getStepReasoning(\n  step: number,\n  category: TreatmentCategory\n): string {\n  if (step === 1) {\n    return 'Start with foundational changes before considering more invasive options.';\n  }\n\n  if (category === 'lifestyle' || category === 'softmaxxing') {\n    return 'Low-risk, reversible changes that can provide noticeable improvement.';\n  }\n\n  if (category === 'non_surgical') {\n    return 'Non-invasive treatments with minimal downtime to test results before committing to surgery.';\n  }\n\n  if (category === 'minimally_invasive') {\n    return 'Minimally invasive procedures can provide significant results with less risk than surgery.';\n  }\n\n  if (category === 'surgical') {\n    return 'Consider surgery only after exhausting less invasive options and with realistic expectations.';\n  }\n\n  return '';\n}\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\n/**\n * Get top priority recommendations across all categories\n */\nexport function getTopRecommendations(\n  plan: RecommendationPlan,\n  count: number = 5\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all\n    .sort((a, b) => b.relevanceScore - a.relevanceScore)\n    .slice(0, count);\n}\n\n/**\n * Get recommendations filtered by cost level\n */\nexport function getRecommendationsByCost(\n  plan: RecommendationPlan,\n  maxCost: 'free' | 'low' | 'medium' | 'high' | 'very_high'\n): TreatmentRecommendation[] {\n  const costOrder = ['free', 'low', 'medium', 'high', 'very_high'];\n  const maxCostIndex = costOrder.indexOf(maxCost);\n\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('costLevel' in treatment) {\n      return costOrder.indexOf(treatment.costLevel) <= maxCostIndex;\n    }\n    return true;\n  });\n}\n\n/**\n * Get recommendations with minimal downtime\n */\nexport function getNoDowntimeRecommendations(\n  plan: RecommendationPlan\n): TreatmentRecommendation[] {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n  ];\n\n  return all.filter(r => {\n    const treatment = r.treatment as Treatment;\n    if ('downtime' in treatment) {\n      const downtime = treatment.downtime.toLowerCase();\n      return downtime.includes('none') || downtime.includes('minimal');\n    }\n    return true;\n  });\n}\n\n/**\n * Format cost for display\n */\nexport function formatCost(treatment: Treatment | Surgery): string {\n  const { min, max, currency } = treatment.costRange;\n  const symbol = currency === 'USD' ? '$' : currency === 'EUR' ? '€' : currency === 'GBP' ? '£' : currency;\n\n  if (min === max) {\n    return `${symbol}${min.toLocaleString()}`;\n  }\n\n  return `${symbol}${min.toLocaleString()} - ${symbol}${max.toLocaleString()}`;\n}\n\n/**\n * Get summary statistics for a plan\n */\nexport function getPlanSummary(plan: RecommendationPlan): {\n  totalRecommendations: number;\n  highPriority: number;\n  mediumPriority: number;\n  lowPriority: number;\n  categoryCounts: Record<string, number>;\n  estimatedTotalImprovement: number;\n} {\n  const all = [\n    ...plan.lifestyle,\n    ...plan.softmaxxing,\n    ...plan.nonSurgical,\n    ...plan.minimallyInvasive,\n    ...plan.surgical,\n  ];\n\n  return {\n    totalRecommendations: all.length,\n    highPriority: all.filter(r => r.priority === 'high').length,\n    mediumPriority: all.filter(r => r.priority === 'medium').length,\n    lowPriority: all.filter(r => r.priority === 'low').length,\n    categoryCounts: {\n      lifestyle: plan.lifestyle.length,\n      softmaxxing: plan.softmaxxing.length,\n      nonSurgical: plan.nonSurgical.length,\n      minimallyInvasive: plan.minimallyInvasive.length,\n      surgical: plan.surgical.length,\n      supplements: plan.supplements.length,\n    },\n    estimatedTotalImprovement: plan.potentialImprovement,\n  };\n}\n","numLines":732,"startLine":1,"totalLines":732}}}
{"parentUuid":"d2931fe3-54c3-4c54-a250-1c715d810ab6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016Mm9m1GoQiNr2N2JhHcpkh","type":"tool_result","content":"     1→/**\n     2→ * Severity Classification System\n     3→ * Classifies metric deviations into severity levels with treatment recommendations\n     4→ */\n     5→\n     6→import { Severity, SeverityResult, SeverityThreshold, MetricIssueMapping, Gender } from './types';\n     7→\n     8→// ============================================\n     9→// SEVERITY THRESHOLDS BY METRIC\n    10→// ============================================\n    11→\n    12→export const SEVERITY_THRESHOLDS: SeverityThreshold[] = [\n    13→  // FRONT PROFILE METRICS\n    14→  {\n    15→    metric: 'fwhr',\n    16→    optimal: { min: 1.80, max: 2.00 },\n    17→    mild: { min: 1.65, max: 2.15 },\n    18→    moderate: { min: 1.55, max: 2.25 },\n    19→    severe: { min: 0, max: Infinity },\n    20→    unit: 'ratio',\n    21→    higherIsBetter: false, // mid-range is ideal\n    22→  },\n    23→  {\n    24→    metric: 'canthalTilt',\n    25→    optimal: { min: 4, max: 8 },\n    26→    mild: { min: 0, max: 10 },\n    27→    moderate: { min: -2, max: 12 },\n    28→    severe: { min: -Infinity, max: Infinity },\n    29→    unit: 'degrees',\n    30→    higherIsBetter: true,\n    31→  },\n    32→  {\n    33→    metric: 'facialThirdsUpper',\n    34→    optimal: { min: 30, max: 36 },\n    35→    mild: { min: 27, max: 39 },\n    36→    moderate: { min: 24, max: 42 },\n    37→    severe: { min: 0, max: Infinity },\n    38→    unit: 'percent',\n    39→  },\n    40→  {\n    41→    metric: 'facialThirdsMiddle',\n    42→    optimal: { min: 30, max: 36 },\n    43→    mild: { min: 27, max: 39 },\n    44→    moderate: { min: 24, max: 42 },\n    45→    severe: { min: 0, max: Infinity },\n    46→    unit: 'percent',\n    47→  },\n    48→  {\n    49→    metric: 'facialThirdsLower',\n    50→    optimal: { min: 30, max: 36 },\n    51→    mild: { min: 27, max: 39 },\n    52→    moderate: { min: 24, max: 42 },\n    53→    severe: { min: 0, max: Infinity },\n    54→    unit: 'percent',\n    55→  },\n    56→  {\n    57→    metric: 'nasalIndex',\n    58→    optimal: { min: 70, max: 85 },\n    59→    mild: { min: 65, max: 90 },\n    60→    moderate: { min: 60, max: 95 },\n    61→    severe: { min: 0, max: Infinity },\n    62→    unit: 'ratio',\n    63→  },\n    64→  {\n    65→    metric: 'interpupillaryDistance',\n    66→    optimal: { min: 44, max: 48 },\n    67→    mild: { min: 42, max: 50 },\n    68→    moderate: { min: 40, max: 52 },\n    69→    severe: { min: 0, max: Infinity },\n    70→    unit: 'percent',\n    71→  },\n    72→  {\n    73→    metric: 'mouthWidth',\n    74→    optimal: { min: 48, max: 54 },\n    75→    mild: { min: 44, max: 58 },\n    76→    moderate: { min: 40, max: 62 },\n    77→    severe: { min: 0, max: Infinity },\n    78→    unit: 'percent',\n    79→  },\n    80→  {\n    81→    metric: 'lipRatio',\n    82→    optimal: { min: 1.5, max: 2.0 },\n    83→    mild: { min: 1.2, max: 2.3 },\n    84→    moderate: { min: 1.0, max: 2.6 },\n    85→    severe: { min: 0, max: Infinity },\n    86→    unit: 'ratio',\n    87→  },\n    88→  {\n    89→    metric: 'jawWidthRatio',\n    90→    optimal: { min: 0.75, max: 0.80 },\n    91→    mild: { min: 0.72, max: 0.83 },\n    92→    moderate: { min: 0.68, max: 0.87 },\n    93→    severe: { min: 0, max: Infinity },\n    94→    unit: 'ratio',\n    95→  },\n    96→  {\n    97→    metric: 'facialSymmetry',\n    98→    optimal: { min: 95, max: 100 },\n    99→    mild: { min: 90, max: 100 },\n   100→    moderate: { min: 85, max: 100 },\n   101→    severe: { min: 0, max: 100 },\n   102→    unit: 'percent',\n   103→    higherIsBetter: true,\n   104→  },\n   105→  {\n   106→    metric: 'eyeSpacing',\n   107→    optimal: { min: 0.95, max: 1.05 },\n   108→    mild: { min: 0.90, max: 1.10 },\n   109→    moderate: { min: 0.85, max: 1.15 },\n   110→    severe: { min: 0, max: Infinity },\n   111→    unit: 'ratio',\n   112→  },\n   113→  {\n   114→    metric: 'noseWidth',\n   115→    optimal: { min: 0.95, max: 1.05 },\n   116→    mild: { min: 0.90, max: 1.10 },\n   117→    moderate: { min: 0.85, max: 1.15 },\n   118→    severe: { min: 0, max: Infinity },\n   119→    unit: 'ratio',\n   120→  },\n   121→  {\n   122→    metric: 'cheekboneWidth',\n   123→    optimal: { min: 0.85, max: 0.92 },\n   124→    mild: { min: 0.80, max: 0.97 },\n   125→    moderate: { min: 0.75, max: 1.02 },\n   126→    severe: { min: 0, max: Infinity },\n   127→    unit: 'ratio',\n   128→  },\n   129→\n   130→  // SIDE PROFILE METRICS\n   131→  {\n   132→    metric: 'gonialAngle',\n   133→    optimal: { min: 120, max: 130 },\n   134→    mild: { min: 115, max: 135 },\n   135→    moderate: { min: 110, max: 140 },\n   136→    severe: { min: 0, max: Infinity },\n   137→    unit: 'degrees',\n   138→  },\n   139→  {\n   140→    metric: 'nasolabialAngle',\n   141→    optimal: { min: 95, max: 110 }, // Gender-adjusted in functions\n   142→    mild: { min: 85, max: 115 },\n   143→    moderate: { min: 80, max: 120 },\n   144→    severe: { min: 0, max: Infinity },\n   145→    unit: 'degrees',\n   146→  },\n   147→  {\n   148→    metric: 'nasofrontalAngle',\n   149→    optimal: { min: 130, max: 140 },\n   150→    mild: { min: 125, max: 145 },\n   151→    moderate: { min: 120, max: 150 },\n   152→    severe: { min: 0, max: Infinity },\n   153→    unit: 'degrees',\n   154→  },\n   155→  {\n   156→    metric: 'chinProjection',\n   157→    optimal: { min: -4, max: 2 },\n   158→    mild: { min: -6, max: 4 },\n   159→    moderate: { min: -8, max: 6 },\n   160→    severe: { min: -Infinity, max: Infinity },\n   161→    unit: 'mm',\n   162→  },\n   163→  {\n   164→    metric: 'mentoLabialAngle',\n   165→    optimal: { min: 110, max: 130 },\n   166→    mild: { min: 100, max: 140 },\n   167→    moderate: { min: 90, max: 150 },\n   168→    severe: { min: 0, max: Infinity },\n   169→    unit: 'degrees',\n   170→  },\n   171→  {\n   172→    metric: 'facialConvexity',\n   173→    optimal: { min: 165, max: 175 },\n   174→    mild: { min: 160, max: 180 },\n   175→    moderate: { min: 155, max: 185 },\n   176→    severe: { min: 0, max: Infinity },\n   177→    unit: 'degrees',\n   178→  },\n   179→  {\n   180→    metric: 'eLineUpperLip',\n   181→    optimal: { min: -4, max: -1 },\n   182→    mild: { min: -6, max: 1 },\n   183→    moderate: { min: -8, max: 3 },\n   184→    severe: { min: -Infinity, max: Infinity },\n   185→    unit: 'mm',\n   186→  },\n   187→  {\n   188→    metric: 'eLineLowerLip',\n   189→    optimal: { min: -2, max: 1 },\n   190→    mild: { min: -4, max: 3 },\n   191→    moderate: { min: -6, max: 5 },\n   192→    severe: { min: -Infinity, max: Infinity },\n   193→    unit: 'mm',\n   194→  },\n   195→  {\n   196→    metric: 'submCervicalAngle',\n   197→    optimal: { min: 100, max: 120 },\n   198→    mild: { min: 90, max: 130 },\n   199→    moderate: { min: 80, max: 140 },\n   200→    severe: { min: 0, max: Infinity },\n   201→    unit: 'degrees',\n   202→  },\n   203→  {\n   204→    metric: 'totalFacialConvexity',\n   205→    optimal: { min: 135, max: 145 },\n   206→    mild: { min: 130, max: 150 },\n   207→    moderate: { min: 125, max: 155 },\n   208→    severe: { min: 0, max: Infinity },\n   209→    unit: 'degrees',\n   210→  },\n   211→];\n   212→\n   213→// ============================================\n   214→// METRIC TO ISSUE MAPPINGS\n   215→// ============================================\n   216→\n   217→export const METRIC_ISSUE_MAPPINGS: MetricIssueMapping[] = [\n   218→  // Front Profile\n   219→  {\n   220→    metric: 'fwhr',\n   221→    lowIssue: 'narrow_face',\n   222→    highIssue: 'wide_face',\n   223→    lowTreatments: ['cheek_filler', 'cheek_implants', 'jaw_implants'],\n   224→    highTreatments: ['botox_masseter', 'buccal_fat_removal', 'zygoma_reduction', 'mandible_reduction'],\n   225→  },\n   226→  {\n   227→    metric: 'canthalTilt',\n   228→    lowIssue: 'negative_canthal_tilt',\n   229→    highIssue: 'excessive_positive_tilt',\n   230→    lowTreatments: ['canthoplasty', 'pdo_threads', 'botox_brow_lift'],\n   231→    highTreatments: [], // Rarely treated\n   232→  },\n   233→  {\n   234→    metric: 'nasalIndex',\n   235→    lowIssue: 'narrow_nose',\n   236→    highIssue: 'wide_nose',\n   237→    lowTreatments: ['nose_filler'],\n   238→    highTreatments: ['rhinoplasty_reduction', 'nose_filler'],\n   239→  },\n   240→  {\n   241→    metric: 'lipRatio',\n   242→    lowIssue: 'thin_lower_lip',\n   243→    highIssue: 'thin_upper_lip',\n   244→    lowTreatments: ['lip_filler'],\n   245→    highTreatments: ['lip_filler', 'lip_lift'],\n   246→  },\n   247→  {\n   248→    metric: 'jawWidthRatio',\n   249→    lowIssue: 'narrow_jaw',\n   250→    highIssue: 'wide_jaw',\n   251→    lowTreatments: ['jaw_implants', 'jawline_filler'],\n   252→    highTreatments: ['botox_masseter', 'mandible_reduction'],\n   253→  },\n   254→  {\n   255→    metric: 'facialSymmetry',\n   256→    lowIssue: 'facial_asymmetry',\n   257→    highIssue: 'optimal',\n   258→    lowTreatments: ['filler_correction', 'botox_asymmetry', 'bimax'],\n   259→    highTreatments: [],\n   260→  },\n   261→  {\n   262→    metric: 'cheekboneWidth',\n   263→    lowIssue: 'flat_cheeks',\n   264→    highIssue: 'wide_cheekbones',\n   265→    lowTreatments: ['cheek_filler', 'cheek_implants'],\n   266→    highTreatments: ['zygoma_reduction'],\n   267→  },\n   268→\n   269→  // Side Profile\n   270→  {\n   271→    metric: 'gonialAngle',\n   272→    lowIssue: 'over_prominent_jaw',\n   273→    highIssue: 'weak_jaw',\n   274→    lowTreatments: ['mandible_reduction'],\n   275→    highTreatments: ['jaw_implants', 'jawline_filler', 'bsso'],\n   276→  },\n   277→  {\n   278→    metric: 'nasolabialAngle',\n   279→    lowIssue: 'droopy_nose_tip',\n   280→    highIssue: 'over_rotated_tip',\n   281→    lowTreatments: ['rhinoplasty_tip', 'nose_filler'],\n   282→    highTreatments: ['rhinoplasty_tip', 'rhinoplasty_reduction'],\n   283→  },\n   284→  {\n   285→    metric: 'chinProjection',\n   286→    lowIssue: 'recessed_chin',\n   287→    highIssue: 'prominent_chin',\n   288→    lowTreatments: ['genioplasty', 'chin_implant', 'chin_filler'],\n   289→    highTreatments: ['genioplasty'],\n   290→  },\n   291→  {\n   292→    metric: 'eLineUpperLip',\n   293→    lowIssue: 'lips_retrude',\n   294→    highIssue: 'lips_protrude',\n   295→    lowTreatments: ['lip_filler', 'bimax'],\n   296→    highTreatments: ['bimax', 'lip_reduction'],\n   297→  },\n   298→  {\n   299→    metric: 'eLineLowerLip',\n   300→    lowIssue: 'lips_retrude',\n   301→    highIssue: 'lips_protrude',\n   302→    lowTreatments: ['lip_filler', 'bimax'],\n   303→    highTreatments: ['bimax', 'lip_reduction'],\n   304→  },\n   305→  {\n   306→    metric: 'facialConvexity',\n   307→    lowIssue: 'concave_profile',\n   308→    highIssue: 'convex_profile',\n   309→    lowTreatments: ['bimax', 'chin_filler', 'lefort_1'],\n   310→    highTreatments: ['bimax', 'rhinoplasty_reduction'],\n   311→  },\n   312→  {\n   313→    metric: 'mentoLabialAngle',\n   314→    lowIssue: 'deep_mentolabial_fold',\n   315→    highIssue: 'flat_mentolabial_fold',\n   316→    lowTreatments: ['chin_filler', 'genioplasty'],\n   317→    highTreatments: [],\n   318→  },\n   319→  {\n   320→    metric: 'submCervicalAngle',\n   321→    lowIssue: 'undefined_neck_jaw',\n   322→    highIssue: 'excessive_neck_angle',\n   323→    lowTreatments: ['kybella', 'posture_correction', 'leanmaxxing'],\n   324→    highTreatments: [],\n   325→  },\n   326→];\n   327→\n   328→// ============================================\n   329→// SEVERITY CLASSIFICATION FUNCTIONS\n   330→// ============================================\n   331→\n   332→/**\n   333→ * Classify a score into a severity level\n   334→ */\n   335→export function classifyByScore(score: number): SeverityResult {\n   336→  if (score >= 85) {\n   337→    return {\n   338→      severity: 'optimal',\n   339→      label: 'Optimal',\n   340→      color: '#22c55e',\n   341→      icon: '✓',\n   342→      description: 'Excellent - within ideal range',\n   343→    };\n   344→  }\n   345→  if (score >= 70) {\n   346→    return {\n   347→      severity: 'mild',\n   348→      label: 'Good',\n   349→      color: '#84cc16',\n   350→      icon: '○',\n   351→      description: 'Good - minor deviation from ideal',\n   352→    };\n   353→  }\n   354→  if (score >= 50) {\n   355→    return {\n   356→      severity: 'moderate',\n   357→      label: 'Average',\n   358→      color: '#f59e0b',\n   359→      icon: '△',\n   360→      description: 'Average - noticeable deviation',\n   361→    };\n   362→  }\n   363→  return {\n   364→    severity: 'severe',\n   365→    label: 'Below Average',\n   366→    color: '#ef4444',\n   367→    icon: '✗',\n   368→    description: 'Below average - significant deviation',\n   369→  };\n   370→}\n   371→\n   372→/**\n   373→ * Get severity threshold for a specific metric\n   374→ */\n   375→export function getSeverityThreshold(metric: string): SeverityThreshold | undefined {\n   376→  return SEVERITY_THRESHOLDS.find(t => t.metric === metric);\n   377→}\n   378→\n   379→/**\n   380→ * Classify a metric value based on its specific thresholds\n   381→ */\n   382→export function classifyMetricValue(\n   383→  metric: string,\n   384→  value: number,\n   385→  gender?: Gender\n   386→): SeverityResult {\n   387→  const threshold = getSeverityThreshold(metric);\n   388→\n   389→  if (!threshold) {\n   390→    // Fallback to score-based classification if no threshold defined\n   391→    return classifyByScore(value);\n   392→  }\n   393→\n   394→  // Apply gender-specific adjustments\n   395→  const adjustedThreshold = { ...threshold };\n   396→  if (gender && metric === 'nasolabialAngle') {\n   397→    if (gender === 'male') {\n   398→      adjustedThreshold.optimal = { min: 90, max: 105 };\n   399→    } else {\n   400→      adjustedThreshold.optimal = { min: 100, max: 115 };\n   401→    }\n   402→  }\n   403→\n   404→  // Check which range the value falls into\n   405→  if (value >= adjustedThreshold.optimal.min && value <= adjustedThreshold.optimal.max) {\n   406→    return {\n   407→      severity: 'optimal',\n   408→      label: 'Optimal',\n   409→      color: '#22c55e',\n   410→      icon: '✓',\n   411→      description: `Within ideal range (${adjustedThreshold.optimal.min}-${adjustedThreshold.optimal.max}${adjustedThreshold.unit})`,\n   412→    };\n   413→  }\n   414→\n   415→  if (value >= adjustedThreshold.mild.min && value <= adjustedThreshold.mild.max) {\n   416→    return {\n   417→      severity: 'mild',\n   418→      label: 'Good',\n   419→      color: '#84cc16',\n   420→      icon: '○',\n   421→      description: 'Minor deviation from ideal',\n   422→    };\n   423→  }\n   424→\n   425→  if (value >= adjustedThreshold.moderate.min && value <= adjustedThreshold.moderate.max) {\n   426→    return {\n   427→      severity: 'moderate',\n   428→      label: 'Average',\n   429→      color: '#f59e0b',\n   430→      icon: '△',\n   431→      description: 'Noticeable deviation from ideal',\n   432→    };\n   433→  }\n   434→\n   435→  return {\n   436→    severity: 'severe',\n   437→    label: 'Below Average',\n   438→    color: '#ef4444',\n   439→    icon: '✗',\n   440→    description: 'Significant deviation from ideal',\n   441→  };\n   442→}\n   443→\n   444→/**\n   445→ * Calculate deviation from ideal for a metric\n   446→ */\n   447→export function calculateDeviation(\n   448→  metric: string,\n   449→  value: number\n   450→): { deviation: number; deviationPercent: number; direction: 'low' | 'high' | 'optimal' } {\n   451→  const threshold = getSeverityThreshold(metric);\n   452→\n   453→  if (!threshold) {\n   454→    return { deviation: 0, deviationPercent: 0, direction: 'optimal' };\n   455→  }\n   456→\n   457→  const idealMidpoint = (threshold.optimal.min + threshold.optimal.max) / 2;\n   458→  const deviation = value - idealMidpoint;\n   459→  const idealRange = threshold.optimal.max - threshold.optimal.min;\n   460→  const deviationPercent = (Math.abs(deviation) / idealRange) * 100;\n   461→\n   462→  let direction: 'low' | 'high' | 'optimal';\n   463→  if (value >= threshold.optimal.min && value <= threshold.optimal.max) {\n   464→    direction = 'optimal';\n   465→  } else if (value < threshold.optimal.min) {\n   466→    direction = 'low';\n   467→  } else {\n   468→    direction = 'high';\n   469→  }\n   470→\n   471→  return { deviation, deviationPercent, direction };\n   472→}\n   473→\n   474→/**\n   475→ * Get the issue name for a metric deviation\n   476→ */\n   477→export function getIssueForMetric(\n   478→  metric: string,\n   479→  direction: 'low' | 'high' | 'optimal'\n   480→): string | null {\n   481→  if (direction === 'optimal') return null;\n   482→\n   483→  const mapping = METRIC_ISSUE_MAPPINGS.find(m => m.metric === metric);\n   484→  if (!mapping) return null;\n   485→\n   486→  return direction === 'low' ? mapping.lowIssue : mapping.highIssue;\n   487→}\n   488→\n   489→/**\n   490→ * Get treatment IDs for a metric deviation\n   491→ */\n   492→export function getTreatmentIdsForMetric(\n   493→  metric: string,\n   494→  direction: 'low' | 'high' | 'optimal'\n   495→): string[] {\n   496→  if (direction === 'optimal') return [];\n   497→\n   498→  const mapping = METRIC_ISSUE_MAPPINGS.find(m => m.metric === metric);\n   499→  if (!mapping) return [];\n   500→\n   501→  return direction === 'low' ? mapping.lowTreatments : mapping.highTreatments;\n   502→}\n   503→\n   504→/**\n   505→ * Get overall severity from multiple metric analyses\n   506→ */\n   507→export function getOverallSeverity(severities: Severity[]): SeverityResult {\n   508→  const severeCount = severities.filter(s => s === 'severe').length;\n   509→  const moderateCount = severities.filter(s => s === 'moderate').length;\n   510→  const mildCount = severities.filter(s => s === 'mild').length;\n   511→\n   512→  // Weighted scoring\n   513→  const score = (\n   514→    (severities.filter(s => s === 'optimal').length * 100) +\n   515→    (mildCount * 75) +\n   516→    (moderateCount * 50) +\n   517→    (severeCount * 25)\n   518→  ) / severities.length;\n   519→\n   520→  return classifyByScore(score);\n   521→}\n   522→\n   523→/**\n   524→ * Prioritize metrics by severity and impact\n   525→ */\n   526→export function prioritizeMetrics(\n   527→  metricSeverities: Array<{ metric: string; severity: Severity; impact: number }>\n   528→): Array<{ metric: string; severity: Severity; priority: 'high' | 'medium' | 'low' }> {\n   529→  const severityWeight: Record<Severity, number> = {\n   530→    severe: 4,\n   531→    moderate: 3,\n   532→    mild: 2,\n   533→    optimal: 1,\n   534→  };\n   535→\n   536→  return metricSeverities\n   537→    .map(m => ({\n   538→      ...m,\n   539→      score: severityWeight[m.severity] * m.impact,\n   540→    }))\n   541→    .sort((a, b) => b.score - a.score)\n   542→    .map((m, index) => ({\n   543→      metric: m.metric,\n   544→      severity: m.severity,\n   545→      priority: index < 3 ? 'high' as const :\n   546→                index < 7 ? 'medium' as const :\n   547→                'low' as const,\n   548→    }));\n   549→}\n   550→\n   551→// ============================================\n   552→// PSL RATING CONVERSION\n   553→// ============================================\n   554→\n   555→/**\n   556→ * Convert harmony score to PSL rating\n   557→ */\n   558→export function harmonyToPSL(harmonyPercent: number): {\n   559→  psl: number;\n   560→  tier: string;\n   561→  percentile: number;\n   562→  description: string;\n   563→} {\n   564→  // Based on FaceIQ formula: Harmony % = ((Score - Min) / (Max - Min)) * 100\n   565→  // Where Max = 333.71, Min = -337.71\n   566→\n   567→  // Convert harmony percent to approximate PSL\n   568→  // Harmony 0% = PSL 3.0, Harmony 100% = PSL 7.5\n   569→  const psl = 3.0 + (harmonyPercent / 100) * 4.5;\n   570→  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n   571→\n   572→  // Determine tier\n   573→  let tier: string;\n   574→  let percentile: number;\n   575→  let description: string;\n   576→\n   577→  if (clampedPSL >= 7.5) {\n   578→    tier = 'Top Model';\n   579→    percentile = 99.99;\n   580→    description = 'Near perfection - world-class genetics';\n   581→  } else if (clampedPSL >= 7.0) {\n   582→    tier = 'Chad';\n   583→    percentile = 99.87;\n   584→    description = 'Exceptional - top 0.1%';\n   585→  } else if (clampedPSL >= 6.5) {\n   586→    tier = 'Chadlite';\n   587→    percentile = 99.0;\n   588→    description = 'Very attractive - top 1%';\n   589→  } else if (clampedPSL >= 6.0) {\n   590→    tier = 'High Tier Normie+';\n   591→    percentile = 97.25;\n   592→    description = 'Notably attractive - top 3%';\n   593→  } else if (clampedPSL >= 5.5) {\n   594→    tier = 'High Tier Normie';\n   595→    percentile = 90.0;\n   596→    description = 'Above average - top 10%';\n   597→  } else if (clampedPSL >= 5.0) {\n   598→    tier = 'Mid Tier Normie+';\n   599→    percentile = 84.15;\n   600→    description = 'Slightly above average';\n   601→  } else if (clampedPSL >= 4.5) {\n   602→    tier = 'Mid Tier Normie';\n   603→    percentile = 65.0;\n   604→    description = 'Average';\n   605→  } else if (clampedPSL >= 4.0) {\n   606→    tier = 'Low Tier Normie';\n   607→    percentile = 50.0;\n   608→    description = 'Median';\n   609→  } else if (clampedPSL >= 3.5) {\n   610→    tier = 'Below Average';\n   611→    percentile = 30.0;\n   612→    description = 'Below average';\n   613→  } else {\n   614→    tier = 'Subpar';\n   615→    percentile = 15.0;\n   616→    description = 'Noticeably below average';\n   617→  }\n   618→\n   619→  return {\n   620→    psl: Math.round(clampedPSL * 10) / 10,\n   621→    tier,\n   622→    percentile,\n   623→    description,\n   624→  };\n   625→}\n   626→\n   627→/**\n   628→ * Estimate potential PSL improvement from treatments\n   629→ */\n   630→export function estimatePotentialPSL(\n   631→  currentPSL: number,\n   632→  treatmentImprovements: number[]\n   633→): { potentialPSL: number; totalImprovement: number } {\n   634→  // Sum improvements with diminishing returns\n   635→  const sortedImprovements = treatmentImprovements.sort((a, b) => b - a);\n   636→\n   637→  let totalImprovement = 0;\n   638→  sortedImprovements.forEach((improvement, index) => {\n   639→    // Each subsequent improvement is reduced by 20%\n   640→    const diminishingFactor = Math.pow(0.8, index);\n   641→    totalImprovement += improvement * diminishingFactor;\n   642→  });\n   643→\n   644→  // Cap total improvement at realistic level\n   645→  const cappedImprovement = Math.min(totalImprovement, 2.5);\n   646→  const potentialPSL = Math.min(7.5, currentPSL + cappedImprovement);\n   647→\n   648→  return {\n   649→    potentialPSL: Math.round(potentialPSL * 10) / 10,\n   650→    totalImprovement: Math.round(cappedImprovement * 10) / 10,\n   651→  };\n   652→}\n   653→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6f052752-bd60-444f-9334-5a4395001c7b","timestamp":"2025-12-24T20:19:15.094Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/severity.ts","content":"/**\n * Severity Classification System\n * Classifies metric deviations into severity levels with treatment recommendations\n */\n\nimport { Severity, SeverityResult, SeverityThreshold, MetricIssueMapping, Gender } from './types';\n\n// ============================================\n// SEVERITY THRESHOLDS BY METRIC\n// ============================================\n\nexport const SEVERITY_THRESHOLDS: SeverityThreshold[] = [\n  // FRONT PROFILE METRICS\n  {\n    metric: 'fwhr',\n    optimal: { min: 1.80, max: 2.00 },\n    mild: { min: 1.65, max: 2.15 },\n    moderate: { min: 1.55, max: 2.25 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n    higherIsBetter: false, // mid-range is ideal\n  },\n  {\n    metric: 'canthalTilt',\n    optimal: { min: 4, max: 8 },\n    mild: { min: 0, max: 10 },\n    moderate: { min: -2, max: 12 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'degrees',\n    higherIsBetter: true,\n  },\n  {\n    metric: 'facialThirdsUpper',\n    optimal: { min: 30, max: 36 },\n    mild: { min: 27, max: 39 },\n    moderate: { min: 24, max: 42 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'facialThirdsMiddle',\n    optimal: { min: 30, max: 36 },\n    mild: { min: 27, max: 39 },\n    moderate: { min: 24, max: 42 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'facialThirdsLower',\n    optimal: { min: 30, max: 36 },\n    mild: { min: 27, max: 39 },\n    moderate: { min: 24, max: 42 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'nasalIndex',\n    optimal: { min: 70, max: 85 },\n    mild: { min: 65, max: 90 },\n    moderate: { min: 60, max: 95 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'interpupillaryDistance',\n    optimal: { min: 44, max: 48 },\n    mild: { min: 42, max: 50 },\n    moderate: { min: 40, max: 52 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'mouthWidth',\n    optimal: { min: 48, max: 54 },\n    mild: { min: 44, max: 58 },\n    moderate: { min: 40, max: 62 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'lipRatio',\n    optimal: { min: 1.5, max: 2.0 },\n    mild: { min: 1.2, max: 2.3 },\n    moderate: { min: 1.0, max: 2.6 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'jawWidthRatio',\n    optimal: { min: 0.75, max: 0.80 },\n    mild: { min: 0.72, max: 0.83 },\n    moderate: { min: 0.68, max: 0.87 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'facialSymmetry',\n    optimal: { min: 95, max: 100 },\n    mild: { min: 90, max: 100 },\n    moderate: { min: 85, max: 100 },\n    severe: { min: 0, max: 100 },\n    unit: 'percent',\n    higherIsBetter: true,\n  },\n  {\n    metric: 'eyeSpacing',\n    optimal: { min: 0.95, max: 1.05 },\n    mild: { min: 0.90, max: 1.10 },\n    moderate: { min: 0.85, max: 1.15 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'noseWidth',\n    optimal: { min: 0.95, max: 1.05 },\n    mild: { min: 0.90, max: 1.10 },\n    moderate: { min: 0.85, max: 1.15 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'cheekboneWidth',\n    optimal: { min: 0.85, max: 0.92 },\n    mild: { min: 0.80, max: 0.97 },\n    moderate: { min: 0.75, max: 1.02 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n\n  // SIDE PROFILE METRICS\n  {\n    metric: 'gonialAngle',\n    optimal: { min: 120, max: 130 },\n    mild: { min: 115, max: 135 },\n    moderate: { min: 110, max: 140 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'nasolabialAngle',\n    optimal: { min: 95, max: 110 }, // Gender-adjusted in functions\n    mild: { min: 85, max: 115 },\n    moderate: { min: 80, max: 120 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'nasofrontalAngle',\n    optimal: { min: 130, max: 140 },\n    mild: { min: 125, max: 145 },\n    moderate: { min: 120, max: 150 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'chinProjection',\n    optimal: { min: -4, max: 2 },\n    mild: { min: -6, max: 4 },\n    moderate: { min: -8, max: 6 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'mm',\n  },\n  {\n    metric: 'mentoLabialAngle',\n    optimal: { min: 110, max: 130 },\n    mild: { min: 100, max: 140 },\n    moderate: { min: 90, max: 150 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'facialConvexity',\n    optimal: { min: 165, max: 175 },\n    mild: { min: 160, max: 180 },\n    moderate: { min: 155, max: 185 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'eLineUpperLip',\n    optimal: { min: -4, max: -1 },\n    mild: { min: -6, max: 1 },\n    moderate: { min: -8, max: 3 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'mm',\n  },\n  {\n    metric: 'eLineLowerLip',\n    optimal: { min: -2, max: 1 },\n    mild: { min: -4, max: 3 },\n    moderate: { min: -6, max: 5 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'mm',\n  },\n  {\n    metric: 'submCervicalAngle',\n    optimal: { min: 100, max: 120 },\n    mild: { min: 90, max: 130 },\n    moderate: { min: 80, max: 140 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'totalFacialConvexity',\n    optimal: { min: 135, max: 145 },\n    mild: { min: 130, max: 150 },\n    moderate: { min: 125, max: 155 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n];\n\n// ============================================\n// METRIC TO ISSUE MAPPINGS\n// ============================================\n\nexport const METRIC_ISSUE_MAPPINGS: MetricIssueMapping[] = [\n  // Front Profile\n  {\n    metric: 'fwhr',\n    lowIssue: 'narrow_face',\n    highIssue: 'wide_face',\n    lowTreatments: ['cheek_filler', 'cheek_implants', 'jaw_implants'],\n    highTreatments: ['botox_masseter', 'buccal_fat_removal', 'zygoma_reduction', 'mandible_reduction'],\n  },\n  {\n    metric: 'canthalTilt',\n    lowIssue: 'negative_canthal_tilt',\n    highIssue: 'excessive_positive_tilt',\n    lowTreatments: ['canthoplasty', 'pdo_threads', 'botox_brow_lift'],\n    highTreatments: [], // Rarely treated\n  },\n  {\n    metric: 'nasalIndex',\n    lowIssue: 'narrow_nose',\n    highIssue: 'wide_nose',\n    lowTreatments: ['nose_filler'],\n    highTreatments: ['rhinoplasty_reduction', 'nose_filler'],\n  },\n  {\n    metric: 'lipRatio',\n    lowIssue: 'thin_lower_lip',\n    highIssue: 'thin_upper_lip',\n    lowTreatments: ['lip_filler'],\n    highTreatments: ['lip_filler', 'lip_lift'],\n  },\n  {\n    metric: 'jawWidthRatio',\n    lowIssue: 'narrow_jaw',\n    highIssue: 'wide_jaw',\n    lowTreatments: ['jaw_implants', 'jawline_filler'],\n    highTreatments: ['botox_masseter', 'mandible_reduction'],\n  },\n  {\n    metric: 'facialSymmetry',\n    lowIssue: 'facial_asymmetry',\n    highIssue: 'optimal',\n    lowTreatments: ['filler_correction', 'botox_asymmetry', 'bimax'],\n    highTreatments: [],\n  },\n  {\n    metric: 'cheekboneWidth',\n    lowIssue: 'flat_cheeks',\n    highIssue: 'wide_cheekbones',\n    lowTreatments: ['cheek_filler', 'cheek_implants'],\n    highTreatments: ['zygoma_reduction'],\n  },\n\n  // Side Profile\n  {\n    metric: 'gonialAngle',\n    lowIssue: 'over_prominent_jaw',\n    highIssue: 'weak_jaw',\n    lowTreatments: ['mandible_reduction'],\n    highTreatments: ['jaw_implants', 'jawline_filler', 'bsso'],\n  },\n  {\n    metric: 'nasolabialAngle',\n    lowIssue: 'droopy_nose_tip',\n    highIssue: 'over_rotated_tip',\n    lowTreatments: ['rhinoplasty_tip', 'nose_filler'],\n    highTreatments: ['rhinoplasty_tip', 'rhinoplasty_reduction'],\n  },\n  {\n    metric: 'chinProjection',\n    lowIssue: 'recessed_chin',\n    highIssue: 'prominent_chin',\n    lowTreatments: ['genioplasty', 'chin_implant', 'chin_filler'],\n    highTreatments: ['genioplasty'],\n  },\n  {\n    metric: 'eLineUpperLip',\n    lowIssue: 'lips_retrude',\n    highIssue: 'lips_protrude',\n    lowTreatments: ['lip_filler', 'bimax'],\n    highTreatments: ['bimax', 'lip_reduction'],\n  },\n  {\n    metric: 'eLineLowerLip',\n    lowIssue: 'lips_retrude',\n    highIssue: 'lips_protrude',\n    lowTreatments: ['lip_filler', 'bimax'],\n    highTreatments: ['bimax', 'lip_reduction'],\n  },\n  {\n    metric: 'facialConvexity',\n    lowIssue: 'concave_profile',\n    highIssue: 'convex_profile',\n    lowTreatments: ['bimax', 'chin_filler', 'lefort_1'],\n    highTreatments: ['bimax', 'rhinoplasty_reduction'],\n  },\n  {\n    metric: 'mentoLabialAngle',\n    lowIssue: 'deep_mentolabial_fold',\n    highIssue: 'flat_mentolabial_fold',\n    lowTreatments: ['chin_filler', 'genioplasty'],\n    highTreatments: [],\n  },\n  {\n    metric: 'submCervicalAngle',\n    lowIssue: 'undefined_neck_jaw',\n    highIssue: 'excessive_neck_angle',\n    lowTreatments: ['kybella', 'posture_correction', 'leanmaxxing'],\n    highTreatments: [],\n  },\n];\n\n// ============================================\n// SEVERITY CLASSIFICATION FUNCTIONS\n// ============================================\n\n/**\n * Classify a score into a severity level\n */\nexport function classifyByScore(score: number): SeverityResult {\n  if (score >= 85) {\n    return {\n      severity: 'optimal',\n      label: 'Optimal',\n      color: '#22c55e',\n      icon: '✓',\n      description: 'Excellent - within ideal range',\n    };\n  }\n  if (score >= 70) {\n    return {\n      severity: 'mild',\n      label: 'Good',\n      color: '#84cc16',\n      icon: '○',\n      description: 'Good - minor deviation from ideal',\n    };\n  }\n  if (score >= 50) {\n    return {\n      severity: 'moderate',\n      label: 'Average',\n      color: '#f59e0b',\n      icon: '△',\n      description: 'Average - noticeable deviation',\n    };\n  }\n  return {\n    severity: 'severe',\n    label: 'Below Average',\n    color: '#ef4444',\n    icon: '✗',\n    description: 'Below average - significant deviation',\n  };\n}\n\n/**\n * Get severity threshold for a specific metric\n */\nexport function getSeverityThreshold(metric: string): SeverityThreshold | undefined {\n  return SEVERITY_THRESHOLDS.find(t => t.metric === metric);\n}\n\n/**\n * Classify a metric value based on its specific thresholds\n */\nexport function classifyMetricValue(\n  metric: string,\n  value: number,\n  gender?: Gender\n): SeverityResult {\n  const threshold = getSeverityThreshold(metric);\n\n  if (!threshold) {\n    // Fallback to score-based classification if no threshold defined\n    return classifyByScore(value);\n  }\n\n  // Apply gender-specific adjustments\n  const adjustedThreshold = { ...threshold };\n  if (gender && metric === 'nasolabialAngle') {\n    if (gender === 'male') {\n      adjustedThreshold.optimal = { min: 90, max: 105 };\n    } else {\n      adjustedThreshold.optimal = { min: 100, max: 115 };\n    }\n  }\n\n  // Check which range the value falls into\n  if (value >= adjustedThreshold.optimal.min && value <= adjustedThreshold.optimal.max) {\n    return {\n      severity: 'optimal',\n      label: 'Optimal',\n      color: '#22c55e',\n      icon: '✓',\n      description: `Within ideal range (${adjustedThreshold.optimal.min}-${adjustedThreshold.optimal.max}${adjustedThreshold.unit})`,\n    };\n  }\n\n  if (value >= adjustedThreshold.mild.min && value <= adjustedThreshold.mild.max) {\n    return {\n      severity: 'mild',\n      label: 'Good',\n      color: '#84cc16',\n      icon: '○',\n      description: 'Minor deviation from ideal',\n    };\n  }\n\n  if (value >= adjustedThreshold.moderate.min && value <= adjustedThreshold.moderate.max) {\n    return {\n      severity: 'moderate',\n      label: 'Average',\n      color: '#f59e0b',\n      icon: '△',\n      description: 'Noticeable deviation from ideal',\n    };\n  }\n\n  return {\n    severity: 'severe',\n    label: 'Below Average',\n    color: '#ef4444',\n    icon: '✗',\n    description: 'Significant deviation from ideal',\n  };\n}\n\n/**\n * Calculate deviation from ideal for a metric\n */\nexport function calculateDeviation(\n  metric: string,\n  value: number\n): { deviation: number; deviationPercent: number; direction: 'low' | 'high' | 'optimal' } {\n  const threshold = getSeverityThreshold(metric);\n\n  if (!threshold) {\n    return { deviation: 0, deviationPercent: 0, direction: 'optimal' };\n  }\n\n  const idealMidpoint = (threshold.optimal.min + threshold.optimal.max) / 2;\n  const deviation = value - idealMidpoint;\n  const idealRange = threshold.optimal.max - threshold.optimal.min;\n  const deviationPercent = (Math.abs(deviation) / idealRange) * 100;\n\n  let direction: 'low' | 'high' | 'optimal';\n  if (value >= threshold.optimal.min && value <= threshold.optimal.max) {\n    direction = 'optimal';\n  } else if (value < threshold.optimal.min) {\n    direction = 'low';\n  } else {\n    direction = 'high';\n  }\n\n  return { deviation, deviationPercent, direction };\n}\n\n/**\n * Get the issue name for a metric deviation\n */\nexport function getIssueForMetric(\n  metric: string,\n  direction: 'low' | 'high' | 'optimal'\n): string | null {\n  if (direction === 'optimal') return null;\n\n  const mapping = METRIC_ISSUE_MAPPINGS.find(m => m.metric === metric);\n  if (!mapping) return null;\n\n  return direction === 'low' ? mapping.lowIssue : mapping.highIssue;\n}\n\n/**\n * Get treatment IDs for a metric deviation\n */\nexport function getTreatmentIdsForMetric(\n  metric: string,\n  direction: 'low' | 'high' | 'optimal'\n): string[] {\n  if (direction === 'optimal') return [];\n\n  const mapping = METRIC_ISSUE_MAPPINGS.find(m => m.metric === metric);\n  if (!mapping) return [];\n\n  return direction === 'low' ? mapping.lowTreatments : mapping.highTreatments;\n}\n\n/**\n * Get overall severity from multiple metric analyses\n */\nexport function getOverallSeverity(severities: Severity[]): SeverityResult {\n  const severeCount = severities.filter(s => s === 'severe').length;\n  const moderateCount = severities.filter(s => s === 'moderate').length;\n  const mildCount = severities.filter(s => s === 'mild').length;\n\n  // Weighted scoring\n  const score = (\n    (severities.filter(s => s === 'optimal').length * 100) +\n    (mildCount * 75) +\n    (moderateCount * 50) +\n    (severeCount * 25)\n  ) / severities.length;\n\n  return classifyByScore(score);\n}\n\n/**\n * Prioritize metrics by severity and impact\n */\nexport function prioritizeMetrics(\n  metricSeverities: Array<{ metric: string; severity: Severity; impact: number }>\n): Array<{ metric: string; severity: Severity; priority: 'high' | 'medium' | 'low' }> {\n  const severityWeight: Record<Severity, number> = {\n    severe: 4,\n    moderate: 3,\n    mild: 2,\n    optimal: 1,\n  };\n\n  return metricSeverities\n    .map(m => ({\n      ...m,\n      score: severityWeight[m.severity] * m.impact,\n    }))\n    .sort((a, b) => b.score - a.score)\n    .map((m, index) => ({\n      metric: m.metric,\n      severity: m.severity,\n      priority: index < 3 ? 'high' as const :\n                index < 7 ? 'medium' as const :\n                'low' as const,\n    }));\n}\n\n// ============================================\n// PSL RATING CONVERSION\n// ============================================\n\n/**\n * Convert harmony score to PSL rating\n */\nexport function harmonyToPSL(harmonyPercent: number): {\n  psl: number;\n  tier: string;\n  percentile: number;\n  description: string;\n} {\n  // Based on FaceIQ formula: Harmony % = ((Score - Min) / (Max - Min)) * 100\n  // Where Max = 333.71, Min = -337.71\n\n  // Convert harmony percent to approximate PSL\n  // Harmony 0% = PSL 3.0, Harmony 100% = PSL 7.5\n  const psl = 3.0 + (harmonyPercent / 100) * 4.5;\n  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n\n  // Determine tier\n  let tier: string;\n  let percentile: number;\n  let description: string;\n\n  if (clampedPSL >= 7.5) {\n    tier = 'Top Model';\n    percentile = 99.99;\n    description = 'Near perfection - world-class genetics';\n  } else if (clampedPSL >= 7.0) {\n    tier = 'Chad';\n    percentile = 99.87;\n    description = 'Exceptional - top 0.1%';\n  } else if (clampedPSL >= 6.5) {\n    tier = 'Chadlite';\n    percentile = 99.0;\n    description = 'Very attractive - top 1%';\n  } else if (clampedPSL >= 6.0) {\n    tier = 'High Tier Normie+';\n    percentile = 97.25;\n    description = 'Notably attractive - top 3%';\n  } else if (clampedPSL >= 5.5) {\n    tier = 'High Tier Normie';\n    percentile = 90.0;\n    description = 'Above average - top 10%';\n  } else if (clampedPSL >= 5.0) {\n    tier = 'Mid Tier Normie+';\n    percentile = 84.15;\n    description = 'Slightly above average';\n  } else if (clampedPSL >= 4.5) {\n    tier = 'Mid Tier Normie';\n    percentile = 65.0;\n    description = 'Average';\n  } else if (clampedPSL >= 4.0) {\n    tier = 'Low Tier Normie';\n    percentile = 50.0;\n    description = 'Median';\n  } else if (clampedPSL >= 3.5) {\n    tier = 'Below Average';\n    percentile = 30.0;\n    description = 'Below average';\n  } else {\n    tier = 'Subpar';\n    percentile = 15.0;\n    description = 'Noticeably below average';\n  }\n\n  return {\n    psl: Math.round(clampedPSL * 10) / 10,\n    tier,\n    percentile,\n    description,\n  };\n}\n\n/**\n * Estimate potential PSL improvement from treatments\n */\nexport function estimatePotentialPSL(\n  currentPSL: number,\n  treatmentImprovements: number[]\n): { potentialPSL: number; totalImprovement: number } {\n  // Sum improvements with diminishing returns\n  const sortedImprovements = treatmentImprovements.sort((a, b) => b - a);\n\n  let totalImprovement = 0;\n  sortedImprovements.forEach((improvement, index) => {\n    // Each subsequent improvement is reduced by 20%\n    const diminishingFactor = Math.pow(0.8, index);\n    totalImprovement += improvement * diminishingFactor;\n  });\n\n  // Cap total improvement at realistic level\n  const cappedImprovement = Math.min(totalImprovement, 2.5);\n  const potentialPSL = Math.min(7.5, currentPSL + cappedImprovement);\n\n  return {\n    potentialPSL: Math.round(potentialPSL * 10) / 10,\n    totalImprovement: Math.round(cappedImprovement * 10) / 10,\n  };\n}\n","numLines":653,"startLine":1,"totalLines":653}}}
{"parentUuid":"6f052752-bd60-444f-9334-5a4395001c7b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JnWZ2MYLugfyonCdBSxgBp","type":"message","role":"assistant","content":[{"type":"text","text":"Let me also check for the Recommendation type definition to see what fields it has:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":18065,"cache_read_input_tokens":61996,"cache_creation":{"ephemeral_5m_input_tokens":18065,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWS8ZQW4XocavvfUPhi7B","type":"assistant","uuid":"e25a5b76-36f9-43be-a38d-d5bd7ea08988","timestamp":"2025-12-24T20:19:16.810Z"}
{"parentUuid":"e25a5b76-36f9-43be-a38d-d5bd7ea08988","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JnWZ2MYLugfyonCdBSxgBp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ai7G9aCA2hsMBfUN5r1pPc","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":18065,"cache_read_input_tokens":61996,"cache_creation":{"ephemeral_5m_input_tokens":18065,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWS8ZQW4XocavvfUPhi7B","type":"assistant","uuid":"9307d4b8-1041-4ef1-a95e-245d8ffc28d1","timestamp":"2025-12-24T20:19:17.369Z"}
{"parentUuid":"9307d4b8-1041-4ef1-a95e-245d8ffc28d1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ai7G9aCA2hsMBfUN5r1pPc","type":"tool_result","content":"     1→/**\n     2→ * FaceIQ-Style Results Page Types\n     3→ * Complete type definitions for the results UI\n     4→ */\n     5→\n     6→import { QualityTier, SeverityLevel, MeasurementUnit } from '@/lib/faceiq-scoring';\n     7→\n     8→// ============================================\n     9→// ILLUSTRATION TYPES\n    10→// ============================================\n    11→\n    12→export interface IllustrationPoint {\n    13→  type: 'landmark' | 'calculated';\n    14→  landmarkId?: string;\n    15→  x?: number;\n    16→  y?: number;\n    17→  label?: string;\n    18→}\n    19→\n    20→export interface IllustrationLine {\n    21→  from: string;\n    22→  to: string;\n    23→  color: string;\n    24→  style?: 'solid' | 'dashed';\n    25→  label?: string;\n    26→  labelColor?: string;\n    27→  labelPosition?: 'start' | 'middle' | 'end';\n    28→}\n    29→\n    30→export interface RatioIllustration {\n    31→  points: Record<string, IllustrationPoint>;\n    32→  lines: Record<string, IllustrationLine>;\n    33→}\n    34→\n    35→// ============================================\n    36→// RATIO/MEASUREMENT TYPES\n    37→// ============================================\n    38→\n    39→export interface Ratio {\n    40→  id: string;\n    41→  name: string;\n    42→  value: number;\n    43→  score: number;  // 0-10 scale\n    44→  standardizedScore: number;\n    45→  unit: 'x' | 'mm' | '%' | '°';\n    46→  idealMin: number;\n    47→  idealMax: number;\n    48→  rangeMin: number;\n    49→  rangeMax: number;\n    50→  description: string;\n    51→  category: string;\n    52→  qualityLevel: QualityTier;\n    53→  severity: SeverityLevel;\n    54→  illustration: RatioIllustration;\n    55→  mayIndicateFlaws: string[];\n    56→  mayIndicateStrengths: string[];\n    57→  usedLandmarks: string[];\n    58→  scoringCurveConfig?: {\n    59→    decayRate: number;\n    60→    maxScore: number;\n    61→  };\n    62→  // FaceIQ Taxonomy classification\n    63→  taxonomyPrimary?: string;    // 'harmony' | 'dimorphism' | 'angularity' | 'features'\n    64→  taxonomySecondary?: string;  // Subcategory ID\n    65→}\n    66→\n    67→// ============================================\n    68→// STRENGTH/FLAW TYPES\n    69→// ============================================\n    70→\n    71→export interface ResponsibleRatio {\n    72→  ratioName: string;\n    73→  ratioId: string;\n    74→  score: number;\n    75→  value: number;\n    76→  isObfuscated?: boolean;\n    77→  // Additional properties for AI descriptions\n    78→  idealMin: number;\n    79→  idealMax: number;\n    80→  unit: string;\n    81→  category?: string;\n    82→}\n    83→\n    84→export interface Strength {\n    85→  id: string;\n    86→  strengthName: string;\n    87→  summary: string;\n    88→  avgScore: number;\n    89→  qualityLevel: QualityTier;\n    90→  categoryName: string;\n    91→  responsibleRatios: ResponsibleRatio[];\n    92→}\n    93→\n    94→export interface Flaw {\n    95→  id: string;\n    96→  flawName: string;\n    97→  summary: string;\n    98→  harmonyPercentageLost: number;\n    99→  standardizedImpact: number;\n   100→  categoryName: string;\n   101→  isOther?: boolean;\n   102→  responsibleRatios: ResponsibleRatio[];\n   103→  rollingPointsDeducted?: number;\n   104→  rollingHarmonyPercentageLost?: number;\n   105→  rollingStandardizedImpact?: number;\n   106→}\n   107→\n   108→// ============================================\n   109→// RECOMMENDATION TYPES\n   110→// ============================================\n   111→\n   112→export type RecommendationPhase = 'Surgical' | 'Minimally Invasive' | 'Foundational';\n   113→\n   114→export interface RecommendationTimeline {\n   115→  effect_start: 'immediate' | 'delayed' | 'gradual';\n   116→  full_results_weeks: number;\n   117→  full_results_weeks_max?: number;\n   118→}\n   119→\n   120→export interface RecommendationCost {\n   121→  type: 'flat' | 'per_month' | 'per_session';\n   122→  min: number;\n   123→  max: number;\n   124→  currency: string;\n   125→}\n   126→\n   127→export interface RatioImpact {\n   128→  ratioId: string;\n   129→  ratioName: string;\n   130→  direction: 'increase' | 'decrease' | 'both';\n   131→  percentageEffect: number;\n   132→}\n   133→\n   134→export interface Recommendation {\n   135→  ref_id: string;\n   136→  name: string;\n   137→  description: string;\n   138→  phase: RecommendationPhase;\n   139→  impact: number;  // 0-1 effectiveness score\n   140→  coverage: number;  // Number of metrics improved\n   141→  percentage: string;  // e.g., \"10-20%\"\n   142→  expectedImprovementRange?: { min: number; max: number };\n   143→  matchedFlaws: string[];\n   144→  matchedRatios: string[];\n   145→  ratios_impacted: RatioImpact[];\n   146→  timeline: RecommendationTimeline;\n   147→  cost: RecommendationCost;\n   148→  risks_side_effects: string | null;\n   149→  warnings: string[];\n   150→  gender: 'male' | 'female' | 'both';\n   151→}\n   152→\n   153→// ============================================\n   154→// HARMONY ANALYSIS TYPES\n   155→// ============================================\n   156→\n   157→export interface ProfileAnalysis {\n   158→  standardizedScore: number;\n   159→  ratios: Ratio[];\n   160→  overallAIDescription?: string | null;\n   161→}\n   162→\n   163→export interface FullHarmonyAnalysis {\n   164→  standardizedScore: number;\n   165→  front: ProfileAnalysis;\n   166→  side: ProfileAnalysis;\n   167→  strengths: Strength[];\n   168→  flaws: Flaw[];\n   169→}\n   170→\n   171→// ============================================\n   172→// FACE DATA TYPES\n   173→// ============================================\n   174→\n   175→export interface FaceData {\n   176→  id: string;\n   177→  userId?: string;\n   178→  frontPhotoUrl: string;\n   179→  sidePhotoUrl?: string;\n   180→  harmonyScore: number | null;\n   181→  frontHarmonyScore: number | null;\n   182→  sideHarmonyScore: number | null;\n   183→  gender: 'male' | 'female';\n   184→  race?: string;\n   185→  unlocked: boolean;\n   186→  actionPlanUnlocked: boolean;\n   187→  harmonyAnalysis: FullHarmonyAnalysis;\n   188→}\n   189→\n   190→// ============================================\n   191→// UI STATE TYPES\n   192→// ============================================\n   193→\n   194→export type ResultsTab =\n   195→  | 'overview'\n   196→  | 'front-ratios'\n   197→  | 'side-ratios'\n   198→  | 'leaderboard'\n   199→  | 'plan'\n   200→  | 'options'\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"893804a6-1c12-4c90-865b-0b8e5f943302","timestamp":"2025-12-24T20:19:17.469Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","content":"/**\n * FaceIQ-Style Results Page Types\n * Complete type definitions for the results UI\n */\n\nimport { QualityTier, SeverityLevel, MeasurementUnit } from '@/lib/faceiq-scoring';\n\n// ============================================\n// ILLUSTRATION TYPES\n// ============================================\n\nexport interface IllustrationPoint {\n  type: 'landmark' | 'calculated';\n  landmarkId?: string;\n  x?: number;\n  y?: number;\n  label?: string;\n}\n\nexport interface IllustrationLine {\n  from: string;\n  to: string;\n  color: string;\n  style?: 'solid' | 'dashed';\n  label?: string;\n  labelColor?: string;\n  labelPosition?: 'start' | 'middle' | 'end';\n}\n\nexport interface RatioIllustration {\n  points: Record<string, IllustrationPoint>;\n  lines: Record<string, IllustrationLine>;\n}\n\n// ============================================\n// RATIO/MEASUREMENT TYPES\n// ============================================\n\nexport interface Ratio {\n  id: string;\n  name: string;\n  value: number;\n  score: number;  // 0-10 scale\n  standardizedScore: number;\n  unit: 'x' | 'mm' | '%' | '°';\n  idealMin: number;\n  idealMax: number;\n  rangeMin: number;\n  rangeMax: number;\n  description: string;\n  category: string;\n  qualityLevel: QualityTier;\n  severity: SeverityLevel;\n  illustration: RatioIllustration;\n  mayIndicateFlaws: string[];\n  mayIndicateStrengths: string[];\n  usedLandmarks: string[];\n  scoringCurveConfig?: {\n    decayRate: number;\n    maxScore: number;\n  };\n  // FaceIQ Taxonomy classification\n  taxonomyPrimary?: string;    // 'harmony' | 'dimorphism' | 'angularity' | 'features'\n  taxonomySecondary?: string;  // Subcategory ID\n}\n\n// ============================================\n// STRENGTH/FLAW TYPES\n// ============================================\n\nexport interface ResponsibleRatio {\n  ratioName: string;\n  ratioId: string;\n  score: number;\n  value: number;\n  isObfuscated?: boolean;\n  // Additional properties for AI descriptions\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category?: string;\n}\n\nexport interface Strength {\n  id: string;\n  strengthName: string;\n  summary: string;\n  avgScore: number;\n  qualityLevel: QualityTier;\n  categoryName: string;\n  responsibleRatios: ResponsibleRatio[];\n}\n\nexport interface Flaw {\n  id: string;\n  flawName: string;\n  summary: string;\n  harmonyPercentageLost: number;\n  standardizedImpact: number;\n  categoryName: string;\n  isOther?: boolean;\n  responsibleRatios: ResponsibleRatio[];\n  rollingPointsDeducted?: number;\n  rollingHarmonyPercentageLost?: number;\n  rollingStandardizedImpact?: number;\n}\n\n// ============================================\n// RECOMMENDATION TYPES\n// ============================================\n\nexport type RecommendationPhase = 'Surgical' | 'Minimally Invasive' | 'Foundational';\n\nexport interface RecommendationTimeline {\n  effect_start: 'immediate' | 'delayed' | 'gradual';\n  full_results_weeks: number;\n  full_results_weeks_max?: number;\n}\n\nexport interface RecommendationCost {\n  type: 'flat' | 'per_month' | 'per_session';\n  min: number;\n  max: number;\n  currency: string;\n}\n\nexport interface RatioImpact {\n  ratioId: string;\n  ratioName: string;\n  direction: 'increase' | 'decrease' | 'both';\n  percentageEffect: number;\n}\n\nexport interface Recommendation {\n  ref_id: string;\n  name: string;\n  description: string;\n  phase: RecommendationPhase;\n  impact: number;  // 0-1 effectiveness score\n  coverage: number;  // Number of metrics improved\n  percentage: string;  // e.g., \"10-20%\"\n  expectedImprovementRange?: { min: number; max: number };\n  matchedFlaws: string[];\n  matchedRatios: string[];\n  ratios_impacted: RatioImpact[];\n  timeline: RecommendationTimeline;\n  cost: RecommendationCost;\n  risks_side_effects: string | null;\n  warnings: string[];\n  gender: 'male' | 'female' | 'both';\n}\n\n// ============================================\n// HARMONY ANALYSIS TYPES\n// ============================================\n\nexport interface ProfileAnalysis {\n  standardizedScore: number;\n  ratios: Ratio[];\n  overallAIDescription?: string | null;\n}\n\nexport interface FullHarmonyAnalysis {\n  standardizedScore: number;\n  front: ProfileAnalysis;\n  side: ProfileAnalysis;\n  strengths: Strength[];\n  flaws: Flaw[];\n}\n\n// ============================================\n// FACE DATA TYPES\n// ============================================\n\nexport interface FaceData {\n  id: string;\n  userId?: string;\n  frontPhotoUrl: string;\n  sidePhotoUrl?: string;\n  harmonyScore: number | null;\n  frontHarmonyScore: number | null;\n  sideHarmonyScore: number | null;\n  gender: 'male' | 'female';\n  race?: string;\n  unlocked: boolean;\n  actionPlanUnlocked: boolean;\n  harmonyAnalysis: FullHarmonyAnalysis;\n}\n\n// ============================================\n// UI STATE TYPES\n// ============================================\n\nexport type ResultsTab =\n  | 'overview'\n  | 'front-ratios'\n  | 'side-ratios'\n  | 'leaderboard'\n  | 'plan'\n  | 'options'","numLines":200,"startLine":1,"totalLines":340}}}
{"parentUuid":"893804a6-1c12-4c90-865b-0b8e5f943302","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"03d3848a-b19a-42b9-aac5-a566436b5df6","version":"2.0.76","gitBranch":"main","agentId":"ae4057f","slug":"stateful-churning-stearns","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Mk28mbJ4e9VtpvFSxN3aka","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! I have all the information I need. Let me compile a comprehensive report on what's been implemented.\n\n## LOOKSMAXX Treatment/Advice Features Implementation Report\n\nBased on my thorough exploration of the codebase, here's what I found regarding the treatment metadata and features from changes.md:\n\n---\n\n### 1. TREATMENT METADATA - FULLY IMPLEMENTED ✅\n\n**File: `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts` (lines 36-50, 70-902)**\n\nAll treatment metadata fields are comprehensively implemented:\n\n| Field | Status | Details |\n|-------|--------|---------|\n| **priority_score** | ✅ | Lines 46, 92, 122, 152, 208, 238, 269, 300, etc. Values 1-5 (higher = more important) |\n| **effectiveness** | ✅ | Lines 47, 93, 123, 153, 209, 239, 270, 301, etc. Object with: `level` (high/medium/low), `score` (1-5), `confidence` (0-1) |\n| **ratios_impacted** | ✅ | Lines 48, 94-98, 124-128, 154-156, etc. Maps metric names to impact objects with `direction` (increase/decrease) and `percentage` |\n| **pillars** | ✅ | Lines 49, 99, 129, 158, etc. Array of aesthetic pillars (e.g., 'angularity', 'harmony', 'masculinity') |\n| **recovery_weeks** | ⚠️ | Implicit via `time_min`/`time_max` fields (lines 40-41) |\n| **duration_months** | ⚠️ | Represented as `time_max` fields |\n| **cost_range** | ✅ | Lines 38-39: `cost_min` and `cost_max` for all 30+ procedures |\n| **risk_level** | ✅ | Lines 42: `risks` field describing risks |\n\n**Example - Jaw Fillers (lines 71-101):**\n```typescript\n{\n  priority_score: 4,                          // 1-5 scale\n  effectiveness: { level: 'high', score: 4, confidence: 0.85 },\n  ratios_impacted: {\n    \"Gonial Angle\": { direction: \"decrease\", percentage: 3 },\n    \"Bigonial Width\": { direction: \"increase\", percentage: 4 },\n    \"Ramus to Mandible Ratio\": { direction: \"increase\", percentage: 2 }\n  },\n  pillars: [\"angularity\", \"masculinity\", \"bone_structure\"]\n}\n```\n\n---\n\n### 2. IMPACT TABLES - FULLY IMPLEMENTED ✅\n\n**File: `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/advice-engine.ts`**\n\nAll 30 procedures have quantitative metric→procedure mappings with percentage changes:\n\n| Procedure | Metrics Affected | Examples |\n|-----------|-----------------|----------|\n| **Jaw Fillers** (lines 94-98) | 3 metrics | Gonial Angle -3%, Bigonial Width +4%, Ramus Ratio +2% |\n| **Cheekbone Fillers** (lines 124-128) | 3 metrics | Cheekbone Height +4%, FWHR +2%, Midface Ratio -2% |\n| **Lip Filler** (lines 182-184) | 1 metric | Lower Lip Ratio +15% |\n| **Fat Loss Protocol** (lines 210-214) | 3 metrics | Cheekbone Height +8%, Jaw Slope -5%, Bigonial Width +3% |\n| **Rhinoplasty** (lines 271-276) | 4 metrics | Nasal Projection -10%, W/H Ratio -8%, Nasolabial Angle +12%, Nasal Index -6% |\n| **Genioplasty** (lines 302-306) | 3 metrics | Chin/Philtrum +20%, Recession -15%, Convexity +5% |\n\n...continuing through all 30 procedures (Canthoplasty, Brow Lift, Kybella, Neck Lift, Jaw Implants, V-Line Surgery, etc.)\n\n---\n\n### 3. PLANTAB UI - COMPREHENSIVELY IMPLEMENTED ✅\n\n**File: `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx`**\n\n#### Priority Ordering (lines 126-164):\n- **OrderOfOperations component** displays 3-phase recommended order:\n  1. Foundational (low-cost, free, no-risk) - Step 1\n  2. Minimally Invasive (temporary, reversible) - Step 2\n  3. Surgical (permanent, significant impact) - Step 3\n\n#### Effectiveness Ratings (lines 23-76):\n- **PotentialScoreCard** displays:\n  - Current harmony score\n  - Potential improvement calculation (line 30): `Math.min(totalImpact * 1.5, 10 - overallScore)`\n  - Projected potential score (line 33)\n  - Visual progression with arrow and +X improvement badge\n\n#### Cumulative Improvement Calculation (lines 27-31):\n```typescript\nconst potentialImprovement = useMemo(() => {\n  if (recommendations.length === 0) return 0;\n  const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);\n  return Math.min(totalImpact * 1.5, 10 - overallScore);\n}, [recommendations, overallScore]);\n```\n\n#### Phase Filtering (lines 83-120):\n- Filter by phase: All, Foundational, Minimally Invasive, Surgical\n- Shows count per phase\n\n#### Recommendation Cards (line 259-271):\n- Displays each recommendation with rank\n- Shows phase badge and impact score\n- Can expand for full details\n\n---\n\n### 4. OUTCOME PREDICTIONS - PARTIALLY IMPLEMENTED ✅⚠️\n\n#### Before/After Visualizations:\n\n**File: `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx`**\n\n- **Current State**: Shows landmark visualization overlays on front/side photos with:\n  - Point markers with pulsing glow effects (lines 514-560)\n  - Line measurements between landmarks (lines 388-464)\n  - Angle visualizations with arc paths (lines 466-512)\n  - Zoom controls for detailed inspection (lines 276-290)\n\n- **Not Implemented**: True before/after slider overlays or predicted post-treatment facial images\n\n#### Predicted Metric Values:\n\n**File: `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/severity.ts` (lines 627-652)**\n\n`estimatePotentialPSL()` function calculates predicted improvements:\n```typescript\nexport function estimatePotentialPSL(\n  currentPSL: number,\n  treatmentImprovements: number[]\n): { potentialPSL: number; totalImprovement: number } {\n  // Sum improvements with diminishing returns\n  const sortedImprovements = treatmentImprovements.sort((a, b) => b - a);\n  let totalImprovement = 0;\n  sortedImprovements.forEach((improvement, index) => {\n    const diminishingFactor = Math.pow(0.8, index);  // 20% reduction per additional treatment\n    totalImprovement += improvement * diminishingFactor;\n  });\n  // Cap at realistic level\n  const cappedImprovement = Math.min(totalImprovement, 2.5);\n  const potentialPSL = Math.min(7.5, currentPSL + cappedImprovement);\n}\n```\n\n**File: `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/engine.ts` (lines 295-346)**\n\nIntegration in `generateRecommendationPlan()`:\n- Line 342-345: Calculates `potentialPSL` and `potentialImprovement`\n- Lines 368-369: Returns both `currentPSL` and `potentialPSL` in recommendation plan\n- Line 345: Uses `estimatePotentialPSL()` with array of individual treatment improvements\n\n---\n\n### 5. ENHANCED RECOMMENDATION CARD UI - FULLY IMPLEMENTED ✅\n\n**File: `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx`**\n\nComprehensive expandable recommendation card with:\n\n#### Metadata Display (lines 574-630):\n- Treatment name and description\n- Phase badge (color-coded)\n- Impact score with direction indicators\n- Cost range with timeline\n- Expand/collapse with animation\n\n#### Detailed Sections (lines 671-823):\n1. **Improvements** (lines 673-692): Shows matched flaws and effectiveness rating\n2. **How It Helps** (lines 694-712): Description + metrics it impacts\n3. **Logistics & Timeline** (lines 714-737): Effect start time, full results timeline\n4. **Considerations** (lines 739-765): Prerequisites, risks, side effects\n5. **Research & Evidence** (lines 774-823): Gender/ethnicity-specific citations (15+ research papers)\n6. **My Tracker** (lines 827-833): Personal notes and progress checklist\n\n#### Research Citations Engine (lines 225-291):\nIntelligent citation matching with relevance scoring based on:\n- Procedure specificity\n- Gender relevance\n- Ethnicity-specific research\n- Recency bonus\n\n---\n\n### Summary Table\n\n| Feature | Implementation | File Location | Notes |\n|---------|----------------|---------------|-------|\n| Treatment Metadata | ✅ Complete | `advice-engine.ts:36-902` | All fields present in 30+ procedures |\n| Impact Tables | ✅ Complete | `advice-engine.ts:94-661` | Quantitative % changes for all procedures |\n| PlanTab UI | ✅ Complete | `PlanTab.tsx` | Priority, effectiveness, cumulative calculations |\n| Outcome Predictions (PSL) | ✅ Complete | `severity.ts:627-652` | Diminishing returns model implemented |\n| Before/After Overlays | ⚠️ Partial | `FaceOverlay.tsx` | Visualization engine exists, true before/after not implemented |\n| Enhanced Cards | ✅ Complete | `EnhancedRecommendationCard.tsx` | Rich UI with tracking and research |\n\n---\n\n### Gaps\n\n1. **Visual Before/After Comparison**: No predicted morphing or facial feature changes visualization\n2. **Recovery Timeline Details**: Uses `time_min`/`time_max` but lacks explicit `recovery_weeks` field\n3. **Individual Metric Predictions**: Shows cumulative PSL improvement but not per-metric predictions"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2506,"cache_read_input_tokens":80061,"cache_creation":{"ephemeral_5m_input_tokens":2506,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWS8ZaaHxLLxA3yZ5u9VG","type":"assistant","uuid":"2b3469ef-4cd1-43ae-bcbb-08755a6a34de","timestamp":"2025-12-24T20:19:43.198Z"}
