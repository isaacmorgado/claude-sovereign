     1→"""
     2→Forum database models - Issue Categories, Sub-Forums, Posts, Comments, Votes, Reports, Flaw Mappings
     3→"""
     4→
     5→import uuid
     6→import enum
     7→from datetime import datetime
     8→from sqlalchemy import (
     9→    Column, String, DateTime, ForeignKey, Text, Integer, Boolean, Enum, Index
    10→)
    11→from sqlalchemy.dialects.postgresql import UUID
    12→from sqlalchemy.orm import relationship
    13→
    14→from app.database import Base
    15→
    16→
    17→class VoteType(str, enum.Enum):
    18→    UP = "up"
    19→    DOWN = "down"
    20→
    21→
    22→class TargetType(str, enum.Enum):
    23→    POST = "post"
    24→    COMMENT = "comment"
    25→
    26→
    27→class ReportStatus(str, enum.Enum):
    28→    PENDING = "pending"
    29→    REVIEWED = "reviewed"
    30→    RESOLVED = "resolved"
    31→    DISMISSED = "dismissed"
    32→
    33→
    34→class ReportReason(str, enum.Enum):
    35→    SPAM = "spam"
    36→    HARASSMENT = "harassment"
    37→    MISINFORMATION = "misinformation"
    38→    OFF_TOPIC = "off_topic"
    39→    INAPPROPRIATE = "inappropriate"
    40→    OTHER = "other"
    41→
    42→
    43→# ============== ISSUE CATEGORIES (12 main categories) ==============
    44→
    45→class ForumIssueCategory(Base):
    46→    """Main issue categories (e.g., 'Weak Bone Structure', 'Poor Skin Complexion')"""
    47→    __tablename__ = "forum_issue_categories"
    48→
    49→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    50→    name = Column(String(100), nullable=False, unique=True)
    51→    slug = Column(String(50), nullable=False, unique=True, index=True)
    52→    description = Column(Text, nullable=True)
    53→    icon = Column(String(10), nullable=True)  # Emoji icon
    54→    display_order = Column(Integer, default=0)
    55→    is_active = Column(Boolean, default=True)
    56→    created_at = Column(DateTime, default=datetime.utcnow)
    57→
    58→    # Relationships
    59→    sub_forums = relationship("ForumSubForum", back_populates="issue_category", cascade="all, delete-orphan")
    60→    flaw_mappings = relationship("FlawToForumMapping", back_populates="issue_category", cascade="all, delete-orphan")
    61→
    62→    def __repr__(self):
    63→        return f"<ForumIssueCategory {self.slug}>"
    64→
    65→
    66→# ============== SUB-FORUMS (44 sub-forums under categories) ==============
    67→
    68→class ForumSubForum(Base):
    69→    """Sub-forums under each issue category (e.g., 'Jawline', 'Nutrition')"""
    70→    __tablename__ = "forum_sub_forums"
    71→
    72→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    73→    issue_category_id = Column(UUID(as_uuid=True), ForeignKey("forum_issue_categories.id", ondelete="CASCADE"), nullable=False)
    74→    name = Column(String(100), nullable=False)
    75→    slug = Column(String(50), nullable=False)
    76→    description = Column(Text, nullable=True)
    77→    icon = Column(String(10), nullable=True)
    78→    display_order = Column(Integer, default=0)
    79→    is_active = Column(Boolean, default=True)
    80→    created_at = Column(DateTime, default=datetime.utcnow)
    81→
    82→    # Relationships
    83→    issue_category = relationship("ForumIssueCategory", back_populates="sub_forums")
    84→    posts = relationship("ForumPost", back_populates="sub_forum", cascade="all, delete-orphan")
    85→
    86→    __table_args__ = (
    87→        Index('idx_subforum_category', 'issue_category_id', 'slug', unique=True),
    88→    )
    89→
    90→    def __repr__(self):
    91→        return f"<ForumSubForum {self.slug}>"
    92→
    93→
    94→# ============== FLAW TO FORUM MAPPING ==============
    95→
    96→class FlawToForumMapping(Base):
    97→    """Maps detected analysis flaws to recommended forum categories"""
    98→    __tablename__ = "flaw_to_forum_mapping"
    99→
   100→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   101→    flaw_id = Column(String(100), nullable=False, index=True)  # e.g., "weak_jaw", "negative_canthal_tilt"
   102→    issue_category_id = Column(UUID(as_uuid=True), ForeignKey("forum_issue_categories.id", ondelete="CASCADE"), nullable=False)
   103→    priority = Column(Integer, default=1)  # 1 = primary, 2 = secondary recommendation
   104→    created_at = Column(DateTime, default=datetime.utcnow)
   105→
   106→    # Relationships
   107→    issue_category = relationship("ForumIssueCategory", back_populates="flaw_mappings")
   108→
   109→    __table_args__ = (
   110→        Index('idx_flaw_mapping', 'flaw_id', 'issue_category_id', unique=True),
   111→    )
   112→
   113→    def __repr__(self):
   114→        return f"<FlawToForumMapping {self.flaw_id} -> {self.issue_category_id}>"
   115→
   116→
   117→class ArchetypeForumMapping(Base):
   118→    """Maps user archetypes to recommended forum categories"""
   119→    __tablename__ = "archetype_forum_mappings"
   120→
   121→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   122→    archetype_category = Column(String(50), nullable=False, index=True)  # "Softboy", "Chad", etc.
   123→    issue_category_id = Column(UUID(as_uuid=True), ForeignKey("forum_issue_categories.id", ondelete="CASCADE"), nullable=False)
   124→    priority = Column(Integer, default=0)  # Higher = more relevant
   125→    reason = Column(Text, nullable=True)  # Why this forum is recommended
   126→    created_at = Column(DateTime, default=datetime.utcnow)
   127→
   128→    # Relationships
   129→    issue_category = relationship("ForumIssueCategory", backref="archetype_mappings")
   130→
   131→    __table_args__ = (
   132→        Index('idx_archetype_mapping', 'archetype_category', 'issue_category_id', unique=True),
   133→    )
   134→
   135→    def __repr__(self):
   136→        return f"<ArchetypeForumMapping {self.archetype_category} -> {self.issue_category_id}>"
   137→
   138→
   139→# ============== POSTS (in sub-forums) ==============
   140→
   141→class ForumPost(Base):
   142→    __tablename__ = "forum_posts"
   143→
   144→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   145→    sub_forum_id = Column(UUID(as_uuid=True), ForeignKey("forum_sub_forums.id", ondelete="CASCADE"), nullable=False)
   146→    author_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
   147→    title = Column(String(200), nullable=False)
   148→    content = Column(Text, nullable=False)
   149→
   150→    # Status flags
   151→    is_pinned = Column(Boolean, default=False)
   152→    is_guide = Column(Boolean, default=False)  # Marks as "Guide" content
   153→    is_approved = Column(Boolean, default=True)  # For moderation workflow
   154→    is_deleted = Column(Boolean, default=False)
   155→
   156→    # Soft delete tracking
   157→    deleted_at = Column(DateTime(timezone=True), nullable=True)
   158→    deleted_by = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=True)
   159→
   160→    # Denormalized counts for performance
   161→    vote_count = Column(Integer, default=0)  # net score (ups - downs)
   162→    comment_count = Column(Integer, default=0)
   163→
   164→    # Timestamps
   165→    created_at = Column(DateTime, default=datetime.utcnow)
   166→    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
   167→
   168→    # Relationships
   169→    sub_forum = relationship("ForumSubForum", back_populates="posts")
   170→    author = relationship("User", backref="forum_posts")
   171→    comments = relationship("ForumComment", back_populates="post", cascade="all, delete-orphan")
   172→
   173→    # Indexes
   174→    __table_args__ = (
   175→        Index('idx_posts_subforum_pinned', 'sub_forum_id', 'is_pinned', 'created_at'),
   176→        Index('idx_posts_subforum_votes', 'sub_forum_id', 'vote_count'),
   177→        Index('idx_posts_author', 'author_id'),
   178→    )
   179→
   180→    def __repr__(self):
   181→        return f"<ForumPost {self.title[:30]}>"
   182→
   183→
   184→class ForumComment(Base):
   185→    __tablename__ = "forum_comments"
   186→
   187→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   188→    content = Column(Text, nullable=False)
   189→    post_id = Column(UUID(as_uuid=True), ForeignKey("forum_posts.id", ondelete="CASCADE"), nullable=False)
   190→    author_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
   191→    parent_id = Column(UUID(as_uuid=True), ForeignKey("forum_comments.id", ondelete="CASCADE"), nullable=True)  # For threading
   192→
   193→    # Status
   194→    is_approved = Column(Boolean, default=True)
   195→    is_deleted = Column(Boolean, default=False)
   196→
   197→    # Soft delete tracking
   198→    deleted_at = Column(DateTime(timezone=True), nullable=True)
   199→    deleted_by = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=True)
   200→
   201→    # Denormalized vote count
   202→    vote_count = Column(Integer, default=0)
   203→
   204→    # Depth for limiting nesting (max 5 levels)
   205→    depth = Column(Integer, default=0)
   206→
   207→    # Timestamps
   208→    created_at = Column(DateTime, default=datetime.utcnow)
   209→    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
   210→
   211→    # Relationships
   212→    post = relationship("ForumPost", back_populates="comments")
   213→    author = relationship("User", backref="forum_comments")
   214→    parent = relationship("ForumComment", remote_side=[id], backref="replies")
   215→
   216→    # Indexes
   217→    __table_args__ = (
   218→        Index('idx_comments_post', 'post_id', 'created_at'),
   219→        Index('idx_comments_parent', 'parent_id'),
   220→        Index('idx_comments_author', 'author_id'),
   221→    )
   222→
   223→    def __repr__(self):
   224→        return f"<ForumComment {self.id}>"
   225→
   226→
   227→class ForumVote(Base):
   228→    __tablename__ = "forum_votes"
   229→
   230→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   231→    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
   232→    target_type = Column(Enum(TargetType), nullable=False)
   233→    target_id = Column(UUID(as_uuid=True), nullable=False)
   234→    vote_type = Column(Enum(VoteType), nullable=False)
   235→    created_at = Column(DateTime, default=datetime.utcnow)
   236→
   237→    # Relationships
   238→    user = relationship("User", backref="forum_votes")
   239→
   240→    # Unique constraint: one vote per user per target
   241→    __table_args__ = (
   242→        Index('idx_votes_user_target', 'user_id', 'target_type', 'target_id', unique=True),
   243→        Index('idx_votes_target', 'target_type', 'target_id'),
   244→    )
   245→
   246→    def __repr__(self):
   247→        return f"<ForumVote {self.vote_type} on {self.target_type}:{self.target_id}>"
   248→
   249→
   250→class ForumReport(Base):
   251→    __tablename__ = "forum_reports"
   252→
   253→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   254→    reporter_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
   255→    target_type = Column(Enum(TargetType), nullable=False)
   256→    target_id = Column(UUID(as_uuid=True), nullable=False)
   257→    reason = Column(Enum(ReportReason), nullable=False)
   258→    details = Column(Text, nullable=True)  # Additional context
   259→    status = Column(Enum(ReportStatus), default=ReportStatus.PENDING)
   260→    reviewed_by = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
   261→    reviewed_at = Column(DateTime, nullable=True)
   262→    created_at = Column(DateTime, default=datetime.utcnow)
   263→
   264→    # Relationships
   265→    reporter = relationship("User", foreign_keys=[reporter_id], backref="reports_filed")
   266→    reviewer = relationship("User", foreign_keys=[reviewed_by], backref="reports_reviewed")
   267→
   268→    # Indexes
   269→    __table_args__ = (
   270→        Index('idx_reports_status', 'status', 'created_at'),
   271→        Index('idx_reports_target', 'target_type', 'target_id'),
   272→    )
   273→
   274→    def __repr__(self):
   275→        return f"<ForumReport {self.reason} on {self.target_type}:{self.target_id}>"
   276→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
