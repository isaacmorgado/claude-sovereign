     1→"""
     2→Forum schemas for request/response validation
     3→"""
     4→
     5→import bleach
     6→from pydantic import BaseModel, Field, field_validator
     7→from typing import Optional, List
     8→from datetime import datetime
     9→from uuid import UUID
    10→from enum import Enum
    11→
    12→
    13→def sanitize_html(value: str) -> str:
    14→    """Strip all HTML tags from input to prevent XSS attacks."""
    15→    if value is None:
    16→        return value
    17→    return bleach.clean(value, tags=[], strip=True)
    18→
    19→
    20→# === ENUMS ===
    21→
    22→class VoteType(str, Enum):
    23→    UP = "up"
    24→    DOWN = "down"
    25→
    26→
    27→class TargetType(str, Enum):
    28→    POST = "post"
    29→    COMMENT = "comment"
    30→
    31→
    32→class ReportReason(str, Enum):
    33→    SPAM = "spam"
    34→    HARASSMENT = "harassment"
    35→    MISINFORMATION = "misinformation"
    36→    OFF_TOPIC = "off_topic"
    37→    INAPPROPRIATE = "inappropriate"
    38→    OTHER = "other"
    39→
    40→
    41→class SortOrder(str, Enum):
    42→    HOT = "hot"  # vote_count DESC, recent bias
    43→    NEW = "new"  # created_at DESC
    44→    TOP = "top"  # vote_count DESC
    45→
    46→
    47→# === SUB-FORUM SCHEMAS ===
    48→
    49→class SubForumResponse(BaseModel):
    50→    id: UUID
    51→    name: str
    52→    slug: str
    53→    description: Optional[str]
    54→    icon: Optional[str]
    55→    display_order: int
    56→    post_count: int = 0
    57→
    58→    class Config:
    59→        from_attributes = True
    60→
    61→
    62→# === CATEGORY SCHEMAS ===
    63→
    64→class CategoryResponse(BaseModel):
    65→    id: UUID
    66→    name: str
    67→    slug: str
    68→    description: Optional[str]
    69→    icon: Optional[str]
    70→    display_order: int
    71→    post_count: int = 0
    72→    sub_forums: List[SubForumResponse] = []
    73→
    74→    class Config:
    75→        from_attributes = True
    76→
    77→
    78→class CategoryListResponse(BaseModel):
    79→    id: UUID
    80→    name: str
    81→    slug: str
    82→    description: Optional[str]
    83→    icon: Optional[str]
    84→    display_order: int
    85→    post_count: int = 0
    86→
    87→    class Config:
    88→        from_attributes = True
    89→
    90→
    91→# === POST SCHEMAS ===
    92→
    93→class PostCreate(BaseModel):
    94→    title: str = Field(..., min_length=5, max_length=200)
    95→    content: str = Field(..., min_length=10, max_length=10000)
    96→    sub_forum_id: UUID
    97→
    98→    @field_validator('title', 'content', mode='before')
    99→    @classmethod
   100→    def sanitize_text_fields(cls, v: str) -> str:
   101→        """Strip HTML tags to prevent XSS attacks."""
   102→        if isinstance(v, str):
   103→            return sanitize_html(v)
   104→        return v
   105→
   106→
   107→class PostUpdate(BaseModel):
   108→    title: Optional[str] = Field(None, min_length=5, max_length=200)
   109→    content: Optional[str] = Field(None, min_length=10, max_length=10000)
   110→
   111→    @field_validator('title', 'content', mode='before')
   112→    @classmethod
   113→    def sanitize_text_fields(cls, v: Optional[str]) -> Optional[str]:
   114→        """Strip HTML tags to prevent XSS attacks."""
   115→        if isinstance(v, str):
   116→            return sanitize_html(v)
   117→        return v
   118→
   119→
   120→class PostAuthor(BaseModel):
   121→    id: UUID
   122→    username: str
   123→
   124→    class Config:
   125→        from_attributes = True
   126→
   127→
   128→class PostResponse(BaseModel):
   129→    id: UUID
   130→    title: str
   131→    content: str
   132→    sub_forum_id: UUID
   133→    sub_forum_slug: str
   134→    category_slug: str
   135→    author: PostAuthor
   136→    is_pinned: bool
   137→    is_guide: bool
   138→    vote_count: int
   139→    comment_count: int
   140→    user_vote: Optional[VoteType] = None  # Current user's vote
   141→    created_at: datetime
   142→    updated_at: datetime
   143→
   144→    class Config:
   145→        from_attributes = True
   146→
   147→
   148→class PostListItem(BaseModel):
   149→    """Lighter version for list views"""
   150→    id: UUID
   151→    title: str
   152→    content_preview: str  # First 200 chars
   153→    sub_forum_slug: str
   154→    category_slug: str
   155→    author: PostAuthor
   156→    is_pinned: bool
   157→    is_guide: bool
   158→    vote_count: int
   159→    comment_count: int
   160→    user_vote: Optional[VoteType] = None
   161→    created_at: datetime
   162→
   163→    class Config:
   164→        from_attributes = True
   165→
   166→
   167→class PostListResponse(BaseModel):
   168→    posts: List[PostListItem]
   169→    total_count: int
   170→    has_more: bool
   171→
   172→
   173→# === COMMENT SCHEMAS ===
   174→
   175→class CommentCreate(BaseModel):
   176→    content: str = Field(..., min_length=1, max_length=5000)
   177→    parent_id: Optional[UUID] = None
   178→
   179→    @field_validator('content', mode='before')
   180→    @classmethod
   181→    def sanitize_content(cls, v: str) -> str:
   182→        """Strip HTML tags to prevent XSS attacks."""
   183→        if isinstance(v, str):
   184→            return sanitize_html(v)
   185→        return v
   186→
   187→
   188→class CommentUpdate(BaseModel):
   189→    content: str = Field(..., min_length=1, max_length=5000)
   190→
   191→    @field_validator('content', mode='before')
   192→    @classmethod
   193→    def sanitize_content(cls, v: str) -> str:
   194→        """Strip HTML tags to prevent XSS attacks."""
   195→        if isinstance(v, str):
   196→            return sanitize_html(v)
   197→        return v
   198→
   199→
   200→class CommentResponse(BaseModel):
   201→    id: UUID
   202→    content: str
   203→    post_id: UUID
   204→    author: PostAuthor
   205→    parent_id: Optional[UUID]
   206→    vote_count: int
   207→    user_vote: Optional[VoteType] = None
   208→    depth: int
   209→    replies: List["CommentResponse"] = []
   210→    created_at: datetime
   211→    updated_at: datetime
   212→
   213→    class Config:
   214→        from_attributes = True
   215→
   216→
   217→# Needed for self-referential model
   218→CommentResponse.model_rebuild()
   219→
   220→
   221→# === VOTE SCHEMAS ===
   222→
   223→class VoteRequest(BaseModel):
   224→    vote_type: VoteType
   225→
   226→
   227→class VoteResponse(BaseModel):
   228→    success: bool
   229→    new_vote_count: int
   230→    user_vote: Optional[VoteType]
   231→
   232→
   233→# === REPORT SCHEMAS ===
   234→
   235→class ReportCreate(BaseModel):
   236→    target_type: TargetType
   237→    target_id: UUID
   238→    reason: ReportReason
   239→    details: Optional[str] = Field(None, max_length=1000)
   240→
   241→    @field_validator('details', mode='before')
   242→    @classmethod
   243→    def sanitize_details(cls, v: Optional[str]) -> Optional[str]:
   244→        """Strip HTML tags to prevent XSS attacks."""
   245→        if isinstance(v, str):
   246→            return sanitize_html(v)
   247→        return v
   248→
   249→
   250→class ReportResponse(BaseModel):
   251→    id: UUID
   252→    target_type: TargetType
   253→    target_id: UUID
   254→    reason: ReportReason
   255→    status: str
   256→    created_at: datetime
   257→
   258→    class Config:
   259→        from_attributes = True
   260→
   261→
   262→# === GUIDE SECTION ===
   263→
   264→class GuideSectionResponse(BaseModel):
   265→    """Guides grouped by category for the top section"""
   266→    category: CategoryListResponse
   267→    guides: List[PostListItem]
   268→
   269→
   270→# === RECOMMENDED FORUMS ===
   271→
   272→class RecommendedForumResponse(BaseModel):
   273→    """Forums recommended based on user's detected flaws"""
   274→    category: CategoryListResponse
   275→    matched_flaws: List[str]  # Which flaws matched this category
   276→    priority: int  # 1 = primary, 2 = secondary
   277→
   278→
   279→class ArchetypeForumRecommendation(BaseModel):
   280→    """Forums recommended based on user's archetype"""
   281→    category: CategoryListResponse
   282→    archetype: str  # The archetype that triggered this recommendation
   283→    reason: Optional[str]  # Why this forum is relevant
   284→    priority: int  # Higher = more relevant
   285→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
