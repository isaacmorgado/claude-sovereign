     1→/**
     2→ * API Client for LOOKSMAXX Backend
     3→ *
     4→ * Handles all authenticated requests to the Railway-hosted API
     5→ */
     6→
     7→import type { UserRank, LeaderboardEntry, LeaderboardData, UserProfile } from '@/types/results';
     8→import type {
     9→  Category,
    10→  SubForum,
    11→  Post,
    12→  PostListItem,
    13→  PostListResponse,
    14→  PostCreate,
    15→  PostUpdate,
    16→  Comment,
    17→  CommentCreate,
    18→  VoteType,
    19→  VoteResponse,
    20→  ReportCreate,
    21→  Report,
    22→  GuideSection,
    23→  RecommendedForum,
    24→  SortOrder,
    25→  CategoryListItem,
    26→  PostAuthor,
    27→} from '@/types/forum';
    28→
    29→const API_URL = (process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000').trim();
    30→
    31→// API Response types (snake_case from backend)
    32→interface LeaderboardApiResponse {
    33→  user_id: string;
    34→  score: number;
    35→  global_rank: number;
    36→  gender_rank: number;
    37→  percentile: number;
    38→  total_users: number;
    39→  gender_total: number;
    40→  anonymous_name: string;
    41→  updated_at: string;
    42→}
    43→
    44→interface LeaderboardEntryResponse {
    45→  user_id: string;
    46→  rank: number;
    47→  score: number;
    48→  anonymous_name: string;
    49→  gender: 'male' | 'female';
    50→  face_photo_url: string | null;
    51→  is_current_user: boolean;
    52→  top_strengths: string[];
    53→  top_improvements: string[];
    54→}
    55→
    56→interface LeaderboardListResponse {
    57→  entries: LeaderboardEntryResponse[];
    58→  total_count: number;
    59→  user_rank: LeaderboardApiResponse | null;
    60→}
    61→
    62→interface UserProfileResponse {
    63→  user_id: string;
    64→  rank: number;
    65→  score: number;
    66→  anonymous_name: string;
    67→  gender: 'male' | 'female';
    68→  face_photo_url: string | null;
    69→  top_strengths: string[];
    70→  top_improvements: string[];
    71→}
    72→
    73→// Transform functions (snake_case -> camelCase)
    74→function transformUserRank(data: LeaderboardApiResponse): UserRank {
    75→  return {
    76→    userId: data.user_id,
    77→    score: data.score,
    78→    globalRank: data.global_rank,
    79→    genderRank: data.gender_rank,
    80→    percentile: data.percentile,
    81→    totalUsers: data.total_users,
    82→    genderTotal: data.gender_total,
    83→    anonymousName: data.anonymous_name,
    84→    updatedAt: data.updated_at,
    85→  };
    86→}
    87→
    88→function transformLeaderboardEntry(data: LeaderboardEntryResponse): LeaderboardEntry {
    89→  return {
    90→    userId: data.user_id,
    91→    rank: data.rank,
    92→    score: data.score,
    93→    anonymousName: data.anonymous_name,
    94→    gender: data.gender,
    95→    facePhotoUrl: data.face_photo_url,
    96→    isCurrentUser: data.is_current_user,
    97→    topStrengths: data.top_strengths || [],
    98→    topImprovements: data.top_improvements || [],
    99→  };
   100→}
   101→
   102→function transformLeaderboardData(data: LeaderboardListResponse): LeaderboardData {
   103→  return {
   104→    entries: data.entries.map(transformLeaderboardEntry),
   105→    totalCount: data.total_count,
   106→    userRank: data.user_rank ? transformUserRank(data.user_rank) : null,
   107→  };
   108→}
   109→
   110→function transformUserProfile(data: UserProfileResponse): UserProfile {
   111→  return {
   112→    userId: data.user_id,
   113→    rank: data.rank,
   114→    score: data.score,
   115→    anonymousName: data.anonymous_name,
   116→    gender: data.gender,
   117→    facePhotoUrl: data.face_photo_url,
   118→    topStrengths: data.top_strengths,
   119→    topImprovements: data.top_improvements,
   120→  };
   121→}
   122→
   123→// === FORUM API RESPONSE TYPES ===
   124→
   125→interface SubForumApiResponse {
   126→  id: string;
   127→  name: string;
   128→  slug: string;
   129→  description: string | null;
   130→  icon: string | null;
   131→  display_order: number;
   132→  post_count: number;
   133→}
   134→
   135→interface CategoryApiResponse {
   136→  id: string;
   137→  name: string;
   138→  slug: string;
   139→  description: string | null;
   140→  icon: string | null;
   141→  display_order: number;
   142→  post_count: number;
   143→  sub_forums: SubForumApiResponse[];
   144→}
   145→
   146→interface CategoryListApiResponse {
   147→  id: string;
   148→  name: string;
   149→  slug: string;
   150→  description: string | null;
   151→  icon: string | null;
   152→  display_order: number;
   153→  post_count: number;
   154→}
   155→
   156→interface PostAuthorApiResponse {
   157→  id: string;
   158→  username: string;
   159→}
   160→
   161→interface PostApiResponse {
   162→  id: string;
   163→  title: string;
   164→  content: string;
   165→  sub_forum_id: string;
   166→  sub_forum_slug: string;
   167→  category_slug: string;
   168→  author: PostAuthorApiResponse;
   169→  is_pinned: boolean;
   170→  is_guide: boolean;
   171→  vote_count: number;
   172→  comment_count: number;
   173→  user_vote: VoteType | null;
   174→  created_at: string;
   175→  updated_at: string;
   176→}
   177→
   178→interface PostListItemApiResponse {
   179→  id: string;
   180→  title: string;
   181→  content_preview: string;
   182→  sub_forum_slug: string;
   183→  category_slug: string;
   184→  author: PostAuthorApiResponse;
   185→  is_pinned: boolean;
   186→  is_guide: boolean;
   187→  vote_count: number;
   188→  comment_count: number;
   189→  user_vote: VoteType | null;
   190→  created_at: string;
   191→}
   192→
   193→interface PostListApiResponse {
   194→  posts: PostListItemApiResponse[];
   195→  total_count: number;
   196→  has_more: boolean;
   197→}
   198→
   199→interface CommentApiResponse {
   200→  id: string;
   201→  content: string;
   202→  post_id: string;
   203→  author: PostAuthorApiResponse;
   204→  parent_id: string | null;
   205→  vote_count: number;
   206→  user_vote: VoteType | null;
   207→  depth: number;
   208→  replies: CommentApiResponse[];
   209→  created_at: string;
   210→  updated_at: string;
   211→}
   212→
   213→interface VoteApiResponse {
   214→  success: boolean;
   215→  new_vote_count: number;
   216→  user_vote: VoteType | null;
   217→}
   218→
   219→interface ReportApiResponse {
   220→  id: string;
   221→  target_type: 'post' | 'comment';
   222→  target_id: string;
   223→  reason: string;
   224→  status: string;
   225→  created_at: string;
   226→}
   227→
   228→interface GuideSectionApiResponse {
   229→  category: CategoryListApiResponse;
   230→  guides: PostListItemApiResponse[];
   231→}
   232→
   233→interface RecommendedForumApiResponse {
   234→  category: CategoryListApiResponse;
   235→  matched_flaws: string[];
   236→  priority: number;
   237→}
   238→
   239→interface ArchetypeForumRecommendationApiResponse {
   240→  category: CategoryListApiResponse;
   241→  archetype: string;
   242→  reason: string | null;
   243→  priority: number;
   244→}
   245→
   246→// === FORUM TRANSFORM FUNCTIONS ===
   247→
   248→function transformSubForum(data: SubForumApiResponse): SubForum {
   249→  return {
   250→    id: data.id,
   251→    name: data.name,
   252→    slug: data.slug,
   253→    description: data.description,
   254→    icon: data.icon,
   255→    displayOrder: data.display_order,
   256→    postCount: data.post_count,
   257→  };
   258→}
   259→
   260→function transformCategory(data: CategoryApiResponse): Category {
   261→  return {
   262→    id: data.id,
   263→    name: data.name,
   264→    slug: data.slug,
   265→    description: data.description,
   266→    icon: data.icon,
   267→    displayOrder: data.display_order,
   268→    postCount: data.post_count,
   269→    subForums: data.sub_forums.map(transformSubForum),
   270→  };
   271→}
   272→
   273→function transformCategoryListItem(data: CategoryListApiResponse): CategoryListItem {
   274→  return {
   275→    id: data.id,
   276→    name: data.name,
   277→    slug: data.slug,
   278→    description: data.description,
   279→    icon: data.icon,
   280→    displayOrder: data.display_order,
   281→    postCount: data.post_count,
   282→  };
   283→}
   284→
   285→function transformPostAuthor(data: PostAuthorApiResponse): PostAuthor {
   286→  return {
   287→    id: data.id,
   288→    username: data.username,
   289→  };
   290→}
   291→
   292→function transformPost(data: PostApiResponse): Post {
   293→  return {
   294→    id: data.id,
   295→    title: data.title,
   296→    content: data.content,
   297→    subForumId: data.sub_forum_id,
   298→    subForumSlug: data.sub_forum_slug,
   299→    categorySlug: data.category_slug,
   300→    author: transformPostAuthor(data.author),
   301→    isPinned: data.is_pinned,
   302→    isGuide: data.is_guide,
   303→    voteCount: data.vote_count,
   304→    commentCount: data.comment_count,
   305→    userVote: data.user_vote,
   306→    createdAt: data.created_at,
   307→    updatedAt: data.updated_at,
   308→  };
   309→}
   310→
   311→function transformPostListItem(data: PostListItemApiResponse): PostListItem {
   312→  return {
   313→    id: data.id,
   314→    title: data.title,
   315→    contentPreview: data.content_preview,
   316→    subForumSlug: data.sub_forum_slug,
   317→    categorySlug: data.category_slug,
   318→    author: transformPostAuthor(data.author),
   319→    isPinned: data.is_pinned,
   320→    isGuide: data.is_guide,
   321→    voteCount: data.vote_count,
   322→    commentCount: data.comment_count,
   323→    userVote: data.user_vote,
   324→    createdAt: data.created_at,
   325→  };
   326→}
   327→
   328→function transformPostListResponse(data: PostListApiResponse): PostListResponse {
   329→  return {
   330→    posts: data.posts.map(transformPostListItem),
   331→    totalCount: data.total_count,
   332→    hasMore: data.has_more,
   333→  };
   334→}
   335→
   336→function transformComment(data: CommentApiResponse): Comment {
   337→  return {
   338→    id: data.id,
   339→    content: data.content,
   340→    postId: data.post_id,
   341→    author: transformPostAuthor(data.author),
   342→    parentId: data.parent_id,
   343→    voteCount: data.vote_count,
   344→    userVote: data.user_vote,
   345→    depth: data.depth,
   346→    replies: data.replies.map(transformComment),
   347→    createdAt: data.created_at,
   348→    updatedAt: data.updated_at,
   349→  };
   350→}
   351→
   352→function transformVoteResponse(data: VoteApiResponse): VoteResponse {
   353→  return {
   354→    success: data.success,
   355→    newVoteCount: data.new_vote_count,
   356→    userVote: data.user_vote,
   357→  };
   358→}
   359→
   360→function transformReport(data: ReportApiResponse): Report {
   361→  return {
   362→    id: data.id,
   363→    targetType: data.target_type,
   364→    targetId: data.target_id,
   365→    reason: data.reason as Report['reason'],
   366→    status: data.status,
   367→    createdAt: data.created_at,
   368→  };
   369→}
   370→
   371→function transformGuideSection(data: GuideSectionApiResponse): GuideSection {
   372→  return {
   373→    category: transformCategoryListItem(data.category),
   374→    guides: data.guides.map(transformPostListItem),
   375→  };
   376→}
   377→
   378→function transformRecommendedForum(data: RecommendedForumApiResponse): RecommendedForum {
   379→  return {
   380→    category: transformCategoryListItem(data.category),
   381→    matchedFlaws: data.matched_flaws,
   382→    priority: data.priority,
   383→  };
   384→}
   385→
   386→export interface ArchetypeForumRecommendation {
   387→  category: CategoryListItem;
   388→  archetype: string;
   389→  reason: string | null;
   390→  priority: number;
   391→}
   392→
   393→function transformArchetypeForumRecommendation(data: ArchetypeForumRecommendationApiResponse): ArchetypeForumRecommendation {
   394→  return {
   395→    category: transformCategoryListItem(data.category),
   396→    archetype: data.archetype,
   397→    reason: data.reason,
   398→    priority: data.priority,
   399→  };
   400→}
   401→
   402→interface ApiOptions {
   403→  method?: 'GET' | 'POST' | 'PUT' | 'DELETE';
   404→  body?: unknown;
   405→  token?: string;
   406→}
   407→
   408→interface Analysis {
   409→  id: string;
   410→  front_image_url: string | null;
   411→  side_image_url: string | null;
   412→  front_landmarks: Record<string, unknown> | null;
   413→  side_landmarks: Record<string, unknown> | null;
   414→  scores: Record<string, unknown> | null;
   415→  gender: string | null;
   416→  ethnicity: string | null;
   417→  created_at: string;
   418→}
   419→
   420→class ApiClient {
   421→  private token: string | null = null;
   422→
   423→  setToken(token: string | null) {
   424→    this.token = token;
   425→  }
   426→
   427→  getToken(): string | null {
   428→    if (typeof window !== 'undefined') {
   429→      return this.token || localStorage.getItem('auth_token');
   430→    }
   431→    return this.token;
   432→  }
   433→
   434→  private async request<T>(endpoint: string, options: ApiOptions = {}): Promise<T> {
   435→    const { method = 'GET', body, token } = options;
   436→    const authToken = token || this.getToken();
   437→
   438→    const headers: Record<string, string> = {
   439→      'Content-Type': 'application/json',
   440→    };
   441→
   442→    if (authToken) {
   443→      headers['Authorization'] = `Bearer ${authToken}`;
   444→    }
   445→
   446→    try {
   447→      const response = await fetch(`${API_URL}${endpoint}`, {
   448→        method,
   449→        headers,
   450→        body: body ? JSON.stringify(body) : undefined,
   451→      });
   452→
   453→      if (!response.ok) {
   454→        const error = await response.json().catch(() => ({ detail: 'Request failed' }));
   455→        throw new Error(error.detail || `HTTP ${response.status}`);
   456→      }
   457→
   458→      // Handle empty responses (204 No Content)
   459→      if (response.status === 204) {
   460→        return undefined as T;
   461→      }
   462→
   463→      return response.json();
   464→    } catch (err) {
   465→      // Network errors, CORS issues, etc.
   466→      if (err instanceof TypeError && err.message.includes('fetch')) {
   467→        throw new Error('Network error - please check your internet connection');
   468→      }
   469→      throw err;
   470→    }
   471→  }
   472→
   473→  // Health check
   474→  async health(): Promise<{ status: string; detection_ready: boolean }> {
   475→    return this.request('/health');
   476→  }
   477→
   478→  // Analyses CRUD
   479→  async listAnalyses(limit = 50, offset = 0): Promise<Analysis[]> {
   480→    return this.request(`/analyses?limit=${limit}&offset=${offset}`);
   481→  }
   482→
   483→  async createAnalysis(data: {
   484→    front_image_url?: string;
   485→    side_image_url?: string;
   486→    front_landmarks?: Record<string, unknown>;
   487→    side_landmarks?: Record<string, unknown>;
   488→    scores?: Record<string, unknown>;
   489→    gender?: string;
   490→    ethnicity?: string;
   491→  }): Promise<Analysis> {
   492→    return this.request('/analyses', { method: 'POST', body: data });
   493→  }
   494→
   495→  async getAnalysis(id: string): Promise<Analysis> {
   496→    return this.request(`/analyses/${id}`);
   497→  }
   498→
   499→  async deleteAnalysis(id: string): Promise<void> {
   500→    return this.request(`/analyses/${id}`, { method: 'DELETE' });
   501→  }
   502→
   503→  // Payments
   504→  async createCheckout(plan: 'basic' | 'pro'): Promise<{ checkout_url: string; session_id: string }> {
   505→    return this.request(`/payments/checkout?plan=${plan}`, { method: 'POST' });
   506→  }
   507→
   508→  async getPaymentHistory(): Promise<Array<{
   509→    id: string;
   510→    amount: number;
   511→    currency: string;
   512→    status: string;
   513→    created_at: string;
   514→  }>> {
   515→    return this.request('/payments/history');
   516→  }
   517→
   518→  // Leaderboard
   519→  async submitScore(data: {
   520→    score: number;
   521→    analysis_id?: string;
   522→    gender: 'male' | 'female';
   523→    ethnicity?: string;
   524→    face_photo_url?: string;
   525→    top_strengths?: string[];
   526→    top_improvements?: string[];
   527→  }): Promise<UserRank> {
   528→    const response = await this.request<LeaderboardApiResponse>('/leaderboard/score', {
   529→      method: 'POST',
   530→      body: data,
   531→    });
   532→    return transformUserRank(response);
   533→  }
   534→
   535→  async getMyRank(): Promise<UserRank> {
   536→    const response = await this.request<LeaderboardApiResponse>('/leaderboard/rank');
   537→    return transformUserRank(response);
   538→  }
   539→
   540→  async getLeaderboard(options?: {
   541→    gender?: 'male' | 'female';
   542→    limit?: number;
   543→    offset?: number;
   544→  }): Promise<LeaderboardData> {
   545→    const params = new URLSearchParams();
   546→    if (options?.gender) params.set('gender', options.gender);
   547→    if (options?.limit) params.set('limit', String(options.limit));
   548→    if (options?.offset) params.set('offset', String(options.offset));
   549→    const query = params.toString() ? `?${params}` : '';
   550→    const response = await this.request<LeaderboardListResponse>(`/leaderboard${query}`);
   551→    return transformLeaderboardData(response);
   552→  }
   553→
   554→  async getLeaderboardAroundMe(rangeSize?: number): Promise<LeaderboardData> {
   555→    const query = rangeSize ? `?range_size=${rangeSize}` : '';
   556→    const response = await this.request<LeaderboardListResponse>(`/leaderboard/around-me${query}`);
   557→    return transformLeaderboardData(response);
   558→  }
   559→
   560→  async getUserProfile(userId: string): Promise<UserProfile> {
   561→    const response = await this.request<UserProfileResponse>(`/leaderboard/user/${userId}`);
   562→    return transformUserProfile(response);
   563→  }
   564→
   565→  // Auth
   566→  async checkUsername(username: string): Promise<{ available: boolean; reason: string | null }> {
   567→    return this.request(`/auth/check-username/${encodeURIComponent(username)}`);
   568→  }
   569→
   570→  async register(data: {
   571→    email: string;
   572→    password: string;
   573→    username: string;
   574→    termsAccepted: boolean;
   575→    referralCode?: string;
   576→  }): Promise<{ access_token: string; token_type: string; user: { id: string; email: string; username: string; plan: string } }> {
   577→    return this.request('/auth/register', {
   578→      method: 'POST',
   579→      body: {
   580→        email: data.email,
   581→        password: data.password,
   582→        username: data.username,
   583→        terms_accepted: data.termsAccepted,
   584→        referral_code: data.referralCode,
   585→      },
   586→    });
   587→  }
   588→
   589→  async login(data: { email: string; password: string }): Promise<{ access_token: string; token_type: string; user: { id: string; email: string; username: string; plan: string } }> {
   590→    return this.request('/auth/login', {
   591→      method: 'POST',
   592→      body: data,
   593→    });
   594→  }
   595→
   596→  async validateReferralCode(code: string): Promise<{ valid: boolean; message: string | null }> {
   597→    return this.request(`/auth/validate-referral/${encodeURIComponent(code)}`);
   598→  }
   599→
   600→  async requestPasswordReset(email: string): Promise<{ message: string }> {
   601→    return this.request('/auth/forgot-password', {
   602→      method: 'POST',
   603→      body: { email },
   604→    });
   605→  }
   606→
   607→  async resetPassword(token: string, newPassword: string): Promise<{ message: string }> {
   608→    return this.request('/auth/reset-password', {
   609→      method: 'POST',
   610→      body: { token, new_password: newPassword },
   611→    });
   612→  }
   613→
   614→  async verifyEmail(token: string): Promise<{ message: string; email: string }> {
   615→    return this.request(`/auth/verify-email?token=${encodeURIComponent(token)}`);
   616→  }
   617→
   618→  async resendVerification(): Promise<{ message: string }> {
   619→    return this.request('/auth/resend-verification', {
   620→      method: 'POST',
   621→    });
   622→  }
   623→
   624→  // === FORUM ===
   625→
   626→  // Categories
   627→  async getForumCategories(): Promise<Category[]> {
   628→    const response = await this.request<CategoryApiResponse[]>('/forum/categories');
   629→    return response.map(transformCategory);
   630→  }
   631→
   632→  async getForumCategory(slug: string): Promise<Category> {
   633→    const response = await this.request<CategoryApiResponse>(`/forum/categories/${slug}`);
   634→    return transformCategory(response);
   635→  }
   636→
   637→  // Guides
   638→  async getForumGuides(): Promise<GuideSection[]> {
   639→    const response = await this.request<GuideSectionApiResponse[]>('/forum/guides');
   640→    return response.map(transformGuideSection);
   641→  }
   642→
   643→  // Recommended forums based on flaws
   644→  async getRecommendedForums(flaws: string[]): Promise<RecommendedForum[]> {
   645→    const params = new URLSearchParams();
   646→    params.set('flaws', flaws.join(','));
   647→    const response = await this.request<RecommendedForumApiResponse[]>(`/forum/recommended?${params}`);
   648→    return response.map(transformRecommendedForum);
   649→  }
   650→
   651→  // Recommended forums based on archetype
   652→  async getArchetypeForumRecommendations(archetype: string): Promise<ArchetypeForumRecommendation[]> {
   653→    const params = new URLSearchParams();
   654→    params.set('archetype', archetype);
   655→    const response = await this.request<ArchetypeForumRecommendationApiResponse[]>(`/forum/archetype-recommendations?${params}`);
   656→    return response.map(transformArchetypeForumRecommendation);
   657→  }
   658→
   659→  // Posts
   660→  async getForumPosts(
   661→    categorySlug: string,
   662→    options?: {
   663→      subForumSlug?: string;
   664→      sort?: SortOrder;
   665→      limit?: number;
   666→      offset?: number;
   667→    }
   668→  ): Promise<PostListResponse> {
   669→    const params = new URLSearchParams();
   670→    if (options?.sort) params.set('sort', options.sort);
   671→    if (options?.limit) params.set('limit', String(options.limit));
   672→    if (options?.offset) params.set('offset', String(options.offset));
   673→    const query = params.toString() ? `?${params}` : '';
   674→
   675→    const endpoint = options?.subForumSlug
   676→      ? `/forum/categories/${categorySlug}/${options.subForumSlug}/posts${query}`
   677→      : `/forum/categories/${categorySlug}/posts${query}`;
   678→
   679→    const response = await this.request<PostListApiResponse>(endpoint);
   680→    return transformPostListResponse(response);
   681→  }
   682→
   683→  async getForumPost(postId: string): Promise<Post> {
   684→    const response = await this.request<PostApiResponse>(`/forum/posts/${postId}`);
   685→    return transformPost(response);
   686→  }
   687→
   688→  async createForumPost(data: PostCreate): Promise<Post> {
   689→    const response = await this.request<PostApiResponse>('/forum/posts', {
   690→      method: 'POST',
   691→      body: {
   692→        title: data.title,
   693→        content: data.content,
   694→        sub_forum_id: data.subForumId,
   695→      },
   696→    });
   697→    return transformPost(response);
   698→  }
   699→
   700→  async updateForumPost(postId: string, data: PostUpdate): Promise<Post> {
   701→    const response = await this.request<PostApiResponse>(`/forum/posts/${postId}`, {
   702→      method: 'PUT',
   703→      body: data,
   704→    });
   705→    return transformPost(response);
   706→  }
   707→
   708→  async deleteForumPost(postId: string): Promise<void> {
   709→    await this.request(`/forum/posts/${postId}`, { method: 'DELETE' });
   710→  }
   711→
   712→  // Comments
   713→  async getForumComments(postId: string): Promise<Comment[]> {
   714→    const response = await this.request<CommentApiResponse[]>(`/forum/posts/${postId}/comments`);
   715→    return response.map(transformComment);
   716→  }
   717→
   718→  async createForumComment(postId: string, data: CommentCreate): Promise<Comment> {
   719→    const response = await this.request<CommentApiResponse>(`/forum/posts/${postId}/comments`, {
   720→      method: 'POST',
   721→      body: {
   722→        content: data.content,
   723→        parent_id: data.parentId,
   724→      },
   725→    });
   726→    return transformComment(response);
   727→  }
   728→
   729→  async updateForumComment(commentId: string, content: string): Promise<Comment> {
   730→    const response = await this.request<CommentApiResponse>(`/forum/comments/${commentId}`, {
   731→      method: 'PUT',
   732→      body: { content },
   733→    });
   734→    return transformComment(response);
   735→  }
   736→
   737→  async deleteForumComment(commentId: string): Promise<void> {
   738→    await this.request(`/forum/comments/${commentId}`, { method: 'DELETE' });
   739→  }
   740→
   741→  // Voting
   742→  async voteForumPost(postId: string, voteType: VoteType): Promise<VoteResponse> {
   743→    const response = await this.request<VoteApiResponse>(`/forum/posts/${postId}/vote`, {
   744→      method: 'POST',
   745→      body: { vote_type: voteType },
   746→    });
   747→    return transformVoteResponse(response);
   748→  }
   749→
   750→  async voteForumComment(commentId: string, voteType: VoteType): Promise<VoteResponse> {
   751→    const response = await this.request<VoteApiResponse>(`/forum/comments/${commentId}/vote`, {
   752→      method: 'POST',
   753→      body: { vote_type: voteType },
   754→    });
   755→    return transformVoteResponse(response);
   756→  }
   757→
   758→  // Reports
   759→  async createForumReport(data: ReportCreate): Promise<Report> {
   760→    const response = await this.request<ReportApiResponse>('/forum/reports', {
   761→      method: 'POST',
   762→      body: {
   763→        target_type: data.targetType,
   764→        target_id: data.targetId,
   765→        reason: data.reason,
   766→        details: data.details,
   767→      },
   768→    });
   769→    return transformReport(response);
   770→  }
   771→
   772→  // === PSL ===
   773→
   774→  async calculatePSL(data: {
   775→    face_score: number;
   776→    height_cm: number;
   777→    gender: 'male' | 'female';
   778→    body_fat_percent?: number;
   779→    muscle_level?: string;
   780→    failos?: string[];
   781→  }): Promise<{
   782→    score: number;
   783→    tier: string;
   784→    percentile: number;
   785→    breakdown: {
   786→      face: { raw: number; weighted: number };
   787→      height: { raw: number; weighted: number };
   788→      body: { raw: number; weighted: number };
   789→      bonuses: { threshold: number; synergy: number; total: number };
   790→      penalties: number;
   791→    };
   792→    potential: number;
   793→  }> {
   794→    return this.request('/psl/calculate', { method: 'POST', body: data });
   795→  }
   796→
   797→  async getHeightRating(height_cm: number, gender: 'male' | 'female'): Promise<{
   798→    height_cm: number;
   799→    height_rating: number;
   800→    height_display: string;
   801→  }> {
   802→    return this.request(`/psl/height-rating?height_cm=${height_cm}&gender=${gender}`);
   803→  }
   804→
   805→  async updateUserHeight(height_cm: number): Promise<{
   806→    height_cm: number;
   807→    height_rating: number;
   808→    height_display: string;
   809→  }> {
   810→    return this.request('/psl/height', { method: 'PUT', body: { height_cm } });
   811→  }
   812→
   813→  async getMyHeight(): Promise<{
   814→    height_cm: number;
   815→    height_rating: number;
   816→    height_display: string;
   817→  } | null> {
   818→    return this.request('/psl/my-height');
   819→  }
   820→
   821→  async updateUserWeight(weight_kg: number): Promise<{
   822→    weight_kg: number;
   823→    weight_display: string;
   824→    bmi: number | null;
   825→  }> {
   826→    return this.request('/psl/weight', { method: 'PUT', body: { weight_kg } });
   827→  }
   828→
   829→  async getMyWeight(): Promise<{
   830→    weight_kg: number;
   831→    weight_display: string;
   832→    bmi: number | null;
   833→  } | null> {
   834→    return this.request('/psl/my-weight');
   835→  }
   836→
   837→  async getPSLTiers(): Promise<{
   838→    tiers: Array<{ name: string; min: number; max: number; percentile: number }>;
   839→    weights: { face: number; height: number; body: number };
   840→  }> {
   841→    return this.request('/psl/tiers');
   842→  }
   843→
   844→  // === ARCHETYPE ===
   845→
   846→  async classifyArchetype(data: {
   847→    gonial_angle?: number;
   848→    fwhr?: number;
   849→    canthal_tilt?: number;
   850→    cheekbone_height?: number;
   851→    brow_ridge?: number;
   852→    jaw_width_ratio?: number;
   853→    gender: 'male' | 'female';
   854→    ethnicity: string;
   855→  }): Promise<{
   856→    primary: {
   857→      category: string;
   858→      sub_archetype: string;
   859→      confidence: number;
   860→      traits: string[];
   861→    };
   862→    secondary: {
   863→      category: string;
   864→      sub_archetype: string;
   865→      confidence: number;
   866→      traits: string[];
   867→    } | null;
   868→    all_scores: Array<{ category: string; score: number; confidence: number }>;
   869→    dimorphism_level: string;
   870→    style_guide: {
   871→      clothing: string[];
   872→      hair: string[];
   873→      colors: string[];
   874→    };
   875→    transition_path: {
   876→      target: string;
   877→      requirements: string[];
   878→    } | null;
   879→  }> {
   880→    return this.request('/archetype/classify', { method: 'POST', body: data });
   881→  }
   882→
   883→  async getArchetypeDefinitions(): Promise<{
   884→    archetypes: Array<{
   885→      id: string;
   886→      name: string;
   887→      description: string;
   888→      traits: string[];
   889→      ideal_metrics: {
   890→        gonial_angle: { min: number; max: number };
   891→        fwhr: { min: number; max: number };
   892→        canthal_tilt: { min: number; max: number };
   893→      };
   894→    }>;
   895→  }> {
   896→    return this.request('/archetype/definitions');
   897→  }
   898→
   899→  async getArchetypeDefinition(archetypeId: string): Promise<{
   900→    id: string;
   901→    name: string;
   902→    description: string;
   903→    traits: string[];
   904→    ideal_metrics: {
   905→      gonial_angle: { min: number; max: number };
   906→      fwhr: { min: number; max: number };
   907→      canthal_tilt: { min: number; max: number };
   908→    };
   909→  }> {
   910→    return this.request(`/archetype/definitions/${archetypeId}`);
   911→  }
   912→
   913→  async getDimorphismInfo(): Promise<{
   914→    levels: Record<string, {
   915→      gonial_angle_min?: number;
   916→      gonial_angle_max?: number;
   917→      description: string;
   918→    }>;
   919→  }> {
   920→    return this.request('/archetype/dimorphism');
   921→  }
   922→
   923→  // === PHYSIQUE ===
   924→
   925→  async uploadPhysiquePhotos(
   926→    front?: File,
   927→    side?: File,
   928→    back?: File
   929→  ): Promise<{
   930→    front_photo_url: string | null;
   931→    side_photo_url: string | null;
   932→    back_photo_url: string | null;
   933→    created_at: string;
   934→    updated_at: string;
   935→  }> {
   936→    const formData = new FormData();
   937→    if (front) formData.append('front', front);
   938→    if (side) formData.append('side', side);
   939→    if (back) formData.append('back', back);
   940→
   941→    const authToken = this.getToken();
   942→    const headers: Record<string, string> = {};
   943→    if (authToken) {
   944→      headers['Authorization'] = `Bearer ${authToken}`;
   945→    }
   946→
   947→    const response = await fetch(`${API_URL}/physique/upload`, {
   948→      method: 'POST',
   949→      headers,
   950→      body: formData,
   951→    });
   952→
   953→    if (!response.ok) {
   954→      const error = await response.json().catch(() => ({ detail: 'Upload failed' }));
   955→      throw new Error(error.detail || `HTTP ${response.status}`);
   956→    }
   957→
   958→    return response.json();
   959→  }
   960→
   961→  async getMyPhysiquePhotos(): Promise<{
   962→    front_photo_url: string | null;
   963→    side_photo_url: string | null;
   964→    back_photo_url: string | null;
   965→    created_at: string;
   966→    updated_at: string;
   967→  } | null> {
   968→    return this.request('/physique/my-photos');
   969→  }
   970→
   971→  async analyzePhysique(gender: 'male' | 'female'): Promise<BodyAnalysisResult> {
   972→    return this.request('/physique/analyze', {
   973→      method: 'POST',
   974→      body: { gender },
   975→    });
   976→  }
   977→
   978→  async getMyPhysiqueAnalysis(): Promise<{
   979→    front_photo_url: string | null;
   980→    side_photo_url: string | null;
   981→    back_photo_url: string | null;
   982→    estimated_body_fat: number | null;
   983→    muscle_mass: string | null;
   984→    frame_size: string | null;
   985→    shoulder_width: string | null;
   986→    waist_definition: string | null;
   987→    posture: string | null;
   988→    analysis_confidence: number | null;
   989→    analysis_notes: string | null;
   990→    analyzed_at: string | null;
   991→  } | null> {
   992→    return this.request('/physique/my-analysis');
   993→  }
   994→
   995→  async extractFaceFeatures(frontFaceUrl: string, sideFaceUrl?: string): Promise<FaceExtractionResult> {
   996→    return this.request('/physique/extract-face', {
   997→      method: 'POST',
   998→      body: {
   999→        front_face_url: frontFaceUrl,
  1000→        side_face_url: sideFaceUrl,
  1001→      },
  1002→    });
  1003→  }
  1004→
  1005→  async getMyFaceFeatures(): Promise<FaceExtractionResult | null> {
  1006→    return this.request('/physique/my-face-features');
  1007→  }
  1008→
  1009→  // === REFERRALS ===
  1010→  async getReferralStats(): Promise<{
  1011→    code: string;
  1012→    referral_link: string;
  1013→    total_invites: number;
  1014→    earnings: number;
  1015→    discount_percent: number;
  1016→  }> {
  1017→    return this.request('/referrals/my-stats');
  1018→  }
  1019→}
  1020→
  1021→// === TYPES ===
  1022→
  1023→export interface SkinAnalysis {
  1024→  clarity: number;
  1025→  tone: string;
  1026→  acne_level: string;
  1027→  acne_scarring: string;
  1028→  pore_visibility: string;
  1029→  texture_issues: string[];
  1030→}
  1031→
  1032→export interface HairAnalysis {
  1033→  hairline_nw: number;
  1034→  density: string;
  1035→  texture: string;
  1036→  color: string;
  1037→}
  1038→
  1039→export interface EyesAnalysis {
  1040→  color: string;
  1041→  under_eye_darkness: number;
  1042→  under_eye_puffiness: number;
  1043→}
  1044→
  1045→export interface FacialFeaturesAnalysis {
  1046→  hollow_cheeks: number;
  1047→  eyebrow_density: string;
  1048→  facial_hair_potential: string;
  1049→}
  1050→
  1051→export interface TeethAnalysis {
  1052→  color: string;
  1053→  alignment: string;
  1054→  visible_in_photo: boolean;
  1055→}
  1056→
  1057→export interface FaceExtractionResult {
  1058→  skin: SkinAnalysis;
  1059→  hair: HairAnalysis;
  1060→  eyes: EyesAnalysis;
  1061→  facial_features: FacialFeaturesAnalysis;
  1062→  teeth: TeethAnalysis;
  1063→  confidence: number;
  1064→}
  1065→
  1066→export interface BodyAnalysisResult {
  1067→  estimated_body_fat: number;
  1068→  muscle_mass: string;
  1069→  frame_size: string;
  1070→  shoulder_width: string;
  1071→  waist_definition: string;
  1072→  posture: string;
  1073→  confidence: number;
  1074→  notes: string | null;
  1075→}
  1076→
  1077→// Export singleton instance
  1078→export const api = new ApiClient();
  1079→
  1080→// Export types
  1081→export type { Analysis };
  1082→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
