     1→/**
     2→ * Advice Engine - Client-side implementation matching the Python AdviceEngine
     3→ * Processes plans.json trigger rules against user metrics
     4→ */
     5→
     6→import { Plan } from '@/components/results/cards/PlanActionCard';
     7→import type { ExclusiveCategory } from './recommendations/types';
     8→
     9→// ============================================
    10→// TREATMENT EXCLUSIVITY RULES
    11→// ============================================
    12→
    13→/**
    14→ * Treatment exclusivity configuration
    15→ * Based on FaceIQ logic for mutually exclusive procedures
    16→ */
    17→export interface TreatmentExclusivity {
    18→  exclusiveCategory?: ExclusiveCategory;
    19→  exclusiveWith?: string[];  // Specific treatment IDs that conflict
    20→}
    21→
    22→/**
    23→ * Mapping of treatment IDs to their exclusivity rules
    24→ */
    25→export const TREATMENT_EXCLUSIVITY: Record<string, TreatmentExclusivity> = {
    26→  // ============================================
    27→  // JAW AUGMENTATION vs REDUCTION
    28→  // Cannot combine augmentation with reduction
    29→  // ============================================
    30→  'jaw_fillers': {
    31→    exclusiveCategory: 'jaw_augmentation',
    32→    exclusiveWith: ['jaw_reduction', 'masseter_botox']
    33→  },
    34→  'jaw_implants': {
    35→    exclusiveCategory: 'jaw_augmentation',
    36→    exclusiveWith: ['jaw_reduction', 'masseter_botox']
    37→  },
    38→  'jaw_reduction': {
    39→    exclusiveCategory: 'jaw_reduction',
    40→    exclusiveWith: ['jaw_fillers', 'jaw_implants']
    41→  },
    42→  'masseter_botox': {
    43→    exclusiveCategory: 'jaw_reduction',
    44→    exclusiveWith: ['jaw_fillers', 'jaw_implants']
    45→  },
    46→
    47→  // ============================================
    48→  // CHIN AUGMENTATION - Pick ONE
    49→  // Chin implants, genioplasty, fat grafting to chin
    50→  // ============================================
    51→  'chin_implant': {
    52→    exclusiveCategory: 'chin_augmentation',
    53→    exclusiveWith: ['genioplasty', 'chin_filler', 'fat_grafting']
    54→  },
    55→  'genioplasty': {
    56→    exclusiveCategory: 'chin_augmentation',
    57→    exclusiveWith: ['chin_implant', 'chin_filler', 'fat_grafting']
    58→  },
    59→  'chin_filler': {
    60→    exclusiveCategory: 'chin_augmentation',
    61→    exclusiveWith: ['chin_implant', 'genioplasty', 'fat_grafting']
    62→  },
    63→
    64→  // ============================================
    65→  // CHEEKBONE AUGMENTATION - Pick ONE
    66→  // Fillers vs implants
    67→  // ============================================
    68→  'cheekbone_fillers': {
    69→    exclusiveCategory: 'cheekbone_augmentation',
    70→    exclusiveWith: ['midface_implants']
    71→  },
    72→  'midface_implants': {
    73→    exclusiveCategory: 'cheekbone_augmentation',
    74→    exclusiveWith: ['cheekbone_fillers']
    75→  },
    76→
    77→  // ============================================
    78→  // LIP AUGMENTATION vs REDUCTION
    79→  // ============================================
    80→  'lip_filler': {
    81→    exclusiveCategory: 'lip_augmentation',
    82→    exclusiveWith: ['lip_reduction']
    83→  },
    84→  'lip_reduction': {
    85→    exclusiveCategory: 'lip_reduction',
    86→    exclusiveWith: ['lip_filler']
    87→  },
    88→
    89→  // ============================================
    90→  // SUBMENTAL/NECK FAT REMOVAL - Pick ONE
    91→  // Kybella, cryolipolysis, submental liposuction
    92→  // ============================================
    93→  'kybella': {
    94→    exclusiveCategory: 'submental_fat_removal',
    95→    exclusiveWith: ['cryolipolysis', 'submental_liposuction']
    96→  },
    97→  'cryolipolysis': {
    98→    exclusiveCategory: 'submental_fat_removal',
    99→    exclusiveWith: ['kybella', 'submental_liposuction']
   100→  },
   101→  'submental_liposuction': {
   102→    exclusiveCategory: 'submental_fat_removal',
   103→    exclusiveWith: ['kybella', 'cryolipolysis']
   104→  },
   105→
   106→  // ============================================
   107→  // NECK PROCEDURES - Overlapping
   108→  // Neck lift supersedes submentoplasty
   109→  // ============================================
   110→  'neck_lift': {
   111→    exclusiveCategory: 'neck_procedures',
   112→    exclusiveWith: ['submentoplasty']  // Neck lift includes submentoplasty
   113→  },
   114→  'submentoplasty': {
   115→    exclusiveCategory: 'neck_procedures',
   116→    exclusiveWith: ['neck_lift']  // If getting neck lift, don't need separate submentoplasty
   117→  },
   118→
   119→  // ============================================
   120→  // EYE LATERAL CANTHUS - Pick ONE
   121→  // Canthoplasty vs canthopexy
   122→  // ============================================
   123→  'canthoplasty': {
   124→    exclusiveCategory: 'eye_lateral_canthus',
   125→    exclusiveWith: ['canthopexy']
   126→  },
   127→  'canthopexy': {
   128→    exclusiveCategory: 'eye_lateral_canthus',
   129→    exclusiveWith: ['canthoplasty']
   130→  },
   131→
   132→  // ============================================
   133→  // MAXILLARY SURGERY - Comprehensive
   134→  // Bimaxillary osteotomy supersedes many other procedures
   135→  // ============================================
   136→  'bimaxillary_osteotomy': {
   137→    exclusiveCategory: 'maxillary_surgery',
   138→    exclusiveWith: [
   139→      'genioplasty',        // Chin is repositioned in bimax
   140→      'chin_implant',       // Redundant after bimax
   141→      'jaw_implants',       // Jaw position changed
   142→      'jaw_fillers',        // Temporary vs permanent bone change
   143→      'rhinoplasty'         // Often combined but distinct - may need sequencing
   144→    ]
   145→  }
   146→};
   147→
   148→/**
   149→ * Get exclusivity data for a treatment
   150→ */
   151→export function getTreatmentExclusivity(treatmentId: string): TreatmentExclusivity | undefined {
   152→  return TREATMENT_EXCLUSIVITY[treatmentId];
   153→}
   154→
   155→/**
   156→ * Check if two treatments conflict
   157→ */
   158→export function treatmentsConflict(treatmentId1: string, treatmentId2: string): boolean {
   159→  const exclusivity1 = TREATMENT_EXCLUSIVITY[treatmentId1];
   160→  const exclusivity2 = TREATMENT_EXCLUSIVITY[treatmentId2];
   161→
   162→  // Check direct exclusivity via IDs
   163→  if (exclusivity1?.exclusiveWith?.includes(treatmentId2)) {
   164→    return true;
   165→  }
   166→  if (exclusivity2?.exclusiveWith?.includes(treatmentId1)) {
   167→    return true;
   168→  }
   169→
   170→  // Check category-based exclusivity (same category = mutually exclusive)
   171→  if (
   172→    exclusivity1?.exclusiveCategory &&
   173→    exclusivity2?.exclusiveCategory &&
   174→    exclusivity1.exclusiveCategory === exclusivity2.exclusiveCategory
   175→  ) {
   176→    return true;
   177→  }
   178→
   179→  return false;
   180→}
   181→
   182→/**
   183→ * Get all treatments that conflict with a given treatment
   184→ */
   185→export function getConflictingTreatments(treatmentId: string): string[] {
   186→  const conflicts: string[] = [];
   187→  const exclusivity = TREATMENT_EXCLUSIVITY[treatmentId];
   188→
   189→  if (!exclusivity) {
   190→    return conflicts;
   191→  }
   192→
   193→  // Add direct exclusions
   194→  if (exclusivity.exclusiveWith) {
   195→    conflicts.push(...exclusivity.exclusiveWith);
   196→  }
   197→
   198→  // Add treatments from same exclusive category
   199→  if (exclusivity.exclusiveCategory) {
   200→    for (const [id, data] of Object.entries(TREATMENT_EXCLUSIVITY)) {
   201→      if (id !== treatmentId && data.exclusiveCategory === exclusivity.exclusiveCategory) {
   202→        if (!conflicts.includes(id)) {
   203→          conflicts.push(id);
   204→        }
   205→      }
   206→    }
   207→  }
   208→
   209→  return conflicts;
   210→}
   211→
   212→/**
   213→ * Human-readable descriptions of why treatments conflict
   214→ */
   215→export const CONFLICT_REASONS: Record<ExclusiveCategory, string> = {
   216→  'jaw_augmentation': 'Jaw augmentation procedures conflict with jaw reduction procedures. Choose one approach.',
   217→  'jaw_reduction': 'Jaw reduction procedures conflict with jaw augmentation procedures. Choose one approach.',
   218→  'chin_augmentation': 'Choose one chin augmentation method. Combining implants, genioplasty, or fillers is not recommended.',
   219→  'cheekbone_augmentation': 'Choose either fillers or implants for cheekbone augmentation, not both.',
   220→  'lip_augmentation': 'Lip augmentation conflicts with lip reduction. Choose one approach for lip volume.',
   221→  'lip_reduction': 'Lip reduction conflicts with lip augmentation. Choose one approach for lip volume.',
   222→  'submental_fat_removal': 'Choose one submental fat removal method. Multiple procedures to the same area increase complication risk.',
   223→  'neck_procedures': 'Neck lift includes submentoplasty. Having both is redundant and increases risk.',
   224→  'eye_lateral_canthus': 'Choose either canthoplasty or canthopexy for lateral canthus modification, not both.',
   225→  'maxillary_surgery': 'Bimaxillary osteotomy is comprehensive and may make other jaw/chin procedures redundant.'
   226→};
   227→
   228→// ============================================
   229→// TYPES
   230→// ============================================
   231→
   232→interface Threshold {
   233→  operator: '<' | '>';
   234→  value: number;
   235→}
   236→
   237→interface TriggerRules {
   238→  metrics: string[];
   239→  condition: 'OR' | 'AND';
   240→  thresholds: Record<string, Threshold>;
   241→}
   242→
   243→// Harmony-style effectiveness rating
   244→interface Effectiveness {
   245→  level: 'high' | 'medium' | 'low';
   246→  score: number;  // 1-5
   247→  confidence: number;  // 0-1
   248→}
   249→
   250→// How a treatment impacts a specific ratio
   251→interface RatioImpact {
   252→  direction: 'increase' | 'decrease';
   253→  percentage: number;  // Expected % change
   254→}
   255→
   256→interface PlanContent {
   257→  description: string;
   258→  cost_min: number;
   259→  cost_max: number;
   260→  time_min?: string;
   261→  time_max?: string;
   262→  risks?: string;
   263→  citations?: string[];
   264→  tags?: string[];
   265→  // Treatment metadata fields
   266→  priority_score?: number;  // 1-5, higher = more important
   267→  effectiveness?: Effectiveness;
   268→  ratios_impacted?: Record<string, RatioImpact>;
   269→  pillars?: string[];  // e.g., ['angularity', 'harmony', 'symmetry']
   270→}
   271→
   272→interface RawPlan {
   273→  id: string;
   274→  title: string;
   275→  trigger_rules: TriggerRules;
   276→  content: PlanContent;
   277→}
   278→
   279→interface TriggerResult {
   280→  metric: string;
   281→  value: number;
   282→  threshold: number;
   283→  operator: '<' | '>';
   284→}
   285→
   286→// ============================================
   287→// PLANS DATA (from plans.json)
   288→// ============================================
   289→
   290→export const PLANS: RawPlan[] = [
   291→  {
   292→    id: "jaw_fillers",
   293→    title: "Jaw Fillers",
   294→    trigger_rules: {
   295→      metrics: ["Gonial Angle", "Bigonial Width", "Ramus to Mandible Ratio"],
   296→      condition: "OR",
   297→      thresholds: {
   298→        "Gonial Angle": { operator: ">", value: 128.0 },
   299→        "Bigonial Width": { operator: "<", value: 90.0 },
   300→        "Ramus to Mandible Ratio": { operator: "<", value: 0.5 }
   301→      }
   302→    },
   303→    content: {
   304→      description: "Injectable dermal fillers (hyaluronic acid or hydroxyapatite) to enhance jawline definition, gonial angle sharpness, and mandibular border projection. Common products: Radiesse, Sculptra, Juvederm Voluma. Targets masseter hollow, prejowl sulcus, and mandibular angle.",
   305→      cost_min: 600,
   306→      cost_max: 2500,
   307→      time_min: "6 months",
   308→      time_max: "18 months",
   309→      risks: "Vascular occlusion, asymmetry, swelling.",
   310→      citations: ["Al-Khafaji et al., 2023"],
   311→      tags: ["Minimally Invasive"],
   312→      priority_score: 4,
   313→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },
   314→      ratios_impacted: {
   315→        "Gonial Angle": { direction: "decrease", percentage: 3 },
   316→        "Bigonial Width": { direction: "increase", percentage: 4 },
   317→        "Ramus to Mandible Ratio": { direction: "increase", percentage: 2 }
   318→      },
   319→      pillars: ["angularity", "masculinity", "bone_structure"]
   320→    }
   321→  },
   322→  {
   323→    id: "cheekbone_fillers",
   324→    title: "Cheekbone Fillers",
   325→    trigger_rules: {
   326→      metrics: ["Cheekbone Height", "Face Width to Height Ratio"],
   327→      condition: "OR",
   328→      thresholds: {
   329→        "Cheekbone Height": { operator: "<", value: 60.0 },
   330→        "Face Width to Height Ratio": { operator: "<", value: 1.75 }
   331→      }
   332→    },
   333→    content: {
   334→      description: "Malar augmentation via hyaluronic acid fillers placed at the zygomatic arch and submalar region. Products: Juvederm Voluma, Restylane Lyft. Enhances ogee curve, anterior cheek projection, and lateral zygomatic width for improved facial angularity.",
   335→      cost_min: 650,
   336→      cost_max: 2500,
   337→      time_min: "6 months",
   338→      time_max: "18 months",
   339→      risks: "Asymmetry, filler migration.",
   340→      citations: ["Trinh & Gupta, 2021"],
   341→      tags: ["Minimally Invasive"],
   342→      priority_score: 4,
   343→      effectiveness: { level: 'high', score: 5, confidence: 0.85 },
   344→      ratios_impacted: {
   345→        "Cheekbone Height": { direction: "increase", percentage: 4 },
   346→        "Face Width to Height Ratio": { direction: "increase", percentage: 2 },
   347→        "Midface Ratio": { direction: "decrease", percentage: 2 }
   348→      },
   349→      pillars: ["angularity", "harmony", "youthfulness"]
   350→    }
   351→  },
   352→  {
   353→    id: "beard_growth",
   354→    title: "Beard / Stubble Growth",
   355→    trigger_rules: {
   356→      metrics: ["Chin to Philtrum Ratio", "Gonial Angle"],
   357→      condition: "OR",
   358→      thresholds: {
   359→        "Chin to Philtrum Ratio": { operator: "<", value: 1.8 },
   360→        "Gonial Angle": { operator: ">", value: 126.0 }
   361→      }
   362→    },
   363→    content: {
   364→      description: "Strategic facial hair growth (5-10mm stubble or full beard) to optically enhance jawline definition, camouflage gonial angle softness, and create visual chin projection. Consider minoxidil 5% foam if low coverage. Trim to maintain sharp mandibular border.",
   365→      cost_min: 0,
   366→      cost_max: 20,
   367→      time_min: "1 month",
   368→      time_max: "3 months",
   369→      risks: "None",
   370→      citations: ["Dixson et al., 2016"],
   371→      tags: ["Foundational", "Free"],
   372→      priority_score: 2,
   373→      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },
   374→      ratios_impacted: {
   375→        "Chin to Philtrum Ratio": { direction: "increase", percentage: 5 },
   376→        "Gonial Angle": { direction: "decrease", percentage: 3 }
   377→      },
   378→      pillars: ["masculinity", "camouflage"]
   379→    }
   380→  },
   381→  {
   382→    id: "lip_filler",
   383→    title: "Lip Filler",
   384→    trigger_rules: {
   385→      metrics: ["Lower Lip to Upper Lip Ratio"],
   386→      condition: "OR",
   387→      thresholds: {
   388→        "Lower Lip to Upper Lip Ratio": { operator: "<", value: 1.0 }
   389→      }
   390→    },
   391→    content: {
   392→      description: "Lip augmentation via hyaluronic acid fillers (Restylane, Juvederm) to enhance vermillion border, cupid's bow definition, and lip ratio balance. Can target vermillion height, philtral columns, or tubercles. Alternative: surgical lip lift (bullhorn or corner lift) for permanent results.",
   393→      cost_min: 500,
   394→      cost_max: 1200,
   395→      time_min: "6 months",
   396→      time_max: "12 months",
   397→      risks: "Migration, bruising.",
   398→      citations: ["Hernandez et al., 2023"],
   399→      tags: ["Minimally Invasive"],
   400→      priority_score: 3,
   401→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },
   402→      ratios_impacted: {
   403→        "Lower Lip to Upper Lip Ratio": { direction: "increase", percentage: 15 }
   404→      },
   405→      pillars: ["harmony", "femininity", "youthfulness"]
   406→    }
   407→  },
   408→  {
   409→    id: "weight_loss_protocol",
   410→    title: "Fat Loss Protocol (High Protein + Cardio)",
   411→    trigger_rules: {
   412→      metrics: ["Cheekbone Height", "Jaw Slope"],
   413→      condition: "OR",
   414→      thresholds: {
   415→        "Cheekbone Height": { operator: "<", value: 65.0 },
   416→        "Jaw Slope": { operator: ">", value: 140.0 }
   417→      }
   418→    },
   419→    content: {
   420→      description: "Caloric deficit protocol targeting 8-12% body fat to debloat buccal fat pads and reveal zygomatic, mandibular, and maxillary bone structure. High-protein intake (1.6-2.2g/kg), fasted cardio, and sodium/water management. Consider buccal fat removal surgery if structure remains obscured at low body fat.",
   421→      cost_min: 200,
   422→      cost_max: 1000,
   423→      time_min: "3 months",
   424→      time_max: "12 months",
   425→      risks: "None",
   426→      citations: ["Moon & Koh, 2020"],
   427→      tags: ["Foundational"],
   428→      priority_score: 5,
   429→      effectiveness: { level: 'high', score: 4, confidence: 0.90 },
   430→      ratios_impacted: {
   431→        "Cheekbone Height": { direction: "increase", percentage: 8 },
   432→        "Jaw Slope": { direction: "decrease", percentage: 5 },
   433→        "Bigonial Width": { direction: "increase", percentage: 3 }
   434→      },
   435→      pillars: ["angularity", "bone_structure", "definition"]
   436→    }
   437→  },
   438→  {
   439→    id: "mewing_posture",
   440→    title: "Mewing & Posture Correction",
   441→    trigger_rules: {
   442→      metrics: ["Midface Ratio", "Nasolabial Angle"],
   443→      condition: "OR",
   444→      thresholds: {
   445→        "Midface Ratio": { operator: ">", value: 1.05 },
   446→        "Nasolabial Angle": { operator: "<", value: 90.0 }
   447→      }
   448→    },
   449→    content: {
   450→      description: "Orthotropic tongue posture: entire tongue (posterior third critical) pressed against palate, teeth in light contact, nasal breathing. Aims to stimulate maxillary protraction, improve mandibular posture, and enhance gonial angle over time. Combine with proper head/neck alignment and chin tucks.",
   451→      cost_min: 0,
   452→      cost_max: 0,
   453→      time_min: "12 months",
   454→      time_max: "Lifetime",
   455→      risks: "None if performed correctly.",
   456→      citations: ["Mew J. et al., 2014"],
   457→      tags: ["Foundational", "Free"],
   458→      priority_score: 3,
   459→      effectiveness: { level: 'low', score: 2, confidence: 0.50 },
   460→      ratios_impacted: {
   461→        "Midface Ratio": { direction: "decrease", percentage: 2 },
   462→        "Nasolabial Angle": { direction: "increase", percentage: 3 },
   463→        "Gonial Angle": { direction: "decrease", percentage: 2 }
   464→      },
   465→      pillars: ["bone_structure", "posture", "long_term"]
   466→    }
   467→  },
   468→  {
   469→    id: "rhinoplasty",
   470→    title: "Rhinoplasty",
   471→    trigger_rules: {
   472→      metrics: ["Nasal Projection", "Nasal W to H Ratio", "Nasolabial Angle"],
   473→      condition: "OR",
   474→      thresholds: {
   475→        "Nasal Projection": { operator: ">", value: 0.75 },
   476→        "Nasal W to H Ratio": { operator: ">", value: 0.85 },
   477→        "Nasolabial Angle": { operator: "<", value: 85.0 }
   478→      }
   479→    },
   480→    content: {
   481→      description: "Comprehensive nasal surgery: dorsal hump reduction, osteotomies for width correction, tip plasty for bulbous refinement, alarplasty for alar base narrowing, cephalic trim for tip rotation, septoplasty for deviation. Can address nasal index, nasolabial angle, nasofrontal angle, and tip projection.",
   482→      cost_min: 5000,
   483→      cost_max: 15000,
   484→      time_min: "6 months",
   485→      time_max: "12 months",
   486→      risks: "Infection, asymmetry, breathing issues, revision surgery.",
   487→      citations: ["Rohrich RJ et al., 2010", "Foda HM, 2008"],
   488→      tags: ["Surgical"],
   489→      priority_score: 5,
   490→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },
   491→      ratios_impacted: {
   492→        "Nasal Projection": { direction: "decrease", percentage: 10 },
   493→        "Nasal W to H Ratio": { direction: "decrease", percentage: 8 },
   494→        "Nasolabial Angle": { direction: "increase", percentage: 12 },
   495→        "Nasal Index": { direction: "decrease", percentage: 6 }
   496→      },
   497→      pillars: ["harmony", "profile", "ethnicity_specific"]
   498→    }
   499→  },
   500→  {
   501→    id: "genioplasty",
   502→    title: "Sliding Genioplasty (Chin Surgery)",
   503→    trigger_rules: {
   504→      metrics: ["Chin to Philtrum Ratio", "Recession Relative to Frankfort Plane"],
   505→      condition: "OR",
   506→      thresholds: {
   507→        "Chin to Philtrum Ratio": { operator: "<", value: 1.5 },
   508→        "Recession Relative to Frankfort Plane": { operator: ">", value: 15.0 }
   509→      }
   510→    },
   511→    content: {
   512→      description: "Osseous genioplasty: horizontal advancement or setback of the chin via osteotomy and titanium plate fixation. Can also adjust vertical height (reduction/augmentation) and transverse width. Alternative: alloplastic chin implant (silicone/Medpor) for pure augmentation. Improves chin-philtrum ratio and profile convexity.",
   513→      cost_min: 4000,
   514→      cost_max: 12000,
   515→      time_min: "3 months",
   516→      time_max: "12 months",
   517→      risks: "Numbness, infection, asymmetry.",
   518→      citations: ["Park JH et al., 2018"],
   519→      tags: ["Surgical"],
   520→      priority_score: 5,
   521→      effectiveness: { level: 'high', score: 5, confidence: 0.92 },
   522→      ratios_impacted: {
   523→        "Chin to Philtrum Ratio": { direction: "increase", percentage: 20 },
   524→        "Recession Relative to Frankfort Plane": { direction: "decrease", percentage: 15 },
   525→        "Facial Convexity (Nasion)": { direction: "increase", percentage: 5 }
   526→      },
   527→      pillars: ["profile", "masculinity", "bone_structure"]
   528→    }
   529→  },
   530→  {
   531→    id: "canthoplasty",
   532→    title: "Canthoplasty (Eye Corner Surgery)",
   533→    trigger_rules: {
   534→      metrics: ["Lateral Canthal Tilt", "Eye Aspect Ratio"],
   535→      condition: "AND",
   536→      thresholds: {
   537→        "Lateral Canthal Tilt": { operator: "<", value: 4.0 },
   538→        "Eye Aspect Ratio": { operator: "<", value: 2.8 }
   539→      }
   540→    },
   541→    content: {
   542→      description: "Lateral canthoplasty or canthopexy: surgical elevation and fixation of the lateral canthal tendon to increase positive canthal tilt angle. Techniques include tarsal strip, lateral canthal suspension, or almond eye surgery. Can be combined with lower blepharoplasty. Addresses negative canthal tilt and downturned eye appearance.",
   543→      cost_min: 3000,
   544→      cost_max: 8000,
   545→      time_min: "2 months",
   546→      time_max: "6 months",
   547→      risks: "Scarring, asymmetry, dry eyes.",
   548→      citations: ["Rhee SC et al., 2017", "Chen WP, 2016"],
   549→      tags: ["Surgical"],
   550→      priority_score: 4,
   551→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },
   552→      ratios_impacted: {
   553→        "Lateral Canthal Tilt": { direction: "increase", percentage: 40 },
   554→        "Eye Aspect Ratio": { direction: "increase", percentage: 10 }
   555→      },
   556→      pillars: ["youthfulness", "alertness", "femininity"]
   557→    }
   558→  },
   559→  {
   560→    id: "brow_lift",
   561→    title: "Brow Lift / Browridge Enhancement",
   562→    trigger_rules: {
   563→      metrics: ["Eyebrow Low Setedness", "Browridge Inclination Angle"],
   564→      condition: "OR",
   565→      thresholds: {
   566→        "Eyebrow Low Setedness": { operator: ">", value: 2.0 },
   567→        "Browridge Inclination Angle": { operator: "<", value: 10.0 }
   568→      }
   569→    },
   570→    content: {
   571→      description: "Brow elevation via endoscopic browlift, temporal lift, or direct browplasty to reduce hooding and increase eyebrow height. For browridge: supraorbital rim augmentation with PMMA, hydroxyapatite paste, or custom implants. Botox for brow arch shaping. Addresses low-set brows and flat browridge inclination.",
   572→      cost_min: 1500,
   573→      cost_max: 10000,
   574→      time_min: "1 month",
   575→      time_max: "6 months",
   576→      risks: "Asymmetry, numbness, unnatural appearance.",
   577→      citations: ["Mendelson B et al., 2015"],
   578→      tags: ["Surgical", "Minimally Invasive"],
   579→      priority_score: 3,
   580→      effectiveness: { level: 'medium', score: 4, confidence: 0.75 },
   581→      ratios_impacted: {
   582→        "Eyebrow Low Setedness": { direction: "decrease", percentage: 30 },
   583→        "Browridge Inclination Angle": { direction: "increase", percentage: 20 }
   584→      },
   585→      pillars: ["youthfulness", "masculinity", "upper_third"]
   586→    }
   587→  },
   588→  // ============================================
   589→  // ADDITIONAL PROCEDURES
   590→  // ============================================
   591→  {
   592→    id: "kybella",
   593→    title: "Kybella (Double Chin Removal)",
   594→    trigger_rules: {
   595→      metrics: ["Submental Cervical Angle", "Neck Width"],
   596→      condition: "OR",
   597→      thresholds: {
   598→        "Submental Cervical Angle": { operator: ">", value: 130.0 },
   599→        "Neck Width": { operator: ">", value: 95.0 }
   600→      }
   601→    },
   602→    content: {
   603→      description: "Injectable deoxycholic acid (Kybella/ATX-101) to permanently dissolve submental fat. Multiple sessions required (2-6 treatments, 4-6 weeks apart). Destroys fat cell membranes, eliminating double chin without surgery. FDA-approved for moderate-to-severe submental fullness.",
   604→      cost_min: 1200,
   605→      cost_max: 3000,
   606→      time_min: "2 months",
   607→      time_max: "6 months",
   608→      risks: "Swelling, bruising, numbness, pain, nerve injury causing asymmetric smile, asymmetry, difficulty swallowing.",
   609→      citations: ["Jones DH et al., 2016", "Ascher B et al., 2017"],
   610→      tags: ["Minimally Invasive"],
   611→      priority_score: 3,
   612→      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },
   613→      ratios_impacted: {
   614→        "Submental Cervical Angle": { direction: "decrease", percentage: 15 },
   615→        "Neck Width": { direction: "decrease", percentage: 10 }
   616→      },
   617→      pillars: ["definition", "youthfulness", "neck"]
   618→    }
   619→  },
   620→  {
   621→    id: "cryolipolysis",
   622→    title: "Cryolipolysis (Fat Freezing)",
   623→    trigger_rules: {
   624→      metrics: ["Submental Cervical Angle", "Neck Width"],
   625→      condition: "OR",
   626→      thresholds: {
   627→        "Submental Cervical Angle": { operator: ">", value: 125.0 },
   628→        "Neck Width": { operator: ">", value: 90.0 }
   629→      }
   630→    },
   631→    content: {
   632→      description: "Non-invasive fat reduction via controlled cooling (CoolSculpting). Targets stubborn subcutaneous fat without surgery by crystallizing fat cells which are then naturally eliminated. FDA-cleared for submental area, flanks, abdomen. Results visible in 2-4 months.",
   633→      cost_min: 750,
   634→      cost_max: 2500,
   635→      time_min: "2 months",
   636→      time_max: "4 months",
   637→      risks: "Temporary erythema/swelling, bruising, numbness/paresthesia, pain, paradoxical adipose hyperplasia (rare), frostbite, hyperpigmentation.",
   638→      citations: ["Ingargiola MJ et al., 2015", "Kilmer SL et al., 2017"],
   639→      tags: ["Minimally Invasive"],
   640→      priority_score: 2,
   641→      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },
   642→      ratios_impacted: {
   643→        "Submental Cervical Angle": { direction: "decrease", percentage: 12 },
   644→        "Neck Width": { direction: "decrease", percentage: 8 }
   645→      },
   646→      pillars: ["definition", "non_invasive", "neck"]
   647→    }
   648→  },
   649→  {
   650→    id: "chin_implant",
   651→    title: "Chin Implant (Mentoplasty)",
   652→    trigger_rules: {
   653→      metrics: ["Chin to Philtrum Ratio", "Recession Relative to Frankfort Plane", "Facial Convexity"],
   654→      condition: "OR",
   655→      thresholds: {
   656→        "Chin to Philtrum Ratio": { operator: "<", value: 1.6 },
   657→        "Recession Relative to Frankfort Plane": { operator: ">", value: 12.0 },
   658→        "Facial Convexity": { operator: "<", value: 165.0 }
   659→      }
   660→    },
   661→    content: {
   662→      description: "Alloplastic chin augmentation using silicone or Medpor implants placed through submental or intraoral incision. Provides permanent chin projection and width enhancement. Alternative to sliding genioplasty for pure augmentation without bone cutting. Custom implants available for precise contouring.",
   663→      cost_min: 3000,
   664→      cost_max: 8000,
   665→      time_min: "2 weeks",
   666→      time_max: "3 months",
   667→      risks: "Infection, implant migration, bone erosion, asymmetry, numbness, capsular contracture, implant extrusion.",
   668→      citations: ["Yaremchuk MJ, 2013", "Binder WJ et al., 2008"],
   669→      tags: ["Surgical"],
   670→      priority_score: 4,
   671→      effectiveness: { level: 'high', score: 4, confidence: 0.88 },
   672→      ratios_impacted: {
   673→        "Chin to Philtrum Ratio": { direction: "increase", percentage: 18 },
   674→        "Recession Relative to Frankfort Plane": { direction: "decrease", percentage: 12 },
   675→        "Facial Convexity (Nasion)": { direction: "increase", percentage: 4 }
   676→      },
   677→      pillars: ["profile", "masculinity", "bone_structure"]
   678→    }
   679→  },
   680→  {
   681→    id: "buccal_fat_removal",
   682→    title: "Buccal Fat Removal (Bichectomy)",
   683→    trigger_rules: {
   684→      metrics: ["Cheekbone Height", "Face Width to Height Ratio"],
   685→      condition: "AND",
   686→      thresholds: {
   687→        "Cheekbone Height": { operator: "<", value: 70.0 },
   688→        "Face Width to Height Ratio": { operator: ">", value: 1.55 }
   689→      }
   690→    },
   691→    content: {
   692→      description: "Surgical excision of buccal fat pads through intraoral incision to slim the lower cheeks and enhance facial angularity. Creates more defined cheekbone-to-jaw contour. Best for patients with naturally round faces at low body fat. Results are permanent and irreversible.",
   693→      cost_min: 2500,
   694→      cost_max: 6000,
   695→      time_min: "2 weeks",
   696→      time_max: "6 months",
   697→      risks: "Facial nerve damage, asymmetry, over-resection causing gaunt appearance, infection, hematoma, parotid duct injury.",
   698→      citations: ["Tarallo M et al., 2018", "Moura LB et al., 2018"],
   699→      tags: ["Surgical"],
   700→      priority_score: 3,
   701→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },
   702→      ratios_impacted: {
   703→        "Cheekbone Height": { direction: "increase", percentage: 6 },
   704→        "Face Width to Height Ratio": { direction: "decrease", percentage: 3 }
   705→      },
   706→      pillars: ["angularity", "definition", "bone_structure"]
   707→    }
   708→  },
   709→  {
   710→    id: "alarplasty",
   711→    title: "Alarplasty (Alar Base Reduction)",
   712→    trigger_rules: {
   713→      metrics: ["Nasal W to H Ratio", "Alar Base Width"],
   714→      condition: "OR",
   715→      thresholds: {
   716→        "Nasal W to H Ratio": { operator: ">", value: 0.80 },
   717→        "Alar Base Width": { operator: ">", value: 35.0 }
   718→      }
   719→    },
   720→    content: {
   721→      description: "Surgical narrowing of the nasal alar base through wedge excision. Reduces nostril width and alar flare. Can be performed alone or combined with rhinoplasty. Weir excision for nostril sill, alar wedge for flaring. Hidden incision placement minimizes visible scarring.",
   722→      cost_min: 2000,
   723→      cost_max: 5000,
   724→      time_min: "2 weeks",
   725→      time_max: "3 months",
   726→      risks: "Visible scarring, asymmetry, over-narrowing, nostril distortion, poor wound healing.",
   727→      citations: ["Rohrich RJ et al., 2009", "Ingels K et al., 2015"],
   728→      tags: ["Surgical"],
   729→      priority_score: 3,
   730→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },
   731→      ratios_impacted: {
   732→        "Nasal W to H Ratio": { direction: "decrease", percentage: 12 },
   733→        "Nasal Index": { direction: "decrease", percentage: 8 }
   734→      },
   735→      pillars: ["harmony", "profile", "ethnicity_specific"]
   736→    }
   737→  },
   738→  {
   739→    id: "canthopexy",
   740→    title: "Canthopexy (Lateral Canthal Suspension)",
   741→    trigger_rules: {
   742→      metrics: ["Lateral Canthal Tilt", "Lower Eyelid Position"],
   743→      condition: "OR",
   744→      thresholds: {
   745→        "Lateral Canthal Tilt": { operator: "<", value: 3.0 },
   746→        "Lower Eyelid Position": { operator: ">", value: 1.5 }
   747→      }
   748→    },
   749→    content: {
   750→      description: "Suture suspension of the lateral canthal tendon to tighten lower eyelid and prevent sagging. Less invasive than canthoplasty (no tendon cutting). Supports eye shape, prevents scleral show, and can provide subtle upward tilt. Often combined with blepharoplasty.",
   751→      cost_min: 2500,
   752→      cost_max: 6000,
   753→      time_min: "2 weeks",
   754→      time_max: "3 months",
   755→      risks: "Asymmetry, under/overcorrection, dry eyes, ectropion, scarring, temporary swelling.",
   756→      citations: ["Hester TR et al., 2000", "Codner MA et al., 2008"],
   757→      tags: ["Surgical"],
   758→      priority_score: 3,
   759→      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },
   760→      ratios_impacted: {
   761→        "Lateral Canthal Tilt": { direction: "increase", percentage: 20 }
   762→      },
   763→      pillars: ["youthfulness", "alertness", "eye_area"]
   764→    }
   765→  },
   766→  {
   767→    id: "neck_lift",
   768→    title: "Neck Lift (Platysmaplasty)",
   769→    trigger_rules: {
   770→      metrics: ["Submental Cervical Angle", "Neck Width"],
   771→      condition: "OR",
   772→      thresholds: {
   773→        "Submental Cervical Angle": { operator: ">", value: 135.0 },
   774→        "Neck Width": { operator: ">", value: 100.0 }
   775→      }
   776→    },
   777→    content: {
   778→      description: "Comprehensive neck rejuvenation: platysma muscle tightening (platysmaplasty), submental liposuction, excess skin removal, and possible digastric muscle reduction. Addresses turkey neck, platysmal banding, submental fullness, and skin laxity. Can include submental tuck or deep plane techniques.",
   779→      cost_min: 5000,
   780→      cost_max: 15000,
   781→      time_min: "3 weeks",
   782→      time_max: "6 months",
   783→      risks: "Hematoma, nerve injury, skin necrosis, asymmetry, visible scarring, skin irregularities, prolonged swelling.",
   784→      citations: ["Feldman JJ, 2006", "Ellenbogen R et al., 2014"],
   785→      tags: ["Surgical"],
   786→      priority_score: 4,
   787→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },
   788→      ratios_impacted: {
   789→        "Submental Cervical Angle": { direction: "decrease", percentage: 25 },
   790→        "Neck Width": { direction: "decrease", percentage: 15 }
   791→      },
   792→      pillars: ["definition", "youthfulness", "neck"]
   793→    }
   794→  },
   795→  {
   796→    id: "septoplasty",
   797→    title: "Septoplasty (Deviated Septum Correction)",
   798→    trigger_rules: {
   799→      metrics: ["Nasal Deviation", "Nasal Symmetry"],
   800→      condition: "OR",
   801→      thresholds: {
   802→        "Nasal Deviation": { operator: ">", value: 5.0 },
   803→        "Nasal Symmetry": { operator: "<", value: 0.90 }
   804→      }
   805→    },
   806→    content: {
   807→      description: "Surgical correction of deviated nasal septum to improve nasal airflow and symmetry. Performed through closed endonasal approach. Can be functional (breathing) or cosmetic (straightening). Often combined with rhinoplasty (septorhinoplasty) for comprehensive nasal reshaping.",
   808→      cost_min: 3000,
   809→      cost_max: 10000,
   810→      time_min: "1 week",
   811→      time_max: "3 months",
   812→      risks: "Septal perforation, persistent deviation, saddle nose, numbness, infection, bleeding, CSF leak (rare).",
   813→      citations: ["Rohrich RJ et al., 2011", "Fettman N et al., 2009"],
   814→      tags: ["Surgical"],
   815→      priority_score: 2,
   816→      effectiveness: { level: 'medium', score: 3, confidence: 0.75 },
   817→      ratios_impacted: {
   818→        "Nasal Deviation": { direction: "decrease", percentage: 80 },
   819→        "Nasal Symmetry": { direction: "increase", percentage: 10 }
   820→      },
   821→      pillars: ["symmetry", "function", "breathing"]
   822→    }
   823→  },
   824→  {
   825→    id: "lip_lift",
   826→    title: "Lip Lift (Bullhorn/Subnasal Lip Lift)",
   827→    trigger_rules: {
   828→      metrics: ["Philtrum Length", "Upper Lip Vermilion Height", "Midface Ratio"],
   829→      condition: "OR",
   830→      thresholds: {
   831→        "Philtrum Length": { operator: ">", value: 15.0 },
   832→        "Upper Lip Vermilion Height": { operator: "<", value: 7.0 },
   833→        "Midface Ratio": { operator: ">", value: 1.1 }
   834→      }
   835→    },
   836→    content: {
   837→      description: "Surgical shortening of the philtrum by removing skin at the base of the nose (bullhorn excision). Permanently increases upper lip vermilion show and reduces long upper lip appearance. Alternative to filler for long philtrum correction. Scar hidden in nasal base crease.",
   838→      cost_min: 3500,
   839→      cost_max: 8000,
   840→      time_min: "2 weeks",
   841→      time_max: "6 months",
   842→      risks: "Visible scarring, asymmetry, over-shortening, distorted nostril base, wound dehiscence, prolonged swelling.",
   843→      citations: ["Austin HW, 1986", "Santanché P et al., 2014"],
   844→      tags: ["Surgical"],
   845→      priority_score: 4,
   846→      effectiveness: { level: 'high', score: 5, confidence: 0.88 },
   847→      ratios_impacted: {
   848→        "Chin to Philtrum Ratio": { direction: "increase", percentage: 25 },
   849→        "Midface Ratio": { direction: "decrease", percentage: 8 }
   850→      },
   851→      pillars: ["youthfulness", "harmony", "lip_area"]
   852→    }
   853→  },
   854→  {
   855→    id: "jaw_implants",
   856→    title: "Jaw Implants (Mandibular Augmentation)",
   857→    trigger_rules: {
   858→      metrics: ["Bigonial Width", "Gonial Angle", "Ramus to Mandible Ratio"],
   859→      condition: "OR",
   860→      thresholds: {
   861→        "Bigonial Width": { operator: "<", value: 85.0 },
   862→        "Gonial Angle": { operator: ">", value: 130.0 },
   863→        "Ramus to Mandible Ratio": { operator: "<", value: 0.45 }
   864→      }
   865→    },
   866→    content: {
   867→      description: "Alloplastic mandibular augmentation using silicone, Medpor, or custom PEEK implants. Enhances jaw width (bigonial), gonial angle definition, and mandibular border projection. Placed through intraoral incision. Custom wraparound implants available for comprehensive jaw enhancement.",
   868→      cost_min: 6000,
   869→      cost_max: 20000,
   870→      time_min: "3 weeks",
   871→      time_max: "6 months",
   872→      risks: "Infection, implant migration, bone erosion, asymmetry, mental nerve injury, capsular contracture, masseter atrophy.",
   873→      citations: ["Yaremchuk MJ, 2006", "Rao LK et al., 2011"],
   874→      tags: ["Surgical"],
   875→      priority_score: 5,
   876→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },
   877→      ratios_impacted: {
   878→        "Bigonial Width": { direction: "increase", percentage: 12 },
   879→        "Gonial Angle": { direction: "decrease", percentage: 8 },
   880→        "Ramus to Mandible Ratio": { direction: "increase", percentage: 6 }
   881→      },
   882→      pillars: ["angularity", "masculinity", "bone_structure"]
   883→    }
   884→  },
   885→  {
   886→    id: "midface_implants",
   887→    title: "Midface Implants (Malar/Submalar)",
   888→    trigger_rules: {
   889→      metrics: ["Cheekbone Height", "Midface Ratio", "Face Width to Height Ratio"],
   890→      condition: "OR",
   891→      thresholds: {
   892→        "Cheekbone Height": { operator: "<", value: 55.0 },
   893→        "Midface Ratio": { operator: ">", value: 1.15 },
   894→        "Face Width to Height Ratio": { operator: "<", value: 1.65 }
   895→      }
   896→    },
   897→    content: {
   898→      description: "Alloplastic augmentation of the malar (cheekbone) and/or submalar region using silicone or Medpor implants. Enhances midface projection, cheekbone prominence, and overall facial width. Custom implants available. Alternative to fat grafting for permanent midface volume.",
   899→      cost_min: 5000,
   900→      cost_max: 15000,
   901→      time_min: "3 weeks",
   902→      time_max: "6 months",
   903→      risks: "Infection, implant migration, asymmetry, nerve injury (infraorbital), bone erosion, capsular contracture, visibility.",
   904→      citations: ["Terino EO, 2000", "Binder WJ et al., 2007"],
   905→      tags: ["Surgical"],
   906→      priority_score: 4,
   907→      effectiveness: { level: 'high', score: 5, confidence: 0.88 },
   908→      ratios_impacted: {
   909→        "Cheekbone Height": { direction: "increase", percentage: 10 },
   910→        "Midface Ratio": { direction: "decrease", percentage: 6 },
   911→        "Face Width to Height Ratio": { direction: "increase", percentage: 4 }
   912→      },
   913→      pillars: ["angularity", "harmony", "bone_structure"]
   914→    }
   915→  },
   916→  {
   917→    id: "submental_liposuction",
   918→    title: "Submental Liposuction",
   919→    trigger_rules: {
   920→      metrics: ["Submental Cervical Angle", "Neck Width"],
   921→      condition: "AND",
   922→      thresholds: {
   923→        "Submental Cervical Angle": { operator: ">", value: 120.0 },
   924→        "Neck Width": { operator: ">", value: 85.0 }
   925→      }
   926→    },
   927→    content: {
   928→      description: "Surgical removal of excess fat beneath the chin via small cannula through submental incision. Refines jawline contour and improves neck definition. Can be combined with skin tightening or platysmaplasty. Best for younger patients with good skin elasticity.",
   929→      cost_min: 2000,
   930→      cost_max: 5000,
   931→      time_min: "1 week",
   932→      time_max: "3 months",
   933→      risks: "Contour irregularities, asymmetry, nerve injury, skin laxity, hematoma, seroma, prolonged swelling.",
   934→      citations: ["Rohrich RJ et al., 2007", "Giampapa VC et al., 2000"],
   935→      tags: ["Surgical"],
   936→      priority_score: 3,
   937→      effectiveness: { level: 'medium', score: 4, confidence: 0.82 },
   938→      ratios_impacted: {
   939→        "Submental Cervical Angle": { direction: "decrease", percentage: 15 },
   940→        "Neck Width": { direction: "decrease", percentage: 10 }
   941→      },
   942→      pillars: ["definition", "youthfulness", "neck"]
   943→    }
   944→  },
   945→  {
   946→    id: "submentoplasty",
   947→    title: "Submentoplasty (Submental Tuck)",
   948→    trigger_rules: {
   949→      metrics: ["Submental Cervical Angle", "Neck Width"],
   950→      condition: "OR",
   951→      thresholds: {
   952→        "Submental Cervical Angle": { operator: ">", value: 140.0 },
   953→        "Neck Width": { operator: ">", value: 105.0 }
   954→      }
   955→    },
   956→    content: {
   957→      description: "Direct excision of submental skin/fat with platysma muscle plication through small chin incision. Tightens central neck muscles and removes excess tissue. More aggressive than liposuction alone, less extensive than full neck lift. Also called cervicoplasty.",
   958→      cost_min: 3500,
   959→      cost_max: 8000,
   960→      time_min: "2 weeks",
   961→      time_max: "4 months",
   962→      risks: "Visible scarring, hematoma, nerve injury, skin necrosis, asymmetry, contour irregularities.",
   963→      citations: ["Giampapa VC et al., 2000", "Ellenbogen R et al., 2014"],
   964→      tags: ["Surgical"],
   965→      priority_score: 4,
   966→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },
   967→      ratios_impacted: {
   968→        "Submental Cervical Angle": { direction: "decrease", percentage: 20 },
   969→        "Neck Width": { direction: "decrease", percentage: 12 }
   970→      },
   971→      pillars: ["definition", "youthfulness", "neck"]
   972→    }
   973→  },
   974→  {
   975→    id: "fat_grafting",
   976→    title: "Fat Grafting (Facial Lipofilling)",
   977→    trigger_rules: {
   978→      metrics: ["Cheekbone Height", "Under-Eye Hollowness", "Temple Volume"],
   979→      condition: "OR",
   980→      thresholds: {
   981→        "Cheekbone Height": { operator: "<", value: 60.0 },
   982→        "Under-Eye Hollowness": { operator: ">", value: 3.0 },
   983→        "Temple Volume": { operator: "<", value: 0.8 }
   984→      }
   985→    },
   986→    content: {
   987→      description: "Autologous fat transfer: fat harvested from body (abdomen, thighs), processed, and injected for facial volumization. Microfat for volume (cheeks, temples, jawline), nanofat for skin rejuvenation. Natural permanent filler with 40-60% long-term retention. Multiple sessions may be needed.",
   988→      cost_min: 4000,
   989→      cost_max: 12000,
   990→      time_min: "1 month",
   991→      time_max: "6 months",
   992→      risks: "Fat resorption, asymmetry, lumpiness, oil cysts, infection, embolism (rare), over/under-correction.",
   993→      citations: ["Coleman SR, 2006", "Khouri RK et al., 2014"],
   994→      tags: ["Surgical"],
   995→      priority_score: 3,
   996→      effectiveness: { level: 'medium', score: 3, confidence: 0.70 },
   997→      ratios_impacted: {
   998→        "Cheekbone Height": { direction: "increase", percentage: 5 },
   999→        "Tear Trough Depth": { direction: "decrease", percentage: 40 }
  1000→      },
  1001→      pillars: ["youthfulness", "volume", "natural"]
  1002→    }
  1003→  },
  1004→  {
  1005→    id: "supraorbital_implants",
  1006→    title: "Supraorbital Rim Implants (Browridge)",
  1007→    trigger_rules: {
  1008→      metrics: ["Browridge Inclination Angle", "Supraorbital Projection"],
  1009→      condition: "OR",
  1010→      thresholds: {
  1011→        "Browridge Inclination Angle": { operator: "<", value: 8.0 },
  1012→        "Supraorbital Projection": { operator: "<", value: 0.85 }
  1013→      }
  1014→    },
  1015→    content: {
  1016→      description: "Custom or standard implants placed along the supraorbital rim to enhance browridge projection and definition. Creates more prominent brow bone for masculine appearance. Often custom-designed from CT scans. Placed through coronal or endoscopic approach.",
  1017→      cost_min: 8000,
  1018→      cost_max: 25000,
  1019→      time_min: "3 weeks",
  1020→      time_max: "6 months",
  1021→      risks: "Infection, implant migration, asymmetry, nerve injury, frontal sinus violation, visible/palpable implant, bone erosion.",
  1022→      citations: ["Yaremchuk MJ, 2003", "Spiegel JH, 2011"],
  1023→      tags: ["Surgical"],
  1024→      priority_score: 3,
  1025→      effectiveness: { level: 'high', score: 4, confidence: 0.80 },
  1026→      ratios_impacted: {
  1027→        "Browridge Inclination Angle": { direction: "increase", percentage: 30 }
  1028→      },
  1029→      pillars: ["masculinity", "bone_structure", "upper_third"]
  1030→    }
  1031→  },
  1032→  {
  1033→    id: "lip_reduction",
  1034→    title: "Lip Reduction Surgery (Reduction Cheiloplasty)",
  1035→    trigger_rules: {
  1036→      metrics: ["Lip Thickness", "Lower Lip to Upper Lip Ratio"],
  1037→      condition: "OR",
  1038→      thresholds: {
  1039→        "Lip Thickness": { operator: ">", value: 18.0 },
  1040→        "Lower Lip to Upper Lip Ratio": { operator: ">", value: 2.2 }
  1041→      }
  1042→    },
  1043→    content: {
  1044→      description: "Surgical removal of excess lip tissue through incision along wet-dry border to reduce lip volume and projection. Improves proportion between lips and surrounding features. Separate procedures for upper and lower lips. Permanent alternative to reversible fillers.",
  1045→      cost_min: 2500,
  1046→      cost_max: 6000,
  1047→      time_min: "2 weeks",
  1048→      time_max: "3 months",
  1049→      risks: "Visible scarring, asymmetry, over-reduction, numbness, altered sensation, wound dehiscence.",
  1050→      citations: ["Fanous N, 2007", "Garcia RM et al., 2016"],
  1051→      tags: ["Surgical"],
  1052→      priority_score: 2,
  1053→      effectiveness: { level: 'high', score: 4, confidence: 0.85 },
  1054→      ratios_impacted: {
  1055→        "Lower Lip to Upper Lip Ratio": { direction: "decrease", percentage: 20 }
  1056→      },
  1057→      pillars: ["harmony", "balance", "lip_area"]
  1058→    }
  1059→  },
  1060→  {
  1061→    id: "jaw_reduction",
  1062→    title: "Jaw Reduction Surgery (V-Line Surgery)",
  1063→    trigger_rules: {
  1064→      metrics: ["Bigonial Width", "Gonial Angle", "Face Width to Height Ratio"],
  1065→      condition: "AND",
  1066→      thresholds: {
  1067→        "Bigonial Width": { operator: ">", value: 120.0 },
  1068→        "Gonial Angle": { operator: "<", value: 115.0 },
  1069→        "Face Width to Height Ratio": { operator: ">", value: 1.65 }
  1070→      }
  1071→    },
  1072→    content: {
  1073→      description: "Mandibular angle resection and contouring to slim and feminize the lower face, creating V-line effect. Osteotomy of mandibular angle, possible chin tapering (T-osteotomy), and masseter reduction. Popular in East Asian aesthetic surgery. Performed through intraoral approach.",
  1074→      cost_min: 8000,
  1075→      cost_max: 25000,
  1076→      time_min: "1 month",
  1077→      time_max: "6 months",
  1078→      risks: "Facial nerve injury, asymmetry, over-reduction, bone necrosis, infection, prolonged swelling, numbness.",
  1079→      citations: ["Yang DB et al., 2014", "Jin H et al., 2013"],
  1080→      tags: ["Surgical"],
  1081→      priority_score: 4,
  1082→      effectiveness: { level: 'high', score: 5, confidence: 0.90 },
  1083→      ratios_impacted: {
  1084→        "Bigonial Width": { direction: "decrease", percentage: 15 },
  1085→        "Gonial Angle": { direction: "increase", percentage: 10 },
  1086→        "Face Width to Height Ratio": { direction: "decrease", percentage: 8 }
  1087→      },
  1088→      pillars: ["femininity", "harmony", "bone_structure"]
  1089→    }
  1090→  },
  1091→  {
  1092→    id: "bimaxillary_osteotomy",
  1093→    title: "Bimaxillary Osteotomy (Double Jaw Surgery)",
  1094→    trigger_rules: {
  1095→      metrics: ["Facial Convexity", "Recession Relative to Frankfort Plane", "Midface Ratio"],
  1096→      condition: "AND",
  1097→      thresholds: {
  1098→        "Facial Convexity": { operator: "<", value: 160.0 },
  1099→        "Recession Relative to Frankfort Plane": { operator: ">", value: 18.0 },
  1100→        "Midface Ratio": { operator: ">", value: 1.2 }
  1101→      }
  1102→    },
  1103→    content: {
  1104→      description: "Simultaneous repositioning of both maxilla (Le Fort I) and mandible (BSSO) to correct facial disharmony and skeletal malocclusion. Addresses severe class II/III relationships, facial asymmetry, and vertical excess. Requires orthodontic preparation. Most comprehensive facial skeletal surgery.",
  1105→      cost_min: 20000,
  1106→      cost_max: 60000,
  1107→      time_min: "3 months",
  1108→      time_max: "12 months",
  1109→      risks: "Nerve injury, infection, relapse, TMJ dysfunction, malocclusion, bleeding, airway compromise, need for revision.",
  1110→      citations: ["Proffit WR et al., 2013", "Wolford LM et al., 2003"],
  1111→      tags: ["Surgical"],
  1112→      priority_score: 5,
  1113→      effectiveness: { level: 'high', score: 5, confidence: 0.92 },
  1114→      ratios_impacted: {
  1115→        "Facial Convexity (Nasion)": { direction: "increase", percentage: 15 },
  1116→        "Recession Relative to Frankfort Plane": { direction: "decrease", percentage: 20 },
  1117→        "Midface Ratio": { direction: "decrease", percentage: 10 }
  1118→      },
  1119→      pillars: ["profile", "bone_structure", "comprehensive"]
  1120→    }
  1121→  }
  1122→];
  1123→
  1124→// ============================================
  1125→// ADVICE ENGINE CLASS
  1126→// ============================================
  1127→
  1128→export class AdviceEngine {
  1129→  private plans: RawPlan[];
  1130→
  1131→  constructor(customPlans?: RawPlan[]) {
  1132→    this.plans = customPlans || PLANS;
  1133→  }
  1134→
  1135→  /**
  1136→   * Check if a single threshold condition is met
  1137→   */
  1138→  private checkThreshold(userValue: number, operator: '<' | '>', thresholdValue: number): boolean {
  1139→    if (operator === '<') {
  1140→      return userValue < thresholdValue;
  1141→    }
  1142→    return userValue > thresholdValue;
  1143→  }
  1144→
  1145→  /**
  1146→   * Evaluate trigger rules against user metrics
  1147→   */
  1148→  private evaluateTriggerRules(
  1149→    triggerRules: TriggerRules,
  1150→    metricsDict: Record<string, number>
  1151→  ): { isTriggered: boolean; triggeredMetrics: TriggerResult[] } {
  1152→    const { metrics, thresholds, condition } = triggerRules;
  1153→    const triggeredMetrics: TriggerResult[] = [];
  1154→    const results: boolean[] = [];
  1155→
  1156→    for (const metricName of metrics) {
  1157→      if (!(metricName in metricsDict)) continue;
  1158→      if (!(metricName in thresholds)) continue;
  1159→
  1160→      const userValue = metricsDict[metricName];
  1161→      const { operator, value: thresholdValue } = thresholds[metricName];
  1162→      const isMet = this.checkThreshold(userValue, operator, thresholdValue);
  1163→
  1164→      if (isMet) {
  1165→        triggeredMetrics.push({
  1166→          metric: metricName,
  1167→          value: userValue,
  1168→          threshold: thresholdValue,
  1169→          operator
  1170→        });
  1171→      }
  1172→
  1173→      results.push(isMet);
  1174→    }
  1175→
  1176→    const isTriggered = condition === 'AND'
  1177→      ? results.length > 0 && results.every(r => r)
  1178→      : results.some(r => r);
  1179→
  1180→    return { isTriggered, triggeredMetrics };
  1181→  }
  1182→
  1183→  /**
  1184→   * Get all recommendations that match the user's metrics
  1185→   *
  1186→   * @param metricsDict - Raw metric values
  1187→   * @param severityDict - Severity classifications (ideal/good/moderate/severe) for each metric
  1188→   *                       If a metric is 'ideal', it will NOT trigger remediation plans
  1189→   */
  1190→  getRecommendations(
  1191→    metricsDict: Record<string, number>,
  1192→    severityDict?: Record<string, string>
  1193→  ): Plan[] {
  1194→    const recommendations: Plan[] = [];
  1195→
  1196→    for (const rawPlan of this.plans) {
  1197→      const { isTriggered, triggeredMetrics } = this.evaluateTriggerRules(
  1198→        rawPlan.trigger_rules,
  1199→        metricsDict
  1200→      );
  1201→
  1202→      // If severity data is provided, filter out metrics that are already ideal
  1203→      if (isTriggered && severityDict) {
  1204→        // Check if ALL triggered metrics are outside ideal range
  1205→        const hasActualFlaw = triggeredMetrics.some(tm => {
  1206→          const severity = severityDict[tm.metric];
  1207→          // Only trigger if severity is NOT ideal (i.e., it's good/moderate/severe)
  1208→          return severity && severity !== 'ideal';
  1209→        });
  1210→
  1211→        // Skip this plan if all triggered metrics are already ideal
  1212→        if (!hasActualFlaw) {
  1213→          continue;
  1214→        }
  1215→      }
  1216→
  1217→      if (isTriggered) {
  1218→        recommendations.push({
  1219→          id: rawPlan.id,
  1220→          title: rawPlan.title,
  1221→          content: {
  1222→            description: rawPlan.content.description,
  1223→            cost_min: rawPlan.content.cost_min,
  1224→            cost_max: rawPlan.content.cost_max,
  1225→            time_min: rawPlan.content.time_min || 'Unknown',
  1226→            time_max: rawPlan.content.time_max || 'Unknown',
  1227→            risks: rawPlan.content.risks || 'Consult a professional.',
  1228→            citations: rawPlan.content.citations || [],
  1229→            tags: rawPlan.content.tags
  1230→          },
  1231→          trigger_reason: triggeredMetrics
  1232→        });
  1233→      }
  1234→    }
  1235→
  1236→    return recommendations;
  1237→  }
  1238→
  1239→  /**
  1240→   * Get recommendations sorted by cost (cheapest first)
  1241→   */
  1242→  getRecommendationsByCost(
  1243→    metricsDict: Record<string, number>,
  1244→    severityDict?: Record<string, string>
  1245→  ): Plan[] {
  1246→    return this.getRecommendations(metricsDict, severityDict).sort(
  1247→      (a, b) => a.content.cost_min - b.content.cost_min
  1248→    );
  1249→  }
  1250→
  1251→  /**
  1252→   * Get recommendations grouped by phase/tag
  1253→   */
  1254→  getRecommendationsByPhase(
  1255→    metricsDict: Record<string, number>,
  1256→    severityDict?: Record<string, string>
  1257→  ): Record<string, Plan[]> {
  1258→    const recommendations = this.getRecommendations(metricsDict, severityDict);
  1259→    const grouped: Record<string, Plan[]> = {
  1260→      'Foundational': [],
  1261→      'Minimally Invasive': [],
  1262→      'Surgical': []
  1263→    };
  1264→
  1265→    for (const rec of recommendations) {
  1266→      const tags = rec.content.tags || [];
  1267→      if (tags.includes('Foundational')) {
  1268→        grouped['Foundational'].push(rec);
  1269→      } else if (tags.includes('Surgical')) {
  1270→        grouped['Surgical'].push(rec);
  1271→      } else if (tags.includes('Minimally Invasive')) {
  1272→        grouped['Minimally Invasive'].push(rec);
  1273→      } else {
  1274→        grouped['Minimally Invasive'].push(rec); // Default
  1275→      }
  1276→    }
  1277→
  1278→    return grouped;
  1279→  }
  1280→}
  1281→
  1282→// ============================================
  1283→// SINGLETON INSTANCE
  1284→// ============================================
  1285→
  1286→export const adviceEngine = new AdviceEngine();
  1287→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
