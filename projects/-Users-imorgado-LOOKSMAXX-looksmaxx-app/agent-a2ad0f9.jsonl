{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":"You are a software architect tasked with planning the implementation of the PSL Enhancement System for the LOOKSMAXX app.\n\n## CONTEXT\n\n### Current Architecture (from exploration)\nThe LOOKSMAXX app is a Next.js 14 + FastAPI application with:\n\n**Frontend (looksmaxx-app/):**\n- React with TypeScript, Tailwind CSS, Framer Motion\n- Contexts: ResultsContext, ForumContext, LeaderboardContext, AuthContext\n- Scoring: `src/lib/harmony-scoring.ts` (barrel export), `src/lib/scoring/` subdirectory\n- 70+ facial metrics with Bezier curves and ethnicity overrides\n- Results tabs: Overview, Front Ratios, Side Ratios, Leaderboard, Plan, Community, Options, Support\n- Components in `src/components/results/` (tabs/, cards/, visualization/)\n\n**Backend (looksmaxx-api/):**\n- FastAPI on Railway with PostgreSQL\n- Routers: auth, forum, leaderboard, payments, referrals\n- Models: User, LeaderboardScore, Analysis, Forum models\n- Services: email_service\n\n**What's Already Built:**\n- Complete scoring system (70+ metrics, Bezier curves, ethnicity overrides)\n- Recommendations engine (30+ treatments, 3-phase ordering)\n- Results page with 8 tabs\n- Forum system (categories, posts, comments, voting)\n- Auth system (email/password, password reset)\n- Leaderboard (global/gender rankings)\n\n### PSL Specification Requirements (from psl.md)\n1. **PSL Scoring Formula**: `PSL = (Face × 0.75) + (Height × 0.20) + (Body × 0.05) + Bonuses - Penalties`\n2. **Height Input**: Manual user input, converted via lookup tables (gender-specific)\n3. **Body Score**: From AI Vision analysis (optional, defaults to 5.0)\n4. **Bonus System**: Threshold bonuses (face/height/body ≥ 8.5) + synergy bonuses\n5. **10 Tier Classification**: Deformity → True Mogger\n6. **Archetype System**: 6 categories, 27 sub-archetypes (Softboy, Prettyboy, Chad, etc.)\n7. **AI Vision (Paid)**: Claude Vision API extracts 23+ features (skin, hair, eyes, teeth, body)\n8. **Advice Engine**: Hairstyles, skincare, style guide, grooming, action plans\n9. **New Database Tables**: vision_extractions, psl_scores, archetype_results, advice_results\n10. **New API Endpoints**: 13 endpoints (PSL, Vision, Archetype, Advice)\n11. **New Frontend Components**: 13 components (PSLScoreCard, ArchetypeCard, HairstyleRecs, etc.)\n\n### GitHub Code Patterns Found\n- Claude Vision API: `client.messages.create()` with `{\"type\": \"image\", \"source\": {\"type\": \"base64\", \"media_type\": \"image/jpeg\", \"data\": base64_data}}`\n- Anthropic client: `anthropic.Anthropic()` singleton pattern\n- Image handling: base64 encoding, media type detection\n\n## YOUR TASK\n\nCreate a detailed implementation plan that:\n\n1. **Analyzes Integration Points**: Where does PSL fit into the existing architecture?\n   - How does height input integrate with existing onboarding flow?\n   - Where do PSL/Archetype tabs go in ResultsLayout?\n   - How does the existing face score feed into PSL calculation?\n\n2. **Identifies Reusable Components**: What existing code can be leveraged?\n   - Existing scoring system for face score\n   - Existing recommendation cards for advice\n   - Existing context patterns for PSLContext\n\n3. **Defines Implementation Phases**: Break down into logical phases\n   - Phase 1: PSL Calculator + Height Input + PSL Tab\n   - Phase 2: Archetype Classification + Archetype Tab\n   - Phase 3: AI Vision Integration (Backend + Paywall)\n   - Phase 4: Advice Engine (Hairstyles, Skincare, Style)\n   - Phase 5: Action Plan + Polish\n\n4. **Specifies Files to Create/Modify**: For each phase, list:\n   - New files to create (exact paths)\n   - Existing files to modify\n   - Database migrations needed\n   - API endpoints to add\n\n5. **Considers Technical Decisions**:\n   - Should PSL calculation happen client-side or server-side?\n   - How to handle the free vs paid tier split?\n   - Caching strategy for AI Vision results\n   - How to gate archetype tab (free) vs advice tab (paid)\n\n6. **Risk Assessment**: Identify potential challenges\n   - API costs for Claude Vision\n   - Performance impact of new computations\n   - Breaking changes to existing data flow\n\nProvide a comprehensive, actionable implementation plan with specific file paths, code patterns, and step-by-step instructions."},"uuid":"2c9c332e-c729-4e99-8740-91ffea873504","timestamp":"2025-12-25T23:22:34.505Z"}
{"parentUuid":"2c9c332e-c729-4e99-8740-91ffea873504","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_019ZWjkpyDJQj6UvnYacqCXX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012zPzNMsc3VpCT4Lfo1Hwms","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/psl.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":16095,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":16095,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGM9GNwBMoGaKeRF6Yh","type":"assistant","uuid":"3f847a9f-dda7-4fac-96d7-3d6f1dc9bc34","timestamp":"2025-12-25T23:22:37.514Z"}
{"parentUuid":"3f847a9f-dda7-4fac-96d7-3d6f1dc9bc34","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_019ZWjkpyDJQj6UvnYacqCXX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N7mudXB1g4v3argLfSmFrd","name":"Glob","input":{"pattern":"**/src/lib/scoring/**/*.ts","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":16095,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":16095,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGM9GNwBMoGaKeRF6Yh","type":"assistant","uuid":"ffe48deb-75ad-42ef-84a3-da25599f9366","timestamp":"2025-12-25T23:22:38.941Z"}
{"parentUuid":"ffe48deb-75ad-42ef-84a3-da25599f9366","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_019ZWjkpyDJQj6UvnYacqCXX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UEgQUNjnf4C6bnQ3MxqKy6","name":"Glob","input":{"pattern":"**/src/components/results/**/*.tsx","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":16095,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":16095,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGM9GNwBMoGaKeRF6Yh","type":"assistant","uuid":"667ce835-ca86-457a-badf-168f31f7836b","timestamp":"2025-12-25T23:22:39.752Z"}
{"parentUuid":"667ce835-ca86-457a-badf-168f31f7836b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_019ZWjkpyDJQj6UvnYacqCXX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018CD8C2mCxnPUJF5ZwQQB83","name":"Glob","input":{"pattern":"**/src/contexts/**/*.tsx","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":16095,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":16095,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGM9GNwBMoGaKeRF6Yh","type":"assistant","uuid":"c5e298bd-e55b-4734-88a9-30dde1b543b0","timestamp":"2025-12-25T23:22:40.965Z"}
{"parentUuid":"c5e298bd-e55b-4734-88a9-30dde1b543b0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012zPzNMsc3VpCT4Lfo1Hwms","type":"tool_result","content":"     1→# PSL Enhancement System - Implementation Specification\n     2→\n     3→## Overview\n     4→\n     5→This document outlines the implementation of an enhanced PSL (Pretty Scale Level) scoring system with AI-powered feature extraction, archetype classification, and personalized advice generation. The AI vision analysis is a **paid feature**.\n     6→\n     7→---\n     8→\n     9→## Table of Contents\n    10→\n    11→1. [System Architecture](#1-system-architecture)\n    12→2. [PSL Scoring Formula](#2-psl-scoring-formula)\n    13→3. [AI Vision Feature Extraction (Paid)](#3-ai-vision-feature-extraction-paid)\n    14→4. [Archetype Classification System](#4-archetype-classification-system)\n    15→5. [Advice Generation Engine](#5-advice-generation-engine)\n    16→6. [Database Schema](#6-database-schema)\n    17→7. [API Endpoints](#7-api-endpoints)\n    18→8. [Frontend Components](#8-frontend-components)\n    19→9. [Implementation Phases](#9-implementation-phases)\n    20→10. [Cost & Pricing](#10-cost--pricing)\n    21→\n    22→---\n    23→\n    24→## 1. System Architecture\n    25→\n    26→### High-Level Flow\n    27→\n    28→```\n    29→┌─────────────────────────────────────────────────────────────────────────────┐\n    30→│                           USER INPUT                                         │\n    31→├─────────────────────────────────────────────────────────────────────────────┤\n    32→│  FREE TIER                          │  PAID TIER (AI Vision)                │\n    33→│  ├── Gender                         │  ├── All FREE tier data               │\n    34→│  ├── Ethnicity                      │  ├── AI Skin Analysis                 │\n    35→│  ├── Front Photo                    │  ├── AI Hair/Hairline Analysis        │\n    36→│  ├── Side Photo                     │  ├── AI Teeth Analysis                │\n    37→│  └── Height (manual input)          │  ├── AI Hollow Cheeks Detection       │\n    38→│                                      │  ├── AI Eye Color Extraction         │\n    39→│                                      │  ├── Physique Photo (optional)        │\n    40→│                                      │  └── AI Body Composition Analysis     │\n    41→└─────────────────────────────────────────────────────────────────────────────┘\n    42→                                    │\n    43→                                    ▼\n    44→┌─────────────────────────────────────────────────────────────────────────────┐\n    45→│                         PROCESSING PIPELINE                                  │\n    46→├─────────────────────────────────────────────────────────────────────────────┤\n    47→│                                                                              │\n    48→│  STAGE 1: Landmark Analysis (Existing)                                      │\n    49→│  ├── MediaPipe 478 landmarks (client-side)                                  │\n    50→│  ├── InsightFace 106 landmarks (server-side)                                │\n    51→│  └── 70+ facial metrics computed                                            │\n    52→│                                                                              │\n    53→│  STAGE 2: AI Vision Extraction (Paid Only)                                  │\n    54→│  ├── Claude Vision API analyzes photos                                      │\n    55→│  ├── Extracts soft tissue features                                          │\n    56→│  └── Stores in vision_extractions table                                     │\n    57→│                                                                              │\n    58→│  STAGE 3: PSL Calculation                                                   │\n    59→│  ├── Face Score (from landmarks) × 0.75                                     │\n    60→│  ├── Height Score (from input) × 0.20                                       │\n    61→│  ├── Body Score (from AI vision, if available) × 0.05                       │\n    62→│  ├── Apply bonuses and constraints                                          │\n    63→│  └── Classify into tier                                                     │\n    64→│                                                                              │\n    65→│  STAGE 4: Archetype Classification                                          │\n    66→│  ├── Rule-based scoring per archetype                                       │\n    67→│  ├── AI refinement for edge cases (paid)                                    │\n    68→│  └── Sub-archetype determination                                            │\n    69→│                                                                              │\n    70→│  STAGE 5: Advice Generation                                                 │\n    71→│  ├── Hairstyle recommendations (face shape + hairline)                      │\n    72→│  ├── Skincare routine (skin analysis)                                       │\n    73→│  ├── Style guide (archetype-matched)                                        │\n    74→│  └── Prioritized action plan (flaws → fixes)                                │\n    75→│                                                                              │\n    76→└─────────────────────────────────────────────────────────────────────────────┘\n    77→                                    │\n    78→                                    ▼\n    79→┌─────────────────────────────────────────────────────────────────────────────┐\n    80→│                              OUTPUT                                          │\n    81→├─────────────────────────────────────────────────────────────────────────────┤\n    82→│  ├── Enhanced PSL Score (0-10) with tier badge                              │\n    83→│  ├── Score breakdown (Face/Height/Body/Bonuses)                             │\n    84→│  ├── Primary + Secondary Archetype                                          │\n    85→│  ├── Hairstyle Recommendations (3-5 options)                                │\n    86→│  ├── Skincare Routine (AM/PM)                                               │\n    87→│  ├── Style Guide (clothing, colors, accessories)                            │\n    88→│  └── Personalized Action Plan (prioritized by impact)                       │\n    89→└─────────────────────────────────────────────────────────────────────────────┘\n    90→```\n    91→\n    92→### Service Architecture\n    93→\n    94→```\n    95→looksmaxx-api/\n    96→├── app/\n    97→│   ├── services/\n    98→│   │   ├── psl_service.py           # PSL calculation with formula\n    99→│   │   ├── vision_service.py        # Claude Vision API integration\n   100→│   │   ├── archetype_service.py     # Archetype classification\n   101→│   │   └── advice_service.py        # Recommendation generation\n   102→│   │\n   103→│   ├── routers/\n   104→│   │   ├── psl.py                   # PSL endpoints\n   105→│   │   ├── vision.py                # AI vision endpoints\n   106→│   │   └── advice.py                # Advice endpoints\n   107→│   │\n   108→│   └── data/\n   109→│       ├── archetypes.json          # Archetype definitions\n   110→│       ├── hairstyles.json          # Hairstyle database\n   111→│       ├── skincare.json            # Skincare routines\n   112→│       └── style_guides.json        # Style recommendations\n   113→\n   114→looksmaxx-app/\n   115→├── src/\n   116→│   ├── contexts/\n   117→│   │   └── PSLContext.tsx           # Enhanced PSL state\n   118→│   │\n   119→│   ├── components/\n   120→│   │   └── psl/\n   121→│   │       ├── PSLScoreCard.tsx     # Main score display\n   122→│   │       ├── PSLBreakdown.tsx     # Component breakdown\n   123→│   │       ├── TierBadge.tsx        # Tier visualization\n   124→│   │       ├── ArchetypeCard.tsx    # Archetype display\n   125→│   │       ├── HairstyleRecs.tsx    # Hairstyle recommendations\n   126→│   │       ├── SkincareRoutine.tsx  # Skincare display\n   127→│   │       ├── StyleGuide.tsx       # Style recommendations\n   128→│   │       └── ActionPlan.tsx       # Prioritized improvements\n   129→│   │\n   130→│   └── lib/\n   131→│       ├── psl-calculator.ts        # Client-side PSL logic\n   132→│       └── archetype-classifier.ts  # Client-side classification\n   133→```\n   134→\n   135→---\n   136→\n   137→## 2. PSL Scoring Formula\n   138→\n   139→### 2.1 Base Formula\n   140→\n   141→```\n   142→PSL_Score = (Face × 0.75) + (Height × 0.20) + (Body × 0.05) + Bonuses\n   143→```\n   144→\n   145→Where:\n   146→- **Face** = Harmony score from landmark analysis (0-10)\n   147→- **Height** = Height rating from lookup table (0-10)\n   148→- **Body** = Body composition score from AI vision (0-10), defaults to 5.0 if not available\n   149→- **Bonuses** = Threshold and synergy bonuses (0-0.85 max)\n   150→\n   151→### 2.2 Height Rating Table\n   152→\n   153→| Height (Male) | Rating | Height (Female) | Rating |\n   154→|---------------|--------|-----------------|--------|\n   155→| < 5'3\" (160cm) | 1.0 | < 4'11\" (150cm) | 1.0 |\n   156→| 5'3\" (160cm) | 2.0 | 4'11\" (150cm) | 2.0 |\n   157→| 5'5\" (165cm) | 3.0 | 5'1\" (155cm) | 3.5 |\n   158→| 5'7\" (170cm) | 4.0 | 5'3\" (160cm) | 5.0 |\n   159→| 5'9\" (175cm) | 5.0 | 5'5\" (165cm) | 6.0 |\n   160→| 5'10\" (178cm) | 5.5 | 5'6\" (168cm) | 6.5 |\n   161→| 5'11\" (180cm) | 6.0 | 5'7\" (170cm) | 7.0 |\n   162→| 6'0\" (183cm) | 7.0 | 5'8\" (173cm) | 7.5 |\n   163→| 6'1\" (185cm) | 7.5 | 5'9\" (175cm) | 8.0 |\n   164→| 6'2\" (188cm) | 8.0 | 5'10\" (178cm) | 8.5 |\n   165→| 6'3\" (190cm) | 8.5 | 5'11\" (180cm) | 9.0 |\n   166→| 6'4\" (193cm) | 9.0 | 6'0\"+ (183cm+) | 9.0 (cap) |\n   167→| 6'5\"+ (196cm+) | 9.5 (diminishing) | - | - |\n   168→\n   169→### 2.3 Body Rating Scale\n   170→\n   171→| Body Fat % | Muscle Level | Rating | Description |\n   172→|------------|--------------|--------|-------------|\n   173→| 25%+ | Low | 2.0-3.0 | Overweight, no definition |\n   174→| 20-25% | Low | 3.5-4.5 | Soft, minimal definition |\n   175→| 18-22% | Medium | 5.0-5.5 | Average, some definition |\n   176→| 15-18% | Medium | 6.0-6.5 | Lean, visible abs starting |\n   177→| 12-15% | Medium-High | 7.0-7.5 | Athletic, clear definition |\n   178→| 10-12% | High | 8.0-8.5 | Shredded, competition lean |\n   179→| 8-10% | Very High | 9.0-9.5 | Elite physique |\n   180→| < 8% | Extreme | 9.5+ | IFBB Pro tier |\n   181→\n   182→### 2.4 Bonus System\n   183→\n   184→#### Threshold Bonuses (when category ≥ 8.5)\n   185→| Category | Bonus |\n   186→|----------|-------|\n   187→| Face ≥ 8.5 | +0.30 |\n   188→| Height ≥ 8.5 | +0.20 |\n   189→| Body ≥ 8.5 | +0.10 |\n   190→\n   191→#### Synergy Bonuses (when multiple categories ≥ 8.5)\n   192→| Combination | Additional Bonus |\n   193→|-------------|------------------|\n   194→| Face + Height ≥ 8.5 | +0.15 |\n   195→| Face + Body ≥ 8.5 | +0.10 |\n   196→| Height + Body ≥ 8.5 | +0.05 |\n   197→\n   198→#### Triple Synergy (all three ≥ 8.5)\n   199→- **+0.35** flat bonus (replaces pair bonuses, stacks with threshold bonuses)\n   200→\n   201→### 2.5 Constraints (Failos)\n   202→\n   203→| Constraint | Effect |\n   204→|------------|--------|\n   205→| Major facial failo present | Caps tier regardless of score |\n   206→| Body < 5.0 | -0.3 to face perception |\n   207→| Height < 8.0 rating | Cannot reach Gigachad tier |\n   208→| Severe asymmetry | -0.5 penalty |\n   209→\n   210→### 2.6 Tier Classification\n   211→\n   212→| Tier | Score Range | Percentile | Description |\n   213→|------|-------------|------------|-------------|\n   214→| Deformity | 0.0 - 1.0 | Bottom 0.01% | Medical intervention territory |\n   215→| Subhuman | 1.25 - 1.75 | Bottom 0.1% | Genetic outlier |\n   216→| Incel | 2.0 - 3.0 | Bottom 2.5% | Visibly below average |\n   217→| LTN (Low Tier Normie) | 3.5 - 4.5 | Bottom 13.59% | Somewhat unattractive |\n   218→| MTN (Mid Tier Normie) | 4.75 - 5.25 | Middle 68% | True average |\n   219→| HTN (High Tier Normie) | 5.5 - 6.5 | Top 13.59% | Somewhat attractive |\n   220→| Chadlite | 7.0 - 8.0 | Top 2.5% | Attractive, local star |\n   221→| Chad | 8.25 - 8.75 | Top 0.1% | Very attractive, elite |\n   222→| Gigachad | 9.0 - 9.5 | Top 0.01% | Mythical tier |\n   223→| True Mogger | 9.5+ | Apex | Theoretical limit |\n   224→\n   225→### 2.7 Implementation\n   226→\n   227→```typescript\n   228→// psl-calculator.ts\n   229→\n   230→interface PSLInput {\n   231→  faceScore: number;        // 0-10 from harmony analysis\n   232→  heightCm: number;         // User input\n   233→  gender: 'male' | 'female';\n   234→  bodyAnalysis?: {          // From AI vision (paid)\n   235→    bodyFatPercent: number;\n   236→    muscleLevel: 'low' | 'medium' | 'medium-high' | 'high' | 'very-high' | 'extreme';\n   237→  };\n   238→  failos?: string[];        // Detected major failos\n   239→}\n   240→\n   241→interface PSLResult {\n   242→  score: number;            // Final PSL 0-10\n   243→  tier: string;             // Tier name\n   244→  percentile: number;       // Population percentile\n   245→  breakdown: {\n   246→    face: { raw: number; weighted: number };\n   247→    height: { raw: number; weighted: number };\n   248→    body: { raw: number; weighted: number };\n   249→    bonuses: { threshold: number; synergy: number; total: number };\n   250→    penalties: number;\n   251→  };\n   252→  potential: number;        // Estimated max with improvements\n   253→}\n   254→\n   255→function calculatePSL(input: PSLInput): PSLResult {\n   256→  // 1. Get height rating\n   257→  const heightRating = getHeightRating(input.heightCm, input.gender);\n   258→\n   259→  // 2. Get body rating (default 5.0 if not available)\n   260→  const bodyRating = input.bodyAnalysis\n   261→    ? getBodyRating(input.bodyAnalysis.bodyFatPercent, input.bodyAnalysis.muscleLevel)\n   262→    : 5.0;\n   263→\n   264→  // 3. Calculate base score\n   265→  const faceWeighted = input.faceScore * 0.75;\n   266→  const heightWeighted = heightRating * 0.20;\n   267→  const bodyWeighted = bodyRating * 0.05;\n   268→  let baseScore = faceWeighted + heightWeighted + bodyWeighted;\n   269→\n   270→  // 4. Calculate bonuses\n   271→  let thresholdBonus = 0;\n   272→  let synergyBonus = 0;\n   273→\n   274→  if (input.faceScore >= 8.5) thresholdBonus += 0.30;\n   275→  if (heightRating >= 8.5) thresholdBonus += 0.20;\n   276→  if (bodyRating >= 8.5) thresholdBonus += 0.10;\n   277→\n   278→  const highCount = [input.faceScore, heightRating, bodyRating].filter(s => s >= 8.5).length;\n   279→\n   280→  if (highCount === 3) {\n   281→    synergyBonus = 0.35; // Triple synergy replaces pairs\n   282→  } else if (highCount === 2) {\n   283→    if (input.faceScore >= 8.5 && heightRating >= 8.5) synergyBonus += 0.15;\n   284→    if (input.faceScore >= 8.5 && bodyRating >= 8.5) synergyBonus += 0.10;\n   285→    if (heightRating >= 8.5 && bodyRating >= 8.5) synergyBonus += 0.05;\n   286→  }\n   287→\n   288→  // 5. Apply penalties\n   289→  let penalties = 0;\n   290→  if (bodyRating < 5.0) penalties += 0.3;\n   291→  if (input.failos?.includes('severe_asymmetry')) penalties += 0.5;\n   292→\n   293→  // 6. Final score\n   294→  const finalScore = Math.min(10, Math.max(0, baseScore + thresholdBonus + synergyBonus - penalties));\n   295→\n   296→  // 7. Classify tier (with constraints)\n   297→  const tier = classifyTier(finalScore, heightRating, input.failos);\n   298→\n   299→  return {\n   300→    score: Math.round(finalScore * 100) / 100,\n   301→    tier: tier.name,\n   302→    percentile: tier.percentile,\n   303→    breakdown: {\n   304→      face: { raw: input.faceScore, weighted: faceWeighted },\n   305→      height: { raw: heightRating, weighted: heightWeighted },\n   306→      body: { raw: bodyRating, weighted: bodyWeighted },\n   307→      bonuses: { threshold: thresholdBonus, synergy: synergyBonus, total: thresholdBonus + synergyBonus },\n   308→      penalties,\n   309→    },\n   310→    potential: estimatePotential(input),\n   311→  };\n   312→}\n   313→```\n   314→\n   315→---\n   316→\n   317→## 3. AI Vision Feature Extraction (Paid)\n   318→\n   319→### 3.1 Features Extracted\n   320→\n   321→#### From Face Photos\n   322→\n   323→| Feature | Scale | Description | Used For |\n   324→|---------|-------|-------------|----------|\n   325→| **Skin Clarity** | 0-10 | Overall skin quality | Skincare recommendations |\n   326→| **Skin Tone** | Category | pale/fair/medium/olive/tan/dark | Style color matching |\n   327→| **Acne Level** | none/mild/moderate/severe | Current breakout status | Skincare priority |\n   328→| **Acne Scarring** | none/mild/moderate/severe | Historical scarring | Treatment recommendations |\n   329→| **Pore Visibility** | minimal/visible/prominent | Pore size assessment | Skincare routine |\n   330→| **Texture Issues** | list | Roughness, bumps, etc. | Targeted treatments |\n   331→| **Hairline NW** | 0-7 | Norwood scale classification | Hairstyle recommendations |\n   332→| **Hair Density** | thin/medium/thick | Hair thickness | Hairstyle options |\n   333→| **Hair Texture** | straight/wavy/curly/coily | Natural texture | Styling recommendations |\n   334→| **Hair Color** | Category | Natural color classification | Style matching |\n   335→| **Eye Color** | Category | Iris color | Style color matching |\n   336→| **Under-eye Darkness** | 0-10 | Dark circle severity | Skincare/concealer advice |\n   337→| **Under-eye Puffiness** | 0-10 | Bag severity | Lifestyle recommendations |\n   338→| **Hollow Cheeks** | 0-10 | Buccal fat assessment | Leanness indicator |\n   339→| **Teeth Color** | white/off-white/yellow/stained | Tooth shade | Whitening recommendations |\n   340→| **Teeth Alignment** | aligned/minor-issues/crooked | Orthodontic status | Treatment options |\n   341→| **Eyebrow Density** | sparse/medium/thick | Brow fullness | Grooming advice |\n   342→| **Facial Hair Potential** | low/medium/high | Beard growth capability | Style recommendations |\n   343→\n   344→#### From Physique Photo (Optional)\n   345→\n   346→| Feature | Scale | Description | Used For |\n   347→|---------|-------|-------------|----------|\n   348→| **Body Fat %** | 5-40% | Estimated body fat | Body score calculation |\n   349→| **Muscle Mass** | low/medium/medium-high/high/very-high | Muscularity | Body score, archetype |\n   350→| **Frame Size** | small/medium/large/very-large | Skeletal frame | Archetype classification |\n   351→| **Shoulder Width** | narrow/average/broad/very-broad | Shoulder assessment | Style recommendations |\n   352→| **Waist Definition** | undefined/slight/defined/very-defined | V-taper indicator | Physique score |\n   353→| **Posture** | poor/fair/good/excellent | Standing posture | Improvement advice |\n   354→\n   355→### 3.2 Claude Vision Implementation\n   356→\n   357→```python\n   358→# vision_service.py\n   359→\n   360→import anthropic\n   361→from typing import Optional\n   362→import base64\n   363→\n   364→class VisionService:\n   365→    def __init__(self):\n   366→        self.client = anthropic.Anthropic()\n   367→        self.model = \"claude-sonnet-4-20250514\"\n   368→\n   369→    async def extract_features(\n   370→        self,\n   371→        front_photo_url: str,\n   372→        side_photo_url: Optional[str] = None,\n   373→        physique_photo_url: Optional[str] = None\n   374→    ) -> VisionExtractionResult:\n   375→\n   376→        # Prepare images\n   377→        images = [{\"type\": \"image\", \"source\": {\"type\": \"url\", \"url\": front_photo_url}}]\n   378→        if side_photo_url:\n   379→            images.append({\"type\": \"image\", \"source\": {\"type\": \"url\", \"url\": side_photo_url}})\n   380→\n   381→        # Face analysis prompt\n   382→        face_prompt = \"\"\"Analyze this face photo and extract the following features.\n   383→        Return a JSON object with these exact keys:\n   384→\n   385→        {\n   386→          \"skin\": {\n   387→            \"clarity\": <0-10 score>,\n   388→            \"tone\": \"<pale|fair|medium|olive|tan|dark>\",\n   389→            \"acne_level\": \"<none|mild|moderate|severe>\",\n   390→            \"acne_scarring\": \"<none|mild|moderate|severe>\",\n   391→            \"pore_visibility\": \"<minimal|visible|prominent>\",\n   392→            \"texture_issues\": [\"<list of issues>\"]\n   393→          },\n   394→          \"hair\": {\n   395→            \"hairline_nw\": <0-7 Norwood scale>,\n   396→            \"density\": \"<thin|medium|thick>\",\n   397→            \"texture\": \"<straight|wavy|curly|coily>\",\n   398→            \"color\": \"<blonde|light-brown|brown|dark-brown|black|red|gray>\"\n   399→          },\n   400→          \"eyes\": {\n   401→            \"color\": \"<blue|green|hazel|brown|dark-brown|black>\",\n   402→            \"under_eye_darkness\": <0-10>,\n   403→            \"under_eye_puffiness\": <0-10>\n   404→          },\n   405→          \"facial_features\": {\n   406→            \"hollow_cheeks\": <0-10>,\n   407→            \"eyebrow_density\": \"<sparse|medium|thick>\",\n   408→            \"facial_hair_potential\": \"<low|medium|high>\"\n   409→          },\n   410→          \"teeth\": {\n   411→            \"color\": \"<white|off-white|yellow|stained>\",\n   412→            \"alignment\": \"<aligned|minor-issues|crooked>\",\n   413→            \"visible_in_photo\": <boolean>\n   414→          }\n   415→        }\n   416→\n   417→        Be objective and accurate. If a feature cannot be determined from the photo, use null.\n   418→        \"\"\"\n   419→\n   420→        response = await self.client.messages.create(\n   421→            model=self.model,\n   422→            max_tokens=1024,\n   423→            messages=[{\n   424→                \"role\": \"user\",\n   425→                \"content\": [*images, {\"type\": \"text\", \"text\": face_prompt}]\n   426→            }]\n   427→        )\n   428→\n   429→        face_features = parse_json_response(response.content[0].text)\n   430→\n   431→        # Body analysis if physique photo provided\n   432→        body_features = None\n   433→        if physique_photo_url:\n   434→            body_features = await self._analyze_physique(physique_photo_url)\n   435→\n   436→        return VisionExtractionResult(\n   437→            face=face_features,\n   438→            body=body_features\n   439→        )\n   440→\n   441→    async def _analyze_physique(self, photo_url: str) -> BodyAnalysis:\n   442→        body_prompt = \"\"\"Analyze this physique photo and extract:\n   443→\n   444→        {\n   445→          \"body_fat_percent\": <estimated 5-40%>,\n   446→          \"muscle_mass\": \"<low|medium|medium-high|high|very-high>\",\n   447→          \"frame_size\": \"<small|medium|large|very-large>\",\n   448→          \"shoulder_width\": \"<narrow|average|broad|very-broad>\",\n   449→          \"waist_definition\": \"<undefined|slight|defined|very-defined>\",\n   450→          \"posture\": \"<poor|fair|good|excellent>\",\n   451→          \"estimated_height_category\": \"<short|average|tall|very-tall>\"\n   452→        }\n   453→\n   454→        Be objective. Base body fat estimate on visible definition and vascularity.\n   455→        \"\"\"\n   456→\n   457→        response = await self.client.messages.create(\n   458→            model=self.model,\n   459→            max_tokens=512,\n   460→            messages=[{\n   461→                \"role\": \"user\",\n   462→                \"content\": [\n   463→                    {\"type\": \"image\", \"source\": {\"type\": \"url\", \"url\": photo_url}},\n   464→                    {\"type\": \"text\", \"text\": body_prompt}\n   465→                ]\n   466→            }]\n   467→        )\n   468→\n   469→        return parse_json_response(response.content[0].text)\n   470→```\n   471→\n   472→### 3.3 Caching Strategy\n   473→\n   474→- Vision extractions are cached per analysis ID\n   475→- Cache invalidated if photos are updated\n   476→- Results stored in `vision_extractions` table\n   477→- TTL: Permanent (until analysis deleted)\n   478→\n   479→---\n   480→\n   481→## 4. Archetype Classification System\n   482→\n   483→### 4.1 Archetype Taxonomy\n   484→\n   485→```\n   486→ARCHETYPES\n   487→├── SOFTBOY (Low Dimorphism, Ectomorphic)\n   488→│   ├── K-Pop Idol\n   489→│   │   ├── Traits: East/SE Asian, flat midface, clear skin, styled hair\n   490→│   │   ├── Style: Slim tailored, high contrast colors, layered hair\n   491→│   │   └── Examples: BTS members, K-drama actors\n   492→│   │\n   493→│   ├── Softboy\n   494→│   │   ├── Traits: Youthful, delicate features, slim build\n   495→│   │   ├── Style: Oversized fits, light colors, long hair\n   496→│   │   └── Examples: Timothée Chalamet, young Leonardo DiCaprio\n   497→│   │\n   498→│   └── Academic\n   499→│       ├── Traits: Intellectual look, refined, understated\n   500→│       ├── Style: Preppy, glasses, earth tones\n   501→│       └── Examples: Young Hugh Grant\n   502→│\n   503→├── PRETTYBOY (Balanced Dimorphism, Good Harmony)\n   504→│   ├── Skater\n   505→│   │   ├── Traits: Casual cool, athletic lean, relaxed\n   506→│   │   ├── Style: Streetwear, baggy pants, sneakers\n   507→│   │   └── Examples: Young Heath Ledger\n   508→│   │\n   509→│   ├── Prettyboy\n   510→│   │   ├── Traits: Symmetrical, harmonious, classic beauty\n   511→│   │   ├── Style: Clean, fitted, minimal\n   512→│   │   └── Examples: Francisco Lachowski, Sean O'Pry\n   513→│   │\n   514→│   └── Surfer\n   515→│       ├── Traits: Sun-kissed, athletic, carefree\n   516→│       ├── Style: Beach casual, natural fabrics\n   517→│       └── Examples: Young Chris Hemsworth\n   518→│\n   519→├── ROBUST PRETTYBOY (Pretty + Edge/Intensity)\n   520→│   ├── Fallen Angel\n   521→│   │   ├── Traits: Ethereal, intense, mysterious\n   522→│   │   ├── Style: Dark romantic, leather, black\n   523→│   │   └── Examples: Young Jared Leto, Jordan Barrett\n   524→│   │\n   525→│   ├── Prince\n   526→│   │   ├── Traits: Regal, refined, elegant\n   527→│   │   ├── Style: Tailored suits, classic elegance\n   528→│   │   └── Examples: Young Alain Delon, Matt Bomer\n   529→│   │\n   530→│   ├── Bad Boy\n   531→│   │   ├── Traits: Rebellious, smoldering, dangerous appeal\n   532→│   │   ├── Style: Leather jackets, boots, rough edges\n   533→│   │   └── Examples: James Dean, Young Johnny Depp\n   534→│   │\n   535→│   └── Artist\n   536→│       ├── Traits: Creative, unconventional, magnetic\n   537→│       ├── Style: Eclectic, statement pieces\n   538→│       └── Examples: Harry Styles, Zayn Malik\n   539→│\n   540→├── CHAD (High Dimorphism, Strong Features)\n   541→│   ├── Vampire\n   542→│   │   ├── Traits: Sharp features, pale, mysterious, hollow cheeks\n   543→│   │   ├── Style: Dark, sophisticated, elegant\n   544→│   │   └── Examples: Robert Pattinson, Ian Somerhalder\n   545→│   │\n   546→│   ├── Superman\n   547→│   │   ├── Traits: Heroic, strong jaw, broad build, classic handsome\n   548→│   │   ├── Style: Classic American, clean-cut\n   549→│   │   └── Examples: Henry Cavill, David Gandy\n   550→│   │\n   551→│   ├── Jock\n   552→│   │   ├── Traits: Athletic, confident, dominant presence\n   553→│   │   ├── Style: Athletic wear, casual sporty\n   554→│   │   └── Examples: Chris Evans, Michael B. Jordan\n   555→│   │\n   556→│   ├── Casanova\n   557→│   │   ├── Traits: Charming, seductive, smooth\n   558→│   │   ├── Style: Tailored, sophisticated, European\n   559→│   │   └── Examples: George Clooney, Pierce Brosnan\n   560→│   │\n   561→│   ├── Executive\n   562→│   │   ├── Traits: Powerful, authoritative, successful look\n   563→│   │   ├── Style: Power suits, luxury watches\n   564→│   │   └── Examples: Jon Hamm, Gabriel Macht\n   565→│   │\n   566→│   └── Pharaoh\n   567→│       ├── Traits: Exotic, regal, chiseled, Middle Eastern features\n   568→│       ├── Style: Luxurious, gold accents, designer\n   569→│       └── Examples: Fares Fares, Egyptian models\n   570→│\n   571→├── HYPERMASCULINE (Extreme Masculine Features)\n   572→│   ├── Aquaman\n   573→│   │   ├── Traits: Tall, muscular, long hair, rugged handsome\n   574→│   │   ├── Style: Relaxed, bohemian, natural fabrics\n   575→│   │   └── Examples: Jason Momoa, Thor-era Chris Hemsworth\n   576→│   │\n   577→│   ├── Hypermasculine\n   578→│   │   ├── Traits: Extreme bone structure, heavy brow, dominant\n   579→│   │   ├── Style: Minimalist, masculine basics\n   580→│   │   └── Examples: Dolph Lundgren (prime), Michael Fassbender\n   581→│   │\n   582→│   ├── Outlaw\n   583→│   │   ├── Traits: Rough, weathered, dangerous\n   584→│   │   ├── Style: Leather, denim, boots, rugged\n   585→│   │   └── Examples: Young Clint Eastwood, Josh Brolin\n   586→│   │\n   587→│   └── Countryman\n   588→│       ├── Traits: Rugged, outdoorsy, strong silent\n   589→│       ├── Style: Workwear, flannel, boots\n   590→│       └── Examples: Yellowstone cast, Young Sam Elliott\n   591→│\n   592→└── OGRE (Maximum Size/Mass)\n   593→    ├── Viking\n   594→    │   ├── Traits: Massive, bearded, warrior look, Norse features\n   595→    │   ├── Style: Rugged, fur, leather, minimalist\n   596→    │   └── Examples: Hafþór Björnsson, Alexander Skarsgård (Northman)\n   597→    │\n   598→    └── Bodybuilder\n   599→        ├── Traits: Extreme muscle, massive frame, imposing\n   600→        ├── Style: Fitted to show physique, tank tops\n   601→        └── Examples: Arnold Schwarzenegger (prime), Dwayne Johnson\n   602→```\n   603→\n   604→### 4.2 Classification Criteria\n   605→\n   606→#### Input Features for Classification\n   607→\n   608→| Feature | Source | Weight |\n   609→|---------|--------|--------|\n   610→| Gonial Angle | Landmarks | High |\n   611→| Facial Width/Height Ratio | Landmarks | High |\n   612→| Brow Ridge Prominence | Landmarks + Vision | Medium |\n   613→| Cheekbone Height | Landmarks | Medium |\n   614→| Eye Area Score | Landmarks | Medium |\n   615→| Dimorphism Level | Computed | High |\n   616→| Body Type | Vision (physique) | Medium |\n   617→| Frame Size | Vision | Medium |\n   618→| Ethnicity | User input | Medium |\n   619→| Hollow Cheeks | Vision | Low |\n   620→| Skin Tone | Vision | Low |\n   621→\n   622→#### Dimorphism Classification\n   623→\n   624→| Level | Gonial Angle | Brow Ridge | Jaw Definition | Features |\n   625→|-------|--------------|------------|----------------|----------|\n   626→| Low | ≥ 130° | Minimal | Soft, undefined | Neotenous, youthful |\n   627→| Low-Balanced | 125-130° | Slight | Harmonious soft | Balanced but softer |\n   628→| Balanced | 118-125° | Moderate | Neutral | Neither masc nor fem |\n   629→| Above-Average | 115-120° | Moderate+ | Defined | Leaning masculine |\n   630→| High | 110-118° | Prominent | Very defined | Strongly masculine |\n   631→| Very High | < 110° | Heavy | Extremely defined | Hypermasculine |\n   632→\n   633→#### Body Type Classification\n   634→\n   635→| Type | Shoulder-Waist Ratio | Build | Archetype Fit |\n   636→|------|---------------------|-------|---------------|\n   637→| Ectomorphic | < 1.35 | Slim, lean | Softboy, Prettyboy |\n   638→| Ecto-Mesomorphic | 1.35-1.45 | Lean athletic | Robust Prettyboy, Vampire Chad |\n   639→| Mesomorphic | 1.45-1.55 | Athletic | Chad, Jock |\n   640→| Endo-Mesomorphic | > 1.55, high muscle | Muscular large | Hypermasculine, Aquaman |\n   641→| Meso-Endomorphic | > 1.45, higher BF | Thick, strong | Ogre, Viking |\n   642→\n   643→### 4.3 Classification Algorithm\n   644→\n   645→```typescript\n   646→// archetype-classifier.ts\n   647→\n   648→interface ClassificationInput {\n   649→  // From landmarks\n   650→  gonialAngle: number;\n   651→  fwhr: number;\n   652→  browRidgeProminence: number;\n   653→  cheekboneHeight: number;\n   654→  eyeAreaScore: number;\n   655→\n   656→  // Computed\n   657→  dimorphismLevel: DimorphismLevel;\n   658→\n   659→  // From vision (if available)\n   660→  hollowCheeks?: number;\n   661→  skinTone?: string;\n   662→\n   663→  // From physique (if available)\n   664→  bodyType?: BodyType;\n   665→  frameSize?: FrameSize;\n   666→\n   667→  // User input\n   668→  ethnicity: string;\n   669→  gender: 'male' | 'female';\n   670→}\n   671→\n   672→interface ArchetypeResult {\n   673→  primary: {\n   674→    category: string;      // e.g., \"Chad\"\n   675→    subArchetype: string;  // e.g., \"Vampire\"\n   676→    confidence: number;    // 0-1\n   677→  };\n   678→  secondary: {\n   679→    category: string;\n   680→    subArchetype: string;\n   681→    confidence: number;\n   682→  };\n   683→  traits: string[];\n   684→  styleGuide: StyleRecommendation;\n   685→  transitionPath?: {\n   686→    target: string;\n   687→    requirements: string[];\n   688→  };\n   689→}\n   690→\n   691→function classifyArchetype(input: ClassificationInput): ArchetypeResult {\n   692→  const scores: Record<string, number> = {};\n   693→\n   694→  // Score each main category\n   695→  scores.Softboy = scoreSoftboy(input);\n   696→  scores.Prettyboy = scorePrettyboy(input);\n   697→  scores.RobustPrettyboy = scoreRobustPrettyboy(input);\n   698→  scores.Chad = scoreChad(input);\n   699→  scores.Hypermasculine = scoreHypermasculine(input);\n   700→  scores.Ogre = scoreOgre(input);\n   701→\n   702→  // Get top 2 categories\n   703→  const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);\n   704→  const primaryCategory = sorted[0][0];\n   705→  const secondaryCategory = sorted[1][0];\n   706→\n   707→  // Determine sub-archetype within primary\n   708→  const primarySub = classifySubArchetype(primaryCategory, input);\n   709→  const secondarySub = classifySubArchetype(secondaryCategory, input);\n   710→\n   711→  return {\n   712→    primary: {\n   713→      category: primaryCategory,\n   714→      subArchetype: primarySub.name,\n   715→      confidence: sorted[0][1] / 100,\n   716→    },\n   717→    secondary: {\n   718→      category: secondaryCategory,\n   719→      subArchetype: secondarySub.name,\n   720→      confidence: sorted[1][1] / 100,\n   721→    },\n   722→    traits: [...primarySub.traits, ...secondarySub.traits.slice(0, 2)],\n   723→    styleGuide: getStyleGuide(primaryCategory, primarySub.name),\n   724→    transitionPath: getTransitionPath(primaryCategory, sorted),\n   725→  };\n   726→}\n   727→\n   728→function scoreChad(input: ClassificationInput): number {\n   729→  let score = 0;\n   730→\n   731→  // Gonial angle (strong jaw)\n   732→  if (input.gonialAngle <= 120) score += 25;\n   733→  else if (input.gonialAngle <= 125) score += 15;\n   734→\n   735→  // High dimorphism\n   736→  if (input.dimorphismLevel === 'high') score += 25;\n   737→  else if (input.dimorphismLevel === 'above-average') score += 15;\n   738→\n   739→  // Brow ridge\n   740→  if (input.browRidgeProminence >= 7) score += 15;\n   741→\n   742→  // Body type\n   743→  if (input.bodyType === 'mesomorphic') score += 15;\n   744→  else if (input.bodyType === 'ecto-mesomorphic') score += 10;\n   745→\n   746→  // Hollow cheeks (vampire sub-type indicator)\n   747→  if (input.hollowCheeks && input.hollowCheeks >= 7) score += 10;\n   748→\n   749→  // Frame\n   750→  if (input.frameSize === 'large') score += 10;\n   751→\n   752→  return score;\n   753→}\n   754→\n   755→// Similar scoring functions for other categories...\n   756→```\n   757→\n   758→---\n   759→\n   760→## 5. Advice Generation Engine\n   761→\n   762→### 5.1 Advice Categories\n   763→\n   764→1. **Hairstyle Recommendations**\n   765→2. **Skincare Routine**\n   766→3. **Style Guide** (clothing, colors, accessories)\n   767→4. **Grooming Guide** (facial hair, eyebrows, etc.)\n   768→5. **Physique Recommendations**\n   769→6. **Action Plan** (prioritized improvements)\n   770→\n   771→### 5.2 Hairstyle Recommendations\n   772→\n   773→#### Face Shape Detection (from landmarks)\n   774→\n   775→| Face Shape | Characteristics | Detection Criteria |\n   776→|------------|-----------------|-------------------|\n   777→| Oval | Balanced, slightly longer | FWHR 1.4-1.6, cheekbones widest |\n   778→| Round | Wide, soft angles | FWHR > 1.6, minimal jaw definition |\n   779→| Square | Strong jaw, equal width/length | FWHR ≈ 1.5, wide bigonial |\n   780→| Oblong | Long, narrow | FWHR < 1.4, high forehead |\n   781→| Heart | Wide forehead, narrow chin | Wide temples, narrow lower third |\n   782→| Diamond | Narrow forehead/chin, wide cheeks | High cheekbones, narrow bigonial |\n   783→\n   784→#### Hairstyle Database Structure\n   785→\n   786→```json\n   787→{\n   788→  \"hairstyles\": [\n   789→    {\n   790→      \"id\": \"textured-fringe\",\n   791→      \"name\": \"Textured Fringe\",\n   792→      \"description\": \"Layered top with textured fringe covering forehead\",\n   793→      \"face_shapes\": [\"oblong\", \"heart\", \"diamond\"],\n   794→      \"hairline_max_nw\": 2,\n   795→      \"hair_textures\": [\"straight\", \"wavy\"],\n   796→      \"archetypes\": [\"Prettyboy\", \"Softboy\", \"RobustPrettyboy\"],\n   797→      \"maintenance\": \"medium\",\n   798→      \"styling_time\": \"5-10 min\",\n   799→      \"products\": [\"texturizing paste\", \"sea salt spray\"],\n   800→      \"reference_images\": [\"url1\", \"url2\"]\n   801→    },\n   802→    {\n   803→      \"id\": \"slicked-back\",\n   804→      \"name\": \"Slicked Back\",\n   805→      \"description\": \"Hair pushed back with product for clean look\",\n   806→      \"face_shapes\": [\"oval\", \"square\", \"diamond\"],\n   807→      \"hairline_max_nw\": 1,\n   808→      \"hair_textures\": [\"straight\", \"wavy\"],\n   809→      \"archetypes\": [\"Chad\", \"Executive\", \"Prince\"],\n   810→      \"maintenance\": \"low\",\n   811→      \"styling_time\": \"2-5 min\",\n   812→      \"products\": [\"pomade\", \"gel\"],\n   813→      \"reference_images\": [\"url1\", \"url2\"]\n   814→    },\n   815→    {\n   816→      \"id\": \"buzz-cut\",\n   817→      \"name\": \"Buzz Cut\",\n   818→      \"description\": \"Very short all around, low maintenance\",\n   819→      \"face_shapes\": [\"oval\", \"square\"],\n   820→      \"hairline_max_nw\": 7,\n   821→      \"hair_textures\": [\"any\"],\n   822→      \"archetypes\": [\"Hypermasculine\", \"Jock\", \"Ogre\"],\n   823→      \"maintenance\": \"very-low\",\n   824→      \"styling_time\": \"0 min\",\n   825→      \"products\": [],\n   826→      \"reference_images\": [\"url1\", \"url2\"]\n   827→    }\n   828→    // ... more hairstyles\n   829→  ]\n   830→}\n   831→```\n   832→\n   833→#### Recommendation Logic\n   834→\n   835→```typescript\n   836→function recommendHairstyles(\n   837→  faceShape: FaceShape,\n   838→  hairlineNW: number,\n   839→  hairTexture: string,\n   840→  archetype: ArchetypeResult,\n   841→  preferences?: { maintenance?: string }\n   842→): HairstyleRecommendation[] {\n   843→\n   844→  return HAIRSTYLES\n   845→    .filter(h => h.face_shapes.includes(faceShape))\n   846→    .filter(h => h.hairline_max_nw >= hairlineNW)\n   847→    .filter(h => h.hair_textures.includes(hairTexture) || h.hair_textures.includes('any'))\n   848→    .filter(h => h.archetypes.some(a =>\n   849→      a === archetype.primary.category || a === archetype.primary.subArchetype\n   850→    ))\n   851→    .sort((a, b) => {\n   852→      // Prioritize by archetype match strength\n   853→      const aMatch = getArchetypeMatchScore(a, archetype);\n   854→      const bMatch = getArchetypeMatchScore(b, archetype);\n   855→      return bMatch - aMatch;\n   856→    })\n   857→    .slice(0, 5);\n   858→}\n   859→```\n   860→\n   861→### 5.3 Skincare Routine Generation\n   862→\n   863→#### Routine Structure\n   864→\n   865→```typescript\n   866→interface SkincareRoutine {\n   867→  morning: SkincareStep[];\n   868→  evening: SkincareStep[];\n   869→  weekly: SkincareStep[];\n   870→  targetedTreatments: Treatment[];\n   871→}\n   872→\n   873→interface SkincareStep {\n   874→  order: number;\n   875→  type: 'cleanser' | 'toner' | 'serum' | 'moisturizer' | 'sunscreen' | 'treatment';\n   876→  product: {\n   877→    name: string;\n   878→    ingredients: string[];\n   879→    purpose: string;\n   880→  };\n   881→  frequency: 'daily' | 'alternate' | 'weekly';\n   882→  notes?: string;\n   883→}\n   884→```\n   885→\n   886→#### Routine Logic Based on Skin Analysis\n   887→\n   888→```typescript\n   889→function generateSkincareRoutine(skinAnalysis: SkinAnalysis): SkincareRoutine {\n   890→  const routine: SkincareRoutine = {\n   891→    morning: [],\n   892→    evening: [],\n   893→    weekly: [],\n   894→    targetedTreatments: [],\n   895→  };\n   896→\n   897→  // Morning routine (always)\n   898→  routine.morning.push(\n   899→    { order: 1, type: 'cleanser', product: getCleanser(skinAnalysis) },\n   900→    { order: 2, type: 'moisturizer', product: getMoisturizer(skinAnalysis) },\n   901→    { order: 3, type: 'sunscreen', product: { name: 'SPF 50+ Sunscreen', ingredients: ['zinc oxide'], purpose: 'UV protection' } }\n   902→  );\n   903→\n   904→  // Evening routine (always)\n   905→  routine.evening.push(\n   906→    { order: 1, type: 'cleanser', product: getCleanser(skinAnalysis) },\n   907→    { order: 2, type: 'treatment', product: getEveningTreatment(skinAnalysis) },\n   908→    { order: 3, type: 'moisturizer', product: getMoisturizer(skinAnalysis) }\n   909→  );\n   910→\n   911→  // Add targeted treatments based on issues\n   912→  if (skinAnalysis.acne_level !== 'none') {\n   913→    routine.targetedTreatments.push({\n   914→      concern: 'acne',\n   915→      product: 'Benzoyl Peroxide 2.5% or Salicylic Acid 2%',\n   916→      frequency: 'daily',\n   917→      notes: 'Apply to affected areas only'\n   918→    });\n   919→  }\n   920→\n   921→  if (skinAnalysis.acne_scarring !== 'none') {\n   922→    routine.targetedTreatments.push({\n   923→      concern: 'scarring',\n   924→      product: 'Vitamin C Serum (morning) + Retinol (evening)',\n   925→      frequency: 'daily',\n   926→      notes: 'Start retinol slowly, 2x/week then increase'\n   927→    });\n   928→  }\n   929→\n   930→  if (skinAnalysis.under_eye_darkness >= 6) {\n   931→    routine.targetedTreatments.push({\n   932→      concern: 'dark circles',\n   933→      product: 'Caffeine Eye Serum + Vitamin K cream',\n   934→      frequency: 'twice daily',\n   935→      notes: 'Also improve sleep and hydration'\n   936→    });\n   937→  }\n   938→\n   939→  // Weekly treatments\n   940→  if (skinAnalysis.pore_visibility !== 'minimal') {\n   941→    routine.weekly.push({\n   942→      order: 1,\n   943→      type: 'treatment',\n   944→      product: { name: 'Clay Mask', ingredients: ['kaolin', 'bentonite'], purpose: 'Deep pore cleansing' },\n   945→      frequency: 'weekly'\n   946→    });\n   947→  }\n   948→\n   949→  return routine;\n   950→}\n   951→```\n   952→\n   953→### 5.4 Style Guide Generation\n   954→\n   955→```typescript\n   956→interface StyleGuide {\n   957→  archetype: string;\n   958→  subArchetype: string;\n   959→\n   960→  clothing: {\n   961→    essentials: ClothingItem[];\n   962→    fits: string[];\n   963→    avoid: string[];\n   964→  };\n   965→\n   966→  colors: {\n   967→    primary: string[];      // Best colors based on skin tone\n   968→    accent: string[];       // Accent colors\n   969→    avoid: string[];        // Colors to avoid\n   970→  };\n   971→\n   972→  accessories: {\n   973→    recommended: Accessory[];\n   974→    optional: Accessory[];\n   975→  };\n   976→\n   977→  grooming: {\n   978→    facialHair: string;     // Recommendation based on features\n   979→    eyebrows: string;\n   980→    hair: string;           // Reference to hairstyle recs\n   981→  };\n   982→\n   983→  inspirationImages: string[];\n   984→  celebrityReferences: string[];\n   985→}\n   986→\n   987→function generateStyleGuide(\n   988→  archetype: ArchetypeResult,\n   989→  skinTone: string,\n   990→  visionFeatures: VisionFeatures\n   991→): StyleGuide {\n   992→\n   993→  const baseGuide = STYLE_GUIDES[archetype.primary.subArchetype];\n   994→\n   995→  // Customize colors based on skin tone\n   996→  const colors = getColorPalette(skinTone, archetype);\n   997→\n   998→  // Facial hair recommendation\n   999→  const facialHair = recommendFacialHair(\n  1000→    archetype,\n  1001→    visionFeatures.facial_hair_potential,\n  1002→    visionFeatures.hollow_cheeks\n  1003→  );\n  1004→\n  1005→  return {\n  1006→    ...baseGuide,\n  1007→    colors,\n  1008→    grooming: {\n  1009→      facialHair,\n  1010→      eyebrows: recommendEyebrowGrooming(visionFeatures.eyebrow_density),\n  1011→      hair: 'See hairstyle recommendations',\n  1012→    },\n  1013→  };\n  1014→}\n  1015→```\n  1016→\n  1017→### 5.5 Action Plan Generation\n  1018→\n  1019→```typescript\n  1020→interface ActionPlan {\n  1021→  tier: 'foundation' | 'enhancement' | 'advanced';\n  1022→  items: ActionItem[];\n  1023→  estimatedTimeframe: string;\n  1024→  estimatedCost: CostRange;\n  1025→  potentialPSLGain: number;\n  1026→}\n  1027→\n  1028→interface ActionItem {\n  1029→  priority: number;\n  1030→  category: 'skincare' | 'hair' | 'physique' | 'style' | 'dental' | 'surgical';\n  1031→  action: string;\n  1032→  reason: string;\n  1033→  impact: 'high' | 'medium' | 'low';\n  1034→  difficulty: 'easy' | 'medium' | 'hard';\n  1035→  timeframe: string;\n  1036→  cost: CostRange;\n  1037→  linkedFlaw?: string;\n  1038→}\n  1039→\n  1040→function generateActionPlan(\n  1041→  flaws: Flaw[],\n  1042→  strengths: Strength[],\n  1043→  visionFeatures: VisionFeatures,\n  1044→  archetype: ArchetypeResult,\n  1045→  userPreferences: { budget: string; timeline: string }\n  1046→): ActionPlan[] {\n  1047→\n  1048→  const items: ActionItem[] = [];\n  1049→\n  1050→  // 1. Foundation tier (softmaxxing, low cost, high impact)\n  1051→\n  1052→  // Skincare if issues detected\n  1053→  if (visionFeatures.skin.acne_level !== 'none' || visionFeatures.skin.clarity < 7) {\n  1054→    items.push({\n  1055→      priority: 1,\n  1056→      category: 'skincare',\n  1057→      action: 'Establish consistent skincare routine',\n  1058→      reason: `Current skin clarity: ${visionFeatures.skin.clarity}/10`,\n  1059→      impact: 'high',\n  1060→      difficulty: 'easy',\n  1061→      timeframe: '2-4 weeks for visible improvement',\n  1062→      cost: { min: 30, max: 100, currency: 'USD', frequency: 'monthly' },\n  1063→    });\n  1064→  }\n  1065→\n  1066→  // Haircut if not matching archetype\n  1067→  items.push({\n  1068→    priority: 2,\n  1069→    category: 'hair',\n  1070→    action: `Get archetype-matched haircut (${archetype.primary.subArchetype} style)`,\n  1071→    reason: 'Hairstyle should complement face shape and archetype',\n  1072→    impact: 'high',\n  1073→    difficulty: 'easy',\n  1074→    timeframe: 'Immediate',\n  1075→    cost: { min: 20, max: 80, currency: 'USD', frequency: 'monthly' },\n  1076→  });\n  1077→\n  1078→  // Physique if needed\n  1079→  if (visionFeatures.body && visionFeatures.body.body_fat_percent > 18) {\n  1080→    items.push({\n  1081→      priority: 3,\n  1082→      category: 'physique',\n  1083→      action: 'Reduce body fat to 12-15% range',\n  1084→      reason: `Current estimated BF: ${visionFeatures.body.body_fat_percent}%. Lower BF reveals facial definition and hollow cheeks.`,\n  1085→      impact: 'high',\n  1086→      difficulty: 'medium',\n  1087→      timeframe: '3-6 months',\n  1088→      cost: { min: 0, max: 100, currency: 'USD', frequency: 'monthly' },\n  1089→    });\n  1090→  }\n  1091→\n  1092→  // Style update\n  1093→  items.push({\n  1094→    priority: 4,\n  1095→    category: 'style',\n  1096→    action: `Adopt ${archetype.primary.subArchetype} wardrobe essentials`,\n  1097→    reason: 'Clothing should reinforce your natural archetype',\n  1098→    impact: 'medium',\n  1099→    difficulty: 'easy',\n  1100→    timeframe: '1-2 weeks',\n  1101→    cost: { min: 200, max: 500, currency: 'USD', frequency: 'one-time' },\n  1102→  });\n  1103→\n  1104→  // Dental if issues\n  1105→  if (visionFeatures.teeth.color !== 'white') {\n  1106→    items.push({\n  1107→      priority: 5,\n  1108→      category: 'dental',\n  1109→      action: 'Whiten teeth',\n  1110→      reason: `Current tooth color: ${visionFeatures.teeth.color}`,\n  1111→      impact: 'medium',\n  1112→      difficulty: 'easy',\n  1113→      timeframe: '2-4 weeks',\n  1114→      cost: { min: 30, max: 500, currency: 'USD', frequency: 'one-time' },\n  1115→    });\n  1116→  }\n  1117→\n  1118→  // 2. Enhancement tier (from existing flaws)\n  1119→  flaws.forEach((flaw, index) => {\n  1120→    const treatment = findBestTreatment(flaw);\n  1121→    if (treatment && treatment.phase !== 'Surgical') {\n  1122→      items.push({\n  1123→        priority: 10 + index,\n  1124→        category: treatment.category,\n  1125→        action: treatment.name,\n  1126→        reason: flaw.summary,\n  1127→        impact: treatment.impact > 0.5 ? 'high' : 'medium',\n  1128→        difficulty: 'medium',\n  1129→        timeframe: treatment.timeline,\n  1130→        cost: treatment.cost,\n  1131→        linkedFlaw: flaw.id,\n  1132→      });\n  1133→    }\n  1134→  });\n  1135→\n  1136→  // Sort by priority and group into tiers\n  1137→  const sorted = items.sort((a, b) => a.priority - b.priority);\n  1138→\n  1139→  return [\n  1140→    {\n  1141→      tier: 'foundation',\n  1142→      items: sorted.filter(i => i.priority <= 5),\n  1143→      estimatedTimeframe: '1-3 months',\n  1144→      estimatedCost: sumCosts(sorted.filter(i => i.priority <= 5)),\n  1145→      potentialPSLGain: 0.5,\n  1146→    },\n  1147→    {\n  1148→      tier: 'enhancement',\n  1149→      items: sorted.filter(i => i.priority > 5 && i.priority <= 15),\n  1150→      estimatedTimeframe: '3-6 months',\n  1151→      estimatedCost: sumCosts(sorted.filter(i => i.priority > 5 && i.priority <= 15)),\n  1152→      potentialPSLGain: 1.0,\n  1153→    },\n  1154→    {\n  1155→      tier: 'advanced',\n  1156→      items: sorted.filter(i => i.priority > 15),\n  1157→      estimatedTimeframe: '6-12 months',\n  1158→      estimatedCost: sumCosts(sorted.filter(i => i.priority > 15)),\n  1159→      potentialPSLGain: 0.5,\n  1160→    },\n  1161→  ];\n  1162→}\n  1163→```\n  1164→\n  1165→---\n  1166→\n  1167→## 6. Database Schema\n  1168→\n  1169→### 6.1 New Tables\n  1170→\n  1171→```sql\n  1172→-- Enhanced user profile\n  1173→ALTER TABLE users ADD COLUMN IF NOT EXISTS height_cm INTEGER;\n  1174→ALTER TABLE users ADD COLUMN IF NOT EXISTS physique_photo_url TEXT;\n  1175→ALTER TABLE users ADD COLUMN IF NOT EXISTS psl_tier VARCHAR(20);\n  1176→\n  1177→-- Vision extractions (cached AI analysis)\n  1178→CREATE TABLE vision_extractions (\n  1179→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n  1180→    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,\n  1181→    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  1182→\n  1183→    -- Face features\n  1184→    skin_clarity DECIMAL(3,2),\n  1185→    skin_tone VARCHAR(50),\n  1186→    acne_level VARCHAR(20),\n  1187→    acne_scarring VARCHAR(20),\n  1188→    pore_visibility VARCHAR(20),\n  1189→    texture_issues JSONB,\n  1190→\n  1191→    -- Hair features\n  1192→    hairline_nw INTEGER,\n  1193→    hair_density VARCHAR(20),\n  1194→    hair_texture VARCHAR(20),\n  1195→    hair_color VARCHAR(50),\n  1196→\n  1197→    -- Eye features\n  1198→    eye_color VARCHAR(50),\n  1199→    under_eye_darkness DECIMAL(3,2),\n  1200→    under_eye_puffiness DECIMAL(3,2),\n  1201→\n  1202→    -- Facial features\n  1203→    hollow_cheeks DECIMAL(3,2),\n  1204→    eyebrow_density VARCHAR(20),\n  1205→    facial_hair_potential VARCHAR(20),\n  1206→\n  1207→    -- Teeth\n  1208→    teeth_color VARCHAR(20),\n  1209→    teeth_alignment VARCHAR(20),\n  1210→\n  1211→    -- Body (if physique photo provided)\n  1212→    body_fat_percent DECIMAL(4,1),\n  1213→    muscle_mass VARCHAR(20),\n  1214→    frame_size VARCHAR(20),\n  1215→    shoulder_width VARCHAR(20),\n  1216→    waist_definition VARCHAR(20),\n  1217→    posture VARCHAR(20),\n  1218→\n  1219→    -- Metadata\n  1220→    raw_response JSONB,\n  1221→    created_at TIMESTAMP DEFAULT NOW(),\n  1222→\n  1223→    UNIQUE(analysis_id)\n  1224→);\n  1225→\n  1226→-- PSL scores (enhanced)\n  1227→CREATE TABLE psl_scores (\n  1228→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n  1229→    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  1230→    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,\n  1231→\n  1232→    -- Component scores\n  1233→    face_score DECIMAL(4,2) NOT NULL,\n  1234→    height_score DECIMAL(4,2) NOT NULL,\n  1235→    body_score DECIMAL(4,2),\n  1236→\n  1237→    -- Bonuses\n  1238→    threshold_bonus DECIMAL(4,2) DEFAULT 0,\n  1239→    synergy_bonus DECIMAL(4,2) DEFAULT 0,\n  1240→    penalties DECIMAL(4,2) DEFAULT 0,\n  1241→\n  1242→    -- Final\n  1243→    total_score DECIMAL(4,2) NOT NULL,\n  1244→    tier VARCHAR(20) NOT NULL,\n  1245→    percentile DECIMAL(5,2),\n  1246→\n  1247→    -- Potential\n  1248→    potential_score DECIMAL(4,2),\n  1249→\n  1250→    created_at TIMESTAMP DEFAULT NOW(),\n  1251→\n  1252→    UNIQUE(analysis_id)\n  1253→);\n  1254→\n  1255→-- Archetype classifications\n  1256→CREATE TABLE archetype_results (\n  1257→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n  1258→    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  1259→    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,\n  1260→\n  1261→    -- Primary archetype\n  1262→    primary_category VARCHAR(50) NOT NULL,\n  1263→    primary_sub_archetype VARCHAR(50) NOT NULL,\n  1264→    primary_confidence DECIMAL(3,2) NOT NULL,\n  1265→\n  1266→    -- Secondary archetype\n  1267→    secondary_category VARCHAR(50),\n  1268→    secondary_sub_archetype VARCHAR(50),\n  1269→    secondary_confidence DECIMAL(3,2),\n  1270→\n  1271→    -- Details\n  1272→    traits JSONB,\n  1273→    style_guide JSONB,\n  1274→    transition_path JSONB,\n  1275→\n  1276→    created_at TIMESTAMP DEFAULT NOW(),\n  1277→\n  1278→    UNIQUE(analysis_id)\n  1279→);\n  1280→\n  1281→-- Generated advice\n  1282→CREATE TABLE advice_results (\n  1283→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n  1284→    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  1285→    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,\n  1286→\n  1287→    -- Recommendations\n  1288→    hairstyle_recommendations JSONB,\n  1289→    skincare_routine JSONB,\n  1290→    style_guide JSONB,\n  1291→    grooming_guide JSONB,\n  1292→    action_plan JSONB,\n  1293→\n  1294→    -- User preferences used\n  1295→    budget VARCHAR(20),\n  1296→    timeline VARCHAR(20),\n  1297→    goals JSONB,\n  1298→\n  1299→    created_at TIMESTAMP DEFAULT NOW(),\n  1300→\n  1301→    UNIQUE(analysis_id)\n  1302→);\n  1303→\n  1304→-- Indexes\n  1305→CREATE INDEX idx_vision_extractions_analysis ON vision_extractions(analysis_id);\n  1306→CREATE INDEX idx_vision_extractions_user ON vision_extractions(user_id);\n  1307→CREATE INDEX idx_psl_scores_analysis ON psl_scores(analysis_id);\n  1308→CREATE INDEX idx_psl_scores_user ON psl_scores(user_id);\n  1309→CREATE INDEX idx_archetype_results_analysis ON archetype_results(analysis_id);\n  1310→CREATE INDEX idx_advice_results_analysis ON advice_results(analysis_id);\n  1311→```\n  1312→\n  1313→---\n  1314→\n  1315→## 7. API Endpoints\n  1316→\n  1317→### 7.1 PSL Endpoints\n  1318→\n  1319→| Endpoint | Method | Auth | Paid | Description |\n  1320→|----------|--------|------|------|-------------|\n  1321→| `/psl/calculate` | POST | Yes | No | Calculate PSL from face + height |\n  1322→| `/psl/calculate-full` | POST | Yes | Yes | Calculate PSL with AI vision + body |\n  1323→| `/psl/{analysis_id}` | GET | Yes | No | Get stored PSL score |\n  1324→\n  1325→#### POST /psl/calculate\n  1326→```json\n  1327→// Request\n  1328→{\n  1329→  \"analysis_id\": \"uuid\",\n  1330→  \"height_cm\": 180\n  1331→}\n  1332→\n  1333→// Response\n  1334→{\n  1335→  \"score\": 6.75,\n  1336→  \"tier\": \"HTN\",\n  1337→  \"percentile\": 78.5,\n  1338→  \"breakdown\": {\n  1339→    \"face\": { \"raw\": 7.2, \"weighted\": 5.4 },\n  1340→    \"height\": { \"raw\": 7.0, \"weighted\": 1.4 },\n  1341→    \"body\": { \"raw\": 5.0, \"weighted\": 0.25 },\n  1342→    \"bonuses\": { \"threshold\": 0, \"synergy\": 0, \"total\": 0 },\n  1343→    \"penalties\": 0\n  1344→  },\n  1345→  \"potential\": 7.8\n  1346→}\n  1347→```\n  1348→\n  1349→### 7.2 Vision Endpoints (Paid)\n  1350→\n  1351→| Endpoint | Method | Auth | Paid | Description |\n  1352→|----------|--------|------|------|-------------|\n  1353→| `/vision/extract` | POST | Yes | Yes | Extract features from photos |\n  1354→| `/vision/extract-body` | POST | Yes | Yes | Analyze physique photo |\n  1355→| `/vision/{analysis_id}` | GET | Yes | Yes | Get stored vision extraction |\n  1356→\n  1357→#### POST /vision/extract\n  1358→```json\n  1359→// Request\n  1360→{\n  1361→  \"analysis_id\": \"uuid\",\n  1362→  \"include_body\": false\n  1363→}\n  1364→\n  1365→// Response\n  1366→{\n  1367→  \"extraction_id\": \"uuid\",\n  1368→  \"face\": {\n  1369→    \"skin\": {\n  1370→      \"clarity\": 7.5,\n  1371→      \"tone\": \"medium\",\n  1372→      \"acne_level\": \"mild\",\n  1373→      \"acne_scarring\": \"none\",\n  1374→      \"pore_visibility\": \"visible\"\n  1375→    },\n  1376→    \"hair\": {\n  1377→      \"hairline_nw\": 1,\n  1378→      \"density\": \"thick\",\n  1379→      \"texture\": \"wavy\",\n  1380→      \"color\": \"dark-brown\"\n  1381→    },\n  1382→    \"eyes\": {\n  1383→      \"color\": \"brown\",\n  1384→      \"under_eye_darkness\": 4.5,\n  1385→      \"under_eye_puffiness\": 2.0\n  1386→    },\n  1387→    \"facial_features\": {\n  1388→      \"hollow_cheeks\": 6.5,\n  1389→      \"eyebrow_density\": \"thick\",\n  1390→      \"facial_hair_potential\": \"high\"\n  1391→    },\n  1392→    \"teeth\": {\n  1393→      \"color\": \"off-white\",\n  1394→      \"alignment\": \"aligned\"\n  1395→    }\n  1396→  },\n  1397→  \"body\": null\n  1398→}\n  1399→```\n  1400→\n  1401→### 7.3 Archetype Endpoints\n  1402→\n  1403→| Endpoint | Method | Auth | Paid | Description |\n  1404→|----------|--------|------|------|-------------|\n  1405→| `/archetype/classify` | POST | Yes | No* | Classify archetype (enhanced with vision if paid) |\n  1406→| `/archetype/{analysis_id}` | GET | Yes | No | Get stored archetype |\n  1407→| `/archetype/styles` | GET | No | No | Get all style guides |\n  1408→\n  1409→### 7.4 Advice Endpoints (Paid)\n  1410→\n  1411→| Endpoint | Method | Auth | Paid | Description |\n  1412→|----------|--------|------|------|-------------|\n  1413→| `/advice/generate` | POST | Yes | Yes | Generate full advice package |\n  1414→| `/advice/hairstyles` | GET | Yes | Yes | Get hairstyle recommendations |\n  1415→| `/advice/skincare` | GET | Yes | Yes | Get skincare routine |\n  1416→| `/advice/style` | GET | Yes | Yes | Get style guide |\n  1417→| `/advice/action-plan` | GET | Yes | Yes | Get action plan |\n  1418→| `/advice/{analysis_id}` | GET | Yes | Yes | Get all stored advice |\n  1419→\n  1420→#### POST /advice/generate\n  1421→```json\n  1422→// Request\n  1423→{\n  1424→  \"analysis_id\": \"uuid\",\n  1425→  \"preferences\": {\n  1426→    \"budget\": \"medium\",\n  1427→    \"timeline\": \"6mo\",\n  1428→    \"goals\": [\"dating\", \"confidence\"]\n  1429→  }\n  1430→}\n  1431→\n  1432→// Response\n  1433→{\n  1434→  \"advice_id\": \"uuid\",\n  1435→  \"hairstyles\": [...],\n  1436→  \"skincare\": {...},\n  1437→  \"style_guide\": {...},\n  1438→  \"grooming\": {...},\n  1439→  \"action_plan\": [...]\n  1440→}\n  1441→```\n  1442→\n  1443→---\n  1444→\n  1445→## 8. Frontend Components\n  1446→\n  1447→### 8.1 Component Structure\n  1448→\n  1449→```\n  1450→src/components/psl/\n  1451→├── PSLScoreCard.tsx          # Main score display with tier badge\n  1452→├── PSLBreakdown.tsx          # Visual breakdown (face/height/body pie)\n  1453→├── PSLTierBadge.tsx          # Tier icon and name\n  1454→├── PSLComparison.tsx         # Current vs Potential\n  1455→├── PSLUpgradePrompt.tsx      # Prompt to unlock AI vision\n  1456→│\n  1457→├── archetype/\n  1458→│   ├── ArchetypeCard.tsx     # Primary archetype display\n  1459→│   ├── ArchetypeTraits.tsx   # Trait badges\n  1460→│   ├── ArchetypeComparison.tsx # Primary vs Secondary\n  1461→│   └── ArchetypeTransition.tsx # Path to next archetype\n  1462→│\n  1463→├── advice/\n  1464→│   ├── HairstyleRecommendations.tsx  # Hairstyle cards with images\n  1465→│   ├── SkincareRoutine.tsx           # AM/PM routine display\n  1466→│   ├── StyleGuide.tsx                # Clothing/color recommendations\n  1467→│   ├── GroomingGuide.tsx             # Facial hair, brows, etc.\n  1468→│   └── ActionPlan.tsx                # Prioritized improvements\n  1469→│\n  1470→└── shared/\n  1471→    ├── FeatureCard.tsx       # Extracted feature display\n  1472→    ├── ScoreBar.tsx          # Horizontal score visualization\n  1473→    ├── TierIcon.tsx          # Tier-specific icons\n  1474→    └── PaywallOverlay.tsx    # Upgrade prompt overlay\n  1475→```\n  1476→\n  1477→### 8.2 Results Tab Integration\n  1478→\n  1479→```typescript\n  1480→// Add to ResultsLayout.tsx tabs\n  1481→const TABS: TabConfig[] = [\n  1482→  { id: 'overview', label: 'Overview', icon: <LayoutDashboard size={18} /> },\n  1483→  { id: 'front-ratios', label: 'Front Ratios', icon: <User size={18} /> },\n  1484→  { id: 'side-ratios', label: 'Side Ratios', icon: <ScanFace size={18} /> },\n  1485→  { id: 'leaderboard', label: 'Leaderboard', icon: <Trophy size={18} /> },\n  1486→  { id: 'plan', label: 'Your Plan', icon: <Sparkles size={18} /> },\n  1487→  // NEW TABS\n  1488→  { id: 'psl', label: 'PSL Score', icon: <Gauge size={18} />, paid: false },\n  1489→  { id: 'archetype', label: 'Archetype', icon: <Shapes size={18} />, paid: false },\n  1490→  { id: 'advice', label: 'AI Advice', icon: <Lightbulb size={18} />, paid: true },\n  1491→  // EXISTING\n  1492→  { id: 'options', label: 'Options', icon: <Settings size={18} /> },\n  1493→  { id: 'support', label: 'Support', icon: <HelpCircle size={18} /> },\n  1494→];\n  1495→```\n  1496→\n  1497→### 8.3 Key Component: PSLScoreCard\n  1498→\n  1499→```tsx\n  1500→// PSLScoreCard.tsx\n  1501→interface PSLScoreCardProps {\n  1502→  psl: PSLResult;\n  1503→  showBreakdown?: boolean;\n  1504→  showPotential?: boolean;\n  1505→}\n  1506→\n  1507→export function PSLScoreCard({ psl, showBreakdown = true, showPotential = true }: PSLScoreCardProps) {\n  1508→  return (\n  1509→    <div className=\"bg-zinc-900 rounded-xl p-6 border border-zinc-800\">\n  1510→      {/* Header */}\n  1511→      <div className=\"flex items-center justify-between mb-6\">\n  1512→        <h2 className=\"text-xl font-semibold text-white\">PSL Rating</h2>\n  1513→        <PSLTierBadge tier={psl.tier} />\n  1514→      </div>\n  1515→\n  1516→      {/* Main Score */}\n  1517→      <div className=\"flex items-center gap-6 mb-6\">\n  1518→        <div className=\"text-6xl font-bold text-cyan-400\">\n  1519→          {psl.score.toFixed(2)}\n  1520→        </div>\n  1521→        <div className=\"text-zinc-400\">\n  1522→          <div className=\"text-lg\">{psl.tier}</div>\n  1523→          <div className=\"text-sm\">Top {(100 - psl.percentile).toFixed(1)}%</div>\n  1524→        </div>\n  1525→      </div>\n  1526→\n  1527→      {/* Breakdown */}\n  1528→      {showBreakdown && (\n  1529→        <PSLBreakdown breakdown={psl.breakdown} />\n  1530→      )}\n  1531→\n  1532→      {/* Potential */}\n  1533→      {showPotential && psl.potential > psl.score && (\n  1534→        <div className=\"mt-4 pt-4 border-t border-zinc-800\">\n  1535→          <div className=\"flex items-center justify-between text-sm\">\n  1536→            <span className=\"text-zinc-400\">Potential with improvements</span>\n  1537→            <span className=\"text-green-400 font-semibold\">\n  1538→              {psl.potential.toFixed(2)} (+{(psl.potential - psl.score).toFixed(2)})\n  1539→            </span>\n  1540→          </div>\n  1541→        </div>\n  1542→      )}\n  1543→    </div>\n  1544→  );\n  1545→}\n  1546→```\n  1547→\n  1548→### 8.4 Key Component: ArchetypeCard\n  1549→\n  1550→```tsx\n  1551→// ArchetypeCard.tsx\n  1552→interface ArchetypeCardProps {\n  1553→  archetype: ArchetypeResult;\n  1554→  showSecondary?: boolean;\n  1555→  showTransition?: boolean;\n  1556→}\n  1557→\n  1558→export function ArchetypeCard({ archetype, showSecondary = true, showTransition = true }: ArchetypeCardProps) {\n  1559→  return (\n  1560→    <div className=\"bg-zinc-900 rounded-xl p-6 border border-zinc-800\">\n  1561→      {/* Primary Archetype */}\n  1562→      <div className=\"flex items-start gap-4 mb-6\">\n  1563→        <div className=\"w-16 h-16 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center\">\n  1564→          <ArchetypeIcon archetype={archetype.primary.subArchetype} />\n  1565→        </div>\n  1566→        <div>\n  1567→          <div className=\"text-sm text-zinc-400 mb-1\">Your Archetype</div>\n  1568→          <div className=\"text-2xl font-bold text-white\">\n  1569→            {archetype.primary.subArchetype}\n  1570→          </div>\n  1571→          <div className=\"text-sm text-zinc-500\">\n  1572→            {archetype.primary.category} • {(archetype.primary.confidence * 100).toFixed(0)}% match\n  1573→          </div>\n  1574→        </div>\n  1575→      </div>\n  1576→\n  1577→      {/* Traits */}\n  1578→      <div className=\"flex flex-wrap gap-2 mb-6\">\n  1579→        {archetype.traits.map(trait => (\n  1580→          <span key={trait} className=\"px-3 py-1 rounded-full bg-zinc-800 text-zinc-300 text-sm\">\n  1581→            {trait}\n  1582→          </span>\n  1583→        ))}\n  1584→      </div>\n  1585→\n  1586→      {/* Secondary */}\n  1587→      {showSecondary && archetype.secondary && (\n  1588→        <div className=\"p-4 rounded-lg bg-zinc-800/50 mb-4\">\n  1589→          <div className=\"text-sm text-zinc-400 mb-1\">Secondary Match</div>\n  1590→          <div className=\"text-lg text-white\">\n  1591→            {archetype.secondary.subArchetype}\n  1592→            <span className=\"text-zinc-500 text-sm ml-2\">\n  1593→              ({(archetype.secondary.confidence * 100).toFixed(0)}%)\n  1594→            </span>\n  1595→          </div>\n  1596→        </div>\n  1597→      )}\n  1598→\n  1599→      {/* Transition Path */}\n  1600→      {showTransition && archetype.transitionPath && (\n  1601→        <div className=\"p-4 rounded-lg border border-dashed border-zinc-700\">\n  1602→          <div className=\"text-sm text-zinc-400 mb-2\">Transition Potential</div>\n  1603→          <div className=\"flex items-center gap-2\">\n  1604→            <span className=\"text-white\">{archetype.primary.subArchetype}</span>\n  1605→            <ArrowRight className=\"text-zinc-600\" size={16} />\n  1606→            <span className=\"text-cyan-400\">{archetype.transitionPath.target}</span>\n  1607→          </div>\n  1608→          <div className=\"text-xs text-zinc-500 mt-2\">\n  1609→            Requirements: {archetype.transitionPath.requirements.join(', ')}\n  1610→          </div>\n  1611→        </div>\n  1612→      )}\n  1613→    </div>\n  1614→  );\n  1615→}\n  1616→```\n  1617→\n  1618→---\n  1619→\n  1620→## 9. Implementation Phases\n  1621→\n  1622→### Phase 1: PSL Foundation (Week 1)\n  1623→**Priority: Critical**\n  1624→\n  1625→- [ ] Add `height_cm` to users table\n  1626→- [ ] Implement height input in onboarding/results\n  1627→- [ ] Create `psl-calculator.ts` with formula\n  1628→- [ ] Create `PSLScoreCard`, `PSLBreakdown`, `PSLTierBadge` components\n  1629→- [ ] Add PSL tab to results page\n  1630→- [ ] Create `/psl/calculate` endpoint\n  1631→\n  1632→### Phase 2: Archetype System (Week 2)\n  1633→**Priority: High**\n  1634→\n  1635→- [ ] Create `archetypes.json` with full taxonomy\n  1636→- [ ] Implement `archetype-classifier.ts`\n  1637→- [ ] Create `archetype_service.py`\n  1638→- [ ] Create `ArchetypeCard`, `ArchetypeTraits` components\n  1639→- [ ] Add Archetype tab to results page\n  1640→- [ ] Create `/archetype/classify` endpoint\n  1641→\n  1642→### Phase 3: AI Vision Integration (Week 3)\n  1643→**Priority: High - Paid Feature**\n  1644→\n  1645→- [ ] Set up Claude API integration\n  1646→- [ ] Implement `vision_service.py`\n  1647→- [ ] Create `vision_extractions` table\n  1648→- [ ] Create `/vision/extract` endpoint\n  1649→- [ ] Add paywall for AI vision access\n  1650→- [ ] Display extracted features in UI\n  1651→\n  1652→### Phase 4: Advice Engine (Week 4)\n  1653→**Priority: High - Paid Feature**\n  1654→\n  1655→- [ ] Create `hairstyles.json` database\n  1656→- [ ] Create `skincare.json` routines\n  1657→- [ ] Create `style_guides.json`\n  1658→- [ ] Implement `advice_service.py`\n  1659→- [ ] Create advice components (`HairstyleRecommendations`, `SkincareRoutine`, etc.)\n  1660→- [ ] Add Advice tab to results page\n  1661→- [ ] Create `/advice/*` endpoints\n  1662→\n  1663→### Phase 5: Action Plan (Week 5)\n  1664→**Priority: Medium**\n  1665→\n  1666→- [ ] Implement action plan generation logic\n  1667→- [ ] Create `ActionPlan` component\n  1668→- [ ] Integrate with existing recommendations\n  1669→- [ ] Add cost/timeline estimates\n  1670→- [ ] Link flaws to specific actions\n  1671→\n  1672→### Phase 6: Polish & Integration (Week 6)\n  1673→**Priority: Medium**\n  1674→\n  1675→- [ ] End-to-end testing\n  1676→- [ ] Performance optimization\n  1677→- [ ] Caching for AI calls\n  1678→- [ ] Error handling\n  1679→- [ ] Mobile responsiveness\n  1680→- [ ] Analytics integration\n  1681→\n  1682→---\n  1683→\n  1684→## 10. Cost & Pricing\n  1685→\n  1686→### 10.1 API Costs\n  1687→\n  1688→| Service | Cost per Call | Usage |\n  1689→|---------|--------------|-------|\n  1690→| Claude Vision (face) | ~$0.01-0.02 | Per face extraction |\n  1691→| Claude Vision (body) | ~$0.01 | Per body extraction |\n  1692→| Total per user | ~$0.02-0.03 | One-time per analysis |\n  1693→\n  1694→### 10.2 Suggested Pricing Tiers\n  1695→\n  1696→| Feature | Free | Pro ($X/mo) | Premium ($Y/mo) |\n  1697→|---------|------|-------------|-----------------|\n  1698→| Landmark Analysis | ✓ | ✓ | ✓ |\n  1699→| Basic PSL (face + height) | ✓ | ✓ | ✓ |\n  1700→| Archetype (rule-based) | ✓ | ✓ | ✓ |\n  1701→| AI Vision Extraction | ✗ | ✓ | ✓ |\n  1702→| Enhanced PSL (with body) | ✗ | ✓ | ✓ |\n  1703→| Hairstyle Recommendations | ✗ | ✓ | ✓ |\n  1704→| Skincare Routine | ✗ | ✓ | ✓ |\n  1705→| Style Guide | ✗ | ✓ | ✓ |\n  1706→| Action Plan | ✗ | ✓ | ✓ |\n  1707→| Unlimited Re-analyses | ✗ | ✗ | ✓ |\n  1708→\n  1709→### 10.3 Margin Analysis\n  1710→\n  1711→- Cost per paid user: ~$0.03 (one-time AI call)\n  1712→- If user pays $5/month: 99%+ margin\n  1713→- If user pays $20 one-time: 99%+ margin\n  1714→- AI costs are negligible relative to value provided\n  1715→\n  1716→---\n  1717→\n  1718→## Appendix A: Halos & Failos Reference\n  1719→\n  1720→### Halos (Positive Features)\n  1721→\n  1722→| Halo | Detection Method | Impact |\n  1723→|------|------------------|--------|\n  1724→| Hunter Eyes | Landmarks (canthal tilt, deep-set) | High |\n  1725→| Hollow Cheeks | Vision AI | High |\n  1726→| Strong Jawline | Landmarks (gonial angle, bigonial) | High |\n  1727→| Clear Skin | Vision AI | High |\n  1728→| NW0-1 Hairline | Vision AI | Medium |\n  1729→| White Teeth | Vision AI | Medium |\n  1730→| Compact Midface | Landmarks | High |\n  1731→| Dense Eyebrows | Vision AI | Low |\n  1732→| Golden/Tanned Skin | Vision AI | Low |\n  1733→\n  1734→### Failos (Negative Features)\n  1735→\n  1736→| Failo | Detection Method | Severity |\n  1737→|-------|------------------|----------|\n  1738→| Negative Canthal Tilt | Landmarks | Major |\n  1739→| Receding Chin | Landmarks | Major |\n  1740→| Long Philtrum | Landmarks | Moderate |\n  1741→| Severe Acne/Scarring | Vision AI | Major |\n  1742→| Asymmetry | Landmarks | Moderate-Major |\n  1743→| NW3+ Hairline | Vision AI | Moderate |\n  1744→| Scleral Show | Landmarks | Moderate |\n  1745→| Thin Neck | Landmarks/Vision | Minor |\n  1746→| Mouth Breathing Signs | Landmarks | Major |\n  1747→| Narrow Palate | Landmarks | Moderate |\n  1748→\n  1749→---\n  1750→\n  1751→## Appendix B: Celebrity Calibration\n  1752→\n  1753→Use these known ratings for algorithm validation:\n  1754→\n  1755→| Celebrity | Expected PSL | Archetype | Key Features |\n  1756→|-----------|--------------|-----------|--------------|\n  1757→| Francisco Lachowski | 9.0+ | Prettyboy | Perfect harmony, no failos |\n  1758→| Henry Cavill | 8.5-9.0 | Superman Chad | Strong jaw, dimorphism |\n  1759→| Ian Somerhalder | 8.0-8.5 | Vampire Chad | Hunter eyes, hollow cheeks |\n  1760→| Zac Efron (prime) | 8.0-8.5 | Jock Chad | Athletic, symmetrical |\n  1761→| Timothée Chalamet | 7.5-8.0 | Softboy | Harmony, low dimorphism |\n  1762→| Josh Hutcherson | 5.5-6.0 | HTN | Average height limits ceiling |\n  1763→| Average man | 5.0 | MTN | By definition |\n  1764→\n  1765→---\n  1766→\n  1767→## Appendix C: File Paths Summary\n  1768→\n  1769→### Backend (looksmaxx-api)\n  1770→\n  1771→```\n  1772→app/\n  1773→├── services/\n  1774→│   ├── psl_service.py           # NEW\n  1775→│   ├── vision_service.py        # NEW\n  1776→│   ├── archetype_service.py     # NEW\n  1777→│   └── advice_service.py        # NEW\n  1778→├── routers/\n  1779→│   ├── psl.py                   # NEW\n  1780→│   ├── vision.py                # NEW\n  1781→│   └── advice.py                # NEW\n  1782→├── models/\n  1783→│   ├── vision_extraction.py     # NEW\n  1784→│   ├── psl_score.py             # NEW\n  1785→│   ├── archetype_result.py      # NEW\n  1786→│   └── advice_result.py         # NEW\n  1787→└── data/\n  1788→    ├── archetypes.json          # NEW\n  1789→    ├── hairstyles.json          # NEW\n  1790→    ├── skincare.json            # NEW\n  1791→    └── style_guides.json        # NEW\n  1792→```\n  1793→\n  1794→### Frontend (looksmaxx-app)\n  1795→\n  1796→```\n  1797→src/\n  1798→├── components/\n  1799→│   └── psl/                     # NEW (entire folder)\n  1800→├── contexts/\n  1801→│   └── PSLContext.tsx           # NEW\n  1802→├── lib/\n  1803→│   ├── psl-calculator.ts        # NEW\n  1804→│   └── archetype-classifier.ts  # NEW\n  1805→└── types/\n  1806→    └── psl.ts                   # NEW\n  1807→```\n  1808→\n  1809→---\n  1810→\n  1811→*Document Version: 1.0*\n  1812→*Last Updated: 2025-01-XX*\n  1813→*Author: LOOKSMAXX Team*\n  1814→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"66c0f1f7-0afc-414d-973e-ad112480bf0f","timestamp":"2025-12-25T23:22:41.178Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/psl.md","content":"# PSL Enhancement System - Implementation Specification\n\n## Overview\n\nThis document outlines the implementation of an enhanced PSL (Pretty Scale Level) scoring system with AI-powered feature extraction, archetype classification, and personalized advice generation. The AI vision analysis is a **paid feature**.\n\n---\n\n## Table of Contents\n\n1. [System Architecture](#1-system-architecture)\n2. [PSL Scoring Formula](#2-psl-scoring-formula)\n3. [AI Vision Feature Extraction (Paid)](#3-ai-vision-feature-extraction-paid)\n4. [Archetype Classification System](#4-archetype-classification-system)\n5. [Advice Generation Engine](#5-advice-generation-engine)\n6. [Database Schema](#6-database-schema)\n7. [API Endpoints](#7-api-endpoints)\n8. [Frontend Components](#8-frontend-components)\n9. [Implementation Phases](#9-implementation-phases)\n10. [Cost & Pricing](#10-cost--pricing)\n\n---\n\n## 1. System Architecture\n\n### High-Level Flow\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                           USER INPUT                                         │\n├─────────────────────────────────────────────────────────────────────────────┤\n│  FREE TIER                          │  PAID TIER (AI Vision)                │\n│  ├── Gender                         │  ├── All FREE tier data               │\n│  ├── Ethnicity                      │  ├── AI Skin Analysis                 │\n│  ├── Front Photo                    │  ├── AI Hair/Hairline Analysis        │\n│  ├── Side Photo                     │  ├── AI Teeth Analysis                │\n│  └── Height (manual input)          │  ├── AI Hollow Cheeks Detection       │\n│                                      │  ├── AI Eye Color Extraction         │\n│                                      │  ├── Physique Photo (optional)        │\n│                                      │  └── AI Body Composition Analysis     │\n└─────────────────────────────────────────────────────────────────────────────┘\n                                    │\n                                    ▼\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                         PROCESSING PIPELINE                                  │\n├─────────────────────────────────────────────────────────────────────────────┤\n│                                                                              │\n│  STAGE 1: Landmark Analysis (Existing)                                      │\n│  ├── MediaPipe 478 landmarks (client-side)                                  │\n│  ├── InsightFace 106 landmarks (server-side)                                │\n│  └── 70+ facial metrics computed                                            │\n│                                                                              │\n│  STAGE 2: AI Vision Extraction (Paid Only)                                  │\n│  ├── Claude Vision API analyzes photos                                      │\n│  ├── Extracts soft tissue features                                          │\n│  └── Stores in vision_extractions table                                     │\n│                                                                              │\n│  STAGE 3: PSL Calculation                                                   │\n│  ├── Face Score (from landmarks) × 0.75                                     │\n│  ├── Height Score (from input) × 0.20                                       │\n│  ├── Body Score (from AI vision, if available) × 0.05                       │\n│  ├── Apply bonuses and constraints                                          │\n│  └── Classify into tier                                                     │\n│                                                                              │\n│  STAGE 4: Archetype Classification                                          │\n│  ├── Rule-based scoring per archetype                                       │\n│  ├── AI refinement for edge cases (paid)                                    │\n│  └── Sub-archetype determination                                            │\n│                                                                              │\n│  STAGE 5: Advice Generation                                                 │\n│  ├── Hairstyle recommendations (face shape + hairline)                      │\n│  ├── Skincare routine (skin analysis)                                       │\n│  ├── Style guide (archetype-matched)                                        │\n│  └── Prioritized action plan (flaws → fixes)                                │\n│                                                                              │\n└─────────────────────────────────────────────────────────────────────────────┘\n                                    │\n                                    ▼\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                              OUTPUT                                          │\n├─────────────────────────────────────────────────────────────────────────────┤\n│  ├── Enhanced PSL Score (0-10) with tier badge                              │\n│  ├── Score breakdown (Face/Height/Body/Bonuses)                             │\n│  ├── Primary + Secondary Archetype                                          │\n│  ├── Hairstyle Recommendations (3-5 options)                                │\n│  ├── Skincare Routine (AM/PM)                                               │\n│  ├── Style Guide (clothing, colors, accessories)                            │\n│  └── Personalized Action Plan (prioritized by impact)                       │\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n### Service Architecture\n\n```\nlooksmaxx-api/\n├── app/\n│   ├── services/\n│   │   ├── psl_service.py           # PSL calculation with formula\n│   │   ├── vision_service.py        # Claude Vision API integration\n│   │   ├── archetype_service.py     # Archetype classification\n│   │   └── advice_service.py        # Recommendation generation\n│   │\n│   ├── routers/\n│   │   ├── psl.py                   # PSL endpoints\n│   │   ├── vision.py                # AI vision endpoints\n│   │   └── advice.py                # Advice endpoints\n│   │\n│   └── data/\n│       ├── archetypes.json          # Archetype definitions\n│       ├── hairstyles.json          # Hairstyle database\n│       ├── skincare.json            # Skincare routines\n│       └── style_guides.json        # Style recommendations\n\nlooksmaxx-app/\n├── src/\n│   ├── contexts/\n│   │   └── PSLContext.tsx           # Enhanced PSL state\n│   │\n│   ├── components/\n│   │   └── psl/\n│   │       ├── PSLScoreCard.tsx     # Main score display\n│   │       ├── PSLBreakdown.tsx     # Component breakdown\n│   │       ├── TierBadge.tsx        # Tier visualization\n│   │       ├── ArchetypeCard.tsx    # Archetype display\n│   │       ├── HairstyleRecs.tsx    # Hairstyle recommendations\n│   │       ├── SkincareRoutine.tsx  # Skincare display\n│   │       ├── StyleGuide.tsx       # Style recommendations\n│   │       └── ActionPlan.tsx       # Prioritized improvements\n│   │\n│   └── lib/\n│       ├── psl-calculator.ts        # Client-side PSL logic\n│       └── archetype-classifier.ts  # Client-side classification\n```\n\n---\n\n## 2. PSL Scoring Formula\n\n### 2.1 Base Formula\n\n```\nPSL_Score = (Face × 0.75) + (Height × 0.20) + (Body × 0.05) + Bonuses\n```\n\nWhere:\n- **Face** = Harmony score from landmark analysis (0-10)\n- **Height** = Height rating from lookup table (0-10)\n- **Body** = Body composition score from AI vision (0-10), defaults to 5.0 if not available\n- **Bonuses** = Threshold and synergy bonuses (0-0.85 max)\n\n### 2.2 Height Rating Table\n\n| Height (Male) | Rating | Height (Female) | Rating |\n|---------------|--------|-----------------|--------|\n| < 5'3\" (160cm) | 1.0 | < 4'11\" (150cm) | 1.0 |\n| 5'3\" (160cm) | 2.0 | 4'11\" (150cm) | 2.0 |\n| 5'5\" (165cm) | 3.0 | 5'1\" (155cm) | 3.5 |\n| 5'7\" (170cm) | 4.0 | 5'3\" (160cm) | 5.0 |\n| 5'9\" (175cm) | 5.0 | 5'5\" (165cm) | 6.0 |\n| 5'10\" (178cm) | 5.5 | 5'6\" (168cm) | 6.5 |\n| 5'11\" (180cm) | 6.0 | 5'7\" (170cm) | 7.0 |\n| 6'0\" (183cm) | 7.0 | 5'8\" (173cm) | 7.5 |\n| 6'1\" (185cm) | 7.5 | 5'9\" (175cm) | 8.0 |\n| 6'2\" (188cm) | 8.0 | 5'10\" (178cm) | 8.5 |\n| 6'3\" (190cm) | 8.5 | 5'11\" (180cm) | 9.0 |\n| 6'4\" (193cm) | 9.0 | 6'0\"+ (183cm+) | 9.0 (cap) |\n| 6'5\"+ (196cm+) | 9.5 (diminishing) | - | - |\n\n### 2.3 Body Rating Scale\n\n| Body Fat % | Muscle Level | Rating | Description |\n|------------|--------------|--------|-------------|\n| 25%+ | Low | 2.0-3.0 | Overweight, no definition |\n| 20-25% | Low | 3.5-4.5 | Soft, minimal definition |\n| 18-22% | Medium | 5.0-5.5 | Average, some definition |\n| 15-18% | Medium | 6.0-6.5 | Lean, visible abs starting |\n| 12-15% | Medium-High | 7.0-7.5 | Athletic, clear definition |\n| 10-12% | High | 8.0-8.5 | Shredded, competition lean |\n| 8-10% | Very High | 9.0-9.5 | Elite physique |\n| < 8% | Extreme | 9.5+ | IFBB Pro tier |\n\n### 2.4 Bonus System\n\n#### Threshold Bonuses (when category ≥ 8.5)\n| Category | Bonus |\n|----------|-------|\n| Face ≥ 8.5 | +0.30 |\n| Height ≥ 8.5 | +0.20 |\n| Body ≥ 8.5 | +0.10 |\n\n#### Synergy Bonuses (when multiple categories ≥ 8.5)\n| Combination | Additional Bonus |\n|-------------|------------------|\n| Face + Height ≥ 8.5 | +0.15 |\n| Face + Body ≥ 8.5 | +0.10 |\n| Height + Body ≥ 8.5 | +0.05 |\n\n#### Triple Synergy (all three ≥ 8.5)\n- **+0.35** flat bonus (replaces pair bonuses, stacks with threshold bonuses)\n\n### 2.5 Constraints (Failos)\n\n| Constraint | Effect |\n|------------|--------|\n| Major facial failo present | Caps tier regardless of score |\n| Body < 5.0 | -0.3 to face perception |\n| Height < 8.0 rating | Cannot reach Gigachad tier |\n| Severe asymmetry | -0.5 penalty |\n\n### 2.6 Tier Classification\n\n| Tier | Score Range | Percentile | Description |\n|------|-------------|------------|-------------|\n| Deformity | 0.0 - 1.0 | Bottom 0.01% | Medical intervention territory |\n| Subhuman | 1.25 - 1.75 | Bottom 0.1% | Genetic outlier |\n| Incel | 2.0 - 3.0 | Bottom 2.5% | Visibly below average |\n| LTN (Low Tier Normie) | 3.5 - 4.5 | Bottom 13.59% | Somewhat unattractive |\n| MTN (Mid Tier Normie) | 4.75 - 5.25 | Middle 68% | True average |\n| HTN (High Tier Normie) | 5.5 - 6.5 | Top 13.59% | Somewhat attractive |\n| Chadlite | 7.0 - 8.0 | Top 2.5% | Attractive, local star |\n| Chad | 8.25 - 8.75 | Top 0.1% | Very attractive, elite |\n| Gigachad | 9.0 - 9.5 | Top 0.01% | Mythical tier |\n| True Mogger | 9.5+ | Apex | Theoretical limit |\n\n### 2.7 Implementation\n\n```typescript\n// psl-calculator.ts\n\ninterface PSLInput {\n  faceScore: number;        // 0-10 from harmony analysis\n  heightCm: number;         // User input\n  gender: 'male' | 'female';\n  bodyAnalysis?: {          // From AI vision (paid)\n    bodyFatPercent: number;\n    muscleLevel: 'low' | 'medium' | 'medium-high' | 'high' | 'very-high' | 'extreme';\n  };\n  failos?: string[];        // Detected major failos\n}\n\ninterface PSLResult {\n  score: number;            // Final PSL 0-10\n  tier: string;             // Tier name\n  percentile: number;       // Population percentile\n  breakdown: {\n    face: { raw: number; weighted: number };\n    height: { raw: number; weighted: number };\n    body: { raw: number; weighted: number };\n    bonuses: { threshold: number; synergy: number; total: number };\n    penalties: number;\n  };\n  potential: number;        // Estimated max with improvements\n}\n\nfunction calculatePSL(input: PSLInput): PSLResult {\n  // 1. Get height rating\n  const heightRating = getHeightRating(input.heightCm, input.gender);\n\n  // 2. Get body rating (default 5.0 if not available)\n  const bodyRating = input.bodyAnalysis\n    ? getBodyRating(input.bodyAnalysis.bodyFatPercent, input.bodyAnalysis.muscleLevel)\n    : 5.0;\n\n  // 3. Calculate base score\n  const faceWeighted = input.faceScore * 0.75;\n  const heightWeighted = heightRating * 0.20;\n  const bodyWeighted = bodyRating * 0.05;\n  let baseScore = faceWeighted + heightWeighted + bodyWeighted;\n\n  // 4. Calculate bonuses\n  let thresholdBonus = 0;\n  let synergyBonus = 0;\n\n  if (input.faceScore >= 8.5) thresholdBonus += 0.30;\n  if (heightRating >= 8.5) thresholdBonus += 0.20;\n  if (bodyRating >= 8.5) thresholdBonus += 0.10;\n\n  const highCount = [input.faceScore, heightRating, bodyRating].filter(s => s >= 8.5).length;\n\n  if (highCount === 3) {\n    synergyBonus = 0.35; // Triple synergy replaces pairs\n  } else if (highCount === 2) {\n    if (input.faceScore >= 8.5 && heightRating >= 8.5) synergyBonus += 0.15;\n    if (input.faceScore >= 8.5 && bodyRating >= 8.5) synergyBonus += 0.10;\n    if (heightRating >= 8.5 && bodyRating >= 8.5) synergyBonus += 0.05;\n  }\n\n  // 5. Apply penalties\n  let penalties = 0;\n  if (bodyRating < 5.0) penalties += 0.3;\n  if (input.failos?.includes('severe_asymmetry')) penalties += 0.5;\n\n  // 6. Final score\n  const finalScore = Math.min(10, Math.max(0, baseScore + thresholdBonus + synergyBonus - penalties));\n\n  // 7. Classify tier (with constraints)\n  const tier = classifyTier(finalScore, heightRating, input.failos);\n\n  return {\n    score: Math.round(finalScore * 100) / 100,\n    tier: tier.name,\n    percentile: tier.percentile,\n    breakdown: {\n      face: { raw: input.faceScore, weighted: faceWeighted },\n      height: { raw: heightRating, weighted: heightWeighted },\n      body: { raw: bodyRating, weighted: bodyWeighted },\n      bonuses: { threshold: thresholdBonus, synergy: synergyBonus, total: thresholdBonus + synergyBonus },\n      penalties,\n    },\n    potential: estimatePotential(input),\n  };\n}\n```\n\n---\n\n## 3. AI Vision Feature Extraction (Paid)\n\n### 3.1 Features Extracted\n\n#### From Face Photos\n\n| Feature | Scale | Description | Used For |\n|---------|-------|-------------|----------|\n| **Skin Clarity** | 0-10 | Overall skin quality | Skincare recommendations |\n| **Skin Tone** | Category | pale/fair/medium/olive/tan/dark | Style color matching |\n| **Acne Level** | none/mild/moderate/severe | Current breakout status | Skincare priority |\n| **Acne Scarring** | none/mild/moderate/severe | Historical scarring | Treatment recommendations |\n| **Pore Visibility** | minimal/visible/prominent | Pore size assessment | Skincare routine |\n| **Texture Issues** | list | Roughness, bumps, etc. | Targeted treatments |\n| **Hairline NW** | 0-7 | Norwood scale classification | Hairstyle recommendations |\n| **Hair Density** | thin/medium/thick | Hair thickness | Hairstyle options |\n| **Hair Texture** | straight/wavy/curly/coily | Natural texture | Styling recommendations |\n| **Hair Color** | Category | Natural color classification | Style matching |\n| **Eye Color** | Category | Iris color | Style color matching |\n| **Under-eye Darkness** | 0-10 | Dark circle severity | Skincare/concealer advice |\n| **Under-eye Puffiness** | 0-10 | Bag severity | Lifestyle recommendations |\n| **Hollow Cheeks** | 0-10 | Buccal fat assessment | Leanness indicator |\n| **Teeth Color** | white/off-white/yellow/stained | Tooth shade | Whitening recommendations |\n| **Teeth Alignment** | aligned/minor-issues/crooked | Orthodontic status | Treatment options |\n| **Eyebrow Density** | sparse/medium/thick | Brow fullness | Grooming advice |\n| **Facial Hair Potential** | low/medium/high | Beard growth capability | Style recommendations |\n\n#### From Physique Photo (Optional)\n\n| Feature | Scale | Description | Used For |\n|---------|-------|-------------|----------|\n| **Body Fat %** | 5-40% | Estimated body fat | Body score calculation |\n| **Muscle Mass** | low/medium/medium-high/high/very-high | Muscularity | Body score, archetype |\n| **Frame Size** | small/medium/large/very-large | Skeletal frame | Archetype classification |\n| **Shoulder Width** | narrow/average/broad/very-broad | Shoulder assessment | Style recommendations |\n| **Waist Definition** | undefined/slight/defined/very-defined | V-taper indicator | Physique score |\n| **Posture** | poor/fair/good/excellent | Standing posture | Improvement advice |\n\n### 3.2 Claude Vision Implementation\n\n```python\n# vision_service.py\n\nimport anthropic\nfrom typing import Optional\nimport base64\n\nclass VisionService:\n    def __init__(self):\n        self.client = anthropic.Anthropic()\n        self.model = \"claude-sonnet-4-20250514\"\n\n    async def extract_features(\n        self,\n        front_photo_url: str,\n        side_photo_url: Optional[str] = None,\n        physique_photo_url: Optional[str] = None\n    ) -> VisionExtractionResult:\n\n        # Prepare images\n        images = [{\"type\": \"image\", \"source\": {\"type\": \"url\", \"url\": front_photo_url}}]\n        if side_photo_url:\n            images.append({\"type\": \"image\", \"source\": {\"type\": \"url\", \"url\": side_photo_url}})\n\n        # Face analysis prompt\n        face_prompt = \"\"\"Analyze this face photo and extract the following features.\n        Return a JSON object with these exact keys:\n\n        {\n          \"skin\": {\n            \"clarity\": <0-10 score>,\n            \"tone\": \"<pale|fair|medium|olive|tan|dark>\",\n            \"acne_level\": \"<none|mild|moderate|severe>\",\n            \"acne_scarring\": \"<none|mild|moderate|severe>\",\n            \"pore_visibility\": \"<minimal|visible|prominent>\",\n            \"texture_issues\": [\"<list of issues>\"]\n          },\n          \"hair\": {\n            \"hairline_nw\": <0-7 Norwood scale>,\n            \"density\": \"<thin|medium|thick>\",\n            \"texture\": \"<straight|wavy|curly|coily>\",\n            \"color\": \"<blonde|light-brown|brown|dark-brown|black|red|gray>\"\n          },\n          \"eyes\": {\n            \"color\": \"<blue|green|hazel|brown|dark-brown|black>\",\n            \"under_eye_darkness\": <0-10>,\n            \"under_eye_puffiness\": <0-10>\n          },\n          \"facial_features\": {\n            \"hollow_cheeks\": <0-10>,\n            \"eyebrow_density\": \"<sparse|medium|thick>\",\n            \"facial_hair_potential\": \"<low|medium|high>\"\n          },\n          \"teeth\": {\n            \"color\": \"<white|off-white|yellow|stained>\",\n            \"alignment\": \"<aligned|minor-issues|crooked>\",\n            \"visible_in_photo\": <boolean>\n          }\n        }\n\n        Be objective and accurate. If a feature cannot be determined from the photo, use null.\n        \"\"\"\n\n        response = await self.client.messages.create(\n            model=self.model,\n            max_tokens=1024,\n            messages=[{\n                \"role\": \"user\",\n                \"content\": [*images, {\"type\": \"text\", \"text\": face_prompt}]\n            }]\n        )\n\n        face_features = parse_json_response(response.content[0].text)\n\n        # Body analysis if physique photo provided\n        body_features = None\n        if physique_photo_url:\n            body_features = await self._analyze_physique(physique_photo_url)\n\n        return VisionExtractionResult(\n            face=face_features,\n            body=body_features\n        )\n\n    async def _analyze_physique(self, photo_url: str) -> BodyAnalysis:\n        body_prompt = \"\"\"Analyze this physique photo and extract:\n\n        {\n          \"body_fat_percent\": <estimated 5-40%>,\n          \"muscle_mass\": \"<low|medium|medium-high|high|very-high>\",\n          \"frame_size\": \"<small|medium|large|very-large>\",\n          \"shoulder_width\": \"<narrow|average|broad|very-broad>\",\n          \"waist_definition\": \"<undefined|slight|defined|very-defined>\",\n          \"posture\": \"<poor|fair|good|excellent>\",\n          \"estimated_height_category\": \"<short|average|tall|very-tall>\"\n        }\n\n        Be objective. Base body fat estimate on visible definition and vascularity.\n        \"\"\"\n\n        response = await self.client.messages.create(\n            model=self.model,\n            max_tokens=512,\n            messages=[{\n                \"role\": \"user\",\n                \"content\": [\n                    {\"type\": \"image\", \"source\": {\"type\": \"url\", \"url\": photo_url}},\n                    {\"type\": \"text\", \"text\": body_prompt}\n                ]\n            }]\n        )\n\n        return parse_json_response(response.content[0].text)\n```\n\n### 3.3 Caching Strategy\n\n- Vision extractions are cached per analysis ID\n- Cache invalidated if photos are updated\n- Results stored in `vision_extractions` table\n- TTL: Permanent (until analysis deleted)\n\n---\n\n## 4. Archetype Classification System\n\n### 4.1 Archetype Taxonomy\n\n```\nARCHETYPES\n├── SOFTBOY (Low Dimorphism, Ectomorphic)\n│   ├── K-Pop Idol\n│   │   ├── Traits: East/SE Asian, flat midface, clear skin, styled hair\n│   │   ├── Style: Slim tailored, high contrast colors, layered hair\n│   │   └── Examples: BTS members, K-drama actors\n│   │\n│   ├── Softboy\n│   │   ├── Traits: Youthful, delicate features, slim build\n│   │   ├── Style: Oversized fits, light colors, long hair\n│   │   └── Examples: Timothée Chalamet, young Leonardo DiCaprio\n│   │\n│   └── Academic\n│       ├── Traits: Intellectual look, refined, understated\n│       ├── Style: Preppy, glasses, earth tones\n│       └── Examples: Young Hugh Grant\n│\n├── PRETTYBOY (Balanced Dimorphism, Good Harmony)\n│   ├── Skater\n│   │   ├── Traits: Casual cool, athletic lean, relaxed\n│   │   ├── Style: Streetwear, baggy pants, sneakers\n│   │   └── Examples: Young Heath Ledger\n│   │\n│   ├── Prettyboy\n│   │   ├── Traits: Symmetrical, harmonious, classic beauty\n│   │   ├── Style: Clean, fitted, minimal\n│   │   └── Examples: Francisco Lachowski, Sean O'Pry\n│   │\n│   └── Surfer\n│       ├── Traits: Sun-kissed, athletic, carefree\n│       ├── Style: Beach casual, natural fabrics\n│       └── Examples: Young Chris Hemsworth\n│\n├── ROBUST PRETTYBOY (Pretty + Edge/Intensity)\n│   ├── Fallen Angel\n│   │   ├── Traits: Ethereal, intense, mysterious\n│   │   ├── Style: Dark romantic, leather, black\n│   │   └── Examples: Young Jared Leto, Jordan Barrett\n│   │\n│   ├── Prince\n│   │   ├── Traits: Regal, refined, elegant\n│   │   ├── Style: Tailored suits, classic elegance\n│   │   └── Examples: Young Alain Delon, Matt Bomer\n│   │\n│   ├── Bad Boy\n│   │   ├── Traits: Rebellious, smoldering, dangerous appeal\n│   │   ├── Style: Leather jackets, boots, rough edges\n│   │   └── Examples: James Dean, Young Johnny Depp\n│   │\n│   └── Artist\n│       ├── Traits: Creative, unconventional, magnetic\n│       ├── Style: Eclectic, statement pieces\n│       └── Examples: Harry Styles, Zayn Malik\n│\n├── CHAD (High Dimorphism, Strong Features)\n│   ├── Vampire\n│   │   ├── Traits: Sharp features, pale, mysterious, hollow cheeks\n│   │   ├── Style: Dark, sophisticated, elegant\n│   │   └── Examples: Robert Pattinson, Ian Somerhalder\n│   │\n│   ├── Superman\n│   │   ├── Traits: Heroic, strong jaw, broad build, classic handsome\n│   │   ├── Style: Classic American, clean-cut\n│   │   └── Examples: Henry Cavill, David Gandy\n│   │\n│   ├── Jock\n│   │   ├── Traits: Athletic, confident, dominant presence\n│   │   ├── Style: Athletic wear, casual sporty\n│   │   └── Examples: Chris Evans, Michael B. Jordan\n│   │\n│   ├── Casanova\n│   │   ├── Traits: Charming, seductive, smooth\n│   │   ├── Style: Tailored, sophisticated, European\n│   │   └── Examples: George Clooney, Pierce Brosnan\n│   │\n│   ├── Executive\n│   │   ├── Traits: Powerful, authoritative, successful look\n│   │   ├── Style: Power suits, luxury watches\n│   │   └── Examples: Jon Hamm, Gabriel Macht\n│   │\n│   └── Pharaoh\n│       ├── Traits: Exotic, regal, chiseled, Middle Eastern features\n│       ├── Style: Luxurious, gold accents, designer\n│       └── Examples: Fares Fares, Egyptian models\n│\n├── HYPERMASCULINE (Extreme Masculine Features)\n│   ├── Aquaman\n│   │   ├── Traits: Tall, muscular, long hair, rugged handsome\n│   │   ├── Style: Relaxed, bohemian, natural fabrics\n│   │   └── Examples: Jason Momoa, Thor-era Chris Hemsworth\n│   │\n│   ├── Hypermasculine\n│   │   ├── Traits: Extreme bone structure, heavy brow, dominant\n│   │   ├── Style: Minimalist, masculine basics\n│   │   └── Examples: Dolph Lundgren (prime), Michael Fassbender\n│   │\n│   ├── Outlaw\n│   │   ├── Traits: Rough, weathered, dangerous\n│   │   ├── Style: Leather, denim, boots, rugged\n│   │   └── Examples: Young Clint Eastwood, Josh Brolin\n│   │\n│   └── Countryman\n│       ├── Traits: Rugged, outdoorsy, strong silent\n│       ├── Style: Workwear, flannel, boots\n│       └── Examples: Yellowstone cast, Young Sam Elliott\n│\n└── OGRE (Maximum Size/Mass)\n    ├── Viking\n    │   ├── Traits: Massive, bearded, warrior look, Norse features\n    │   ├── Style: Rugged, fur, leather, minimalist\n    │   └── Examples: Hafþór Björnsson, Alexander Skarsgård (Northman)\n    │\n    └── Bodybuilder\n        ├── Traits: Extreme muscle, massive frame, imposing\n        ├── Style: Fitted to show physique, tank tops\n        └── Examples: Arnold Schwarzenegger (prime), Dwayne Johnson\n```\n\n### 4.2 Classification Criteria\n\n#### Input Features for Classification\n\n| Feature | Source | Weight |\n|---------|--------|--------|\n| Gonial Angle | Landmarks | High |\n| Facial Width/Height Ratio | Landmarks | High |\n| Brow Ridge Prominence | Landmarks + Vision | Medium |\n| Cheekbone Height | Landmarks | Medium |\n| Eye Area Score | Landmarks | Medium |\n| Dimorphism Level | Computed | High |\n| Body Type | Vision (physique) | Medium |\n| Frame Size | Vision | Medium |\n| Ethnicity | User input | Medium |\n| Hollow Cheeks | Vision | Low |\n| Skin Tone | Vision | Low |\n\n#### Dimorphism Classification\n\n| Level | Gonial Angle | Brow Ridge | Jaw Definition | Features |\n|-------|--------------|------------|----------------|----------|\n| Low | ≥ 130° | Minimal | Soft, undefined | Neotenous, youthful |\n| Low-Balanced | 125-130° | Slight | Harmonious soft | Balanced but softer |\n| Balanced | 118-125° | Moderate | Neutral | Neither masc nor fem |\n| Above-Average | 115-120° | Moderate+ | Defined | Leaning masculine |\n| High | 110-118° | Prominent | Very defined | Strongly masculine |\n| Very High | < 110° | Heavy | Extremely defined | Hypermasculine |\n\n#### Body Type Classification\n\n| Type | Shoulder-Waist Ratio | Build | Archetype Fit |\n|------|---------------------|-------|---------------|\n| Ectomorphic | < 1.35 | Slim, lean | Softboy, Prettyboy |\n| Ecto-Mesomorphic | 1.35-1.45 | Lean athletic | Robust Prettyboy, Vampire Chad |\n| Mesomorphic | 1.45-1.55 | Athletic | Chad, Jock |\n| Endo-Mesomorphic | > 1.55, high muscle | Muscular large | Hypermasculine, Aquaman |\n| Meso-Endomorphic | > 1.45, higher BF | Thick, strong | Ogre, Viking |\n\n### 4.3 Classification Algorithm\n\n```typescript\n// archetype-classifier.ts\n\ninterface ClassificationInput {\n  // From landmarks\n  gonialAngle: number;\n  fwhr: number;\n  browRidgeProminence: number;\n  cheekboneHeight: number;\n  eyeAreaScore: number;\n\n  // Computed\n  dimorphismLevel: DimorphismLevel;\n\n  // From vision (if available)\n  hollowCheeks?: number;\n  skinTone?: string;\n\n  // From physique (if available)\n  bodyType?: BodyType;\n  frameSize?: FrameSize;\n\n  // User input\n  ethnicity: string;\n  gender: 'male' | 'female';\n}\n\ninterface ArchetypeResult {\n  primary: {\n    category: string;      // e.g., \"Chad\"\n    subArchetype: string;  // e.g., \"Vampire\"\n    confidence: number;    // 0-1\n  };\n  secondary: {\n    category: string;\n    subArchetype: string;\n    confidence: number;\n  };\n  traits: string[];\n  styleGuide: StyleRecommendation;\n  transitionPath?: {\n    target: string;\n    requirements: string[];\n  };\n}\n\nfunction classifyArchetype(input: ClassificationInput): ArchetypeResult {\n  const scores: Record<string, number> = {};\n\n  // Score each main category\n  scores.Softboy = scoreSoftboy(input);\n  scores.Prettyboy = scorePrettyboy(input);\n  scores.RobustPrettyboy = scoreRobustPrettyboy(input);\n  scores.Chad = scoreChad(input);\n  scores.Hypermasculine = scoreHypermasculine(input);\n  scores.Ogre = scoreOgre(input);\n\n  // Get top 2 categories\n  const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);\n  const primaryCategory = sorted[0][0];\n  const secondaryCategory = sorted[1][0];\n\n  // Determine sub-archetype within primary\n  const primarySub = classifySubArchetype(primaryCategory, input);\n  const secondarySub = classifySubArchetype(secondaryCategory, input);\n\n  return {\n    primary: {\n      category: primaryCategory,\n      subArchetype: primarySub.name,\n      confidence: sorted[0][1] / 100,\n    },\n    secondary: {\n      category: secondaryCategory,\n      subArchetype: secondarySub.name,\n      confidence: sorted[1][1] / 100,\n    },\n    traits: [...primarySub.traits, ...secondarySub.traits.slice(0, 2)],\n    styleGuide: getStyleGuide(primaryCategory, primarySub.name),\n    transitionPath: getTransitionPath(primaryCategory, sorted),\n  };\n}\n\nfunction scoreChad(input: ClassificationInput): number {\n  let score = 0;\n\n  // Gonial angle (strong jaw)\n  if (input.gonialAngle <= 120) score += 25;\n  else if (input.gonialAngle <= 125) score += 15;\n\n  // High dimorphism\n  if (input.dimorphismLevel === 'high') score += 25;\n  else if (input.dimorphismLevel === 'above-average') score += 15;\n\n  // Brow ridge\n  if (input.browRidgeProminence >= 7) score += 15;\n\n  // Body type\n  if (input.bodyType === 'mesomorphic') score += 15;\n  else if (input.bodyType === 'ecto-mesomorphic') score += 10;\n\n  // Hollow cheeks (vampire sub-type indicator)\n  if (input.hollowCheeks && input.hollowCheeks >= 7) score += 10;\n\n  // Frame\n  if (input.frameSize === 'large') score += 10;\n\n  return score;\n}\n\n// Similar scoring functions for other categories...\n```\n\n---\n\n## 5. Advice Generation Engine\n\n### 5.1 Advice Categories\n\n1. **Hairstyle Recommendations**\n2. **Skincare Routine**\n3. **Style Guide** (clothing, colors, accessories)\n4. **Grooming Guide** (facial hair, eyebrows, etc.)\n5. **Physique Recommendations**\n6. **Action Plan** (prioritized improvements)\n\n### 5.2 Hairstyle Recommendations\n\n#### Face Shape Detection (from landmarks)\n\n| Face Shape | Characteristics | Detection Criteria |\n|------------|-----------------|-------------------|\n| Oval | Balanced, slightly longer | FWHR 1.4-1.6, cheekbones widest |\n| Round | Wide, soft angles | FWHR > 1.6, minimal jaw definition |\n| Square | Strong jaw, equal width/length | FWHR ≈ 1.5, wide bigonial |\n| Oblong | Long, narrow | FWHR < 1.4, high forehead |\n| Heart | Wide forehead, narrow chin | Wide temples, narrow lower third |\n| Diamond | Narrow forehead/chin, wide cheeks | High cheekbones, narrow bigonial |\n\n#### Hairstyle Database Structure\n\n```json\n{\n  \"hairstyles\": [\n    {\n      \"id\": \"textured-fringe\",\n      \"name\": \"Textured Fringe\",\n      \"description\": \"Layered top with textured fringe covering forehead\",\n      \"face_shapes\": [\"oblong\", \"heart\", \"diamond\"],\n      \"hairline_max_nw\": 2,\n      \"hair_textures\": [\"straight\", \"wavy\"],\n      \"archetypes\": [\"Prettyboy\", \"Softboy\", \"RobustPrettyboy\"],\n      \"maintenance\": \"medium\",\n      \"styling_time\": \"5-10 min\",\n      \"products\": [\"texturizing paste\", \"sea salt spray\"],\n      \"reference_images\": [\"url1\", \"url2\"]\n    },\n    {\n      \"id\": \"slicked-back\",\n      \"name\": \"Slicked Back\",\n      \"description\": \"Hair pushed back with product for clean look\",\n      \"face_shapes\": [\"oval\", \"square\", \"diamond\"],\n      \"hairline_max_nw\": 1,\n      \"hair_textures\": [\"straight\", \"wavy\"],\n      \"archetypes\": [\"Chad\", \"Executive\", \"Prince\"],\n      \"maintenance\": \"low\",\n      \"styling_time\": \"2-5 min\",\n      \"products\": [\"pomade\", \"gel\"],\n      \"reference_images\": [\"url1\", \"url2\"]\n    },\n    {\n      \"id\": \"buzz-cut\",\n      \"name\": \"Buzz Cut\",\n      \"description\": \"Very short all around, low maintenance\",\n      \"face_shapes\": [\"oval\", \"square\"],\n      \"hairline_max_nw\": 7,\n      \"hair_textures\": [\"any\"],\n      \"archetypes\": [\"Hypermasculine\", \"Jock\", \"Ogre\"],\n      \"maintenance\": \"very-low\",\n      \"styling_time\": \"0 min\",\n      \"products\": [],\n      \"reference_images\": [\"url1\", \"url2\"]\n    }\n    // ... more hairstyles\n  ]\n}\n```\n\n#### Recommendation Logic\n\n```typescript\nfunction recommendHairstyles(\n  faceShape: FaceShape,\n  hairlineNW: number,\n  hairTexture: string,\n  archetype: ArchetypeResult,\n  preferences?: { maintenance?: string }\n): HairstyleRecommendation[] {\n\n  return HAIRSTYLES\n    .filter(h => h.face_shapes.includes(faceShape))\n    .filter(h => h.hairline_max_nw >= hairlineNW)\n    .filter(h => h.hair_textures.includes(hairTexture) || h.hair_textures.includes('any'))\n    .filter(h => h.archetypes.some(a =>\n      a === archetype.primary.category || a === archetype.primary.subArchetype\n    ))\n    .sort((a, b) => {\n      // Prioritize by archetype match strength\n      const aMatch = getArchetypeMatchScore(a, archetype);\n      const bMatch = getArchetypeMatchScore(b, archetype);\n      return bMatch - aMatch;\n    })\n    .slice(0, 5);\n}\n```\n\n### 5.3 Skincare Routine Generation\n\n#### Routine Structure\n\n```typescript\ninterface SkincareRoutine {\n  morning: SkincareStep[];\n  evening: SkincareStep[];\n  weekly: SkincareStep[];\n  targetedTreatments: Treatment[];\n}\n\ninterface SkincareStep {\n  order: number;\n  type: 'cleanser' | 'toner' | 'serum' | 'moisturizer' | 'sunscreen' | 'treatment';\n  product: {\n    name: string;\n    ingredients: string[];\n    purpose: string;\n  };\n  frequency: 'daily' | 'alternate' | 'weekly';\n  notes?: string;\n}\n```\n\n#### Routine Logic Based on Skin Analysis\n\n```typescript\nfunction generateSkincareRoutine(skinAnalysis: SkinAnalysis): SkincareRoutine {\n  const routine: SkincareRoutine = {\n    morning: [],\n    evening: [],\n    weekly: [],\n    targetedTreatments: [],\n  };\n\n  // Morning routine (always)\n  routine.morning.push(\n    { order: 1, type: 'cleanser', product: getCleanser(skinAnalysis) },\n    { order: 2, type: 'moisturizer', product: getMoisturizer(skinAnalysis) },\n    { order: 3, type: 'sunscreen', product: { name: 'SPF 50+ Sunscreen', ingredients: ['zinc oxide'], purpose: 'UV protection' } }\n  );\n\n  // Evening routine (always)\n  routine.evening.push(\n    { order: 1, type: 'cleanser', product: getCleanser(skinAnalysis) },\n    { order: 2, type: 'treatment', product: getEveningTreatment(skinAnalysis) },\n    { order: 3, type: 'moisturizer', product: getMoisturizer(skinAnalysis) }\n  );\n\n  // Add targeted treatments based on issues\n  if (skinAnalysis.acne_level !== 'none') {\n    routine.targetedTreatments.push({\n      concern: 'acne',\n      product: 'Benzoyl Peroxide 2.5% or Salicylic Acid 2%',\n      frequency: 'daily',\n      notes: 'Apply to affected areas only'\n    });\n  }\n\n  if (skinAnalysis.acne_scarring !== 'none') {\n    routine.targetedTreatments.push({\n      concern: 'scarring',\n      product: 'Vitamin C Serum (morning) + Retinol (evening)',\n      frequency: 'daily',\n      notes: 'Start retinol slowly, 2x/week then increase'\n    });\n  }\n\n  if (skinAnalysis.under_eye_darkness >= 6) {\n    routine.targetedTreatments.push({\n      concern: 'dark circles',\n      product: 'Caffeine Eye Serum + Vitamin K cream',\n      frequency: 'twice daily',\n      notes: 'Also improve sleep and hydration'\n    });\n  }\n\n  // Weekly treatments\n  if (skinAnalysis.pore_visibility !== 'minimal') {\n    routine.weekly.push({\n      order: 1,\n      type: 'treatment',\n      product: { name: 'Clay Mask', ingredients: ['kaolin', 'bentonite'], purpose: 'Deep pore cleansing' },\n      frequency: 'weekly'\n    });\n  }\n\n  return routine;\n}\n```\n\n### 5.4 Style Guide Generation\n\n```typescript\ninterface StyleGuide {\n  archetype: string;\n  subArchetype: string;\n\n  clothing: {\n    essentials: ClothingItem[];\n    fits: string[];\n    avoid: string[];\n  };\n\n  colors: {\n    primary: string[];      // Best colors based on skin tone\n    accent: string[];       // Accent colors\n    avoid: string[];        // Colors to avoid\n  };\n\n  accessories: {\n    recommended: Accessory[];\n    optional: Accessory[];\n  };\n\n  grooming: {\n    facialHair: string;     // Recommendation based on features\n    eyebrows: string;\n    hair: string;           // Reference to hairstyle recs\n  };\n\n  inspirationImages: string[];\n  celebrityReferences: string[];\n}\n\nfunction generateStyleGuide(\n  archetype: ArchetypeResult,\n  skinTone: string,\n  visionFeatures: VisionFeatures\n): StyleGuide {\n\n  const baseGuide = STYLE_GUIDES[archetype.primary.subArchetype];\n\n  // Customize colors based on skin tone\n  const colors = getColorPalette(skinTone, archetype);\n\n  // Facial hair recommendation\n  const facialHair = recommendFacialHair(\n    archetype,\n    visionFeatures.facial_hair_potential,\n    visionFeatures.hollow_cheeks\n  );\n\n  return {\n    ...baseGuide,\n    colors,\n    grooming: {\n      facialHair,\n      eyebrows: recommendEyebrowGrooming(visionFeatures.eyebrow_density),\n      hair: 'See hairstyle recommendations',\n    },\n  };\n}\n```\n\n### 5.5 Action Plan Generation\n\n```typescript\ninterface ActionPlan {\n  tier: 'foundation' | 'enhancement' | 'advanced';\n  items: ActionItem[];\n  estimatedTimeframe: string;\n  estimatedCost: CostRange;\n  potentialPSLGain: number;\n}\n\ninterface ActionItem {\n  priority: number;\n  category: 'skincare' | 'hair' | 'physique' | 'style' | 'dental' | 'surgical';\n  action: string;\n  reason: string;\n  impact: 'high' | 'medium' | 'low';\n  difficulty: 'easy' | 'medium' | 'hard';\n  timeframe: string;\n  cost: CostRange;\n  linkedFlaw?: string;\n}\n\nfunction generateActionPlan(\n  flaws: Flaw[],\n  strengths: Strength[],\n  visionFeatures: VisionFeatures,\n  archetype: ArchetypeResult,\n  userPreferences: { budget: string; timeline: string }\n): ActionPlan[] {\n\n  const items: ActionItem[] = [];\n\n  // 1. Foundation tier (softmaxxing, low cost, high impact)\n\n  // Skincare if issues detected\n  if (visionFeatures.skin.acne_level !== 'none' || visionFeatures.skin.clarity < 7) {\n    items.push({\n      priority: 1,\n      category: 'skincare',\n      action: 'Establish consistent skincare routine',\n      reason: `Current skin clarity: ${visionFeatures.skin.clarity}/10`,\n      impact: 'high',\n      difficulty: 'easy',\n      timeframe: '2-4 weeks for visible improvement',\n      cost: { min: 30, max: 100, currency: 'USD', frequency: 'monthly' },\n    });\n  }\n\n  // Haircut if not matching archetype\n  items.push({\n    priority: 2,\n    category: 'hair',\n    action: `Get archetype-matched haircut (${archetype.primary.subArchetype} style)`,\n    reason: 'Hairstyle should complement face shape and archetype',\n    impact: 'high',\n    difficulty: 'easy',\n    timeframe: 'Immediate',\n    cost: { min: 20, max: 80, currency: 'USD', frequency: 'monthly' },\n  });\n\n  // Physique if needed\n  if (visionFeatures.body && visionFeatures.body.body_fat_percent > 18) {\n    items.push({\n      priority: 3,\n      category: 'physique',\n      action: 'Reduce body fat to 12-15% range',\n      reason: `Current estimated BF: ${visionFeatures.body.body_fat_percent}%. Lower BF reveals facial definition and hollow cheeks.`,\n      impact: 'high',\n      difficulty: 'medium',\n      timeframe: '3-6 months',\n      cost: { min: 0, max: 100, currency: 'USD', frequency: 'monthly' },\n    });\n  }\n\n  // Style update\n  items.push({\n    priority: 4,\n    category: 'style',\n    action: `Adopt ${archetype.primary.subArchetype} wardrobe essentials`,\n    reason: 'Clothing should reinforce your natural archetype',\n    impact: 'medium',\n    difficulty: 'easy',\n    timeframe: '1-2 weeks',\n    cost: { min: 200, max: 500, currency: 'USD', frequency: 'one-time' },\n  });\n\n  // Dental if issues\n  if (visionFeatures.teeth.color !== 'white') {\n    items.push({\n      priority: 5,\n      category: 'dental',\n      action: 'Whiten teeth',\n      reason: `Current tooth color: ${visionFeatures.teeth.color}`,\n      impact: 'medium',\n      difficulty: 'easy',\n      timeframe: '2-4 weeks',\n      cost: { min: 30, max: 500, currency: 'USD', frequency: 'one-time' },\n    });\n  }\n\n  // 2. Enhancement tier (from existing flaws)\n  flaws.forEach((flaw, index) => {\n    const treatment = findBestTreatment(flaw);\n    if (treatment && treatment.phase !== 'Surgical') {\n      items.push({\n        priority: 10 + index,\n        category: treatment.category,\n        action: treatment.name,\n        reason: flaw.summary,\n        impact: treatment.impact > 0.5 ? 'high' : 'medium',\n        difficulty: 'medium',\n        timeframe: treatment.timeline,\n        cost: treatment.cost,\n        linkedFlaw: flaw.id,\n      });\n    }\n  });\n\n  // Sort by priority and group into tiers\n  const sorted = items.sort((a, b) => a.priority - b.priority);\n\n  return [\n    {\n      tier: 'foundation',\n      items: sorted.filter(i => i.priority <= 5),\n      estimatedTimeframe: '1-3 months',\n      estimatedCost: sumCosts(sorted.filter(i => i.priority <= 5)),\n      potentialPSLGain: 0.5,\n    },\n    {\n      tier: 'enhancement',\n      items: sorted.filter(i => i.priority > 5 && i.priority <= 15),\n      estimatedTimeframe: '3-6 months',\n      estimatedCost: sumCosts(sorted.filter(i => i.priority > 5 && i.priority <= 15)),\n      potentialPSLGain: 1.0,\n    },\n    {\n      tier: 'advanced',\n      items: sorted.filter(i => i.priority > 15),\n      estimatedTimeframe: '6-12 months',\n      estimatedCost: sumCosts(sorted.filter(i => i.priority > 15)),\n      potentialPSLGain: 0.5,\n    },\n  ];\n}\n```\n\n---\n\n## 6. Database Schema\n\n### 6.1 New Tables\n\n```sql\n-- Enhanced user profile\nALTER TABLE users ADD COLUMN IF NOT EXISTS height_cm INTEGER;\nALTER TABLE users ADD COLUMN IF NOT EXISTS physique_photo_url TEXT;\nALTER TABLE users ADD COLUMN IF NOT EXISTS psl_tier VARCHAR(20);\n\n-- Vision extractions (cached AI analysis)\nCREATE TABLE vision_extractions (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n\n    -- Face features\n    skin_clarity DECIMAL(3,2),\n    skin_tone VARCHAR(50),\n    acne_level VARCHAR(20),\n    acne_scarring VARCHAR(20),\n    pore_visibility VARCHAR(20),\n    texture_issues JSONB,\n\n    -- Hair features\n    hairline_nw INTEGER,\n    hair_density VARCHAR(20),\n    hair_texture VARCHAR(20),\n    hair_color VARCHAR(50),\n\n    -- Eye features\n    eye_color VARCHAR(50),\n    under_eye_darkness DECIMAL(3,2),\n    under_eye_puffiness DECIMAL(3,2),\n\n    -- Facial features\n    hollow_cheeks DECIMAL(3,2),\n    eyebrow_density VARCHAR(20),\n    facial_hair_potential VARCHAR(20),\n\n    -- Teeth\n    teeth_color VARCHAR(20),\n    teeth_alignment VARCHAR(20),\n\n    -- Body (if physique photo provided)\n    body_fat_percent DECIMAL(4,1),\n    muscle_mass VARCHAR(20),\n    frame_size VARCHAR(20),\n    shoulder_width VARCHAR(20),\n    waist_definition VARCHAR(20),\n    posture VARCHAR(20),\n\n    -- Metadata\n    raw_response JSONB,\n    created_at TIMESTAMP DEFAULT NOW(),\n\n    UNIQUE(analysis_id)\n);\n\n-- PSL scores (enhanced)\nCREATE TABLE psl_scores (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,\n\n    -- Component scores\n    face_score DECIMAL(4,2) NOT NULL,\n    height_score DECIMAL(4,2) NOT NULL,\n    body_score DECIMAL(4,2),\n\n    -- Bonuses\n    threshold_bonus DECIMAL(4,2) DEFAULT 0,\n    synergy_bonus DECIMAL(4,2) DEFAULT 0,\n    penalties DECIMAL(4,2) DEFAULT 0,\n\n    -- Final\n    total_score DECIMAL(4,2) NOT NULL,\n    tier VARCHAR(20) NOT NULL,\n    percentile DECIMAL(5,2),\n\n    -- Potential\n    potential_score DECIMAL(4,2),\n\n    created_at TIMESTAMP DEFAULT NOW(),\n\n    UNIQUE(analysis_id)\n);\n\n-- Archetype classifications\nCREATE TABLE archetype_results (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,\n\n    -- Primary archetype\n    primary_category VARCHAR(50) NOT NULL,\n    primary_sub_archetype VARCHAR(50) NOT NULL,\n    primary_confidence DECIMAL(3,2) NOT NULL,\n\n    -- Secondary archetype\n    secondary_category VARCHAR(50),\n    secondary_sub_archetype VARCHAR(50),\n    secondary_confidence DECIMAL(3,2),\n\n    -- Details\n    traits JSONB,\n    style_guide JSONB,\n    transition_path JSONB,\n\n    created_at TIMESTAMP DEFAULT NOW(),\n\n    UNIQUE(analysis_id)\n);\n\n-- Generated advice\nCREATE TABLE advice_results (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,\n\n    -- Recommendations\n    hairstyle_recommendations JSONB,\n    skincare_routine JSONB,\n    style_guide JSONB,\n    grooming_guide JSONB,\n    action_plan JSONB,\n\n    -- User preferences used\n    budget VARCHAR(20),\n    timeline VARCHAR(20),\n    goals JSONB,\n\n    created_at TIMESTAMP DEFAULT NOW(),\n\n    UNIQUE(analysis_id)\n);\n\n-- Indexes\nCREATE INDEX idx_vision_extractions_analysis ON vision_extractions(analysis_id);\nCREATE INDEX idx_vision_extractions_user ON vision_extractions(user_id);\nCREATE INDEX idx_psl_scores_analysis ON psl_scores(analysis_id);\nCREATE INDEX idx_psl_scores_user ON psl_scores(user_id);\nCREATE INDEX idx_archetype_results_analysis ON archetype_results(analysis_id);\nCREATE INDEX idx_advice_results_analysis ON advice_results(analysis_id);\n```\n\n---\n\n## 7. API Endpoints\n\n### 7.1 PSL Endpoints\n\n| Endpoint | Method | Auth | Paid | Description |\n|----------|--------|------|------|-------------|\n| `/psl/calculate` | POST | Yes | No | Calculate PSL from face + height |\n| `/psl/calculate-full` | POST | Yes | Yes | Calculate PSL with AI vision + body |\n| `/psl/{analysis_id}` | GET | Yes | No | Get stored PSL score |\n\n#### POST /psl/calculate\n```json\n// Request\n{\n  \"analysis_id\": \"uuid\",\n  \"height_cm\": 180\n}\n\n// Response\n{\n  \"score\": 6.75,\n  \"tier\": \"HTN\",\n  \"percentile\": 78.5,\n  \"breakdown\": {\n    \"face\": { \"raw\": 7.2, \"weighted\": 5.4 },\n    \"height\": { \"raw\": 7.0, \"weighted\": 1.4 },\n    \"body\": { \"raw\": 5.0, \"weighted\": 0.25 },\n    \"bonuses\": { \"threshold\": 0, \"synergy\": 0, \"total\": 0 },\n    \"penalties\": 0\n  },\n  \"potential\": 7.8\n}\n```\n\n### 7.2 Vision Endpoints (Paid)\n\n| Endpoint | Method | Auth | Paid | Description |\n|----------|--------|------|------|-------------|\n| `/vision/extract` | POST | Yes | Yes | Extract features from photos |\n| `/vision/extract-body` | POST | Yes | Yes | Analyze physique photo |\n| `/vision/{analysis_id}` | GET | Yes | Yes | Get stored vision extraction |\n\n#### POST /vision/extract\n```json\n// Request\n{\n  \"analysis_id\": \"uuid\",\n  \"include_body\": false\n}\n\n// Response\n{\n  \"extraction_id\": \"uuid\",\n  \"face\": {\n    \"skin\": {\n      \"clarity\": 7.5,\n      \"tone\": \"medium\",\n      \"acne_level\": \"mild\",\n      \"acne_scarring\": \"none\",\n      \"pore_visibility\": \"visible\"\n    },\n    \"hair\": {\n      \"hairline_nw\": 1,\n      \"density\": \"thick\",\n      \"texture\": \"wavy\",\n      \"color\": \"dark-brown\"\n    },\n    \"eyes\": {\n      \"color\": \"brown\",\n      \"under_eye_darkness\": 4.5,\n      \"under_eye_puffiness\": 2.0\n    },\n    \"facial_features\": {\n      \"hollow_cheeks\": 6.5,\n      \"eyebrow_density\": \"thick\",\n      \"facial_hair_potential\": \"high\"\n    },\n    \"teeth\": {\n      \"color\": \"off-white\",\n      \"alignment\": \"aligned\"\n    }\n  },\n  \"body\": null\n}\n```\n\n### 7.3 Archetype Endpoints\n\n| Endpoint | Method | Auth | Paid | Description |\n|----------|--------|------|------|-------------|\n| `/archetype/classify` | POST | Yes | No* | Classify archetype (enhanced with vision if paid) |\n| `/archetype/{analysis_id}` | GET | Yes | No | Get stored archetype |\n| `/archetype/styles` | GET | No | No | Get all style guides |\n\n### 7.4 Advice Endpoints (Paid)\n\n| Endpoint | Method | Auth | Paid | Description |\n|----------|--------|------|------|-------------|\n| `/advice/generate` | POST | Yes | Yes | Generate full advice package |\n| `/advice/hairstyles` | GET | Yes | Yes | Get hairstyle recommendations |\n| `/advice/skincare` | GET | Yes | Yes | Get skincare routine |\n| `/advice/style` | GET | Yes | Yes | Get style guide |\n| `/advice/action-plan` | GET | Yes | Yes | Get action plan |\n| `/advice/{analysis_id}` | GET | Yes | Yes | Get all stored advice |\n\n#### POST /advice/generate\n```json\n// Request\n{\n  \"analysis_id\": \"uuid\",\n  \"preferences\": {\n    \"budget\": \"medium\",\n    \"timeline\": \"6mo\",\n    \"goals\": [\"dating\", \"confidence\"]\n  }\n}\n\n// Response\n{\n  \"advice_id\": \"uuid\",\n  \"hairstyles\": [...],\n  \"skincare\": {...},\n  \"style_guide\": {...},\n  \"grooming\": {...},\n  \"action_plan\": [...]\n}\n```\n\n---\n\n## 8. Frontend Components\n\n### 8.1 Component Structure\n\n```\nsrc/components/psl/\n├── PSLScoreCard.tsx          # Main score display with tier badge\n├── PSLBreakdown.tsx          # Visual breakdown (face/height/body pie)\n├── PSLTierBadge.tsx          # Tier icon and name\n├── PSLComparison.tsx         # Current vs Potential\n├── PSLUpgradePrompt.tsx      # Prompt to unlock AI vision\n│\n├── archetype/\n│   ├── ArchetypeCard.tsx     # Primary archetype display\n│   ├── ArchetypeTraits.tsx   # Trait badges\n│   ├── ArchetypeComparison.tsx # Primary vs Secondary\n│   └── ArchetypeTransition.tsx # Path to next archetype\n│\n├── advice/\n│   ├── HairstyleRecommendations.tsx  # Hairstyle cards with images\n│   ├── SkincareRoutine.tsx           # AM/PM routine display\n│   ├── StyleGuide.tsx                # Clothing/color recommendations\n│   ├── GroomingGuide.tsx             # Facial hair, brows, etc.\n│   └── ActionPlan.tsx                # Prioritized improvements\n│\n└── shared/\n    ├── FeatureCard.tsx       # Extracted feature display\n    ├── ScoreBar.tsx          # Horizontal score visualization\n    ├── TierIcon.tsx          # Tier-specific icons\n    └── PaywallOverlay.tsx    # Upgrade prompt overlay\n```\n\n### 8.2 Results Tab Integration\n\n```typescript\n// Add to ResultsLayout.tsx tabs\nconst TABS: TabConfig[] = [\n  { id: 'overview', label: 'Overview', icon: <LayoutDashboard size={18} /> },\n  { id: 'front-ratios', label: 'Front Ratios', icon: <User size={18} /> },\n  { id: 'side-ratios', label: 'Side Ratios', icon: <ScanFace size={18} /> },\n  { id: 'leaderboard', label: 'Leaderboard', icon: <Trophy size={18} /> },\n  { id: 'plan', label: 'Your Plan', icon: <Sparkles size={18} /> },\n  // NEW TABS\n  { id: 'psl', label: 'PSL Score', icon: <Gauge size={18} />, paid: false },\n  { id: 'archetype', label: 'Archetype', icon: <Shapes size={18} />, paid: false },\n  { id: 'advice', label: 'AI Advice', icon: <Lightbulb size={18} />, paid: true },\n  // EXISTING\n  { id: 'options', label: 'Options', icon: <Settings size={18} /> },\n  { id: 'support', label: 'Support', icon: <HelpCircle size={18} /> },\n];\n```\n\n### 8.3 Key Component: PSLScoreCard\n\n```tsx\n// PSLScoreCard.tsx\ninterface PSLScoreCardProps {\n  psl: PSLResult;\n  showBreakdown?: boolean;\n  showPotential?: boolean;\n}\n\nexport function PSLScoreCard({ psl, showBreakdown = true, showPotential = true }: PSLScoreCardProps) {\n  return (\n    <div className=\"bg-zinc-900 rounded-xl p-6 border border-zinc-800\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between mb-6\">\n        <h2 className=\"text-xl font-semibold text-white\">PSL Rating</h2>\n        <PSLTierBadge tier={psl.tier} />\n      </div>\n\n      {/* Main Score */}\n      <div className=\"flex items-center gap-6 mb-6\">\n        <div className=\"text-6xl font-bold text-cyan-400\">\n          {psl.score.toFixed(2)}\n        </div>\n        <div className=\"text-zinc-400\">\n          <div className=\"text-lg\">{psl.tier}</div>\n          <div className=\"text-sm\">Top {(100 - psl.percentile).toFixed(1)}%</div>\n        </div>\n      </div>\n\n      {/* Breakdown */}\n      {showBreakdown && (\n        <PSLBreakdown breakdown={psl.breakdown} />\n      )}\n\n      {/* Potential */}\n      {showPotential && psl.potential > psl.score && (\n        <div className=\"mt-4 pt-4 border-t border-zinc-800\">\n          <div className=\"flex items-center justify-between text-sm\">\n            <span className=\"text-zinc-400\">Potential with improvements</span>\n            <span className=\"text-green-400 font-semibold\">\n              {psl.potential.toFixed(2)} (+{(psl.potential - psl.score).toFixed(2)})\n            </span>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n```\n\n### 8.4 Key Component: ArchetypeCard\n\n```tsx\n// ArchetypeCard.tsx\ninterface ArchetypeCardProps {\n  archetype: ArchetypeResult;\n  showSecondary?: boolean;\n  showTransition?: boolean;\n}\n\nexport function ArchetypeCard({ archetype, showSecondary = true, showTransition = true }: ArchetypeCardProps) {\n  return (\n    <div className=\"bg-zinc-900 rounded-xl p-6 border border-zinc-800\">\n      {/* Primary Archetype */}\n      <div className=\"flex items-start gap-4 mb-6\">\n        <div className=\"w-16 h-16 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center\">\n          <ArchetypeIcon archetype={archetype.primary.subArchetype} />\n        </div>\n        <div>\n          <div className=\"text-sm text-zinc-400 mb-1\">Your Archetype</div>\n          <div className=\"text-2xl font-bold text-white\">\n            {archetype.primary.subArchetype}\n          </div>\n          <div className=\"text-sm text-zinc-500\">\n            {archetype.primary.category} • {(archetype.primary.confidence * 100).toFixed(0)}% match\n          </div>\n        </div>\n      </div>\n\n      {/* Traits */}\n      <div className=\"flex flex-wrap gap-2 mb-6\">\n        {archetype.traits.map(trait => (\n          <span key={trait} className=\"px-3 py-1 rounded-full bg-zinc-800 text-zinc-300 text-sm\">\n            {trait}\n          </span>\n        ))}\n      </div>\n\n      {/* Secondary */}\n      {showSecondary && archetype.secondary && (\n        <div className=\"p-4 rounded-lg bg-zinc-800/50 mb-4\">\n          <div className=\"text-sm text-zinc-400 mb-1\">Secondary Match</div>\n          <div className=\"text-lg text-white\">\n            {archetype.secondary.subArchetype}\n            <span className=\"text-zinc-500 text-sm ml-2\">\n              ({(archetype.secondary.confidence * 100).toFixed(0)}%)\n            </span>\n          </div>\n        </div>\n      )}\n\n      {/* Transition Path */}\n      {showTransition && archetype.transitionPath && (\n        <div className=\"p-4 rounded-lg border border-dashed border-zinc-700\">\n          <div className=\"text-sm text-zinc-400 mb-2\">Transition Potential</div>\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-white\">{archetype.primary.subArchetype}</span>\n            <ArrowRight className=\"text-zinc-600\" size={16} />\n            <span className=\"text-cyan-400\">{archetype.transitionPath.target}</span>\n          </div>\n          <div className=\"text-xs text-zinc-500 mt-2\">\n            Requirements: {archetype.transitionPath.requirements.join(', ')}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n```\n\n---\n\n## 9. Implementation Phases\n\n### Phase 1: PSL Foundation (Week 1)\n**Priority: Critical**\n\n- [ ] Add `height_cm` to users table\n- [ ] Implement height input in onboarding/results\n- [ ] Create `psl-calculator.ts` with formula\n- [ ] Create `PSLScoreCard`, `PSLBreakdown`, `PSLTierBadge` components\n- [ ] Add PSL tab to results page\n- [ ] Create `/psl/calculate` endpoint\n\n### Phase 2: Archetype System (Week 2)\n**Priority: High**\n\n- [ ] Create `archetypes.json` with full taxonomy\n- [ ] Implement `archetype-classifier.ts`\n- [ ] Create `archetype_service.py`\n- [ ] Create `ArchetypeCard`, `ArchetypeTraits` components\n- [ ] Add Archetype tab to results page\n- [ ] Create `/archetype/classify` endpoint\n\n### Phase 3: AI Vision Integration (Week 3)\n**Priority: High - Paid Feature**\n\n- [ ] Set up Claude API integration\n- [ ] Implement `vision_service.py`\n- [ ] Create `vision_extractions` table\n- [ ] Create `/vision/extract` endpoint\n- [ ] Add paywall for AI vision access\n- [ ] Display extracted features in UI\n\n### Phase 4: Advice Engine (Week 4)\n**Priority: High - Paid Feature**\n\n- [ ] Create `hairstyles.json` database\n- [ ] Create `skincare.json` routines\n- [ ] Create `style_guides.json`\n- [ ] Implement `advice_service.py`\n- [ ] Create advice components (`HairstyleRecommendations`, `SkincareRoutine`, etc.)\n- [ ] Add Advice tab to results page\n- [ ] Create `/advice/*` endpoints\n\n### Phase 5: Action Plan (Week 5)\n**Priority: Medium**\n\n- [ ] Implement action plan generation logic\n- [ ] Create `ActionPlan` component\n- [ ] Integrate with existing recommendations\n- [ ] Add cost/timeline estimates\n- [ ] Link flaws to specific actions\n\n### Phase 6: Polish & Integration (Week 6)\n**Priority: Medium**\n\n- [ ] End-to-end testing\n- [ ] Performance optimization\n- [ ] Caching for AI calls\n- [ ] Error handling\n- [ ] Mobile responsiveness\n- [ ] Analytics integration\n\n---\n\n## 10. Cost & Pricing\n\n### 10.1 API Costs\n\n| Service | Cost per Call | Usage |\n|---------|--------------|-------|\n| Claude Vision (face) | ~$0.01-0.02 | Per face extraction |\n| Claude Vision (body) | ~$0.01 | Per body extraction |\n| Total per user | ~$0.02-0.03 | One-time per analysis |\n\n### 10.2 Suggested Pricing Tiers\n\n| Feature | Free | Pro ($X/mo) | Premium ($Y/mo) |\n|---------|------|-------------|-----------------|\n| Landmark Analysis | ✓ | ✓ | ✓ |\n| Basic PSL (face + height) | ✓ | ✓ | ✓ |\n| Archetype (rule-based) | ✓ | ✓ | ✓ |\n| AI Vision Extraction | ✗ | ✓ | ✓ |\n| Enhanced PSL (with body) | ✗ | ✓ | ✓ |\n| Hairstyle Recommendations | ✗ | ✓ | ✓ |\n| Skincare Routine | ✗ | ✓ | ✓ |\n| Style Guide | ✗ | ✓ | ✓ |\n| Action Plan | ✗ | ✓ | ✓ |\n| Unlimited Re-analyses | ✗ | ✗ | ✓ |\n\n### 10.3 Margin Analysis\n\n- Cost per paid user: ~$0.03 (one-time AI call)\n- If user pays $5/month: 99%+ margin\n- If user pays $20 one-time: 99%+ margin\n- AI costs are negligible relative to value provided\n\n---\n\n## Appendix A: Halos & Failos Reference\n\n### Halos (Positive Features)\n\n| Halo | Detection Method | Impact |\n|------|------------------|--------|\n| Hunter Eyes | Landmarks (canthal tilt, deep-set) | High |\n| Hollow Cheeks | Vision AI | High |\n| Strong Jawline | Landmarks (gonial angle, bigonial) | High |\n| Clear Skin | Vision AI | High |\n| NW0-1 Hairline | Vision AI | Medium |\n| White Teeth | Vision AI | Medium |\n| Compact Midface | Landmarks | High |\n| Dense Eyebrows | Vision AI | Low |\n| Golden/Tanned Skin | Vision AI | Low |\n\n### Failos (Negative Features)\n\n| Failo | Detection Method | Severity |\n|-------|------------------|----------|\n| Negative Canthal Tilt | Landmarks | Major |\n| Receding Chin | Landmarks | Major |\n| Long Philtrum | Landmarks | Moderate |\n| Severe Acne/Scarring | Vision AI | Major |\n| Asymmetry | Landmarks | Moderate-Major |\n| NW3+ Hairline | Vision AI | Moderate |\n| Scleral Show | Landmarks | Moderate |\n| Thin Neck | Landmarks/Vision | Minor |\n| Mouth Breathing Signs | Landmarks | Major |\n| Narrow Palate | Landmarks | Moderate |\n\n---\n\n## Appendix B: Celebrity Calibration\n\nUse these known ratings for algorithm validation:\n\n| Celebrity | Expected PSL | Archetype | Key Features |\n|-----------|--------------|-----------|--------------|\n| Francisco Lachowski | 9.0+ | Prettyboy | Perfect harmony, no failos |\n| Henry Cavill | 8.5-9.0 | Superman Chad | Strong jaw, dimorphism |\n| Ian Somerhalder | 8.0-8.5 | Vampire Chad | Hunter eyes, hollow cheeks |\n| Zac Efron (prime) | 8.0-8.5 | Jock Chad | Athletic, symmetrical |\n| Timothée Chalamet | 7.5-8.0 | Softboy | Harmony, low dimorphism |\n| Josh Hutcherson | 5.5-6.0 | HTN | Average height limits ceiling |\n| Average man | 5.0 | MTN | By definition |\n\n---\n\n## Appendix C: File Paths Summary\n\n### Backend (looksmaxx-api)\n\n```\napp/\n├── services/\n│   ├── psl_service.py           # NEW\n│   ├── vision_service.py        # NEW\n│   ├── archetype_service.py     # NEW\n│   └── advice_service.py        # NEW\n├── routers/\n│   ├── psl.py                   # NEW\n│   ├── vision.py                # NEW\n│   └── advice.py                # NEW\n├── models/\n│   ├── vision_extraction.py     # NEW\n│   ├── psl_score.py             # NEW\n│   ├── archetype_result.py      # NEW\n│   └── advice_result.py         # NEW\n└── data/\n    ├── archetypes.json          # NEW\n    ├── hairstyles.json          # NEW\n    ├── skincare.json            # NEW\n    └── style_guides.json        # NEW\n```\n\n### Frontend (looksmaxx-app)\n\n```\nsrc/\n├── components/\n│   └── psl/                     # NEW (entire folder)\n├── contexts/\n│   └── PSLContext.tsx           # NEW\n├── lib/\n│   ├── psl-calculator.ts        # NEW\n│   └── archetype-classifier.ts  # NEW\n└── types/\n    └── psl.ts                   # NEW\n```\n\n---\n\n*Document Version: 1.0*\n*Last Updated: 2025-01-XX*\n*Author: LOOKSMAXX Team*\n","numLines":1814,"startLine":1,"totalLines":1814}}}
{"parentUuid":"66c0f1f7-0afc-414d-973e-ad112480bf0f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018CD8C2mCxnPUJF5ZwQQB83","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/GenderContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/UploadContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/EthnicityContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/AuthContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/LeaderboardContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ForumContext.tsx"}]},"uuid":"65974a94-82ef-4567-ae36-f0c54f927fc0","timestamp":"2025-12-25T23:22:41.799Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/GenderContext.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/UploadContext.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/EthnicityContext.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/AuthContext.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/LeaderboardContext.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ForumContext.tsx"],"durationMs":774,"numFiles":7,"truncated":false}}
{"parentUuid":"65974a94-82ef-4567-ae36-f0c54f927fc0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N7mudXB1g4v3argLfSmFrd","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/types.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/analyzer.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/calculator.ts"}]},"uuid":"0a023b32-8a7a-46e7-9a8e-c4aed2e05f7a","timestamp":"2025-12-25T23:22:41.965Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/types.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/analyzer.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/calculator.ts"],"durationMs":940,"numFiles":3,"truncated":false}}
{"parentUuid":"0a023b32-8a7a-46e7-9a8e-c4aed2e05f7a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UEgQUNjnf4C6bnQ3MxqKy6","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/IdealRangeBar.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/SupportTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/RecommendationCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/AnimatedScore.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ShareButton.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ExportButton.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OptionsTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/GradientRangeBar.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/PlanActionCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/UserProfileModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/TreatmentTimeline.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/BeforeAfterPreview.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/MeasurementCard.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/index.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/MetricDetailModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/RatiosTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StrengthFlawCards.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/RatioDetailModal.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/KeyStrengthsFlaws.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/Results.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/CommunityTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FacialRadarChart.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/LeaderboardTab.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/RankBadge.tsx\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx"}]},"uuid":"8f7fe7f1-189e-4730-8745-690a6f2c6851","timestamp":"2025-12-25T23:22:42.119Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/IdealRangeBar.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/SupportTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/index.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/RecommendationCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/AnimatedScore.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ShareButton.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/ExportButton.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OptionsTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/GradientRangeBar.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/PlanActionCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FaceOverlay.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/UserProfileModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/TreatmentTimeline.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/BeforeAfterPreview.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/MeasurementCard.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/index.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/MetricDetailModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/RatiosTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/StrengthFlawCards.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/modals/RatioDetailModal.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/KeyStrengthsFlaws.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/Results.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/CommunityTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/visualization/FacialRadarChart.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/LeaderboardTab.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/shared/RankBadge.tsx","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx"],"durationMs":1095,"numFiles":30,"truncated":false}}
{"parentUuid":"8f7fe7f1-189e-4730-8745-690a6f2c6851","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DQcwzEe1gei8hcxW6Ud6Xu","type":"message","role":"assistant","content":[{"type":"text","text":"Let me now explore the existing scoring system, results components, and onboarding flow to understand integration points:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":242,"cache_creation_input_tokens":27999,"cache_read_input_tokens":16095,"cache_creation":{"ephemeral_5m_input_tokens":27999,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGMhqhvH3wquhMXmu25","type":"assistant","uuid":"b186b938-cfc4-4f1f-91f4-a64c5c483708","timestamp":"2025-12-25T23:22:47.570Z"}
{"parentUuid":"b186b938-cfc4-4f1f-91f4-a64c5c483708","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DQcwzEe1gei8hcxW6Ud6Xu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RJAvGjCsYhFggU74Z9gUw2","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/calculator.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":242,"cache_creation_input_tokens":27999,"cache_read_input_tokens":16095,"cache_creation":{"ephemeral_5m_input_tokens":27999,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGMhqhvH3wquhMXmu25","type":"assistant","uuid":"f36c9679-3e7f-41bd-a09e-33efcaed1229","timestamp":"2025-12-25T23:22:48.607Z"}
{"parentUuid":"f36c9679-3e7f-41bd-a09e-33efcaed1229","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DQcwzEe1gei8hcxW6Ud6Xu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TcUDLDhcbKSPenVC7ttV41","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":242,"cache_creation_input_tokens":27999,"cache_read_input_tokens":16095,"cache_creation":{"ephemeral_5m_input_tokens":27999,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGMhqhvH3wquhMXmu25","type":"assistant","uuid":"2a88a283-6860-472b-88d9-c8fba2927f4c","timestamp":"2025-12-25T23:22:49.224Z"}
{"parentUuid":"2a88a283-6860-472b-88d9-c8fba2927f4c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DQcwzEe1gei8hcxW6Ud6Xu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XpDejYNF6w2HDnuf87HbVt","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":242,"cache_creation_input_tokens":27999,"cache_read_input_tokens":16095,"cache_creation":{"ephemeral_5m_input_tokens":27999,"ephemeral_1h_input_tokens":0},"output_tokens":234,"service_tier":"standard"}},"requestId":"req_011CWUGMhqhvH3wquhMXmu25","type":"assistant","uuid":"b4d988bb-4468-4d4b-9886-4b0d6ab5383d","timestamp":"2025-12-25T23:22:50.251Z"}
{"parentUuid":"b4d988bb-4468-4d4b-9886-4b0d6ab5383d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TcUDLDhcbKSPenVC7ttV41","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useState, useEffect } from 'react';\n     4→import { motion, AnimatePresence } from 'framer-motion';\n     5→import Image from 'next/image';\n     6→import {\n     7→  LayoutDashboard,\n     8→  User,\n     9→  ScanFace,\n    10→  Sparkles,\n    11→  Settings,\n    12→  HelpCircle,\n    13→  Menu,\n    14→  X,\n    15→  ChevronRight,\n    16→  Trophy,\n    17→  Users,\n    18→} from 'lucide-react';\n    19→import { useResults } from '@/contexts/ResultsContext';\n    20→import { useLeaderboardOptional } from '@/contexts/LeaderboardContext';\n    21→import { ResultsTab } from '@/types/results';\n    22→import { ScoreCircle, RankBadge } from './shared';\n    23→import { api } from '@/lib/api';\n    24→\n    25→// ============================================\n    26→// TAB NAVIGATION\n    27→// ============================================\n    28→\n    29→interface TabConfig {\n    30→  id: ResultsTab;\n    31→  label: string;\n    32→  icon: React.ReactNode;\n    33→}\n    34→\n    35→const TABS: TabConfig[] = [\n    36→  { id: 'overview', label: 'Overview', icon: <LayoutDashboard size={18} /> },\n    37→  { id: 'front-ratios', label: 'Front Ratios', icon: <User size={18} /> },\n    38→  { id: 'side-ratios', label: 'Side Ratios', icon: <ScanFace size={18} /> },\n    39→  { id: 'leaderboard', label: 'Leaderboard', icon: <Trophy size={18} /> },\n    40→  { id: 'plan', label: 'Your Plan', icon: <Sparkles size={18} /> },\n    41→  { id: 'community', label: 'Community', icon: <Users size={18} /> },\n    42→  { id: 'options', label: 'Options', icon: <Settings size={18} /> },\n    43→  { id: 'support', label: 'Support', icon: <HelpCircle size={18} /> },\n    44→];\n    45→\n    46→// ============================================\n    47→// SIDEBAR\n    48→// ============================================\n    49→\n    50→interface SidebarProps {\n    51→  onClose?: () => void;\n    52→}\n    53→\n    54→function Sidebar({ onClose }: SidebarProps) {\n    55→  const { activeTab, setActiveTab, overallScore, frontPhoto } = useResults();\n    56→\n    57→  return (\n    58→    <div className=\"flex flex-col h-full bg-neutral-950 border-r border-neutral-800\">\n    59→      {/* Header */}\n    60→      <div className=\"flex items-center justify-between p-4 border-b border-neutral-800\">\n    61→        <div className=\"flex items-center gap-2\">\n    62→          <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center\">\n    63→            <ScanFace size={18} className=\"text-white\" />\n    64→          </div>\n    65→          <span className=\"font-semibold text-white\">LOOKSMAXX</span>\n    66→        </div>\n    67→        {onClose && (\n    68→          <button\n    69→            onClick={onClose}\n    70→            className=\"p-2 hover:bg-neutral-800 rounded-lg transition-colors md:hidden\"\n    71→          >\n    72→            <X size={20} className=\"text-neutral-400\" />\n    73→          </button>\n    74→        )}\n    75→      </div>\n    76→\n    77→      {/* Profile Photo & Score */}\n    78→      <div className=\"p-4 border-b border-neutral-800\">\n    79→        <div className=\"relative aspect-square rounded-xl overflow-hidden bg-neutral-900 mb-3\">\n    80→          {frontPhoto ? (\n    81→            <Image\n    82→              src={frontPhoto}\n    83→              alt=\"Your face\"\n    84→              fill\n    85→              className=\"object-cover\"\n    86→              unoptimized\n    87→            />\n    88→          ) : (\n    89→            <div className=\"w-full h-full flex items-center justify-center\">\n    90→              <User size={48} className=\"text-neutral-700\" />\n    91→            </div>\n    92→          )}\n    93→          {/* Score badge */}\n    94→          <div className=\"absolute bottom-2 right-2\">\n    95→            <ScoreCircle score={overallScore} size=\"sm\" animate={false} />\n    96→          </div>\n    97→        </div>\n    98→        <div className=\"text-center\">\n    99→          <p className=\"text-sm text-neutral-400\">Harmony Score</p>\n   100→          <p className=\"text-2xl font-bold text-white\">{overallScore.toFixed(2)}</p>\n   101→          <div className=\"mt-2\">\n   102→            <RankBadge size=\"md\" alwaysShow showPercentile />\n   103→          </div>\n   104→        </div>\n   105→      </div>\n   106→\n   107→      {/* Navigation */}\n   108→      <nav className=\"flex-1 p-2 overflow-y-auto\">\n   109→        {TABS.map((tab) => (\n   110→          <button\n   111→            key={tab.id}\n   112→            onClick={() => {\n   113→              setActiveTab(tab.id);\n   114→              onClose?.();\n   115→            }}\n   116→            className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all ${\n   117→              activeTab === tab.id\n   118→                ? 'bg-cyan-500/20 text-cyan-400'\n   119→                : 'text-neutral-400 hover:bg-neutral-800 hover:text-white'\n   120→            }`}\n   121→          >\n   122→            {tab.icon}\n   123→            <span className=\"font-medium\">{tab.label}</span>\n   124→            {activeTab === tab.id && (\n   125→              <ChevronRight size={16} className=\"ml-auto\" />\n   126→            )}\n   127→          </button>\n   128→        ))}\n   129→      </nav>\n   130→\n   131→      {/* Footer */}\n   132→      <div className=\"p-4 border-t border-neutral-800\">\n   133→        <button className=\"w-full py-2.5 px-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-medium rounded-lg hover:from-cyan-400 hover:to-blue-500 transition-all\">\n   134→          New Analysis\n   135→        </button>\n   136→      </div>\n   137→    </div>\n   138→  );\n   139→}\n   140→\n   141→// ============================================\n   142→// FLOATING RANK CARD (Desktop)\n   143→// ============================================\n   144→\n   145→function FloatingRankCard() {\n   146→  const { setActiveTab } = useResults();\n   147→  const leaderboard = useLeaderboardOptional();\n   148→  const userRank = leaderboard?.userRank;\n   149→  const isAuthenticated = !!api.getToken();\n   150→\n   151→  // Auto-fetch user's rank on mount if authenticated\n   152→  useEffect(() => {\n   153→    if (isAuthenticated && !userRank && leaderboard?.fetchMyRank) {\n   154→      leaderboard.fetchMyRank();\n   155→    }\n   156→  }, [isAuthenticated, userRank, leaderboard]);\n   157→\n   158→  return (\n   159→    <motion.button\n   160→      initial={{ opacity: 0, y: -20 }}\n   161→      animate={{ opacity: 1, y: 0 }}\n   162→      onClick={() => setActiveTab('leaderboard')}\n   163→      className=\"flex items-center gap-3 px-4 py-3 bg-neutral-900/95 backdrop-blur-sm border border-neutral-800 rounded-xl shadow-lg hover:border-yellow-500/30 transition-all group\"\n   164→    >\n   165→      {userRank ? (\n   166→        <>\n   167→          <div className=\"flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-yellow-500/20 to-amber-500/20 border border-yellow-500/30\">\n   168→            <Trophy size={20} className=\"text-yellow-400\" />\n   169→          </div>\n   170→          <div className=\"text-left\">\n   171→            <p className=\"text-xs text-neutral-500 uppercase tracking-wide\">Your Rank</p>\n   172→            <div className=\"flex items-baseline gap-2\">\n   173→              <span className=\"text-xl font-bold text-yellow-400\">#{userRank.genderRank}</span>\n   174→              <span className=\"text-xs text-neutral-500\">Top {userRank.percentile.toFixed(1)}%</span>\n   175→            </div>\n   176→          </div>\n   177→          <ChevronRight size={16} className=\"text-neutral-600 group-hover:text-yellow-400 transition-colors ml-1\" />\n   178→        </>\n   179→      ) : (\n   180→        <>\n   181→          <div className=\"flex items-center justify-center w-10 h-10 rounded-lg bg-neutral-800 border border-neutral-700\">\n   182→            <Trophy size={20} className=\"text-neutral-500\" />\n   183→          </div>\n   184→          <div className=\"text-left\">\n   185→            <p className=\"text-xs text-neutral-500 uppercase tracking-wide\">Your Rank</p>\n   186→            <span className=\"text-sm text-neutral-400\">\n   187→              {isAuthenticated ? 'Not ranked yet' : 'Sign in to rank'}\n   188→            </span>\n   189→          </div>\n   190→          <ChevronRight size={16} className=\"text-neutral-600 group-hover:text-neutral-400 transition-colors ml-1\" />\n   191→        </>\n   192→      )}\n   193→    </motion.button>\n   194→  );\n   195→}\n   196→\n   197→// ============================================\n   198→// MOBILE HEADER\n   199→// ============================================\n   200→\n   201→interface MobileHeaderProps {\n   202→  onMenuClick: () => void;\n   203→}\n   204→\n   205→function MobileHeader({ onMenuClick }: MobileHeaderProps) {\n   206→  const { activeTab, overallScore } = useResults();\n   207→  const currentTab = TABS.find((t) => t.id === activeTab);\n   208→\n   209→  return (\n   210→    <header className=\"flex items-center justify-between px-4 py-3 bg-neutral-950 border-b border-neutral-800\">\n   211→      <button\n   212→        onClick={onMenuClick}\n   213→        className=\"p-2 hover:bg-neutral-800 rounded-lg transition-colors\"\n   214→      >\n   215→        <Menu size={20} className=\"text-neutral-400\" />\n   216→      </button>\n   217→      <div className=\"flex items-center gap-2\">\n   218→        {currentTab?.icon}\n   219→        <span className=\"font-medium text-white\">{currentTab?.label}</span>\n   220→      </div>\n   221→      <div className=\"flex items-center gap-2\">\n   222→        <RankBadge size=\"sm\" alwaysShow />\n   223→        <div className=\"w-6 h-6 rounded-full bg-cyan-500/20 flex items-center justify-center\">\n   224→          <span className=\"text-xs text-cyan-400 font-bold\">{Math.round(overallScore)}</span>\n   225→        </div>\n   226→      </div>\n   227→    </header>\n   228→  );\n   229→}\n   230→\n   231→// ============================================\n   232→// MAIN LAYOUT\n   233→// ============================================\n   234→\n   235→interface ResultsLayoutProps {\n   236→  children: React.ReactNode;\n   237→}\n   238→\n   239→export function ResultsLayout({ children }: ResultsLayoutProps) {\n   240→  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n   241→  const { activeTab } = useResults();\n   242→\n   243→  return (\n   244→    <div className=\"flex min-h-screen bg-black\">\n   245→      {/* Desktop Sidebar */}\n   246→      <aside className=\"hidden md:flex md:w-[280px] md:flex-col md:fixed md:inset-y-0 z-40\">\n   247→        <Sidebar />\n   248→      </aside>\n   249→\n   250→      {/* Mobile Menu Overlay */}\n   251→      <AnimatePresence>\n   252→        {mobileMenuOpen && (\n   253→          <>\n   254→            <motion.div\n   255→              initial={{ opacity: 0 }}\n   256→              animate={{ opacity: 1 }}\n   257→              exit={{ opacity: 0 }}\n   258→              onClick={() => setMobileMenuOpen(false)}\n   259→              className=\"fixed inset-0 bg-black/60 z-40 md:hidden\"\n   260→            />\n   261→            <motion.aside\n   262→              initial={{ x: -280 }}\n   263→              animate={{ x: 0 }}\n   264→              exit={{ x: -280 }}\n   265→              transition={{ type: 'spring', damping: 25, stiffness: 200 }}\n   266→              className=\"fixed inset-y-0 left-0 w-[280px] z-50 md:hidden\"\n   267→            >\n   268→              <Sidebar onClose={() => setMobileMenuOpen(false)} />\n   269→            </motion.aside>\n   270→          </>\n   271→        )}\n   272→      </AnimatePresence>\n   273→\n   274→      {/* Main Content */}\n   275→      <div className=\"flex-1 md:pl-[280px] flex flex-col min-h-screen\">\n   276→        {/* Mobile Header */}\n   277→        <div className=\"md:hidden\">\n   278→          <MobileHeader onMenuClick={() => setMobileMenuOpen(true)} />\n   279→        </div>\n   280→\n   281→        {/* Desktop Floating Rank Indicator */}\n   282→        <div className=\"hidden md:block fixed top-4 right-4 z-30\">\n   283→          <FloatingRankCard />\n   284→        </div>\n   285→\n   286→        {/* Content Area - no overflow so sticky works */}\n   287→        <main className=\"flex-1\">\n   288→          <AnimatePresence mode=\"wait\">\n   289→            <motion.div\n   290→              key={activeTab}\n   291→              initial={{ opacity: 0, y: 10 }}\n   292→              animate={{ opacity: 1, y: 0 }}\n   293→              exit={{ opacity: 0, y: -10 }}\n   294→              transition={{ duration: 0.2 }}\n   295→            >\n   296→              {children}\n   297→            </motion.div>\n   298→          </AnimatePresence>\n   299→        </main>\n   300→      </div>\n   301→    </div>\n   302→  );\n   303→}\n   304→\n   305→// ============================================\n   306→// TAB CONTENT WRAPPER\n   307→// ============================================\n   308→\n   309→interface TabContentProps {\n   310→  title: string;\n   311→  subtitle?: string;\n   312→  children: React.ReactNode;\n   313→  rightContent?: React.ReactNode;\n   314→}\n   315→\n   316→export function TabContent({ title, subtitle, children, rightContent }: TabContentProps) {\n   317→  return (\n   318→    <div className=\"p-4 md:p-6 lg:p-8 max-w-7xl mx-auto\">\n   319→      {/* Header */}\n   320→      <div className=\"flex flex-col md:flex-row md:items-center md:justify-between mb-6\">\n   321→        <div>\n   322→          <h1 className=\"text-2xl md:text-3xl font-bold text-white\">{title}</h1>\n   323→          {subtitle && (\n   324→            <p className=\"text-neutral-400 mt-1\">{subtitle}</p>\n   325→          )}\n   326→        </div>\n   327→        {rightContent && (\n   328→          <div className=\"mt-4 md:mt-0\">{rightContent}</div>\n   329→        )}\n   330→      </div>\n   331→\n   332→      {/* Content */}\n   333→      {children}\n   334→    </div>\n   335→  );\n   336→}\n   337→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3d40822f-2927-4873-82f3-7807ec1f2fde","timestamp":"2025-12-25T23:22:50.304Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx","content":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport Image from 'next/image';\nimport {\n  LayoutDashboard,\n  User,\n  ScanFace,\n  Sparkles,\n  Settings,\n  HelpCircle,\n  Menu,\n  X,\n  ChevronRight,\n  Trophy,\n  Users,\n} from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { useLeaderboardOptional } from '@/contexts/LeaderboardContext';\nimport { ResultsTab } from '@/types/results';\nimport { ScoreCircle, RankBadge } from './shared';\nimport { api } from '@/lib/api';\n\n// ============================================\n// TAB NAVIGATION\n// ============================================\n\ninterface TabConfig {\n  id: ResultsTab;\n  label: string;\n  icon: React.ReactNode;\n}\n\nconst TABS: TabConfig[] = [\n  { id: 'overview', label: 'Overview', icon: <LayoutDashboard size={18} /> },\n  { id: 'front-ratios', label: 'Front Ratios', icon: <User size={18} /> },\n  { id: 'side-ratios', label: 'Side Ratios', icon: <ScanFace size={18} /> },\n  { id: 'leaderboard', label: 'Leaderboard', icon: <Trophy size={18} /> },\n  { id: 'plan', label: 'Your Plan', icon: <Sparkles size={18} /> },\n  { id: 'community', label: 'Community', icon: <Users size={18} /> },\n  { id: 'options', label: 'Options', icon: <Settings size={18} /> },\n  { id: 'support', label: 'Support', icon: <HelpCircle size={18} /> },\n];\n\n// ============================================\n// SIDEBAR\n// ============================================\n\ninterface SidebarProps {\n  onClose?: () => void;\n}\n\nfunction Sidebar({ onClose }: SidebarProps) {\n  const { activeTab, setActiveTab, overallScore, frontPhoto } = useResults();\n\n  return (\n    <div className=\"flex flex-col h-full bg-neutral-950 border-r border-neutral-800\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between p-4 border-b border-neutral-800\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center\">\n            <ScanFace size={18} className=\"text-white\" />\n          </div>\n          <span className=\"font-semibold text-white\">LOOKSMAXX</span>\n        </div>\n        {onClose && (\n          <button\n            onClick={onClose}\n            className=\"p-2 hover:bg-neutral-800 rounded-lg transition-colors md:hidden\"\n          >\n            <X size={20} className=\"text-neutral-400\" />\n          </button>\n        )}\n      </div>\n\n      {/* Profile Photo & Score */}\n      <div className=\"p-4 border-b border-neutral-800\">\n        <div className=\"relative aspect-square rounded-xl overflow-hidden bg-neutral-900 mb-3\">\n          {frontPhoto ? (\n            <Image\n              src={frontPhoto}\n              alt=\"Your face\"\n              fill\n              className=\"object-cover\"\n              unoptimized\n            />\n          ) : (\n            <div className=\"w-full h-full flex items-center justify-center\">\n              <User size={48} className=\"text-neutral-700\" />\n            </div>\n          )}\n          {/* Score badge */}\n          <div className=\"absolute bottom-2 right-2\">\n            <ScoreCircle score={overallScore} size=\"sm\" animate={false} />\n          </div>\n        </div>\n        <div className=\"text-center\">\n          <p className=\"text-sm text-neutral-400\">Harmony Score</p>\n          <p className=\"text-2xl font-bold text-white\">{overallScore.toFixed(2)}</p>\n          <div className=\"mt-2\">\n            <RankBadge size=\"md\" alwaysShow showPercentile />\n          </div>\n        </div>\n      </div>\n\n      {/* Navigation */}\n      <nav className=\"flex-1 p-2 overflow-y-auto\">\n        {TABS.map((tab) => (\n          <button\n            key={tab.id}\n            onClick={() => {\n              setActiveTab(tab.id);\n              onClose?.();\n            }}\n            className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg mb-1 transition-all ${\n              activeTab === tab.id\n                ? 'bg-cyan-500/20 text-cyan-400'\n                : 'text-neutral-400 hover:bg-neutral-800 hover:text-white'\n            }`}\n          >\n            {tab.icon}\n            <span className=\"font-medium\">{tab.label}</span>\n            {activeTab === tab.id && (\n              <ChevronRight size={16} className=\"ml-auto\" />\n            )}\n          </button>\n        ))}\n      </nav>\n\n      {/* Footer */}\n      <div className=\"p-4 border-t border-neutral-800\">\n        <button className=\"w-full py-2.5 px-4 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-medium rounded-lg hover:from-cyan-400 hover:to-blue-500 transition-all\">\n          New Analysis\n        </button>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// FLOATING RANK CARD (Desktop)\n// ============================================\n\nfunction FloatingRankCard() {\n  const { setActiveTab } = useResults();\n  const leaderboard = useLeaderboardOptional();\n  const userRank = leaderboard?.userRank;\n  const isAuthenticated = !!api.getToken();\n\n  // Auto-fetch user's rank on mount if authenticated\n  useEffect(() => {\n    if (isAuthenticated && !userRank && leaderboard?.fetchMyRank) {\n      leaderboard.fetchMyRank();\n    }\n  }, [isAuthenticated, userRank, leaderboard]);\n\n  return (\n    <motion.button\n      initial={{ opacity: 0, y: -20 }}\n      animate={{ opacity: 1, y: 0 }}\n      onClick={() => setActiveTab('leaderboard')}\n      className=\"flex items-center gap-3 px-4 py-3 bg-neutral-900/95 backdrop-blur-sm border border-neutral-800 rounded-xl shadow-lg hover:border-yellow-500/30 transition-all group\"\n    >\n      {userRank ? (\n        <>\n          <div className=\"flex items-center justify-center w-10 h-10 rounded-lg bg-gradient-to-br from-yellow-500/20 to-amber-500/20 border border-yellow-500/30\">\n            <Trophy size={20} className=\"text-yellow-400\" />\n          </div>\n          <div className=\"text-left\">\n            <p className=\"text-xs text-neutral-500 uppercase tracking-wide\">Your Rank</p>\n            <div className=\"flex items-baseline gap-2\">\n              <span className=\"text-xl font-bold text-yellow-400\">#{userRank.genderRank}</span>\n              <span className=\"text-xs text-neutral-500\">Top {userRank.percentile.toFixed(1)}%</span>\n            </div>\n          </div>\n          <ChevronRight size={16} className=\"text-neutral-600 group-hover:text-yellow-400 transition-colors ml-1\" />\n        </>\n      ) : (\n        <>\n          <div className=\"flex items-center justify-center w-10 h-10 rounded-lg bg-neutral-800 border border-neutral-700\">\n            <Trophy size={20} className=\"text-neutral-500\" />\n          </div>\n          <div className=\"text-left\">\n            <p className=\"text-xs text-neutral-500 uppercase tracking-wide\">Your Rank</p>\n            <span className=\"text-sm text-neutral-400\">\n              {isAuthenticated ? 'Not ranked yet' : 'Sign in to rank'}\n            </span>\n          </div>\n          <ChevronRight size={16} className=\"text-neutral-600 group-hover:text-neutral-400 transition-colors ml-1\" />\n        </>\n      )}\n    </motion.button>\n  );\n}\n\n// ============================================\n// MOBILE HEADER\n// ============================================\n\ninterface MobileHeaderProps {\n  onMenuClick: () => void;\n}\n\nfunction MobileHeader({ onMenuClick }: MobileHeaderProps) {\n  const { activeTab, overallScore } = useResults();\n  const currentTab = TABS.find((t) => t.id === activeTab);\n\n  return (\n    <header className=\"flex items-center justify-between px-4 py-3 bg-neutral-950 border-b border-neutral-800\">\n      <button\n        onClick={onMenuClick}\n        className=\"p-2 hover:bg-neutral-800 rounded-lg transition-colors\"\n      >\n        <Menu size={20} className=\"text-neutral-400\" />\n      </button>\n      <div className=\"flex items-center gap-2\">\n        {currentTab?.icon}\n        <span className=\"font-medium text-white\">{currentTab?.label}</span>\n      </div>\n      <div className=\"flex items-center gap-2\">\n        <RankBadge size=\"sm\" alwaysShow />\n        <div className=\"w-6 h-6 rounded-full bg-cyan-500/20 flex items-center justify-center\">\n          <span className=\"text-xs text-cyan-400 font-bold\">{Math.round(overallScore)}</span>\n        </div>\n      </div>\n    </header>\n  );\n}\n\n// ============================================\n// MAIN LAYOUT\n// ============================================\n\ninterface ResultsLayoutProps {\n  children: React.ReactNode;\n}\n\nexport function ResultsLayout({ children }: ResultsLayoutProps) {\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n  const { activeTab } = useResults();\n\n  return (\n    <div className=\"flex min-h-screen bg-black\">\n      {/* Desktop Sidebar */}\n      <aside className=\"hidden md:flex md:w-[280px] md:flex-col md:fixed md:inset-y-0 z-40\">\n        <Sidebar />\n      </aside>\n\n      {/* Mobile Menu Overlay */}\n      <AnimatePresence>\n        {mobileMenuOpen && (\n          <>\n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              onClick={() => setMobileMenuOpen(false)}\n              className=\"fixed inset-0 bg-black/60 z-40 md:hidden\"\n            />\n            <motion.aside\n              initial={{ x: -280 }}\n              animate={{ x: 0 }}\n              exit={{ x: -280 }}\n              transition={{ type: 'spring', damping: 25, stiffness: 200 }}\n              className=\"fixed inset-y-0 left-0 w-[280px] z-50 md:hidden\"\n            >\n              <Sidebar onClose={() => setMobileMenuOpen(false)} />\n            </motion.aside>\n          </>\n        )}\n      </AnimatePresence>\n\n      {/* Main Content */}\n      <div className=\"flex-1 md:pl-[280px] flex flex-col min-h-screen\">\n        {/* Mobile Header */}\n        <div className=\"md:hidden\">\n          <MobileHeader onMenuClick={() => setMobileMenuOpen(true)} />\n        </div>\n\n        {/* Desktop Floating Rank Indicator */}\n        <div className=\"hidden md:block fixed top-4 right-4 z-30\">\n          <FloatingRankCard />\n        </div>\n\n        {/* Content Area - no overflow so sticky works */}\n        <main className=\"flex-1\">\n          <AnimatePresence mode=\"wait\">\n            <motion.div\n              key={activeTab}\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -10 }}\n              transition={{ duration: 0.2 }}\n            >\n              {children}\n            </motion.div>\n          </AnimatePresence>\n        </main>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// TAB CONTENT WRAPPER\n// ============================================\n\ninterface TabContentProps {\n  title: string;\n  subtitle?: string;\n  children: React.ReactNode;\n  rightContent?: React.ReactNode;\n}\n\nexport function TabContent({ title, subtitle, children, rightContent }: TabContentProps) {\n  return (\n    <div className=\"p-4 md:p-6 lg:p-8 max-w-7xl mx-auto\">\n      {/* Header */}\n      <div className=\"flex flex-col md:flex-row md:items-center md:justify-between mb-6\">\n        <div>\n          <h1 className=\"text-2xl md:text-3xl font-bold text-white\">{title}</h1>\n          {subtitle && (\n            <p className=\"text-neutral-400 mt-1\">{subtitle}</p>\n          )}\n        </div>\n        {rightContent && (\n          <div className=\"mt-4 md:mt-0\">{rightContent}</div>\n        )}\n      </div>\n\n      {/* Content */}\n      {children}\n    </div>\n  );\n}\n","numLines":337,"startLine":1,"totalLines":337}}}
{"parentUuid":"3d40822f-2927-4873-82f3-7807ec1f2fde","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RJAvGjCsYhFggU74Z9gUw2","type":"tool_result","content":"     1→/**\n     2→ * Scoring Calculator\n     3→ * Core scoring algorithm functions extracted from harmony-scoring.ts\n     4→ *\n     5→ * Features:\n     6→ * - Exponential decay scoring with per-metric decay rates\n     7→ * - Bezier curve custom scoring for non-linear measurements\n     8→ * - Directional/Dimorphic scoring (polarity support)\n     9→ * - Quality tiers and severity levels\n    10→ */\n    11→\n    12→import {\n    13→  Point,\n    14→  QualityTier,\n    15→  SeverityLevel,\n    16→  MeasurementUnit,\n    17→  MetricConfig,\n    18→  CurvePoint,\n    19→  FlawMapping,\n    20→} from './types';\n    21→import { BEZIER_CURVES } from '@/lib/bezier-curves';\n    22→\n    23→// ============================================\n    24→// FLAW MAPPINGS\n    25→// ============================================\n    26→\n    27→export const METRIC_FLAW_MAPPINGS: Record<string, FlawMapping[]> = {\n    28→  anteriorFacialDepth: [\n    29→    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Anterior Facial Depth measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n    30→  ],\n    31→  bitemporalWidth: [\n    32→    { category: 'Upper Third', flawName: 'Narrow forehead', confidence: 'confirmed', reasoning: 'Reduced bitemporal width indicates a narrower than ideal forehead relative to the cheekbones. This disrupts facial harmony by creating a compressed hairline and forehead, altering the overall shape of the face.' },\n    33→  ],\n    34→  cheekboneHeight: [\n    35→    { category: 'Midface/Face Shape', flawName: 'Low-set cheekbones', confidence: 'confirmed', reasoning: 'Reduced cheekbone height indicates that the cheekbones are positioned lower than ideal. This disrupts facial harmony by creating an unpronounced appearance to the cheekbones and facial structure.' },\n    36→  ],\n    37→  cheekFullness: [\n    38→    { category: 'Midface/Face Shape', flawName: 'Hollow/Gaunt midface', confidence: 'confirmed', reasoning: 'Reduced cheek fullness indicates volume loss or hollow cheeks. This disrupts facial harmony by creating a gaunt or aged appearance, particularly important in South Asian and East Asian beauty standards.' },\n    39→  ],\n    40→  eyeAspectRatio: [\n    41→    { category: 'Eyes', flawName: 'Overly round eye shape', confidence: 'confirmed', reasoning: 'A reduced eye aspect ratio indicates overly narrow eyes relative to their height. This disrupts facial harmony by creating an overly surprised appearance and reducing angular definition.' },\n    42→  ],\n    43→  eyeSeparationRatio: [\n    44→    { category: 'Eyes', flawName: 'Close-set eyes', confidence: 'confirmed', reasoning: 'Reduced eye separation indicates close-set eyes. This disrupts facial harmony by making the eye area appear too compressed.' },\n    45→  ],\n    46→  eyebrowLowSetedness: [\n    47→    { category: 'Eyes', flawName: 'Medium-set eyebrows', confidence: 'confirmed', reasoning: 'Increased eyebrow low setedness indicates eyebrows that are positioned higher than ideal. This disrupts facial harmony by reducing the overall visual impact of the eyebrows and framing of the eyes.' },\n    48→  ],\n    49→  faceWidthToHeight: [\n    50→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced face width to height ratio indicates an overly long midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    51→  ],\n    52→  facialDepthToHeight: [\n    53→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'Reduced facial depth to height ratio indicates insufficient mid-face projection relative to height. This disrupts facial harmony by creating the appearance of a flat midface.' },\n    54→  ],\n    55→  gonialAngle: [\n    56→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony in the lower face.' },\n    57→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    58→  ],\n    59→  holdawayHLine: [\n    60→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'Decreased H-line indicates the lips are positioned too far in front of the line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    61→  ],\n    62→  interiorMidfaceProjectionAngle: [\n    63→    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Interior Midface Projection Angle measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n    64→  ],\n    65→  ipsilateralAlarAngle: [\n    66→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A decreased ipsilateral alar angle indicates an overly narrow interior midface. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    67→  ],\n    68→  jawFrontalAngle: [\n    69→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A narrower jaw frontal angle indicates a steeper jawline or overly wide chin. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    70→  ],\n    71→  jawSlope: [\n    72→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'The Jaw Slope measurement is above the ideal range. This disrupts facial harmony in the lower face.' },\n    73→  ],\n    74→  lateralCanthalTilt: [\n    75→    { category: 'Eyes', flawName: 'Insufficient eye tilt', confidence: 'confirmed', reasoning: 'A decreased lateral canthal tilt indicates insufficiently upturned eyes. This disrupts facial harmony by creating a less alert and youthful appearance.' },\n    76→  ],\n    77→  burstoneLowerLip: [\n    78→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the Burstone line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    79→  ],\n    80→  eLineLowerLip: [\n    81→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned too far in front of the E-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    82→  ],\n    83→  sLineLowerLip: [\n    84→    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the S-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n    85→  ],\n    86→  lowerThirdProportion: [\n    87→    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'The upper jaw is too long relative to lower jaw, possibly from a long upper jaw or short lower jaw, or a combination of both. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n    88→  ],\n    89→  mandibularPlaneAngle: [\n    90→    { category: 'Occlusion/Jaw Growth', flawName: 'Hyper-divergent jaw growth', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by elongating the lower face.' },\n    91→    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony in the lower face.' },\n    92→    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n    93→  ],\n    94→  midfaceRatio: [\n    95→    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    96→    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n    97→  ],\n    98→  nasofacialAngle: [\n    99→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A smaller nasofacial angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n   100→  ],\n   101→  nasofrontalAngle: [\n   102→    { category: 'Upper Third', flawName: 'Soft and weak brow ridge', confidence: 'confirmed', reasoning: 'An increased nasofrontal angle indicates reduced brow ridge prominence and angularity. This disrupts facial harmony by creating a less defined upper face.' },\n   103→  ],\n   104→  nasomentaAngle: [\n   105→    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A larger nasomental angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n   106→  ],\n   107→  noseBridgeWidth: [\n   108→    { category: 'Nose', flawName: 'Overly narrow nose bridge', confidence: 'confirmed', reasoning: 'The Nose Bridge to Nose Width measurement is above the ideal range. This disrupts facial harmony by creating an unbalanced nasal profile.' },\n   109→  ],\n   110→  orbitalVector: [\n   111→    { category: 'Eyes', flawName: 'Sunken orbital region', confidence: 'confirmed', reasoning: 'A decreased orbital vector indicates insufficient projection and volume underneath the eye. This disrupts facial harmony due to the lacking volume underneath the eyes, reducing vibrancy and youthfulness.' },\n   112→  ],\n   113→  ramusToMandibleRatio: [\n   114→    { category: 'Jaw Shape', flawName: 'Short ramus', confidence: 'confirmed', reasoning: 'A reduced ramus-to-mandible ratio indicates a shorter than ideal vertical jawbone (ramus) when compared to the mandible. This disrupts facial harmony by reducing jaw height and definition.' },\n   115→  ],\n   116→  submentalCervicalAngle: [\n   117→    { category: 'Neck', flawName: 'Round neck region', confidence: 'confirmed', reasoning: 'An increased submental cervical angle indicates a round neck region, possibly from excess submental fat or tissue. This disrupts facial harmony by reducing neck definition.' },\n   118→  ],\n   119→  totalFacialWidthToHeight: [\n   120→    { category: 'Midface/Face Shape', flawName: 'Overly long face shape', confidence: 'confirmed', reasoning: 'An increased total facial width to height ratio indicates an overly long face relative to its height. This disrupts facial harmony by creating a vertically stretched appearance to the face.' },\n   121→  ],\n   122→};\n   123→\n   124→// ============================================\n   125→// CUSTOM BEZIER CURVES (Ethnicity-specific override)\n   126→// ============================================\n   127→\n   128→export const METRIC_CUSTOM_CURVES: Record<string, CurvePoint[]> = {\n   129→  faceWidthToHeight: [\n   130→    { x: 1.49, y: 0, leftHandleX: 1.44, leftHandleY: 0, rightHandleX: 1.55, rightHandleY: 0 },\n   131→    { x: 1.68, y: 1.05, leftHandleX: 1.62, leftHandleY: 0.36, rightHandleX: 1.71, rightHandleY: 1.58 },\n   132→    { x: 1.77, y: 3.07, leftHandleX: 1.74, leftHandleY: 2.15, rightHandleX: 1.79, rightHandleY: 3.88 },\n   133→    { x: 1.83, y: 5.83, leftHandleX: 1.8, leftHandleY: 4.64, rightHandleX: 1.84, rightHandleY: 6.85 },\n   134→    { x: 1.89, y: 8.7, leftHandleX: 1.88, leftHandleY: 8.3, rightHandleX: 1.92, rightHandleY: 9.5 },\n   135→    { x: 1.96, y: 10, leftHandleX: 1.96, leftHandleY: 10, rightHandleX: 1.96, rightHandleY: 10, fixed: true },\n   136→    { x: 2, y: 10, leftHandleX: 2, leftHandleY: 10, rightHandleX: 2, rightHandleY: 10 },\n   137→    { x: 2.07, y: 8.7, leftHandleX: 2.04, leftHandleY: 9.5, rightHandleX: 2.08, rightHandleY: 8.3 },\n   138→    { x: 2.13, y: 5.83, leftHandleX: 2.12, leftHandleY: 6.85, rightHandleX: 2.16, rightHandleY: 4.64 },\n   139→    { x: 2.19, y: 3.07, leftHandleX: 2.17, leftHandleY: 3.88, rightHandleX: 2.22, rightHandleY: 2.15 },\n   140→    { x: 2.28, y: 1.05, leftHandleX: 2.25, leftHandleY: 1.58, rightHandleX: 2.34, rightHandleY: 0.36 },\n   141→    { x: 2.47, y: 0, leftHandleX: 2.41, leftHandleY: 0, rightHandleX: 2.52, rightHandleY: 0 },\n   142→  ],\n   143→  lowerThirdProportion: [\n   144→    { x: 25.6, y: 0, leftHandleX: 24.8, leftHandleY: 0, rightHandleX: 26.4, rightHandleY: 0 },\n   145→    { x: 28.01, y: 1.58, leftHandleX: 27.23, leftHandleY: 0.53, rightHandleX: 28.27, rightHandleY: 1.97 },\n   146→    { x: 28.83, y: 3.21, leftHandleX: 28.62, leftHandleY: 2.59, rightHandleX: 29.03, rightHandleY: 3.76 },\n   147→    { x: 29.63, y: 5.85, leftHandleX: 29.38, leftHandleY: 4.64, rightHandleX: 29.84, rightHandleY: 6.61 },\n   148→    { x: 30.27, y: 8.56, leftHandleX: 30.1, leftHandleY: 7.71, rightHandleX: 30.52, rightHandleY: 9.42 },\n   149→    { x: 31, y: 10, leftHandleX: 30.88, leftHandleY: 10, rightHandleX: 31.13, rightHandleY: 10, fixed: true },\n   150→    { x: 33.5, y: 10, leftHandleX: 33.38, leftHandleY: 10, rightHandleX: 33.63, rightHandleY: 10 },\n   151→    { x: 34.23, y: 8.56, leftHandleX: 33.98, leftHandleY: 9.42, rightHandleX: 34.4, rightHandleY: 7.71 },\n   152→    { x: 34.87, y: 5.85, leftHandleX: 34.66, leftHandleY: 6.61, rightHandleX: 35.12, rightHandleY: 4.64 },\n   153→    { x: 35.67, y: 3.21, leftHandleX: 35.47, leftHandleY: 3.76, rightHandleX: 35.88, rightHandleY: 2.59 },\n   154→    { x: 36.49, y: 1.58, leftHandleX: 36.23, leftHandleY: 1.97, rightHandleX: 37.27, rightHandleY: 0.53 },\n   155→    { x: 38.9, y: 0, leftHandleX: 38.1, leftHandleY: 0, rightHandleX: 39.7, rightHandleY: 0 },\n   156→  ],\n   157→  eyeAspectRatio: [\n   158→    { x: 1.44, y: 0, leftHandleX: 1.18, leftHandleY: 0, rightHandleX: 1.75, rightHandleY: 0.38 },\n   159→    { x: 2.07, y: 1.66, leftHandleX: 1.96, leftHandleY: 1.08, rightHandleX: 2.24, rightHandleY: 2.63 },\n   160→    { x: 2.42, y: 4.34, leftHandleX: 2.35, leftHandleY: 3.6, rightHandleX: 2.52, rightHandleY: 5.5 },\n   161→    { x: 2.71, y: 7.96, leftHandleX: 2.65, leftHandleY: 7.13, rightHandleX: 2.8, rightHandleY: 9.08 },\n   162→    { x: 3, y: 10, leftHandleX: 2.98, leftHandleY: 10, rightHandleX: 3.03, rightHandleY: 10, fixed: true },\n   163→    { x: 3.5, y: 10, leftHandleX: 3.48, leftHandleY: 10, rightHandleX: 3.53, rightHandleY: 10 },\n   164→    { x: 3.79, y: 7.96, leftHandleX: 3.7, leftHandleY: 9.08, rightHandleX: 3.85, rightHandleY: 7.13 },\n   165→    { x: 4.08, y: 4.34, leftHandleX: 3.98, leftHandleY: 5.5, rightHandleX: 4.15, rightHandleY: 3.6 },\n   166→    { x: 4.43, y: 1.66, leftHandleX: 4.26, leftHandleY: 2.63, rightHandleX: 4.54, rightHandleY: 1.08 },\n   167→    { x: 5.06, y: 0, leftHandleX: 4.75, leftHandleY: 0.38, rightHandleX: 5.32, rightHandleY: 0 },\n   168→  ],\n   169→  // Note: Additional curves can be added from METRIC_CUSTOM_CURVES in harmony-scoring.ts\n   170→};\n   171→\n   172→// ============================================\n   173→// CORE SCORING FUNCTIONS\n   174→// ============================================\n   175→\n   176→/**\n   177→ * Exponential Decay Scoring Algorithm with Directional/Dimorphic Support\n   178→ *\n   179→ * Standard: score = maxScore * e^(-decayRate * deviation)\n   180→ *\n   181→ * Directional scoring (polarity):\n   182→ * - 'higher_is_better': Values above safeFloor but below ideal get softZoneScore\n   183→ *   Example: Canthal Tilt of 3 degrees is still positive/good, just not peak ideal (6-8 degrees)\n   184→ * - 'lower_is_better': Values below safeCeiling but above ideal get softZoneScore\n   185→ *   Example: Short philtrum is still attractive even if shorter than \"ideal\"\n   186→ */\n   187→export function calculateMetricScore(\n   188→  value: number,\n   189→  config: MetricConfig\n   190→): number {\n   191→  const {\n   192→    id,\n   193→    idealMin,\n   194→    idealMax,\n   195→    decayRate,\n   196→    maxScore,\n   197→    customCurve,\n   198→    polarity = 'balanced',\n   199→    safeFloor,\n   200→    safeCeiling,\n   201→    softZoneScore = 8.0, // Default \"Good\" score for acceptable-but-not-ideal values\n   202→  } = config;\n   203→\n   204→  // IMPORTANT: Check demographic-adjusted ideal range FIRST\n   205→  // This ensures that demographic overrides are respected even when Bezier curves exist\n   206→  // (Bezier curves are optimized for base ranges and don't auto-adjust for demographics)\n   207→  if (value >= idealMin && value <= idealMax) {\n   208→    return maxScore;\n   209→  }\n   210→\n   211→  // Use custom curve if available in config\n   212→  if (customCurve && customCurve.mode === 'custom') {\n   213→    const bezierScore = interpolateCustomCurve(value, customCurve.points, maxScore);\n   214→    // If Bezier returns -1, it means value is out of range with edge y=0\n   215→    // Fall through to exponential decay instead of returning 0\n   216→    if (bezierScore >= 0) {\n   217→      return bezierScore;\n   218→    }\n   219→  }\n   220→\n   221→  // Check for pre-defined Bezier curve from harmony curves (66 metrics)\n   222→  const bezierCurve = BEZIER_CURVES[id];\n   223→  if (bezierCurve && bezierCurve.mode === 'custom') {\n   224→    const bezierScore = interpolateCustomCurve(value, bezierCurve.points, maxScore);\n   225→    // If Bezier returns -1, it means value is out of range with edge y=0\n   226→    // Fall through to exponential decay instead of returning 0\n   227→    if (bezierScore >= 0) {\n   228→      return bezierScore;\n   229→    }\n   230→  }\n   231→\n   232→  // Handle directional/dimorphic scoring\n   233→  if (polarity === 'higher_is_better' && safeFloor !== undefined) {\n   234→    // Higher values are good. Only values below safeFloor are true weaknesses.\n   235→    if (value >= safeFloor && value < idealMin) {\n   236→      // Value is in the \"acceptable but not ideal\" zone\n   237→      // Give a passing score that decreases linearly as we approach the floor\n   238→      const zoneRange = idealMin - safeFloor;\n   239→      const distanceFromIdeal = idealMin - value;\n   240→      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n   241→      // Linear interpolation: idealMin -> maxScore, safeFloor -> softZoneScore\n   242→      return maxScore - t * (maxScore - softZoneScore);\n   243→    }\n   244→    if (value >= idealMax) {\n   245→      // Values above ideal are still excellent for 'higher_is_better'\n   246→      // Apply gentler decay (1/3 the normal rate)\n   247→      const deviation = value - idealMax;\n   248→      const gentleDecay = decayRate / 3;\n   249→      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n   250→    }\n   251→    // Below safeFloor - apply normal (or harsher) exponential decay\n   252→    if (value < safeFloor) {\n   253→      const deviation = safeFloor - value;\n   254→      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n   255→    }\n   256→  }\n   257→\n   258→  if (polarity === 'lower_is_better' && safeCeiling !== undefined) {\n   259→    // Lower values are good. Only values above safeCeiling are true weaknesses.\n   260→    if (value <= safeCeiling && value > idealMax) {\n   261→      // Value is in the \"acceptable but not ideal\" zone\n   262→      const zoneRange = safeCeiling - idealMax;\n   263→      const distanceFromIdeal = value - idealMax;\n   264→      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n   265→      // Linear interpolation: idealMax -> maxScore, safeCeiling -> softZoneScore\n   266→      return maxScore - t * (maxScore - softZoneScore);\n   267→    }\n   268→    if (value <= idealMin) {\n   269→      // Values below ideal are still excellent for 'lower_is_better'\n   270→      // Apply gentler decay (1/3 the normal rate)\n   271→      const deviation = idealMin - value;\n   272→      const gentleDecay = decayRate / 3;\n   273→      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n   274→    }\n   275→    // Above safeCeiling - apply normal exponential decay\n   276→    if (value > safeCeiling) {\n   277→      const deviation = value - safeCeiling;\n   278→      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n   279→    }\n   280→  }\n   281→\n   282→  // Default balanced scoring: deviation in either direction is equally bad\n   283→  const deviation = value < idealMin\n   284→    ? idealMin - value\n   285→    : value - idealMax;\n   286→\n   287→  // Exponential decay\n   288→  const score = maxScore * Math.exp(-decayRate * deviation);\n   289→\n   290→  return Math.max(0, Math.min(maxScore, score));\n   291→}\n   292→\n   293→/**\n   294→ * Check if a metric value is in an \"acceptable\" zone (not a true weakness).\n   295→ * Used by InsightsEngine to prevent false positives.\n   296→ */\n   297→export function isValueAcceptable(\n   298→  value: number,\n   299→  config: MetricConfig\n   300→): { acceptable: boolean; reason: string } {\n   301→  const {\n   302→    idealMin,\n   303→    idealMax,\n   304→    polarity = 'balanced',\n   305→    safeFloor,\n   306→    safeCeiling,\n   307→  } = config;\n   308→\n   309→  // Within ideal range is always acceptable\n   310→  if (value >= idealMin && value <= idealMax) {\n   311→    return { acceptable: true, reason: 'within_ideal' };\n   312→  }\n   313→\n   314→  // Check directional acceptability\n   315→  if (polarity === 'higher_is_better') {\n   316→    if (value >= idealMax) {\n   317→      return { acceptable: true, reason: 'above_ideal_higher_is_better' };\n   318→    }\n   319→    if (safeFloor !== undefined && value >= safeFloor) {\n   320→      return { acceptable: true, reason: 'above_safe_floor' };\n   321→    }\n   322→    // Below safe floor - true weakness\n   323→    return { acceptable: false, reason: 'below_safe_floor' };\n   324→  }\n   325→\n   326→  if (polarity === 'lower_is_better') {\n   327→    if (value <= idealMin) {\n   328→      return { acceptable: true, reason: 'below_ideal_lower_is_better' };\n   329→    }\n   330→    if (safeCeiling !== undefined && value <= safeCeiling) {\n   331→      return { acceptable: true, reason: 'below_safe_ceiling' };\n   332→    }\n   333→    // Above safe ceiling - true weakness\n   334→    return { acceptable: false, reason: 'above_safe_ceiling' };\n   335→  }\n   336→\n   337→  // Balanced polarity - outside ideal is not acceptable\n   338→  return { acceptable: false, reason: 'outside_ideal_balanced' };\n   339→}\n   340→\n   341→/**\n   342→ * Interpolate custom Bezier curve for scoring\n   343→ * Uses cubic Bezier interpolation with control handles for smooth curves\n   344→ *\n   345→ * IMPORTANT: When value is outside the curve range and the edge y-value is 0,\n   346→ * returns -1 to signal the caller should use exponential decay fallback.\n   347→ * This prevents artificially returning 0 for values just outside the curve.\n   348→ */\n   349→export function interpolateCustomCurve(\n   350→  value: number,\n   351→  points: CurvePoint[],\n   352→  maxScore: number\n   353→): number {\n   354→  void maxScore; // Reserved for future custom curve implementations\n   355→  if (points.length === 0) return -1; // Signal to use fallback\n   356→\n   357→  // Sort points by x value\n   358→  const sortedPoints = [...points].sort((a, b) => a.x - b.x);\n   359→\n   360→  // Handle out-of-range values\n   361→  // If edge y-value is 0, return -1 to signal exponential decay fallback should be used\n   362→  if (value <= sortedPoints[0].x) {\n   363→    const edgeY = sortedPoints[0].y;\n   364→    // If edge score is 0, signal to use exponential decay fallback\n   365→    return edgeY <= 0 ? -1 : edgeY;\n   366→  }\n   367→  if (value >= sortedPoints[sortedPoints.length - 1].x) {\n   368→    const edgeY = sortedPoints[sortedPoints.length - 1].y;\n   369→    // If edge score is 0, signal to use exponential decay fallback\n   370→    return edgeY <= 0 ? -1 : edgeY;\n   371→  }\n   372→\n   373→  // Find bracketing points\n   374→  let lowerIndex = 0;\n   375→  for (let i = 0; i < sortedPoints.length - 1; i++) {\n   376→    if (value >= sortedPoints[i].x && value <= sortedPoints[i + 1].x) {\n   377→      lowerIndex = i;\n   378→      break;\n   379→    }\n   380→  }\n   381→\n   382→  const p0 = sortedPoints[lowerIndex];\n   383→  const p3 = sortedPoints[lowerIndex + 1];\n   384→\n   385→  // Check if we have Bezier control handles\n   386→  const hasHandles = p0.rightHandleX !== undefined && p3.leftHandleX !== undefined;\n   387→\n   388→  if (hasHandles) {\n   389→    // Cubic Bezier interpolation with control points\n   390→    const p1x = p0.rightHandleX!;\n   391→    const p1y = p0.rightHandleY ?? p0.y;\n   392→    const p2x = p3.leftHandleX!;\n   393→    const p2y = p3.leftHandleY ?? p3.y;\n   394→\n   395→    // Find t parameter for given x value using Newton-Raphson iteration\n   396→    let t = (value - p0.x) / (p3.x - p0.x); // Initial guess\n   397→\n   398→    // Newton-Raphson iterations to find t where B_x(t) = value\n   399→    for (let iter = 0; iter < 10; iter++) {\n   400→      const bx = cubicBezier(p0.x, p1x, p2x, p3.x, t);\n   401→      const bxDerivative = cubicBezierDerivative(p0.x, p1x, p2x, p3.x, t);\n   402→\n   403→      if (Math.abs(bxDerivative) < 1e-10) break;\n   404→\n   405→      const newT = t - (bx - value) / bxDerivative;\n   406→      if (Math.abs(newT - t) < 1e-10) break;\n   407→      t = Math.max(0, Math.min(1, newT));\n   408→    }\n   409→\n   410→    // Calculate y using the found t parameter\n   411→    return cubicBezier(p0.y, p1y, p2y, p3.y, t);\n   412→  } else {\n   413→    // Smooth interpolation using Catmull-Rom spline\n   414→    // This provides smoother curves than linear interpolation\n   415→    const t = (value - p0.x) / (p3.x - p0.x);\n   416→\n   417→    // Get neighboring points for spline calculation\n   418→    const pMinus1 = lowerIndex > 0 ? sortedPoints[lowerIndex - 1] : p0;\n   419→    const p4 = lowerIndex + 2 < sortedPoints.length ? sortedPoints[lowerIndex + 2] : p3;\n   420→\n   421→    // Catmull-Rom spline interpolation\n   422→    return catmullRomSpline(pMinus1.y, p0.y, p3.y, p4.y, t);\n   423→  }\n   424→}\n   425→\n   426→/**\n   427→ * Cubic Bezier curve evaluation: B(t) = (1-t)^3*P0 + 3*(1-t)^2*t*P1 + 3*(1-t)*t^2*P2 + t^3*P3\n   428→ */\n   429→export function cubicBezier(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   430→  const mt = 1 - t;\n   431→  const mt2 = mt * mt;\n   432→  const mt3 = mt2 * mt;\n   433→  const t2 = t * t;\n   434→  const t3 = t2 * t;\n   435→  return mt3 * p0 + 3 * mt2 * t * p1 + 3 * mt * t2 * p2 + t3 * p3;\n   436→}\n   437→\n   438→/**\n   439→ * Cubic Bezier derivative: B'(t) = 3*(1-t)^2*(P1-P0) + 6*(1-t)*t*(P2-P1) + 3*t^2*(P3-P2)\n   440→ */\n   441→export function cubicBezierDerivative(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   442→  const mt = 1 - t;\n   443→  return 3 * mt * mt * (p1 - p0) + 6 * mt * t * (p2 - p1) + 3 * t * t * (p3 - p2);\n   444→}\n   445→\n   446→/**\n   447→ * Catmull-Rom spline interpolation for smooth curves without explicit handles\n   448→ */\n   449→export function catmullRomSpline(p0: number, p1: number, p2: number, p3: number, t: number): number {\n   450→  const t2 = t * t;\n   451→  const t3 = t2 * t;\n   452→\n   453→  // Catmull-Rom coefficients with tension = 0.5\n   454→  const a = -0.5 * p0 + 1.5 * p1 - 1.5 * p2 + 0.5 * p3;\n   455→  const b = p0 - 2.5 * p1 + 2 * p2 - 0.5 * p3;\n   456→  const c = -0.5 * p0 + 0.5 * p2;\n   457→  const d = p1;\n   458→\n   459→  return a * t3 + b * t2 + c * t + d;\n   460→}\n   461→\n   462→/**\n   463→ * Calculate standardized score (0-10 normalized)\n   464→ */\n   465→export function standardizeScore(score: number, maxScore: number): number {\n   466→  return (score / maxScore) * 10;\n   467→}\n   468→\n   469→/**\n   470→ * Determine quality tier based on score\n   471→ */\n   472→export function getQualityTier(score: number, maxScore: number = 10): QualityTier {\n   473→  const normalized = (score / maxScore) * 100;\n   474→\n   475→  if (normalized >= 90) return 'ideal';\n   476→  if (normalized >= 70) return 'excellent';\n   477→  if (normalized >= 50) return 'good';\n   478→  return 'below_average';\n   479→}\n   480→\n   481→/**\n   482→ * Determine severity level based on score\n   483→ */\n   484→export function getSeverityLevel(score: number, maxScore: number = 10): SeverityLevel {\n   485→  const normalized = (score / maxScore) * 100;\n   486→\n   487→  if (normalized >= 85) return 'optimal';\n   488→  if (normalized >= 70) return 'minor';\n   489→  if (normalized >= 50) return 'moderate';\n   490→  if (normalized >= 30) return 'major';\n   491→  if (normalized >= 15) return 'severe';\n   492→  return 'extremely_severe';\n   493→}\n   494→\n   495→/**\n   496→ * Calculate deviation description\n   497→ */\n   498→export function getDeviationDescription(\n   499→  value: number,\n   500→  idealMin: number,\n   501→  idealMax: number,\n   502→  unit: MeasurementUnit\n   503→): { deviation: number; direction: 'above' | 'below' | 'within'; description: string } {\n   504→  if (value >= idealMin && value <= idealMax) {\n   505→    return { deviation: 0, direction: 'within', description: 'within ideal range' };\n   506→  }\n   507→\n   508→  const unitLabel = getUnitLabel(unit);\n   509→\n   510→  if (value < idealMin) {\n   511→    const dev = idealMin - value;\n   512→    return {\n   513→      deviation: dev,\n   514→      direction: 'below',\n   515→      description: `${dev.toFixed(2)}${unitLabel} below ideal`,\n   516→    };\n   517→  }\n   518→\n   519→  const dev = value - idealMax;\n   520→  return {\n   521→    deviation: dev,\n   522→    direction: 'above',\n   523→    description: `${dev.toFixed(2)}${unitLabel} above ideal`,\n   524→  };\n   525→}\n   526→\n   527→/**\n   528→ * Get unit label for display\n   529→ */\n   530→export function getUnitLabel(unit: MeasurementUnit): string {\n   531→  switch (unit) {\n   532→    case 'ratio': return 'x';\n   533→    case 'percent': return '%';\n   534→    case 'degrees': return '\\u00B0';\n   535→    case 'mm': return 'mm';\n   536→    default: return '';\n   537→  }\n   538→}\n   539→\n   540→// ============================================\n   541→// GEOMETRY HELPERS\n   542→// ============================================\n   543→\n   544→/**\n   545→ * Calculate distance between two points\n   546→ */\n   547→export function distance(p1: Point, p2: Point): number {\n   548→  return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));\n   549→}\n   550→\n   551→/**\n   552→ * Calculate angle at vertex point (in degrees)\n   553→ */\n   554→export function calculateAngle(p1: Point, vertex: Point, p2: Point): number {\n   555→  const v1 = { x: p1.x - vertex.x, y: p1.y - vertex.y };\n   556→  const v2 = { x: p2.x - vertex.x, y: p2.y - vertex.y };\n   557→\n   558→  const dot = v1.x * v2.x + v1.y * v2.y;\n   559→  const cross = v1.x * v2.y - v1.y * v2.x;\n   560→\n   561→  const angle = Math.atan2(cross, dot) * (180 / Math.PI);\n   562→  return Math.abs(angle);\n   563→}\n   564→\n   565→/**\n   566→ * Calculate perpendicular distance from point to line (signed)\n   567→ */\n   568→export function perpendicularDistance(\n   569→  point: Point,\n   570→  lineStart: Point,\n   571→  lineEnd: Point\n   572→): number {\n   573→  const A = point.x - lineStart.x;\n   574→  const B = point.y - lineStart.y;\n   575→  const C = lineEnd.x - lineStart.x;\n   576→  const D = lineEnd.y - lineStart.y;\n   577→\n   578→  const dot = A * C + B * D;\n   579→  const lenSq = C * C + D * D;\n   580→  const param = lenSq !== 0 ? dot / lenSq : -1;\n   581→\n   582→  let xx: number, yy: number;\n   583→\n   584→  if (param < 0) {\n   585→    xx = lineStart.x;\n   586→    yy = lineStart.y;\n   587→  } else if (param > 1) {\n   588→    xx = lineEnd.x;\n   589→    yy = lineEnd.y;\n   590→  } else {\n   591→    xx = lineStart.x + param * C;\n   592→    yy = lineStart.y + param * D;\n   593→  }\n   594→\n   595→  const dx = point.x - xx;\n   596→  const dy = point.y - yy;\n   597→\n   598→  const sign =\n   599→    (lineEnd.y - lineStart.y) * point.x -\n   600→      (lineEnd.x - lineStart.x) * point.y +\n   601→      lineEnd.x * lineStart.y -\n   602→      lineEnd.y * lineStart.x >=\n   603→    0\n   604→      ? 1\n   605→      : -1;\n   606→\n   607→  return sign * Math.sqrt(dx * dx + dy * dy);\n   608→}\n   609→\n   610→// ============================================\n   611→// PERCENTILE & PSL CONVERSION\n   612→// ============================================\n   613→\n   614→/**\n   615→ * Calculate percentile from harmony score\n   616→ */\n   617→export function calculateHarmonyPercentile(score: number): number {\n   618→  // Based on normal distribution with mean=5, stdDev=1.5\n   619→  const mean = 5;\n   620→  const stdDev = 1.5;\n   621→  const z = (score - mean) / stdDev;\n   622→  return normalCDF(z) * 100;\n   623→}\n   624→\n   625→/**\n   626→ * Standard normal CDF approximation\n   627→ */\n   628→export function normalCDF(z: number): number {\n   629→  const a1 = 0.254829592;\n   630→  const a2 = -0.284496736;\n   631→  const a3 = 1.421413741;\n   632→  const a4 = -1.453152027;\n   633→  const a5 = 1.061405429;\n   634→  const p = 0.3275911;\n   635→\n   636→  const sign = z < 0 ? -1 : 1;\n   637→  const absZ = Math.abs(z) / Math.sqrt(2);\n   638→\n   639→  const t = 1.0 / (1.0 + p * absZ);\n   640→  const y = 1.0 - ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-absZ * absZ);\n   641→\n   642→  return 0.5 * (1.0 + sign * y);\n   643→}\n   644→\n   645→// ============================================\n   646→// PSL RATING CONVERSION\n   647→// ============================================\n   648→\n   649→export interface PSLRating {\n   650→  score: number;\n   651→  tier: string;\n   652→  percentile: number;\n   653→  description: string;\n   654→}\n   655→\n   656→/**\n   657→ * Convert harmony score to PSL rating\n   658→ */\n   659→export function convertToPSL(harmonyScore: number): PSLRating {\n   660→  // Convert 0-10 harmony to 3.0-7.5 PSL range\n   661→  const psl = 3.0 + (harmonyScore / 10) * 4.5;\n   662→  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n   663→\n   664→  let tier: string;\n   665→  let percentile: number;\n   666→\n   667→  if (clampedPSL >= 7.5) {\n   668→    tier = 'Top Model';\n   669→    percentile = 99.99;\n   670→  } else if (clampedPSL >= 7.0) {\n   671→    tier = 'Chad';\n   672→    percentile = 99.87;\n   673→  } else if (clampedPSL >= 6.5) {\n   674→    tier = 'Chadlite';\n   675→    percentile = 99.0;\n   676→  } else if (clampedPSL >= 6.0) {\n   677→    tier = 'High Tier Normie+';\n   678→    percentile = 97.25;\n   679→  } else if (clampedPSL >= 5.5) {\n   680→    tier = 'High Tier Normie';\n   681→    percentile = 90.0;\n   682→  } else if (clampedPSL >= 5.0) {\n   683→    tier = 'Mid Tier Normie+';\n   684→    percentile = 84.15;\n   685→  } else if (clampedPSL >= 4.5) {\n   686→    tier = 'Mid Tier Normie';\n   687→    percentile = 65.0;\n   688→  } else if (clampedPSL >= 4.0) {\n   689→    tier = 'Low Tier Normie';\n   690→    percentile = 50.0;\n   691→  } else if (clampedPSL >= 3.5) {\n   692→    tier = 'Below Average';\n   693→    percentile = 30.0;\n   694→  } else {\n   695→    tier = 'Subpar';\n   696→    percentile = 15.0;\n   697→  }\n   698→\n   699→  return {\n   700→    score: clampedPSL,\n   701→    tier,\n   702→    percentile,\n   703→    description: `${tier} (top ${(100 - percentile).toFixed(1)}%)`,\n   704→  };\n   705→}\n   706→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"dc77074c-1783-41d0-93dc-2700ef0b76f6","timestamp":"2025-12-25T23:22:50.445Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/calculator.ts","content":"/**\n * Scoring Calculator\n * Core scoring algorithm functions extracted from harmony-scoring.ts\n *\n * Features:\n * - Exponential decay scoring with per-metric decay rates\n * - Bezier curve custom scoring for non-linear measurements\n * - Directional/Dimorphic scoring (polarity support)\n * - Quality tiers and severity levels\n */\n\nimport {\n  Point,\n  QualityTier,\n  SeverityLevel,\n  MeasurementUnit,\n  MetricConfig,\n  CurvePoint,\n  FlawMapping,\n} from './types';\nimport { BEZIER_CURVES } from '@/lib/bezier-curves';\n\n// ============================================\n// FLAW MAPPINGS\n// ============================================\n\nexport const METRIC_FLAW_MAPPINGS: Record<string, FlawMapping[]> = {\n  anteriorFacialDepth: [\n    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Anterior Facial Depth measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n  ],\n  bitemporalWidth: [\n    { category: 'Upper Third', flawName: 'Narrow forehead', confidence: 'confirmed', reasoning: 'Reduced bitemporal width indicates a narrower than ideal forehead relative to the cheekbones. This disrupts facial harmony by creating a compressed hairline and forehead, altering the overall shape of the face.' },\n  ],\n  cheekboneHeight: [\n    { category: 'Midface/Face Shape', flawName: 'Low-set cheekbones', confidence: 'confirmed', reasoning: 'Reduced cheekbone height indicates that the cheekbones are positioned lower than ideal. This disrupts facial harmony by creating an unpronounced appearance to the cheekbones and facial structure.' },\n  ],\n  cheekFullness: [\n    { category: 'Midface/Face Shape', flawName: 'Hollow/Gaunt midface', confidence: 'confirmed', reasoning: 'Reduced cheek fullness indicates volume loss or hollow cheeks. This disrupts facial harmony by creating a gaunt or aged appearance, particularly important in South Asian and East Asian beauty standards.' },\n  ],\n  eyeAspectRatio: [\n    { category: 'Eyes', flawName: 'Overly round eye shape', confidence: 'confirmed', reasoning: 'A reduced eye aspect ratio indicates overly narrow eyes relative to their height. This disrupts facial harmony by creating an overly surprised appearance and reducing angular definition.' },\n  ],\n  eyeSeparationRatio: [\n    { category: 'Eyes', flawName: 'Close-set eyes', confidence: 'confirmed', reasoning: 'Reduced eye separation indicates close-set eyes. This disrupts facial harmony by making the eye area appear too compressed.' },\n  ],\n  eyebrowLowSetedness: [\n    { category: 'Eyes', flawName: 'Medium-set eyebrows', confidence: 'confirmed', reasoning: 'Increased eyebrow low setedness indicates eyebrows that are positioned higher than ideal. This disrupts facial harmony by reducing the overall visual impact of the eyebrows and framing of the eyes.' },\n  ],\n  faceWidthToHeight: [\n    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced face width to height ratio indicates an overly long midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n  ],\n  facialDepthToHeight: [\n    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'Reduced facial depth to height ratio indicates insufficient mid-face projection relative to height. This disrupts facial harmony by creating the appearance of a flat midface.' },\n  ],\n  gonialAngle: [\n    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony in the lower face.' },\n    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A wider gonial angle indicates a softer, less defined jawline with reduced angularity. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n  ],\n  holdawayHLine: [\n    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'Decreased H-line indicates the lips are positioned too far in front of the line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n  ],\n  interiorMidfaceProjectionAngle: [\n    { category: 'Midface/Face Shape', flawName: 'Underprojected midface', confidence: 'confirmed', reasoning: 'The Interior Midface Projection Angle measurement is above the ideal range. This disrupts facial harmony by creating a sunken and unprominent appearance to the midface.' },\n  ],\n  ipsilateralAlarAngle: [\n    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A decreased ipsilateral alar angle indicates an overly narrow interior midface. This disrupts facial harmony by overemphasizing the middle of the face.' },\n  ],\n  jawFrontalAngle: [\n    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A narrower jaw frontal angle indicates a steeper jawline or overly wide chin. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n  ],\n  jawSlope: [\n    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'The Jaw Slope measurement is above the ideal range. This disrupts facial harmony in the lower face.' },\n  ],\n  lateralCanthalTilt: [\n    { category: 'Eyes', flawName: 'Insufficient eye tilt', confidence: 'confirmed', reasoning: 'A decreased lateral canthal tilt indicates insufficiently upturned eyes. This disrupts facial harmony by creating a less alert and youthful appearance.' },\n  ],\n  burstoneLowerLip: [\n    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the Burstone line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n  ],\n  eLineLowerLip: [\n    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned too far in front of the E-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n  ],\n  sLineLowerLip: [\n    { category: 'Lips', flawName: 'Overly full lower lip', confidence: 'confirmed', reasoning: 'The lower lip is positioned excessively in front of the S-line. This disrupts facial harmony by drawing attention to the lower lip and creating an imbalance between the lower lip, chin, and nose.' },\n  ],\n  lowerThirdProportion: [\n    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'The upper jaw is too long relative to lower jaw, possibly from a long upper jaw or short lower jaw, or a combination of both. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n  ],\n  mandibularPlaneAngle: [\n    { category: 'Occlusion/Jaw Growth', flawName: 'Hyper-divergent jaw growth', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by elongating the lower face.' },\n    { category: 'Jaw Shape', flawName: 'Weak/soft jaw structure', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony in the lower face.' },\n    { category: 'Jaw Shape', flawName: 'Steep jaw', confidence: 'confirmed', reasoning: 'A steeper mandibular plane angle indicates vertical overgrowth, elongating the lower face and potentially indicating malocclusion. This disrupts facial harmony by creating a narrow or pointed chin effect.' },\n  ],\n  midfaceRatio: [\n    { category: 'Midface/Face Shape', flawName: 'Long midface', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the middle of the face.' },\n    { category: 'Midface/Face Shape', flawName: 'Long upper jaw', confidence: 'confirmed', reasoning: 'A reduced midface ratio indicates an overly narrow interior midface relative to its height. This disrupts facial harmony by overemphasizing the upper jaw relative to the lower jaw.' },\n  ],\n  nasofacialAngle: [\n    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A smaller nasofacial angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n  ],\n  nasofrontalAngle: [\n    { category: 'Upper Third', flawName: 'Soft and weak brow ridge', confidence: 'confirmed', reasoning: 'An increased nasofrontal angle indicates reduced brow ridge prominence and angularity. This disrupts facial harmony by creating a less defined upper face.' },\n  ],\n  nasomentaAngle: [\n    { category: 'Occlusion/Jaw Growth', flawName: 'Maxillary recession', confidence: 'confirmed', reasoning: 'A larger nasomental angle suggests reduced projection of the nose and midface region, or an overprojected chin. This disrupts facial harmony by creating the appearance of a flat midface.' },\n  ],\n  noseBridgeWidth: [\n    { category: 'Nose', flawName: 'Overly narrow nose bridge', confidence: 'confirmed', reasoning: 'The Nose Bridge to Nose Width measurement is above the ideal range. This disrupts facial harmony by creating an unbalanced nasal profile.' },\n  ],\n  orbitalVector: [\n    { category: 'Eyes', flawName: 'Sunken orbital region', confidence: 'confirmed', reasoning: 'A decreased orbital vector indicates insufficient projection and volume underneath the eye. This disrupts facial harmony due to the lacking volume underneath the eyes, reducing vibrancy and youthfulness.' },\n  ],\n  ramusToMandibleRatio: [\n    { category: 'Jaw Shape', flawName: 'Short ramus', confidence: 'confirmed', reasoning: 'A reduced ramus-to-mandible ratio indicates a shorter than ideal vertical jawbone (ramus) when compared to the mandible. This disrupts facial harmony by reducing jaw height and definition.' },\n  ],\n  submentalCervicalAngle: [\n    { category: 'Neck', flawName: 'Round neck region', confidence: 'confirmed', reasoning: 'An increased submental cervical angle indicates a round neck region, possibly from excess submental fat or tissue. This disrupts facial harmony by reducing neck definition.' },\n  ],\n  totalFacialWidthToHeight: [\n    { category: 'Midface/Face Shape', flawName: 'Overly long face shape', confidence: 'confirmed', reasoning: 'An increased total facial width to height ratio indicates an overly long face relative to its height. This disrupts facial harmony by creating a vertically stretched appearance to the face.' },\n  ],\n};\n\n// ============================================\n// CUSTOM BEZIER CURVES (Ethnicity-specific override)\n// ============================================\n\nexport const METRIC_CUSTOM_CURVES: Record<string, CurvePoint[]> = {\n  faceWidthToHeight: [\n    { x: 1.49, y: 0, leftHandleX: 1.44, leftHandleY: 0, rightHandleX: 1.55, rightHandleY: 0 },\n    { x: 1.68, y: 1.05, leftHandleX: 1.62, leftHandleY: 0.36, rightHandleX: 1.71, rightHandleY: 1.58 },\n    { x: 1.77, y: 3.07, leftHandleX: 1.74, leftHandleY: 2.15, rightHandleX: 1.79, rightHandleY: 3.88 },\n    { x: 1.83, y: 5.83, leftHandleX: 1.8, leftHandleY: 4.64, rightHandleX: 1.84, rightHandleY: 6.85 },\n    { x: 1.89, y: 8.7, leftHandleX: 1.88, leftHandleY: 8.3, rightHandleX: 1.92, rightHandleY: 9.5 },\n    { x: 1.96, y: 10, leftHandleX: 1.96, leftHandleY: 10, rightHandleX: 1.96, rightHandleY: 10, fixed: true },\n    { x: 2, y: 10, leftHandleX: 2, leftHandleY: 10, rightHandleX: 2, rightHandleY: 10 },\n    { x: 2.07, y: 8.7, leftHandleX: 2.04, leftHandleY: 9.5, rightHandleX: 2.08, rightHandleY: 8.3 },\n    { x: 2.13, y: 5.83, leftHandleX: 2.12, leftHandleY: 6.85, rightHandleX: 2.16, rightHandleY: 4.64 },\n    { x: 2.19, y: 3.07, leftHandleX: 2.17, leftHandleY: 3.88, rightHandleX: 2.22, rightHandleY: 2.15 },\n    { x: 2.28, y: 1.05, leftHandleX: 2.25, leftHandleY: 1.58, rightHandleX: 2.34, rightHandleY: 0.36 },\n    { x: 2.47, y: 0, leftHandleX: 2.41, leftHandleY: 0, rightHandleX: 2.52, rightHandleY: 0 },\n  ],\n  lowerThirdProportion: [\n    { x: 25.6, y: 0, leftHandleX: 24.8, leftHandleY: 0, rightHandleX: 26.4, rightHandleY: 0 },\n    { x: 28.01, y: 1.58, leftHandleX: 27.23, leftHandleY: 0.53, rightHandleX: 28.27, rightHandleY: 1.97 },\n    { x: 28.83, y: 3.21, leftHandleX: 28.62, leftHandleY: 2.59, rightHandleX: 29.03, rightHandleY: 3.76 },\n    { x: 29.63, y: 5.85, leftHandleX: 29.38, leftHandleY: 4.64, rightHandleX: 29.84, rightHandleY: 6.61 },\n    { x: 30.27, y: 8.56, leftHandleX: 30.1, leftHandleY: 7.71, rightHandleX: 30.52, rightHandleY: 9.42 },\n    { x: 31, y: 10, leftHandleX: 30.88, leftHandleY: 10, rightHandleX: 31.13, rightHandleY: 10, fixed: true },\n    { x: 33.5, y: 10, leftHandleX: 33.38, leftHandleY: 10, rightHandleX: 33.63, rightHandleY: 10 },\n    { x: 34.23, y: 8.56, leftHandleX: 33.98, leftHandleY: 9.42, rightHandleX: 34.4, rightHandleY: 7.71 },\n    { x: 34.87, y: 5.85, leftHandleX: 34.66, leftHandleY: 6.61, rightHandleX: 35.12, rightHandleY: 4.64 },\n    { x: 35.67, y: 3.21, leftHandleX: 35.47, leftHandleY: 3.76, rightHandleX: 35.88, rightHandleY: 2.59 },\n    { x: 36.49, y: 1.58, leftHandleX: 36.23, leftHandleY: 1.97, rightHandleX: 37.27, rightHandleY: 0.53 },\n    { x: 38.9, y: 0, leftHandleX: 38.1, leftHandleY: 0, rightHandleX: 39.7, rightHandleY: 0 },\n  ],\n  eyeAspectRatio: [\n    { x: 1.44, y: 0, leftHandleX: 1.18, leftHandleY: 0, rightHandleX: 1.75, rightHandleY: 0.38 },\n    { x: 2.07, y: 1.66, leftHandleX: 1.96, leftHandleY: 1.08, rightHandleX: 2.24, rightHandleY: 2.63 },\n    { x: 2.42, y: 4.34, leftHandleX: 2.35, leftHandleY: 3.6, rightHandleX: 2.52, rightHandleY: 5.5 },\n    { x: 2.71, y: 7.96, leftHandleX: 2.65, leftHandleY: 7.13, rightHandleX: 2.8, rightHandleY: 9.08 },\n    { x: 3, y: 10, leftHandleX: 2.98, leftHandleY: 10, rightHandleX: 3.03, rightHandleY: 10, fixed: true },\n    { x: 3.5, y: 10, leftHandleX: 3.48, leftHandleY: 10, rightHandleX: 3.53, rightHandleY: 10 },\n    { x: 3.79, y: 7.96, leftHandleX: 3.7, leftHandleY: 9.08, rightHandleX: 3.85, rightHandleY: 7.13 },\n    { x: 4.08, y: 4.34, leftHandleX: 3.98, leftHandleY: 5.5, rightHandleX: 4.15, rightHandleY: 3.6 },\n    { x: 4.43, y: 1.66, leftHandleX: 4.26, leftHandleY: 2.63, rightHandleX: 4.54, rightHandleY: 1.08 },\n    { x: 5.06, y: 0, leftHandleX: 4.75, leftHandleY: 0.38, rightHandleX: 5.32, rightHandleY: 0 },\n  ],\n  // Note: Additional curves can be added from METRIC_CUSTOM_CURVES in harmony-scoring.ts\n};\n\n// ============================================\n// CORE SCORING FUNCTIONS\n// ============================================\n\n/**\n * Exponential Decay Scoring Algorithm with Directional/Dimorphic Support\n *\n * Standard: score = maxScore * e^(-decayRate * deviation)\n *\n * Directional scoring (polarity):\n * - 'higher_is_better': Values above safeFloor but below ideal get softZoneScore\n *   Example: Canthal Tilt of 3 degrees is still positive/good, just not peak ideal (6-8 degrees)\n * - 'lower_is_better': Values below safeCeiling but above ideal get softZoneScore\n *   Example: Short philtrum is still attractive even if shorter than \"ideal\"\n */\nexport function calculateMetricScore(\n  value: number,\n  config: MetricConfig\n): number {\n  const {\n    id,\n    idealMin,\n    idealMax,\n    decayRate,\n    maxScore,\n    customCurve,\n    polarity = 'balanced',\n    safeFloor,\n    safeCeiling,\n    softZoneScore = 8.0, // Default \"Good\" score for acceptable-but-not-ideal values\n  } = config;\n\n  // IMPORTANT: Check demographic-adjusted ideal range FIRST\n  // This ensures that demographic overrides are respected even when Bezier curves exist\n  // (Bezier curves are optimized for base ranges and don't auto-adjust for demographics)\n  if (value >= idealMin && value <= idealMax) {\n    return maxScore;\n  }\n\n  // Use custom curve if available in config\n  if (customCurve && customCurve.mode === 'custom') {\n    const bezierScore = interpolateCustomCurve(value, customCurve.points, maxScore);\n    // If Bezier returns -1, it means value is out of range with edge y=0\n    // Fall through to exponential decay instead of returning 0\n    if (bezierScore >= 0) {\n      return bezierScore;\n    }\n  }\n\n  // Check for pre-defined Bezier curve from harmony curves (66 metrics)\n  const bezierCurve = BEZIER_CURVES[id];\n  if (bezierCurve && bezierCurve.mode === 'custom') {\n    const bezierScore = interpolateCustomCurve(value, bezierCurve.points, maxScore);\n    // If Bezier returns -1, it means value is out of range with edge y=0\n    // Fall through to exponential decay instead of returning 0\n    if (bezierScore >= 0) {\n      return bezierScore;\n    }\n  }\n\n  // Handle directional/dimorphic scoring\n  if (polarity === 'higher_is_better' && safeFloor !== undefined) {\n    // Higher values are good. Only values below safeFloor are true weaknesses.\n    if (value >= safeFloor && value < idealMin) {\n      // Value is in the \"acceptable but not ideal\" zone\n      // Give a passing score that decreases linearly as we approach the floor\n      const zoneRange = idealMin - safeFloor;\n      const distanceFromIdeal = idealMin - value;\n      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n      // Linear interpolation: idealMin -> maxScore, safeFloor -> softZoneScore\n      return maxScore - t * (maxScore - softZoneScore);\n    }\n    if (value >= idealMax) {\n      // Values above ideal are still excellent for 'higher_is_better'\n      // Apply gentler decay (1/3 the normal rate)\n      const deviation = value - idealMax;\n      const gentleDecay = decayRate / 3;\n      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n    }\n    // Below safeFloor - apply normal (or harsher) exponential decay\n    if (value < safeFloor) {\n      const deviation = safeFloor - value;\n      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n    }\n  }\n\n  if (polarity === 'lower_is_better' && safeCeiling !== undefined) {\n    // Lower values are good. Only values above safeCeiling are true weaknesses.\n    if (value <= safeCeiling && value > idealMax) {\n      // Value is in the \"acceptable but not ideal\" zone\n      const zoneRange = safeCeiling - idealMax;\n      const distanceFromIdeal = value - idealMax;\n      const t = zoneRange > 0 ? distanceFromIdeal / zoneRange : 0;\n      // Linear interpolation: idealMax -> maxScore, safeCeiling -> softZoneScore\n      return maxScore - t * (maxScore - softZoneScore);\n    }\n    if (value <= idealMin) {\n      // Values below ideal are still excellent for 'lower_is_better'\n      // Apply gentler decay (1/3 the normal rate)\n      const deviation = idealMin - value;\n      const gentleDecay = decayRate / 3;\n      return Math.max(softZoneScore, maxScore * Math.exp(-gentleDecay * deviation));\n    }\n    // Above safeCeiling - apply normal exponential decay\n    if (value > safeCeiling) {\n      const deviation = value - safeCeiling;\n      return Math.max(0, softZoneScore * Math.exp(-decayRate * deviation));\n    }\n  }\n\n  // Default balanced scoring: deviation in either direction is equally bad\n  const deviation = value < idealMin\n    ? idealMin - value\n    : value - idealMax;\n\n  // Exponential decay\n  const score = maxScore * Math.exp(-decayRate * deviation);\n\n  return Math.max(0, Math.min(maxScore, score));\n}\n\n/**\n * Check if a metric value is in an \"acceptable\" zone (not a true weakness).\n * Used by InsightsEngine to prevent false positives.\n */\nexport function isValueAcceptable(\n  value: number,\n  config: MetricConfig\n): { acceptable: boolean; reason: string } {\n  const {\n    idealMin,\n    idealMax,\n    polarity = 'balanced',\n    safeFloor,\n    safeCeiling,\n  } = config;\n\n  // Within ideal range is always acceptable\n  if (value >= idealMin && value <= idealMax) {\n    return { acceptable: true, reason: 'within_ideal' };\n  }\n\n  // Check directional acceptability\n  if (polarity === 'higher_is_better') {\n    if (value >= idealMax) {\n      return { acceptable: true, reason: 'above_ideal_higher_is_better' };\n    }\n    if (safeFloor !== undefined && value >= safeFloor) {\n      return { acceptable: true, reason: 'above_safe_floor' };\n    }\n    // Below safe floor - true weakness\n    return { acceptable: false, reason: 'below_safe_floor' };\n  }\n\n  if (polarity === 'lower_is_better') {\n    if (value <= idealMin) {\n      return { acceptable: true, reason: 'below_ideal_lower_is_better' };\n    }\n    if (safeCeiling !== undefined && value <= safeCeiling) {\n      return { acceptable: true, reason: 'below_safe_ceiling' };\n    }\n    // Above safe ceiling - true weakness\n    return { acceptable: false, reason: 'above_safe_ceiling' };\n  }\n\n  // Balanced polarity - outside ideal is not acceptable\n  return { acceptable: false, reason: 'outside_ideal_balanced' };\n}\n\n/**\n * Interpolate custom Bezier curve for scoring\n * Uses cubic Bezier interpolation with control handles for smooth curves\n *\n * IMPORTANT: When value is outside the curve range and the edge y-value is 0,\n * returns -1 to signal the caller should use exponential decay fallback.\n * This prevents artificially returning 0 for values just outside the curve.\n */\nexport function interpolateCustomCurve(\n  value: number,\n  points: CurvePoint[],\n  maxScore: number\n): number {\n  void maxScore; // Reserved for future custom curve implementations\n  if (points.length === 0) return -1; // Signal to use fallback\n\n  // Sort points by x value\n  const sortedPoints = [...points].sort((a, b) => a.x - b.x);\n\n  // Handle out-of-range values\n  // If edge y-value is 0, return -1 to signal exponential decay fallback should be used\n  if (value <= sortedPoints[0].x) {\n    const edgeY = sortedPoints[0].y;\n    // If edge score is 0, signal to use exponential decay fallback\n    return edgeY <= 0 ? -1 : edgeY;\n  }\n  if (value >= sortedPoints[sortedPoints.length - 1].x) {\n    const edgeY = sortedPoints[sortedPoints.length - 1].y;\n    // If edge score is 0, signal to use exponential decay fallback\n    return edgeY <= 0 ? -1 : edgeY;\n  }\n\n  // Find bracketing points\n  let lowerIndex = 0;\n  for (let i = 0; i < sortedPoints.length - 1; i++) {\n    if (value >= sortedPoints[i].x && value <= sortedPoints[i + 1].x) {\n      lowerIndex = i;\n      break;\n    }\n  }\n\n  const p0 = sortedPoints[lowerIndex];\n  const p3 = sortedPoints[lowerIndex + 1];\n\n  // Check if we have Bezier control handles\n  const hasHandles = p0.rightHandleX !== undefined && p3.leftHandleX !== undefined;\n\n  if (hasHandles) {\n    // Cubic Bezier interpolation with control points\n    const p1x = p0.rightHandleX!;\n    const p1y = p0.rightHandleY ?? p0.y;\n    const p2x = p3.leftHandleX!;\n    const p2y = p3.leftHandleY ?? p3.y;\n\n    // Find t parameter for given x value using Newton-Raphson iteration\n    let t = (value - p0.x) / (p3.x - p0.x); // Initial guess\n\n    // Newton-Raphson iterations to find t where B_x(t) = value\n    for (let iter = 0; iter < 10; iter++) {\n      const bx = cubicBezier(p0.x, p1x, p2x, p3.x, t);\n      const bxDerivative = cubicBezierDerivative(p0.x, p1x, p2x, p3.x, t);\n\n      if (Math.abs(bxDerivative) < 1e-10) break;\n\n      const newT = t - (bx - value) / bxDerivative;\n      if (Math.abs(newT - t) < 1e-10) break;\n      t = Math.max(0, Math.min(1, newT));\n    }\n\n    // Calculate y using the found t parameter\n    return cubicBezier(p0.y, p1y, p2y, p3.y, t);\n  } else {\n    // Smooth interpolation using Catmull-Rom spline\n    // This provides smoother curves than linear interpolation\n    const t = (value - p0.x) / (p3.x - p0.x);\n\n    // Get neighboring points for spline calculation\n    const pMinus1 = lowerIndex > 0 ? sortedPoints[lowerIndex - 1] : p0;\n    const p4 = lowerIndex + 2 < sortedPoints.length ? sortedPoints[lowerIndex + 2] : p3;\n\n    // Catmull-Rom spline interpolation\n    return catmullRomSpline(pMinus1.y, p0.y, p3.y, p4.y, t);\n  }\n}\n\n/**\n * Cubic Bezier curve evaluation: B(t) = (1-t)^3*P0 + 3*(1-t)^2*t*P1 + 3*(1-t)*t^2*P2 + t^3*P3\n */\nexport function cubicBezier(p0: number, p1: number, p2: number, p3: number, t: number): number {\n  const mt = 1 - t;\n  const mt2 = mt * mt;\n  const mt3 = mt2 * mt;\n  const t2 = t * t;\n  const t3 = t2 * t;\n  return mt3 * p0 + 3 * mt2 * t * p1 + 3 * mt * t2 * p2 + t3 * p3;\n}\n\n/**\n * Cubic Bezier derivative: B'(t) = 3*(1-t)^2*(P1-P0) + 6*(1-t)*t*(P2-P1) + 3*t^2*(P3-P2)\n */\nexport function cubicBezierDerivative(p0: number, p1: number, p2: number, p3: number, t: number): number {\n  const mt = 1 - t;\n  return 3 * mt * mt * (p1 - p0) + 6 * mt * t * (p2 - p1) + 3 * t * t * (p3 - p2);\n}\n\n/**\n * Catmull-Rom spline interpolation for smooth curves without explicit handles\n */\nexport function catmullRomSpline(p0: number, p1: number, p2: number, p3: number, t: number): number {\n  const t2 = t * t;\n  const t3 = t2 * t;\n\n  // Catmull-Rom coefficients with tension = 0.5\n  const a = -0.5 * p0 + 1.5 * p1 - 1.5 * p2 + 0.5 * p3;\n  const b = p0 - 2.5 * p1 + 2 * p2 - 0.5 * p3;\n  const c = -0.5 * p0 + 0.5 * p2;\n  const d = p1;\n\n  return a * t3 + b * t2 + c * t + d;\n}\n\n/**\n * Calculate standardized score (0-10 normalized)\n */\nexport function standardizeScore(score: number, maxScore: number): number {\n  return (score / maxScore) * 10;\n}\n\n/**\n * Determine quality tier based on score\n */\nexport function getQualityTier(score: number, maxScore: number = 10): QualityTier {\n  const normalized = (score / maxScore) * 100;\n\n  if (normalized >= 90) return 'ideal';\n  if (normalized >= 70) return 'excellent';\n  if (normalized >= 50) return 'good';\n  return 'below_average';\n}\n\n/**\n * Determine severity level based on score\n */\nexport function getSeverityLevel(score: number, maxScore: number = 10): SeverityLevel {\n  const normalized = (score / maxScore) * 100;\n\n  if (normalized >= 85) return 'optimal';\n  if (normalized >= 70) return 'minor';\n  if (normalized >= 50) return 'moderate';\n  if (normalized >= 30) return 'major';\n  if (normalized >= 15) return 'severe';\n  return 'extremely_severe';\n}\n\n/**\n * Calculate deviation description\n */\nexport function getDeviationDescription(\n  value: number,\n  idealMin: number,\n  idealMax: number,\n  unit: MeasurementUnit\n): { deviation: number; direction: 'above' | 'below' | 'within'; description: string } {\n  if (value >= idealMin && value <= idealMax) {\n    return { deviation: 0, direction: 'within', description: 'within ideal range' };\n  }\n\n  const unitLabel = getUnitLabel(unit);\n\n  if (value < idealMin) {\n    const dev = idealMin - value;\n    return {\n      deviation: dev,\n      direction: 'below',\n      description: `${dev.toFixed(2)}${unitLabel} below ideal`,\n    };\n  }\n\n  const dev = value - idealMax;\n  return {\n    deviation: dev,\n    direction: 'above',\n    description: `${dev.toFixed(2)}${unitLabel} above ideal`,\n  };\n}\n\n/**\n * Get unit label for display\n */\nexport function getUnitLabel(unit: MeasurementUnit): string {\n  switch (unit) {\n    case 'ratio': return 'x';\n    case 'percent': return '%';\n    case 'degrees': return '\\u00B0';\n    case 'mm': return 'mm';\n    default: return '';\n  }\n}\n\n// ============================================\n// GEOMETRY HELPERS\n// ============================================\n\n/**\n * Calculate distance between two points\n */\nexport function distance(p1: Point, p2: Point): number {\n  return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));\n}\n\n/**\n * Calculate angle at vertex point (in degrees)\n */\nexport function calculateAngle(p1: Point, vertex: Point, p2: Point): number {\n  const v1 = { x: p1.x - vertex.x, y: p1.y - vertex.y };\n  const v2 = { x: p2.x - vertex.x, y: p2.y - vertex.y };\n\n  const dot = v1.x * v2.x + v1.y * v2.y;\n  const cross = v1.x * v2.y - v1.y * v2.x;\n\n  const angle = Math.atan2(cross, dot) * (180 / Math.PI);\n  return Math.abs(angle);\n}\n\n/**\n * Calculate perpendicular distance from point to line (signed)\n */\nexport function perpendicularDistance(\n  point: Point,\n  lineStart: Point,\n  lineEnd: Point\n): number {\n  const A = point.x - lineStart.x;\n  const B = point.y - lineStart.y;\n  const C = lineEnd.x - lineStart.x;\n  const D = lineEnd.y - lineStart.y;\n\n  const dot = A * C + B * D;\n  const lenSq = C * C + D * D;\n  const param = lenSq !== 0 ? dot / lenSq : -1;\n\n  let xx: number, yy: number;\n\n  if (param < 0) {\n    xx = lineStart.x;\n    yy = lineStart.y;\n  } else if (param > 1) {\n    xx = lineEnd.x;\n    yy = lineEnd.y;\n  } else {\n    xx = lineStart.x + param * C;\n    yy = lineStart.y + param * D;\n  }\n\n  const dx = point.x - xx;\n  const dy = point.y - yy;\n\n  const sign =\n    (lineEnd.y - lineStart.y) * point.x -\n      (lineEnd.x - lineStart.x) * point.y +\n      lineEnd.x * lineStart.y -\n      lineEnd.y * lineStart.x >=\n    0\n      ? 1\n      : -1;\n\n  return sign * Math.sqrt(dx * dx + dy * dy);\n}\n\n// ============================================\n// PERCENTILE & PSL CONVERSION\n// ============================================\n\n/**\n * Calculate percentile from harmony score\n */\nexport function calculateHarmonyPercentile(score: number): number {\n  // Based on normal distribution with mean=5, stdDev=1.5\n  const mean = 5;\n  const stdDev = 1.5;\n  const z = (score - mean) / stdDev;\n  return normalCDF(z) * 100;\n}\n\n/**\n * Standard normal CDF approximation\n */\nexport function normalCDF(z: number): number {\n  const a1 = 0.254829592;\n  const a2 = -0.284496736;\n  const a3 = 1.421413741;\n  const a4 = -1.453152027;\n  const a5 = 1.061405429;\n  const p = 0.3275911;\n\n  const sign = z < 0 ? -1 : 1;\n  const absZ = Math.abs(z) / Math.sqrt(2);\n\n  const t = 1.0 / (1.0 + p * absZ);\n  const y = 1.0 - ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-absZ * absZ);\n\n  return 0.5 * (1.0 + sign * y);\n}\n\n// ============================================\n// PSL RATING CONVERSION\n// ============================================\n\nexport interface PSLRating {\n  score: number;\n  tier: string;\n  percentile: number;\n  description: string;\n}\n\n/**\n * Convert harmony score to PSL rating\n */\nexport function convertToPSL(harmonyScore: number): PSLRating {\n  // Convert 0-10 harmony to 3.0-7.5 PSL range\n  const psl = 3.0 + (harmonyScore / 10) * 4.5;\n  const clampedPSL = Math.max(3.0, Math.min(7.5, psl));\n\n  let tier: string;\n  let percentile: number;\n\n  if (clampedPSL >= 7.5) {\n    tier = 'Top Model';\n    percentile = 99.99;\n  } else if (clampedPSL >= 7.0) {\n    tier = 'Chad';\n    percentile = 99.87;\n  } else if (clampedPSL >= 6.5) {\n    tier = 'Chadlite';\n    percentile = 99.0;\n  } else if (clampedPSL >= 6.0) {\n    tier = 'High Tier Normie+';\n    percentile = 97.25;\n  } else if (clampedPSL >= 5.5) {\n    tier = 'High Tier Normie';\n    percentile = 90.0;\n  } else if (clampedPSL >= 5.0) {\n    tier = 'Mid Tier Normie+';\n    percentile = 84.15;\n  } else if (clampedPSL >= 4.5) {\n    tier = 'Mid Tier Normie';\n    percentile = 65.0;\n  } else if (clampedPSL >= 4.0) {\n    tier = 'Low Tier Normie';\n    percentile = 50.0;\n  } else if (clampedPSL >= 3.5) {\n    tier = 'Below Average';\n    percentile = 30.0;\n  } else {\n    tier = 'Subpar';\n    percentile = 15.0;\n  }\n\n  return {\n    score: clampedPSL,\n    tier,\n    percentile,\n    description: `${tier} (top ${(100 - percentile).toFixed(1)}%)`,\n  };\n}\n","numLines":706,"startLine":1,"totalLines":706}}}
{"parentUuid":"dc77074c-1783-41d0-93dc-2700ef0b76f6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XpDejYNF6w2HDnuf87HbVt","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\n     4→import { LandmarkPoint } from '@/lib/landmarks';\n     5→import {\n     6→  analyzeFrontProfile,\n     7→  analyzeSideProfile,\n     8→  analyzeHarmony,\n     9→  HarmonyAnalysis,\n    10→  MetricScoreResult,\n    11→  METRIC_CONFIGS,\n    12→  Ethnicity,\n    13→  Gender,\n    14→} from '@/lib/harmony-scoring';\n    15→import {\n    16→  calculateHarmonyScore,\n    17→  getTopMetrics,\n    18→  getBottomMetrics,\n    19→  HarmonyScoreResult,\n    20→  RankedMetric,\n    21→} from '@/lib/looksmax-scoring';\n    22→import { harmonyToPSL } from '@/lib/recommendations/severity';\n    23→import {\n    24→  classifyInsights,\n    25→  convertToStrength,\n    26→  convertToFlaw,\n    27→  INSIGHTS_DEFINITIONS,\n    28→} from '@/lib/insights-engine';\n    29→import { classifyMetric } from '@/lib/taxonomy';\n    30→import {\n    31→  Ratio,\n    32→  Strength,\n    33→  Flaw,\n    34→  Recommendation,\n    35→  ResultsTab,\n    36→  FullHarmonyAnalysis,\n    37→} from '@/types/results';\n    38→import { generateRecommendations } from '@/lib/results/analysis';\n    39→\n    40→// ============================================\n    41→// CONTEXT TYPES\n    42→// ============================================\n    43→\n    44→interface ResultsContextType {\n    45→  // Raw data\n    46→  frontLandmarks: LandmarkPoint[];\n    47→  sideLandmarks: LandmarkPoint[];\n    48→  gender: Gender;\n    49→  ethnicity: Ethnicity;\n    50→  frontPhoto: string;\n    51→  sidePhoto: string | null;\n    52→\n    53→  // Computed results\n    54→  harmonyAnalysis: FullHarmonyAnalysis | null;\n    55→  frontRatios: Ratio[];\n    56→  sideRatios: Ratio[];\n    57→  strengths: Strength[];\n    58→  flaws: Flaw[];\n    59→  recommendations: Recommendation[];\n    60→\n    61→  // Scores (now using weighted harmony from looksmax_engine.py)\n    62→  overallScore: number;\n    63→  frontScore: number;\n    64→  sideScore: number;\n    65→\n    66→  // Weighted Harmony Score (from looksmax_engine.py)\n    67→  harmonyScoreResult: HarmonyScoreResult | null;\n    68→  harmonyPercentage: number;  // 0-100% weighted harmony\n    69→\n    70→  // Top 3 strengths and bottom 3 areas to improve with advice\n    71→  topMetrics: RankedMetric[];\n    72→  bottomMetrics: RankedMetric[];\n    73→\n    74→  // PSL Rating (1-10 scale)\n    75→  pslRating: {\n    76→    psl: number;\n    77→    tier: string;\n    78→    percentile: number;\n    79→    description: string;\n    80→  };\n    81→\n    82→  // UI state\n    83→  activeTab: ResultsTab;\n    84→  setActiveTab: (tab: ResultsTab) => void;\n    85→  expandedMeasurementId: string | null;\n    86→  setExpandedMeasurementId: (id: string | null) => void;\n    87→  selectedVisualizationMetric: string | null;\n    88→  setSelectedVisualizationMetric: (id: string | null) => void;\n    89→  categoryFilter: string | null;\n    90→  setCategoryFilter: (category: string | null) => void;\n    91→  showLandmarkOverlay: boolean;\n    92→  setShowLandmarkOverlay: (show: boolean) => void;\n    93→\n    94→  // Actions\n    95→  setResultsData: (data: ResultsInputData) => void;\n    96→}\n    97→\n    98→interface ResultsInputData {\n    99→  frontLandmarks: LandmarkPoint[];\n   100→  sideLandmarks: LandmarkPoint[];\n   101→  frontPhoto: string;\n   102→  sidePhoto?: string;\n   103→  gender: Gender;\n   104→  ethnicity?: Ethnicity;\n   105→}\n   106→\n   107→// ============================================\n   108→// HELPER FUNCTIONS\n   109→// ============================================\n   110→\n   111→function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n   112→  switch (unit) {\n   113→    case 'ratio': return 'x';\n   114→    case 'percent': return '%';\n   115→    case 'degrees': return '°';\n   116→    case 'mm': return 'mm';\n   117→    default: return 'x';\n   118→  }\n   119→}\n   120→\n   121→function transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {\n   122→  const metricConfig = METRIC_CONFIGS[result.metricId];\n   123→\n   124→  // Generate illustration based on metric\n   125→  const illustration = generateIllustration(result.metricId, landmarks);\n   126→\n   127→  // Get flaw/strength mappings\n   128→  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n   129→\n   130→  // Classify metric using Harmony taxonomy\n   131→  const taxonomyClassification = classifyMetric(result.name, result.category);\n   132→\n   133→  return {\n   134→    id: result.metricId,\n   135→    name: result.name,\n   136→    value: result.value,\n   137→    score: result.standardizedScore,  // Use standardized 0-10 score for UI display\n   138→    standardizedScore: result.standardizedScore,\n   139→    unit: convertUnitToRatioUnit(result.unit),\n   140→    idealMin: result.idealMin,\n   141→    idealMax: result.idealMax,\n   142→    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n   143→    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n   144→    description: metricConfig?.description || '',\n   145→    category: result.category,\n   146→    qualityLevel: result.qualityTier,\n   147→    severity: result.severity,\n   148→    illustration,\n   149→    mayIndicateFlaws,\n   150→    mayIndicateStrengths,\n   151→    usedLandmarks: getUsedLandmarks(result.metricId),\n   152→    scoringCurveConfig: metricConfig ? {\n   153→      decayRate: metricConfig.decayRate,\n   154→      maxScore: metricConfig.maxScore,\n   155→    } : undefined,\n   156→    taxonomyPrimary: taxonomyClassification?.primary,\n   157→    taxonomySecondary: taxonomyClassification?.secondary,\n   158→  };\n   159→}\n   160→\n   161→// Enhanced illustration configuration type\n   162→interface IllustrationConfig {\n   163→  points: string[];\n   164→  lines: Array<{\n   165→    from: string;\n   166→    to: string;\n   167→    label?: string;\n   168→    color?: string;\n   169→    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n   170→  }>;\n   171→}\n   172→\n   173→// Comprehensive illustration configurations for all metrics\n   174→const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n   175→  // ==========================================\n   176→  // FACE SHAPE / PROPORTIONS\n   177→  // ==========================================\n   178→  faceWidthToHeight: {\n   179→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   180→    lines: [\n   181→      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n   182→      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n   183→    ],\n   184→  },\n   185→  totalFacialWidthToHeight: {\n   186→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   187→    lines: [\n   188→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   189→      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n   190→    ],\n   191→  },\n   192→  lowerThirdProportion: {\n   193→    points: ['subnasale', 'menton', 'trichion'],\n   194→    lines: [\n   195→      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n   196→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   197→    ],\n   198→  },\n   199→  middleThirdProportion: {\n   200→    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n   201→    lines: [\n   202→      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n   203→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   204→    ],\n   205→  },\n   206→  upperThirdProportion: {\n   207→    points: ['trichion', 'nasal_base', 'menton'],\n   208→    lines: [\n   209→      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n   210→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   211→    ],\n   212→  },\n   213→  bitemporalWidth: {\n   214→    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n   215→    lines: [\n   216→      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n   217→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n   218→    ],\n   219→  },\n   220→  cheekboneHeight: {\n   221→    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n   222→    lines: [\n   223→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n   224→      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n   225→    ],\n   226→  },\n   227→  midfaceRatio: {\n   228→    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n   229→    lines: [\n   230→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n   231→      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n   232→    ],\n   233→  },\n   234→\n   235→  // ==========================================\n   236→  // JAW MEASUREMENTS\n   237→  // ==========================================\n   238→  jawSlope: {\n   239→    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n   240→    lines: [\n   241→      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n   242→      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n   243→    ],\n   244→  },\n   245→  jawFrontalAngle: {\n   246→    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n   247→    lines: [\n   248→      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n   249→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n   250→    ],\n   251→  },\n   252→  bigonialWidth: {\n   253→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   254→    lines: [\n   255→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n   256→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   257→    ],\n   258→  },\n   259→  jawWidthRatio: {\n   260→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   261→    lines: [\n   262→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   263→      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n   264→    ],\n   265→  },\n   266→\n   267→  // ==========================================\n   268→  // EYE MEASUREMENTS\n   269→  // ==========================================\n   270→  lateralCanthalTilt: {\n   271→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n   272→    lines: [\n   273→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n   274→      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n   275→    ],\n   276→  },\n   277→  eyeAspectRatio: {\n   278→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n   279→    lines: [\n   280→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n   281→      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n   282→    ],\n   283→  },\n   284→  eyeSeparationRatio: {\n   285→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n   286→    lines: [\n   287→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   288→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   289→    ],\n   290→  },\n   291→  interpupillaryRatio: {\n   292→    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n   293→    lines: [\n   294→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   295→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   296→    ],\n   297→  },\n   298→  interpupillaryMouthWidthRatio: {\n   299→    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n   300→    lines: [\n   301→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   302→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   303→    ],\n   304→  },\n   305→  oneEyeApartTest: {\n   306→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n   307→    lines: [\n   308→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n   309→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n   310→    ],\n   311→  },\n   312→\n   313→  // ==========================================\n   314→  // EYEBROW MEASUREMENTS\n   315→  // ==========================================\n   316→  browLengthRatio: {\n   317→    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n   318→    lines: [\n   319→      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n   320→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   321→    ],\n   322→  },\n   323→  eyebrowTilt: {\n   324→    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n   325→    lines: [\n   326→      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n   327→      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n   328→    ],\n   329→  },\n   330→  eyebrowLowSetedness: {\n   331→    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n   332→    lines: [\n   333→      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n   334→    ],\n   335→  },\n   336→\n   337→  // ==========================================\n   338→  // NOSE MEASUREMENTS (FRONT)\n   339→  // ==========================================\n   340→  nasalIndex: {\n   341→    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n   342→    lines: [\n   343→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n   344→      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n   345→    ],\n   346→  },\n   347→  intercanthalNasalRatio: {\n   348→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n   349→    lines: [\n   350→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n   351→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   352→    ],\n   353→  },\n   354→  noseBridgeWidth: {\n   355→    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n   356→    lines: [\n   357→      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n   358→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n   359→    ],\n   360→  },\n   361→  noseTipPosition: {\n   362→    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n   363→    lines: [\n   364→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n   365→    ],\n   366→  },\n   367→\n   368→  // ==========================================\n   369→  // MOUTH/LIP MEASUREMENTS\n   370→  // ==========================================\n   371→  mouthNoseWidthRatio: {\n   372→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n   373→    lines: [\n   374→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   375→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n   376→    ],\n   377→  },\n   378→  lowerUpperLipRatio: {\n   379→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n   380→    lines: [\n   381→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n   382→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n   383→    ],\n   384→  },\n   385→  chinPhiltrumRatio: {\n   386→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n   387→    lines: [\n   388→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n   389→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n   390→    ],\n   391→  },\n   392→  mouthWidth: {\n   393→    points: ['left_cheilion', 'right_cheilion'],\n   394→    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n   395→  },\n   396→\n   397→  // ==========================================\n   398→  // CHIN MEASUREMENTS\n   399→  // ==========================================\n   400→  chinHeight: {\n   401→    points: ['labrale_inferius', 'menton'],\n   402→    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n   403→  },\n   404→\n   405→  // ==========================================\n   406→  // NECK MEASUREMENTS\n   407→  // ==========================================\n   408→  neckWidthRatio: {\n   409→    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n   410→    lines: [\n   411→      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n   412→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   413→    ],\n   414→  },\n   415→\n   416→  // ==========================================\n   417→  // SIDE PROFILE MEASUREMENTS\n   418→  // ==========================================\n   419→  gonialAngle: {\n   420→    points: ['tragus', 'gonionBottom', 'menton'],\n   421→    lines: [\n   422→      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   423→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   424→    ],\n   425→  },\n   426→  nasofrontalAngle: {\n   427→    points: ['glabella', 'nasion', 'pronasale'],\n   428→    lines: [\n   429→      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n   430→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   431→    ],\n   432→  },\n   433→  nasofacialAngle: {\n   434→    points: ['nasion', 'pronasale', 'pogonion'],\n   435→    lines: [\n   436→      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n   437→      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n   438→    ],\n   439→  },\n   440→  nasomentaAngle: {\n   441→    points: ['nasion', 'pronasale', 'pogonion'],\n   442→    lines: [\n   443→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   444→      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n   445→    ],\n   446→  },\n   447→  submentalCervicalAngle: {\n   448→    points: ['menton', 'cervicalPoint', 'neckPoint'],\n   449→    lines: [\n   450→      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n   451→      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n   452→    ],\n   453→  },\n   454→  facialDepthToHeight: {\n   455→    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n   456→    lines: [\n   457→      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n   458→      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n   459→    ],\n   460→  },\n   461→  anteriorFacialDepth: {\n   462→    points: ['glabella', 'pronasale', 'pogonion'],\n   463→    lines: [\n   464→      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n   465→      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n   466→    ],\n   467→  },\n   468→  mandibularPlaneAngle: {\n   469→    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n   470→    lines: [\n   471→      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n   472→      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n   473→    ],\n   474→  },\n   475→  ramusToMandibleRatio: {\n   476→    points: ['gonionTop', 'gonionBottom', 'menton'],\n   477→    lines: [\n   478→      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   479→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   480→    ],\n   481→  },\n   482→  orbitalVector: {\n   483→    points: ['cornealApex', 'orbitale', 'cheekbone'],\n   484→    lines: [\n   485→      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n   486→    ],\n   487→  },\n   488→  eLineLowerLip: {\n   489→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   490→    lines: [\n   491→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n   492→    ],\n   493→  },\n   494→  sLineLowerLip: {\n   495→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   496→    lines: [\n   497→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n   498→    ],\n   499→  },\n   500→  holdawayHLine: {\n   501→    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n   502→    lines: [\n   503→      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n   504→    ],\n   505→  },\n   506→  burstoneLowerLip: {\n   507→    points: ['subnasale', 'pogonion', 'labraleInferius'],\n   508→    lines: [\n   509→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n   510→    ],\n   511→  },\n   512→\n   513→  // ==========================================\n   514→  // ADDITIONAL FRONT PROFILE METRICS\n   515→  // ==========================================\n   516→  cupidsBowDepth: {\n   517→    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],\n   518→    lines: [\n   519→      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },\n   520→      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },\n   521→    ],\n   522→  },\n   523→  mouthCornerPosition: {\n   524→    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],\n   525→    lines: [\n   526→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },\n   527→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },\n   528→    ],\n   529→  },\n   530→  iaaJfaDeviation: {\n   531→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n   532→    lines: [\n   533→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },\n   534→      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },\n   535→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n   536→    ],\n   537→  },\n   538→  ipsilateralAlarAngle: {\n   539→    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],\n   540→    lines: [\n   541→      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },\n   542→      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },\n   543→    ],\n   544→  },\n   545→  earProtrusionAngle: {\n   546→    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],\n   547→    lines: [\n   548→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },\n   549→    ],\n   550→  },\n   551→  earProtrusionRatio: {\n   552→    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],\n   553→    lines: [\n   554→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },\n   555→      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },\n   556→    ],\n   557→  },\n   558→  mouthWidthToNoseRatio: {\n   559→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n   560→    lines: [\n   561→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   562→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n   563→    ],\n   564→  },\n   565→  lowerToUpperLipRatio: {\n   566→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n   567→    lines: [\n   568→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n   569→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n   570→    ],\n   571→  },\n   572→  chinToPhiltrumRatio: {\n   573→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n   574→    lines: [\n   575→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n   576→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n   577→    ],\n   578→  },\n   579→\n   580→  // ==========================================\n   581→  // ADDITIONAL SIDE PROFILE METRICS\n   582→  // ==========================================\n   583→  nasolabialAngle: {\n   584→    points: ['columella', 'subnasale', 'labraleSuperius'],\n   585→    lines: [\n   586→      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },\n   587→      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },\n   588→    ],\n   589→  },\n   590→  nasalTipAngle: {\n   591→    points: ['nasion', 'pronasale', 'columella'],\n   592→    lines: [\n   593→      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },\n   594→      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },\n   595→    ],\n   596→  },\n   597→  nasalProjection: {\n   598→    points: ['alar_crease', 'pronasale', 'subnasale'],\n   599→    lines: [\n   600→      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },\n   601→    ],\n   602→  },\n   603→  nasalWToHRatio: {\n   604→    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],\n   605→    lines: [\n   606→      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },\n   607→      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n   608→    ],\n   609→  },\n   610→  noseTipRotationAngle: {\n   611→    points: ['columella', 'subnasale', 'labraleSuperius'],\n   612→    lines: [\n   613→      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },\n   614→    ],\n   615→  },\n   616→  frankfortTipAngle: {\n   617→    points: ['porion', 'orbitale', 'pronasale'],\n   618→    lines: [\n   619→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   620→      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },\n   621→    ],\n   622→  },\n   623→  mentolabialAngle: {\n   624→    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],\n   625→    lines: [\n   626→      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },\n   627→      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },\n   628→    ],\n   629→  },\n   630→  zAngle: {\n   631→    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],\n   632→    lines: [\n   633→      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },\n   634→    ],\n   635→  },\n   636→  facialConvexityGlabella: {\n   637→    points: ['glabella', 'subnasale', 'pogonion'],\n   638→    lines: [\n   639→      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },\n   640→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   641→    ],\n   642→  },\n   643→  facialConvexityNasion: {\n   644→    points: ['nasion', 'subnasale', 'pogonion'],\n   645→    lines: [\n   646→      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },\n   647→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   648→    ],\n   649→  },\n   650→  totalFacialConvexity: {\n   651→    points: ['glabella', 'pronasale', 'pogonion'],\n   652→    lines: [\n   653→      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },\n   654→      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n   655→    ],\n   656→  },\n   657→  interiorMidfaceProjectionAngle: {\n   658→    points: ['orbitale', 'subnasale', 'pronasale'],\n   659→    lines: [\n   660→      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },\n   661→      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },\n   662→    ],\n   663→  },\n   664→  recessionFromFrankfort: {\n   665→    points: ['porion', 'orbitale', 'pogonion'],\n   666→    lines: [\n   667→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   668→      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },\n   669→    ],\n   670→  },\n   671→  gonionToMouthLine: {\n   672→    points: ['gonionBottom', 'cheilion', 'tragus'],\n   673→    lines: [\n   674→      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },\n   675→    ],\n   676→  },\n   677→  eLineUpperLip: {\n   678→    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n   679→    lines: [\n   680→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n   681→    ],\n   682→  },\n   683→  sLineUpperLip: {\n   684→    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n   685→    lines: [\n   686→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n   687→    ],\n   688→  },\n   689→  burstoneUpperLip: {\n   690→    points: ['subnasale', 'pogonion', 'labraleSuperius'],\n   691→    lines: [\n   692→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n   693→    ],\n   694→  },\n   695→  chinProjection: {\n   696→    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],\n   697→    lines: [\n   698→      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },\n   699→    ],\n   700→  },\n   701→  recessionRelativeToFrankfort: {\n   702→    points: ['porion', 'orbitale', 'pogonion', 'menton'],\n   703→    lines: [\n   704→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n   705→      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },\n   706→    ],\n   707→  },\n   708→  browridgeInclinationAngle: {\n   709→    points: ['glabella', 'trichion', 'nasion'],\n   710→    lines: [\n   711→      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },\n   712→      { from: 'glabella', to: 'nasion', color: '#67e8f9' },\n   713→    ],\n   714→  },\n   715→  upperForeheadSlope: {\n   716→    points: ['trichion', 'glabella', 'frankfortHorizontal'],\n   717→    lines: [\n   718→      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },\n   719→    ],\n   720→  },\n   721→  midfaceProjectionAngle: {\n   722→    points: ['orbitale', 'subnasale', 'pronasale'],\n   723→    lines: [\n   724→      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },\n   725→      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },\n   726→    ],\n   727→  },\n   728→};\n   729→\n   730→function generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {\n   731→  const landmarkMap: Record<string, LandmarkPoint> = {};\n   732→  landmarks.forEach(l => { landmarkMap[l.id] = l; });\n   733→\n   734→  const config = ILLUSTRATION_CONFIGS[metricId];\n   735→  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};\n   736→  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};\n   737→\n   738→  if (config) {\n   739→    config.points.forEach((pointId, i) => {\n   740→      if (landmarkMap[pointId]) {\n   741→        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };\n   742→      }\n   743→    });\n   744→    config.lines.forEach((line, i) => {\n   745→      lines[`line_${i}`] = {\n   746→        from: line.from,\n   747→        to: line.to,\n   748→        color: line.color || '#67e8f9',\n   749→        label: line.label,\n   750→        labelPosition: line.labelPosition,\n   751→      };\n   752→    });\n   753→  }\n   754→\n   755→  return { points, lines };\n   756→}\n   757→\n   758→function getUsedLandmarks(metricId: string): string[] {\n   759→  const landmarkMappings: Record<string, string[]> = {\n   760→    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   761→    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],\n   762→    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n   763→    ipd: ['left_pupila', 'right_pupila'],\n   764→    mouthWidth: ['left_cheilion', 'right_cheilion'],\n   765→    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],\n   766→    chinHeight: ['labrale_inferius', 'menton'],\n   767→    gonialAngle: ['tragus', 'gonionBottom', 'menton'],\n   768→  };\n   769→  return landmarkMappings[metricId] || [];\n   770→}\n   771→\n   772→function getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {\n   773→  const flawMappings: Record<string, { low: string[]; high: string[] }> = {\n   774→    faceWidthToHeight: {\n   775→      low: ['Narrow face', 'Vertically elongated face'],\n   776→      high: ['Wide face', 'Horizontally expanded face'],\n   777→    },\n   778→    lowerThirdProportion: {\n   779→      low: ['Short lower third', 'Deficient mandible'],\n   780→      high: ['Long lower third', 'Mandibular excess'],\n   781→    },\n   782→    lateralCanthalTilt: {\n   783→      low: ['Negative canthal tilt', 'Drooping eyes'],\n   784→      high: ['Excessive positive canthal tilt'],\n   785→    },\n   786→    nasalIndex: {\n   787→      low: ['Narrow nose', 'Leptorrhine nose'],\n   788→      high: ['Wide nose', 'Platyrrhine nose'],\n   789→    },\n   790→    gonialAngle: {\n   791→      low: ['Steep mandibular plane'],\n   792→      high: ['Flat mandibular plane', 'Weak jaw definition'],\n   793→    },\n   794→  };\n   795→\n   796→  const strengthMappings: Record<string, { ideal: string[] }> = {\n   797→    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },\n   798→    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },\n   799→    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },\n   800→    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },\n   801→  };\n   802→\n   803→  const mapping = flawMappings[result.metricId];\n   804→  const strengthMapping = strengthMappings[result.metricId];\n   805→\n   806→  let mayIndicateFlaws: string[] = [];\n   807→  let mayIndicateStrengths: string[] = [];\n   808→\n   809→  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {\n   810→    mayIndicateStrengths = strengthMapping?.ideal || [];\n   811→  } else if (mapping) {\n   812→    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;\n   813→  }\n   814→\n   815→  return { mayIndicateFlaws, mayIndicateStrengths };\n   816→}\n   817→\n   818→// Metric groupings for creating multi-ratio strengths\n   819→const STRENGTH_GROUPINGS: Record<string, {\n   820→  name: string;\n   821→  category: string;\n   822→  description: string;\n   823→  metrics: string[];\n   824→}> = {\n   825→  // Lip Proportions\n   826→  lipProportions: {\n   827→    name: 'Well Proportioned Lips',\n   828→    category: 'Lips',\n   829→    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',\n   830→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n   831→  },\n   832→  // Eye Proportions\n   833→  eyeProportions: {\n   834→    name: 'Harmonious Eye Proportions',\n   835→    category: 'Eyes',\n   836→    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',\n   837→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n   838→  },\n   839→  // Nose Proportions\n   840→  noseProportions: {\n   841→    name: 'Balanced Nasal Proportions',\n   842→    category: 'Nose',\n   843→    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',\n   844→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n   845→  },\n   846→  // Jaw Definition\n   847→  jawDefinition: {\n   848→    name: 'Well-Defined Jawline',\n   849→    category: 'Jaw Shape',\n   850→    description: 'The jawline displays strong definition with balanced angles and proportionate width.',\n   851→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n   852→  },\n   853→  // Chin Proportions\n   854→  chinProportions: {\n   855→    name: 'Balanced Chin Projection',\n   856→    category: 'Chin',\n   857→    description: 'The chin demonstrates ideal projection and proportions relative to the face.',\n   858→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n   859→  },\n   860→  // Facial Thirds\n   861→  facialThirds: {\n   862→    name: 'Balanced Facial Thirds',\n   863→    category: 'Face Proportions',\n   864→    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',\n   865→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n   866→  },\n   867→  // Midface\n   868→  midfaceBalance: {\n   869→    name: 'Harmonious Midface',\n   870→    category: 'Midface/Face Shape',\n   871→    description: 'The midface shows balanced proportions with well-positioned cheekbones.',\n   872→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n   873→  },\n   874→  // Forehead\n   875→  foreheadBalance: {\n   876→    name: 'Well-Proportioned Forehead',\n   877→    category: 'Forehead',\n   878→    description: 'The forehead displays ideal proportions in height and shape.',\n   879→    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],\n   880→  },\n   881→};\n   882→\n   883→function generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {\n   884→  const strengths: Strength[] = [];\n   885→  const usedMetricIds = new Set<string>();\n   886→\n   887→  // First pass: Create grouped strengths from related high-scoring metrics\n   888→  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {\n   889→    // Find all high-scoring measurements that belong to this group\n   890→    const groupMeasurements = analysis.measurements.filter(m =>\n   891→      groupConfig.metrics.includes(m.metricId) &&\n   892→      m.score >= 7.5 &&\n   893→      !usedMetricIds.has(m.metricId)\n   894→    );\n   895→\n   896→    // Only create a grouped strength if we have 2+ metrics with good scores\n   897→    if (groupMeasurements.length >= 2) {\n   898→      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n   899→      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n   900→\n   901→      // Mark these metrics as used\n   902→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n   903→\n   904→      // Create grouped strength with multiple contributing ratios\n   905→      strengths.push({\n   906→        id: `strength_group_${groupId}`,\n   907→        strengthName: groupConfig.name,\n   908→        summary: groupConfig.description,\n   909→        avgScore,\n   910→        qualityLevel: bestQuality,\n   911→        categoryName: groupConfig.category,\n   912→        responsibleRatios: groupMeasurements.map(m => ({\n   913→          ratioName: m.name,\n   914→          ratioId: m.metricId,\n   915→          score: m.score,\n   916→          value: m.value,\n   917→          idealMin: m.idealMin,\n   918→          idealMax: m.idealMax,\n   919→          unit: m.unit,\n   920→          category: m.category,\n   921→        })),\n   922→      });\n   923→    }\n   924→  });\n   925→\n   926→  // Second pass: Add remaining individual strengths that weren't grouped\n   927→  analysis.strengths.forEach((s, i) => {\n   928→    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n   929→\n   930→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n   931→\n   932→    strengths.push({\n   933→      id: `strength_${i}`,\n   934→      strengthName: s.metricName,\n   935→      summary: s.reasoning,\n   936→      avgScore: matchingMeasurement?.score || 8,\n   937→      qualityLevel: s.qualityTier,\n   938→      categoryName: s.category,\n   939→      responsibleRatios: [{\n   940→        ratioName: s.metricName,\n   941→        ratioId: s.metricId,\n   942→        score: matchingMeasurement?.score || 8,\n   943→        value: s.value,\n   944→        idealMin: matchingMeasurement?.idealMin || 0,\n   945→        idealMax: matchingMeasurement?.idealMax || 1,\n   946→        unit: matchingMeasurement?.unit || 'ratio',\n   947→        category: s.category,\n   948→      }],\n   949→    });\n   950→  });\n   951→\n   952→  // Sort by average score (highest first) then by number of contributing ratios\n   953→  return strengths.sort((a, b) => {\n   954→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n   955→      return b.responsibleRatios.length - a.responsibleRatios.length;\n   956→    }\n   957→    return b.avgScore - a.avgScore;\n   958→  });\n   959→}\n   960→\n   961→// Flaw groupings - similar to strength groupings but for areas of improvement\n   962→const FLAW_GROUPINGS: Record<string, {\n   963→  name: string;\n   964→  category: string;\n   965→  description: string;\n   966→  metrics: string[];\n   967→}> = {\n   968→  // Lip Issues\n   969→  lipIssues: {\n   970→    name: 'Lip Proportion Concerns',\n   971→    category: 'Lips',\n   972→    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',\n   973→    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n   974→  },\n   975→  // Eye Issues\n   976→  eyeIssues: {\n   977→    name: 'Eye Shape Considerations',\n   978→    category: 'Eyes',\n   979→    description: 'The eye proportions or positioning could benefit from enhancement.',\n   980→    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n   981→  },\n   982→  // Nose Issues\n   983→  noseIssues: {\n   984→    name: 'Nasal Proportion Concerns',\n   985→    category: 'Nose',\n   986→    description: 'The nasal proportions show deviations that affect facial harmony.',\n   987→    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n   988→  },\n   989→  // Jaw Issues\n   990→  jawIssues: {\n   991→    name: 'Jawline Definition Concerns',\n   992→    category: 'Jaw Shape',\n   993→    description: 'The jawline structure shows areas that could be enhanced for better definition.',\n   994→    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n   995→  },\n   996→  // Chin Issues\n   997→  chinIssues: {\n   998→    name: 'Chin Projection Concerns',\n   999→    category: 'Chin',\n  1000→    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',\n  1001→    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  1002→  },\n  1003→  // Face Proportion Issues\n  1004→  proportionIssues: {\n  1005→    name: 'Facial Proportion Imbalance',\n  1006→    category: 'Face Proportions',\n  1007→    description: 'The vertical face proportions show imbalance between facial thirds.',\n  1008→    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  1009→  },\n  1010→  // Midface Issues\n  1011→  midfaceIssues: {\n  1012→    name: 'Midface Development Concerns',\n  1013→    category: 'Midface/Face Shape',\n  1014→    description: 'The midface shows areas that could benefit from enhanced projection or balance.',\n  1015→    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  1016→  },\n  1017→};\n  1018→\n  1019→function generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  1020→  const flaws: Flaw[] = [];\n  1021→  const usedMetricIds = new Set<string>();\n  1022→  let rollingLost = 0;\n  1023→\n  1024→  // First pass: Create grouped flaws from related low-scoring metrics\n  1025→  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n  1026→    // Find all low-scoring measurements that belong to this group\n  1027→    const groupMeasurements = analysis.measurements.filter(m =>\n  1028→      groupConfig.metrics.includes(m.metricId) &&\n  1029→      m.score < 6 &&\n  1030→      !usedMetricIds.has(m.metricId)\n  1031→    );\n  1032→\n  1033→    // Only create a grouped flaw if we have 2+ metrics with low scores\n  1034→    if (groupMeasurements.length >= 2) {\n  1035→      // Mark these metrics as used\n  1036→      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n  1037→\n  1038→      // Calculate total impact from all metrics in this group\n  1039→      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n  1040→      rollingLost += totalImpact;\n  1041→\n  1042→      // Create grouped flaw with multiple contributing ratios\n  1043→      flaws.push({\n  1044→        id: `flaw_group_${groupId}`,\n  1045→        flawName: groupConfig.name,\n  1046→        summary: groupConfig.description,\n  1047→        harmonyPercentageLost: totalImpact,\n  1048→        standardizedImpact: totalImpact / 10,\n  1049→        categoryName: groupConfig.category,\n  1050→        responsibleRatios: groupMeasurements.map(m => ({\n  1051→          ratioName: m.name,\n  1052→          ratioId: m.metricId,\n  1053→          score: m.score,\n  1054→          value: m.value,\n  1055→          idealMin: m.idealMin,\n  1056→          idealMax: m.idealMax,\n  1057→          unit: m.unit,\n  1058→          category: m.category,\n  1059→        })),\n  1060→        rollingPointsDeducted: rollingLost,\n  1061→        rollingHarmonyPercentageLost: rollingLost,\n  1062→        rollingStandardizedImpact: rollingLost / 10,\n  1063→      });\n  1064→    }\n  1065→  });\n  1066→\n  1067→  // Second pass: Add remaining individual flaws that weren't grouped\n  1068→  analysis.flaws.forEach((f, i) => {\n  1069→    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n  1070→\n  1071→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n  1072→    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n  1073→    rollingLost += impact;\n  1074→\n  1075→    flaws.push({\n  1076→      id: `flaw_${i}`,\n  1077→      flawName: f.metricName,\n  1078→      summary: f.reasoning,\n  1079→      harmonyPercentageLost: impact,\n  1080→      standardizedImpact: impact / 10,\n  1081→      categoryName: f.category,\n  1082→      responsibleRatios: [{\n  1083→        ratioName: f.metricName,\n  1084→        ratioId: f.metricId,\n  1085→        score: matchingMeasurement?.score || 3,\n  1086→        value: matchingMeasurement?.value || 0,\n  1087→        idealMin: matchingMeasurement?.idealMin || 0,\n  1088→        idealMax: matchingMeasurement?.idealMax || 1,\n  1089→        unit: matchingMeasurement?.unit || 'ratio',\n  1090→        category: f.category,\n  1091→      }],\n  1092→      rollingPointsDeducted: rollingLost,\n  1093→      rollingHarmonyPercentageLost: rollingLost,\n  1094→      rollingStandardizedImpact: rollingLost / 10,\n  1095→    });\n  1096→  });\n  1097→\n  1098→  // Sort by impact (highest first) then by number of contributing ratios\n  1099→  return flaws.sort((a, b) => {\n  1100→    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n  1101→      return b.responsibleRatios.length - a.responsibleRatios.length;\n  1102→    }\n  1103→    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  1104→  });\n  1105→}\n  1106→\n  1107→// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions\n  1108→// have been moved to @/lib/results/analysis.ts to reduce bundle size\n  1109→// Import generateRecommendations from there instead\n  1110→// ============================================\n  1111→// CONTEXT CREATION\n  1112→// ============================================\n  1113→\n  1114→const ResultsContext = createContext<ResultsContextType | null>(null);\n  1115→\n  1116→export function useResults(): ResultsContextType {\n  1117→  const context = useContext(ResultsContext);\n  1118→  if (!context) {\n  1119→    throw new Error('useResults must be used within a ResultsProvider');\n  1120→  }\n  1121→  return context;\n  1122→}\n  1123→\n  1124→interface ResultsProviderProps {\n  1125→  children: ReactNode;\n  1126→  initialData?: ResultsInputData;\n  1127→}\n  1128→\n  1129→export function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  1130→  // Raw data state\n  1131→  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  1132→  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  1133→  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  1134→  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  1135→  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  1136→  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n  1137→\n  1138→  // UI state\n  1139→  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  1140→  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  1141→  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  1142→  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  1143→  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n  1144→\n  1145→  // Compute analysis results (now with demographic-specific scoring)\n  1146→  const analysisResults = useMemo(() => {\n  1147→    if (frontLandmarks.length === 0) {\n  1148→      return null;\n  1149→    }\n  1150→\n  1151→    try {\n  1152→      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n  1153→      const sideAnalysis = sideLandmarks.length > 0\n  1154→        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n  1155→        : null;\n  1156→      // analyzeHarmony expects landmarks directly, not analysis results\n  1157→      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n  1158→\n  1159→      return { frontAnalysis, sideAnalysis, harmony };\n  1160→    } catch (error) {\n  1161→      console.error('Analysis error:', error);\n  1162→      return null;\n  1163→    }\n  1164→  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n  1165→\n  1166→  // Transform to Ratio format\n  1167→  const frontRatios = useMemo(() => {\n  1168→    if (!analysisResults?.frontAnalysis) return [];\n  1169→    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  1170→  }, [analysisResults, frontLandmarks]);\n  1171→\n  1172→  const sideRatios = useMemo(() => {\n  1173→    if (!analysisResults?.sideAnalysis) return [];\n  1174→    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  1175→  }, [analysisResults, sideLandmarks]);\n  1176→\n  1177→  // Generate strengths and flaws using INSIGHTS-BASED classification\n  1178→  // This processes insights.json definitions: calculates avg score of affected metrics,\n  1179→  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  1180→  const { insightStrengths, insightFlaws } = useMemo(() => {\n  1181→    if (!analysisResults?.harmony) {\n  1182→      return { insightStrengths: [], insightFlaws: [] };\n  1183→    }\n  1184→\n  1185→    try {\n  1186→      // Classify using insights engine\n  1187→      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n  1188→        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n  1189→\n  1190→      // Convert to UI-compatible types\n  1191→      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n  1192→\n  1193→      let rollingLost = 0;\n  1194→      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n  1195→        const flaw = convertToFlaw(w, i, rollingLost);\n  1196→        rollingLost = flaw.rollingPointsDeducted || 0;\n  1197→        return flaw;\n  1198→      });\n  1199→\n  1200→      return { insightStrengths, insightFlaws };\n  1201→    } catch (error) {\n  1202→      console.error('[ResultsContext] Error in insights classification:', error);\n  1203→      return { insightStrengths: [], insightFlaws: [] };\n  1204→    }\n  1205→  }, [analysisResults]);\n  1206→\n  1207→  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  1208→  const groupingStrengths = useMemo(() => {\n  1209→    if (!analysisResults?.harmony) return [];\n  1210→    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  1211→  }, [analysisResults]);\n  1212→\n  1213→  const groupingFlaws = useMemo(() => {\n  1214→    if (!analysisResults?.harmony) return [];\n  1215→    return generateFlawsFromAnalysis(analysisResults.harmony);\n  1216→  }, [analysisResults]);\n  1217→\n  1218→  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)\n  1219→  const strengths = useMemo(() => {\n  1220→    // Use insights as primary source\n  1221→    const usedMetricIds = new Set<string>();\n  1222→    insightStrengths.forEach(s => {\n  1223→      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n  1224→    });\n  1225→\n  1226→    // Add grouping-based strengths that don't overlap\n  1227→    const nonOverlappingGrouping = groupingStrengths.filter(gs => {\n  1228→      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n  1229→      return !overlap;\n  1230→    });\n  1231→\n  1232→    return [...insightStrengths, ...nonOverlappingGrouping];\n  1233→  }, [insightStrengths, groupingStrengths]);\n  1234→\n  1235→  const flaws = useMemo(() => {\n  1236→    // Use insights as primary source\n  1237→    const usedMetricIds = new Set<string>();\n  1238→    insightFlaws.forEach(f => {\n  1239→      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n  1240→    });\n  1241→\n  1242→    // Add grouping-based flaws that don't overlap\n  1243→    const nonOverlappingGrouping = groupingFlaws.filter(gf => {\n  1244→      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n  1245→      return !overlap;\n  1246→    });\n  1247→\n  1248→    // Recalculate rolling totals for merged list\n  1249→    let rollingLost = 0;\n  1250→    const merged = [...insightFlaws, ...nonOverlappingGrouping];\n  1251→    return merged.map(f => {\n  1252→      rollingLost += f.harmonyPercentageLost;\n  1253→      return {\n  1254→        ...f,\n  1255→        rollingPointsDeducted: rollingLost,\n  1256→        rollingHarmonyPercentageLost: rollingLost,\n  1257→        rollingStandardizedImpact: rollingLost / 10,\n  1258→      };\n  1259→    });\n  1260→  }, [insightFlaws, groupingFlaws]);\n  1261→\n  1262→  // Generate recommendations with metric-aware matching and Bezier recalculation\n  1263→  const recommendations = useMemo(() => {\n  1264→    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);\n  1265→  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);\n  1266→\n  1267→  // Build full harmony analysis\n  1268→  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {\n  1269→    if (!analysisResults?.harmony) return null;\n  1270→\n  1271→    return {\n  1272→      standardizedScore: analysisResults.harmony.overallScore,\n  1273→      front: {\n  1274→        standardizedScore: analysisResults.harmony.frontScore,\n  1275→        ratios: frontRatios,\n  1276→      },\n  1277→      side: {\n  1278→        standardizedScore: analysisResults.harmony.sideScore,\n  1279→        ratios: sideRatios,\n  1280→      },\n  1281→      strengths,\n  1282→      flaws,\n  1283→    };\n  1284→  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);\n  1285→\n  1286→  // Calculate weighted harmony score using looksmax_engine.py algorithm\n  1287→  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {\n  1288→    if (!analysisResults?.harmony) return null;\n  1289→\n  1290→    const allMeasurements = analysisResults.harmony.measurements.map(m => ({\n  1291→      metricId: m.metricId,\n  1292→      standardizedScore: m.standardizedScore,\n  1293→    }));\n  1294→\n  1295→    return calculateHarmonyScore(allMeasurements);\n  1296→  }, [analysisResults]);\n  1297→\n  1298→  // Get top 3 and bottom 3 metrics with advice\n  1299→  const topMetrics = useMemo((): RankedMetric[] => {\n  1300→    if (!analysisResults?.harmony) return [];\n  1301→    return getTopMetrics(analysisResults.harmony.measurements, 3);\n  1302→  }, [analysisResults]);\n  1303→\n  1304→  const bottomMetrics = useMemo((): RankedMetric[] => {\n  1305→    if (!analysisResults?.harmony) return [];\n  1306→    return getBottomMetrics(analysisResults.harmony.measurements, 3);\n  1307→  }, [analysisResults]);\n  1308→\n  1309→  // Scores - now using weighted harmony\n  1310→  const harmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;\n  1311→  const overallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;\n  1312→  const frontScore = analysisResults?.harmony?.frontScore || 0;\n  1313→  const sideScore = analysisResults?.harmony?.sideScore || 0;\n  1314→\n  1315→  // PSL Rating (1-10 scale with tier/percentile)\n  1316→  const pslRating = useMemo(() => {\n  1317→    return harmonyToPSL(harmonyPercentage);\n  1318→  }, [harmonyPercentage]);\n  1319→\n  1320→  // Action to set all results data\n  1321→  const setResultsData = useCallback((data: ResultsInputData) => {\n  1322→    setFrontLandmarks(data.frontLandmarks);\n  1323→    setSideLandmarks(data.sideLandmarks);\n  1324→    setFrontPhoto(data.frontPhoto);\n  1325→    setSidePhoto(data.sidePhoto || null);\n  1326→    setGender(data.gender);\n  1327→    setEthnicity(data.ethnicity || 'other');\n  1328→  }, []);\n  1329→\n  1330→  // Memoize context value to prevent unnecessary re-renders\n  1331→  const value = useMemo<ResultsContextType>(() => ({\n  1332→    frontLandmarks,\n  1333→    sideLandmarks,\n  1334→    gender,\n  1335→    ethnicity,\n  1336→    frontPhoto,\n  1337→    sidePhoto,\n  1338→    harmonyAnalysis,\n  1339→    frontRatios,\n  1340→    sideRatios,\n  1341→    strengths,\n  1342→    flaws,\n  1343→    recommendations,\n  1344→    overallScore,\n  1345→    frontScore,\n  1346→    sideScore,\n  1347→    // Weighted harmony from looksmax_engine.py\n  1348→    harmonyScoreResult,\n  1349→    harmonyPercentage,\n  1350→    topMetrics,\n  1351→    bottomMetrics,\n  1352→    // PSL Rating\n  1353→    pslRating,\n  1354→    // UI state\n  1355→    activeTab,\n  1356→    setActiveTab,\n  1357→    expandedMeasurementId,\n  1358→    setExpandedMeasurementId,\n  1359→    selectedVisualizationMetric,\n  1360→    setSelectedVisualizationMetric,\n  1361→    categoryFilter,\n  1362→    setCategoryFilter,\n  1363→    showLandmarkOverlay,\n  1364→    setShowLandmarkOverlay,\n  1365→    setResultsData,\n  1366→  }), [\n  1367→    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,\n  1368→    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,\n  1369→    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,\n  1370→    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,\n  1371→    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,\n  1372→    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,\n  1373→    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,\n  1374→  ]);\n  1375→\n  1376→  return (\n  1377→    <ResultsContext.Provider value={value}>\n  1378→      {children}\n  1379→    </ResultsContext.Provider>\n  1380→  );\n  1381→}\n  1382→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"965e41d8-07fd-4fbc-ab1a-0c7ae38579a9","timestamp":"2025-12-25T23:22:50.643Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","content":"'use client';\n\nimport React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\nimport { LandmarkPoint } from '@/lib/landmarks';\nimport {\n  analyzeFrontProfile,\n  analyzeSideProfile,\n  analyzeHarmony,\n  HarmonyAnalysis,\n  MetricScoreResult,\n  METRIC_CONFIGS,\n  Ethnicity,\n  Gender,\n} from '@/lib/harmony-scoring';\nimport {\n  calculateHarmonyScore,\n  getTopMetrics,\n  getBottomMetrics,\n  HarmonyScoreResult,\n  RankedMetric,\n} from '@/lib/looksmax-scoring';\nimport { harmonyToPSL } from '@/lib/recommendations/severity';\nimport {\n  classifyInsights,\n  convertToStrength,\n  convertToFlaw,\n  INSIGHTS_DEFINITIONS,\n} from '@/lib/insights-engine';\nimport { classifyMetric } from '@/lib/taxonomy';\nimport {\n  Ratio,\n  Strength,\n  Flaw,\n  Recommendation,\n  ResultsTab,\n  FullHarmonyAnalysis,\n} from '@/types/results';\nimport { generateRecommendations } from '@/lib/results/analysis';\n\n// ============================================\n// CONTEXT TYPES\n// ============================================\n\ninterface ResultsContextType {\n  // Raw data\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  gender: Gender;\n  ethnicity: Ethnicity;\n  frontPhoto: string;\n  sidePhoto: string | null;\n\n  // Computed results\n  harmonyAnalysis: FullHarmonyAnalysis | null;\n  frontRatios: Ratio[];\n  sideRatios: Ratio[];\n  strengths: Strength[];\n  flaws: Flaw[];\n  recommendations: Recommendation[];\n\n  // Scores (now using weighted harmony from looksmax_engine.py)\n  overallScore: number;\n  frontScore: number;\n  sideScore: number;\n\n  // Weighted Harmony Score (from looksmax_engine.py)\n  harmonyScoreResult: HarmonyScoreResult | null;\n  harmonyPercentage: number;  // 0-100% weighted harmony\n\n  // Top 3 strengths and bottom 3 areas to improve with advice\n  topMetrics: RankedMetric[];\n  bottomMetrics: RankedMetric[];\n\n  // PSL Rating (1-10 scale)\n  pslRating: {\n    psl: number;\n    tier: string;\n    percentile: number;\n    description: string;\n  };\n\n  // UI state\n  activeTab: ResultsTab;\n  setActiveTab: (tab: ResultsTab) => void;\n  expandedMeasurementId: string | null;\n  setExpandedMeasurementId: (id: string | null) => void;\n  selectedVisualizationMetric: string | null;\n  setSelectedVisualizationMetric: (id: string | null) => void;\n  categoryFilter: string | null;\n  setCategoryFilter: (category: string | null) => void;\n  showLandmarkOverlay: boolean;\n  setShowLandmarkOverlay: (show: boolean) => void;\n\n  // Actions\n  setResultsData: (data: ResultsInputData) => void;\n}\n\ninterface ResultsInputData {\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  frontPhoto: string;\n  sidePhoto?: string;\n  gender: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// HELPER FUNCTIONS\n// ============================================\n\nfunction convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n  switch (unit) {\n    case 'ratio': return 'x';\n    case 'percent': return '%';\n    case 'degrees': return '°';\n    case 'mm': return 'mm';\n    default: return 'x';\n  }\n}\n\nfunction transformToRatio(result: MetricScoreResult, landmarks: LandmarkPoint[]): Ratio {\n  const metricConfig = METRIC_CONFIGS[result.metricId];\n\n  // Generate illustration based on metric\n  const illustration = generateIllustration(result.metricId, landmarks);\n\n  // Get flaw/strength mappings\n  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n\n  // Classify metric using Harmony taxonomy\n  const taxonomyClassification = classifyMetric(result.name, result.category);\n\n  return {\n    id: result.metricId,\n    name: result.name,\n    value: result.value,\n    score: result.standardizedScore,  // Use standardized 0-10 score for UI display\n    standardizedScore: result.standardizedScore,\n    unit: convertUnitToRatioUnit(result.unit),\n    idealMin: result.idealMin,\n    idealMax: result.idealMax,\n    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n    description: metricConfig?.description || '',\n    category: result.category,\n    qualityLevel: result.qualityTier,\n    severity: result.severity,\n    illustration,\n    mayIndicateFlaws,\n    mayIndicateStrengths,\n    usedLandmarks: getUsedLandmarks(result.metricId),\n    scoringCurveConfig: metricConfig ? {\n      decayRate: metricConfig.decayRate,\n      maxScore: metricConfig.maxScore,\n    } : undefined,\n    taxonomyPrimary: taxonomyClassification?.primary,\n    taxonomySecondary: taxonomyClassification?.secondary,\n  };\n}\n\n// Enhanced illustration configuration type\ninterface IllustrationConfig {\n  points: string[];\n  lines: Array<{\n    from: string;\n    to: string;\n    label?: string;\n    color?: string;\n    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n  }>;\n}\n\n// Comprehensive illustration configurations for all metrics\nconst ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n  // ==========================================\n  // FACE SHAPE / PROPORTIONS\n  // ==========================================\n  faceWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n    ],\n  },\n  totalFacialWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n    ],\n  },\n  lowerThirdProportion: {\n    points: ['subnasale', 'menton', 'trichion'],\n    lines: [\n      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  middleThirdProportion: {\n    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n    lines: [\n      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  upperThirdProportion: {\n    points: ['trichion', 'nasal_base', 'menton'],\n    lines: [\n      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  bitemporalWidth: {\n    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n    ],\n  },\n  cheekboneHeight: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n    ],\n  },\n  midfaceRatio: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // JAW MEASUREMENTS\n  // ==========================================\n  jawSlope: {\n    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n    ],\n  },\n  jawFrontalAngle: {\n    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  bigonialWidth: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n    ],\n  },\n  jawWidthRatio: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n    ],\n  },\n\n  // ==========================================\n  // EYE MEASUREMENTS\n  // ==========================================\n  lateralCanthalTilt: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n    ],\n  },\n  eyeAspectRatio: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  eyeSeparationRatio: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryMouthWidthRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n    ],\n  },\n  oneEyeApartTest: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // EYEBROW MEASUREMENTS\n  // ==========================================\n  browLengthRatio: {\n    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  eyebrowTilt: {\n    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n    ],\n  },\n  eyebrowLowSetedness: {\n    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n    ],\n  },\n\n  // ==========================================\n  // NOSE MEASUREMENTS (FRONT)\n  // ==========================================\n  nasalIndex: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  intercanthalNasalRatio: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n    ],\n  },\n  noseBridgeWidth: {\n    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n    ],\n  },\n  noseTipPosition: {\n    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // MOUTH/LIP MEASUREMENTS\n  // ==========================================\n  mouthNoseWidthRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  mouthWidth: {\n    points: ['left_cheilion', 'right_cheilion'],\n    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n  },\n\n  // ==========================================\n  // CHIN MEASUREMENTS\n  // ==========================================\n  chinHeight: {\n    points: ['labrale_inferius', 'menton'],\n    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n  },\n\n  // ==========================================\n  // NECK MEASUREMENTS\n  // ==========================================\n  neckWidthRatio: {\n    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n    ],\n  },\n\n  // ==========================================\n  // SIDE PROFILE MEASUREMENTS\n  // ==========================================\n  gonialAngle: {\n    points: ['tragus', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  nasofrontalAngle: {\n    points: ['glabella', 'nasion', 'pronasale'],\n    lines: [\n      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  nasofacialAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n    ],\n  },\n  nasomentaAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n    ],\n  },\n  submentalCervicalAngle: {\n    points: ['menton', 'cervicalPoint', 'neckPoint'],\n    lines: [\n      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n    ],\n  },\n  facialDepthToHeight: {\n    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n    lines: [\n      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  anteriorFacialDepth: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n    ],\n  },\n  mandibularPlaneAngle: {\n    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n    lines: [\n      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n    ],\n  },\n  ramusToMandibleRatio: {\n    points: ['gonionTop', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  orbitalVector: {\n    points: ['cornealApex', 'orbitale', 'cheekbone'],\n    lines: [\n      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n    ],\n  },\n  eLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  holdawayHLine: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n    ],\n  },\n  burstoneLowerLip: {\n    points: ['subnasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL FRONT PROFILE METRICS\n  // ==========================================\n  cupidsBowDepth: {\n    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],\n    lines: [\n      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },\n      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },\n    ],\n  },\n  mouthCornerPosition: {\n    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },\n    ],\n  },\n  iaaJfaDeviation: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },\n      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  ipsilateralAlarAngle: {\n    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },\n      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },\n    ],\n  },\n  earProtrusionAngle: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },\n    ],\n  },\n  earProtrusionRatio: {\n    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],\n    lines: [\n      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },\n      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },\n    ],\n  },\n  mouthWidthToNoseRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerToUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinToPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL SIDE PROFILE METRICS\n  // ==========================================\n  nasolabialAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },\n      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },\n    ],\n  },\n  nasalTipAngle: {\n    points: ['nasion', 'pronasale', 'columella'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },\n      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },\n    ],\n  },\n  nasalProjection: {\n    points: ['alar_crease', 'pronasale', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },\n    ],\n  },\n  nasalWToHRatio: {\n    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],\n    lines: [\n      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },\n      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  noseTipRotationAngle: {\n    points: ['columella', 'subnasale', 'labraleSuperius'],\n    lines: [\n      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },\n    ],\n  },\n  frankfortTipAngle: {\n    points: ['porion', 'orbitale', 'pronasale'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },\n    ],\n  },\n  mentolabialAngle: {\n    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],\n    lines: [\n      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },\n      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  zAngle: {\n    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],\n    lines: [\n      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },\n    ],\n  },\n  facialConvexityGlabella: {\n    points: ['glabella', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  facialConvexityNasion: {\n    points: ['nasion', 'subnasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },\n      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  totalFacialConvexity: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },\n      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },\n    ],\n  },\n  interiorMidfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },\n      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },\n    ],\n  },\n  recessionFromFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  gonionToMouthLine: {\n    points: ['gonionBottom', 'cheilion', 'tragus'],\n    lines: [\n      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },\n    ],\n  },\n  eLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineUpperLip: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  burstoneUpperLip: {\n    points: ['subnasale', 'pogonion', 'labraleSuperius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n  chinProjection: {\n    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },\n    ],\n  },\n  recessionRelativeToFrankfort: {\n    points: ['porion', 'orbitale', 'pogonion', 'menton'],\n    lines: [\n      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },\n      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },\n    ],\n  },\n  browridgeInclinationAngle: {\n    points: ['glabella', 'trichion', 'nasion'],\n    lines: [\n      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },\n      { from: 'glabella', to: 'nasion', color: '#67e8f9' },\n    ],\n  },\n  upperForeheadSlope: {\n    points: ['trichion', 'glabella', 'frankfortHorizontal'],\n    lines: [\n      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },\n    ],\n  },\n  midfaceProjectionAngle: {\n    points: ['orbitale', 'subnasale', 'pronasale'],\n    lines: [\n      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },\n      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },\n    ],\n  },\n};\n\nfunction generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {\n  const landmarkMap: Record<string, LandmarkPoint> = {};\n  landmarks.forEach(l => { landmarkMap[l.id] = l; });\n\n  const config = ILLUSTRATION_CONFIGS[metricId];\n  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};\n  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};\n\n  if (config) {\n    config.points.forEach((pointId, i) => {\n      if (landmarkMap[pointId]) {\n        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };\n      }\n    });\n    config.lines.forEach((line, i) => {\n      lines[`line_${i}`] = {\n        from: line.from,\n        to: line.to,\n        color: line.color || '#67e8f9',\n        label: line.label,\n        labelPosition: line.labelPosition,\n      };\n    });\n  }\n\n  return { points, lines };\n}\n\nfunction getUsedLandmarks(metricId: string): string[] {\n  const landmarkMappings: Record<string, string[]> = {\n    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],\n    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    ipd: ['left_pupila', 'right_pupila'],\n    mouthWidth: ['left_cheilion', 'right_cheilion'],\n    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],\n    chinHeight: ['labrale_inferius', 'menton'],\n    gonialAngle: ['tragus', 'gonionBottom', 'menton'],\n  };\n  return landmarkMappings[metricId] || [];\n}\n\nfunction getFlawStrengthMappings(result: MetricScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {\n  const flawMappings: Record<string, { low: string[]; high: string[] }> = {\n    faceWidthToHeight: {\n      low: ['Narrow face', 'Vertically elongated face'],\n      high: ['Wide face', 'Horizontally expanded face'],\n    },\n    lowerThirdProportion: {\n      low: ['Short lower third', 'Deficient mandible'],\n      high: ['Long lower third', 'Mandibular excess'],\n    },\n    lateralCanthalTilt: {\n      low: ['Negative canthal tilt', 'Drooping eyes'],\n      high: ['Excessive positive canthal tilt'],\n    },\n    nasalIndex: {\n      low: ['Narrow nose', 'Leptorrhine nose'],\n      high: ['Wide nose', 'Platyrrhine nose'],\n    },\n    gonialAngle: {\n      low: ['Steep mandibular plane'],\n      high: ['Flat mandibular plane', 'Weak jaw definition'],\n    },\n  };\n\n  const strengthMappings: Record<string, { ideal: string[] }> = {\n    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },\n    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },\n    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },\n    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },\n  };\n\n  const mapping = flawMappings[result.metricId];\n  const strengthMapping = strengthMappings[result.metricId];\n\n  let mayIndicateFlaws: string[] = [];\n  let mayIndicateStrengths: string[] = [];\n\n  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {\n    mayIndicateStrengths = strengthMapping?.ideal || [];\n  } else if (mapping) {\n    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;\n  }\n\n  return { mayIndicateFlaws, mayIndicateStrengths };\n}\n\n// Metric groupings for creating multi-ratio strengths\nconst STRENGTH_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Proportions\n  lipProportions: {\n    name: 'Well Proportioned Lips',\n    category: 'Lips',\n    description: 'The lips demonstrate excellent proportions with balanced upper-to-lower lip ratio and appropriate projection.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Proportions\n  eyeProportions: {\n    name: 'Harmonious Eye Proportions',\n    category: 'Eyes',\n    description: 'The eyes display balanced proportions with attractive shape and ideal spacing.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Proportions\n  noseProportions: {\n    name: 'Balanced Nasal Proportions',\n    category: 'Nose',\n    description: 'The nose exhibits well-balanced width, height, and angles that harmonize with facial features.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Definition\n  jawDefinition: {\n    name: 'Well-Defined Jawline',\n    category: 'Jaw Shape',\n    description: 'The jawline displays strong definition with balanced angles and proportionate width.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Proportions\n  chinProportions: {\n    name: 'Balanced Chin Projection',\n    category: 'Chin',\n    description: 'The chin demonstrates ideal projection and proportions relative to the face.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Facial Thirds\n  facialThirds: {\n    name: 'Balanced Facial Thirds',\n    category: 'Face Proportions',\n    description: 'The face displays well-balanced vertical proportions across upper, middle, and lower thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface\n  midfaceBalance: {\n    name: 'Harmonious Midface',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows balanced proportions with well-positioned cheekbones.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n  // Forehead\n  foreheadBalance: {\n    name: 'Well-Proportioned Forehead',\n    category: 'Forehead',\n    description: 'The forehead displays ideal proportions in height and shape.',\n    metrics: ['foreheadHeight', 'foreheadWidth', 'templeWidth'],\n  },\n};\n\nfunction generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {\n  const strengths: Strength[] = [];\n  const usedMetricIds = new Set<string>();\n\n  // First pass: Create grouped strengths from related high-scoring metrics\n  Object.entries(STRENGTH_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all high-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score >= 7.5 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped strength if we have 2+ metrics with good scores\n    if (groupMeasurements.length >= 2) {\n      const avgScore = groupMeasurements.reduce((sum, m) => sum + m.score, 0) / groupMeasurements.length;\n      const bestQuality = avgScore >= 9 ? 'excellent' : avgScore >= 8 ? 'good' : 'below_average';\n\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Create grouped strength with multiple contributing ratios\n      strengths.push({\n        id: `strength_group_${groupId}`,\n        strengthName: groupConfig.name,\n        summary: groupConfig.description,\n        avgScore,\n        qualityLevel: bestQuality,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual strengths that weren't grouped\n  analysis.strengths.forEach((s, i) => {\n    if (usedMetricIds.has(s.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);\n\n    strengths.push({\n      id: `strength_${i}`,\n      strengthName: s.metricName,\n      summary: s.reasoning,\n      avgScore: matchingMeasurement?.score || 8,\n      qualityLevel: s.qualityTier,\n      categoryName: s.category,\n      responsibleRatios: [{\n        ratioName: s.metricName,\n        ratioId: s.metricId,\n        score: matchingMeasurement?.score || 8,\n        value: s.value,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: s.category,\n      }],\n    });\n  });\n\n  // Sort by average score (highest first) then by number of contributing ratios\n  return strengths.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.avgScore - a.avgScore;\n  });\n}\n\n// Flaw groupings - similar to strength groupings but for areas of improvement\nconst FLAW_GROUPINGS: Record<string, {\n  name: string;\n  category: string;\n  description: string;\n  metrics: string[];\n}> = {\n  // Lip Issues\n  lipIssues: {\n    name: 'Lip Proportion Concerns',\n    category: 'Lips',\n    description: 'The lip proportions show deviation from ideal ratios, affecting lower face harmony.',\n    metrics: ['lipRatio', 'philtrumLength', 'upperLipProjection', 'lowerLipProjection', 'lipChinDistance'],\n  },\n  // Eye Issues\n  eyeIssues: {\n    name: 'Eye Shape Considerations',\n    category: 'Eyes',\n    description: 'The eye proportions or positioning could benefit from enhancement.',\n    metrics: ['lateralCanthalTilt', 'eyeAspectRatio', 'intercanthalWidth', 'eyeSeparationRatio', 'eyebrowHeight'],\n  },\n  // Nose Issues\n  noseIssues: {\n    name: 'Nasal Proportion Concerns',\n    category: 'Nose',\n    description: 'The nasal proportions show deviations that affect facial harmony.',\n    metrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],\n  },\n  // Jaw Issues\n  jawIssues: {\n    name: 'Jawline Definition Concerns',\n    category: 'Jaw Shape',\n    description: 'The jawline structure shows areas that could be enhanced for better definition.',\n    metrics: ['gonialAngle', 'jawWidthRatio', 'bigonialWidth', 'mandibularPlaneAngle', 'jawFrontalAngle', 'jawSlope'],\n  },\n  // Chin Issues\n  chinIssues: {\n    name: 'Chin Projection Concerns',\n    category: 'Chin',\n    description: 'The chin proportions deviate from ideal, affecting facial profile balance.',\n    metrics: ['chinPhiltrumRatio', 'chinHeight', 'facialDepthToHeight', 'anteriorFacialDepth'],\n  },\n  // Face Proportion Issues\n  proportionIssues: {\n    name: 'Facial Proportion Imbalance',\n    category: 'Face Proportions',\n    description: 'The vertical face proportions show imbalance between facial thirds.',\n    metrics: ['faceWidthToHeight', 'upperThirdProportion', 'middleThirdProportion', 'lowerThirdProportion'],\n  },\n  // Midface Issues\n  midfaceIssues: {\n    name: 'Midface Development Concerns',\n    category: 'Midface/Face Shape',\n    description: 'The midface shows areas that could benefit from enhanced projection or balance.',\n    metrics: ['midfaceRatio', 'cheekboneHeight', 'cheekboneWidth', 'totalFacialWidthToHeight'],\n  },\n};\n\nfunction generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {\n  const flaws: Flaw[] = [];\n  const usedMetricIds = new Set<string>();\n  let rollingLost = 0;\n\n  // First pass: Create grouped flaws from related low-scoring metrics\n  Object.entries(FLAW_GROUPINGS).forEach(([groupId, groupConfig]) => {\n    // Find all low-scoring measurements that belong to this group\n    const groupMeasurements = analysis.measurements.filter(m =>\n      groupConfig.metrics.includes(m.metricId) &&\n      m.score < 6 &&\n      !usedMetricIds.has(m.metricId)\n    );\n\n    // Only create a grouped flaw if we have 2+ metrics with low scores\n    if (groupMeasurements.length >= 2) {\n      // Mark these metrics as used\n      groupMeasurements.forEach(m => usedMetricIds.add(m.metricId));\n\n      // Calculate total impact from all metrics in this group\n      const totalImpact = groupMeasurements.reduce((sum, m) => sum + (10 - m.score) * 0.4, 0);\n      rollingLost += totalImpact;\n\n      // Create grouped flaw with multiple contributing ratios\n      flaws.push({\n        id: `flaw_group_${groupId}`,\n        flawName: groupConfig.name,\n        summary: groupConfig.description,\n        harmonyPercentageLost: totalImpact,\n        standardizedImpact: totalImpact / 10,\n        categoryName: groupConfig.category,\n        responsibleRatios: groupMeasurements.map(m => ({\n          ratioName: m.name,\n          ratioId: m.metricId,\n          score: m.score,\n          value: m.value,\n          idealMin: m.idealMin,\n          idealMax: m.idealMax,\n          unit: m.unit,\n          category: m.category,\n        })),\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      });\n    }\n  });\n\n  // Second pass: Add remaining individual flaws that weren't grouped\n  analysis.flaws.forEach((f, i) => {\n    if (usedMetricIds.has(f.metricId)) return; // Skip if already used in a group\n\n    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);\n    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;\n    rollingLost += impact;\n\n    flaws.push({\n      id: `flaw_${i}`,\n      flawName: f.metricName,\n      summary: f.reasoning,\n      harmonyPercentageLost: impact,\n      standardizedImpact: impact / 10,\n      categoryName: f.category,\n      responsibleRatios: [{\n        ratioName: f.metricName,\n        ratioId: f.metricId,\n        score: matchingMeasurement?.score || 3,\n        value: matchingMeasurement?.value || 0,\n        idealMin: matchingMeasurement?.idealMin || 0,\n        idealMax: matchingMeasurement?.idealMax || 1,\n        unit: matchingMeasurement?.unit || 'ratio',\n        category: f.category,\n      }],\n      rollingPointsDeducted: rollingLost,\n      rollingHarmonyPercentageLost: rollingLost,\n      rollingStandardizedImpact: rollingLost / 10,\n    });\n  });\n\n  // Sort by impact (highest first) then by number of contributing ratios\n  return flaws.sort((a, b) => {\n    if (b.responsibleRatios.length !== a.responsibleRatios.length) {\n      return b.responsibleRatios.length - a.responsibleRatios.length;\n    }\n    return b.harmonyPercentageLost - a.harmonyPercentageLost;\n  });\n}\n\n// NOTE: PROCEDURE_DATABASE, ProcedureConfig, and recommendation generation functions\n// have been moved to @/lib/results/analysis.ts to reduce bundle size\n// Import generateRecommendations from there instead\n// ============================================\n// CONTEXT CREATION\n// ============================================\n\nconst ResultsContext = createContext<ResultsContextType | null>(null);\n\nexport function useResults(): ResultsContextType {\n  const context = useContext(ResultsContext);\n  if (!context) {\n    throw new Error('useResults must be used within a ResultsProvider');\n  }\n  return context;\n}\n\ninterface ResultsProviderProps {\n  children: ReactNode;\n  initialData?: ResultsInputData;\n}\n\nexport function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  // Raw data state\n  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n\n  // UI state\n  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n\n  // Compute analysis results (now with demographic-specific scoring)\n  const analysisResults = useMemo(() => {\n    if (frontLandmarks.length === 0) {\n      return null;\n    }\n\n    try {\n      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n      const sideAnalysis = sideLandmarks.length > 0\n        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n        : null;\n      // analyzeHarmony expects landmarks directly, not analysis results\n      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n\n      return { frontAnalysis, sideAnalysis, harmony };\n    } catch (error) {\n      console.error('Analysis error:', error);\n      return null;\n    }\n  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n\n  // Transform to Ratio format\n  const frontRatios = useMemo(() => {\n    if (!analysisResults?.frontAnalysis) return [];\n    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  }, [analysisResults, frontLandmarks]);\n\n  const sideRatios = useMemo(() => {\n    if (!analysisResults?.sideAnalysis) return [];\n    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  }, [analysisResults, sideLandmarks]);\n\n  // Generate strengths and flaws using INSIGHTS-BASED classification\n  // This processes insights.json definitions: calculates avg score of affected metrics,\n  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  const { insightStrengths, insightFlaws } = useMemo(() => {\n    if (!analysisResults?.harmony) {\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n\n    try {\n      // Classify using insights engine\n      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n\n      // Convert to UI-compatible types\n      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n      let rollingLost = 0;\n      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n        const flaw = convertToFlaw(w, i, rollingLost);\n        rollingLost = flaw.rollingPointsDeducted || 0;\n        return flaw;\n      });\n\n      return { insightStrengths, insightFlaws };\n    } catch (error) {\n      console.error('[ResultsContext] Error in insights classification:', error);\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n  }, [analysisResults]);\n\n  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  const groupingStrengths = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  const groupingFlaws = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateFlawsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);\n\n  // Merge insights + groupings, preferring insights (dedupe by category/metric overlap)\n  const strengths = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightStrengths.forEach(s => {\n      s.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based strengths that don't overlap\n    const nonOverlappingGrouping = groupingStrengths.filter(gs => {\n      const overlap = gs.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    return [...insightStrengths, ...nonOverlappingGrouping];\n  }, [insightStrengths, groupingStrengths]);\n\n  const flaws = useMemo(() => {\n    // Use insights as primary source\n    const usedMetricIds = new Set<string>();\n    insightFlaws.forEach(f => {\n      f.responsibleRatios.forEach(r => usedMetricIds.add(r.ratioId));\n    });\n\n    // Add grouping-based flaws that don't overlap\n    const nonOverlappingGrouping = groupingFlaws.filter(gf => {\n      const overlap = gf.responsibleRatios.some(r => usedMetricIds.has(r.ratioId));\n      return !overlap;\n    });\n\n    // Recalculate rolling totals for merged list\n    let rollingLost = 0;\n    const merged = [...insightFlaws, ...nonOverlappingGrouping];\n    return merged.map(f => {\n      rollingLost += f.harmonyPercentageLost;\n      return {\n        ...f,\n        rollingPointsDeducted: rollingLost,\n        rollingHarmonyPercentageLost: rollingLost,\n        rollingStandardizedImpact: rollingLost / 10,\n      };\n    });\n  }, [insightFlaws, groupingFlaws]);\n\n  // Generate recommendations with metric-aware matching and Bezier recalculation\n  const recommendations = useMemo(() => {\n    return generateRecommendations(flaws, frontRatios, sideRatios, gender, ethnicity);\n  }, [flaws, frontRatios, sideRatios, gender, ethnicity]);\n\n  // Build full harmony analysis\n  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {\n    if (!analysisResults?.harmony) return null;\n\n    return {\n      standardizedScore: analysisResults.harmony.overallScore,\n      front: {\n        standardizedScore: analysisResults.harmony.frontScore,\n        ratios: frontRatios,\n      },\n      side: {\n        standardizedScore: analysisResults.harmony.sideScore,\n        ratios: sideRatios,\n      },\n      strengths,\n      flaws,\n    };\n  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);\n\n  // Calculate weighted harmony score using looksmax_engine.py algorithm\n  const harmonyScoreResult = useMemo((): HarmonyScoreResult | null => {\n    if (!analysisResults?.harmony) return null;\n\n    const allMeasurements = analysisResults.harmony.measurements.map(m => ({\n      metricId: m.metricId,\n      standardizedScore: m.standardizedScore,\n    }));\n\n    return calculateHarmonyScore(allMeasurements);\n  }, [analysisResults]);\n\n  // Get top 3 and bottom 3 metrics with advice\n  const topMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getTopMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  const bottomMetrics = useMemo((): RankedMetric[] => {\n    if (!analysisResults?.harmony) return [];\n    return getBottomMetrics(analysisResults.harmony.measurements, 3);\n  }, [analysisResults]);\n\n  // Scores - now using weighted harmony\n  const harmonyPercentage = harmonyScoreResult?.harmonyPercentage || 0;\n  const overallScore = harmonyScoreResult?.weightedAverage || analysisResults?.harmony?.overallScore || 0;\n  const frontScore = analysisResults?.harmony?.frontScore || 0;\n  const sideScore = analysisResults?.harmony?.sideScore || 0;\n\n  // PSL Rating (1-10 scale with tier/percentile)\n  const pslRating = useMemo(() => {\n    return harmonyToPSL(harmonyPercentage);\n  }, [harmonyPercentage]);\n\n  // Action to set all results data\n  const setResultsData = useCallback((data: ResultsInputData) => {\n    setFrontLandmarks(data.frontLandmarks);\n    setSideLandmarks(data.sideLandmarks);\n    setFrontPhoto(data.frontPhoto);\n    setSidePhoto(data.sidePhoto || null);\n    setGender(data.gender);\n    setEthnicity(data.ethnicity || 'other');\n  }, []);\n\n  // Memoize context value to prevent unnecessary re-renders\n  const value = useMemo<ResultsContextType>(() => ({\n    frontLandmarks,\n    sideLandmarks,\n    gender,\n    ethnicity,\n    frontPhoto,\n    sidePhoto,\n    harmonyAnalysis,\n    frontRatios,\n    sideRatios,\n    strengths,\n    flaws,\n    recommendations,\n    overallScore,\n    frontScore,\n    sideScore,\n    // Weighted harmony from looksmax_engine.py\n    harmonyScoreResult,\n    harmonyPercentage,\n    topMetrics,\n    bottomMetrics,\n    // PSL Rating\n    pslRating,\n    // UI state\n    activeTab,\n    setActiveTab,\n    expandedMeasurementId,\n    setExpandedMeasurementId,\n    selectedVisualizationMetric,\n    setSelectedVisualizationMetric,\n    categoryFilter,\n    setCategoryFilter,\n    showLandmarkOverlay,\n    setShowLandmarkOverlay,\n    setResultsData,\n  }), [\n    frontLandmarks, sideLandmarks, gender, ethnicity, frontPhoto, sidePhoto,\n    harmonyAnalysis, frontRatios, sideRatios, strengths, flaws, recommendations,\n    overallScore, frontScore, sideScore, harmonyScoreResult, harmonyPercentage,\n    topMetrics, bottomMetrics, pslRating, activeTab, setActiveTab,\n    expandedMeasurementId, setExpandedMeasurementId, selectedVisualizationMetric,\n    setSelectedVisualizationMetric, categoryFilter, setCategoryFilter,\n    showLandmarkOverlay, setShowLandmarkOverlay, setResultsData,\n  ]);\n\n  return (\n    <ResultsContext.Provider value={value}>\n      {children}\n    </ResultsContext.Provider>\n  );\n}\n","numLines":1382,"startLine":1,"totalLines":1382}}}
{"parentUuid":"965e41d8-07fd-4fbc-ab1a-0c7ae38579a9","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YUhmUfLAj5jKVQZbD646is","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me explore the onboarding flow, backend routers, and existing recommendation engine to understand how height input and PSL calculation should integrate:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":41951,"cache_read_input_tokens":44094,"cache_creation":{"ephemeral_5m_input_tokens":41951,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGNMZqPFjADit5ebYwK","type":"assistant","uuid":"cd4042f3-ee85-44df-8a96-7374cdb12de2","timestamp":"2025-12-25T23:22:54.980Z"}
{"parentUuid":"cd4042f3-ee85-44df-8a96-7374cdb12de2","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YUhmUfLAj5jKVQZbD646is","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ho8eMvWNekRdGRN5NY9e1D","name":"Glob","input":{"pattern":"**/src/app/(onboarding)/**/*.tsx","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":41951,"cache_read_input_tokens":44094,"cache_creation":{"ephemeral_5m_input_tokens":41951,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGNMZqPFjADit5ebYwK","type":"assistant","uuid":"cdf62b35-89f4-43ab-a8b6-e4541bafeb7e","timestamp":"2025-12-25T23:22:56.758Z"}
{"parentUuid":"cdf62b35-89f4-43ab-a8b6-e4541bafeb7e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YUhmUfLAj5jKVQZbD646is","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01V8e2nig1zZmTy2EZ9qyct3","name":"Glob","input":{"pattern":"**/routers/*.py","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-api"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":41951,"cache_read_input_tokens":44094,"cache_creation":{"ephemeral_5m_input_tokens":41951,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGNMZqPFjADit5ebYwK","type":"assistant","uuid":"12062c97-255f-4042-9f9f-2f9cac1d4489","timestamp":"2025-12-25T23:22:58.111Z"}
{"parentUuid":"12062c97-255f-4042-9f9f-2f9cac1d4489","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YUhmUfLAj5jKVQZbD646is","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Xiz5YHsyjncKiS9dwYmpRv","name":"Glob","input":{"pattern":"**/models/*.py","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-api"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":41951,"cache_read_input_tokens":44094,"cache_creation":{"ephemeral_5m_input_tokens":41951,"ephemeral_1h_input_tokens":0},"output_tokens":279,"service_tier":"standard"}},"requestId":"req_011CWUGNMZqPFjADit5ebYwK","type":"assistant","uuid":"1c7c0601-28fd-4415-bffe-9065cf187cdc","timestamp":"2025-12-25T23:22:59.266Z"}
{"parentUuid":"1c7c0601-28fd-4415-bffe-9065cf187cdc","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01V8e2nig1zZmTy2EZ9qyct3","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/analyses.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/detection.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/leaderboard.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/auth.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/payments.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/referrals.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/__init__.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/forum.py"}]},"uuid":"145bdb42-73f3-4200-9e15-f8b5f0aaf980","timestamp":"2025-12-25T23:22:59.682Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/analyses.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/detection.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/leaderboard.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/auth.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/payments.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/referrals.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/__init__.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/forum.py"],"durationMs":372,"numFiles":8,"truncated":false}}
{"parentUuid":"145bdb42-73f3-4200-9e15-f8b5f0aaf980","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ho8eMvWNekRdGRN5NY9e1D","type":"tool_result","content":"No files found"}]},"uuid":"f0295699-18f5-4586-bbb7-6605ef51a6c6","timestamp":"2025-12-25T23:23:00.003Z","toolUseResult":{"filenames":[],"durationMs":694,"numFiles":0,"truncated":false}}
{"parentUuid":"f0295699-18f5-4586-bbb7-6605ef51a6c6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Xiz5YHsyjncKiS9dwYmpRv","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/analysis.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/payment.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/leaderboard.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/user.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/forum.py\n/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/__init__.py"}]},"uuid":"8b9b0225-0e30-46b5-a6dd-c5b40e5b5223","timestamp":"2025-12-25T23:23:00.082Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/analysis.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/payment.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/leaderboard.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/user.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/forum.py","/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/__init__.py"],"durationMs":773,"numFiles":6,"truncated":false}}
{"parentUuid":"8b9b0225-0e30-46b5-a6dd-c5b40e5b5223","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LPex5T8ZR6ahyvJNrtwFdr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UfthLxQcdajA9jnhaWEz9D","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/user.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":908,"cache_read_input_tokens":86045,"cache_creation":{"ephemeral_5m_input_tokens":908,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWUGP3K1PzC8mTYpAYFLJ","type":"assistant","uuid":"528abd7b-e6ff-4d4f-ae71-6770b3be2e04","timestamp":"2025-12-25T23:23:03.212Z"}
{"parentUuid":"528abd7b-e6ff-4d4f-ae71-6770b3be2e04","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LPex5T8ZR6ahyvJNrtwFdr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ARk5pEMXCAXRZNtJpy85uE","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/analysis.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":908,"cache_read_input_tokens":86045,"cache_creation":{"ephemeral_5m_input_tokens":908,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWUGP3K1PzC8mTYpAYFLJ","type":"assistant","uuid":"60cd61ad-05d8-4c7b-9b23-2e363424b670","timestamp":"2025-12-25T23:23:03.650Z"}
{"parentUuid":"60cd61ad-05d8-4c7b-9b23-2e363424b670","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LPex5T8ZR6ahyvJNrtwFdr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XADnusyMeD3Kkf6922mWEU","name":"Glob","input":{"pattern":"**/src/app/gender/**/*.tsx","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":908,"cache_read_input_tokens":86045,"cache_creation":{"ephemeral_5m_input_tokens":908,"ephemeral_1h_input_tokens":0},"output_tokens":220,"service_tier":"standard"}},"requestId":"req_011CWUGP3K1PzC8mTYpAYFLJ","type":"assistant","uuid":"befac4da-3870-4a79-9062-7636da91faeb","timestamp":"2025-12-25T23:23:04.685Z"}
{"parentUuid":"befac4da-3870-4a79-9062-7636da91faeb","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UfthLxQcdajA9jnhaWEz9D","type":"tool_result","content":"     1→\"\"\"\n     2→User database model\n     3→\"\"\"\n     4→\n     5→import uuid\n     6→from datetime import datetime\n     7→from sqlalchemy import Column, String, DateTime, Enum, Boolean, Integer\n     8→from sqlalchemy.dialects.postgresql import UUID\n     9→from sqlalchemy.orm import relationship\n    10→import enum\n    11→\n    12→from app.database import Base\n    13→\n    14→\n    15→class PlanType(str, enum.Enum):\n    16→    FREE = \"free\"\n    17→    BASIC = \"basic\"\n    18→    PRO = \"pro\"\n    19→\n    20→\n    21→class UserRole(str, enum.Enum):\n    22→    USER = \"user\"\n    23→    MODERATOR = \"moderator\"\n    24→    ADMIN = \"admin\"\n    25→\n    26→\n    27→class User(Base):\n    28→    __tablename__ = \"users\"\n    29→\n    30→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    31→    email = Column(String, unique=True, nullable=False, index=True)\n    32→    password_hash = Column(String, nullable=False)\n    33→    name = Column(String, nullable=True)\n    34→    username = Column(String(30), unique=True, nullable=False, index=True)\n    35→    terms_accepted_at = Column(DateTime, nullable=True)\n    36→    plan = Column(Enum(PlanType), default=PlanType.FREE)\n    37→    stripe_customer_id = Column(String, nullable=True)\n    38→    stripe_subscription_id = Column(String, nullable=True)\n    39→\n    40→    # User role for moderation\n    41→    role = Column(Enum(UserRole), default=UserRole.USER)\n    42→\n    43→    # Referral tracking\n    44→    referral_code = Column(String(50), nullable=True, index=True)  # Code used at signup\n    45→    referred_by = Column(String(100), nullable=True, index=True)  # Stripe promo code ID\n    46→\n    47→    # Password reset\n    48→    password_reset_token = Column(String(255), nullable=True, index=True)\n    49→    password_reset_expires = Column(DateTime, nullable=True)\n    50→\n    51→    created_at = Column(DateTime, default=datetime.utcnow)\n    52→    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    53→\n    54→    # Relationships\n    55→    analyses = relationship(\"Analysis\", back_populates=\"user\", cascade=\"all, delete-orphan\")\n    56→    payments = relationship(\"Payment\", back_populates=\"user\", cascade=\"all, delete-orphan\")\n    57→\n    58→    def __repr__(self):\n    59→        return f\"<User {self.email}>\"\n    60→\n    61→\n    62→class ReferralCode(Base):\n    63→    \"\"\"Influencer referral codes linked to Stripe promotion codes\"\"\"\n    64→    __tablename__ = \"referral_codes\"\n    65→\n    66→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    67→    code = Column(String(50), unique=True, nullable=False, index=True)\n    68→    influencer_name = Column(String(100), nullable=False)\n    69→    stripe_promotion_code_id = Column(String(100), nullable=True)\n    70→    stripe_coupon_id = Column(String(100), nullable=True)\n    71→    discount_percent = Column(Integer, default=10)\n    72→    is_active = Column(Boolean, default=True)\n    73→    total_uses = Column(Integer, default=0)\n    74→    created_at = Column(DateTime, default=datetime.utcnow)\n    75→    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    76→\n    77→    def __repr__(self):\n    78→        return f\"<ReferralCode {self.code}>\"\n    79→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"bd752453-6c8a-468b-8ed8-9c6b67b6935a","timestamp":"2025-12-25T23:23:04.746Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/user.py","content":"\"\"\"\nUser database model\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\nfrom sqlalchemy import Column, String, DateTime, Enum, Boolean, Integer\nfrom sqlalchemy.dialects.postgresql import UUID\nfrom sqlalchemy.orm import relationship\nimport enum\n\nfrom app.database import Base\n\n\nclass PlanType(str, enum.Enum):\n    FREE = \"free\"\n    BASIC = \"basic\"\n    PRO = \"pro\"\n\n\nclass UserRole(str, enum.Enum):\n    USER = \"user\"\n    MODERATOR = \"moderator\"\n    ADMIN = \"admin\"\n\n\nclass User(Base):\n    __tablename__ = \"users\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    email = Column(String, unique=True, nullable=False, index=True)\n    password_hash = Column(String, nullable=False)\n    name = Column(String, nullable=True)\n    username = Column(String(30), unique=True, nullable=False, index=True)\n    terms_accepted_at = Column(DateTime, nullable=True)\n    plan = Column(Enum(PlanType), default=PlanType.FREE)\n    stripe_customer_id = Column(String, nullable=True)\n    stripe_subscription_id = Column(String, nullable=True)\n\n    # User role for moderation\n    role = Column(Enum(UserRole), default=UserRole.USER)\n\n    # Referral tracking\n    referral_code = Column(String(50), nullable=True, index=True)  # Code used at signup\n    referred_by = Column(String(100), nullable=True, index=True)  # Stripe promo code ID\n\n    # Password reset\n    password_reset_token = Column(String(255), nullable=True, index=True)\n    password_reset_expires = Column(DateTime, nullable=True)\n\n    created_at = Column(DateTime, default=datetime.utcnow)\n    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n\n    # Relationships\n    analyses = relationship(\"Analysis\", back_populates=\"user\", cascade=\"all, delete-orphan\")\n    payments = relationship(\"Payment\", back_populates=\"user\", cascade=\"all, delete-orphan\")\n\n    def __repr__(self):\n        return f\"<User {self.email}>\"\n\n\nclass ReferralCode(Base):\n    \"\"\"Influencer referral codes linked to Stripe promotion codes\"\"\"\n    __tablename__ = \"referral_codes\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    code = Column(String(50), unique=True, nullable=False, index=True)\n    influencer_name = Column(String(100), nullable=False)\n    stripe_promotion_code_id = Column(String(100), nullable=True)\n    stripe_coupon_id = Column(String(100), nullable=True)\n    discount_percent = Column(Integer, default=10)\n    is_active = Column(Boolean, default=True)\n    total_uses = Column(Integer, default=0)\n    created_at = Column(DateTime, default=datetime.utcnow)\n    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n\n    def __repr__(self):\n        return f\"<ReferralCode {self.code}>\"\n","numLines":79,"startLine":1,"totalLines":79}}}
{"parentUuid":"bd752453-6c8a-468b-8ed8-9c6b67b6935a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ARk5pEMXCAXRZNtJpy85uE","type":"tool_result","content":"     1→\"\"\"\n     2→Analysis database model - stores facial analysis results\n     3→\"\"\"\n     4→\n     5→import uuid\n     6→from datetime import datetime\n     7→from sqlalchemy import Column, String, DateTime, ForeignKey, JSON\n     8→from sqlalchemy.dialects.postgresql import UUID\n     9→from sqlalchemy.orm import relationship\n    10→\n    11→from app.database import Base\n    12→\n    13→\n    14→class Analysis(Base):\n    15→    __tablename__ = \"analyses\"\n    16→\n    17→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    18→    user_id = Column(UUID(as_uuid=True), ForeignKey(\"users.id\"), nullable=False)\n    19→\n    20→    # Image URLs (stored in S3)\n    21→    front_image_url = Column(String, nullable=True)\n    22→    side_image_url = Column(String, nullable=True)\n    23→\n    24→    # Landmark data (JSON)\n    25→    front_landmarks = Column(JSON, nullable=True)\n    26→    side_landmarks = Column(JSON, nullable=True)\n    27→\n    28→    # Calculated scores (computed client-side, stored for history)\n    29→    scores = Column(JSON, nullable=True)\n    30→\n    31→    # Metadata\n    32→    gender = Column(String, nullable=True)\n    33→    ethnicity = Column(String, nullable=True)\n    34→\n    35→    created_at = Column(DateTime, default=datetime.utcnow)\n    36→\n    37→    # Relationships\n    38→    user = relationship(\"User\", back_populates=\"analyses\")\n    39→\n    40→    def __repr__(self):\n    41→        return f\"<Analysis {self.id}>\"\n    42→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"4aaa9b2e-b643-40fe-b511-a523eb1147fb","timestamp":"2025-12-25T23:23:04.746Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/analysis.py","content":"\"\"\"\nAnalysis database model - stores facial analysis results\n\"\"\"\n\nimport uuid\nfrom datetime import datetime\nfrom sqlalchemy import Column, String, DateTime, ForeignKey, JSON\nfrom sqlalchemy.dialects.postgresql import UUID\nfrom sqlalchemy.orm import relationship\n\nfrom app.database import Base\n\n\nclass Analysis(Base):\n    __tablename__ = \"analyses\"\n\n    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)\n    user_id = Column(UUID(as_uuid=True), ForeignKey(\"users.id\"), nullable=False)\n\n    # Image URLs (stored in S3)\n    front_image_url = Column(String, nullable=True)\n    side_image_url = Column(String, nullable=True)\n\n    # Landmark data (JSON)\n    front_landmarks = Column(JSON, nullable=True)\n    side_landmarks = Column(JSON, nullable=True)\n\n    # Calculated scores (computed client-side, stored for history)\n    scores = Column(JSON, nullable=True)\n\n    # Metadata\n    gender = Column(String, nullable=True)\n    ethnicity = Column(String, nullable=True)\n\n    created_at = Column(DateTime, default=datetime.utcnow)\n\n    # Relationships\n    user = relationship(\"User\", back_populates=\"analyses\")\n\n    def __repr__(self):\n        return f\"<Analysis {self.id}>\"\n","numLines":42,"startLine":1,"totalLines":42}}}
{"parentUuid":"4aaa9b2e-b643-40fe-b511-a523eb1147fb","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XADnusyMeD3Kkf6922mWEU","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/gender/page.tsx"}]},"uuid":"ceb905d6-c047-408f-b3a2-6804dec28178","timestamp":"2025-12-25T23:23:05.157Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/gender/page.tsx"],"durationMs":417,"numFiles":1,"truncated":false}}
{"parentUuid":"ceb905d6-c047-408f-b3a2-6804dec28178","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_014tEK2Cv1C1hq5QDiveJ56a","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MS1tQZ4QDYQ6kdvP1PaQyD","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/gender/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2184,"cache_read_input_tokens":86953,"cache_creation":{"ephemeral_5m_input_tokens":2184,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWUGPQkc4DvmCynqhhr1e","type":"assistant","uuid":"050f3cdb-5658-4a96-a9cc-e4f48e6bb5b4","timestamp":"2025-12-25T23:23:08.403Z"}
{"parentUuid":"050f3cdb-5658-4a96-a9cc-e4f48e6bb5b4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_014tEK2Cv1C1hq5QDiveJ56a","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YX3iQq23yyh2wZpZyrP9XN","name":"Glob","input":{"pattern":"**/src/types/*.ts","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2184,"cache_read_input_tokens":86953,"cache_creation":{"ephemeral_5m_input_tokens":2184,"ephemeral_1h_input_tokens":0},"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CWUGPQkc4DvmCynqhhr1e","type":"assistant","uuid":"a8ea2080-1bc5-41c0-8ec9-484b0fc136e6","timestamp":"2025-12-25T23:23:09.590Z"}
{"parentUuid":"a8ea2080-1bc5-41c0-8ec9-484b0fc136e6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_014tEK2Cv1C1hq5QDiveJ56a","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YLxB8xEKfwExGpeU1AMeLz","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/api.ts"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2184,"cache_read_input_tokens":86953,"cache_creation":{"ephemeral_5m_input_tokens":2184,"ephemeral_1h_input_tokens":0},"output_tokens":219,"service_tier":"standard"}},"requestId":"req_011CWUGPQkc4DvmCynqhhr1e","type":"assistant","uuid":"233a6ce6-5bb4-4392-9ea7-9793b7d65158","timestamp":"2025-12-25T23:23:10.408Z"}
{"parentUuid":"233a6ce6-5bb4-4392-9ea7-9793b7d65158","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MS1tQZ4QDYQ6kdvP1PaQyD","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useRouter } from 'next/navigation';\n     4→import { useGender, Gender } from '@/contexts/GenderContext';\n     5→\n     6→export default function GenderPage() {\n     7→  const router = useRouter();\n     8→  const { gender, setGender } = useGender();\n     9→\n    10→  const handleSelect = (selectedGender: Gender) => {\n    11→    setGender(selectedGender);\n    12→  };\n    13→\n    14→  const handleContinue = () => {\n    15→    if (gender) {\n    16→      router.push('/ethnicity');\n    17→    }\n    18→  };\n    19→\n    20→  return (\n    21→    <div className=\"min-h-screen flex flex-col items-center justify-center bg-black px-4\">\n    22→      <div className=\"w-full max-w-sm\">\n    23→        {/* Header */}\n    24→        <div className=\"mb-10\">\n    25→          <div className=\"flex justify-center mb-6\">\n    26→            {/* Logo */}\n    27→            <div className=\"h-8 w-8 rounded bg-[#00f3ff]/20 flex items-center justify-center\">\n    28→              <span className=\"text-[#00f3ff] text-sm font-bold\">L</span>\n    29→            </div>\n    30→          </div>\n    31→          <h1 className=\"text-2xl font-semibold tracking-tight text-center text-white mb-2\">\n    32→            Select Gender\n    33→          </h1>\n    34→          <p className=\"text-sm text-neutral-400 text-center\">\n    35→            Help us personalize your analysis\n    36→          </p>\n    37→        </div>\n    38→\n    39→        {/* Gender Options */}\n    40→        <div className=\"space-y-3\">\n    41→          {/* Male Button */}\n    42→          <button\n    43→            onClick={() => handleSelect('male')}\n    44→            className={`\n    45→              w-full h-14 rounded-xl border-2\n    46→              flex items-center justify-between px-5\n    47→              transition-all duration-200 cursor-pointer\n    48→              ${gender === 'male'\n    49→                ? 'border-[#00f3ff] bg-[#00f3ff]/5'\n    50→                : 'border-neutral-800 bg-black hover:border-neutral-700'\n    51→              }\n    52→            `}\n    53→          >\n    54→            <span className={`\n    55→              font-medium transition-colors duration-200\n    56→              ${gender === 'male' ? 'text-white' : 'text-neutral-300'}\n    57→            `}>\n    58→              Male\n    59→            </span>\n    60→            {/* Radio indicator */}\n    61→            <div className={`\n    62→              w-5 h-5 rounded-full border-2 flex items-center justify-center\n    63→              transition-all duration-200\n    64→              ${gender === 'male'\n    65→                ? 'border-[#00f3ff] bg-[#00f3ff]'\n    66→                : 'border-neutral-600 bg-transparent'\n    67→              }\n    68→            `}>\n    69→              {gender === 'male' && (\n    70→                <div className=\"w-2 h-2 rounded-full bg-black\" />\n    71→              )}\n    72→            </div>\n    73→          </button>\n    74→\n    75→          {/* Female Button */}\n    76→          <button\n    77→            onClick={() => handleSelect('female')}\n    78→            className={`\n    79→              w-full h-14 rounded-xl border-2\n    80→              flex items-center justify-between px-5\n    81→              transition-all duration-200 cursor-pointer\n    82→              ${gender === 'female'\n    83→                ? 'border-[#00f3ff] bg-[#00f3ff]/5'\n    84→                : 'border-neutral-800 bg-black hover:border-neutral-700'\n    85→              }\n    86→            `}\n    87→          >\n    88→            <span className={`\n    89→              font-medium transition-colors duration-200\n    90→              ${gender === 'female' ? 'text-white' : 'text-neutral-300'}\n    91→            `}>\n    92→              Female\n    93→            </span>\n    94→            {/* Radio indicator */}\n    95→            <div className={`\n    96→              w-5 h-5 rounded-full border-2 flex items-center justify-center\n    97→              transition-all duration-200\n    98→              ${gender === 'female'\n    99→                ? 'border-[#00f3ff] bg-[#00f3ff]'\n   100→                : 'border-neutral-600 bg-transparent'\n   101→              }\n   102→            `}>\n   103→              {gender === 'female' && (\n   104→                <div className=\"w-2 h-2 rounded-full bg-black\" />\n   105→              )}\n   106→            </div>\n   107→          </button>\n   108→        </div>\n   109→\n   110→        {/* Continue Button */}\n   111→        <button\n   112→          onClick={handleContinue}\n   113→          disabled={!gender}\n   114→          className={`\n   115→            w-full h-12 mt-6 rounded-xl font-medium text-sm\n   116→            transition-all duration-200\n   117→            ${gender\n   118→              ? 'bg-[#00f3ff] text-black hover:shadow-[0_0_20px_rgba(0,243,255,0.3)] cursor-pointer'\n   119→              : 'bg-neutral-800 text-neutral-500 cursor-not-allowed'\n   120→            }\n   121→          `}\n   122→        >\n   123→          Continue\n   124→        </button>\n   125→      </div>\n   126→    </div>\n   127→  );\n   128→}\n   129→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ca0ce618-6851-4bf5-a688-2e8c661dc31e","timestamp":"2025-12-25T23:23:10.460Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/gender/page.tsx","content":"'use client';\n\nimport { useRouter } from 'next/navigation';\nimport { useGender, Gender } from '@/contexts/GenderContext';\n\nexport default function GenderPage() {\n  const router = useRouter();\n  const { gender, setGender } = useGender();\n\n  const handleSelect = (selectedGender: Gender) => {\n    setGender(selectedGender);\n  };\n\n  const handleContinue = () => {\n    if (gender) {\n      router.push('/ethnicity');\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex flex-col items-center justify-center bg-black px-4\">\n      <div className=\"w-full max-w-sm\">\n        {/* Header */}\n        <div className=\"mb-10\">\n          <div className=\"flex justify-center mb-6\">\n            {/* Logo */}\n            <div className=\"h-8 w-8 rounded bg-[#00f3ff]/20 flex items-center justify-center\">\n              <span className=\"text-[#00f3ff] text-sm font-bold\">L</span>\n            </div>\n          </div>\n          <h1 className=\"text-2xl font-semibold tracking-tight text-center text-white mb-2\">\n            Select Gender\n          </h1>\n          <p className=\"text-sm text-neutral-400 text-center\">\n            Help us personalize your analysis\n          </p>\n        </div>\n\n        {/* Gender Options */}\n        <div className=\"space-y-3\">\n          {/* Male Button */}\n          <button\n            onClick={() => handleSelect('male')}\n            className={`\n              w-full h-14 rounded-xl border-2\n              flex items-center justify-between px-5\n              transition-all duration-200 cursor-pointer\n              ${gender === 'male'\n                ? 'border-[#00f3ff] bg-[#00f3ff]/5'\n                : 'border-neutral-800 bg-black hover:border-neutral-700'\n              }\n            `}\n          >\n            <span className={`\n              font-medium transition-colors duration-200\n              ${gender === 'male' ? 'text-white' : 'text-neutral-300'}\n            `}>\n              Male\n            </span>\n            {/* Radio indicator */}\n            <div className={`\n              w-5 h-5 rounded-full border-2 flex items-center justify-center\n              transition-all duration-200\n              ${gender === 'male'\n                ? 'border-[#00f3ff] bg-[#00f3ff]'\n                : 'border-neutral-600 bg-transparent'\n              }\n            `}>\n              {gender === 'male' && (\n                <div className=\"w-2 h-2 rounded-full bg-black\" />\n              )}\n            </div>\n          </button>\n\n          {/* Female Button */}\n          <button\n            onClick={() => handleSelect('female')}\n            className={`\n              w-full h-14 rounded-xl border-2\n              flex items-center justify-between px-5\n              transition-all duration-200 cursor-pointer\n              ${gender === 'female'\n                ? 'border-[#00f3ff] bg-[#00f3ff]/5'\n                : 'border-neutral-800 bg-black hover:border-neutral-700'\n              }\n            `}\n          >\n            <span className={`\n              font-medium transition-colors duration-200\n              ${gender === 'female' ? 'text-white' : 'text-neutral-300'}\n            `}>\n              Female\n            </span>\n            {/* Radio indicator */}\n            <div className={`\n              w-5 h-5 rounded-full border-2 flex items-center justify-center\n              transition-all duration-200\n              ${gender === 'female'\n                ? 'border-[#00f3ff] bg-[#00f3ff]'\n                : 'border-neutral-600 bg-transparent'\n              }\n            `}>\n              {gender === 'female' && (\n                <div className=\"w-2 h-2 rounded-full bg-black\" />\n              )}\n            </div>\n          </button>\n        </div>\n\n        {/* Continue Button */}\n        <button\n          onClick={handleContinue}\n          disabled={!gender}\n          className={`\n            w-full h-12 mt-6 rounded-xl font-medium text-sm\n            transition-all duration-200\n            ${gender\n              ? 'bg-[#00f3ff] text-black hover:shadow-[0_0_20px_rgba(0,243,255,0.3)] cursor-pointer'\n              : 'bg-neutral-800 text-neutral-500 cursor-not-allowed'\n            }\n          `}\n        >\n          Continue\n        </button>\n      </div>\n    </div>\n  );\n}\n","numLines":129,"startLine":1,"totalLines":129}}}
{"parentUuid":"ca0ce618-6851-4bf5-a688-2e8c661dc31e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YLxB8xEKfwExGpeU1AMeLz","type":"tool_result","content":"     1→/**\n     2→ * API Client for LOOKSMAXX Backend\n     3→ *\n     4→ * Handles all authenticated requests to the Railway-hosted API\n     5→ */\n     6→\n     7→import type { UserRank, LeaderboardEntry, LeaderboardData, UserProfile } from '@/types/results';\n     8→import type {\n     9→  Category,\n    10→  SubForum,\n    11→  Post,\n    12→  PostListItem,\n    13→  PostListResponse,\n    14→  PostCreate,\n    15→  PostUpdate,\n    16→  Comment,\n    17→  CommentCreate,\n    18→  VoteType,\n    19→  VoteResponse,\n    20→  ReportCreate,\n    21→  Report,\n    22→  GuideSection,\n    23→  RecommendedForum,\n    24→  SortOrder,\n    25→  CategoryListItem,\n    26→  PostAuthor,\n    27→} from '@/types/forum';\n    28→\n    29→const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';\n    30→\n    31→// API Response types (snake_case from backend)\n    32→interface LeaderboardApiResponse {\n    33→  user_id: string;\n    34→  score: number;\n    35→  global_rank: number;\n    36→  gender_rank: number;\n    37→  percentile: number;\n    38→  total_users: number;\n    39→  gender_total: number;\n    40→  anonymous_name: string;\n    41→  updated_at: string;\n    42→}\n    43→\n    44→interface LeaderboardEntryResponse {\n    45→  user_id: string;\n    46→  rank: number;\n    47→  score: number;\n    48→  anonymous_name: string;\n    49→  gender: 'male' | 'female';\n    50→  face_photo_url: string | null;\n    51→  is_current_user: boolean;\n    52→}\n    53→\n    54→interface LeaderboardListResponse {\n    55→  entries: LeaderboardEntryResponse[];\n    56→  total_count: number;\n    57→  user_rank: LeaderboardApiResponse | null;\n    58→}\n    59→\n    60→interface UserProfileResponse {\n    61→  user_id: string;\n    62→  rank: number;\n    63→  score: number;\n    64→  anonymous_name: string;\n    65→  gender: 'male' | 'female';\n    66→  face_photo_url: string | null;\n    67→  top_strengths: string[];\n    68→  top_improvements: string[];\n    69→}\n    70→\n    71→// Transform functions (snake_case -> camelCase)\n    72→function transformUserRank(data: LeaderboardApiResponse): UserRank {\n    73→  return {\n    74→    userId: data.user_id,\n    75→    score: data.score,\n    76→    globalRank: data.global_rank,\n    77→    genderRank: data.gender_rank,\n    78→    percentile: data.percentile,\n    79→    totalUsers: data.total_users,\n    80→    genderTotal: data.gender_total,\n    81→    anonymousName: data.anonymous_name,\n    82→    updatedAt: data.updated_at,\n    83→  };\n    84→}\n    85→\n    86→function transformLeaderboardEntry(data: LeaderboardEntryResponse): LeaderboardEntry {\n    87→  return {\n    88→    userId: data.user_id,\n    89→    rank: data.rank,\n    90→    score: data.score,\n    91→    anonymousName: data.anonymous_name,\n    92→    gender: data.gender,\n    93→    facePhotoUrl: data.face_photo_url,\n    94→    isCurrentUser: data.is_current_user,\n    95→  };\n    96→}\n    97→\n    98→function transformLeaderboardData(data: LeaderboardListResponse): LeaderboardData {\n    99→  return {\n   100→    entries: data.entries.map(transformLeaderboardEntry),\n   101→    totalCount: data.total_count,\n   102→    userRank: data.user_rank ? transformUserRank(data.user_rank) : null,\n   103→  };\n   104→}\n   105→\n   106→function transformUserProfile(data: UserProfileResponse): UserProfile {\n   107→  return {\n   108→    userId: data.user_id,\n   109→    rank: data.rank,\n   110→    score: data.score,\n   111→    anonymousName: data.anonymous_name,\n   112→    gender: data.gender,\n   113→    facePhotoUrl: data.face_photo_url,\n   114→    topStrengths: data.top_strengths,\n   115→    topImprovements: data.top_improvements,\n   116→  };\n   117→}\n   118→\n   119→// === FORUM API RESPONSE TYPES ===\n   120→\n   121→interface SubForumApiResponse {\n   122→  id: string;\n   123→  name: string;\n   124→  slug: string;\n   125→  description: string | null;\n   126→  icon: string | null;\n   127→  display_order: number;\n   128→  post_count: number;\n   129→}\n   130→\n   131→interface CategoryApiResponse {\n   132→  id: string;\n   133→  name: string;\n   134→  slug: string;\n   135→  description: string | null;\n   136→  icon: string | null;\n   137→  display_order: number;\n   138→  post_count: number;\n   139→  sub_forums: SubForumApiResponse[];\n   140→}\n   141→\n   142→interface CategoryListApiResponse {\n   143→  id: string;\n   144→  name: string;\n   145→  slug: string;\n   146→  description: string | null;\n   147→  icon: string | null;\n   148→  display_order: number;\n   149→  post_count: number;\n   150→}\n   151→\n   152→interface PostAuthorApiResponse {\n   153→  id: string;\n   154→  username: string;\n   155→}\n   156→\n   157→interface PostApiResponse {\n   158→  id: string;\n   159→  title: string;\n   160→  content: string;\n   161→  sub_forum_id: string;\n   162→  sub_forum_slug: string;\n   163→  category_slug: string;\n   164→  author: PostAuthorApiResponse;\n   165→  is_pinned: boolean;\n   166→  is_guide: boolean;\n   167→  vote_count: number;\n   168→  comment_count: number;\n   169→  user_vote: VoteType | null;\n   170→  created_at: string;\n   171→  updated_at: string;\n   172→}\n   173→\n   174→interface PostListItemApiResponse {\n   175→  id: string;\n   176→  title: string;\n   177→  content_preview: string;\n   178→  sub_forum_slug: string;\n   179→  category_slug: string;\n   180→  author: PostAuthorApiResponse;\n   181→  is_pinned: boolean;\n   182→  is_guide: boolean;\n   183→  vote_count: number;\n   184→  comment_count: number;\n   185→  user_vote: VoteType | null;\n   186→  created_at: string;\n   187→}\n   188→\n   189→interface PostListApiResponse {\n   190→  posts: PostListItemApiResponse[];\n   191→  total_count: number;\n   192→  has_more: boolean;\n   193→}\n   194→\n   195→interface CommentApiResponse {\n   196→  id: string;\n   197→  content: string;\n   198→  post_id: string;\n   199→  author: PostAuthorApiResponse;\n   200→  parent_id: string | null;\n   201→  vote_count: number;\n   202→  user_vote: VoteType | null;\n   203→  depth: number;\n   204→  replies: CommentApiResponse[];\n   205→  created_at: string;\n   206→  updated_at: string;\n   207→}\n   208→\n   209→interface VoteApiResponse {\n   210→  success: boolean;\n   211→  new_vote_count: number;\n   212→  user_vote: VoteType | null;\n   213→}\n   214→\n   215→interface ReportApiResponse {\n   216→  id: string;\n   217→  target_type: 'post' | 'comment';\n   218→  target_id: string;\n   219→  reason: string;\n   220→  status: string;\n   221→  created_at: string;\n   222→}\n   223→\n   224→interface GuideSectionApiResponse {\n   225→  category: CategoryListApiResponse;\n   226→  guides: PostListItemApiResponse[];\n   227→}\n   228→\n   229→interface RecommendedForumApiResponse {\n   230→  category: CategoryListApiResponse;\n   231→  matched_flaws: string[];\n   232→  priority: number;\n   233→}\n   234→\n   235→// === FORUM TRANSFORM FUNCTIONS ===\n   236→\n   237→function transformSubForum(data: SubForumApiResponse): SubForum {\n   238→  return {\n   239→    id: data.id,\n   240→    name: data.name,\n   241→    slug: data.slug,\n   242→    description: data.description,\n   243→    icon: data.icon,\n   244→    displayOrder: data.display_order,\n   245→    postCount: data.post_count,\n   246→  };\n   247→}\n   248→\n   249→function transformCategory(data: CategoryApiResponse): Category {\n   250→  return {\n   251→    id: data.id,\n   252→    name: data.name,\n   253→    slug: data.slug,\n   254→    description: data.description,\n   255→    icon: data.icon,\n   256→    displayOrder: data.display_order,\n   257→    postCount: data.post_count,\n   258→    subForums: data.sub_forums.map(transformSubForum),\n   259→  };\n   260→}\n   261→\n   262→function transformCategoryListItem(data: CategoryListApiResponse): CategoryListItem {\n   263→  return {\n   264→    id: data.id,\n   265→    name: data.name,\n   266→    slug: data.slug,\n   267→    description: data.description,\n   268→    icon: data.icon,\n   269→    displayOrder: data.display_order,\n   270→    postCount: data.post_count,\n   271→  };\n   272→}\n   273→\n   274→function transformPostAuthor(data: PostAuthorApiResponse): PostAuthor {\n   275→  return {\n   276→    id: data.id,\n   277→    username: data.username,\n   278→  };\n   279→}\n   280→\n   281→function transformPost(data: PostApiResponse): Post {\n   282→  return {\n   283→    id: data.id,\n   284→    title: data.title,\n   285→    content: data.content,\n   286→    subForumId: data.sub_forum_id,\n   287→    subForumSlug: data.sub_forum_slug,\n   288→    categorySlug: data.category_slug,\n   289→    author: transformPostAuthor(data.author),\n   290→    isPinned: data.is_pinned,\n   291→    isGuide: data.is_guide,\n   292→    voteCount: data.vote_count,\n   293→    commentCount: data.comment_count,\n   294→    userVote: data.user_vote,\n   295→    createdAt: data.created_at,\n   296→    updatedAt: data.updated_at,\n   297→  };\n   298→}\n   299→\n   300→function transformPostListItem(data: PostListItemApiResponse): PostListItem {\n   301→  return {\n   302→    id: data.id,\n   303→    title: data.title,\n   304→    contentPreview: data.content_preview,\n   305→    subForumSlug: data.sub_forum_slug,\n   306→    categorySlug: data.category_slug,\n   307→    author: transformPostAuthor(data.author),\n   308→    isPinned: data.is_pinned,\n   309→    isGuide: data.is_guide,\n   310→    voteCount: data.vote_count,\n   311→    commentCount: data.comment_count,\n   312→    userVote: data.user_vote,\n   313→    createdAt: data.created_at,\n   314→  };\n   315→}\n   316→\n   317→function transformPostListResponse(data: PostListApiResponse): PostListResponse {\n   318→  return {\n   319→    posts: data.posts.map(transformPostListItem),\n   320→    totalCount: data.total_count,\n   321→    hasMore: data.has_more,\n   322→  };\n   323→}\n   324→\n   325→function transformComment(data: CommentApiResponse): Comment {\n   326→  return {\n   327→    id: data.id,\n   328→    content: data.content,\n   329→    postId: data.post_id,\n   330→    author: transformPostAuthor(data.author),\n   331→    parentId: data.parent_id,\n   332→    voteCount: data.vote_count,\n   333→    userVote: data.user_vote,\n   334→    depth: data.depth,\n   335→    replies: data.replies.map(transformComment),\n   336→    createdAt: data.created_at,\n   337→    updatedAt: data.updated_at,\n   338→  };\n   339→}\n   340→\n   341→function transformVoteResponse(data: VoteApiResponse): VoteResponse {\n   342→  return {\n   343→    success: data.success,\n   344→    newVoteCount: data.new_vote_count,\n   345→    userVote: data.user_vote,\n   346→  };\n   347→}\n   348→\n   349→function transformReport(data: ReportApiResponse): Report {\n   350→  return {\n   351→    id: data.id,\n   352→    targetType: data.target_type,\n   353→    targetId: data.target_id,\n   354→    reason: data.reason as Report['reason'],\n   355→    status: data.status,\n   356→    createdAt: data.created_at,\n   357→  };\n   358→}\n   359→\n   360→function transformGuideSection(data: GuideSectionApiResponse): GuideSection {\n   361→  return {\n   362→    category: transformCategoryListItem(data.category),\n   363→    guides: data.guides.map(transformPostListItem),\n   364→  };\n   365→}\n   366→\n   367→function transformRecommendedForum(data: RecommendedForumApiResponse): RecommendedForum {\n   368→  return {\n   369→    category: transformCategoryListItem(data.category),\n   370→    matchedFlaws: data.matched_flaws,\n   371→    priority: data.priority,\n   372→  };\n   373→}\n   374→\n   375→interface ApiOptions {\n   376→  method?: 'GET' | 'POST' | 'PUT' | 'DELETE';\n   377→  body?: unknown;\n   378→  token?: string;\n   379→}\n   380→\n   381→interface Analysis {\n   382→  id: string;\n   383→  front_image_url: string | null;\n   384→  side_image_url: string | null;\n   385→  front_landmarks: Record<string, unknown> | null;\n   386→  side_landmarks: Record<string, unknown> | null;\n   387→  scores: Record<string, unknown> | null;\n   388→  gender: string | null;\n   389→  ethnicity: string | null;\n   390→  created_at: string;\n   391→}\n   392→\n   393→class ApiClient {\n   394→  private token: string | null = null;\n   395→\n   396→  setToken(token: string | null) {\n   397→    this.token = token;\n   398→  }\n   399→\n   400→  getToken(): string | null {\n   401→    if (typeof window !== 'undefined') {\n   402→      return this.token || localStorage.getItem('auth_token');\n   403→    }\n   404→    return this.token;\n   405→  }\n   406→\n   407→  private async request<T>(endpoint: string, options: ApiOptions = {}): Promise<T> {\n   408→    const { method = 'GET', body, token } = options;\n   409→    const authToken = token || this.getToken();\n   410→\n   411→    const headers: Record<string, string> = {\n   412→      'Content-Type': 'application/json',\n   413→    };\n   414→\n   415→    if (authToken) {\n   416→      headers['Authorization'] = `Bearer ${authToken}`;\n   417→    }\n   418→\n   419→    const response = await fetch(`${API_URL}${endpoint}`, {\n   420→      method,\n   421→      headers,\n   422→      body: body ? JSON.stringify(body) : undefined,\n   423→    });\n   424→\n   425→    if (!response.ok) {\n   426→      const error = await response.json().catch(() => ({ detail: 'Request failed' }));\n   427→      throw new Error(error.detail || `HTTP ${response.status}`);\n   428→    }\n   429→\n   430→    // Handle empty responses (204 No Content)\n   431→    if (response.status === 204) {\n   432→      return undefined as T;\n   433→    }\n   434→\n   435→    return response.json();\n   436→  }\n   437→\n   438→  // Health check\n   439→  async health(): Promise<{ status: string; detection_ready: boolean }> {\n   440→    return this.request('/health');\n   441→  }\n   442→\n   443→  // Analyses CRUD\n   444→  async listAnalyses(limit = 50, offset = 0): Promise<Analysis[]> {\n   445→    return this.request(`/analyses?limit=${limit}&offset=${offset}`);\n   446→  }\n   447→\n   448→  async createAnalysis(data: {\n   449→    front_image_url?: string;\n   450→    side_image_url?: string;\n   451→    front_landmarks?: Record<string, unknown>;\n   452→    side_landmarks?: Record<string, unknown>;\n   453→    scores?: Record<string, unknown>;\n   454→    gender?: string;\n   455→    ethnicity?: string;\n   456→  }): Promise<Analysis> {\n   457→    return this.request('/analyses', { method: 'POST', body: data });\n   458→  }\n   459→\n   460→  async getAnalysis(id: string): Promise<Analysis> {\n   461→    return this.request(`/analyses/${id}`);\n   462→  }\n   463→\n   464→  async deleteAnalysis(id: string): Promise<void> {\n   465→    return this.request(`/analyses/${id}`, { method: 'DELETE' });\n   466→  }\n   467→\n   468→  // Payments\n   469→  async createCheckout(plan: 'basic' | 'pro'): Promise<{ checkout_url: string; session_id: string }> {\n   470→    return this.request(`/payments/checkout?plan=${plan}`, { method: 'POST' });\n   471→  }\n   472→\n   473→  async getPaymentHistory(): Promise<Array<{\n   474→    id: string;\n   475→    amount: number;\n   476→    currency: string;\n   477→    status: string;\n   478→    created_at: string;\n   479→  }>> {\n   480→    return this.request('/payments/history');\n   481→  }\n   482→\n   483→  // Leaderboard\n   484→  async submitScore(data: {\n   485→    score: number;\n   486→    analysis_id?: string;\n   487→    gender: 'male' | 'female';\n   488→    ethnicity?: string;\n   489→    face_photo_url?: string;\n   490→    top_strengths?: string[];\n   491→    top_improvements?: string[];\n   492→  }): Promise<UserRank> {\n   493→    const response = await this.request<LeaderboardApiResponse>('/leaderboard/score', {\n   494→      method: 'POST',\n   495→      body: data,\n   496→    });\n   497→    return transformUserRank(response);\n   498→  }\n   499→\n   500→  async getMyRank(): Promise<UserRank> {\n   501→    const response = await this.request<LeaderboardApiResponse>('/leaderboard/rank');\n   502→    return transformUserRank(response);\n   503→  }\n   504→\n   505→  async getLeaderboard(options?: {\n   506→    gender?: 'male' | 'female';\n   507→    limit?: number;\n   508→    offset?: number;\n   509→  }): Promise<LeaderboardData> {\n   510→    const params = new URLSearchParams();\n   511→    if (options?.gender) params.set('gender', options.gender);\n   512→    if (options?.limit) params.set('limit', String(options.limit));\n   513→    if (options?.offset) params.set('offset', String(options.offset));\n   514→    const query = params.toString() ? `?${params}` : '';\n   515→    const response = await this.request<LeaderboardListResponse>(`/leaderboard${query}`);\n   516→    return transformLeaderboardData(response);\n   517→  }\n   518→\n   519→  async getLeaderboardAroundMe(rangeSize?: number): Promise<LeaderboardData> {\n   520→    const query = rangeSize ? `?range_size=${rangeSize}` : '';\n   521→    const response = await this.request<LeaderboardListResponse>(`/leaderboard/around-me${query}`);\n   522→    return transformLeaderboardData(response);\n   523→  }\n   524→\n   525→  async getUserProfile(userId: string): Promise<UserProfile> {\n   526→    const response = await this.request<UserProfileResponse>(`/leaderboard/user/${userId}`);\n   527→    return transformUserProfile(response);\n   528→  }\n   529→\n   530→  // Auth\n   531→  async checkUsername(username: string): Promise<{ available: boolean; reason: string | null }> {\n   532→    return this.request(`/auth/check-username/${encodeURIComponent(username)}`);\n   533→  }\n   534→\n   535→  async register(data: {\n   536→    email: string;\n   537→    password: string;\n   538→    username: string;\n   539→    termsAccepted: boolean;\n   540→    referralCode?: string;\n   541→  }): Promise<{ access_token: string; token_type: string; user: { id: string; email: string; username: string; plan: string } }> {\n   542→    return this.request('/auth/register', {\n   543→      method: 'POST',\n   544→      body: {\n   545→        email: data.email,\n   546→        password: data.password,\n   547→        username: data.username,\n   548→        terms_accepted: data.termsAccepted,\n   549→        referral_code: data.referralCode,\n   550→      },\n   551→    });\n   552→  }\n   553→\n   554→  async login(data: { email: string; password: string }): Promise<{ access_token: string; token_type: string; user: { id: string; email: string; username: string; plan: string } }> {\n   555→    return this.request('/auth/login', {\n   556→      method: 'POST',\n   557→      body: data,\n   558→    });\n   559→  }\n   560→\n   561→  async validateReferralCode(code: string): Promise<{ valid: boolean; message: string | null }> {\n   562→    return this.request(`/auth/validate-referral/${encodeURIComponent(code)}`);\n   563→  }\n   564→\n   565→  async requestPasswordReset(email: string): Promise<{ message: string }> {\n   566→    return this.request('/auth/forgot-password', {\n   567→      method: 'POST',\n   568→      body: { email },\n   569→    });\n   570→  }\n   571→\n   572→  async resetPassword(token: string, newPassword: string): Promise<{ message: string }> {\n   573→    return this.request('/auth/reset-password', {\n   574→      method: 'POST',\n   575→      body: { token, new_password: newPassword },\n   576→    });\n   577→  }\n   578→\n   579→  // === FORUM ===\n   580→\n   581→  // Categories\n   582→  async getForumCategories(): Promise<Category[]> {\n   583→    const response = await this.request<CategoryApiResponse[]>('/forum/categories');\n   584→    return response.map(transformCategory);\n   585→  }\n   586→\n   587→  async getForumCategory(slug: string): Promise<Category> {\n   588→    const response = await this.request<CategoryApiResponse>(`/forum/categories/${slug}`);\n   589→    return transformCategory(response);\n   590→  }\n   591→\n   592→  // Guides\n   593→  async getForumGuides(): Promise<GuideSection[]> {\n   594→    const response = await this.request<GuideSectionApiResponse[]>('/forum/guides');\n   595→    return response.map(transformGuideSection);\n   596→  }\n   597→\n   598→  // Recommended forums based on flaws\n   599→  async getRecommendedForums(flaws: string[]): Promise<RecommendedForum[]> {\n   600→    const params = new URLSearchParams();\n   601→    params.set('flaws', flaws.join(','));\n   602→    const response = await this.request<RecommendedForumApiResponse[]>(`/forum/recommended?${params}`);\n   603→    return response.map(transformRecommendedForum);\n   604→  }\n   605→\n   606→  // Posts\n   607→  async getForumPosts(\n   608→    categorySlug: string,\n   609→    options?: {\n   610→      subForumSlug?: string;\n   611→      sort?: SortOrder;\n   612→      limit?: number;\n   613→      offset?: number;\n   614→    }\n   615→  ): Promise<PostListResponse> {\n   616→    const params = new URLSearchParams();\n   617→    if (options?.sort) params.set('sort', options.sort);\n   618→    if (options?.limit) params.set('limit', String(options.limit));\n   619→    if (options?.offset) params.set('offset', String(options.offset));\n   620→    const query = params.toString() ? `?${params}` : '';\n   621→\n   622→    const endpoint = options?.subForumSlug\n   623→      ? `/forum/categories/${categorySlug}/${options.subForumSlug}/posts${query}`\n   624→      : `/forum/categories/${categorySlug}/posts${query}`;\n   625→\n   626→    const response = await this.request<PostListApiResponse>(endpoint);\n   627→    return transformPostListResponse(response);\n   628→  }\n   629→\n   630→  async getForumPost(postId: string): Promise<Post> {\n   631→    const response = await this.request<PostApiResponse>(`/forum/posts/${postId}`);\n   632→    return transformPost(response);\n   633→  }\n   634→\n   635→  async createForumPost(data: PostCreate): Promise<Post> {\n   636→    const response = await this.request<PostApiResponse>('/forum/posts', {\n   637→      method: 'POST',\n   638→      body: {\n   639→        title: data.title,\n   640→        content: data.content,\n   641→        sub_forum_id: data.subForumId,\n   642→      },\n   643→    });\n   644→    return transformPost(response);\n   645→  }\n   646→\n   647→  async updateForumPost(postId: string, data: PostUpdate): Promise<Post> {\n   648→    const response = await this.request<PostApiResponse>(`/forum/posts/${postId}`, {\n   649→      method: 'PUT',\n   650→      body: data,\n   651→    });\n   652→    return transformPost(response);\n   653→  }\n   654→\n   655→  async deleteForumPost(postId: string): Promise<void> {\n   656→    await this.request(`/forum/posts/${postId}`, { method: 'DELETE' });\n   657→  }\n   658→\n   659→  // Comments\n   660→  async getForumComments(postId: string): Promise<Comment[]> {\n   661→    const response = await this.request<CommentApiResponse[]>(`/forum/posts/${postId}/comments`);\n   662→    return response.map(transformComment);\n   663→  }\n   664→\n   665→  async createForumComment(postId: string, data: CommentCreate): Promise<Comment> {\n   666→    const response = await this.request<CommentApiResponse>(`/forum/posts/${postId}/comments`, {\n   667→      method: 'POST',\n   668→      body: {\n   669→        content: data.content,\n   670→        parent_id: data.parentId,\n   671→      },\n   672→    });\n   673→    return transformComment(response);\n   674→  }\n   675→\n   676→  async updateForumComment(commentId: string, content: string): Promise<Comment> {\n   677→    const response = await this.request<CommentApiResponse>(`/forum/comments/${commentId}`, {\n   678→      method: 'PUT',\n   679→      body: { content },\n   680→    });\n   681→    return transformComment(response);\n   682→  }\n   683→\n   684→  async deleteForumComment(commentId: string): Promise<void> {\n   685→    await this.request(`/forum/comments/${commentId}`, { method: 'DELETE' });\n   686→  }\n   687→\n   688→  // Voting\n   689→  async voteForumPost(postId: string, voteType: VoteType): Promise<VoteResponse> {\n   690→    const response = await this.request<VoteApiResponse>(`/forum/posts/${postId}/vote`, {\n   691→      method: 'POST',\n   692→      body: { vote_type: voteType },\n   693→    });\n   694→    return transformVoteResponse(response);\n   695→  }\n   696→\n   697→  async voteForumComment(commentId: string, voteType: VoteType): Promise<VoteResponse> {\n   698→    const response = await this.request<VoteApiResponse>(`/forum/comments/${commentId}/vote`, {\n   699→      method: 'POST',\n   700→      body: { vote_type: voteType },\n   701→    });\n   702→    return transformVoteResponse(response);\n   703→  }\n   704→\n   705→  // Reports\n   706→  async createForumReport(data: ReportCreate): Promise<Report> {\n   707→    const response = await this.request<ReportApiResponse>('/forum/reports', {\n   708→      method: 'POST',\n   709→      body: {\n   710→        target_type: data.targetType,\n   711→        target_id: data.targetId,\n   712→        reason: data.reason,\n   713→        details: data.details,\n   714→      },\n   715→    });\n   716→    return transformReport(response);\n   717→  }\n   718→}\n   719→\n   720→// Export singleton instance\n   721→export const api = new ApiClient();\n   722→\n   723→// Export types\n   724→export type { Analysis };\n   725→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1c9e78e0-c2ed-4114-9820-f6ed0bf54d7c","timestamp":"2025-12-25T23:23:10.460Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/api.ts","content":"/**\n * API Client for LOOKSMAXX Backend\n *\n * Handles all authenticated requests to the Railway-hosted API\n */\n\nimport type { UserRank, LeaderboardEntry, LeaderboardData, UserProfile } from '@/types/results';\nimport type {\n  Category,\n  SubForum,\n  Post,\n  PostListItem,\n  PostListResponse,\n  PostCreate,\n  PostUpdate,\n  Comment,\n  CommentCreate,\n  VoteType,\n  VoteResponse,\n  ReportCreate,\n  Report,\n  GuideSection,\n  RecommendedForum,\n  SortOrder,\n  CategoryListItem,\n  PostAuthor,\n} from '@/types/forum';\n\nconst API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';\n\n// API Response types (snake_case from backend)\ninterface LeaderboardApiResponse {\n  user_id: string;\n  score: number;\n  global_rank: number;\n  gender_rank: number;\n  percentile: number;\n  total_users: number;\n  gender_total: number;\n  anonymous_name: string;\n  updated_at: string;\n}\n\ninterface LeaderboardEntryResponse {\n  user_id: string;\n  rank: number;\n  score: number;\n  anonymous_name: string;\n  gender: 'male' | 'female';\n  face_photo_url: string | null;\n  is_current_user: boolean;\n}\n\ninterface LeaderboardListResponse {\n  entries: LeaderboardEntryResponse[];\n  total_count: number;\n  user_rank: LeaderboardApiResponse | null;\n}\n\ninterface UserProfileResponse {\n  user_id: string;\n  rank: number;\n  score: number;\n  anonymous_name: string;\n  gender: 'male' | 'female';\n  face_photo_url: string | null;\n  top_strengths: string[];\n  top_improvements: string[];\n}\n\n// Transform functions (snake_case -> camelCase)\nfunction transformUserRank(data: LeaderboardApiResponse): UserRank {\n  return {\n    userId: data.user_id,\n    score: data.score,\n    globalRank: data.global_rank,\n    genderRank: data.gender_rank,\n    percentile: data.percentile,\n    totalUsers: data.total_users,\n    genderTotal: data.gender_total,\n    anonymousName: data.anonymous_name,\n    updatedAt: data.updated_at,\n  };\n}\n\nfunction transformLeaderboardEntry(data: LeaderboardEntryResponse): LeaderboardEntry {\n  return {\n    userId: data.user_id,\n    rank: data.rank,\n    score: data.score,\n    anonymousName: data.anonymous_name,\n    gender: data.gender,\n    facePhotoUrl: data.face_photo_url,\n    isCurrentUser: data.is_current_user,\n  };\n}\n\nfunction transformLeaderboardData(data: LeaderboardListResponse): LeaderboardData {\n  return {\n    entries: data.entries.map(transformLeaderboardEntry),\n    totalCount: data.total_count,\n    userRank: data.user_rank ? transformUserRank(data.user_rank) : null,\n  };\n}\n\nfunction transformUserProfile(data: UserProfileResponse): UserProfile {\n  return {\n    userId: data.user_id,\n    rank: data.rank,\n    score: data.score,\n    anonymousName: data.anonymous_name,\n    gender: data.gender,\n    facePhotoUrl: data.face_photo_url,\n    topStrengths: data.top_strengths,\n    topImprovements: data.top_improvements,\n  };\n}\n\n// === FORUM API RESPONSE TYPES ===\n\ninterface SubForumApiResponse {\n  id: string;\n  name: string;\n  slug: string;\n  description: string | null;\n  icon: string | null;\n  display_order: number;\n  post_count: number;\n}\n\ninterface CategoryApiResponse {\n  id: string;\n  name: string;\n  slug: string;\n  description: string | null;\n  icon: string | null;\n  display_order: number;\n  post_count: number;\n  sub_forums: SubForumApiResponse[];\n}\n\ninterface CategoryListApiResponse {\n  id: string;\n  name: string;\n  slug: string;\n  description: string | null;\n  icon: string | null;\n  display_order: number;\n  post_count: number;\n}\n\ninterface PostAuthorApiResponse {\n  id: string;\n  username: string;\n}\n\ninterface PostApiResponse {\n  id: string;\n  title: string;\n  content: string;\n  sub_forum_id: string;\n  sub_forum_slug: string;\n  category_slug: string;\n  author: PostAuthorApiResponse;\n  is_pinned: boolean;\n  is_guide: boolean;\n  vote_count: number;\n  comment_count: number;\n  user_vote: VoteType | null;\n  created_at: string;\n  updated_at: string;\n}\n\ninterface PostListItemApiResponse {\n  id: string;\n  title: string;\n  content_preview: string;\n  sub_forum_slug: string;\n  category_slug: string;\n  author: PostAuthorApiResponse;\n  is_pinned: boolean;\n  is_guide: boolean;\n  vote_count: number;\n  comment_count: number;\n  user_vote: VoteType | null;\n  created_at: string;\n}\n\ninterface PostListApiResponse {\n  posts: PostListItemApiResponse[];\n  total_count: number;\n  has_more: boolean;\n}\n\ninterface CommentApiResponse {\n  id: string;\n  content: string;\n  post_id: string;\n  author: PostAuthorApiResponse;\n  parent_id: string | null;\n  vote_count: number;\n  user_vote: VoteType | null;\n  depth: number;\n  replies: CommentApiResponse[];\n  created_at: string;\n  updated_at: string;\n}\n\ninterface VoteApiResponse {\n  success: boolean;\n  new_vote_count: number;\n  user_vote: VoteType | null;\n}\n\ninterface ReportApiResponse {\n  id: string;\n  target_type: 'post' | 'comment';\n  target_id: string;\n  reason: string;\n  status: string;\n  created_at: string;\n}\n\ninterface GuideSectionApiResponse {\n  category: CategoryListApiResponse;\n  guides: PostListItemApiResponse[];\n}\n\ninterface RecommendedForumApiResponse {\n  category: CategoryListApiResponse;\n  matched_flaws: string[];\n  priority: number;\n}\n\n// === FORUM TRANSFORM FUNCTIONS ===\n\nfunction transformSubForum(data: SubForumApiResponse): SubForum {\n  return {\n    id: data.id,\n    name: data.name,\n    slug: data.slug,\n    description: data.description,\n    icon: data.icon,\n    displayOrder: data.display_order,\n    postCount: data.post_count,\n  };\n}\n\nfunction transformCategory(data: CategoryApiResponse): Category {\n  return {\n    id: data.id,\n    name: data.name,\n    slug: data.slug,\n    description: data.description,\n    icon: data.icon,\n    displayOrder: data.display_order,\n    postCount: data.post_count,\n    subForums: data.sub_forums.map(transformSubForum),\n  };\n}\n\nfunction transformCategoryListItem(data: CategoryListApiResponse): CategoryListItem {\n  return {\n    id: data.id,\n    name: data.name,\n    slug: data.slug,\n    description: data.description,\n    icon: data.icon,\n    displayOrder: data.display_order,\n    postCount: data.post_count,\n  };\n}\n\nfunction transformPostAuthor(data: PostAuthorApiResponse): PostAuthor {\n  return {\n    id: data.id,\n    username: data.username,\n  };\n}\n\nfunction transformPost(data: PostApiResponse): Post {\n  return {\n    id: data.id,\n    title: data.title,\n    content: data.content,\n    subForumId: data.sub_forum_id,\n    subForumSlug: data.sub_forum_slug,\n    categorySlug: data.category_slug,\n    author: transformPostAuthor(data.author),\n    isPinned: data.is_pinned,\n    isGuide: data.is_guide,\n    voteCount: data.vote_count,\n    commentCount: data.comment_count,\n    userVote: data.user_vote,\n    createdAt: data.created_at,\n    updatedAt: data.updated_at,\n  };\n}\n\nfunction transformPostListItem(data: PostListItemApiResponse): PostListItem {\n  return {\n    id: data.id,\n    title: data.title,\n    contentPreview: data.content_preview,\n    subForumSlug: data.sub_forum_slug,\n    categorySlug: data.category_slug,\n    author: transformPostAuthor(data.author),\n    isPinned: data.is_pinned,\n    isGuide: data.is_guide,\n    voteCount: data.vote_count,\n    commentCount: data.comment_count,\n    userVote: data.user_vote,\n    createdAt: data.created_at,\n  };\n}\n\nfunction transformPostListResponse(data: PostListApiResponse): PostListResponse {\n  return {\n    posts: data.posts.map(transformPostListItem),\n    totalCount: data.total_count,\n    hasMore: data.has_more,\n  };\n}\n\nfunction transformComment(data: CommentApiResponse): Comment {\n  return {\n    id: data.id,\n    content: data.content,\n    postId: data.post_id,\n    author: transformPostAuthor(data.author),\n    parentId: data.parent_id,\n    voteCount: data.vote_count,\n    userVote: data.user_vote,\n    depth: data.depth,\n    replies: data.replies.map(transformComment),\n    createdAt: data.created_at,\n    updatedAt: data.updated_at,\n  };\n}\n\nfunction transformVoteResponse(data: VoteApiResponse): VoteResponse {\n  return {\n    success: data.success,\n    newVoteCount: data.new_vote_count,\n    userVote: data.user_vote,\n  };\n}\n\nfunction transformReport(data: ReportApiResponse): Report {\n  return {\n    id: data.id,\n    targetType: data.target_type,\n    targetId: data.target_id,\n    reason: data.reason as Report['reason'],\n    status: data.status,\n    createdAt: data.created_at,\n  };\n}\n\nfunction transformGuideSection(data: GuideSectionApiResponse): GuideSection {\n  return {\n    category: transformCategoryListItem(data.category),\n    guides: data.guides.map(transformPostListItem),\n  };\n}\n\nfunction transformRecommendedForum(data: RecommendedForumApiResponse): RecommendedForum {\n  return {\n    category: transformCategoryListItem(data.category),\n    matchedFlaws: data.matched_flaws,\n    priority: data.priority,\n  };\n}\n\ninterface ApiOptions {\n  method?: 'GET' | 'POST' | 'PUT' | 'DELETE';\n  body?: unknown;\n  token?: string;\n}\n\ninterface Analysis {\n  id: string;\n  front_image_url: string | null;\n  side_image_url: string | null;\n  front_landmarks: Record<string, unknown> | null;\n  side_landmarks: Record<string, unknown> | null;\n  scores: Record<string, unknown> | null;\n  gender: string | null;\n  ethnicity: string | null;\n  created_at: string;\n}\n\nclass ApiClient {\n  private token: string | null = null;\n\n  setToken(token: string | null) {\n    this.token = token;\n  }\n\n  getToken(): string | null {\n    if (typeof window !== 'undefined') {\n      return this.token || localStorage.getItem('auth_token');\n    }\n    return this.token;\n  }\n\n  private async request<T>(endpoint: string, options: ApiOptions = {}): Promise<T> {\n    const { method = 'GET', body, token } = options;\n    const authToken = token || this.getToken();\n\n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n    };\n\n    if (authToken) {\n      headers['Authorization'] = `Bearer ${authToken}`;\n    }\n\n    const response = await fetch(`${API_URL}${endpoint}`, {\n      method,\n      headers,\n      body: body ? JSON.stringify(body) : undefined,\n    });\n\n    if (!response.ok) {\n      const error = await response.json().catch(() => ({ detail: 'Request failed' }));\n      throw new Error(error.detail || `HTTP ${response.status}`);\n    }\n\n    // Handle empty responses (204 No Content)\n    if (response.status === 204) {\n      return undefined as T;\n    }\n\n    return response.json();\n  }\n\n  // Health check\n  async health(): Promise<{ status: string; detection_ready: boolean }> {\n    return this.request('/health');\n  }\n\n  // Analyses CRUD\n  async listAnalyses(limit = 50, offset = 0): Promise<Analysis[]> {\n    return this.request(`/analyses?limit=${limit}&offset=${offset}`);\n  }\n\n  async createAnalysis(data: {\n    front_image_url?: string;\n    side_image_url?: string;\n    front_landmarks?: Record<string, unknown>;\n    side_landmarks?: Record<string, unknown>;\n    scores?: Record<string, unknown>;\n    gender?: string;\n    ethnicity?: string;\n  }): Promise<Analysis> {\n    return this.request('/analyses', { method: 'POST', body: data });\n  }\n\n  async getAnalysis(id: string): Promise<Analysis> {\n    return this.request(`/analyses/${id}`);\n  }\n\n  async deleteAnalysis(id: string): Promise<void> {\n    return this.request(`/analyses/${id}`, { method: 'DELETE' });\n  }\n\n  // Payments\n  async createCheckout(plan: 'basic' | 'pro'): Promise<{ checkout_url: string; session_id: string }> {\n    return this.request(`/payments/checkout?plan=${plan}`, { method: 'POST' });\n  }\n\n  async getPaymentHistory(): Promise<Array<{\n    id: string;\n    amount: number;\n    currency: string;\n    status: string;\n    created_at: string;\n  }>> {\n    return this.request('/payments/history');\n  }\n\n  // Leaderboard\n  async submitScore(data: {\n    score: number;\n    analysis_id?: string;\n    gender: 'male' | 'female';\n    ethnicity?: string;\n    face_photo_url?: string;\n    top_strengths?: string[];\n    top_improvements?: string[];\n  }): Promise<UserRank> {\n    const response = await this.request<LeaderboardApiResponse>('/leaderboard/score', {\n      method: 'POST',\n      body: data,\n    });\n    return transformUserRank(response);\n  }\n\n  async getMyRank(): Promise<UserRank> {\n    const response = await this.request<LeaderboardApiResponse>('/leaderboard/rank');\n    return transformUserRank(response);\n  }\n\n  async getLeaderboard(options?: {\n    gender?: 'male' | 'female';\n    limit?: number;\n    offset?: number;\n  }): Promise<LeaderboardData> {\n    const params = new URLSearchParams();\n    if (options?.gender) params.set('gender', options.gender);\n    if (options?.limit) params.set('limit', String(options.limit));\n    if (options?.offset) params.set('offset', String(options.offset));\n    const query = params.toString() ? `?${params}` : '';\n    const response = await this.request<LeaderboardListResponse>(`/leaderboard${query}`);\n    return transformLeaderboardData(response);\n  }\n\n  async getLeaderboardAroundMe(rangeSize?: number): Promise<LeaderboardData> {\n    const query = rangeSize ? `?range_size=${rangeSize}` : '';\n    const response = await this.request<LeaderboardListResponse>(`/leaderboard/around-me${query}`);\n    return transformLeaderboardData(response);\n  }\n\n  async getUserProfile(userId: string): Promise<UserProfile> {\n    const response = await this.request<UserProfileResponse>(`/leaderboard/user/${userId}`);\n    return transformUserProfile(response);\n  }\n\n  // Auth\n  async checkUsername(username: string): Promise<{ available: boolean; reason: string | null }> {\n    return this.request(`/auth/check-username/${encodeURIComponent(username)}`);\n  }\n\n  async register(data: {\n    email: string;\n    password: string;\n    username: string;\n    termsAccepted: boolean;\n    referralCode?: string;\n  }): Promise<{ access_token: string; token_type: string; user: { id: string; email: string; username: string; plan: string } }> {\n    return this.request('/auth/register', {\n      method: 'POST',\n      body: {\n        email: data.email,\n        password: data.password,\n        username: data.username,\n        terms_accepted: data.termsAccepted,\n        referral_code: data.referralCode,\n      },\n    });\n  }\n\n  async login(data: { email: string; password: string }): Promise<{ access_token: string; token_type: string; user: { id: string; email: string; username: string; plan: string } }> {\n    return this.request('/auth/login', {\n      method: 'POST',\n      body: data,\n    });\n  }\n\n  async validateReferralCode(code: string): Promise<{ valid: boolean; message: string | null }> {\n    return this.request(`/auth/validate-referral/${encodeURIComponent(code)}`);\n  }\n\n  async requestPasswordReset(email: string): Promise<{ message: string }> {\n    return this.request('/auth/forgot-password', {\n      method: 'POST',\n      body: { email },\n    });\n  }\n\n  async resetPassword(token: string, newPassword: string): Promise<{ message: string }> {\n    return this.request('/auth/reset-password', {\n      method: 'POST',\n      body: { token, new_password: newPassword },\n    });\n  }\n\n  // === FORUM ===\n\n  // Categories\n  async getForumCategories(): Promise<Category[]> {\n    const response = await this.request<CategoryApiResponse[]>('/forum/categories');\n    return response.map(transformCategory);\n  }\n\n  async getForumCategory(slug: string): Promise<Category> {\n    const response = await this.request<CategoryApiResponse>(`/forum/categories/${slug}`);\n    return transformCategory(response);\n  }\n\n  // Guides\n  async getForumGuides(): Promise<GuideSection[]> {\n    const response = await this.request<GuideSectionApiResponse[]>('/forum/guides');\n    return response.map(transformGuideSection);\n  }\n\n  // Recommended forums based on flaws\n  async getRecommendedForums(flaws: string[]): Promise<RecommendedForum[]> {\n    const params = new URLSearchParams();\n    params.set('flaws', flaws.join(','));\n    const response = await this.request<RecommendedForumApiResponse[]>(`/forum/recommended?${params}`);\n    return response.map(transformRecommendedForum);\n  }\n\n  // Posts\n  async getForumPosts(\n    categorySlug: string,\n    options?: {\n      subForumSlug?: string;\n      sort?: SortOrder;\n      limit?: number;\n      offset?: number;\n    }\n  ): Promise<PostListResponse> {\n    const params = new URLSearchParams();\n    if (options?.sort) params.set('sort', options.sort);\n    if (options?.limit) params.set('limit', String(options.limit));\n    if (options?.offset) params.set('offset', String(options.offset));\n    const query = params.toString() ? `?${params}` : '';\n\n    const endpoint = options?.subForumSlug\n      ? `/forum/categories/${categorySlug}/${options.subForumSlug}/posts${query}`\n      : `/forum/categories/${categorySlug}/posts${query}`;\n\n    const response = await this.request<PostListApiResponse>(endpoint);\n    return transformPostListResponse(response);\n  }\n\n  async getForumPost(postId: string): Promise<Post> {\n    const response = await this.request<PostApiResponse>(`/forum/posts/${postId}`);\n    return transformPost(response);\n  }\n\n  async createForumPost(data: PostCreate): Promise<Post> {\n    const response = await this.request<PostApiResponse>('/forum/posts', {\n      method: 'POST',\n      body: {\n        title: data.title,\n        content: data.content,\n        sub_forum_id: data.subForumId,\n      },\n    });\n    return transformPost(response);\n  }\n\n  async updateForumPost(postId: string, data: PostUpdate): Promise<Post> {\n    const response = await this.request<PostApiResponse>(`/forum/posts/${postId}`, {\n      method: 'PUT',\n      body: data,\n    });\n    return transformPost(response);\n  }\n\n  async deleteForumPost(postId: string): Promise<void> {\n    await this.request(`/forum/posts/${postId}`, { method: 'DELETE' });\n  }\n\n  // Comments\n  async getForumComments(postId: string): Promise<Comment[]> {\n    const response = await this.request<CommentApiResponse[]>(`/forum/posts/${postId}/comments`);\n    return response.map(transformComment);\n  }\n\n  async createForumComment(postId: string, data: CommentCreate): Promise<Comment> {\n    const response = await this.request<CommentApiResponse>(`/forum/posts/${postId}/comments`, {\n      method: 'POST',\n      body: {\n        content: data.content,\n        parent_id: data.parentId,\n      },\n    });\n    return transformComment(response);\n  }\n\n  async updateForumComment(commentId: string, content: string): Promise<Comment> {\n    const response = await this.request<CommentApiResponse>(`/forum/comments/${commentId}`, {\n      method: 'PUT',\n      body: { content },\n    });\n    return transformComment(response);\n  }\n\n  async deleteForumComment(commentId: string): Promise<void> {\n    await this.request(`/forum/comments/${commentId}`, { method: 'DELETE' });\n  }\n\n  // Voting\n  async voteForumPost(postId: string, voteType: VoteType): Promise<VoteResponse> {\n    const response = await this.request<VoteApiResponse>(`/forum/posts/${postId}/vote`, {\n      method: 'POST',\n      body: { vote_type: voteType },\n    });\n    return transformVoteResponse(response);\n  }\n\n  async voteForumComment(commentId: string, voteType: VoteType): Promise<VoteResponse> {\n    const response = await this.request<VoteApiResponse>(`/forum/comments/${commentId}/vote`, {\n      method: 'POST',\n      body: { vote_type: voteType },\n    });\n    return transformVoteResponse(response);\n  }\n\n  // Reports\n  async createForumReport(data: ReportCreate): Promise<Report> {\n    const response = await this.request<ReportApiResponse>('/forum/reports', {\n      method: 'POST',\n      body: {\n        target_type: data.targetType,\n        target_id: data.targetId,\n        reason: data.reason,\n        details: data.details,\n      },\n    });\n    return transformReport(response);\n  }\n}\n\n// Export singleton instance\nexport const api = new ApiClient();\n\n// Export types\nexport type { Analysis };\n","numLines":725,"startLine":1,"totalLines":725}}}
{"parentUuid":"1c9e78e0-c2ed-4114-9820-f6ed0bf54d7c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YX3iQq23yyh2wZpZyrP9XN","type":"tool_result","content":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/redux/src/types/actions.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/redux/src/types/middleware.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/redux/src/types/reducers.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/redux/src/types/store.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/immer/src/types/globals.d.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/immer/src/types/types-external.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/immer/src/types/types-internal.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/@reduxjs/toolkit/node_modules/immer/src/types/globals.d.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/@reduxjs/toolkit/node_modules/immer/src/types/types-external.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/@reduxjs/toolkit/node_modules/immer/src/types/types-internal.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/forum.ts\n/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts"}]},"uuid":"71926da3-a443-4da8-9130-89a6af93b678","timestamp":"2025-12-25T23:23:10.920Z","toolUseResult":{"filenames":["/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/redux/src/types/actions.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/redux/src/types/middleware.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/redux/src/types/reducers.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/redux/src/types/store.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/immer/src/types/globals.d.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/immer/src/types/types-external.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/immer/src/types/types-internal.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/@reduxjs/toolkit/node_modules/immer/src/types/globals.d.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/@reduxjs/toolkit/node_modules/immer/src/types/types-external.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/node_modules/@reduxjs/toolkit/node_modules/immer/src/types/types-internal.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/forum.ts","/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts"],"durationMs":467,"numFiles":12,"truncated":false}}
{"parentUuid":"71926da3-a443-4da8-9130-89a6af93b678","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VP5mgbKmBMfznSFwUSQDE2","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me examine the existing recommendation engine and tabs to understand how to integrate the PSL and Archetype systems:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8539,"cache_creation_input_tokens":2556,"cache_read_input_tokens":89137,"cache_creation":{"ephemeral_5m_input_tokens":2556,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWUGPqNh4R7rQdUafW9Ax","type":"assistant","uuid":"516bee3b-cc31-48bc-9e45-774d118709cf","timestamp":"2025-12-25T23:23:14.616Z"}
{"parentUuid":"516bee3b-cc31-48bc-9e45-774d118709cf","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VP5mgbKmBMfznSFwUSQDE2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0129hWYtbcvMVk7iwiVJyTQk","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/severity.ts","limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8539,"cache_creation_input_tokens":2556,"cache_read_input_tokens":89137,"cache_creation":{"ephemeral_5m_input_tokens":2556,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWUGPqNh4R7rQdUafW9Ax","type":"assistant","uuid":"2f9d3724-46d9-4a0a-9018-76985f745d51","timestamp":"2025-12-25T23:23:16.112Z"}
{"parentUuid":"2f9d3724-46d9-4a0a-9018-76985f745d51","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VP5mgbKmBMfznSFwUSQDE2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N3TNMybhMxRKLPvn5cJa5U","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx","limit":150}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8539,"cache_creation_input_tokens":2556,"cache_read_input_tokens":89137,"cache_creation":{"ephemeral_5m_input_tokens":2556,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWUGPqNh4R7rQdUafW9Ax","type":"assistant","uuid":"abdd3c9a-65fa-4489-b1a6-85e61f283484","timestamp":"2025-12-25T23:23:17.284Z"}
{"parentUuid":"abdd3c9a-65fa-4489-b1a6-85e61f283484","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VP5mgbKmBMfznSFwUSQDE2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014PMrCjzAB2kEM1GrGoFQtD","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8539,"cache_creation_input_tokens":2556,"cache_read_input_tokens":89137,"cache_creation":{"ephemeral_5m_input_tokens":2556,"ephemeral_1h_input_tokens":0},"output_tokens":271,"service_tier":"standard"}},"requestId":"req_011CWUGPqNh4R7rQdUafW9Ax","type":"assistant","uuid":"efacb8c7-f03d-4c92-98a8-198c90ef1ae5","timestamp":"2025-12-25T23:23:18.026Z"}
{"parentUuid":"efacb8c7-f03d-4c92-98a8-198c90ef1ae5","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0129hWYtbcvMVk7iwiVJyTQk","type":"tool_result","content":"     1→/**\n     2→ * Severity Classification System\n     3→ * Classifies metric deviations into severity levels with treatment recommendations\n     4→ */\n     5→\n     6→import { Severity, SeverityResult, SeverityThreshold, MetricIssueMapping, Gender } from './types';\n     7→\n     8→// ============================================\n     9→// SEVERITY THRESHOLDS BY METRIC\n    10→// ============================================\n    11→\n    12→export const SEVERITY_THRESHOLDS: SeverityThreshold[] = [\n    13→  // FRONT PROFILE METRICS\n    14→  {\n    15→    metric: 'fwhr',\n    16→    optimal: { min: 1.80, max: 2.00 },\n    17→    mild: { min: 1.65, max: 2.15 },\n    18→    moderate: { min: 1.55, max: 2.25 },\n    19→    severe: { min: 0, max: Infinity },\n    20→    unit: 'ratio',\n    21→    higherIsBetter: false, // mid-range is ideal\n    22→  },\n    23→  {\n    24→    metric: 'canthalTilt',\n    25→    optimal: { min: 4, max: 8 },\n    26→    mild: { min: 0, max: 10 },\n    27→    moderate: { min: -2, max: 12 },\n    28→    severe: { min: -Infinity, max: Infinity },\n    29→    unit: 'degrees',\n    30→    higherIsBetter: true,\n    31→  },\n    32→  {\n    33→    metric: 'facialThirdsUpper',\n    34→    optimal: { min: 30, max: 36 },\n    35→    mild: { min: 27, max: 39 },\n    36→    moderate: { min: 24, max: 42 },\n    37→    severe: { min: 0, max: Infinity },\n    38→    unit: 'percent',\n    39→  },\n    40→  {\n    41→    metric: 'facialThirdsMiddle',\n    42→    optimal: { min: 30, max: 36 },\n    43→    mild: { min: 27, max: 39 },\n    44→    moderate: { min: 24, max: 42 },\n    45→    severe: { min: 0, max: Infinity },\n    46→    unit: 'percent',\n    47→  },\n    48→  {\n    49→    metric: 'facialThirdsLower',\n    50→    optimal: { min: 30, max: 36 },\n    51→    mild: { min: 27, max: 39 },\n    52→    moderate: { min: 24, max: 42 },\n    53→    severe: { min: 0, max: Infinity },\n    54→    unit: 'percent',\n    55→  },\n    56→  {\n    57→    metric: 'nasalIndex',\n    58→    optimal: { min: 70, max: 85 },\n    59→    mild: { min: 65, max: 90 },\n    60→    moderate: { min: 60, max: 95 },\n    61→    severe: { min: 0, max: Infinity },\n    62→    unit: 'ratio',\n    63→  },\n    64→  {\n    65→    metric: 'interpupillaryDistance',\n    66→    optimal: { min: 44, max: 48 },\n    67→    mild: { min: 42, max: 50 },\n    68→    moderate: { min: 40, max: 52 },\n    69→    severe: { min: 0, max: Infinity },\n    70→    unit: 'percent',\n    71→  },\n    72→  {\n    73→    metric: 'mouthWidth',\n    74→    optimal: { min: 48, max: 54 },\n    75→    mild: { min: 44, max: 58 },\n    76→    moderate: { min: 40, max: 62 },\n    77→    severe: { min: 0, max: Infinity },\n    78→    unit: 'percent',\n    79→  },\n    80→  {\n    81→    metric: 'lipRatio',\n    82→    optimal: { min: 1.5, max: 2.0 },\n    83→    mild: { min: 1.2, max: 2.3 },\n    84→    moderate: { min: 1.0, max: 2.6 },\n    85→    severe: { min: 0, max: Infinity },\n    86→    unit: 'ratio',\n    87→  },\n    88→  {\n    89→    metric: 'jawWidthRatio',\n    90→    optimal: { min: 0.75, max: 0.80 },\n    91→    mild: { min: 0.72, max: 0.83 },\n    92→    moderate: { min: 0.68, max: 0.87 },\n    93→    severe: { min: 0, max: Infinity },\n    94→    unit: 'ratio',\n    95→  },\n    96→  {\n    97→    metric: 'facialSymmetry',\n    98→    optimal: { min: 95, max: 100 },\n    99→    mild: { min: 90, max: 100 },\n   100→    moderate: { min: 85, max: 100 },\n   101→    severe: { min: 0, max: 100 },\n   102→    unit: 'percent',\n   103→    higherIsBetter: true,\n   104→  },\n   105→  {\n   106→    metric: 'eyeSpacing',\n   107→    optimal: { min: 0.95, max: 1.05 },\n   108→    mild: { min: 0.90, max: 1.10 },\n   109→    moderate: { min: 0.85, max: 1.15 },\n   110→    severe: { min: 0, max: Infinity },\n   111→    unit: 'ratio',\n   112→  },\n   113→  {\n   114→    metric: 'noseWidth',\n   115→    optimal: { min: 0.95, max: 1.05 },\n   116→    mild: { min: 0.90, max: 1.10 },\n   117→    moderate: { min: 0.85, max: 1.15 },\n   118→    severe: { min: 0, max: Infinity },\n   119→    unit: 'ratio',\n   120→  },\n   121→  {\n   122→    metric: 'cheekboneWidth',\n   123→    optimal: { min: 0.85, max: 0.92 },\n   124→    mild: { min: 0.80, max: 0.97 },\n   125→    moderate: { min: 0.75, max: 1.02 },\n   126→    severe: { min: 0, max: Infinity },\n   127→    unit: 'ratio',\n   128→  },\n   129→\n   130→  // SIDE PROFILE METRICS\n   131→  {\n   132→    metric: 'gonialAngle',\n   133→    optimal: { min: 120, max: 130 },\n   134→    mild: { min: 115, max: 135 },\n   135→    moderate: { min: 110, max: 140 },\n   136→    severe: { min: 0, max: Infinity },\n   137→    unit: 'degrees',\n   138→  },\n   139→  {\n   140→    metric: 'nasolabialAngle',\n   141→    optimal: { min: 95, max: 110 }, // Gender-adjusted in functions\n   142→    mild: { min: 85, max: 115 },\n   143→    moderate: { min: 80, max: 120 },\n   144→    severe: { min: 0, max: Infinity },\n   145→    unit: 'degrees',\n   146→  },\n   147→  {\n   148→    metric: 'nasofrontalAngle',\n   149→    optimal: { min: 130, max: 140 },\n   150→    mild: { min: 125, max: 145 },\n   151→    moderate: { min: 120, max: 150 },\n   152→    severe: { min: 0, max: Infinity },\n   153→    unit: 'degrees',\n   154→  },\n   155→  {\n   156→    metric: 'chinProjection',\n   157→    optimal: { min: -4, max: 2 },\n   158→    mild: { min: -6, max: 4 },\n   159→    moderate: { min: -8, max: 6 },\n   160→    severe: { min: -Infinity, max: Infinity },\n   161→    unit: 'mm',\n   162→  },\n   163→  {\n   164→    metric: 'mentoLabialAngle',\n   165→    optimal: { min: 110, max: 130 },\n   166→    mild: { min: 100, max: 140 },\n   167→    moderate: { min: 90, max: 150 },\n   168→    severe: { min: 0, max: Infinity },\n   169→    unit: 'degrees',\n   170→  },\n   171→  {\n   172→    metric: 'facialConvexity',\n   173→    optimal: { min: 165, max: 175 },\n   174→    mild: { min: 160, max: 180 },\n   175→    moderate: { min: 155, max: 185 },\n   176→    severe: { min: 0, max: Infinity },\n   177→    unit: 'degrees',\n   178→  },\n   179→  {\n   180→    metric: 'eLineUpperLip',\n   181→    optimal: { min: -4, max: -1 },\n   182→    mild: { min: -6, max: 1 },\n   183→    moderate: { min: -8, max: 3 },\n   184→    severe: { min: -Infinity, max: Infinity },\n   185→    unit: 'mm',\n   186→  },\n   187→  {\n   188→    metric: 'eLineLowerLip',\n   189→    optimal: { min: -2, max: 1 },\n   190→    mild: { min: -4, max: 3 },\n   191→    moderate: { min: -6, max: 5 },\n   192→    severe: { min: -Infinity, max: Infinity },\n   193→    unit: 'mm',\n   194→  },\n   195→  {\n   196→    metric: 'submCervicalAngle',\n   197→    optimal: { min: 100, max: 120 },\n   198→    mild: { min: 90, max: 130 },\n   199→    moderate: { min: 80, max: 140 },\n   200→    severe: { min: 0, max: Infinity },\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d1dd52ee-a437-4344-96a2-1fd2b178a7c6","timestamp":"2025-12-25T23:23:18.088Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/recommendations/severity.ts","content":"/**\n * Severity Classification System\n * Classifies metric deviations into severity levels with treatment recommendations\n */\n\nimport { Severity, SeverityResult, SeverityThreshold, MetricIssueMapping, Gender } from './types';\n\n// ============================================\n// SEVERITY THRESHOLDS BY METRIC\n// ============================================\n\nexport const SEVERITY_THRESHOLDS: SeverityThreshold[] = [\n  // FRONT PROFILE METRICS\n  {\n    metric: 'fwhr',\n    optimal: { min: 1.80, max: 2.00 },\n    mild: { min: 1.65, max: 2.15 },\n    moderate: { min: 1.55, max: 2.25 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n    higherIsBetter: false, // mid-range is ideal\n  },\n  {\n    metric: 'canthalTilt',\n    optimal: { min: 4, max: 8 },\n    mild: { min: 0, max: 10 },\n    moderate: { min: -2, max: 12 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'degrees',\n    higherIsBetter: true,\n  },\n  {\n    metric: 'facialThirdsUpper',\n    optimal: { min: 30, max: 36 },\n    mild: { min: 27, max: 39 },\n    moderate: { min: 24, max: 42 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'facialThirdsMiddle',\n    optimal: { min: 30, max: 36 },\n    mild: { min: 27, max: 39 },\n    moderate: { min: 24, max: 42 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'facialThirdsLower',\n    optimal: { min: 30, max: 36 },\n    mild: { min: 27, max: 39 },\n    moderate: { min: 24, max: 42 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'nasalIndex',\n    optimal: { min: 70, max: 85 },\n    mild: { min: 65, max: 90 },\n    moderate: { min: 60, max: 95 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'interpupillaryDistance',\n    optimal: { min: 44, max: 48 },\n    mild: { min: 42, max: 50 },\n    moderate: { min: 40, max: 52 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'mouthWidth',\n    optimal: { min: 48, max: 54 },\n    mild: { min: 44, max: 58 },\n    moderate: { min: 40, max: 62 },\n    severe: { min: 0, max: Infinity },\n    unit: 'percent',\n  },\n  {\n    metric: 'lipRatio',\n    optimal: { min: 1.5, max: 2.0 },\n    mild: { min: 1.2, max: 2.3 },\n    moderate: { min: 1.0, max: 2.6 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'jawWidthRatio',\n    optimal: { min: 0.75, max: 0.80 },\n    mild: { min: 0.72, max: 0.83 },\n    moderate: { min: 0.68, max: 0.87 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'facialSymmetry',\n    optimal: { min: 95, max: 100 },\n    mild: { min: 90, max: 100 },\n    moderate: { min: 85, max: 100 },\n    severe: { min: 0, max: 100 },\n    unit: 'percent',\n    higherIsBetter: true,\n  },\n  {\n    metric: 'eyeSpacing',\n    optimal: { min: 0.95, max: 1.05 },\n    mild: { min: 0.90, max: 1.10 },\n    moderate: { min: 0.85, max: 1.15 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'noseWidth',\n    optimal: { min: 0.95, max: 1.05 },\n    mild: { min: 0.90, max: 1.10 },\n    moderate: { min: 0.85, max: 1.15 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n  {\n    metric: 'cheekboneWidth',\n    optimal: { min: 0.85, max: 0.92 },\n    mild: { min: 0.80, max: 0.97 },\n    moderate: { min: 0.75, max: 1.02 },\n    severe: { min: 0, max: Infinity },\n    unit: 'ratio',\n  },\n\n  // SIDE PROFILE METRICS\n  {\n    metric: 'gonialAngle',\n    optimal: { min: 120, max: 130 },\n    mild: { min: 115, max: 135 },\n    moderate: { min: 110, max: 140 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'nasolabialAngle',\n    optimal: { min: 95, max: 110 }, // Gender-adjusted in functions\n    mild: { min: 85, max: 115 },\n    moderate: { min: 80, max: 120 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'nasofrontalAngle',\n    optimal: { min: 130, max: 140 },\n    mild: { min: 125, max: 145 },\n    moderate: { min: 120, max: 150 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'chinProjection',\n    optimal: { min: -4, max: 2 },\n    mild: { min: -6, max: 4 },\n    moderate: { min: -8, max: 6 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'mm',\n  },\n  {\n    metric: 'mentoLabialAngle',\n    optimal: { min: 110, max: 130 },\n    mild: { min: 100, max: 140 },\n    moderate: { min: 90, max: 150 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'facialConvexity',\n    optimal: { min: 165, max: 175 },\n    mild: { min: 160, max: 180 },\n    moderate: { min: 155, max: 185 },\n    severe: { min: 0, max: Infinity },\n    unit: 'degrees',\n  },\n  {\n    metric: 'eLineUpperLip',\n    optimal: { min: -4, max: -1 },\n    mild: { min: -6, max: 1 },\n    moderate: { min: -8, max: 3 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'mm',\n  },\n  {\n    metric: 'eLineLowerLip',\n    optimal: { min: -2, max: 1 },\n    mild: { min: -4, max: 3 },\n    moderate: { min: -6, max: 5 },\n    severe: { min: -Infinity, max: Infinity },\n    unit: 'mm',\n  },\n  {\n    metric: 'submCervicalAngle',\n    optimal: { min: 100, max: 120 },\n    mild: { min: 90, max: 130 },\n    moderate: { min: 80, max: 140 },\n    severe: { min: 0, max: Infinity },","numLines":200,"startLine":1,"totalLines":694}}}
{"parentUuid":"d1dd52ee-a437-4344-96a2-1fd2b178a7c6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N3TNMybhMxRKLPvn5cJa5U","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { motion } from 'framer-motion';\n     4→import Image from 'next/image';\n     5→import { User, ScanFace, Sparkles, ChevronRight, TrendingUp, TrendingDown, Lightbulb } from 'lucide-react';\n     6→import { useResults } from '@/contexts/ResultsContext';\n     7→import { TabContent } from '../ResultsLayout';\n     8→import { ScoreBar, AnimatedScore, ShareButton, ExportButton } from '../shared';\n     9→import { KeyStrengthsSection, AreasOfImprovementSection } from '../cards/KeyStrengthsFlaws';\n    10→import { FacialRadarChart } from '../visualization/FacialRadarChart';\n    11→import { RatioDetailModal } from '../modals/RatioDetailModal';\n    12→import { getScoreColor, ResponsibleRatio, Ratio } from '@/types/results';\n    13→import { MetricScoreResult } from '@/lib/harmony-scoring';\n    14→import { RankedMetric, getWeightTierColor } from '@/lib/looksmax-scoring';\n    15→import { useState, useCallback, useMemo } from 'react';\n    16→\n    17→// ============================================\n    18→// SCORE SUMMARY CARDS\n    19→// ============================================\n    20→\n    21→interface ProfileScoreCardProps {\n    22→  title: string;\n    23→  score: number;\n    24→  icon: React.ReactNode;\n    25→  photo?: string;\n    26→  ratioCount: number;\n    27→  onClick?: () => void;\n    28→}\n    29→\n    30→function ProfileScoreCard({ title, score, icon, photo, ratioCount, onClick }: ProfileScoreCardProps) {\n    31→  const color = getScoreColor(score);\n    32→\n    33→  return (\n    34→    <motion.button\n    35→      onClick={onClick}\n    36→      className=\"bg-neutral-900/80 border border-neutral-800 rounded-xl p-4 hover:border-neutral-700 transition-all text-left w-full\"\n    37→      whileHover={{ scale: 1.02 }}\n    38→      whileTap={{ scale: 0.98 }}\n    39→    >\n    40→      <div className=\"flex items-center gap-4\">\n    41→        {/* Photo or icon */}\n    42→        <div className=\"relative w-16 h-16 rounded-lg overflow-hidden bg-neutral-800 flex-shrink-0\">\n    43→          {photo ? (\n    44→            <Image\n    45→              src={photo}\n    46→              alt={title}\n    47→              width={64}\n    48→              height={64}\n    49→              className=\"object-cover\"\n    50→              unoptimized\n    51→            />\n    52→          ) : (\n    53→            <div className=\"w-full h-full flex items-center justify-center\">\n    54→              {icon}\n    55→            </div>\n    56→          )}\n    57→        </div>\n    58→\n    59→        {/* Info */}\n    60→        <div className=\"flex-1\">\n    61→          <h3 className=\"text-sm font-medium text-neutral-400 mb-1\">{title}</h3>\n    62→          <div className=\"flex items-baseline gap-2\">\n    63→            <span className=\"text-2xl font-bold\" style={{ color }}>\n    64→              {score.toFixed(2)}\n    65→            </span>\n    66→            <span className=\"text-sm text-neutral-500\">/ 10</span>\n    67→          </div>\n    68→          <p className=\"text-xs text-neutral-500 mt-1\">{ratioCount} measurements</p>\n    69→        </div>\n    70→\n    71→        {/* Arrow */}\n    72→        <ChevronRight size={20} className=\"text-neutral-600\" />\n    73→      </div>\n    74→\n    75→      {/* Score bar */}\n    76→      <div className=\"mt-3\">\n    77→        <ScoreBar score={score} height={6} />\n    78→      </div>\n    79→    </motion.button>\n    80→  );\n    81→}\n    82→\n    83→// ============================================\n    84→// QUICK INSIGHTS - TOP/BOTTOM METRICS WITH ADVICE\n    85→// ============================================\n    86→\n    87→interface MetricInsightCardProps {\n    88→  metric: RankedMetric;\n    89→  type: 'strength' | 'improvement';\n    90→  index: number;\n    91→}\n    92→\n    93→function MetricInsightCard({ metric, type, index }: MetricInsightCardProps) {\n    94→  const isStrength = type === 'strength';\n    95→  const color = getScoreColor(metric.score);\n    96→  const weightTierClass = getWeightTierColor(metric.weightTier);\n    97→\n    98→  return (\n    99→    <motion.div\n   100→      className={`bg-neutral-900/80 border rounded-xl p-4 ${\n   101→        isStrength ? 'border-green-500/30' : 'border-orange-500/30'\n   102→      }`}\n   103→      initial={{ opacity: 0, x: isStrength ? -20 : 20 }}\n   104→      animate={{ opacity: 1, x: 0 }}\n   105→      transition={{ delay: 0.1 * index }}\n   106→    >\n   107→      <div className=\"flex items-start gap-3\">\n   108→        <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${\n   109→          isStrength ? 'bg-green-500/20' : 'bg-orange-500/20'\n   110→        }`}>\n   111→          {isStrength ? (\n   112→            <TrendingUp size={16} className=\"text-green-400\" />\n   113→          ) : (\n   114→            <TrendingDown size={16} className=\"text-orange-400\" />\n   115→          )}\n   116→        </div>\n   117→\n   118→        <div className=\"flex-1 min-w-0\">\n   119→          <div className=\"flex items-center gap-2 mb-1\">\n   120→            <h4 className=\"font-medium text-white text-sm truncate\">{metric.name}</h4>\n   121→            <span className={`text-xs px-1.5 py-0.5 rounded border ${weightTierClass}`}>\n   122→              {metric.weightTier === 'high' ? '3x' : metric.weightTier === 'medium' ? '2x' : '1x'}\n   123→            </span>\n   124→          </div>\n   125→\n   126→          <div className=\"flex items-center gap-3 mb-2\">\n   127→            <span className=\"text-lg font-bold\" style={{ color }}>\n   128→              {metric.score.toFixed(1)}\n   129→            </span>\n   130→            <span className=\"text-xs text-neutral-500\">\n   131→              Ideal: {metric.idealMin.toFixed(1)} - {metric.idealMax.toFixed(1)}\n   132→            </span>\n   133→          </div>\n   134→\n   135→          {/* Advice */}\n   136→          <div className=\"flex items-start gap-2 mt-2 p-2 bg-neutral-800/50 rounded-lg\">\n   137→            <Lightbulb size={14} className={isStrength ? 'text-green-400 mt-0.5' : 'text-orange-400 mt-0.5'} />\n   138→            <p className=\"text-xs text-neutral-300 leading-relaxed\">{metric.advice}</p>\n   139→          </div>\n   140→        </div>\n   141→      </div>\n   142→    </motion.div>\n   143→  );\n   144→}\n   145→\n   146→interface QuickInsightsSectionProps {\n   147→  topMetrics: RankedMetric[];\n   148→  bottomMetrics: RankedMetric[];\n   149→}\n   150→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5e171581-1127-4964-aa8b-67fc56ffe22d","timestamp":"2025-12-25T23:23:18.088Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx","content":"'use client';\n\nimport { motion } from 'framer-motion';\nimport Image from 'next/image';\nimport { User, ScanFace, Sparkles, ChevronRight, TrendingUp, TrendingDown, Lightbulb } from 'lucide-react';\nimport { useResults } from '@/contexts/ResultsContext';\nimport { TabContent } from '../ResultsLayout';\nimport { ScoreBar, AnimatedScore, ShareButton, ExportButton } from '../shared';\nimport { KeyStrengthsSection, AreasOfImprovementSection } from '../cards/KeyStrengthsFlaws';\nimport { FacialRadarChart } from '../visualization/FacialRadarChart';\nimport { RatioDetailModal } from '../modals/RatioDetailModal';\nimport { getScoreColor, ResponsibleRatio, Ratio } from '@/types/results';\nimport { MetricScoreResult } from '@/lib/harmony-scoring';\nimport { RankedMetric, getWeightTierColor } from '@/lib/looksmax-scoring';\nimport { useState, useCallback, useMemo } from 'react';\n\n// ============================================\n// SCORE SUMMARY CARDS\n// ============================================\n\ninterface ProfileScoreCardProps {\n  title: string;\n  score: number;\n  icon: React.ReactNode;\n  photo?: string;\n  ratioCount: number;\n  onClick?: () => void;\n}\n\nfunction ProfileScoreCard({ title, score, icon, photo, ratioCount, onClick }: ProfileScoreCardProps) {\n  const color = getScoreColor(score);\n\n  return (\n    <motion.button\n      onClick={onClick}\n      className=\"bg-neutral-900/80 border border-neutral-800 rounded-xl p-4 hover:border-neutral-700 transition-all text-left w-full\"\n      whileHover={{ scale: 1.02 }}\n      whileTap={{ scale: 0.98 }}\n    >\n      <div className=\"flex items-center gap-4\">\n        {/* Photo or icon */}\n        <div className=\"relative w-16 h-16 rounded-lg overflow-hidden bg-neutral-800 flex-shrink-0\">\n          {photo ? (\n            <Image\n              src={photo}\n              alt={title}\n              width={64}\n              height={64}\n              className=\"object-cover\"\n              unoptimized\n            />\n          ) : (\n            <div className=\"w-full h-full flex items-center justify-center\">\n              {icon}\n            </div>\n          )}\n        </div>\n\n        {/* Info */}\n        <div className=\"flex-1\">\n          <h3 className=\"text-sm font-medium text-neutral-400 mb-1\">{title}</h3>\n          <div className=\"flex items-baseline gap-2\">\n            <span className=\"text-2xl font-bold\" style={{ color }}>\n              {score.toFixed(2)}\n            </span>\n            <span className=\"text-sm text-neutral-500\">/ 10</span>\n          </div>\n          <p className=\"text-xs text-neutral-500 mt-1\">{ratioCount} measurements</p>\n        </div>\n\n        {/* Arrow */}\n        <ChevronRight size={20} className=\"text-neutral-600\" />\n      </div>\n\n      {/* Score bar */}\n      <div className=\"mt-3\">\n        <ScoreBar score={score} height={6} />\n      </div>\n    </motion.button>\n  );\n}\n\n// ============================================\n// QUICK INSIGHTS - TOP/BOTTOM METRICS WITH ADVICE\n// ============================================\n\ninterface MetricInsightCardProps {\n  metric: RankedMetric;\n  type: 'strength' | 'improvement';\n  index: number;\n}\n\nfunction MetricInsightCard({ metric, type, index }: MetricInsightCardProps) {\n  const isStrength = type === 'strength';\n  const color = getScoreColor(metric.score);\n  const weightTierClass = getWeightTierColor(metric.weightTier);\n\n  return (\n    <motion.div\n      className={`bg-neutral-900/80 border rounded-xl p-4 ${\n        isStrength ? 'border-green-500/30' : 'border-orange-500/30'\n      }`}\n      initial={{ opacity: 0, x: isStrength ? -20 : 20 }}\n      animate={{ opacity: 1, x: 0 }}\n      transition={{ delay: 0.1 * index }}\n    >\n      <div className=\"flex items-start gap-3\">\n        <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${\n          isStrength ? 'bg-green-500/20' : 'bg-orange-500/20'\n        }`}>\n          {isStrength ? (\n            <TrendingUp size={16} className=\"text-green-400\" />\n          ) : (\n            <TrendingDown size={16} className=\"text-orange-400\" />\n          )}\n        </div>\n\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h4 className=\"font-medium text-white text-sm truncate\">{metric.name}</h4>\n            <span className={`text-xs px-1.5 py-0.5 rounded border ${weightTierClass}`}>\n              {metric.weightTier === 'high' ? '3x' : metric.weightTier === 'medium' ? '2x' : '1x'}\n            </span>\n          </div>\n\n          <div className=\"flex items-center gap-3 mb-2\">\n            <span className=\"text-lg font-bold\" style={{ color }}>\n              {metric.score.toFixed(1)}\n            </span>\n            <span className=\"text-xs text-neutral-500\">\n              Ideal: {metric.idealMin.toFixed(1)} - {metric.idealMax.toFixed(1)}\n            </span>\n          </div>\n\n          {/* Advice */}\n          <div className=\"flex items-start gap-2 mt-2 p-2 bg-neutral-800/50 rounded-lg\">\n            <Lightbulb size={14} className={isStrength ? 'text-green-400 mt-0.5' : 'text-orange-400 mt-0.5'} />\n            <p className=\"text-xs text-neutral-300 leading-relaxed\">{metric.advice}</p>\n          </div>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\ninterface QuickInsightsSectionProps {\n  topMetrics: RankedMetric[];\n  bottomMetrics: RankedMetric[];\n}\n","numLines":150,"startLine":1,"totalLines":604}}}
{"parentUuid":"5e171581-1127-4964-aa8b-67fc56ffe22d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014PMrCjzAB2kEM1GrGoFQtD","type":"tool_result","content":"     1→/**\n     2→ * Harmony-Style Results Page Types\n     3→ * Complete type definitions for the results UI\n     4→ */\n     5→\n     6→import { QualityTier, SeverityLevel, MeasurementUnit } from '@/lib/harmony-scoring';\n     7→\n     8→// ============================================\n     9→// ILLUSTRATION TYPES\n    10→// ============================================\n    11→\n    12→export interface IllustrationPoint {\n    13→  type: 'landmark' | 'calculated';\n    14→  landmarkId?: string;\n    15→  x?: number;\n    16→  y?: number;\n    17→  label?: string;\n    18→}\n    19→\n    20→export interface IllustrationLine {\n    21→  from: string;\n    22→  to: string;\n    23→  color: string;\n    24→  style?: 'solid' | 'dashed';\n    25→  label?: string;\n    26→  labelColor?: string;\n    27→  labelPosition?: 'start' | 'middle' | 'end';\n    28→}\n    29→\n    30→export interface RatioIllustration {\n    31→  points: Record<string, IllustrationPoint>;\n    32→  lines: Record<string, IllustrationLine>;\n    33→}\n    34→\n    35→// ============================================\n    36→// RATIO/MEASUREMENT TYPES\n    37→// ============================================\n    38→\n    39→export interface Ratio {\n    40→  id: string;\n    41→  name: string;\n    42→  value: number;\n    43→  score: number;  // 0-10 scale\n    44→  standardizedScore: number;\n    45→  unit: 'x' | 'mm' | '%' | '°';\n    46→  idealMin: number;\n    47→  idealMax: number;\n    48→  rangeMin: number;\n    49→  rangeMax: number;\n    50→  description: string;\n    51→  category: string;\n    52→  qualityLevel: QualityTier;\n    53→  severity: SeverityLevel;\n    54→  illustration: RatioIllustration;\n    55→  mayIndicateFlaws: string[];\n    56→  mayIndicateStrengths: string[];\n    57→  usedLandmarks: string[];\n    58→  scoringCurveConfig?: {\n    59→    decayRate: number;\n    60→    maxScore: number;\n    61→  };\n    62→  // Harmony Taxonomy classification\n    63→  taxonomyPrimary?: string;    // 'harmony' | 'dimorphism' | 'angularity' | 'features'\n    64→  taxonomySecondary?: string;  // Subcategory ID\n    65→}\n    66→\n    67→// ============================================\n    68→// STRENGTH/FLAW TYPES\n    69→// ============================================\n    70→\n    71→export interface ResponsibleRatio {\n    72→  ratioName: string;\n    73→  ratioId: string;\n    74→  score: number;\n    75→  value: number;\n    76→  isObfuscated?: boolean;\n    77→  // Additional properties for AI descriptions\n    78→  idealMin: number;\n    79→  idealMax: number;\n    80→  unit: string;\n    81→  category?: string;\n    82→}\n    83→\n    84→export interface Strength {\n    85→  id: string;\n    86→  strengthName: string;\n    87→  summary: string;\n    88→  avgScore: number;\n    89→  qualityLevel: QualityTier;\n    90→  categoryName: string;\n    91→  responsibleRatios: ResponsibleRatio[];\n    92→}\n    93→\n    94→export interface Flaw {\n    95→  id: string;\n    96→  flawName: string;\n    97→  summary: string;\n    98→  harmonyPercentageLost: number;\n    99→  standardizedImpact: number;\n   100→  categoryName: string;\n   101→  isOther?: boolean;\n   102→  responsibleRatios: ResponsibleRatio[];\n   103→  rollingPointsDeducted?: number;\n   104→  rollingHarmonyPercentageLost?: number;\n   105→  rollingStandardizedImpact?: number;\n   106→}\n   107→\n   108→// ============================================\n   109→// RECOMMENDATION TYPES\n   110→// ============================================\n   111→\n   112→export type RecommendationPhase = 'Surgical' | 'Minimally Invasive' | 'Foundational';\n   113→\n   114→export interface RecommendationTimeline {\n   115→  effect_start: 'immediate' | 'delayed' | 'gradual';\n   116→  full_results_weeks: number;\n   117→  full_results_weeks_max?: number;\n   118→}\n   119→\n   120→export interface RecommendationCost {\n   121→  type: 'flat' | 'per_month' | 'per_session';\n   122→  min: number;\n   123→  max: number;\n   124→  currency: string;\n   125→}\n   126→\n   127→export interface RatioImpact {\n   128→  ratioId: string;\n   129→  ratioName: string;\n   130→  direction: 'increase' | 'decrease' | 'both';\n   131→  percentageEffect: number;\n   132→}\n   133→\n   134→export interface Recommendation {\n   135→  ref_id: string;\n   136→  name: string;\n   137→  description: string;\n   138→  phase: RecommendationPhase;\n   139→  impact: number;  // 0-1 effectiveness score\n   140→  coverage: number;  // Number of metrics improved\n   141→  percentage: string;  // e.g., \"10-20%\"\n   142→  expectedImprovementRange?: { min: number; max: number };\n   143→  matchedFlaws: string[];\n   144→  matchedRatios: string[];\n   145→  ratios_impacted: RatioImpact[];\n   146→  timeline: RecommendationTimeline;\n   147→  cost: RecommendationCost;\n   148→  risks_side_effects: string | null;\n   149→  warnings: string[];\n   150→  gender: 'male' | 'female' | 'both';\n   151→}\n   152→\n   153→// ============================================\n   154→// HARMONY ANALYSIS TYPES\n   155→// ============================================\n   156→\n   157→export interface ProfileAnalysis {\n   158→  standardizedScore: number;\n   159→  ratios: Ratio[];\n   160→  overallAIDescription?: string | null;\n   161→}\n   162→\n   163→export interface FullHarmonyAnalysis {\n   164→  standardizedScore: number;\n   165→  front: ProfileAnalysis;\n   166→  side: ProfileAnalysis;\n   167→  strengths: Strength[];\n   168→  flaws: Flaw[];\n   169→}\n   170→\n   171→// ============================================\n   172→// FACE DATA TYPES\n   173→// ============================================\n   174→\n   175→export interface FaceData {\n   176→  id: string;\n   177→  userId?: string;\n   178→  frontPhotoUrl: string;\n   179→  sidePhotoUrl?: string;\n   180→  harmonyScore: number | null;\n   181→  frontHarmonyScore: number | null;\n   182→  sideHarmonyScore: number | null;\n   183→  gender: 'male' | 'female';\n   184→  race?: string;\n   185→  unlocked: boolean;\n   186→  actionPlanUnlocked: boolean;\n   187→  harmonyAnalysis: FullHarmonyAnalysis;\n   188→}\n   189→\n   190→// ============================================\n   191→// UI STATE TYPES\n   192→// ============================================\n   193→\n   194→export type ResultsTab =\n   195→  | 'overview'\n   196→  | 'front-ratios'\n   197→  | 'side-ratios'\n   198→  | 'leaderboard'\n   199→  | 'plan'\n   200→  | 'community'\n   201→  | 'options'\n   202→  | 'support';\n   203→\n   204→// ============================================\n   205→// LEADERBOARD TYPES\n   206→// ============================================\n   207→\n   208→export interface UserRank {\n   209→  userId: string;\n   210→  score: number;\n   211→  globalRank: number;\n   212→  genderRank: number;\n   213→  percentile: number;\n   214→  totalUsers: number;\n   215→  genderTotal: number;\n   216→  anonymousName: string;\n   217→  updatedAt: string;\n   218→}\n   219→\n   220→export interface LeaderboardEntry {\n   221→  userId: string;\n   222→  rank: number;\n   223→  score: number;\n   224→  anonymousName: string;\n   225→  gender: 'male' | 'female';\n   226→  facePhotoUrl: string | null;\n   227→  isCurrentUser: boolean;\n   228→}\n   229→\n   230→export interface UserProfile extends Omit<LeaderboardEntry, 'isCurrentUser'> {\n   231→  topStrengths: string[];\n   232→  topImprovements: string[];\n   233→}\n   234→\n   235→export interface LeaderboardData {\n   236→  entries: LeaderboardEntry[];\n   237→  totalCount: number;\n   238→  userRank: UserRank | null;\n   239→}\n   240→\n   241→export interface ResultsUIState {\n   242→  activeTab: ResultsTab;\n   243→  expandedMeasurementId: string | null;\n   244→  selectedVisualizationMetric: string | null;\n   245→  categoryFilter: string | null;\n   246→  showLandmarkOverlay: boolean;\n   247→}\n   248→\n   249→// ============================================\n   250→// CATEGORY TYPES\n   251→// ============================================\n   252→\n   253→export interface MeasurementCategory {\n   254→  id: string;\n   255→  name: string;\n   256→  color: string;\n   257→  description: string;\n   258→}\n   259→\n   260→export const MEASUREMENT_CATEGORIES: MeasurementCategory[] = [\n   261→  { id: 'midface', name: 'Midface/Face Shape', color: '#67e8f9', description: 'Facial proportions and overall shape' },\n   262→  { id: 'jaw-growth', name: 'Occlusion/Jaw Growth', color: '#a78bfa', description: 'Jaw development and bite alignment' },\n   263→  { id: 'jaw-shape', name: 'Jaw Shape', color: '#f97316', description: 'Jawline contour and angles' },\n   264→  { id: 'upper-third', name: 'Upper Third', color: '#84cc16', description: 'Forehead and hairline proportions' },\n   265→  { id: 'eyes', name: 'Eyes', color: '#06b6d4', description: 'Eye shape, spacing, and canthal tilt' },\n   266→  { id: 'nose', name: 'Nose', color: '#fbbf24', description: 'Nasal proportions and angles' },\n   267→  { id: 'lips', name: 'Lips', color: '#ec4899', description: 'Lip proportions and projection' },\n   268→  { id: 'chin', name: 'Chin', color: '#ef4444', description: 'Chin projection and shape' },\n   269→  { id: 'neck', name: 'Neck', color: '#14b8a6', description: 'Neck angle and throat definition' },\n   270→  { id: 'other', name: 'Other', color: '#6b7280', description: 'Additional measurements' },\n   271→];\n   272→\n   273→// ============================================\n   274→// SCORE COLOR HELPERS\n   275→// ============================================\n   276→\n   277→export function getScoreColor(score: number): string {\n   278→  if (score >= 8) return '#67e8f9';  // Cyan - ideal\n   279→  if (score >= 6) return '#22c55e';  // Green - good\n   280→  if (score >= 4) return '#fbbf24';  // Yellow - fair\n   281→  return 'rgb(227, 67, 67)';         // Red - poor\n   282→}\n   283→\n   284→export function getQualityColor(quality: QualityTier): string {\n   285→  switch (quality) {\n   286→    case 'ideal': return '#67e8f9';\n   287→    case 'excellent': return '#22c55e';\n   288→    case 'good': return '#fbbf24';\n   289→    case 'below_average': return 'rgb(227, 67, 67)';\n   290→    default: return '#6b7280';\n   291→  }\n   292→}\n   293→\n   294→export function getSeverityColor(severity: SeverityLevel): string {\n   295→  switch (severity) {\n   296→    case 'optimal': return '#67e8f9';\n   297→    case 'minor': return '#22c55e';\n   298→    case 'moderate': return '#fbbf24';\n   299→    case 'major': return '#f97316';\n   300→    case 'severe': return '#ef4444';\n   301→    case 'extremely_severe': return '#dc2626';\n   302→    default: return '#6b7280';\n   303→  }\n   304→}\n   305→\n   306→export function getCategoryColor(categoryName: string): string {\n   307→  const cat = MEASUREMENT_CATEGORIES.find(c =>\n   308→    c.name.toLowerCase().includes(categoryName.toLowerCase()) ||\n   309→    categoryName.toLowerCase().includes(c.name.toLowerCase())\n   310→  );\n   311→  return cat?.color || '#6b7280';\n   312→}\n   313→\n   314→// ============================================\n   315→// UNIT FORMATTING\n   316→// ============================================\n   317→\n   318→export function formatUnit(unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n   319→  switch (unit) {\n   320→    case 'x':\n   321→    case 'ratio': return 'x';\n   322→    case 'mm': return 'mm';\n   323→    case '%':\n   324→    case 'percent': return '%';\n   325→    case '°':\n   326→    case 'degrees': return '°';\n   327→    default: return '';\n   328→  }\n   329→}\n   330→\n   331→export function formatValue(value: number, unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n   332→  const unitStr = formatUnit(unit);\n   333→  if (unit === '%' || unit === 'percent') {\n   334→    return `${value.toFixed(1)}${unitStr}`;\n   335→  }\n   336→  if (unit === '°' || unit === 'degrees') {\n   337→    return `${value.toFixed(1)}${unitStr}`;\n   338→  }\n   339→  return `${value.toFixed(2)}${unitStr}`;\n   340→}\n   341→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f8b092c0-d433-4435-89b1-e1e253c8343b","timestamp":"2025-12-25T23:23:18.088Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts","content":"/**\n * Harmony-Style Results Page Types\n * Complete type definitions for the results UI\n */\n\nimport { QualityTier, SeverityLevel, MeasurementUnit } from '@/lib/harmony-scoring';\n\n// ============================================\n// ILLUSTRATION TYPES\n// ============================================\n\nexport interface IllustrationPoint {\n  type: 'landmark' | 'calculated';\n  landmarkId?: string;\n  x?: number;\n  y?: number;\n  label?: string;\n}\n\nexport interface IllustrationLine {\n  from: string;\n  to: string;\n  color: string;\n  style?: 'solid' | 'dashed';\n  label?: string;\n  labelColor?: string;\n  labelPosition?: 'start' | 'middle' | 'end';\n}\n\nexport interface RatioIllustration {\n  points: Record<string, IllustrationPoint>;\n  lines: Record<string, IllustrationLine>;\n}\n\n// ============================================\n// RATIO/MEASUREMENT TYPES\n// ============================================\n\nexport interface Ratio {\n  id: string;\n  name: string;\n  value: number;\n  score: number;  // 0-10 scale\n  standardizedScore: number;\n  unit: 'x' | 'mm' | '%' | '°';\n  idealMin: number;\n  idealMax: number;\n  rangeMin: number;\n  rangeMax: number;\n  description: string;\n  category: string;\n  qualityLevel: QualityTier;\n  severity: SeverityLevel;\n  illustration: RatioIllustration;\n  mayIndicateFlaws: string[];\n  mayIndicateStrengths: string[];\n  usedLandmarks: string[];\n  scoringCurveConfig?: {\n    decayRate: number;\n    maxScore: number;\n  };\n  // Harmony Taxonomy classification\n  taxonomyPrimary?: string;    // 'harmony' | 'dimorphism' | 'angularity' | 'features'\n  taxonomySecondary?: string;  // Subcategory ID\n}\n\n// ============================================\n// STRENGTH/FLAW TYPES\n// ============================================\n\nexport interface ResponsibleRatio {\n  ratioName: string;\n  ratioId: string;\n  score: number;\n  value: number;\n  isObfuscated?: boolean;\n  // Additional properties for AI descriptions\n  idealMin: number;\n  idealMax: number;\n  unit: string;\n  category?: string;\n}\n\nexport interface Strength {\n  id: string;\n  strengthName: string;\n  summary: string;\n  avgScore: number;\n  qualityLevel: QualityTier;\n  categoryName: string;\n  responsibleRatios: ResponsibleRatio[];\n}\n\nexport interface Flaw {\n  id: string;\n  flawName: string;\n  summary: string;\n  harmonyPercentageLost: number;\n  standardizedImpact: number;\n  categoryName: string;\n  isOther?: boolean;\n  responsibleRatios: ResponsibleRatio[];\n  rollingPointsDeducted?: number;\n  rollingHarmonyPercentageLost?: number;\n  rollingStandardizedImpact?: number;\n}\n\n// ============================================\n// RECOMMENDATION TYPES\n// ============================================\n\nexport type RecommendationPhase = 'Surgical' | 'Minimally Invasive' | 'Foundational';\n\nexport interface RecommendationTimeline {\n  effect_start: 'immediate' | 'delayed' | 'gradual';\n  full_results_weeks: number;\n  full_results_weeks_max?: number;\n}\n\nexport interface RecommendationCost {\n  type: 'flat' | 'per_month' | 'per_session';\n  min: number;\n  max: number;\n  currency: string;\n}\n\nexport interface RatioImpact {\n  ratioId: string;\n  ratioName: string;\n  direction: 'increase' | 'decrease' | 'both';\n  percentageEffect: number;\n}\n\nexport interface Recommendation {\n  ref_id: string;\n  name: string;\n  description: string;\n  phase: RecommendationPhase;\n  impact: number;  // 0-1 effectiveness score\n  coverage: number;  // Number of metrics improved\n  percentage: string;  // e.g., \"10-20%\"\n  expectedImprovementRange?: { min: number; max: number };\n  matchedFlaws: string[];\n  matchedRatios: string[];\n  ratios_impacted: RatioImpact[];\n  timeline: RecommendationTimeline;\n  cost: RecommendationCost;\n  risks_side_effects: string | null;\n  warnings: string[];\n  gender: 'male' | 'female' | 'both';\n}\n\n// ============================================\n// HARMONY ANALYSIS TYPES\n// ============================================\n\nexport interface ProfileAnalysis {\n  standardizedScore: number;\n  ratios: Ratio[];\n  overallAIDescription?: string | null;\n}\n\nexport interface FullHarmonyAnalysis {\n  standardizedScore: number;\n  front: ProfileAnalysis;\n  side: ProfileAnalysis;\n  strengths: Strength[];\n  flaws: Flaw[];\n}\n\n// ============================================\n// FACE DATA TYPES\n// ============================================\n\nexport interface FaceData {\n  id: string;\n  userId?: string;\n  frontPhotoUrl: string;\n  sidePhotoUrl?: string;\n  harmonyScore: number | null;\n  frontHarmonyScore: number | null;\n  sideHarmonyScore: number | null;\n  gender: 'male' | 'female';\n  race?: string;\n  unlocked: boolean;\n  actionPlanUnlocked: boolean;\n  harmonyAnalysis: FullHarmonyAnalysis;\n}\n\n// ============================================\n// UI STATE TYPES\n// ============================================\n\nexport type ResultsTab =\n  | 'overview'\n  | 'front-ratios'\n  | 'side-ratios'\n  | 'leaderboard'\n  | 'plan'\n  | 'community'\n  | 'options'\n  | 'support';\n\n// ============================================\n// LEADERBOARD TYPES\n// ============================================\n\nexport interface UserRank {\n  userId: string;\n  score: number;\n  globalRank: number;\n  genderRank: number;\n  percentile: number;\n  totalUsers: number;\n  genderTotal: number;\n  anonymousName: string;\n  updatedAt: string;\n}\n\nexport interface LeaderboardEntry {\n  userId: string;\n  rank: number;\n  score: number;\n  anonymousName: string;\n  gender: 'male' | 'female';\n  facePhotoUrl: string | null;\n  isCurrentUser: boolean;\n}\n\nexport interface UserProfile extends Omit<LeaderboardEntry, 'isCurrentUser'> {\n  topStrengths: string[];\n  topImprovements: string[];\n}\n\nexport interface LeaderboardData {\n  entries: LeaderboardEntry[];\n  totalCount: number;\n  userRank: UserRank | null;\n}\n\nexport interface ResultsUIState {\n  activeTab: ResultsTab;\n  expandedMeasurementId: string | null;\n  selectedVisualizationMetric: string | null;\n  categoryFilter: string | null;\n  showLandmarkOverlay: boolean;\n}\n\n// ============================================\n// CATEGORY TYPES\n// ============================================\n\nexport interface MeasurementCategory {\n  id: string;\n  name: string;\n  color: string;\n  description: string;\n}\n\nexport const MEASUREMENT_CATEGORIES: MeasurementCategory[] = [\n  { id: 'midface', name: 'Midface/Face Shape', color: '#67e8f9', description: 'Facial proportions and overall shape' },\n  { id: 'jaw-growth', name: 'Occlusion/Jaw Growth', color: '#a78bfa', description: 'Jaw development and bite alignment' },\n  { id: 'jaw-shape', name: 'Jaw Shape', color: '#f97316', description: 'Jawline contour and angles' },\n  { id: 'upper-third', name: 'Upper Third', color: '#84cc16', description: 'Forehead and hairline proportions' },\n  { id: 'eyes', name: 'Eyes', color: '#06b6d4', description: 'Eye shape, spacing, and canthal tilt' },\n  { id: 'nose', name: 'Nose', color: '#fbbf24', description: 'Nasal proportions and angles' },\n  { id: 'lips', name: 'Lips', color: '#ec4899', description: 'Lip proportions and projection' },\n  { id: 'chin', name: 'Chin', color: '#ef4444', description: 'Chin projection and shape' },\n  { id: 'neck', name: 'Neck', color: '#14b8a6', description: 'Neck angle and throat definition' },\n  { id: 'other', name: 'Other', color: '#6b7280', description: 'Additional measurements' },\n];\n\n// ============================================\n// SCORE COLOR HELPERS\n// ============================================\n\nexport function getScoreColor(score: number): string {\n  if (score >= 8) return '#67e8f9';  // Cyan - ideal\n  if (score >= 6) return '#22c55e';  // Green - good\n  if (score >= 4) return '#fbbf24';  // Yellow - fair\n  return 'rgb(227, 67, 67)';         // Red - poor\n}\n\nexport function getQualityColor(quality: QualityTier): string {\n  switch (quality) {\n    case 'ideal': return '#67e8f9';\n    case 'excellent': return '#22c55e';\n    case 'good': return '#fbbf24';\n    case 'below_average': return 'rgb(227, 67, 67)';\n    default: return '#6b7280';\n  }\n}\n\nexport function getSeverityColor(severity: SeverityLevel): string {\n  switch (severity) {\n    case 'optimal': return '#67e8f9';\n    case 'minor': return '#22c55e';\n    case 'moderate': return '#fbbf24';\n    case 'major': return '#f97316';\n    case 'severe': return '#ef4444';\n    case 'extremely_severe': return '#dc2626';\n    default: return '#6b7280';\n  }\n}\n\nexport function getCategoryColor(categoryName: string): string {\n  const cat = MEASUREMENT_CATEGORIES.find(c =>\n    c.name.toLowerCase().includes(categoryName.toLowerCase()) ||\n    categoryName.toLowerCase().includes(c.name.toLowerCase())\n  );\n  return cat?.color || '#6b7280';\n}\n\n// ============================================\n// UNIT FORMATTING\n// ============================================\n\nexport function formatUnit(unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n  switch (unit) {\n    case 'x':\n    case 'ratio': return 'x';\n    case 'mm': return 'mm';\n    case '%':\n    case 'percent': return '%';\n    case '°':\n    case 'degrees': return '°';\n    default: return '';\n  }\n}\n\nexport function formatValue(value: number, unit: 'x' | 'mm' | '%' | '°' | MeasurementUnit): string {\n  const unitStr = formatUnit(unit);\n  if (unit === '%' || unit === 'percent') {\n    return `${value.toFixed(1)}${unitStr}`;\n  }\n  if (unit === '°' || unit === 'degrees') {\n    return `${value.toFixed(1)}${unitStr}`;\n  }\n  return `${value.toFixed(2)}${unitStr}`;\n}\n","numLines":341,"startLine":1,"totalLines":341}}}
{"parentUuid":"f8b092c0-d433-4435-89b1-e1e253c8343b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_017Xcwn4wzgxfJVbhBB5Vefc","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the payment router and existing context patterns to understand the paid tier gating:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":18370,"cache_read_input_tokens":91693,"cache_creation":{"ephemeral_5m_input_tokens":18370,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGQheP4RJjv6hg6CMja","type":"assistant","uuid":"c1fa8884-5997-43e4-a178-81f2827b7757","timestamp":"2025-12-25T23:23:25.918Z"}
{"parentUuid":"c1fa8884-5997-43e4-a178-81f2827b7757","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_017Xcwn4wzgxfJVbhBB5Vefc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BUxkAch7W5RuKU6akpZxTu","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/payments.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":18370,"cache_read_input_tokens":91693,"cache_creation":{"ephemeral_5m_input_tokens":18370,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGQheP4RJjv6hg6CMja","type":"assistant","uuid":"55458d98-9dcd-4c52-a632-d7aad0dd3ee0","timestamp":"2025-12-25T23:23:27.083Z"}
{"parentUuid":"55458d98-9dcd-4c52-a632-d7aad0dd3ee0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_017Xcwn4wzgxfJVbhBB5Vefc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YFoWgKSBwgTpnNwZNh3emp","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/AuthContext.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":18370,"cache_read_input_tokens":91693,"cache_creation":{"ephemeral_5m_input_tokens":18370,"ephemeral_1h_input_tokens":0},"output_tokens":163,"service_tier":"standard"}},"requestId":"req_011CWUGQheP4RJjv6hg6CMja","type":"assistant","uuid":"988a4320-3ba7-4859-a39e-4537339dd140","timestamp":"2025-12-25T23:23:27.840Z"}
{"parentUuid":"988a4320-3ba7-4859-a39e-4537339dd140","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BUxkAch7W5RuKU6akpZxTu","type":"tool_result","content":"     1→\"\"\"\n     2→Payments router - Stripe checkout and webhooks\n     3→\"\"\"\n     4→\n     5→import stripe\n     6→from fastapi import APIRouter, Depends, HTTPException, Request, status\n     7→from sqlalchemy.ext.asyncio import AsyncSession\n     8→from sqlalchemy import select\n     9→from uuid import uuid4\n    10→\n    11→from app.config import get_settings\n    12→from app.database import get_db\n    13→from app.models.user import User\n    14→from app.models.payment import Payment\n    15→from app.services.auth import get_current_user\n    16→\n    17→router = APIRouter(prefix=\"/payments\", tags=[\"payments\"])\n    18→settings = get_settings()\n    19→\n    20→# Initialize Stripe\n    21→stripe.api_key = settings.stripe_secret_key\n    22→\n    23→# Plan pricing (in cents)\n    24→PLAN_PRICES = {\n    25→    \"basic\": 2499,  # $24.99/month\n    26→    \"pro\": 4999,    # $49.99/month\n    27→}\n    28→\n    29→\n    30→@router.post(\"/checkout\")\n    31→async def create_checkout_session(\n    32→    plan: str,\n    33→    current_user: User = Depends(get_current_user),\n    34→):\n    35→    \"\"\"Create Stripe checkout session for plan upgrade\"\"\"\n    36→    if plan not in PLAN_PRICES:\n    37→        raise HTTPException(\n    38→            status_code=status.HTTP_400_BAD_REQUEST,\n    39→            detail=f\"Invalid plan. Choose from: {list(PLAN_PRICES.keys())}\"\n    40→        )\n    41→\n    42→    try:\n    43→        # Create or get Stripe customer\n    44→        if not current_user.stripe_customer_id:\n    45→            customer = stripe.Customer.create(\n    46→                email=current_user.email,\n    47→                metadata={\"user_id\": str(current_user.id)}\n    48→            )\n    49→            customer_id = customer.id\n    50→        else:\n    51→            customer_id = current_user.stripe_customer_id\n    52→\n    53→        # Build checkout session params\n    54→        checkout_params = {\n    55→            \"customer\": customer_id,\n    56→            \"payment_method_types\": [\"card\"],\n    57→            \"line_items\": [{\n    58→                \"price_data\": {\n    59→                    \"currency\": \"usd\",\n    60→                    \"product_data\": {\n    61→                        \"name\": f\"LOOKSMAXX {plan.title()} Plan\",\n    62→                    },\n    63→                    \"unit_amount\": PLAN_PRICES[plan],\n    64→                },\n    65→                \"quantity\": 1,\n    66→            }],\n    67→            \"mode\": \"payment\",\n    68→            \"success_url\": f\"{settings.frontend_url}/payment/success?session_id={{CHECKOUT_SESSION_ID}}\",\n    69→            \"cancel_url\": f\"{settings.frontend_url}/payment/cancel\",\n    70→            \"metadata\": {\n    71→                \"user_id\": str(current_user.id),\n    72→                \"plan\": plan,\n    73→                \"referral_code\": current_user.referral_code or \"\",\n    74→            },\n    75→        }\n    76→\n    77→        # Apply Stripe promotion code if user was referred\n    78→        if current_user.referred_by:\n    79→            checkout_params[\"discounts\"] = [{\n    80→                \"promotion_code\": current_user.referred_by\n    81→            }]\n    82→\n    83→        # Create checkout session\n    84→        session = stripe.checkout.Session.create(**checkout_params)\n    85→\n    86→        return {\"checkout_url\": session.url, \"session_id\": session.id}\n    87→\n    88→    except stripe.error.StripeError as e:\n    89→        raise HTTPException(\n    90→            status_code=status.HTTP_400_BAD_REQUEST,\n    91→            detail=str(e)\n    92→        )\n    93→\n    94→\n    95→@router.post(\"/webhook\")\n    96→async def stripe_webhook(request: Request, db: AsyncSession = Depends(get_db)):\n    97→    \"\"\"Handle Stripe webhooks\"\"\"\n    98→    payload = await request.body()\n    99→    sig_header = request.headers.get(\"stripe-signature\")\n   100→\n   101→    try:\n   102→        event = stripe.Webhook.construct_event(\n   103→            payload, sig_header, settings.stripe_webhook_secret\n   104→        )\n   105→    except ValueError:\n   106→        raise HTTPException(status_code=400, detail=\"Invalid payload\")\n   107→    except stripe.error.SignatureVerificationError:\n   108→        raise HTTPException(status_code=400, detail=\"Invalid signature\")\n   109→\n   110→    # Handle checkout.session.completed\n   111→    if event[\"type\"] == \"checkout.session.completed\":\n   112→        session = event[\"data\"][\"object\"]\n   113→        user_id = session[\"metadata\"][\"user_id\"]\n   114→        plan = session[\"metadata\"][\"plan\"]\n   115→\n   116→        # Update user plan\n   117→        result = await db.execute(select(User).where(User.id == user_id))\n   118→        user = result.scalar_one_or_none()\n   119→\n   120→        if user:\n   121→            user.plan = plan\n   122→            user.stripe_customer_id = session[\"customer\"]\n   123→\n   124→            # Record payment\n   125→            payment = Payment(\n   126→                id=uuid4(),\n   127→                user_id=user.id,\n   128→                stripe_payment_id=session[\"payment_intent\"],\n   129→                stripe_session_id=session[\"id\"],\n   130→                amount=session[\"amount_total\"],\n   131→                currency=session[\"currency\"],\n   132→                status=\"completed\",\n   133→            )\n   134→            db.add(payment)\n   135→            await db.commit()\n   136→\n   137→    return {\"received\": True}\n   138→\n   139→\n   140→@router.get(\"/history\")\n   141→async def payment_history(\n   142→    current_user: User = Depends(get_current_user),\n   143→    db: AsyncSession = Depends(get_db),\n   144→):\n   145→    \"\"\"Get payment history for current user\"\"\"\n   146→    result = await db.execute(\n   147→        select(Payment)\n   148→        .where(Payment.user_id == current_user.id)\n   149→        .order_by(Payment.created_at.desc())\n   150→    )\n   151→    payments = result.scalars().all()\n   152→\n   153→    return [\n   154→        {\n   155→            \"id\": str(p.id),\n   156→            \"amount\": p.amount / 100,  # Convert cents to dollars\n   157→            \"currency\": p.currency,\n   158→            \"status\": p.status,\n   159→            \"created_at\": p.created_at.isoformat(),\n   160→        }\n   161→        for p in payments\n   162→    ]\n   163→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"703f2e99-935a-47fb-840a-13de52e17b66","timestamp":"2025-12-25T23:23:27.900Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/payments.py","content":"\"\"\"\nPayments router - Stripe checkout and webhooks\n\"\"\"\n\nimport stripe\nfrom fastapi import APIRouter, Depends, HTTPException, Request, status\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select\nfrom uuid import uuid4\n\nfrom app.config import get_settings\nfrom app.database import get_db\nfrom app.models.user import User\nfrom app.models.payment import Payment\nfrom app.services.auth import get_current_user\n\nrouter = APIRouter(prefix=\"/payments\", tags=[\"payments\"])\nsettings = get_settings()\n\n# Initialize Stripe\nstripe.api_key = settings.stripe_secret_key\n\n# Plan pricing (in cents)\nPLAN_PRICES = {\n    \"basic\": 2499,  # $24.99/month\n    \"pro\": 4999,    # $49.99/month\n}\n\n\n@router.post(\"/checkout\")\nasync def create_checkout_session(\n    plan: str,\n    current_user: User = Depends(get_current_user),\n):\n    \"\"\"Create Stripe checkout session for plan upgrade\"\"\"\n    if plan not in PLAN_PRICES:\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=f\"Invalid plan. Choose from: {list(PLAN_PRICES.keys())}\"\n        )\n\n    try:\n        # Create or get Stripe customer\n        if not current_user.stripe_customer_id:\n            customer = stripe.Customer.create(\n                email=current_user.email,\n                metadata={\"user_id\": str(current_user.id)}\n            )\n            customer_id = customer.id\n        else:\n            customer_id = current_user.stripe_customer_id\n\n        # Build checkout session params\n        checkout_params = {\n            \"customer\": customer_id,\n            \"payment_method_types\": [\"card\"],\n            \"line_items\": [{\n                \"price_data\": {\n                    \"currency\": \"usd\",\n                    \"product_data\": {\n                        \"name\": f\"LOOKSMAXX {plan.title()} Plan\",\n                    },\n                    \"unit_amount\": PLAN_PRICES[plan],\n                },\n                \"quantity\": 1,\n            }],\n            \"mode\": \"payment\",\n            \"success_url\": f\"{settings.frontend_url}/payment/success?session_id={{CHECKOUT_SESSION_ID}}\",\n            \"cancel_url\": f\"{settings.frontend_url}/payment/cancel\",\n            \"metadata\": {\n                \"user_id\": str(current_user.id),\n                \"plan\": plan,\n                \"referral_code\": current_user.referral_code or \"\",\n            },\n        }\n\n        # Apply Stripe promotion code if user was referred\n        if current_user.referred_by:\n            checkout_params[\"discounts\"] = [{\n                \"promotion_code\": current_user.referred_by\n            }]\n\n        # Create checkout session\n        session = stripe.checkout.Session.create(**checkout_params)\n\n        return {\"checkout_url\": session.url, \"session_id\": session.id}\n\n    except stripe.error.StripeError as e:\n        raise HTTPException(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=str(e)\n        )\n\n\n@router.post(\"/webhook\")\nasync def stripe_webhook(request: Request, db: AsyncSession = Depends(get_db)):\n    \"\"\"Handle Stripe webhooks\"\"\"\n    payload = await request.body()\n    sig_header = request.headers.get(\"stripe-signature\")\n\n    try:\n        event = stripe.Webhook.construct_event(\n            payload, sig_header, settings.stripe_webhook_secret\n        )\n    except ValueError:\n        raise HTTPException(status_code=400, detail=\"Invalid payload\")\n    except stripe.error.SignatureVerificationError:\n        raise HTTPException(status_code=400, detail=\"Invalid signature\")\n\n    # Handle checkout.session.completed\n    if event[\"type\"] == \"checkout.session.completed\":\n        session = event[\"data\"][\"object\"]\n        user_id = session[\"metadata\"][\"user_id\"]\n        plan = session[\"metadata\"][\"plan\"]\n\n        # Update user plan\n        result = await db.execute(select(User).where(User.id == user_id))\n        user = result.scalar_one_or_none()\n\n        if user:\n            user.plan = plan\n            user.stripe_customer_id = session[\"customer\"]\n\n            # Record payment\n            payment = Payment(\n                id=uuid4(),\n                user_id=user.id,\n                stripe_payment_id=session[\"payment_intent\"],\n                stripe_session_id=session[\"id\"],\n                amount=session[\"amount_total\"],\n                currency=session[\"currency\"],\n                status=\"completed\",\n            )\n            db.add(payment)\n            await db.commit()\n\n    return {\"received\": True}\n\n\n@router.get(\"/history\")\nasync def payment_history(\n    current_user: User = Depends(get_current_user),\n    db: AsyncSession = Depends(get_db),\n):\n    \"\"\"Get payment history for current user\"\"\"\n    result = await db.execute(\n        select(Payment)\n        .where(Payment.user_id == current_user.id)\n        .order_by(Payment.created_at.desc())\n    )\n    payments = result.scalars().all()\n\n    return [\n        {\n            \"id\": str(p.id),\n            \"amount\": p.amount / 100,  # Convert cents to dollars\n            \"currency\": p.currency,\n            \"status\": p.status,\n            \"created_at\": p.created_at.isoformat(),\n        }\n        for p in payments\n    ]\n","numLines":163,"startLine":1,"totalLines":163}}}
{"parentUuid":"703f2e99-935a-47fb-840a-13de52e17b66","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YFoWgKSBwgTpnNwZNh3emp","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';\n     4→\n     5→interface User {\n     6→  id: string;\n     7→  email: string;\n     8→  name?: string;\n     9→  plan: 'free' | 'basic' | 'pro';\n    10→}\n    11→\n    12→interface AuthContextType {\n    13→  user: User | null;\n    14→  token: string | null;\n    15→  isLoading: boolean;\n    16→  isAuthenticated: boolean;\n    17→  login: (email: string, password: string) => Promise<void>;\n    18→  register: (email: string, password: string, name?: string) => Promise<void>;\n    19→  logout: () => void;\n    20→}\n    21→\n    22→const AuthContext = createContext<AuthContextType | undefined>(undefined);\n    23→\n    24→const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';\n    25→\n    26→export function AuthProvider({ children }: { children: React.ReactNode }) {\n    27→  const [user, setUser] = useState<User | null>(null);\n    28→  const [token, setToken] = useState<string | null>(null);\n    29→  const [isLoading, setIsLoading] = useState(true);\n    30→\n    31→  // Check for existing token on mount\n    32→  useEffect(() => {\n    33→    const storedToken = localStorage.getItem('auth_token');\n    34→    if (storedToken) {\n    35→      setToken(storedToken);\n    36→      fetchUser(storedToken);\n    37→    } else {\n    38→      setIsLoading(false);\n    39→    }\n    40→  }, []);\n    41→\n    42→  const fetchUser = async (authToken: string) => {\n    43→    try {\n    44→      const response = await fetch(`${API_URL}/auth/me`, {\n    45→        headers: {\n    46→          Authorization: `Bearer ${authToken}`,\n    47→        },\n    48→      });\n    49→\n    50→      if (response.ok) {\n    51→        const userData = await response.json();\n    52→        setUser(userData);\n    53→      } else {\n    54→        // Token is invalid, clear it\n    55→        localStorage.removeItem('auth_token');\n    56→        setToken(null);\n    57→      }\n    58→    } catch (error) {\n    59→      console.error('[Auth] Failed to fetch user:', error);\n    60→      localStorage.removeItem('auth_token');\n    61→      setToken(null);\n    62→    } finally {\n    63→      setIsLoading(false);\n    64→    }\n    65→  };\n    66→\n    67→  const login = useCallback(async (email: string, password: string) => {\n    68→    const response = await fetch(`${API_URL}/auth/login`, {\n    69→      method: 'POST',\n    70→      headers: {\n    71→        'Content-Type': 'application/json',\n    72→      },\n    73→      body: JSON.stringify({ email, password }),\n    74→    });\n    75→\n    76→    if (!response.ok) {\n    77→      const error = await response.json();\n    78→      throw new Error(error.detail || 'Login failed');\n    79→    }\n    80→\n    81→    const data = await response.json();\n    82→    setToken(data.access_token);\n    83→    localStorage.setItem('auth_token', data.access_token);\n    84→\n    85→    // Fetch user details\n    86→    await fetchUser(data.access_token);\n    87→  }, []);\n    88→\n    89→  const register = useCallback(async (email: string, password: string, name?: string) => {\n    90→    const response = await fetch(`${API_URL}/auth/register`, {\n    91→      method: 'POST',\n    92→      headers: {\n    93→        'Content-Type': 'application/json',\n    94→      },\n    95→      body: JSON.stringify({ email, password, name }),\n    96→    });\n    97→\n    98→    if (!response.ok) {\n    99→      const error = await response.json();\n   100→      throw new Error(error.detail || 'Registration failed');\n   101→    }\n   102→\n   103→    const data = await response.json();\n   104→    setToken(data.access_token);\n   105→    localStorage.setItem('auth_token', data.access_token);\n   106→\n   107→    // Fetch user details\n   108→    await fetchUser(data.access_token);\n   109→  }, []);\n   110→\n   111→  const logout = useCallback(() => {\n   112→    setUser(null);\n   113→    setToken(null);\n   114→    localStorage.removeItem('auth_token');\n   115→  }, []);\n   116→\n   117→  return (\n   118→    <AuthContext.Provider\n   119→      value={{\n   120→        user,\n   121→        token,\n   122→        isLoading,\n   123→        isAuthenticated: !!user,\n   124→        login,\n   125→        register,\n   126→        logout,\n   127→      }}\n   128→    >\n   129→      {children}\n   130→    </AuthContext.Provider>\n   131→  );\n   132→}\n   133→\n   134→export function useAuth() {\n   135→  const context = useContext(AuthContext);\n   136→  if (context === undefined) {\n   137→    throw new Error('useAuth must be used within an AuthProvider');\n   138→  }\n   139→  return context;\n   140→}\n   141→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"07c22371-4ef8-4a3e-8c4e-d9641a5cf520","timestamp":"2025-12-25T23:23:27.900Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/AuthContext.tsx","content":"'use client';\n\nimport React, { createContext, useContext, useState, useEffect, useCallback } from 'react';\n\ninterface User {\n  id: string;\n  email: string;\n  name?: string;\n  plan: 'free' | 'basic' | 'pro';\n}\n\ninterface AuthContextType {\n  user: User | null;\n  token: string | null;\n  isLoading: boolean;\n  isAuthenticated: boolean;\n  login: (email: string, password: string) => Promise<void>;\n  register: (email: string, password: string, name?: string) => Promise<void>;\n  logout: () => void;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nconst API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [user, setUser] = useState<User | null>(null);\n  const [token, setToken] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // Check for existing token on mount\n  useEffect(() => {\n    const storedToken = localStorage.getItem('auth_token');\n    if (storedToken) {\n      setToken(storedToken);\n      fetchUser(storedToken);\n    } else {\n      setIsLoading(false);\n    }\n  }, []);\n\n  const fetchUser = async (authToken: string) => {\n    try {\n      const response = await fetch(`${API_URL}/auth/me`, {\n        headers: {\n          Authorization: `Bearer ${authToken}`,\n        },\n      });\n\n      if (response.ok) {\n        const userData = await response.json();\n        setUser(userData);\n      } else {\n        // Token is invalid, clear it\n        localStorage.removeItem('auth_token');\n        setToken(null);\n      }\n    } catch (error) {\n      console.error('[Auth] Failed to fetch user:', error);\n      localStorage.removeItem('auth_token');\n      setToken(null);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const login = useCallback(async (email: string, password: string) => {\n    const response = await fetch(`${API_URL}/auth/login`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({ email, password }),\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      throw new Error(error.detail || 'Login failed');\n    }\n\n    const data = await response.json();\n    setToken(data.access_token);\n    localStorage.setItem('auth_token', data.access_token);\n\n    // Fetch user details\n    await fetchUser(data.access_token);\n  }, []);\n\n  const register = useCallback(async (email: string, password: string, name?: string) => {\n    const response = await fetch(`${API_URL}/auth/register`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({ email, password, name }),\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      throw new Error(error.detail || 'Registration failed');\n    }\n\n    const data = await response.json();\n    setToken(data.access_token);\n    localStorage.setItem('auth_token', data.access_token);\n\n    // Fetch user details\n    await fetchUser(data.access_token);\n  }, []);\n\n  const logout = useCallback(() => {\n    setUser(null);\n    setToken(null);\n    localStorage.removeItem('auth_token');\n  }, []);\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user,\n        token,\n        isLoading,\n        isAuthenticated: !!user,\n        login,\n        register,\n        logout,\n      }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n}\n","numLines":141,"startLine":1,"totalLines":141}}}
{"parentUuid":"07c22371-4ef8-4a3e-8c4e-d9641a5cf520","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"9ef504ee-e86a-4062-a25e-b90107ea7ce2","version":"2.0.76","gitBranch":"main","agentId":"a2ad0f9","slug":"shiny-wondering-bentley","message":{"model":"claude-opus-4-5-20251101","id":"msg_01N58DdvGtvr3Ge8kUNeMZ2N","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a comprehensive understanding of the codebase. Let me compile the detailed implementation plan for the PSL Enhancement System.\n\n---\n\n# PSL Enhancement System - Implementation Plan\n\n## Executive Summary\n\nThis document provides a comprehensive implementation plan for integrating the PSL (Pretty Scale Level) Enhancement System into the LOOKSMAXX application. The system adds height-aware scoring, archetype classification, AI vision feature extraction, and personalized advice generation.\n\n---\n\n## 1. Architecture Analysis & Integration Points\n\n### 1.1 Current System Overview\n\n**Existing Frontend Architecture:**\n- `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx` - Central results state with 70+ metrics, existing `pslRating` computed from `harmonyToPSL()`\n- `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/calculator.ts` - Core scoring with `convertToPSL()` function (line 659-705) - currently converts harmony to a simplified 3.0-7.5 PSL range\n- `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx` - Tab navigation system (lines 35-44) with 8 existing tabs\n\n**Existing Backend Architecture:**\n- `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/user.py` - User model with `plan` enum (free/basic/pro)\n- `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/analysis.py` - Analysis model storing landmarks, scores, gender, ethnicity\n- `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/payments.py` - Stripe integration for plan upgrades\n\n### 1.2 Key Integration Points\n\n| Integration Point | Existing Code | Modification Required |\n|-------------------|---------------|----------------------|\n| **Height Input** | `/src/app/gender/page.tsx` onboarding flow | Add new `/height` page after ethnicity |\n| **Face Score** | `ResultsContext.overallScore` | Feed into PSL calculator as `faceScore` |\n| **PSL Display** | `ResultsLayout.TABS` array (line 35) | Add `psl`, `archetype`, `advice` tabs |\n| **Paid Features** | `AuthContext.user.plan` | Gate AI Vision and Advice tabs |\n| **API Client** | `/src/lib/api.ts` | Add PSL/Vision/Archetype methods |\n| **Database** | `Analysis` model | Add height_cm, psl_score, archetype columns |\n\n### 1.3 Data Flow\n\n```\nExisting Flow:\n  Gender -> Ethnicity -> Upload -> Analysis -> Results (Face Score)\n\nNew Flow:\n  Gender -> Ethnicity -> Height -> Upload -> Analysis -> Results (PSL Score)\n                                                              |\n                                                              v\n                                        [Free: PSL + Archetype] [Paid: AI Vision + Advice]\n```\n\n---\n\n## 2. Reusable Components Analysis\n\n### 2.1 Components to Leverage\n\n| Existing Component | Location | Reuse For |\n|-------------------|----------|-----------|\n| `ScoreCircle` / `ScoreBar` | `/src/components/results/shared/` | PSL score visualization |\n| `RecommendationCard` | `/src/components/results/cards/` | Hairstyle/Skincare cards |\n| `TabContent` wrapper | `/src/components/results/ResultsLayout.tsx` | PSL/Archetype/Advice tabs |\n| `ProfileScoreCard` | `/src/components/results/tabs/OverviewTab.tsx` | PSL breakdown cards |\n| `MetricInsightCard` | `/src/components/results/tabs/OverviewTab.tsx` | Archetype trait cards |\n| `RankBadge` | `/src/components/results/shared/RankBadge.tsx` | Tier badge component |\n\n### 2.2 Patterns to Follow\n\n**Context Pattern** (from ResultsContext.tsx):\n```typescript\n// PSLContext should follow same pattern\nconst PSLContext = createContext<PSLContextType | null>(null);\nexport function usePSL(): PSLContextType { ... }\nexport function PSLProvider({ children }: PSLProviderProps) { ... }\n```\n\n**API Client Pattern** (from api.ts):\n```typescript\n// Add to ApiClient class\nasync calculatePSL(data: { analysis_id: string; height_cm: number }): Promise<PSLResult> {\n  return this.request('/psl/calculate', { method: 'POST', body: data });\n}\n```\n\n**Tab Pattern** (from ResultsLayout.tsx):\n```typescript\n// Add to TABS array\n{ id: 'psl', label: 'PSL Score', icon: <Gauge size={18} /> },\n{ id: 'archetype', label: 'Archetype', icon: <Shapes size={18} /> },\n{ id: 'advice', label: 'AI Advice', icon: <Lightbulb size={18} />, paid: true },\n```\n\n---\n\n## 3. Implementation Phases\n\n### Phase 1: PSL Calculator + Height Input (Week 1)\n\n**Goal:** Implement the enhanced PSL formula with height integration.\n\n#### 3.1.1 Frontend Changes\n\n**New Files:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/height/page.tsx` - Height input page\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/HeightContext.tsx` - Height state management\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/psl-calculator.ts` - PSL calculation logic\n4. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/psl.ts` - PSL type definitions\n5. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/PSLScoreCard.tsx` - Main PSL display\n6. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/PSLBreakdown.tsx` - Component breakdown\n7. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/PSLTierBadge.tsx` - Tier visualization\n8. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PSLTab.tsx` - PSL results tab\n\n**Files to Modify:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/ethnicity/page.tsx` - Update navigation to `/height`\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx` - Add PSL tab\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx` - Add height, PSL fields\n4. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts` - Add 'psl' to ResultsTab union\n\n**Height Input Page Design:**\n```typescript\n// height/page.tsx structure\ninterface HeightInputState {\n  unit: 'cm' | 'ft-in';\n  valueCm: number;\n  valueFeet: number;\n  valueInches: number;\n}\n\n// UI: Slider or number input\n// Range: 140-210cm for metric, 4'7\" - 6'11\" for imperial\n// Continue button navigates to /upload\n```\n\n**PSL Calculator Implementation:**\n```typescript\n// psl-calculator.ts - Key functions\nexport function calculatePSL(input: PSLInput): PSLResult\nexport function getHeightRating(heightCm: number, gender: Gender): number\nexport function getBodyRating(bodyFat: number, muscle: MuscleLevel): number\nexport function classifyTier(score: number, height: number, failos?: string[]): TierInfo\nexport function calculateBonuses(face: number, height: number, body: number): BonusResult\n```\n\n**Height Rating Lookup Table:**\n```typescript\nconst HEIGHT_RATINGS_MALE: [number, number][] = [\n  [160, 1.0], [165, 3.0], [170, 4.0], [175, 5.0], [178, 5.5],\n  [180, 6.0], [183, 7.0], [185, 7.5], [188, 8.0], [190, 8.5],\n  [193, 9.0], [196, 9.5]\n];\n\nconst HEIGHT_RATINGS_FEMALE: [number, number][] = [\n  [150, 2.0], [155, 3.5], [160, 5.0], [165, 6.0], [168, 6.5],\n  [170, 7.0], [173, 7.5], [175, 8.0], [178, 8.5], [180, 9.0]\n];\n```\n\n#### 3.1.2 Backend Changes\n\n**New Files:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/psl.py` - PSL endpoints\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/services/psl_service.py` - PSL calculation service\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/schemas/psl.py` - Pydantic schemas\n\n**Files to Modify:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/user.py` - Add `height_cm` column\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/analysis.py` - Add PSL score fields\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/main.py` - Register PSL router\n\n**Database Migration:**\n```sql\n-- Migration: add_psl_fields\nALTER TABLE users ADD COLUMN height_cm INTEGER;\n\nALTER TABLE analyses ADD COLUMN psl_score DECIMAL(4,2);\nALTER TABLE analyses ADD COLUMN psl_tier VARCHAR(20);\nALTER TABLE analyses ADD COLUMN psl_breakdown JSONB;\n```\n\n**API Endpoints:**\n| Endpoint | Method | Auth | Description |\n|----------|--------|------|-------------|\n| `/psl/calculate` | POST | Yes | Calculate PSL from face + height |\n| `/psl/{analysis_id}` | GET | Yes | Get stored PSL score |\n| `/users/height` | PUT | Yes | Update user's height |\n\n---\n\n### Phase 2: Archetype Classification (Week 2)\n\n**Goal:** Implement rule-based archetype classification with 27 sub-archetypes.\n\n#### 3.2.1 Frontend Changes\n\n**New Files:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/archetype-classifier.ts` - Classification logic\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/data/archetypes.json` - Archetype definitions\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/archetype/ArchetypeCard.tsx`\n4. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/archetype/ArchetypeTraits.tsx`\n5. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/archetype/ArchetypeComparison.tsx`\n6. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/ArchetypeTab.tsx`\n\n**Files to Modify:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx` - Add archetype tab\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts` - Add 'archetype' to ResultsTab\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/psl.ts` - Add archetype types\n\n**Archetype Classifier Implementation:**\n```typescript\n// archetype-classifier.ts\nexport interface ClassificationInput {\n  gonialAngle: number;        // From existing landmarks\n  fwhr: number;               // Face width-to-height\n  browRidgeProminence: number;\n  cheekboneHeight: number;\n  eyeAreaScore: number;\n  ethnicity: Ethnicity;\n  gender: Gender;\n  bodyType?: BodyType;        // From AI vision (optional)\n}\n\nexport interface ArchetypeResult {\n  primary: { category: string; subArchetype: string; confidence: number };\n  secondary: { category: string; subArchetype: string; confidence: number };\n  traits: string[];\n  styleGuide: StyleRecommendation;\n  transitionPath?: { target: string; requirements: string[] };\n}\n\nexport function classifyArchetype(input: ClassificationInput): ArchetypeResult;\nexport function computeDimorphismLevel(gonial: number, brow: number, jaw: number): DimorphismLevel;\n```\n\n**Key Metrics for Classification (from existing landmarks):**\n- `gonialAngle` - Already computed in side profile analysis\n- `faceWidthToHeight` - Exists in front profile (`fwhr`)\n- `browRidgeProminence` - Can be derived from `nasofrontalAngle`\n- `cheekboneHeight` - Exists as `cheekboneHeight` metric\n- `eyeAreaScore` - Composite of `lateralCanthalTilt`, `eyeAspectRatio`\n\n#### 3.2.2 Backend Changes\n\n**New Files:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/services/archetype_service.py`\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/data/archetypes.json`\n\n**Files to Modify:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/psl.py` - Add archetype endpoints\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/analysis.py` - Add archetype fields\n\n**Database Migration:**\n```sql\n-- Migration: add_archetype_fields\nALTER TABLE analyses ADD COLUMN archetype_primary VARCHAR(50);\nALTER TABLE analyses ADD COLUMN archetype_secondary VARCHAR(50);\nALTER TABLE analyses ADD COLUMN archetype_confidence DECIMAL(3,2);\nALTER TABLE analyses ADD COLUMN archetype_traits JSONB;\n```\n\n---\n\n### Phase 3: AI Vision Integration (Week 3)\n\n**Goal:** Implement Claude Vision API for soft tissue feature extraction (paid feature).\n\n#### 3.3.1 Backend Changes (Primary)\n\n**New Files:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/services/vision_service.py` - Claude Vision integration\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/vision.py` - Vision endpoints\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/schemas/vision.py` - Vision schemas\n4. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/vision_extraction.py` - Vision model\n\n**Vision Service Implementation:**\n```python\n# vision_service.py\nimport anthropic\nfrom typing import Optional\n\nclass VisionService:\n    def __init__(self):\n        self.client = anthropic.Anthropic()\n        self.model = \"claude-sonnet-4-20250514\"\n    \n    async def extract_features(\n        self,\n        front_photo_base64: str,\n        side_photo_base64: Optional[str] = None,\n        physique_photo_base64: Optional[str] = None\n    ) -> VisionExtractionResult:\n        # Build message with images\n        content = [\n            {\"type\": \"image\", \"source\": {\"type\": \"base64\", \"media_type\": \"image/jpeg\", \"data\": front_photo_base64}},\n            {\"type\": \"text\", \"text\": FACE_ANALYSIS_PROMPT}\n        ]\n        \n        response = await self.client.messages.create(\n            model=self.model,\n            max_tokens=1024,\n            messages=[{\"role\": \"user\", \"content\": content}]\n        )\n        \n        return parse_vision_response(response.content[0].text)\n```\n\n**Database Migration:**\n```sql\n-- Migration: add_vision_extractions\nCREATE TABLE vision_extractions (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    analysis_id UUID NOT NULL REFERENCES analyses(id) ON DELETE CASCADE,\n    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    \n    -- Face features\n    skin_clarity DECIMAL(3,2),\n    skin_tone VARCHAR(50),\n    acne_level VARCHAR(20),\n    hairline_nw INTEGER,\n    hair_density VARCHAR(20),\n    hair_texture VARCHAR(20),\n    eye_color VARCHAR(50),\n    hollow_cheeks DECIMAL(3,2),\n    teeth_color VARCHAR(20),\n    \n    -- Body features (optional)\n    body_fat_percent DECIMAL(4,1),\n    muscle_mass VARCHAR(20),\n    frame_size VARCHAR(20),\n    \n    -- Metadata\n    raw_response JSONB,\n    created_at TIMESTAMP DEFAULT NOW(),\n    \n    UNIQUE(analysis_id)\n);\n\nCREATE INDEX idx_vision_extractions_analysis ON vision_extractions(analysis_id);\n```\n\n**API Endpoints:**\n| Endpoint | Method | Auth | Paid | Description |\n|----------|--------|------|------|-------------|\n| `/vision/extract` | POST | Yes | Yes | Extract features from photos |\n| `/vision/{analysis_id}` | GET | Yes | Yes | Get cached vision extraction |\n\n#### 3.3.2 Frontend Changes\n\n**New Files:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/shared/PaywallOverlay.tsx`\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/shared/FeatureCard.tsx`\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/hooks/usePaidFeature.ts` - Paywall hook\n\n**Files to Modify:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/api.ts` - Add vision methods\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/PSLContext.tsx` - Add vision state\n\n**Paywall Hook:**\n```typescript\n// usePaidFeature.ts\nexport function usePaidFeature(feature: 'vision' | 'advice' | 'archetype_enhanced') {\n  const { user } = useAuth();\n  const isPaid = user?.plan === 'basic' || user?.plan === 'pro';\n  const canAccess = feature === 'archetype_enhanced' ? true : isPaid;\n  \n  return {\n    canAccess,\n    isPaid,\n    showPaywall: !canAccess,\n    upgradePlan: () => { /* Navigate to payment */ }\n  };\n}\n```\n\n---\n\n### Phase 4: Advice Engine (Week 4)\n\n**Goal:** Implement hairstyle, skincare, style guide, and action plan generation.\n\n#### 3.4.1 Backend Changes\n\n**New Files:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/services/advice_service.py`\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/routers/advice.py`\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/data/hairstyles.json`\n4. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/data/skincare.json`\n5. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/data/style_guides.json`\n\n**Hairstyle Database Structure:**\n```json\n{\n  \"hairstyles\": [\n    {\n      \"id\": \"textured-fringe\",\n      \"name\": \"Textured Fringe\",\n      \"face_shapes\": [\"oblong\", \"heart\", \"diamond\"],\n      \"hairline_max_nw\": 2,\n      \"hair_textures\": [\"straight\", \"wavy\"],\n      \"archetypes\": [\"Prettyboy\", \"Softboy\"],\n      \"maintenance\": \"medium\",\n      \"products\": [\"texturizing paste\", \"sea salt spray\"],\n      \"reference_images\": [\"url1\", \"url2\"]\n    }\n  ]\n}\n```\n\n**API Endpoints:**\n| Endpoint | Method | Auth | Paid | Description |\n|----------|--------|------|------|-------------|\n| `/advice/generate` | POST | Yes | Yes | Generate full advice package |\n| `/advice/hairstyles` | GET | Yes | Yes | Get hairstyle recommendations |\n| `/advice/skincare` | GET | Yes | Yes | Get skincare routine |\n| `/advice/style` | GET | Yes | Yes | Get style guide |\n| `/advice/action-plan` | GET | Yes | Yes | Get prioritized action plan |\n\n#### 3.4.2 Frontend Changes\n\n**New Files:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/advice/HairstyleRecommendations.tsx`\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/advice/SkincareRoutine.tsx`\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/advice/StyleGuide.tsx`\n4. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/psl/advice/ActionPlan.tsx`\n5. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/AdviceTab.tsx`\n\n**Files to Modify:**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx` - Add advice tab\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts` - Add 'advice' to ResultsTab\n\n---\n\n### Phase 5: Action Plan & Polish (Week 5-6)\n\n**Goal:** Integrate action plan with existing recommendations, polish UI, add analytics.\n\n#### 3.5.1 Integration Tasks\n\n1. **Merge Action Plan with Existing Plan Tab:**\n   - Modify `/src/components/results/tabs/PlanTab.tsx`\n   - Add action plan items alongside existing recommendations\n   - Show PSL potential improvement for each action\n\n2. **Add PSL Context to Overview Tab:**\n   - Modify `/src/components/results/tabs/OverviewTab.tsx`\n   - Add PSL score summary card\n   - Add archetype quick preview\n\n3. **Caching Strategy:**\n   - Vision extractions: Cache indefinitely (stored in DB)\n   - PSL scores: Recalculate if height changes\n   - Archetype: Recalculate if new analysis\n\n4. **Analytics Integration:**\n   - Track tab views (PSL, Archetype, Advice)\n   - Track conversion from free to paid\n   - Track action plan completion\n\n---\n\n## 4. Technical Decisions\n\n### 4.1 PSL Calculation: Client-Side vs Server-Side\n\n**Recommendation: Hybrid Approach**\n\n| Calculation | Location | Reason |\n|-------------|----------|--------|\n| Basic PSL (face + height) | Client-side | Instant updates, no API latency |\n| Full PSL (with body) | Server-side | Requires AI Vision data |\n| Archetype (rule-based) | Client-side | Deterministic, uses existing metrics |\n| Archetype (AI-enhanced) | Server-side | Uses Claude for edge cases |\n\n**Implementation:**\n```typescript\n// Client-side in psl-calculator.ts\nexport function calculateBasicPSL(faceScore: number, heightCm: number, gender: Gender): PSLResult\n\n// Server-side via API\nexport async function calculateFullPSL(analysisId: string): Promise<PSLResult>\n```\n\n### 4.2 Free vs Paid Tier Split\n\n| Feature | Free | Basic | Pro |\n|---------|------|-------|-----|\n| Face Analysis (70+ metrics) | Yes | Yes | Yes |\n| Basic PSL (face + height) | Yes | Yes | Yes |\n| Archetype (rule-based) | Yes | Yes | Yes |\n| AI Vision Extraction | No | Yes | Yes |\n| Full PSL (with body) | No | Yes | Yes |\n| Hairstyle Recommendations | No | Yes | Yes |\n| Skincare Routine | No | Yes | Yes |\n| Style Guide | No | Yes | Yes |\n| Action Plan | No | Yes | Yes |\n| Unlimited Re-analyses | No | No | Yes |\n\n**Tab Visibility:**\n```typescript\nconst TABS: TabConfig[] = [\n  // ... existing tabs\n  { id: 'psl', label: 'PSL Score', icon: <Gauge />, paid: false },\n  { id: 'archetype', label: 'Archetype', icon: <Shapes />, paid: false },\n  { id: 'advice', label: 'AI Advice', icon: <Lightbulb />, paid: true, minPlan: 'basic' },\n];\n```\n\n### 4.3 Caching Strategy\n\n| Data | Cache Location | TTL | Invalidation |\n|------|----------------|-----|--------------|\n| Vision Extraction | PostgreSQL | Permanent | Photo update |\n| PSL Score | PostgreSQL | Permanent | Height update |\n| Archetype | PostgreSQL | Permanent | New analysis |\n| Hairstyle Data | JSON file | App deploy | Manual |\n| Skincare Data | JSON file | App deploy | Manual |\n\n---\n\n## 5. Risk Assessment\n\n### 5.1 Technical Risks\n\n| Risk | Severity | Mitigation |\n|------|----------|------------|\n| Claude Vision API costs | Medium | Cache results, one-time per analysis |\n| API rate limits | Low | Queue requests, retry with backoff |\n| Complex archetype logic | Medium | Comprehensive test suite |\n| Mobile performance | Medium | Lazy load advice tab, optimize images |\n\n### 5.2 Cost Analysis\n\n| Service | Cost/Call | Calls/User | Monthly @ 1000 users |\n|---------|-----------|------------|---------------------|\n| Claude Vision (face) | ~$0.015 | 1 | $15 |\n| Claude Vision (body) | ~$0.01 | 0.3 | $3 |\n| **Total API Cost** | | | **$18/month** |\n\nWith $24.99/month basic plan, margin is ~99% on API costs.\n\n### 5.3 Breaking Changes\n\n| Change | Impact | Migration |\n|--------|--------|-----------|\n| Height field required | Medium | Make optional, prompt on results page |\n| New ResultsTab values | Low | Add to union type, backwards compatible |\n| New database columns | Low | Nullable columns, no data loss |\n\n---\n\n## 6. File Summary\n\n### 6.1 New Files to Create\n\n**Frontend (18 files):**\n```\nlooksmaxx-app/src/\n├── app/height/page.tsx\n├── contexts/HeightContext.tsx\n├── lib/psl-calculator.ts\n├── lib/archetype-classifier.ts\n├── types/psl.ts\n├── data/archetypes.json\n├── hooks/usePaidFeature.ts\n├── components/psl/\n│   ├── PSLScoreCard.tsx\n│   ├── PSLBreakdown.tsx\n│   ├── PSLTierBadge.tsx\n│   ├── archetype/\n│   │   ├── ArchetypeCard.tsx\n│   │   ├── ArchetypeTraits.tsx\n│   │   └── ArchetypeComparison.tsx\n│   ├── advice/\n│   │   ├── HairstyleRecommendations.tsx\n│   │   ├── SkincareRoutine.tsx\n│   │   ├── StyleGuide.tsx\n│   │   └── ActionPlan.tsx\n│   └── shared/\n│       ├── PaywallOverlay.tsx\n│       └── FeatureCard.tsx\n└── components/results/tabs/\n    ├── PSLTab.tsx\n    ├── ArchetypeTab.tsx\n    └── AdviceTab.tsx\n```\n\n**Backend (12 files):**\n```\nlooksmaxx-api/app/\n├── routers/\n│   ├── psl.py\n│   ├── vision.py\n│   └── advice.py\n├── services/\n│   ├── psl_service.py\n│   ├── vision_service.py\n│   ├── archetype_service.py\n│   └── advice_service.py\n├── schemas/\n│   ├── psl.py\n│   └── vision.py\n├── models/\n│   └── vision_extraction.py\n└── data/\n    ├── archetypes.json\n    ├── hairstyles.json\n    ├── skincare.json\n    └── style_guides.json\n```\n\n### 6.2 Files to Modify\n\n**Frontend (8 files):**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/ethnicity/page.tsx` - Navigation to height\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx` - Add tabs\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx` - Add PSL state\n4. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/types/results.ts` - Add tab types\n5. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/api.ts` - Add PSL/Vision methods\n6. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/OverviewTab.tsx` - Add PSL preview\n7. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/tabs/PlanTab.tsx` - Integrate action plan\n8. `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/app/layout.tsx` - Add HeightContext provider\n\n**Backend (4 files):**\n1. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/user.py` - Add height_cm\n2. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/analysis.py` - Add PSL/archetype fields\n3. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/main.py` - Register routers\n4. `/Users/imorgado/LOOKSMAXX/looksmaxx-api/requirements.txt` - Add anthropic SDK\n\n---\n\n### Critical Files for Implementation\n\n1. **`/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/scoring/calculator.ts`** - Contains existing `convertToPSL()` function (line 659) that will be replaced with the new PSL calculator; also has all scoring utilities to reuse\n\n2. **`/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx`** - Central state management with 1380 lines; contains existing `pslRating` field and `harmonyToPSL()` usage that will be enhanced with full PSL calculation\n\n3. **`/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/ResultsLayout.tsx`** - Tab navigation system (TABS array on line 35-44); must be modified to add PSL/Archetype/Advice tabs\n\n4. **`/Users/imorgado/LOOKSMAXX/looksmaxx-api/app/models/user.py`** - User model that needs `height_cm` column; also has `plan` enum for paywall logic\n\n5. **`/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/lib/api.ts`** - API client with 725 lines; pattern for adding PSL/Vision/Advice endpoints; contains existing transform functions for snake_case to camelCase"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3924,"cache_read_input_tokens":110063,"cache_creation":{"ephemeral_5m_input_tokens":3924,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWUGRQDuUZNfuZLJkaM89","type":"assistant","uuid":"a87fd1fe-d5ed-444a-bdc8-13978f02807e","timestamp":"2025-12-25T23:25:56.630Z"}
