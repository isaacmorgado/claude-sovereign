{"type":"file-history-snapshot","messageId":"92a13c74-e4a0-4ceb-a163-200dc412f1b2","snapshot":{"messageId":"92a13c74-e4a0-4ceb-a163-200dc412f1b2","trackedFileBackups":{},"timestamp":"2025-12-21T14:29:03.919Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","type":"user","message":{"role":"user","content":"Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to."},"isMeta":true,"uuid":"87c14ec4-76a8-4392-9d1b-15d27f3baff3","timestamp":"2025-12-21T14:29:03.917Z"}
{"parentUuid":"87c14ec4-76a8-4392-9d1b-15d27f3baff3","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","type":"user","message":{"role":"user","content":"<command-name>/clear</command-name>\n            <command-message>clear</command-message>\n            <command-args></command-args>"},"uuid":"92a13c74-e4a0-4ceb-a163-200dc412f1b2","timestamp":"2025-12-21T14:29:03.907Z"}
{"parentUuid":"92a13c74-e4a0-4ceb-a163-200dc412f1b2","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","type":"user","message":{"role":"user","content":"<local-command-stdout></local-command-stdout>"},"uuid":"dff2ce8d-379a-49ce-944e-156590f3f539","timestamp":"2025-12-21T14:29:03.917Z"}
{"type":"file-history-snapshot","messageId":"4aa3c16b-2382-4f77-ba0c-94cc210c42f1","snapshot":{"messageId":"4aa3c16b-2382-4f77-ba0c-94cc210c42f1","trackedFileBackups":{},"timestamp":"2025-12-21T14:29:36.760Z"},"isSnapshotUpdate":false}
{"parentUuid":"dff2ce8d-379a-49ce-944e-156590f3f539","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","type":"user","message":{"role":"user","content":"Spawn an exlore agent to analyze the current results page and studies. The studies being cited are in the incorrect positions"},"uuid":"4aa3c16b-2382-4f77-ba0c-94cc210c42f1","timestamp":"2025-12-21T14:29:36.755Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]}}
{"parentUuid":"4aa3c16b-2382-4f77-ba0c-94cc210c42f1","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_016ZMgmNCNiBADX2M6quKfMJ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to analyze the results page and the studies/citations that are being displayed in incorrect positions. Let me spawn an explore agent to investigate this issue.","signature":"EtoCCkYIChgCKkDUr+AaX2+sxp56DtX366zrFiUYEMRWcmn+jYgJTDRl00F8kHv58URnI/0CID6XRHPuUiGLmbR1ewKdoAQtHL4BEgzya0QfXFxDb8PKbmMaDPlN1us6eQDcMcfcOSIwXJY5dxmwjkgw6u4VoNHi2hhzKo4IXahg1twUZ8RJyypcWTO7pYnP1DwThB0uQq1DKsEBGAqsFY0P9mJ18oRS8dJaHKCoDdBSf9Fow7p9nr3afg/XfTdW7WEWxAFG8TsaidQDFlvOukPyglU7WYieZlgujooiKZqL3R4wZf+KK7FE5ds3Bp/+o2nKd/gs7jYCN8tZ9AjavjRjGAJrlmIIUiRc56LMu+E+akTg6kGD0HdMp8Yrfk/2dzVMs7b82+nkjd3Uun7NH6E6XpdxQCE0Yf+zkJhRYY5eQFqHiQRC6NU44EaDJ1xGwQBq6gHP78pH9osx4RgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":20866,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":20866,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWKzUFrZex7nawEK9ArjL","type":"assistant","uuid":"4e1d8376-84ad-48b5-8f3b-38f49b3f5b5b","timestamp":"2025-12-21T14:29:42.133Z"}
{"parentUuid":"4e1d8376-84ad-48b5-8f3b-38f49b3f5b5b","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_016ZMgmNCNiBADX2M6quKfMJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01J5ZyzaYux5U8nx46kNhGAo","name":"Task","input":{"subagent_type":"Explore","prompt":"Analyze the results page and research citations system in this Next.js facial analysis app. The user reports that studies are being cited in incorrect positions.\n\nFocus on:\n1. How citations/studies are defined - look for RESEARCH_CITATIONS or similar\n2. How citations are matched to recommendations or displayed\n3. The EnhancedRecommendationCard.tsx component that displays citations\n4. The ResultsContext.tsx for any citation-related logic\n5. Any filtering logic for gender/ethnicity that might cause mismatches\n\nFind the root cause of why studies might appear in wrong positions. Look at the data structures, filtering logic, and rendering code.","description":"Analyze citations system"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":20866,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":20866,"ephemeral_1h_input_tokens":0},"output_tokens":274,"service_tier":"standard"}},"requestId":"req_011CWKzUFrZex7nawEK9ArjL","type":"assistant","uuid":"f0d78cf3-bfc3-42b0-b839-8b5f9222c4c6","timestamp":"2025-12-21T14:29:46.064Z"}
{"parentUuid":"f0d78cf3-bfc3-42b0-b839-8b5f9222c4c6","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01J5ZyzaYux5U8nx46kNhGAo","type":"tool_result","content":[{"type":"text","text":"Perfect! Now I have a clear picture. Let me create a comprehensive analysis document of the citation issues:\n\n## Root Cause Analysis: Research Citations in Wrong Positions\n\nBased on my thorough analysis of the code, I've identified the key issues causing studies to be cited in incorrect positions.\n\n### Key Findings:\n\n**1. PROCEDURE DATABASE vs RESEARCH CITATIONS MISMATCH**\n\nThe PROCEDURE_DATABASE in ResultsContext.tsx defines these ref_ids:\n- **Surgical**: SUR-01 through SUR-08 (8 procedures)\n- **Minimally Invasive**: MIN-01 through MIN-06 (6 procedures)  \n- **Foundational**: FND-01 through FND-05 (5 procedures)\n\nThe RESEARCH_CITATIONS in EnhancedRecommendationCard.tsx references these procedure types:\n- SUR-01, SUR-02, SUR-03, SUR-04, SUR-05, SUR-06, MIN-01 through MIN-07, FND-01 through FND-07\n\n**Issue**: MIN-07 and FND-06, FND-07 are cited but don't exist in the PROCEDURE_DATABASE!\n\n**2. CITATION MATCHING LOGIC**\n\nFile: `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx`\n\nThe `getRelevantCitations()` function (lines 225-252):\n```typescript\nfunction getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  return RESEARCH_CITATIONS.filter(citation => {\n    // Must match the procedure\n    if (!citation.procedureRefs.includes(procedureRefId)) return false;\n\n    // Check gender relevance\n    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {\n      if (citation.genderRelevance !== gender) return false;\n    }\n\n    // Check ethnicity relevance\n    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {\n      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation\n      if (!citation.ethnicityRelevance.includes(ethnicity)) {\n        // Only exclude if the citation is ethnicity-specific\n        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  }).slice(0, 3); // Limit to 3 most relevant citations\n}\n```\n\n**Problems with this logic**:\n\n1. **No priority/ranking system**: All matching citations are treated equally. When a procedure appears in multiple citation procedureRefs arrays, there's no way to guarantee the most relevant one shows first.\n\n2. **Ethnicity filtering is vague** (lines 240-248): \n   - The logic \"only exclude if ethnicityRelevance.length > 0 && < 6\" is unclear\n   - This means citations with 1-5 ethnicities get filtered strictly, but citations with 6+ ethnicities (like \"all ethnicities\") don't\n   - If a citation is in the database but not matching the user's ethnicity AND has fewer than 6 ethnicity entries, it gets excluded - but this creates a confusing filtering pattern\n\n3. **No temporal relationship**: The component passes `recommendation.ref_id` to `getRelevantCitations()`, but recommendations are sorted by priority (line 1688-1695 in ResultsContext.tsx). The citations fetching doesn't consider this priority ordering.\n\n**3. CITATION POSITION ISSUES**\n\nLooking at specific examples in the RESEARCH_CITATIONS array:\n\n- **Line 63-65**: Rhinoplasty research references `['SUR-02', 'MIN-04']`\n- **Line 73-75**: Another Rhinoplasty study references `['SUR-02', 'MIN-04']`\n- **Line 112-114**: Lip Proportions research references `['MIN-01', 'FND-01']`\n- **Line 173-174**: Mewing research references `['FND-02', 'FND-03']` ✓ (FND-02 exists, FND-03 exists)\n- **Line 182-183**: Body composition research references `['FND-04', 'FND-05']` ✓ (both exist)\n- **Line 191-193**: Grooming research references `['FND-01', 'FND-06', 'FND-07']` ✗ (FND-06 and FND-07 don't exist!)\n- **Line 133-134**: Canthal Tilt research references `['SUR-05', 'MIN-07']` ✗ (MIN-07 doesn't exist!)\n\n**4. THE REAL ISSUE: Card Rendering Order**\n\nWhen a recommendation is displayed via EnhancedRecommendationCard.tsx:\n1. The component receives a `recommendation` object with a `ref_id` (e.g., \"SUR-02\")\n2. It calls `getRelevantCitations(recommendation.ref_id, gender, ethnicity)` (line 469)\n3. This filters ALL citations that have that ref_id in their `procedureRefs` array\n4. Since multiple citations can reference the same procedure, and `.slice(0, 3)` just takes the first 3 from the filtered array, the order depends on:\n   - Array order in RESEARCH_CITATIONS (appears to be the main factor)\n   - Gender/ethnicity filtering\n\n**Example problem**: If a user is male and views a Rhinoplasty (SUR-02) recommendation:\n- Citation 1 (line 56-65): \"Ethnic Considerations in Rhinoplasty\" - references SUR-02, genderRelevance='both'\n- Citation 2 (line 68-75): \"The Male Rhinoplasty\" - references SUR-02, genderRelevance='male'\n\nThe male-specific citation should appear first for a male user, but it won't because the filter doesn't prioritize gender relevance - it just checks if it matches. The `.slice(0, 3)` then returns the first 3 matches in array order, not by relevance.\n\n### Summary of Root Causes:\n\n1. **Non-existent procedure references**: MIN-07, FND-06, FND-07 are cited but don't exist\n2. **No relevance ranking**: Citations matching a procedure aren't sorted by relevance (gender/ethnicity match strength)\n3. **Array-order dependency**: Citation positions depend on their order in RESEARCH_CITATIONS array, not on actual relevance\n4. **Broken ethnicity logic**: The ethnicity filtering uses an arbitrary threshold (< 6 entries) that's unintuitive\n5. **No consideration of recommendation priority**: Citations aren't adjusted based on how relevant the recommendation itself is to the user's flaws"},{"type":"text","text":"agentId: a97d09b (for resuming to continue this agent's work if needed)"}]}]},"uuid":"71be3263-5772-4c2d-9030-32b8ec78ae9f","timestamp":"2025-12-21T14:30:45.217Z","toolUseResult":{"status":"completed","prompt":"Analyze the results page and research citations system in this Next.js facial analysis app. The user reports that studies are being cited in incorrect positions.\n\nFocus on:\n1. How citations/studies are defined - look for RESEARCH_CITATIONS or similar\n2. How citations are matched to recommendations or displayed\n3. The EnhancedRecommendationCard.tsx component that displays citations\n4. The ResultsContext.tsx for any citation-related logic\n5. Any filtering logic for gender/ethnicity that might cause mismatches\n\nFind the root cause of why studies might appear in wrong positions. Look at the data structures, filtering logic, and rendering code.","agentId":"a97d09b","content":[{"type":"text","text":"Perfect! Now I have a clear picture. Let me create a comprehensive analysis document of the citation issues:\n\n## Root Cause Analysis: Research Citations in Wrong Positions\n\nBased on my thorough analysis of the code, I've identified the key issues causing studies to be cited in incorrect positions.\n\n### Key Findings:\n\n**1. PROCEDURE DATABASE vs RESEARCH CITATIONS MISMATCH**\n\nThe PROCEDURE_DATABASE in ResultsContext.tsx defines these ref_ids:\n- **Surgical**: SUR-01 through SUR-08 (8 procedures)\n- **Minimally Invasive**: MIN-01 through MIN-06 (6 procedures)  \n- **Foundational**: FND-01 through FND-05 (5 procedures)\n\nThe RESEARCH_CITATIONS in EnhancedRecommendationCard.tsx references these procedure types:\n- SUR-01, SUR-02, SUR-03, SUR-04, SUR-05, SUR-06, MIN-01 through MIN-07, FND-01 through FND-07\n\n**Issue**: MIN-07 and FND-06, FND-07 are cited but don't exist in the PROCEDURE_DATABASE!\n\n**2. CITATION MATCHING LOGIC**\n\nFile: `/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx`\n\nThe `getRelevantCitations()` function (lines 225-252):\n```typescript\nfunction getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  return RESEARCH_CITATIONS.filter(citation => {\n    // Must match the procedure\n    if (!citation.procedureRefs.includes(procedureRefId)) return false;\n\n    // Check gender relevance\n    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {\n      if (citation.genderRelevance !== gender) return false;\n    }\n\n    // Check ethnicity relevance\n    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {\n      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation\n      if (!citation.ethnicityRelevance.includes(ethnicity)) {\n        // Only exclude if the citation is ethnicity-specific\n        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  }).slice(0, 3); // Limit to 3 most relevant citations\n}\n```\n\n**Problems with this logic**:\n\n1. **No priority/ranking system**: All matching citations are treated equally. When a procedure appears in multiple citation procedureRefs arrays, there's no way to guarantee the most relevant one shows first.\n\n2. **Ethnicity filtering is vague** (lines 240-248): \n   - The logic \"only exclude if ethnicityRelevance.length > 0 && < 6\" is unclear\n   - This means citations with 1-5 ethnicities get filtered strictly, but citations with 6+ ethnicities (like \"all ethnicities\") don't\n   - If a citation is in the database but not matching the user's ethnicity AND has fewer than 6 ethnicity entries, it gets excluded - but this creates a confusing filtering pattern\n\n3. **No temporal relationship**: The component passes `recommendation.ref_id` to `getRelevantCitations()`, but recommendations are sorted by priority (line 1688-1695 in ResultsContext.tsx). The citations fetching doesn't consider this priority ordering.\n\n**3. CITATION POSITION ISSUES**\n\nLooking at specific examples in the RESEARCH_CITATIONS array:\n\n- **Line 63-65**: Rhinoplasty research references `['SUR-02', 'MIN-04']`\n- **Line 73-75**: Another Rhinoplasty study references `['SUR-02', 'MIN-04']`\n- **Line 112-114**: Lip Proportions research references `['MIN-01', 'FND-01']`\n- **Line 173-174**: Mewing research references `['FND-02', 'FND-03']` ✓ (FND-02 exists, FND-03 exists)\n- **Line 182-183**: Body composition research references `['FND-04', 'FND-05']` ✓ (both exist)\n- **Line 191-193**: Grooming research references `['FND-01', 'FND-06', 'FND-07']` ✗ (FND-06 and FND-07 don't exist!)\n- **Line 133-134**: Canthal Tilt research references `['SUR-05', 'MIN-07']` ✗ (MIN-07 doesn't exist!)\n\n**4. THE REAL ISSUE: Card Rendering Order**\n\nWhen a recommendation is displayed via EnhancedRecommendationCard.tsx:\n1. The component receives a `recommendation` object with a `ref_id` (e.g., \"SUR-02\")\n2. It calls `getRelevantCitations(recommendation.ref_id, gender, ethnicity)` (line 469)\n3. This filters ALL citations that have that ref_id in their `procedureRefs` array\n4. Since multiple citations can reference the same procedure, and `.slice(0, 3)` just takes the first 3 from the filtered array, the order depends on:\n   - Array order in RESEARCH_CITATIONS (appears to be the main factor)\n   - Gender/ethnicity filtering\n\n**Example problem**: If a user is male and views a Rhinoplasty (SUR-02) recommendation:\n- Citation 1 (line 56-65): \"Ethnic Considerations in Rhinoplasty\" - references SUR-02, genderRelevance='both'\n- Citation 2 (line 68-75): \"The Male Rhinoplasty\" - references SUR-02, genderRelevance='male'\n\nThe male-specific citation should appear first for a male user, but it won't because the filter doesn't prioritize gender relevance - it just checks if it matches. The `.slice(0, 3)` then returns the first 3 matches in array order, not by relevance.\n\n### Summary of Root Causes:\n\n1. **Non-existent procedure references**: MIN-07, FND-06, FND-07 are cited but don't exist\n2. **No relevance ranking**: Citations matching a procedure aren't sorted by relevance (gender/ethnicity match strength)\n3. **Array-order dependency**: Citation positions depend on their order in RESEARCH_CITATIONS array, not on actual relevance\n4. **Broken ethnicity logic**: The ethnicity filtering uses an arbitrary threshold (< 6 entries) that's unintuitive\n5. **No consideration of recommendation priority**: Citations aren't adjusted based on how relevant the recommendation itself is to the user's flaws"}],"totalDurationMs":59139,"totalTokens":63220,"totalToolUseCount":18,"usage":{"input_tokens":0,"cache_creation_input_tokens":1976,"cache_read_input_tokens":59560,"cache_creation":{"ephemeral_5m_input_tokens":1976,"ephemeral_1h_input_tokens":0},"output_tokens":1684,"service_tier":"standard"}}}
{"parentUuid":"71be3263-5772-4c2d-9030-32b8ec78ae9f","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_0171eLNLGoPKzfF3B142Wp98","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The explore agent found the root causes of the citation issues. Let me summarize the findings for the user:\n\n1. **Non-existent procedure references**: MIN-07, FND-06, FND-07 are cited but don't exist in PROCEDURE_DATABASE\n2. **No relevance ranking**: Citations aren't sorted by relevance \n3. **Array-order dependency**: Citation display depends on their order in RESEARCH_CITATIONS array\n4. **Broken ethnicity logic**: The filtering threshold is arbitrary\n5. **No priority consideration**: Citations aren't adjusted based on recommendation relevance\n\nThe user said studies are being cited in incorrect positions. This aligns with finding #3 - the citations appear based on their array order rather than actual relevance to the user's demographics or the specific recommendation context.\n\nLet me read the files to understand this better and propose a fix.","signature":"EvwHCkYIChgCKkDakOVU8PTu2w8j0CMcS2avTgqyoUWJyQuNCU9oreep3eYh/gYA42lp1hbMEFbOqTnh5Lu8U3IUdUmtLnmUZ9sXEgw+a0aCcO2L3QKitPYaDAlqO6x3bKqiAXH1sSIwqqFhy4Smn1lkYCWPS/fIpvotLS4p01POWFCabzzuYJFwpKOJA6RiRxy/Ov72AbwuKuMGnqEMzdGhto/92M9Dzi/ynql8wkEaBZuSaq+0DtTTpL2sshlMeqzr+d173gyYQqwJabs760BfcrwN62OtN606+b+o6Q4nCgzAEmLnUuK09fK4EypsKhZ8jYE2VkhD0LXhRhlFYOL4wKB7vG2Nb9SwHt0hJZlutfirp/fbhyN1yJLZ086q/h1QYBGqedULh1vci2Ors13lUIg8XLvAavWgcu4zNl7RL7TG0AibBoggVDemIRZDEpE+d7W1QYhLJUutJT48xW/tT5MzFWxVUErLywvSPZ+B9/0iZt3AnlsEFcb7OCXQXn/ovhYFIpkc1/7iLUUXFZ/pmubuu2PdZc0nzCqNFSWfvCF+yizHuNN+abHNoKcJaWvpnS1L/86pXypCBMUcYYXHSQi+H6tXR2qD9/9Sy92bkAnwqFhafxeIvX3gsIgI7pBox9RL9Opn6QxW7ZJ/kxg5Osch4adc2v4EOMk2OSTzDj6ik6GJMPlObS33RZBVzy+LhbwJY6zyYVFNvtsCULeB+qCMETMaLJ3A3JHycjzVvDXpTDHlK85kSJosb4VzolQbAA2uxiRlpyLKwfFoLMSfzFTP4+YmAR7OfFfbF+AR26qGz6Ch3bju7yeRLA2exNY3EPexJH5nCa9/7V5fvDygyvGzM7jknRSrwS/WXbLemDHSJqG0lXyCRWwqcT3E4WFT3Mu1qCZZkdp53krh2XMF+LWfpWYnVHSyx0oRNUyULHIWPg2zPW/CSoWpGwRrUIps9g5f1+NjBCJ6Ydnl+bKYN1UnOHCC2BSJJQxsPWpc25s+qA5Anz25woedsyvnse+2yhkBh8Ed7WWB8M2Fl46RgcO2mE8J07osxnSl7Up26L4pN/GCx+wRQMcLSfn3jUJILEmVFxEwctmkATxlrsvYVd0AChOFEhXZBj73GCxxto/e41FNTEII1mM98yaBMViN7tTvUUueMFx4ChJ9bTHi2wn33kOyHfmN3CRPgXFhRRAvIXdkv7qITwuV4uUQd2aeo51jtiq6cdLj8559dz0r6W9qBUt9RC4p08t9cjhRBfOQyRG9gRVnTlF/cbSDDY7mg/2lkA95iaCvSDwtdeWacatyA9GHRZ2wuwDvCpd5NT/U38XdXZJBVZl5WlI/P6CWYikAYRK5dhpSMWZbGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1998,"cache_read_input_tokens":20866,"cache_creation":{"ephemeral_5m_input_tokens":1998,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzZJRUxoJj3Czk1CRhW","type":"assistant","uuid":"81dbae00-7e42-483a-8858-41da8e83b331","timestamp":"2025-12-21T14:30:52.915Z"}
{"parentUuid":"81dbae00-7e42-483a-8858-41da8e83b331","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_0171eLNLGoPKzfF3B142Wp98","type":"message","role":"assistant","content":[{"type":"text","text":"The agent found several issues with the citations system:\n\n## Root Causes Identified\n\n1. **Non-existent procedure references** - Citations reference MIN-07, FND-06, FND-07 which don't exist in `PROCEDURE_DATABASE`\n\n2. **No relevance ranking** - All matching citations are treated equally. A male-specific study should appear first for male users, but it doesn't.\n\n3. **Array-order dependency** - Citations appear based on their position in the `RESEARCH_CITATIONS` array, not actual relevance\n\n4. **Broken ethnicity filtering** - The logic uses an arbitrary threshold (`length < 6`) that creates confusing behavior\n\n5. **No priority consideration** - Citations aren't sorted by how well they match the user's demographics\n\nWould you like me to:\n1. **Fix the invalid procedure references** (MIN-07, FND-06, FND-07)\n2. **Add relevance-based sorting** to `getRelevantCitations()` so gender/ethnicity matches rank higher\n3. **Both** - Fix references and improve sorting logic"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1998,"cache_read_input_tokens":20866,"cache_creation":{"ephemeral_5m_input_tokens":1998,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzZJRUxoJj3Czk1CRhW","type":"assistant","uuid":"d3148e2c-ff00-43ef-9a27-fff4d71ad597","timestamp":"2025-12-21T14:30:56.608Z"}
{"type":"file-history-snapshot","messageId":"a94b6ddd-e460-4a82-be01-101772354336","snapshot":{"messageId":"a94b6ddd-e460-4a82-be01-101772354336","trackedFileBackups":{},"timestamp":"2025-12-21T14:31:16.125Z"},"isSnapshotUpdate":false}
{"parentUuid":"d3148e2c-ff00-43ef-9a27-fff4d71ad597","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":"both"},"uuid":"a94b6ddd-e460-4a82-be01-101772354336","timestamp":"2025-12-21T14:31:16.123Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]}}
{"parentUuid":"a94b6ddd-e460-4a82-be01-101772354336","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LdndsPamwy4DE5APpUVhn9","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to fix both issues:\n1. Fix the invalid procedure references (MIN-07, FND-06, FND-07)\n2. Add relevance-based sorting to getRelevantCitations()\n\nLet me first read the relevant files to understand the current state and make the fixes.","signature":"Ep4DCkYIChgCKkDqRKVF9hqpjy5z/S5IC4vaikarQkV1xZ3pOgHhwtDBaE+yJW4I63mhgVzJjRJDt5jLsuwTRbgkAtzxOD91+/oAEgx4X+aPs+1N+tFXXvQaDD9yw7QRB3Z0/JEcEyIwNwPzIVBIPwI/MpHbKSIFgZ01IJtI4Z5WNA8fiWrT1lYXpqU267C6y2PxhC76lrapKoUCM+2btS4zey6yvU57jPd5z3Pj1t7YSqDaj7AVCZ96dAQF4jehAOGSQdFUSSnIxR2Qu8bbIyN78b7LxfuYMUKQpVckKRK2/3bNKXj5t+21hZHcGeFzzRc6H2frpFy8uaaxYxpkysuma1fRWC+iMFyiWEDXyFvePtSUOqYHp1D51Im4YFP90/UZ88kqrcmzx5AsBSyptety57ahBdIHutmTyqDaN6csZou6+AdZ8HKBScrk/JG301v5epEpDqE40eRlO0b9ko6L9SGZnRb5rDFQR2s8aKr+Ja2mfXE9VuOqJe67r7cerjjyFf+DP4EzfPalHuDUEtPvDfsJ2cjxKG0UXVGU5NiZGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":451,"cache_read_input_tokens":22864,"cache_creation":{"ephemeral_5m_input_tokens":451,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWKzbaVS5dx54e28HW78f","type":"assistant","uuid":"93b773e0-6032-4dc1-8910-bc0fcde7e4be","timestamp":"2025-12-21T14:31:21.918Z"}
{"parentUuid":"93b773e0-6032-4dc1-8910-bc0fcde7e4be","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LdndsPamwy4DE5APpUVhn9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VXmHaW23ZvKMeWg3y68vjo","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":451,"cache_read_input_tokens":22864,"cache_creation":{"ephemeral_5m_input_tokens":451,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWKzbaVS5dx54e28HW78f","type":"assistant","uuid":"a780470a-20b0-46ce-90d6-d985dfc2a9c9","timestamp":"2025-12-21T14:31:22.399Z"}
{"parentUuid":"a780470a-20b0-46ce-90d6-d985dfc2a9c9","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LdndsPamwy4DE5APpUVhn9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XETWEQtzEHfdafskcdvVpo","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":451,"cache_read_input_tokens":22864,"cache_creation":{"ephemeral_5m_input_tokens":451,"ephemeral_1h_input_tokens":0},"output_tokens":230,"service_tier":"standard"}},"requestId":"req_011CWKzbaVS5dx54e28HW78f","type":"assistant","uuid":"1fa097d0-3a17-428a-aafb-c3865cd1360e","timestamp":"2025-12-21T14:31:22.966Z"}
{"parentUuid":"1fa097d0-3a17-428a-aafb-c3865cd1360e","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VXmHaW23ZvKMeWg3y68vjo","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import { useState, useCallback, useMemo } from 'react';\n     4→import { motion, AnimatePresence } from 'framer-motion';\n     5→import {\n     6→  ChevronDown,\n     7→  Clock,\n     8→  DollarSign,\n     9→  AlertTriangle,\n    10→  Target,\n    11→  Info,\n    12→  BookOpen,\n    13→  CheckCircle,\n    14→  Trash2,\n    15→  Plus,\n    16→  Sparkles,\n    17→  ExternalLink,\n    18→} from 'lucide-react';\n    19→import { Recommendation } from '@/types/results';\n    20→import { Gender, Ethnicity } from '@/lib/faceiq-scoring';\n    21→\n    22→// ============================================\n    23→// TYPES\n    24→// ============================================\n    25→\n    26→interface EnhancedRecommendationCardProps {\n    27→  recommendation: Recommendation;\n    28→  isExpanded?: boolean;\n    29→  onToggle?: () => void;\n    30→  rank?: number;\n    31→  onMarkComplete?: (id: string) => void;\n    32→  onRemove?: (id: string) => void;\n    33→  isCompleted?: boolean;\n    34→  gender?: Gender;\n    35→  ethnicity?: Ethnicity;\n    36→}\n    37→\n    38→// ============================================\n    39→// RESEARCH CITATIONS DATABASE\n    40→// ============================================\n    41→\n    42→interface ResearchCitation {\n    43→  title: string;\n    44→  authors: string;\n    45→  journal: string;\n    46→  year: number;\n    47→  doi?: string;\n    48→  summary: string;\n    49→  procedureRefs: string[];  // Matches recommendation ref_id\n    50→  genderRelevance?: 'male' | 'female' | 'both';\n    51→  ethnicityRelevance?: Ethnicity[];\n    52→}\n    53→\n    54→const RESEARCH_CITATIONS: ResearchCitation[] = [\n    55→  // Rhinoplasty Research\n    56→  {\n    57→    title: 'Ethnic Considerations in Rhinoplasty',\n    58→    authors: 'Rohrich RJ, Bolden K',\n    59→    journal: 'Plastic and Reconstructive Surgery',\n    60→    year: 2010,\n    61→    doi: '10.1097/PRS.0b013e3181c6b2b7',\n    62→    summary: 'Discusses the importance of preserving ethnic identity while achieving aesthetic goals in rhinoplasty across different ethnicities.',\n    63→    procedureRefs: ['SUR-02', 'MIN-04'],\n    64→    genderRelevance: 'both',\n    65→    ethnicityRelevance: ['black', 'east_asian', 'south_asian', 'middle_eastern', 'hispanic'],\n    66→  },\n    67→  {\n    68→    title: 'The Male Rhinoplasty',\n    69→    authors: 'Foda HM',\n    70→    journal: 'Facial Plastic Surgery',\n    71→    year: 2008,\n    72→    summary: 'Examines unique considerations for male rhinoplasty including maintaining masculine features and avoiding feminization.',\n    73→    procedureRefs: ['SUR-02', 'MIN-04'],\n    74→    genderRelevance: 'male',\n    75→  },\n    76→  // Jaw/Chin Research\n    77→  {\n    78→    title: 'Sliding Genioplasty: A Systematic Review',\n    79→    authors: 'Park JH, Tae-Hoon K',\n    80→    journal: 'Journal of Oral and Maxillofacial Surgery',\n    81→    year: 2018,\n    82→    summary: 'Comprehensive analysis of chin advancement outcomes and patient satisfaction rates across demographics.',\n    83→    procedureRefs: ['SUR-01', 'MIN-02'],\n    84→    genderRelevance: 'both',\n    85→  },\n    86→  {\n    87→    title: 'Gender Differences in Jaw Angle Aesthetics',\n    88→    authors: 'Kim YH, Cho J',\n    89→    journal: 'Aesthetic Plastic Surgery',\n    90→    year: 2020,\n    91→    summary: 'Research on ideal jaw angle parameters for males (90-110°) versus females (110-120°).',\n    92→    procedureRefs: ['SUR-03', 'MIN-03'],\n    93→    genderRelevance: 'both',\n    94→  },\n    95→  {\n    96→    title: 'Mandibular Angle Augmentation in Asian Patients',\n    97→    authors: 'Lee YJ, Park KS',\n    98→    journal: 'Asian Journal of Beauty and Cosmetology',\n    99→    year: 2019,\n   100→    summary: 'Study on jaw angle enhancement specific to East Asian facial structure and aesthetic preferences.',\n   101→    procedureRefs: ['SUR-03', 'MIN-03'],\n   102→    genderRelevance: 'both',\n   103→    ethnicityRelevance: ['east_asian', 'south_asian'],\n   104→  },\n   105→  // Lip Research\n   106→  {\n   107→    title: 'Ideal Lip Proportions Across Ethnicities',\n   108→    authors: 'Farkas LG, Katic MJ',\n   109→    journal: 'Aesthetic Surgery Journal',\n   110→    year: 2003,\n   111→    summary: 'Anthropometric study establishing ethnic-specific ideal lip ratios and proportions.',\n   112→    procedureRefs: ['MIN-01', 'FND-01'],\n   113→    genderRelevance: 'both',\n   114→    ethnicityRelevance: ['white', 'black', 'east_asian', 'hispanic'],\n   115→  },\n   116→  {\n   117→    title: 'Lip Enhancement in African American Patients',\n   118→    authors: 'Mack WP',\n   119→    journal: 'Facial Plastic Surgery Clinics',\n   120→    year: 2014,\n   121→    summary: 'Guidelines for maintaining ethnic characteristics while enhancing lip aesthetics.',\n   122→    procedureRefs: ['MIN-01'],\n   123→    genderRelevance: 'both',\n   124→    ethnicityRelevance: ['black'],\n   125→  },\n   126→  // Eye/Canthal Research\n   127→  {\n   128→    title: 'Canthal Tilt and Facial Attractiveness',\n   129→    authors: 'Rhee SC, et al.',\n   130→    journal: 'Plastic and Reconstructive Surgery',\n   131→    year: 2017,\n   132→    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n   133→    procedureRefs: ['SUR-05', 'MIN-07'],\n   134→    genderRelevance: 'both',\n   135→  },\n   136→  {\n   137→    title: 'Asian Blepharoplasty and Canthopexy',\n   138→    authors: 'Chen WP',\n   139→    journal: 'Ophthalmic Plastic Surgery',\n   140→    year: 2016,\n   141→    summary: 'Specific techniques for Asian eyelid surgery that preserve ethnic identity while enhancing eye shape.',\n   142→    procedureRefs: ['SUR-05'],\n   143→    genderRelevance: 'both',\n   144→    ethnicityRelevance: ['east_asian', 'south_asian'],\n   145→  },\n   146→  // Midface/Cheek Research\n   147→  {\n   148→    title: 'Cheekbone Enhancement for Facial Harmony',\n   149→    authors: 'Mendelson B, Wong CH',\n   150→    journal: 'Clinics in Plastic Surgery',\n   151→    year: 2015,\n   152→    summary: 'Analysis of malar augmentation effects on overall facial harmony and perceived attractiveness.',\n   153→    procedureRefs: ['SUR-06', 'MIN-05'],\n   154→    genderRelevance: 'both',\n   155→  },\n   156→  {\n   157→    title: 'Midface Aesthetics in Middle Eastern Populations',\n   158→    authors: 'Rohrich RJ, et al.',\n   159→    journal: 'Aesthetic Surgery Journal',\n   160→    year: 2021,\n   161→    summary: 'Ethnic considerations for midface enhancement in Middle Eastern patients.',\n   162→    procedureRefs: ['SUR-06', 'MIN-05'],\n   163→    genderRelevance: 'both',\n   164→    ethnicityRelevance: ['middle_eastern'],\n   165→  },\n   166→  // Foundational/Non-Surgical Research\n   167→  {\n   168→    title: 'Mewing and Orthotropic Treatment',\n   169→    authors: 'Mew J, Mew M',\n   170→    journal: 'International Journal of Orthodontics',\n   171→    year: 2014,\n   172→    summary: 'Research on proper tongue posture and its effects on facial development and structure.',\n   173→    procedureRefs: ['FND-02', 'FND-03'],\n   174→    genderRelevance: 'both',\n   175→  },\n   176→  {\n   177→    title: 'Effects of Body Composition on Facial Aesthetics',\n   178→    authors: 'Morrison CS, et al.',\n   179→    journal: 'Aesthetic Surgery Journal',\n   180→    year: 2017,\n   181→    summary: 'Study on how body fat percentage affects facial definition and perceived attractiveness.',\n   182→    procedureRefs: ['FND-04', 'FND-05'],\n   183→    genderRelevance: 'both',\n   184→  },\n   185→  {\n   186→    title: 'Grooming and First Impressions',\n   187→    authors: 'Phelan C, Etcoff N',\n   188→    journal: 'Journal of Applied Social Psychology',\n   189→    year: 2011,\n   190→    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n   191→    procedureRefs: ['FND-01', 'FND-06', 'FND-07'],\n   192→    genderRelevance: 'both',\n   193→  },\n   194→  // Orthognathic Research\n   195→  {\n   196→    title: 'Bimaxillary Surgery Outcomes',\n   197→    authors: 'Rustemeyer J, et al.',\n   198→    journal: 'Journal of Cranio-Maxillofacial Surgery',\n   199→    year: 2019,\n   200→    summary: 'Long-term outcomes and patient satisfaction following double jaw surgery.',\n   201→    procedureRefs: ['SUR-04'],\n   202→    genderRelevance: 'both',\n   203→  },\n   204→  // General Attractiveness Research\n   205→  {\n   206→    title: 'Cross-Cultural Facial Attractiveness',\n   207→    authors: 'Perrett DI, et al.',\n   208→    journal: 'Nature',\n   209→    year: 1998,\n   210→    summary: 'Landmark study on universal vs. culture-specific aspects of facial attractiveness.',\n   211→    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06'],\n   212→    genderRelevance: 'both',\n   213→  },\n   214→  {\n   215→    title: 'Golden Ratios in Facial Beauty',\n   216→    authors: 'Marquardt SR',\n   217→    journal: 'International Journal of Cosmetic Surgery',\n   218→    year: 2002,\n   219→    summary: 'Analysis of mathematical proportions and their relationship to perceived facial beauty.',\n   220→    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06', 'MIN-01', 'MIN-02'],\n   221→    genderRelevance: 'both',\n   222→  },\n   223→];\n   224→\n   225→function getRelevantCitations(\n   226→  procedureRefId: string,\n   227→  gender?: Gender,\n   228→  ethnicity?: Ethnicity\n   229→): ResearchCitation[] {\n   230→  return RESEARCH_CITATIONS.filter(citation => {\n   231→    // Must match the procedure\n   232→    if (!citation.procedureRefs.includes(procedureRefId)) return false;\n   233→\n   234→    // Check gender relevance\n   235→    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {\n   236→      if (citation.genderRelevance !== gender) return false;\n   237→    }\n   238→\n   239→    // Check ethnicity relevance\n   240→    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {\n   241→      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation\n   242→      if (!citation.ethnicityRelevance.includes(ethnicity)) {\n   243→        // Only exclude if the citation is ethnicity-specific\n   244→        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {\n   245→          return false;\n   246→        }\n   247→      }\n   248→    }\n   249→\n   250→    return true;\n   251→  }).slice(0, 3); // Limit to 3 most relevant citations\n   252→}\n   253→\n   254→interface TrackerState {\n   255→  notes: string;\n   256→  checklist: Array<{ id: string; text: string; completed: boolean }>;\n   257→}\n   258→\n   259→// ============================================\n   260→// PHASE BADGE (Dark Theme)\n   261→// ============================================\n   262→\n   263→function PhaseBadge({ phase }: { phase: string }) {\n   264→  const getPhaseConfig = () => {\n   265→    switch (phase) {\n   266→      case 'Foundational':\n   267→        return {\n   268→          bg: 'bg-emerald-500/20',\n   269→          text: 'text-emerald-400',\n   270→          border: 'border-emerald-500/30',\n   271→        };\n   272→      case 'Minimally Invasive':\n   273→        return {\n   274→          bg: 'bg-blue-500/20',\n   275→          text: 'text-blue-400',\n   276→          border: 'border-blue-500/30',\n   277→        };\n   278→      case 'Surgical':\n   279→        return {\n   280→          bg: 'bg-purple-500/20',\n   281→          text: 'text-purple-400',\n   282→          border: 'border-purple-500/30',\n   283→        };\n   284→      default:\n   285→        return {\n   286→          bg: 'bg-neutral-500/20',\n   287→          text: 'text-neutral-400',\n   288→          border: 'border-neutral-500/30',\n   289→        };\n   290→    }\n   291→  };\n   292→\n   293→  const config = getPhaseConfig();\n   294→\n   295→  return (\n   296→    <span\n   297→      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}\n   298→    >\n   299→      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}\n   300→    </span>\n   301→  );\n   302→}\n   303→\n   304→// ============================================\n   305→// IMPACT BADGE\n   306→// ============================================\n   307→\n   308→function ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {\n   309→  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);\n   310→\n   311→  return (\n   312→    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n   313→      <span className=\"flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0\">\n   314→        <Sparkles className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n   315→        {formattedImpact}\n   316→      </span>\n   317→      {(frontImpact !== undefined || sideImpact !== undefined) && (\n   318→        <span className=\"hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0\">\n   319→          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n   320→            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}\n   321→          </span>\n   322→          <span className=\"text-neutral-600\">|</span>\n   323→          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n   324→            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}\n   325→          </span>\n   326→        </span>\n   327→      )}\n   328→    </div>\n   329→  );\n   330→}\n   331→\n   332→// ============================================\n   333→// IMPROVEMENT TAG\n   334→// ============================================\n   335→\n   336→function ImprovementTag({ text }: { text: string }) {\n   337→  return (\n   338→    <div className=\"inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm\">\n   339→      <CheckCircle className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0\" />\n   340→      <span className=\"truncate\">{text}</span>\n   341→    </div>\n   342→  );\n   343→}\n   344→\n   345→// ============================================\n   346→// SECTION HEADER\n   347→// ============================================\n   348→\n   349→function SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {\n   350→  return (\n   351→    <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3\">\n   352→      <Icon className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n   353→      {title}\n   354→    </h4>\n   355→  );\n   356→}\n   357→\n   358→// ============================================\n   359→// MY TRACKER SECTION\n   360→// ============================================\n   361→\n   362→function MyTracker({\n   363→  tracker,\n   364→  onNotesChange,\n   365→  onAddChecklistItem,\n   366→  onToggleChecklistItem,\n   367→  onRemoveChecklistItem\n   368→}: {\n   369→  tracker: TrackerState;\n   370→  onNotesChange: (notes: string) => void;\n   371→  onAddChecklistItem: () => void;\n   372→  onToggleChecklistItem: (id: string) => void;\n   373→  onRemoveChecklistItem: (id: string) => void;\n   374→}) {\n   375→  return (\n   376→    <div className=\"md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full\">\n   377→      <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4\">\n   378→        <BookOpen className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n   379→        My Tracker\n   380→      </h4>\n   381→      <div className=\"space-y-3 sm:space-y-4\">\n   382→        {/* Personal Notes */}\n   383→        <div className=\"space-y-1 sm:space-y-1.5\">\n   384→          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400\">Personal Notes</label>\n   385→          <textarea\n   386→            value={tracker.notes}\n   387→            onChange={(e) => onNotesChange(e.target.value)}\n   388→            className=\"w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all\"\n   389→            placeholder=\"Track progress, questions, dates...\"\n   390→          />\n   391→        </div>\n   392→\n   393→        {/* Checklist */}\n   394→        <div className=\"space-y-1.5 sm:space-y-2 pt-1 sm:pt-2\">\n   395→          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center\">\n   396→            <span>Checklist</span>\n   397→            <button\n   398→              onClick={onAddChecklistItem}\n   399→              className=\"text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors\"\n   400→            >\n   401→              <Plus className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n   402→              Add\n   403→            </button>\n   404→          </label>\n   405→          <div className=\"space-y-1.5 sm:space-y-2\">\n   406→            {tracker.checklist.length === 0 ? (\n   407→              <div className=\"text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50\">\n   408→                No tasks yet\n   409→              </div>\n   410→            ) : (\n   411→              tracker.checklist.map((item) => (\n   412→                <div\n   413→                  key={item.id}\n   414→                  className=\"flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg\"\n   415→                >\n   416→                  <button\n   417→                    onClick={() => onToggleChecklistItem(item.id)}\n   418→                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${\n   419→                      item.completed\n   420→                        ? 'bg-emerald-500 border-emerald-500'\n   421→                        : 'border-neutral-600 hover:border-neutral-500'\n   422→                    }`}\n   423→                  >\n   424→                    {item.completed && <CheckCircle className=\"w-3 h-3 text-black\" />}\n   425→                  </button>\n   426→                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>\n   427→                    {item.text}\n   428→                  </span>\n   429→                  <button\n   430→                    onClick={() => onRemoveChecklistItem(item.id)}\n   431→                    className=\"text-neutral-600 hover:text-red-400 transition-colors\"\n   432→                  >\n   433→                    <Trash2 className=\"w-3 h-3\" />\n   434→                  </button>\n   435→                </div>\n   436→              ))\n   437→            )}\n   438→          </div>\n   439→        </div>\n   440→      </div>\n   441→    </div>\n   442→  );\n   443→}\n   444→\n   445→// ============================================\n   446→// MAIN ENHANCED RECOMMENDATION CARD\n   447→// ============================================\n   448→\n   449→export function EnhancedRecommendationCard({\n   450→  recommendation,\n   451→  isExpanded = false,\n   452→  onToggle,\n   453→  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n   454→  rank,\n   455→  onMarkComplete,\n   456→  onRemove,\n   457→  isCompleted = false,\n   458→  gender,\n   459→  ethnicity,\n   460→}: EnhancedRecommendationCardProps) {\n   461→  // Tracker state (would be persisted in real app)\n   462→  const [tracker, setTracker] = useState<TrackerState>({\n   463→    notes: '',\n   464→    checklist: [],\n   465→  });\n   466→\n   467→  // Get relevant research citations based on procedure, gender, and ethnicity\n   468→  const citations = useMemo(() => {\n   469→    return getRelevantCitations(recommendation.ref_id, gender, ethnicity);\n   470→  }, [recommendation.ref_id, gender, ethnicity]);\n   471→\n   472→  const handleNotesChange = useCallback((notes: string) => {\n   473→    setTracker(prev => ({ ...prev, notes }));\n   474→  }, []);\n   475→\n   476→  const handleAddChecklistItem = useCallback(() => {\n   477→    const text = window.prompt('Enter task:');\n   478→    if (text) {\n   479→      setTracker(prev => ({\n   480→        ...prev,\n   481→        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],\n   482→      }));\n   483→    }\n   484→  }, []);\n   485→\n   486→  const handleToggleChecklistItem = useCallback((id: string) => {\n   487→    setTracker(prev => ({\n   488→      ...prev,\n   489→      checklist: prev.checklist.map(item =>\n   490→        item.id === id ? { ...item, completed: !item.completed } : item\n   491→      ),\n   492→    }));\n   493→  }, []);\n   494→\n   495→  const handleRemoveChecklistItem = useCallback((id: string) => {\n   496→    setTracker(prev => ({\n   497→      ...prev,\n   498→      checklist: prev.checklist.filter(item => item.id !== id),\n   499→    }));\n   500→  }, []);\n   501→\n   502→  // Format cost\n   503→  const formatCost = () => {\n   504→    const { min, max, type } = recommendation.cost;\n   505→    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';\n   506→    if (min === max) {\n   507→      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n   508→    }\n   509→    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n   510→  };\n   511→\n   512→  // Format timeline\n   513→  const formatTimeline = () => {\n   514→    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;\n   515→    if (full_results_weeks_max) {\n   516→      return `${full_results_weeks}-${full_results_weeks_max} weeks`;\n   517→    }\n   518→    if (full_results_weeks >= 52) {\n   519→      const months = Math.round(full_results_weeks / 4);\n   520→      return `${months} months`;\n   521→    }\n   522→    return `${full_results_weeks} weeks`;\n   523→  };\n   524→\n   525→  // Get effectiveness level\n   526→  const getEffectiveness = () => {\n   527→    if (recommendation.impact >= 0.7) return 'high';\n   528→    if (recommendation.impact >= 0.4) return 'moderate';\n   529→    return 'low';\n   530→  };\n   531→\n   532→  return (\n   533→    <motion.div\n   534→      layout\n   535→      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${\n   536→        isExpanded\n   537→          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'\n   538→          : 'border-neutral-800 hover:border-neutral-700'\n   539→      } ${isCompleted ? 'opacity-60' : ''}`}\n   540→    >\n   541→      {/* Header - Clickable */}\n   542→      <div className=\"p-3.5 sm:p-5 cursor-pointer\" onClick={onToggle}>\n   543→        <div className=\"space-y-3 sm:space-y-4\">\n   544→          <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4\">\n   545→            <div className=\"flex-1 min-w-0\">\n   546→              <div className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2\">\n   547→                <h3 className=\"text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white\">\n   548→                  {recommendation.name}\n   549→                </h3>\n   550→                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n   551→                  <PhaseBadge phase={recommendation.phase} />\n   552→                  <ImpactBadge impact={recommendation.impact} />\n   553→                </div>\n   554→              </div>\n   555→              <p className=\"text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none\">\n   556→                {recommendation.description}\n   557→              </p>\n   558→            </div>\n   559→\n   560→            {/* Action buttons */}\n   561→            <div className=\"flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto\">\n   562→              {onMarkComplete && (\n   563→                <button\n   564→                  onClick={(e) => {\n   565→                    e.stopPropagation();\n   566→                    onMarkComplete(recommendation.ref_id);\n   567→                  }}\n   568→                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${\n   569→                    isCompleted\n   570→                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'\n   571→                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'\n   572→                  }`}\n   573→                  title=\"Mark as complete\"\n   574→                >\n   575→                  <CheckCircle className=\"w-4 h-4\" />\n   576→                </button>\n   577→              )}\n   578→              {onRemove && (\n   579→                <button\n   580→                  onClick={(e) => {\n   581→                    e.stopPropagation();\n   582→                    onRemove(recommendation.ref_id);\n   583→                  }}\n   584→                  className=\"p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10\"\n   585→                  title=\"Remove action\"\n   586→                >\n   587→                  <Trash2 className=\"w-4 h-4\" />\n   588→                </button>\n   589→              )}\n   590→            </div>\n   591→          </div>\n   592→\n   593→          {/* Quick stats row */}\n   594→          <div className=\"flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400\">\n   595→            <div className=\"flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5\">\n   596→              <div className=\"flex items-center gap-1 sm:gap-1.5\" title=\"Estimated Cost\">\n   597→                <DollarSign className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n   598→                <span className=\"font-medium text-neutral-300\">{formatCost()}</span>\n   599→              </div>\n   600→              {recommendation.timeline.full_results_weeks > 0 && (\n   601→                <div className=\"flex items-center gap-1 sm:gap-1.5\">\n   602→                  <Clock className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n   603→                  <span className=\"font-medium text-neutral-300\">{formatTimeline()}</span>\n   604→                </div>\n   605→              )}\n   606→            </div>\n   607→            <button\n   608→              className=\"flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white\"\n   609→            >\n   610→              {isExpanded ? 'Less' : 'More'}\n   611→              <ChevronDown\n   612→                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n   613→              />\n   614→            </button>\n   615→          </div>\n   616→        </div>\n   617→      </div>\n   618→\n   619→      {/* Expanded Content */}\n   620→      <AnimatePresence initial={false}>\n   621→        {isExpanded && (\n   622→          <motion.div\n   623→            initial={{ height: 0, opacity: 0 }}\n   624→            animate={{ height: 'auto', opacity: 1 }}\n   625→            exit={{ height: 0, opacity: 0 }}\n   626→            transition={{ duration: 0.3 }}\n   627→            className=\"overflow-hidden\"\n   628→          >\n   629→            <div className=\"border-t border-neutral-800 bg-neutral-900/50\">\n   630→              <div className=\"grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800\">\n   631→                {/* Main Content */}\n   632→                <div className=\"md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6\">\n   633→                  {/* Improvements */}\n   634→                  <div>\n   635→                    <SectionHeader icon={Target} title=\"Improvements\" />\n   636→                    <div className=\"space-y-2 sm:space-y-3\">\n   637→                      <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\n   638→                        {recommendation.matchedFlaws.map((flaw, i) => (\n   639→                          <ImprovementTag key={i} text={flaw} />\n   640→                        ))}\n   641→                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (\n   642→                          <ImprovementTag key={i} text={ratio} />\n   643→                        ))}\n   644→                      </div>\n   645→                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n   646→                        <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n   647→                          <div className=\"text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase\">Effectiveness</div>\n   648→                          <div className=\"h-1 w-1 rounded-full bg-neutral-600\" />\n   649→                          <div className=\"font-medium text-white capitalize text-xs sm:text-sm\">{getEffectiveness()}</div>\n   650→                        </div>\n   651→                      </div>\n   652→                    </div>\n   653→                  </div>\n   654→\n   655→                  {/* How It Helps */}\n   656→                  <div>\n   657→                    <SectionHeader icon={Info} title=\"How It Helps\" />\n   658→                    <div className=\"space-y-1.5 sm:space-y-2\">\n   659→                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n   660→                        <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n   661→                          {recommendation.description}\n   662→                        </p>\n   663→                      </div>\n   664→                      {recommendation.ratios_impacted.length > 0 && (\n   665→                        <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n   666→                          <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n   667→                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}\n   668→                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.\n   669→                          </p>\n   670→                        </div>\n   671→                      )}\n   672→                    </div>\n   673→                  </div>\n   674→\n   675→                  {/* Logistics & Timeline */}\n   676→                  {recommendation.timeline.full_results_weeks > 0 && (\n   677→                    <div>\n   678→                      <SectionHeader icon={Clock} title=\"Logistics & Timeline\" />\n   679→                      <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\n   680→                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n   681→                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n   682→                            Effect Starts\n   683→                          </span>\n   684→                          <span className=\"text-xs sm:text-sm font-medium text-white capitalize\">\n   685→                            {recommendation.timeline.effect_start}\n   686→                          </span>\n   687→                        </div>\n   688→                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n   689→                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n   690→                            Full Results\n   691→                          </span>\n   692→                          <span className=\"text-xs sm:text-sm font-medium text-white\">\n   693→                            {formatTimeline()}\n   694→                          </span>\n   695→                        </div>\n   696→                      </div>\n   697→                    </div>\n   698→                  )}\n   699→\n   700→                  {/* Considerations */}\n   701→                  <div>\n   702→                    <SectionHeader icon={AlertTriangle} title=\"Considerations\" />\n   703→                    <div className=\"space-y-2 sm:space-y-3\">\n   704→                      {/* Prerequisites */}\n   705→                      {recommendation.warnings.length > 0 && (\n   706→                        <div className=\"bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm\">\n   707→                          <span className=\"font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">Prerequisites</span>\n   708→                          <p className=\"text-blue-300/80 text-[11px] sm:text-xs leading-relaxed\">\n   709→                            {recommendation.warnings[0]}\n   710→                          </p>\n   711→                        </div>\n   712→                      )}\n   713→\n   714→                      {/* Risks & Side Effects */}\n   715→                      {recommendation.risks_side_effects && (\n   716→                        <div className=\"bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm\">\n   717→                          <span className=\"font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">\n   718→                            Risks & Side Effects\n   719→                          </span>\n   720→                          <p className=\"text-amber-300/80 text-[11px] sm:text-xs leading-relaxed\">\n   721→                            {recommendation.risks_side_effects}\n   722→                          </p>\n   723→                        </div>\n   724→                      )}\n   725→                    </div>\n   726→                  </div>\n   727→\n   728→                  {/* Notes & Warnings */}\n   729→                  {recommendation.warnings.length > 1 && (\n   730→                    <div className=\"text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic\">\n   731→                      {recommendation.warnings.slice(1).join(' ')}\n   732→                    </div>\n   733→                  )}\n   734→\n   735→                  {/* Research Citations */}\n   736→                  <div className=\"bg-cyan-500/10 p-3 sm:p-4 rounded-lg border border-cyan-500/30\">\n   737→                    <div className=\"flex items-center gap-2 mb-3\">\n   738→                      <BookOpen size={14} className=\"text-cyan-400\" />\n   739→                      <span className=\"font-semibold text-cyan-400 text-xs sm:text-sm\">Research & Evidence</span>\n   740→                      {ethnicity && ethnicity !== 'other' && (\n   741→                        <span className=\"text-[9px] px-1.5 py-0.5 bg-cyan-500/20 rounded text-cyan-300 capitalize\">\n   742→                          {ethnicity.replace('_', ' ')} focus\n   743→                        </span>\n   744→                      )}\n   745→                    </div>\n   746→                    {citations.length > 0 ? (\n   747→                      <div className=\"space-y-2.5\">\n   748→                        {citations.map((citation, idx) => (\n   749→                          <div key={idx} className=\"text-[11px] sm:text-xs bg-neutral-900/50 p-2.5 rounded-lg border border-neutral-700/50\">\n   750→                            <div className=\"flex items-start justify-between gap-2\">\n   751→                              <div className=\"flex-1\">\n   752→                                <div className=\"font-medium text-cyan-300 mb-0.5 line-clamp-2\">\n   753→                                  {citation.title}\n   754→                                </div>\n   755→                                <div className=\"text-neutral-500 text-[10px] mb-1\">\n   756→                                  {citation.authors} • {citation.journal} ({citation.year})\n   757→                                </div>\n   758→                                <div className=\"text-neutral-400 leading-relaxed\">\n   759→                                  {citation.summary}\n   760→                                </div>\n   761→                              </div>\n   762→                              {citation.doi && (\n   763→                                <a\n   764→                                  href={`https://doi.org/${citation.doi}`}\n   765→                                  target=\"_blank\"\n   766→                                  rel=\"noopener noreferrer\"\n   767→                                  className=\"flex-shrink-0 p-1 text-cyan-400 hover:text-cyan-300 transition-colors\"\n   768→                                  title=\"View full paper\"\n   769→                                >\n   770→                                  <ExternalLink size={12} />\n   771→                                </a>\n   772→                              )}\n   773→                            </div>\n   774→                          </div>\n   775→                        ))}\n   776→                      </div>\n   777→                    ) : (\n   778→                      <div className=\"text-[11px] sm:text-xs text-cyan-300/70\">\n   779→                        {recommendation.matchedFlaws.length > 0\n   780→                          ? 'Based on facial analysis and established aesthetic research. More specific citations coming soon.'\n   781→                          : 'No specific research citations available for this recommendation.'}\n   782→                      </div>\n   783→                    )}\n   784→                  </div>\n   785→                </div>\n   786→\n   787→                {/* My Tracker Sidebar */}\n   788→                <MyTracker\n   789→                  tracker={tracker}\n   790→                  onNotesChange={handleNotesChange}\n   791→                  onAddChecklistItem={handleAddChecklistItem}\n   792→                  onToggleChecklistItem={handleToggleChecklistItem}\n   793→                  onRemoveChecklistItem={handleRemoveChecklistItem}\n   794→                />\n   795→              </div>\n   796→            </div>\n   797→          </motion.div>\n   798→        )}\n   799→      </AnimatePresence>\n   800→    </motion.div>\n   801→  );\n   802→}\n   803→\n   804→export default EnhancedRecommendationCard;\n   805→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7d871574-c928-4623-b0a8-78ad4a88c4c4","timestamp":"2025-12-21T14:31:23.181Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","content":"'use client';\n\nimport { useState, useCallback, useMemo } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  ChevronDown,\n  Clock,\n  DollarSign,\n  AlertTriangle,\n  Target,\n  Info,\n  BookOpen,\n  CheckCircle,\n  Trash2,\n  Plus,\n  Sparkles,\n  ExternalLink,\n} from 'lucide-react';\nimport { Recommendation } from '@/types/results';\nimport { Gender, Ethnicity } from '@/lib/faceiq-scoring';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface EnhancedRecommendationCardProps {\n  recommendation: Recommendation;\n  isExpanded?: boolean;\n  onToggle?: () => void;\n  rank?: number;\n  onMarkComplete?: (id: string) => void;\n  onRemove?: (id: string) => void;\n  isCompleted?: boolean;\n  gender?: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// RESEARCH CITATIONS DATABASE\n// ============================================\n\ninterface ResearchCitation {\n  title: string;\n  authors: string;\n  journal: string;\n  year: number;\n  doi?: string;\n  summary: string;\n  procedureRefs: string[];  // Matches recommendation ref_id\n  genderRelevance?: 'male' | 'female' | 'both';\n  ethnicityRelevance?: Ethnicity[];\n}\n\nconst RESEARCH_CITATIONS: ResearchCitation[] = [\n  // Rhinoplasty Research\n  {\n    title: 'Ethnic Considerations in Rhinoplasty',\n    authors: 'Rohrich RJ, Bolden K',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2010,\n    doi: '10.1097/PRS.0b013e3181c6b2b7',\n    summary: 'Discusses the importance of preserving ethnic identity while achieving aesthetic goals in rhinoplasty across different ethnicities.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black', 'east_asian', 'south_asian', 'middle_eastern', 'hispanic'],\n  },\n  {\n    title: 'The Male Rhinoplasty',\n    authors: 'Foda HM',\n    journal: 'Facial Plastic Surgery',\n    year: 2008,\n    summary: 'Examines unique considerations for male rhinoplasty including maintaining masculine features and avoiding feminization.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'male',\n  },\n  // Jaw/Chin Research\n  {\n    title: 'Sliding Genioplasty: A Systematic Review',\n    authors: 'Park JH, Tae-Hoon K',\n    journal: 'Journal of Oral and Maxillofacial Surgery',\n    year: 2018,\n    summary: 'Comprehensive analysis of chin advancement outcomes and patient satisfaction rates across demographics.',\n    procedureRefs: ['SUR-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Gender Differences in Jaw Angle Aesthetics',\n    authors: 'Kim YH, Cho J',\n    journal: 'Aesthetic Plastic Surgery',\n    year: 2020,\n    summary: 'Research on ideal jaw angle parameters for males (90-110°) versus females (110-120°).',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Mandibular Angle Augmentation in Asian Patients',\n    authors: 'Lee YJ, Park KS',\n    journal: 'Asian Journal of Beauty and Cosmetology',\n    year: 2019,\n    summary: 'Study on jaw angle enhancement specific to East Asian facial structure and aesthetic preferences.',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Lip Research\n  {\n    title: 'Ideal Lip Proportions Across Ethnicities',\n    authors: 'Farkas LG, Katic MJ',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2003,\n    summary: 'Anthropometric study establishing ethnic-specific ideal lip ratios and proportions.',\n    procedureRefs: ['MIN-01', 'FND-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['white', 'black', 'east_asian', 'hispanic'],\n  },\n  {\n    title: 'Lip Enhancement in African American Patients',\n    authors: 'Mack WP',\n    journal: 'Facial Plastic Surgery Clinics',\n    year: 2014,\n    summary: 'Guidelines for maintaining ethnic characteristics while enhancing lip aesthetics.',\n    procedureRefs: ['MIN-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black'],\n  },\n  // Eye/Canthal Research\n  {\n    title: 'Canthal Tilt and Facial Attractiveness',\n    authors: 'Rhee SC, et al.',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2017,\n    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n    procedureRefs: ['SUR-05', 'MIN-07'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Asian Blepharoplasty and Canthopexy',\n    authors: 'Chen WP',\n    journal: 'Ophthalmic Plastic Surgery',\n    year: 2016,\n    summary: 'Specific techniques for Asian eyelid surgery that preserve ethnic identity while enhancing eye shape.',\n    procedureRefs: ['SUR-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Midface/Cheek Research\n  {\n    title: 'Cheekbone Enhancement for Facial Harmony',\n    authors: 'Mendelson B, Wong CH',\n    journal: 'Clinics in Plastic Surgery',\n    year: 2015,\n    summary: 'Analysis of malar augmentation effects on overall facial harmony and perceived attractiveness.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Midface Aesthetics in Middle Eastern Populations',\n    authors: 'Rohrich RJ, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2021,\n    summary: 'Ethnic considerations for midface enhancement in Middle Eastern patients.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['middle_eastern'],\n  },\n  // Foundational/Non-Surgical Research\n  {\n    title: 'Mewing and Orthotropic Treatment',\n    authors: 'Mew J, Mew M',\n    journal: 'International Journal of Orthodontics',\n    year: 2014,\n    summary: 'Research on proper tongue posture and its effects on facial development and structure.',\n    procedureRefs: ['FND-02', 'FND-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Effects of Body Composition on Facial Aesthetics',\n    authors: 'Morrison CS, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2017,\n    summary: 'Study on how body fat percentage affects facial definition and perceived attractiveness.',\n    procedureRefs: ['FND-04', 'FND-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Grooming and First Impressions',\n    authors: 'Phelan C, Etcoff N',\n    journal: 'Journal of Applied Social Psychology',\n    year: 2011,\n    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n    procedureRefs: ['FND-01', 'FND-06', 'FND-07'],\n    genderRelevance: 'both',\n  },\n  // Orthognathic Research\n  {\n    title: 'Bimaxillary Surgery Outcomes',\n    authors: 'Rustemeyer J, et al.',\n    journal: 'Journal of Cranio-Maxillofacial Surgery',\n    year: 2019,\n    summary: 'Long-term outcomes and patient satisfaction following double jaw surgery.',\n    procedureRefs: ['SUR-04'],\n    genderRelevance: 'both',\n  },\n  // General Attractiveness Research\n  {\n    title: 'Cross-Cultural Facial Attractiveness',\n    authors: 'Perrett DI, et al.',\n    journal: 'Nature',\n    year: 1998,\n    summary: 'Landmark study on universal vs. culture-specific aspects of facial attractiveness.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Golden Ratios in Facial Beauty',\n    authors: 'Marquardt SR',\n    journal: 'International Journal of Cosmetic Surgery',\n    year: 2002,\n    summary: 'Analysis of mathematical proportions and their relationship to perceived facial beauty.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06', 'MIN-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n];\n\nfunction getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  return RESEARCH_CITATIONS.filter(citation => {\n    // Must match the procedure\n    if (!citation.procedureRefs.includes(procedureRefId)) return false;\n\n    // Check gender relevance\n    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {\n      if (citation.genderRelevance !== gender) return false;\n    }\n\n    // Check ethnicity relevance\n    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {\n      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation\n      if (!citation.ethnicityRelevance.includes(ethnicity)) {\n        // Only exclude if the citation is ethnicity-specific\n        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  }).slice(0, 3); // Limit to 3 most relevant citations\n}\n\ninterface TrackerState {\n  notes: string;\n  checklist: Array<{ id: string; text: string; completed: boolean }>;\n}\n\n// ============================================\n// PHASE BADGE (Dark Theme)\n// ============================================\n\nfunction PhaseBadge({ phase }: { phase: string }) {\n  const getPhaseConfig = () => {\n    switch (phase) {\n      case 'Foundational':\n        return {\n          bg: 'bg-emerald-500/20',\n          text: 'text-emerald-400',\n          border: 'border-emerald-500/30',\n        };\n      case 'Minimally Invasive':\n        return {\n          bg: 'bg-blue-500/20',\n          text: 'text-blue-400',\n          border: 'border-blue-500/30',\n        };\n      case 'Surgical':\n        return {\n          bg: 'bg-purple-500/20',\n          text: 'text-purple-400',\n          border: 'border-purple-500/30',\n        };\n      default:\n        return {\n          bg: 'bg-neutral-500/20',\n          text: 'text-neutral-400',\n          border: 'border-neutral-500/30',\n        };\n    }\n  };\n\n  const config = getPhaseConfig();\n\n  return (\n    <span\n      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}\n    >\n      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}\n    </span>\n  );\n}\n\n// ============================================\n// IMPACT BADGE\n// ============================================\n\nfunction ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {\n  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);\n\n  return (\n    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n      <span className=\"flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0\">\n        <Sparkles className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n        {formattedImpact}\n      </span>\n      {(frontImpact !== undefined || sideImpact !== undefined) && (\n        <span className=\"hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0\">\n          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}\n          </span>\n          <span className=\"text-neutral-600\">|</span>\n          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}\n          </span>\n        </span>\n      )}\n    </div>\n  );\n}\n\n// ============================================\n// IMPROVEMENT TAG\n// ============================================\n\nfunction ImprovementTag({ text }: { text: string }) {\n  return (\n    <div className=\"inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm\">\n      <CheckCircle className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0\" />\n      <span className=\"truncate\">{text}</span>\n    </div>\n  );\n}\n\n// ============================================\n// SECTION HEADER\n// ============================================\n\nfunction SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {\n  return (\n    <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3\">\n      <Icon className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n      {title}\n    </h4>\n  );\n}\n\n// ============================================\n// MY TRACKER SECTION\n// ============================================\n\nfunction MyTracker({\n  tracker,\n  onNotesChange,\n  onAddChecklistItem,\n  onToggleChecklistItem,\n  onRemoveChecklistItem\n}: {\n  tracker: TrackerState;\n  onNotesChange: (notes: string) => void;\n  onAddChecklistItem: () => void;\n  onToggleChecklistItem: (id: string) => void;\n  onRemoveChecklistItem: (id: string) => void;\n}) {\n  return (\n    <div className=\"md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full\">\n      <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4\">\n        <BookOpen className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n        My Tracker\n      </h4>\n      <div className=\"space-y-3 sm:space-y-4\">\n        {/* Personal Notes */}\n        <div className=\"space-y-1 sm:space-y-1.5\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400\">Personal Notes</label>\n          <textarea\n            value={tracker.notes}\n            onChange={(e) => onNotesChange(e.target.value)}\n            className=\"w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all\"\n            placeholder=\"Track progress, questions, dates...\"\n          />\n        </div>\n\n        {/* Checklist */}\n        <div className=\"space-y-1.5 sm:space-y-2 pt-1 sm:pt-2\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center\">\n            <span>Checklist</span>\n            <button\n              onClick={onAddChecklistItem}\n              className=\"text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors\"\n            >\n              <Plus className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n              Add\n            </button>\n          </label>\n          <div className=\"space-y-1.5 sm:space-y-2\">\n            {tracker.checklist.length === 0 ? (\n              <div className=\"text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50\">\n                No tasks yet\n              </div>\n            ) : (\n              tracker.checklist.map((item) => (\n                <div\n                  key={item.id}\n                  className=\"flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg\"\n                >\n                  <button\n                    onClick={() => onToggleChecklistItem(item.id)}\n                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${\n                      item.completed\n                        ? 'bg-emerald-500 border-emerald-500'\n                        : 'border-neutral-600 hover:border-neutral-500'\n                    }`}\n                  >\n                    {item.completed && <CheckCircle className=\"w-3 h-3 text-black\" />}\n                  </button>\n                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>\n                    {item.text}\n                  </span>\n                  <button\n                    onClick={() => onRemoveChecklistItem(item.id)}\n                    className=\"text-neutral-600 hover:text-red-400 transition-colors\"\n                  >\n                    <Trash2 className=\"w-3 h-3\" />\n                  </button>\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// MAIN ENHANCED RECOMMENDATION CARD\n// ============================================\n\nexport function EnhancedRecommendationCard({\n  recommendation,\n  isExpanded = false,\n  onToggle,\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  rank,\n  onMarkComplete,\n  onRemove,\n  isCompleted = false,\n  gender,\n  ethnicity,\n}: EnhancedRecommendationCardProps) {\n  // Tracker state (would be persisted in real app)\n  const [tracker, setTracker] = useState<TrackerState>({\n    notes: '',\n    checklist: [],\n  });\n\n  // Get relevant research citations based on procedure, gender, and ethnicity\n  const citations = useMemo(() => {\n    return getRelevantCitations(recommendation.ref_id, gender, ethnicity);\n  }, [recommendation.ref_id, gender, ethnicity]);\n\n  const handleNotesChange = useCallback((notes: string) => {\n    setTracker(prev => ({ ...prev, notes }));\n  }, []);\n\n  const handleAddChecklistItem = useCallback(() => {\n    const text = window.prompt('Enter task:');\n    if (text) {\n      setTracker(prev => ({\n        ...prev,\n        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],\n      }));\n    }\n  }, []);\n\n  const handleToggleChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.map(item =>\n        item.id === id ? { ...item, completed: !item.completed } : item\n      ),\n    }));\n  }, []);\n\n  const handleRemoveChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.filter(item => item.id !== id),\n    }));\n  }, []);\n\n  // Format cost\n  const formatCost = () => {\n    const { min, max, type } = recommendation.cost;\n    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';\n    if (min === max) {\n      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n    }\n    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n  };\n\n  // Format timeline\n  const formatTimeline = () => {\n    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;\n    if (full_results_weeks_max) {\n      return `${full_results_weeks}-${full_results_weeks_max} weeks`;\n    }\n    if (full_results_weeks >= 52) {\n      const months = Math.round(full_results_weeks / 4);\n      return `${months} months`;\n    }\n    return `${full_results_weeks} weeks`;\n  };\n\n  // Get effectiveness level\n  const getEffectiveness = () => {\n    if (recommendation.impact >= 0.7) return 'high';\n    if (recommendation.impact >= 0.4) return 'moderate';\n    return 'low';\n  };\n\n  return (\n    <motion.div\n      layout\n      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${\n        isExpanded\n          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'\n          : 'border-neutral-800 hover:border-neutral-700'\n      } ${isCompleted ? 'opacity-60' : ''}`}\n    >\n      {/* Header - Clickable */}\n      <div className=\"p-3.5 sm:p-5 cursor-pointer\" onClick={onToggle}>\n        <div className=\"space-y-3 sm:space-y-4\">\n          <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2\">\n                <h3 className=\"text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white\">\n                  {recommendation.name}\n                </h3>\n                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n                  <PhaseBadge phase={recommendation.phase} />\n                  <ImpactBadge impact={recommendation.impact} />\n                </div>\n              </div>\n              <p className=\"text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none\">\n                {recommendation.description}\n              </p>\n            </div>\n\n            {/* Action buttons */}\n            <div className=\"flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto\">\n              {onMarkComplete && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onMarkComplete(recommendation.ref_id);\n                  }}\n                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${\n                    isCompleted\n                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'\n                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'\n                  }`}\n                  title=\"Mark as complete\"\n                >\n                  <CheckCircle className=\"w-4 h-4\" />\n                </button>\n              )}\n              {onRemove && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onRemove(recommendation.ref_id);\n                  }}\n                  className=\"p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10\"\n                  title=\"Remove action\"\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </button>\n              )}\n            </div>\n          </div>\n\n          {/* Quick stats row */}\n          <div className=\"flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400\">\n            <div className=\"flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5\">\n              <div className=\"flex items-center gap-1 sm:gap-1.5\" title=\"Estimated Cost\">\n                <DollarSign className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                <span className=\"font-medium text-neutral-300\">{formatCost()}</span>\n              </div>\n              {recommendation.timeline.full_results_weeks > 0 && (\n                <div className=\"flex items-center gap-1 sm:gap-1.5\">\n                  <Clock className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                  <span className=\"font-medium text-neutral-300\">{formatTimeline()}</span>\n                </div>\n              )}\n            </div>\n            <button\n              className=\"flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white\"\n            >\n              {isExpanded ? 'Less' : 'More'}\n              <ChevronDown\n                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n              />\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded Content */}\n      <AnimatePresence initial={false}>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.3 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"border-t border-neutral-800 bg-neutral-900/50\">\n              <div className=\"grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800\">\n                {/* Main Content */}\n                <div className=\"md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6\">\n                  {/* Improvements */}\n                  <div>\n                    <SectionHeader icon={Target} title=\"Improvements\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\n                        {recommendation.matchedFlaws.map((flaw, i) => (\n                          <ImprovementTag key={i} text={flaw} />\n                        ))}\n                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (\n                          <ImprovementTag key={i} text={ratio} />\n                        ))}\n                      </div>\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n                          <div className=\"text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase\">Effectiveness</div>\n                          <div className=\"h-1 w-1 rounded-full bg-neutral-600\" />\n                          <div className=\"font-medium text-white capitalize text-xs sm:text-sm\">{getEffectiveness()}</div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* How It Helps */}\n                  <div>\n                    <SectionHeader icon={Info} title=\"How It Helps\" />\n                    <div className=\"space-y-1.5 sm:space-y-2\">\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                          {recommendation.description}\n                        </p>\n                      </div>\n                      {recommendation.ratios_impacted.length > 0 && (\n                        <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                          <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}\n                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Logistics & Timeline */}\n                  {recommendation.timeline.full_results_weeks > 0 && (\n                    <div>\n                      <SectionHeader icon={Clock} title=\"Logistics & Timeline\" />\n                      <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Effect Starts\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white capitalize\">\n                            {recommendation.timeline.effect_start}\n                          </span>\n                        </div>\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Full Results\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white\">\n                            {formatTimeline()}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Considerations */}\n                  <div>\n                    <SectionHeader icon={AlertTriangle} title=\"Considerations\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      {/* Prerequisites */}\n                      {recommendation.warnings.length > 0 && (\n                        <div className=\"bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm\">\n                          <span className=\"font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">Prerequisites</span>\n                          <p className=\"text-blue-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.warnings[0]}\n                          </p>\n                        </div>\n                      )}\n\n                      {/* Risks & Side Effects */}\n                      {recommendation.risks_side_effects && (\n                        <div className=\"bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm\">\n                          <span className=\"font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">\n                            Risks & Side Effects\n                          </span>\n                          <p className=\"text-amber-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.risks_side_effects}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Notes & Warnings */}\n                  {recommendation.warnings.length > 1 && (\n                    <div className=\"text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic\">\n                      {recommendation.warnings.slice(1).join(' ')}\n                    </div>\n                  )}\n\n                  {/* Research Citations */}\n                  <div className=\"bg-cyan-500/10 p-3 sm:p-4 rounded-lg border border-cyan-500/30\">\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <BookOpen size={14} className=\"text-cyan-400\" />\n                      <span className=\"font-semibold text-cyan-400 text-xs sm:text-sm\">Research & Evidence</span>\n                      {ethnicity && ethnicity !== 'other' && (\n                        <span className=\"text-[9px] px-1.5 py-0.5 bg-cyan-500/20 rounded text-cyan-300 capitalize\">\n                          {ethnicity.replace('_', ' ')} focus\n                        </span>\n                      )}\n                    </div>\n                    {citations.length > 0 ? (\n                      <div className=\"space-y-2.5\">\n                        {citations.map((citation, idx) => (\n                          <div key={idx} className=\"text-[11px] sm:text-xs bg-neutral-900/50 p-2.5 rounded-lg border border-neutral-700/50\">\n                            <div className=\"flex items-start justify-between gap-2\">\n                              <div className=\"flex-1\">\n                                <div className=\"font-medium text-cyan-300 mb-0.5 line-clamp-2\">\n                                  {citation.title}\n                                </div>\n                                <div className=\"text-neutral-500 text-[10px] mb-1\">\n                                  {citation.authors} • {citation.journal} ({citation.year})\n                                </div>\n                                <div className=\"text-neutral-400 leading-relaxed\">\n                                  {citation.summary}\n                                </div>\n                              </div>\n                              {citation.doi && (\n                                <a\n                                  href={`https://doi.org/${citation.doi}`}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"flex-shrink-0 p-1 text-cyan-400 hover:text-cyan-300 transition-colors\"\n                                  title=\"View full paper\"\n                                >\n                                  <ExternalLink size={12} />\n                                </a>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-[11px] sm:text-xs text-cyan-300/70\">\n                        {recommendation.matchedFlaws.length > 0\n                          ? 'Based on facial analysis and established aesthetic research. More specific citations coming soon.'\n                          : 'No specific research citations available for this recommendation.'}\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* My Tracker Sidebar */}\n                <MyTracker\n                  tracker={tracker}\n                  onNotesChange={handleNotesChange}\n                  onAddChecklistItem={handleAddChecklistItem}\n                  onToggleChecklistItem={handleToggleChecklistItem}\n                  onRemoveChecklistItem={handleRemoveChecklistItem}\n                />\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\nexport default EnhancedRecommendationCard;\n","numLines":805,"startLine":1,"totalLines":805}}}
{"parentUuid":"7d871574-c928-4623-b0a8-78ad4a88c4c4","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"File content (27077 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","is_error":true,"tool_use_id":"toolu_01XETWEQtzEHfdafskcdvVpo"}]},"uuid":"79e006e4-fdfa-4c91-bca1-a97586e4e0cc","timestamp":"2025-12-21T14:31:23.204Z","toolUseResult":"Error: File content (27077 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content."}
{"parentUuid":"79e006e4-fdfa-4c91-bca1-a97586e4e0cc","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AEKsiPGvwU23thJEp6FRhB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The ResultsContext.tsx file is too large. Let me search for the PROCEDURE_DATABASE to see the valid ref_ids.","signature":"EpQCCkYIChgCKkCuII//Mtbq2g8TNAOWZ+4rPVIIucXdI+QKYzs/hqGfHLq/G/6EKbmIlV7hOD7aH50bQaaAiFExtcuwi4FLBg2EEgxUVQ59wQi8vLP+zWUaDHKNis1narBuSs3b3SIwV58D6Gmtiw9TnMfZj3UAIivb4pLmLhYKW/L3aGyfmpWpYc1lxUPAUqtUWgmKRlgwKny1E1RWQXQkSvh+Shl3nHRoz8teN6DfeI41RhKMxgKffcOLjjElvUxYHslXaIRZf+RFltYQC+zGvJDvDymzKWfM86xiXzgwSFHU8RDEe/cB3bTn9UGBL4623dLmWuvTm7mGcJqlLw19idlN6somWvuo+AIjlLwVi2rnz7OIGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":13216,"cache_read_input_tokens":23315,"cache_creation":{"ephemeral_5m_input_tokens":13216,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWKzc6oZzsuXVxmE1CFF7","type":"assistant","uuid":"0482df21-d520-4355-87c9-0ca62c365292","timestamp":"2025-12-21T14:31:29.207Z"}
{"parentUuid":"0482df21-d520-4355-87c9-0ca62c365292","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AEKsiPGvwU23thJEp6FRhB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QscvepT6Gu4TAEud13eqEf","name":"Grep","input":{"pattern":"PROCEDURE_DATABASE|ref_id.*SUR|ref_id.*MIN|ref_id.*FND","path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":13216,"cache_read_input_tokens":23315,"cache_creation":{"ephemeral_5m_input_tokens":13216,"ephemeral_1h_input_tokens":0},"output_tokens":193,"service_tier":"standard"}},"requestId":"req_011CWKzc6oZzsuXVxmE1CFF7","type":"assistant","uuid":"2f015b77-6a0c-4e70-9094-bcbc02627321","timestamp":"2025-12-21T14:31:31.127Z"}
{"parentUuid":"2f015b77-6a0c-4e70-9094-bcbc02627321","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'","is_error":true,"tool_use_id":"toolu_01QscvepT6Gu4TAEud13eqEf"}]},"uuid":"cbd07eb0-86a0-4ac0-a8f8-a2f7ce211a90","timestamp":"2025-12-21T14:31:31.149Z","toolUseResult":"Error: ENOENT: no such file or directory, posix_spawn '/opt/homebrew/Caskroom/claude-code/2.0.70/claude'"}
{"parentUuid":"cbd07eb0-86a0-4ac0-a8f8-a2f7ce211a90","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_014piacsPRPvhAWthGeRFfAd","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me try reading specific portions of the file to find the PROCEDURE_DATABASE.","signature":"EvgBCkYIChgCKkDLPdSM2fgUAybfxbxOPrc48xKfNIsWxp55vfv5iFFDJnuw3dQ4B+GMuLFZf58yEPqoLmR6ZDEIyqJet+4M6QUeEgwPogAFEPnsA/g4a0QaDHC8uStlewZ/qjgmsSIwVpcmY7sh5ZVpkurB99w5l5KEAFx8Qdg8EaNPUlfbfGEvubW8qQmVYZcLh9RPQJ+HKmAkgIdxj9P8CrUn897dwZP38ROCsUZzS3j67eHTgrInucvGSREMe+xRfyYo4hbiTrKDDefRWtYujhuB6xZg3cEq5uu0BwiPb9mfxVtDla/Dl1/mLXcxHR7UySYdRFcT0BgYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":258,"cache_read_input_tokens":36531,"cache_creation":{"ephemeral_5m_input_tokens":258,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWKzcgkzJ9fLwTac52ud3","type":"assistant","uuid":"2dd00c33-e400-4806-b106-0ec533c95951","timestamp":"2025-12-21T14:31:36.215Z"}
{"parentUuid":"2dd00c33-e400-4806-b106-0ec533c95951","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_014piacsPRPvhAWthGeRFfAd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NfZjXZgWVde3mYjB5SJHFz","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","offset":1,"limit":500}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":258,"cache_read_input_tokens":36531,"cache_creation":{"ephemeral_5m_input_tokens":258,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWKzcgkzJ9fLwTac52ud3","type":"assistant","uuid":"31ee32cb-6498-421f-b766-451fdd067a6e","timestamp":"2025-12-21T14:31:36.869Z"}
{"parentUuid":"31ee32cb-6498-421f-b766-451fdd067a6e","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NfZjXZgWVde3mYjB5SJHFz","type":"tool_result","content":"     1→'use client';\n     2→\n     3→import React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\n     4→import { LandmarkPoint } from '@/lib/landmarks';\n     5→import {\n     6→  analyzeFrontProfile,\n     7→  analyzeSideProfile,\n     8→  analyzeHarmony,\n     9→  HarmonyAnalysis,\n    10→  FaceIQScoreResult,\n    11→  FACEIQ_METRICS,\n    12→  Ethnicity,\n    13→  Gender,\n    14→} from '@/lib/faceiq-scoring';\n    15→import {\n    16→  calculateHarmonyScore,\n    17→  getTopMetrics,\n    18→  getBottomMetrics,\n    19→  HarmonyScoreResult,\n    20→  RankedMetric,\n    21→} from '@/lib/looksmax-scoring';\n    22→import {\n    23→  classifyInsights,\n    24→  convertToStrength,\n    25→  convertToFlaw,\n    26→  INSIGHTS_DEFINITIONS,\n    27→} from '@/lib/insights-engine';\n    28→import {\n    29→  Ratio,\n    30→  Strength,\n    31→  Flaw,\n    32→  Recommendation,\n    33→  ResultsTab,\n    34→  FullHarmonyAnalysis,\n    35→} from '@/types/results';\n    36→\n    37→// ============================================\n    38→// CONTEXT TYPES\n    39→// ============================================\n    40→\n    41→interface ResultsContextType {\n    42→  // Raw data\n    43→  frontLandmarks: LandmarkPoint[];\n    44→  sideLandmarks: LandmarkPoint[];\n    45→  gender: Gender;\n    46→  ethnicity: Ethnicity;\n    47→  frontPhoto: string;\n    48→  sidePhoto: string | null;\n    49→\n    50→  // Computed results\n    51→  harmonyAnalysis: FullHarmonyAnalysis | null;\n    52→  frontRatios: Ratio[];\n    53→  sideRatios: Ratio[];\n    54→  strengths: Strength[];\n    55→  flaws: Flaw[];\n    56→  recommendations: Recommendation[];\n    57→\n    58→  // Scores (now using weighted harmony from looksmax_engine.py)\n    59→  overallScore: number;\n    60→  frontScore: number;\n    61→  sideScore: number;\n    62→\n    63→  // Weighted Harmony Score (from looksmax_engine.py)\n    64→  harmonyScoreResult: HarmonyScoreResult | null;\n    65→  harmonyPercentage: number;  // 0-100% weighted harmony\n    66→\n    67→  // Top 3 strengths and bottom 3 areas to improve with advice\n    68→  topMetrics: RankedMetric[];\n    69→  bottomMetrics: RankedMetric[];\n    70→\n    71→  // UI state\n    72→  activeTab: ResultsTab;\n    73→  setActiveTab: (tab: ResultsTab) => void;\n    74→  expandedMeasurementId: string | null;\n    75→  setExpandedMeasurementId: (id: string | null) => void;\n    76→  selectedVisualizationMetric: string | null;\n    77→  setSelectedVisualizationMetric: (id: string | null) => void;\n    78→  categoryFilter: string | null;\n    79→  setCategoryFilter: (category: string | null) => void;\n    80→  showLandmarkOverlay: boolean;\n    81→  setShowLandmarkOverlay: (show: boolean) => void;\n    82→\n    83→  // Actions\n    84→  setResultsData: (data: ResultsInputData) => void;\n    85→}\n    86→\n    87→interface ResultsInputData {\n    88→  frontLandmarks: LandmarkPoint[];\n    89→  sideLandmarks: LandmarkPoint[];\n    90→  frontPhoto: string;\n    91→  sidePhoto?: string;\n    92→  gender: Gender;\n    93→  ethnicity?: Ethnicity;\n    94→}\n    95→\n    96→// ============================================\n    97→// HELPER FUNCTIONS\n    98→// ============================================\n    99→\n   100→function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n   101→  switch (unit) {\n   102→    case 'ratio': return 'x';\n   103→    case 'percent': return '%';\n   104→    case 'degrees': return '°';\n   105→    case 'mm': return 'mm';\n   106→    default: return 'x';\n   107→  }\n   108→}\n   109→\n   110→function transformToRatio(result: FaceIQScoreResult, landmarks: LandmarkPoint[]): Ratio {\n   111→  const metricConfig = FACEIQ_METRICS[result.metricId];\n   112→\n   113→  // Generate illustration based on metric\n   114→  const illustration = generateIllustration(result.metricId, landmarks);\n   115→\n   116→  // Get flaw/strength mappings\n   117→  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n   118→\n   119→  return {\n   120→    id: result.metricId,\n   121→    name: result.name,\n   122→    value: result.value,\n   123→    score: result.score,\n   124→    standardizedScore: result.standardizedScore,\n   125→    unit: convertUnitToRatioUnit(result.unit),\n   126→    idealMin: result.idealMin,\n   127→    idealMax: result.idealMax,\n   128→    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n   129→    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n   130→    description: metricConfig?.description || '',\n   131→    category: result.category,\n   132→    qualityLevel: result.qualityTier,\n   133→    severity: result.severity,\n   134→    illustration,\n   135→    mayIndicateFlaws,\n   136→    mayIndicateStrengths,\n   137→    usedLandmarks: getUsedLandmarks(result.metricId),\n   138→    scoringCurveConfig: metricConfig ? {\n   139→      decayRate: metricConfig.decayRate,\n   140→      maxScore: metricConfig.maxScore,\n   141→    } : undefined,\n   142→  };\n   143→}\n   144→\n   145→// Enhanced illustration configuration type\n   146→interface IllustrationConfig {\n   147→  points: string[];\n   148→  lines: Array<{\n   149→    from: string;\n   150→    to: string;\n   151→    label?: string;\n   152→    color?: string;\n   153→    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n   154→  }>;\n   155→}\n   156→\n   157→// Comprehensive illustration configurations for all metrics\n   158→const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n   159→  // ==========================================\n   160→  // FACE SHAPE / PROPORTIONS\n   161→  // ==========================================\n   162→  faceWidthToHeight: {\n   163→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   164→    lines: [\n   165→      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n   166→      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n   167→    ],\n   168→  },\n   169→  totalFacialWidthToHeight: {\n   170→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n   171→    lines: [\n   172→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   173→      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n   174→    ],\n   175→  },\n   176→  lowerThirdProportion: {\n   177→    points: ['subnasale', 'menton', 'trichion'],\n   178→    lines: [\n   179→      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n   180→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   181→    ],\n   182→  },\n   183→  middleThirdProportion: {\n   184→    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n   185→    lines: [\n   186→      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n   187→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   188→    ],\n   189→  },\n   190→  upperThirdProportion: {\n   191→    points: ['trichion', 'nasal_base', 'menton'],\n   192→    lines: [\n   193→      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n   194→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n   195→    ],\n   196→  },\n   197→  bitemporalWidth: {\n   198→    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n   199→    lines: [\n   200→      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n   201→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n   202→    ],\n   203→  },\n   204→  cheekboneHeight: {\n   205→    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n   206→    lines: [\n   207→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n   208→      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n   209→    ],\n   210→  },\n   211→  midfaceRatio: {\n   212→    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n   213→    lines: [\n   214→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n   215→      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n   216→    ],\n   217→  },\n   218→\n   219→  // ==========================================\n   220→  // JAW MEASUREMENTS\n   221→  // ==========================================\n   222→  jawSlope: {\n   223→    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n   224→    lines: [\n   225→      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n   226→      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n   227→    ],\n   228→  },\n   229→  jawFrontalAngle: {\n   230→    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n   231→    lines: [\n   232→      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n   233→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n   234→    ],\n   235→  },\n   236→  bigonialWidth: {\n   237→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   238→    lines: [\n   239→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n   240→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n   241→    ],\n   242→  },\n   243→  jawWidthRatio: {\n   244→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n   245→    lines: [\n   246→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   247→      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n   248→    ],\n   249→  },\n   250→\n   251→  // ==========================================\n   252→  // EYE MEASUREMENTS\n   253→  // ==========================================\n   254→  lateralCanthalTilt: {\n   255→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n   256→    lines: [\n   257→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n   258→      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n   259→    ],\n   260→  },\n   261→  eyeAspectRatio: {\n   262→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n   263→    lines: [\n   264→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n   265→      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n   266→    ],\n   267→  },\n   268→  eyeSeparationRatio: {\n   269→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n   270→    lines: [\n   271→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   272→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   273→    ],\n   274→  },\n   275→  interpupillaryRatio: {\n   276→    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n   277→    lines: [\n   278→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   279→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   280→    ],\n   281→  },\n   282→  interpupillaryMouthWidthRatio: {\n   283→    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n   284→    lines: [\n   285→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n   286→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   287→    ],\n   288→  },\n   289→  oneEyeApartTest: {\n   290→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n   291→    lines: [\n   292→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n   293→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n   294→    ],\n   295→  },\n   296→\n   297→  // ==========================================\n   298→  // EYEBROW MEASUREMENTS\n   299→  // ==========================================\n   300→  browLengthRatio: {\n   301→    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n   302→    lines: [\n   303→      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n   304→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n   305→    ],\n   306→  },\n   307→  eyebrowTilt: {\n   308→    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n   309→    lines: [\n   310→      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n   311→      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n   312→    ],\n   313→  },\n   314→  eyebrowLowSetedness: {\n   315→    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n   316→    lines: [\n   317→      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n   318→    ],\n   319→  },\n   320→\n   321→  // ==========================================\n   322→  // NOSE MEASUREMENTS (FRONT)\n   323→  // ==========================================\n   324→  nasalIndex: {\n   325→    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n   326→    lines: [\n   327→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n   328→      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n   329→    ],\n   330→  },\n   331→  intercanthalNasalRatio: {\n   332→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n   333→    lines: [\n   334→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n   335→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n   336→    ],\n   337→  },\n   338→  noseBridgeWidth: {\n   339→    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n   340→    lines: [\n   341→      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n   342→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n   343→    ],\n   344→  },\n   345→  noseTipPosition: {\n   346→    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n   347→    lines: [\n   348→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n   349→    ],\n   350→  },\n   351→\n   352→  // ==========================================\n   353→  // MOUTH/LIP MEASUREMENTS\n   354→  // ==========================================\n   355→  mouthNoseWidthRatio: {\n   356→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n   357→    lines: [\n   358→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n   359→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n   360→    ],\n   361→  },\n   362→  lowerUpperLipRatio: {\n   363→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n   364→    lines: [\n   365→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n   366→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n   367→    ],\n   368→  },\n   369→  chinPhiltrumRatio: {\n   370→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n   371→    lines: [\n   372→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n   373→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n   374→    ],\n   375→  },\n   376→  mouthWidth: {\n   377→    points: ['left_cheilion', 'right_cheilion'],\n   378→    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n   379→  },\n   380→\n   381→  // ==========================================\n   382→  // CHIN MEASUREMENTS\n   383→  // ==========================================\n   384→  chinHeight: {\n   385→    points: ['labrale_inferius', 'menton'],\n   386→    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n   387→  },\n   388→\n   389→  // ==========================================\n   390→  // NECK MEASUREMENTS\n   391→  // ==========================================\n   392→  neckWidthRatio: {\n   393→    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n   394→    lines: [\n   395→      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n   396→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n   397→    ],\n   398→  },\n   399→\n   400→  // ==========================================\n   401→  // SIDE PROFILE MEASUREMENTS\n   402→  // ==========================================\n   403→  gonialAngle: {\n   404→    points: ['tragus', 'gonionBottom', 'menton'],\n   405→    lines: [\n   406→      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   407→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   408→    ],\n   409→  },\n   410→  nasofrontalAngle: {\n   411→    points: ['glabella', 'nasion', 'pronasale'],\n   412→    lines: [\n   413→      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n   414→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   415→    ],\n   416→  },\n   417→  nasofacialAngle: {\n   418→    points: ['nasion', 'pronasale', 'pogonion'],\n   419→    lines: [\n   420→      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n   421→      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n   422→    ],\n   423→  },\n   424→  nasomentaAngle: {\n   425→    points: ['nasion', 'pronasale', 'pogonion'],\n   426→    lines: [\n   427→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n   428→      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n   429→    ],\n   430→  },\n   431→  submentalCervicalAngle: {\n   432→    points: ['menton', 'cervicalPoint', 'neckPoint'],\n   433→    lines: [\n   434→      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n   435→      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n   436→    ],\n   437→  },\n   438→  facialDepthToHeight: {\n   439→    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n   440→    lines: [\n   441→      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n   442→      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n   443→    ],\n   444→  },\n   445→  anteriorFacialDepth: {\n   446→    points: ['glabella', 'pronasale', 'pogonion'],\n   447→    lines: [\n   448→      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n   449→      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n   450→    ],\n   451→  },\n   452→  mandibularPlaneAngle: {\n   453→    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n   454→    lines: [\n   455→      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n   456→      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n   457→    ],\n   458→  },\n   459→  ramusToMandibleRatio: {\n   460→    points: ['gonionTop', 'gonionBottom', 'menton'],\n   461→    lines: [\n   462→      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n   463→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n   464→    ],\n   465→  },\n   466→  orbitalVector: {\n   467→    points: ['cornealApex', 'orbitale', 'cheekbone'],\n   468→    lines: [\n   469→      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n   470→    ],\n   471→  },\n   472→  eLineLowerLip: {\n   473→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   474→    lines: [\n   475→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n   476→    ],\n   477→  },\n   478→  sLineLowerLip: {\n   479→    points: ['pronasale', 'pogonion', 'labraleInferius'],\n   480→    lines: [\n   481→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n   482→    ],\n   483→  },\n   484→  holdawayHLine: {\n   485→    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n   486→    lines: [\n   487→      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n   488→    ],\n   489→  },\n   490→  burstoneLowerLip: {\n   491→    points: ['subnasale', 'pogonion', 'labraleInferius'],\n   492→    lines: [\n   493→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n   494→    ],\n   495→  },\n   496→\n   497→  // ==========================================\n   498→  // ADDITIONAL FRONT PROFILE METRICS\n   499→  // ==========================================\n   500→  cupidsBowDepth: {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"c2d94c26-6231-4b5f-b296-93f9afa5fd18","timestamp":"2025-12-21T14:31:36.912Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","content":"'use client';\n\nimport React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';\nimport { LandmarkPoint } from '@/lib/landmarks';\nimport {\n  analyzeFrontProfile,\n  analyzeSideProfile,\n  analyzeHarmony,\n  HarmonyAnalysis,\n  FaceIQScoreResult,\n  FACEIQ_METRICS,\n  Ethnicity,\n  Gender,\n} from '@/lib/faceiq-scoring';\nimport {\n  calculateHarmonyScore,\n  getTopMetrics,\n  getBottomMetrics,\n  HarmonyScoreResult,\n  RankedMetric,\n} from '@/lib/looksmax-scoring';\nimport {\n  classifyInsights,\n  convertToStrength,\n  convertToFlaw,\n  INSIGHTS_DEFINITIONS,\n} from '@/lib/insights-engine';\nimport {\n  Ratio,\n  Strength,\n  Flaw,\n  Recommendation,\n  ResultsTab,\n  FullHarmonyAnalysis,\n} from '@/types/results';\n\n// ============================================\n// CONTEXT TYPES\n// ============================================\n\ninterface ResultsContextType {\n  // Raw data\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  gender: Gender;\n  ethnicity: Ethnicity;\n  frontPhoto: string;\n  sidePhoto: string | null;\n\n  // Computed results\n  harmonyAnalysis: FullHarmonyAnalysis | null;\n  frontRatios: Ratio[];\n  sideRatios: Ratio[];\n  strengths: Strength[];\n  flaws: Flaw[];\n  recommendations: Recommendation[];\n\n  // Scores (now using weighted harmony from looksmax_engine.py)\n  overallScore: number;\n  frontScore: number;\n  sideScore: number;\n\n  // Weighted Harmony Score (from looksmax_engine.py)\n  harmonyScoreResult: HarmonyScoreResult | null;\n  harmonyPercentage: number;  // 0-100% weighted harmony\n\n  // Top 3 strengths and bottom 3 areas to improve with advice\n  topMetrics: RankedMetric[];\n  bottomMetrics: RankedMetric[];\n\n  // UI state\n  activeTab: ResultsTab;\n  setActiveTab: (tab: ResultsTab) => void;\n  expandedMeasurementId: string | null;\n  setExpandedMeasurementId: (id: string | null) => void;\n  selectedVisualizationMetric: string | null;\n  setSelectedVisualizationMetric: (id: string | null) => void;\n  categoryFilter: string | null;\n  setCategoryFilter: (category: string | null) => void;\n  showLandmarkOverlay: boolean;\n  setShowLandmarkOverlay: (show: boolean) => void;\n\n  // Actions\n  setResultsData: (data: ResultsInputData) => void;\n}\n\ninterface ResultsInputData {\n  frontLandmarks: LandmarkPoint[];\n  sideLandmarks: LandmarkPoint[];\n  frontPhoto: string;\n  sidePhoto?: string;\n  gender: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// HELPER FUNCTIONS\n// ============================================\n\nfunction convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {\n  switch (unit) {\n    case 'ratio': return 'x';\n    case 'percent': return '%';\n    case 'degrees': return '°';\n    case 'mm': return 'mm';\n    default: return 'x';\n  }\n}\n\nfunction transformToRatio(result: FaceIQScoreResult, landmarks: LandmarkPoint[]): Ratio {\n  const metricConfig = FACEIQ_METRICS[result.metricId];\n\n  // Generate illustration based on metric\n  const illustration = generateIllustration(result.metricId, landmarks);\n\n  // Get flaw/strength mappings\n  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);\n\n  return {\n    id: result.metricId,\n    name: result.name,\n    value: result.value,\n    score: result.score,\n    standardizedScore: result.standardizedScore,\n    unit: convertUnitToRatioUnit(result.unit),\n    idealMin: result.idealMin,\n    idealMax: result.idealMax,\n    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,\n    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,\n    description: metricConfig?.description || '',\n    category: result.category,\n    qualityLevel: result.qualityTier,\n    severity: result.severity,\n    illustration,\n    mayIndicateFlaws,\n    mayIndicateStrengths,\n    usedLandmarks: getUsedLandmarks(result.metricId),\n    scoringCurveConfig: metricConfig ? {\n      decayRate: metricConfig.decayRate,\n      maxScore: metricConfig.maxScore,\n    } : undefined,\n  };\n}\n\n// Enhanced illustration configuration type\ninterface IllustrationConfig {\n  points: string[];\n  lines: Array<{\n    from: string;\n    to: string;\n    label?: string;\n    color?: string;\n    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type\n  }>;\n}\n\n// Comprehensive illustration configurations for all metrics\nconst ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {\n  // ==========================================\n  // FACE SHAPE / PROPORTIONS\n  // ==========================================\n  faceWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },\n      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },\n    ],\n  },\n  totalFacialWidthToHeight: {\n    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },\n    ],\n  },\n  lowerThirdProportion: {\n    points: ['subnasale', 'menton', 'trichion'],\n    lines: [\n      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  middleThirdProportion: {\n    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],\n    lines: [\n      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  upperThirdProportion: {\n    points: ['trichion', 'nasal_base', 'menton'],\n    lines: [\n      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },\n      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },\n    ],\n  },\n  bitemporalWidth: {\n    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },\n    ],\n  },\n  cheekboneHeight: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],\n    lines: [\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },\n      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },\n    ],\n  },\n  midfaceRatio: {\n    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },\n      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // JAW MEASUREMENTS\n  // ==========================================\n  jawSlope: {\n    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },\n      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },\n    ],\n  },\n  jawFrontalAngle: {\n    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },\n      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },\n    ],\n  },\n  bigonialWidth: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },\n    ],\n  },\n  jawWidthRatio: {\n    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },\n    ],\n  },\n\n  // ==========================================\n  // EYE MEASUREMENTS\n  // ==========================================\n  lateralCanthalTilt: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },\n      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },\n    ],\n  },\n  eyeAspectRatio: {\n    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },\n      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  eyeSeparationRatio: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  interpupillaryMouthWidthRatio: {\n    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],\n    lines: [\n      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n    ],\n  },\n  oneEyeApartTest: {\n    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],\n    lines: [\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },\n      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },\n    ],\n  },\n\n  // ==========================================\n  // EYEBROW MEASUREMENTS\n  // ==========================================\n  browLengthRatio: {\n    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },\n      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },\n    ],\n  },\n  eyebrowTilt: {\n    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },\n      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },\n    ],\n  },\n  eyebrowLowSetedness: {\n    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],\n    lines: [\n      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },\n    ],\n  },\n\n  // ==========================================\n  // NOSE MEASUREMENTS (FRONT)\n  // ==========================================\n  nasalIndex: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },\n      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  intercanthalNasalRatio: {\n    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },\n      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },\n    ],\n  },\n  noseBridgeWidth: {\n    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },\n    ],\n  },\n  noseTipPosition: {\n    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // MOUTH/LIP MEASUREMENTS\n  // ==========================================\n  mouthNoseWidthRatio: {\n    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],\n    lines: [\n      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },\n      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  lowerUpperLipRatio: {\n    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],\n    lines: [\n      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },\n      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },\n    ],\n  },\n  chinPhiltrumRatio: {\n    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],\n    lines: [\n      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },\n      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },\n    ],\n  },\n  mouthWidth: {\n    points: ['left_cheilion', 'right_cheilion'],\n    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],\n  },\n\n  // ==========================================\n  // CHIN MEASUREMENTS\n  // ==========================================\n  chinHeight: {\n    points: ['labrale_inferius', 'menton'],\n    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],\n  },\n\n  // ==========================================\n  // NECK MEASUREMENTS\n  // ==========================================\n  neckWidthRatio: {\n    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],\n    lines: [\n      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },\n      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },\n    ],\n  },\n\n  // ==========================================\n  // SIDE PROFILE MEASUREMENTS\n  // ==========================================\n  gonialAngle: {\n    points: ['tragus', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  nasofrontalAngle: {\n    points: ['glabella', 'nasion', 'pronasale'],\n    lines: [\n      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n    ],\n  },\n  nasofacialAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },\n    ],\n  },\n  nasomentaAngle: {\n    points: ['nasion', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },\n      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },\n    ],\n  },\n  submentalCervicalAngle: {\n    points: ['menton', 'cervicalPoint', 'neckPoint'],\n    lines: [\n      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },\n      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },\n    ],\n  },\n  facialDepthToHeight: {\n    points: ['pronasale', 'tragus', 'nasion', 'menton'],\n    lines: [\n      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },\n      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },\n    ],\n  },\n  anteriorFacialDepth: {\n    points: ['glabella', 'pronasale', 'pogonion'],\n    lines: [\n      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },\n      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },\n    ],\n  },\n  mandibularPlaneAngle: {\n    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],\n    lines: [\n      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },\n      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },\n    ],\n  },\n  ramusToMandibleRatio: {\n    points: ['gonionTop', 'gonionBottom', 'menton'],\n    lines: [\n      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },\n      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },\n    ],\n  },\n  orbitalVector: {\n    points: ['cornealApex', 'orbitale', 'cheekbone'],\n    lines: [\n      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },\n    ],\n  },\n  eLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },\n    ],\n  },\n  sLineLowerLip: {\n    points: ['pronasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },\n    ],\n  },\n  holdawayHLine: {\n    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],\n    lines: [\n      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },\n    ],\n  },\n  burstoneLowerLip: {\n    points: ['subnasale', 'pogonion', 'labraleInferius'],\n    lines: [\n      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },\n    ],\n  },\n\n  // ==========================================\n  // ADDITIONAL FRONT PROFILE METRICS\n  // ==========================================\n  cupidsBowDepth: {","numLines":500,"startLine":1,"totalLines":1954}}}
{"parentUuid":"c2d94c26-6231-4b5f-b296-93f9afa5fd18","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_015mtP8S8pNpRZduRvfSMUJD","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to find the PROCEDURE_DATABASE. Let me read more of the file to find it.","signature":"EvcBCkYIChgCKkAYIR/e8AGtXu6a1UUuFnUcqpQhujBt+TQprYojsxS9sAEisxD1bSsNGDsqkyBRepbFpTtNYrk8g8b/q8JoOWtuEgwgFQe/oi4QPfsdUVUaDJwZN4WNJksTDQ4pUSIwMxjntRtrKnrLAhJoa/11ylnkV3j5aW9NCrahRTtKQ9Gs8O33kyaGLMAcvtCjUZp6Kl+jhsj/wB/kyB6R33x2j+rKDKC14Ixn9A461G0amkEMQJk/0ZBL9KbQYhYwIfKib//CW+Bbt/zVIRfMh5ZhgBCz8GqWMX2F0LDBAlkWmxLKnRCF6uuVRKZL+KGFktcvuRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8891,"cache_read_input_tokens":36789,"cache_creation":{"ephemeral_5m_input_tokens":8891,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWKzd7RZQdKqCnTGK4ULE","type":"assistant","uuid":"5b7a7246-43d7-437d-bc13-34feca25e820","timestamp":"2025-12-21T14:31:42.602Z"}
{"parentUuid":"5b7a7246-43d7-437d-bc13-34feca25e820","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_015mtP8S8pNpRZduRvfSMUJD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FYD9m6qrSv4wwS2gWfnLsW","name":"Read","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","offset":1200,"limit":600}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8891,"cache_read_input_tokens":36789,"cache_creation":{"ephemeral_5m_input_tokens":8891,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWKzd7RZQdKqCnTGK4ULE","type":"assistant","uuid":"5b5e1dd1-fa77-4f5b-a0ac-db01bff615d4","timestamp":"2025-12-21T14:31:44.028Z"}
{"parentUuid":"5b5e1dd1-fa77-4f5b-a0ac-db01bff615d4","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FYD9m6qrSv4wwS2gWfnLsW","type":"tool_result","content":"  1200→    cost: { type: 'flat', min: 4000, max: 12000, currency: 'USD' },\n  1201→    risks_side_effects: 'Scarring, asymmetry, dry eyes, ectropion.',\n  1202→    warnings: ['Difficult to reverse'],\n  1203→    gender: 'both',\n  1204→  },\n  1205→  {\n  1206→    ref_id: 'SUR-06',\n  1207→    name: 'Cheek/Malar Implants',\n  1208→    description: 'Solid implants placed over the cheekbones to enhance midface projection and width.',\n  1209→    phase: 'Surgical',\n  1210→    baseImpact: 0.75,\n  1211→    coverage: 4,\n  1212→    percentage: '10-18%',\n  1213→    expectedImprovementRange: { min: 0.4, max: 0.9 },\n  1214→    targetMetrics: ['cheekboneHeight', 'midfaceRatio', 'totalFacialWidthToHeight'],\n  1215→    targetCategories: ['Midface/Face Shape'],\n  1216→    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface', 'zygomatic', 'malar'],\n  1217→    timeline: { effect_start: 'delayed', full_results_weeks: 6, full_results_weeks_max: 12 },\n  1218→    cost: { type: 'flat', min: 6000, max: 15000, currency: 'USD' },\n  1219→    risks_side_effects: 'Swelling, asymmetry, implant shifting, nerve damage.',\n  1220→    warnings: [],\n  1221→    gender: 'both',\n  1222→  },\n  1223→  {\n  1224→    ref_id: 'SUR-07',\n  1225→    name: 'Neck Liposuction / Submentoplasty',\n  1226→    description: 'Fat removal and skin tightening under the chin and neck area.',\n  1227→    phase: 'Surgical',\n  1228→    baseImpact: 0.65,\n  1229→    coverage: 3,\n  1230→    percentage: '8-12%',\n  1231→    expectedImprovementRange: { min: 0.3, max: 0.7 },\n  1232→    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],\n  1233→    targetCategories: ['Neck'],\n  1234→    targetKeywords: ['round neck', 'double chin', 'submental', 'cervical', 'neck definition'],\n  1235→    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },\n  1236→    cost: { type: 'flat', min: 3000, max: 8000, currency: 'USD' },\n  1237→    risks_side_effects: 'Swelling, bruising, skin irregularity, numbness.',\n  1238→    warnings: [],\n  1239→    gender: 'both',\n  1240→  },\n  1241→  {\n  1242→    ref_id: 'SUR-08',\n  1243→    name: 'Brow Bone Reduction/Augmentation',\n  1244→    description: 'Surgical reshaping of the brow ridge for improved upper third harmony.',\n  1245→    phase: 'Surgical',\n  1246→    baseImpact: 0.70,\n  1247→    coverage: 3,\n  1248→    percentage: '8-15%',\n  1249→    expectedImprovementRange: { min: 0.3, max: 0.7 },\n  1250→    targetMetrics: ['nasofrontalAngle', 'bitemporalWidth', 'upperThirdProportion'],\n  1251→    targetCategories: ['Upper Third'],\n  1252→    targetKeywords: ['brow ridge', 'forehead', 'nasofrontal', 'upper third', 'glabella'],\n  1253→    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },\n  1254→    cost: { type: 'flat', min: 8000, max: 20000, currency: 'USD' },\n  1255→    risks_side_effects: 'Swelling, numbness, scarring (if coronal incision).',\n  1256→    warnings: [],\n  1257→    gender: 'both',\n  1258→  },\n  1259→\n  1260→  // ==========================================\n  1261→  // MINIMALLY INVASIVE TREATMENTS\n  1262→  // ==========================================\n  1263→  {\n  1264→    ref_id: 'MIN-01',\n  1265→    name: 'Chin/Jawline Filler',\n  1266→    description: 'Hyaluronic acid injections to enhance chin projection and jawline definition. Reversible and temporary.',\n  1267→    phase: 'Minimally Invasive',\n  1268→    baseImpact: 0.45,\n  1269→    coverage: 4,\n  1270→    percentage: '5-10%',\n  1271→    expectedImprovementRange: { min: 0.2, max: 0.5 },\n  1272→    targetMetrics: ['chinPhiltrumRatio', 'jawFrontalAngle', 'bigonialWidth'],\n  1273→    targetCategories: ['Chin', 'Jaw Shape'],\n  1274→    targetKeywords: ['weak chin', 'recessed chin', 'soft jaw', 'jawline'],\n  1275→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n  1276→    cost: { type: 'per_session', min: 800, max: 2500, currency: 'USD' },\n  1277→    risks_side_effects: 'Bruising, swelling, rare vascular occlusion.',\n  1278→    warnings: ['Results temporary (12-18 months)', 'Requires maintenance'],\n  1279→    gender: 'both',\n  1280→  },\n  1281→  {\n  1282→    ref_id: 'MIN-02',\n  1283→    name: 'Cheek Filler',\n  1284→    description: 'HA filler to enhance cheekbone projection and midface volume.',\n  1285→    phase: 'Minimally Invasive',\n  1286→    baseImpact: 0.40,\n  1287→    coverage: 3,\n  1288→    percentage: '5-8%',\n  1289→    expectedImprovementRange: { min: 0.2, max: 0.4 },\n  1290→    targetMetrics: ['cheekboneHeight', 'midfaceRatio'],\n  1291→    targetCategories: ['Midface/Face Shape'],\n  1292→    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface volume'],\n  1293→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n  1294→    cost: { type: 'per_session', min: 600, max: 1800, currency: 'USD' },\n  1295→    risks_side_effects: 'Bruising, swelling, asymmetry.',\n  1296→    warnings: ['Results temporary (12-18 months)'],\n  1297→    gender: 'both',\n  1298→  },\n  1299→  {\n  1300→    ref_id: 'MIN-03',\n  1301→    name: 'Lip Filler',\n  1302→    description: 'Hyaluronic acid to enhance lip volume and proportions.',\n  1303→    phase: 'Minimally Invasive',\n  1304→    baseImpact: 0.35,\n  1305→    coverage: 2,\n  1306→    percentage: '3-6%',\n  1307→    expectedImprovementRange: { min: 0.1, max: 0.3 },\n  1308→    targetMetrics: ['lowerUpperLipRatio', 'mouthNoseWidthRatio'],\n  1309→    targetCategories: ['Lips'],\n  1310→    targetKeywords: ['thin lip', 'lip ratio', 'lip volume', 'upper lip', 'lower lip'],\n  1311→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n  1312→    cost: { type: 'per_session', min: 400, max: 1200, currency: 'USD' },\n  1313→    risks_side_effects: 'Bruising, swelling, lumps.',\n  1314→    warnings: ['Results temporary (6-12 months)'],\n  1315→    gender: 'both',\n  1316→  },\n  1317→  {\n  1318→    ref_id: 'MIN-04',\n  1319→    name: 'PDO Thread Lift',\n  1320→    description: 'Dissolvable threads to lift and tighten skin, particularly for canthal tilt improvement.',\n  1321→    phase: 'Minimally Invasive',\n  1322→    baseImpact: 0.35,\n  1323→    coverage: 3,\n  1324→    percentage: '4-8%',\n  1325→    expectedImprovementRange: { min: 0.1, max: 0.4 },\n  1326→    targetMetrics: ['lateralCanthalTilt', 'eyebrowLowSetedness'],\n  1327→    targetCategories: ['Eyes', 'Upper Third'],\n  1328→    targetKeywords: ['canthal tilt', 'drooping', 'sagging', 'eyebrow position'],\n  1329→    timeline: { effect_start: 'immediate', full_results_weeks: 4, full_results_weeks_max: 12 },\n  1330→    cost: { type: 'per_session', min: 1500, max: 4000, currency: 'USD' },\n  1331→    risks_side_effects: 'Bruising, asymmetry, thread visibility, infection.',\n  1332→    warnings: ['Results temporary (12-18 months)'],\n  1333→    gender: 'both',\n  1334→  },\n  1335→  {\n  1336→    ref_id: 'MIN-05',\n  1337→    name: 'Masseter Botox',\n  1338→    description: 'Botulinum toxin to slim the lower face by relaxing masseter muscles.',\n  1339→    phase: 'Minimally Invasive',\n  1340→    baseImpact: 0.40,\n  1341→    coverage: 2,\n  1342→    percentage: '4-8%',\n  1343→    expectedImprovementRange: { min: 0.2, max: 0.4 },\n  1344→    targetMetrics: ['bigonialWidth', 'jawWidthRatio', 'faceWidthToHeight'],\n  1345→    targetCategories: ['Jaw Shape', 'Midface/Face Shape'],\n  1346→    targetKeywords: ['wide jaw', 'square jaw', 'masseter', 'bruxism'],\n  1347→    timeline: { effect_start: 'delayed', full_results_weeks: 4, full_results_weeks_max: 12 },\n  1348→    cost: { type: 'per_session', min: 400, max: 1000, currency: 'USD' },\n  1349→    risks_side_effects: 'Temporary weakness, asymmetry, difficulty chewing.',\n  1350→    warnings: ['Results temporary (4-6 months)', 'Requires regular maintenance'],\n  1351→    gender: 'both',\n  1352→  },\n  1353→  {\n  1354→    ref_id: 'MIN-06',\n  1355→    name: 'Kybella (Submental Fat Dissolving)',\n  1356→    description: 'Injectable deoxycholic acid to permanently destroy fat cells under the chin.',\n  1357→    phase: 'Minimally Invasive',\n  1358→    baseImpact: 0.45,\n  1359→    coverage: 2,\n  1360→    percentage: '5-10%',\n  1361→    expectedImprovementRange: { min: 0.2, max: 0.5 },\n  1362→    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],\n  1363→    targetCategories: ['Neck'],\n  1364→    targetKeywords: ['double chin', 'submental fat', 'neck definition'],\n  1365→    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },\n  1366→    cost: { type: 'per_session', min: 1200, max: 1800, currency: 'USD' },\n  1367→    risks_side_effects: 'Swelling, bruising, numbness, difficulty swallowing (temporary).',\n  1368→    warnings: ['Requires 2-4 sessions'],\n  1369→    gender: 'both',\n  1370→  },\n  1371→\n  1372→  // ==========================================\n  1373→  // FOUNDATIONAL TREATMENTS\n  1374→  // ==========================================\n  1375→  {\n  1376→    ref_id: 'FND-01',\n  1377→    name: 'Mewing / Proper Tongue Posture',\n  1378→    description: 'Maintaining correct tongue posture on the palate to potentially influence facial development over time.',\n  1379→    phase: 'Foundational',\n  1380→    baseImpact: 0.25,\n  1381→    coverage: 5,\n  1382→    percentage: '2-5%',\n  1383→    expectedImprovementRange: { min: 0.1, max: 0.3 },\n  1384→    targetMetrics: ['midfaceRatio', 'bigonialWidth', 'facialDepthToHeight'],\n  1385→    targetCategories: ['Midface/Face Shape', 'Jaw Shape', 'Occlusion/Jaw Growth'],\n  1386→    targetKeywords: ['midface', 'palate', 'recession', 'jaw development'],\n  1387→    timeline: { effect_start: 'gradual', full_results_weeks: 104, full_results_weeks_max: 260 },\n  1388→    cost: { type: 'flat', min: 0, max: 0, currency: 'USD' },\n  1389→    risks_side_effects: 'None if done correctly. Jaw pain if excessive.',\n  1390→    warnings: ['Results vary significantly', 'Most effective in younger individuals'],\n  1391→    gender: 'both',\n  1392→  },\n  1393→  {\n  1394→    ref_id: 'FND-02',\n  1395→    name: 'Body Recomposition (Leanmaxxing)',\n  1396→    description: 'Reducing body fat percentage to enhance facial definition and reveal underlying bone structure.',\n  1397→    phase: 'Foundational',\n  1398→    baseImpact: 0.35,\n  1399→    coverage: 6,\n  1400→    percentage: '5-12%',\n  1401→    expectedImprovementRange: { min: 0.2, max: 0.5 },\n  1402→    targetMetrics: ['bigonialWidth', 'submentalCervicalAngle', 'cheekboneHeight'],\n  1403→    targetCategories: ['Jaw Shape', 'Neck', 'Midface/Face Shape'],\n  1404→    targetKeywords: ['soft jaw', 'undefined', 'round', 'facial definition'],\n  1405→    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 52 },\n  1406→    cost: { type: 'per_month', min: 50, max: 200, currency: 'USD' },\n  1407→    risks_side_effects: 'None if done healthily.',\n  1408→    warnings: [],\n  1409→    gender: 'both',\n  1410→  },\n  1411→  {\n  1412→    ref_id: 'FND-03',\n  1413→    name: 'Posture Correction',\n  1414→    description: 'Improving head and neck posture to optimize facial appearance and reduce forward head posture effects.',\n  1415→    phase: 'Foundational',\n  1416→    baseImpact: 0.20,\n  1417→    coverage: 3,\n  1418→    percentage: '2-5%',\n  1419→    expectedImprovementRange: { min: 0.1, max: 0.2 },\n  1420→    targetMetrics: ['submentalCervicalAngle', 'anteriorFacialDepth'],\n  1421→    targetCategories: ['Neck', 'Occlusion/Jaw Growth'],\n  1422→    targetKeywords: ['neck', 'posture', 'forward head'],\n  1423→    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 52 },\n  1424→    cost: { type: 'flat', min: 0, max: 100, currency: 'USD' },\n  1425→    risks_side_effects: 'None.',\n  1426→    warnings: [],\n  1427→    gender: 'both',\n  1428→  },\n  1429→  {\n  1430→    ref_id: 'FND-04',\n  1431→    name: 'Skincare Routine (Retinoid + SPF)',\n  1432→    description: 'Medical-grade skincare to improve skin quality, texture, and reduce aging signs.',\n  1433→    phase: 'Foundational',\n  1434→    baseImpact: 0.20,\n  1435→    coverage: 2,\n  1436→    percentage: '2-5%',\n  1437→    expectedImprovementRange: { min: 0.1, max: 0.3 },\n  1438→    targetMetrics: [],\n  1439→    targetCategories: [],\n  1440→    targetKeywords: ['skin', 'texture', 'aging'],\n  1441→    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 26 },\n  1442→    cost: { type: 'per_month', min: 30, max: 150, currency: 'USD' },\n  1443→    risks_side_effects: 'Initial irritation, sun sensitivity.',\n  1444→    warnings: [],\n  1445→    gender: 'both',\n  1446→  },\n  1447→  {\n  1448→    ref_id: 'FND-05',\n  1449→    name: 'Eyebrow Grooming / Microblading',\n  1450→    description: 'Professional shaping or semi-permanent tattooing to optimize eyebrow shape and position.',\n  1451→    phase: 'Foundational',\n  1452→    baseImpact: 0.25,\n  1453→    coverage: 2,\n  1454→    percentage: '3-6%',\n  1455→    expectedImprovementRange: { min: 0.1, max: 0.3 },\n  1456→    targetMetrics: ['eyebrowTilt', 'eyebrowLowSetedness', 'browLengthRatio'],\n  1457→    targetCategories: ['Upper Third'],\n  1458→    targetKeywords: ['eyebrow', 'brow', 'upper third'],\n  1459→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n  1460→    cost: { type: 'flat', min: 20, max: 600, currency: 'USD' },\n  1461→    risks_side_effects: 'Minimal for grooming. Microblading: infection risk, color fading.',\n  1462→    warnings: [],\n  1463→    gender: 'both',\n  1464→  },\n  1465→];\n  1466→\n  1467→// Calculate relevance score based on multiple factors including metric scores\n  1468→function calculateRelevanceScore(\n  1469→  proc: ProcedureConfig,\n  1470→  flaw: Flaw,\n  1471→  allFlaws: Flaw[],\n  1472→  allRatios: Ratio[] = []\n  1473→): number {\n  1474→  let score = 0;\n  1475→\n  1476→  // Check metric ID match (highest priority)\n  1477→  const metricId = flaw.responsibleRatios[0]?.ratioId || '';\n  1478→  const metricScore = flaw.responsibleRatios[0]?.score || 5;\n  1479→\n  1480→  if (proc.targetMetrics.includes(metricId)) {\n  1481→    // Base score for metric match\n  1482→    score += 40;\n  1483→\n  1484→    // Boost based on how poor the metric score is (lower score = more improvement potential)\n  1485→    // Score of 2 adds +20, score of 8 adds +5\n  1486→    const metricPoorness = Math.max(0, 10 - metricScore) * 2;\n  1487→    score += metricPoorness;\n  1488→  }\n  1489→\n  1490→  // Check category match\n  1491→  if (proc.targetCategories.some(cat =>\n  1492→    flaw.categoryName.toLowerCase().includes(cat.toLowerCase()) ||\n  1493→    cat.toLowerCase().includes(flaw.categoryName.toLowerCase())\n  1494→  )) {\n  1495→    score += 25;\n  1496→  }\n  1497→\n  1498→  // Check keyword match with weighted scoring\n  1499→  const flawLower = flaw.flawName.toLowerCase();\n  1500→  const summaryLower = flaw.summary.toLowerCase();\n  1501→  const matchedKeywords = proc.targetKeywords.filter(kw =>\n  1502→    flawLower.includes(kw.toLowerCase()) || summaryLower.includes(kw.toLowerCase())\n  1503→  );\n  1504→  // Primary keyword match (in flaw name) worth more\n  1505→  const primaryMatches = matchedKeywords.filter(kw => flawLower.includes(kw.toLowerCase()));\n  1506→  score += primaryMatches.length * 15;\n  1507→  score += (matchedKeywords.length - primaryMatches.length) * 8;\n  1508→\n  1509→  // Adjust by flaw severity/impact (more severe = higher priority)\n  1510→  score += Math.min(flaw.harmonyPercentageLost * 4, 20);\n  1511→\n  1512→  // Bonus if this procedure addresses multiple flaws\n  1513→  const otherFlawsAddressed = allFlaws.filter(f =>\n  1514→    f.id !== flaw.id && (\n  1515→      proc.targetMetrics.includes(f.responsibleRatios[0]?.ratioId || '') ||\n  1516→      proc.targetCategories.some(cat => f.categoryName.toLowerCase().includes(cat.toLowerCase()))\n  1517→    )\n  1518→  );\n  1519→  score += otherFlawsAddressed.length * 7;\n  1520→\n  1521→  // Check if procedure targets any below-average ratios directly\n  1522→  const matchingRatios = allRatios.filter(r =>\n  1523→    proc.targetMetrics.includes(r.id) && r.score < 6\n  1524→  );\n  1525→  score += matchingRatios.length * 8;\n  1526→\n  1527→  return Math.min(score, 100);\n  1528→}\n  1529→\n  1530→// Calculate expected score improvement based on metric deviation and procedure effectiveness\n  1531→function calculateExpectedImprovement(\n  1532→  proc: ProcedureConfig,\n  1533→  matchedRatios: Ratio[],\n  1534→  avgFlawImpact: number\n  1535→): { min: number; max: number; potential: number } {\n  1536→  // Base improvement from procedure\n  1537→  const baseMin = proc.expectedImprovementRange.min;\n  1538→  const baseMax = proc.expectedImprovementRange.max;\n  1539→\n  1540→  // Severity multiplier: more severe issues have more room for improvement\n  1541→  const severityMultiplier = Math.min(avgFlawImpact / 2.5, 1.8);\n  1542→\n  1543→  // Metric deviation bonus: further from ideal = more potential improvement\n  1544→  let deviationBonus = 1.0;\n  1545→  if (matchedRatios.length > 0) {\n  1546→    const avgScore = matchedRatios.reduce((sum, r) => sum + r.score, 0) / matchedRatios.length;\n  1547→    // Score of 3 gives 1.4x, score of 7 gives 1.0x\n  1548→    deviationBonus = 1 + Math.max(0, (7 - avgScore) * 0.1);\n  1549→  }\n  1550→\n  1551→  const adjustedMin = baseMin * severityMultiplier * deviationBonus;\n  1552→  const adjustedMax = baseMax * severityMultiplier * deviationBonus;\n  1553→\n  1554→  // Calculate potential new score if treatment is applied\n  1555→  const avgCurrentScore = matchedRatios.length > 0\n  1556→    ? matchedRatios.reduce((sum, r) => sum + r.score, 0) / matchedRatios.length\n  1557→    : 5;\n  1558→  const potentialScore = Math.min(10, avgCurrentScore + (adjustedMax * 0.8));\n  1559→\n  1560→  return {\n  1561→    min: Math.round(adjustedMin * 100) / 100,\n  1562→    max: Math.round(adjustedMax * 100) / 100,\n  1563→    potential: Math.round(potentialScore * 10) / 10,\n  1564→  };\n  1565→}\n  1566→\n  1567→function generateRecommendations(flaws: Flaw[], frontRatios: Ratio[] = [], sideRatios: Ratio[] = []): Recommendation[] {\n  1568→  const recommendations: Recommendation[] = [];\n  1569→  const allRatios = [...frontRatios, ...sideRatios];\n  1570→\n  1571→  // Track which procedures have been added and their matched flaws\n  1572→  const procMatches: Map<string, {\n  1573→    flaws: string[];\n  1574→    ratios: string[];\n  1575→    ratioIds: string[];\n  1576→    maxScore: number;\n  1577→    totalFlawImpact: number;\n  1578→  }> = new Map();\n  1579→\n  1580→  flaws.forEach(flaw => {\n  1581→    PROCEDURE_DATABASE.forEach(proc => {\n  1582→      // Pass allRatios to the enhanced relevance scoring\n  1583→      const relevanceScore = calculateRelevanceScore(proc, flaw, flaws, allRatios);\n  1584→\n  1585→      if (relevanceScore >= 25) {  // Minimum threshold\n  1586→        const existing = procMatches.get(proc.ref_id);\n  1587→        if (existing) {\n  1588→          existing.flaws.push(flaw.flawName);\n  1589→          existing.ratios.push(...flaw.responsibleRatios.map(r => r.ratioName));\n  1590→          existing.ratioIds.push(...flaw.responsibleRatios.map(r => r.ratioId));\n  1591→          existing.maxScore = Math.max(existing.maxScore, relevanceScore);\n  1592→          existing.totalFlawImpact += flaw.harmonyPercentageLost;\n  1593→        } else {\n  1594→          procMatches.set(proc.ref_id, {\n  1595→            flaws: [flaw.flawName],\n  1596→            ratios: flaw.responsibleRatios.map(r => r.ratioName),\n  1597→            ratioIds: flaw.responsibleRatios.map(r => r.ratioId),\n  1598→            maxScore: relevanceScore,\n  1599→            totalFlawImpact: flaw.harmonyPercentageLost,\n  1600→          });\n  1601→        }\n  1602→      }\n  1603→    });\n  1604→  });\n  1605→\n  1606→  // Build recommendations from matched procedures\n  1607→  procMatches.forEach((match, procId) => {\n  1608→    const proc = PROCEDURE_DATABASE.find(p => p.ref_id === procId);\n  1609→    if (!proc) return;\n  1610→\n  1611→    // Get affected ratios from the actual data (including directly targeted metrics)\n  1612→    const affectedRatios = allRatios.filter(r =>\n  1613→      proc.targetMetrics.includes(r.id) ||\n  1614→      match.ratioIds.includes(r.id) ||\n  1615→      match.flaws.some(f => f.toLowerCase().includes(r.category.toLowerCase()))\n  1616→    );\n  1617→\n  1618→    // Calculate expected improvement with the new function\n  1619→    const avgFlawImpact = match.totalFlawImpact / match.flaws.length;\n  1620→    const improvement = calculateExpectedImprovement(proc, affectedRatios, avgFlawImpact);\n  1621→\n  1622→    // Calculate priority score based on multiple factors\n  1623→    const priorityScore =\n  1624→      (match.maxScore * 0.4) +  // Relevance weight\n  1625→      (match.flaws.length * 8) +  // Multi-flaw bonus\n  1626→      (avgFlawImpact * 3) +  // Severity weight\n  1627→      (proc.baseImpact * 25);  // Procedure effectiveness\n  1628→\n  1629→    // Adjust impact based on how well this procedure addresses the specific issues\n  1630→    const adjustedImpact = Math.min(\n  1631→      1.0,\n  1632→      proc.baseImpact * (0.85 + (match.maxScore / 400)) * (1 + (match.flaws.length * 0.05))\n  1633→    );\n  1634→\n  1635→    // Calculate direction for each affected ratio\n  1636→    const ratiosImpacted = affectedRatios.map(r => {\n  1637→      // Determine direction based on deviation\n  1638→      let direction: 'increase' | 'decrease' | 'both' = 'both';\n  1639→      if (r.value < r.idealMin) {\n  1640→        direction = 'increase';\n  1641→      } else if (r.value > r.idealMax) {\n  1642→        direction = 'decrease';\n  1643→      }\n  1644→\n  1645→      // Calculate percentage effect based on how far from ideal and procedure strength\n  1646→      const deviation = r.value < r.idealMin\n  1647→        ? r.idealMin - r.value\n  1648→        : r.value > r.idealMax\n  1649→          ? r.value - r.idealMax\n  1650→          : 0;\n  1651→      const normalizedDeviation = deviation / ((r.rangeMax - r.rangeMin) / 2);\n  1652→      const percentageEffect = proc.baseImpact * Math.min(normalizedDeviation * 1.5, 1.5);\n  1653→\n  1654→      return {\n  1655→        ratioId: r.id,\n  1656→        ratioName: r.name,\n  1657→        direction,\n  1658→        percentageEffect: Math.round(percentageEffect * 100) / 100,\n  1659→      };\n  1660→    });\n  1661→\n  1662→    recommendations.push({\n  1663→      ref_id: proc.ref_id,\n  1664→      name: proc.name,\n  1665→      description: proc.description,\n  1666→      phase: proc.phase,\n  1667→      impact: adjustedImpact,\n  1668→      coverage: match.flaws.length + Math.min(match.ratios.length, 5),\n  1669→      percentage: proc.percentage,\n  1670→      expectedImprovementRange: {\n  1671→        min: improvement.min,\n  1672→        max: improvement.max,\n  1673→      },\n  1674→      matchedFlaws: Array.from(new Set(match.flaws)),\n  1675→      matchedRatios: Array.from(new Set(match.ratios)),\n  1676→      ratios_impacted: ratiosImpacted,\n  1677→      timeline: proc.timeline,\n  1678→      cost: proc.cost,\n  1679→      risks_side_effects: proc.risks_side_effects,\n  1680→      warnings: proc.warnings,\n  1681→      gender: proc.gender,\n  1682→      // Add priority score as a sorting key (stored in coverage field calculation)\n  1683→      _priorityScore: priorityScore,\n  1684→    } as Recommendation & { _priorityScore: number });\n  1685→  });\n  1686→\n  1687→  // Sort by priority score (combines impact, coverage, and severity)\n  1688→  return recommendations.sort((a, b) => {\n  1689→    const aScore = (a as Recommendation & { _priorityScore?: number })._priorityScore || (a.impact * 100);\n  1690→    const bScore = (b as Recommendation & { _priorityScore?: number })._priorityScore || (b.impact * 100);\n  1691→    const scoreDiff = bScore - aScore;\n  1692→    if (Math.abs(scoreDiff) > 5) return scoreDiff;\n  1693→    // Tiebreaker: prefer procedures that address more flaws\n  1694→    return b.matchedFlaws.length - a.matchedFlaws.length;\n  1695→  });\n  1696→}\n  1697→\n  1698→// ============================================\n  1699→// CONTEXT CREATION\n  1700→// ============================================\n  1701→\n  1702→const ResultsContext = createContext<ResultsContextType | null>(null);\n  1703→\n  1704→export function useResults(): ResultsContextType {\n  1705→  const context = useContext(ResultsContext);\n  1706→  if (!context) {\n  1707→    throw new Error('useResults must be used within a ResultsProvider');\n  1708→  }\n  1709→  return context;\n  1710→}\n  1711→\n  1712→interface ResultsProviderProps {\n  1713→  children: ReactNode;\n  1714→  initialData?: ResultsInputData;\n  1715→}\n  1716→\n  1717→export function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  1718→  // Raw data state\n  1719→  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  1720→  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  1721→  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  1722→  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  1723→  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  1724→  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n  1725→\n  1726→  // UI state\n  1727→  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  1728→  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  1729→  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  1730→  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  1731→  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n  1732→\n  1733→  // Compute analysis results (now with demographic-specific scoring)\n  1734→  const analysisResults = useMemo(() => {\n  1735→    if (frontLandmarks.length === 0) {\n  1736→      return null;\n  1737→    }\n  1738→\n  1739→    try {\n  1740→      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n  1741→      const sideAnalysis = sideLandmarks.length > 0\n  1742→        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n  1743→        : null;\n  1744→      // analyzeHarmony expects landmarks directly, not analysis results\n  1745→      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n  1746→\n  1747→      return { frontAnalysis, sideAnalysis, harmony };\n  1748→    } catch (error) {\n  1749→      console.error('Analysis error:', error);\n  1750→      return null;\n  1751→    }\n  1752→  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n  1753→\n  1754→  // Transform to Ratio format\n  1755→  const frontRatios = useMemo(() => {\n  1756→    if (!analysisResults?.frontAnalysis) return [];\n  1757→    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  1758→  }, [analysisResults, frontLandmarks]);\n  1759→\n  1760→  const sideRatios = useMemo(() => {\n  1761→    if (!analysisResults?.sideAnalysis) return [];\n  1762→    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  1763→  }, [analysisResults, sideLandmarks]);\n  1764→\n  1765→  // Generate strengths and flaws using INSIGHTS-BASED classification\n  1766→  // This processes insights.json definitions: calculates avg score of affected metrics,\n  1767→  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  1768→  const { insightStrengths, insightFlaws } = useMemo(() => {\n  1769→    if (!analysisResults?.harmony) {\n  1770→      return { insightStrengths: [], insightFlaws: [] };\n  1771→    }\n  1772→\n  1773→    try {\n  1774→      // Classify using insights engine\n  1775→      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n  1776→        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n  1777→\n  1778→      // Convert to UI-compatible types\n  1779→      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n  1780→\n  1781→      let rollingLost = 0;\n  1782→      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n  1783→        const flaw = convertToFlaw(w, i, rollingLost);\n  1784→        rollingLost = flaw.rollingPointsDeducted || 0;\n  1785→        return flaw;\n  1786→      });\n  1787→\n  1788→      return { insightStrengths, insightFlaws };\n  1789→    } catch (error) {\n  1790→      console.error('[ResultsContext] Error in insights classification:', error);\n  1791→      return { insightStrengths: [], insightFlaws: [] };\n  1792→    }\n  1793→  }, [analysisResults]);\n  1794→\n  1795→  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  1796→  const groupingStrengths = useMemo(() => {\n  1797→    if (!analysisResults?.harmony) return [];\n  1798→    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  1799→  }, [analysisResults]);\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"583ef3e3-cef3-4b7f-be42-83d6b29e2def","timestamp":"2025-12-21T14:31:44.058Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/contexts/ResultsContext.tsx","content":"    cost: { type: 'flat', min: 4000, max: 12000, currency: 'USD' },\n    risks_side_effects: 'Scarring, asymmetry, dry eyes, ectropion.',\n    warnings: ['Difficult to reverse'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-06',\n    name: 'Cheek/Malar Implants',\n    description: 'Solid implants placed over the cheekbones to enhance midface projection and width.',\n    phase: 'Surgical',\n    baseImpact: 0.75,\n    coverage: 4,\n    percentage: '10-18%',\n    expectedImprovementRange: { min: 0.4, max: 0.9 },\n    targetMetrics: ['cheekboneHeight', 'midfaceRatio', 'totalFacialWidthToHeight'],\n    targetCategories: ['Midface/Face Shape'],\n    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface', 'zygomatic', 'malar'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 6, full_results_weeks_max: 12 },\n    cost: { type: 'flat', min: 6000, max: 15000, currency: 'USD' },\n    risks_side_effects: 'Swelling, asymmetry, implant shifting, nerve damage.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-07',\n    name: 'Neck Liposuction / Submentoplasty',\n    description: 'Fat removal and skin tightening under the chin and neck area.',\n    phase: 'Surgical',\n    baseImpact: 0.65,\n    coverage: 3,\n    percentage: '8-12%',\n    expectedImprovementRange: { min: 0.3, max: 0.7 },\n    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],\n    targetCategories: ['Neck'],\n    targetKeywords: ['round neck', 'double chin', 'submental', 'cervical', 'neck definition'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },\n    cost: { type: 'flat', min: 3000, max: 8000, currency: 'USD' },\n    risks_side_effects: 'Swelling, bruising, skin irregularity, numbness.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'SUR-08',\n    name: 'Brow Bone Reduction/Augmentation',\n    description: 'Surgical reshaping of the brow ridge for improved upper third harmony.',\n    phase: 'Surgical',\n    baseImpact: 0.70,\n    coverage: 3,\n    percentage: '8-15%',\n    expectedImprovementRange: { min: 0.3, max: 0.7 },\n    targetMetrics: ['nasofrontalAngle', 'bitemporalWidth', 'upperThirdProportion'],\n    targetCategories: ['Upper Third'],\n    targetKeywords: ['brow ridge', 'forehead', 'nasofrontal', 'upper third', 'glabella'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },\n    cost: { type: 'flat', min: 8000, max: 20000, currency: 'USD' },\n    risks_side_effects: 'Swelling, numbness, scarring (if coronal incision).',\n    warnings: [],\n    gender: 'both',\n  },\n\n  // ==========================================\n  // MINIMALLY INVASIVE TREATMENTS\n  // ==========================================\n  {\n    ref_id: 'MIN-01',\n    name: 'Chin/Jawline Filler',\n    description: 'Hyaluronic acid injections to enhance chin projection and jawline definition. Reversible and temporary.',\n    phase: 'Minimally Invasive',\n    baseImpact: 0.45,\n    coverage: 4,\n    percentage: '5-10%',\n    expectedImprovementRange: { min: 0.2, max: 0.5 },\n    targetMetrics: ['chinPhiltrumRatio', 'jawFrontalAngle', 'bigonialWidth'],\n    targetCategories: ['Chin', 'Jaw Shape'],\n    targetKeywords: ['weak chin', 'recessed chin', 'soft jaw', 'jawline'],\n    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n    cost: { type: 'per_session', min: 800, max: 2500, currency: 'USD' },\n    risks_side_effects: 'Bruising, swelling, rare vascular occlusion.',\n    warnings: ['Results temporary (12-18 months)', 'Requires maintenance'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'MIN-02',\n    name: 'Cheek Filler',\n    description: 'HA filler to enhance cheekbone projection and midface volume.',\n    phase: 'Minimally Invasive',\n    baseImpact: 0.40,\n    coverage: 3,\n    percentage: '5-8%',\n    expectedImprovementRange: { min: 0.2, max: 0.4 },\n    targetMetrics: ['cheekboneHeight', 'midfaceRatio'],\n    targetCategories: ['Midface/Face Shape'],\n    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface volume'],\n    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n    cost: { type: 'per_session', min: 600, max: 1800, currency: 'USD' },\n    risks_side_effects: 'Bruising, swelling, asymmetry.',\n    warnings: ['Results temporary (12-18 months)'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'MIN-03',\n    name: 'Lip Filler',\n    description: 'Hyaluronic acid to enhance lip volume and proportions.',\n    phase: 'Minimally Invasive',\n    baseImpact: 0.35,\n    coverage: 2,\n    percentage: '3-6%',\n    expectedImprovementRange: { min: 0.1, max: 0.3 },\n    targetMetrics: ['lowerUpperLipRatio', 'mouthNoseWidthRatio'],\n    targetCategories: ['Lips'],\n    targetKeywords: ['thin lip', 'lip ratio', 'lip volume', 'upper lip', 'lower lip'],\n    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n    cost: { type: 'per_session', min: 400, max: 1200, currency: 'USD' },\n    risks_side_effects: 'Bruising, swelling, lumps.',\n    warnings: ['Results temporary (6-12 months)'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'MIN-04',\n    name: 'PDO Thread Lift',\n    description: 'Dissolvable threads to lift and tighten skin, particularly for canthal tilt improvement.',\n    phase: 'Minimally Invasive',\n    baseImpact: 0.35,\n    coverage: 3,\n    percentage: '4-8%',\n    expectedImprovementRange: { min: 0.1, max: 0.4 },\n    targetMetrics: ['lateralCanthalTilt', 'eyebrowLowSetedness'],\n    targetCategories: ['Eyes', 'Upper Third'],\n    targetKeywords: ['canthal tilt', 'drooping', 'sagging', 'eyebrow position'],\n    timeline: { effect_start: 'immediate', full_results_weeks: 4, full_results_weeks_max: 12 },\n    cost: { type: 'per_session', min: 1500, max: 4000, currency: 'USD' },\n    risks_side_effects: 'Bruising, asymmetry, thread visibility, infection.',\n    warnings: ['Results temporary (12-18 months)'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'MIN-05',\n    name: 'Masseter Botox',\n    description: 'Botulinum toxin to slim the lower face by relaxing masseter muscles.',\n    phase: 'Minimally Invasive',\n    baseImpact: 0.40,\n    coverage: 2,\n    percentage: '4-8%',\n    expectedImprovementRange: { min: 0.2, max: 0.4 },\n    targetMetrics: ['bigonialWidth', 'jawWidthRatio', 'faceWidthToHeight'],\n    targetCategories: ['Jaw Shape', 'Midface/Face Shape'],\n    targetKeywords: ['wide jaw', 'square jaw', 'masseter', 'bruxism'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 4, full_results_weeks_max: 12 },\n    cost: { type: 'per_session', min: 400, max: 1000, currency: 'USD' },\n    risks_side_effects: 'Temporary weakness, asymmetry, difficulty chewing.',\n    warnings: ['Results temporary (4-6 months)', 'Requires regular maintenance'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'MIN-06',\n    name: 'Kybella (Submental Fat Dissolving)',\n    description: 'Injectable deoxycholic acid to permanently destroy fat cells under the chin.',\n    phase: 'Minimally Invasive',\n    baseImpact: 0.45,\n    coverage: 2,\n    percentage: '5-10%',\n    expectedImprovementRange: { min: 0.2, max: 0.5 },\n    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],\n    targetCategories: ['Neck'],\n    targetKeywords: ['double chin', 'submental fat', 'neck definition'],\n    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },\n    cost: { type: 'per_session', min: 1200, max: 1800, currency: 'USD' },\n    risks_side_effects: 'Swelling, bruising, numbness, difficulty swallowing (temporary).',\n    warnings: ['Requires 2-4 sessions'],\n    gender: 'both',\n  },\n\n  // ==========================================\n  // FOUNDATIONAL TREATMENTS\n  // ==========================================\n  {\n    ref_id: 'FND-01',\n    name: 'Mewing / Proper Tongue Posture',\n    description: 'Maintaining correct tongue posture on the palate to potentially influence facial development over time.',\n    phase: 'Foundational',\n    baseImpact: 0.25,\n    coverage: 5,\n    percentage: '2-5%',\n    expectedImprovementRange: { min: 0.1, max: 0.3 },\n    targetMetrics: ['midfaceRatio', 'bigonialWidth', 'facialDepthToHeight'],\n    targetCategories: ['Midface/Face Shape', 'Jaw Shape', 'Occlusion/Jaw Growth'],\n    targetKeywords: ['midface', 'palate', 'recession', 'jaw development'],\n    timeline: { effect_start: 'gradual', full_results_weeks: 104, full_results_weeks_max: 260 },\n    cost: { type: 'flat', min: 0, max: 0, currency: 'USD' },\n    risks_side_effects: 'None if done correctly. Jaw pain if excessive.',\n    warnings: ['Results vary significantly', 'Most effective in younger individuals'],\n    gender: 'both',\n  },\n  {\n    ref_id: 'FND-02',\n    name: 'Body Recomposition (Leanmaxxing)',\n    description: 'Reducing body fat percentage to enhance facial definition and reveal underlying bone structure.',\n    phase: 'Foundational',\n    baseImpact: 0.35,\n    coverage: 6,\n    percentage: '5-12%',\n    expectedImprovementRange: { min: 0.2, max: 0.5 },\n    targetMetrics: ['bigonialWidth', 'submentalCervicalAngle', 'cheekboneHeight'],\n    targetCategories: ['Jaw Shape', 'Neck', 'Midface/Face Shape'],\n    targetKeywords: ['soft jaw', 'undefined', 'round', 'facial definition'],\n    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 52 },\n    cost: { type: 'per_month', min: 50, max: 200, currency: 'USD' },\n    risks_side_effects: 'None if done healthily.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'FND-03',\n    name: 'Posture Correction',\n    description: 'Improving head and neck posture to optimize facial appearance and reduce forward head posture effects.',\n    phase: 'Foundational',\n    baseImpact: 0.20,\n    coverage: 3,\n    percentage: '2-5%',\n    expectedImprovementRange: { min: 0.1, max: 0.2 },\n    targetMetrics: ['submentalCervicalAngle', 'anteriorFacialDepth'],\n    targetCategories: ['Neck', 'Occlusion/Jaw Growth'],\n    targetKeywords: ['neck', 'posture', 'forward head'],\n    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 52 },\n    cost: { type: 'flat', min: 0, max: 100, currency: 'USD' },\n    risks_side_effects: 'None.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'FND-04',\n    name: 'Skincare Routine (Retinoid + SPF)',\n    description: 'Medical-grade skincare to improve skin quality, texture, and reduce aging signs.',\n    phase: 'Foundational',\n    baseImpact: 0.20,\n    coverage: 2,\n    percentage: '2-5%',\n    expectedImprovementRange: { min: 0.1, max: 0.3 },\n    targetMetrics: [],\n    targetCategories: [],\n    targetKeywords: ['skin', 'texture', 'aging'],\n    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 26 },\n    cost: { type: 'per_month', min: 30, max: 150, currency: 'USD' },\n    risks_side_effects: 'Initial irritation, sun sensitivity.',\n    warnings: [],\n    gender: 'both',\n  },\n  {\n    ref_id: 'FND-05',\n    name: 'Eyebrow Grooming / Microblading',\n    description: 'Professional shaping or semi-permanent tattooing to optimize eyebrow shape and position.',\n    phase: 'Foundational',\n    baseImpact: 0.25,\n    coverage: 2,\n    percentage: '3-6%',\n    expectedImprovementRange: { min: 0.1, max: 0.3 },\n    targetMetrics: ['eyebrowTilt', 'eyebrowLowSetedness', 'browLengthRatio'],\n    targetCategories: ['Upper Third'],\n    targetKeywords: ['eyebrow', 'brow', 'upper third'],\n    timeline: { effect_start: 'immediate', full_results_weeks: 1 },\n    cost: { type: 'flat', min: 20, max: 600, currency: 'USD' },\n    risks_side_effects: 'Minimal for grooming. Microblading: infection risk, color fading.',\n    warnings: [],\n    gender: 'both',\n  },\n];\n\n// Calculate relevance score based on multiple factors including metric scores\nfunction calculateRelevanceScore(\n  proc: ProcedureConfig,\n  flaw: Flaw,\n  allFlaws: Flaw[],\n  allRatios: Ratio[] = []\n): number {\n  let score = 0;\n\n  // Check metric ID match (highest priority)\n  const metricId = flaw.responsibleRatios[0]?.ratioId || '';\n  const metricScore = flaw.responsibleRatios[0]?.score || 5;\n\n  if (proc.targetMetrics.includes(metricId)) {\n    // Base score for metric match\n    score += 40;\n\n    // Boost based on how poor the metric score is (lower score = more improvement potential)\n    // Score of 2 adds +20, score of 8 adds +5\n    const metricPoorness = Math.max(0, 10 - metricScore) * 2;\n    score += metricPoorness;\n  }\n\n  // Check category match\n  if (proc.targetCategories.some(cat =>\n    flaw.categoryName.toLowerCase().includes(cat.toLowerCase()) ||\n    cat.toLowerCase().includes(flaw.categoryName.toLowerCase())\n  )) {\n    score += 25;\n  }\n\n  // Check keyword match with weighted scoring\n  const flawLower = flaw.flawName.toLowerCase();\n  const summaryLower = flaw.summary.toLowerCase();\n  const matchedKeywords = proc.targetKeywords.filter(kw =>\n    flawLower.includes(kw.toLowerCase()) || summaryLower.includes(kw.toLowerCase())\n  );\n  // Primary keyword match (in flaw name) worth more\n  const primaryMatches = matchedKeywords.filter(kw => flawLower.includes(kw.toLowerCase()));\n  score += primaryMatches.length * 15;\n  score += (matchedKeywords.length - primaryMatches.length) * 8;\n\n  // Adjust by flaw severity/impact (more severe = higher priority)\n  score += Math.min(flaw.harmonyPercentageLost * 4, 20);\n\n  // Bonus if this procedure addresses multiple flaws\n  const otherFlawsAddressed = allFlaws.filter(f =>\n    f.id !== flaw.id && (\n      proc.targetMetrics.includes(f.responsibleRatios[0]?.ratioId || '') ||\n      proc.targetCategories.some(cat => f.categoryName.toLowerCase().includes(cat.toLowerCase()))\n    )\n  );\n  score += otherFlawsAddressed.length * 7;\n\n  // Check if procedure targets any below-average ratios directly\n  const matchingRatios = allRatios.filter(r =>\n    proc.targetMetrics.includes(r.id) && r.score < 6\n  );\n  score += matchingRatios.length * 8;\n\n  return Math.min(score, 100);\n}\n\n// Calculate expected score improvement based on metric deviation and procedure effectiveness\nfunction calculateExpectedImprovement(\n  proc: ProcedureConfig,\n  matchedRatios: Ratio[],\n  avgFlawImpact: number\n): { min: number; max: number; potential: number } {\n  // Base improvement from procedure\n  const baseMin = proc.expectedImprovementRange.min;\n  const baseMax = proc.expectedImprovementRange.max;\n\n  // Severity multiplier: more severe issues have more room for improvement\n  const severityMultiplier = Math.min(avgFlawImpact / 2.5, 1.8);\n\n  // Metric deviation bonus: further from ideal = more potential improvement\n  let deviationBonus = 1.0;\n  if (matchedRatios.length > 0) {\n    const avgScore = matchedRatios.reduce((sum, r) => sum + r.score, 0) / matchedRatios.length;\n    // Score of 3 gives 1.4x, score of 7 gives 1.0x\n    deviationBonus = 1 + Math.max(0, (7 - avgScore) * 0.1);\n  }\n\n  const adjustedMin = baseMin * severityMultiplier * deviationBonus;\n  const adjustedMax = baseMax * severityMultiplier * deviationBonus;\n\n  // Calculate potential new score if treatment is applied\n  const avgCurrentScore = matchedRatios.length > 0\n    ? matchedRatios.reduce((sum, r) => sum + r.score, 0) / matchedRatios.length\n    : 5;\n  const potentialScore = Math.min(10, avgCurrentScore + (adjustedMax * 0.8));\n\n  return {\n    min: Math.round(adjustedMin * 100) / 100,\n    max: Math.round(adjustedMax * 100) / 100,\n    potential: Math.round(potentialScore * 10) / 10,\n  };\n}\n\nfunction generateRecommendations(flaws: Flaw[], frontRatios: Ratio[] = [], sideRatios: Ratio[] = []): Recommendation[] {\n  const recommendations: Recommendation[] = [];\n  const allRatios = [...frontRatios, ...sideRatios];\n\n  // Track which procedures have been added and their matched flaws\n  const procMatches: Map<string, {\n    flaws: string[];\n    ratios: string[];\n    ratioIds: string[];\n    maxScore: number;\n    totalFlawImpact: number;\n  }> = new Map();\n\n  flaws.forEach(flaw => {\n    PROCEDURE_DATABASE.forEach(proc => {\n      // Pass allRatios to the enhanced relevance scoring\n      const relevanceScore = calculateRelevanceScore(proc, flaw, flaws, allRatios);\n\n      if (relevanceScore >= 25) {  // Minimum threshold\n        const existing = procMatches.get(proc.ref_id);\n        if (existing) {\n          existing.flaws.push(flaw.flawName);\n          existing.ratios.push(...flaw.responsibleRatios.map(r => r.ratioName));\n          existing.ratioIds.push(...flaw.responsibleRatios.map(r => r.ratioId));\n          existing.maxScore = Math.max(existing.maxScore, relevanceScore);\n          existing.totalFlawImpact += flaw.harmonyPercentageLost;\n        } else {\n          procMatches.set(proc.ref_id, {\n            flaws: [flaw.flawName],\n            ratios: flaw.responsibleRatios.map(r => r.ratioName),\n            ratioIds: flaw.responsibleRatios.map(r => r.ratioId),\n            maxScore: relevanceScore,\n            totalFlawImpact: flaw.harmonyPercentageLost,\n          });\n        }\n      }\n    });\n  });\n\n  // Build recommendations from matched procedures\n  procMatches.forEach((match, procId) => {\n    const proc = PROCEDURE_DATABASE.find(p => p.ref_id === procId);\n    if (!proc) return;\n\n    // Get affected ratios from the actual data (including directly targeted metrics)\n    const affectedRatios = allRatios.filter(r =>\n      proc.targetMetrics.includes(r.id) ||\n      match.ratioIds.includes(r.id) ||\n      match.flaws.some(f => f.toLowerCase().includes(r.category.toLowerCase()))\n    );\n\n    // Calculate expected improvement with the new function\n    const avgFlawImpact = match.totalFlawImpact / match.flaws.length;\n    const improvement = calculateExpectedImprovement(proc, affectedRatios, avgFlawImpact);\n\n    // Calculate priority score based on multiple factors\n    const priorityScore =\n      (match.maxScore * 0.4) +  // Relevance weight\n      (match.flaws.length * 8) +  // Multi-flaw bonus\n      (avgFlawImpact * 3) +  // Severity weight\n      (proc.baseImpact * 25);  // Procedure effectiveness\n\n    // Adjust impact based on how well this procedure addresses the specific issues\n    const adjustedImpact = Math.min(\n      1.0,\n      proc.baseImpact * (0.85 + (match.maxScore / 400)) * (1 + (match.flaws.length * 0.05))\n    );\n\n    // Calculate direction for each affected ratio\n    const ratiosImpacted = affectedRatios.map(r => {\n      // Determine direction based on deviation\n      let direction: 'increase' | 'decrease' | 'both' = 'both';\n      if (r.value < r.idealMin) {\n        direction = 'increase';\n      } else if (r.value > r.idealMax) {\n        direction = 'decrease';\n      }\n\n      // Calculate percentage effect based on how far from ideal and procedure strength\n      const deviation = r.value < r.idealMin\n        ? r.idealMin - r.value\n        : r.value > r.idealMax\n          ? r.value - r.idealMax\n          : 0;\n      const normalizedDeviation = deviation / ((r.rangeMax - r.rangeMin) / 2);\n      const percentageEffect = proc.baseImpact * Math.min(normalizedDeviation * 1.5, 1.5);\n\n      return {\n        ratioId: r.id,\n        ratioName: r.name,\n        direction,\n        percentageEffect: Math.round(percentageEffect * 100) / 100,\n      };\n    });\n\n    recommendations.push({\n      ref_id: proc.ref_id,\n      name: proc.name,\n      description: proc.description,\n      phase: proc.phase,\n      impact: adjustedImpact,\n      coverage: match.flaws.length + Math.min(match.ratios.length, 5),\n      percentage: proc.percentage,\n      expectedImprovementRange: {\n        min: improvement.min,\n        max: improvement.max,\n      },\n      matchedFlaws: Array.from(new Set(match.flaws)),\n      matchedRatios: Array.from(new Set(match.ratios)),\n      ratios_impacted: ratiosImpacted,\n      timeline: proc.timeline,\n      cost: proc.cost,\n      risks_side_effects: proc.risks_side_effects,\n      warnings: proc.warnings,\n      gender: proc.gender,\n      // Add priority score as a sorting key (stored in coverage field calculation)\n      _priorityScore: priorityScore,\n    } as Recommendation & { _priorityScore: number });\n  });\n\n  // Sort by priority score (combines impact, coverage, and severity)\n  return recommendations.sort((a, b) => {\n    const aScore = (a as Recommendation & { _priorityScore?: number })._priorityScore || (a.impact * 100);\n    const bScore = (b as Recommendation & { _priorityScore?: number })._priorityScore || (b.impact * 100);\n    const scoreDiff = bScore - aScore;\n    if (Math.abs(scoreDiff) > 5) return scoreDiff;\n    // Tiebreaker: prefer procedures that address more flaws\n    return b.matchedFlaws.length - a.matchedFlaws.length;\n  });\n}\n\n// ============================================\n// CONTEXT CREATION\n// ============================================\n\nconst ResultsContext = createContext<ResultsContextType | null>(null);\n\nexport function useResults(): ResultsContextType {\n  const context = useContext(ResultsContext);\n  if (!context) {\n    throw new Error('useResults must be used within a ResultsProvider');\n  }\n  return context;\n}\n\ninterface ResultsProviderProps {\n  children: ReactNode;\n  initialData?: ResultsInputData;\n}\n\nexport function ResultsProvider({ children, initialData }: ResultsProviderProps) {\n  // Raw data state\n  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);\n  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);\n  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');\n  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');\n  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');\n  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);\n\n  // UI state\n  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');\n  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);\n  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);\n  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);\n  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);\n\n  // Compute analysis results (now with demographic-specific scoring)\n  const analysisResults = useMemo(() => {\n    if (frontLandmarks.length === 0) {\n      return null;\n    }\n\n    try {\n      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);\n      const sideAnalysis = sideLandmarks.length > 0\n        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)\n        : null;\n      // analyzeHarmony expects landmarks directly, not analysis results\n      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);\n\n      return { frontAnalysis, sideAnalysis, harmony };\n    } catch (error) {\n      console.error('Analysis error:', error);\n      return null;\n    }\n  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);\n\n  // Transform to Ratio format\n  const frontRatios = useMemo(() => {\n    if (!analysisResults?.frontAnalysis) return [];\n    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));\n  }, [analysisResults, frontLandmarks]);\n\n  const sideRatios = useMemo(() => {\n    if (!analysisResults?.sideAnalysis) return [];\n    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));\n  }, [analysisResults, sideLandmarks]);\n\n  // Generate strengths and flaws using INSIGHTS-BASED classification\n  // This processes insights.json definitions: calculates avg score of affected metrics,\n  // then classifies as strength (avg > threshold) or weakness (avg < threshold)\n  const { insightStrengths, insightFlaws } = useMemo(() => {\n    if (!analysisResults?.harmony) {\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n\n    try {\n      // Classify using insights engine\n      const { strengths: classifiedStrengths, weaknesses: classifiedWeaknesses } =\n        classifyInsights(analysisResults.harmony.measurements, INSIGHTS_DEFINITIONS);\n\n      // Convert to UI-compatible types\n      const insightStrengths = classifiedStrengths.map((s) => convertToStrength(s));\n\n      let rollingLost = 0;\n      const insightFlaws = classifiedWeaknesses.map((w, i) => {\n        const flaw = convertToFlaw(w, i, rollingLost);\n        rollingLost = flaw.rollingPointsDeducted || 0;\n        return flaw;\n      });\n\n      return { insightStrengths, insightFlaws };\n    } catch (error) {\n      console.error('[ResultsContext] Error in insights classification:', error);\n      return { insightStrengths: [], insightFlaws: [] };\n    }\n  }, [analysisResults]);\n\n  // Generate grouping-based strengths/flaws (legacy approach for metrics not covered by insights)\n  const groupingStrengths = useMemo(() => {\n    if (!analysisResults?.harmony) return [];\n    return generateStrengthsFromAnalysis(analysisResults.harmony);\n  }, [analysisResults]);","numLines":600,"startLine":1200,"totalLines":1954}}}
{"parentUuid":"583ef3e3-cef3-4b7f-be42-83d6b29e2def","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SDzGnnSNK9hEhgbrxAkyN3","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a clear picture of the PROCEDURE_DATABASE. It contains:\n\n**Surgical (SUR-01 to SUR-08):**\n- SUR-01: Genioplasty\n- SUR-02: Rhinoplasty  \n- SUR-03: Jaw Angle Implants\n- SUR-04: Orthognathic Surgery\n- SUR-05: Canthoplasty\n- SUR-06: Cheek/Malar Implants\n- SUR-07: Neck Liposuction / Submentoplasty\n- SUR-08: Brow Bone Reduction/Augmentation\n\n**Minimally Invasive (MIN-01 to MIN-06):**\n- MIN-01: Chin/Jawline Filler\n- MIN-02: Cheek Filler\n- MIN-03: Lip Filler\n- MIN-04: PDO Thread Lift\n- MIN-05: Masseter Botox\n- MIN-06: Kybella\n\n**Foundational (FND-01 to FND-05):**\n- FND-01: Mewing / Proper Tongue Posture\n- FND-02: Body Recomposition (Leanmaxxing)\n- FND-03: Posture Correction\n- FND-04: Skincare Routine (Retinoid + SPF)\n- FND-05: Eyebrow Grooming / Microblading\n\nNow looking at the RESEARCH_CITATIONS in EnhancedRecommendationCard.tsx, I need to fix:\n\n1. **Invalid references:**\n   - Line 133: `['SUR-05', 'MIN-07']` - MIN-07 doesn't exist (should be MIN-04 for PDO Thread Lift which affects canthal tilt)\n   - Line 191: `['FND-01', 'FND-06', 'FND-07']` - FND-06 and FND-07 don't exist (should use existing FND refs)\n   \nI'll implement a smart citation sorting strategy that prioritizes personalized research references. The sorting mechanism will dynamically rank citations based on user-specific attributes like gender and ethnicity, ensuring the most relevant scientific evidence appears first. This approach will create a more tailored and precise recommendation system.","signature":"EucMCkYIChgCKkAnNmBeQlK56imGIxdUYniWEn90xcsKSjHAkTs8yXhTWafp02ZQKtp0aEK6w673B5FP9kgoMQDjR3l62JiUAUBSEgxB+jlF2EXl7hGAKdMaDCnrF5HJIaLYRGG0jiIwDAgpROSOPCV2H2jkaiWTv3VYWe69TF2NMdfm50ok81qKubE4EapI/ZM9cuExH1I9Ks4L+35usXHtk1wqwxiy2rDbkLHzEz+HruCcR0ziqHyb1zfjRFq9AcGLNIJS2aWWnulgcrIKaT44NAUNEh5PkuA/TZtHamzoK2t5FoZMlpKbbt9b9un/zg/kNKb7m5UA0pcTvyH0Q+xhe2bXUDnX5Qwo9ZDroAjkHyZATYyVKTklOCVVxqaLD9rTtEf25UGpheck0CwO5vfhkCPgN7Zgn7d9ABjF5F/w7uHzvs+H3YfjRTv+yYyWQa5EPlHih41cUOkBkyGL9huWMU9fJqHruogdpea9Lo/w6ImLXEGvf/Tro7PYviC+l9vr9q6EdBRuRubKvts0ER92K9lsp3SAYr8/73a+ImQecmcTILB59r/ewsfLgV5vzjo+4EcN0sZQG6zrGzuBoLYIXsw7HfNwrHH+uf9ZDvkBj6ZxlBF0ysi2xCRYa150zX7cuxudbUfM2nYdMOdirfdKxZ7QoRoWXHIrNMutBBC53ZCOKgsQqPzjWYzgnFXDbkvsysZ6i7/ZtjC3O3X5cZnjafuN7pOMNSNyNyiVMTTPjMWz5SMgIkM225zHu7zf6nFGc8Z3snnM0bJwN58gPzxIgu7GuUv/SFMihhR+B6pELK8JKv7hRQF/SZBCA1Iyh04bODVa2JnLZ97SvJCTWKLO6uGgHxbEhwguDqpUV/G//RACjfif4YYlfiwJKwYV3qcOF5SzyRLKJUbFvSpr9KL+wGoeAGfw6cHlTr/IFSuGc82Nj3AIyQEuAU3AWOvp823SPh1Eos30AJjfe6SZLO0jfnJXKwa/nGILGD8gMnJAu9UMZ4sKdSmY3sjG7jTZTH5IaiQk3gYo2qSyUuSQbZlWidDVbfIjKXu9buRTlTa+kSK5hcf2UWTDClk0RfMaFRoruBAbDBQ8aVtNk9sykzkSC5mgSDNwyUx3bEllnNOmEuRywBUqpH7hAF9cFx8HIyYalmJOfdMKMEVvAV2qnN19vfjXTZQrPYLiXAhX5QHZQOz5a7xZqKIGttBhtuyofzmoEonkQRiTdN0tDBmhTfFvqUhy9WtJSZUIz613bmC+kJp7U1vaKFGBZR9LN8T0W6nF4p8jZPL/X6BaQme7Rnxe0DYmb2YqQYEkVsQ2LlmL+CqGSDBVtbF3Wx9jich37akXiR0miKo7qIxwxCGNE1nTeYfdnQNLUOFVk3dqLkFneIEZAFF5WB/U5W2+27VV8eoi8mHkYsNXk7kBcfgke+H5GZ8UbQw/gRTlvAJHEYRH2RO+d32jAF2maXDWnjzD9DZ7E2/cmi0oAOvN1QnLmEipbLJjnPfEQNLxbWDyeSKIEW2oDrEdm5YBsKSvsJ6Vy+bFPCykpWOLV3ytbPx53+NrPZNDSNzqxy+okc2qwCLqxk2JEMwHk/1gv4wxyf8TlMiOln77ZrgMiGV6ujgqNpo2jGAgAM3Dk/6SM5NudbYwJrCJF0sIxRoq4L8vxTOoGraRPzd33YysqxzZWiC7uXgx8vgQpvqLHJ8rzVtv/wteihC++vNRrd7HiBKNHF/ek5uVOjKmXxTvrCqVI2vU0tAyYgvgScA0rUaBLza1yW+edFoc4AmBVCJNee9LEQ86PNSsljO5/ZOo4KneL25KBDsAdjwiNMp8rU+zhAnwuIs3wCvXN/jlBe+6SSX/AOMPybD1xaZbXhzG4Iw7Q35Gnf1g0fMAemMrXOhKKLmmDc3ZIW59UqR/ucsMwrvt5V4re1U0quTNQH0WdYLnFd2R/FpSeqVob83M7p0fRfNpo6Ls8D+4R1qjBgnWn88CZTRcg41BG+yjBEtNMy5A8C+IQClYgVlWcAWrSCbU3HjtjTncTDJDrAwKOEf/MlDfQjelhC3rDYklYEH2UoFvJf3KgcaF3lf6dntuRuha/hehLwJRfZpciEBgeXR3PBM29uDPfeZ60eRtB9KgPfDELl2S16n6R27lHo/5QBTWO/FHwVgbe6QMABm9TUz5sx3x5R92kqWbv7JHG/uTNhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":11094,"cache_read_input_tokens":45680,"cache_creation":{"ephemeral_5m_input_tokens":11094,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzde24gMgJ9QJRr9LRA","type":"assistant","uuid":"d9cfd866-c7a3-443e-a25b-c84e410b08e5","timestamp":"2025-12-21T14:32:03.218Z"}
{"parentUuid":"d9cfd866-c7a3-443e-a25b-c84e410b08e5","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SDzGnnSNK9hEhgbrxAkyN3","type":"message","role":"assistant","content":[{"type":"text","text":"Now I understand the full picture. Let me fix both issues."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":11094,"cache_read_input_tokens":45680,"cache_creation":{"ephemeral_5m_input_tokens":11094,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzde24gMgJ9QJRr9LRA","type":"assistant","uuid":"1adce92b-f9e5-4b2d-8125-6a5ca9efcf80","timestamp":"2025-12-21T14:32:03.232Z"}
{"parentUuid":"1adce92b-f9e5-4b2d-8125-6a5ca9efcf80","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SDzGnnSNK9hEhgbrxAkyN3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LmTYQ91XXeu43Ueef9Xqjw","name":"TodoWrite","input":{"todos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"in_progress","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"pending","activeForm":"Adding relevance-based sorting to citations"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":11094,"cache_read_input_tokens":45680,"cache_creation":{"ephemeral_5m_input_tokens":11094,"ephemeral_1h_input_tokens":0},"output_tokens":737,"service_tier":"standard"}},"requestId":"req_011CWKzde24gMgJ9QJRr9LRA","type":"assistant","uuid":"eeef074e-4509-4bb6-84a2-2c5aa83a4e39","timestamp":"2025-12-21T14:32:03.286Z"}
{"parentUuid":"eeef074e-4509-4bb6-84a2-2c5aa83a4e39","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LmTYQ91XXeu43Ueef9Xqjw","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"0f8d8341-a010-4826-9479-b8a48734a05a","timestamp":"2025-12-21T14:32:03.300Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"in_progress","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"pending","activeForm":"Adding relevance-based sorting to citations"}]}}
{"parentUuid":"0f8d8341-a010-4826-9479-b8a48734a05a","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_018LTVDt9qt71mqmAw9NnRsn","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me fix the issues. Based on my analysis:\n\n**Invalid references to fix:**\n1. Line 133: `procedureRefs: ['SUR-05', 'MIN-07']` - MIN-07 doesn't exist. This is for \"Canthal Tilt and Facial Attractiveness\" - MIN-04 (PDO Thread Lift) addresses canthal tilt, so change to `['SUR-05', 'MIN-04']`\n\n2. Line 191: `procedureRefs: ['FND-01', 'FND-06', 'FND-07']` - FND-06 and FND-07 don't exist. This is for \"Grooming and First Impressions\" - FND-04 (Skincare) and FND-05 (Eyebrow Grooming) are relevant, so change to `['FND-04', 'FND-05']`\n\nLet me also fix the getRelevantCitations function to add relevance-based sorting.","signature":"Eo8GCkYIChgCKkA24v26czRJUp/vmsw6Fq6tTJMClagwYwJl6floehgwMXEf7odJnf5IN6eIQiLLalj2FxQfzIeWY1Fes4BykDTFEgwRVlSdUutr5nhxSmgaDOUS2mLohWuN2jP0FyIwTnOUtc1Xo4HGZiWk+93RYRT3gcPKMWMwHShFrJMV0qfl1GwE0SNNIMkMtEeTsZluKvYE8GB8xWn6e+UU7TFyR9NSHpTxtNeomDYKLt+PWI4cNHZgPakLjl7Lr8k6cyYJCbeszPSQFKnrXL9TezdSjAQwrNI9ocqhxH34FySwIMjUFeb3cDztc3x8vEnFsYbb0KXU2dGBToQwDBWSgOTdxtuaR21i9j5KUWetuJhvedEmWIP7ZFU31QvI5TPgWaG9NZt65uCjD76NUIpXUmq8MeQNxPvCNNQGALNqJ3bU6vE33tkKmG4fK8IOPfs13aZm3yEtBHdCfXiS0XeE7D2nAMWgAxWm+rE8zOrCQVZFEoalFv1KLIJTQLCbONvjtEQHYQ52ZMbUqN9zKThyh/g8U0VcYlWIgZdFjnMyjWqoZzSWOSFOjEN+KyP8TxYkrtMVW34JJw9LkVJSy0LHYg7IJCsLpIk++epcoPWEKR0gL7Jp/cEraxLokj5jU2Z9fwKwxOs1DCPgbyHB7wstNWr2AYu2OG1VUICy4nFrgEU1bvurJmPGZij8EXbQbgsKk+kuVm+K0Twuwwf6/wuZHXwbGF1wLE/Mi5lXfVqAFVr9XtUx7kTM4s6byIlKrxDokz8TjWa7NuNTygk4bh9DL7b1Oecbnxy1Clis8K1PoelIS3mjLxKEGoTr6Mlyv886c2zgOHYJG5b0O3zsyAoB2yNFzLvZ2g32ZGBv0sKJnl1yCfGLzMXy1uW0n6MVxzvDOVJE5VatgywJ9NrYjJRy0ER+Woffn2N87U/eueSZvKHFhG8BN9g0vroizQSdBtELCI6ueAJOrreKSloAvGS/Col7nAULMAgB1le7zfxFfxF8P76et13HkHTo/r3qjjmNOaHQK5wiGyV5D5YCGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":771,"cache_read_input_tokens":56774,"cache_creation":{"ephemeral_5m_input_tokens":771,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzf4LpkmeADWm9CVf5v","type":"assistant","uuid":"b8094045-c604-4368-9646-0d1611af799f","timestamp":"2025-12-21T14:32:11.974Z"}
{"parentUuid":"b8094045-c604-4368-9646-0d1611af799f","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_018LTVDt9qt71mqmAw9NnRsn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01C44dgxtZZg4WAmGMpeA4ie","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","old_string":"    procedureRefs: ['SUR-05', 'MIN-07'],","new_string":"    procedureRefs: ['SUR-05', 'MIN-04'],"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":771,"cache_read_input_tokens":56774,"cache_creation":{"ephemeral_5m_input_tokens":771,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzf4LpkmeADWm9CVf5v","type":"assistant","uuid":"0653b5b2-8cd1-4efb-abda-2fde0a4ee7e5","timestamp":"2025-12-21T14:32:13.710Z"}
{"parentUuid":"0653b5b2-8cd1-4efb-abda-2fde0a4ee7e5","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_018LTVDt9qt71mqmAw9NnRsn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Jtuddq3zQnkzv16RbTPerP","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","old_string":"    procedureRefs: ['FND-01', 'FND-06', 'FND-07'],","new_string":"    procedureRefs: ['FND-04', 'FND-05'],"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":771,"cache_read_input_tokens":56774,"cache_creation":{"ephemeral_5m_input_tokens":771,"ephemeral_1h_input_tokens":0},"output_tokens":563,"service_tier":"standard"}},"requestId":"req_011CWKzf4LpkmeADWm9CVf5v","type":"assistant","uuid":"1353f2e7-8a48-4b0b-957a-7b4c14eb2542","timestamp":"2025-12-21T14:32:15.164Z"}
{"type":"file-history-snapshot","messageId":"0653b5b2-8cd1-4efb-abda-2fde0a4ee7e5","snapshot":{"messageId":"a94b6ddd-e460-4a82-be01-101772354336","trackedFileBackups":{"src/components/results/cards/EnhancedRecommendationCard.tsx":{"backupFileName":"eeaa0feb60ed4d0a@v1","version":1,"backupTime":"2025-12-21T14:32:15.199Z"}},"timestamp":"2025-12-21T14:31:16.125Z"},"isSnapshotUpdate":true}
{"parentUuid":"1353f2e7-8a48-4b0b-957a-7b4c14eb2542","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01C44dgxtZZg4WAmGMpeA4ie","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   129→    authors: 'Rhee SC, et al.',\n   130→    journal: 'Plastic and Reconstructive Surgery',\n   131→    year: 2017,\n   132→    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n   133→    procedureRefs: ['SUR-05', 'MIN-04'],\n   134→    genderRelevance: 'both',\n   135→  },\n   136→  {\n   137→    title: 'Asian Blepharoplasty and Canthopexy',"}]},"uuid":"c05cc2bc-1b56-4259-a21e-d06c7ec375d2","timestamp":"2025-12-21T14:32:15.199Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","oldString":"    procedureRefs: ['SUR-05', 'MIN-07'],","newString":"    procedureRefs: ['SUR-05', 'MIN-04'],","originalFile":"'use client';\n\nimport { useState, useCallback, useMemo } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  ChevronDown,\n  Clock,\n  DollarSign,\n  AlertTriangle,\n  Target,\n  Info,\n  BookOpen,\n  CheckCircle,\n  Trash2,\n  Plus,\n  Sparkles,\n  ExternalLink,\n} from 'lucide-react';\nimport { Recommendation } from '@/types/results';\nimport { Gender, Ethnicity } from '@/lib/faceiq-scoring';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface EnhancedRecommendationCardProps {\n  recommendation: Recommendation;\n  isExpanded?: boolean;\n  onToggle?: () => void;\n  rank?: number;\n  onMarkComplete?: (id: string) => void;\n  onRemove?: (id: string) => void;\n  isCompleted?: boolean;\n  gender?: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// RESEARCH CITATIONS DATABASE\n// ============================================\n\ninterface ResearchCitation {\n  title: string;\n  authors: string;\n  journal: string;\n  year: number;\n  doi?: string;\n  summary: string;\n  procedureRefs: string[];  // Matches recommendation ref_id\n  genderRelevance?: 'male' | 'female' | 'both';\n  ethnicityRelevance?: Ethnicity[];\n}\n\nconst RESEARCH_CITATIONS: ResearchCitation[] = [\n  // Rhinoplasty Research\n  {\n    title: 'Ethnic Considerations in Rhinoplasty',\n    authors: 'Rohrich RJ, Bolden K',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2010,\n    doi: '10.1097/PRS.0b013e3181c6b2b7',\n    summary: 'Discusses the importance of preserving ethnic identity while achieving aesthetic goals in rhinoplasty across different ethnicities.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black', 'east_asian', 'south_asian', 'middle_eastern', 'hispanic'],\n  },\n  {\n    title: 'The Male Rhinoplasty',\n    authors: 'Foda HM',\n    journal: 'Facial Plastic Surgery',\n    year: 2008,\n    summary: 'Examines unique considerations for male rhinoplasty including maintaining masculine features and avoiding feminization.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'male',\n  },\n  // Jaw/Chin Research\n  {\n    title: 'Sliding Genioplasty: A Systematic Review',\n    authors: 'Park JH, Tae-Hoon K',\n    journal: 'Journal of Oral and Maxillofacial Surgery',\n    year: 2018,\n    summary: 'Comprehensive analysis of chin advancement outcomes and patient satisfaction rates across demographics.',\n    procedureRefs: ['SUR-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Gender Differences in Jaw Angle Aesthetics',\n    authors: 'Kim YH, Cho J',\n    journal: 'Aesthetic Plastic Surgery',\n    year: 2020,\n    summary: 'Research on ideal jaw angle parameters for males (90-110°) versus females (110-120°).',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Mandibular Angle Augmentation in Asian Patients',\n    authors: 'Lee YJ, Park KS',\n    journal: 'Asian Journal of Beauty and Cosmetology',\n    year: 2019,\n    summary: 'Study on jaw angle enhancement specific to East Asian facial structure and aesthetic preferences.',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Lip Research\n  {\n    title: 'Ideal Lip Proportions Across Ethnicities',\n    authors: 'Farkas LG, Katic MJ',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2003,\n    summary: 'Anthropometric study establishing ethnic-specific ideal lip ratios and proportions.',\n    procedureRefs: ['MIN-01', 'FND-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['white', 'black', 'east_asian', 'hispanic'],\n  },\n  {\n    title: 'Lip Enhancement in African American Patients',\n    authors: 'Mack WP',\n    journal: 'Facial Plastic Surgery Clinics',\n    year: 2014,\n    summary: 'Guidelines for maintaining ethnic characteristics while enhancing lip aesthetics.',\n    procedureRefs: ['MIN-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black'],\n  },\n  // Eye/Canthal Research\n  {\n    title: 'Canthal Tilt and Facial Attractiveness',\n    authors: 'Rhee SC, et al.',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2017,\n    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n    procedureRefs: ['SUR-05', 'MIN-07'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Asian Blepharoplasty and Canthopexy',\n    authors: 'Chen WP',\n    journal: 'Ophthalmic Plastic Surgery',\n    year: 2016,\n    summary: 'Specific techniques for Asian eyelid surgery that preserve ethnic identity while enhancing eye shape.',\n    procedureRefs: ['SUR-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Midface/Cheek Research\n  {\n    title: 'Cheekbone Enhancement for Facial Harmony',\n    authors: 'Mendelson B, Wong CH',\n    journal: 'Clinics in Plastic Surgery',\n    year: 2015,\n    summary: 'Analysis of malar augmentation effects on overall facial harmony and perceived attractiveness.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Midface Aesthetics in Middle Eastern Populations',\n    authors: 'Rohrich RJ, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2021,\n    summary: 'Ethnic considerations for midface enhancement in Middle Eastern patients.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['middle_eastern'],\n  },\n  // Foundational/Non-Surgical Research\n  {\n    title: 'Mewing and Orthotropic Treatment',\n    authors: 'Mew J, Mew M',\n    journal: 'International Journal of Orthodontics',\n    year: 2014,\n    summary: 'Research on proper tongue posture and its effects on facial development and structure.',\n    procedureRefs: ['FND-02', 'FND-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Effects of Body Composition on Facial Aesthetics',\n    authors: 'Morrison CS, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2017,\n    summary: 'Study on how body fat percentage affects facial definition and perceived attractiveness.',\n    procedureRefs: ['FND-04', 'FND-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Grooming and First Impressions',\n    authors: 'Phelan C, Etcoff N',\n    journal: 'Journal of Applied Social Psychology',\n    year: 2011,\n    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n    procedureRefs: ['FND-01', 'FND-06', 'FND-07'],\n    genderRelevance: 'both',\n  },\n  // Orthognathic Research\n  {\n    title: 'Bimaxillary Surgery Outcomes',\n    authors: 'Rustemeyer J, et al.',\n    journal: 'Journal of Cranio-Maxillofacial Surgery',\n    year: 2019,\n    summary: 'Long-term outcomes and patient satisfaction following double jaw surgery.',\n    procedureRefs: ['SUR-04'],\n    genderRelevance: 'both',\n  },\n  // General Attractiveness Research\n  {\n    title: 'Cross-Cultural Facial Attractiveness',\n    authors: 'Perrett DI, et al.',\n    journal: 'Nature',\n    year: 1998,\n    summary: 'Landmark study on universal vs. culture-specific aspects of facial attractiveness.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Golden Ratios in Facial Beauty',\n    authors: 'Marquardt SR',\n    journal: 'International Journal of Cosmetic Surgery',\n    year: 2002,\n    summary: 'Analysis of mathematical proportions and their relationship to perceived facial beauty.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06', 'MIN-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n];\n\nfunction getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  return RESEARCH_CITATIONS.filter(citation => {\n    // Must match the procedure\n    if (!citation.procedureRefs.includes(procedureRefId)) return false;\n\n    // Check gender relevance\n    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {\n      if (citation.genderRelevance !== gender) return false;\n    }\n\n    // Check ethnicity relevance\n    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {\n      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation\n      if (!citation.ethnicityRelevance.includes(ethnicity)) {\n        // Only exclude if the citation is ethnicity-specific\n        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  }).slice(0, 3); // Limit to 3 most relevant citations\n}\n\ninterface TrackerState {\n  notes: string;\n  checklist: Array<{ id: string; text: string; completed: boolean }>;\n}\n\n// ============================================\n// PHASE BADGE (Dark Theme)\n// ============================================\n\nfunction PhaseBadge({ phase }: { phase: string }) {\n  const getPhaseConfig = () => {\n    switch (phase) {\n      case 'Foundational':\n        return {\n          bg: 'bg-emerald-500/20',\n          text: 'text-emerald-400',\n          border: 'border-emerald-500/30',\n        };\n      case 'Minimally Invasive':\n        return {\n          bg: 'bg-blue-500/20',\n          text: 'text-blue-400',\n          border: 'border-blue-500/30',\n        };\n      case 'Surgical':\n        return {\n          bg: 'bg-purple-500/20',\n          text: 'text-purple-400',\n          border: 'border-purple-500/30',\n        };\n      default:\n        return {\n          bg: 'bg-neutral-500/20',\n          text: 'text-neutral-400',\n          border: 'border-neutral-500/30',\n        };\n    }\n  };\n\n  const config = getPhaseConfig();\n\n  return (\n    <span\n      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}\n    >\n      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}\n    </span>\n  );\n}\n\n// ============================================\n// IMPACT BADGE\n// ============================================\n\nfunction ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {\n  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);\n\n  return (\n    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n      <span className=\"flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0\">\n        <Sparkles className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n        {formattedImpact}\n      </span>\n      {(frontImpact !== undefined || sideImpact !== undefined) && (\n        <span className=\"hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0\">\n          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}\n          </span>\n          <span className=\"text-neutral-600\">|</span>\n          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}\n          </span>\n        </span>\n      )}\n    </div>\n  );\n}\n\n// ============================================\n// IMPROVEMENT TAG\n// ============================================\n\nfunction ImprovementTag({ text }: { text: string }) {\n  return (\n    <div className=\"inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm\">\n      <CheckCircle className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0\" />\n      <span className=\"truncate\">{text}</span>\n    </div>\n  );\n}\n\n// ============================================\n// SECTION HEADER\n// ============================================\n\nfunction SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {\n  return (\n    <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3\">\n      <Icon className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n      {title}\n    </h4>\n  );\n}\n\n// ============================================\n// MY TRACKER SECTION\n// ============================================\n\nfunction MyTracker({\n  tracker,\n  onNotesChange,\n  onAddChecklistItem,\n  onToggleChecklistItem,\n  onRemoveChecklistItem\n}: {\n  tracker: TrackerState;\n  onNotesChange: (notes: string) => void;\n  onAddChecklistItem: () => void;\n  onToggleChecklistItem: (id: string) => void;\n  onRemoveChecklistItem: (id: string) => void;\n}) {\n  return (\n    <div className=\"md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full\">\n      <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4\">\n        <BookOpen className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n        My Tracker\n      </h4>\n      <div className=\"space-y-3 sm:space-y-4\">\n        {/* Personal Notes */}\n        <div className=\"space-y-1 sm:space-y-1.5\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400\">Personal Notes</label>\n          <textarea\n            value={tracker.notes}\n            onChange={(e) => onNotesChange(e.target.value)}\n            className=\"w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all\"\n            placeholder=\"Track progress, questions, dates...\"\n          />\n        </div>\n\n        {/* Checklist */}\n        <div className=\"space-y-1.5 sm:space-y-2 pt-1 sm:pt-2\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center\">\n            <span>Checklist</span>\n            <button\n              onClick={onAddChecklistItem}\n              className=\"text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors\"\n            >\n              <Plus className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n              Add\n            </button>\n          </label>\n          <div className=\"space-y-1.5 sm:space-y-2\">\n            {tracker.checklist.length === 0 ? (\n              <div className=\"text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50\">\n                No tasks yet\n              </div>\n            ) : (\n              tracker.checklist.map((item) => (\n                <div\n                  key={item.id}\n                  className=\"flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg\"\n                >\n                  <button\n                    onClick={() => onToggleChecklistItem(item.id)}\n                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${\n                      item.completed\n                        ? 'bg-emerald-500 border-emerald-500'\n                        : 'border-neutral-600 hover:border-neutral-500'\n                    }`}\n                  >\n                    {item.completed && <CheckCircle className=\"w-3 h-3 text-black\" />}\n                  </button>\n                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>\n                    {item.text}\n                  </span>\n                  <button\n                    onClick={() => onRemoveChecklistItem(item.id)}\n                    className=\"text-neutral-600 hover:text-red-400 transition-colors\"\n                  >\n                    <Trash2 className=\"w-3 h-3\" />\n                  </button>\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// MAIN ENHANCED RECOMMENDATION CARD\n// ============================================\n\nexport function EnhancedRecommendationCard({\n  recommendation,\n  isExpanded = false,\n  onToggle,\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  rank,\n  onMarkComplete,\n  onRemove,\n  isCompleted = false,\n  gender,\n  ethnicity,\n}: EnhancedRecommendationCardProps) {\n  // Tracker state (would be persisted in real app)\n  const [tracker, setTracker] = useState<TrackerState>({\n    notes: '',\n    checklist: [],\n  });\n\n  // Get relevant research citations based on procedure, gender, and ethnicity\n  const citations = useMemo(() => {\n    return getRelevantCitations(recommendation.ref_id, gender, ethnicity);\n  }, [recommendation.ref_id, gender, ethnicity]);\n\n  const handleNotesChange = useCallback((notes: string) => {\n    setTracker(prev => ({ ...prev, notes }));\n  }, []);\n\n  const handleAddChecklistItem = useCallback(() => {\n    const text = window.prompt('Enter task:');\n    if (text) {\n      setTracker(prev => ({\n        ...prev,\n        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],\n      }));\n    }\n  }, []);\n\n  const handleToggleChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.map(item =>\n        item.id === id ? { ...item, completed: !item.completed } : item\n      ),\n    }));\n  }, []);\n\n  const handleRemoveChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.filter(item => item.id !== id),\n    }));\n  }, []);\n\n  // Format cost\n  const formatCost = () => {\n    const { min, max, type } = recommendation.cost;\n    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';\n    if (min === max) {\n      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n    }\n    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n  };\n\n  // Format timeline\n  const formatTimeline = () => {\n    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;\n    if (full_results_weeks_max) {\n      return `${full_results_weeks}-${full_results_weeks_max} weeks`;\n    }\n    if (full_results_weeks >= 52) {\n      const months = Math.round(full_results_weeks / 4);\n      return `${months} months`;\n    }\n    return `${full_results_weeks} weeks`;\n  };\n\n  // Get effectiveness level\n  const getEffectiveness = () => {\n    if (recommendation.impact >= 0.7) return 'high';\n    if (recommendation.impact >= 0.4) return 'moderate';\n    return 'low';\n  };\n\n  return (\n    <motion.div\n      layout\n      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${\n        isExpanded\n          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'\n          : 'border-neutral-800 hover:border-neutral-700'\n      } ${isCompleted ? 'opacity-60' : ''}`}\n    >\n      {/* Header - Clickable */}\n      <div className=\"p-3.5 sm:p-5 cursor-pointer\" onClick={onToggle}>\n        <div className=\"space-y-3 sm:space-y-4\">\n          <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2\">\n                <h3 className=\"text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white\">\n                  {recommendation.name}\n                </h3>\n                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n                  <PhaseBadge phase={recommendation.phase} />\n                  <ImpactBadge impact={recommendation.impact} />\n                </div>\n              </div>\n              <p className=\"text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none\">\n                {recommendation.description}\n              </p>\n            </div>\n\n            {/* Action buttons */}\n            <div className=\"flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto\">\n              {onMarkComplete && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onMarkComplete(recommendation.ref_id);\n                  }}\n                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${\n                    isCompleted\n                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'\n                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'\n                  }`}\n                  title=\"Mark as complete\"\n                >\n                  <CheckCircle className=\"w-4 h-4\" />\n                </button>\n              )}\n              {onRemove && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onRemove(recommendation.ref_id);\n                  }}\n                  className=\"p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10\"\n                  title=\"Remove action\"\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </button>\n              )}\n            </div>\n          </div>\n\n          {/* Quick stats row */}\n          <div className=\"flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400\">\n            <div className=\"flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5\">\n              <div className=\"flex items-center gap-1 sm:gap-1.5\" title=\"Estimated Cost\">\n                <DollarSign className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                <span className=\"font-medium text-neutral-300\">{formatCost()}</span>\n              </div>\n              {recommendation.timeline.full_results_weeks > 0 && (\n                <div className=\"flex items-center gap-1 sm:gap-1.5\">\n                  <Clock className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                  <span className=\"font-medium text-neutral-300\">{formatTimeline()}</span>\n                </div>\n              )}\n            </div>\n            <button\n              className=\"flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white\"\n            >\n              {isExpanded ? 'Less' : 'More'}\n              <ChevronDown\n                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n              />\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded Content */}\n      <AnimatePresence initial={false}>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.3 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"border-t border-neutral-800 bg-neutral-900/50\">\n              <div className=\"grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800\">\n                {/* Main Content */}\n                <div className=\"md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6\">\n                  {/* Improvements */}\n                  <div>\n                    <SectionHeader icon={Target} title=\"Improvements\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\n                        {recommendation.matchedFlaws.map((flaw, i) => (\n                          <ImprovementTag key={i} text={flaw} />\n                        ))}\n                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (\n                          <ImprovementTag key={i} text={ratio} />\n                        ))}\n                      </div>\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n                          <div className=\"text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase\">Effectiveness</div>\n                          <div className=\"h-1 w-1 rounded-full bg-neutral-600\" />\n                          <div className=\"font-medium text-white capitalize text-xs sm:text-sm\">{getEffectiveness()}</div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* How It Helps */}\n                  <div>\n                    <SectionHeader icon={Info} title=\"How It Helps\" />\n                    <div className=\"space-y-1.5 sm:space-y-2\">\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                          {recommendation.description}\n                        </p>\n                      </div>\n                      {recommendation.ratios_impacted.length > 0 && (\n                        <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                          <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}\n                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Logistics & Timeline */}\n                  {recommendation.timeline.full_results_weeks > 0 && (\n                    <div>\n                      <SectionHeader icon={Clock} title=\"Logistics & Timeline\" />\n                      <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Effect Starts\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white capitalize\">\n                            {recommendation.timeline.effect_start}\n                          </span>\n                        </div>\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Full Results\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white\">\n                            {formatTimeline()}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Considerations */}\n                  <div>\n                    <SectionHeader icon={AlertTriangle} title=\"Considerations\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      {/* Prerequisites */}\n                      {recommendation.warnings.length > 0 && (\n                        <div className=\"bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm\">\n                          <span className=\"font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">Prerequisites</span>\n                          <p className=\"text-blue-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.warnings[0]}\n                          </p>\n                        </div>\n                      )}\n\n                      {/* Risks & Side Effects */}\n                      {recommendation.risks_side_effects && (\n                        <div className=\"bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm\">\n                          <span className=\"font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">\n                            Risks & Side Effects\n                          </span>\n                          <p className=\"text-amber-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.risks_side_effects}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Notes & Warnings */}\n                  {recommendation.warnings.length > 1 && (\n                    <div className=\"text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic\">\n                      {recommendation.warnings.slice(1).join(' ')}\n                    </div>\n                  )}\n\n                  {/* Research Citations */}\n                  <div className=\"bg-cyan-500/10 p-3 sm:p-4 rounded-lg border border-cyan-500/30\">\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <BookOpen size={14} className=\"text-cyan-400\" />\n                      <span className=\"font-semibold text-cyan-400 text-xs sm:text-sm\">Research & Evidence</span>\n                      {ethnicity && ethnicity !== 'other' && (\n                        <span className=\"text-[9px] px-1.5 py-0.5 bg-cyan-500/20 rounded text-cyan-300 capitalize\">\n                          {ethnicity.replace('_', ' ')} focus\n                        </span>\n                      )}\n                    </div>\n                    {citations.length > 0 ? (\n                      <div className=\"space-y-2.5\">\n                        {citations.map((citation, idx) => (\n                          <div key={idx} className=\"text-[11px] sm:text-xs bg-neutral-900/50 p-2.5 rounded-lg border border-neutral-700/50\">\n                            <div className=\"flex items-start justify-between gap-2\">\n                              <div className=\"flex-1\">\n                                <div className=\"font-medium text-cyan-300 mb-0.5 line-clamp-2\">\n                                  {citation.title}\n                                </div>\n                                <div className=\"text-neutral-500 text-[10px] mb-1\">\n                                  {citation.authors} • {citation.journal} ({citation.year})\n                                </div>\n                                <div className=\"text-neutral-400 leading-relaxed\">\n                                  {citation.summary}\n                                </div>\n                              </div>\n                              {citation.doi && (\n                                <a\n                                  href={`https://doi.org/${citation.doi}`}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"flex-shrink-0 p-1 text-cyan-400 hover:text-cyan-300 transition-colors\"\n                                  title=\"View full paper\"\n                                >\n                                  <ExternalLink size={12} />\n                                </a>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-[11px] sm:text-xs text-cyan-300/70\">\n                        {recommendation.matchedFlaws.length > 0\n                          ? 'Based on facial analysis and established aesthetic research. More specific citations coming soon.'\n                          : 'No specific research citations available for this recommendation.'}\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* My Tracker Sidebar */}\n                <MyTracker\n                  tracker={tracker}\n                  onNotesChange={handleNotesChange}\n                  onAddChecklistItem={handleAddChecklistItem}\n                  onToggleChecklistItem={handleToggleChecklistItem}\n                  onRemoveChecklistItem={handleRemoveChecklistItem}\n                />\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\nexport default EnhancedRecommendationCard;\n","structuredPatch":[{"oldStart":130,"oldLines":7,"newStart":130,"newLines":7,"lines":["     journal: 'Plastic and Reconstructive Surgery',","     year: 2017,","     summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',","-    procedureRefs: ['SUR-05', 'MIN-07'],","+    procedureRefs: ['SUR-05', 'MIN-04'],","     genderRelevance: 'both',","   },","   {"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"c05cc2bc-1b56-4259-a21e-d06c7ec375d2","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Jtuddq3zQnkzv16RbTPerP","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   187→    authors: 'Phelan C, Etcoff N',\n   188→    journal: 'Journal of Applied Social Psychology',\n   189→    year: 2011,\n   190→    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n   191→    procedureRefs: ['FND-04', 'FND-05'],\n   192→    genderRelevance: 'both',\n   193→  },\n   194→  // Orthognathic Research\n   195→  {"}]},"uuid":"73ef76f3-ef63-46c2-8112-ac9dde6892b8","timestamp":"2025-12-21T14:32:16.308Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","oldString":"    procedureRefs: ['FND-01', 'FND-06', 'FND-07'],","newString":"    procedureRefs: ['FND-04', 'FND-05'],","originalFile":"'use client';\n\nimport { useState, useCallback, useMemo } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  ChevronDown,\n  Clock,\n  DollarSign,\n  AlertTriangle,\n  Target,\n  Info,\n  BookOpen,\n  CheckCircle,\n  Trash2,\n  Plus,\n  Sparkles,\n  ExternalLink,\n} from 'lucide-react';\nimport { Recommendation } from '@/types/results';\nimport { Gender, Ethnicity } from '@/lib/faceiq-scoring';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface EnhancedRecommendationCardProps {\n  recommendation: Recommendation;\n  isExpanded?: boolean;\n  onToggle?: () => void;\n  rank?: number;\n  onMarkComplete?: (id: string) => void;\n  onRemove?: (id: string) => void;\n  isCompleted?: boolean;\n  gender?: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// RESEARCH CITATIONS DATABASE\n// ============================================\n\ninterface ResearchCitation {\n  title: string;\n  authors: string;\n  journal: string;\n  year: number;\n  doi?: string;\n  summary: string;\n  procedureRefs: string[];  // Matches recommendation ref_id\n  genderRelevance?: 'male' | 'female' | 'both';\n  ethnicityRelevance?: Ethnicity[];\n}\n\nconst RESEARCH_CITATIONS: ResearchCitation[] = [\n  // Rhinoplasty Research\n  {\n    title: 'Ethnic Considerations in Rhinoplasty',\n    authors: 'Rohrich RJ, Bolden K',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2010,\n    doi: '10.1097/PRS.0b013e3181c6b2b7',\n    summary: 'Discusses the importance of preserving ethnic identity while achieving aesthetic goals in rhinoplasty across different ethnicities.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black', 'east_asian', 'south_asian', 'middle_eastern', 'hispanic'],\n  },\n  {\n    title: 'The Male Rhinoplasty',\n    authors: 'Foda HM',\n    journal: 'Facial Plastic Surgery',\n    year: 2008,\n    summary: 'Examines unique considerations for male rhinoplasty including maintaining masculine features and avoiding feminization.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'male',\n  },\n  // Jaw/Chin Research\n  {\n    title: 'Sliding Genioplasty: A Systematic Review',\n    authors: 'Park JH, Tae-Hoon K',\n    journal: 'Journal of Oral and Maxillofacial Surgery',\n    year: 2018,\n    summary: 'Comprehensive analysis of chin advancement outcomes and patient satisfaction rates across demographics.',\n    procedureRefs: ['SUR-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Gender Differences in Jaw Angle Aesthetics',\n    authors: 'Kim YH, Cho J',\n    journal: 'Aesthetic Plastic Surgery',\n    year: 2020,\n    summary: 'Research on ideal jaw angle parameters for males (90-110°) versus females (110-120°).',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Mandibular Angle Augmentation in Asian Patients',\n    authors: 'Lee YJ, Park KS',\n    journal: 'Asian Journal of Beauty and Cosmetology',\n    year: 2019,\n    summary: 'Study on jaw angle enhancement specific to East Asian facial structure and aesthetic preferences.',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Lip Research\n  {\n    title: 'Ideal Lip Proportions Across Ethnicities',\n    authors: 'Farkas LG, Katic MJ',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2003,\n    summary: 'Anthropometric study establishing ethnic-specific ideal lip ratios and proportions.',\n    procedureRefs: ['MIN-01', 'FND-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['white', 'black', 'east_asian', 'hispanic'],\n  },\n  {\n    title: 'Lip Enhancement in African American Patients',\n    authors: 'Mack WP',\n    journal: 'Facial Plastic Surgery Clinics',\n    year: 2014,\n    summary: 'Guidelines for maintaining ethnic characteristics while enhancing lip aesthetics.',\n    procedureRefs: ['MIN-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black'],\n  },\n  // Eye/Canthal Research\n  {\n    title: 'Canthal Tilt and Facial Attractiveness',\n    authors: 'Rhee SC, et al.',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2017,\n    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n    procedureRefs: ['SUR-05', 'MIN-04'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Asian Blepharoplasty and Canthopexy',\n    authors: 'Chen WP',\n    journal: 'Ophthalmic Plastic Surgery',\n    year: 2016,\n    summary: 'Specific techniques for Asian eyelid surgery that preserve ethnic identity while enhancing eye shape.',\n    procedureRefs: ['SUR-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Midface/Cheek Research\n  {\n    title: 'Cheekbone Enhancement for Facial Harmony',\n    authors: 'Mendelson B, Wong CH',\n    journal: 'Clinics in Plastic Surgery',\n    year: 2015,\n    summary: 'Analysis of malar augmentation effects on overall facial harmony and perceived attractiveness.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Midface Aesthetics in Middle Eastern Populations',\n    authors: 'Rohrich RJ, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2021,\n    summary: 'Ethnic considerations for midface enhancement in Middle Eastern patients.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['middle_eastern'],\n  },\n  // Foundational/Non-Surgical Research\n  {\n    title: 'Mewing and Orthotropic Treatment',\n    authors: 'Mew J, Mew M',\n    journal: 'International Journal of Orthodontics',\n    year: 2014,\n    summary: 'Research on proper tongue posture and its effects on facial development and structure.',\n    procedureRefs: ['FND-02', 'FND-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Effects of Body Composition on Facial Aesthetics',\n    authors: 'Morrison CS, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2017,\n    summary: 'Study on how body fat percentage affects facial definition and perceived attractiveness.',\n    procedureRefs: ['FND-04', 'FND-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Grooming and First Impressions',\n    authors: 'Phelan C, Etcoff N',\n    journal: 'Journal of Applied Social Psychology',\n    year: 2011,\n    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n    procedureRefs: ['FND-01', 'FND-06', 'FND-07'],\n    genderRelevance: 'both',\n  },\n  // Orthognathic Research\n  {\n    title: 'Bimaxillary Surgery Outcomes',\n    authors: 'Rustemeyer J, et al.',\n    journal: 'Journal of Cranio-Maxillofacial Surgery',\n    year: 2019,\n    summary: 'Long-term outcomes and patient satisfaction following double jaw surgery.',\n    procedureRefs: ['SUR-04'],\n    genderRelevance: 'both',\n  },\n  // General Attractiveness Research\n  {\n    title: 'Cross-Cultural Facial Attractiveness',\n    authors: 'Perrett DI, et al.',\n    journal: 'Nature',\n    year: 1998,\n    summary: 'Landmark study on universal vs. culture-specific aspects of facial attractiveness.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Golden Ratios in Facial Beauty',\n    authors: 'Marquardt SR',\n    journal: 'International Journal of Cosmetic Surgery',\n    year: 2002,\n    summary: 'Analysis of mathematical proportions and their relationship to perceived facial beauty.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06', 'MIN-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n];\n\nfunction getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  return RESEARCH_CITATIONS.filter(citation => {\n    // Must match the procedure\n    if (!citation.procedureRefs.includes(procedureRefId)) return false;\n\n    // Check gender relevance\n    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {\n      if (citation.genderRelevance !== gender) return false;\n    }\n\n    // Check ethnicity relevance\n    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {\n      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation\n      if (!citation.ethnicityRelevance.includes(ethnicity)) {\n        // Only exclude if the citation is ethnicity-specific\n        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  }).slice(0, 3); // Limit to 3 most relevant citations\n}\n\ninterface TrackerState {\n  notes: string;\n  checklist: Array<{ id: string; text: string; completed: boolean }>;\n}\n\n// ============================================\n// PHASE BADGE (Dark Theme)\n// ============================================\n\nfunction PhaseBadge({ phase }: { phase: string }) {\n  const getPhaseConfig = () => {\n    switch (phase) {\n      case 'Foundational':\n        return {\n          bg: 'bg-emerald-500/20',\n          text: 'text-emerald-400',\n          border: 'border-emerald-500/30',\n        };\n      case 'Minimally Invasive':\n        return {\n          bg: 'bg-blue-500/20',\n          text: 'text-blue-400',\n          border: 'border-blue-500/30',\n        };\n      case 'Surgical':\n        return {\n          bg: 'bg-purple-500/20',\n          text: 'text-purple-400',\n          border: 'border-purple-500/30',\n        };\n      default:\n        return {\n          bg: 'bg-neutral-500/20',\n          text: 'text-neutral-400',\n          border: 'border-neutral-500/30',\n        };\n    }\n  };\n\n  const config = getPhaseConfig();\n\n  return (\n    <span\n      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}\n    >\n      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}\n    </span>\n  );\n}\n\n// ============================================\n// IMPACT BADGE\n// ============================================\n\nfunction ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {\n  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);\n\n  return (\n    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n      <span className=\"flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0\">\n        <Sparkles className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n        {formattedImpact}\n      </span>\n      {(frontImpact !== undefined || sideImpact !== undefined) && (\n        <span className=\"hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0\">\n          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}\n          </span>\n          <span className=\"text-neutral-600\">|</span>\n          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}\n          </span>\n        </span>\n      )}\n    </div>\n  );\n}\n\n// ============================================\n// IMPROVEMENT TAG\n// ============================================\n\nfunction ImprovementTag({ text }: { text: string }) {\n  return (\n    <div className=\"inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm\">\n      <CheckCircle className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0\" />\n      <span className=\"truncate\">{text}</span>\n    </div>\n  );\n}\n\n// ============================================\n// SECTION HEADER\n// ============================================\n\nfunction SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {\n  return (\n    <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3\">\n      <Icon className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n      {title}\n    </h4>\n  );\n}\n\n// ============================================\n// MY TRACKER SECTION\n// ============================================\n\nfunction MyTracker({\n  tracker,\n  onNotesChange,\n  onAddChecklistItem,\n  onToggleChecklistItem,\n  onRemoveChecklistItem\n}: {\n  tracker: TrackerState;\n  onNotesChange: (notes: string) => void;\n  onAddChecklistItem: () => void;\n  onToggleChecklistItem: (id: string) => void;\n  onRemoveChecklistItem: (id: string) => void;\n}) {\n  return (\n    <div className=\"md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full\">\n      <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4\">\n        <BookOpen className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n        My Tracker\n      </h4>\n      <div className=\"space-y-3 sm:space-y-4\">\n        {/* Personal Notes */}\n        <div className=\"space-y-1 sm:space-y-1.5\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400\">Personal Notes</label>\n          <textarea\n            value={tracker.notes}\n            onChange={(e) => onNotesChange(e.target.value)}\n            className=\"w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all\"\n            placeholder=\"Track progress, questions, dates...\"\n          />\n        </div>\n\n        {/* Checklist */}\n        <div className=\"space-y-1.5 sm:space-y-2 pt-1 sm:pt-2\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center\">\n            <span>Checklist</span>\n            <button\n              onClick={onAddChecklistItem}\n              className=\"text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors\"\n            >\n              <Plus className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n              Add\n            </button>\n          </label>\n          <div className=\"space-y-1.5 sm:space-y-2\">\n            {tracker.checklist.length === 0 ? (\n              <div className=\"text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50\">\n                No tasks yet\n              </div>\n            ) : (\n              tracker.checklist.map((item) => (\n                <div\n                  key={item.id}\n                  className=\"flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg\"\n                >\n                  <button\n                    onClick={() => onToggleChecklistItem(item.id)}\n                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${\n                      item.completed\n                        ? 'bg-emerald-500 border-emerald-500'\n                        : 'border-neutral-600 hover:border-neutral-500'\n                    }`}\n                  >\n                    {item.completed && <CheckCircle className=\"w-3 h-3 text-black\" />}\n                  </button>\n                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>\n                    {item.text}\n                  </span>\n                  <button\n                    onClick={() => onRemoveChecklistItem(item.id)}\n                    className=\"text-neutral-600 hover:text-red-400 transition-colors\"\n                  >\n                    <Trash2 className=\"w-3 h-3\" />\n                  </button>\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// MAIN ENHANCED RECOMMENDATION CARD\n// ============================================\n\nexport function EnhancedRecommendationCard({\n  recommendation,\n  isExpanded = false,\n  onToggle,\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  rank,\n  onMarkComplete,\n  onRemove,\n  isCompleted = false,\n  gender,\n  ethnicity,\n}: EnhancedRecommendationCardProps) {\n  // Tracker state (would be persisted in real app)\n  const [tracker, setTracker] = useState<TrackerState>({\n    notes: '',\n    checklist: [],\n  });\n\n  // Get relevant research citations based on procedure, gender, and ethnicity\n  const citations = useMemo(() => {\n    return getRelevantCitations(recommendation.ref_id, gender, ethnicity);\n  }, [recommendation.ref_id, gender, ethnicity]);\n\n  const handleNotesChange = useCallback((notes: string) => {\n    setTracker(prev => ({ ...prev, notes }));\n  }, []);\n\n  const handleAddChecklistItem = useCallback(() => {\n    const text = window.prompt('Enter task:');\n    if (text) {\n      setTracker(prev => ({\n        ...prev,\n        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],\n      }));\n    }\n  }, []);\n\n  const handleToggleChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.map(item =>\n        item.id === id ? { ...item, completed: !item.completed } : item\n      ),\n    }));\n  }, []);\n\n  const handleRemoveChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.filter(item => item.id !== id),\n    }));\n  }, []);\n\n  // Format cost\n  const formatCost = () => {\n    const { min, max, type } = recommendation.cost;\n    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';\n    if (min === max) {\n      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n    }\n    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n  };\n\n  // Format timeline\n  const formatTimeline = () => {\n    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;\n    if (full_results_weeks_max) {\n      return `${full_results_weeks}-${full_results_weeks_max} weeks`;\n    }\n    if (full_results_weeks >= 52) {\n      const months = Math.round(full_results_weeks / 4);\n      return `${months} months`;\n    }\n    return `${full_results_weeks} weeks`;\n  };\n\n  // Get effectiveness level\n  const getEffectiveness = () => {\n    if (recommendation.impact >= 0.7) return 'high';\n    if (recommendation.impact >= 0.4) return 'moderate';\n    return 'low';\n  };\n\n  return (\n    <motion.div\n      layout\n      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${\n        isExpanded\n          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'\n          : 'border-neutral-800 hover:border-neutral-700'\n      } ${isCompleted ? 'opacity-60' : ''}`}\n    >\n      {/* Header - Clickable */}\n      <div className=\"p-3.5 sm:p-5 cursor-pointer\" onClick={onToggle}>\n        <div className=\"space-y-3 sm:space-y-4\">\n          <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2\">\n                <h3 className=\"text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white\">\n                  {recommendation.name}\n                </h3>\n                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n                  <PhaseBadge phase={recommendation.phase} />\n                  <ImpactBadge impact={recommendation.impact} />\n                </div>\n              </div>\n              <p className=\"text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none\">\n                {recommendation.description}\n              </p>\n            </div>\n\n            {/* Action buttons */}\n            <div className=\"flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto\">\n              {onMarkComplete && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onMarkComplete(recommendation.ref_id);\n                  }}\n                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${\n                    isCompleted\n                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'\n                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'\n                  }`}\n                  title=\"Mark as complete\"\n                >\n                  <CheckCircle className=\"w-4 h-4\" />\n                </button>\n              )}\n              {onRemove && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onRemove(recommendation.ref_id);\n                  }}\n                  className=\"p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10\"\n                  title=\"Remove action\"\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </button>\n              )}\n            </div>\n          </div>\n\n          {/* Quick stats row */}\n          <div className=\"flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400\">\n            <div className=\"flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5\">\n              <div className=\"flex items-center gap-1 sm:gap-1.5\" title=\"Estimated Cost\">\n                <DollarSign className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                <span className=\"font-medium text-neutral-300\">{formatCost()}</span>\n              </div>\n              {recommendation.timeline.full_results_weeks > 0 && (\n                <div className=\"flex items-center gap-1 sm:gap-1.5\">\n                  <Clock className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                  <span className=\"font-medium text-neutral-300\">{formatTimeline()}</span>\n                </div>\n              )}\n            </div>\n            <button\n              className=\"flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white\"\n            >\n              {isExpanded ? 'Less' : 'More'}\n              <ChevronDown\n                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n              />\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded Content */}\n      <AnimatePresence initial={false}>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.3 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"border-t border-neutral-800 bg-neutral-900/50\">\n              <div className=\"grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800\">\n                {/* Main Content */}\n                <div className=\"md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6\">\n                  {/* Improvements */}\n                  <div>\n                    <SectionHeader icon={Target} title=\"Improvements\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\n                        {recommendation.matchedFlaws.map((flaw, i) => (\n                          <ImprovementTag key={i} text={flaw} />\n                        ))}\n                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (\n                          <ImprovementTag key={i} text={ratio} />\n                        ))}\n                      </div>\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n                          <div className=\"text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase\">Effectiveness</div>\n                          <div className=\"h-1 w-1 rounded-full bg-neutral-600\" />\n                          <div className=\"font-medium text-white capitalize text-xs sm:text-sm\">{getEffectiveness()}</div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* How It Helps */}\n                  <div>\n                    <SectionHeader icon={Info} title=\"How It Helps\" />\n                    <div className=\"space-y-1.5 sm:space-y-2\">\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                          {recommendation.description}\n                        </p>\n                      </div>\n                      {recommendation.ratios_impacted.length > 0 && (\n                        <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                          <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}\n                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Logistics & Timeline */}\n                  {recommendation.timeline.full_results_weeks > 0 && (\n                    <div>\n                      <SectionHeader icon={Clock} title=\"Logistics & Timeline\" />\n                      <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Effect Starts\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white capitalize\">\n                            {recommendation.timeline.effect_start}\n                          </span>\n                        </div>\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Full Results\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white\">\n                            {formatTimeline()}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Considerations */}\n                  <div>\n                    <SectionHeader icon={AlertTriangle} title=\"Considerations\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      {/* Prerequisites */}\n                      {recommendation.warnings.length > 0 && (\n                        <div className=\"bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm\">\n                          <span className=\"font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">Prerequisites</span>\n                          <p className=\"text-blue-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.warnings[0]}\n                          </p>\n                        </div>\n                      )}\n\n                      {/* Risks & Side Effects */}\n                      {recommendation.risks_side_effects && (\n                        <div className=\"bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm\">\n                          <span className=\"font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">\n                            Risks & Side Effects\n                          </span>\n                          <p className=\"text-amber-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.risks_side_effects}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Notes & Warnings */}\n                  {recommendation.warnings.length > 1 && (\n                    <div className=\"text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic\">\n                      {recommendation.warnings.slice(1).join(' ')}\n                    </div>\n                  )}\n\n                  {/* Research Citations */}\n                  <div className=\"bg-cyan-500/10 p-3 sm:p-4 rounded-lg border border-cyan-500/30\">\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <BookOpen size={14} className=\"text-cyan-400\" />\n                      <span className=\"font-semibold text-cyan-400 text-xs sm:text-sm\">Research & Evidence</span>\n                      {ethnicity && ethnicity !== 'other' && (\n                        <span className=\"text-[9px] px-1.5 py-0.5 bg-cyan-500/20 rounded text-cyan-300 capitalize\">\n                          {ethnicity.replace('_', ' ')} focus\n                        </span>\n                      )}\n                    </div>\n                    {citations.length > 0 ? (\n                      <div className=\"space-y-2.5\">\n                        {citations.map((citation, idx) => (\n                          <div key={idx} className=\"text-[11px] sm:text-xs bg-neutral-900/50 p-2.5 rounded-lg border border-neutral-700/50\">\n                            <div className=\"flex items-start justify-between gap-2\">\n                              <div className=\"flex-1\">\n                                <div className=\"font-medium text-cyan-300 mb-0.5 line-clamp-2\">\n                                  {citation.title}\n                                </div>\n                                <div className=\"text-neutral-500 text-[10px] mb-1\">\n                                  {citation.authors} • {citation.journal} ({citation.year})\n                                </div>\n                                <div className=\"text-neutral-400 leading-relaxed\">\n                                  {citation.summary}\n                                </div>\n                              </div>\n                              {citation.doi && (\n                                <a\n                                  href={`https://doi.org/${citation.doi}`}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"flex-shrink-0 p-1 text-cyan-400 hover:text-cyan-300 transition-colors\"\n                                  title=\"View full paper\"\n                                >\n                                  <ExternalLink size={12} />\n                                </a>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-[11px] sm:text-xs text-cyan-300/70\">\n                        {recommendation.matchedFlaws.length > 0\n                          ? 'Based on facial analysis and established aesthetic research. More specific citations coming soon.'\n                          : 'No specific research citations available for this recommendation.'}\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* My Tracker Sidebar */}\n                <MyTracker\n                  tracker={tracker}\n                  onNotesChange={handleNotesChange}\n                  onAddChecklistItem={handleAddChecklistItem}\n                  onToggleChecklistItem={handleToggleChecklistItem}\n                  onRemoveChecklistItem={handleRemoveChecklistItem}\n                />\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\nexport default EnhancedRecommendationCard;\n","structuredPatch":[{"oldStart":188,"oldLines":7,"newStart":188,"newLines":7,"lines":["     journal: 'Journal of Applied Social Psychology',","     year: 2011,","     summary: 'Research on how grooming affects perceived competence and attractiveness.',","-    procedureRefs: ['FND-01', 'FND-06', 'FND-07'],","+    procedureRefs: ['FND-04', 'FND-05'],","     genderRelevance: 'both',","   },","   // Orthognathic Research"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"73ef76f3-ef63-46c2-8112-ac9dde6892b8","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SkPraLoruKjAP9kVWaCjWX","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to fix the `getRelevantCitations` function to add relevance-based sorting. The current function just filters and slices - it doesn't rank citations by how well they match.\n\nI need to:\n1. Add a relevance score to each citation\n2. Sort by relevance before taking top 3\n3. Consider: exact gender match > gender='both', exact ethnicity match > no ethnicity filter\n\nLet me update the function.","signature":"ErIECkYIChgCKkCJCY55SMjxA1V9kg9Z5JWDE7lJO2c2weeKrtcMnHdTkPS1EMO16hzHKZmAGiQUYwFANCCODiPLokqbL9fK/cUhEgxDZvi8V7eHon99OnwaDGOjyPsAhsZoCc36DCIwStD/Pkhji606el7nCQzjArCTp73FHhsJLq+8uyknY2nDMk4mNHsAN80xbi6fak+cKpkD2sguk2pUNk+zyD6WIEs2WqOMJ13pqMOhsfPBcqIksomrVM7DFD//dXUElnQOoeq5KH+vlcDFPwzf98CI5PqNnZNu4gFimajlxymAerGBj2iKkfSj5/fco76J2hfigDelqVGq2vTZqc9txQOf/KjKOugHgyHgSPuQdhSUkJddrBFwyFcM4kr4SvFQsPxjr7zBalma/j+w+24AhdHf5NI8FIuGDc7kjzs+bjTKHa7Ca22dfPlOw/va0lnIDrQNUFyfDhMnCX0lW+BsYRgvYS0kgWkc1zULyipyYBM+trKb0my7E02Tc0CpKkxnbt26raMeGA0U+nviWukiyHXmJuiDJBUE8Xfu4d5SQWzNPm6EtkKHPqP3p8d0UlD6nn15xqOQagzjZ2CCZRKr/3eP5hb5FD3mDt8lKcz/hBsTK75un6r6hqeCEsHExMNibc7ydqiBU/rq3qHJuxnnX5peoDxwtH03cahX5ryFQ6xGj/8ld4OAh89aFDw6YQvhsyGsiGofSlNsSg9u03c2cupTmRYjQvw+ZdnqWubfaBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1079,"cache_read_input_tokens":57545,"cache_creation":{"ephemeral_5m_input_tokens":1079,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWKzg5VZMMrg8Y8LJ8Bzw","type":"assistant","uuid":"33f9e487-dca7-448a-a580-0e2e1938f2cf","timestamp":"2025-12-21T14:32:23.668Z"}
{"parentUuid":"33f9e487-dca7-448a-a580-0e2e1938f2cf","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SkPraLoruKjAP9kVWaCjWX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Di8gKe5b2771DFpSKEn1ue","name":"TodoWrite","input":{"todos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"completed","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"in_progress","activeForm":"Adding relevance-based sorting to citations"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1079,"cache_read_input_tokens":57545,"cache_creation":{"ephemeral_5m_input_tokens":1079,"ephemeral_1h_input_tokens":0},"output_tokens":243,"service_tier":"standard"}},"requestId":"req_011CWKzg5VZMMrg8Y8LJ8Bzw","type":"assistant","uuid":"bc5a8059-1982-4ab6-b3bc-f8c6caaf5269","timestamp":"2025-12-21T14:32:24.500Z"}
{"parentUuid":"bc5a8059-1982-4ab6-b3bc-f8c6caaf5269","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Di8gKe5b2771DFpSKEn1ue","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"7bd7504d-e693-4321-8bb7-f6d8f055cac0","timestamp":"2025-12-21T14:32:24.519Z","toolUseResult":{"oldTodos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"in_progress","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"pending","activeForm":"Adding relevance-based sorting to citations"}],"newTodos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"completed","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"in_progress","activeForm":"Adding relevance-based sorting to citations"}]}}
{"parentUuid":"7bd7504d-e693-4321-8bb7-f6d8f055cac0","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_012zxxyth4Nn2q5L6r3edBLB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me replace the `getRelevantCitations` function with one that includes relevance-based sorting.","signature":"Eo4CCkYIChgCKkB3QtWrh8xxXeIcD+vRVBvqDNw70GaEQVcJbSAzMDnSZNCId+Z518+huFPVu97GOryiTYKyQC9TPCY82koA0j5nEgwRhYzryM00tT6iRs8aDKOJW4gi0TpFBBHilyIwsaJCUkTxPhMxV7bckmUUJIR8Fm8Mphsn9NJx/JjDKyVMx9pAw0+WNFd3MbM07RPjKnYkWIc1Lan4ECB4hI/4R54jjqoBY/lACCOqsch+jUjMNAbxSYd6DwVNngh7e8VmRF0aL24BfDo4Wa4YztdW45+S57mTvKA68qOXo3M8axL0hParYZCZQohrMz/6LfxbTEsrNjfvd/buOcAtbEtOTykYvKpmxr4BGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":288,"cache_read_input_tokens":58624,"cache_creation":{"ephemeral_5m_input_tokens":288,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWKzgeAajGG4fzHfbXuuw","type":"assistant","uuid":"130c3d37-c442-462e-b179-e00caea80c13","timestamp":"2025-12-21T14:32:29.835Z"}
{"parentUuid":"130c3d37-c442-462e-b179-e00caea80c13","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_012zxxyth4Nn2q5L6r3edBLB","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me fix the `getRelevantCitations` function to add proper relevance-based sorting."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":288,"cache_read_input_tokens":58624,"cache_creation":{"ephemeral_5m_input_tokens":288,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWKzgeAajGG4fzHfbXuuw","type":"assistant","uuid":"3ee5c649-bd31-4738-a145-e46034ae5b3a","timestamp":"2025-12-21T14:32:30.218Z"}
{"parentUuid":"3ee5c649-bd31-4738-a145-e46034ae5b3a","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_012zxxyth4Nn2q5L6r3edBLB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015ig6shbXb6Wh7iHJ7VLGBe","name":"Edit","input":{"file_path":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","old_string":"function getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  return RESEARCH_CITATIONS.filter(citation => {\n    // Must match the procedure\n    if (!citation.procedureRefs.includes(procedureRefId)) return false;\n\n    // Check gender relevance\n    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {\n      if (citation.genderRelevance !== gender) return false;\n    }\n\n    // Check ethnicity relevance\n    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {\n      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation\n      if (!citation.ethnicityRelevance.includes(ethnicity)) {\n        // Only exclude if the citation is ethnicity-specific\n        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  }).slice(0, 3); // Limit to 3 most relevant citations\n}","new_string":"function getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  // Calculate relevance score for sorting\n  function calculateRelevance(citation: ResearchCitation): number {\n    let score = 0;\n\n    // Base score: procedure is in the list\n    if (!citation.procedureRefs.includes(procedureRefId)) return -1;\n\n    // Procedure specificity: fewer refs = more specific to this procedure (+20 max)\n    score += Math.max(0, 20 - (citation.procedureRefs.length * 3));\n\n    // Gender relevance scoring\n    if (gender && citation.genderRelevance) {\n      if (citation.genderRelevance === gender) {\n        // Exact gender match - highest priority (+30)\n        score += 30;\n      } else if (citation.genderRelevance === 'both') {\n        // General/both - neutral (+10)\n        score += 10;\n      } else {\n        // Wrong gender - exclude\n        return -1;\n      }\n    } else {\n      // No gender specified or citation has no gender preference\n      score += 10;\n    }\n\n    // Ethnicity relevance scoring\n    if (ethnicity && ethnicity !== 'other' && citation.ethnicityRelevance) {\n      if (citation.ethnicityRelevance.includes(ethnicity)) {\n        // Exact ethnicity match - high priority (+25)\n        score += 25;\n        // Bonus for ethnicity-specific studies (fewer ethnicities = more focused)\n        score += Math.max(0, 15 - (citation.ethnicityRelevance.length * 2));\n      } else {\n        // Citation is ethnicity-specific but doesn't match user - lower priority\n        // Still include unless very specific (1-2 ethnicities)\n        if (citation.ethnicityRelevance.length <= 2) {\n          return -1; // Too specific for different ethnicity\n        }\n        score += 5; // General enough to still be useful\n      }\n    } else {\n      // No ethnicity filter or citation applies to all\n      score += 10;\n    }\n\n    // Recency bonus: newer studies slightly preferred\n    const yearBonus = Math.max(0, (citation.year - 2000) * 0.5);\n    score += yearBonus;\n\n    return score;\n  }\n\n  // Filter, score, sort, and take top 3\n  return RESEARCH_CITATIONS\n    .map(citation => ({ citation, relevance: calculateRelevance(citation) }))\n    .filter(item => item.relevance >= 0)\n    .sort((a, b) => b.relevance - a.relevance)\n    .slice(0, 3)\n    .map(item => item.citation);\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":288,"cache_read_input_tokens":58624,"cache_creation":{"ephemeral_5m_input_tokens":288,"ephemeral_1h_input_tokens":0},"output_tokens":1160,"service_tier":"standard"}},"requestId":"req_011CWKzgeAajGG4fzHfbXuuw","type":"assistant","uuid":"16797bd5-876b-4537-aea6-9b6997797d78","timestamp":"2025-12-21T14:32:44.664Z"}
{"parentUuid":"16797bd5-876b-4537-aea6-9b6997797d78","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015ig6shbXb6Wh7iHJ7VLGBe","type":"tool_result","content":"The file /Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   221→    genderRelevance: 'both',\n   222→  },\n   223→];\n   224→\n   225→function getRelevantCitations(\n   226→  procedureRefId: string,\n   227→  gender?: Gender,\n   228→  ethnicity?: Ethnicity\n   229→): ResearchCitation[] {\n   230→  // Calculate relevance score for sorting\n   231→  function calculateRelevance(citation: ResearchCitation): number {\n   232→    let score = 0;\n   233→\n   234→    // Base score: procedure is in the list\n   235→    if (!citation.procedureRefs.includes(procedureRefId)) return -1;\n   236→\n   237→    // Procedure specificity: fewer refs = more specific to this procedure (+20 max)\n   238→    score += Math.max(0, 20 - (citation.procedureRefs.length * 3));\n   239→\n   240→    // Gender relevance scoring\n   241→    if (gender && citation.genderRelevance) {\n   242→      if (citation.genderRelevance === gender) {\n   243→        // Exact gender match - highest priority (+30)\n   244→        score += 30;\n   245→      } else if (citation.genderRelevance === 'both') {\n   246→        // General/both - neutral (+10)\n   247→        score += 10;\n   248→      } else {\n   249→        // Wrong gender - exclude\n   250→        return -1;\n   251→      }\n   252→    } else {\n   253→      // No gender specified or citation has no gender preference\n   254→      score += 10;\n   255→    }\n   256→\n   257→    // Ethnicity relevance scoring\n   258→    if (ethnicity && ethnicity !== 'other' && citation.ethnicityRelevance) {\n   259→      if (citation.ethnicityRelevance.includes(ethnicity)) {\n   260→        // Exact ethnicity match - high priority (+25)\n   261→        score += 25;\n   262→        // Bonus for ethnicity-specific studies (fewer ethnicities = more focused)\n   263→        score += Math.max(0, 15 - (citation.ethnicityRelevance.length * 2));\n   264→      } else {\n   265→        // Citation is ethnicity-specific but doesn't match user - lower priority\n   266→        // Still include unless very specific (1-2 ethnicities)\n   267→        if (citation.ethnicityRelevance.length <= 2) {\n   268→          return -1; // Too specific for different ethnicity\n   269→        }\n   270→        score += 5; // General enough to still be useful\n   271→      }\n   272→    } else {\n   273→      // No ethnicity filter or citation applies to all\n   274→      score += 10;\n   275→    }\n   276→\n   277→    // Recency bonus: newer studies slightly preferred\n   278→    const yearBonus = Math.max(0, (citation.year - 2000) * 0.5);\n   279→    score += yearBonus;\n   280→\n   281→    return score;\n   282→  }\n   283→\n   284→  // Filter, score, sort, and take top 3\n   285→  return RESEARCH_CITATIONS\n   286→    .map(citation => ({ citation, relevance: calculateRelevance(citation) }))\n   287→    .filter(item => item.relevance >= 0)\n   288→    .sort((a, b) => b.relevance - a.relevance)\n   289→    .slice(0, 3)\n   290→    .map(item => item.citation);\n   291→}\n   292→\n   293→interface TrackerState {\n   294→  notes: string;\n   295→  checklist: Array<{ id: string; text: string; completed: boolean }>;"}]},"uuid":"9661fa24-5944-426d-b747-05cde55aac65","timestamp":"2025-12-21T14:32:44.684Z","toolUseResult":{"filePath":"/Users/imorgado/LOOKSMAXX/looksmaxx-app/src/components/results/cards/EnhancedRecommendationCard.tsx","oldString":"function getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  return RESEARCH_CITATIONS.filter(citation => {\n    // Must match the procedure\n    if (!citation.procedureRefs.includes(procedureRefId)) return false;\n\n    // Check gender relevance\n    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {\n      if (citation.genderRelevance !== gender) return false;\n    }\n\n    // Check ethnicity relevance\n    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {\n      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation\n      if (!citation.ethnicityRelevance.includes(ethnicity)) {\n        // Only exclude if the citation is ethnicity-specific\n        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  }).slice(0, 3); // Limit to 3 most relevant citations\n}","newString":"function getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  // Calculate relevance score for sorting\n  function calculateRelevance(citation: ResearchCitation): number {\n    let score = 0;\n\n    // Base score: procedure is in the list\n    if (!citation.procedureRefs.includes(procedureRefId)) return -1;\n\n    // Procedure specificity: fewer refs = more specific to this procedure (+20 max)\n    score += Math.max(0, 20 - (citation.procedureRefs.length * 3));\n\n    // Gender relevance scoring\n    if (gender && citation.genderRelevance) {\n      if (citation.genderRelevance === gender) {\n        // Exact gender match - highest priority (+30)\n        score += 30;\n      } else if (citation.genderRelevance === 'both') {\n        // General/both - neutral (+10)\n        score += 10;\n      } else {\n        // Wrong gender - exclude\n        return -1;\n      }\n    } else {\n      // No gender specified or citation has no gender preference\n      score += 10;\n    }\n\n    // Ethnicity relevance scoring\n    if (ethnicity && ethnicity !== 'other' && citation.ethnicityRelevance) {\n      if (citation.ethnicityRelevance.includes(ethnicity)) {\n        // Exact ethnicity match - high priority (+25)\n        score += 25;\n        // Bonus for ethnicity-specific studies (fewer ethnicities = more focused)\n        score += Math.max(0, 15 - (citation.ethnicityRelevance.length * 2));\n      } else {\n        // Citation is ethnicity-specific but doesn't match user - lower priority\n        // Still include unless very specific (1-2 ethnicities)\n        if (citation.ethnicityRelevance.length <= 2) {\n          return -1; // Too specific for different ethnicity\n        }\n        score += 5; // General enough to still be useful\n      }\n    } else {\n      // No ethnicity filter or citation applies to all\n      score += 10;\n    }\n\n    // Recency bonus: newer studies slightly preferred\n    const yearBonus = Math.max(0, (citation.year - 2000) * 0.5);\n    score += yearBonus;\n\n    return score;\n  }\n\n  // Filter, score, sort, and take top 3\n  return RESEARCH_CITATIONS\n    .map(citation => ({ citation, relevance: calculateRelevance(citation) }))\n    .filter(item => item.relevance >= 0)\n    .sort((a, b) => b.relevance - a.relevance)\n    .slice(0, 3)\n    .map(item => item.citation);\n}","originalFile":"'use client';\n\nimport { useState, useCallback, useMemo } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  ChevronDown,\n  Clock,\n  DollarSign,\n  AlertTriangle,\n  Target,\n  Info,\n  BookOpen,\n  CheckCircle,\n  Trash2,\n  Plus,\n  Sparkles,\n  ExternalLink,\n} from 'lucide-react';\nimport { Recommendation } from '@/types/results';\nimport { Gender, Ethnicity } from '@/lib/faceiq-scoring';\n\n// ============================================\n// TYPES\n// ============================================\n\ninterface EnhancedRecommendationCardProps {\n  recommendation: Recommendation;\n  isExpanded?: boolean;\n  onToggle?: () => void;\n  rank?: number;\n  onMarkComplete?: (id: string) => void;\n  onRemove?: (id: string) => void;\n  isCompleted?: boolean;\n  gender?: Gender;\n  ethnicity?: Ethnicity;\n}\n\n// ============================================\n// RESEARCH CITATIONS DATABASE\n// ============================================\n\ninterface ResearchCitation {\n  title: string;\n  authors: string;\n  journal: string;\n  year: number;\n  doi?: string;\n  summary: string;\n  procedureRefs: string[];  // Matches recommendation ref_id\n  genderRelevance?: 'male' | 'female' | 'both';\n  ethnicityRelevance?: Ethnicity[];\n}\n\nconst RESEARCH_CITATIONS: ResearchCitation[] = [\n  // Rhinoplasty Research\n  {\n    title: 'Ethnic Considerations in Rhinoplasty',\n    authors: 'Rohrich RJ, Bolden K',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2010,\n    doi: '10.1097/PRS.0b013e3181c6b2b7',\n    summary: 'Discusses the importance of preserving ethnic identity while achieving aesthetic goals in rhinoplasty across different ethnicities.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black', 'east_asian', 'south_asian', 'middle_eastern', 'hispanic'],\n  },\n  {\n    title: 'The Male Rhinoplasty',\n    authors: 'Foda HM',\n    journal: 'Facial Plastic Surgery',\n    year: 2008,\n    summary: 'Examines unique considerations for male rhinoplasty including maintaining masculine features and avoiding feminization.',\n    procedureRefs: ['SUR-02', 'MIN-04'],\n    genderRelevance: 'male',\n  },\n  // Jaw/Chin Research\n  {\n    title: 'Sliding Genioplasty: A Systematic Review',\n    authors: 'Park JH, Tae-Hoon K',\n    journal: 'Journal of Oral and Maxillofacial Surgery',\n    year: 2018,\n    summary: 'Comprehensive analysis of chin advancement outcomes and patient satisfaction rates across demographics.',\n    procedureRefs: ['SUR-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Gender Differences in Jaw Angle Aesthetics',\n    authors: 'Kim YH, Cho J',\n    journal: 'Aesthetic Plastic Surgery',\n    year: 2020,\n    summary: 'Research on ideal jaw angle parameters for males (90-110°) versus females (110-120°).',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Mandibular Angle Augmentation in Asian Patients',\n    authors: 'Lee YJ, Park KS',\n    journal: 'Asian Journal of Beauty and Cosmetology',\n    year: 2019,\n    summary: 'Study on jaw angle enhancement specific to East Asian facial structure and aesthetic preferences.',\n    procedureRefs: ['SUR-03', 'MIN-03'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Lip Research\n  {\n    title: 'Ideal Lip Proportions Across Ethnicities',\n    authors: 'Farkas LG, Katic MJ',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2003,\n    summary: 'Anthropometric study establishing ethnic-specific ideal lip ratios and proportions.',\n    procedureRefs: ['MIN-01', 'FND-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['white', 'black', 'east_asian', 'hispanic'],\n  },\n  {\n    title: 'Lip Enhancement in African American Patients',\n    authors: 'Mack WP',\n    journal: 'Facial Plastic Surgery Clinics',\n    year: 2014,\n    summary: 'Guidelines for maintaining ethnic characteristics while enhancing lip aesthetics.',\n    procedureRefs: ['MIN-01'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['black'],\n  },\n  // Eye/Canthal Research\n  {\n    title: 'Canthal Tilt and Facial Attractiveness',\n    authors: 'Rhee SC, et al.',\n    journal: 'Plastic and Reconstructive Surgery',\n    year: 2017,\n    summary: 'Demonstrates the importance of positive canthal tilt in perceived attractiveness across cultures.',\n    procedureRefs: ['SUR-05', 'MIN-04'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Asian Blepharoplasty and Canthopexy',\n    authors: 'Chen WP',\n    journal: 'Ophthalmic Plastic Surgery',\n    year: 2016,\n    summary: 'Specific techniques for Asian eyelid surgery that preserve ethnic identity while enhancing eye shape.',\n    procedureRefs: ['SUR-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['east_asian', 'south_asian'],\n  },\n  // Midface/Cheek Research\n  {\n    title: 'Cheekbone Enhancement for Facial Harmony',\n    authors: 'Mendelson B, Wong CH',\n    journal: 'Clinics in Plastic Surgery',\n    year: 2015,\n    summary: 'Analysis of malar augmentation effects on overall facial harmony and perceived attractiveness.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Midface Aesthetics in Middle Eastern Populations',\n    authors: 'Rohrich RJ, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2021,\n    summary: 'Ethnic considerations for midface enhancement in Middle Eastern patients.',\n    procedureRefs: ['SUR-06', 'MIN-05'],\n    genderRelevance: 'both',\n    ethnicityRelevance: ['middle_eastern'],\n  },\n  // Foundational/Non-Surgical Research\n  {\n    title: 'Mewing and Orthotropic Treatment',\n    authors: 'Mew J, Mew M',\n    journal: 'International Journal of Orthodontics',\n    year: 2014,\n    summary: 'Research on proper tongue posture and its effects on facial development and structure.',\n    procedureRefs: ['FND-02', 'FND-03'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Effects of Body Composition on Facial Aesthetics',\n    authors: 'Morrison CS, et al.',\n    journal: 'Aesthetic Surgery Journal',\n    year: 2017,\n    summary: 'Study on how body fat percentage affects facial definition and perceived attractiveness.',\n    procedureRefs: ['FND-04', 'FND-05'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Grooming and First Impressions',\n    authors: 'Phelan C, Etcoff N',\n    journal: 'Journal of Applied Social Psychology',\n    year: 2011,\n    summary: 'Research on how grooming affects perceived competence and attractiveness.',\n    procedureRefs: ['FND-04', 'FND-05'],\n    genderRelevance: 'both',\n  },\n  // Orthognathic Research\n  {\n    title: 'Bimaxillary Surgery Outcomes',\n    authors: 'Rustemeyer J, et al.',\n    journal: 'Journal of Cranio-Maxillofacial Surgery',\n    year: 2019,\n    summary: 'Long-term outcomes and patient satisfaction following double jaw surgery.',\n    procedureRefs: ['SUR-04'],\n    genderRelevance: 'both',\n  },\n  // General Attractiveness Research\n  {\n    title: 'Cross-Cultural Facial Attractiveness',\n    authors: 'Perrett DI, et al.',\n    journal: 'Nature',\n    year: 1998,\n    summary: 'Landmark study on universal vs. culture-specific aspects of facial attractiveness.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06'],\n    genderRelevance: 'both',\n  },\n  {\n    title: 'Golden Ratios in Facial Beauty',\n    authors: 'Marquardt SR',\n    journal: 'International Journal of Cosmetic Surgery',\n    year: 2002,\n    summary: 'Analysis of mathematical proportions and their relationship to perceived facial beauty.',\n    procedureRefs: ['SUR-01', 'SUR-02', 'SUR-03', 'SUR-04', 'SUR-05', 'SUR-06', 'MIN-01', 'MIN-02'],\n    genderRelevance: 'both',\n  },\n];\n\nfunction getRelevantCitations(\n  procedureRefId: string,\n  gender?: Gender,\n  ethnicity?: Ethnicity\n): ResearchCitation[] {\n  return RESEARCH_CITATIONS.filter(citation => {\n    // Must match the procedure\n    if (!citation.procedureRefs.includes(procedureRefId)) return false;\n\n    // Check gender relevance\n    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {\n      if (citation.genderRelevance !== gender) return false;\n    }\n\n    // Check ethnicity relevance\n    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {\n      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation\n      if (!citation.ethnicityRelevance.includes(ethnicity)) {\n        // Only exclude if the citation is ethnicity-specific\n        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {\n          return false;\n        }\n      }\n    }\n\n    return true;\n  }).slice(0, 3); // Limit to 3 most relevant citations\n}\n\ninterface TrackerState {\n  notes: string;\n  checklist: Array<{ id: string; text: string; completed: boolean }>;\n}\n\n// ============================================\n// PHASE BADGE (Dark Theme)\n// ============================================\n\nfunction PhaseBadge({ phase }: { phase: string }) {\n  const getPhaseConfig = () => {\n    switch (phase) {\n      case 'Foundational':\n        return {\n          bg: 'bg-emerald-500/20',\n          text: 'text-emerald-400',\n          border: 'border-emerald-500/30',\n        };\n      case 'Minimally Invasive':\n        return {\n          bg: 'bg-blue-500/20',\n          text: 'text-blue-400',\n          border: 'border-blue-500/30',\n        };\n      case 'Surgical':\n        return {\n          bg: 'bg-purple-500/20',\n          text: 'text-purple-400',\n          border: 'border-purple-500/30',\n        };\n      default:\n        return {\n          bg: 'bg-neutral-500/20',\n          text: 'text-neutral-400',\n          border: 'border-neutral-500/30',\n        };\n    }\n  };\n\n  const config = getPhaseConfig();\n\n  return (\n    <span\n      className={`text-[9px] sm:text-[10px] uppercase tracking-wide font-semibold px-1.5 sm:px-2 py-0.5 rounded-md border flex-shrink-0 ${config.bg} ${config.text} ${config.border}`}\n    >\n      {phase === 'Minimally Invasive' ? 'Non-Invasive' : phase}\n    </span>\n  );\n}\n\n// ============================================\n// IMPACT BADGE\n// ============================================\n\nfunction ImpactBadge({ impact, frontImpact, sideImpact }: { impact: number; frontImpact?: number; sideImpact?: number }) {\n  const formattedImpact = impact >= 0 ? `+${impact.toFixed(2)}` : impact.toFixed(2);\n\n  return (\n    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n      <span className=\"flex items-center gap-1 text-[9px] sm:text-[10px] font-semibold text-emerald-400 bg-emerald-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-emerald-500/30 flex-shrink-0\">\n        <Sparkles className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n        {formattedImpact}\n      </span>\n      {(frontImpact !== undefined || sideImpact !== undefined) && (\n        <span className=\"hidden sm:flex items-center gap-1.5 text-[9px] text-neutral-500 flex-shrink-0\">\n          <span className={`font-medium ${(frontImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            F {(frontImpact || 0) >= 0 ? '+' : ''}{(frontImpact || 0).toFixed(2)}\n          </span>\n          <span className=\"text-neutral-600\">|</span>\n          <span className={`font-medium ${(sideImpact || 0) > 0 ? 'text-emerald-400' : 'text-neutral-500'}`}>\n            S {(sideImpact || 0) >= 0 ? '+' : ''}{(sideImpact || 0).toFixed(2)}\n          </span>\n        </span>\n      )}\n    </div>\n  );\n}\n\n// ============================================\n// IMPROVEMENT TAG\n// ============================================\n\nfunction ImprovementTag({ text }: { text: string }) {\n  return (\n    <div className=\"inline-flex items-center gap-1 sm:gap-1.5 px-2 sm:px-2.5 py-0.5 sm:py-1 bg-neutral-800 border border-neutral-700 rounded-md text-[11px] sm:text-xs font-medium text-neutral-300 shadow-sm\">\n      <CheckCircle className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-400 flex-shrink-0\" />\n      <span className=\"truncate\">{text}</span>\n    </div>\n  );\n}\n\n// ============================================\n// SECTION HEADER\n// ============================================\n\nfunction SectionHeader({ icon: Icon, title }: { icon: React.ElementType; title: string }) {\n  return (\n    <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-2 sm:mb-3\">\n      <Icon className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n      {title}\n    </h4>\n  );\n}\n\n// ============================================\n// MY TRACKER SECTION\n// ============================================\n\nfunction MyTracker({\n  tracker,\n  onNotesChange,\n  onAddChecklistItem,\n  onToggleChecklistItem,\n  onRemoveChecklistItem\n}: {\n  tracker: TrackerState;\n  onNotesChange: (notes: string) => void;\n  onAddChecklistItem: () => void;\n  onToggleChecklistItem: (id: string) => void;\n  onRemoveChecklistItem: (id: string) => void;\n}) {\n  return (\n    <div className=\"md:col-span-5 lg:col-span-4 p-4 sm:p-6 bg-neutral-900/50 md:bg-neutral-800/30 h-full\">\n      <h4 className=\"flex items-center gap-1.5 sm:gap-2 text-[11px] sm:text-xs font-semibold text-white uppercase tracking-wide mb-3 sm:mb-4\">\n        <BookOpen className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-400\" />\n        My Tracker\n      </h4>\n      <div className=\"space-y-3 sm:space-y-4\">\n        {/* Personal Notes */}\n        <div className=\"space-y-1 sm:space-y-1.5\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400\">Personal Notes</label>\n          <textarea\n            value={tracker.notes}\n            onChange={(e) => onNotesChange(e.target.value)}\n            className=\"w-full text-xs sm:text-sm p-2.5 sm:p-3 border border-neutral-700 rounded-lg focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 bg-neutral-900 text-white min-h-[80px] sm:min-h-[100px] resize-none placeholder:text-neutral-600 shadow-sm transition-all\"\n            placeholder=\"Track progress, questions, dates...\"\n          />\n        </div>\n\n        {/* Checklist */}\n        <div className=\"space-y-1.5 sm:space-y-2 pt-1 sm:pt-2\">\n          <label className=\"text-[11px] sm:text-xs font-medium text-neutral-400 flex justify-between items-center\">\n            <span>Checklist</span>\n            <button\n              onClick={onAddChecklistItem}\n              className=\"text-cyan-400 hover:text-cyan-300 text-[9px] sm:text-[10px] font-bold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 bg-cyan-500/20 px-1.5 sm:px-2 py-0.5 rounded-md border border-cyan-500/30 hover:bg-cyan-500/30 transition-colors\"\n            >\n              <Plus className=\"w-2.5 h-2.5 sm:w-3 sm:h-3\" />\n              Add\n            </button>\n          </label>\n          <div className=\"space-y-1.5 sm:space-y-2\">\n            {tracker.checklist.length === 0 ? (\n              <div className=\"text-[11px] sm:text-xs text-neutral-500 text-center py-3 sm:py-4 border border-dashed border-neutral-700 rounded-lg bg-neutral-900/50\">\n                No tasks yet\n              </div>\n            ) : (\n              tracker.checklist.map((item) => (\n                <div\n                  key={item.id}\n                  className=\"flex items-center gap-2 p-2 bg-neutral-900 border border-neutral-700 rounded-lg\"\n                >\n                  <button\n                    onClick={() => onToggleChecklistItem(item.id)}\n                    className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 transition-colors ${\n                      item.completed\n                        ? 'bg-emerald-500 border-emerald-500'\n                        : 'border-neutral-600 hover:border-neutral-500'\n                    }`}\n                  >\n                    {item.completed && <CheckCircle className=\"w-3 h-3 text-black\" />}\n                  </button>\n                  <span className={`text-xs flex-1 ${item.completed ? 'text-neutral-500 line-through' : 'text-neutral-300'}`}>\n                    {item.text}\n                  </span>\n                  <button\n                    onClick={() => onRemoveChecklistItem(item.id)}\n                    className=\"text-neutral-600 hover:text-red-400 transition-colors\"\n                  >\n                    <Trash2 className=\"w-3 h-3\" />\n                  </button>\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================\n// MAIN ENHANCED RECOMMENDATION CARD\n// ============================================\n\nexport function EnhancedRecommendationCard({\n  recommendation,\n  isExpanded = false,\n  onToggle,\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  rank,\n  onMarkComplete,\n  onRemove,\n  isCompleted = false,\n  gender,\n  ethnicity,\n}: EnhancedRecommendationCardProps) {\n  // Tracker state (would be persisted in real app)\n  const [tracker, setTracker] = useState<TrackerState>({\n    notes: '',\n    checklist: [],\n  });\n\n  // Get relevant research citations based on procedure, gender, and ethnicity\n  const citations = useMemo(() => {\n    return getRelevantCitations(recommendation.ref_id, gender, ethnicity);\n  }, [recommendation.ref_id, gender, ethnicity]);\n\n  const handleNotesChange = useCallback((notes: string) => {\n    setTracker(prev => ({ ...prev, notes }));\n  }, []);\n\n  const handleAddChecklistItem = useCallback(() => {\n    const text = window.prompt('Enter task:');\n    if (text) {\n      setTracker(prev => ({\n        ...prev,\n        checklist: [...prev.checklist, { id: Date.now().toString(), text, completed: false }],\n      }));\n    }\n  }, []);\n\n  const handleToggleChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.map(item =>\n        item.id === id ? { ...item, completed: !item.completed } : item\n      ),\n    }));\n  }, []);\n\n  const handleRemoveChecklistItem = useCallback((id: string) => {\n    setTracker(prev => ({\n      ...prev,\n      checklist: prev.checklist.filter(item => item.id !== id),\n    }));\n  }, []);\n\n  // Format cost\n  const formatCost = () => {\n    const { min, max, type } = recommendation.cost;\n    const typeLabel = type === 'per_session' ? 'session' : type === 'per_month' ? '/mo' : '';\n    if (min === max) {\n      return `$${min.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n    }\n    return `$${min.toLocaleString()} - $${max.toLocaleString()}${typeLabel ? ` ${typeLabel}` : ''}`;\n  };\n\n  // Format timeline\n  const formatTimeline = () => {\n    const { full_results_weeks, full_results_weeks_max } = recommendation.timeline;\n    if (full_results_weeks_max) {\n      return `${full_results_weeks}-${full_results_weeks_max} weeks`;\n    }\n    if (full_results_weeks >= 52) {\n      const months = Math.round(full_results_weeks / 4);\n      return `${months} months`;\n    }\n    return `${full_results_weeks} weeks`;\n  };\n\n  // Get effectiveness level\n  const getEffectiveness = () => {\n    if (recommendation.impact >= 0.7) return 'high';\n    if (recommendation.impact >= 0.4) return 'moderate';\n    return 'low';\n  };\n\n  return (\n    <motion.div\n      layout\n      className={`bg-neutral-900/80 rounded-xl border group relative transition-all duration-150 ${\n        isExpanded\n          ? 'border-cyan-500/40 ring-1 ring-cyan-500/20'\n          : 'border-neutral-800 hover:border-neutral-700'\n      } ${isCompleted ? 'opacity-60' : ''}`}\n    >\n      {/* Header - Clickable */}\n      <div className=\"p-3.5 sm:p-5 cursor-pointer\" onClick={onToggle}>\n        <div className=\"space-y-3 sm:space-y-4\">\n          <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 sm:gap-4\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2\">\n                <h3 className=\"text-sm sm:text-base font-semibold transition-colors line-clamp-2 sm:truncate text-white\">\n                  {recommendation.name}\n                </h3>\n                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n                  <PhaseBadge phase={recommendation.phase} />\n                  <ImpactBadge impact={recommendation.impact} />\n                </div>\n              </div>\n              <p className=\"text-xs sm:text-sm text-neutral-400 leading-relaxed max-w-2xl line-clamp-2 sm:line-clamp-none\">\n                {recommendation.description}\n              </p>\n            </div>\n\n            {/* Action buttons */}\n            <div className=\"flex items-center gap-1.5 sm:ml-4 absolute right-3 top-3 sm:relative sm:right-auto sm:top-auto\">\n              {onMarkComplete && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onMarkComplete(recommendation.ref_id);\n                  }}\n                  className={`p-1.5 sm:p-1.5 rounded-md border transition-colors ${\n                    isCompleted\n                      ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'\n                      : 'bg-neutral-900 text-neutral-500 border-neutral-700 hover:border-neutral-500 hover:text-white'\n                  }`}\n                  title=\"Mark as complete\"\n                >\n                  <CheckCircle className=\"w-4 h-4\" />\n                </button>\n              )}\n              {onRemove && (\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    onRemove(recommendation.ref_id);\n                  }}\n                  className=\"p-1.5 sm:p-1.5 rounded-md border transition-all duration-200 border-neutral-700 bg-neutral-900 text-neutral-500 hover:border-red-500/50 hover:text-red-400 hover:bg-red-500/10\"\n                  title=\"Remove action\"\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </button>\n              )}\n            </div>\n          </div>\n\n          {/* Quick stats row */}\n          <div className=\"flex flex-wrap items-center justify-between gap-x-4 sm:gap-x-6 gap-y-2 text-[11px] sm:text-xs text-neutral-400\">\n            <div className=\"flex flex-wrap items-center gap-x-3 sm:gap-x-6 gap-y-1.5\">\n              <div className=\"flex items-center gap-1 sm:gap-1.5\" title=\"Estimated Cost\">\n                <DollarSign className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                <span className=\"font-medium text-neutral-300\">{formatCost()}</span>\n              </div>\n              {recommendation.timeline.full_results_weeks > 0 && (\n                <div className=\"flex items-center gap-1 sm:gap-1.5\">\n                  <Clock className=\"w-3 h-3 sm:w-3.5 sm:h-3.5 text-neutral-500\" />\n                  <span className=\"font-medium text-neutral-300\">{formatTimeline()}</span>\n                </div>\n              )}\n            </div>\n            <button\n              className=\"flex items-center gap-1 text-[11px] sm:text-xs font-medium transition-colors px-1.5 sm:px-2 py-1 rounded-md hover:bg-neutral-800 text-white\"\n            >\n              {isExpanded ? 'Less' : 'More'}\n              <ChevronDown\n                className={`w-3 h-3 sm:w-3.5 sm:h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n              />\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded Content */}\n      <AnimatePresence initial={false}>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.3 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"border-t border-neutral-800 bg-neutral-900/50\">\n              <div className=\"grid md:grid-cols-12 divide-y md:divide-y-0 md:divide-x divide-neutral-800\">\n                {/* Main Content */}\n                <div className=\"md:col-span-7 lg:col-span-8 p-4 sm:p-6 space-y-4 sm:space-y-6\">\n                  {/* Improvements */}\n                  <div>\n                    <SectionHeader icon={Target} title=\"Improvements\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      <div className=\"flex flex-wrap gap-1.5 sm:gap-2\">\n                        {recommendation.matchedFlaws.map((flaw, i) => (\n                          <ImprovementTag key={i} text={flaw} />\n                        ))}\n                        {recommendation.matchedFlaws.length === 0 && recommendation.matchedRatios.slice(0, 3).map((ratio, i) => (\n                          <ImprovementTag key={i} text={ratio} />\n                        ))}\n                      </div>\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n                          <div className=\"text-[10px] sm:text-xs font-semibold text-neutral-500 uppercase\">Effectiveness</div>\n                          <div className=\"h-1 w-1 rounded-full bg-neutral-600\" />\n                          <div className=\"font-medium text-white capitalize text-xs sm:text-sm\">{getEffectiveness()}</div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* How It Helps */}\n                  <div>\n                    <SectionHeader icon={Info} title=\"How It Helps\" />\n                    <div className=\"space-y-1.5 sm:space-y-2\">\n                      <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                        <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                          {recommendation.description}\n                        </p>\n                      </div>\n                      {recommendation.ratios_impacted.length > 0 && (\n                        <div className=\"bg-neutral-800/50 p-2.5 sm:p-3.5 rounded-lg border border-neutral-700 text-sm shadow-sm\">\n                          <p className=\"text-neutral-300 text-[11px] sm:text-xs leading-relaxed\">\n                            This treatment can {recommendation.ratios_impacted[0].direction === 'increase' ? 'increase' : 'improve'}{' '}\n                            {recommendation.ratios_impacted.slice(0, 3).map(r => r.ratioName).join(', ')}.\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Logistics & Timeline */}\n                  {recommendation.timeline.full_results_weeks > 0 && (\n                    <div>\n                      <SectionHeader icon={Clock} title=\"Logistics & Timeline\" />\n                      <div className=\"grid grid-cols-2 gap-2 sm:gap-3\">\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Effect Starts\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white capitalize\">\n                            {recommendation.timeline.effect_start}\n                          </span>\n                        </div>\n                        <div className=\"bg-neutral-800/50 p-2 sm:p-3 rounded-lg border border-neutral-700\">\n                          <span className=\"text-[9px] sm:text-[10px] font-semibold text-neutral-500 uppercase block mb-0.5 sm:mb-1\">\n                            Full Results\n                          </span>\n                          <span className=\"text-xs sm:text-sm font-medium text-white\">\n                            {formatTimeline()}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Considerations */}\n                  <div>\n                    <SectionHeader icon={AlertTriangle} title=\"Considerations\" />\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      {/* Prerequisites */}\n                      {recommendation.warnings.length > 0 && (\n                        <div className=\"bg-blue-500/10 p-2.5 sm:p-3.5 rounded-lg border border-blue-500/30 text-sm\">\n                          <span className=\"font-semibold text-blue-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">Prerequisites</span>\n                          <p className=\"text-blue-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.warnings[0]}\n                          </p>\n                        </div>\n                      )}\n\n                      {/* Risks & Side Effects */}\n                      {recommendation.risks_side_effects && (\n                        <div className=\"bg-amber-500/10 p-2.5 sm:p-3.5 rounded-lg border border-amber-500/30 text-sm\">\n                          <span className=\"font-semibold text-amber-400 block mb-0.5 sm:mb-1 text-xs sm:text-sm\">\n                            Risks & Side Effects\n                          </span>\n                          <p className=\"text-amber-300/80 text-[11px] sm:text-xs leading-relaxed\">\n                            {recommendation.risks_side_effects}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Notes & Warnings */}\n                  {recommendation.warnings.length > 1 && (\n                    <div className=\"text-[11px] sm:text-xs text-neutral-400 bg-neutral-800/50 p-2.5 sm:p-3 rounded-lg border border-neutral-700 italic\">\n                      {recommendation.warnings.slice(1).join(' ')}\n                    </div>\n                  )}\n\n                  {/* Research Citations */}\n                  <div className=\"bg-cyan-500/10 p-3 sm:p-4 rounded-lg border border-cyan-500/30\">\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <BookOpen size={14} className=\"text-cyan-400\" />\n                      <span className=\"font-semibold text-cyan-400 text-xs sm:text-sm\">Research & Evidence</span>\n                      {ethnicity && ethnicity !== 'other' && (\n                        <span className=\"text-[9px] px-1.5 py-0.5 bg-cyan-500/20 rounded text-cyan-300 capitalize\">\n                          {ethnicity.replace('_', ' ')} focus\n                        </span>\n                      )}\n                    </div>\n                    {citations.length > 0 ? (\n                      <div className=\"space-y-2.5\">\n                        {citations.map((citation, idx) => (\n                          <div key={idx} className=\"text-[11px] sm:text-xs bg-neutral-900/50 p-2.5 rounded-lg border border-neutral-700/50\">\n                            <div className=\"flex items-start justify-between gap-2\">\n                              <div className=\"flex-1\">\n                                <div className=\"font-medium text-cyan-300 mb-0.5 line-clamp-2\">\n                                  {citation.title}\n                                </div>\n                                <div className=\"text-neutral-500 text-[10px] mb-1\">\n                                  {citation.authors} • {citation.journal} ({citation.year})\n                                </div>\n                                <div className=\"text-neutral-400 leading-relaxed\">\n                                  {citation.summary}\n                                </div>\n                              </div>\n                              {citation.doi && (\n                                <a\n                                  href={`https://doi.org/${citation.doi}`}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"flex-shrink-0 p-1 text-cyan-400 hover:text-cyan-300 transition-colors\"\n                                  title=\"View full paper\"\n                                >\n                                  <ExternalLink size={12} />\n                                </a>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-[11px] sm:text-xs text-cyan-300/70\">\n                        {recommendation.matchedFlaws.length > 0\n                          ? 'Based on facial analysis and established aesthetic research. More specific citations coming soon.'\n                          : 'No specific research citations available for this recommendation.'}\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* My Tracker Sidebar */}\n                <MyTracker\n                  tracker={tracker}\n                  onNotesChange={handleNotesChange}\n                  onAddChecklistItem={handleAddChecklistItem}\n                  onToggleChecklistItem={handleToggleChecklistItem}\n                  onRemoveChecklistItem={handleRemoveChecklistItem}\n                />\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\nexport default EnhancedRecommendationCard;\n","structuredPatch":[{"oldStart":227,"oldLines":28,"newStart":227,"newLines":67,"lines":["   gender?: Gender,","   ethnicity?: Ethnicity"," ): ResearchCitation[] {","-  return RESEARCH_CITATIONS.filter(citation => {","-    // Must match the procedure","-    if (!citation.procedureRefs.includes(procedureRefId)) return false;","+  // Calculate relevance score for sorting","+  function calculateRelevance(citation: ResearchCitation): number {","+    let score = 0;"," ","-    // Check gender relevance","-    if (gender && citation.genderRelevance && citation.genderRelevance !== 'both') {","-      if (citation.genderRelevance !== gender) return false;","+    // Base score: procedure is in the list","+    if (!citation.procedureRefs.includes(procedureRefId)) return -1;","+","+    // Procedure specificity: fewer refs = more specific to this procedure (+20 max)","+    score += Math.max(0, 20 - (citation.procedureRefs.length * 3));","+","+    // Gender relevance scoring","+    if (gender && citation.genderRelevance) {","+      if (citation.genderRelevance === gender) {","+        // Exact gender match - highest priority (+30)","+        score += 30;","+      } else if (citation.genderRelevance === 'both') {","+        // General/both - neutral (+10)","+        score += 10;","+      } else {","+        // Wrong gender - exclude","+        return -1;","+      }","+    } else {","+      // No gender specified or citation has no gender preference","+      score += 10;","     }"," ","-    // Check ethnicity relevance","-    if (ethnicity && citation.ethnicityRelevance && ethnicity !== 'other') {","-      // Include if the ethnicity matches OR if no ethnicity filter is set on the citation","-      if (!citation.ethnicityRelevance.includes(ethnicity)) {","-        // Only exclude if the citation is ethnicity-specific","-        if (citation.ethnicityRelevance.length > 0 && citation.ethnicityRelevance.length < 6) {","-          return false;","+    // Ethnicity relevance scoring","+    if (ethnicity && ethnicity !== 'other' && citation.ethnicityRelevance) {","+      if (citation.ethnicityRelevance.includes(ethnicity)) {","+        // Exact ethnicity match - high priority (+25)","+        score += 25;","+        // Bonus for ethnicity-specific studies (fewer ethnicities = more focused)","+        score += Math.max(0, 15 - (citation.ethnicityRelevance.length * 2));","+      } else {","+        // Citation is ethnicity-specific but doesn't match user - lower priority","+        // Still include unless very specific (1-2 ethnicities)","+        if (citation.ethnicityRelevance.length <= 2) {","+          return -1; // Too specific for different ethnicity","         }","+        score += 5; // General enough to still be useful","       }","+    } else {","+      // No ethnicity filter or citation applies to all","+      score += 10;","     }"," ","-    return true;","-  }).slice(0, 3); // Limit to 3 most relevant citations","+    // Recency bonus: newer studies slightly preferred","+    const yearBonus = Math.max(0, (citation.year - 2000) * 0.5);","+    score += yearBonus;","+","+    return score;","+  }","+","+  // Filter, score, sort, and take top 3","+  return RESEARCH_CITATIONS","+    .map(citation => ({ citation, relevance: calculateRelevance(citation) }))","+    .filter(item => item.relevance >= 0)","+    .sort((a, b) => b.relevance - a.relevance)","+    .slice(0, 3)","+    .map(item => item.citation);"," }"," "," interface TrackerState {"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"9661fa24-5944-426d-b747-05cde55aac65","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_011EqEx4mXaAVzbcc5GXxh8m","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I've made all the fixes. Let me verify the changes compile correctly by running the lint/type check.","signature":"EowCCkYIChgCKkCTAdsV54m/kOKAD2aNO3c4Q2UoWTT7vqNmUkOeqgkvp57+fegDyGCZfVgCo7ofq8AWrORQu5a4XG7BQQ0SItKqEgymrXvaLdtc/bNZy1IaDIhog0iivMNk7qvUOyIwhPMnU5hgcNg1TE/bgFWsAKiKqC1IkQF7N808wlL7ftVj37FMKLv7cAuRK68IoEgNKnTHy60N82TGfcGz5ndCsPoL+1dvA/8oWo/5NN9tPAMWIU1e3AjhObBpyaANl5qfsGdGCPRylJhZcSm1HfyuNQQiziSp2EZUgGw2/awy+WH49gETVJvYQbWJwGwCsyyVXAVUXzK1JcYHW4RrFTFVLor5gOICUBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2217,"cache_read_input_tokens":58912,"cache_creation":{"ephemeral_5m_input_tokens":2217,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWKzi7MENdxcuHSnst6CZ","type":"assistant","uuid":"63603d4f-134c-4322-bab4-c10357037e1b","timestamp":"2025-12-21T14:32:49.941Z"}
{"parentUuid":"63603d4f-134c-4322-bab4-c10357037e1b","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_011EqEx4mXaAVzbcc5GXxh8m","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MUFCtkUaA6NfvZexLy5BNx","name":"TodoWrite","input":{"todos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"completed","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"completed","activeForm":"Adding relevance-based sorting to citations"},{"content":"Verify changes compile without errors","status":"in_progress","activeForm":"Verifying changes compile"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2217,"cache_read_input_tokens":58912,"cache_creation":{"ephemeral_5m_input_tokens":2217,"ephemeral_1h_input_tokens":0},"output_tokens":194,"service_tier":"standard"}},"requestId":"req_011CWKzi7MENdxcuHSnst6CZ","type":"assistant","uuid":"4422bb73-2498-44a2-8c14-355c6d853ea4","timestamp":"2025-12-21T14:32:51.130Z"}
{"parentUuid":"4422bb73-2498-44a2-8c14-355c6d853ea4","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MUFCtkUaA6NfvZexLy5BNx","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"e71c0b6c-8672-4306-993e-a048dee2ed21","timestamp":"2025-12-21T14:32:51.149Z","toolUseResult":{"oldTodos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"completed","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"in_progress","activeForm":"Adding relevance-based sorting to citations"}],"newTodos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"completed","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"completed","activeForm":"Adding relevance-based sorting to citations"},{"content":"Verify changes compile without errors","status":"in_progress","activeForm":"Verifying changes compile"}]}}
{"parentUuid":"e71c0b6c-8672-4306-993e-a048dee2ed21","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_018iRWvMqgN4x3UpwD6fHJLz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me run the lint and type check to verify the changes compile correctly.","signature":"EvMBCkYIChgCKkDnAyODBf9DLA+kB8bjWRdB6QmQr9XVDQJYJfVx06Me3hax/28r3l0XK32uAd7a/9F2Y4KCWzJq6Rqh+wQzrUfaEgwxfXczeCx+F30kKk4aDN/CLwYinZ4Wa+XmMSIwpxLk+mWuHDaEmhUiwHjTqyS8dPIv9eqkR/qCQu1H0TlQuUK9pjDKT8ROT+KlyjPvKlviGIvsi3qgw60NdCnK1wcA9DLBZX0w3XIbnEIZjm1UlxxpDxBJp01oUlZmoCL/qTMtsQ5szJsy8m4vdTJAbTT2jh/rP/g3iiA0AiBuL6tVwhq1tgn8rYLaKwr3GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":293,"cache_read_input_tokens":61129,"cache_creation":{"ephemeral_5m_input_tokens":293,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKziauRvD2UDxZiwK7nh","type":"assistant","uuid":"fb5e26b2-0805-42c7-a4dc-fee7b6a044d9","timestamp":"2025-12-21T14:32:57.971Z"}
{"parentUuid":"fb5e26b2-0805-42c7-a4dc-fee7b6a044d9","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_018iRWvMqgN4x3UpwD6fHJLz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016kr9zfMS5FxRPTtBKkJrHY","name":"Bash","input":{"command":"npx tsc --noEmit 2>&1 | head -30","description":"Run TypeScript type check"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":293,"cache_read_input_tokens":61129,"cache_creation":{"ephemeral_5m_input_tokens":293,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKziauRvD2UDxZiwK7nh","type":"assistant","uuid":"2ff79fb8-71f2-4c4f-84ee-182af57c093e","timestamp":"2025-12-21T14:32:59.105Z"}
{"parentUuid":"2ff79fb8-71f2-4c4f-84ee-182af57c093e","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016kr9zfMS5FxRPTtBKkJrHY","type":"tool_result","content":"","is_error":false}]},"uuid":"37e348d6-d8eb-4565-8142-b28ba77e27f6","timestamp":"2025-12-21T14:33:00.851Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"37e348d6-d8eb-4565-8142-b28ba77e27f6","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01P7rN4CxSnrNaeBJD6gqzga","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"TypeScript compiles without errors. Let me also run lint to be sure.","signature":"EuwBCkYIChgCKkACIHZlBjj0362SeP4d4hCZ1R8phj5V39KulINdqWKh03t0b8tYRywkpySgBdJ8PxcowFH72h/lo5X8MoFcGvycEgzkpOzgUuDY+KSeQdgaDJ8z+kr+cuPHh/qAUCIw751ziO6iLCHNqrsj8dCJXFmAkEFESPwpnKCNwWQjz0ZOre4ZSg3ni8rnpSLi9JYiKlRMGl1p7FfMpy1Dp8stK1NtDF/+Y9r1LenZcQ+r4Rhe/Q0EaHQ7OGouUQVvSRNAJW2yTKR+n8nc5uXZDR/EnRFKo86IZ93orBmNKh7TQuL7ZeXDiGEYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":145,"cache_read_input_tokens":61422,"cache_creation":{"ephemeral_5m_input_tokens":145,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzjJR23j3Nx2bK1ibKv","type":"assistant","uuid":"563ae361-916d-4f1c-b357-57198eacdcea","timestamp":"2025-12-21T14:33:06.395Z"}
{"parentUuid":"563ae361-916d-4f1c-b357-57198eacdcea","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01P7rN4CxSnrNaeBJD6gqzga","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UvmeyMavPcyDTpNxZwUjLD","name":"Bash","input":{"command":"npm run lint 2>&1 | head -20","description":"Run ESLint check"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":145,"cache_read_input_tokens":61422,"cache_creation":{"ephemeral_5m_input_tokens":145,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzjJR23j3Nx2bK1ibKv","type":"assistant","uuid":"e8a52ccd-ca12-44d5-8a2b-3abe34dd2745","timestamp":"2025-12-21T14:33:07.092Z"}
{"parentUuid":"e8a52ccd-ca12-44d5-8a2b-3abe34dd2745","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UvmeyMavPcyDTpNxZwUjLD","type":"tool_result","content":"> looksmaxx-app@0.1.0 lint\n> next lint\n\n\n./src/components/results/ResultsLayout.tsx\n74:13  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/modals/MetricDetailModal.tsx\n249:25  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/tabs/OverviewTab.tsx\n43:13  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/visualization/FaceOverlay.tsx\n250:11  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\ninfo  - Need to disable some ESLint rules? Learn more here: https://nextjs.org/docs/basic-features/eslint#disabling-rules","is_error":false}]},"uuid":"5cd0d360-43f4-43f0-9569-2c66caf35ded","timestamp":"2025-12-21T14:33:08.867Z","toolUseResult":{"stdout":"> looksmaxx-app@0.1.0 lint\n> next lint\n\n\n./src/components/results/ResultsLayout.tsx\n74:13  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/modals/MetricDetailModal.tsx\n249:25  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/tabs/OverviewTab.tsx\n43:13  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\n./src/components/results/visualization/FaceOverlay.tsx\n250:11  Warning: Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element  @next/next/no-img-element\n\ninfo  - Need to disable some ESLint rules? Learn more here: https://nextjs.org/docs/basic-features/eslint#disabling-rules","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"5cd0d360-43f4-43f0-9569-2c66caf35ded","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GuddzmwnYknW6BnVU9PoFm","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Only image warnings, no errors. The changes compile and pass lint. Let me update the todo list and summarize.","signature":"EpUCCkYIChgCKkCxGweVQ/r7kbwjvNsoPALSEDxEqX7WAoXWves1qwxAhnLbDyvdNvUb7Tc5MhBqCGBKy16ZwTep8l1CWuGodmsMEgyXgNAkOVGDFb3E2DkaDPbPXZ9hkfaFz++jtyIw7q9u1Np849YwGwpknsaTZTAdc4DDEK5zpHnL8Nsmfcb5U2ONP6RXJaLLMDRwXLfeKn38+TyvZS1lDDJnfqrQZe+2re2BhkYQ4RUpTZ6pRjfw7dPAh1L9faGngApOu/YtguMycV0GCfAO2DD++iXCrXIDdJInZkTcw3CsqKh2iWVs7edyyqrUfJHm8XeNtd4pLzMT0xdLFkjoQUpUTIMi/zWBpdU96WFWURwFDwuCPxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":572,"cache_read_input_tokens":61567,"cache_creation":{"ephemeral_5m_input_tokens":572,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzjtZqjdD3jeYuqiay4","type":"assistant","uuid":"40c177ef-bbef-4d4c-8e59-55cdf029b395","timestamp":"2025-12-21T14:33:14.465Z"}
{"parentUuid":"40c177ef-bbef-4d4c-8e59-55cdf029b395","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GuddzmwnYknW6BnVU9PoFm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01D77jLDCgV3T3Zecu3nAhWh","name":"TodoWrite","input":{"todos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"completed","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"completed","activeForm":"Adding relevance-based sorting to citations"},{"content":"Verify changes compile without errors","status":"completed","activeForm":"Verifying changes compile"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":572,"cache_read_input_tokens":61567,"cache_creation":{"ephemeral_5m_input_tokens":572,"ephemeral_1h_input_tokens":0},"output_tokens":194,"service_tier":"standard"}},"requestId":"req_011CWKzjtZqjdD3jeYuqiay4","type":"assistant","uuid":"35a1f67b-160a-4703-982c-fda0e1c81a1d","timestamp":"2025-12-21T14:33:15.245Z"}
{"parentUuid":"35a1f67b-160a-4703-982c-fda0e1c81a1d","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01D77jLDCgV3T3Zecu3nAhWh","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"58bd8cad-9d2d-4628-a8a6-cd4093964886","timestamp":"2025-12-21T14:33:15.266Z","toolUseResult":{"oldTodos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"completed","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"completed","activeForm":"Adding relevance-based sorting to citations"},{"content":"Verify changes compile without errors","status":"in_progress","activeForm":"Verifying changes compile"}],"newTodos":[{"content":"Fix invalid procedure references (MIN-07, FND-06, FND-07)","status":"completed","activeForm":"Fixing invalid procedure references"},{"content":"Add relevance-based sorting to getRelevantCitations()","status":"completed","activeForm":"Adding relevance-based sorting to citations"},{"content":"Verify changes compile without errors","status":"completed","activeForm":"Verifying changes compile"}]}}
{"parentUuid":"58bd8cad-9d2d-4628-a8a6-cd4093964886","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NEhfraF6Sx5KmpQmhsEoeU","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"All done. Let me provide a summary of what I fixed.","signature":"EtsBCkYIChgCKkD5qU2LPPyQYNtUtmicte9MUMChMVUKx43RPQCARucQbaJFz5FX/H9r+RCb66BZFZXhJEPg1P/HviTXSyFqr+XTEgyRBnE+xFSzxnhl0ooaDJ78zrbDsQKmnyi1GyIwSZ80QUOhQ1Y8u+QZf+hB1frvBvEkonb4JWxXWxpHjZNsPvDXz6QGYRUVRpzfb9HkKkOg99Y+NZrtma2sttQe16HVNqHm2avCDfXxrMWz9Q/75DqbDjw5Te15L4stDOQi/OvX/KfmGsxRd/hJ9ZaMBNSysa5WGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":243,"cache_read_input_tokens":62139,"cache_creation":{"ephemeral_5m_input_tokens":243,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzkMxNXVJhYHUMyyv65","type":"assistant","uuid":"4f4c7653-312c-44dc-9625-b9fd69426cf6","timestamp":"2025-12-21T14:33:18.766Z"}
{"parentUuid":"4f4c7653-312c-44dc-9625-b9fd69426cf6","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NEhfraF6Sx5KmpQmhsEoeU","type":"message","role":"assistant","content":[{"type":"text","text":"Both issues fixed. Here's what I changed:\n\n## 1. Fixed Invalid Procedure References\n\n**EnhancedRecommendationCard.tsx:133**\n- Changed `['SUR-05', 'MIN-07']` → `['SUR-05', 'MIN-04']`\n- MIN-07 didn't exist; MIN-04 (PDO Thread Lift) is the correct procedure for canthal tilt improvement\n\n**EnhancedRecommendationCard.tsx:191**\n- Changed `['FND-01', 'FND-06', 'FND-07']` → `['FND-04', 'FND-05']`\n- FND-06/FND-07 didn't exist; FND-04 (Skincare) and FND-05 (Eyebrow Grooming) are relevant for the \"Grooming and First Impressions\" study\n\n## 2. Added Relevance-Based Sorting to `getRelevantCitations()`\n\nThe new scoring system prioritizes citations by:\n\n| Factor | Points |\n|--------|--------|\n| **Exact gender match** (e.g., male study for male user) | +30 |\n| **Gender = 'both'** | +10 |\n| **Exact ethnicity match** | +25 + bonus for specificity |\n| **Procedure specificity** (fewer refs = more focused) | up to +20 |\n| **Recency** (newer studies) | +0.5 per year after 2000 |\n\nCitations that don't match the user's gender or are too ethnicity-specific for a different ethnicity are excluded entirely.\n\nTypeScript and ESLint pass (only pre-existing `<img>` warnings remain)."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":243,"cache_read_input_tokens":62139,"cache_creation":{"ephemeral_5m_input_tokens":243,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWKzkMxNXVJhYHUMyyv65","type":"assistant","uuid":"184e56e2-0f19-440e-904f-eae62a208bee","timestamp":"2025-12-21T14:33:28.167Z"}
{"type":"file-history-snapshot","messageId":"49da46b0-c6a6-48c7-8e53-0bf06120d58d","snapshot":{"messageId":"49da46b0-c6a6-48c7-8e53-0bf06120d58d","trackedFileBackups":{"src/components/results/cards/EnhancedRecommendationCard.tsx":{"backupFileName":"eeaa0feb60ed4d0a@v2","version":2,"backupTime":"2025-12-21T15:10:13.219Z"}},"timestamp":"2025-12-21T15:10:13.218Z"},"isSnapshotUpdate":false}
{"parentUuid":"184e56e2-0f19-440e-904f-eae62a208bee","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":"Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to."},"isMeta":true,"uuid":"f604217f-8223-49f9-980d-ccc8cdf0dcfe","timestamp":"2025-12-21T15:10:13.210Z"}
{"parentUuid":"f604217f-8223-49f9-980d-ccc8cdf0dcfe","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":"<command-name>/model</command-name>\n            <command-message>model</command-message>\n            <command-args></command-args>"},"uuid":"49da46b0-c6a6-48c7-8e53-0bf06120d58d","timestamp":"2025-12-21T15:10:13.207Z"}
{"parentUuid":"49da46b0-c6a6-48c7-8e53-0bf06120d58d","isSidechain":false,"userType":"external","cwd":"/Users/imorgado/LOOKSMAXX/looksmaxx-app","sessionId":"4db1b482-6771-4935-b84f-b8db1b1cb551","version":"2.0.70","gitBranch":"main","slug":"glittery-toasting-charm","type":"user","message":{"role":"user","content":"<local-command-stdout>Set model to \u001b[1msonnet (claude-sonnet-4-5-20250929)\u001b[22m</local-command-stdout>"},"uuid":"63b68d07-6599-4073-872c-00e55a2dc630","timestamp":"2025-12-21T15:10:13.207Z"}
