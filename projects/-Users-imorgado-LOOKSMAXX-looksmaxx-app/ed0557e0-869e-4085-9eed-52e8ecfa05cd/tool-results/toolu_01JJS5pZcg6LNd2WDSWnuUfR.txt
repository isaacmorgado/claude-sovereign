     1→"""
     2→User database model
     3→"""
     4→
     5→import uuid
     6→from datetime import datetime
     7→from sqlalchemy import Column, String, DateTime, Enum, Boolean, Integer, Float
     8→from sqlalchemy.dialects.postgresql import UUID
     9→from sqlalchemy.orm import relationship
    10→import enum
    11→
    12→from app.database import Base
    13→
    14→
    15→class PlanType(str, enum.Enum):
    16→    # Database enum has UPPERCASE values
    17→    FREE = "FREE"
    18→    BASIC = "BASIC"
    19→    PRO = "PRO"
    20→
    21→
    22→class UserRole(str, enum.Enum):
    23→    # Database enum has lowercase values
    24→    USER = "user"
    25→    MODERATOR = "moderator"
    26→    ADMIN = "admin"
    27→
    28→
    29→class User(Base):
    30→    __tablename__ = "users"
    31→
    32→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    33→    email = Column(String, unique=True, nullable=False, index=True)
    34→    password_hash = Column(String, nullable=False)
    35→    name = Column(String, nullable=True)
    36→    username = Column(String(30), unique=True, nullable=False, index=True)
    37→    terms_accepted_at = Column(DateTime, nullable=True)
    38→    # Use values_callable to ensure enum VALUES are used (lowercase) instead of NAMES (uppercase)
    39→    plan = Column(Enum(PlanType, values_callable=lambda x: [e.value for e in x]), default=PlanType.FREE)
    40→    stripe_customer_id = Column(String, nullable=True)
    41→    stripe_subscription_id = Column(String, nullable=True)
    42→
    43→    # User role for moderation - use values_callable for enum values
    44→    role = Column(Enum(UserRole, values_callable=lambda x: [e.value for e in x]), default=UserRole.USER)
    45→
    46→    # Ban status - banned users cannot access forum features
    47→    is_banned = Column(Boolean, default=False, nullable=False)
    48→
    49→    # Referral tracking
    50→    referral_code = Column(String(50), nullable=True, index=True)  # Code used at signup
    51→    referred_by = Column(String(100), nullable=True, index=True)  # Stripe promo code ID
    52→
    53→    # Password reset
    54→    password_reset_token = Column(String(255), nullable=True, index=True)
    55→    password_reset_expires = Column(DateTime, nullable=True)
    56→
    57→    # Email verification
    58→    email_verified = Column(Boolean, default=False)
    59→    email_verification_token = Column(String(255), nullable=True, index=True)
    60→    email_verification_expires = Column(DateTime, nullable=True)
    61→
    62→    # PSL System - Height & Weight
    63→    height_cm = Column(Integer, nullable=True)  # User height in centimeters for PSL calculation
    64→    weight_kg = Column(Float, nullable=True)  # User weight in kilograms for FFMI calculation
    65→
    66→    # Forum quotas - tracked monthly
    67→    forum_posts_this_month = Column(Integer, default=0, nullable=False)
    68→    forum_comments_this_month = Column(Integer, default=0, nullable=False)
    69→    quota_reset_date = Column(DateTime, nullable=True)  # First of next month when quotas reset
    70→
    71→    created_at = Column(DateTime, default=datetime.utcnow)
    72→    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    73→
    74→    # Relationships
    75→    analyses = relationship("Analysis", back_populates="user", cascade="all, delete-orphan")
    76→    payments = relationship("Payment", back_populates="user", cascade="all, delete-orphan")
    77→
    78→    def __repr__(self):
    79→        return f"<User {self.email}>"
    80→
    81→
    82→class ReferralCode(Base):
    83→    """Influencer referral codes linked to Stripe promotion codes"""
    84→    __tablename__ = "referral_codes"
    85→
    86→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    87→    code = Column(String(50), unique=True, nullable=False, index=True)
    88→    influencer_name = Column(String(100), nullable=False)
    89→    stripe_promotion_code_id = Column(String(100), nullable=True)
    90→    stripe_coupon_id = Column(String(100), nullable=True)
    91→    discount_percent = Column(Integer, default=10)
    92→    is_active = Column(Boolean, default=True)
    93→    total_uses = Column(Integer, default=0)
    94→    created_at = Column(DateTime, default=datetime.utcnow)
    95→    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    96→
    97→    def __repr__(self):
    98→        return f"<ReferralCode {self.code}>"
    99→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
