     1→"""
     2→LOOKSMAXX API - Unified backend for facial analysis
     3→"""
     4→import sys
     5→print("[STARTUP] Loading main.py...", flush=True)
     6→
     7→from contextlib import asynccontextmanager
     8→from fastapi import FastAPI
     9→from fastapi.middleware.cors import CORSMiddleware
    10→from slowapi import _rate_limit_exceeded_handler
    11→from slowapi.errors import RateLimitExceeded
    12→
    13→print("[STARTUP] Imports done, loading config...", flush=True)
    14→
    15→from app.config import get_settings
    16→print("[STARTUP] Config loaded, loading database...", flush=True)
    17→
    18→from app.database import engine, Base
    19→print("[STARTUP] Database loaded, loading services...", flush=True)
    20→
    21→from app.services.detection import detection_service
    22→from app.routers import auth_router, detection_router, analyses_router, payments_router, leaderboard_router, referrals_router, forum_router, psl_router, archetype_router, physique_router, supplements_router, users_router, admin_router
    23→from app.core.rate_limit import limiter
    24→
    25→print("[STARTUP] All imports complete!", flush=True)
    26→
    27→settings = get_settings()
    28→print(f"[STARTUP] Settings: frontend_url={settings.frontend_url}", flush=True)
    29→
    30→
    31→@asynccontextmanager
    32→async def lifespan(app: FastAPI):
    33→    """Startup and shutdown events"""
    34→    # Startup
    35→    print("[API] Starting up...", flush=True)
    36→
    37→    try:
    38→        # Create database tables
    39→        async with engine.begin() as conn:
    40→            await conn.run_sync(Base.metadata.create_all)
    41→        print("[API] Database tables created", flush=True)
    42→    except Exception as e:
    43→        print(f"[API] Database error (non-fatal): {e}", flush=True)
    44→
    45→    # Note: InsightFace model is lazy-loaded on first detection request
    46→    # This reduces startup memory usage and prevents OOM on Railway
    47→    print("[API] Detection service ready (lazy-load enabled)", flush=True)
    48→
    49→    yield
    50→
    51→    # Shutdown
    52→    print("[API] Shutting down...", flush=True)
    53→    await engine.dispose()
    54→
    55→
    56→app = FastAPI(
    57→    title="LOOKSMAXX API",
    58→    description="Facial analysis and metrics API",
    59→    version="1.0.0",
    60→    lifespan=lifespan,
    61→)
    62→
    63→# Add rate limiter state and exception handler
    64→app.state.limiter = limiter
    65→app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)
    66→
    67→# CORS middleware
    68→app.add_middleware(
    69→    CORSMiddleware,
    70→    allow_origins=[
    71→        settings.frontend_url,
    72→        "http://localhost:3000",
    73→        "http://localhost:3001",
    74→        "https://frontend-production-7ea5.up.railway.app",  # Added explicit allow for production frontend
    75→    ],
    76→    allow_credentials=True,
    77→    allow_methods=["*"],
    78→    allow_headers=["*"],
    79→)
    80→
    81→# Include routers
    82→app.include_router(auth_router)
    83→app.include_router(detection_router)
    84→app.include_router(analyses_router)
    85→app.include_router(payments_router)
    86→app.include_router(leaderboard_router)
    87→app.include_router(referrals_router)
    88→app.include_router(forum_router)
    89→app.include_router(psl_router)
    90→app.include_router(archetype_router)
    91→app.include_router(physique_router)
    92→app.include_router(supplements_router)
    93→app.include_router(users_router)
    94→app.include_router(admin_router)
    95→
    96→
    97→@app.get("/")
    98→async def root():
    99→    """Root endpoint - API info"""
   100→    return {
   101→        "name": "LOOKSMAXX API",
   102→        "version": "1.0.0",
   103→        "status": "running",
   104→        "docs": "/docs",
   105→    }
   106→
   107→
   108→@app.get("/health")
   109→async def health():
   110→    """Health check endpoint"""
   111→    return {
   112→        "status": "healthy",
   113→        "detection_ready": detection_service._face_analyzer is not None,
   114→    }
   115→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
