     1→-- Migration 015: Add forum activity fields to users table
     2→-- These fields are computed/cached for display on user profiles
     3→
     4→-- Add forum activity count fields
     5→ALTER TABLE users ADD COLUMN IF NOT EXISTS forum_posts_count INTEGER DEFAULT 0;
     6→ALTER TABLE users ADD COLUMN IF NOT EXISTS forum_comments_count INTEGER DEFAULT 0;
     7→ALTER TABLE users ADD COLUMN IF NOT EXISTS forum_karma INTEGER DEFAULT 0;
     8→
     9→-- Create index for efficient karma-based queries (leaderboard, top contributors)
    10→CREATE INDEX IF NOT EXISTS idx_users_forum_karma ON users (forum_karma DESC) WHERE is_banned = FALSE;
    11→
    12→-- Comment explaining the fields
    13→COMMENT ON COLUMN users.forum_posts_count IS 'Cached count of non-deleted forum posts by this user';
    14→COMMENT ON COLUMN users.forum_comments_count IS 'Cached count of non-deleted forum comments by this user';
    15→COMMENT ON COLUMN users.forum_karma IS 'Total karma points: sum of all votes received on posts and comments';
    16→
    17→-- Optional: Backfill existing data (run this manually after migration)
    18→-- UPDATE users u SET
    19→--   forum_posts_count = (SELECT COUNT(*) FROM forum_posts p WHERE p.author_id = u.id AND p.is_deleted = FALSE),
    20→--   forum_comments_count = (SELECT COUNT(*) FROM forum_comments c WHERE c.author_id = u.id AND c.is_deleted = FALSE),
    21→--   forum_karma = (
    22→--     SELECT COALESCE(SUM(vote_count), 0)
    23→--     FROM (
    24→--       SELECT vote_count FROM forum_posts WHERE author_id = u.id AND is_deleted = FALSE
    25→--       UNION ALL
    26→--       SELECT vote_count FROM forum_comments WHERE author_id = u.id AND is_deleted = FALSE
    27→--     ) votes
    28→--   );
    29→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
