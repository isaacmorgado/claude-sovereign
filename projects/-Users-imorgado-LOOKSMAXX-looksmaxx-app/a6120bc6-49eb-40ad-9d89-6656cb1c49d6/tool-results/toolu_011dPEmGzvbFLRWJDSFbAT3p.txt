     1→'use client';
     2→
     3→import { motion, AnimatePresence } from 'framer-motion';
     4→import { X, ChevronLeft, ChevronRight, AlertTriangle, Info } from 'lucide-react';
     5→import { FaceIQScoreResult } from '@/lib/faceiq-scoring';
     6→import { generateAIDescription, getSeverityFromScore } from '@/lib/aiDescriptions';
     7→import { getScoreColor } from '@/types/results';
     8→import { GradientRangeBar } from '../visualization/GradientRangeBar';
     9→import { useMemo } from 'react';
    10→
    11→// ============================================
    12→// TYPES
    13→// ============================================
    14→
    15→interface MetricDetailModalProps {
    16→  isOpen: boolean;
    17→  onClose: () => void;
    18→  ratio: FaceIQScoreResult | null;
    19→  onPrevious?: () => void;
    20→  onNext?: () => void;
    21→  hasPrevious?: boolean;
    22→  hasNext?: boolean;
    23→  facePhoto?: string;
    24→}
    25→
    26→// ============================================
    27→// STAT CARD
    28→// ============================================
    29→
    30→interface StatCardProps {
    31→  label: string;
    32→  value: string;
    33→  subtext?: string;
    34→  variant?: 'default' | 'ideal' | 'score';
    35→  scoreColor?: string;
    36→}
    37→
    38→function StatCard({ label, value, subtext, variant = 'default', scoreColor }: StatCardProps) {
    39→  const variants = {
    40→    default: 'bg-neutral-800/80 border-neutral-700',
    41→    ideal: 'bg-cyan-500/10 border-cyan-500/30',
    42→    score: 'bg-blue-500/10 border-blue-500/30',
    43→  };
    44→
    45→  const labelColors = {
    46→    default: 'text-neutral-500',
    47→    ideal: 'text-cyan-400',
    48→    score: 'text-neutral-500',
    49→  };
    50→
    51→  const valueColors = {
    52→    default: 'text-white',
    53→    ideal: 'text-cyan-400',
    54→    score: scoreColor || 'text-white',
    55→  };
    56→
    57→  return (
    58→    <div className={`rounded-xl border p-4 ${variants[variant]}`}>
    59→      <div className={`text-[10px] font-medium uppercase tracking-wider mb-1 ${labelColors[variant]}`}>
    60→        {label}
    61→      </div>
    62→      <div className={`text-xl font-semibold ${valueColors[variant]}`} style={variant === 'score' && scoreColor ? { color: scoreColor } : {}}>
    63→        {value}
    64→      </div>
    65→      {subtext && (
    66→        <div className="text-[10px] mt-1 text-neutral-500">{subtext}</div>
    67→      )}
    68→    </div>
    69→  );
    70→}
    71→
    72→// ============================================
    73→// MAIN MODAL COMPONENT
    74→// ============================================
    75→
    76→export function MetricDetailModal({
    77→  isOpen,
    78→  onClose,
    79→  ratio,
    80→  onPrevious,
    81→  onNext,
    82→  hasPrevious = false,
    83→  hasNext = false,
    84→  facePhoto,
    85→}: MetricDetailModalProps) {
    86→  // Generate AI description from ratio data
    87→  const flawDetail = useMemo(() => {
    88→    if (!ratio) return null;
    89→
    90→    return generateAIDescription(
    91→      ratio.metricId.toLowerCase().replace(/\\s+/g, ''),
    92→      ratio.name,
    93→      ratio.value,
    94→      ratio.idealMin,
    95→      ratio.idealMax,
    96→      ratio.score,
    97→      ratio.unit,
    98→      ratio.category
    99→    );
   100→  }, [ratio]);
   101→
   102→  if (!ratio || !flawDetail) return null;
   103→
   104→  const scoreColor = getScoreColor(ratio.score);
   105→  const isWithinIdeal = ratio.value >= ratio.idealMin && ratio.value <= ratio.idealMax;
   106→  const severity = getSeverityFromScore(ratio.score);
   107→
   108→  // Format values with units
   109→  const formatUnit = (v: number) => {
   110→    const formatted = v.toFixed(ratio.unit === 'percent' ? 1 : 2);
   111→    const suffix = ratio.unit === 'percent' ? ' %' : ratio.unit === 'degrees' ? '°' : ratio.unit === 'ratio' ? ' x' : ratio.unit === 'mm' ? ' mm' : '';
   112→    return `${formatted}${suffix}`;
   113→  };
   114→
   115→  // Calculate range for visualization
   116→  const idealRange = ratio.idealMax - ratio.idealMin;
   117→  const rangeMin = ratio.idealMin - idealRange * 1.5;
   118→  const rangeMax = ratio.idealMax + idealRange * 1.5;
   119→
   120→  return (
   121→    <AnimatePresence>
   122→      {isOpen && (
   123→        <>
   124→          {/* Backdrop */}
   125→          <motion.div
   126→            initial={{ opacity: 0 }}
   127→            animate={{ opacity: 1 }}
   128→            exit={{ opacity: 0 }}
   129→            onClick={onClose}
   130→            className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50"
   131→          />
   132→
   133→          {/* Navigation Arrows - Desktop */}
   134→          {hasPrevious && onPrevious && (
   135→            <motion.button
   136→              initial={{ opacity: 0, x: -10 }}
   137→              animate={{ opacity: 1, x: 0 }}
   138→              exit={{ opacity: 0, x: -10 }}
   139→              onClick={onPrevious}
   140→              className="hidden lg:flex fixed left-4 xl:left-8 top-1/2 -translate-y-1/2 z-[60] w-12 h-12 rounded-full bg-neutral-800 border border-neutral-600 shadow-xl hover:bg-neutral-700 hover:border-neutral-500 transition-all items-center justify-center group"
   141→              aria-label="Previous measurement"
   142→            >
   143→              <ChevronLeft className="w-6 h-6 text-neutral-300 group-hover:text-white" />
   144→            </motion.button>
   145→          )}
   146→
   147→          {hasNext && onNext && (
   148→            <motion.button
   149→              initial={{ opacity: 0, x: 10 }}
   150→              animate={{ opacity: 1, x: 0 }}
   151→              exit={{ opacity: 0, x: 10 }}
   152→              onClick={onNext}
   153→              className="hidden lg:flex fixed right-4 xl:right-8 top-1/2 -translate-y-1/2 z-[60] w-12 h-12 rounded-full bg-neutral-800 border border-neutral-600 shadow-xl hover:bg-neutral-700 hover:border-neutral-500 transition-all items-center justify-center group"
   154→              aria-label="Next measurement"
   155→            >
   156→              <ChevronRight className="w-6 h-6 text-neutral-300 group-hover:text-white" />
   157→            </motion.button>
   158→          )}
   159→
   160→          {/* Modal */}
   161→          <motion.div
   162→            initial={{ opacity: 0, scale: 0.95, y: 20 }}
   163→            animate={{ opacity: 1, scale: 1, y: 0 }}
   164→            exit={{ opacity: 0, scale: 0.95, y: 20 }}
   165→            transition={{ type: 'spring', damping: 25, stiffness: 300 }}
   166→            className="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-5xl max-h-[90vh] overflow-hidden bg-neutral-900 border border-neutral-700 rounded-2xl shadow-2xl z-50"
   167→          >
   168→            {/* Header */}
   169→            <div className="sticky top-0 bg-neutral-900/95 backdrop-blur-sm border-b border-neutral-800 px-4 py-4 md:px-6 z-10">
   170→              <div className="flex items-center justify-between">
   171→                <div className="flex items-center gap-3 flex-1 min-w-0">
   172→                  {/* Mobile nav */}
   173→                  {hasPrevious && onPrevious && (
   174→                    <button
   175→                      onClick={onPrevious}
   176→                      className="lg:hidden flex-shrink-0 p-1.5 rounded-lg hover:bg-neutral-800 transition-colors text-neutral-400"
   177→                      aria-label="Previous measurement"
   178→                    >
   179→                      <ChevronLeft className="w-5 h-5" />
   180→                    </button>
   181→                  )}
   182→
   183→                  <h2 className="text-lg md:text-xl font-semibold text-white truncate">
   184→                    {ratio.name}
   185→                  </h2>
   186→
   187→                  {hasNext && onNext && (
   188→                    <button
   189→                      onClick={onNext}
   190→                      className="lg:hidden flex-shrink-0 p-1.5 rounded-lg hover:bg-neutral-800 transition-colors text-neutral-400"
   191→                      aria-label="Next measurement"
   192→                    >
   193→                      <ChevronRight className="w-5 h-5" />
   194→                    </button>
   195→                  )}
   196→                </div>
   197→
   198→                <button
   199→                  onClick={onClose}
   200→                  className="flex-shrink-0 ml-4 p-2 rounded-lg hover:bg-neutral-800 transition-colors text-neutral-400 hover:text-white"
   201→                >
   202→                  <X className="w-5 h-5" />
   203→                </button>
   204→              </div>
   205→            </div>
   206→
   207→            {/* Content */}
   208→            <div className="p-4 md:p-6 space-y-4 overflow-y-auto max-h-[calc(90vh-72px)]">
   209→              {/* Stats Grid */}
   210→              <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
   211→                <StatCard
   212→                  label="Your Value"
   213→                  value={formatUnit(ratio.value)}
   214→                  subtext={isWithinIdeal ? 'Within ideal' : 'Outside ideal'}
   215→                  variant="default"
   216→                />
   217→                <StatCard
   218→                  label="Ideal Range"
   219→                  value={`${formatUnit(ratio.idealMin)} - ${formatUnit(ratio.idealMax)}`}
   220→                  subtext="Target range"
   221→                  variant="ideal"
   222→                />
   223→                <StatCard
   224→                  label="Score"
   225→                  value={`${ratio.score.toFixed(2)}/10`}
   226→                  subtext="Normalized score (1-10)"
   227→                  variant="score"
   228→                  scoreColor={scoreColor}
   229→                />
   230→              </div>
   231→
   232→              {/* Gradient Range Bar */}
   233→              <GradientRangeBar
   234→                value={ratio.value}
   235→                idealMin={ratio.idealMin}
   236→                idealMax={ratio.idealMax}
   237→                rangeMin={rangeMin}
   238→                rangeMax={rangeMax}
   239→                unit={ratio.unit}
   240→              />
   241→
   242→              {/* Two Column Layout */}
   243→              <div className="grid lg:grid-cols-2 gap-4">
   244→                {/* Face Image (if available) */}
   245→                {facePhoto && (
   246→                  <div>
   247→                    <div className="relative rounded-xl overflow-hidden border border-neutral-700 bg-neutral-800">
   248→                      <div className="relative w-full" style={{ aspectRatio: '1/1' }}>
   249→                        <img
   250→                          src={facePhoto}
   251→                          alt="Face"
   252→                          className="w-full h-full object-contain"
   253→                        />
   254→                      </div>
   255→                    </div>
   256→                  </div>
   257→                )}
   258→
   259→                {/* Info Sections */}
   260→                <div className={`space-y-4 ${!facePhoto ? 'lg:col-span-2' : ''}`}>
   261→                  {/* May Indicate Flaws - Only show if score is below 7 */}
   262→                  {ratio.score < 7 && (
   263→                    <div className="rounded-xl bg-amber-500/10 border border-amber-500/30 p-4">
   264→                      <div className="flex items-center gap-2 mb-3">
   265→                        <AlertTriangle size={14} className="text-amber-400" />
   266→                        <span className="text-[10px] font-medium text-amber-400 uppercase tracking-wider">
   267→                          May Indicate Flaws
   268→                        </span>
   269→                      </div>
   270→                      <div className="space-y-3">
   271→                        <div className="pb-3 border-b border-amber-500/20 last:border-0 last:pb-0">
   272→                          <div className="text-sm font-semibold text-white mb-1">
   273→                            {flawDetail.flawName}
   274→                          </div>
   275→                          <div className="text-xs text-neutral-300 leading-relaxed">
   276→                            {flawDetail.reasoning}
   277→                          </div>
   278→                        </div>
   279→                      </div>
   280→                    </div>
   281→                  )}
   282→
   283→                  {/* About This Ratio */}
   284→                  <div className="rounded-xl bg-neutral-800/50 border border-neutral-700 p-4">
   285→                    <div className="flex items-center gap-2 mb-3">
   286→                      <Info size={14} className="text-neutral-400" />
   287→                      <span className="text-[10px] font-medium text-neutral-400 uppercase tracking-wider">
   288→                        About This Ratio
   289→                      </span>
   290→                    </div>
   291→                    <div className="text-sm text-neutral-300 leading-relaxed">
   292→                      {getAboutDescription(ratio.name, ratio.category)}
   293→                    </div>
   294→                  </div>
   295→
   296→                  {/* Category Badge */}
   297→                  <div className="flex items-center gap-2">
   298→                    <span className="px-3 py-1.5 rounded-lg bg-neutral-800 border border-neutral-700 text-xs font-medium text-neutral-300">
   299→                      {ratio.category}
   300→                    </span>
   301→                    <span
   302→                      className="px-3 py-1.5 rounded-lg text-xs font-medium"
   303→                      style={{
   304→                        backgroundColor: `${scoreColor}20`,
   305→                        color: scoreColor,
   306→                        border: `1px solid ${scoreColor}40`,
   307→                      }}
   308→                    >
   309→                      {severity.replace('_', ' ')}
   310→                    </span>
   311→                  </div>
   312→                </div>
   313→              </div>
   314→            </div>
   315→          </motion.div>
   316→        </>
   317→      )}
   318→    </AnimatePresence>
   319→  );
   320→}
   321→
   322→// ============================================
   323→// ABOUT DESCRIPTIONS
   324→// ============================================
   325→
   326→function getAboutDescription(name: string, category: string): string {
   327→  const descriptions: Record<string, string> = {
   328→    'Face Width to Height Ratio': 'Facial Width-to-Height Ratio evaluates midface compactness by comparing its width to height, influenced by brow position, philtrum length, and lip fullness. Balanced proportions suit most faces; higher ratios (shorter midfaces) are preferred for males, while ethnic and structural variations in width affect overall harmony.',
   329→    'Lower Third': 'Facial thirds assess the vertical height of facial thirds relative to total facial height, favoring a balanced proportion with a slightly taller Lower Third in males. Disproportionate thirds, such as an overly short or tall Lower Third, may indicate disharmony or occlusal issues.',
   330→    'Middle Third': 'The middle third spans from the brow line to the base of the nose. A balanced middle third contributes to overall facial harmony and affects the perceived size of the nose and eyes.',
   331→    'Upper Third': 'The upper third spans from the hairline to the brow line. Its proportion affects forehead prominence and hairline positioning.',
   332→    'Lateral Canthal Tilt': 'Canthal tilt measures the angle of the eye from inner to outer corner. A positive tilt (outer corner higher) is generally considered more attractive and youthful.',
   333→    'Gonial Angle': 'The gonial angle measures the angle at the jaw corner. A well-defined angle contributes to jaw prominence and facial structure.',
   334→    'Bigonial Width': 'Bigonial width measures the distance between the jaw angles. It contributes to the perception of jaw strength and facial width.',
   335→    'Eye Aspect Ratio': 'Eye aspect ratio compares eye height to width. Almond-shaped eyes with balanced proportions are often considered ideal.',
   336→    'Nasal Index': 'The nasal index compares nose width to height. Balanced proportions contribute to facial harmony and ethnic variations are normal.',
   337→    'Chin Philtrum Ratio': 'This ratio compares chin height to philtrum length. Proper balance contributes to lower face harmony.',
   338→    'Submental Cervical Angle': 'This angle measures the definition between chin and neck. A well-defined angle creates a clean jawline profile.',
   339→  };
   340→
   341→  return descriptions[name] || `This measurement evaluates your ${category.toLowerCase()} proportions and contributes to overall facial harmony. Ideal ranges are based on established aesthetic standards.`;
   342→}
   343→
   344→export default MetricDetailModal;
   345→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
