     1→'use client';
     2→
     3→import React, { createContext, useContext, useState, useMemo, useCallback, ReactNode } from 'react';
     4→import { LandmarkPoint } from '@/lib/landmarks';
     5→import {
     6→  analyzeFrontProfile,
     7→  analyzeSideProfile,
     8→  analyzeHarmony,
     9→  HarmonyAnalysis,
    10→  FaceIQScoreResult,
    11→  FACEIQ_METRICS,
    12→  Ethnicity,
    13→  Gender,
    14→} from '@/lib/faceiq-scoring';
    15→import {
    16→  Ratio,
    17→  Strength,
    18→  Flaw,
    19→  Recommendation,
    20→  ResultsTab,
    21→  FullHarmonyAnalysis,
    22→} from '@/types/results';
    23→
    24→// ============================================
    25→// CONTEXT TYPES
    26→// ============================================
    27→
    28→interface ResultsContextType {
    29→  // Raw data
    30→  frontLandmarks: LandmarkPoint[];
    31→  sideLandmarks: LandmarkPoint[];
    32→  gender: Gender;
    33→  ethnicity: Ethnicity;
    34→  frontPhoto: string;
    35→  sidePhoto: string | null;
    36→
    37→  // Computed results
    38→  harmonyAnalysis: FullHarmonyAnalysis | null;
    39→  frontRatios: Ratio[];
    40→  sideRatios: Ratio[];
    41→  strengths: Strength[];
    42→  flaws: Flaw[];
    43→  recommendations: Recommendation[];
    44→
    45→  // Scores
    46→  overallScore: number;
    47→  frontScore: number;
    48→  sideScore: number;
    49→
    50→  // UI state
    51→  activeTab: ResultsTab;
    52→  setActiveTab: (tab: ResultsTab) => void;
    53→  expandedMeasurementId: string | null;
    54→  setExpandedMeasurementId: (id: string | null) => void;
    55→  selectedVisualizationMetric: string | null;
    56→  setSelectedVisualizationMetric: (id: string | null) => void;
    57→  categoryFilter: string | null;
    58→  setCategoryFilter: (category: string | null) => void;
    59→  showLandmarkOverlay: boolean;
    60→  setShowLandmarkOverlay: (show: boolean) => void;
    61→
    62→  // Actions
    63→  setResultsData: (data: ResultsInputData) => void;
    64→}
    65→
    66→interface ResultsInputData {
    67→  frontLandmarks: LandmarkPoint[];
    68→  sideLandmarks: LandmarkPoint[];
    69→  frontPhoto: string;
    70→  sidePhoto?: string;
    71→  gender: Gender;
    72→  ethnicity?: Ethnicity;
    73→}
    74→
    75→// ============================================
    76→// HELPER FUNCTIONS
    77→// ============================================
    78→
    79→function convertUnitToRatioUnit(unit: string): 'x' | 'mm' | '%' | '°' {
    80→  switch (unit) {
    81→    case 'ratio': return 'x';
    82→    case 'percent': return '%';
    83→    case 'degrees': return '°';
    84→    case 'mm': return 'mm';
    85→    default: return 'x';
    86→  }
    87→}
    88→
    89→function transformToRatio(result: FaceIQScoreResult, landmarks: LandmarkPoint[]): Ratio {
    90→  const metricConfig = FACEIQ_METRICS[result.metricId];
    91→
    92→  // Generate illustration based on metric
    93→  const illustration = generateIllustration(result.metricId, landmarks);
    94→
    95→  // Get flaw/strength mappings
    96→  const { mayIndicateFlaws, mayIndicateStrengths } = getFlawStrengthMappings(result);
    97→
    98→  return {
    99→    id: result.metricId,
   100→    name: result.name,
   101→    value: result.value,
   102→    score: result.score,
   103→    standardizedScore: result.standardizedScore,
   104→    unit: convertUnitToRatioUnit(result.unit),
   105→    idealMin: result.idealMin,
   106→    idealMax: result.idealMax,
   107→    rangeMin: metricConfig?.rangeMin || result.idealMin - 0.5,
   108→    rangeMax: metricConfig?.rangeMax || result.idealMax + 0.5,
   109→    description: metricConfig?.description || '',
   110→    category: result.category,
   111→    qualityLevel: result.qualityTier,
   112→    severity: result.severity,
   113→    illustration,
   114→    mayIndicateFlaws,
   115→    mayIndicateStrengths,
   116→    usedLandmarks: getUsedLandmarks(result.metricId),
   117→    scoringCurveConfig: metricConfig ? {
   118→      decayRate: metricConfig.decayRate,
   119→      maxScore: metricConfig.maxScore,
   120→    } : undefined,
   121→  };
   122→}
   123→
   124→// Enhanced illustration configuration type
   125→interface IllustrationConfig {
   126→  points: string[];
   127→  lines: Array<{
   128→    from: string;
   129→    to: string;
   130→    label?: string;
   131→    color?: string;
   132→    labelPosition?: 'start' | 'middle' | 'end';  // Matches IllustrationLine type
   133→  }>;
   134→}
   135→
   136→// Comprehensive illustration configurations for all metrics
   137→const ILLUSTRATION_CONFIGS: Record<string, IllustrationConfig> = {
   138→  // ==========================================
   139→  // FACE SHAPE / PROPORTIONS
   140→  // ==========================================
   141→  faceWidthToHeight: {
   142→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
   143→    lines: [
   144→      { from: 'left_zygion', to: 'right_zygion', label: 'Width', color: '#67e8f9', labelPosition: 'middle' },
   145→      { from: 'trichion', to: 'menton', label: 'Height', color: '#a78bfa', labelPosition: 'end' },
   146→    ],
   147→  },
   148→  totalFacialWidthToHeight: {
   149→    points: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
   150→    lines: [
   151→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },
   152→      { from: 'trichion', to: 'menton', label: 'Total Height', color: '#a78bfa' },
   153→    ],
   154→  },
   155→  lowerThirdProportion: {
   156→    points: ['subnasale', 'menton', 'trichion'],
   157→    lines: [
   158→      { from: 'subnasale', to: 'menton', label: 'Lower Third', color: '#f97316', labelPosition: 'end' },
   159→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
   160→    ],
   161→  },
   162→  middleThirdProportion: {
   163→    points: ['nasal_base', 'subnasale', 'trichion', 'menton'],
   164→    lines: [
   165→      { from: 'nasal_base', to: 'subnasale', label: 'Middle Third', color: '#22c55e', labelPosition: 'end' },
   166→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
   167→    ],
   168→  },
   169→  upperThirdProportion: {
   170→    points: ['trichion', 'nasal_base', 'menton'],
   171→    lines: [
   172→      { from: 'trichion', to: 'nasal_base', label: 'Upper Third', color: '#fbbf24', labelPosition: 'end' },
   173→      { from: 'trichion', to: 'menton', label: 'Full Height', color: '#67e8f9', labelPosition: 'start' },
   174→    ],
   175→  },
   176→  bitemporalWidth: {
   177→    points: ['left_temporal', 'right_temporal', 'left_zygion', 'right_zygion'],
   178→    lines: [
   179→      { from: 'left_temporal', to: 'right_temporal', label: 'Temple', color: '#fbbf24' },
   180→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek', color: '#67e8f9' },
   181→    ],
   182→  },
   183→  cheekboneHeight: {
   184→    points: ['left_zygion', 'right_zygion', 'left_canthus_lateralis', 'right_canthus_lateralis', 'menton'],
   185→    lines: [
   186→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheekbone', color: '#ec4899' },
   187→      { from: 'left_canthus_lateralis', to: 'left_zygion', color: '#67e8f9' },
   188→    ],
   189→  },
   190→  midfaceRatio: {
   191→    points: ['left_zygion', 'right_zygion', 'left_canthus_medialis', 'right_canthus_medialis', 'subnasale'],
   192→    lines: [
   193→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Midface Width', color: '#67e8f9' },
   194→      { from: 'left_canthus_medialis', to: 'subnasale', label: 'Midface Height', color: '#a78bfa' },
   195→    ],
   196→  },
   197→
   198→  // ==========================================
   199→  // JAW MEASUREMENTS
   200→  // ==========================================
   201→  jawSlope: {
   202→    points: ['left_gonion_inferior', 'left_mentum_lateralis', 'menton', 'right_mentum_lateralis', 'right_gonion_inferior'],
   203→    lines: [
   204→      { from: 'left_gonion_inferior', to: 'left_mentum_lateralis', label: 'Jaw Slope', color: '#f97316' },
   205→      { from: 'right_gonion_inferior', to: 'right_mentum_lateralis', color: '#f97316' },
   206→    ],
   207→  },
   208→  jawFrontalAngle: {
   209→    points: ['left_gonion_inferior', 'menton', 'right_gonion_inferior'],
   210→    lines: [
   211→      { from: 'left_gonion_inferior', to: 'menton', label: 'Jaw Angle', color: '#f97316' },
   212→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },
   213→    ],
   214→  },
   215→  bigonialWidth: {
   216→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],
   217→    lines: [
   218→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw Width', color: '#f97316' },
   219→      { from: 'left_zygion', to: 'right_zygion', label: 'Cheek Width', color: '#67e8f9' },
   220→    ],
   221→  },
   222→  jawWidthRatio: {
   223→    points: ['left_gonion_inferior', 'right_gonion_inferior', 'left_zygion', 'right_zygion'],
   224→    lines: [
   225→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },
   226→      { from: 'left_zygion', to: 'right_zygion', label: 'Face', color: '#67e8f9' },
   227→    ],
   228→  },
   229→
   230→  // ==========================================
   231→  // EYE MEASUREMENTS
   232→  // ==========================================
   233→  lateralCanthalTilt: {
   234→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'right_canthus_medialis', 'right_canthus_lateralis'],
   235→    lines: [
   236→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Tilt', color: '#06b6d4', labelPosition: 'end' },
   237→      { from: 'right_canthus_medialis', to: 'right_canthus_lateralis', color: '#06b6d4' },
   238→    ],
   239→  },
   240→  eyeAspectRatio: {
   241→    points: ['left_canthus_medialis', 'left_canthus_lateralis', 'left_palpebra_superior', 'left_palpebra_inferior'],
   242→    lines: [
   243→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Width', color: '#06b6d4' },
   244→      { from: 'left_palpebra_superior', to: 'left_palpebra_inferior', label: 'Height', color: '#a78bfa' },
   245→    ],
   246→  },
   247→  eyeSeparationRatio: {
   248→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_zygion', 'right_zygion'],
   249→    lines: [
   250→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },
   251→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
   252→    ],
   253→  },
   254→  interpupillaryRatio: {
   255→    points: ['left_pupila', 'right_pupila', 'left_zygion', 'right_zygion'],
   256→    lines: [
   257→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },
   258→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
   259→    ],
   260→  },
   261→  interpupillaryMouthWidthRatio: {
   262→    points: ['left_pupila', 'right_pupila', 'left_cheilion', 'right_cheilion'],
   263→    lines: [
   264→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4' },
   265→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
   266→    ],
   267→  },
   268→  oneEyeApartTest: {
   269→    points: ['left_canthus_medialis', 'right_canthus_medialis', 'left_canthus_lateralis'],
   270→    lines: [
   271→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Between Eyes', color: '#06b6d4' },
   272→      { from: 'left_canthus_medialis', to: 'left_canthus_lateralis', label: 'Eye Width', color: '#a78bfa' },
   273→    ],
   274→  },
   275→
   276→  // ==========================================
   277→  // EYEBROW MEASUREMENTS
   278→  // ==========================================
   279→  browLengthRatio: {
   280→    points: ['left_supercilium_medialis', 'left_supercilium_lateralis', 'left_zygion', 'right_zygion'],
   281→    lines: [
   282→      { from: 'left_supercilium_medialis', to: 'left_supercilium_lateralis', label: 'Brow', color: '#84cc16' },
   283→      { from: 'left_zygion', to: 'right_zygion', label: 'Face Width', color: '#67e8f9' },
   284→    ],
   285→  },
   286→  eyebrowTilt: {
   287→    points: ['left_supercilium_medialis', 'left_supercilium_apex', 'left_supercilium_lateralis'],
   288→    lines: [
   289→      { from: 'left_supercilium_medialis', to: 'left_supercilium_apex', label: 'Tilt', color: '#84cc16' },
   290→      { from: 'left_supercilium_apex', to: 'left_supercilium_lateralis', color: '#84cc16' },
   291→    ],
   292→  },
   293→  eyebrowLowSetedness: {
   294→    points: ['left_supercilium_medialis', 'left_palpebra_superior', 'left_canthus_medialis'],
   295→    lines: [
   296→      { from: 'left_supercilium_medialis', to: 'left_palpebra_superior', label: 'Brow-Eye Gap', color: '#84cc16' },
   297→    ],
   298→  },
   299→
   300→  // ==========================================
   301→  // NOSE MEASUREMENTS (FRONT)
   302→  // ==========================================
   303→  nasalIndex: {
   304→    points: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],
   305→    lines: [
   306→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Width', color: '#fbbf24' },
   307→      { from: 'nasal_base', to: 'subnasale', label: 'Height', color: '#a78bfa' },
   308→    ],
   309→  },
   310→  intercanthalNasalRatio: {
   311→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_canthus_medialis', 'right_canthus_medialis'],
   312→    lines: [
   313→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose Width', color: '#fbbf24' },
   314→      { from: 'left_canthus_medialis', to: 'right_canthus_medialis', label: 'Intercanthal', color: '#06b6d4' },
   315→    ],
   316→  },
   317→  noseBridgeWidth: {
   318→    points: ['left_dorsum_nasi', 'right_dorsum_nasi', 'left_ala_nasi', 'right_ala_nasi'],
   319→    lines: [
   320→      { from: 'left_dorsum_nasi', to: 'right_dorsum_nasi', label: 'Bridge', color: '#fbbf24' },
   321→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Base', color: '#f97316' },
   322→    ],
   323→  },
   324→  noseTipPosition: {
   325→    points: ['subnasale', 'left_ala_nasi', 'right_ala_nasi'],
   326→    lines: [
   327→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Tip Position', color: '#fbbf24' },
   328→    ],
   329→  },
   330→
   331→  // ==========================================
   332→  // MOUTH/LIP MEASUREMENTS
   333→  // ==========================================
   334→  mouthNoseWidthRatio: {
   335→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],
   336→    lines: [
   337→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
   338→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },
   339→    ],
   340→  },
   341→  lowerUpperLipRatio: {
   342→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],
   343→    lines: [
   344→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },
   345→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },
   346→    ],
   347→  },
   348→  chinPhiltrumRatio: {
   349→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],
   350→    lines: [
   351→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },
   352→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },
   353→    ],
   354→  },
   355→  mouthWidth: {
   356→    points: ['left_cheilion', 'right_cheilion'],
   357→    lines: [{ from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' }],
   358→  },
   359→
   360→  // ==========================================
   361→  // CHIN MEASUREMENTS
   362→  // ==========================================
   363→  chinHeight: {
   364→    points: ['labrale_inferius', 'menton'],
   365→    lines: [{ from: 'labrale_inferius', to: 'menton', label: 'Chin Height', color: '#ef4444' }],
   366→  },
   367→
   368→  // ==========================================
   369→  // NECK MEASUREMENTS
   370→  // ==========================================
   371→  neckWidthRatio: {
   372→    points: ['left_cervical_lateralis', 'right_cervical_lateralis', 'left_gonion_inferior', 'right_gonion_inferior'],
   373→    lines: [
   374→      { from: 'left_cervical_lateralis', to: 'right_cervical_lateralis', label: 'Neck', color: '#14b8a6' },
   375→      { from: 'left_gonion_inferior', to: 'right_gonion_inferior', label: 'Jaw', color: '#f97316' },
   376→    ],
   377→  },
   378→
   379→  // ==========================================
   380→  // SIDE PROFILE MEASUREMENTS
   381→  // ==========================================
   382→  gonialAngle: {
   383→    points: ['tragus', 'gonionBottom', 'menton'],
   384→    lines: [
   385→      { from: 'tragus', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },
   386→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },
   387→    ],
   388→  },
   389→  nasofrontalAngle: {
   390→    points: ['glabella', 'nasion', 'pronasale'],
   391→    lines: [
   392→      { from: 'glabella', to: 'nasion', label: 'Forehead', color: '#84cc16' },
   393→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },
   394→    ],
   395→  },
   396→  nasofacialAngle: {
   397→    points: ['nasion', 'pronasale', 'pogonion'],
   398→    lines: [
   399→      { from: 'nasion', to: 'pronasale', color: '#fbbf24' },
   400→      { from: 'pronasale', to: 'pogonion', color: '#67e8f9' },
   401→    ],
   402→  },
   403→  nasomentaAngle: {
   404→    points: ['nasion', 'pronasale', 'pogonion'],
   405→    lines: [
   406→      { from: 'nasion', to: 'pronasale', label: 'Nose', color: '#fbbf24' },
   407→      { from: 'pronasale', to: 'pogonion', label: 'To Chin', color: '#ef4444' },
   408→    ],
   409→  },
   410→  submentalCervicalAngle: {
   411→    points: ['menton', 'cervicalPoint', 'neckPoint'],
   412→    lines: [
   413→      { from: 'menton', to: 'cervicalPoint', label: 'Submental', color: '#14b8a6' },
   414→      { from: 'cervicalPoint', to: 'neckPoint', label: 'Cervical', color: '#06b6d4' },
   415→    ],
   416→  },
   417→  facialDepthToHeight: {
   418→    points: ['pronasale', 'tragus', 'nasion', 'menton'],
   419→    lines: [
   420→      { from: 'pronasale', to: 'tragus', label: 'Depth', color: '#67e8f9' },
   421→      { from: 'nasion', to: 'menton', label: 'Height', color: '#a78bfa' },
   422→    ],
   423→  },
   424→  anteriorFacialDepth: {
   425→    points: ['glabella', 'pronasale', 'pogonion'],
   426→    lines: [
   427→      { from: 'glabella', to: 'pronasale', color: '#67e8f9' },
   428→      { from: 'pronasale', to: 'pogonion', color: '#a78bfa' },
   429→    ],
   430→  },
   431→  mandibularPlaneAngle: {
   432→    points: ['gonionBottom', 'menton', 'orbitale', 'porion'],
   433→    lines: [
   434→      { from: 'gonionBottom', to: 'menton', label: 'Mandibular', color: '#f97316' },
   435→      { from: 'orbitale', to: 'porion', label: 'Frankfort', color: '#67e8f9' },
   436→    ],
   437→  },
   438→  ramusToMandibleRatio: {
   439→    points: ['gonionTop', 'gonionBottom', 'menton'],
   440→    lines: [
   441→      { from: 'gonionTop', to: 'gonionBottom', label: 'Ramus', color: '#f97316' },
   442→      { from: 'gonionBottom', to: 'menton', label: 'Mandible', color: '#ef4444' },
   443→    ],
   444→  },
   445→  orbitalVector: {
   446→    points: ['cornealApex', 'orbitale', 'cheekbone'],
   447→    lines: [
   448→      { from: 'cornealApex', to: 'cheekbone', label: 'Orbital Vector', color: '#06b6d4' },
   449→    ],
   450→  },
   451→  eLineLowerLip: {
   452→    points: ['pronasale', 'pogonion', 'labraleInferius'],
   453→    lines: [
   454→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },
   455→    ],
   456→  },
   457→  sLineLowerLip: {
   458→    points: ['pronasale', 'pogonion', 'labraleInferius'],
   459→    lines: [
   460→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },
   461→    ],
   462→  },
   463→  holdawayHLine: {
   464→    points: ['pronasale', 'pogonion', 'labraleSuperius', 'labraleInferius'],
   465→    lines: [
   466→      { from: 'pronasale', to: 'pogonion', label: 'H-Line', color: '#ec4899' },
   467→    ],
   468→  },
   469→  burstoneLowerLip: {
   470→    points: ['subnasale', 'pogonion', 'labraleInferius'],
   471→    lines: [
   472→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },
   473→    ],
   474→  },
   475→
   476→  // ==========================================
   477→  // ADDITIONAL FRONT PROFILE METRICS
   478→  // ==========================================
   479→  cupidsBowDepth: {
   480→    points: ['labrale_superius', 'cupids_bow_left', 'cupids_bow_right', 'cupids_bow_center'],
   481→    lines: [
   482→      { from: 'cupids_bow_left', to: 'cupids_bow_center', label: 'Bow', color: '#ec4899' },
   483→      { from: 'cupids_bow_center', to: 'cupids_bow_right', color: '#ec4899' },
   484→    ],
   485→  },
   486→  mouthCornerPosition: {
   487→    points: ['left_cheilion', 'right_cheilion', 'left_pupila', 'right_pupila'],
   488→    lines: [
   489→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth Width', color: '#ec4899' },
   490→      { from: 'left_pupila', to: 'right_pupila', label: 'IPD', color: '#06b6d4', labelPosition: 'start' },
   491→    ],
   492→  },
   493→  iaaJfaDeviation: {
   494→    points: ['left_ala_nasi', 'right_ala_nasi', 'left_gonion_inferior', 'menton', 'right_gonion_inferior'],
   495→    lines: [
   496→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'IAA', color: '#fbbf24' },
   497→      { from: 'left_gonion_inferior', to: 'menton', label: 'JFA', color: '#f97316' },
   498→      { from: 'menton', to: 'right_gonion_inferior', color: '#f97316' },
   499→    ],
   500→  },
   501→  ipsilateralAlarAngle: {
   502→    points: ['left_ala_nasi', 'subnasale', 'right_ala_nasi'],
   503→    lines: [
   504→      { from: 'left_ala_nasi', to: 'subnasale', label: 'Alar Angle', color: '#fbbf24' },
   505→      { from: 'subnasale', to: 'right_ala_nasi', color: '#fbbf24' },
   506→    ],
   507→  },
   508→  earProtrusionAngle: {
   509→    points: ['left_ear_helix', 'left_ear_attachment', 'left_tragus'],
   510→    lines: [
   511→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Protrusion', color: '#a78bfa' },
   512→    ],
   513→  },
   514→  earProtrusionRatio: {
   515→    points: ['left_ear_helix', 'left_ear_attachment', 'left_ear_lobule'],
   516→    lines: [
   517→      { from: 'left_ear_helix', to: 'left_ear_attachment', label: 'Distance', color: '#a78bfa' },
   518→      { from: 'left_ear_attachment', to: 'left_ear_lobule', label: 'Length', color: '#67e8f9' },
   519→    ],
   520→  },
   521→  mouthWidthToNoseRatio: {
   522→    points: ['left_cheilion', 'right_cheilion', 'left_ala_nasi', 'right_ala_nasi'],
   523→    lines: [
   524→      { from: 'left_cheilion', to: 'right_cheilion', label: 'Mouth', color: '#ec4899' },
   525→      { from: 'left_ala_nasi', to: 'right_ala_nasi', label: 'Nose', color: '#fbbf24' },
   526→    ],
   527→  },
   528→  lowerToUpperLipRatio: {
   529→    points: ['labrale_superius', 'mouth_middle', 'labrale_inferius'],
   530→    lines: [
   531→      { from: 'labrale_superius', to: 'mouth_middle', label: 'Upper', color: '#ec4899' },
   532→      { from: 'mouth_middle', to: 'labrale_inferius', label: 'Lower', color: '#f97316' },
   533→    ],
   534→  },
   535→  chinToPhiltrumRatio: {
   536→    points: ['subnasale', 'labrale_superius', 'labrale_inferius', 'menton'],
   537→    lines: [
   538→      { from: 'subnasale', to: 'labrale_superius', label: 'Philtrum', color: '#ec4899' },
   539→      { from: 'labrale_inferius', to: 'menton', label: 'Chin', color: '#ef4444' },
   540→    ],
   541→  },
   542→
   543→  // ==========================================
   544→  // ADDITIONAL SIDE PROFILE METRICS
   545→  // ==========================================
   546→  nasolabialAngle: {
   547→    points: ['columella', 'subnasale', 'labraleSuperius'],
   548→    lines: [
   549→      { from: 'columella', to: 'subnasale', label: 'Columella', color: '#fbbf24' },
   550→      { from: 'subnasale', to: 'labraleSuperius', label: 'Upper Lip', color: '#ec4899' },
   551→    ],
   552→  },
   553→  nasalTipAngle: {
   554→    points: ['nasion', 'pronasale', 'columella'],
   555→    lines: [
   556→      { from: 'nasion', to: 'pronasale', label: 'Dorsum', color: '#fbbf24' },
   557→      { from: 'pronasale', to: 'columella', label: 'Tip', color: '#f97316' },
   558→    ],
   559→  },
   560→  nasalProjection: {
   561→    points: ['alar_crease', 'pronasale', 'subnasale'],
   562→    lines: [
   563→      { from: 'alar_crease', to: 'pronasale', label: 'Projection', color: '#fbbf24' },
   564→    ],
   565→  },
   566→  nasalWToHRatio: {
   567→    points: ['alar_crease', 'pronasale', 'nasion', 'subnasale'],
   568→    lines: [
   569→      { from: 'alar_crease', to: 'pronasale', label: 'Width', color: '#fbbf24' },
   570→      { from: 'nasion', to: 'subnasale', label: 'Height', color: '#a78bfa' },
   571→    ],
   572→  },
   573→  noseTipRotationAngle: {
   574→    points: ['columella', 'subnasale', 'labraleSuperius'],
   575→    lines: [
   576→      { from: 'columella', to: 'subnasale', label: 'Rotation', color: '#fbbf24' },
   577→    ],
   578→  },
   579→  frankfortTipAngle: {
   580→    points: ['porion', 'orbitale', 'pronasale'],
   581→    lines: [
   582→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
   583→      { from: 'orbitale', to: 'pronasale', label: 'To Tip', color: '#fbbf24' },
   584→    ],
   585→  },
   586→  mentolabialAngle: {
   587→    points: ['labraleInferius', 'mentolabialSulcus', 'pogonion'],
   588→    lines: [
   589→      { from: 'labraleInferius', to: 'mentolabialSulcus', label: 'Lip', color: '#ec4899' },
   590→      { from: 'mentolabialSulcus', to: 'pogonion', label: 'Chin', color: '#ef4444' },
   591→    ],
   592→  },
   593→  zAngle: {
   594→    points: ['pogonion', 'labraleSuperius', 'frankfortHorizontal'],
   595→    lines: [
   596→      { from: 'pogonion', to: 'labraleSuperius', label: 'Z-Line', color: '#a78bfa' },
   597→    ],
   598→  },
   599→  facialConvexityGlabella: {
   600→    points: ['glabella', 'subnasale', 'pogonion'],
   601→    lines: [
   602→      { from: 'glabella', to: 'subnasale', label: 'Upper', color: '#84cc16' },
   603→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
   604→    ],
   605→  },
   606→  facialConvexityNasion: {
   607→    points: ['nasion', 'subnasale', 'pogonion'],
   608→    lines: [
   609→      { from: 'nasion', to: 'subnasale', label: 'Midface', color: '#22c55e' },
   610→      { from: 'subnasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
   611→    ],
   612→  },
   613→  totalFacialConvexity: {
   614→    points: ['glabella', 'pronasale', 'pogonion'],
   615→    lines: [
   616→      { from: 'glabella', to: 'pronasale', label: 'Upper', color: '#84cc16' },
   617→      { from: 'pronasale', to: 'pogonion', label: 'Lower', color: '#ef4444' },
   618→    ],
   619→  },
   620→  interiorMidfaceProjectionAngle: {
   621→    points: ['orbitale', 'subnasale', 'pronasale'],
   622→    lines: [
   623→      { from: 'orbitale', to: 'subnasale', label: 'Orbital', color: '#06b6d4' },
   624→      { from: 'subnasale', to: 'pronasale', label: 'Midface', color: '#67e8f9' },
   625→    ],
   626→  },
   627→  recessionFromFrankfort: {
   628→    points: ['porion', 'orbitale', 'pogonion'],
   629→    lines: [
   630→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
   631→      { from: 'orbitale', to: 'pogonion', label: 'Recession', color: '#ef4444' },
   632→    ],
   633→  },
   634→  gonionToMouthLine: {
   635→    points: ['gonionBottom', 'cheilion', 'tragus'],
   636→    lines: [
   637→      { from: 'gonionBottom', to: 'cheilion', label: 'Gonion-Mouth', color: '#f97316' },
   638→    ],
   639→  },
   640→  eLineUpperLip: {
   641→    points: ['pronasale', 'pogonion', 'labraleSuperius'],
   642→    lines: [
   643→      { from: 'pronasale', to: 'pogonion', label: 'E-Line', color: '#67e8f9' },
   644→    ],
   645→  },
   646→  sLineUpperLip: {
   647→    points: ['pronasale', 'pogonion', 'labraleSuperius'],
   648→    lines: [
   649→      { from: 'pronasale', to: 'pogonion', label: 'S-Line', color: '#a78bfa' },
   650→    ],
   651→  },
   652→  burstoneUpperLip: {
   653→    points: ['subnasale', 'pogonion', 'labraleSuperius'],
   654→    lines: [
   655→      { from: 'subnasale', to: 'pogonion', label: 'Burstone', color: '#fbbf24' },
   656→    ],
   657→  },
   658→  chinProjection: {
   659→    points: ['subnasale', 'pogonion', 'menton', 'frankfortHorizontal'],
   660→    lines: [
   661→      { from: 'subnasale', to: 'pogonion', label: 'Chin Proj', color: '#ef4444' },
   662→    ],
   663→  },
   664→  recessionRelativeToFrankfort: {
   665→    points: ['porion', 'orbitale', 'pogonion', 'menton'],
   666→    lines: [
   667→      { from: 'porion', to: 'orbitale', label: 'Frankfort', color: '#67e8f9' },
   668→      { from: 'pogonion', to: 'menton', label: 'Recession', color: '#ef4444' },
   669→    ],
   670→  },
   671→  browridgeInclinationAngle: {
   672→    points: ['glabella', 'trichion', 'nasion'],
   673→    lines: [
   674→      { from: 'glabella', to: 'trichion', label: 'Brow Ridge', color: '#84cc16' },
   675→      { from: 'glabella', to: 'nasion', color: '#67e8f9' },
   676→    ],
   677→  },
   678→  upperForeheadSlope: {
   679→    points: ['trichion', 'glabella', 'frankfortHorizontal'],
   680→    lines: [
   681→      { from: 'trichion', to: 'glabella', label: 'Forehead', color: '#84cc16' },
   682→    ],
   683→  },
   684→  midfaceProjectionAngle: {
   685→    points: ['orbitale', 'subnasale', 'pronasale'],
   686→    lines: [
   687→      { from: 'orbitale', to: 'subnasale', color: '#67e8f9' },
   688→      { from: 'subnasale', to: 'pronasale', label: 'Projection', color: '#22c55e' },
   689→    ],
   690→  },
   691→};
   692→
   693→function generateIllustration(metricId: string, landmarks: LandmarkPoint[]): Ratio['illustration'] {
   694→  const landmarkMap: Record<string, LandmarkPoint> = {};
   695→  landmarks.forEach(l => { landmarkMap[l.id] = l; });
   696→
   697→  const config = ILLUSTRATION_CONFIGS[metricId];
   698→  const points: Record<string, { type: 'landmark'; landmarkId: string }> = {};
   699→  const lines: Record<string, { from: string; to: string; color: string; label?: string; labelPosition?: 'start' | 'middle' | 'end' }> = {};
   700→
   701→  if (config) {
   702→    config.points.forEach((pointId, i) => {
   703→      if (landmarkMap[pointId]) {
   704→        points[`point_${i}`] = { type: 'landmark', landmarkId: pointId };
   705→      }
   706→    });
   707→    config.lines.forEach((line, i) => {
   708→      lines[`line_${i}`] = {
   709→        from: line.from,
   710→        to: line.to,
   711→        color: line.color || '#67e8f9',
   712→        label: line.label,
   713→        labelPosition: line.labelPosition,
   714→      };
   715→    });
   716→  }
   717→
   718→  return { points, lines };
   719→}
   720→
   721→function getUsedLandmarks(metricId: string): string[] {
   722→  const landmarkMappings: Record<string, string[]> = {
   723→    faceWidthToHeight: ['left_zygion', 'right_zygion', 'trichion', 'menton'],
   724→    lateralCanthalTilt: ['left_canthus_medialis', 'left_canthus_lateralis'],
   725→    nasalIndex: ['left_ala_nasi', 'right_ala_nasi', 'nasal_base', 'subnasale'],
   726→    ipd: ['left_pupila', 'right_pupila'],
   727→    mouthWidth: ['left_cheilion', 'right_cheilion'],
   728→    jawWidth: ['left_gonion_inferior', 'right_gonion_inferior'],
   729→    chinHeight: ['labrale_inferius', 'menton'],
   730→    gonialAngle: ['tragus', 'gonionBottom', 'menton'],
   731→  };
   732→  return landmarkMappings[metricId] || [];
   733→}
   734→
   735→function getFlawStrengthMappings(result: FaceIQScoreResult): { mayIndicateFlaws: string[]; mayIndicateStrengths: string[] } {
   736→  const flawMappings: Record<string, { low: string[]; high: string[] }> = {
   737→    faceWidthToHeight: {
   738→      low: ['Narrow face', 'Vertically elongated face'],
   739→      high: ['Wide face', 'Horizontally expanded face'],
   740→    },
   741→    lowerThirdProportion: {
   742→      low: ['Short lower third', 'Deficient mandible'],
   743→      high: ['Long lower third', 'Mandibular excess'],
   744→    },
   745→    lateralCanthalTilt: {
   746→      low: ['Negative canthal tilt', 'Drooping eyes'],
   747→      high: ['Excessive positive canthal tilt'],
   748→    },
   749→    nasalIndex: {
   750→      low: ['Narrow nose', 'Leptorrhine nose'],
   751→      high: ['Wide nose', 'Platyrrhine nose'],
   752→    },
   753→    gonialAngle: {
   754→      low: ['Steep mandibular plane'],
   755→      high: ['Flat mandibular plane', 'Weak jaw definition'],
   756→    },
   757→  };
   758→
   759→  const strengthMappings: Record<string, { ideal: string[] }> = {
   760→    faceWidthToHeight: { ideal: ['Balanced facial proportions', 'Harmonious face shape'] },
   761→    lateralCanthalTilt: { ideal: ['Attractive eye shape', 'Positive canthal tilt'] },
   762→    nasalIndex: { ideal: ['Well-proportioned nose', 'Balanced nasal width'] },
   763→    gonialAngle: { ideal: ['Well-defined jawline', 'Strong jaw structure'] },
   764→  };
   765→
   766→  const mapping = flawMappings[result.metricId];
   767→  const strengthMapping = strengthMappings[result.metricId];
   768→
   769→  let mayIndicateFlaws: string[] = [];
   770→  let mayIndicateStrengths: string[] = [];
   771→
   772→  if (result.qualityTier === 'ideal' || result.qualityTier === 'excellent') {
   773→    mayIndicateStrengths = strengthMapping?.ideal || [];
   774→  } else if (mapping) {
   775→    mayIndicateFlaws = result.deviationDirection === 'below' ? mapping.low : mapping.high;
   776→  }
   777→
   778→  return { mayIndicateFlaws, mayIndicateStrengths };
   779→}
   780→
   781→function generateStrengthsFromAnalysis(analysis: HarmonyAnalysis): Strength[] {
   782→  const strengths: Strength[] = [];
   783→
   784→  analysis.strengths.forEach((s, i) => {
   785→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === s.metricId);
   786→
   787→    strengths.push({
   788→      id: `strength_${i}`,
   789→      strengthName: s.metricName,
   790→      summary: s.reasoning,
   791→      avgScore: matchingMeasurement?.score || 8,
   792→      qualityLevel: s.qualityTier,
   793→      categoryName: s.category,
   794→      responsibleRatios: [{
   795→        ratioName: s.metricName,
   796→        ratioId: s.metricId,
   797→        score: matchingMeasurement?.score || 8,
   798→        value: s.value,
   799→        idealMin: matchingMeasurement?.idealMin || 0,
   800→        idealMax: matchingMeasurement?.idealMax || 1,
   801→        unit: matchingMeasurement?.unit || 'ratio',
   802→        category: s.category,
   803→      }],
   804→    });
   805→  });
   806→
   807→  return strengths;
   808→}
   809→
   810→function generateFlawsFromAnalysis(analysis: HarmonyAnalysis): Flaw[] {
   811→  const flaws: Flaw[] = [];
   812→  let rollingLost = 0;
   813→
   814→  analysis.flaws.forEach((f, i) => {
   815→    const matchingMeasurement = analysis.measurements.find(m => m.metricId === f.metricId);
   816→    const impact = matchingMeasurement ? (10 - matchingMeasurement.score) * 0.5 : 2;
   817→    rollingLost += impact;
   818→
   819→    flaws.push({
   820→      id: `flaw_${i}`,
   821→      flawName: f.metricName,
   822→      summary: f.reasoning,
   823→      harmonyPercentageLost: impact,
   824→      standardizedImpact: impact / 10,
   825→      categoryName: f.category,
   826→      responsibleRatios: [{
   827→        ratioName: f.metricName,
   828→        ratioId: f.metricId,
   829→        score: matchingMeasurement?.score || 3,
   830→        value: matchingMeasurement?.value || 0,
   831→        idealMin: matchingMeasurement?.idealMin || 0,
   832→        idealMax: matchingMeasurement?.idealMax || 1,
   833→        unit: matchingMeasurement?.unit || 'ratio',
   834→        category: f.category,
   835→      }],
   836→      rollingPointsDeducted: rollingLost,
   837→      rollingHarmonyPercentageLost: rollingLost,
   838→      rollingStandardizedImpact: rollingLost / 10,
   839→    });
   840→  });
   841→
   842→  return flaws.sort((a, b) => b.harmonyPercentageLost - a.harmonyPercentageLost);
   843→}
   844→
   845→// Comprehensive procedure database with metric-specific targeting
   846→interface ProcedureConfig {
   847→  ref_id: string;
   848→  name: string;
   849→  description: string;
   850→  phase: 'Surgical' | 'Minimally Invasive' | 'Foundational';
   851→  baseImpact: number;
   852→  coverage: number;
   853→  percentage: string;
   854→  expectedImprovementRange: { min: number; max: number };
   855→  targetMetrics: string[];  // Specific metric IDs this treatment addresses
   856→  targetCategories: string[];  // Category names this treatment addresses
   857→  targetKeywords: string[];  // Flaw name keywords to match
   858→  timeline: { effect_start: 'immediate' | 'delayed' | 'gradual'; full_results_weeks: number; full_results_weeks_max?: number };
   859→  cost: { type: 'flat' | 'per_session' | 'per_month'; min: number; max: number; currency: string };
   860→  risks_side_effects: string;
   861→  warnings: string[];
   862→  gender: 'male' | 'female' | 'both';
   863→}
   864→
   865→const PROCEDURE_DATABASE: ProcedureConfig[] = [
   866→  // ==========================================
   867→  // SURGICAL TREATMENTS
   868→  // ==========================================
   869→  {
   870→    ref_id: 'SUR-01',
   871→    name: 'Sliding Genioplasty',
   872→    description: 'Chin bone repositioning surgery that can move the chin forward, backward, up, or down for optimal projection and facial balance.',
   873→    phase: 'Surgical',
   874→    baseImpact: 0.90,
   875→    coverage: 8,
   876→    percentage: '15-25%',
   877→    expectedImprovementRange: { min: 0.5, max: 1.5 },
   878→    targetMetrics: ['chinPhiltrumRatio', 'facialDepthToHeight', 'anteriorFacialDepth', 'nasomentaAngle'],
   879→    targetCategories: ['Chin', 'Occlusion/Jaw Growth'],
   880→    targetKeywords: ['chin', 'recessed', 'weak', 'short chin', 'long chin', 'pogonion'],
   881→    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },
   882→    cost: { type: 'flat', min: 5000, max: 15000, currency: 'USD' },
   883→    risks_side_effects: 'Temporary numbness, swelling, bruising. Rare: infection, nerve damage, bone resorption.',
   884→    warnings: [],
   885→    gender: 'both',
   886→  },
   887→  {
   888→    ref_id: 'SUR-02',
   889→    name: 'Reduction Rhinoplasty',
   890→    description: 'Surgical reduction of nose size, hump removal, and tip refinement to improve nasal proportions.',
   891→    phase: 'Surgical',
   892→    baseImpact: 0.85,
   893→    coverage: 6,
   894→    percentage: '10-20%',
   895→    expectedImprovementRange: { min: 0.5, max: 1.0 },
   896→    targetMetrics: ['nasalIndex', 'nasofrontalAngle', 'nasofacialAngle', 'nasomentaAngle', 'intercanthalNasalRatio', 'noseBridgeWidth'],
   897→    targetCategories: ['Nose'],
   898→    targetKeywords: ['wide nose', 'large nose', 'dorsal hump', 'bulbous', 'nasal', 'nose bridge'],
   899→    timeline: { effect_start: 'delayed', full_results_weeks: 24, full_results_weeks_max: 52 },
   900→    cost: { type: 'flat', min: 7000, max: 20000, currency: 'USD' },
   901→    risks_side_effects: 'Swelling for 6-12 months, numbness, possible revision needed.',
   902→    warnings: [],
   903→    gender: 'both',
   904→  },
   905→  {
   906→    ref_id: 'SUR-03',
   907→    name: 'Jaw Angle Implants',
   908→    description: 'Custom or standard silicone/PEEK implants to enhance jaw width, definition, and angularity.',
   909→    phase: 'Surgical',
   910→    baseImpact: 0.80,
   911→    coverage: 5,
   912→    percentage: '10-15%',
   913→    expectedImprovementRange: { min: 0.4, max: 1.0 },
   914→    targetMetrics: ['bigonialWidth', 'jawFrontalAngle', 'jawWidthRatio', 'jawSlope', 'gonialAngle'],
   915→    targetCategories: ['Jaw Shape'],
   916→    targetKeywords: ['narrow jaw', 'weak jaw', 'soft jaw', 'jaw angle', 'gonial', 'mandible'],
   917→    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },
   918→    cost: { type: 'flat', min: 8000, max: 25000, currency: 'USD' },
   919→    risks_side_effects: 'Swelling, asymmetry risk, implant migration, infection, bone erosion.',
   920→    warnings: [],
   921→    gender: 'both',
   922→  },
   923→  {
   924→    ref_id: 'SUR-04',
   925→    name: 'Bimaxillary Osteotomy (Bimax)',
   926→    description: 'Double jaw surgery to reposition both upper and lower jaws for optimal occlusion and facial balance.',
   927→    phase: 'Surgical',
   928→    baseImpact: 0.95,
   929→    coverage: 12,
   930→    percentage: '20-35%',
   931→    expectedImprovementRange: { min: 1.0, max: 2.0 },
   932→    targetMetrics: ['midfaceRatio', 'facialDepthToHeight', 'mandibularPlaneAngle', 'lowerThirdProportion', 'nasofacialAngle'],
   933→    targetCategories: ['Occlusion/Jaw Growth', 'Midface/Face Shape'],
   934→    targetKeywords: ['maxillary recession', 'mandibular', 'hyper-divergent', 'bite', 'occlusion', 'midface recession'],
   935→    timeline: { effect_start: 'delayed', full_results_weeks: 24, full_results_weeks_max: 52 },
   936→    cost: { type: 'flat', min: 20000, max: 60000, currency: 'USD' },
   937→    risks_side_effects: 'Extended recovery, numbness (temporary to permanent), dietary restrictions.',
   938→    warnings: ['Major surgery - requires orthodontic preparation'],
   939→    gender: 'both',
   940→  },
   941→  {
   942→    ref_id: 'SUR-05',
   943→    name: 'Canthoplasty',
   944→    description: 'Surgical eye corner modification to improve canthal tilt and eye shape.',
   945→    phase: 'Surgical',
   946→    baseImpact: 0.75,
   947→    coverage: 3,
   948→    percentage: '8-15%',
   949→    expectedImprovementRange: { min: 0.3, max: 0.8 },
   950→    targetMetrics: ['lateralCanthalTilt', 'eyeAspectRatio'],
   951→    targetCategories: ['Eyes'],
   952→    targetKeywords: ['canthal tilt', 'negative tilt', 'drooping eyes', 'eye shape', 'eye angle'],
   953→    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },
   954→    cost: { type: 'flat', min: 4000, max: 12000, currency: 'USD' },
   955→    risks_side_effects: 'Scarring, asymmetry, dry eyes, ectropion.',
   956→    warnings: ['Difficult to reverse'],
   957→    gender: 'both',
   958→  },
   959→  {
   960→    ref_id: 'SUR-06',
   961→    name: 'Cheek/Malar Implants',
   962→    description: 'Solid implants placed over the cheekbones to enhance midface projection and width.',
   963→    phase: 'Surgical',
   964→    baseImpact: 0.75,
   965→    coverage: 4,
   966→    percentage: '10-18%',
   967→    expectedImprovementRange: { min: 0.4, max: 0.9 },
   968→    targetMetrics: ['cheekboneHeight', 'midfaceRatio', 'totalFacialWidthToHeight'],
   969→    targetCategories: ['Midface/Face Shape'],
   970→    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface', 'zygomatic', 'malar'],
   971→    timeline: { effect_start: 'delayed', full_results_weeks: 6, full_results_weeks_max: 12 },
   972→    cost: { type: 'flat', min: 6000, max: 15000, currency: 'USD' },
   973→    risks_side_effects: 'Swelling, asymmetry, implant shifting, nerve damage.',
   974→    warnings: [],
   975→    gender: 'both',
   976→  },
   977→  {
   978→    ref_id: 'SUR-07',
   979→    name: 'Neck Liposuction / Submentoplasty',
   980→    description: 'Fat removal and skin tightening under the chin and neck area.',
   981→    phase: 'Surgical',
   982→    baseImpact: 0.65,
   983→    coverage: 3,
   984→    percentage: '8-12%',
   985→    expectedImprovementRange: { min: 0.3, max: 0.7 },
   986→    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],
   987→    targetCategories: ['Neck'],
   988→    targetKeywords: ['round neck', 'double chin', 'submental', 'cervical', 'neck definition'],
   989→    timeline: { effect_start: 'delayed', full_results_weeks: 8, full_results_weeks_max: 16 },
   990→    cost: { type: 'flat', min: 3000, max: 8000, currency: 'USD' },
   991→    risks_side_effects: 'Swelling, bruising, skin irregularity, numbness.',
   992→    warnings: [],
   993→    gender: 'both',
   994→  },
   995→  {
   996→    ref_id: 'SUR-08',
   997→    name: 'Brow Bone Reduction/Augmentation',
   998→    description: 'Surgical reshaping of the brow ridge for improved upper third harmony.',
   999→    phase: 'Surgical',
  1000→    baseImpact: 0.70,
  1001→    coverage: 3,
  1002→    percentage: '8-15%',
  1003→    expectedImprovementRange: { min: 0.3, max: 0.7 },
  1004→    targetMetrics: ['nasofrontalAngle', 'bitemporalWidth', 'upperThirdProportion'],
  1005→    targetCategories: ['Upper Third'],
  1006→    targetKeywords: ['brow ridge', 'forehead', 'nasofrontal', 'upper third', 'glabella'],
  1007→    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },
  1008→    cost: { type: 'flat', min: 8000, max: 20000, currency: 'USD' },
  1009→    risks_side_effects: 'Swelling, numbness, scarring (if coronal incision).',
  1010→    warnings: [],
  1011→    gender: 'both',
  1012→  },
  1013→
  1014→  // ==========================================
  1015→  // MINIMALLY INVASIVE TREATMENTS
  1016→  // ==========================================
  1017→  {
  1018→    ref_id: 'MIN-01',
  1019→    name: 'Chin/Jawline Filler',
  1020→    description: 'Hyaluronic acid injections to enhance chin projection and jawline definition. Reversible and temporary.',
  1021→    phase: 'Minimally Invasive',
  1022→    baseImpact: 0.45,
  1023→    coverage: 4,
  1024→    percentage: '5-10%',
  1025→    expectedImprovementRange: { min: 0.2, max: 0.5 },
  1026→    targetMetrics: ['chinPhiltrumRatio', 'jawFrontalAngle', 'bigonialWidth'],
  1027→    targetCategories: ['Chin', 'Jaw Shape'],
  1028→    targetKeywords: ['weak chin', 'recessed chin', 'soft jaw', 'jawline'],
  1029→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },
  1030→    cost: { type: 'per_session', min: 800, max: 2500, currency: 'USD' },
  1031→    risks_side_effects: 'Bruising, swelling, rare vascular occlusion.',
  1032→    warnings: ['Results temporary (12-18 months)', 'Requires maintenance'],
  1033→    gender: 'both',
  1034→  },
  1035→  {
  1036→    ref_id: 'MIN-02',
  1037→    name: 'Cheek Filler',
  1038→    description: 'HA filler to enhance cheekbone projection and midface volume.',
  1039→    phase: 'Minimally Invasive',
  1040→    baseImpact: 0.40,
  1041→    coverage: 3,
  1042→    percentage: '5-8%',
  1043→    expectedImprovementRange: { min: 0.2, max: 0.4 },
  1044→    targetMetrics: ['cheekboneHeight', 'midfaceRatio'],
  1045→    targetCategories: ['Midface/Face Shape'],
  1046→    targetKeywords: ['flat cheeks', 'low cheekbones', 'midface volume'],
  1047→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },
  1048→    cost: { type: 'per_session', min: 600, max: 1800, currency: 'USD' },
  1049→    risks_side_effects: 'Bruising, swelling, asymmetry.',
  1050→    warnings: ['Results temporary (12-18 months)'],
  1051→    gender: 'both',
  1052→  },
  1053→  {
  1054→    ref_id: 'MIN-03',
  1055→    name: 'Lip Filler',
  1056→    description: 'Hyaluronic acid to enhance lip volume and proportions.',
  1057→    phase: 'Minimally Invasive',
  1058→    baseImpact: 0.35,
  1059→    coverage: 2,
  1060→    percentage: '3-6%',
  1061→    expectedImprovementRange: { min: 0.1, max: 0.3 },
  1062→    targetMetrics: ['lowerUpperLipRatio', 'mouthNoseWidthRatio'],
  1063→    targetCategories: ['Lips'],
  1064→    targetKeywords: ['thin lip', 'lip ratio', 'lip volume', 'upper lip', 'lower lip'],
  1065→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },
  1066→    cost: { type: 'per_session', min: 400, max: 1200, currency: 'USD' },
  1067→    risks_side_effects: 'Bruising, swelling, lumps.',
  1068→    warnings: ['Results temporary (6-12 months)'],
  1069→    gender: 'both',
  1070→  },
  1071→  {
  1072→    ref_id: 'MIN-04',
  1073→    name: 'PDO Thread Lift',
  1074→    description: 'Dissolvable threads to lift and tighten skin, particularly for canthal tilt improvement.',
  1075→    phase: 'Minimally Invasive',
  1076→    baseImpact: 0.35,
  1077→    coverage: 3,
  1078→    percentage: '4-8%',
  1079→    expectedImprovementRange: { min: 0.1, max: 0.4 },
  1080→    targetMetrics: ['lateralCanthalTilt', 'eyebrowLowSetedness'],
  1081→    targetCategories: ['Eyes', 'Upper Third'],
  1082→    targetKeywords: ['canthal tilt', 'drooping', 'sagging', 'eyebrow position'],
  1083→    timeline: { effect_start: 'immediate', full_results_weeks: 4, full_results_weeks_max: 12 },
  1084→    cost: { type: 'per_session', min: 1500, max: 4000, currency: 'USD' },
  1085→    risks_side_effects: 'Bruising, asymmetry, thread visibility, infection.',
  1086→    warnings: ['Results temporary (12-18 months)'],
  1087→    gender: 'both',
  1088→  },
  1089→  {
  1090→    ref_id: 'MIN-05',
  1091→    name: 'Masseter Botox',
  1092→    description: 'Botulinum toxin to slim the lower face by relaxing masseter muscles.',
  1093→    phase: 'Minimally Invasive',
  1094→    baseImpact: 0.40,
  1095→    coverage: 2,
  1096→    percentage: '4-8%',
  1097→    expectedImprovementRange: { min: 0.2, max: 0.4 },
  1098→    targetMetrics: ['bigonialWidth', 'jawWidthRatio', 'faceWidthToHeight'],
  1099→    targetCategories: ['Jaw Shape', 'Midface/Face Shape'],
  1100→    targetKeywords: ['wide jaw', 'square jaw', 'masseter', 'bruxism'],
  1101→    timeline: { effect_start: 'delayed', full_results_weeks: 4, full_results_weeks_max: 12 },
  1102→    cost: { type: 'per_session', min: 400, max: 1000, currency: 'USD' },
  1103→    risks_side_effects: 'Temporary weakness, asymmetry, difficulty chewing.',
  1104→    warnings: ['Results temporary (4-6 months)', 'Requires regular maintenance'],
  1105→    gender: 'both',
  1106→  },
  1107→  {
  1108→    ref_id: 'MIN-06',
  1109→    name: 'Kybella (Submental Fat Dissolving)',
  1110→    description: 'Injectable deoxycholic acid to permanently destroy fat cells under the chin.',
  1111→    phase: 'Minimally Invasive',
  1112→    baseImpact: 0.45,
  1113→    coverage: 2,
  1114→    percentage: '5-10%',
  1115→    expectedImprovementRange: { min: 0.2, max: 0.5 },
  1116→    targetMetrics: ['submentalCervicalAngle', 'neckWidthRatio'],
  1117→    targetCategories: ['Neck'],
  1118→    targetKeywords: ['double chin', 'submental fat', 'neck definition'],
  1119→    timeline: { effect_start: 'delayed', full_results_weeks: 12, full_results_weeks_max: 24 },
  1120→    cost: { type: 'per_session', min: 1200, max: 1800, currency: 'USD' },
  1121→    risks_side_effects: 'Swelling, bruising, numbness, difficulty swallowing (temporary).',
  1122→    warnings: ['Requires 2-4 sessions'],
  1123→    gender: 'both',
  1124→  },
  1125→
  1126→  // ==========================================
  1127→  // FOUNDATIONAL TREATMENTS
  1128→  // ==========================================
  1129→  {
  1130→    ref_id: 'FND-01',
  1131→    name: 'Mewing / Proper Tongue Posture',
  1132→    description: 'Maintaining correct tongue posture on the palate to potentially influence facial development over time.',
  1133→    phase: 'Foundational',
  1134→    baseImpact: 0.25,
  1135→    coverage: 5,
  1136→    percentage: '2-5%',
  1137→    expectedImprovementRange: { min: 0.1, max: 0.3 },
  1138→    targetMetrics: ['midfaceRatio', 'bigonialWidth', 'facialDepthToHeight'],
  1139→    targetCategories: ['Midface/Face Shape', 'Jaw Shape', 'Occlusion/Jaw Growth'],
  1140→    targetKeywords: ['midface', 'palate', 'recession', 'jaw development'],
  1141→    timeline: { effect_start: 'gradual', full_results_weeks: 104, full_results_weeks_max: 260 },
  1142→    cost: { type: 'flat', min: 0, max: 0, currency: 'USD' },
  1143→    risks_side_effects: 'None if done correctly. Jaw pain if excessive.',
  1144→    warnings: ['Results vary significantly', 'Most effective in younger individuals'],
  1145→    gender: 'both',
  1146→  },
  1147→  {
  1148→    ref_id: 'FND-02',
  1149→    name: 'Body Recomposition (Leanmaxxing)',
  1150→    description: 'Reducing body fat percentage to enhance facial definition and reveal underlying bone structure.',
  1151→    phase: 'Foundational',
  1152→    baseImpact: 0.35,
  1153→    coverage: 6,
  1154→    percentage: '5-12%',
  1155→    expectedImprovementRange: { min: 0.2, max: 0.5 },
  1156→    targetMetrics: ['bigonialWidth', 'submentalCervicalAngle', 'cheekboneHeight'],
  1157→    targetCategories: ['Jaw Shape', 'Neck', 'Midface/Face Shape'],
  1158→    targetKeywords: ['soft jaw', 'undefined', 'round', 'facial definition'],
  1159→    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 52 },
  1160→    cost: { type: 'per_month', min: 50, max: 200, currency: 'USD' },
  1161→    risks_side_effects: 'None if done healthily.',
  1162→    warnings: [],
  1163→    gender: 'both',
  1164→  },
  1165→  {
  1166→    ref_id: 'FND-03',
  1167→    name: 'Posture Correction',
  1168→    description: 'Improving head and neck posture to optimize facial appearance and reduce forward head posture effects.',
  1169→    phase: 'Foundational',
  1170→    baseImpact: 0.20,
  1171→    coverage: 3,
  1172→    percentage: '2-5%',
  1173→    expectedImprovementRange: { min: 0.1, max: 0.2 },
  1174→    targetMetrics: ['submentalCervicalAngle', 'anteriorFacialDepth'],
  1175→    targetCategories: ['Neck', 'Occlusion/Jaw Growth'],
  1176→    targetKeywords: ['neck', 'posture', 'forward head'],
  1177→    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 52 },
  1178→    cost: { type: 'flat', min: 0, max: 100, currency: 'USD' },
  1179→    risks_side_effects: 'None.',
  1180→    warnings: [],
  1181→    gender: 'both',
  1182→  },
  1183→  {
  1184→    ref_id: 'FND-04',
  1185→    name: 'Skincare Routine (Retinoid + SPF)',
  1186→    description: 'Medical-grade skincare to improve skin quality, texture, and reduce aging signs.',
  1187→    phase: 'Foundational',
  1188→    baseImpact: 0.20,
  1189→    coverage: 2,
  1190→    percentage: '2-5%',
  1191→    expectedImprovementRange: { min: 0.1, max: 0.3 },
  1192→    targetMetrics: [],
  1193→    targetCategories: [],
  1194→    targetKeywords: ['skin', 'texture', 'aging'],
  1195→    timeline: { effect_start: 'gradual', full_results_weeks: 12, full_results_weeks_max: 26 },
  1196→    cost: { type: 'per_month', min: 30, max: 150, currency: 'USD' },
  1197→    risks_side_effects: 'Initial irritation, sun sensitivity.',
  1198→    warnings: [],
  1199→    gender: 'both',
  1200→  },
  1201→  {
  1202→    ref_id: 'FND-05',
  1203→    name: 'Eyebrow Grooming / Microblading',
  1204→    description: 'Professional shaping or semi-permanent tattooing to optimize eyebrow shape and position.',
  1205→    phase: 'Foundational',
  1206→    baseImpact: 0.25,
  1207→    coverage: 2,
  1208→    percentage: '3-6%',
  1209→    expectedImprovementRange: { min: 0.1, max: 0.3 },
  1210→    targetMetrics: ['eyebrowTilt', 'eyebrowLowSetedness', 'browLengthRatio'],
  1211→    targetCategories: ['Upper Third'],
  1212→    targetKeywords: ['eyebrow', 'brow', 'upper third'],
  1213→    timeline: { effect_start: 'immediate', full_results_weeks: 1 },
  1214→    cost: { type: 'flat', min: 20, max: 600, currency: 'USD' },
  1215→    risks_side_effects: 'Minimal for grooming. Microblading: infection risk, color fading.',
  1216→    warnings: [],
  1217→    gender: 'both',
  1218→  },
  1219→];
  1220→
  1221→// Calculate relevance score based on multiple factors including metric scores
  1222→function calculateRelevanceScore(
  1223→  proc: ProcedureConfig,
  1224→  flaw: Flaw,
  1225→  allFlaws: Flaw[],
  1226→  allRatios: Ratio[] = []
  1227→): number {
  1228→  let score = 0;
  1229→
  1230→  // Check metric ID match (highest priority)
  1231→  const metricId = flaw.responsibleRatios[0]?.ratioId || '';
  1232→  const metricScore = flaw.responsibleRatios[0]?.score || 5;
  1233→
  1234→  if (proc.targetMetrics.includes(metricId)) {
  1235→    // Base score for metric match
  1236→    score += 40;
  1237→
  1238→    // Boost based on how poor the metric score is (lower score = more improvement potential)
  1239→    // Score of 2 adds +20, score of 8 adds +5
  1240→    const metricPoorness = Math.max(0, 10 - metricScore) * 2;
  1241→    score += metricPoorness;
  1242→  }
  1243→
  1244→  // Check category match
  1245→  if (proc.targetCategories.some(cat =>
  1246→    flaw.categoryName.toLowerCase().includes(cat.toLowerCase()) ||
  1247→    cat.toLowerCase().includes(flaw.categoryName.toLowerCase())
  1248→  )) {
  1249→    score += 25;
  1250→  }
  1251→
  1252→  // Check keyword match with weighted scoring
  1253→  const flawLower = flaw.flawName.toLowerCase();
  1254→  const summaryLower = flaw.summary.toLowerCase();
  1255→  const matchedKeywords = proc.targetKeywords.filter(kw =>
  1256→    flawLower.includes(kw.toLowerCase()) || summaryLower.includes(kw.toLowerCase())
  1257→  );
  1258→  // Primary keyword match (in flaw name) worth more
  1259→  const primaryMatches = matchedKeywords.filter(kw => flawLower.includes(kw.toLowerCase()));
  1260→  score += primaryMatches.length * 15;
  1261→  score += (matchedKeywords.length - primaryMatches.length) * 8;
  1262→
  1263→  // Adjust by flaw severity/impact (more severe = higher priority)
  1264→  score += Math.min(flaw.harmonyPercentageLost * 4, 20);
  1265→
  1266→  // Bonus if this procedure addresses multiple flaws
  1267→  const otherFlawsAddressed = allFlaws.filter(f =>
  1268→    f.id !== flaw.id && (
  1269→      proc.targetMetrics.includes(f.responsibleRatios[0]?.ratioId || '') ||
  1270→      proc.targetCategories.some(cat => f.categoryName.toLowerCase().includes(cat.toLowerCase()))
  1271→    )
  1272→  );
  1273→  score += otherFlawsAddressed.length * 7;
  1274→
  1275→  // Check if procedure targets any below-average ratios directly
  1276→  const matchingRatios = allRatios.filter(r =>
  1277→    proc.targetMetrics.includes(r.id) && r.score < 6
  1278→  );
  1279→  score += matchingRatios.length * 8;
  1280→
  1281→  return Math.min(score, 100);
  1282→}
  1283→
  1284→// Calculate expected score improvement based on metric deviation and procedure effectiveness
  1285→function calculateExpectedImprovement(
  1286→  proc: ProcedureConfig,
  1287→  matchedRatios: Ratio[],
  1288→  avgFlawImpact: number
  1289→): { min: number; max: number; potential: number } {
  1290→  // Base improvement from procedure
  1291→  const baseMin = proc.expectedImprovementRange.min;
  1292→  const baseMax = proc.expectedImprovementRange.max;
  1293→
  1294→  // Severity multiplier: more severe issues have more room for improvement
  1295→  const severityMultiplier = Math.min(avgFlawImpact / 2.5, 1.8);
  1296→
  1297→  // Metric deviation bonus: further from ideal = more potential improvement
  1298→  let deviationBonus = 1.0;
  1299→  if (matchedRatios.length > 0) {
  1300→    const avgScore = matchedRatios.reduce((sum, r) => sum + r.score, 0) / matchedRatios.length;
  1301→    // Score of 3 gives 1.4x, score of 7 gives 1.0x
  1302→    deviationBonus = 1 + Math.max(0, (7 - avgScore) * 0.1);
  1303→  }
  1304→
  1305→  const adjustedMin = baseMin * severityMultiplier * deviationBonus;
  1306→  const adjustedMax = baseMax * severityMultiplier * deviationBonus;
  1307→
  1308→  // Calculate potential new score if treatment is applied
  1309→  const avgCurrentScore = matchedRatios.length > 0
  1310→    ? matchedRatios.reduce((sum, r) => sum + r.score, 0) / matchedRatios.length
  1311→    : 5;
  1312→  const potentialScore = Math.min(10, avgCurrentScore + (adjustedMax * 0.8));
  1313→
  1314→  return {
  1315→    min: Math.round(adjustedMin * 100) / 100,
  1316→    max: Math.round(adjustedMax * 100) / 100,
  1317→    potential: Math.round(potentialScore * 10) / 10,
  1318→  };
  1319→}
  1320→
  1321→function generateRecommendations(flaws: Flaw[], frontRatios: Ratio[] = [], sideRatios: Ratio[] = []): Recommendation[] {
  1322→  const recommendations: Recommendation[] = [];
  1323→  const allRatios = [...frontRatios, ...sideRatios];
  1324→
  1325→  // Track which procedures have been added and their matched flaws
  1326→  const procMatches: Map<string, {
  1327→    flaws: string[];
  1328→    ratios: string[];
  1329→    ratioIds: string[];
  1330→    maxScore: number;
  1331→    totalFlawImpact: number;
  1332→  }> = new Map();
  1333→
  1334→  flaws.forEach(flaw => {
  1335→    PROCEDURE_DATABASE.forEach(proc => {
  1336→      // Pass allRatios to the enhanced relevance scoring
  1337→      const relevanceScore = calculateRelevanceScore(proc, flaw, flaws, allRatios);
  1338→
  1339→      if (relevanceScore >= 25) {  // Minimum threshold
  1340→        const existing = procMatches.get(proc.ref_id);
  1341→        if (existing) {
  1342→          existing.flaws.push(flaw.flawName);
  1343→          existing.ratios.push(...flaw.responsibleRatios.map(r => r.ratioName));
  1344→          existing.ratioIds.push(...flaw.responsibleRatios.map(r => r.ratioId));
  1345→          existing.maxScore = Math.max(existing.maxScore, relevanceScore);
  1346→          existing.totalFlawImpact += flaw.harmonyPercentageLost;
  1347→        } else {
  1348→          procMatches.set(proc.ref_id, {
  1349→            flaws: [flaw.flawName],
  1350→            ratios: flaw.responsibleRatios.map(r => r.ratioName),
  1351→            ratioIds: flaw.responsibleRatios.map(r => r.ratioId),
  1352→            maxScore: relevanceScore,
  1353→            totalFlawImpact: flaw.harmonyPercentageLost,
  1354→          });
  1355→        }
  1356→      }
  1357→    });
  1358→  });
  1359→
  1360→  // Build recommendations from matched procedures
  1361→  procMatches.forEach((match, procId) => {
  1362→    const proc = PROCEDURE_DATABASE.find(p => p.ref_id === procId);
  1363→    if (!proc) return;
  1364→
  1365→    // Get affected ratios from the actual data (including directly targeted metrics)
  1366→    const affectedRatios = allRatios.filter(r =>
  1367→      proc.targetMetrics.includes(r.id) ||
  1368→      match.ratioIds.includes(r.id) ||
  1369→      match.flaws.some(f => f.toLowerCase().includes(r.category.toLowerCase()))
  1370→    );
  1371→
  1372→    // Calculate expected improvement with the new function
  1373→    const avgFlawImpact = match.totalFlawImpact / match.flaws.length;
  1374→    const improvement = calculateExpectedImprovement(proc, affectedRatios, avgFlawImpact);
  1375→
  1376→    // Calculate priority score based on multiple factors
  1377→    const priorityScore =
  1378→      (match.maxScore * 0.4) +  // Relevance weight
  1379→      (match.flaws.length * 8) +  // Multi-flaw bonus
  1380→      (avgFlawImpact * 3) +  // Severity weight
  1381→      (proc.baseImpact * 25);  // Procedure effectiveness
  1382→
  1383→    // Adjust impact based on how well this procedure addresses the specific issues
  1384→    const adjustedImpact = Math.min(
  1385→      1.0,
  1386→      proc.baseImpact * (0.85 + (match.maxScore / 400)) * (1 + (match.flaws.length * 0.05))
  1387→    );
  1388→
  1389→    // Calculate direction for each affected ratio
  1390→    const ratiosImpacted = affectedRatios.map(r => {
  1391→      // Determine direction based on deviation
  1392→      let direction: 'increase' | 'decrease' | 'both' = 'both';
  1393→      if (r.value < r.idealMin) {
  1394→        direction = 'increase';
  1395→      } else if (r.value > r.idealMax) {
  1396→        direction = 'decrease';
  1397→      }
  1398→
  1399→      // Calculate percentage effect based on how far from ideal and procedure strength
  1400→      const deviation = r.value < r.idealMin
  1401→        ? r.idealMin - r.value
  1402→        : r.value > r.idealMax
  1403→          ? r.value - r.idealMax
  1404→          : 0;
  1405→      const normalizedDeviation = deviation / ((r.rangeMax - r.rangeMin) / 2);
  1406→      const percentageEffect = proc.baseImpact * Math.min(normalizedDeviation * 1.5, 1.5);
  1407→
  1408→      return {
  1409→        ratioId: r.id,
  1410→        ratioName: r.name,
  1411→        direction,
  1412→        percentageEffect: Math.round(percentageEffect * 100) / 100,
  1413→      };
  1414→    });
  1415→
  1416→    recommendations.push({
  1417→      ref_id: proc.ref_id,
  1418→      name: proc.name,
  1419→      description: proc.description,
  1420→      phase: proc.phase,
  1421→      impact: adjustedImpact,
  1422→      coverage: match.flaws.length + Math.min(match.ratios.length, 5),
  1423→      percentage: proc.percentage,
  1424→      expectedImprovementRange: {
  1425→        min: improvement.min,
  1426→        max: improvement.max,
  1427→      },
  1428→      matchedFlaws: Array.from(new Set(match.flaws)),
  1429→      matchedRatios: Array.from(new Set(match.ratios)),
  1430→      ratios_impacted: ratiosImpacted,
  1431→      timeline: proc.timeline,
  1432→      cost: proc.cost,
  1433→      risks_side_effects: proc.risks_side_effects,
  1434→      warnings: proc.warnings,
  1435→      gender: proc.gender,
  1436→      // Add priority score as a sorting key (stored in coverage field calculation)
  1437→      _priorityScore: priorityScore,
  1438→    } as Recommendation & { _priorityScore: number });
  1439→  });
  1440→
  1441→  // Sort by priority score (combines impact, coverage, and severity)
  1442→  return recommendations.sort((a, b) => {
  1443→    const aScore = (a as Recommendation & { _priorityScore?: number })._priorityScore || (a.impact * 100);
  1444→    const bScore = (b as Recommendation & { _priorityScore?: number })._priorityScore || (b.impact * 100);
  1445→    const scoreDiff = bScore - aScore;
  1446→    if (Math.abs(scoreDiff) > 5) return scoreDiff;
  1447→    // Tiebreaker: prefer procedures that address more flaws
  1448→    return b.matchedFlaws.length - a.matchedFlaws.length;
  1449→  });
  1450→}
  1451→
  1452→// ============================================
  1453→// CONTEXT CREATION
  1454→// ============================================
  1455→
  1456→const ResultsContext = createContext<ResultsContextType | null>(null);
  1457→
  1458→export function useResults(): ResultsContextType {
  1459→  const context = useContext(ResultsContext);
  1460→  if (!context) {
  1461→    throw new Error('useResults must be used within a ResultsProvider');
  1462→  }
  1463→  return context;
  1464→}
  1465→
  1466→interface ResultsProviderProps {
  1467→  children: ReactNode;
  1468→  initialData?: ResultsInputData;
  1469→}
  1470→
  1471→export function ResultsProvider({ children, initialData }: ResultsProviderProps) {
  1472→  // Raw data state
  1473→  const [frontLandmarks, setFrontLandmarks] = useState<LandmarkPoint[]>(initialData?.frontLandmarks || []);
  1474→  const [sideLandmarks, setSideLandmarks] = useState<LandmarkPoint[]>(initialData?.sideLandmarks || []);
  1475→  const [gender, setGender] = useState<Gender>(initialData?.gender || 'male');
  1476→  const [ethnicity, setEthnicity] = useState<Ethnicity>(initialData?.ethnicity || 'other');
  1477→  const [frontPhoto, setFrontPhoto] = useState<string>(initialData?.frontPhoto || '');
  1478→  const [sidePhoto, setSidePhoto] = useState<string | null>(initialData?.sidePhoto || null);
  1479→
  1480→  // UI state
  1481→  const [activeTab, setActiveTab] = useState<ResultsTab>('overview');
  1482→  const [expandedMeasurementId, setExpandedMeasurementId] = useState<string | null>(null);
  1483→  const [selectedVisualizationMetric, setSelectedVisualizationMetric] = useState<string | null>(null);
  1484→  const [categoryFilter, setCategoryFilter] = useState<string | null>(null);
  1485→  const [showLandmarkOverlay, setShowLandmarkOverlay] = useState(true);
  1486→
  1487→  // Compute analysis results (now with demographic-specific scoring)
  1488→  const analysisResults = useMemo(() => {
  1489→    if (frontLandmarks.length === 0) {
  1490→      return null;
  1491→    }
  1492→
  1493→    try {
  1494→      const frontAnalysis = analyzeFrontProfile(frontLandmarks, gender, ethnicity);
  1495→      const sideAnalysis = sideLandmarks.length > 0
  1496→        ? analyzeSideProfile(sideLandmarks, gender, ethnicity)
  1497→        : null;
  1498→      // analyzeHarmony expects landmarks directly, not analysis results
  1499→      const harmony = analyzeHarmony(frontLandmarks, sideLandmarks, gender, ethnicity);
  1500→
  1501→      return { frontAnalysis, sideAnalysis, harmony };
  1502→    } catch (error) {
  1503→      console.error('Analysis error:', error);
  1504→      return null;
  1505→    }
  1506→  }, [frontLandmarks, sideLandmarks, gender, ethnicity]);
  1507→
  1508→  // Transform to Ratio format
  1509→  const frontRatios = useMemo(() => {
  1510→    if (!analysisResults?.frontAnalysis) return [];
  1511→    return analysisResults.frontAnalysis.measurements.map(m => transformToRatio(m, frontLandmarks));
  1512→  }, [analysisResults, frontLandmarks]);
  1513→
  1514→  const sideRatios = useMemo(() => {
  1515→    if (!analysisResults?.sideAnalysis) return [];
  1516→    return analysisResults.sideAnalysis.measurements.map(m => transformToRatio(m, sideLandmarks));
  1517→  }, [analysisResults, sideLandmarks]);
  1518→
  1519→  // Generate strengths and flaws
  1520→  const strengths = useMemo(() => {
  1521→    if (!analysisResults?.harmony) return [];
  1522→    return generateStrengthsFromAnalysis(analysisResults.harmony);
  1523→  }, [analysisResults]);
  1524→
  1525→  const flaws = useMemo(() => {
  1526→    if (!analysisResults?.harmony) return [];
  1527→    return generateFlawsFromAnalysis(analysisResults.harmony);
  1528→  }, [analysisResults]);
  1529→
  1530→  // Generate recommendations with metric-aware matching
  1531→  const recommendations = useMemo(() => {
  1532→    return generateRecommendations(flaws, frontRatios, sideRatios);
  1533→  }, [flaws, frontRatios, sideRatios]);
  1534→
  1535→  // Build full harmony analysis
  1536→  const harmonyAnalysis = useMemo((): FullHarmonyAnalysis | null => {
  1537→    if (!analysisResults?.harmony) return null;
  1538→
  1539→    return {
  1540→      standardizedScore: analysisResults.harmony.overallScore,
  1541→      front: {
  1542→        standardizedScore: analysisResults.harmony.frontScore,
  1543→        ratios: frontRatios,
  1544→      },
  1545→      side: {
  1546→        standardizedScore: analysisResults.harmony.sideScore,
  1547→        ratios: sideRatios,
  1548→      },
  1549→      strengths,
  1550→      flaws,
  1551→    };
  1552→  }, [analysisResults, frontRatios, sideRatios, strengths, flaws]);
  1553→
  1554→  // Scores
  1555→  const overallScore = analysisResults?.harmony?.overallScore || 0;
  1556→  const frontScore = analysisResults?.harmony?.frontScore || 0;
  1557→  const sideScore = analysisResults?.harmony?.sideScore || 0;
  1558→
  1559→  // Action to set all results data
  1560→  const setResultsData = useCallback((data: ResultsInputData) => {
  1561→    setFrontLandmarks(data.frontLandmarks);
  1562→    setSideLandmarks(data.sideLandmarks);
  1563→    setFrontPhoto(data.frontPhoto);
  1564→    setSidePhoto(data.sidePhoto || null);
  1565→    setGender(data.gender);
  1566→    setEthnicity(data.ethnicity || 'other');
  1567→  }, []);
  1568→
  1569→  const value: ResultsContextType = {
  1570→    frontLandmarks,
  1571→    sideLandmarks,
  1572→    gender,
  1573→    ethnicity,
  1574→    frontPhoto,
  1575→    sidePhoto,
  1576→    harmonyAnalysis,
  1577→    frontRatios,
  1578→    sideRatios,
  1579→    strengths,
  1580→    flaws,
  1581→    recommendations,
  1582→    overallScore,
  1583→    frontScore,
  1584→    sideScore,
  1585→    activeTab,
  1586→    setActiveTab,
  1587→    expandedMeasurementId,
  1588→    setExpandedMeasurementId,
  1589→    selectedVisualizationMetric,
  1590→    setSelectedVisualizationMetric,
  1591→    categoryFilter,
  1592→    setCategoryFilter,
  1593→    showLandmarkOverlay,
  1594→    setShowLandmarkOverlay,
  1595→    setResultsData,
  1596→  };
  1597→
  1598→  return (
  1599→    <ResultsContext.Provider value={value}>
  1600→      {children}
  1601→    </ResultsContext.Provider>
  1602→  );
  1603→}
  1604→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
