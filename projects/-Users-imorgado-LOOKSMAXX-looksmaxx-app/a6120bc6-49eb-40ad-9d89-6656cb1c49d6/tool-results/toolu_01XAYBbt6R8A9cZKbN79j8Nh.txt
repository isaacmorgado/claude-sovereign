     1→/**
     2→ * AI-Generated Descriptions for Facial Metrics
     3→ * Generates personalized explanations based on actual values vs ideal ranges
     4→ */
     5→
     6→import { SeverityLevel } from '@/lib/faceiq-scoring';
     7→
     8→// ============================================
     9→// TYPES
    10→// ============================================
    11→
    12→export interface MetricDescription {
    13→  reasoning: string;
    14→  impact: string;
    15→  recommendation?: string;
    16→}
    17→
    18→export interface FlawDetail {
    19→  category: string;
    20→  flawName: string;
    21→  confidence: 'confirmed' | 'likely' | 'possible';
    22→  actualValue: string;
    23→  idealRange: string;
    24→  deviation: string;
    25→  deviationPercent: number;
    26→  score: number;
    27→  severity: SeverityLevel;
    28→  reasoning: string;
    29→}
    30→
    31→// ============================================
    32→// DEVIATION CALCULATION
    33→// ============================================
    34→
    35→export function calculateDeviation(
    36→  value: number,
    37→  idealMin: number,
    38→  idealMax: number,
    39→  unit: string
    40→): { deviation: string; percent: number; direction: 'above' | 'below' | 'within' } {
    41→  const idealRange = idealMax - idealMin;
    42→
    43→  if (value >= idealMin && value <= idealMax) {
    44→    return { deviation: 'Within ideal range', percent: 0, direction: 'within' };
    45→  }
    46→
    47→  if (value < idealMin) {
    48→    const diff = idealMin - value;
    49→    const percent = (diff / idealRange) * 100;
    50→    const unitSymbol = unit === 'percent' ? '%' : unit === 'degrees' ? '°' : unit === 'mm' ? 'mm' : '';
    51→    return {
    52→      deviation: `${diff.toFixed(2)}${unitSymbol} below ideal`,
    53→      percent: Math.min(percent, 200),
    54→      direction: 'below',
    55→    };
    56→  }
    57→
    58→  const diff = value - idealMax;
    59→  const percent = (diff / idealRange) * 100;
    60→  const unitSymbol = unit === 'percent' ? '%' : unit === 'degrees' ? '°' : unit === 'mm' ? 'mm' : '';
    61→  return {
    62→    deviation: `${diff.toFixed(2)}${unitSymbol} above ideal`,
    63→    percent: Math.min(percent, 200),
    64→    direction: 'above',
    65→  };
    66→}
    67→
    68→export function getSeverityFromScore(score: number): SeverityLevel {
    69→  if (score >= 9) return 'optimal';
    70→  if (score >= 7.5) return 'minor';
    71→  if (score >= 6) return 'moderate';
    72→  if (score >= 4) return 'major';
    73→  if (score >= 2) return 'severe';
    74→  return 'extremely_severe';
    75→}
    76→
    77→export function getConfidenceFromScore(score: number): 'confirmed' | 'likely' | 'possible' {
    78→  if (score < 4) return 'confirmed';
    79→  if (score < 6) return 'likely';
    80→  return 'possible';
    81→}
    82→
    83→// ============================================
    84→// METRIC-SPECIFIC DESCRIPTIONS
    85→// ============================================
    86→
    87→interface DescriptionTemplate {
    88→  low: string;
    89→  high: string;
    90→  ideal: string;
    91→  impact: {
    92→    low: string;
    93→    high: string;
    94→  };
    95→  flawNames: {
    96→    low: string[];
    97→    high: string[];
    98→  };
    99→}
   100→
   101→const METRIC_DESCRIPTIONS: Record<string, DescriptionTemplate> = {
   102→  // FACE SHAPE
   103→  faceWidthToHeight: {
   104→    low: 'Your face appears narrower relative to its height, creating a more elongated vertical appearance. This can reduce perceived facial harmony and may affect how balanced your features appear.',
   105→    high: 'Your face is wider relative to its height, creating a more horizontally expanded appearance. While this can convey strength, extreme values may reduce overall facial balance.',
   106→    ideal: 'Your facial width-to-height ratio falls within the ideal range, contributing to a balanced and harmonious facial appearance.',
   107→    impact: {
   108→      low: 'A narrow face can make the midface appear longer and may reduce perceived masculinity in males.',
   109→      high: 'A wider face can appear less refined and may create imbalance with other features.',
   110→    },
   111→    flawNames: {
   112→      low: ['Narrow face', 'Vertically elongated face', 'Long face syndrome'],
   113→      high: ['Wide face', 'Horizontally expanded face', 'Facial width excess'],
   114→    },
   115→  },
   116→
   117→  lowerThirdProportion: {
   118→    low: 'Your lower third (chin to base of nose) is shorter than ideal, which can make the midface appear longer and reduce jaw prominence.',
   119→    high: 'Your lower third is longer than ideal, indicating possible hyper-divergent growth pattern. This elongates the lower face and can disrupt vertical facial harmony.',
   120→    ideal: 'Your lower third proportion is well-balanced, contributing to harmonious vertical facial thirds.',
   121→    impact: {
   122→      low: 'A short lower third can indicate underdevelopment of the mandible or a recessed chin position.',
   123→      high: 'A long lower third often indicates vertical maxillary excess or hyper-divergent jaw growth, which can significantly impact facial aesthetics.',
   124→    },
   125→    flawNames: {
   126→      low: ['Short lower third', 'Deficient mandible', 'Vertical deficiency'],
   127→      high: ['Long lower third', 'Hyper-divergent jaw growth', 'Vertical maxillary excess'],
   128→    },
   129→  },
   130→
   131→  middleThirdProportion: {
   132→    low: 'Your middle third (nose to brow) is shorter than ideal, which can make the upper face appear more dominant.',
   133→    high: 'Your middle third is longer than ideal, which can create an elongated midface appearance and reduce harmony.',
   134→    ideal: 'Your middle third proportion is balanced, contributing to proper vertical facial harmony.',
   135→    impact: {
   136→      low: 'A short midface can make the nose appear relatively larger and affect eye positioning perception.',
   137→      high: 'A long midface can create a tired or aged appearance and affect overall facial balance.',
   138→    },
   139→    flawNames: {
   140→      low: ['Short midface', 'Compressed middle third'],
   141→      high: ['Long midface', 'Elongated middle third', 'Midface excess'],
   142→    },
   143→  },
   144→
   145→  lateralCanthalTilt: {
   146→    low: 'Your lateral canthal tilt is negative or insufficient, meaning your outer eye corners sit at or below the inner corners. This creates a downward-sloping eye appearance.',
   147→    high: 'Your lateral canthal tilt is excessive, with outer corners significantly higher than inner corners. While some positive tilt is ideal, extreme values can appear unnatural.',
   148→    ideal: 'Your lateral canthal tilt is within the ideal positive range, contributing to an alert and youthful eye appearance.',
   149→    impact: {
   150→      low: 'Negative canthal tilt can create a tired, sad, or aged appearance and is one of the most impactful eye metrics.',
   151→      high: 'Excessive canthal tilt can appear unnatural or create asymmetric eye appearance.',
   152→    },
   153→    flawNames: {
   154→      low: ['Negative canthal tilt', 'Drooping eyes', 'Downward-sloping palpebral fissure'],
   155→      high: ['Excessive positive tilt', 'Over-tilted eyes'],
   156→    },
   157→  },
   158→
   159→  gonialAngle: {
   160→    low: 'Your gonial angle is too acute (steep), which can create an overly defined but potentially harsh jaw appearance.',
   161→    high: 'Your gonial angle is too obtuse (flat), resulting in a weak or undefined jaw angle. This reduces mandibular definition.',
   162→    ideal: 'Your gonial angle is within the ideal range, providing good jaw definition without appearing overly harsh.',
   163→    impact: {
   164→      low: 'A steep gonial angle can make the face appear overly angular or masculine in females.',
   165→      high: 'A flat gonial angle significantly reduces jaw definition and is a common area of concern.',
   166→    },
   167→    flawNames: {
   168→      low: ['Steep mandibular plane', 'Acute gonial angle'],
   169→      high: ['Flat gonial angle', 'Weak jaw definition', 'Obtuse mandibular angle'],
   170→    },
   171→  },
   172→
   173→  bigonialWidth: {
   174→    low: 'Your jaw width (bigonial width) is narrower than ideal relative to your face width, creating a less defined lower face.',
   175→    high: 'Your jaw width is wider than ideal, which can create an overly square or blocky facial appearance.',
   176→    ideal: 'Your jaw width is well-proportioned to your face width, contributing to balanced facial structure.',
   177→    impact: {
   178→      low: 'Narrow jaw width can reduce facial definition and create a less masculine appearance in males.',
   179→      high: 'Excessive jaw width can appear masculine in females or create imbalance.',
   180→    },
   181→    flawNames: {
   182→      low: ['Narrow jaw', 'Deficient bigonial width', 'Weak mandibular width'],
   183→      high: ['Wide jaw', 'Excessive bigonial width', 'Square jaw'],
   184→    },
   185→  },
   186→
   187→  nasalIndex: {
   188→    low: 'Your nose is narrower than the ideal proportion relative to its height, which may appear pinched or overly refined.',
   189→    high: 'Your nose is wider than ideal relative to its height, which can reduce nasal refinement and affect facial balance.',
   190→    ideal: 'Your nasal proportions are balanced, with width harmonizing well with nasal height.',
   191→    impact: {
   192→      low: 'A very narrow nose can appear pinched and may create breathing issues.',
   193→      high: 'A wide nose can dominate the midface and reduce overall facial refinement.',
   194→    },
   195→    flawNames: {
   196→      low: ['Narrow nose', 'Leptorrhine nose', 'Pinched nose'],
   197→      high: ['Wide nose', 'Platyrrhine nose', 'Broad nasal base'],
   198→    },
   199→  },
   200→
   201→  eyeAspectRatio: {
   202→    low: 'Your eyes appear narrower/more closed, with a lower height-to-width ratio. This can create a squinting or less open appearance.',
   203→    high: 'Your eyes have a high height-to-width ratio, appearing very round. While not necessarily negative, this differs from the almond-shaped ideal.',
   204→    ideal: 'Your eye aspect ratio falls within the ideal range, creating an attractive almond-shaped appearance.',
   205→    impact: {
   206→      low: 'Narrow eyes can appear less open and may reduce perceived attractiveness.',
   207→      high: 'Very round eyes can appear surprised or less refined.',
   208→    },
   209→    flawNames: {
   210→      low: ['Narrow eyes', 'Low eye aperture', 'Closed eye appearance'],
   211→      high: ['Round eyes', 'Excessive eye aperture'],
   212→    },
   213→  },
   214→
   215→  chinPhiltrumRatio: {
   216→    low: 'Your chin height is short relative to your philtrum length, which can indicate a recessed or underdeveloped chin.',
   217→    high: 'Your chin is long relative to your philtrum, which can create a bottom-heavy lower face appearance.',
   218→    ideal: 'Your chin-to-philtrum ratio is balanced, contributing to harmonious lower third proportions.',
   219→    impact: {
   220→      low: 'A short chin relative to philtrum can make the face appear weak or recessed from the side.',
   221→      high: 'An excessively long chin can dominate the lower face and appear unfeminine in females.',
   222→    },
   223→    flawNames: {
   224→      low: ['Short chin', 'Recessed chin', 'Weak chin projection'],
   225→      high: ['Long chin', 'Excessive chin height', 'Macrogenia'],
   226→    },
   227→  },
   228→
   229→  submentalCervicalAngle: {
   230→    low: 'Your submental-cervical angle is too acute, which is generally not a concern as it indicates good neck definition.',
   231→    high: 'Your submental-cervical angle is too obtuse, indicating poor neck definition or excess submental fat.',
   232→    ideal: 'Your submental-cervical angle is well-defined, contributing to a clean jawline-to-neck transition.',
   233→    impact: {
   234→      low: 'An overly acute angle is rare and usually not aesthetically concerning.',
   235→      high: 'An obtuse angle creates a "double chin" appearance and reduces jawline definition.',
   236→    },
   237→    flawNames: {
   238→      low: ['Overly defined neck angle'],
   239→      high: ['Poor neck definition', 'Double chin', 'Obtuse cervicomental angle'],
   240→    },
   241→  },
   242→
   243→  // Side profile metrics
   244→  nasofrontalAngle: {
   245→    low: 'Your nasofrontal angle is too acute, creating a sharp transition between forehead and nose that may appear harsh.',
   246→    high: 'Your nasofrontal angle is too obtuse, creating a flattened transition between forehead and nose.',
   247→    ideal: 'Your nasofrontal angle creates a smooth, aesthetically pleasing transition from forehead to nose.',
   248→    impact: {
   249→      low: 'A sharp nasofrontal angle can make the nose appear to project suddenly from the face.',
   250→      high: 'A flat nasofrontal angle can reduce the nose\'s definition from the profile.',
   251→    },
   252→    flawNames: {
   253→      low: ['Sharp nasofrontal transition', 'Acute nasofrontal angle'],
   254→      high: ['Flat nasofrontal angle', 'Poor forehead-nose transition'],
   255→    },
   256→  },
   257→
   258→  nasolabialAngle: {
   259→    low: 'Your nasolabial angle is too acute, indicating a downturned nasal tip that can create a droopy appearance.',
   260→    high: 'Your nasolabial angle is too obtuse, indicating an upturned nose that may appear overly rotated.',
   261→    ideal: 'Your nasolabial angle is balanced, with appropriate nasal tip rotation for your gender.',
   262→    impact: {
   263→      low: 'A droopy nasal tip can age the face and create a less refined profile.',
   264→      high: 'An overly upturned nose can appear piggy or infantile.',
   265→    },
   266→    flawNames: {
   267→      low: ['Drooping nasal tip', 'Acute nasolabial angle', 'Ptotic nose'],
   268→      high: ['Upturned nose', 'Over-rotated nasal tip', 'Obtuse nasolabial angle'],
   269→    },
   270→  },
   271→};
   272→
   273→// Default template for metrics without specific descriptions
   274→const DEFAULT_DESCRIPTION: DescriptionTemplate = {
   275→  low: 'This measurement is below the ideal range, which may affect your facial harmony.',
   276→  high: 'This measurement is above the ideal range, which may affect your facial harmony.',
   277→  ideal: 'This measurement falls within the ideal range, contributing to facial harmony.',
   278→  impact: {
   279→    low: 'Values below ideal can reduce facial balance and proportional harmony.',
   280→    high: 'Values above ideal can create imbalance with other facial features.',
   281→  },
   282→  flawNames: {
   283→    low: ['Below ideal range'],
   284→    high: ['Above ideal range'],
   285→  },
   286→};
   287→
   288→// ============================================
   289→// MAIN GENERATOR FUNCTION
   290→// ============================================
   291→
   292→export function generateAIDescription(
   293→  metricId: string,
   294→  metricName: string,
   295→  value: number,
   296→  idealMin: number,
   297→  idealMax: number,
   298→  score: number,
   299→  unit: string,
   300→  category: string
   301→): FlawDetail {
   302→  const template = METRIC_DESCRIPTIONS[metricId] || DEFAULT_DESCRIPTION;
   303→  const deviation = calculateDeviation(value, idealMin, idealMax, unit);
   304→  const severity = getSeverityFromScore(score);
   305→  const confidence = getConfidenceFromScore(score);
   306→
   307→  // Format actual value with unit
   308→  const unitSymbol = unit === 'percent' ? '%' : unit === 'degrees' ? '°' : unit === 'mm' ? 'mm' : '';
   309→  const actualValue = `${value.toFixed(2)}${unitSymbol}`;
   310→  const idealRange = `${idealMin.toFixed(2)}-${idealMax.toFixed(2)}${unitSymbol}`;
   311→
   312→  // Get appropriate reasoning based on deviation direction
   313→  let reasoning: string;
   314→  let flawName: string;
   315→
   316→  if (deviation.direction === 'within') {
   317→    reasoning = template.ideal;
   318→    flawName = 'Optimal';
   319→  } else if (deviation.direction === 'below') {
   320→    reasoning = template.low;
   321→    flawName = template.flawNames.low[0] || 'Below ideal';
   322→  } else {
   323→    reasoning = template.high;
   324→    flawName = template.flawNames.high[0] || 'Above ideal';
   325→  }
   326→
   327→  // Add impact information for non-ideal values
   328→  if (deviation.direction !== 'within' && score < 7) {
   329→    const impact = deviation.direction === 'below' ? template.impact.low : template.impact.high;
   330→    reasoning += ` ${impact}`;
   331→  }
   332→
   333→  return {
   334→    category,
   335→    flawName,
   336→    confidence,
   337→    actualValue,
   338→    idealRange,
   339→    deviation: deviation.deviation,
   340→    deviationPercent: deviation.percent,
   341→    score,
   342→    severity,
   343→    reasoning,
   344→  };
   345→}
   346→
   347→// ============================================
   348→// STRENGTH DESCRIPTION GENERATOR
   349→// ============================================
   350→
   351→export function generateStrengthDescription(
   352→  metricId: string,
   353→  score: number
   354→): string {
   355→  const template = METRIC_DESCRIPTIONS[metricId] || DEFAULT_DESCRIPTION;
   356→
   357→  if (score >= 8) {
   358→    return template.ideal + ' This is one of your strongest facial features.';
   359→  }
   360→
   361→  return template.ideal;
   362→}
   363→
   364→// ============================================
   365→// FLAW LIST GENERATOR
   366→// ============================================
   367→
   368→export function generateFlawsList(
   369→  metricId: string,
   370→  value: number,
   371→  idealMin: number,
   372→  idealMax: number
   373→): string[] {
   374→  const template = METRIC_DESCRIPTIONS[metricId] || DEFAULT_DESCRIPTION;
   375→  const deviation = calculateDeviation(value, idealMin, idealMax, 'ratio');
   376→
   377→  if (deviation.direction === 'within') {
   378→    return [];
   379→  }
   380→
   381→  return deviation.direction === 'below'
   382→    ? template.flawNames.low
   383→    : template.flawNames.high;
   384→}
   385→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
