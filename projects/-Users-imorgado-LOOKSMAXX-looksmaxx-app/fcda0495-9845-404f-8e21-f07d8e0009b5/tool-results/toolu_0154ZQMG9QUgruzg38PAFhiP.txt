     1→"""
     2→Forum database models - Issue Categories, Sub-Forums, Posts, Comments, Votes, Reports, Flaw Mappings
     3→"""
     4→
     5→import uuid
     6→import enum
     7→from datetime import datetime
     8→from sqlalchemy import (
     9→    Column, String, DateTime, ForeignKey, Text, Integer, Boolean, Enum, Index
    10→)
    11→from sqlalchemy.dialects.postgresql import UUID
    12→from sqlalchemy.orm import relationship
    13→
    14→from app.database import Base
    15→
    16→
    17→class VoteType(str, enum.Enum):
    18→    UP = "up"
    19→    DOWN = "down"
    20→
    21→
    22→class TargetType(str, enum.Enum):
    23→    POST = "post"
    24→    COMMENT = "comment"
    25→
    26→
    27→class ReportStatus(str, enum.Enum):
    28→    PENDING = "pending"
    29→    REVIEWED = "reviewed"
    30→    RESOLVED = "resolved"
    31→    DISMISSED = "dismissed"
    32→
    33→
    34→class ReportReason(str, enum.Enum):
    35→    SPAM = "spam"
    36→    HARASSMENT = "harassment"
    37→    MISINFORMATION = "misinformation"
    38→    OFF_TOPIC = "off_topic"
    39→    INAPPROPRIATE = "inappropriate"
    40→    OTHER = "other"
    41→
    42→
    43→# ============== ISSUE CATEGORIES (12 main categories) ==============
    44→
    45→class ForumIssueCategory(Base):
    46→    """Main issue categories (e.g., 'Weak Bone Structure', 'Poor Skin Complexion')"""
    47→    __tablename__ = "forum_issue_categories"
    48→
    49→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    50→    name = Column(String(100), nullable=False, unique=True)
    51→    slug = Column(String(50), nullable=False, unique=True, index=True)
    52→    description = Column(Text, nullable=True)
    53→    icon = Column(String(10), nullable=True)  # Emoji icon
    54→    display_order = Column(Integer, default=0)
    55→    is_active = Column(Boolean, default=True)
    56→    created_at = Column(DateTime, default=datetime.utcnow)
    57→
    58→    # Relationships
    59→    sub_forums = relationship("ForumSubForum", back_populates="issue_category", cascade="all, delete-orphan")
    60→    flaw_mappings = relationship("FlawToForumMapping", back_populates="issue_category", cascade="all, delete-orphan")
    61→
    62→    def __repr__(self):
    63→        return f"<ForumIssueCategory {self.slug}>"
    64→
    65→
    66→# ============== SUB-FORUMS (44 sub-forums under categories) ==============
    67→
    68→class ForumSubForum(Base):
    69→    """Sub-forums under each issue category (e.g., 'Jawline', 'Nutrition')"""
    70→    __tablename__ = "forum_sub_forums"
    71→
    72→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    73→    issue_category_id = Column(UUID(as_uuid=True), ForeignKey("forum_issue_categories.id", ondelete="CASCADE"), nullable=False)
    74→    name = Column(String(100), nullable=False)
    75→    slug = Column(String(50), nullable=False)
    76→    description = Column(Text, nullable=True)
    77→    icon = Column(String(10), nullable=True)
    78→    display_order = Column(Integer, default=0)
    79→    is_active = Column(Boolean, default=True)
    80→    created_at = Column(DateTime, default=datetime.utcnow)
    81→
    82→    # Relationships
    83→    issue_category = relationship("ForumIssueCategory", back_populates="sub_forums")
    84→    posts = relationship("ForumPost", back_populates="sub_forum", cascade="all, delete-orphan")
    85→
    86→    __table_args__ = (
    87→        Index('idx_subforum_category', 'issue_category_id', 'slug', unique=True),
    88→    )
    89→
    90→    def __repr__(self):
    91→        return f"<ForumSubForum {self.slug}>"
    92→
    93→
    94→# ============== FLAW TO FORUM MAPPING ==============
    95→
    96→class FlawToForumMapping(Base):
    97→    """Maps detected analysis flaws to recommended forum categories"""
    98→    __tablename__ = "flaw_to_forum_mapping"
    99→
   100→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   101→    flaw_id = Column(String(100), nullable=False, index=True)  # e.g., "weak_jaw", "negative_canthal_tilt"
   102→    issue_category_id = Column(UUID(as_uuid=True), ForeignKey("forum_issue_categories.id", ondelete="CASCADE"), nullable=False)
   103→    priority = Column(Integer, default=1)  # 1 = primary, 2 = secondary recommendation
   104→    created_at = Column(DateTime, default=datetime.utcnow)
   105→
   106→    # Relationships
   107→    issue_category = relationship("ForumIssueCategory", back_populates="flaw_mappings")
   108→
   109→    __table_args__ = (
   110→        Index('idx_flaw_mapping', 'flaw_id', 'issue_category_id', unique=True),
   111→    )
   112→
   113→    def __repr__(self):
   114→        return f"<FlawToForumMapping {self.flaw_id} -> {self.issue_category_id}>"
   115→
   116→
   117→# ============== POSTS (in sub-forums) ==============
   118→
   119→class ForumPost(Base):
   120→    __tablename__ = "forum_posts"
   121→
   122→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   123→    sub_forum_id = Column(UUID(as_uuid=True), ForeignKey("forum_sub_forums.id", ondelete="CASCADE"), nullable=False)
   124→    author_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
   125→    title = Column(String(200), nullable=False)
   126→    content = Column(Text, nullable=False)
   127→
   128→    # Status flags
   129→    is_pinned = Column(Boolean, default=False)
   130→    is_guide = Column(Boolean, default=False)  # Marks as "Guide" content
   131→    is_approved = Column(Boolean, default=True)  # For moderation workflow
   132→    is_deleted = Column(Boolean, default=False)
   133→
   134→    # Denormalized counts for performance
   135→    vote_count = Column(Integer, default=0)  # net score (ups - downs)
   136→    comment_count = Column(Integer, default=0)
   137→
   138→    # Timestamps
   139→    created_at = Column(DateTime, default=datetime.utcnow)
   140→    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
   141→
   142→    # Relationships
   143→    sub_forum = relationship("ForumSubForum", back_populates="posts")
   144→    author = relationship("User", backref="forum_posts")
   145→    comments = relationship("ForumComment", back_populates="post", cascade="all, delete-orphan")
   146→
   147→    # Indexes
   148→    __table_args__ = (
   149→        Index('idx_posts_subforum_pinned', 'sub_forum_id', 'is_pinned', 'created_at'),
   150→        Index('idx_posts_subforum_votes', 'sub_forum_id', 'vote_count'),
   151→        Index('idx_posts_author', 'author_id'),
   152→    )
   153→
   154→    def __repr__(self):
   155→        return f"<ForumPost {self.title[:30]}>"
   156→
   157→
   158→class ForumComment(Base):
   159→    __tablename__ = "forum_comments"
   160→
   161→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   162→    content = Column(Text, nullable=False)
   163→    post_id = Column(UUID(as_uuid=True), ForeignKey("forum_posts.id", ondelete="CASCADE"), nullable=False)
   164→    author_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
   165→    parent_id = Column(UUID(as_uuid=True), ForeignKey("forum_comments.id", ondelete="CASCADE"), nullable=True)  # For threading
   166→
   167→    # Status
   168→    is_approved = Column(Boolean, default=True)
   169→    is_deleted = Column(Boolean, default=False)
   170→
   171→    # Denormalized vote count
   172→    vote_count = Column(Integer, default=0)
   173→
   174→    # Depth for limiting nesting (max 5 levels)
   175→    depth = Column(Integer, default=0)
   176→
   177→    # Timestamps
   178→    created_at = Column(DateTime, default=datetime.utcnow)
   179→    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
   180→
   181→    # Relationships
   182→    post = relationship("ForumPost", back_populates="comments")
   183→    author = relationship("User", backref="forum_comments")
   184→    parent = relationship("ForumComment", remote_side=[id], backref="replies")
   185→
   186→    # Indexes
   187→    __table_args__ = (
   188→        Index('idx_comments_post', 'post_id', 'created_at'),
   189→        Index('idx_comments_parent', 'parent_id'),
   190→        Index('idx_comments_author', 'author_id'),
   191→    )
   192→
   193→    def __repr__(self):
   194→        return f"<ForumComment {self.id}>"
   195→
   196→
   197→class ForumVote(Base):
   198→    __tablename__ = "forum_votes"
   199→
   200→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   201→    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
   202→    target_type = Column(Enum(TargetType), nullable=False)
   203→    target_id = Column(UUID(as_uuid=True), nullable=False)
   204→    vote_type = Column(Enum(VoteType), nullable=False)
   205→    created_at = Column(DateTime, default=datetime.utcnow)
   206→
   207→    # Relationships
   208→    user = relationship("User", backref="forum_votes")
   209→
   210→    # Unique constraint: one vote per user per target
   211→    __table_args__ = (
   212→        Index('idx_votes_user_target', 'user_id', 'target_type', 'target_id', unique=True),
   213→        Index('idx_votes_target', 'target_type', 'target_id'),
   214→    )
   215→
   216→    def __repr__(self):
   217→        return f"<ForumVote {self.vote_type} on {self.target_type}:{self.target_id}>"
   218→
   219→
   220→class ForumReport(Base):
   221→    __tablename__ = "forum_reports"
   222→
   223→    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
   224→    reporter_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
   225→    target_type = Column(Enum(TargetType), nullable=False)
   226→    target_id = Column(UUID(as_uuid=True), nullable=False)
   227→    reason = Column(Enum(ReportReason), nullable=False)
   228→    details = Column(Text, nullable=True)  # Additional context
   229→    status = Column(Enum(ReportStatus), default=ReportStatus.PENDING)
   230→    reviewed_by = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
   231→    reviewed_at = Column(DateTime, nullable=True)
   232→    created_at = Column(DateTime, default=datetime.utcnow)
   233→
   234→    # Relationships
   235→    reporter = relationship("User", foreign_keys=[reporter_id], backref="reports_filed")
   236→    reviewer = relationship("User", foreign_keys=[reviewed_by], backref="reports_reviewed")
   237→
   238→    # Indexes
   239→    __table_args__ = (
   240→        Index('idx_reports_status', 'status', 'created_at'),
   241→        Index('idx_reports_target', 'target_type', 'target_id'),
   242→    )
   243→
   244→    def __repr__(self):
   245→        return f"<ForumReport {self.reason} on {self.target_type}:{self.target_id}>"
   246→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
