     1→# LOOKSMAXX PSL + Body Composition Sprints
     2→
     3→## Process
     4→For each feature: Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature
     5→
     6→## Completed Sprints
     7→- [x] Sprint 1: Weight Collection (WeightContext, `/weight` page, API endpoints)
     8→- [x] Sprint 2: Physique Upload UI (PhysiqueContext, `/physique` page with 3 angles)
     9→- [x] Sprint 3: Backend Physique Storage & Analysis (Claude Vision body analysis)
    10→- [x] Sprint 4: FFMI Calculator & PSL Display (FFMI-based body scoring)
    11→
    12→---
    13→
    14→# Sprint 3: Backend Physique Storage & Analysis
    15→
    16→## Process
    17→For each feature: Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature
    18→
    19→---
    20→
    21→## Feature 3.1: Physique Photo Storage Endpoint
    22→
    23→**Files:**
    24→- `looksmaxx-api/app/routers/physique.py` (new)
    25→- `looksmaxx-api/app/models/physique.py` (new)
    26→- `looksmaxx-api/app/main.py` (add router)
    27→
    28→**Problem:** Physique photos collected on frontend but no backend storage. Photos lost on page refresh.
    29→
    30→**Implementation:**
    31→1. Create `PhysiqueAnalysis` model:
    32→   ```python
    33→   class PhysiqueAnalysis(Base):
    34→       id: UUID
    35→       user_id: UUID (FK to users)
    36→       front_photo_url: Optional[str]
    37→       side_photo_url: Optional[str]
    38→       back_photo_url: Optional[str]
    39→       created_at: datetime
    40→   ```
    41→2. Create `POST /physique/upload` endpoint accepting multipart form data
    42→3. Store photos in same S3/storage as face photos
    43→4. Create `GET /physique/my-photos` to retrieve user's photos
    44→5. Add router to `main.py`
    45→
    46→**E2E Test After Implementation:**
    47→- Upload front photo via `POST /physique/upload` → verify 200 response
    48→- Upload all 3 photos → verify URLs returned
    49→- Call `GET /physique/my-photos` → verify all 3 URLs present
    50→- Upload as unauthenticated user → should return 401
    51→- Upload invalid file type (PDF) → should return 400
    52→- Verify photos accessible via returned URLs
    53→
    54→**Fix any bugs found, re-test until passing, then proceed to 3.2**
    55→
    56→---
    57→
    58→## Feature 3.2: Claude Vision Body Analysis Service
    59→
    60→**Files:**
    61→- `looksmaxx-api/app/services/body_analysis.py` (new)
    62→- `looksmaxx-api/app/core/config.py` (add ANTHROPIC_API_KEY)
    63→
    64→**Problem:** No way to estimate body fat percentage from photos. PSL body score defaults to 5.0.
    65→
    66→**Implementation:**
    67→1. Add `ANTHROPIC_API_KEY` to environment config
    68→2. Create `analyze_physique()` function:
    69→   ```python
    70→   async def analyze_physique(
    71→       front_url: str,
    72→       side_url: Optional[str],
    73→       back_url: Optional[str],
    74→       gender: str
    75→   ) -> PhysiqueResult:
    76→       # Use Claude Vision to analyze photos
    77→       # Return: estimated_body_fat, muscle_level, confidence, notes
    78→   ```
    79→3. Craft prompt for body fat estimation (10-30% range for most people)
    80→4. Return structured result with confidence score
    81→5. Cache results in database to avoid re-analysis
    82→
    83→**E2E Test After Implementation:**
    84→- Call with valid front photo → returns body fat estimate (10-35% range)
    85→- Call with all 3 photos → returns estimate with higher confidence
    86→- Call with male vs female → different assessment criteria applied
    87→- Call with invalid image URL → returns error gracefully
    88→- Call twice with same photos → second call uses cached result
    89→- Verify response time < 10 seconds
    90→
    91→**Fix any bugs found, re-test until passing, then proceed to 3.3**
    92→
    93→---
    94→
    95→## Feature 3.3: Physique Analysis Endpoint
    96→
    97→**Files:**
    98→- `looksmaxx-api/app/routers/physique.py`
    99→- `looksmaxx-api/app/models/physique.py` (add analysis fields)
   100→
   101→**Problem:** Need HTTP endpoint to trigger and retrieve body analysis results.
   102→
   103→**Implementation:**
   104→1. Add fields to `PhysiqueAnalysis` model:
   105→   ```python
   106→   estimated_body_fat: Optional[float]
   107→   muscle_level: Optional[str]  # "low", "moderate", "high", "very_high"
   108→   analysis_confidence: Optional[float]
   109→   analysis_notes: Optional[str]
   110→   analyzed_at: Optional[datetime]
   111→   ```
   112→2. Create `POST /physique/analyze` endpoint:
   113→   - Fetches user's stored photos
   114→   - Calls `analyze_physique()` service
   115→   - Stores results in database
   116→   - Returns analysis results
   117→3. Create `GET /physique/my-analysis` to retrieve stored analysis
   118→
   119→**E2E Test After Implementation:**
   120→- Upload photos, then `POST /physique/analyze` → returns body fat estimate
   121→- `GET /physique/my-analysis` → returns same stored result
   122→- Analyze without photos uploaded → returns 400 "No photos found"
   123→- Analyze as unauthenticated → returns 401
   124→- Re-analyze after uploading new photos → updates stored result
   125→- Verify `analyzed_at` timestamp updates on re-analysis
   126→
   127→**Fix any bugs found, re-test until passing, then proceed to 3.4**
   128→
   129→---
   130→
   131→## Feature 3.4: Frontend Analysis Integration
   132→
   133→**Files:**
   134→- `looksmaxx-app/src/app/analysis/page.tsx`
   135→- `looksmaxx-app/src/lib/api.ts`
   136→- `looksmaxx-app/src/contexts/PhysiqueContext.tsx`
   137→
   138→**Problem:** Analysis page only analyzes face photos. Physique photos not sent to backend.
   139→
   140→**Implementation:**
   141→1. Add API methods to `api.ts`:
   142→   ```typescript
   143→   uploadPhysiquePhotos(front: File, side?: File, back?: File): Promise<PhysiqueUrls>
   144→   analyzePhysique(): Promise<PhysiqueAnalysis>
   145→   getMyPhysiqueAnalysis(): Promise<PhysiqueAnalysis | null>
   146→   ```
   147→2. Update `/analysis` page:
   148→   - After face analysis, check if physique photos exist in context
   149→   - If yes, upload photos and trigger analysis
   150→   - Show combined loading state
   151→   - Store results in context
   152→3. Add `physiqueAnalysis` state to `PhysiqueContext`:
   153→   ```typescript
   154→   physiqueAnalysis: {
   155→     bodyFatPercent: number;
   156→     muscleLevel: string;
   157→     confidence: number;
   158→   } | null
   159→   ```
   160→
   161→**E2E Test After Implementation:**
   162→- Complete onboarding with physique photos → analysis page uploads them
   163→- Analysis page shows "Analyzing body composition..." step
   164→- After analysis, physique context has body fat data
   165→- Skip physique photos → analysis proceeds without body analysis
   166→- Network error during physique upload → shows error, face analysis continues
   167→- Verify physique analysis doesn't block face analysis (parallel or sequential)
   168→
   169→**Fix any bugs found, re-test until passing**
   170→
   171→---
   172→
   173→## Sprint 3 Complete Checklist
   174→- [x] 3.1 Physique photo storage endpoint working
   175→- [x] 3.2 Claude Vision body analysis service working
   176→- [x] 3.3 Physique analysis endpoint returns body fat %
   177→- [x] 3.4 Frontend integrates physique analysis in flow
   178→- [x] All endpoints return proper error codes
   179→- [x] Analysis results persisted in database
   180→- [x] Ready for Sprint 4
   181→
   182→---
   183→
   184→# Sprint 4: FFMI Calculator & PSL Display
   185→
   186→## Process
   187→For each feature: Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature
   188→
   189→---
   190→
   191→## Feature 4.1: FFMI Calculator
   192→
   193→**Files:**
   194→- `looksmaxx-app/src/lib/ffmi-calculator.ts` (new)
   195→
   196→**Problem:** No way to calculate FFMI (Fat-Free Mass Index) from height, weight, and body fat.
   197→
   198→**Implementation:**
   199→1. Create `calculateFFMI()` function:
   200→   ```typescript
   201→   interface FFMIResult {
   202→     ffmi: number;           // Raw FFMI value
   203→     normalizedFFMI: number; // Adjusted for height
   204→     leanMassKg: number;     // Weight × (1 - bodyFat/100)
   205→     rating: number;         // 0-10 scale
   206→     category: string;       // "Below Average" | "Average" | "Above Average" | "Excellent" | "Elite"
   207→   }
   208→
   209→   function calculateFFMI(
   210→     heightCm: number,
   211→     weightKg: number,
   212→     bodyFatPercent: number
   213→   ): FFMIResult
   214→   ```
   215→2. FFMI Formula: `leanMass / (height in m)^2`
   216→3. Normalized FFMI: `FFMI + 6.1 × (1.8 - height in m)`
   217→4. Rating scale (male):
   218→   - < 18: Below Average (0-3)
   219→   - 18-20: Average (4-5)
   220→   - 20-22: Above Average (6-7)
   221→   - 22-25: Excellent (8-9)
   222→   - 25+: Elite (10) - near natural limit
   223→5. Female scale ~2-3 points lower
   224→
   225→**E2E Test After Implementation:**
   226→- Calculate for average male (180cm, 80kg, 15% BF) → FFMI ~23, rating ~8
   227→- Calculate for skinny male (180cm, 65kg, 12% BF) → FFMI ~18, rating ~4
   228→- Calculate for muscular male (180cm, 95kg, 12% BF) → FFMI ~26, rating ~10
   229→- Calculate for female (165cm, 55kg, 22% BF) → appropriate female rating
   230→- Edge case: 0% body fat → still calculates (though unrealistic)
   231→- Edge case: 50% body fat → handles gracefully
   232→- Verify normalized FFMI adjusts for height correctly
   233→
   234→**Fix any bugs found, re-test until passing, then proceed to 4.2**
   235→
   236→---
   237→
   238→## Feature 4.2: Body Score from FFMI
   239→
   240→**Files:**
   241→- `looksmaxx-app/src/lib/psl-calculator.ts`
   242→
   243→**Problem:** PSL calculation uses hardcoded body score of 5.0. Need to use actual FFMI-based score.
   244→
   245→**Implementation:**
   246→1. Update `calculatePSL()` to accept optional `bodyFatPercent`:
   247→   ```typescript
   248→   interface PSLInput {
   249→     faceScore: number;
   250→     heightCm: number;
   251→     gender: 'male' | 'female';
   252→     bodyFatPercent?: number;  // NEW
   253→     weightKg?: number;        // NEW
   254→   }
   255→   ```
   256→2. If `bodyFatPercent` and `weightKg` provided:
   257→   - Calculate FFMI using `calculateFFMI()`
   258→   - Use FFMI rating as body score
   259→3. If not provided, default to 5.0 (as before)
   260→4. Update PSL formula to use actual body score
   261→
   262→**E2E Test After Implementation:**
   263→- PSL with no body data → uses 5.0 body score (backward compatible)
   264→- PSL with body data → uses calculated FFMI rating
   265→- Muscular person (FFMI 24) → higher PSL than default
   266→- Skinny person (FFMI 17) → lower PSL than default
   267→- Verify body score contributes 5% to final PSL
   268→- Verify bonuses apply if body score ≥ 8.5
   269→- Compare PSL with/without body data → difference should be ±0.25 max
   270→
   271→**Fix any bugs found, re-test until passing, then proceed to 4.3**
   272→
   273→---
   274→
   275→## Feature 4.3: PSL Tab Shows Body Composition
   276→
   277→**Files:**
   278→- `looksmaxx-app/src/components/results/tabs/PSLTab.tsx`
   279→- `looksmaxx-app/src/contexts/PhysiqueContext.tsx`
   280→
   281→**Problem:** PSL tab shows height/weight but not body fat % or FFMI breakdown.
   282→
   283→**Implementation:**
   284→1. Import physique context in PSLTab
   285→2. If physique analysis available, show:
   286→   - Body Fat %: X% (category)
   287→   - FFMI: X.X (rating/10)
   288→   - Muscle Level: Low/Moderate/High
   289→3. Update formula display to show actual body score (not just "5/10 default")
   290→4. Add section explaining body score calculation
   291→5. If no physique data, show prompt to add physique photos
   292→
   293→**E2E Test After Implementation:**
   294→- View PSL tab with physique data → shows body fat %, FFMI, muscle level
   295→- View PSL tab without physique data → shows "Add physique photos" prompt
   296→- Verify body score in breakdown matches FFMI rating
   297→- Verify formula explanation updates when body data present
   298→- Click "Add physique photos" → navigates to /physique
   299→- Verify styling matches existing height/weight cards
   300→
   301→**Fix any bugs found, re-test until passing, then proceed to 4.4**
   302→
   303→---
   304→
   305→## Feature 4.4: PSL Preview on Overview Tab
   306→
   307→**Files:**
   308→- `looksmaxx-app/src/components/results/tabs/OverviewTab.tsx`
   309→
   310→**Problem:** PSL only visible in dedicated tab. Users don't see it on main Overview.
   311→
   312→**Implementation:**
   313→1. Add PSL score card widget to Overview tab:
   314→   ```tsx
   315→   <PSLPreviewCard
   316→     score={pslResult.score}
   317→     tier={pslResult.tier}
   318→     tierColor={pslResult.tierColor}
   319→     onClick={() => setActiveTab('psl')}
   320→   />
   321→   ```
   322→2. Show compact view with:
   323→   - PSL score (large number)
   324→   - Tier badge
   325→   - "View Details →" link
   326→3. Position near harmony score or in grid layout
   327→4. Handle case where height not entered (show "Enter height for PSL")
   328→
   329→**E2E Test After Implementation:**
   330→- View Overview with height entered → PSL preview card visible
   331→- Click PSL preview card → navigates to PSL tab
   332→- View Overview without height → shows "Enter height" prompt
   333→- PSL preview updates when underlying data changes
   334→- Verify tier badge color matches PSL tab
   335→- Mobile responsive layout (card stacks properly)
   336→
   337→**Fix any bugs found, re-test until passing**
   338→
   339→---
   340→
   341→## Sprint 4 Complete Checklist
   342→- [x] 4.1 FFMI calculator implemented and accurate
   343→- [x] 4.2 PSL calculation uses real body score when available
   344→- [x] 4.3 PSL tab displays body composition breakdown
   345→- [x] 4.4 Overview tab shows PSL preview card
   346→- [x] Backward compatible (works without body data)
   347→- [x] All calculations match expected formulas
   348→- [x] Ready for Sprint 5
   349→
   350→### Sprint 4 Implementation Notes (2025-12-25)
   351→
   352→**Files Created:**
   353→- `src/lib/ffmi-calculator.ts` - FFMI calculation with rating scale and categories
   354→
   355→**Files Modified:**
   356→- `src/types/psl.ts` - Added FFMIData, BodyScoreInfo, weightKg to BodyAnalysis/PSLInput
   357→- `src/lib/psl-calculator.ts` - Added calculateBodyScore(), getBodyRatingFromFFMI(), FFMI integration
   358→- `src/components/results/tabs/PSLTab.tsx` - Added BodyCompositionCard, AddPhysiquePrompt, updated formula explainer
   359→- `src/components/results/tabs/OverviewTab.tsx` - Added PSLPreviewCard component
   360→
   361→**E2E Test Results:** 27/27 tests passed
   362→- FFMI calculator: 11 tests
   363→- PSL + FFMI integration: 9 tests
   364→- Body score calculation: 5 tests
   365→- Tier color: 2 tests
   366→
   367→---
   368→
   369→# Sprint 5: Archetype → Forum Integration
   370→
   371→## Process
   372→For each feature: Implement → E2E Test → Identify Bugs → Fix → Re-test → Pass → Next Feature
   373→
   374→---
   375→
   376→## Feature 5.1: Archetype-to-Forum Mapping (Backend)
   377→
   378→**Files:**
   379→- `looksmaxx-api/migrations/005_add_archetype_forum_mapping.sql` (new)
   380→- `looksmaxx-api/app/routers/forum.py`
   381→
   382→**Problem:** Forum recommends categories based on flaws only. Archetype has no forum connection.
   383→
   384→**Implementation:**
   385→1. Create `archetype_forum_mappings` table:
   386→   ```sql
   387→   CREATE TABLE archetype_forum_mappings (
   388→       id UUID PRIMARY KEY,
   389→       archetype_category VARCHAR(50) NOT NULL,  -- "Softboy", "Chad", etc.
   390→       forum_category_id UUID REFERENCES forum_issue_categories(id),
   391→       priority INTEGER DEFAULT 0,
   392→       reason TEXT  -- "Style tips for masculine frames"
   393→   );
   394→   ```
   395→2. Seed mappings:
   396→   - Softboy → Fashion (styling for softer features)
   397→   - Prettyboy → Fashion, Poor Skin (grooming emphasis)
   398→   - Chad → Body Composition (frame building)
   399→   - Hypermasculine → Body Composition, Height/Frame
   400→   - Exotic → Fashion (unique styling opportunities)
   401→3. Create `GET /forum/archetype-recommendations?archetype=Chad` endpoint
   402→
   403→**E2E Test After Implementation:**
   404→- `GET /forum/archetype-recommendations?archetype=Softboy` → returns Fashion category
   405→- `GET /forum/archetype-recommendations?archetype=Chad` → returns Body Composition
   406→- `GET /forum/archetype-recommendations?archetype=InvalidType` → returns empty array
   407→- Verify response includes category details (name, slug, description)
   408→- Verify priority ordering works (higher priority first)
   409→- Run migration on fresh database → no errors
   410→
   411→**Fix any bugs found, re-test until passing, then proceed to 5.2**
   412→
   413→---
   414→
   415→## Feature 5.2: Frontend Archetype Forum Integration
   416→
   417→**Files:**
   418→- `looksmaxx-app/src/lib/api.ts`
   419→- `looksmaxx-app/src/components/results/tabs/CommunityTab.tsx`
   420→
   421→**Problem:** Community tab shows flaw-based recommendations but ignores archetype.
   422→
   423→**Implementation:**
   424→1. Add API method:
   425→   ```typescript
   426→   getArchetypeForumRecommendations(archetype: string): Promise<RecommendedForum[]>
   427→   ```
   428→2. Update CommunityTab to:
   429→   - Get user's archetype from ArchetypeContext or classify from ratios
   430→   - Fetch archetype-based recommendations
   431→   - Display in new "Based on Your Archetype" section
   432→3. Show archetype name and why forums are recommended
   433→4. Combine with flaw-based recommendations (don't replace)
   434→
   435→**E2E Test After Implementation:**
   436→- View Community tab with archetype classified → "Based on Your Archetype" section visible
   437→- Softboy archetype → shows Fashion forum recommendation
   438→- Chad archetype → shows Body Composition forum recommendation
   439→- Click recommended forum → navigates to forum page
   440→- Flaw-based recommendations still appear separately
   441→- No archetype (classification failed) → section hidden gracefully
   442→- Verify no duplicate recommendations (if same forum in both flaw + archetype)
   443→
   444→**Fix any bugs found, re-test until passing, then proceed to 5.3**
   445→
   446→---
   447→
   448→## Feature 5.3: Archetype Tab Forum Link
   449→
   450→**Files:**
   451→- `looksmaxx-app/src/components/results/tabs/ArchetypeTab.tsx`
   452→
   453→**Problem:** Archetype tab has no connection to actionable forum content.
   454→
   455→**Implementation:**
   456→1. Add "Recommended Forums" section at bottom of ArchetypeTab:
   457→   ```tsx
   458→   <RecommendedForumsSection archetype={classification.primary.category} />
   459→   ```
   460→2. Show 2-3 relevant forums with:
   461→   - Category icon and name
   462→   - "Why this is relevant" explanation
   463→   - Link to forum category page
   464→3. Style consistently with StyleRecommendations section
   465→
   466→**E2E Test After Implementation:**
   467→- View Archetype tab → Recommended Forums section visible
   468→- Forums shown match user's primary archetype
   469→- Click forum link → navigates to correct forum page
   470→- Section shows explanation text (not just links)
   471→- If no recommendations for archetype → section hidden
   472→- Mobile layout responsive
   473→
   474→**Fix any bugs found, re-test until passing**
   475→
   476→---
   477→
   478→## Sprint 5 Complete Checklist
   479→- [ ] 5.1 Archetype-to-forum mapping table and endpoint
   480→- [ ] 5.2 Community tab shows archetype-based recommendations
   481→- [ ] 5.3 Archetype tab links to relevant forums
   482→- [ ] No duplicate forum recommendations
   483→- [ ] All forum links navigate correctly
   484→- [ ] Graceful fallback when archetype not available
   485→- [ ] Ready for Final E2E Test
   486→
   487→---
   488→
   489→# Sprint 6: Final Comprehensive E2E Test
   490→
   491→## Purpose
   492→All features from Sprints 3-5 complete. Run full end-to-end test of entire PSL + Body + Forum system.
   493→
   494→---
   495→
   496→## Test 1: Complete Onboarding-to-Results Flow
   497→
   498→**Steps:**
   499→1. Start fresh (clear all contexts)
   500→2. Complete signup → gender → ethnicity → height → weight
   501→3. Upload 3 physique photos (front, side, back)
   502→4. Upload 2 face photos (front, side)
   503→5. Verify analysis page shows both face and body analysis steps
   504→6. Wait for analysis completion
   505→7. Verify results page loads with all data
   506→
   507→**Pass Criteria:** All 7 steps succeed, no console errors
   508→
   509→---
   510→
   511→## Test 2: PSL Calculation Accuracy
   512→
   513→**Steps:**
   514→1. Use test data: 180cm height, 80kg weight, 15% body fat, 7.5 face score
   515→2. Calculate expected values:
   516→   - Lean mass: 80 × 0.85 = 68kg
   517→   - FFMI: 68 / (1.8)² = 21.0
   518→   - Normalized FFMI: 21.0 + 6.1 × (1.8 - 1.8) = 21.0
   519→   - FFMI Rating: ~7/10 (Above Average)
   520→   - Height Rating: ~6.5/10 (average male height)
   521→   - PSL = (7.5 × 0.75) + (6.5 × 0.20) + (7.0 × 0.05) = 5.625 + 1.3 + 0.35 = 7.275
   522→3. Verify PSL tab shows matching values
   523→4. Verify Overview PSL preview matches
   524→
   525→**Pass Criteria:** Calculated PSL within 0.1 of expected value
   526→
   527→---
   528→
   529→## Test 3: Skip Physique Flow
   530→
   531→**Steps:**
   532→1. Complete onboarding, SKIP physique photos
   533→2. Complete face photo upload and analysis
   534→3. Verify PSL tab shows body score as 5.0 (default)
   535→4. Verify PSL tab shows "Add physique photos" prompt
   536→5. Verify PSL calculation uses 5.0 body score
   537→
   538→**Pass Criteria:** App functions correctly without physique data
   539→
   540→---
   541→
   542→## Test 4: Archetype → Forum Integration
   543→
   544→**Steps:**
   545→1. Complete analysis (ensure archetype classified)
   546→2. Navigate to Archetype tab → verify "Recommended Forums" section
   547→3. Click forum link → verify navigation to `/forum/[slug]`
   548→4. Navigate to Community tab → verify "Based on Your Archetype" section
   549→5. Verify archetype-based recommendations differ from flaw-based
   550→
   551→**Pass Criteria:** Archetype correctly maps to forum recommendations
   552→
   553→---
   554→
   555→## Test 5: Data Persistence
   556→
   557→**Steps:**
   558→1. Complete full analysis with all data
   559→2. Refresh page
   560→3. Verify face photos restored
   561→4. Verify height/weight restored
   562→5. Verify PSL data restored
   563→6. Navigate through all tabs → no data missing
   564→
   565→**Pass Criteria:** All user data persists across page refresh
   566→
   567→---
   568→
   569→## Test 6: Error Handling
   570→
   571→**Steps:**
   572→1. Upload invalid file type as physique photo → verify error message
   573→2. Disconnect network during body analysis → verify graceful failure
   574→3. Enter extreme height (50cm) → verify validation
   575→4. Enter extreme weight (500kg) → verify validation
   576→5. Analysis with corrupted image → verify error handling
   577→
   578→**Pass Criteria:** All error states handled with user-friendly messages
   579→
   580→---
   581→
   582→## Final Checklist
   583→
   584→| Test | Status |
   585→|------|--------|
   586→| 1. Onboarding-to-Results Flow | ⬜ |
   587→| 2. PSL Calculation Accuracy | ⬜ |
   588→| 3. Skip Physique Flow | ⬜ |
   589→| 4. Archetype → Forum Integration | ⬜ |
   590→| 5. Data Persistence | ⬜ |
   591→| 6. Error Handling | ⬜ |
   592→
   593→## If Any Test Fails
   594→1. Log failure with specific step and error
   595→2. Trace to root cause (file:line)
   596→3. Fix the issue
   597→4. Re-run failed test
   598→5. If pass, continue
   599→6. If fail, repeat fix cycle
   600→
   601→## Completion Criteria
   602→All 6 tests passing = PSL + Body Composition integration complete and verified
   603→
   604→---
   605→
   606→# Quick Reference: New Files Created
   607→
   608→## Backend (looksmaxx-api/)
   609→| File | Purpose |
   610→|------|---------|
   611→| `app/routers/physique.py` | Physique upload, analyze, face extraction |
   612→| `app/models/physique.py` | PhysiqueAnalysis + VisionExtraction models |
   613→| `app/services/vision_service.py` | **NEW** Unified Claude Vision (face + body) |
   614→| `migrations/006_add_physique_tables.sql` | **NEW** Physique + Vision tables |
   615→| `migrations/005_add_archetype_forum_mapping.sql` | Archetype → Forum mapping |
   616→
   617→## Frontend (looksmaxx-app/)
   618→| File | Purpose |
   619→|------|---------|
   620→| `src/lib/ffmi-calculator.ts` | FFMI calculation and rating |
   621→| `src/contexts/PhysiqueContext.tsx` | ✅ Updated with expanded fields |
   622→| `src/app/physique/page.tsx` | ✅ Already exists |
   623→
   624→## Modified Files
   625→| File | Changes |
   626→|------|---------|
   627→| `src/lib/psl-calculator.ts` | Accept body fat, use FFMI rating |
   628→| `src/components/results/tabs/PSLTab.tsx` | Show body composition, uses physiqueAnalysis |
   629→| `src/components/results/tabs/OverviewTab.tsx` | Add PSL preview card |
   630→| `src/components/results/tabs/CommunityTab.tsx` | Archetype recommendations |
   631→| `src/components/results/tabs/ArchetypeTab.tsx` | Forum links section |
   632→| `src/app/analysis/page.tsx` | Fixed isMounted cleanup, physique integration |
   633→| `src/lib/api.ts` | Add physique + face extraction API methods |
   634→
   635→---
   636→
   637→# Sprint 3.5: Expanded Vision Feature Extraction (Completed)
   638→
   639→## Summary
   640→Extended Sprint 3 to include full psl.md spec coverage with comprehensive face feature extraction.
   641→
   642→## New Backend Files
   643→- `app/services/vision_service.py` - Unified Claude Vision service for face + body
   644→- `migrations/006_add_physique_tables.sql` - Database tables for physique + vision
   645→
   646→## Face Feature Extraction (NEW)
   647→| Category | Features |
   648→|----------|----------|
   649→| Skin | clarity (0-10), tone, acne_level, acne_scarring, pore_visibility, texture_issues |
   650→| Hair | hairline_nw (0-7 Norwood), density, texture, color |
   651→| Eyes | color, under_eye_darkness (0-10), under_eye_puffiness (0-10) |
   652→| Facial | hollow_cheeks (0-10), eyebrow_density, facial_hair_potential |
   653→| Teeth | color, alignment, visible |
   654→
   655→## Body Feature Extraction (Enhanced)
   656→| Feature | Values |
   657→|---------|--------|
   658→| body_fat_percent | 5-45% |
   659→| muscle_mass | low/medium/medium-high/high/very-high |
   660→| frame_size | small/medium/large/very-large |
   661→| shoulder_width | narrow/average/broad/very-broad |
   662→| waist_definition | undefined/slight/defined/very-defined |
   663→| posture | poor/fair/good/excellent |
   664→
   665→## New API Endpoints
   666→- `POST /physique/extract-face` - Extract all facial features from photos
   667→- `GET /physique/my-face-features` - Get stored face extraction
   668→
   669→## E2E Testing Results (11 Bugs Found & Fixed)
   670→
   671→### Backend Bugs
   672→| Bug | File | Fix |
   673→|-----|------|-----|
   674→| Missing migration | - | Created `006_add_physique_tables.sql` |
   675→| Missing ANTHROPIC_API_KEY | `.env.example` | Added to example file |
   676→| hairline_nw type mismatch | `physique.py` model | Changed Float → Integer |
   677→| weight_kg missing | `005_*.sql` | Added ALTER TABLE |
   678→| File size validation | `physique.py` router | Made async with size check |
   679→
   680→### Frontend Bugs
   681→| Bug | File | Fix |
   682→|-----|------|-----|
   683→| Empty sideLandmarks | `analysis/page.tsx` | Pass actual state to navigateToResults |
   684→| PSLTab not using physique | `PSLTab.tsx` | Added usePhysiqueOptional hook |
   685→| Missing useEffect cleanup | `analysis/page.tsx` | Added isMounted flag |
   686→| No localStorage persistence | `PhysiqueContext.tsx` | Added hydration + persistence |
   687→
   688→## Sprint 3.5 Complete Checklist
   689→- [x] Vision service covers full psl.md spec
   690→- [x] Face extraction endpoint working
   691→- [x] Body extraction enhanced with all fields
   692→- [x] E2E tests passed (11 bugs fixed)
   693→- [x] Type checks pass
   694→- [x] Lint checks pass
   695→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
