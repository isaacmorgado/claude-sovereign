     1→'use client';
     2→
     3→import { useState, useEffect, useCallback } from 'react';
     4→import Link from 'next/link';
     5→import { MessageSquare, Share2, Bookmark, BookmarkCheck, MoreHorizontal, Pin, Sparkles, Check, Flag, Loader2 } from 'lucide-react';
     6→import { PostListItem, VoteType } from '@/types/forum';
     7→import { formatDistanceToNow } from '@/lib/utils';
     8→import { VoteButtons } from './VoteButtons';
     9→import { api } from '@/lib/api';
    10→import { useBookmarks } from '@/contexts/ForumContext';
    11→
    12→interface PostCardProps {
    13→  post: PostListItem;
    14→  onVote?: (postId: string, voteType: VoteType) => void;
    15→  showSubForum?: boolean;
    16→  onReport?: (postId: string) => void;
    17→}
    18→
    19→export function PostCard({ post, onVote, showSubForum = false, onReport }: PostCardProps) {
    20→  const bookmarkContext = useBookmarks();
    21→  const [localIsSaved, setLocalIsSaved] = useState(false);
    22→  const [isBookmarking, setIsBookmarking] = useState(false);
    23→  const [copied, setCopied] = useState(false);
    24→  const [showMenu, setShowMenu] = useState(false);
    25→
    26→  // Determine if bookmarked based on context or local state
    27→  const isSaved = bookmarkContext
    28→    ? bookmarkContext.isBookmarked(post.id)
    29→    : localIsSaved;
    30→
    31→  // Fetch bookmark status on mount if not using global context
    32→  useEffect(() => {
    33→    if (!bookmarkContext) {
    34→      // Only fetch if user is logged in (token exists)
    35→      const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null;
    36→      if (token) {
    37→        api.getBookmarkStatus(post.id)
    38→          .then(status => setLocalIsSaved(status.isBookmarked))
    39→          .catch(() => setLocalIsSaved(false));
    40→      }
    41→    }
    42→  }, [post.id, bookmarkContext]);
    43→
    44→  const handleShare = async () => {
    45→    const url = `${window.location.origin}/forum/post/${post.id}`;
    46→    try {
    47→      await navigator.clipboard.writeText(url);
    48→      setCopied(true);
    49→      setTimeout(() => setCopied(false), 2000);
    50→    } catch {
    51→      // Fallback for older browsers
    52→      const input = document.createElement('input');
    53→      input.value = url;
    54→      document.body.appendChild(input);
    55→      input.select();
    56→      document.execCommand('copy');
    57→      document.body.removeChild(input);
    58→      setCopied(true);
    59→      setTimeout(() => setCopied(false), 2000);
    60→    }
    61→  };
    62→
    63→  const handleSave = useCallback(async () => {
    64→    // Check if user is logged in
    65→    const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null;
    66→    if (!token) {
    67→      // Redirect to login if not authenticated
    68→      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
    69→      return;
    70→    }
    71→
    72→    setIsBookmarking(true);
    73→    try {
    74→      if (bookmarkContext) {
    75→        // Use global context
    76→        await bookmarkContext.toggleBookmark(post.id);
    77→      } else {
    78→        // Use local state with direct API call
    79→        const result = await api.toggleBookmark(post.id);
    80→        setLocalIsSaved(result.isBookmarked);
    81→      }
    82→    } catch (err) {
    83→      console.error('Failed to toggle bookmark:', err);
    84→    } finally {
    85→      setIsBookmarking(false);
    86→    }
    87→  }, [post.id, bookmarkContext]);
    88→
    89→  const handleReport = () => {
    90→    setShowMenu(false);
    91→    onReport?.(post.id);
    92→  };
    93→
    94→  return (
    95→    <article className="group relative rounded-2xl bg-neutral-900/30 border border-white/5 hover:border-cyan-500/20 transition-all overflow-hidden">
    96→      <div className="flex">
    97→        {/* Vote column */}
    98→        <div className="w-12 bg-neutral-900/50 border-r border-white/5 flex flex-col items-center py-4">
    99→          <VoteButtons
   100→            voteCount={post.voteCount}
   101→            userVote={post.userVote}
   102→            onVote={(voteType) => onVote?.(post.id, voteType)}
   103→            size="sm"
   104→          />
   105→        </div>
   106→
   107→        {/* Content */}
   108→        <div className="flex-1 p-4 min-w-0">
   109→          {/* Meta line */}
   110→          <div className="flex items-center flex-wrap gap-2 mb-3">
   111→            {post.isPinned && (
   112→              <span className="flex items-center gap-1 px-2 py-0.5 rounded-md bg-cyan-500/10 border border-cyan-500/20 text-[9px] font-black uppercase tracking-wider text-cyan-400">
   113→                <Pin size={10} />
   114→                Pinned
   115→              </span>
   116→            )}
   117→            {post.isGuide && (
   118→              <span className="flex items-center gap-1 px-2 py-0.5 rounded-md bg-green-500/10 border border-green-500/20 text-[9px] font-black uppercase tracking-wider text-green-400">
   119→                <Sparkles size={10} />
   120→                Guide
   121→              </span>
   122→            )}
   123→            {showSubForum && (
   124→              <Link
   125→                href={`/forum/${post.categorySlug}`}
   126→                className="text-[10px] font-black uppercase tracking-widest text-cyan-400 hover:text-cyan-300"
   127→              >
   128→                {post.subForumSlug}
   129→              </Link>
   130→            )}
   131→            <span className="text-[10px] font-medium text-neutral-600">
   132→              by{' '}
   133→              <Link
   134→                href={`/forum/user/${post.author.id}`}
   135→                className="text-neutral-400 hover:text-cyan-400 transition-colors"
   136→              >
   137→                u/{post.author.username}
   138→              </Link>
   139→            </span>
   140→            <span className="text-[10px] text-neutral-700">-</span>
   141→            <span className="text-[10px] text-neutral-600">{formatDistanceToNow(post.createdAt)}</span>
   142→          </div>
   143→
   144→          {/* Title */}
   145→          <Link href={`/forum/post/${post.id}`}>
   146→            <h3 className="text-base font-bold text-white group-hover:text-cyan-400 transition-colors leading-snug mb-2">
   147→              {post.title}
   148→            </h3>
   149→          </Link>
   150→
   151→          {/* Preview text */}
   152→          {post.contentPreview && (
   153→            <p className="text-neutral-500 text-sm line-clamp-2 mb-4 leading-relaxed">
   154→              {post.contentPreview}
   155→            </p>
   156→          )}
   157→
   158→          {/* Action bar */}
   159→          <div className="flex items-center gap-1">
   160→            <Link
   161→              href={`/forum/post/${post.id}`}
   162→              className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider text-neutral-500 hover:bg-white/5 hover:text-cyan-400 transition-all"
   163→            >
   164→              <MessageSquare size={14} />
   165→              <span>{post.commentCount} Comments</span>
   166→            </Link>
   167→            <button
   168→              onClick={handleShare}
   169→              className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${
   170→                copied
   171→                  ? 'text-emerald-400 bg-emerald-500/10'
   172→                  : 'text-neutral-500 hover:bg-white/5 hover:text-white'
   173→              }`}
   174→            >
   175→              {copied ? <Check size={14} /> : <Share2 size={14} />}
   176→              <span className="hidden sm:inline">{copied ? 'Copied!' : 'Share'}</span>
   177→            </button>
   178→            <button
   179→              onClick={handleSave}
   180→              disabled={isBookmarking}
   181→              className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all disabled:opacity-50 ${
   182→                isSaved
   183→                  ? 'text-cyan-400 bg-cyan-500/10'
   184→                  : 'text-neutral-500 hover:bg-white/5 hover:text-white'
   185→              }`}
   186→            >
   187→              {isBookmarking ? (
   188→                <Loader2 size={14} className="animate-spin" />
   189→              ) : isSaved ? (
   190→                <BookmarkCheck size={14} />
   191→              ) : (
   192→                <Bookmark size={14} />
   193→              )}
   194→              <span className="hidden sm:inline">{isSaved ? 'Saved' : 'Save'}</span>
   195→            </button>
   196→            <div className="relative">
   197→              <button
   198→                onClick={() => setShowMenu(!showMenu)}
   199→                className="flex items-center gap-2 p-1.5 rounded-lg text-neutral-500 hover:bg-white/5 hover:text-white transition-all"
   200→              >
   201→                <MoreHorizontal size={14} />
   202→              </button>
   203→              {showMenu && (
   204→                <>
   205→                  <div
   206→                    className="fixed inset-0 z-40"
   207→                    onClick={() => setShowMenu(false)}
   208→                  />
   209→                  <div className="absolute right-0 top-full mt-1 z-50 min-w-[140px] rounded-xl bg-neutral-900 border border-white/10 shadow-xl overflow-hidden">
   210→                    <button
   211→                      onClick={handleReport}
   212→                      className="w-full flex items-center gap-2 px-4 py-2.5 text-[10px] font-black uppercase tracking-wider text-neutral-400 hover:bg-white/5 hover:text-red-400 transition-all"
   213→                    >
   214→                      <Flag size={12} />
   215→                      Report
   216→                    </button>
   217→                  </div>
   218→                </>
   219→              )}
   220→            </div>
   221→          </div>
   222→        </div>
   223→      </div>
   224→    </article>
   225→  );
   226→}
   227→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
