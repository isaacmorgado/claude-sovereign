     1→'use client';
     2→
     3→import { motion } from 'framer-motion';
     4→import Image from 'next/image';
     5→import { User, ScanFace, Sparkles, ChevronRight, TrendingUp, TrendingDown, Lightbulb, Ruler } from 'lucide-react';
     6→import { useResults } from '@/contexts/ResultsContext';
     7→import { useHeightOptional } from '@/contexts/HeightContext';
     8→import { TabContent } from '../ResultsLayout';
     9→import { ScoreBar, AnimatedScore, ShareButton, ExportButton } from '../shared';
    10→import { KeyStrengthsSection, AreasOfImprovementSection } from '../cards/KeyStrengthsFlaws';
    11→import { FacialRadarChart } from '../visualization/FacialRadarChart';
    12→import { RatioDetailModal } from '../modals/RatioDetailModal';
    13→import { getScoreColor, ResponsibleRatio, Ratio } from '@/types/results';
    14→import { MetricScoreResult } from '@/lib/harmony-scoring';
    15→import { RankedMetric, getWeightTierColor } from '@/lib/looksmax-scoring';
    16→import { calculatePSL, getTierColor } from '@/lib/psl-calculator';
    17→import { useState, useCallback, useMemo } from 'react';
    18→
    19→// ============================================
    20→// SCORE SUMMARY CARDS
    21→// ============================================
    22→
    23→interface ProfileScoreCardProps {
    24→  title: string;
    25→  score: number;
    26→  icon: React.ReactNode;
    27→  photo?: string;
    28→  ratioCount: number;
    29→  onClick?: () => void;
    30→}
    31→
    32→function ProfileScoreCard({ title, score, icon, photo, ratioCount, onClick }: ProfileScoreCardProps) {
    33→  const color = getScoreColor(score);
    34→
    35→  return (
    36→    <motion.button
    37→      onClick={onClick}
    38→      className="bg-neutral-900/80 border border-neutral-800 rounded-xl p-4 hover:border-neutral-700 transition-all text-left w-full"
    39→      whileHover={{ scale: 1.02 }}
    40→      whileTap={{ scale: 0.98 }}
    41→    >
    42→      <div className="flex items-center gap-4">
    43→        {/* Photo or icon */}
    44→        <div className="relative w-16 h-16 rounded-lg overflow-hidden bg-neutral-800 flex-shrink-0">
    45→          {photo ? (
    46→            <Image
    47→              src={photo}
    48→              alt={title}
    49→              width={64}
    50→              height={64}
    51→              className="object-cover"
    52→              unoptimized
    53→            />
    54→          ) : (
    55→            <div className="w-full h-full flex items-center justify-center">
    56→              {icon}
    57→            </div>
    58→          )}
    59→        </div>
    60→
    61→        {/* Info */}
    62→        <div className="flex-1">
    63→          <h3 className="text-sm font-medium text-neutral-400 mb-1">{title}</h3>
    64→          <div className="flex items-baseline gap-2">
    65→            <span className="text-2xl font-bold" style={{ color }}>
    66→              {score.toFixed(2)}
    67→            </span>
    68→            <span className="text-sm text-neutral-500">/ 10</span>
    69→          </div>
    70→          <p className="text-xs text-neutral-500 mt-1">{ratioCount} measurements</p>
    71→        </div>
    72→
    73→        {/* Arrow */}
    74→        <ChevronRight size={20} className="text-neutral-600" />
    75→      </div>
    76→
    77→      {/* Score bar */}
    78→      <div className="mt-3">
    79→        <ScoreBar score={score} height={6} />
    80→      </div>
    81→    </motion.button>
    82→  );
    83→}
    84→
    85→// ============================================
    86→// PSL PREVIEW CARD
    87→// ============================================
    88→
    89→interface PSLPreviewCardProps {
    90→  score: number;
    91→  tier: string;
    92→  tierColor: string;
    93→  hasHeight: boolean;
    94→  onClick: () => void;
    95→}
    96→
    97→function PSLPreviewCard({ score, tier, tierColor, hasHeight, onClick }: PSLPreviewCardProps) {
    98→  if (!hasHeight) {
    99→    // Prompt to enter height
   100→    return (
   101→      <motion.button
   102→        onClick={onClick}
   103→        className="bg-neutral-900/80 border border-dashed border-neutral-700 rounded-xl p-4 hover:border-cyan-500/50 transition-all text-left w-full"
   104→        whileHover={{ scale: 1.02 }}
   105→        whileTap={{ scale: 0.98 }}
   106→      >
   107→        <div className="flex items-center gap-4">
   108→          <div className="w-14 h-14 rounded-lg bg-cyan-500/20 flex items-center justify-center flex-shrink-0">
   109→            <Ruler size={24} className="text-cyan-400" />
   110→          </div>
   111→          <div className="flex-1">
   112→            <h3 className="text-sm font-medium text-white mb-1">Get Your PSL Rating</h3>
   113→            <p className="text-xs text-neutral-400">Enter your height to calculate your Pretty Scale Level score</p>
   114→          </div>
   115→          <ChevronRight size={20} className="text-cyan-400" />
   116→        </div>
   117→      </motion.button>
   118→    );
   119→  }
   120→
   121→  return (
   122→    <motion.button
   123→      onClick={onClick}
   124→      className="bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-xl p-4 hover:border-cyan-500/30 transition-all text-left w-full"
   125→      whileHover={{ scale: 1.02 }}
   126→      whileTap={{ scale: 0.98 }}
   127→    >
   128→      <div className="flex items-center gap-4">
   129→        {/* PSL Score */}
   130→        <div className="w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0" style={{ backgroundColor: `${tierColor}20` }}>
   131→          <span className="text-2xl font-bold" style={{ color: tierColor }}>
   132→            {score.toFixed(1)}
   133→          </span>
   134→        </div>
   135→
   136→        {/* Info */}
   137→        <div className="flex-1">
   138→          <div className="flex items-center gap-2 mb-1">
   139→            <h3 className="text-sm font-medium text-neutral-400">PSL Rating</h3>
   140→            <span className="text-xs px-2 py-0.5 rounded-full font-medium" style={{ backgroundColor: `${tierColor}20`, color: tierColor }}>
   141→              {tier}
   142→            </span>
   143→          </div>
   144→          <p className="text-xs text-neutral-500">Face (75%) + Height (20%) + Body (5%)</p>
   145→        </div>
   146→
   147→        {/* Arrow */}
   148→        <div className="flex flex-col items-end">
   149→          <span className="text-xs text-neutral-500 mb-1">View Details</span>
   150→          <ChevronRight size={20} className="text-neutral-600" />
   151→        </div>
   152→      </div>
   153→    </motion.button>
   154→  );
   155→}
   156→
   157→// ============================================
   158→// QUICK INSIGHTS - TOP/BOTTOM METRICS WITH ADVICE
   159→// ============================================
   160→
   161→interface MetricInsightCardProps {
   162→  metric: RankedMetric;
   163→  type: 'strength' | 'improvement';
   164→  index: number;
   165→}
   166→
   167→function MetricInsightCard({ metric, type, index }: MetricInsightCardProps) {
   168→  const isStrength = type === 'strength';
   169→  const color = getScoreColor(metric.score);
   170→  const weightTierClass = getWeightTierColor(metric.weightTier);
   171→
   172→  return (
   173→    <motion.div
   174→      className={`bg-neutral-900/80 border rounded-xl p-4 ${
   175→        isStrength ? 'border-green-500/30' : 'border-orange-500/30'
   176→      }`}
   177→      initial={{ opacity: 0, x: isStrength ? -20 : 20 }}
   178→      animate={{ opacity: 1, x: 0 }}
   179→      transition={{ delay: 0.1 * index }}
   180→    >
   181→      <div className="flex items-start gap-3">
   182→        <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
   183→          isStrength ? 'bg-green-500/20' : 'bg-orange-500/20'
   184→        }`}>
   185→          {isStrength ? (
   186→            <TrendingUp size={16} className="text-green-400" />
   187→          ) : (
   188→            <TrendingDown size={16} className="text-orange-400" />
   189→          )}
   190→        </div>
   191→
   192→        <div className="flex-1 min-w-0">
   193→          <div className="flex items-center gap-2 mb-1">
   194→            <h4 className="font-medium text-white text-sm truncate">{metric.name}</h4>
   195→            <span className={`text-xs px-1.5 py-0.5 rounded border ${weightTierClass}`}>
   196→              {metric.weightTier === 'high' ? '3x' : metric.weightTier === 'medium' ? '2x' : '1x'}
   197→            </span>
   198→          </div>
   199→
   200→          <div className="flex items-center gap-3 mb-2">
   201→            <span className="text-lg font-bold" style={{ color }}>
   202→              {metric.score.toFixed(1)}
   203→            </span>
   204→            <span className="text-xs text-neutral-500">
   205→              Ideal: {metric.idealMin.toFixed(1)} - {metric.idealMax.toFixed(1)}
   206→            </span>
   207→          </div>
   208→
   209→          {/* Advice */}
   210→          <div className="flex items-start gap-2 mt-2 p-2 bg-neutral-800/50 rounded-lg">
   211→            <Lightbulb size={14} className={isStrength ? 'text-green-400 mt-0.5' : 'text-orange-400 mt-0.5'} />
   212→            <p className="text-xs text-neutral-300 leading-relaxed">{metric.advice}</p>
   213→          </div>
   214→        </div>
   215→      </div>
   216→    </motion.div>
   217→  );
   218→}
   219→
   220→interface QuickInsightsSectionProps {
   221→  topMetrics: RankedMetric[];
   222→  bottomMetrics: RankedMetric[];
   223→}
   224→
   225→function QuickInsightsSection({ topMetrics, bottomMetrics }: QuickInsightsSectionProps) {
   226→  if (topMetrics.length === 0 && bottomMetrics.length === 0) return null;
   227→
   228→  return (
   229→    <div className="mb-8">
   230→      <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
   231→        <Lightbulb size={20} className="text-cyan-400" />
   232→        Quick Insights
   233→      </h3>
   234→
   235→      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
   236→        {/* Top 3 Strengths */}
   237→        <div>
   238→          <h4 className="text-sm font-medium text-green-400 mb-3 flex items-center gap-2">
   239→            <TrendingUp size={14} />
   240→            Top Strengths
   241→          </h4>
   242→          <div className="space-y-3">
   243→            {topMetrics.map((metric, index) => (
   244→              <MetricInsightCard
   245→                key={metric.metricId}
   246→                metric={metric}
   247→                type="strength"
   248→                index={index}
   249→              />
   250→            ))}
   251→          </div>
   252→        </div>
   253→
   254→        {/* Bottom 3 - Areas to Improve */}
   255→        <div>
   256→          <h4 className="text-sm font-medium text-orange-400 mb-3 flex items-center gap-2">
   257→            <TrendingDown size={14} />
   258→            Areas to Improve
   259→          </h4>
   260→          <div className="space-y-3">
   261→            {bottomMetrics.map((metric, index) => (
   262→              <MetricInsightCard
   263→                key={metric.metricId}
   264→                metric={metric}
   265→                type="improvement"
   266→                index={index}
   267→              />
   268→            ))}
   269→          </div>
   270→        </div>
   271→      </div>
   272→    </div>
   273→  );
   274→}
   275→
   276→// ============================================
   277→// HARMONY SCORE DISPLAY (with AnimatedScore and Radar Chart)
   278→// ============================================
   279→
   280→function HarmonyScoreDisplay() {
   281→  const { overallScore, frontScore, sideScore, harmonyPercentage, harmonyScoreResult, pslRating } = useResults();
   282→  const [showRadar, setShowRadar] = useState(true);
   283→
   284→  // Get tier color based on PSL
   285→  const getTierColor = (psl: number) => {
   286→    // Handle invalid PSL values
   287→    if (typeof psl !== 'number' || !Number.isFinite(psl)) {
   288→      return 'text-orange-400';
   289→    }
   290→    if (psl >= 7.0) return 'text-purple-400';
   291→    if (psl >= 6.0) return 'text-cyan-400';
   292→    if (psl >= 5.0) return 'text-green-400';
   293→    if (psl >= 4.0) return 'text-yellow-400';
   294→    return 'text-orange-400';
   295→  };
   296→
   297→  // Safe values for display with fallbacks
   298→  const safePslRating = useMemo(() => ({
   299→    psl: typeof pslRating?.psl === 'number' && Number.isFinite(pslRating.psl) ? pslRating.psl : 3.0,
   300→    tier: pslRating?.tier || 'Unknown',
   301→    percentile: typeof pslRating?.percentile === 'number' && Number.isFinite(pslRating.percentile) ? pslRating.percentile : 50,
   302→    description: pslRating?.description || 'Analysis pending',
   303→  }), [pslRating]);
   304→
   305→  const safeHarmonyPercentage = typeof harmonyPercentage === 'number' && Number.isFinite(harmonyPercentage)
   306→    ? harmonyPercentage
   307→    : 0;
   308→
   309→  const safeFrontScore = typeof frontScore === 'number' && Number.isFinite(frontScore) ? frontScore : 0;
   310→  const safeSideScore = typeof sideScore === 'number' && Number.isFinite(sideScore) ? sideScore : 0;
   311→  const safeOverallScore = typeof overallScore === 'number' && Number.isFinite(overallScore) ? overallScore : 0;
   312→
   313→  return (
   314→    <motion.div
   315→      className="bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6 md:p-8"
   316→      initial={{ opacity: 0, y: 20 }}
   317→      animate={{ opacity: 1, y: 0 }}
   318→      transition={{ duration: 0.5 }}
   319→    >
   320→      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
   321→        {/* Left: Score Display */}
   322→        <div className="text-center flex flex-col justify-center">
   323→          <h2 className="text-lg font-medium text-neutral-400 mb-2">Weighted Harmony Score</h2>
   324→
   325→          {/* PSL Rating Badge */}
   326→          <motion.div
   327→            className="flex justify-center mb-3"
   328→            initial={{ scale: 0 }}
   329→            animate={{ scale: 1 }}
   330→            transition={{ delay: 0.2, type: 'spring' }}
   331→          >
   332→            <div className="px-5 py-2 bg-gradient-to-r from-neutral-800 to-neutral-900 border border-neutral-700 rounded-xl">
   333→              <div className="flex items-center gap-3">
   334→                <div className="text-center">
   335→                  <span className={`text-3xl font-bold ${getTierColor(safePslRating.psl)}`}>
   336→                    {safePslRating.psl.toFixed(1)}
   337→                  </span>
   338→                  <span className="text-sm text-neutral-500 ml-1">PSL</span>
   339→                </div>
   340→                <div className="h-8 w-px bg-neutral-700" />
   341→                <div className="text-left">
   342→                  <p className={`text-sm font-semibold ${getTierColor(safePslRating.psl)}`}>
   343→                    {safePslRating.tier}
   344→                  </p>
   345→                  <p className="text-xs text-neutral-500">
   346→                    Top {(100 - safePslRating.percentile).toFixed(1)}%
   347→                  </p>
   348→                </div>
   349→              </div>
   350→            </div>
   351→          </motion.div>
   352→
   353→          {/* Harmony Percentage Badge */}
   354→          <motion.div
   355→            className="flex justify-center mb-4"
   356→            initial={{ scale: 0 }}
   357→            animate={{ scale: 1 }}
   358→            transition={{ delay: 0.3, type: 'spring' }}
   359→          >
   360→            <div className="px-4 py-1 bg-gradient-to-r from-purple-500/20 to-cyan-500/20 border border-purple-500/30 rounded-full">
   361→              <span className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">
   362→                {safeHarmonyPercentage.toFixed(1)}%
   363→              </span>
   364→              <span className="text-xs text-neutral-500 ml-2">Harmony</span>
   365→            </div>
   366→          </motion.div>
   367→
   368→          {/* Animated Score */}
   369→          <div className="flex justify-center mb-4">
   370→            <AnimatedScore
   371→              score={safeOverallScore}
   372→              duration={2.5}
   373→              delay={0.5}
   374→              showConfetti={true}
   375→              confettiThreshold={7.5}
   376→            />
   377→          </div>
   378→
   379→          {/* Profile Breakdowns */}
   380→          <div className="flex justify-center gap-8 mb-4">
   381→            <div className="text-center">
   382→              <p className="text-xs text-neutral-500 mb-1">Front Profile</p>
   383→              <p className="text-xl font-bold" style={{ color: getScoreColor(safeFrontScore) }}>
   384→                {safeFrontScore.toFixed(2)}
   385→              </p>
   386→            </div>
   387→            <div className="w-px bg-neutral-800" />
   388→            <div className="text-center">
   389→              <p className="text-xs text-neutral-500 mb-1">Side Profile</p>
   390→              <p className="text-xl font-bold" style={{ color: getScoreColor(safeSideScore) }}>
   391→                {safeSideScore.toFixed(2)}
   392→              </p>
   393→            </div>
   394→          </div>
   395→
   396→          {/* Weight Distribution */}
   397→          {harmonyScoreResult && (
   398→            <div className="flex justify-center gap-3 mb-4 text-xs">
   399→              <span className="px-2 py-1 rounded bg-purple-500/20 text-purple-400 border border-purple-500/30">
   400→                High Impact: {harmonyScoreResult.weightDistribution.highImpact.count}
   401→              </span>
   402→              <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30">
   403→                Medium: {harmonyScoreResult.weightDistribution.mediumImpact.count}
   404→              </span>
   405→              <span className="px-2 py-1 rounded bg-gray-500/20 text-gray-400 border border-gray-500/30">
   406→                Standard: {harmonyScoreResult.weightDistribution.standard.count}
   407→              </span>
   408→            </div>
   409→          )}
   410→
   411→          <p className="text-sm text-neutral-400 max-w-md mx-auto">
   412→            {safeHarmonyPercentage >= 80 ? 'Exceptional facial harmony. Your features are well-balanced and proportioned.' :
   413→              safeHarmonyPercentage >= 60 ? 'Good facial harmony with some areas that could be optimized.' :
   414→                safeHarmonyPercentage >= 40 ? 'Average facial harmony. Several areas have room for improvement.' :
   415→                  'Below average facial harmony. Multiple areas could benefit from attention.'}
   416→          </p>
   417→        </div>
   418→
   419→        {/* Right: Radar Chart */}
   420→        <div className="flex flex-col">
   421→          <div className="flex items-center justify-between mb-2">
   422→            <h3 className="text-sm font-medium text-neutral-400">Category Breakdown</h3>
   423→            <button
   424→              onClick={() => setShowRadar(!showRadar)}
   425→              className="text-xs text-cyan-400 hover:text-cyan-300 transition-colors"
   426→            >
   427→              {showRadar ? 'Hide' : 'Show'}
   428→            </button>
   429→          </div>
   430→          {showRadar && (
   431→            <motion.div
   432→              initial={{ opacity: 0, scale: 0.95 }}
   433→              animate={{ opacity: 1, scale: 1 }}
   434→              transition={{ duration: 0.5, delay: 0.3 }}
   435→              className="flex-1 min-h-[280px]"
   436→            >
   437→              <FacialRadarChart height={280} />
   438→            </motion.div>
   439→          )}
   440→        </div>
   441→      </div>
   442→    </motion.div>
   443→  );
   444→}
   445→
   446→// ============================================
   447→// OVERVIEW TAB
   448→// ============================================
   449→
   450→export function OverviewTab() {
   451→  const {
   452→    overallScore,
   453→    frontScore,
   454→    sideScore,
   455→    frontRatios,
   456→    sideRatios,
   457→    strengths,
   458→    flaws,
   459→    frontPhoto,
   460→    sidePhoto,
   461→    frontLandmarks,
   462→    sideLandmarks,
   463→    gender,
   464→    ethnicity,
   465→    setActiveTab,
   466→    topMetrics,
   467→    bottomMetrics,
   468→    setSelectedVisualizationMetric,
   469→  } = useResults();
   470→
   471→  const heightContext = useHeightOptional();
   472→  const [selectedRatio, setSelectedRatio] = useState<MetricScoreResult | null>(null);
   473→  const [isModalOpen, setIsModalOpen] = useState(false);
   474→
   475→  // Calculate PSL for the preview card
   476→  const pslPreviewData = useMemo(() => {
   477→    const heightCm = heightContext?.heightCm;
   478→    if (!heightCm || !overallScore) {
   479→      return { hasHeight: false, score: 0, tier: 'Unknown', tierColor: '#6b7280' };
   480→    }
   481→
   482→    const pslResult = calculatePSL({
   483→      faceScore: overallScore,
   484→      heightCm,
   485→      gender: gender || 'male',
   486→    });
   487→
   488→    return {
   489→      hasHeight: true,
   490→      score: pslResult.score,
   491→      tier: pslResult.tier,
   492→      tierColor: getTierColor(pslResult.tier),
   493→    };
   494→  }, [heightContext?.heightCm, overallScore, gender]);
   495→
   496→  // All ratios combined for modal navigation
   497→  const allRatios = useMemo(() => [...frontRatios, ...sideRatios], [frontRatios, sideRatios]);
   498→
   499→  // Current ratio index for navigation
   500→  const currentRatioIndex = useMemo(() => {
   501→    if (!selectedRatio) return -1;
   502→    return allRatios.findIndex(r => r.id === selectedRatio.metricId);
   503→  }, [selectedRatio, allRatios]);
   504→
   505→  // Convert Ratio to MetricScoreResult for modal
   506→  const ratioToMetricResult = useCallback((ratio: Ratio): MetricScoreResult => {
   507→    return {
   508→      metricId: ratio.id,
   509→      name: ratio.name,
   510→      value: ratio.value,
   511→      score: ratio.score,
   512→      standardizedScore: ratio.standardizedScore,
   513→      idealMin: ratio.idealMin,
   514→      idealMax: ratio.idealMax,
   515→      deviation: 0,
   516→      deviationDirection: 'within',
   517→      unit: ratio.unit === 'x' ? 'ratio' : ratio.unit === '%' ? 'percent' : ratio.unit === '°' ? 'degrees' : ratio.unit,
   518→      category: ratio.category,
   519→      qualityTier: ratio.qualityLevel,
   520→      severity: ratio.severity,
   521→    } as MetricScoreResult;
   522→  }, []);
   523→
   524→  // Handle ratio click from strengths/flaws sections
   525→  const handleRatioClick = useCallback((ratio: ResponsibleRatio, categoryName: string) => {
   526→    // Find the full ratio data from frontRatios or sideRatios
   527→    const fullRatio = allRatios.find(
   528→      (r) => r.name === ratio.ratioName || r.id === ratio.ratioId
   529→    );
   530→
   531→    // Update the visualization first (shows on face image)
   532→    if (fullRatio) {
   533→      setSelectedVisualizationMetric(fullRatio.id);
   534→      setSelectedRatio(ratioToMetricResult(fullRatio));
   535→    } else {
   536→      // Create a minimal MetricScoreResult from ResponsibleRatio
   537→      setSelectedVisualizationMetric(ratio.ratioId);
   538→      setSelectedRatio({
   539→        metricId: ratio.ratioId,
   540→        name: ratio.ratioName,
   541→        value: ratio.value,
   542→        score: ratio.score,
   543→        standardizedScore: ratio.score,
   544→        idealMin: ratio.idealMin,
   545→        idealMax: ratio.idealMax,
   546→        deviation: 0,
   547→        deviationDirection: 'within',
   548→        unit: (ratio.unit as 'ratio' | 'percent' | 'degrees' | 'mm' | 'none') || 'ratio',
   549→        category: ratio.category || categoryName,
   550→        qualityTier: ratio.score >= 8 ? 'ideal' : ratio.score >= 6 ? 'excellent' : ratio.score >= 4 ? 'good' : 'below_average',
   551→        severity: 'optimal',
   552→      } as MetricScoreResult);
   553→    }
   554→    setIsModalOpen(true);
   555→  }, [allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);
   556→
   557→  // Navigate to previous/next ratio in modal
   558→  const handlePreviousRatio = useCallback(() => {
   559→    if (currentRatioIndex > 0) {
   560→      const prevRatio = allRatios[currentRatioIndex - 1];
   561→      setSelectedRatio(ratioToMetricResult(prevRatio));
   562→      setSelectedVisualizationMetric(prevRatio.id);
   563→    }
   564→  }, [currentRatioIndex, allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);
   565→
   566→  const handleNextRatio = useCallback(() => {
   567→    if (currentRatioIndex < allRatios.length - 1) {
   568→      const nextRatio = allRatios[currentRatioIndex + 1];
   569→      setSelectedRatio(ratioToMetricResult(nextRatio));
   570→      setSelectedVisualizationMetric(nextRatio.id);
   571→    }
   572→  }, [currentRatioIndex, allRatios, ratioToMetricResult, setSelectedVisualizationMetric]);
   573→
   574→  // Determine if selected ratio is from side profile
   575→  const isSideRatio = useMemo(() => {
   576→    if (!selectedRatio) return false;
   577→    const sideMetricIds = sideRatios.map(r => r.id);
   578→    return sideMetricIds.includes(selectedRatio.metricId);
   579→  }, [selectedRatio, sideRatios]);
   580→
   581→  // Memoized modal values (useMemo instead of useCallback for computed values)
   582→  const modalPhoto = useMemo(() => {
   583→    if (!selectedRatio) return frontPhoto;
   584→    return isSideRatio ? (sidePhoto || frontPhoto) : frontPhoto;
   585→  }, [selectedRatio, isSideRatio, frontPhoto, sidePhoto]);
   586→
   587→  const modalLandmarks = useMemo(() => {
   588→    return isSideRatio ? (sideLandmarks || []) : (frontLandmarks || []);
   589→  }, [isSideRatio, frontLandmarks, sideLandmarks]);
   590→
   591→  const modalProfileType = useMemo((): 'front' | 'side' => {
   592→    return isSideRatio ? 'side' : 'front';
   593→  }, [isSideRatio]);
   594→
   595→  return (
   596→    <TabContent
   597→      title="Overview"
   598→      subtitle="Your complete facial harmony analysis"
   599→      rightContent={
   600→        <div className="flex items-center gap-2">
   601→          <ShareButton score={overallScore} frontScore={frontScore} sideScore={sideScore} />
   602→          <ExportButton elementId="results-overview" />
   603→        </div>
   604→      }
   605→    >
   606→      {/* Main content with ID for export */}
   607→      <div id="results-overview">
   608→        {/* Harmony Score */}
   609→        <div className="mb-8">
   610→          <HarmonyScoreDisplay />
   611→        </div>
   612→
   613→        {/* Profile Scores */}
   614→        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
   615→          <ProfileScoreCard
   616→            title="Front Profile"
   617→            score={frontScore}
   618→            icon={<User size={24} className="text-neutral-600" />}
   619→            photo={frontPhoto}
   620→            ratioCount={frontRatios.length}
   621→            onClick={() => setActiveTab('front-ratios')}
   622→          />
   623→          <ProfileScoreCard
   624→            title="Side Profile"
   625→            score={sideScore}
   626→            icon={<ScanFace size={24} className="text-neutral-600" />}
   627→            photo={sidePhoto || undefined}
   628→            ratioCount={sideRatios.length}
   629→            onClick={() => setActiveTab('side-ratios')}
   630→          />
   631→        </div>
   632→
   633→        {/* PSL Preview Card */}
   634→        <div className="mb-8">
   635→          <PSLPreviewCard
   636→            score={pslPreviewData.score}
   637→            tier={pslPreviewData.tier}
   638→            tierColor={pslPreviewData.tierColor}
   639→            hasHeight={pslPreviewData.hasHeight}
   640→            onClick={() => setActiveTab('psl')}
   641→          />
   642→        </div>
   643→
   644→        {/* Quick Insights - Top/Bottom Metrics with Advice (from looksmax_engine.py) */}
   645→        <QuickInsightsSection topMetrics={topMetrics} bottomMetrics={bottomMetrics} />
   646→
   647→        {/* Strengths & Flaws Grid - Harmony Style */}
   648→        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
   649→          {/* Key Strengths */}
   650→          <KeyStrengthsSection
   651→            strengths={strengths}
   652→            onRatioClick={handleRatioClick}
   653→            initialShowCount={3}
   654→          />
   655→
   656→          {/* Areas of Improvement */}
   657→          <AreasOfImprovementSection
   658→            flaws={flaws}
   659→            onRatioClick={handleRatioClick}
   660→            initialShowCount={3}
   661→          />
   662→        </div>
   663→
   664→        {/* Call to Action */}
   665→        <motion.div
   666→          className="bg-gradient-to-r from-cyan-500/20 to-blue-600/20 border border-cyan-500/30 rounded-xl p-6 flex items-center justify-between"
   667→          initial={{ opacity: 0 }}
   668→          animate={{ opacity: 1 }}
   669→          transition={{ delay: 0.5 }}
   670→        >
   671→          <div className="flex items-center gap-4">
   672→            <div className="w-12 h-12 rounded-xl bg-cyan-500/20 flex items-center justify-center">
   673→              <Sparkles size={24} className="text-cyan-400" />
   674→            </div>
   675→            <div>
   676→              <h3 className="font-semibold text-white">Unlock Your Potential</h3>
   677→              <p className="text-sm text-neutral-400">
   678→                See personalized recommendations to improve your harmony score
   679→              </p>
   680→            </div>
   681→          </div>
   682→          <button
   683→            onClick={() => setActiveTab('plan')}
   684→            className="px-4 py-2 bg-cyan-500 text-black font-medium rounded-lg hover:bg-cyan-400 transition-colors flex items-center gap-2"
   685→          >
   686→            View Plan
   687→            <ChevronRight size={16} />
   688→          </button>
   689→        </motion.div>
   690→      </div>{/* End of results-overview */}
   691→
   692→      {/* Ratio Detail Modal */}
   693→      <RatioDetailModal
   694→        isOpen={isModalOpen}
   695→        onClose={() => setIsModalOpen(false)}
   696→        ratio={selectedRatio}
   697→        onPrevious={handlePreviousRatio}
   698→        onNext={handleNextRatio}
   699→        hasPrevious={currentRatioIndex > 0}
   700→        hasNext={currentRatioIndex < allRatios.length - 1}
   701→        facePhoto={modalPhoto}
   702→        landmarks={modalLandmarks}
   703→        allRatios={allRatios}
   704→        profileType={modalProfileType}
   705→        gender={gender}
   706→        ethnicity={ethnicity}
   707→      />
   708→    </TabContent>
   709→  );
   710→}
   711→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
