     1â†’'use client';
     2â†’
     3â†’import { useEffect, useState, useMemo } from 'react';
     4â†’import Link from 'next/link';
     5â†’import { useResults } from '@/contexts/ResultsContext';
     6â†’import { TabContent } from '../ResultsLayout';
     7â†’import { api, ArchetypeForumRecommendation } from '@/lib/api';
     8â†’import { RecommendedForum, Category } from '@/types/forum';
     9â†’import { classifyFromRatios } from '@/lib/archetype-classifier';
    10â†’import { Ethnicity, Gender } from '@/lib/harmony-scoring';
    11â†’import {
    12â†’  Users,
    13â†’  ArrowRight,
    14â†’  MessageSquare,
    15â†’  Flame,
    16â†’  Target,
    17â†’  TrendingUp,
    18â†’  Sparkles,
    19â†’  Crown,
    20â†’} from 'lucide-react';
    21â†’
    22â†’export function CommunityTab() {
    23â†’  const { flaws, frontRatios, sideRatios, gender, ethnicity } = useResults();
    24â†’  const [recommendedForums, setRecommendedForums] = useState<RecommendedForum[]>([]);
    25â†’  const [archetypeForums, setArchetypeForums] = useState<ArchetypeForumRecommendation[]>([]);
    26â†’  const [allCategories, setAllCategories] = useState<Category[]>([]);
    27â†’  const [isLoading, setIsLoading] = useState(true);
    28â†’  const [error, setError] = useState<string | null>(null);
    29â†’
    30â†’  // Classify archetype from ratios
    31â†’  const archetypeClassification = useMemo(() => {
    32â†’    if (!frontRatios || frontRatios.length === 0 || !gender || !ethnicity) {
    33â†’      return null;
    34â†’    }
    35â†’    try {
    36â†’      return classifyFromRatios(
    37â†’        frontRatios,
    38â†’        sideRatios || [],
    39â†’        gender as Gender,
    40â†’        ethnicity as Ethnicity
    41â†’      );
    42â†’    } catch {
    43â†’      return null;
    44â†’    }
    45â†’  }, [frontRatios, sideRatios, gender, ethnicity]);
    46â†’
    47â†’  useEffect(() => {
    48â†’    let isMounted = true;
    49â†’    const controller = new AbortController();
    50â†’
    51â†’    async function fetchData() {
    52â†’      setIsLoading(true);
    53â†’      setError(null);
    54â†’
    55â†’      try {
    56â†’        // Convert flaw IDs to snake_case format for API
    57â†’        // flaw.id format: "insight_flaw_narrow_jaw" -> extract "narrow_jaw"
    58â†’        const flawIds = flaws.map(f => {
    59â†’          const id = f.id.replace('insight_flaw_', '');
    60â†’          return id;
    61â†’        });
    62â†’
    63â†’        // Get archetype category for recommendations
    64â†’        const archetypeCategory = archetypeClassification?.primary?.category;
    65â†’
    66â†’        const [recommended, archetype, all] = await Promise.all([
    67â†’          flawIds.length > 0 ? api.getRecommendedForums(flawIds) : Promise.resolve([]),
    68â†’          archetypeCategory ? api.getArchetypeForumRecommendations(archetypeCategory) : Promise.resolve([]),
    69â†’          api.getForumCategories(),
    70â†’        ]);
    71â†’
    72â†’        if (isMounted) {
    73â†’          setRecommendedForums(recommended);
    74â†’          setArchetypeForums(archetype);
    75â†’          setAllCategories(all);
    76â†’        }
    77â†’      } catch (err) {
    78â†’        if (isMounted && err instanceof Error && err.name !== 'AbortError') {
    79â†’          setError(err.message || 'Failed to load communities');
    80â†’        }
    81â†’      } finally {
    82â†’        if (isMounted) {
    83â†’          setIsLoading(false);
    84â†’        }
    85â†’      }
    86â†’    }
    87â†’
    88â†’    fetchData();
    89â†’
    90â†’    return () => {
    91â†’      isMounted = false;
    92â†’      controller.abort();
    93â†’    };
    94â†’  }, [flaws, archetypeClassification]);
    95â†’
    96â†’  return (
    97â†’    <TabContent
    98â†’      title="Community"
    99â†’      subtitle="Connect with others on your self-improvement journey"
   100â†’    >
   101â†’      <div className="space-y-8">
   102â†’        {/* Hero CTA */}
   103â†’        <div className="bg-gradient-to-br from-cyan-500/10 via-blue-500/5 to-purple-500/10 border border-cyan-500/20 rounded-2xl p-6 md:p-8">
   104â†’          <div className="flex flex-col md:flex-row md:items-center gap-6">
   105â†’            <div className="flex-1">
   106â†’              <h2 className="text-xl md:text-2xl font-bold text-white mb-2">
   107â†’                Your Personalized Communities
   108â†’              </h2>
   109â†’              <p className="text-neutral-400">
   110â†’                Based on your analysis results, we&apos;ve identified communities where you can
   111â†’                learn from others with similar goals and share your journey.
   112â†’              </p>
   113â†’            </div>
   114â†’            <Link
   115â†’              href="/forum"
   116â†’              className="flex items-center justify-center gap-2 px-6 py-3 bg-cyan-500 text-black font-semibold rounded-xl hover:bg-cyan-400 transition-colors whitespace-nowrap"
   117â†’            >
   118â†’              Explore All
   119â†’              <ArrowRight className="w-4 h-4" />
   120â†’            </Link>
   121â†’          </div>
   122â†’        </div>
   123â†’
   124â†’        {/* Loading State */}
   125â†’        {isLoading && (
   126â†’          <div className="grid gap-4 md:grid-cols-2">
   127â†’            {[1, 2, 3, 4].map((i) => (
   128â†’              <div key={i} className="bg-neutral-900 border border-neutral-800 rounded-xl p-5 animate-pulse">
   129â†’                <div className="flex items-start gap-4">
   130â†’                  <div className="w-12 h-12 rounded-xl bg-neutral-800" />
   131â†’                  <div className="flex-1">
   132â†’                    <div className="h-5 bg-neutral-800 rounded w-2/3 mb-2" />
   133â†’                    <div className="h-4 bg-neutral-800 rounded w-full mb-3" />
   134â†’                    <div className="flex gap-2">
   135â†’                      <div className="h-6 bg-neutral-800 rounded w-20" />
   136â†’                      <div className="h-6 bg-neutral-800 rounded w-16" />
   137â†’                    </div>
   138â†’                  </div>
   139â†’                </div>
   140â†’              </div>
   141â†’            ))}
   142â†’          </div>
   143â†’        )}
   144â†’
   145â†’        {/* Error State */}
   146â†’        {error && (
   147â†’          <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-4">
   148â†’            <p className="text-red-400">{error}</p>
   149â†’          </div>
   150â†’        )}
   151â†’
   152â†’        {/* Archetype-Based Recommendations */}
   153â†’        {!isLoading && !error && archetypeForums.length > 0 && archetypeClassification && (
   154â†’          <section>
   155â†’            <div className="flex items-center gap-2 mb-4">
   156â†’              <Crown className="w-5 h-5 text-amber-400" />
   157â†’              <h3 className="text-lg font-semibold text-white">Based on Your Archetype</h3>
   158â†’              <span className="px-2 py-0.5 text-xs font-medium bg-amber-500/20 text-amber-400 rounded">
   159â†’                {archetypeClassification.primary.category}
   160â†’              </span>
   161â†’            </div>
   162â†’
   163â†’            <div className="grid gap-4 md:grid-cols-2">
   164â†’              {archetypeForums.map((af) => {
   165â†’                // Filter out duplicates from flaw-based recommendations
   166â†’                const isDuplicate = recommendedForums.some(rf => rf.category.id === af.category.id);
   167â†’                if (isDuplicate) return null;
   168â†’
   169â†’                return (
   170â†’                  <Link key={af.category.id} href={`/forum/${af.category.slug}`}>
   171â†’                    <div className="group bg-neutral-900/50 border border-neutral-800 hover:border-amber-500/30 rounded-xl p-5 transition-all hover:shadow-[0_0_30px_rgba(245,158,11,0.05)]">
   172â†’                      <div className="flex items-start gap-4">
   173â†’                        {/* Icon */}
   174â†’                        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 flex items-center justify-center text-2xl flex-shrink-0">
   175â†’                          {af.category.icon || 'ðŸ’¬'}
   176â†’                        </div>
   177â†’
   178â†’                        {/* Content */}
   179â†’                        <div className="flex-1 min-w-0">
   180â†’                          <div className="flex items-center gap-2 mb-1">
   181â†’                            <h4 className="font-semibold text-white group-hover:text-amber-400 transition-colors">
   182â†’                              {af.category.name}
   183â†’                            </h4>
   184â†’                            <Crown className="w-4 h-4 text-amber-400" />
   185â†’                          </div>
   186â†’                          <p className="text-sm text-neutral-400 line-clamp-2 mb-3">
   187â†’                            {af.reason || af.category.description}
   188â†’                          </p>
   189â†’
   190â†’                          {/* Archetype tag */}
   191â†’                          <div className="flex flex-wrap gap-1.5">
   192â†’                            <span className="px-2 py-0.5 text-xs bg-amber-500/10 text-amber-400 rounded">
   193â†’                              {af.archetype} archetype
   194â†’                            </span>
   195â†’                          </div>
   196â†’                        </div>
   197â†’
   198â†’                        {/* Arrow */}
   199â†’                        <ArrowRight className="w-5 h-5 text-neutral-600 group-hover:text-amber-400 transition-colors flex-shrink-0" />
   200â†’                      </div>
   201â†’                    </div>
   202â†’                  </Link>
   203â†’                );
   204â†’              })}
   205â†’            </div>
   206â†’          </section>
   207â†’        )}
   208â†’
   209â†’        {/* Recommended Forums */}
   210â†’        {!isLoading && !error && recommendedForums.length > 0 && (
   211â†’          <section>
   212â†’            <div className="flex items-center gap-2 mb-4">
   213â†’              <Target className="w-5 h-5 text-cyan-400" />
   214â†’              <h3 className="text-lg font-semibold text-white">Recommended For You</h3>
   215â†’              <span className="px-2 py-0.5 text-xs font-medium bg-cyan-500/20 text-cyan-400 rounded">
   216â†’                Based on your results
   217â†’              </span>
   218â†’            </div>
   219â†’
   220â†’            <div className="grid gap-4 md:grid-cols-2">
   221â†’              {recommendedForums.map((rf) => (
   222â†’                <Link key={rf.category.id} href={`/forum/${rf.category.slug}`}>
   223â†’                  <div className="group bg-neutral-900/50 border border-neutral-800 hover:border-cyan-500/30 rounded-xl p-5 transition-all hover:shadow-[0_0_30px_rgba(0,243,255,0.05)]">
   224â†’                    <div className="flex items-start gap-4">
   225â†’                      {/* Icon */}
   226â†’                      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500/20 to-purple-500/20 flex items-center justify-center text-2xl flex-shrink-0">
   227â†’                        {rf.category.icon || 'ðŸ’¬'}
   228â†’                      </div>
   229â†’
   230â†’                      {/* Content */}
   231â†’                      <div className="flex-1 min-w-0">
   232â†’                        <div className="flex items-center gap-2 mb-1">
   233â†’                          <h4 className="font-semibold text-white group-hover:text-cyan-400 transition-colors">
   234â†’                            {rf.category.name}
   235â†’                          </h4>
   236â†’                          <Sparkles className="w-4 h-4 text-cyan-400" />
   237â†’                        </div>
   238â†’                        <p className="text-sm text-neutral-400 line-clamp-2 mb-3">
   239â†’                          {rf.category.description}
   240â†’                        </p>
   241â†’
   242â†’                        {/* Matched flaws */}
   243â†’                        <div className="flex flex-wrap gap-1.5">
   244â†’                          {rf.matchedFlaws.slice(0, 3).map((flaw) => (
   245â†’                            <span
   246â†’                              key={flaw}
   247â†’                              className="px-2 py-0.5 text-xs bg-cyan-500/10 text-cyan-400 rounded"
   248â†’                            >
   249â†’                              {flaw}
   250â†’                            </span>
   251â†’                          ))}
   252â†’                          {rf.matchedFlaws.length > 3 && (
   253â†’                            <span className="px-2 py-0.5 text-xs text-neutral-500">
   254â†’                              +{rf.matchedFlaws.length - 3} more
   255â†’                            </span>
   256â†’                          )}
   257â†’                        </div>
   258â†’                      </div>
   259â†’
   260â†’                      {/* Arrow */}
   261â†’                      <ArrowRight className="w-5 h-5 text-neutral-600 group-hover:text-cyan-400 transition-colors flex-shrink-0" />
   262â†’                    </div>
   263â†’                  </div>
   264â†’                </Link>
   265â†’              ))}
   266â†’            </div>
   267â†’          </section>
   268â†’        )}
   269â†’
   270â†’        {/* All Communities */}
   271â†’        {!isLoading && !error && allCategories.length > 0 && (
   272â†’          <section>
   273â†’            <div className="flex items-center gap-2 mb-4">
   274â†’              <Users className="w-5 h-5 text-purple-400" />
   275â†’              <h3 className="text-lg font-semibold text-white">All Communities</h3>
   276â†’            </div>
   277â†’
   278â†’            <div className="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
   279â†’              {allCategories.map((category) => (
   280â†’                <Link key={category.id} href={`/forum/${category.slug}`}>
   281â†’                  <div className="group bg-neutral-900/30 border border-neutral-800 hover:border-neutral-700 rounded-xl p-4 transition-all">
   282â†’                    <div className="flex items-center gap-3">
   283â†’                      {/* Icon */}
   284â†’                      <div className="w-10 h-10 rounded-lg bg-neutral-800 flex items-center justify-center text-lg flex-shrink-0">
   285â†’                        {category.icon || 'ðŸ’¬'}
   286â†’                      </div>
   287â†’
   288â†’                      {/* Content */}
   289â†’                      <div className="flex-1 min-w-0">
   290â†’                        <h4 className="font-medium text-white group-hover:text-cyan-400 transition-colors truncate">
   291â†’                          {category.name}
   292â†’                        </h4>
   293â†’                        <div className="flex items-center gap-3 text-xs text-neutral-500">
   294â†’                          <span className="flex items-center gap-1">
   295â†’                            <MessageSquare className="w-3 h-3" />
   296â†’                            {category.postCount} posts
   297â†’                          </span>
   298â†’                          <span className="flex items-center gap-1">
   299â†’                            <TrendingUp className="w-3 h-3" />
   300â†’                            {category.subForums.length} topics
   301â†’                          </span>
   302â†’                        </div>
   303â†’                      </div>
   304â†’
   305â†’                      <ArrowRight className="w-4 h-4 text-neutral-600 group-hover:text-white transition-colors" />
   306â†’                    </div>
   307â†’                  </div>
   308â†’                </Link>
   309â†’              ))}
   310â†’            </div>
   311â†’          </section>
   312â†’        )}
   313â†’
   314â†’        {/* Empty State */}
   315â†’        {!isLoading && !error && allCategories.length === 0 && (
   316â†’          <div className="text-center py-12">
   317â†’            <div className="w-16 h-16 rounded-2xl bg-neutral-900 flex items-center justify-center mx-auto mb-4">
   318â†’              <Users className="w-8 h-8 text-neutral-600" />
   319â†’            </div>
   320â†’            <p className="text-neutral-400 mb-4">No communities available yet.</p>
   321â†’            <Link
   322â†’              href="/forum"
   323â†’              className="text-cyan-400 hover:text-cyan-300 font-medium"
   324â†’            >
   325â†’              Check back soon
   326â†’            </Link>
   327â†’          </div>
   328â†’        )}
   329â†’
   330â†’        {/* Bottom CTA */}
   331â†’        <div className="flex flex-col sm:flex-row items-center justify-center gap-4 pt-4">
   332â†’          <Link
   333â†’            href="/forum"
   334â†’            className="flex items-center gap-2 px-6 py-3 bg-neutral-800 text-white font-medium rounded-xl hover:bg-neutral-700 transition-colors"
   335â†’          >
   336â†’            <Flame className="w-4 h-4 text-orange-400" />
   337â†’            Browse Trending Posts
   338â†’          </Link>
   339â†’          <Link
   340â†’            href="/forum"
   341â†’            className="flex items-center gap-2 px-6 py-3 border border-neutral-700 text-neutral-300 font-medium rounded-xl hover:bg-neutral-900 transition-colors"
   342â†’          >
   343â†’            View All Communities
   344â†’            <ArrowRight className="w-4 h-4" />
   345â†’          </Link>
   346â†’        </div>
   347â†’      </div>
   348â†’    </TabContent>
   349â†’  );
   350â†’}
   351â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
