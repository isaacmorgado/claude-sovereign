     1→'use client';
     2→
     3→import { useEffect, useState } from 'react';
     4→import { useParams, useRouter } from 'next/navigation';
     5→import Link from 'next/link';
     6→import { useForum } from '@/contexts/ForumContext';
     7→import { VoteButtons, CommentThread, ForumHeader, ForumBreadcrumb, MentionInput, QuotaIndicator, QuotaExceededBanner, MarkdownContent } from '@/components/forum';
     8→import { formatDistanceToNow } from '@/lib/utils';
     9→import {
    10→  MessageSquare,
    11→  Share2,
    12→  Bookmark,
    13→  BookmarkCheck,
    14→  Flag,
    15→  Trash2,
    16→  Pin,
    17→  Sparkles,
    18→  Send,
    19→  Check
    20→} from 'lucide-react';
    21→import { ReportModal } from '@/components/forum';
    22→
    23→// ============================================
    24→// SAVED POSTS HELPER
    25→// ============================================
    26→function getSavedPosts(): string[] {
    27→  if (typeof window === 'undefined') return [];
    28→  try {
    29→    return JSON.parse(localStorage.getItem('saved_posts') || '[]');
    30→  } catch {
    31→    return [];
    32→  }
    33→}
    34→
    35→function toggleSavedPost(postId: string): boolean {
    36→  const saved = getSavedPosts();
    37→  const isSaved = saved.includes(postId);
    38→  if (isSaved) {
    39→    localStorage.setItem('saved_posts', JSON.stringify(saved.filter(id => id !== postId)));
    40→    return false;
    41→  } else {
    42→    localStorage.setItem('saved_posts', JSON.stringify([...saved, postId]));
    43→    return true;
    44→  }
    45→}
    46→
    47→// ============================================
    48→// COMMENT SKELETON
    49→// ============================================
    50→function CommentSkeleton() {
    51→  return (
    52→    <div className="flex gap-4 animate-pulse">
    53→      <div className="w-8 space-y-2">
    54→        <div className="h-5 w-5 bg-neutral-800 rounded mx-auto" />
    55→        <div className="h-4 w-4 bg-neutral-800 rounded mx-auto" />
    56→        <div className="h-5 w-5 bg-neutral-800 rounded mx-auto" />
    57→      </div>
    58→      <div className="flex-1 space-y-2">
    59→        <div className="h-3 w-32 bg-neutral-800 rounded" />
    60→        <div className="h-4 w-full bg-neutral-800 rounded" />
    61→        <div className="h-4 w-2/3 bg-neutral-800 rounded" />
    62→      </div>
    63→    </div>
    64→  );
    65→}
    66→
    67→// ============================================
    68→// POST SKELETON
    69→// ============================================
    70→function PostSkeleton() {
    71→  return (
    72→    <div className="rounded-2xl bg-neutral-900/30 border border-white/5 p-6 animate-pulse">
    73→      <div className="flex gap-6">
    74→        <div className="w-10 space-y-2">
    75→          <div className="h-6 w-6 bg-neutral-800 rounded mx-auto" />
    76→          <div className="h-4 w-4 bg-neutral-800 rounded mx-auto" />
    77→          <div className="h-6 w-6 bg-neutral-800 rounded mx-auto" />
    78→        </div>
    79→        <div className="flex-1 space-y-4">
    80→          <div className="h-4 w-48 bg-neutral-800 rounded" />
    81→          <div className="h-6 w-3/4 bg-neutral-800 rounded" />
    82→          <div className="space-y-2">
    83→            <div className="h-4 w-full bg-neutral-800 rounded" />
    84→            <div className="h-4 w-full bg-neutral-800 rounded" />
    85→            <div className="h-4 w-2/3 bg-neutral-800 rounded" />
    86→          </div>
    87→        </div>
    88→      </div>
    89→    </div>
    90→  );
    91→}
    92→
    93→// ============================================
    94→// MAIN PAGE
    95→// ============================================
    96→export default function PostDetailPage() {
    97→  const params = useParams();
    98→  const router = useRouter();
    99→  const postId = params.postId as string;
   100→
   101→  const {
   102→    currentPost,
   103→    comments,
   104→    isLoadingPosts,
   105→    isLoadingComments,
   106→    fetchPost,
   107→    fetchComments,
   108→    votePost,
   109→    voteComment,
   110→    createComment,
   111→    updateComment,
   112→    deleteComment,
   113→    deletePost,
   114→    error,
   115→  } = useForum();
   116→
   117→  const [newComment, setNewComment] = useState('');
   118→  const [isSubmitting, setIsSubmitting] = useState(false);
   119→  const [isSaved, setIsSaved] = useState(false);
   120→  const [copied, setCopied] = useState(false);
   121→  const [showReportModal, setShowReportModal] = useState(false);
   122→  const [commentQuotaExceeded, setCommentQuotaExceeded] = useState(false);
   123→  const [commentError, setCommentError] = useState<string | null>(null);
   124→
   125→  useEffect(() => {
   126→    fetchPost(postId);
   127→    fetchComments(postId);
   128→  }, [postId, fetchPost, fetchComments]);
   129→
   130→  // Check saved state on mount
   131→  useEffect(() => {
   132→    setIsSaved(getSavedPosts().includes(postId));
   133→  }, [postId]);
   134→
   135→  const handleShare = async () => {
   136→    const url = window.location.href;
   137→    try {
   138→      await navigator.clipboard.writeText(url);
   139→      setCopied(true);
   140→      setTimeout(() => setCopied(false), 2000);
   141→    } catch {
   142→      // Fallback for older browsers
   143→      const input = document.createElement('input');
   144→      input.value = url;
   145→      document.body.appendChild(input);
   146→      input.select();
   147→      document.execCommand('copy');
   148→      document.body.removeChild(input);
   149→      setCopied(true);
   150→      setTimeout(() => setCopied(false), 2000);
   151→    }
   152→  };
   153→
   154→  const handleSave = () => {
   155→    const newSavedState = toggleSavedPost(postId);
   156→    setIsSaved(newSavedState);
   157→  };
   158→
   159→  const handleSubmitComment = async () => {
   160→    if (!newComment.trim()) return;
   161→
   162→    setIsSubmitting(true);
   163→    setCommentError(null);
   164→    try {
   165→      await createComment(postId, newComment.trim());
   166→      setNewComment('');
   167→    } catch (err) {
   168→      const errorMessage = err instanceof Error ? err.message : 'Failed to create comment';
   169→      // Check for quota exceeded error (429 status)
   170→      if (errorMessage.toLowerCase().includes('quota exceeded') ||
   171→          errorMessage.toLowerCase().includes('too many requests')) {
   172→        setCommentQuotaExceeded(true);
   173→      }
   174→      setCommentError(errorMessage);
   175→    } finally {
   176→      setIsSubmitting(false);
   177→    }
   178→  };
   179→
   180→  const handleReply = async (parentId: string, content: string) => {
   181→    try {
   182→      await createComment(postId, content, parentId);
   183→      fetchComments(postId);
   184→    } catch (err) {
   185→      const errorMessage = err instanceof Error ? err.message : 'Failed to create comment';
   186→      // Check for quota exceeded error (429 status)
   187→      if (errorMessage.toLowerCase().includes('quota exceeded') ||
   188→          errorMessage.toLowerCase().includes('too many requests')) {
   189→        setCommentQuotaExceeded(true);
   190→        setCommentError(errorMessage);
   191→      }
   192→    }
   193→  };
   194→
   195→  const handleDeletePost = async () => {
   196→    if (!confirm('Are you sure you want to delete this post?')) return;
   197→
   198→    try {
   199→      await deletePost(postId);
   200→      router.push('/forum');
   201→    } catch {
   202→      // Error handled in context
   203→    }
   204→  };
   205→
   206→  // Get current user ID from localStorage (if logged in)
   207→  const getCurrentUserId = (): string | undefined => {
   208→    if (typeof window === 'undefined') return undefined;
   209→    const token = localStorage.getItem('auth_token');
   210→    if (!token) return undefined;
   211→    try {
   212→      const payload = JSON.parse(atob(token.split('.')[1]));
   213→      return payload.sub;
   214→    } catch {
   215→      return undefined;
   216→    }
   217→  };
   218→
   219→  const currentUserId = getCurrentUserId();
   220→  const isPostOwner = currentUserId && currentPost?.author.id === currentUserId;
   221→
   222→  return (
   223→    <div className="min-h-screen bg-black selection:bg-cyan-500/30">
   224→      <ForumHeader />
   225→      <ForumBreadcrumb items={[
   226→        { label: 'Community', href: '/forum' },
   227→        ...(currentPost ? [{ label: currentPost.categorySlug.replace(/-/g, ' '), href: `/forum/${currentPost.categorySlug}` }] : []),
   228→        { label: 'Post' }
   229→      ]} />
   230→
   231→      {/* Content */}
   232→      <div className="max-w-4xl mx-auto px-6 py-10">
   233→        {/* Error */}
   234→        {error && (
   235→          <div className="p-4 rounded-xl bg-red-500/10 border border-red-500/20 mb-6">
   236→            <p className="text-red-400 text-sm">{error}</p>
   237→          </div>
   238→        )}
   239→
   240→        {/* Loading */}
   241→        {isLoadingPosts && !currentPost && <PostSkeleton />}
   242→
   243→        {/* Post */}
   244→        {currentPost && (
   245→          <article className="rounded-2xl bg-neutral-900/30 border border-white/5 p-6 mb-8">
   246→            <div className="flex gap-6">
   247→              {/* Vote buttons */}
   248→              <div className="flex-shrink-0">
   249→                <VoteButtons
   250→                  voteCount={currentPost.voteCount}
   251→                  userVote={currentPost.userVote}
   252→                  onVote={(voteType) => votePost(postId, voteType)}
   253→                />
   254→              </div>
   255→
   256→              {/* Post content */}
   257→              <div className="flex-1 min-w-0">
   258→                {/* Meta */}
   259→                <div className="flex items-center flex-wrap gap-2 mb-4">
   260→                  {currentPost.isPinned && (
   261→                    <span className="flex items-center gap-1 px-2 py-0.5 rounded-md bg-cyan-500/10 border border-cyan-500/20 text-[9px] font-black uppercase tracking-wider text-cyan-400">
   262→                      <Pin size={10} />
   263→                      Pinned
   264→                    </span>
   265→                  )}
   266→                  {currentPost.isGuide && (
   267→                    <span className="flex items-center gap-1 px-2 py-0.5 rounded-md bg-green-500/10 border border-green-500/20 text-[9px] font-black uppercase tracking-wider text-green-400">
   268→                      <Sparkles size={10} />
   269→                      Guide
   270→                    </span>
   271→                  )}
   272→                  <span className="text-[10px] text-neutral-500">
   273→                    Posted by{' '}
   274→                    <Link
   275→                      href={`/forum/user/${currentPost.author.id}`}
   276→                      className="text-cyan-400 font-bold hover:text-cyan-300 transition-colors"
   277→                    >
   278→                      u/{currentPost.author.username}
   279→                    </Link>
   280→                  </span>
   281→                  <span className="text-neutral-700">•</span>
   282→                  <span className="text-[10px] text-neutral-600">{formatDistanceToNow(currentPost.createdAt)}</span>
   283→                  {currentPost.updatedAt !== currentPost.createdAt && (
   284→                    <>
   285→                      <span className="text-neutral-700">•</span>
   286→                      <span className="text-[10px] text-neutral-600 italic">edited</span>
   287→                    </>
   288→                  )}
   289→                </div>
   290→
   291→                {/* Title */}
   292→                <h1 className="text-2xl font-black tracking-tight text-white mb-5">
   293→                  {currentPost.title}
   294→                </h1>
   295→
   296→                {/* Content - rendered as markdown */}
   297→                <div className="mb-6">
   298→                  <MarkdownContent content={currentPost.content} />
   299→                </div>
   300→
   301→                {/* Actions */}
   302→                <div className="flex items-center gap-2 pt-5 border-t border-white/5">
   303→                  <span className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider text-neutral-500">
   304→                    <MessageSquare size={14} />
   305→                    {currentPost.commentCount} Comments
   306→                  </span>
   307→                  <button
   308→                    onClick={handleShare}
   309→                    className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${
   310→                      copied
   311→                        ? 'text-emerald-400 bg-emerald-500/10'
   312→                        : 'text-neutral-500 hover:bg-white/5 hover:text-white'
   313→                    }`}
   314→                  >
   315→                    {copied ? <Check size={14} /> : <Share2 size={14} />}
   316→                    {copied ? 'Copied!' : 'Share'}
   317→                  </button>
   318→                  <button
   319→                    onClick={handleSave}
   320→                    className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${
   321→                      isSaved
   322→                        ? 'text-cyan-400 bg-cyan-500/10'
   323→                        : 'text-neutral-500 hover:bg-white/5 hover:text-white'
   324→                    }`}
   325→                  >
   326→                    {isSaved ? <BookmarkCheck size={14} /> : <Bookmark size={14} />}
   327→                    {isSaved ? 'Saved' : 'Save'}
   328→                  </button>
   329→                  <button
   330→                    onClick={() => setShowReportModal(true)}
   331→                    className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider text-neutral-500 hover:bg-white/5 hover:text-red-400 transition-all"
   332→                  >
   333→                    <Flag size={14} />
   334→                    Report
   335→                  </button>
   336→                  {isPostOwner && (
   337→                    <button
   338→                      onClick={handleDeletePost}
   339→                      className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider text-neutral-500 hover:bg-red-500/10 hover:text-red-400 transition-all"
   340→                    >
   341→                      <Trash2 size={14} />
   342→                      Delete
   343→                    </button>
   344→                  )}
   345→                </div>
   346→              </div>
   347→            </div>
   348→          </article>
   349→        )}
   350→
   351→        {/* Comment Section */}
   352→        {currentPost && (
   353→          <section>
   354→            <h2 className="text-[10px] font-black uppercase tracking-[0.4em] text-neutral-600 mb-6 flex items-center gap-4">
   355→              Comments ({currentPost.commentCount})
   356→              <div className="flex-1 h-px bg-neutral-900" />
   357→            </h2>
   358→
   359→            {/* Comment Input */}
   360→            {currentUserId ? (
   361→              <div className="rounded-2xl bg-neutral-900/30 border border-white/5 p-5 mb-8">
   362→                {commentQuotaExceeded ? (
   363→                  <QuotaExceededBanner type="comments" />
   364→                ) : (
   365→                  <>
   366→                    {/* Quota indicator */}
   367→                    <div className="mb-3">
   368→                      <QuotaIndicator
   369→                        type="comments"
   370→                        compact
   371→                        onQuotaExceeded={() => setCommentQuotaExceeded(true)}
   372→                      />
   373→                    </div>
   374→                    <MentionInput
   375→                      value={newComment}
   376→                      onChange={setNewComment}
   377→                      placeholder="What are your thoughts? Use @username to mention others."
   378→                      rows={4}
   379→                      className="bg-transparent border-0 min-h-0"
   380→                    />
   381→                    {commentError && (
   382→                      <p className="text-red-400 text-xs mt-2">{commentError}</p>
   383→                    )}
   384→                    <div className="flex justify-end mt-3 pt-3 border-t border-white/5">
   385→                      <button
   386→                        onClick={handleSubmitComment}
   387→                        disabled={isSubmitting || !newComment.trim()}
   388→                        className="flex items-center gap-2 px-5 py-2.5 bg-cyan-500 text-black text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-cyan-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-cyan-500/20"
   389→                      >
   390→                        <Send size={12} />
   391→                        {isSubmitting ? 'Posting...' : 'Comment'}
   392→                      </button>
   393→                    </div>
   394→                  </>
   395→                )}
   396→              </div>
   397→            ) : (
   398→              <div className="rounded-2xl bg-neutral-900/30 border border-white/5 p-5 mb-8 text-center">
   399→                <p className="text-neutral-400 text-sm mb-4">Sign in to join the discussion</p>
   400→                <div className="flex justify-center gap-3">
   401→                  <Link
   402→                    href="/login"
   403→                    className="px-5 py-2.5 bg-cyan-500 text-black text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-cyan-400 transition-all"
   404→                  >
   405→                    Login
   406→                  </Link>
   407→                  <Link
   408→                    href="/signup"
   409→                    className="px-5 py-2.5 border border-white/10 text-white text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-white/5 transition-all"
   410→                  >
   411→                    Sign Up
   412→                  </Link>
   413→                </div>
   414→              </div>
   415→            )}
   416→
   417→            {/* Comments List */}
   418→            {isLoadingComments && comments.length === 0 ? (
   419→              <div className="space-y-6">
   420→                {[1, 2].map((i) => (
   421→                  <CommentSkeleton key={i} />
   422→                ))}
   423→              </div>
   424→            ) : comments.length > 0 ? (
   425→              <CommentThread
   426→                comments={comments}
   427→                onVote={(commentId, voteType) => voteComment(commentId, voteType)}
   428→                onReply={handleReply}
   429→                onEdit={(commentId, content) => updateComment(commentId, content)}
   430→                onDelete={(commentId) => deleteComment(commentId)}
   431→                currentUserId={currentUserId}
   432→              />
   433→            ) : (
   434→              <div className="text-center py-12 rounded-2xl bg-neutral-900/30 border border-white/5">
   435→                <MessageSquare size={32} className="mx-auto text-neutral-700 mb-3" />
   436→                <p className="text-neutral-400">No comments yet. Be the first to comment!</p>
   437→              </div>
   438→            )}
   439→          </section>
   440→        )}
   441→
   442→        {/* Post not found */}
   443→        {!isLoadingPosts && !currentPost && !error && (
   444→          <div className="text-center py-16 rounded-2xl bg-neutral-900/30 border border-white/5">
   445→            <h2 className="text-xl font-black text-white mb-3">Post not found</h2>
   446→            <p className="text-neutral-400 mb-6">
   447→              The post you&apos;re looking for doesn&apos;t exist or has been deleted.
   448→            </p>
   449→            <Link
   450→              href="/forum"
   451→              className="inline-flex items-center gap-2 px-6 py-3 bg-cyan-500 text-black text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-cyan-400 transition-all"
   452→            >
   453→              Go back to forum
   454→            </Link>
   455→          </div>
   456→        )}
   457→      </div>
   458→
   459→      {/* Report Modal */}
   460→      <ReportModal
   461→        isOpen={showReportModal}
   462→        onClose={() => setShowReportModal(false)}
   463→        targetType="post"
   464→        targetId={postId}
   465→      />
   466→    </div>
   467→  );
   468→}
   469→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
