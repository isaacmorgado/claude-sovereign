     1→'use client';
     2→
     3→import { useState, useEffect, useCallback } from 'react';
     4→import Link from 'next/link';
     5→import { MessageSquare, Share2, Bookmark, BookmarkCheck, MoreHorizontal, Pin, Sparkles, Check, Flag, Loader2 } from 'lucide-react';
     6→import { PostListItem, VoteType } from '@/types/forum';
     7→import { formatDistanceToNow } from '@/lib/utils';
     8→import { VoteButtons } from './VoteButtons';
     9→import { api } from '@/lib/api';
    10→import { useBookmarks } from '@/contexts/ForumContext';
    11→import { KarmaBadge } from './KarmaBadge';
    12→
    13→interface PostCardProps {
    14→  post: PostListItem;
    15→  onVote?: (postId: string, voteType: VoteType) => void;
    16→  showSubForum?: boolean;
    17→  onReport?: (postId: string) => void;
    18→}
    19→
    20→export function PostCard({ post, onVote, showSubForum = false, onReport }: PostCardProps) {
    21→  const bookmarkContext = useBookmarks();
    22→  const [localIsSaved, setLocalIsSaved] = useState(false);
    23→  const [isBookmarking, setIsBookmarking] = useState(false);
    24→  const [copied, setCopied] = useState(false);
    25→  const [showMenu, setShowMenu] = useState(false);
    26→
    27→  // Determine if bookmarked based on context or local state
    28→  const isSaved = bookmarkContext
    29→    ? bookmarkContext.isBookmarked(post.id)
    30→    : localIsSaved;
    31→
    32→  // Fetch bookmark status on mount if not using global context
    33→  useEffect(() => {
    34→    if (!bookmarkContext) {
    35→      // Only fetch if user is logged in (token exists)
    36→      const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null;
    37→      if (token) {
    38→        api.getBookmarkStatus(post.id)
    39→          .then(status => setLocalIsSaved(status.isBookmarked))
    40→          .catch(() => setLocalIsSaved(false));
    41→      }
    42→    }
    43→  }, [post.id, bookmarkContext]);
    44→
    45→  const handleShare = async () => {
    46→    const url = `${window.location.origin}/forum/post/${post.id}`;
    47→    try {
    48→      await navigator.clipboard.writeText(url);
    49→      setCopied(true);
    50→      setTimeout(() => setCopied(false), 2000);
    51→    } catch {
    52→      // Fallback for older browsers
    53→      const input = document.createElement('input');
    54→      input.value = url;
    55→      document.body.appendChild(input);
    56→      input.select();
    57→      document.execCommand('copy');
    58→      document.body.removeChild(input);
    59→      setCopied(true);
    60→      setTimeout(() => setCopied(false), 2000);
    61→    }
    62→  };
    63→
    64→  const handleSave = useCallback(async () => {
    65→    // Check if user is logged in
    66→    const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null;
    67→    if (!token) {
    68→      // Redirect to login if not authenticated
    69→      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
    70→      return;
    71→    }
    72→
    73→    setIsBookmarking(true);
    74→    try {
    75→      if (bookmarkContext) {
    76→        // Use global context
    77→        await bookmarkContext.toggleBookmark(post.id);
    78→      } else {
    79→        // Use local state with direct API call
    80→        const result = await api.toggleBookmark(post.id);
    81→        setLocalIsSaved(result.isBookmarked);
    82→      }
    83→    } catch (err) {
    84→      console.error('Failed to toggle bookmark:', err);
    85→    } finally {
    86→      setIsBookmarking(false);
    87→    }
    88→  }, [post.id, bookmarkContext]);
    89→
    90→  const handleReport = () => {
    91→    setShowMenu(false);
    92→    onReport?.(post.id);
    93→  };
    94→
    95→  return (
    96→    <article className="group relative rounded-2xl bg-neutral-900/30 border border-white/5 hover:border-cyan-500/20 transition-all overflow-hidden">
    97→      <div className="flex">
    98→        {/* Vote column */}
    99→        <div className="w-12 bg-neutral-900/50 border-r border-white/5 flex flex-col items-center py-4">
   100→          <VoteButtons
   101→            voteCount={post.voteCount}
   102→            userVote={post.userVote}
   103→            onVote={(voteType) => onVote?.(post.id, voteType)}
   104→            size="sm"
   105→          />
   106→        </div>
   107→
   108→        {/* Content */}
   109→        <div className="flex-1 p-4 min-w-0">
   110→          {/* Meta line */}
   111→          <div className="flex items-center flex-wrap gap-2 mb-3">
   112→            {post.isPinned && (
   113→              <span className="flex items-center gap-1 px-2 py-0.5 rounded-md bg-cyan-500/10 border border-cyan-500/20 text-[9px] font-black uppercase tracking-wider text-cyan-400">
   114→                <Pin size={10} />
   115→                Pinned
   116→              </span>
   117→            )}
   118→            {post.isGuide && (
   119→              <span className="flex items-center gap-1 px-2 py-0.5 rounded-md bg-green-500/10 border border-green-500/20 text-[9px] font-black uppercase tracking-wider text-green-400">
   120→                <Sparkles size={10} />
   121→                Guide
   122→              </span>
   123→            )}
   124→            {showSubForum && (
   125→              <Link
   126→                href={`/forum/${post.categorySlug}`}
   127→                className="text-[10px] font-black uppercase tracking-widest text-cyan-400 hover:text-cyan-300"
   128→              >
   129→                {post.subForumSlug}
   130→              </Link>
   131→            )}
   132→            <span className="flex items-center gap-1.5 text-[10px] font-medium text-neutral-600">
   133→              by{' '}
   134→              <Link
   135→                href={`/forum/user/${post.author.id}`}
   136→                className="text-neutral-400 hover:text-cyan-400 transition-colors"
   137→              >
   138→                u/{post.author.username}
   139→              </Link>
   140→              {post.author.karma !== undefined && post.author.karma > 0 && (
   141→                <KarmaBadge karma={post.author.karma} size="xs" />
   142→              )}
   143→            </span>
   144→            <span className="text-[10px] text-neutral-700">-</span>
   145→            <span className="text-[10px] text-neutral-600">{formatDistanceToNow(post.createdAt)}</span>
   146→          </div>
   147→
   148→          {/* Title */}
   149→          <Link href={`/forum/post/${post.id}`}>
   150→            <h3 className="text-base font-bold text-white group-hover:text-cyan-400 transition-colors leading-snug mb-2">
   151→              {post.title}
   152→            </h3>
   153→          </Link>
   154→
   155→          {/* Preview text - plain text for cards, full markdown on detail page */}
   156→          {post.contentPreview && (
   157→            <p className="text-neutral-500 text-sm line-clamp-2 mb-4 leading-relaxed">
   158→              {post.contentPreview}
   159→            </p>
   160→          )}
   161→
   162→          {/* Action bar */}
   163→          <div className="flex items-center gap-1">
   164→            <Link
   165→              href={`/forum/post/${post.id}`}
   166→              className="flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider text-neutral-500 hover:bg-white/5 hover:text-cyan-400 transition-all"
   167→            >
   168→              <MessageSquare size={14} />
   169→              <span>{post.commentCount} Comments</span>
   170→            </Link>
   171→            <button
   172→              onClick={handleShare}
   173→              className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${
   174→                copied
   175→                  ? 'text-emerald-400 bg-emerald-500/10'
   176→                  : 'text-neutral-500 hover:bg-white/5 hover:text-white'
   177→              }`}
   178→            >
   179→              {copied ? <Check size={14} /> : <Share2 size={14} />}
   180→              <span className="hidden sm:inline">{copied ? 'Copied!' : 'Share'}</span>
   181→            </button>
   182→            <button
   183→              onClick={handleSave}
   184→              disabled={isBookmarking}
   185→              className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all disabled:opacity-50 ${
   186→                isSaved
   187→                  ? 'text-cyan-400 bg-cyan-500/10'
   188→                  : 'text-neutral-500 hover:bg-white/5 hover:text-white'
   189→              }`}
   190→            >
   191→              {isBookmarking ? (
   192→                <Loader2 size={14} className="animate-spin" />
   193→              ) : isSaved ? (
   194→                <BookmarkCheck size={14} />
   195→              ) : (
   196→                <Bookmark size={14} />
   197→              )}
   198→              <span className="hidden sm:inline">{isSaved ? 'Saved' : 'Save'}</span>
   199→            </button>
   200→            <div className="relative">
   201→              <button
   202→                onClick={() => setShowMenu(!showMenu)}
   203→                className="flex items-center gap-2 p-1.5 rounded-lg text-neutral-500 hover:bg-white/5 hover:text-white transition-all"
   204→              >
   205→                <MoreHorizontal size={14} />
   206→              </button>
   207→              {showMenu && (
   208→                <>
   209→                  <div
   210→                    className="fixed inset-0 z-40"
   211→                    onClick={() => setShowMenu(false)}
   212→                  />
   213→                  <div className="absolute right-0 top-full mt-1 z-50 min-w-[140px] rounded-xl bg-neutral-900 border border-white/10 shadow-xl overflow-hidden">
   214→                    <button
   215→                      onClick={handleReport}
   216→                      className="w-full flex items-center gap-2 px-4 py-2.5 text-[10px] font-black uppercase tracking-wider text-neutral-400 hover:bg-white/5 hover:text-red-400 transition-all"
   217→                    >
   218→                      <Flag size={12} />
   219→                      Report
   220→                    </button>
   221→                  </div>
   222→                </>
   223→              )}
   224→            </div>
   225→          </div>
   226→        </div>
   227→      </div>
   228→    </article>
   229→  );
   230→}
   231→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
