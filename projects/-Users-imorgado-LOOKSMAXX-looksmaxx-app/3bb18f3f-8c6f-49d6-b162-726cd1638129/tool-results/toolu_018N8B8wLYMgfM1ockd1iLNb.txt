     1â†’'use client';
     2â†’
     3â†’import { useEffect, useState, useRef, Suspense } from 'react';
     4â†’import { useParams, useRouter, useSearchParams } from 'next/navigation';
     5â†’import Link from 'next/link';
     6â†’import { motion } from 'framer-motion';
     7â†’import { useForum } from '@/contexts/ForumContext';
     8â†’import { PostCard, CreatePostForm, ForumHeader, ForumBreadcrumb } from '@/components/forum';
     9â†’import { SortOrder } from '@/types/forum';
    10â†’import {
    11â†’  Flame,
    12â†’  Clock,
    13â†’  TrendingUp,
    14â†’  X,
    15â†’  Image as ImageIcon,
    16â†’  LinkIcon,
    17â†’  Hash,
    18â†’  ShieldCheck,
    19â†’  ArrowLeft,
    20â†’  PenSquare
    21â†’} from 'lucide-react';
    22â†’
    23â†’// ============================================
    24â†’// SORT TABS
    25â†’// ============================================
    26â†’function SortTabs({ sortOrder, setSortOrder }: { sortOrder: SortOrder; setSortOrder: (s: SortOrder) => void }) {
    27â†’  const sorts = [
    28â†’    { id: 'hot' as const, label: 'Hot', icon: Flame },
    29â†’    { id: 'new' as const, label: 'New', icon: Clock },
    30â†’    { id: 'top' as const, label: 'Top', icon: TrendingUp },
    31â†’  ];
    32â†’
    33â†’  return (
    34â†’    <div className="flex items-center gap-1 p-1.5 bg-neutral-900/30 border border-white/5 rounded-xl">
    35â†’      {sorts.map((sort) => (
    36â†’        <button
    37â†’          key={sort.id}
    38â†’          onClick={() => setSortOrder(sort.id)}
    39â†’          className={`flex items-center gap-2 px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${sortOrder === sort.id
    40â†’              ? 'bg-cyan-500/10 text-cyan-400 border border-cyan-500/20'
    41â†’              : 'text-neutral-600 hover:text-white border border-transparent'
    42â†’            }`}
    43â†’        >
    44â†’          <sort.icon size={12} />
    45â†’          {sort.label}
    46â†’        </button>
    47â†’      ))}
    48â†’    </div>
    49â†’  );
    50â†’}
    51â†’
    52â†’// ============================================
    53â†’// TOPIC PILLS
    54â†’// ============================================
    55â†’function TopicPills({
    56â†’  subForums,
    57â†’  selected,
    58â†’  onSelect
    59â†’}: {
    60â†’  subForums: { id: string; name: string; slug: string; postCount: number }[];
    61â†’  selected: string | null;
    62â†’  onSelect: (slug: string) => void;
    63â†’}) {
    64â†’  return (
    65â†’    <div className="flex flex-wrap gap-2">
    66â†’      {subForums.map((sf) => (
    67â†’        <button
    68â†’          key={sf.id}
    69â†’          onClick={() => onSelect(sf.slug)}
    70â†’          className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${selected === sf.slug
    71â†’              ? 'bg-cyan-500 text-black'
    72â†’              : 'bg-neutral-900/50 border border-white/5 text-neutral-400 hover:border-cyan-500/30 hover:text-cyan-400'
    73â†’            }`}
    74â†’        >
    75â†’          {sf.name}
    76â†’          {sf.postCount > 0 && (
    77â†’            <span className="ml-1.5 opacity-60">{sf.postCount}</span>
    78â†’          )}
    79â†’        </button>
    80â†’      ))}
    81â†’    </div>
    82â†’  );
    83â†’}
    84â†’
    85â†’// ============================================
    86â†’// POST SKELETON
    87â†’// ============================================
    88â†’function PostSkeleton() {
    89â†’  return (
    90â†’    <div className="rounded-2xl bg-neutral-900/30 border border-white/5 overflow-hidden animate-pulse">
    91â†’      <div className="flex">
    92â†’        <div className="w-12 bg-neutral-900/50 py-4 flex flex-col items-center gap-2">
    93â†’          <div className="w-6 h-6 bg-neutral-800 rounded" />
    94â†’          <div className="w-4 h-4 bg-neutral-800 rounded" />
    95â†’          <div className="w-6 h-6 bg-neutral-800 rounded" />
    96â†’        </div>
    97â†’        <div className="flex-1 p-4 space-y-3">
    98â†’          <div className="flex gap-2">
    99â†’            <div className="h-4 w-16 bg-neutral-800 rounded" />
   100â†’            <div className="h-4 w-24 bg-neutral-800 rounded" />
   101â†’          </div>
   102â†’          <div className="h-5 w-3/4 bg-neutral-800 rounded" />
   103â†’          <div className="h-4 w-full bg-neutral-800 rounded" />
   104â†’          <div className="flex gap-2">
   105â†’            <div className="h-6 w-20 bg-neutral-800 rounded" />
   106â†’            <div className="h-6 w-16 bg-neutral-800 rounded" />
   107â†’          </div>
   108â†’        </div>
   109â†’      </div>
   110â†’    </div>
   111â†’  );
   112â†’}
   113â†’
   114â†’// ============================================
   115â†’// CATEGORY CONTENT
   116â†’// ============================================
   117â†’function CategoryContent() {
   118â†’  const params = useParams();
   119â†’  const searchParams = useSearchParams();
   120â†’  const router = useRouter();
   121â†’  const categorySlug = params.categorySlug as string;
   122â†’  const topicParam = searchParams.get('topic');
   123â†’  const isInitialMount = useRef(true);
   124â†’
   125â†’  const {
   126â†’    currentCategory,
   127â†’    posts,
   128â†’    hasMorePosts,
   129â†’    isLoadingPosts,
   130â†’    sortOrder,
   131â†’    setSortOrder,
   132â†’    fetchCategory,
   133â†’    fetchPosts,
   134â†’    loadMorePosts,
   135â†’    votePost,
   136â†’    createPost,
   137â†’    error,
   138â†’  } = useForum();
   139â†’
   140â†’  const [showCreateForm, setShowCreateForm] = useState(false);
   141â†’  const [selectedSubForum, setSelectedSubForum] = useState<string | null>(topicParam);
   142â†’
   143â†’  useEffect(() => {
   144â†’    fetchCategory(categorySlug);
   145â†’    // If topic param is present, fetch posts filtered by it immediately
   146â†’    fetchPosts(categorySlug, topicParam || undefined);
   147â†’    setSelectedSubForum(topicParam);
   148â†’  }, [categorySlug, topicParam, fetchCategory, fetchPosts]);
   149â†’
   150â†’  useEffect(() => {
   151â†’    if (isInitialMount.current) {
   152â†’      isInitialMount.current = false;
   153â†’      return;
   154â†’    }
   155â†’    fetchPosts(categorySlug, undefined, true);
   156â†’  }, [sortOrder, categorySlug, fetchPosts]);
   157â†’
   158â†’  const handleCreatePost = async (title: string, content: string, subForumId: string) => {
   159â†’    try {
   160â†’      const post = await createPost(title, content, subForumId);
   161â†’      setShowCreateForm(false);
   162â†’      router.push(`/forum/post/${post.id}`);
   163â†’    } catch {
   164â†’      // Error handled in context
   165â†’    }
   166â†’  };
   167â†’
   168â†’  const handleSubForumClick = (subForumSlug: string) => {
   169â†’    setSelectedSubForum(subForumSlug === selectedSubForum ? null : subForumSlug);
   170â†’    fetchPosts(categorySlug, subForumSlug === selectedSubForum ? undefined : subForumSlug, true);
   171â†’  };
   172â†’
   173â†’  return (
   174â†’    <div className="min-h-screen bg-black selection:bg-cyan-500/30">
   175â†’      <ForumHeader />
   176â†’      <ForumBreadcrumb items={[
   177â†’        { label: 'Community', href: '/forum' },
   178â†’        { label: currentCategory?.name || categorySlug }
   179â†’      ]} />
   180â†’
   181â†’      {/* Category Header */}
   182â†’      <section className="border-b border-white/5">
   183â†’        <div className="max-w-6xl mx-auto px-6 py-10">
   184â†’          <div className="flex items-start gap-6">
   185â†’            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border border-white/10 flex items-center justify-center text-3xl flex-shrink-0">
   186â†’              {currentCategory?.icon || 'ðŸ“‚'}
   187â†’            </div>
   188â†’            <div className="flex-1 min-w-0">
   189â†’              <h1 className="text-4xl md:text-5xl font-black tracking-tighter italic uppercase mb-3">
   190â†’                {currentCategory?.name || 'Loading...'}
   191â†’              </h1>
   192â†’              <p className="text-neutral-500 text-sm max-w-2xl leading-relaxed">
   193â†’                {currentCategory?.description}
   194â†’              </p>
   195â†’            </div>
   196â†’            <button
   197â†’              onClick={() => setShowCreateForm(true)}
   198â†’              className="hidden md:flex h-11 px-6 rounded-xl bg-cyan-500 text-black text-[10px] font-black uppercase tracking-widest items-center gap-2 hover:bg-cyan-400 transition-all shadow-lg shadow-cyan-500/20"
   199â†’            >
   200â†’              <PenSquare size={14} />
   201â†’              New Post
   202â†’            </button>
   203â†’          </div>
   204â†’        </div>
   205â†’      </section>
   206â†’
   207â†’      {/* Main Content */}
   208â†’      <main className="max-w-6xl mx-auto px-6 py-10">
   209â†’        <div className="flex flex-col lg:flex-row gap-10">
   210â†’          {/* Main Feed */}
   211â†’          <div className="flex-1 min-w-0">
   212â†’            {/* Create Post Form */}
   213â†’            {showCreateForm && currentCategory ? (
   214â†’              <motion.div
   215â†’                initial={{ opacity: 0, y: -10 }}
   216â†’                animate={{ opacity: 1, y: 0 }}
   217â†’                className="p-6 rounded-2xl bg-neutral-900/30 border border-white/5 mb-6"
   218â†’              >
   219â†’                <div className="flex items-center justify-between mb-6">
   220â†’                  <h2 className="text-sm font-black uppercase tracking-wider text-white">Create a Post</h2>
   221â†’                  <button
   222â†’                    onClick={() => setShowCreateForm(false)}
   223â†’                    className="p-2 rounded-lg hover:bg-white/5 text-neutral-500 hover:text-white transition-all"
   224â†’                  >
   225â†’                    <X size={16} />
   226â†’                  </button>
   227â†’                </div>
   228â†’                <CreatePostForm
   229â†’                  subForums={currentCategory.subForums}
   230â†’                  onSubmit={handleCreatePost}
   231â†’                  onCancel={() => setShowCreateForm(false)}
   232â†’                />
   233â†’              </motion.div>
   234â†’            ) : (
   235â†’              <div
   236â†’                onClick={() => setShowCreateForm(true)}
   237â†’                className="flex items-center gap-4 p-4 rounded-2xl bg-neutral-900/30 border border-white/5 hover:border-cyan-500/20 cursor-pointer transition-all mb-6"
   238â†’              >
   239â†’                <div className="w-10 h-10 rounded-xl bg-neutral-900 border border-white/5" />
   240â†’                <div className="flex-1 px-4 py-2.5 rounded-xl bg-neutral-900/50 border border-white/5 text-neutral-600 text-sm">
   241â†’                  Create Post
   242â†’                </div>
   243â†’                <button className="p-2 rounded-lg hover:bg-white/5 text-neutral-600 hover:text-cyan-400 transition-all">
   244â†’                  <ImageIcon size={18} />
   245â†’                </button>
   246â†’                <button className="p-2 rounded-lg hover:bg-white/5 text-neutral-600 hover:text-cyan-400 transition-all">
   247â†’                  <LinkIcon size={18} />
   248â†’                </button>
   249â†’              </div>
   250â†’            )}
   251â†’
   252â†’            {/* Sort & Filter */}
   253â†’            <div className="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
   254â†’              <SortTabs sortOrder={sortOrder} setSortOrder={setSortOrder} />
   255â†’            </div>
   256â†’
   257â†’            {/* Topic Filter */}
   258â†’            {currentCategory && currentCategory.subForums.length > 0 && (
   259â†’              <div className="mb-6">
   260â†’                <TopicPills
   261â†’                  subForums={currentCategory.subForums}
   262â†’                  selected={selectedSubForum}
   263â†’                  onSelect={handleSubForumClick}
   264â†’                />
   265â†’              </div>
   266â†’            )}
   267â†’
   268â†’            {/* Error */}
   269â†’            {error && (
   270â†’              <div className="p-4 rounded-xl bg-red-500/10 border border-red-500/20 mb-6">
   271â†’                <p className="text-red-400 text-sm">{error}</p>
   272â†’              </div>
   273â†’            )}
   274â†’
   275â†’            {/* Posts */}
   276â†’            <div className="space-y-4">
   277â†’              {isLoadingPosts && posts.length === 0 ? (
   278â†’                [1, 2, 3].map((i) => <PostSkeleton key={i} />)
   279â†’              ) : posts.length > 0 ? (
   280â†’                <>
   281â†’                  {posts.map((post) => (
   282â†’                    <PostCard
   283â†’                      key={post.id}
   284â†’                      post={post}
   285â†’                      onVote={(postId, voteType) => votePost(postId, voteType)}
   286â†’                    />
   287â†’                  ))}
   288â†’                  {hasMorePosts && (
   289â†’                    <button
   290â†’                      onClick={() => loadMorePosts(categorySlug, selectedSubForum || undefined)}
   291â†’                      disabled={isLoadingPosts}
   292â†’                      className="w-full py-4 text-[10px] font-black uppercase tracking-widest text-cyan-400 hover:text-cyan-300 disabled:opacity-50 transition-colors"
   293â†’                    >
   294â†’                      {isLoadingPosts ? 'Loading...' : 'Load More Posts'}
   295â†’                    </button>
   296â†’                  )}
   297â†’                </>
   298â†’              ) : (
   299â†’                <div className="text-center py-16 rounded-2xl bg-neutral-900/30 border border-white/5">
   300â†’                  <div className="text-5xl mb-4">ðŸŒ±</div>
   301â†’                  <p className="text-white font-bold mb-2">No posts yet</p>
   302â†’                  <p className="text-neutral-500 text-sm">Be the first to share something!</p>
   303â†’                </div>
   304â†’              )}
   305â†’            </div>
   306â†’          </div>
   307â†’
   308â†’          {/* Sidebar */}
   309â†’          <aside className="lg:w-80 space-y-6">
   310â†’            {/* About */}
   311â†’            <div className="rounded-2xl bg-neutral-900/30 border border-white/5 overflow-hidden">
   312â†’              <div className="px-5 py-3 bg-cyan-500/10 border-b border-white/5">
   313â†’                <h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-cyan-400">About Community</h3>
   314â†’              </div>
   315â†’              <div className="p-5">
   316â†’                <p className="text-sm text-neutral-400 mb-5 leading-relaxed">
   317â†’                  {currentCategory?.description || 'Loading...'}
   318â†’                </p>
   319â†’                <div className="grid grid-cols-2 gap-4 pb-5 border-b border-white/5 mb-5">
   320â†’                  <div>
   321â†’                    <p className="text-lg font-black italic text-white">{currentCategory?.postCount || 0}</p>
   322â†’                    <p className="text-[9px] font-black uppercase tracking-widest text-neutral-600">Posts</p>
   323â†’                  </div>
   324â†’                  <div>
   325â†’                    <p className="text-lg font-black italic text-white">{currentCategory?.subForums.length || 0}</p>
   326â†’                    <p className="text-[9px] font-black uppercase tracking-widest text-neutral-600">Topics</p>
   327â†’                  </div>
   328â†’                </div>
   329â†’                <button
   330â†’                  onClick={() => setShowCreateForm(true)}
   331â†’                  className="w-full py-3 bg-cyan-500 text-black text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-cyan-400 transition-all"
   332â†’                >
   333â†’                  Create Post
   334â†’                </button>
   335â†’              </div>
   336â†’            </div>
   337â†’
   338â†’            {/* Topics */}
   339â†’            {currentCategory && currentCategory.subForums.length > 0 && (
   340â†’              <div className="rounded-2xl bg-neutral-900/30 border border-white/5 overflow-hidden">
   341â†’                <div className="px-5 py-3 border-b border-white/5">
   342â†’                  <div className="flex items-center gap-2">
   343â†’                    <Hash size={12} className="text-cyan-400" />
   344â†’                    <h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-500">Topics</h3>
   345â†’                  </div>
   346â†’                </div>
   347â†’                <div className="p-3">
   348â†’                  {currentCategory.subForums.map((sf) => (
   349â†’                    <button
   350â†’                      key={sf.id}
   351â†’                      onClick={() => handleSubForumClick(sf.slug)}
   352â†’                      className={`w-full text-left px-4 py-2.5 rounded-lg text-sm transition-all flex justify-between items-center ${selectedSubForum === sf.slug
   353â†’                        ? 'bg-cyan-500/10 text-cyan-400'
   354â†’                        : 'text-neutral-400 hover:bg-white/5 hover:text-white'
   355â†’                        }`}
   356â†’                    >
   357â†’                      <span>{sf.name}</span>
   358â†’                      <span className="text-[10px] text-neutral-600">{sf.postCount}</span>
   359â†’                    </button>
   360â†’                  ))}
   361â†’                </div>
   362â†’              </div>
   363â†’            )}
   364â†’
   365â†’            {/* Rules */}
   366â†’            <div className="rounded-2xl bg-neutral-900/30 border border-white/5 overflow-hidden">
   367â†’              <div className="px-5 py-3 border-b border-white/5">
   368â†’                <div className="flex items-center gap-2">
   369â†’                  <ShieldCheck size={12} className="text-cyan-400" />
   370â†’                  <h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-500">Rules</h3>
   371â†’                </div>
   372â†’              </div>
   373â†’              <div className="p-5 space-y-3 text-sm text-neutral-400">
   374â†’                <div className="flex gap-3">
   375â†’                  <span className="text-cyan-400 font-black">1.</span>
   376â†’                  <span>Be respectful to others</span>
   377â†’                </div>
   378â†’                <div className="flex gap-3">
   379â†’                  <span className="text-cyan-400 font-black">2.</span>
   380â†’                  <span>No medical advice</span>
   381â†’                </div>
   382â†’                <div className="flex gap-3">
   383â†’                  <span className="text-cyan-400 font-black">3.</span>
   384â†’                  <span>Share evidence-based info</span>
   385â†’                </div>
   386â†’              </div>
   387â†’            </div>
   388â†’
   389â†’            {/* Back link */}
   390â†’            <Link
   391â†’              href="/forum"
   392â†’              className="flex items-center justify-center gap-2 py-3 text-[10px] font-black uppercase tracking-widest text-neutral-600 hover:text-cyan-400 transition-colors"
   393â†’            >
   394â†’              <ArrowLeft size={12} />
   395â†’              Back to all communities
   396â†’            </Link>
   397â†’          </aside>
   398â†’        </div>
   399â†’      </main>
   400â†’    </div>
   401â†’  );
   402â†’}
   403â†’
   404â†’// ============================================
   405â†’// MAIN PAGE (Suspense wrapped for useSearchParams)
   406â†’// ============================================
   407â†’export default function CategoryPage() {
   408â†’  return (
   409â†’    <Suspense fallback={
   410â†’      <div className="min-h-screen bg-black flex items-center justify-center">
   411â†’        <div className="w-10 h-10 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin" />
   412â†’      </div>
   413â†’    }>
   414â†’      <CategoryContent />
   415â†’    </Suspense>
   416â†’  );
   417â†’}
   418â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
