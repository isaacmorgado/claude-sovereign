     1→/**
     2→ * Product Recommendation Engine
     3→ * Maps facial metrics to supplement product recommendations
     4→ */
     5→
     6→import { ProductRecommendation } from '@/types/results';
     7→import { PRODUCTS } from './product_db';
     8→import { SUPPLEMENTS } from './recommendations/supplements';
     9→
    10→// ============================================
    11→// METRIC TO PRODUCT MAPPING
    12→// ============================================
    13→
    14→const METRIC_TO_PRODUCTS: Record<string, string[]> = {
    15→  // Skin quality metrics -> skin products
    16→  "Skin Texture Score": ["collagen_peptides", "vitamin_c_oral", "astaxanthin", "vitamin_e"],
    17→  "Under Eye Area": ["collagen_peptides", "hyaluronic_acid_oral", "vitamin_e", "coq10"],
    18→  "Skin Quality": ["collagen_peptides", "astaxanthin", "vitamin_c_oral", "omega_3"],
    19→
    20→  // Bone/structure metrics -> bone + muscle products
    21→  "Gonial Angle": ["creatine", "vitamin_d3", "vitamin_k2", "magnesium"],
    22→  "Bigonial Width": ["creatine", "vitamin_d3", "vitamin_k2"],
    23→  "Jaw Projection": ["creatine", "vitamin_d3", "magnesium"],
    24→  "Cheekbone Height": ["collagen_peptides", "vitamin_k2", "silica", "vitamin_d3"],
    25→  "Cheekbone Prominence": ["collagen_peptides", "vitamin_k2", "vitamin_d3"],
    26→  "Chin Projection": ["creatine", "vitamin_d3", "vitamin_k2"],
    27→
    28→  // Eye metrics -> general anti-aging
    29→  "Canthal Tilt": ["collagen_peptides", "vitamin_c_oral", "astaxanthin"],
    30→  "Eye Spacing Ratio": ["collagen_peptides", "vitamin_c_oral"],
    31→  "Palpebral Fissure Height": ["collagen_peptides", "vitamin_c_oral"],
    32→
    33→  // Hair metrics -> hair products
    34→  "Hairline Position": ["biotin", "vitamin_d3", "iron", "saw_palmetto"],
    35→  "Hairline Recession": ["biotin", "saw_palmetto", "iron", "vitamin_d3"],
    36→
    37→  // Nose metrics -> collagen + structure
    38→  "Nasal Tip Angle": ["collagen_peptides", "vitamin_c_oral"],
    39→  "Nasal Bridge Width": ["collagen_peptides", "vitamin_c_oral"],
    40→
    41→  // Lips -> collagen
    42→  "Lip Fullness": ["collagen_peptides", "hyaluronic_acid_oral", "vitamin_c_oral"],
    43→  "Upper Lip Height": ["collagen_peptides", "vitamin_c_oral"],
    44→
    45→  // Neck -> posture + muscle
    46→  "Neck Posture": ["magnesium", "vitamin_d3", "creatine"],
    47→  "Cervicomental Angle": ["creatine", "magnesium"],
    48→
    49→  // General harmony -> comprehensive stack
    50→  "Overall Facial Harmony": ["omega_3", "coq10", "collagen_peptides", "vitamin_d3"],
    51→  "Facial Symmetry": ["omega_3", "magnesium", "vitamin_d3"],
    52→
    53→  // Age-related -> anti-aging
    54→  "Facial Aging Score": ["nad_precursor", "resveratrol", "coq10", "collagen_peptides"],
    55→  "Skin Laxity": ["collagen_peptides", "vitamin_c_oral", "astaxanthin", "coq10"],
    56→};
    57→
    58→// Category fallbacks (if specific metric not found)
    59→const CATEGORY_TO_PRODUCTS: Record<string, string[]> = {
    60→  "skin": ["collagen_peptides", "vitamin_c_oral", "astaxanthin", "vitamin_e"],
    61→  "bone": ["vitamin_d3", "vitamin_k2", "creatine", "magnesium", "silica", "msm"],
    62→  "hair": ["biotin", "iron", "saw_palmetto", "vitamin_d3", "zinc"],
    63→  "anti-aging": ["nad_precursor", "coq10", "resveratrol", "omega_3"],
    64→  "hormonal": ["ashwagandha", "tongkat_ali", "dim", "vitamin_d3"],
    65→  "general": ["omega_3", "magnesium", "vitamin_d3", "creatine"],
    66→};
    67→
    68→// ============================================
    69→// PRODUCT RECOMMENDATIONS
    70→// ============================================
    71→
    72→export function getProductRecommendations(
    73→  metricsDict: Record<string, number>,
    74→  severityDict: Record<string, string>,
    75→  // These parameters are reserved for future gender/ethnicity-specific recommendations
    76→  // eslint-disable-next-line @typescript-eslint/no-unused-vars
    77→  gender: 'male' | 'female',
    78→  // eslint-disable-next-line @typescript-eslint/no-unused-vars
    79→  ethnicity: string
    80→): ProductRecommendation[] {
    81→  const recommendations: ProductRecommendation[] = [];
    82→  const seenProducts = new Set<string>();
    83→
    84→  // Iterate through all metrics
    85→  for (const metricName of Object.keys(metricsDict)) {
    86→    const severity = severityDict[metricName];
    87→    if (!severity) continue;
    88→
    89→    // Determine state and urgency
    90→    let state: "flaw" | "ideal";
    91→    let urgency: "high" | "medium" | "low";
    92→    let messageTemplate: string;
    93→
    94→    if (severity === "severe" || severity === "extremely_severe") {
    95→      state = "flaw";
    96→      urgency = "high";
    97→      messageTemplate = "Your {metric} is below optimal. Use {product} to IMPROVE it.";
    98→    } else if (severity === "moderate" || severity === "major") {
    99→      state = "flaw";
   100→      urgency = "medium";
   101→      messageTemplate = "Your {metric} needs improvement. Use {product} to optimize it.";
   102→    } else if (severity === "optimal" || severity === "ideal") {
   103→      state = "ideal";
   104→      urgency = "low";
   105→      messageTemplate = "Your {metric} is excellent. Use {product} to MAINTAIN and PROTECT this strength.";
   106→    } else {
   107→      continue; // Skip "minor" or "good" - not compelling enough
   108→    }
   109→
   110→    // Find products for this metric
   111→    let productIds = METRIC_TO_PRODUCTS[metricName];
   112→
   113→    // If no direct mapping, try category fallback
   114→    if (!productIds || productIds.length === 0) {
   115→      const metricLower = metricName.toLowerCase();
   116→      if (metricLower.includes('skin') || metricLower.includes('texture')) {
   117→        productIds = CATEGORY_TO_PRODUCTS['skin'];
   118→      } else if (metricLower.includes('jaw') || metricLower.includes('chin') || metricLower.includes('bone')) {
   119→        productIds = CATEGORY_TO_PRODUCTS['bone'];
   120→      } else if (metricLower.includes('hair')) {
   121→        productIds = CATEGORY_TO_PRODUCTS['hair'];
   122→      } else {
   123→        productIds = CATEGORY_TO_PRODUCTS['general'];
   124→      }
   125→    }
   126→
   127→    // Create recommendations for each product
   128→    for (const supplementId of productIds.slice(0, 2)) {
   129→      // Find product in PRODUCTS by supplementId
   130→      const product = PRODUCTS.find(p => p.supplementId === supplementId);
   131→      if (!product) continue;
   132→
   133→      // Skip if already recommended
   134→      if (seenProducts.has(product.id)) {
   135→        // Just add this metric to existing recommendation
   136→        const existing = recommendations.find(r => r.product.id === product.id);
   137→        if (existing && !existing.matchedMetrics.includes(metricName)) {
   138→          existing.matchedMetrics.push(metricName);
   139→        }
   140→        continue;
   141→      }
   142→
   143→      // Get supplement details for the product name
   144→      const supplement = SUPPLEMENTS.find(s => s.id === supplementId);
   145→      const productDisplayName = supplement?.name || product.name;
   146→
   147→      // Create personalized message
   148→      const message = messageTemplate
   149→        .replace('{metric}', metricName)
   150→        .replace('{product}', productDisplayName);
   151→
   152→      recommendations.push({
   153→        product,
   154→        state,
   155→        targetMetric: metricName,
   156→        message,
   157→        urgency,
   158→        matchedMetrics: [metricName],
   159→      });
   160→
   161→      seenProducts.add(product.id);
   162→    }
   163→  }
   164→
   165→  // Sort recommendations
   166→  // 1. High urgency flaws first
   167→  // 2. Then medium urgency flaws
   168→  // 3. Then ideal maintenance products
   169→  recommendations.sort((a, b) => {
   170→    const urgencyOrder: Record<string, number> = { high: 3, medium: 2, low: 1 };
   171→    const urgencyDiff = urgencyOrder[b.urgency] - urgencyOrder[a.urgency];
   172→    if (urgencyDiff !== 0) return urgencyDiff;
   173→
   174→    // Within same urgency, sort by product priority
   175→    return b.product.priority - a.product.priority;
   176→  });
   177→
   178→  // Return top 15 recommendations
   179→  return recommendations.slice(0, 15);
   180→}
   181→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
