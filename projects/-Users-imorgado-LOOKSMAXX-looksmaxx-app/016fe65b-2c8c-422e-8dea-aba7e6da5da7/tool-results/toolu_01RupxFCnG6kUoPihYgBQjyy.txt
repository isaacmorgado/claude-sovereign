     1→'use client';
     2→
     3→import { useState, useMemo, useCallback } from 'react';
     4→import { motion, AnimatePresence } from 'framer-motion';
     5→import {
     6→  Sparkles,
     7→  TrendingUp,
     8→  Target,
     9→  Zap,
    10→  ChevronRight,
    11→  Lock,
    12→  CheckCircle,
    13→  AlertCircle,
    14→  CheckCircle2,
    15→} from 'lucide-react';
    16→import { useResults } from '@/contexts/ResultsContext';
    17→import { useAuth } from '@/contexts/AuthContext';
    18→import { TabContent } from '../ResultsLayout';
    19→import { EnhancedRecommendationCard } from '../cards/EnhancedRecommendationCard';
    20→import { ScoreCircle, PhaseBadge } from '../shared';
    21→import { BeforeAfterPreview } from '../visualization/BeforeAfterPreview';
    22→import { TreatmentTimeline } from '../visualization/TreatmentTimeline';
    23→import { RecommendationPhase } from '@/types/results';
    24→import { DailyStackCard } from '../cards/DailyStackCard';
    25→import { ProductCard } from '../cards/ProductCard';
    26→import { generateDailyStack } from '@/lib/daily-stack';
    27→import { getProductRecommendations } from '@/lib/product-recommendations';
    28→
    29→// ============================================
    30→// POTENTIAL SCORE CARD
    31→// ============================================
    32→
    33→function PotentialScoreCard() {
    34→  const { overallScore, recommendations } = useResults();
    35→
    36→  // Calculate potential improvement
    37→  const potentialImprovement = useMemo(() => {
    38→    if (recommendations.length === 0) return 0;
    39→    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);
    40→    return Math.min(totalImpact * 1.5, 10 - overallScore);
    41→  }, [recommendations, overallScore]);
    42→
    43→  const potentialScore = Math.min(10, overallScore + potentialImprovement);
    44→
    45→  return (
    46→    <motion.div
    47→      className="bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6"
    48→      initial={{ opacity: 0, y: 20 }}
    49→      animate={{ opacity: 1, y: 0 }}
    50→    >
    51→      <div className="flex items-center gap-2 mb-4">
    52→        <Sparkles size={20} className="text-cyan-400" />
    53→        <h3 className="font-semibold text-white">Your Potential</h3>
    54→      </div>
    55→
    56→      <div className="flex items-center justify-center gap-8 mb-6">
    57→        {/* Current */}
    58→        <div className="text-center">
    59→          <p className="text-xs text-neutral-500 mb-2">Current</p>
    60→          <ScoreCircle score={overallScore} size="lg" animate={false} />
    61→        </div>
    62→
    63→        {/* Arrow */}
    64→        <div className="flex flex-col items-center gap-1">
    65→          <ChevronRight size={24} className="text-cyan-400" />
    66→          <span className="text-xs text-green-400">+{potentialImprovement.toFixed(1)}</span>
    67→        </div>
    68→
    69→        {/* Potential */}
    70→        <div className="text-center">
    71→          <p className="text-xs text-neutral-500 mb-2">Potential</p>
    72→          <div className="relative">
    73→            <ScoreCircle score={potentialScore} size="lg" animate={false} />
    74→            <div className="absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
    75→              <TrendingUp size={12} className="text-black" />
    76→            </div>
    77→          </div>
    78→        </div>
    79→      </div>
    80→
    81→      <p className="text-sm text-neutral-400 text-center">
    82→        Following our recommendations could improve your harmony score by up to{' '}
    83→        <span className="text-green-400 font-medium">+{potentialImprovement.toFixed(1)} points</span>
    84→      </p>
    85→    </motion.div>
    86→  );
    87→}
    88→
    89→// ============================================
    90→// PHASE FILTER
    91→// ============================================
    92→
    93→interface PhaseFilterProps {
    94→  selectedPhase: RecommendationPhase | null;
    95→  onSelect: (phase: RecommendationPhase | null) => void;
    96→  counts: Record<RecommendationPhase, number>;
    97→}
    98→
    99→function PhaseFilter({ selectedPhase, onSelect, counts }: PhaseFilterProps) {
   100→  const phases: RecommendationPhase[] = ['Foundational', 'Minimally Invasive', 'Surgical'];
   101→
   102→  return (
   103→    <div className="flex flex-wrap gap-2">
   104→      <button
   105→        onClick={() => onSelect(null)}
   106→        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
   107→          selectedPhase === null
   108→            ? 'bg-cyan-500 text-black'
   109→            : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'
   110→        }`}
   111→      >
   112→        All ({Object.values(counts).reduce((a, b) => a + b, 0)})
   113→      </button>
   114→      {phases.map(phase => (
   115→        <button
   116→          key={phase}
   117→          onClick={() => onSelect(phase)}
   118→          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${
   119→            selectedPhase === phase
   120→              ? 'bg-neutral-700 text-white'
   121→              : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'
   122→          }`}
   123→        >
   124→          <PhaseBadge phase={phase} size="sm" />
   125→          ({counts[phase] || 0})
   126→        </button>
   127→      ))}
   128→    </div>
   129→  );
   130→}
   131→
   132→// ============================================
   133→// BEFORE/AFTER PREVIEW SECTION
   134→// ============================================
   135→
   136→function BeforeAfterPreviewSection() {
   137→  const { frontPhoto, overallScore, recommendations } = useResults();
   138→
   139→  // Calculate potential improvement
   140→  const potentialImprovement = useMemo(() => {
   141→    if (recommendations.length === 0) return 0;
   142→    const totalImpact = recommendations.slice(0, 5).reduce((sum, r) => sum + r.impact, 0);
   143→    return Math.min(totalImpact * 1.5, 10 - overallScore);
   144→  }, [recommendations, overallScore]);
   145→
   146→  const potentialScore = Math.min(10, overallScore + potentialImprovement);
   147→
   148→  if (!frontPhoto) return null;
   149→
   150→  return (
   151→    <BeforeAfterPreview
   152→      photo={frontPhoto}
   153→      currentScore={overallScore}
   154→      potentialScore={potentialScore}
   155→      recommendations={recommendations}
   156→    />
   157→  );
   158→}
   159→
   160→// ============================================
   161→// ORDER OF OPERATIONS
   162→// ============================================
   163→
   164→function OrderOfOperations() {
   165→  return (
   166→    <div className="bg-neutral-900/50 border border-neutral-800 rounded-xl p-4">
   167→      <h4 className="font-medium text-white mb-3 flex items-center gap-2">
   168→        <Target size={16} className="text-cyan-400" />
   169→        Recommended Order
   170→      </h4>
   171→      <div className="space-y-3">
   172→        <div className="flex items-start gap-3">
   173→          <div className="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
   174→            <span className="text-xs font-bold text-green-400">1</span>
   175→          </div>
   176→          <div>
   177→            <p className="text-sm font-medium text-white">Start with Foundational</p>
   178→            <p className="text-xs text-neutral-500">Low-cost, no-risk improvements that anyone can do</p>
   179→          </div>
   180→        </div>
   181→        <div className="flex items-start gap-3">
   182→          <div className="w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
   183→            <span className="text-xs font-bold text-yellow-400">2</span>
   184→          </div>
   185→          <div>
   186→            <p className="text-sm font-medium text-white">Consider Minimally Invasive</p>
   187→            <p className="text-xs text-neutral-500">Temporary or reversible options with moderate impact</p>
   188→          </div>
   189→        </div>
   190→        <div className="flex items-start gap-3">
   191→          <div className="w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
   192→            <span className="text-xs font-bold text-red-400">3</span>
   193→          </div>
   194→          <div>
   195→            <p className="text-sm font-medium text-white">Evaluate Surgical Options</p>
   196→            <p className="text-xs text-neutral-500">Permanent solutions for significant improvements</p>
   197→          </div>
   198→        </div>
   199→      </div>
   200→    </div>
   201→  );
   202→}
   203→
   204→// ============================================
   205→// PLAN TAB
   206→// ============================================
   207→
   208→export function PlanTab() {
   209→  const { recommendations, flaws, gender, ethnicity, frontRatios, sideRatios } = useResults();
   210→  const { user } = useAuth();
   211→  const [selectedPhase, setSelectedPhase] = useState<RecommendationPhase | null>(null);
   212→  const [expandedId, setExpandedId] = useState<string | null>(null);
   213→  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set());
   214→  const [removedIds, setRemovedIds] = useState<Set<string>>(new Set());
   215→
   216→  // Check if user has a paid plan
   217→  const hasPaidPlan = user?.plan === 'basic' || user?.plan === 'pro';
   218→
   219→  // Generate Daily Stack for all users
   220→  const dailyStack = useMemo(() => {
   221→    return generateDailyStack(gender);
   222→  }, [gender]);
   223→
   224→  // Generate Product Recommendations based on metrics
   225→  const productRecommendations = useMemo(() => {
   226→    // Build metrics and severity dictionaries from ratios
   227→    const metricsDict: Record<string, number> = {};
   228→    const severityDict: Record<string, string> = {};
   229→
   230→    [...frontRatios, ...sideRatios].forEach(ratio => {
   231→      metricsDict[ratio.name] = ratio.value;
   232→      severityDict[ratio.name] = ratio.severity;
   233→    });
   234→
   235→    return getProductRecommendations(metricsDict, severityDict, gender, ethnicity);
   236→  }, [frontRatios, sideRatios, gender, ethnicity]);
   237→
   238→  // Split product recommendations by state
   239→  const { flawProducts, idealProducts } = useMemo(() => {
   240→    const flaw = productRecommendations.filter(r => r.state === 'flaw');
   241→    const ideal = productRecommendations.filter(r => r.state === 'ideal');
   242→    return { flawProducts: flaw, idealProducts: ideal };
   243→  }, [productRecommendations]);
   244→
   245→  // Count recommendations by phase
   246→  const phaseCounts = useMemo(() => {
   247→    const counts: Record<RecommendationPhase, number> = {
   248→      'Foundational': 0,
   249→      'Minimally Invasive': 0,
   250→      'Surgical': 0,
   251→    };
   252→    recommendations.forEach(r => {
   253→      if (!removedIds.has(r.ref_id)) {
   254→        counts[r.phase]++;
   255→      }
   256→    });
   257→    return counts;
   258→  }, [recommendations, removedIds]);
   259→
   260→  // Filter recommendations
   261→  const filteredRecommendations = useMemo(() => {
   262→    let filtered = recommendations.filter(r => !removedIds.has(r.ref_id));
   263→    if (selectedPhase) {
   264→      filtered = filtered.filter(r => r.phase === selectedPhase);
   265→    }
   266→    return filtered;
   267→  }, [recommendations, selectedPhase, removedIds]);
   268→
   269→  const hasRecommendations = filteredRecommendations.length > 0;
   270→
   271→  // Handle mark complete
   272→  const handleMarkComplete = useCallback((id: string) => {
   273→    setCompletedIds(prev => {
   274→      const newSet = new Set(prev);
   275→      if (newSet.has(id)) {
   276→        newSet.delete(id);
   277→      } else {
   278→        newSet.add(id);
   279→      }
   280→      return newSet;
   281→    });
   282→  }, []);
   283→
   284→  // Handle remove
   285→  const handleRemove = useCallback((id: string) => {
   286→    setRemovedIds(prev => {
   287→      const newSet = new Set(prev);
   288→      newSet.add(id);
   289→      return newSet;
   290→    });
   291→    if (expandedId === id) {
   292→      setExpandedId(null);
   293→    }
   294→  }, [expandedId]);
   295→
   296→  return (
   297→    <TabContent
   298→      title="Your Plan & Potential"
   299→      subtitle="Personalized recommendations based on your analysis"
   300→    >
   301→      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
   302→        {/* Main Content */}
   303→        <div className="lg:col-span-2 space-y-6">
   304→          {/* Daily Stack Card - Hero Element for ALL users */}
   305→          {dailyStack && <DailyStackCard dailyStack={dailyStack} />}
   306→
   307→          {/* Potential Score */}
   308→          <PotentialScoreCard />
   309→
   310→          {/* Targeted Product Recommendations - Corrective */}
   311→          {flawProducts.length > 0 && (
   312→            <div className="space-y-4">
   313→              <div className="flex items-center gap-2">
   314→                <AlertCircle size={20} className="text-red-400" />
   315→                <h3 className="text-lg font-semibold text-white">Fix These Areas</h3>
   316→                <span className="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded-full border border-red-500/30">
   317→                  Corrective
   318→                </span>
   319→              </div>
   320→              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
   321→                {flawProducts.slice(0, 6).map((rec, index) => (
   322→                  <ProductCard key={rec.product.id} recommendation={rec} rank={index + 1} />
   323→                ))}
   324→              </div>
   325→            </div>
   326→          )}
   327→
   328→          {/* Targeted Product Recommendations - Maintenance */}
   329→          {idealProducts.length > 0 && (
   330→            <div className="space-y-4">
   331→              <div className="flex items-center gap-2">
   332→                <CheckCircle2 size={20} className="text-green-400" />
   333→                <h3 className="text-lg font-semibold text-white">Protect Your Strengths</h3>
   334→                <span className="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded-full border border-green-500/30">
   335→                  Maintenance
   336→                </span>
   337→              </div>
   338→              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
   339→                {idealProducts.slice(0, 4).map((rec) => (
   340→                  <ProductCard key={rec.product.id} recommendation={rec} />
   341→                ))}
   342→              </div>
   343→            </div>
   344→          )}
   345→
   346→          {/* Treatment Timeline */}
   347→          {recommendations.length > 0 && (
   348→            <TreatmentTimeline recommendations={recommendations.filter(r => !removedIds.has(r.ref_id))} />
   349→          )}
   350→
   351→          {/* Phase Filter */}
   352→          <PhaseFilter
   353→            selectedPhase={selectedPhase}
   354→            onSelect={setSelectedPhase}
   355→            counts={phaseCounts}
   356→          />
   357→
   358→          {/* Recommendations List */}
   359→          {hasRecommendations ? (
   360→            <motion.div className="space-y-4" layout>
   361→              <AnimatePresence mode="popLayout">
   362→                {filteredRecommendations.map((rec, index) => (
   363→                  <motion.div
   364→                    key={rec.ref_id}
   365→                    layout
   366→                    initial={{ opacity: 0, y: 20 }}
   367→                    animate={{ opacity: 1, y: 0 }}
   368→                    exit={{ opacity: 0, y: -20 }}
   369→                    transition={{ duration: 0.2, delay: index * 0.05 }}
   370→                  >
   371→                    <EnhancedRecommendationCard
   372→                      recommendation={rec}
   373→                      rank={index + 1}
   374→                      isExpanded={expandedId === rec.ref_id}
   375→                      onToggle={() => setExpandedId(
   376→                        expandedId === rec.ref_id ? null : rec.ref_id
   377→                      )}
   378→                      onMarkComplete={handleMarkComplete}
   379→                      onRemove={handleRemove}
   380→                      isCompleted={completedIds.has(rec.ref_id)}
   381→                      gender={gender}
   382→                      ethnicity={ethnicity}
   383→                    />
   384→                  </motion.div>
   385→                ))}
   386→              </AnimatePresence>
   387→            </motion.div>
   388→          ) : (
   389→            <div className="bg-neutral-900/50 border border-neutral-800 rounded-xl p-8 text-center">
   390→              <Sparkles size={48} className="mx-auto text-neutral-700 mb-4" />
   391→              <h3 className="text-lg font-medium text-white mb-2">No Recommendations Yet</h3>
   392→              <p className="text-neutral-500 mb-4">
   393→                Complete a facial analysis to get personalized recommendations
   394→              </p>
   395→            </div>
   396→          )}
   397→        </div>
   398→
   399→        {/* Sidebar */}
   400→        <div className="space-y-6">
   401→          {/* Before/After Preview */}
   402→          <BeforeAfterPreviewSection />
   403→
   404→          {/* Order of Operations */}
   405→          <OrderOfOperations />
   406→
   407→          {/* My Plan Summary */}
   408→          <div className="bg-neutral-900/50 border border-neutral-800 rounded-xl p-4">
   409→            <h4 className="font-medium text-white mb-3 flex items-center gap-2">
   410→              <Zap size={16} className="text-yellow-400" />
   411→              My Plan
   412→            </h4>
   413→            <div className="text-center py-6">
   414→              <div className="w-12 h-12 mx-auto mb-3 rounded-xl bg-neutral-800 flex items-center justify-center">
   415→                <Lock size={20} className="text-neutral-600" />
   416→              </div>
   417→              <p className="text-sm text-neutral-500 mb-3">
   418→                Add recommendations to build your personalized plan
   419→              </p>
   420→              <p className="text-xs text-neutral-600">
   421→                0 items selected
   422→              </p>
   423→            </div>
   424→          </div>
   425→
   426→          {/* Issues Summary */}
   427→          <div className="bg-neutral-900/50 border border-neutral-800 rounded-xl p-4">
   428→            <h4 className="font-medium text-white mb-3">Detected Issues</h4>
   429→            <div className="space-y-2">
   430→              {flaws.slice(0, 5).map(flaw => (
   431→                <div
   432→                  key={flaw.id}
   433→                  className="flex items-center justify-between p-2 bg-neutral-800/50 rounded-lg"
   434→                >
   435→                  <span className="text-sm text-neutral-300 truncate">{flaw.flawName}</span>
   436→                  <span className="text-xs text-red-400 flex-shrink-0">
   437→                    -{flaw.harmonyPercentageLost.toFixed(1)}%
   438→                  </span>
   439→                </div>
   440→              ))}
   441→              {flaws.length === 0 && (
   442→                <p className="text-sm text-neutral-500 text-center py-4">
   443→                  No issues detected
   444→                </p>
   445→              )}
   446→            </div>
   447→          </div>
   448→
   449→          {/* Upgrade CTA or Premium Badge */}
   450→          {hasPaidPlan ? (
   451→            <motion.div
   452→              className="bg-gradient-to-br from-green-500/10 to-emerald-600/10 border border-green-500/30 rounded-xl p-4"
   453→              initial={{ opacity: 0, y: 20 }}
   454→              animate={{ opacity: 1, y: 0 }}
   455→              transition={{ delay: 0.3 }}
   456→            >
   457→              <div className="flex items-center gap-2 mb-2">
   458→                <CheckCircle size={16} className="text-green-400" />
   459→                <span className="text-sm font-medium text-white">
   460→                  {user?.plan === 'pro' ? 'Pro Plan' : 'Basic Plan'} Active
   461→                </span>
   462→              </div>
   463→              <p className="text-xs text-neutral-400">
   464→                You have full access to all {user?.plan === 'pro' ? 'features' : 'non-surgical recommendations'}.
   465→              </p>
   466→            </motion.div>
   467→          ) : (
   468→            <motion.div
   469→              className="bg-gradient-to-br from-cyan-500/10 to-blue-600/10 border border-cyan-500/30 rounded-xl p-4"
   470→              initial={{ opacity: 0, y: 20 }}
   471→              animate={{ opacity: 1, y: 0 }}
   472→              transition={{ delay: 0.3 }}
   473→            >
   474→              <div className="flex items-center gap-2 mb-2">
   475→                <Sparkles size={16} className="text-cyan-400" />
   476→                <span className="text-sm font-medium text-white">Unlock Full Plan</span>
   477→              </div>
   478→              <p className="text-xs text-neutral-400 mb-3">
   479→                Get detailed treatment guides, cost estimates, and provider recommendations.
   480→              </p>
   481→              <a
   482→                href="/pricing"
   483→                className="block w-full py-2 bg-cyan-500 text-black text-sm font-medium rounded-lg text-center hover:bg-cyan-400 transition-colors"
   484→              >
   485→                Upgrade Now
   486→              </a>
   487→            </motion.div>
   488→          )}
   489→        </div>
   490→      </div>
   491→    </TabContent>
   492→  );
   493→}
   494→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
