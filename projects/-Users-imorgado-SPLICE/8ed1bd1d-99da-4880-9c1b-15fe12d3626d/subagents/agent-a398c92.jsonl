{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","type":"user","message":{"role":"user","content":"Explore the splice-backend directory to understand what code changes were recently made. Focus on:\n1. What files were modified (check git diff or recent changes)\n2. What features or fixes were being implemented\n3. Any patterns in the changes (security, bug fixes, new features, etc.)\n4. Look for incomplete work or TODO comments\n\nProvide a summary of what work was in progress."},"uuid":"ce1e996a-25cc-421f-b676-5daf5ee285f6","timestamp":"2026-01-12T20:42:34.769Z"}
{"parentUuid":"ce1e996a-25cc-421f-b676-5daf5ee285f6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JnoNc3m2KgVVRbptdEw2t3","type":"message","role":"assistant","content":[{"type":"text","text":"I'll explore the splice-backend directory to understand the recent code changes."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":31234,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":31234,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX48hzBiYsaemid9ib8EV","type":"assistant","uuid":"f511233d-2640-4d7a-931d-19c88a050b3c","timestamp":"2026-01-12T20:42:37.308Z"}
{"parentUuid":"f511233d-2640-4d7a-931d-19c88a050b3c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01JnoNc3m2KgVVRbptdEw2t3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UCmtBvWzJHt5NCErS3zKAH","name":"Bash","input":{"command":"git diff splice-backend/ --stat"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":31234,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":31234,"ephemeral_1h_input_tokens":0},"output_tokens":86,"service_tier":"standard"}},"requestId":"req_011CX48hzBiYsaemid9ib8EV","type":"assistant","uuid":"ac5a7ecf-773e-4f8d-a70e-ba372c0d4b75","timestamp":"2026-01-12T20:42:37.725Z"}
{"parentUuid":"ac5a7ecf-773e-4f8d-a70e-ba372c0d4b75","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"Exit code 128\nfatal: option '--stat' must come before non-option arguments","is_error":true,"tool_use_id":"toolu_01UCmtBvWzJHt5NCErS3zKAH"}]},"uuid":"68255272-9b8b-4fb6-b136-f005bc0570c1","timestamp":"2026-01-12T20:42:37.827Z","toolUseResult":"Error: Exit code 128\nfatal: option '--stat' must come before non-option arguments","sourceToolAssistantUUID":"ac5a7ecf-773e-4f8d-a70e-ba372c0d4b75"}
{"parentUuid":"68255272-9b8b-4fb6-b136-f005bc0570c1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01W4M9TY3jVYpPLvmXoF5Tbp","type":"message","role":"assistant","content":[{"type":"text","text":"Let me fix the command syntax:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":144,"cache_read_input_tokens":31234,"cache_creation":{"ephemeral_5m_input_tokens":144,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48iCe4s14RKyterNynD","type":"assistant","uuid":"ffad479e-594a-40d3-bd64-501ea29de55d","timestamp":"2026-01-12T20:42:39.284Z"}
{"parentUuid":"ffad479e-594a-40d3-bd64-501ea29de55d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01W4M9TY3jVYpPLvmXoF5Tbp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UvqeQW3XqG3q4cG7RnJLhT","name":"Bash","input":{"command":"git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git diff --stat splice-backend/"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":144,"cache_read_input_tokens":31234,"cache_creation":{"ephemeral_5m_input_tokens":144,"ephemeral_1h_input_tokens":0},"output_tokens":95,"service_tier":"standard"}},"requestId":"req_011CX48iCe4s14RKyterNynD","type":"assistant","uuid":"38de41bb-c2ec-43ca-8fcd-aa61af0bd53a","timestamp":"2026-01-12T20:42:39.735Z"}
{"parentUuid":"38de41bb-c2ec-43ca-8fcd-aa61af0bd53a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UvqeQW3XqG3q4cG7RnJLhT","type":"tool_result","content":" splice-backend/middleware/auth.js            | 126 ++++-\n splice-backend/middleware/inputValidation.js | 138 ++++-\n splice-backend/middleware/rateLimiter.js     |  90 +++-\n splice-backend/package-lock.json             | 729 ++++++++++++++++++++++++++-\n splice-backend/package.json                  |   9 +-\n splice-backend/routes/music.js               |  66 ++-\n splice-backend/server.js                     |  46 +-\n splice-backend/services/musicGeneration.js   |  55 +-\n splice-backend/services/usageTracking.js     |  77 ++-\n splice-backend/workers/musicWorker.js        |   4 +\n 10 files changed, 1260 insertions(+), 80 deletions(-)","is_error":false}]},"uuid":"b8046ef0-72f3-4b0b-94ad-066eadb53a23","timestamp":"2026-01-12T20:42:40.480Z","toolUseResult":{"stdout":" splice-backend/middleware/auth.js            | 126 ++++-\n splice-backend/middleware/inputValidation.js | 138 ++++-\n splice-backend/middleware/rateLimiter.js     |  90 +++-\n splice-backend/package-lock.json             | 729 ++++++++++++++++++++++++++-\n splice-backend/package.json                  |   9 +-\n splice-backend/routes/music.js               |  66 ++-\n splice-backend/server.js                     |  46 +-\n splice-backend/services/musicGeneration.js   |  55 +-\n splice-backend/services/usageTracking.js     |  77 ++-\n splice-backend/workers/musicWorker.js        |   4 +\n 10 files changed, 1260 insertions(+), 80 deletions(-)","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"38de41bb-c2ec-43ca-8fcd-aa61af0bd53a"}
{"parentUuid":"f1b64c42-d6bc-4529-a074-efdbdaf142c7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015KSDEiWLawzC3Z3kkFgM7Y","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me look at the actual changes in detail:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":363,"cache_read_input_tokens":31378,"cache_creation":{"ephemeral_5m_input_tokens":363,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48iQ9s5PmBo8ejeiQpz","type":"assistant","uuid":"b8a506e7-3eae-4833-a549-ae886e026bb8","timestamp":"2026-01-12T20:42:42.115Z"}
{"parentUuid":"b8a506e7-3eae-4833-a549-ae886e026bb8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_015KSDEiWLawzC3Z3kkFgM7Y","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DtCx2Yrbp8ANopFWVE7UFN","name":"Bash","input":{"command":"git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git diff splice-backend/package.json"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":363,"cache_read_input_tokens":31378,"cache_creation":{"ephemeral_5m_input_tokens":363,"ephemeral_1h_input_tokens":0},"output_tokens":100,"service_tier":"standard"}},"requestId":"req_011CX48iQ9s5PmBo8ejeiQpz","type":"assistant","uuid":"94e38ac4-0aad-49f8-a9fe-67502b397828","timestamp":"2026-01-12T20:42:42.425Z"}
{"parentUuid":"94e38ac4-0aad-49f8-a9fe-67502b397828","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DtCx2Yrbp8ANopFWVE7UFN","type":"tool_result","content":"diff --git a/splice-backend/package.json b/splice-backend/package.json\nindex 5f82225..676d6e5 100644\n--- a/splice-backend/package.json\n+++ b/splice-backend/package.json\n@@ -1,6 +1,6 @@\n {\n   \"name\": \"splice-backend\",\n-  \"version\": \"6.0.3\",\n+  \"version\": \"6.0.8\",\n   \"description\": \"Backend for SPLICE - Audio analysis and take detection\",\n   \"main\": \"server.js\",\n   \"scripts\": {\n@@ -11,6 +11,8 @@\n     \"test\": \"node tests/auth.test.js\",\n     \"test:auth\": \"node tests/auth.test.js\",\n     \"test:all\": \"for f in tests/*.test.js; do echo \\\"Running $f...\\\"; node \\\"$f\\\" || exit 1; done\",\n+    \"test:users\": \"node scripts/verify-test-users.js\",\n+    \"test:users:create\": \"node scripts/create-test-users.js\",\n     \"audit\": \"npm audit --audit-level=moderate\",\n     \"audit:fix\": \"npm audit fix\",\n     \"audit:ci\": \"npm audit --audit-level=high --json\"\n@@ -21,12 +23,17 @@\n     \"@aws-sdk/s3-request-presigner\": \"^3.958.0\",\n     \"@upstash/redis\": \"^1.34.3\",\n     \"bullmq\": \"^5.66.3\",\n+    \"canvas\": \"^2.11.2\",\n+    \"compression\": \"^1.8.0\",\n     \"cookie-parser\": \"^1.4.7\",\n     \"cors\": \"^2.8.5\",\n     \"dotenv\": \"^16.4.5\",\n     \"express\": \"^4.21.0\",\n     \"express-rate-limit\": \"^7.5.0\",\n+    \"express-validator\": \"^7.3.1\",\n+    \"face-api.js\": \"^0.22.2\",\n     \"fast-xml-parser\": \"^5.3.3\",\n+    \"fluent-ffmpeg\": \"^2.1.2\",\n     \"form-data\": \"^4.0.5\",\n     \"groq-sdk\": \"^0.8.0\",\n     \"helmet\": \"^8.1.0\",","is_error":false}]},"uuid":"89b461a9-48f8-42f2-804b-d61ed1a1f7ec","timestamp":"2026-01-12T20:42:43.095Z","toolUseResult":{"stdout":"diff --git a/splice-backend/package.json b/splice-backend/package.json\nindex 5f82225..676d6e5 100644\n--- a/splice-backend/package.json\n+++ b/splice-backend/package.json\n@@ -1,6 +1,6 @@\n {\n   \"name\": \"splice-backend\",\n-  \"version\": \"6.0.3\",\n+  \"version\": \"6.0.8\",\n   \"description\": \"Backend for SPLICE - Audio analysis and take detection\",\n   \"main\": \"server.js\",\n   \"scripts\": {\n@@ -11,6 +11,8 @@\n     \"test\": \"node tests/auth.test.js\",\n     \"test:auth\": \"node tests/auth.test.js\",\n     \"test:all\": \"for f in tests/*.test.js; do echo \\\"Running $f...\\\"; node \\\"$f\\\" || exit 1; done\",\n+    \"test:users\": \"node scripts/verify-test-users.js\",\n+    \"test:users:create\": \"node scripts/create-test-users.js\",\n     \"audit\": \"npm audit --audit-level=moderate\",\n     \"audit:fix\": \"npm audit fix\",\n     \"audit:ci\": \"npm audit --audit-level=high --json\"\n@@ -21,12 +23,17 @@\n     \"@aws-sdk/s3-request-presigner\": \"^3.958.0\",\n     \"@upstash/redis\": \"^1.34.3\",\n     \"bullmq\": \"^5.66.3\",\n+    \"canvas\": \"^2.11.2\",\n+    \"compression\": \"^1.8.0\",\n     \"cookie-parser\": \"^1.4.7\",\n     \"cors\": \"^2.8.5\",\n     \"dotenv\": \"^16.4.5\",\n     \"express\": \"^4.21.0\",\n     \"express-rate-limit\": \"^7.5.0\",\n+    \"express-validator\": \"^7.3.1\",\n+    \"face-api.js\": \"^0.22.2\",\n     \"fast-xml-parser\": \"^5.3.3\",\n+    \"fluent-ffmpeg\": \"^2.1.2\",\n     \"form-data\": \"^4.0.5\",\n     \"groq-sdk\": \"^0.8.0\",\n     \"helmet\": \"^8.1.0\",","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"94e38ac4-0aad-49f8-a9fe-67502b397828"}
{"parentUuid":"9e483fe3-d016-4f38-8028-3b468d47754d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SMNdqJ36SZPxXJRYQiNmf7","type":"message","role":"assistant","content":[{"type":"text","text":"Let me examine the middleware changes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":751,"cache_read_input_tokens":31741,"cache_creation":{"ephemeral_5m_input_tokens":751,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX48ibNYi4ZzmgifhDqHs","type":"assistant","uuid":"3764de52-7312-41bb-b9c5-7a04ceeeec76","timestamp":"2026-01-12T20:42:45.201Z"}
{"parentUuid":"3764de52-7312-41bb-b9c5-7a04ceeeec76","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SMNdqJ36SZPxXJRYQiNmf7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BwVRi4aN6BRkQ8DxoAd1FJ","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-backend/middleware/auth.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":751,"cache_read_input_tokens":31741,"cache_creation":{"ephemeral_5m_input_tokens":751,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX48ibNYi4ZzmgifhDqHs","type":"assistant","uuid":"37a16193-a6ff-479e-99dd-b5589eaa418b","timestamp":"2026-01-12T20:42:45.573Z"}
{"parentUuid":"37a16193-a6ff-479e-99dd-b5589eaa418b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BwVRi4aN6BRkQ8DxoAd1FJ","type":"tool_result","content":"     1→/**\n     2→ * JWT Authentication Middleware\n     3→ *\n     4→ * Primary authentication method: JWT Bearer tokens\n     5→ * Tokens are signed with a secret and contain the customer ID.\n     6→ *\n     7→ * Token Blacklist:\n     8→ * - Primary: Upstash Redis with automatic TTL-based expiry\n     9→ * - Fallback: In-memory Map (for development or Redis failures)\n    10→ *\n    11→ * DEPRECATION NOTICE:\n    12→ * The legacy x-stripe-customer-id header authentication is DEPRECATED.\n    13→ * - Sunset Date: 2026-04-11\n    14→ * - Control: Set ALLOW_LEGACY_AUTH environment variable\n    15→ *   - Production default: false (disabled)\n    16→ *   - Development default: true (enabled for backward compatibility)\n    17→ * - Clients using legacy auth will receive X-Deprecation-Warning headers\n    18→ * - After sunset date, legacy auth will be completely removed\n    19→ *\n    20→ * Migration Guide:\n    21→ * 1. Call POST /auth/login with license key to obtain JWT tokens\n    22→ * 2. Use Authorization: Bearer <token> header for all authenticated requests\n    23→ * 3. Use POST /auth/refresh to refresh expired tokens\n    24→ */\n    25→\n    26→const jwt = require('jsonwebtoken');\n    27→const crypto = require('crypto');\n    28→const authLogger = require('../utils/authLogger');\n    29→const redis = require('../services/redisClient');\n    30→\n    31→// HIGH-007: Database pool for admin RBAC\n    32→let pool = null;\n    33→try {\n    34→  const { Pool } = require('pg');\n    35→  pool = new Pool({\n    36→    connectionString: process.env.DATABASE_URL,\n    37→    ssl: process.env.NODE_ENV === 'production'\n    38→      ? { rejectUnauthorized: process.env.DATABASE_SSL_REJECT_UNAUTHORIZED !== 'false' }\n    39→      : false,\n    40→    max: 3, // Small pool just for auth checks\n    41→    idleTimeoutMillis: 30000,\n    42→  });\n    43→} catch (err) {\n    44→  console.warn('[Auth] PostgreSQL pool not available for admin RBAC:', err.message);\n    45→}\n    46→\n    47→// JWT configuration\n    48→const JWT_SECRET = process.env.JWT_SECRET || 'splice-dev-secret-change-in-production';\n    49→const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '24h';\n    50→const JWT_REFRESH_EXPIRES_IN = process.env.JWT_REFRESH_EXPIRES_IN || '7d';\n    51→\n    52→// Redis key prefix for blacklisted tokens\n    53→const BLACKLIST_KEY_PREFIX = 'token:blacklist:';\n    54→\n    55→// Check if running in production\n    56→const isProduction = process.env.NODE_ENV === 'production' || process.env.RAILWAY_ENVIRONMENT;\n    57→\n    58→// =============================================================================\n    59→// Legacy Authentication Deprecation Configuration\n    60→// =============================================================================\n    61→// The x-stripe-customer-id header is deprecated and will be removed.\n    62→// Set ALLOW_LEGACY_AUTH=true to temporarily enable legacy auth (NOT recommended in production)\n    63→\n    64→/**\n    65→ * Legacy auth sunset date (90 days from 2026-01-11)\n    66→ * After this date, legacy auth will be completely removed\n    67→ */\n    68→const LEGACY_AUTH_SUNSET_DATE = '2026-04-11';\n    69→\n    70→/**\n    71→ * Whether to allow legacy x-stripe-customer-id header authentication\n    72→ * Defaults to false in production, true in development for backward compatibility\n    73→ */\n    74→const ALLOW_LEGACY_AUTH = process.env.ALLOW_LEGACY_AUTH === 'true' ||\n    75→  (!isProduction && process.env.ALLOW_LEGACY_AUTH !== 'false');\n    76→\n    77→// Log legacy auth configuration on startup\n    78→if (isProduction) {\n    79→  if (ALLOW_LEGACY_AUTH) {\n    80→    console.warn('[Auth] WARNING: Legacy x-stripe-customer-id authentication is ENABLED in production.');\n    81→    console.warn(`[Auth] This header is DEPRECATED and will be removed after ${LEGACY_AUTH_SUNSET_DATE}.`);\n    82→    console.warn('[Auth] Set ALLOW_LEGACY_AUTH=false to disable legacy auth.');\n    83→  } else {\n    84→    console.log('[Auth] Legacy x-stripe-customer-id authentication is DISABLED (recommended for production).');\n    85→  }\n    86→} else {\n    87→  if (ALLOW_LEGACY_AUTH) {\n    88→    console.log(`[Auth] Legacy auth enabled in development. Sunset date: ${LEGACY_AUTH_SUNSET_DATE}`);\n    89→  } else {\n    90→    console.log('[Auth] Legacy auth disabled in development (ALLOW_LEGACY_AUTH=false).');\n    91→  }\n    92→}\n    93→\n    94→// HIGH-001: Validate JWT_SECRET security requirements\n    95→if (isProduction) {\n    96→  if (JWT_SECRET === 'splice-dev-secret-change-in-production') {\n    97→    console.error('[SECURITY] CRITICAL: JWT_SECRET not set in production! Set JWT_SECRET environment variable.');\n    98→    console.error('[SECURITY] Exiting process to prevent insecure operation.');\n    99→    process.exit(1);\n   100→  }\n   101→  \n   102→  if (JWT_SECRET.length < 64) {\n   103→    console.error('[SECURITY] CRITICAL: JWT_SECRET must be at least 64 characters (512 bits) for cryptographic security.');\n   104→    console.error('[SECURITY] Current length:', JWT_SECRET.length, 'characters');\n   105→    console.error('[SECURITY] Generate a secure secret: openssl rand -hex 64');\n   106→    console.error('[SECURITY] Exiting process to prevent insecure operation.');\n   107→    process.exit(1);\n   108→  }\n   109→}\n   110→\n   111→/**\n   112→ * Fallback Token Blacklist (In-Memory)\n   113→ * Used when Redis is unavailable. Maps jti -> expiration timestamp.\n   114→ */\n   115→const fallbackBlacklist = new Map();\n   116→\n   117→// Track if we're using fallback mode\n   118→let usingFallback = false;\n   119→\n   120→// Cleanup interval for expired fallback blacklist entries (every 15 minutes)\n   121→const BLACKLIST_CLEANUP_INTERVAL = 15 * 60 * 1000;\n   122→\n   123→/**\n   124→ * Clean up expired entries from the fallback blacklist\n   125→ * Only runs when using in-memory fallback\n   126→ */\n   127→function cleanupFallbackBlacklist() {\n   128→  if (!usingFallback || fallbackBlacklist.size === 0) {\n   129→    return;\n   130→  }\n   131→\n   132→  const now = Math.floor(Date.now() / 1000);\n   133→  let cleanedCount = 0;\n   134→\n   135→  for (const [jti, exp] of fallbackBlacklist.entries()) {\n   136→    if (exp <= now) {\n   137→      fallbackBlacklist.delete(jti);\n   138→      cleanedCount++;\n   139→    }\n   140→  }\n   141→\n   142→  if (cleanedCount > 0) {\n   143→    authLogger.logBlacklistCleanup(cleanedCount, fallbackBlacklist.size);\n   144→  }\n   145→}\n   146→\n   147→// Start periodic cleanup for fallback (unref to allow process exit)\n   148→const cleanupTimer = setInterval(cleanupFallbackBlacklist, BLACKLIST_CLEANUP_INTERVAL);\n   149→if (cleanupTimer.unref) {\n   150→  cleanupTimer.unref();\n   151→}\n   152→\n   153→/**\n   154→ * Add a token to the blacklist\n   155→ * Uses Redis with automatic TTL, falls back to in-memory if Redis unavailable\n   156→ * @param {string} jti - JWT ID claim\n   157→ * @param {number} exp - Token expiration timestamp (Unix seconds)\n   158→ * @param {Object} options - Additional options for logging\n   159→ * @param {string} options.userId - User ID for logging\n   160→ * @param {string} options.reason - Reason for revocation (logout, security, admin)\n   161→ * @returns {Promise<boolean>} True if successfully blacklisted\n   162→ */\n   163→async function blacklistToken(jti, exp, options = {}) {\n   164→  if (!jti) {\n   165→    console.warn('[Auth] Cannot blacklist token without jti');\n   166→    return false;\n   167→  }\n   168→\n   169→  const now = Math.floor(Date.now() / 1000);\n   170→  const ttlSeconds = Math.max(exp - now, 1); // At least 1 second TTL\n   171→\n   172→  // Try Redis first\n   173→  if (redis.isRedisAvailable()) {\n   174→    try {\n   175→      const key = `${BLACKLIST_KEY_PREFIX}${jti}`;\n   176→      const success = await redis.set(key, exp, ttlSeconds);\n   177→\n   178→      if (success) {\n   179→        console.log(`[Auth] Token blacklisted in Redis: ${jti.slice(0, 8)}..., TTL: ${ttlSeconds}s`);\n   180→        usingFallback = false;\n   181→        // Log token revocation with structured logging\n   182→        authLogger.logTokenRevoked(options.userId || 'unknown', jti, options.reason || 'logout');\n   183→        return true;\n   184→      }\n   185→    } catch (err) {\n   186→      console.error('[Auth] Redis blacklist failed, using fallback:', err.message);\n   187→    }\n   188→  }\n   189→\n   190→  // Fallback to in-memory\n   191→  usingFallback = true;\n   192→  fallbackBlacklist.set(jti, exp);\n   193→  console.log(`[Auth] Token blacklisted in memory (fallback): ${jti.slice(0, 8)}..., expires at ${new Date(exp * 1000).toISOString()}`);\n   194→\n   195→  // Log token revocation with structured logging\n   196→  authLogger.logTokenRevoked(options.userId || 'unknown', jti, options.reason || 'logout');\n   197→  return true;\n   198→}\n   199→\n   200→/**\n   201→ * Check if a token is blacklisted\n   202→ * Checks Redis first, then fallback in-memory store\n   203→ * @param {string} jti - JWT ID claim\n   204→ * @returns {Promise<boolean>} True if token is blacklisted\n   205→ */\n   206→async function isTokenBlacklisted(jti) {\n   207→  if (!jti) {\n   208→    return false;\n   209→  }\n   210→\n   211→  // Try Redis first\n   212→  if (redis.isRedisAvailable()) {\n   213→    try {\n   214→      const key = `${BLACKLIST_KEY_PREFIX}${jti}`;\n   215→      const exists = await redis.exists(key);\n   216→\n   217→      if (exists) {\n   218→        return true;\n   219→      }\n   220→\n   221→      // Also check fallback in case token was blacklisted during Redis downtime\n   222→      // and Redis is now back up\n   223→      if (fallbackBlacklist.has(jti)) {\n   224→        // Migrate to Redis if token still valid\n   225→        const exp = fallbackBlacklist.get(jti);\n   226→        const now = Math.floor(Date.now() / 1000);\n   227→        if (exp > now) {\n   228→          const ttlSeconds = exp - now;\n   229→          await redis.set(key, exp, ttlSeconds);\n   230→          fallbackBlacklist.delete(jti);\n   231→          console.log(`[Auth] Migrated blacklist entry to Redis: ${jti.slice(0, 8)}...`);\n   232→        } else {\n   233→          // Expired, remove from fallback\n   234→          fallbackBlacklist.delete(jti);\n   235→        }\n   236→        return true;\n   237→      }\n   238→\n   239→      return false;\n   240→    } catch (err) {\n   241→      console.error('[Auth] Redis blacklist check failed, checking fallback:', err.message);\n   242→    }\n   243→  }\n   244→\n   245→  // Fallback to in-memory check\n   246→  if (fallbackBlacklist.has(jti)) {\n   247→    const exp = fallbackBlacklist.get(jti);\n   248→    const now = Math.floor(Date.now() / 1000);\n   249→    if (exp > now) {\n   250→      return true;\n   251→    }\n   252→    // Expired, remove it\n   253→    fallbackBlacklist.delete(jti);\n   254→  }\n   255→\n   256→  return false;\n   257→}\n   258→\n   259→/**\n   260→ * Get blacklist statistics (for monitoring)\n   261→ * @returns {Promise<Object>} { storage, redisConnected, fallbackSize, fallbackEntries, usingFallback }\n   262→ */\n   263→async function getBlacklistStats() {\n   264→  const redisAvailable = redis.isRedisAvailable();\n   265→  const redisStatus = redis.getRedisStatus();\n   266→\n   267→  return {\n   268→    storage: redisAvailable ? 'redis' : 'memory',\n   269→    redisConnected: redisStatus.connected,\n   270→    redisError: redisStatus.error,\n   271→    fallbackSize: fallbackBlacklist.size,\n   272→    fallbackEntries: Array.from(fallbackBlacklist.entries()).slice(0, 10), // First 10 for debugging\n   273→    usingFallback\n   274→  };\n   275→}\n   276→\n   277→/**\n   278→ * Generate a JWT token for a customer\n   279→ * @param {string} stripeCustomerId - Stripe customer ID (cus_xxx)\n   280→ * @param {Object} options - Additional options\n   281→ * @param {string} options.tier - User's subscription tier\n   282→ * @param {string} options.email - User's email (optional)\n   283→ * @returns {Object} { token, expiresIn }\n   284→ */\n   285→function generateToken(stripeCustomerId, options = {}) {\n   286→  if (!stripeCustomerId || !stripeCustomerId.startsWith('cus_')) {\n   287→    throw new Error('Invalid Stripe customer ID');\n   288→  }\n   289→\n   290→  const payload = {\n   291→    sub: stripeCustomerId,\n   292→    type: 'access',\n   293→    tier: options.tier || 'starter',\n   294→    iat: Math.floor(Date.now() / 1000),\n   295→    jti: crypto.randomUUID() // Unique token identifier for blacklisting\n   296→  };\n   297→\n   298→  if (options.email) {\n   299→    payload.email = options.email;\n   300→  }\n   301→\n   302→  const token = jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN });\n   303→\n   304→  return {\n   305→    token,\n   306→    expiresIn: JWT_EXPIRES_IN,\n   307→    tokenType: 'Bearer'\n   308→  };\n   309→}\n   310→\n   311→/**\n   312→ * Generate a refresh token for a customer\n   313→ * @param {string} stripeCustomerId - Stripe customer ID\n   314→ * @returns {Object} { refreshToken, expiresIn }\n   315→ */\n   316→function generateRefreshToken(stripeCustomerId) {\n   317→  if (!stripeCustomerId || !stripeCustomerId.startsWith('cus_')) {\n   318→    throw new Error('Invalid Stripe customer ID');\n   319→  }\n   320→\n   321→  const payload = {\n   322→    sub: stripeCustomerId,\n   323→    type: 'refresh',\n   324→    iat: Math.floor(Date.now() / 1000),\n   325→    jti: crypto.randomUUID() // Unique token identifier for blacklisting\n   326→  };\n   327→\n   328→  const refreshToken = jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_REFRESH_EXPIRES_IN });\n   329→\n   330→  return {\n   331→    refreshToken,\n   332→    expiresIn: JWT_REFRESH_EXPIRES_IN\n   333→  };\n   334→}\n   335→\n   336→/**\n   337→ * Verify and decode a JWT token (async version)\n   338→ * Checks both JWT signature validity and token blacklist status via Redis\n   339→ * @param {string} token - JWT token to verify\n   340→ * @param {Object} options - Verification options\n   341→ * @param {boolean} options.checkBlacklist - Whether to check token blacklist (default: true)\n   342→ * @param {Object} options.req - Express request object for logging (optional)\n   343→ * @returns {Promise<Object|null>} Decoded payload or null if invalid/revoked\n   344→ */\n   345→async function verifyToken(token, options = {}) {\n   346→  const { checkBlacklist = true, req = null } = options;\n   347→\n   348→  try {\n   349→    const decoded = jwt.verify(token, JWT_SECRET);\n   350→\n   351→    // Check if token has been revoked (blacklisted) - async Redis check\n   352→    if (checkBlacklist && decoded.jti) {\n   353→      const isBlacklisted = await isTokenBlacklisted(decoded.jti);\n   354→      if (isBlacklisted) {\n   355→        if (req) {\n   356→          authLogger.logTokenBlacklisted(req, decoded.jti);\n   357→        }\n   358→        return null;\n   359→      }\n   360→    }\n   361→\n   362→    return decoded;\n   363→  } catch (err) {\n   364→    // Log specific error types for debugging\n   365→    if (err.name === 'TokenExpiredError') {\n   366→      if (req) {\n   367→        authLogger.logTokenExpired(req);\n   368→      }\n   369→    } else if (err.name === 'JsonWebTokenError') {\n   370→      if (req) {\n   371→        authLogger.logTokenInvalid(req, err.message);\n   372→      }\n   373→    }\n   374→    return null;\n   375→  }\n   376→}\n   377→\n   378→/**\n   379→ * Synchronous token verification (for cases where async is not possible)\n   380→ * Does NOT check blacklist - use verifyToken() for full verification\n   381→ * @param {string} token - JWT token to verify\n   382→ * @returns {Object|null} Decoded payload or null if invalid\n   383→ */\n   384→function verifyTokenSync(token) {\n   385→  try {\n   386→    return jwt.verify(token, JWT_SECRET);\n   387→  } catch {\n   388→    return null;\n   389→  }\n   390→}\n   391→\n   392→/**\n   393→ * Extract Bearer token from Authorization header\n   394→ * @param {string} authHeader - Authorization header value\n   395→ * @returns {string|null} Token or null if not found\n   396→ */\n   397→function extractBearerToken(authHeader) {\n   398→  if (!authHeader || typeof authHeader !== 'string') {\n   399→    return null;\n   400→  }\n   401→\n   402→  const parts = authHeader.split(' ');\n   403→  if (parts.length !== 2 || parts[0].toLowerCase() !== 'bearer') {\n   404→    return null;\n   405→  }\n   406→\n   407→  return parts[1];\n   408→}\n   409→\n   410→/**\n   411→ * Middleware to authenticate JWT tokens\n   412→ * Sets req.stripeCustomerId if valid token found\n   413→ *\n   414→ * Authentication Methods:\n   415→ * - Authorization: Bearer <token> (PREFERRED - use this method)\n   416→ * - x-stripe-customer-id header (DEPRECATED - see deprecation notice below)\n   417→ *\n   418→ * DEPRECATION: x-stripe-customer-id header\n   419→ * - This method is deprecated and controlled by ALLOW_LEGACY_AUTH env var\n   420→ * - Production: Disabled by default (returns 401)\n   421→ * - Development: Enabled by default for backward compatibility\n   422→ * - Sunset Date: 2026-04-11 (after which it will be removed entirely)\n   423→ * - When enabled, responses include X-Deprecation-Warning and X-Deprecation-Sunset headers\n   424→ *\n   425→ * @param {Object} req - Express request object\n   426→ * @param {Object} res - Express response object\n   427→ * @param {Function} next - Express next function\n   428→ */\n   429→async function authenticateToken(req, res, next) {\n   430→  // First, try JWT token from Authorization header\n   431→  const authHeader = req.headers['authorization'];\n   432→  const token = extractBearerToken(authHeader);\n   433→\n   434→  if (token) {\n   435→    // First verify JWT signature without blacklist check to get specific error messages\n   436→    const decoded = verifyTokenSync(token);\n   437→\n   438→    if (!decoded || !decoded.sub) {\n   439→      // Token is invalid or expired (signature failed)\n   440→      authLogger.logTokenInvalid(req, 'Invalid or expired token');\n   441→      return res.status(401).json({\n   442→        error: 'Invalid or expired token',\n   443→        message: 'Please log in again to continue'\n   444→      });\n   445→    }\n   446→\n   447→    // Check if token has been revoked (blacklisted) - async Redis check\n   448→    if (decoded.jti) {\n   449→      const isBlacklisted = await isTokenBlacklisted(decoded.jti);\n   450→      if (isBlacklisted) {\n   451→        authLogger.logTokenBlacklisted(req, decoded.jti);\n   452→        return res.status(401).json({\n   453→          error: 'Token has been revoked',\n   454→          message: 'This session has been logged out. Please log in again.'\n   455→        });\n   456→      }\n   457→    }\n   458→\n   459→    // Token is valid and not revoked\n   460→    req.stripeCustomerId = decoded.sub;\n   461→    req.tokenData = decoded;\n   462→    req.rawToken = token; // Store raw token for logout\n   463→    return next();\n   464→  }\n   465→\n   466→  // ==========================================================================\n   467→  // DEPRECATED: Legacy x-stripe-customer-id header authentication\n   468→  // This authentication method is deprecated and will be removed after\n   469→  // the sunset date. Clients should migrate to JWT Bearer token authentication.\n   470→  // ==========================================================================\n   471→  const legacyCustomerId = req.headers['x-stripe-customer-id'];\n   472→  if (legacyCustomerId) {\n   473→    // Check if legacy auth is allowed\n   474→    if (!ALLOW_LEGACY_AUTH) {\n   475→      console.warn(`[Auth] Legacy auth attempt rejected (disabled): ${legacyCustomerId.slice(0, 8)}...`);\n   476→      authLogger.logLegacyAuthUsed(req, legacyCustomerId);\n   477→      return res.status(401).json({\n   478→        error: 'Legacy authentication disabled',\n   479→        message: 'The x-stripe-customer-id header is no longer supported. Please use JWT Bearer token authentication.',\n   480→        migration_guide: 'Use POST /auth/login with your license key to obtain a JWT token, then include it as: Authorization: Bearer <token>'\n   481→      });\n   482→    }\n   483→\n   484→    // Log deprecation warning with structured logging (once per request)\n   485→    if (!req._legacyAuthWarned) {\n   486→      authLogger.logLegacyAuthUsed(req, legacyCustomerId);\n   487→      console.warn(`[Auth] DEPRECATION: Legacy auth used by ${legacyCustomerId.slice(0, 8)}... - migrate before ${LEGACY_AUTH_SUNSET_DATE}`);\n   488→      req._legacyAuthWarned = true;\n   489→    }\n   490→\n   491→    // Validate format\n   492→    if (!legacyCustomerId.startsWith('cus_')) {\n   493→      authLogger.logTokenInvalid(req, 'Invalid legacy customer ID format');\n   494→      return res.status(401).json({\n   495→        error: 'Invalid customer ID format',\n   496→        message: 'Customer ID must start with cus_'\n   497→      });\n   498→    }\n   499→\n   500→    // Set deprecation warning header on the response\n   501→    res.set('X-Deprecation-Warning', `x-stripe-customer-id header is deprecated. Please use JWT authentication. Sunset date: ${LEGACY_AUTH_SUNSET_DATE}`);\n   502→    res.set('X-Deprecation-Sunset', LEGACY_AUTH_SUNSET_DATE);\n   503→\n   504→    req.stripeCustomerId = legacyCustomerId;\n   505→    req.isLegacyAuth = true;\n   506→    return next();\n   507→  }\n   508→\n   509→  // No authentication provided\n   510→  return res.status(401).json({\n   511→    error: 'Authentication required',\n   512→    message: 'Please provide a valid Bearer token in the Authorization header'\n   513→  });\n   514→}\n   515→\n   516→/**\n   517→ * Optional authentication middleware\n   518→ * Allows unauthenticated access but sets req.stripeCustomerId if token present\n   519→ *\n   520→ * Note: Legacy x-stripe-customer-id header is deprecated and controlled by ALLOW_LEGACY_AUTH\n   521→ */\n   522→async function optionalAuthentication(req, res, next) {\n   523→  const authHeader = req.headers['authorization'];\n   524→  const token = extractBearerToken(authHeader);\n   525→\n   526→  if (token) {\n   527→    const decoded = await verifyToken(token);\n   528→    if (decoded && decoded.sub) {\n   529→      req.stripeCustomerId = decoded.sub;\n   530→      req.tokenData = decoded;\n   531→    }\n   532→  } else {\n   533→    // DEPRECATED: Legacy x-stripe-customer-id header authentication\n   534→    const legacyCustomerId = req.headers['x-stripe-customer-id'];\n   535→    if (legacyCustomerId && legacyCustomerId.startsWith('cus_')) {\n   536→      // Only accept legacy auth if allowed\n   537→      if (ALLOW_LEGACY_AUTH) {\n   538→        // Log deprecation warning\n   539→        if (!req._legacyAuthWarned) {\n   540→          authLogger.logLegacyAuthUsed(req, legacyCustomerId);\n   541→          console.warn(`[Auth] DEPRECATION: Legacy auth used by ${legacyCustomerId.slice(0, 8)}... - migrate before ${LEGACY_AUTH_SUNSET_DATE}`);\n   542→          req._legacyAuthWarned = true;\n   543→        }\n   544→\n   545→        // Set deprecation warning headers\n   546→        res.set('X-Deprecation-Warning', `x-stripe-customer-id header is deprecated. Please use JWT authentication. Sunset date: ${LEGACY_AUTH_SUNSET_DATE}`);\n   547→        res.set('X-Deprecation-Sunset', LEGACY_AUTH_SUNSET_DATE);\n   548→\n   549→        req.stripeCustomerId = legacyCustomerId;\n   550→        req.isLegacyAuth = true;\n   551→      }\n   552→      // If legacy auth is disabled, silently ignore (optional auth doesn't require auth)\n   553→    }\n   554→  }\n   555→\n   556→  next();\n   557→}\n   558→\n   559→/**\n   560→ * HIGH-007: Database-backed admin role check middleware\n   561→ * Checks the user's role in the database instead of relying on env vars\n   562→ * Requires authenticateToken middleware to run first\n   563→ *\n   564→ * @param {Object} req - Express request object (must have req.stripeCustomerId set)\n   565→ * @param {Object} res - Express response object\n   566→ * @param {Function} next - Express next function\n   567→ */\n   568→async function requireAdmin(req, res, next) {\n   569→  // Must be authenticated first\n   570→  if (!req.stripeCustomerId) {\n   571→    return res.status(401).json({\n   572→      error: 'Authentication required',\n   573→      message: 'Please log in to access this resource'\n   574→    });\n   575→  }\n   576→\n   577→  // Check if database pool is available\n   578→  if (!pool) {\n   579→    console.error('[Auth] Admin check failed: Database pool not available');\n   580→    return res.status(503).json({\n   581→      error: 'Service unavailable',\n   582→      message: 'Admin verification temporarily unavailable'\n   583→    });\n   584→  }\n   585→\n   586→  try {\n   587→    // Query database for user role\n   588→    const result = await pool.query(\n   589→      'SELECT role FROM users WHERE stripe_customer_id = $1',\n   590→      [req.stripeCustomerId]\n   591→    );\n   592→\n   593→    if (!result.rows[0]) {\n   594→      authLogger.logAdminAccessDenied(req, 'User not found in database');\n   595→      return res.status(403).json({\n   596→        error: 'Access denied',\n   597→        message: 'User account not found'\n   598→      });\n   599→    }\n   600→\n   601→    const userRole = result.rows[0].role;\n   602→\n   603→    if (userRole !== 'admin') {\n   604→      authLogger.logAdminAccessDenied(req, `Role is '${userRole}', admin required`);\n   605→      return res.status(403).json({\n   606→        error: 'Admin access required',\n   607→        message: 'This action requires administrator privileges'\n   608→      });\n   609→    }\n   610→\n   611→    // User is admin - log and proceed\n   612→    authLogger.logAdminAccess(req);\n   613→    req.isAdmin = true;\n   614→    next();\n   615→  } catch (err) {\n   616→    console.error('[Auth] Admin role check failed:', err.message);\n   617→    return res.status(500).json({\n   618→      error: 'Authorization check failed',\n   619→      message: 'Unable to verify admin privileges'\n   620→    });\n   621→  }\n   622→}\n   623→\n   624→/**\n   625→ * Mask sensitive data for logging\n   626→ * @param {string} key - License key or other sensitive string\n   627→ * @returns {string} Masked string (e.g., \"SPLICE-ABC1-****-****-****\")\n   628→ */\n   629→function maskSensitiveData(data) {\n   630→  if (!data || typeof data !== 'string') {\n   631→    return '****';\n   632→  }\n   633→\n   634→  // For license keys (SPLICE-XXXX-XXXX-XXXX-XXXX format)\n   635→  if (data.startsWith('SPLICE-')) {\n   636→    const parts = data.split('-');\n   637→    if (parts.length === 5) {\n   638→      return `${parts[0]}-${parts[1]}-****-****-****`;\n   639→    }\n   640→  }\n   641→\n   642→  // For customer IDs (cus_xxxx format)\n   643→  if (data.startsWith('cus_')) {\n   644→    if (data.length > 10) {\n   645→      return `cus_${data.slice(4, 8)}****`;\n   646→    }\n   647→    return 'cus_****';\n   648→  }\n   649→\n   650→  // For JWTs (eyJ... format)\n   651→  if (data.startsWith('eyJ')) {\n   652→    return `${data.slice(0, 10)}...****`;\n   653→  }\n   654→\n   655→  // For emails\n   656→  if (data.includes('@')) {\n   657→    const [local, domain] = data.split('@');\n   658→    const maskedLocal = local.length > 2 ? `${local[0]}***${local[local.length-1]}` : '***';\n   659→    return `${maskedLocal}@${domain}`;\n   660→  }\n   661→\n   662→  // Generic masking - show first 4 chars\n   663→  if (data.length > 8) {\n   664→    return `${data.slice(0, 4)}****`;\n   665→  }\n   666→\n   667→  return '****';\n   668→}\n   669→\n   670→module.exports = {\n   671→  generateToken,\n   672→  generateRefreshToken,\n   673→  verifyToken,\n   674→  verifyTokenSync,\n   675→  extractBearerToken,\n   676→  authenticateToken,\n   677→  optionalAuthentication,\n   678→  maskSensitiveData,\n   679→  // HIGH-007: Admin RBAC middleware\n   680→  requireAdmin,\n   681→  // Token blacklist functions\n   682→  blacklistToken,\n   683→  isTokenBlacklisted,\n   684→  getBlacklistStats,\n   685→  // Structured logging\n   686→  authLogger,\n   687→  // Constants\n   688→  JWT_SECRET,\n   689→  JWT_EXPIRES_IN,\n   690→  // Legacy auth deprecation constants\n   691→  LEGACY_AUTH_SUNSET_DATE,\n   692→  ALLOW_LEGACY_AUTH\n   693→};\n   694→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"61dbe6a5-a150-4a1d-928c-7f9f5013db77","timestamp":"2026-01-12T20:42:45.595Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-backend/middleware/auth.js","content":"/**\n * JWT Authentication Middleware\n *\n * Primary authentication method: JWT Bearer tokens\n * Tokens are signed with a secret and contain the customer ID.\n *\n * Token Blacklist:\n * - Primary: Upstash Redis with automatic TTL-based expiry\n * - Fallback: In-memory Map (for development or Redis failures)\n *\n * DEPRECATION NOTICE:\n * The legacy x-stripe-customer-id header authentication is DEPRECATED.\n * - Sunset Date: 2026-04-11\n * - Control: Set ALLOW_LEGACY_AUTH environment variable\n *   - Production default: false (disabled)\n *   - Development default: true (enabled for backward compatibility)\n * - Clients using legacy auth will receive X-Deprecation-Warning headers\n * - After sunset date, legacy auth will be completely removed\n *\n * Migration Guide:\n * 1. Call POST /auth/login with license key to obtain JWT tokens\n * 2. Use Authorization: Bearer <token> header for all authenticated requests\n * 3. Use POST /auth/refresh to refresh expired tokens\n */\n\nconst jwt = require('jsonwebtoken');\nconst crypto = require('crypto');\nconst authLogger = require('../utils/authLogger');\nconst redis = require('../services/redisClient');\n\n// HIGH-007: Database pool for admin RBAC\nlet pool = null;\ntry {\n  const { Pool } = require('pg');\n  pool = new Pool({\n    connectionString: process.env.DATABASE_URL,\n    ssl: process.env.NODE_ENV === 'production'\n      ? { rejectUnauthorized: process.env.DATABASE_SSL_REJECT_UNAUTHORIZED !== 'false' }\n      : false,\n    max: 3, // Small pool just for auth checks\n    idleTimeoutMillis: 30000,\n  });\n} catch (err) {\n  console.warn('[Auth] PostgreSQL pool not available for admin RBAC:', err.message);\n}\n\n// JWT configuration\nconst JWT_SECRET = process.env.JWT_SECRET || 'splice-dev-secret-change-in-production';\nconst JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '24h';\nconst JWT_REFRESH_EXPIRES_IN = process.env.JWT_REFRESH_EXPIRES_IN || '7d';\n\n// Redis key prefix for blacklisted tokens\nconst BLACKLIST_KEY_PREFIX = 'token:blacklist:';\n\n// Check if running in production\nconst isProduction = process.env.NODE_ENV === 'production' || process.env.RAILWAY_ENVIRONMENT;\n\n// =============================================================================\n// Legacy Authentication Deprecation Configuration\n// =============================================================================\n// The x-stripe-customer-id header is deprecated and will be removed.\n// Set ALLOW_LEGACY_AUTH=true to temporarily enable legacy auth (NOT recommended in production)\n\n/**\n * Legacy auth sunset date (90 days from 2026-01-11)\n * After this date, legacy auth will be completely removed\n */\nconst LEGACY_AUTH_SUNSET_DATE = '2026-04-11';\n\n/**\n * Whether to allow legacy x-stripe-customer-id header authentication\n * Defaults to false in production, true in development for backward compatibility\n */\nconst ALLOW_LEGACY_AUTH = process.env.ALLOW_LEGACY_AUTH === 'true' ||\n  (!isProduction && process.env.ALLOW_LEGACY_AUTH !== 'false');\n\n// Log legacy auth configuration on startup\nif (isProduction) {\n  if (ALLOW_LEGACY_AUTH) {\n    console.warn('[Auth] WARNING: Legacy x-stripe-customer-id authentication is ENABLED in production.');\n    console.warn(`[Auth] This header is DEPRECATED and will be removed after ${LEGACY_AUTH_SUNSET_DATE}.`);\n    console.warn('[Auth] Set ALLOW_LEGACY_AUTH=false to disable legacy auth.');\n  } else {\n    console.log('[Auth] Legacy x-stripe-customer-id authentication is DISABLED (recommended for production).');\n  }\n} else {\n  if (ALLOW_LEGACY_AUTH) {\n    console.log(`[Auth] Legacy auth enabled in development. Sunset date: ${LEGACY_AUTH_SUNSET_DATE}`);\n  } else {\n    console.log('[Auth] Legacy auth disabled in development (ALLOW_LEGACY_AUTH=false).');\n  }\n}\n\n// HIGH-001: Validate JWT_SECRET security requirements\nif (isProduction) {\n  if (JWT_SECRET === 'splice-dev-secret-change-in-production') {\n    console.error('[SECURITY] CRITICAL: JWT_SECRET not set in production! Set JWT_SECRET environment variable.');\n    console.error('[SECURITY] Exiting process to prevent insecure operation.');\n    process.exit(1);\n  }\n  \n  if (JWT_SECRET.length < 64) {\n    console.error('[SECURITY] CRITICAL: JWT_SECRET must be at least 64 characters (512 bits) for cryptographic security.');\n    console.error('[SECURITY] Current length:', JWT_SECRET.length, 'characters');\n    console.error('[SECURITY] Generate a secure secret: openssl rand -hex 64');\n    console.error('[SECURITY] Exiting process to prevent insecure operation.');\n    process.exit(1);\n  }\n}\n\n/**\n * Fallback Token Blacklist (In-Memory)\n * Used when Redis is unavailable. Maps jti -> expiration timestamp.\n */\nconst fallbackBlacklist = new Map();\n\n// Track if we're using fallback mode\nlet usingFallback = false;\n\n// Cleanup interval for expired fallback blacklist entries (every 15 minutes)\nconst BLACKLIST_CLEANUP_INTERVAL = 15 * 60 * 1000;\n\n/**\n * Clean up expired entries from the fallback blacklist\n * Only runs when using in-memory fallback\n */\nfunction cleanupFallbackBlacklist() {\n  if (!usingFallback || fallbackBlacklist.size === 0) {\n    return;\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  let cleanedCount = 0;\n\n  for (const [jti, exp] of fallbackBlacklist.entries()) {\n    if (exp <= now) {\n      fallbackBlacklist.delete(jti);\n      cleanedCount++;\n    }\n  }\n\n  if (cleanedCount > 0) {\n    authLogger.logBlacklistCleanup(cleanedCount, fallbackBlacklist.size);\n  }\n}\n\n// Start periodic cleanup for fallback (unref to allow process exit)\nconst cleanupTimer = setInterval(cleanupFallbackBlacklist, BLACKLIST_CLEANUP_INTERVAL);\nif (cleanupTimer.unref) {\n  cleanupTimer.unref();\n}\n\n/**\n * Add a token to the blacklist\n * Uses Redis with automatic TTL, falls back to in-memory if Redis unavailable\n * @param {string} jti - JWT ID claim\n * @param {number} exp - Token expiration timestamp (Unix seconds)\n * @param {Object} options - Additional options for logging\n * @param {string} options.userId - User ID for logging\n * @param {string} options.reason - Reason for revocation (logout, security, admin)\n * @returns {Promise<boolean>} True if successfully blacklisted\n */\nasync function blacklistToken(jti, exp, options = {}) {\n  if (!jti) {\n    console.warn('[Auth] Cannot blacklist token without jti');\n    return false;\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  const ttlSeconds = Math.max(exp - now, 1); // At least 1 second TTL\n\n  // Try Redis first\n  if (redis.isRedisAvailable()) {\n    try {\n      const key = `${BLACKLIST_KEY_PREFIX}${jti}`;\n      const success = await redis.set(key, exp, ttlSeconds);\n\n      if (success) {\n        console.log(`[Auth] Token blacklisted in Redis: ${jti.slice(0, 8)}..., TTL: ${ttlSeconds}s`);\n        usingFallback = false;\n        // Log token revocation with structured logging\n        authLogger.logTokenRevoked(options.userId || 'unknown', jti, options.reason || 'logout');\n        return true;\n      }\n    } catch (err) {\n      console.error('[Auth] Redis blacklist failed, using fallback:', err.message);\n    }\n  }\n\n  // Fallback to in-memory\n  usingFallback = true;\n  fallbackBlacklist.set(jti, exp);\n  console.log(`[Auth] Token blacklisted in memory (fallback): ${jti.slice(0, 8)}..., expires at ${new Date(exp * 1000).toISOString()}`);\n\n  // Log token revocation with structured logging\n  authLogger.logTokenRevoked(options.userId || 'unknown', jti, options.reason || 'logout');\n  return true;\n}\n\n/**\n * Check if a token is blacklisted\n * Checks Redis first, then fallback in-memory store\n * @param {string} jti - JWT ID claim\n * @returns {Promise<boolean>} True if token is blacklisted\n */\nasync function isTokenBlacklisted(jti) {\n  if (!jti) {\n    return false;\n  }\n\n  // Try Redis first\n  if (redis.isRedisAvailable()) {\n    try {\n      const key = `${BLACKLIST_KEY_PREFIX}${jti}`;\n      const exists = await redis.exists(key);\n\n      if (exists) {\n        return true;\n      }\n\n      // Also check fallback in case token was blacklisted during Redis downtime\n      // and Redis is now back up\n      if (fallbackBlacklist.has(jti)) {\n        // Migrate to Redis if token still valid\n        const exp = fallbackBlacklist.get(jti);\n        const now = Math.floor(Date.now() / 1000);\n        if (exp > now) {\n          const ttlSeconds = exp - now;\n          await redis.set(key, exp, ttlSeconds);\n          fallbackBlacklist.delete(jti);\n          console.log(`[Auth] Migrated blacklist entry to Redis: ${jti.slice(0, 8)}...`);\n        } else {\n          // Expired, remove from fallback\n          fallbackBlacklist.delete(jti);\n        }\n        return true;\n      }\n\n      return false;\n    } catch (err) {\n      console.error('[Auth] Redis blacklist check failed, checking fallback:', err.message);\n    }\n  }\n\n  // Fallback to in-memory check\n  if (fallbackBlacklist.has(jti)) {\n    const exp = fallbackBlacklist.get(jti);\n    const now = Math.floor(Date.now() / 1000);\n    if (exp > now) {\n      return true;\n    }\n    // Expired, remove it\n    fallbackBlacklist.delete(jti);\n  }\n\n  return false;\n}\n\n/**\n * Get blacklist statistics (for monitoring)\n * @returns {Promise<Object>} { storage, redisConnected, fallbackSize, fallbackEntries, usingFallback }\n */\nasync function getBlacklistStats() {\n  const redisAvailable = redis.isRedisAvailable();\n  const redisStatus = redis.getRedisStatus();\n\n  return {\n    storage: redisAvailable ? 'redis' : 'memory',\n    redisConnected: redisStatus.connected,\n    redisError: redisStatus.error,\n    fallbackSize: fallbackBlacklist.size,\n    fallbackEntries: Array.from(fallbackBlacklist.entries()).slice(0, 10), // First 10 for debugging\n    usingFallback\n  };\n}\n\n/**\n * Generate a JWT token for a customer\n * @param {string} stripeCustomerId - Stripe customer ID (cus_xxx)\n * @param {Object} options - Additional options\n * @param {string} options.tier - User's subscription tier\n * @param {string} options.email - User's email (optional)\n * @returns {Object} { token, expiresIn }\n */\nfunction generateToken(stripeCustomerId, options = {}) {\n  if (!stripeCustomerId || !stripeCustomerId.startsWith('cus_')) {\n    throw new Error('Invalid Stripe customer ID');\n  }\n\n  const payload = {\n    sub: stripeCustomerId,\n    type: 'access',\n    tier: options.tier || 'starter',\n    iat: Math.floor(Date.now() / 1000),\n    jti: crypto.randomUUID() // Unique token identifier for blacklisting\n  };\n\n  if (options.email) {\n    payload.email = options.email;\n  }\n\n  const token = jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN });\n\n  return {\n    token,\n    expiresIn: JWT_EXPIRES_IN,\n    tokenType: 'Bearer'\n  };\n}\n\n/**\n * Generate a refresh token for a customer\n * @param {string} stripeCustomerId - Stripe customer ID\n * @returns {Object} { refreshToken, expiresIn }\n */\nfunction generateRefreshToken(stripeCustomerId) {\n  if (!stripeCustomerId || !stripeCustomerId.startsWith('cus_')) {\n    throw new Error('Invalid Stripe customer ID');\n  }\n\n  const payload = {\n    sub: stripeCustomerId,\n    type: 'refresh',\n    iat: Math.floor(Date.now() / 1000),\n    jti: crypto.randomUUID() // Unique token identifier for blacklisting\n  };\n\n  const refreshToken = jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_REFRESH_EXPIRES_IN });\n\n  return {\n    refreshToken,\n    expiresIn: JWT_REFRESH_EXPIRES_IN\n  };\n}\n\n/**\n * Verify and decode a JWT token (async version)\n * Checks both JWT signature validity and token blacklist status via Redis\n * @param {string} token - JWT token to verify\n * @param {Object} options - Verification options\n * @param {boolean} options.checkBlacklist - Whether to check token blacklist (default: true)\n * @param {Object} options.req - Express request object for logging (optional)\n * @returns {Promise<Object|null>} Decoded payload or null if invalid/revoked\n */\nasync function verifyToken(token, options = {}) {\n  const { checkBlacklist = true, req = null } = options;\n\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET);\n\n    // Check if token has been revoked (blacklisted) - async Redis check\n    if (checkBlacklist && decoded.jti) {\n      const isBlacklisted = await isTokenBlacklisted(decoded.jti);\n      if (isBlacklisted) {\n        if (req) {\n          authLogger.logTokenBlacklisted(req, decoded.jti);\n        }\n        return null;\n      }\n    }\n\n    return decoded;\n  } catch (err) {\n    // Log specific error types for debugging\n    if (err.name === 'TokenExpiredError') {\n      if (req) {\n        authLogger.logTokenExpired(req);\n      }\n    } else if (err.name === 'JsonWebTokenError') {\n      if (req) {\n        authLogger.logTokenInvalid(req, err.message);\n      }\n    }\n    return null;\n  }\n}\n\n/**\n * Synchronous token verification (for cases where async is not possible)\n * Does NOT check blacklist - use verifyToken() for full verification\n * @param {string} token - JWT token to verify\n * @returns {Object|null} Decoded payload or null if invalid\n */\nfunction verifyTokenSync(token) {\n  try {\n    return jwt.verify(token, JWT_SECRET);\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Extract Bearer token from Authorization header\n * @param {string} authHeader - Authorization header value\n * @returns {string|null} Token or null if not found\n */\nfunction extractBearerToken(authHeader) {\n  if (!authHeader || typeof authHeader !== 'string') {\n    return null;\n  }\n\n  const parts = authHeader.split(' ');\n  if (parts.length !== 2 || parts[0].toLowerCase() !== 'bearer') {\n    return null;\n  }\n\n  return parts[1];\n}\n\n/**\n * Middleware to authenticate JWT tokens\n * Sets req.stripeCustomerId if valid token found\n *\n * Authentication Methods:\n * - Authorization: Bearer <token> (PREFERRED - use this method)\n * - x-stripe-customer-id header (DEPRECATED - see deprecation notice below)\n *\n * DEPRECATION: x-stripe-customer-id header\n * - This method is deprecated and controlled by ALLOW_LEGACY_AUTH env var\n * - Production: Disabled by default (returns 401)\n * - Development: Enabled by default for backward compatibility\n * - Sunset Date: 2026-04-11 (after which it will be removed entirely)\n * - When enabled, responses include X-Deprecation-Warning and X-Deprecation-Sunset headers\n *\n * @param {Object} req - Express request object\n * @param {Object} res - Express response object\n * @param {Function} next - Express next function\n */\nasync function authenticateToken(req, res, next) {\n  // First, try JWT token from Authorization header\n  const authHeader = req.headers['authorization'];\n  const token = extractBearerToken(authHeader);\n\n  if (token) {\n    // First verify JWT signature without blacklist check to get specific error messages\n    const decoded = verifyTokenSync(token);\n\n    if (!decoded || !decoded.sub) {\n      // Token is invalid or expired (signature failed)\n      authLogger.logTokenInvalid(req, 'Invalid or expired token');\n      return res.status(401).json({\n        error: 'Invalid or expired token',\n        message: 'Please log in again to continue'\n      });\n    }\n\n    // Check if token has been revoked (blacklisted) - async Redis check\n    if (decoded.jti) {\n      const isBlacklisted = await isTokenBlacklisted(decoded.jti);\n      if (isBlacklisted) {\n        authLogger.logTokenBlacklisted(req, decoded.jti);\n        return res.status(401).json({\n          error: 'Token has been revoked',\n          message: 'This session has been logged out. Please log in again.'\n        });\n      }\n    }\n\n    // Token is valid and not revoked\n    req.stripeCustomerId = decoded.sub;\n    req.tokenData = decoded;\n    req.rawToken = token; // Store raw token for logout\n    return next();\n  }\n\n  // ==========================================================================\n  // DEPRECATED: Legacy x-stripe-customer-id header authentication\n  // This authentication method is deprecated and will be removed after\n  // the sunset date. Clients should migrate to JWT Bearer token authentication.\n  // ==========================================================================\n  const legacyCustomerId = req.headers['x-stripe-customer-id'];\n  if (legacyCustomerId) {\n    // Check if legacy auth is allowed\n    if (!ALLOW_LEGACY_AUTH) {\n      console.warn(`[Auth] Legacy auth attempt rejected (disabled): ${legacyCustomerId.slice(0, 8)}...`);\n      authLogger.logLegacyAuthUsed(req, legacyCustomerId);\n      return res.status(401).json({\n        error: 'Legacy authentication disabled',\n        message: 'The x-stripe-customer-id header is no longer supported. Please use JWT Bearer token authentication.',\n        migration_guide: 'Use POST /auth/login with your license key to obtain a JWT token, then include it as: Authorization: Bearer <token>'\n      });\n    }\n\n    // Log deprecation warning with structured logging (once per request)\n    if (!req._legacyAuthWarned) {\n      authLogger.logLegacyAuthUsed(req, legacyCustomerId);\n      console.warn(`[Auth] DEPRECATION: Legacy auth used by ${legacyCustomerId.slice(0, 8)}... - migrate before ${LEGACY_AUTH_SUNSET_DATE}`);\n      req._legacyAuthWarned = true;\n    }\n\n    // Validate format\n    if (!legacyCustomerId.startsWith('cus_')) {\n      authLogger.logTokenInvalid(req, 'Invalid legacy customer ID format');\n      return res.status(401).json({\n        error: 'Invalid customer ID format',\n        message: 'Customer ID must start with cus_'\n      });\n    }\n\n    // Set deprecation warning header on the response\n    res.set('X-Deprecation-Warning', `x-stripe-customer-id header is deprecated. Please use JWT authentication. Sunset date: ${LEGACY_AUTH_SUNSET_DATE}`);\n    res.set('X-Deprecation-Sunset', LEGACY_AUTH_SUNSET_DATE);\n\n    req.stripeCustomerId = legacyCustomerId;\n    req.isLegacyAuth = true;\n    return next();\n  }\n\n  // No authentication provided\n  return res.status(401).json({\n    error: 'Authentication required',\n    message: 'Please provide a valid Bearer token in the Authorization header'\n  });\n}\n\n/**\n * Optional authentication middleware\n * Allows unauthenticated access but sets req.stripeCustomerId if token present\n *\n * Note: Legacy x-stripe-customer-id header is deprecated and controlled by ALLOW_LEGACY_AUTH\n */\nasync function optionalAuthentication(req, res, next) {\n  const authHeader = req.headers['authorization'];\n  const token = extractBearerToken(authHeader);\n\n  if (token) {\n    const decoded = await verifyToken(token);\n    if (decoded && decoded.sub) {\n      req.stripeCustomerId = decoded.sub;\n      req.tokenData = decoded;\n    }\n  } else {\n    // DEPRECATED: Legacy x-stripe-customer-id header authentication\n    const legacyCustomerId = req.headers['x-stripe-customer-id'];\n    if (legacyCustomerId && legacyCustomerId.startsWith('cus_')) {\n      // Only accept legacy auth if allowed\n      if (ALLOW_LEGACY_AUTH) {\n        // Log deprecation warning\n        if (!req._legacyAuthWarned) {\n          authLogger.logLegacyAuthUsed(req, legacyCustomerId);\n          console.warn(`[Auth] DEPRECATION: Legacy auth used by ${legacyCustomerId.slice(0, 8)}... - migrate before ${LEGACY_AUTH_SUNSET_DATE}`);\n          req._legacyAuthWarned = true;\n        }\n\n        // Set deprecation warning headers\n        res.set('X-Deprecation-Warning', `x-stripe-customer-id header is deprecated. Please use JWT authentication. Sunset date: ${LEGACY_AUTH_SUNSET_DATE}`);\n        res.set('X-Deprecation-Sunset', LEGACY_AUTH_SUNSET_DATE);\n\n        req.stripeCustomerId = legacyCustomerId;\n        req.isLegacyAuth = true;\n      }\n      // If legacy auth is disabled, silently ignore (optional auth doesn't require auth)\n    }\n  }\n\n  next();\n}\n\n/**\n * HIGH-007: Database-backed admin role check middleware\n * Checks the user's role in the database instead of relying on env vars\n * Requires authenticateToken middleware to run first\n *\n * @param {Object} req - Express request object (must have req.stripeCustomerId set)\n * @param {Object} res - Express response object\n * @param {Function} next - Express next function\n */\nasync function requireAdmin(req, res, next) {\n  // Must be authenticated first\n  if (!req.stripeCustomerId) {\n    return res.status(401).json({\n      error: 'Authentication required',\n      message: 'Please log in to access this resource'\n    });\n  }\n\n  // Check if database pool is available\n  if (!pool) {\n    console.error('[Auth] Admin check failed: Database pool not available');\n    return res.status(503).json({\n      error: 'Service unavailable',\n      message: 'Admin verification temporarily unavailable'\n    });\n  }\n\n  try {\n    // Query database for user role\n    const result = await pool.query(\n      'SELECT role FROM users WHERE stripe_customer_id = $1',\n      [req.stripeCustomerId]\n    );\n\n    if (!result.rows[0]) {\n      authLogger.logAdminAccessDenied(req, 'User not found in database');\n      return res.status(403).json({\n        error: 'Access denied',\n        message: 'User account not found'\n      });\n    }\n\n    const userRole = result.rows[0].role;\n\n    if (userRole !== 'admin') {\n      authLogger.logAdminAccessDenied(req, `Role is '${userRole}', admin required`);\n      return res.status(403).json({\n        error: 'Admin access required',\n        message: 'This action requires administrator privileges'\n      });\n    }\n\n    // User is admin - log and proceed\n    authLogger.logAdminAccess(req);\n    req.isAdmin = true;\n    next();\n  } catch (err) {\n    console.error('[Auth] Admin role check failed:', err.message);\n    return res.status(500).json({\n      error: 'Authorization check failed',\n      message: 'Unable to verify admin privileges'\n    });\n  }\n}\n\n/**\n * Mask sensitive data for logging\n * @param {string} key - License key or other sensitive string\n * @returns {string} Masked string (e.g., \"SPLICE-ABC1-****-****-****\")\n */\nfunction maskSensitiveData(data) {\n  if (!data || typeof data !== 'string') {\n    return '****';\n  }\n\n  // For license keys (SPLICE-XXXX-XXXX-XXXX-XXXX format)\n  if (data.startsWith('SPLICE-')) {\n    const parts = data.split('-');\n    if (parts.length === 5) {\n      return `${parts[0]}-${parts[1]}-****-****-****`;\n    }\n  }\n\n  // For customer IDs (cus_xxxx format)\n  if (data.startsWith('cus_')) {\n    if (data.length > 10) {\n      return `cus_${data.slice(4, 8)}****`;\n    }\n    return 'cus_****';\n  }\n\n  // For JWTs (eyJ... format)\n  if (data.startsWith('eyJ')) {\n    return `${data.slice(0, 10)}...****`;\n  }\n\n  // For emails\n  if (data.includes('@')) {\n    const [local, domain] = data.split('@');\n    const maskedLocal = local.length > 2 ? `${local[0]}***${local[local.length-1]}` : '***';\n    return `${maskedLocal}@${domain}`;\n  }\n\n  // Generic masking - show first 4 chars\n  if (data.length > 8) {\n    return `${data.slice(0, 4)}****`;\n  }\n\n  return '****';\n}\n\nmodule.exports = {\n  generateToken,\n  generateRefreshToken,\n  verifyToken,\n  verifyTokenSync,\n  extractBearerToken,\n  authenticateToken,\n  optionalAuthentication,\n  maskSensitiveData,\n  // HIGH-007: Admin RBAC middleware\n  requireAdmin,\n  // Token blacklist functions\n  blacklistToken,\n  isTokenBlacklisted,\n  getBlacklistStats,\n  // Structured logging\n  authLogger,\n  // Constants\n  JWT_SECRET,\n  JWT_EXPIRES_IN,\n  // Legacy auth deprecation constants\n  LEGACY_AUTH_SUNSET_DATE,\n  ALLOW_LEGACY_AUTH\n};\n","numLines":694,"startLine":1,"totalLines":694}},"sourceToolAssistantUUID":"37a16193-a6ff-479e-99dd-b5589eaa418b"}
{"parentUuid":"61dbe6a5-a150-4a1d-928c-7f9f5013db77","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01KawTaTziSuP4u3CUTmAkHP","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the other modified files:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9391,"cache_read_input_tokens":32492,"cache_creation":{"ephemeral_5m_input_tokens":9391,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX48imu4qKdqB2RVhMPhV","type":"assistant","uuid":"27ca172f-4d87-4e24-a17b-ba78a64f43f1","timestamp":"2026-01-12T20:42:47.245Z"}
{"parentUuid":"27ca172f-4d87-4e24-a17b-ba78a64f43f1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01KawTaTziSuP4u3CUTmAkHP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XRyHjVqUu9mRb7C1KnG8eb","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-backend/middleware/inputValidation.js","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9391,"cache_read_input_tokens":32492,"cache_creation":{"ephemeral_5m_input_tokens":9391,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CX48imu4qKdqB2RVhMPhV","type":"assistant","uuid":"0029bc6f-4928-4351-8499-a56134f226d1","timestamp":"2026-01-12T20:42:47.785Z"}
{"parentUuid":"0029bc6f-4928-4351-8499-a56134f226d1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XRyHjVqUu9mRb7C1KnG8eb","type":"tool_result","content":"     1→/**\n     2→ * Input Validation Middleware\n     3→ *\n     4→ * Provides type validation and sanitization for API request parameters\n     5→ * to prevent type confusion attacks and ensure data integrity.\n     6→ *\n     7→ * SECURITY ENHANCEMENTS:\n     8→ * - Email validation with RFC-compliant regex\n     9→ * - File upload validation (type, size, extension whitelist)\n    10→ * - Input sanitization to prevent injection attacks\n    11→ * - Request body size enforcement\n    12→ * - Path traversal prevention\n    13→ */\n    14→\n    15→const path = require('path');\n    16→\n    17→/**\n    18→ * Validate that a value is a non-empty string\n    19→ * @param {any} value - Value to validate\n    20→ * @param {string} fieldName - Name of the field for error messages\n    21→ * @returns {{valid: boolean, value?: string, error?: string}}\n    22→ */\n    23→function validateString(value, fieldName, options = {}) {\n    24→  const { maxLength = 10000, allowEmpty = false } = options;\n    25→\n    26→  if (value === null || value === undefined) {\n    27→    return { valid: false, error: `${fieldName} is required` };\n    28→  }\n    29→\n    30→  if (typeof value !== 'string') {\n    31→    return { valid: false, error: `${fieldName} must be a string` };\n    32→  }\n    33→\n    34→  if (!allowEmpty && value.trim() === '') {\n    35→    return { valid: false, error: `${fieldName} cannot be empty` };\n    36→  }\n    37→\n    38→  if (value.length > maxLength) {\n    39→    return { valid: false, error: `${fieldName} exceeds maximum length of ${maxLength}` };\n    40→  }\n    41→\n    42→  return { valid: true, value: value.trim() };\n    43→}\n    44→\n    45→/**\n    46→ * Validate that a value is a number within range\n    47→ * @param {any} value - Value to validate\n    48→ * @param {string} fieldName - Name of the field for error messages\n    49→ * @param {Object} options - Validation options\n    50→ * @returns {{valid: boolean, value?: number, error?: string}}\n    51→ */\n    52→function validateNumber(value, fieldName, options = {}) {\n    53→  const { min = -Infinity, max = Infinity, allowNegative = true } = options;\n    54→\n    55→  if (value === null || value === undefined) {\n    56→    return { valid: false, error: `${fieldName} is required` };\n    57→  }\n    58→\n    59→  const num = typeof value === 'string' ? parseFloat(value) : value;\n    60→\n    61→  if (typeof num !== 'number' || isNaN(num)) {\n    62→    return { valid: false, error: `${fieldName} must be a valid number` };\n    63→  }\n    64→\n    65→  if (!allowNegative && num < 0) {\n    66→    return { valid: false, error: `${fieldName} cannot be negative` };\n    67→  }\n    68→\n    69→  if (num < min || num > max) {\n    70→    return { valid: false, error: `${fieldName} must be between ${min} and ${max}` };\n    71→  }\n    72→\n    73→  return { valid: true, value: num };\n    74→}\n    75→\n    76→/**\n    77→ * Validate that a value is a boolean\n    78→ * @param {any} value - Value to validate\n    79→ * @param {string} fieldName - Name of the field for error messages\n    80→ * @returns {{valid: boolean, value?: boolean, error?: string}}\n    81→ */\n    82→function validateBoolean(value, fieldName) {\n    83→  if (value === null || value === undefined) {\n    84→    return { valid: true, value: false }; // Default to false\n    85→  }\n    86→\n    87→  if (typeof value === 'boolean') {\n    88→    return { valid: true, value };\n    89→  }\n    90→\n    91→  if (value === 'true' || value === '1') {\n    92→    return { valid: true, value: true };\n    93→  }\n    94→\n    95→  if (value === 'false' || value === '0') {\n    96→    return { valid: true, value: false };\n    97→  }\n    98→\n    99→  return { valid: false, error: `${fieldName} must be a boolean` };\n   100→}\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"4d438f88-d4e7-404f-99a5-236602db4fb8","timestamp":"2026-01-12T20:42:47.838Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-backend/middleware/inputValidation.js","content":"/**\n * Input Validation Middleware\n *\n * Provides type validation and sanitization for API request parameters\n * to prevent type confusion attacks and ensure data integrity.\n *\n * SECURITY ENHANCEMENTS:\n * - Email validation with RFC-compliant regex\n * - File upload validation (type, size, extension whitelist)\n * - Input sanitization to prevent injection attacks\n * - Request body size enforcement\n * - Path traversal prevention\n */\n\nconst path = require('path');\n\n/**\n * Validate that a value is a non-empty string\n * @param {any} value - Value to validate\n * @param {string} fieldName - Name of the field for error messages\n * @returns {{valid: boolean, value?: string, error?: string}}\n */\nfunction validateString(value, fieldName, options = {}) {\n  const { maxLength = 10000, allowEmpty = false } = options;\n\n  if (value === null || value === undefined) {\n    return { valid: false, error: `${fieldName} is required` };\n  }\n\n  if (typeof value !== 'string') {\n    return { valid: false, error: `${fieldName} must be a string` };\n  }\n\n  if (!allowEmpty && value.trim() === '') {\n    return { valid: false, error: `${fieldName} cannot be empty` };\n  }\n\n  if (value.length > maxLength) {\n    return { valid: false, error: `${fieldName} exceeds maximum length of ${maxLength}` };\n  }\n\n  return { valid: true, value: value.trim() };\n}\n\n/**\n * Validate that a value is a number within range\n * @param {any} value - Value to validate\n * @param {string} fieldName - Name of the field for error messages\n * @param {Object} options - Validation options\n * @returns {{valid: boolean, value?: number, error?: string}}\n */\nfunction validateNumber(value, fieldName, options = {}) {\n  const { min = -Infinity, max = Infinity, allowNegative = true } = options;\n\n  if (value === null || value === undefined) {\n    return { valid: false, error: `${fieldName} is required` };\n  }\n\n  const num = typeof value === 'string' ? parseFloat(value) : value;\n\n  if (typeof num !== 'number' || isNaN(num)) {\n    return { valid: false, error: `${fieldName} must be a valid number` };\n  }\n\n  if (!allowNegative && num < 0) {\n    return { valid: false, error: `${fieldName} cannot be negative` };\n  }\n\n  if (num < min || num > max) {\n    return { valid: false, error: `${fieldName} must be between ${min} and ${max}` };\n  }\n\n  return { valid: true, value: num };\n}\n\n/**\n * Validate that a value is a boolean\n * @param {any} value - Value to validate\n * @param {string} fieldName - Name of the field for error messages\n * @returns {{valid: boolean, value?: boolean, error?: string}}\n */\nfunction validateBoolean(value, fieldName) {\n  if (value === null || value === undefined) {\n    return { valid: true, value: false }; // Default to false\n  }\n\n  if (typeof value === 'boolean') {\n    return { valid: true, value };\n  }\n\n  if (value === 'true' || value === '1') {\n    return { valid: true, value: true };\n  }\n\n  if (value === 'false' || value === '0') {\n    return { valid: true, value: false };\n  }\n\n  return { valid: false, error: `${fieldName} must be a boolean` };\n}","numLines":100,"startLine":1,"totalLines":374}},"sourceToolAssistantUUID":"0029bc6f-4928-4351-8499-a56134f226d1"}
{"parentUuid":"4d438f88-d4e7-404f-99a5-236602db4fb8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Covj9YXGwgdLw1ZvnyTBT6","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the rateLimiter and server changes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":1572,"cache_read_input_tokens":41883,"cache_creation":{"ephemeral_5m_input_tokens":1572,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48iwWm57eXf65c8dNcT","type":"assistant","uuid":"b98a9801-8539-4887-b05a-09b8a6806024","timestamp":"2026-01-12T20:42:49.824Z"}
{"parentUuid":"b98a9801-8539-4887-b05a-09b8a6806024","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Covj9YXGwgdLw1ZvnyTBT6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01S3zU3A5VT7WuCU2GNMgQwY","name":"Bash","input":{"command":"git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git diff splice-backend/middleware/rateLimiter.js | head -150"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":1572,"cache_read_input_tokens":41883,"cache_creation":{"ephemeral_5m_input_tokens":1572,"ephemeral_1h_input_tokens":0},"output_tokens":110,"service_tier":"standard"}},"requestId":"req_011CX48iwWm57eXf65c8dNcT","type":"assistant","uuid":"468626cf-729e-4d8d-b808-da6fc4199786","timestamp":"2026-01-12T20:42:50.430Z"}
{"parentUuid":"468626cf-729e-4d8d-b808-da6fc4199786","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01S3zU3A5VT7WuCU2GNMgQwY","type":"tool_result","content":"diff --git a/splice-backend/middleware/rateLimiter.js b/splice-backend/middleware/rateLimiter.js\nindex aa2a805..a792598 100644\n--- a/splice-backend/middleware/rateLimiter.js\n+++ b/splice-backend/middleware/rateLimiter.js\n@@ -37,6 +37,11 @@ const ALLOW_LEGACY_AUTH = process.env.ALLOW_LEGACY_AUTH === 'true';\n /**\n  * Rate limit configuration\n  * Tiered limits: authenticated users get higher limits than anonymous\n+ *\n+ * SECURITY FIX: Added rate limits for all expensive/AI endpoints to prevent:\n+ * - API cost escalation (OpenAI, Replicate API abuse)\n+ * - DoS attacks on compute-intensive endpoints\n+ * - Brute force on referral codes\n  */\n const RATE_LIMITS = {\n   // Global IP limits\n@@ -44,12 +49,59 @@ const RATE_LIMITS = {\n     anonymous: { max: 100, window: 60 },      // 100 req/min for unauthenticated\n     authenticated: { max: 300, window: 60 }   // 300 req/min for authenticated users\n   },\n-  // Endpoint-specific limits (stricter)\n+  // Endpoint-specific limits (stricter for expensive operations)\n   endpoints: {\n+    // Auth endpoints - strict limits to prevent brute force\n     '/auth/send-code': { max: 5, window: 300 },        // 5 requests per 5 minutes\n     '/auth/verify-code': { max: 10, window: 300 },     // 10 requests per 5 minutes\n+    '/auth/login': { max: 10, window: 60 },            // 10 login attempts per minute\n+\n+    // Music generation - expensive AI operation\n     '/music/generate': { max: 10, window: 60 },        // 10 requests per minute\n+    '/music/status': { max: 60, window: 60 },          // 60 status checks per minute\n+\n+    // Analysis endpoints - use OpenAI/AI services\n     '/analyze': { max: 30, window: 60 },               // 30 requests per minute\n+\n+    // Transcription-heavy endpoints - expensive AI operations\n+    '/captions/animate': { max: 15, window: 60 },      // 15 caption generations per minute\n+    '/captions/export': { max: 30, window: 60 },       // 30 exports per minute\n+\n+    // Detection endpoints - compute-intensive\n+    '/silences/detect': { max: 20, window: 60 },       // 20 silence detections per minute\n+    '/detection/takes': { max: 20, window: 60 },       // 20 take detections per minute\n+    '/detection/scenes': { max: 20, window: 60 },      // 20 scene detections per minute\n+\n+    // Multitrack analysis - expensive operation\n+    '/multitrack/analyze': { max: 15, window: 60 },    // 15 multitrack analyses per minute\n+\n+    // Chapter detection - AI-powered\n+    '/chapters/detect': { max: 15, window: 60 },       // 15 chapter detections per minute\n+\n+    // Reframe/social - compute-intensive\n+    '/reframe/analyze': { max: 15, window: 60 },       // 15 reframe analyses per minute\n+\n+    // YouTube/Zoom generation - AI-powered content\n+    '/youtube/generate': { max: 10, window: 60 },      // 10 YouTube generations per minute\n+    '/zoom/generate': { max: 10, window: 60 },         // 10 Zoom generations per minute\n+\n+    // Text editing - AI-powered\n+    '/text-edit/process': { max: 20, window: 60 },     // 20 text edits per minute\n+\n+    // Cut list generation\n+    '/cutlist/generate': { max: 20, window: 60 },      // 20 cut lists per minute\n+\n+    // Export operations\n+    '/export': { max: 30, window: 60 },                // 30 exports per minute\n+\n+    // Batch operations - very expensive\n+    '/batch/start': { max: 5, window: 60 },            // 5 batch jobs per minute\n+\n+    // Referral code validation - prevent brute force\n+    '/referral/validate': { max: 10, window: 60 },     // 10 validations per minute\n+    '/referral/apply': { max: 5, window: 60 },         // 5 applications per minute\n+\n+    // Upload operations\n     'upload': { max: 20, window: 60 }                  // 20 uploads per minute\n   }\n };\n@@ -77,23 +129,27 @@ setInterval(() => {\n async function checkRateLimit(key, max, windowSeconds) {\n   try {\n     // Try Redis first (preferred for multi-instance deployments)\n-    if (redisClient && redisClient.isConnected) {\n-      const current = await redisClient.incr(key);\n-      \n-      if (current === 1) {\n-        // First request in window, set expiry\n-        await redisClient.expire(key, windowSeconds);\n+    // Use isRedisAvailable() function and getRedisClient() to access raw client\n+    if (redisClient && redisClient.isRedisAvailable()) {\n+      const redis = redisClient.getRedisClient();\n+      if (redis) {\n+        const current = await redis.incr(key);\n+\n+        if (current === 1) {\n+          // First request in window, set expiry\n+          await redis.expire(key, windowSeconds);\n+        }\n+\n+        const ttlValue = await redis.ttl(key);\n+        const resetAt = Date.now() + (ttlValue * 1000);\n+\n+        return {\n+          allowed: current <= max,\n+          remaining: Math.max(0, max - current),\n+          resetAt,\n+          retryAfter: ttlValue\n+        };\n       }\n-      \n-      const ttl = await redisClient.ttl(key);\n-      const resetAt = Date.now() + (ttl * 1000);\n-      \n-      return {\n-        allowed: current <= max,\n-        remaining: Math.max(0, max - current),\n-        resetAt,\n-        retryAfter: ttl\n-      };\n     }\n   } catch (redisError) {\n     console.warn('[RateLimiter] Redis error, falling back to in-memory:', redisError.message);","is_error":false}]},"uuid":"f9938214-1373-4d5b-879d-035ccacdbbfa","timestamp":"2026-01-12T20:42:50.980Z","toolUseResult":{"stdout":"diff --git a/splice-backend/middleware/rateLimiter.js b/splice-backend/middleware/rateLimiter.js\nindex aa2a805..a792598 100644\n--- a/splice-backend/middleware/rateLimiter.js\n+++ b/splice-backend/middleware/rateLimiter.js\n@@ -37,6 +37,11 @@ const ALLOW_LEGACY_AUTH = process.env.ALLOW_LEGACY_AUTH === 'true';\n /**\n  * Rate limit configuration\n  * Tiered limits: authenticated users get higher limits than anonymous\n+ *\n+ * SECURITY FIX: Added rate limits for all expensive/AI endpoints to prevent:\n+ * - API cost escalation (OpenAI, Replicate API abuse)\n+ * - DoS attacks on compute-intensive endpoints\n+ * - Brute force on referral codes\n  */\n const RATE_LIMITS = {\n   // Global IP limits\n@@ -44,12 +49,59 @@ const RATE_LIMITS = {\n     anonymous: { max: 100, window: 60 },      // 100 req/min for unauthenticated\n     authenticated: { max: 300, window: 60 }   // 300 req/min for authenticated users\n   },\n-  // Endpoint-specific limits (stricter)\n+  // Endpoint-specific limits (stricter for expensive operations)\n   endpoints: {\n+    // Auth endpoints - strict limits to prevent brute force\n     '/auth/send-code': { max: 5, window: 300 },        // 5 requests per 5 minutes\n     '/auth/verify-code': { max: 10, window: 300 },     // 10 requests per 5 minutes\n+    '/auth/login': { max: 10, window: 60 },            // 10 login attempts per minute\n+\n+    // Music generation - expensive AI operation\n     '/music/generate': { max: 10, window: 60 },        // 10 requests per minute\n+    '/music/status': { max: 60, window: 60 },          // 60 status checks per minute\n+\n+    // Analysis endpoints - use OpenAI/AI services\n     '/analyze': { max: 30, window: 60 },               // 30 requests per minute\n+\n+    // Transcription-heavy endpoints - expensive AI operations\n+    '/captions/animate': { max: 15, window: 60 },      // 15 caption generations per minute\n+    '/captions/export': { max: 30, window: 60 },       // 30 exports per minute\n+\n+    // Detection endpoints - compute-intensive\n+    '/silences/detect': { max: 20, window: 60 },       // 20 silence detections per minute\n+    '/detection/takes': { max: 20, window: 60 },       // 20 take detections per minute\n+    '/detection/scenes': { max: 20, window: 60 },      // 20 scene detections per minute\n+\n+    // Multitrack analysis - expensive operation\n+    '/multitrack/analyze': { max: 15, window: 60 },    // 15 multitrack analyses per minute\n+\n+    // Chapter detection - AI-powered\n+    '/chapters/detect': { max: 15, window: 60 },       // 15 chapter detections per minute\n+\n+    // Reframe/social - compute-intensive\n+    '/reframe/analyze': { max: 15, window: 60 },       // 15 reframe analyses per minute\n+\n+    // YouTube/Zoom generation - AI-powered content\n+    '/youtube/generate': { max: 10, window: 60 },      // 10 YouTube generations per minute\n+    '/zoom/generate': { max: 10, window: 60 },         // 10 Zoom generations per minute\n+\n+    // Text editing - AI-powered\n+    '/text-edit/process': { max: 20, window: 60 },     // 20 text edits per minute\n+\n+    // Cut list generation\n+    '/cutlist/generate': { max: 20, window: 60 },      // 20 cut lists per minute\n+\n+    // Export operations\n+    '/export': { max: 30, window: 60 },                // 30 exports per minute\n+\n+    // Batch operations - very expensive\n+    '/batch/start': { max: 5, window: 60 },            // 5 batch jobs per minute\n+\n+    // Referral code validation - prevent brute force\n+    '/referral/validate': { max: 10, window: 60 },     // 10 validations per minute\n+    '/referral/apply': { max: 5, window: 60 },         // 5 applications per minute\n+\n+    // Upload operations\n     'upload': { max: 20, window: 60 }                  // 20 uploads per minute\n   }\n };\n@@ -77,23 +129,27 @@ setInterval(() => {\n async function checkRateLimit(key, max, windowSeconds) {\n   try {\n     // Try Redis first (preferred for multi-instance deployments)\n-    if (redisClient && redisClient.isConnected) {\n-      const current = await redisClient.incr(key);\n-      \n-      if (current === 1) {\n-        // First request in window, set expiry\n-        await redisClient.expire(key, windowSeconds);\n+    // Use isRedisAvailable() function and getRedisClient() to access raw client\n+    if (redisClient && redisClient.isRedisAvailable()) {\n+      const redis = redisClient.getRedisClient();\n+      if (redis) {\n+        const current = await redis.incr(key);\n+\n+        if (current === 1) {\n+          // First request in window, set expiry\n+          await redis.expire(key, windowSeconds);\n+        }\n+\n+        const ttlValue = await redis.ttl(key);\n+        const resetAt = Date.now() + (ttlValue * 1000);\n+\n+        return {\n+          allowed: current <= max,\n+          remaining: Math.max(0, max - current),\n+          resetAt,\n+          retryAfter: ttlValue\n+        };\n       }\n-      \n-      const ttl = await redisClient.ttl(key);\n-      const resetAt = Date.now() + (ttl * 1000);\n-      \n-      return {\n-        allowed: current <= max,\n-        remaining: Math.max(0, max - current),\n-        resetAt,\n-        retryAfter: ttl\n-      };\n     }\n   } catch (redisError) {\n     console.warn('[RateLimiter] Redis error, falling back to in-memory:', redisError.message);","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"468626cf-729e-4d8d-b808-da6fc4199786"}
{"parentUuid":"27da7b62-ee13-4b39-a334-574bfe8d5df5","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019NkvXB81vnYUxhKVqWN55M","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the server.js and service changes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1855,"cache_read_input_tokens":43455,"cache_creation":{"ephemeral_5m_input_tokens":1855,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48jB3MVUyYRes9M1Nki","type":"assistant","uuid":"25d56556-7567-4e43-819b-bb61dfc72027","timestamp":"2026-01-12T20:42:52.773Z"}
{"parentUuid":"25d56556-7567-4e43-819b-bb61dfc72027","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019NkvXB81vnYUxhKVqWN55M","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SDx8Nh5QFBFDZfWoaCas4h","name":"Bash","input":{"command":"git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git diff splice-backend/server.js | head -200"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1855,"cache_read_input_tokens":43455,"cache_creation":{"ephemeral_5m_input_tokens":1855,"ephemeral_1h_input_tokens":0},"output_tokens":104,"service_tier":"standard"}},"requestId":"req_011CX48jB3MVUyYRes9M1Nki","type":"assistant","uuid":"8ac97870-28da-4852-8567-1b720486f9f7","timestamp":"2026-01-12T20:42:53.393Z"}
{"parentUuid":"8ac97870-28da-4852-8567-1b720486f9f7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SDx8Nh5QFBFDZfWoaCas4h","type":"tool_result","content":"diff --git a/splice-backend/server.js b/splice-backend/server.js\nindex 2abe4b1..dce379c 100644\n--- a/splice-backend/server.js\n+++ b/splice-backend/server.js\n@@ -17,6 +17,7 @@ require('dotenv').config();\n const express = require('express');\n const cors = require('cors');\n const helmet = require('helmet');\n+const compression = require('compression');\n const cookieParser = require('cookie-parser');\n const fs = require('fs');\n const https = require('https');\n@@ -71,9 +72,12 @@ const billingRoutes = require('./routes/billing');\n const referralRoutes = require('./routes/referral');\n const licenseRoutes = require('./routes/license');\n const musicRoutes = require('./routes/music');\n+const zoomProRoutes = require('./routes/zoomPro');\n+const workflowRoutes = require('./routes/workflows');\n \n // Music generation worker (BullMQ background processor)\n const { createMusicWorker, shutdownWorker } = require('./workers/musicWorker');\n+let musicWorkerInstance = null; // Track worker for graceful shutdown\n \n // HIGH-011: API Versioning - v1 routes\n const v1Routes = require('./routes/v1');\n@@ -119,10 +123,13 @@ function validateEnvironmentVariables() {\n     errors.push('OPENAI_API_KEY is required (OpenAI API for transcription)');\n   }\n   \n-  // CRITICAL: Redis required for job queue and rate limiting\n+  // CRITICAL: Redis required for job queue and rate limiting in production\n   // Support both Railway Redis (REDIS_URL) and Upstash (UPSTASH_REDIS_URL)\n-  if (!process.env.REDIS_URL && !process.env.UPSTASH_REDIS_URL) {\n+  // In development, will fall back to in-memory storage\n+  if (process.env.NODE_ENV === 'production' && !process.env.REDIS_URL && !process.env.UPSTASH_REDIS_URL) {\n     errors.push('REDIS_URL or UPSTASH_REDIS_URL is required (Redis for job queue and rate limiting)');\n+  } else if (!process.env.REDIS_URL && !process.env.UPSTASH_REDIS_URL) {\n+    console.warn('[SPLICE] WARNING: Redis not configured. Using in-memory fallback (not suitable for production).');\n   }\n   \n   // CRITICAL: Webhook secret required in production\n@@ -245,7 +252,7 @@ if (Sentry && process.env.SENTRY_DSN) {\n   Sentry.init({\n     dsn: process.env.SENTRY_DSN,\n     environment: process.env.NODE_ENV || 'development',\n-    release: process.env.npm_package_version || '6.0.3',\n+    release: process.env.npm_package_version || '6.0.8',\n     tracesSampleRate: isProduction ? 0.1 : 1.0, // 10% in prod, 100% in dev\n     profilesSampleRate: isProduction ? 0.1 : 0, // Profile only in production\n     integrations: [\n@@ -304,10 +311,13 @@ const CORS_WHITELIST = [\n   'https://127.0.0.1:3847',\n   'https://splice.app',\n   'https://www.splice.app',\n+  'https://splice.video',\n+  'https://www.splice.video',\n   'https://spliceclips.com',\n   'https://www.spliceclips.com',\n   'https://splice-api-production.up.railway.app',\n   'https://splice-website.vercel.app',\n+  'https://splice-dusky.vercel.app',\n   // Adobe CEP/UXP panels run from file:// or bolt://\n   'file://',\n   'bolt://'\n@@ -374,6 +384,22 @@ app.use(helmet({\n   hidePoweredBy: true\n }));\n \n+// PERF-003: Response compression (gzip/deflate) - reduces payload size by 40-60%\n+app.use(compression({\n+  // Only compress responses > 1KB\n+  threshold: 1024,\n+  // Compression level (0-9), 6 is a good balance between speed and compression\n+  level: 6,\n+  // Skip compression if client sends x-no-compression header\n+  filter: (req, res) => {\n+    if (req.headers['x-no-compression']) {\n+      return false;\n+    }\n+    // Use compression's default filter (compresses text-based responses)\n+    return compression.filter(req, res);\n+  }\n+}));\n+\n // Helper to determine tier from price ID with logging\n // Supports both monthly and annual pricing\n function getTierFromPriceId(priceId) {\n@@ -787,6 +813,12 @@ app.use('/license', licenseRoutes(routeOptions));\n // AI Music generation endpoints\n app.use('/music', musicRoutes(routeOptions));\n \n+// Auto Zoom with Face Detection endpoints\n+app.use('/zoom-pro', zoomProRoutes(routeOptions));\n+\n+// Workflow Automation endpoints\n+app.use('/workflows', workflowRoutes(routeOptions));\n+\n // =============================================================================\n // HIGH-011: API Versioning\n // Mount versioned routes under /api/v1 prefix\n@@ -849,7 +881,7 @@ async function startServer() {\n     if (process.env.REDIS_URL || process.env.UPSTASH_REDIS_URL) {\n       if (process.env.REPLICATE_API_TOKEN) {\n         try {\n-          createMusicWorker();\n+          musicWorkerInstance = createMusicWorker();\n           console.log('[SPLICE] ✅ Music generation worker started');\n         } catch (workerErr) {\n           console.error('[SPLICE] ⚠️ Failed to start music worker:', workerErr.message);\n@@ -896,8 +928,10 @@ async function gracefulShutdown(signal) {\n \n   // Shutdown music worker (allows in-progress jobs to complete)\n   try {\n-    await shutdownWorker();\n-    console.log('[SPLICE] Music worker shut down');\n+    if (musicWorkerInstance) {\n+      await shutdownWorker(musicWorkerInstance);\n+      console.log('[SPLICE] Music worker shut down');\n+    }\n   } catch (err) {\n     console.error('[SPLICE] Error shutting down music worker:', err.message);\n   }","is_error":false}]},"uuid":"8dd49f9e-f493-4a9e-b88b-6c251a3c0ef7","timestamp":"2026-01-12T20:42:54.802Z","toolUseResult":{"stdout":"diff --git a/splice-backend/server.js b/splice-backend/server.js\nindex 2abe4b1..dce379c 100644\n--- a/splice-backend/server.js\n+++ b/splice-backend/server.js\n@@ -17,6 +17,7 @@ require('dotenv').config();\n const express = require('express');\n const cors = require('cors');\n const helmet = require('helmet');\n+const compression = require('compression');\n const cookieParser = require('cookie-parser');\n const fs = require('fs');\n const https = require('https');\n@@ -71,9 +72,12 @@ const billingRoutes = require('./routes/billing');\n const referralRoutes = require('./routes/referral');\n const licenseRoutes = require('./routes/license');\n const musicRoutes = require('./routes/music');\n+const zoomProRoutes = require('./routes/zoomPro');\n+const workflowRoutes = require('./routes/workflows');\n \n // Music generation worker (BullMQ background processor)\n const { createMusicWorker, shutdownWorker } = require('./workers/musicWorker');\n+let musicWorkerInstance = null; // Track worker for graceful shutdown\n \n // HIGH-011: API Versioning - v1 routes\n const v1Routes = require('./routes/v1');\n@@ -119,10 +123,13 @@ function validateEnvironmentVariables() {\n     errors.push('OPENAI_API_KEY is required (OpenAI API for transcription)');\n   }\n   \n-  // CRITICAL: Redis required for job queue and rate limiting\n+  // CRITICAL: Redis required for job queue and rate limiting in production\n   // Support both Railway Redis (REDIS_URL) and Upstash (UPSTASH_REDIS_URL)\n-  if (!process.env.REDIS_URL && !process.env.UPSTASH_REDIS_URL) {\n+  // In development, will fall back to in-memory storage\n+  if (process.env.NODE_ENV === 'production' && !process.env.REDIS_URL && !process.env.UPSTASH_REDIS_URL) {\n     errors.push('REDIS_URL or UPSTASH_REDIS_URL is required (Redis for job queue and rate limiting)');\n+  } else if (!process.env.REDIS_URL && !process.env.UPSTASH_REDIS_URL) {\n+    console.warn('[SPLICE] WARNING: Redis not configured. Using in-memory fallback (not suitable for production).');\n   }\n   \n   // CRITICAL: Webhook secret required in production\n@@ -245,7 +252,7 @@ if (Sentry && process.env.SENTRY_DSN) {\n   Sentry.init({\n     dsn: process.env.SENTRY_DSN,\n     environment: process.env.NODE_ENV || 'development',\n-    release: process.env.npm_package_version || '6.0.3',\n+    release: process.env.npm_package_version || '6.0.8',\n     tracesSampleRate: isProduction ? 0.1 : 1.0, // 10% in prod, 100% in dev\n     profilesSampleRate: isProduction ? 0.1 : 0, // Profile only in production\n     integrations: [\n@@ -304,10 +311,13 @@ const CORS_WHITELIST = [\n   'https://127.0.0.1:3847',\n   'https://splice.app',\n   'https://www.splice.app',\n+  'https://splice.video',\n+  'https://www.splice.video',\n   'https://spliceclips.com',\n   'https://www.spliceclips.com',\n   'https://splice-api-production.up.railway.app',\n   'https://splice-website.vercel.app',\n+  'https://splice-dusky.vercel.app',\n   // Adobe CEP/UXP panels run from file:// or bolt://\n   'file://',\n   'bolt://'\n@@ -374,6 +384,22 @@ app.use(helmet({\n   hidePoweredBy: true\n }));\n \n+// PERF-003: Response compression (gzip/deflate) - reduces payload size by 40-60%\n+app.use(compression({\n+  // Only compress responses > 1KB\n+  threshold: 1024,\n+  // Compression level (0-9), 6 is a good balance between speed and compression\n+  level: 6,\n+  // Skip compression if client sends x-no-compression header\n+  filter: (req, res) => {\n+    if (req.headers['x-no-compression']) {\n+      return false;\n+    }\n+    // Use compression's default filter (compresses text-based responses)\n+    return compression.filter(req, res);\n+  }\n+}));\n+\n // Helper to determine tier from price ID with logging\n // Supports both monthly and annual pricing\n function getTierFromPriceId(priceId) {\n@@ -787,6 +813,12 @@ app.use('/license', licenseRoutes(routeOptions));\n // AI Music generation endpoints\n app.use('/music', musicRoutes(routeOptions));\n \n+// Auto Zoom with Face Detection endpoints\n+app.use('/zoom-pro', zoomProRoutes(routeOptions));\n+\n+// Workflow Automation endpoints\n+app.use('/workflows', workflowRoutes(routeOptions));\n+\n // =============================================================================\n // HIGH-011: API Versioning\n // Mount versioned routes under /api/v1 prefix\n@@ -849,7 +881,7 @@ async function startServer() {\n     if (process.env.REDIS_URL || process.env.UPSTASH_REDIS_URL) {\n       if (process.env.REPLICATE_API_TOKEN) {\n         try {\n-          createMusicWorker();\n+          musicWorkerInstance = createMusicWorker();\n           console.log('[SPLICE] ✅ Music generation worker started');\n         } catch (workerErr) {\n           console.error('[SPLICE] ⚠️ Failed to start music worker:', workerErr.message);\n@@ -896,8 +928,10 @@ async function gracefulShutdown(signal) {\n \n   // Shutdown music worker (allows in-progress jobs to complete)\n   try {\n-    await shutdownWorker();\n-    console.log('[SPLICE] Music worker shut down');\n+    if (musicWorkerInstance) {\n+      await shutdownWorker(musicWorkerInstance);\n+      console.log('[SPLICE] Music worker shut down');\n+    }\n   } catch (err) {\n     console.error('[SPLICE] Error shutting down music worker:', err.message);\n   }","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"8ac97870-28da-4852-8567-1b720486f9f7"}
{"parentUuid":"0370e116-fa28-4934-8750-2ef4b9883914","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XTBs4uEKWiGYZuCPkbdfTu","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the music-related changes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1870,"cache_read_input_tokens":45310,"cache_creation":{"ephemeral_5m_input_tokens":1870,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX48jTXncK634A145RG4P","type":"assistant","uuid":"5d8a4307-8017-407a-babd-058bac295669","timestamp":"2026-01-12T20:42:56.539Z"}
{"parentUuid":"5d8a4307-8017-407a-babd-058bac295669","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XTBs4uEKWiGYZuCPkbdfTu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CRkp7rcbqkJZ3NNqRJGszm","name":"Bash","input":{"command":"git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git diff splice-backend/routes/music.js | head -150"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1870,"cache_read_input_tokens":45310,"cache_creation":{"ephemeral_5m_input_tokens":1870,"ephemeral_1h_input_tokens":0},"output_tokens":104,"service_tier":"standard"}},"requestId":"req_011CX48jTXncK634A145RG4P","type":"assistant","uuid":"8e603648-4c82-4691-80f5-3511df73f52f","timestamp":"2026-01-12T20:42:57.321Z"}
{"parentUuid":"8e603648-4c82-4691-80f5-3511df73f52f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CRkp7rcbqkJZ3NNqRJGszm","type":"tool_result","content":"diff --git a/splice-backend/routes/music.js b/splice-backend/routes/music.js\nindex 119829d..3d6c575 100644\n--- a/splice-backend/routes/music.js\n+++ b/splice-backend/routes/music.js\n@@ -75,7 +75,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /identify - Identify song from YouTube URL\n    */\n-  router.post('/identify', requireCredits, async (req, res) => {\n+  router.post('/identify', requireCredits({ endpoint: 'music-identify' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { youtubeUrl } = req.body;\n \n     if (!youtubeUrl) {\n@@ -121,7 +124,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /generate - Start music generation job\n    */\n-  router.post('/generate', requireCredits, async (req, res) => {\n+  router.post('/generate', requireCredits({ endpoint: 'music-generate' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { youtubeUrl, prompt, duration, mood, instruments, referenceSong } = req.body;\n     const customerId = req.stripeCustomerId;\n \n@@ -170,7 +176,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /generate-variations - Generate 3 song variations for user selection\n    */\n-  router.post('/generate-variations', requireCredits, async (req, res) => {\n+  router.post('/generate-variations', requireCredits({ endpoint: 'music-generate-variations' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { prompt, duration, mood, instruments, referenceSong } = req.body;\n     const customerId = req.stripeCustomerId;\n \n@@ -229,7 +238,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /generate-scene-aware - Generate music with transcript analysis\n    */\n-  router.post('/generate-scene-aware', requireCredits, async (req, res) => {\n+  router.post('/generate-scene-aware', requireCredits({ endpoint: 'music-generate-scene-aware' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { segments, prompt, duration, mood, instruments, referenceSong } = req.body;\n     const customerId = req.stripeCustomerId;\n \n@@ -295,7 +307,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * GET /variations/status/:jobId - Get variations job status with detailed progress\n    */\n-  router.get('/variations/status/:jobId', requireCredits, async (req, res) => {\n+  router.get('/variations/status/:jobId', requireCredits({ endpoint: 'music-variations-status' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const customerId = req.stripeCustomerId;\n \n@@ -326,7 +341,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /variations/:jobId/select - Select a variation to finalize\n    */\n-  router.post('/variations/:jobId/select', requireCredits, async (req, res) => {\n+  router.post('/variations/:jobId/select', requireCredits({ endpoint: 'music-variations-select' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const { variationIndex } = req.body;\n     const customerId = req.stripeCustomerId;\n@@ -365,7 +383,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * GET /status/:jobId - Get job status\n    */\n-  router.get('/status/:jobId', requireCredits, async (req, res) => {\n+  router.get('/status/:jobId', requireCredits({ endpoint: 'music-status' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const customerId = req.stripeCustomerId;\n \n@@ -396,7 +417,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * GET /library - Get user's music library\n    */\n-  router.get('/library', requireCredits, async (req, res) => {\n+  router.get('/library', requireCredits({ endpoint: 'music-library' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const customerId = req.stripeCustomerId;\n \n     if (!customerId) {\n@@ -428,7 +452,7 @@ function createMusicRoutes(options = {}) {\n    * GET /credits - Get music credits balance\n    * IMPORTANT: Must be defined BEFORE /:jobId catch-all route\n    */\n-  router.get('/credits', requireCredits, async (req, res) => {\n+  router.get('/credits', requireCredits({ endpoint: 'music-credits' }), async (req, res) => {\n     const customerId = req.stripeCustomerId;\n \n     if (!customerId) {\n@@ -480,7 +504,7 @@ function createMusicRoutes(options = {}) {\n    * IMPORTANT: Must be defined BEFORE /:jobId catch-all route\n    * SECURITY: Restricted to admin customers only\n    */\n-  router.get('/queue-stats', requireCredits, async (req, res) => {\n+  router.get('/queue-stats', requireCredits({ endpoint: 'music-queue-stats' }), async (req, res) => {\n     // SECURITY: Check for admin access\n     // Only allow specific admin customer IDs (configured via env var)\n     const adminCustomerIds = (process.env.ADMIN_CUSTOMER_IDS || '').split(',').filter(Boolean);\n@@ -588,7 +612,10 @@ function createMusicRoutes(options = {}) {\n    * GET /:jobId - Get music with signed download URL\n    * IMPORTANT: This is a catch-all route - must be defined AFTER all specific routes\n    */\n-  router.get('/:jobId', requireCredits, async (req, res) => {\n+  router.get('/:jobId', requireCredits({ endpoint: 'music-download' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const customerId = req.stripeCustomerId;\n \n@@ -644,7 +671,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * DELETE /:jobId - Delete music from library\n    */\n-  router.delete('/:jobId', requireCredits, async (req, res) => {\n+  router.delete('/:jobId', requireCredits({ endpoint: 'music-delete' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const customerId = req.stripeCustomerId;\n \n@@ -681,7 +711,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /align - Align music to video duration with beat-matching\n    */\n-  router.post('/align', requireCredits, async (req, res) => {\n+  router.post('/align', requireCredits({ endpoint: 'music-align' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();","is_error":false}]},"uuid":"d2fec603-59ee-47fc-9f4f-8c04f4cddf16","timestamp":"2026-01-12T20:42:58.212Z","toolUseResult":{"stdout":"diff --git a/splice-backend/routes/music.js b/splice-backend/routes/music.js\nindex 119829d..3d6c575 100644\n--- a/splice-backend/routes/music.js\n+++ b/splice-backend/routes/music.js\n@@ -75,7 +75,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /identify - Identify song from YouTube URL\n    */\n-  router.post('/identify', requireCredits, async (req, res) => {\n+  router.post('/identify', requireCredits({ endpoint: 'music-identify' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { youtubeUrl } = req.body;\n \n     if (!youtubeUrl) {\n@@ -121,7 +124,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /generate - Start music generation job\n    */\n-  router.post('/generate', requireCredits, async (req, res) => {\n+  router.post('/generate', requireCredits({ endpoint: 'music-generate' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { youtubeUrl, prompt, duration, mood, instruments, referenceSong } = req.body;\n     const customerId = req.stripeCustomerId;\n \n@@ -170,7 +176,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /generate-variations - Generate 3 song variations for user selection\n    */\n-  router.post('/generate-variations', requireCredits, async (req, res) => {\n+  router.post('/generate-variations', requireCredits({ endpoint: 'music-generate-variations' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { prompt, duration, mood, instruments, referenceSong } = req.body;\n     const customerId = req.stripeCustomerId;\n \n@@ -229,7 +238,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /generate-scene-aware - Generate music with transcript analysis\n    */\n-  router.post('/generate-scene-aware', requireCredits, async (req, res) => {\n+  router.post('/generate-scene-aware', requireCredits({ endpoint: 'music-generate-scene-aware' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { segments, prompt, duration, mood, instruments, referenceSong } = req.body;\n     const customerId = req.stripeCustomerId;\n \n@@ -295,7 +307,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * GET /variations/status/:jobId - Get variations job status with detailed progress\n    */\n-  router.get('/variations/status/:jobId', requireCredits, async (req, res) => {\n+  router.get('/variations/status/:jobId', requireCredits({ endpoint: 'music-variations-status' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const customerId = req.stripeCustomerId;\n \n@@ -326,7 +341,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /variations/:jobId/select - Select a variation to finalize\n    */\n-  router.post('/variations/:jobId/select', requireCredits, async (req, res) => {\n+  router.post('/variations/:jobId/select', requireCredits({ endpoint: 'music-variations-select' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const { variationIndex } = req.body;\n     const customerId = req.stripeCustomerId;\n@@ -365,7 +383,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * GET /status/:jobId - Get job status\n    */\n-  router.get('/status/:jobId', requireCredits, async (req, res) => {\n+  router.get('/status/:jobId', requireCredits({ endpoint: 'music-status' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const customerId = req.stripeCustomerId;\n \n@@ -396,7 +417,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * GET /library - Get user's music library\n    */\n-  router.get('/library', requireCredits, async (req, res) => {\n+  router.get('/library', requireCredits({ endpoint: 'music-library' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const customerId = req.stripeCustomerId;\n \n     if (!customerId) {\n@@ -428,7 +452,7 @@ function createMusicRoutes(options = {}) {\n    * GET /credits - Get music credits balance\n    * IMPORTANT: Must be defined BEFORE /:jobId catch-all route\n    */\n-  router.get('/credits', requireCredits, async (req, res) => {\n+  router.get('/credits', requireCredits({ endpoint: 'music-credits' }), async (req, res) => {\n     const customerId = req.stripeCustomerId;\n \n     if (!customerId) {\n@@ -480,7 +504,7 @@ function createMusicRoutes(options = {}) {\n    * IMPORTANT: Must be defined BEFORE /:jobId catch-all route\n    * SECURITY: Restricted to admin customers only\n    */\n-  router.get('/queue-stats', requireCredits, async (req, res) => {\n+  router.get('/queue-stats', requireCredits({ endpoint: 'music-queue-stats' }), async (req, res) => {\n     // SECURITY: Check for admin access\n     // Only allow specific admin customer IDs (configured via env var)\n     const adminCustomerIds = (process.env.ADMIN_CUSTOMER_IDS || '').split(',').filter(Boolean);\n@@ -588,7 +612,10 @@ function createMusicRoutes(options = {}) {\n    * GET /:jobId - Get music with signed download URL\n    * IMPORTANT: This is a catch-all route - must be defined AFTER all specific routes\n    */\n-  router.get('/:jobId', requireCredits, async (req, res) => {\n+  router.get('/:jobId', requireCredits({ endpoint: 'music-download' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const customerId = req.stripeCustomerId;\n \n@@ -644,7 +671,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * DELETE /:jobId - Delete music from library\n    */\n-  router.delete('/:jobId', requireCredits, async (req, res) => {\n+  router.delete('/:jobId', requireCredits({ endpoint: 'music-delete' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();\n+\n     const { jobId } = req.params;\n     const customerId = req.stripeCustomerId;\n \n@@ -681,7 +711,10 @@ function createMusicRoutes(options = {}) {\n   /**\n    * POST /align - Align music to video duration with beat-matching\n    */\n-  router.post('/align', requireCredits, async (req, res) => {\n+  router.post('/align', requireCredits({ endpoint: 'music-align' }), async (req, res) => {\n+    // Load services on first request\n+    loadMusicServices();","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"8e603648-4c82-4691-80f5-3511df73f52f"}
{"parentUuid":"e8229a18-b6b2-4ef5-8693-164697db71f1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01ALywxMdxxAXvCSsqu3PXFf","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the services changes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":2224,"cache_read_input_tokens":47180,"cache_creation":{"ephemeral_5m_input_tokens":2224,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48jhvE9VEUV1o7hciSR","type":"assistant","uuid":"ed6ae58d-b1bc-4189-91f8-99ede53488b0","timestamp":"2026-01-12T20:42:59.911Z"}
{"parentUuid":"ed6ae58d-b1bc-4189-91f8-99ede53488b0","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01ALywxMdxxAXvCSsqu3PXFf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GqrxgZipkYJaMwySEJDDzw","name":"Bash","input":{"command":"git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git diff splice-backend/services/usageTracking.js | head -200"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":2224,"cache_read_input_tokens":47180,"cache_creation":{"ephemeral_5m_input_tokens":2224,"ephemeral_1h_input_tokens":0},"output_tokens":105,"service_tier":"standard"}},"requestId":"req_011CX48jhvE9VEUV1o7hciSR","type":"assistant","uuid":"1ef6ad60-6ce0-4303-9ed9-78abe32f8a32","timestamp":"2026-01-12T20:43:00.621Z"}
{"parentUuid":"1ef6ad60-6ce0-4303-9ed9-78abe32f8a32","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GqrxgZipkYJaMwySEJDDzw","type":"tool_result","content":"diff --git a/splice-backend/services/usageTracking.js b/splice-backend/services/usageTracking.js\nindex 868abae..7f37909 100644\n--- a/splice-backend/services/usageTracking.js\n+++ b/splice-backend/services/usageTracking.js\n@@ -30,6 +30,79 @@ const pool = new Pool({\n   query_timeout: 30000             // 30 seconds max total query time including queue\n });\n \n+// ============================================================================\n+// DEADLOCK RETRY HELPER (ERROR-HANDLING-HIGH-001)\n+// Automatically retries transactions on deadlock with exponential backoff\n+// ============================================================================\n+\n+/**\n+ * Execute a transaction with automatic deadlock retry\n+ * PostgreSQL error code 40P01 = deadlock_detected\n+ * PostgreSQL error code 40001 = serialization_failure (also retryable)\n+ *\n+ * @param {Function} transactionFn - Async function that receives client and performs transaction\n+ * @param {Object} options - Configuration options\n+ * @param {number} options.maxRetries - Maximum retry attempts (default: 3)\n+ * @param {number} options.baseDelay - Base delay in ms (default: 100)\n+ * @param {string} options.operationName - Name for logging (default: 'transaction')\n+ * @returns {Promise<any>} - Result from transactionFn\n+ */\n+async function withDeadlockRetry(transactionFn, options = {}) {\n+  const {\n+    maxRetries = 3,\n+    baseDelay = 100,\n+    operationName = 'transaction'\n+  } = options;\n+\n+  const RETRYABLE_ERRORS = ['40P01', '40001']; // deadlock_detected, serialization_failure\n+\n+  for (let attempt = 1; attempt <= maxRetries + 1; attempt++) {\n+    const client = await pool.connect();\n+\n+    try {\n+      const result = await transactionFn(client);\n+      return result;\n+    } catch (error) {\n+      // Check if error is retryable\n+      if (RETRYABLE_ERRORS.includes(error.code) && attempt <= maxRetries) {\n+        // Calculate exponential backoff with jitter\n+        const delay = baseDelay * Math.pow(2, attempt - 1) + Math.random() * 50;\n+        console.warn(\n+          `[UsageTracking] ${operationName}: Deadlock detected (attempt ${attempt}/${maxRetries + 1}), ` +\n+          `retrying in ${delay.toFixed(0)}ms...`\n+        );\n+\n+        // Ensure we rollback before retry\n+        try {\n+          await client.query('ROLLBACK');\n+        } catch (rollbackErr) {\n+          // Ignore rollback errors\n+        }\n+\n+        await new Promise(resolve => setTimeout(resolve, delay));\n+        continue;\n+      }\n+\n+      // Non-retryable error or max retries exceeded\n+      try {\n+        await client.query('ROLLBACK');\n+      } catch (rollbackErr) {\n+        // Ignore rollback errors\n+      }\n+\n+      if (RETRYABLE_ERRORS.includes(error.code)) {\n+        console.error(\n+          `[UsageTracking] ${operationName}: Deadlock persisted after ${maxRetries} retries`\n+        );\n+      }\n+\n+      throw error;\n+    } finally {\n+      client.release();\n+    }\n+  }\n+}\n+\n // Hours per tier (regular processing)\n // Pricing: Starter $15/mo, Pro $39/mo, Team $129/mo\n // Target margins: 79-82%\n@@ -1673,5 +1746,7 @@ module.exports = {\n   SCENE_AWARE_OVERAGE_RATES,\n   // Feature access\n   TIER_FEATURES,\n-  hasFeatureAccess\n+  hasFeatureAccess,\n+  // Deadlock retry helper\n+  withDeadlockRetry\n };","is_error":false}]},"uuid":"ed7cd24b-76ba-4eb8-907a-d55ec20b5bd1","timestamp":"2026-01-12T20:43:01.210Z","toolUseResult":{"stdout":"diff --git a/splice-backend/services/usageTracking.js b/splice-backend/services/usageTracking.js\nindex 868abae..7f37909 100644\n--- a/splice-backend/services/usageTracking.js\n+++ b/splice-backend/services/usageTracking.js\n@@ -30,6 +30,79 @@ const pool = new Pool({\n   query_timeout: 30000             // 30 seconds max total query time including queue\n });\n \n+// ============================================================================\n+// DEADLOCK RETRY HELPER (ERROR-HANDLING-HIGH-001)\n+// Automatically retries transactions on deadlock with exponential backoff\n+// ============================================================================\n+\n+/**\n+ * Execute a transaction with automatic deadlock retry\n+ * PostgreSQL error code 40P01 = deadlock_detected\n+ * PostgreSQL error code 40001 = serialization_failure (also retryable)\n+ *\n+ * @param {Function} transactionFn - Async function that receives client and performs transaction\n+ * @param {Object} options - Configuration options\n+ * @param {number} options.maxRetries - Maximum retry attempts (default: 3)\n+ * @param {number} options.baseDelay - Base delay in ms (default: 100)\n+ * @param {string} options.operationName - Name for logging (default: 'transaction')\n+ * @returns {Promise<any>} - Result from transactionFn\n+ */\n+async function withDeadlockRetry(transactionFn, options = {}) {\n+  const {\n+    maxRetries = 3,\n+    baseDelay = 100,\n+    operationName = 'transaction'\n+  } = options;\n+\n+  const RETRYABLE_ERRORS = ['40P01', '40001']; // deadlock_detected, serialization_failure\n+\n+  for (let attempt = 1; attempt <= maxRetries + 1; attempt++) {\n+    const client = await pool.connect();\n+\n+    try {\n+      const result = await transactionFn(client);\n+      return result;\n+    } catch (error) {\n+      // Check if error is retryable\n+      if (RETRYABLE_ERRORS.includes(error.code) && attempt <= maxRetries) {\n+        // Calculate exponential backoff with jitter\n+        const delay = baseDelay * Math.pow(2, attempt - 1) + Math.random() * 50;\n+        console.warn(\n+          `[UsageTracking] ${operationName}: Deadlock detected (attempt ${attempt}/${maxRetries + 1}), ` +\n+          `retrying in ${delay.toFixed(0)}ms...`\n+        );\n+\n+        // Ensure we rollback before retry\n+        try {\n+          await client.query('ROLLBACK');\n+        } catch (rollbackErr) {\n+          // Ignore rollback errors\n+        }\n+\n+        await new Promise(resolve => setTimeout(resolve, delay));\n+        continue;\n+      }\n+\n+      // Non-retryable error or max retries exceeded\n+      try {\n+        await client.query('ROLLBACK');\n+      } catch (rollbackErr) {\n+        // Ignore rollback errors\n+      }\n+\n+      if (RETRYABLE_ERRORS.includes(error.code)) {\n+        console.error(\n+          `[UsageTracking] ${operationName}: Deadlock persisted after ${maxRetries} retries`\n+        );\n+      }\n+\n+      throw error;\n+    } finally {\n+      client.release();\n+    }\n+  }\n+}\n+\n // Hours per tier (regular processing)\n // Pricing: Starter $15/mo, Pro $39/mo, Team $129/mo\n // Target margins: 79-82%\n@@ -1673,5 +1746,7 @@ module.exports = {\n   SCENE_AWARE_OVERAGE_RATES,\n   // Feature access\n   TIER_FEATURES,\n-  hasFeatureAccess\n+  hasFeatureAccess,\n+  // Deadlock retry helper\n+  withDeadlockRetry\n };","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"1ef6ad60-6ce0-4303-9ed9-78abe32f8a32"}
{"parentUuid":"5a756f4b-e25a-431e-8a7c-f2db8609d815","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019G4Z4F7k1rDdAeXhGD7Ynp","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check for TODO comments and look at what new files were added:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1197,"cache_read_input_tokens":49404,"cache_creation":{"ephemeral_5m_input_tokens":1197,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48jvoNojUFm48jxFgrh","type":"assistant","uuid":"ed880585-9369-46b4-ab0f-4cd829ed3a92","timestamp":"2026-01-12T20:43:02.965Z"}
{"parentUuid":"ed880585-9369-46b4-ab0f-4cd829ed3a92","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_019G4Z4F7k1rDdAeXhGD7Ynp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UXHFsXKXNJXUq4CA9w7v6q","name":"Bash","input":{"command":"git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git diff splice-backend/services/musicGeneration.js | head -150"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1197,"cache_read_input_tokens":49404,"cache_creation":{"ephemeral_5m_input_tokens":1197,"ephemeral_1h_input_tokens":0},"output_tokens":112,"service_tier":"standard"}},"requestId":"req_011CX48jvoNojUFm48jxFgrh","type":"assistant","uuid":"bf99f84e-989d-4bad-93b7-a0bc871cf6dc","timestamp":"2026-01-12T20:43:03.686Z"}
{"parentUuid":"bf99f84e-989d-4bad-93b7-a0bc871cf6dc","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UXHFsXKXNJXUq4CA9w7v6q","type":"tool_result","content":"diff --git a/splice-backend/services/musicGeneration.js b/splice-backend/services/musicGeneration.js\nindex 71df55b..c0b419c 100644\n--- a/splice-backend/services/musicGeneration.js\n+++ b/splice-backend/services/musicGeneration.js\n@@ -30,7 +30,8 @@ const DEFAULT_DURATION = 60;\n const MIN_DURATION = 30;\n const MAX_DURATION = 180;\n const POLL_INTERVAL = 5000; // 5 seconds\n-const MAX_POLL_ATTEMPTS = 120; // 10 minutes max\n+const MAX_POLL_ATTEMPTS = 120; // 10 minutes max by attempt count\n+const MAX_TOTAL_TIME_MS = 10 * 60 * 1000; // 10 minutes hard limit by wall clock\n \n // Mood presets with Mureka-compatible descriptions\n const MOOD_PRESETS = {\n@@ -264,36 +265,58 @@ async function checkTaskStatus(taskId) {\n  */\n async function pollForCompletion(taskId, onProgress = null) {\n   let attempts = 0;\n+  const startTime = Date.now();\n+  let consecutiveFailures = 0;\n \n   while (attempts < MAX_POLL_ATTEMPTS) {\n+    // Check elapsed time first (wall clock limit)\n+    const elapsed = Date.now() - startTime;\n+    if (elapsed > MAX_TOTAL_TIME_MS) {\n+      throw new Error(`Mureka generation timed out after ${Math.round(elapsed / 1000)} seconds`);\n+    }\n+\n     attempts++;\n \n-    const status = await checkTaskStatus(taskId);\n+    try {\n+      const status = await checkTaskStatus(taskId);\n+      consecutiveFailures = 0; // Reset on success\n \n-    if (onProgress) {\n-      onProgress(status.progress, status.status);\n-    }\n+      if (onProgress) {\n+        onProgress(status.progress, status.status);\n+      }\n \n-    if (status.status === 'completed') {\n-      if (!status.audioUrl) {\n-        throw new Error('Mureka completed but no audio URL provided');\n+      if (status.status === 'completed') {\n+        if (!status.audioUrl) {\n+          throw new Error('Mureka completed but no audio URL provided');\n+        }\n+        return status;\n       }\n-      return status;\n-    }\n \n-    if (status.status === 'failed') {\n-      throw new Error(status.error || 'Mureka generation failed');\n-    }\n+      if (status.status === 'failed') {\n+        throw new Error(status.error || 'Mureka generation failed');\n+      }\n \n-    if (status.status === 'cancelled') {\n-      throw new Error('Mureka generation was cancelled');\n+      if (status.status === 'cancelled') {\n+        throw new Error('Mureka generation was cancelled');\n+      }\n+    } catch (err) {\n+      // Track consecutive failures for early abort\n+      if (err.message.includes('timeout') || err.message.includes('ECONNREFUSED') || err.message.includes('ETIMEDOUT')) {\n+        consecutiveFailures++;\n+        console.warn(`[Mureka] Poll attempt ${attempts} failed: ${err.message} (${consecutiveFailures} consecutive failures)`);\n+        if (consecutiveFailures >= 3) {\n+          throw new Error('Mureka API unavailable - aborting after 3 consecutive failures');\n+        }\n+      } else {\n+        throw err; // Re-throw non-transient errors\n+      }\n     }\n \n     // Wait before polling again\n     await new Promise(resolve => setTimeout(resolve, POLL_INTERVAL));\n   }\n \n-  throw new Error('Mureka generation timed out after 10 minutes');\n+  throw new Error('Mureka generation timed out after maximum poll attempts');\n }\n \n /**","is_error":false}]},"uuid":"c916c79f-3d19-4b16-a642-55f0f0f24398","timestamp":"2026-01-12T20:43:04.443Z","toolUseResult":{"stdout":"diff --git a/splice-backend/services/musicGeneration.js b/splice-backend/services/musicGeneration.js\nindex 71df55b..c0b419c 100644\n--- a/splice-backend/services/musicGeneration.js\n+++ b/splice-backend/services/musicGeneration.js\n@@ -30,7 +30,8 @@ const DEFAULT_DURATION = 60;\n const MIN_DURATION = 30;\n const MAX_DURATION = 180;\n const POLL_INTERVAL = 5000; // 5 seconds\n-const MAX_POLL_ATTEMPTS = 120; // 10 minutes max\n+const MAX_POLL_ATTEMPTS = 120; // 10 minutes max by attempt count\n+const MAX_TOTAL_TIME_MS = 10 * 60 * 1000; // 10 minutes hard limit by wall clock\n \n // Mood presets with Mureka-compatible descriptions\n const MOOD_PRESETS = {\n@@ -264,36 +265,58 @@ async function checkTaskStatus(taskId) {\n  */\n async function pollForCompletion(taskId, onProgress = null) {\n   let attempts = 0;\n+  const startTime = Date.now();\n+  let consecutiveFailures = 0;\n \n   while (attempts < MAX_POLL_ATTEMPTS) {\n+    // Check elapsed time first (wall clock limit)\n+    const elapsed = Date.now() - startTime;\n+    if (elapsed > MAX_TOTAL_TIME_MS) {\n+      throw new Error(`Mureka generation timed out after ${Math.round(elapsed / 1000)} seconds`);\n+    }\n+\n     attempts++;\n \n-    const status = await checkTaskStatus(taskId);\n+    try {\n+      const status = await checkTaskStatus(taskId);\n+      consecutiveFailures = 0; // Reset on success\n \n-    if (onProgress) {\n-      onProgress(status.progress, status.status);\n-    }\n+      if (onProgress) {\n+        onProgress(status.progress, status.status);\n+      }\n \n-    if (status.status === 'completed') {\n-      if (!status.audioUrl) {\n-        throw new Error('Mureka completed but no audio URL provided');\n+      if (status.status === 'completed') {\n+        if (!status.audioUrl) {\n+          throw new Error('Mureka completed but no audio URL provided');\n+        }\n+        return status;\n       }\n-      return status;\n-    }\n \n-    if (status.status === 'failed') {\n-      throw new Error(status.error || 'Mureka generation failed');\n-    }\n+      if (status.status === 'failed') {\n+        throw new Error(status.error || 'Mureka generation failed');\n+      }\n \n-    if (status.status === 'cancelled') {\n-      throw new Error('Mureka generation was cancelled');\n+      if (status.status === 'cancelled') {\n+        throw new Error('Mureka generation was cancelled');\n+      }\n+    } catch (err) {\n+      // Track consecutive failures for early abort\n+      if (err.message.includes('timeout') || err.message.includes('ECONNREFUSED') || err.message.includes('ETIMEDOUT')) {\n+        consecutiveFailures++;\n+        console.warn(`[Mureka] Poll attempt ${attempts} failed: ${err.message} (${consecutiveFailures} consecutive failures)`);\n+        if (consecutiveFailures >= 3) {\n+          throw new Error('Mureka API unavailable - aborting after 3 consecutive failures');\n+        }\n+      } else {\n+        throw err; // Re-throw non-transient errors\n+      }\n     }\n \n     // Wait before polling again\n     await new Promise(resolve => setTimeout(resolve, POLL_INTERVAL));\n   }\n \n-  throw new Error('Mureka generation timed out after 10 minutes');\n+  throw new Error('Mureka generation timed out after maximum poll attempts');\n }\n \n /**","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"bf99f84e-989d-4bad-93b7-a0bc871cf6dc"}
{"parentUuid":"c5251377-11ac-40e0-a6c9-bca7adc53132","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01YXboRKV5bjg8KwYprCRkU5","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check for any new routes or migrations:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1288,"cache_read_input_tokens":50601,"cache_creation":{"ephemeral_5m_input_tokens":1288,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CX48kAfJkAZpNhWmocBpb","type":"assistant","uuid":"e169e0f1-2fe5-4be9-9ad2-ad8a5ffaf899","timestamp":"2026-01-12T20:43:06.128Z"}
{"parentUuid":"e169e0f1-2fe5-4be9-9ad2-ad8a5ffaf899","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01YXboRKV5bjg8KwYprCRkU5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XXEHUCjh4FrQUJz1CWpobW","name":"Bash","input":{"command":"find /Users/imorgado/SPLICE/splice-backend -type f -name \"*.js\" -o -name \"*.sql\" | xargs git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git status --short | grep splice-backend"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1288,"cache_read_input_tokens":50601,"cache_creation":{"ephemeral_5m_input_tokens":1288,"ephemeral_1h_input_tokens":0},"output_tokens":133,"service_tier":"standard"}},"requestId":"req_011CX48kAfJkAZpNhWmocBpb","type":"assistant","uuid":"124702b0-646f-4b44-b183-ed508acd479a","timestamp":"2026-01-12T20:43:06.931Z"}
{"parentUuid":"124702b0-646f-4b44-b183-ed508acd479a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XXEHUCjh4FrQUJz1CWpobW","type":"tool_result","content":" M splice-backend/middleware/auth.js\n M splice-backend/middleware/inputValidation.js\n M splice-backend/middleware/rateLimiter.js\n M splice-backend/server.js\n?? splice-backend/migrations/001_create_workflows.sql\n M splice-backend/routes/music.js\n M splice-backend/services/musicGeneration.js\n M splice-backend/services/usageTracking.js\n M splice-backend/workers/musicWorker.js\n?? splice-backend/routes/workflows.js\n?? splice-backend/routes/zoomPro.js\n?? splice-backend/scripts/create-test-users.js\n?? splice-backend/scripts/run-migration.js\n?? splice-backend/scripts/verify-test-users.js\n?? splice-backend/services/faceDetectionPro.js\n?? splice-backend/services/workflowExecutor.js","is_error":false}]},"uuid":"fe440ec2-08e6-4c4d-8db4-4a29ae3137f6","timestamp":"2026-01-12T20:43:08.144Z","toolUseResult":{"stdout":" M splice-backend/middleware/auth.js\n M splice-backend/middleware/inputValidation.js\n M splice-backend/middleware/rateLimiter.js\n M splice-backend/server.js\n?? splice-backend/migrations/001_create_workflows.sql\n M splice-backend/routes/music.js\n M splice-backend/services/musicGeneration.js\n M splice-backend/services/usageTracking.js\n M splice-backend/workers/musicWorker.js\n?? splice-backend/routes/workflows.js\n?? splice-backend/routes/zoomPro.js\n?? splice-backend/scripts/create-test-users.js\n?? splice-backend/scripts/run-migration.js\n?? splice-backend/scripts/verify-test-users.js\n?? splice-backend/services/faceDetectionPro.js\n?? splice-backend/services/workflowExecutor.js","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"124702b0-646f-4b44-b183-ed508acd479a"}
{"parentUuid":"5b1bb384-1969-4d65-a14f-8012efc57552","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011PrgwPkt2d6625XfdQLxKV","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check for TODO comments in the modified files:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":406,"cache_read_input_tokens":51889,"cache_creation":{"ephemeral_5m_input_tokens":406,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48kSb1qRHHDfnNVjkwA","type":"assistant","uuid":"d00f9242-330b-41ef-9ff5-cec1d92c0210","timestamp":"2026-01-12T20:43:09.772Z"}
{"parentUuid":"d00f9242-330b-41ef-9ff5-cec1d92c0210","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011PrgwPkt2d6625XfdQLxKV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Q2u5FawFGj1okTtmRAdsrd","name":"Bash","input":{"command":"grep -rn \"TODO\\|FIXME\\|WIP\\|XXX\\|HACK\" /Users/imorgado/SPLICE/splice-backend --include=\"*.js\" | head -50"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":406,"cache_read_input_tokens":51889,"cache_creation":{"ephemeral_5m_input_tokens":406,"ephemeral_1h_input_tokens":0},"output_tokens":111,"service_tier":"standard"}},"requestId":"req_011CX48kSb1qRHHDfnNVjkwA","type":"assistant","uuid":"603216bd-a501-4f83-b60d-57b1d9291a2b","timestamp":"2026-01-12T20:43:10.218Z"}
{"parentUuid":"603216bd-a501-4f83-b60d-57b1d9291a2b","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Q2u5FawFGj1okTtmRAdsrd","type":"tool_result","content":"<persisted-output>\nOutput too large (100.5KB). Full output saved to: /Users/imorgado/.claude/projects/-Users-imorgado-SPLICE/8ed1bd1d-99da-4880-9c1b-15fe12d3626d/tool-results/toolu_01Q2u5FawFGj1okTtmRAdsrd.txt\n\nPreview (first 2KB):\n/Users/imorgado/SPLICE/splice-backend/middleware/auth.js:634:  // For license keys (SPLICE-XXXX-XXXX-XXXX-XXXX format)\n/Users/imorgado/SPLICE/splice-backend/node_modules/callsites/index.js:12:// TODO: Remove this for the next major release\n/Users/imorgado/SPLICE/splice-backend/node_modules/agentkeepalive/lib/agent.js:196:    // TODO: need to fix on node itself\n/Users/imorgado/SPLICE/splice-backend/node_modules/groq-sdk/core.js:52:    // TODO handle blob, arraybuffer, other content types, etc.\n/Users/imorgado/SPLICE/splice-backend/node_modules/groq-sdk/core.js:603:    // TODO add support for Cloudflare workers, etc.\n/Users/imorgado/SPLICE/splice-backend/node_modules/groq-sdk/uploads.js:83:            parts.push(chunk); // TODO, consider validating?\n/Users/imorgado/SPLICE/splice-backend/node_modules/groq-sdk/uploads.js:153:    // TODO: make nested formats configurable\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/dist/src/index.js:108:            // XXX: non-documented `http` module API :(\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/common.js:120:\t\tdebug.destroy = createDebug.destroy; // XXX Temporary. Will be removed in the next major release.\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/common.js:280:\t* XXX DO NOT USE. This is a temporary stub function.\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/common.js:281:\t* XXX It WILL be removed in the next major release.\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/browser.js:111: * TODO: add a `localStorage` variable to explicitly enable/disable colors\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/browser.js:209:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/browser.js:225:\t\t// XXX (@Qix-) should we be logging these?\n...\n</persisted-output>","is_error":false}]},"uuid":"67d646c9-2f51-4861-b5d5-3c8c7f8d3813","timestamp":"2026-01-12T20:43:11.244Z","toolUseResult":{"stdout":"/Users/imorgado/SPLICE/splice-backend/middleware/auth.js:634:  // For license keys (SPLICE-XXXX-XXXX-XXXX-XXXX format)\n/Users/imorgado/SPLICE/splice-backend/node_modules/callsites/index.js:12:// TODO: Remove this for the next major release\n/Users/imorgado/SPLICE/splice-backend/node_modules/agentkeepalive/lib/agent.js:196:    // TODO: need to fix on node itself\n/Users/imorgado/SPLICE/splice-backend/node_modules/groq-sdk/core.js:52:    // TODO handle blob, arraybuffer, other content types, etc.\n/Users/imorgado/SPLICE/splice-backend/node_modules/groq-sdk/core.js:603:    // TODO add support for Cloudflare workers, etc.\n/Users/imorgado/SPLICE/splice-backend/node_modules/groq-sdk/uploads.js:83:            parts.push(chunk); // TODO, consider validating?\n/Users/imorgado/SPLICE/splice-backend/node_modules/groq-sdk/uploads.js:153:    // TODO: make nested formats configurable\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/dist/src/index.js:108:            // XXX: non-documented `http` module API :(\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/common.js:120:\t\tdebug.destroy = createDebug.destroy; // XXX Temporary. Will be removed in the next major release.\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/common.js:280:\t* XXX DO NOT USE. This is a temporary stub function.\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/common.js:281:\t* XXX It WILL be removed in the next major release.\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/browser.js:111: * TODO: add a `localStorage` variable to explicitly enable/disable colors\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/browser.js:209:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/browser.js:225:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/agent-base/node_modules/debug/src/browser.js:254:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/eslint-scope/lib/referencer.js:59:// FIXME: Now, we don't create module environment, because the context is\n/Users/imorgado/SPLICE/splice-backend/node_modules/eslint-scope/lib/referencer.js:623:    // TODO: ExportDeclaration doesn't exist. for bc?\n/Users/imorgado/SPLICE/splice-backend/node_modules/eslint-scope/lib/referencer.js:642:        // TODO: `node.id` doesn't exist. for bc?\n/Users/imorgado/SPLICE/splice-backend/node_modules/eslint-scope/lib/scope.js:677:        // TODO(Constellation)\n/Users/imorgado/SPLICE/splice-backend/node_modules/validator/validator.min.js:23:((t,e)=>{\"object\"==typeof exports&&\"undefined\"!=typeof module?module.exports=e():\"function\"==typeof define&&define.amd?define(e):t.validator=e()})(this,function(){function f(t){if(null==t)throw new TypeError(\"Expected a string but received a \".concat(t));if(\"String\"!==t.constructor.name)throw new TypeError(\"Expected a string but received a \".concat(t.constructor.name))}function r(t){return f(t),t=Date.parse(t),isNaN(t)?null:new Date(t)}function o(t){return null==t}for(var t,n={\"en-US\":/^[A-Z]+$/i,\"az-AZ\":/^[A-VXYZÇƏĞİıÖŞÜ]+$/i,\"bg-BG\":/^[А-Я]+$/i,\"cs-CZ\":/^[A-ZÁČĎÉĚÍŇÓŘŠŤÚŮÝŽ]+$/i,\"da-DK\":/^[A-ZÆØÅ]+$/i,\"de-DE\":/^[A-ZÄÖÜß]+$/i,\"el-GR\":/^[Α-ώ]+$/i,\"es-ES\":/^[A-ZÁÉÍÑÓÚÜ]+$/i,\"fa-IR\":/^[ابپتثجچحخدذرزژسشصضطظعغفقکگلمنوهی]+$/i,\"fi-FI\":/^[A-ZÅÄÖ]+$/i,\"fr-FR\":/^[A-ZÀÂÆÇÉÈÊËÏÎÔŒÙÛÜŸ]+$/i,\"it-IT\":/^[A-ZÀÉÈÌÎÓÒÙ]+$/i,\"ja-JP\":/^[ぁ-んァ-ヶｦ-ﾟ一-龠ー・。、]+$/i,\"nb-NO\":/^[A-ZÆØÅ]+$/i,\"nl-NL\":/^[A-ZÁÉËÏÓÖÜÚ]+$/i,\"nn-NO\":/^[A-ZÆØÅ]+$/i,\"hu-HU\":/^[A-ZÁÉÍÓÖŐÚÜŰ]+$/i,\"pl-PL\":/^[A-ZĄĆĘŚŁŃÓŻŹ]+$/i,\"pt-PT\":/^[A-ZÃÁÀÂÄÇÉÊËÍÏÕÓÔÖÚÜ]+$/i,\"ru-RU\":/^[А-ЯЁ]+$/i,\"kk-KZ\":/^[А-ЯЁ\\u04D8\\u04B0\\u0406\\u04A2\\u0492\\u04AE\\u049A\\u04E8\\u04BA]+$/i,\"sl-SI\":/^[A-ZČĆĐŠŽ]+$/i,\"sk-SK\":/^[A-ZÁČĎÉÍŇÓŠŤÚÝŽĹŔĽÄÔ]+$/i,\"sr-RS@latin\":/^[A-ZČĆŽŠĐ]+$/i,\"sr-RS\":/^[А-ЯЂЈЉЊЋЏ]+$/i,\"sv-SE\":/^[A-ZÅÄÖ]+$/i,\"th-TH\":/^[ก-๐\\s]+$/i,\"tr-TR\":/^[A-ZÇĞİıÖŞÜ]+$/i,\"uk-UA\":/^[А-ЩЬЮЯЄIЇҐі]+$/i,\"vi-VN\":/^[A-ZÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴĐÈÉẸẺẼÊỀẾỆỂỄÌÍỊỈĨÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠÙÚỤỦŨƯỪỨỰỬỮỲÝỴỶỸ]+$/i,\"ko-KR\":/^[ㄱ-ㅎㅏ-ㅣ가-힣]*$/,\"ku-IQ\":/^[ئابپتجچحخدرڕزژسشعغفڤقکگلڵمنوۆھەیێيطؤثآإأكضصةظذ]+$/i,ar:/^[ءآأؤإئابةتثجحخدذرزسشصضطظعغفقكلمنهوىيًٌٍَُِّْٰ]+$/,he:/^[א-ת]+$/,fa:/^['آاءأؤئبپتثجچحخدذرزژسشصضطظعغفقکگلمنوهةی']+$/i,bn:/^['ঀঁংঃঅআইঈউঊঋঌএঐওঔকখগঘঙচছজঝঞটঠডঢণতথদধনপফবভমযরলশষসহ়ঽািীুূৃৄেৈোৌ্ৎৗড়ঢ়য়ৠৡৢৣৰৱ৲৳৴৵৶৷৸৹৺৻']+$/,eo:/^[ABCĈD-GĜHĤIJĴK-PRSŜTUŬVZ]+$/i,\"hi-IN\":/^[\\u0900-\\u0961]+[\\u0972-\\u097F]*$/i,\"si-LK\":/^[\\u0D80-\\u0DFF]+$/,\"ta-IN\":/^[\\u0B80-\\u0BFF]+$/i,\"te-IN\":/^[\\u0C00-\\u0C7F]+$/i,\"kn-IN\":/^[\\u0C80-\\u0CFF]+$/i,\"ml-IN\":/^[\\u0D00-\\u0D7F]+$/i,\"gu-IN\":/^[\\u0A80-\\u0AFF]+$/i,\"pa-IN\":/^[\\u0A00-\\u0A7F]+$/i,\"or-IN\":/^[\\u0B00-\\u0B7F]+$/i},a={\"en-US\":/^[0-9A-Z]+$/i,\"az-AZ\":/^[0-9A-VXYZÇƏĞİıÖŞÜ]+$/i,\"bg-BG\":/^[0-9А-Я]+$/i,\"cs-CZ\":/^[0-9A-ZÁČĎÉĚÍŇÓŘŠŤÚŮÝŽ]+$/i,\"da-DK\":/^[0-9A-ZÆØÅ]+$/i,\"de-DE\":/^[0-9A-ZÄÖÜß]+$/i,\"el-GR\":/^[0-9Α-ω]+$/i,\"es-ES\":/^[0-9A-ZÁÉÍÑÓÚÜ]+$/i,\"fi-FI\":/^[0-9A-ZÅÄÖ]+$/i,\"fr-FR\":/^[0-9A-ZÀÂÆÇÉÈÊËÏÎÔŒÙÛÜŸ]+$/i,\"it-IT\":/^[0-9A-ZÀÉÈÌÎÓÒÙ]+$/i,\"ja-JP\":/^[0-9０-９ぁ-んァ-ヶｦ-ﾟ一-龠ー・。、]+$/i,\"hu-HU\":/^[0-9A-ZÁÉÍÓÖŐÚÜŰ]+$/i,\"nb-NO\":/^[0-9A-ZÆØÅ]+$/i,\"nl-NL\":/^[0-9A-ZÁÉËÏÓÖÜÚ]+$/i,\"nn-NO\":/^[0-9A-ZÆØÅ]+$/i,\"pl-PL\":/^[0-9A-ZĄĆĘŚŁŃÓŻŹ]+$/i,\"pt-PT\":/^[0-9A-ZÃÁÀÂÄÇÉÊËÍÏÕÓÔÖÚÜ]+$/i,\"ru-RU\":/^[0-9А-ЯЁ]+$/i,\"kk-KZ\":/^[0-9А-ЯЁ\\u04D8\\u04B0\\u0406\\u04A2\\u0492\\u04AE\\u049A\\u04E8\\u04BA]+$/i,\"sl-SI\":/^[0-9A-ZČĆĐŠŽ]+$/i,\"sk-SK\":/^[0-9A-ZÁČĎÉÍŇÓŠŤÚÝŽĹŔĽÄÔ]+$/i,\"sr-RS@latin\":/^[0-9A-ZČĆŽŠĐ]+$/i,\"sr-RS\":/^[0-9А-ЯЂЈЉЊЋЏ]+$/i,\"sv-SE\":/^[0-9A-ZÅÄÖ]+$/i,\"th-TH\":/^[ก-๙\\s]+$/i,\"tr-TR\":/^[0-9A-ZÇĞİıÖŞÜ]+$/i,\"uk-UA\":/^[0-9А-ЩЬЮЯЄIЇҐі]+$/i,\"ko-KR\":/^[0-9ㄱ-ㅎㅏ-ㅣ가-힣]*$/,\"ku-IQ\":/^[٠١٢٣٤٥٦٧٨٩0-9ئابپتجچحخدرڕزژسشعغفڤقکگلڵمنوۆھەیێيطؤثآإأكضصةظذ]+$/i,\"vi-VN\":/^[0-9A-ZÀÁẠẢÃÂẦẤẬẨẪĂẰẮẶẲẴĐÈÉẸẺẼÊỀẾỆỂỄÌÍỊỈĨÒÓỌỎÕÔỒỐỘỔỖƠỜỚỢỞỠÙÚỤỦŨƯỪỨỰỬỮỲÝỴỶỸ]+$/i,ar:/^[٠١٢٣٤٥٦٧٨٩0-9ءآأؤإئابةتثجحخدذرزسشصضطظعغفقكلمنهوىيًٌٍَُِّْٰ]+$/,he:/^[0-9א-ת]+$/,fa:/^['0-9آاءأؤئبپتثجچحخدذرزژسشصضطظعغفقکگلمنوهةی۱۲۳۴۵۶۷۸۹۰']+$/i,bn:/^['ঀঁংঃঅআইঈউঊঋঌএঐওঔকখগঘঙচছজঝঞটঠডঢণতথদধনপফবভমযরলশষসহ়ঽািীুূৃৄেৈোৌ্ৎৗড়ঢ়য়ৠৡৢৣ০১২৩৪৫৬৭৮৯ৰৱ৲৳৴৵৶৷৸৹৺৻']+$/,eo:/^[0-9ABCĈD-GĜHĤIJĴK-PRSŜTUŬVZ]+$/i,\"hi-IN\":/^[\\u0900-\\u0963]+[\\u0966-\\u097F]*$/i,\"si-LK\":/^[0-9\\u0D80-\\u0DFF]+$/,\"ta-IN\":/^[0-9\\u0B80-\\u0BFF.]+$/i,\"te-IN\":/^[0-9\\u0C00-\\u0C7F.]+$/i,\"kn-IN\":/^[0-9\\u0C80-\\u0CFF.]+$/i,\"ml-IN\":/^[0-9\\u0D00-\\u0D7F.]+$/i,\"gu-IN\":/^[0-9\\u0A80-\\u0AFF.]+$/i,\"pa-IN\":/^[0-9\\u0A00-\\u0A7F.]+$/i,\"or-IN\":/^[0-9\\u0B00-\\u0B7F.]+$/i},i={\"en-US\":\".\",ar:\"٫\"},P=[\"AU\",\"GB\",\"HK\",\"IN\",\"NZ\",\"ZA\",\"ZM\"],e=0;e<P.length;e++)t=\"en-\".concat(P[e]),n[t]=n[\"en-US\"],a[t]=a[\"en-US\"],i[t]=i[\"en-US\"];for(var s,H=[\"AE\",\"BH\",\"DZ\",\"EG\",\"IQ\",\"JO\",\"KW\",\"LB\",\"LY\",\"MA\",\"QM\",\"QA\",\"SA\",\"SD\",\"SY\",\"TN\",\"YE\"],_=0;_<H.length;_++)s=\"ar-\".concat(H[_]),n[s]=n.ar,a[s]=a.ar,i[s]=i.ar;for(var U,w=[\"IR\",\"AF\"],K=0;K<w.length;K++)U=\"fa-\".concat(w[K]),a[U]=a.fa,i[U]=i.ar;for(var c,y=[\"BD\",\"IN\"],x=0;x<y.length;x++)c=\"bn-\".concat(y[x]),n[c]=n.bn,a[c]=a.bn,i[c]=i[\"en-US\"];for(var W=[\"ar-EG\",\"ar-LB\",\"ar-LY\"],k=[\"bg-BG\",\"cs-CZ\",\"da-DK\",\"de-DE\",\"el-GR\",\"en-ZM\",\"eo\",\"es-ES\",\"fr-CA\",\"fr-FR\",\"gu-IN\",\"hi-IN\",\"hu-HU\",\"id-ID\",\"it-IT\",\"kk-KZ\",\"kn-IN\",\"ku-IQ\",\"ml-IN\",\"nb-NO\",\"nl-NL\",\"nn-NO\",\"or-IN\",\"pa-IN\",\"pl-PL\",\"pt-PT\",\"ru-RU\",\"si-LK\",\"sl-SI\",\"sr-RS\",\"sr-RS@latin\",\"sv-SE\",\"ta-IN\",\"te-IN\",\"tr-TR\",\"uk-UA\",\"vi-VN\"],Y=0;Y<W.length;Y++)i[W[Y]]=i[\"en-US\"];for(var V=0;V<k.length;V++)i[k[V]]=\",\";function z(t,e){f(t),e=e||{};var r,n=new RegExp(\"^(?:[-+])?(?:[0-9]+)?(?:\\\\\".concat(e.locale?i[e.locale]:\".\",\"[0-9]*)?(?:[eE][\\\\+\\\\-]?(?:[0-9]+))?$\"));return\"\"!==t&&\".\"!==t&&\",\"!==t&&\"-\"!==t&&\"+\"!==t&&(r=parseFloat(t.replace(\",\",\".\")),n.test(t))&&(!e.hasOwnProperty(\"min\")||o(e.min)||r>=e.min)&&(!e.hasOwnProperty(\"max\")||o(e.max)||r<=e.max)&&(!e.hasOwnProperty(\"lt\")||o(e.lt)||r<e.lt)&&(!e.hasOwnProperty(\"gt\")||o(e.gt)||r>e.gt)}n[\"fr-CA\"]=n[\"fr-FR\"],a[\"fr-CA\"]=a[\"fr-FR\"],n[\"pt-BR\"]=n[\"pt-PT\"],a[\"pt-BR\"]=a[\"pt-PT\"],i[\"pt-BR\"]=i[\"pt-PT\"],n[\"pl-Pl\"]=n[\"pl-PL\"],a[\"pl-Pl\"]=a[\"pl-PL\"],i[\"pl-Pl\"]=i[\"pl-PL\"],n[\"fa-AF\"]=n.fa;var Q=Object.keys(i);function j(t){return z(t)?parseFloat(t):NaN}function J(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function X(t,e){var r,n,a,i,o=\"undefined\"!=typeof Symbol&&t[Symbol.iterator]||t[\"@@iterator\"];if(o)return a=!(n=!0),{s:function(){o=o.call(t)},n:function(){var t=o.next();return n=t.done,t},e:function(t){a=!0,r=t},f:function(){try{n||null==o.return||o.return()}finally{if(a)throw r}}};if(Array.isArray(t)||(o=tt(t))||e&&t&&\"number\"==typeof t.length)return o&&(t=o),i=0,{s:e=function(){},n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:e};throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\")}function A(t,e){return(t=>{if(Array.isArray(t))return t})(t)||((t,e)=>{var r=null==t?null:\"undefined\"!=typeof Symbol&&t[Symbol.iterator]||t[\"@@iterator\"];if(null!=r){var n,a,i,o,s=[],c=!0,u=!1;try{if(i=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=i.call(r)).done)&&(s.push(n.value),s.length!==e);c=!0);}catch(t){u=!0,a=t}finally{try{if(!c&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(u)throw a}}return s}})(t,e)||tt(t,e)||(()=>{throw new TypeError(\"Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\")})()}function q(t){return(t=>{if(Array.isArray(t))return J(t)})(t)||(t=>{if(\"undefined\"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t[\"@@iterator\"])return Array.from(t)})(t)||tt(t)||(()=>{throw new TypeError(\"Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\")})()}function u(t){return(u=\"function\"==typeof Symbol&&\"symbol\"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&\"function\"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?\"symbol\":typeof t})(t)}function tt(t,e){var r;if(t)return\"string\"==typeof t?J(t,e):\"Map\"===(r=\"Object\"===(r={}.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:r)||\"Set\"===r?Array.from(t):\"Arguments\"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?J(t,e):void 0}function et(t){return\"object\"===u(t)&&null!==t?t=\"function\"==typeof t.toString?t.toString():\"[object Object]\":(null==t||isNaN(t)&&!t.length)&&(t=\"\"),String(t)}function $(t,e){var r,n=0<arguments.length&&void 0!==t?t:{},a=1<arguments.length?e:void 0;for(r in a)void 0===n[r]&&(n[r]=a[r]);return n}var rt={ignoreCase:!1,minOccurrences:1};function p(t,e){for(var r=0;r<e.length;r++){var n=e[r];if(t===n||\"[object RegExp]\"===Object.prototype.toString.call(n)&&n.test(t))return!0}return!1}function l(t,e){f(t),e=\"object\"===u(e)?(r=e.min||0,e.max):(r=e,arguments[2]);var r,t=encodeURI(t).split(/%..|./).length-1;return r<=t&&(void 0===e||t<=e)}var nt={require_tld:!0,allow_underscores:!1,allow_trailing_dot:!1,allow_numeric_tld:!1,allow_wildcard:!1,ignore_max_length:!1};function at(t,e){f(t),(e=$(e,nt)).allow_trailing_dot&&\".\"===t[t.length-1]&&(t=t.substring(0,t.length-1));var t=(t=!0===e.allow_wildcard&&0===t.indexOf(\"*.\")?t.substring(2):t).split(\".\"),r=t[t.length-1];if(e.require_tld){if(t.length<2)return!1;if(!e.allow_numeric_tld&&!/^([a-z\\u00A1-\\u00A8\\u00AA-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]{2,}|xn[a-z0-9-]{2,})$/i.test(r))return!1;if(/\\s/.test(r))return!1}return!(!e.allow_numeric_tld&&/^\\d+$/.test(r))&&t.every(function(t){return!(63<t.length&&!e.ignore_max_length||!/^[a-z_\\u00a1-\\uffff0-9-]+$/i.test(t)||/[\\uff01-\\uff5e]/.test(t)||/^-|-$/.test(t)||!e.allow_underscores&&/_/.test(t))})}var d=\"(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\",d=\"(\".concat(d,\"[.]){3}\").concat(d),it=new RegExp(\"^\".concat(d,\"$\")),h=\"(?:[0-9a-fA-F]{1,4})\",ot=new RegExp(\"^(\"+\"(?:\".concat(h,\":){7}(?:\").concat(h,\"|:)|\")+\"(?:\".concat(h,\":){6}(?:\").concat(d,\"|:\").concat(h,\"|:)|\")+\"(?:\".concat(h,\":){5}(?::\").concat(d,\"|(:\").concat(h,\"){1,2}|:)|\")+\"(?:\".concat(h,\":){4}(?:(:\").concat(h,\"){0,1}:\").concat(d,\"|(:\").concat(h,\"){1,3}|:)|\")+\"(?:\".concat(h,\":){3}(?:(:\").concat(h,\"){0,2}:\").concat(d,\"|(:\").concat(h,\"){1,4}|:)|\")+\"(?:\".concat(h,\":){2}(?:(:\").concat(h,\"){0,3}:\").concat(d,\"|(:\").concat(h,\"){1,5}|:)|\")+\"(?:\".concat(h,\":){1}(?:(:\").concat(h,\"){0,4}:\").concat(d,\"|(:\").concat(h,\"){1,6}|:)|\")+\"(?::((?::\".concat(h,\"){0,5}:\").concat(d,\"|(?::\").concat(h,\"){1,7}|:))\")+\")(%[0-9a-zA-Z.]{1,})?$\");function g(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},e=(f(t),(\"object\"===u(e)?e.version:arguments[1])||\"\");return e?\"4\"===e.toString()?it.test(t):\"6\"===e.toString()&&ot.test(t):g(t,{version:4})||g(t,{version:6})}var st={allow_display_name:!1,allow_underscores:!1,require_display_name:!1,allow_utf8_local_part:!0,require_tld:!0,blacklisted_chars:\"\",ignore_max_length:!1,host_blacklist:[],host_whitelist:[]},ct=/^([^\\x00-\\x1F\\x7F-\\x9F\\cX]+)</i,ut=/^[a-z\\d!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]+$/i,lt=/^[a-z\\d]+$/,dt=/^([\\s\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f\\x21\\x23-\\x5b\\x5d-\\x7e]|(\\\\[\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]))*$/i,ft=/^[a-z\\d!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~\\u00A1-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]+$/i,At=/^([\\s\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f\\x21\\x23-\\x5b\\x5d-\\x7e\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]|(\\\\[\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]))*$/i;function $t(t,e){if(f(t),(e=$(e,st)).require_display_name||e.allow_display_name){var r=t.match(ct);if(r){r=r[1];if(t=t.replace(r,\"\").replace(/(^<|>$)/g,\"\"),!(t=>{var e=t.replace(/^\"(.+)\"$/,\"$1\");if(e.trim()){if(/[\\.\";<>]/.test(e)){if(e===t)return;if(!(e.split('\"').length===e.split('\\\\\"').length))return}return 1}})(r=r.endsWith(\" \")?r.slice(0,-1):r))return!1}else if(e.require_display_name)return!1}if(!e.ignore_max_length&&254<t.length)return!1;var r=t.split(\"@\"),t=r.pop(),n=t.toLowerCase();if(0<e.host_blacklist.length&&p(n,e.host_blacklist))return!1;if(0<e.host_whitelist.length&&!p(n,e.host_whitelist))return!1;r=r.join(\"@\");if(e.domain_specific_validation&&(\"gmail.com\"===n||\"googlemail.com\"===n)){n=(r=r.toLowerCase()).split(\"+\")[0];if(!l(n.replace(/\\./g,\"\"),{min:6,max:30}))return!1;for(var a=n.split(\".\"),i=0;i<a.length;i++)if(!lt.test(a[i]))return!1}if(!(!1!==e.ignore_max_length||l(r,{max:64})&&l(t,{max:254})))return!1;if(!at(t,{require_tld:e.require_tld,ignore_max_length:e.ignore_max_length,allow_underscores:e.allow_underscores})){if(!e.allow_ip_domain)return!1;if(!g(t)){if(!t.startsWith(\"[\")||!t.endsWith(\"]\"))return!1;n=t.slice(1,-1);if(0===n.length||!g(n))return!1}}if(e.blacklisted_chars&&-1!==r.search(new RegExp(\"[\".concat(e.blacklisted_chars,\"]+\"),\"g\")))return!1;if('\"'===r[0]&&'\"'===r[r.length-1])return r=r.slice(1,r.length-1),(e.allow_utf8_local_part?At:dt).test(r);for(var o=e.allow_utf8_local_part?ft:ut,s=r.split(\".\"),c=0;c<s.length;c++)if(!o.test(s[c]))return!1;return!0}function S(t,e){return-1!==t.indexOf(e)}var pt={protocols:[\"http\",\"https\",\"ftp\"],require_tld:!0,require_protocol:!1,require_host:!0,require_port:!1,require_valid_protocol:!0,allow_underscores:!1,allow_trailing_dot:!1,allow_protocol_relative_urls:!1,allow_fragments:!0,allow_query_components:!0,validate_length:!0,max_allowed_length:2084},ht=/^\\[([^\\]]+)\\](?::([0-9]+))?$/;var gt=/^(?:[0-9a-fA-F]{2}([-:\\s]))([0-9a-fA-F]{2}\\1){4}([0-9a-fA-F]{2})$/,St=/^([0-9a-fA-F]){12}$/,mt=/^([0-9a-fA-F]{4}\\.){2}([0-9a-fA-F]{4})$/,Zt=/^(?:[0-9a-fA-F]{2}([-:\\s]))([0-9a-fA-F]{2}\\1){6}([0-9a-fA-F]{2})$/,Et=/^([0-9a-fA-F]){16}$/,It=/^([0-9a-fA-F]{4}\\.){3}([0-9a-fA-F]{4})$/;var Rt=/^\\d{1,3}$/;var vt={format:\"YYYY/MM/DD\",delimiters:[\"/\",\"-\"],strictMode:!1};function m(e,r){if(r=$(\"string\"==typeof r?{format:r}:r,vt),\"string\"==typeof e&&/(^(y{4}|y{2})[.\\/-](m{1,2})[.\\/-](d{1,2})$)|(^(m{1,2})[.\\/-](d{1,2})[.\\/-]((y{4}|y{2})$))|(^(d{1,2})[.\\/-](m{1,2})[.\\/-]((y{4}|y{2})$))/gi.test(r.format)){if(r.strictMode&&e.length!==r.format.length)return!1;var t,n=r.delimiters.find(function(t){return-1!==r.format.indexOf(t)}),a=r.strictMode?n:r.delimiters.find(function(t){return-1!==e.indexOf(t)}),i={},o=X(((t,e)=>{for(var r=[],n=Math.max(t.length,e.length),a=0;a<n;a++)r.push([t[a],e[a]]);return r})(e.split(a),r.format.toLowerCase().split(n)));try{for(o.s();!(t=o.n()).done;){var s=A(t.value,2),c=s[0],u=s[1];if(!c||!u||c.length!==u.length)return!1;i[u.charAt(0)]=c}}catch(t){o.e(t)}finally{o.f()}if((a=i.y).startsWith(\"-\"))return!1;if(2===i.y.length){n=parseInt(i.y,10);if(isNaN(n))return!1;a=(n<(new Date).getFullYear()%100?\"20\":\"19\").concat(i.y)}var n=i.m,l=(1===i.m.length&&(n=\"0\".concat(i.m)),i.d);return 1===i.d.length&&(l=\"0\".concat(i.d)),new Date(\"\".concat(a,\"-\").concat(n,\"-\").concat(l,\"T00:00:00.000Z\")).getUTCDate()===+i.d}return!r.strictMode&&\"[object Date]\"===Object.prototype.toString.call(e)&&isFinite(e)}var Lt={hourFormat:\"hour24\",mode:\"default\"},Mt={hour24:{default:/^([01]?[0-9]|2[0-3]):([0-5][0-9])$/,withSeconds:/^([01]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/,withOptionalSeconds:/^([01]?[0-9]|2[0-3]):([0-5][0-9])(?::([0-5][0-9]))?$/},hour12:{default:/^(0?[1-9]|1[0-2]):([0-5][0-9]) (A|P)M$/,withSeconds:/^(0?[1-9]|1[0-2]):([0-5][0-9]):([0-5][0-9]) (A|P)M$/,withOptionalSeconds:/^(0?[1-9]|1[0-2]):([0-5][0-9])(?::([0-5][0-9]))? (A|P)M$/}};var Z=function(t,e){return t.some(function(t){return e===t})},Bt={loose:!1},Ft=[\"true\",\"false\",\"1\",\"0\"],Nt=[].concat(Ft,[\"yes\",\"no\"]);var d=\"(([a-zA-Z]{2,3}(-\".concat(\"([A-Za-z]{3}(-[A-Za-z]{3}){0,2})\",\")?)|([a-zA-Z]{5,8}))\"),h=\"(\".concat(\"(\\\\d|[A-W]|[Y-Z]|[a-w]|[y-z])\",\"(-[A-Za-z0-9]{2,8})+)\"),Ct=\"(x(-[A-Za-z0-9]{1,8})+)\",E=\"(\".concat(\"((en-GB-oed)|(i-ami)|(i-bnn)|(i-default)|(i-enochian)|(i-hak)|(i-klingon)|(i-lux)|(i-mingo)|(i-navajo)|(i-pwn)|(i-tao)|(i-tay)|(i-tsu)|(sgn-BE-FR)|(sgn-BE-NL)|(sgn-CH-DE))\",\"|\").concat(\"((art-lojban)|(cel-gaulish)|(no-bok)|(no-nyn)|(zh-guoyu)|(zh-hakka)|(zh-min)|(zh-min-nan)|(zh-xiang))\",\")\"),I=\"(-|_)\",d=\"\".concat(d,\"(\").concat(I).concat(\"([A-Za-z]{4})\",\")?(\").concat(I).concat(\"([A-Za-z]{2}|\\\\d{3})\",\")?(\").concat(I).concat(\"([A-Za-z0-9]{5,8}|(\\\\d[A-Z-a-z0-9]{3}))\",\")*(\").concat(I).concat(h,\")*(\").concat(I).concat(Ct,\")?\"),Dt=new RegExp(\"(^\".concat(Ct,\"$)|(^\").concat(E,\"$)|(^\").concat(d,\"$)\"));var Tt=/^(?!(1[3-9])|(20)|(3[3-9])|(4[0-9])|(5[0-9])|(60)|(7[3-9])|(8[1-9])|(9[0-2])|(9[3-9]))[0-9]{9}$/;h=Object.keys(n);var I=Object.keys(a),bt=/^[0-9]+$/;var Gt={AM:/^[A-Z]{2}\\d{7}$/,AR:/^[A-Z]{3}\\d{6}$/,AT:/^[A-Z]\\d{7}$/,AU:/^[A-Z]\\d{7}$/,AZ:/^[A-Z]{1}\\d{8}$/,BE:/^[A-Z]{2}\\d{6}$/,BG:/^\\d{9}$/,BR:/^[A-Z]{2}\\d{6}$/,BY:/^[A-Z]{2}\\d{7}$/,CA:/^[A-Z]{2}\\d{6}$|^[A-Z]\\d{6}[A-Z]{2}$/,CH:/^[A-Z]\\d{7}$/,CN:/^G\\d{8}$|^E(?![IO])[A-Z0-9]\\d{7}$/,CY:/^[A-Z](\\d{6}|\\d{8})$/,CZ:/^\\d{8}$/,DE:/^[CFGHJKLMNPRTVWXYZ0-9]{9}$/,DK:/^\\d{9}$/,DZ:/^\\d{9}$/,EE:/^([A-Z]\\d{7}|[A-Z]{2}\\d{7})$/,ES:/^[A-Z0-9]{2}([A-Z0-9]?)\\d{6}$/,FI:/^[A-Z]{2}\\d{7}$/,FR:/^\\d{2}[A-Z]{2}\\d{5}$/,GB:/^\\d{9}$/,GR:/^[A-Z]{2}\\d{7}$/,HR:/^\\d{9}$/,HU:/^[A-Z]{2}(\\d{6}|\\d{7})$/,IE:/^[A-Z0-9]{2}\\d{7}$/,IN:/^[A-Z]{1}-?\\d{7}$/,ID:/^[A-C]\\d{7}$/,IR:/^[A-Z]\\d{8}$/,IS:/^(A)\\d{7}$/,IT:/^[A-Z0-9]{2}\\d{7}$/,JM:/^[Aa]\\d{7}$/,JP:/^[A-Z]{2}\\d{7}$/,KR:/^[MS]\\d{8}$/,KZ:/^[a-zA-Z]\\d{7}$/,LI:/^[a-zA-Z]\\d{5}$/,LT:/^[A-Z0-9]{8}$/,LU:/^[A-Z0-9]{8}$/,LV:/^[A-Z0-9]{2}\\d{7}$/,LY:/^[A-Z0-9]{8}$/,MT:/^\\d{7}$/,MZ:/^([A-Z]{2}\\d{7})|(\\d{2}[A-Z]{2}\\d{5})$/,MY:/^[AHK]\\d{8}$/,MX:/^\\d{10,11}$/,NL:/^[A-Z]{2}[A-Z0-9]{6}\\d$/,NZ:/^([Ll]([Aa]|[Dd]|[Ff]|[Hh])|[Ee]([Aa]|[Pp])|[Nn])\\d{6}$/,PH:/^([A-Z](\\d{6}|\\d{7}[A-Z]))|([A-Z]{2}(\\d{6}|\\d{7}))$/,PK:/^[A-Z]{2}\\d{7}$/,PL:/^[A-Z]{2}\\d{7}$/,PT:/^[A-Z]\\d{6}$/,RO:/^\\d{8,9}$/,RU:/^\\d{9}$/,SE:/^\\d{8}$/,SL:/^(P)[A-Z]\\d{7}$/,SK:/^[0-9A-Z]\\d{7}$/,TH:/^[A-Z]{1,2}\\d{6,7}$/,TR:/^[A-Z]\\d{8}$/,UA:/^[A-Z]{2}\\d{6}$/,US:/^\\d{9}$|^[A-Z]\\d{8}$/,ZA:/^[TAMD]\\d{8}$/},Ct=Object.keys(Gt);var Ot=/^(?:[-+]?(?:0|[1-9][0-9]*))$/,Pt=/^[-+]?[0-9]+$/;function Ht(t,e){f(t);var r=!1===(e=e||{}).allow_leading_zeroes?Ot:Pt,n=!e.hasOwnProperty(\"min\")||o(e.min)||t>=e.min,a=!e.hasOwnProperty(\"max\")||o(e.max)||t<=e.max,i=!e.hasOwnProperty(\"lt\")||o(e.lt)||t<e.lt,e=!e.hasOwnProperty(\"gt\")||o(e.gt)||t>e.gt;return r.test(t)&&n&&a&&i&&e}var _t=/^[0-9]{15}$/,Ut=/^\\d{2}-\\d{6}-\\d{6}-\\d{1}$/;var wt=/^[\\x00-\\x7F]+$/;var Kt=/[^\\u0020-\\u007E\\uFF61-\\uFF9F\\uFFA0-\\uFFDC\\uFFE8-\\uFFEE0-9a-zA-Z]/;var yt=/[\\u0020-\\u007E\\uFF61-\\uFF9F\\uFFA0-\\uFFDC\\uFFE8-\\uFFEE0-9a-zA-Z]/;var xt=/[^\\x00-\\x7F]/;E=\"i\",d=(d=[\"^(0|[1-9]\\\\d*)\\\\.(0|[1-9]\\\\d*)\\\\.(0|[1-9]\\\\d*)\",\"(?:-((?:0|[1-9]\\\\d*|\\\\d*[a-z-][0-9a-z-]*)(?:\\\\.(?:0|[1-9]\\\\d*|\\\\d*[a-z-][0-9a-z-]*))*))\",\"?(?:\\\\+([0-9a-z-]+(?:\\\\.[0-9a-z-]+)*))?$\"]).join(\"\");var Wt=new RegExp(d,E);var kt=/[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]/;var Yt={force_decimal:!1,decimal_digits:\"1,\",locale:\"en-US\"},Vt=[\"\",\"-\",\"+\"];var zt=/^(0x|0h)?[0-9A-F]+$/i;function Qt(t){return f(t),zt.test(t)}var jt=/^(0o)?[0-7]+$/i;var Jt=/^#?([0-9A-F]{3}|[0-9A-F]{4}|[0-9A-F]{6}|[0-9A-F]{8})$/i,Xt=/^#([0-9A-F]{3}|[0-9A-F]{4}|[0-9A-F]{6}|[0-9A-F]{8})$/i,qt={require_hashtag:!1};var te=/^rgb\\((([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5]),){2}([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\\)$/,ee=/^rgba\\((([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5]),){3}(0?\\.\\d\\d?|1(\\.0)?|0(\\.0)?)\\)$/,re=/^rgb\\((([0-9]%|[1-9][0-9]%|100%),){2}([0-9]%|[1-9][0-9]%|100%)\\)$/,ne=/^rgba\\((([0-9]%|[1-9][0-9]%|100%),){3}(0?\\.\\d\\d?|1(\\.0)?|0(\\.0)?)\\)$/,ae=/^rgba?/;var ie=/^hsla?\\(((\\+|\\-)?([0-9]+(\\.[0-9]+)?(e(\\+|\\-)?[0-9]+)?|\\.[0-9]+(e(\\+|\\-)?[0-9]+)?))(deg|grad|rad|turn)?(,(\\+|\\-)?([0-9]+(\\.[0-9]+)?(e(\\+|\\-)?[0-9]+)?|\\.[0-9]+(e(\\+|\\-)?[0-9]+)?)%){2}(,((\\+|\\-)?([0-9]+(\\.[0-9]+)?(e(\\+|\\-)?[0-9]+)?|\\.[0-9]+(e(\\+|\\-)?[0-9]+)?)%?))?\\)$/i,oe=/^hsla?\\(((\\+|\\-)?([0-9]+(\\.[0-9]+)?(e(\\+|\\-)?[0-9]+)?|\\.[0-9]+(e(\\+|\\-)?[0-9]+)?))(deg|grad|rad|turn)?(\\s(\\+|\\-)?([0-9]+(\\.[0-9]+)?(e(\\+|\\-)?[0-9]+)?|\\.[0-9]+(e(\\+|\\-)?[0-9]+)?)%){2}\\s?(\\/\\s((\\+|\\-)?([0-9]+(\\.[0-9]+)?(e(\\+|\\-)?[0-9]+)?|\\.[0-9]+(e(\\+|\\-)?[0-9]+)?)%?)\\s?)?\\)$/i;var se=/^[A-Z]{2}[0-9A-Z]{3}\\d{2}\\d{5}$/;var R={AD:/^(AD[0-9]{2})\\d{8}[A-Z0-9]{12}$/,AE:/^(AE[0-9]{2})\\d{3}\\d{16}$/,AL:/^(AL[0-9]{2})\\d{8}[A-Z0-9]{16}$/,AT:/^(AT[0-9]{2})\\d{16}$/,AZ:/^(AZ[0-9]{2})[A-Z0-9]{4}\\d{20}$/,BA:/^(BA[0-9]{2})\\d{16}$/,BE:/^(BE[0-9]{2})\\d{12}$/,BG:/^(BG[0-9]{2})[A-Z]{4}\\d{6}[A-Z0-9]{8}$/,BH:/^(BH[0-9]{2})[A-Z]{4}[A-Z0-9]{14}$/,BR:/^(BR[0-9]{2})\\d{23}[A-Z]{1}[A-Z0-9]{1}$/,BY:/^(BY[0-9]{2})[A-Z0-9]{4}\\d{20}$/,CH:/^(CH[0-9]{2})\\d{5}[A-Z0-9]{12}$/,CR:/^(CR[0-9]{2})\\d{18}$/,CY:/^(CY[0-9]{2})\\d{8}[A-Z0-9]{16}$/,CZ:/^(CZ[0-9]{2})\\d{20}$/,DE:/^(DE[0-9]{2})\\d{18}$/,DK:/^(DK[0-9]{2})\\d{14}$/,DO:/^(DO[0-9]{2})[A-Z]{4}\\d{20}$/,DZ:/^(DZ\\d{24})$/,EE:/^(EE[0-9]{2})\\d{16}$/,EG:/^(EG[0-9]{2})\\d{25}$/,ES:/^(ES[0-9]{2})\\d{20}$/,FI:/^(FI[0-9]{2})\\d{14}$/,FO:/^(FO[0-9]{2})\\d{14}$/,FR:/^(FR[0-9]{2})\\d{10}[A-Z0-9]{11}\\d{2}$/,GB:/^(GB[0-9]{2})[A-Z]{4}\\d{14}$/,GE:/^(GE[0-9]{2})[A-Z0-9]{2}\\d{16}$/,GI:/^(GI[0-9]{2})[A-Z]{4}[A-Z0-9]{15}$/,GL:/^(GL[0-9]{2})\\d{14}$/,GR:/^(GR[0-9]{2})\\d{7}[A-Z0-9]{16}$/,GT:/^(GT[0-9]{2})[A-Z0-9]{4}[A-Z0-9]{20}$/,HR:/^(HR[0-9]{2})\\d{17}$/,HU:/^(HU[0-9]{2})\\d{24}$/,IE:/^(IE[0-9]{2})[A-Z]{4}\\d{14}$/,IL:/^(IL[0-9]{2})\\d{19}$/,IQ:/^(IQ[0-9]{2})[A-Z]{4}\\d{15}$/,IR:/^(IR[0-9]{2})\\d{22}$/,IS:/^(IS[0-9]{2})\\d{22}$/,IT:/^(IT[0-9]{2})[A-Z]{1}\\d{10}[A-Z0-9]{12}$/,JO:/^(JO[0-9]{2})[A-Z]{4}\\d{22}$/,KW:/^(KW[0-9]{2})[A-Z]{4}[A-Z0-9]{22}$/,KZ:/^(KZ[0-9]{2})\\d{3}[A-Z0-9]{13}$/,LB:/^(LB[0-9]{2})\\d{4}[A-Z0-9]{20}$/,LC:/^(LC[0-9]{2})[A-Z]{4}[A-Z0-9]{24}$/,LI:/^(LI[0-9]{2})\\d{5}[A-Z0-9]{12}$/,LT:/^(LT[0-9]{2})\\d{16}$/,LU:/^(LU[0-9]{2})\\d{3}[A-Z0-9]{13}$/,LV:/^(LV[0-9]{2})[A-Z]{4}[A-Z0-9]{13}$/,MA:/^(MA[0-9]{26})$/,MC:/^(MC[0-9]{2})\\d{10}[A-Z0-9]{11}\\d{2}$/,MD:/^(MD[0-9]{2})[A-Z0-9]{20}$/,ME:/^(ME[0-9]{2})\\d{18}$/,MK:/^(MK[0-9]{2})\\d{3}[A-Z0-9]{10}\\d{2}$/,MR:/^(MR[0-9]{2})\\d{23}$/,MT:/^(MT[0-9]{2})[A-Z]{4}\\d{5}[A-Z0-9]{18}$/,MU:/^(MU[0-9]{2})[A-Z]{4}\\d{19}[A-Z]{3}$/,MZ:/^(MZ[0-9]{2})\\d{21}$/,NL:/^(NL[0-9]{2})[A-Z]{4}\\d{10}$/,NO:/^(NO[0-9]{2})\\d{11}$/,PK:/^(PK[0-9]{2})[A-Z0-9]{4}\\d{16}$/,PL:/^(PL[0-9]{2})\\d{24}$/,PS:/^(PS[0-9]{2})[A-Z]{4}[A-Z0-9]{21}$/,PT:/^(PT[0-9]{2})\\d{21}$/,QA:/^(QA[0-9]{2})[A-Z]{4}[A-Z0-9]{21}$/,RO:/^(RO[0-9]{2})[A-Z]{4}[A-Z0-9]{16}$/,RS:/^(RS[0-9]{2})\\d{18}$/,SA:/^(SA[0-9]{2})\\d{2}[A-Z0-9]{18}$/,SC:/^(SC[0-9]{2})[A-Z]{4}\\d{20}[A-Z]{3}$/,SE:/^(SE[0-9]{2})\\d{20}$/,SI:/^(SI[0-9]{2})\\d{15}$/,SK:/^(SK[0-9]{2})\\d{20}$/,SM:/^(SM[0-9]{2})[A-Z]{1}\\d{10}[A-Z0-9]{12}$/,SV:/^(SV[0-9]{2})[A-Z0-9]{4}\\d{20}$/,TL:/^(TL[0-9]{2})\\d{19}$/,TN:/^(TN[0-9]{2})\\d{20}$/,TR:/^(TR[0-9]{2})\\d{5}[A-Z0-9]{17}$/,UA:/^(UA[0-9]{2})\\d{6}[A-Z0-9]{19}$/,VA:/^(VA[0-9]{2})\\d{18}$/,VG:/^(VG[0-9]{2})[A-Z]{4}\\d{16}$/,XK:/^(XK[0-9]{2})\\d{16}$/};function ce(t,e){var t=t.replace(/[\\s\\-]+/gi,\"\").toUpperCase(),r=t.slice(0,2).toUpperCase(),n=r in R;if(e.whitelist){if(0<e.whitelist.filter(function(t){return!(t in R)}).length)return!1;if(!Z(e.whitelist,r))return!1}if(e.blacklist&&Z(e.blacklist,r))return!1;return n&&R[r].test(t)}var d=Object.keys(R),ue=new Set([\"AD\",\"AE\",\"AF\",\"AG\",\"AI\",\"AL\",\"AM\",\"AO\",\"AQ\",\"AR\",\"AS\",\"AT\",\"AU\",\"AW\",\"AX\",\"AZ\",\"BA\",\"BB\",\"BD\",\"BE\",\"BF\",\"BG\",\"BH\",\"BI\",\"BJ\",\"BL\",\"BM\",\"BN\",\"BO\",\"BQ\",\"BR\",\"BS\",\"BT\",\"BV\",\"BW\",\"BY\",\"BZ\",\"CA\",\"CC\",\"CD\",\"CF\",\"CG\",\"CH\",\"CI\",\"CK\",\"CL\",\"CM\",\"CN\",\"CO\",\"CR\",\"CU\",\"CV\",\"CW\",\"CX\",\"CY\",\"CZ\",\"DE\",\"DJ\",\"DK\",\"DM\",\"DO\",\"DZ\",\"EC\",\"EE\",\"EG\",\"EH\",\"ER\",\"ES\",\"ET\",\"FI\",\"FJ\",\"FK\",\"FM\",\"FO\",\"FR\",\"GA\",\"GB\",\"GD\",\"GE\",\"GF\",\"GG\",\"GH\",\"GI\",\"GL\",\"GM\",\"GN\",\"GP\",\"GQ\",\"GR\",\"GS\",\"GT\",\"GU\",\"GW\",\"GY\",\"HK\",\"HM\",\"HN\",\"HR\",\"HT\",\"HU\",\"ID\",\"IE\",\"IL\",\"IM\",\"IN\",\"IO\",\"IQ\",\"IR\",\"IS\",\"IT\",\"JE\",\"JM\",\"JO\",\"JP\",\"KE\",\"KG\",\"KH\",\"KI\",\"KM\",\"KN\",\"KP\",\"KR\",\"KW\",\"KY\",\"KZ\",\"LA\",\"LB\",\"LC\",\"LI\",\"LK\",\"LR\",\"LS\",\"LT\",\"LU\",\"LV\",\"LY\",\"MA\",\"MC\",\"MD\",\"ME\",\"MF\",\"MG\",\"MH\",\"MK\",\"ML\",\"MM\",\"MN\",\"MO\",\"MP\",\"MQ\",\"MR\",\"MS\",\"MT\",\"MU\",\"MV\",\"MW\",\"MX\",\"MY\",\"MZ\",\"NA\",\"NC\",\"NE\",\"NF\",\"NG\",\"NI\",\"NL\",\"NO\",\"NP\",\"NR\",\"NU\",\"NZ\",\"OM\",\"PA\",\"PE\",\"PF\",\"PG\",\"PH\",\"PK\",\"PL\",\"PM\",\"PN\",\"PR\",\"PS\",\"PT\",\"PW\",\"PY\",\"QA\",\"RE\",\"RO\",\"RS\",\"RU\",\"RW\",\"SA\",\"SB\",\"SC\",\"SD\",\"SE\",\"SG\",\"SH\",\"SI\",\"SJ\",\"SK\",\"SL\",\"SM\",\"SN\",\"SO\",\"SR\",\"SS\",\"ST\",\"SV\",\"SX\",\"SY\",\"SZ\",\"TC\",\"TD\",\"TF\",\"TG\",\"TH\",\"TJ\",\"TK\",\"TL\",\"TM\",\"TN\",\"TO\",\"TR\",\"TT\",\"TV\",\"TW\",\"TZ\",\"UA\",\"UG\",\"UM\",\"US\",\"UY\",\"UZ\",\"VA\",\"VC\",\"VE\",\"VG\",\"VI\",\"VN\",\"VU\",\"WF\",\"WS\",\"YE\",\"YT\",\"ZA\",\"ZM\",\"ZW\"]);var le=ue,de=/^[A-Za-z]{6}[A-Za-z0-9]{2}([A-Za-z0-9]{3})?$/;var fe=/^[a-f0-9]{32}$/;var Ae={md5:32,md4:32,sha1:40,sha256:64,sha384:96,sha512:128,ripemd128:32,ripemd160:40,tiger128:32,tiger160:40,tiger192:48,crc32:8,crc32b:8};var $e=/^[A-Za-z0-9+/]+={0,2}$/,pe=/^[A-Za-z0-9+/]+$/,he=/^[A-Za-z0-9_-]+={0,2}$/,ge=/^[A-Za-z0-9_-]+$/;function Se(t,e){var r,n;return f(t),e=$(e,{urlSafe:!1,padding:!(null!=(r=e)&&r.urlSafe)}),\"\"===t||!(e.padding&&t.length%4!=0||(n=e.urlSafe?e.padding?he:ge:e.padding?$e:pe,e.padding&&t.length%4!=0))&&n.test(t)}var me={allow_primitives:!1};var Ze={ignore_whitespace:!1};var Ee={1:/^[0-9A-F]{8}-[0-9A-F]{4}-1[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,2:/^[0-9A-F]{8}-[0-9A-F]{4}-2[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,3:/^[0-9A-F]{8}-[0-9A-F]{4}-3[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,4:/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,5:/^[0-9A-F]{8}-[0-9A-F]{4}-5[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,6:/^[0-9A-F]{8}-[0-9A-F]{4}-6[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,7:/^[0-9A-F]{8}-[0-9A-F]{4}-7[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,8:/^[0-9A-F]{8}-[0-9A-F]{4}-8[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,nil:/^00000000-0000-0000-0000-000000000000$/i,max:/^ffffffff-ffff-ffff-ffff-ffffffffffff$/i,loose:/^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i,all:/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i};function Ie(t){f(t);for(var e,r,n=t.replace(/[- ]+/g,\"\"),a=0,i=n.length-1;0<=i;i--)e=n.substring(i,i+1),e=parseInt(e,10),a+=r&&10<=(e*=2)?e%10+1:e,r=!r;return!(a%10!=0||!n)}var v={amex:/^3[47][0-9]{13}$/,dinersclub:/^3(?:0[0-5]|[68][0-9])[0-9]{11}$/,discover:/^6(?:011|5[0-9][0-9])[0-9]{12,15}$/,jcb:/^(?:2131|1800|35\\d{3})\\d{11}$/,mastercard:/^5[1-5][0-9]{2}|(222[1-9]|22[3-9][0-9]|2[3-6][0-9]{2}|27[01][0-9]|2720)[0-9]{12}$/,unionpay:/^(6[27][0-9]{14}|^(81[0-9]{14,17}))$/,visa:/^(?:4[0-9]{12})(?:[0-9]{3,6})?$/},Re=(()=>{var t,e=[];for(t in v)v.hasOwnProperty(t)&&e.push(v[t]);return e})();var L={PL:function(t){f(t);var n={1:1,2:3,3:7,4:9,5:1,6:3,7:7,8:9,9:1,10:3,11:0};if(null!=t&&11===t.length&&Ht(t,{allow_leading_zeroes:!0})){var e=t.split(\"\").slice(0,-1).reduce(function(t,e,r){return t+Number(e)*n[r+1]},0)%10,t=Number(t.charAt(t.length-1));if(0==e&&0===t||t===10-e)return!0}return!1},ES:function(t){f(t);var e,r={X:0,Y:1,Z:2},t=t.trim().toUpperCase();return!!/^[0-9X-Z][0-9]{7}[TRWAGMYFPDXBNJZSQVHLCKE]$/.test(t)&&(e=t.slice(0,-1).replace(/[X,Y,Z]/g,function(t){return r[t]}),t.endsWith([\"T\",\"R\",\"W\",\"A\",\"G\",\"M\",\"Y\",\"F\",\"P\",\"D\",\"X\",\"B\",\"N\",\"J\",\"Z\",\"S\",\"Q\",\"V\",\"H\",\"L\",\"C\",\"K\",\"E\"][e%23]))},FI:function(t){return f(t),11===t.length&&!!t.match(/^\\d{6}[\\-A\\+]\\d{3}[0-9ABCDEFHJKLMNPRSTUVWXY]{1}$/)&&\"0123456789ABCDEFHJKLMNPRSTUVWXY\"[(1e3*parseInt(t.slice(0,6),10)+parseInt(t.slice(7,10),10))%31]===t.slice(10,11)},IN:function(t){var r,n=[[0,1,2,3,4,5,6,7,8,9],[1,2,3,4,0,6,7,8,9,5],[2,3,4,0,1,7,8,9,5,6],[3,4,0,1,2,8,9,5,6,7],[4,0,1,2,3,9,5,6,7,8],[5,9,8,7,6,0,4,3,2,1],[6,5,9,8,7,1,0,4,3,2],[7,6,5,9,8,2,1,0,4,3],[8,7,6,5,9,3,2,1,0,4],[9,8,7,6,5,4,3,2,1,0]],a=[[0,1,2,3,4,5,6,7,8,9],[1,5,7,6,2,8,3,0,9,4],[5,8,0,3,7,9,6,1,4,2],[8,9,1,6,0,4,3,5,2,7],[9,4,5,3,1,2,6,8,7,0],[4,2,8,6,5,7,3,9,0,1],[2,7,9,3,8,0,6,4,1,5],[7,0,4,6,9,1,3,2,5,8]],t=t.trim();return!!/^[1-9]\\d{3}\\s?\\d{4}\\s?\\d{4}$/.test(t)&&(r=0,t.replace(/\\s/g,\"\").split(\"\").map(Number).reverse().forEach(function(t,e){r=n[r][a[e%8][t]]}),0===r)},IR:function(t){if(!t.match(/^\\d{10}$/))return!1;if(t=\"0000\".concat(t).slice(t.length-6),0===parseInt(t.slice(3,9),10))return!1;for(var e=parseInt(t.slice(9,10),10),r=0,n=0;n<9;n++)r+=parseInt(t.slice(n,n+1),10)*(10-n);return(r%=11)<2&&e===r||2<=r&&e===11-r},IT:function(t){return 9===t.length&&\"CA00000AA\"!==t&&-1<t.search(/C[A-Z]\\d{5}[A-Z]{2}/i)},NO:function(t){var e,t=t.trim();return!isNaN(Number(t))&&11===t.length&&\"00000000000\"!==t&&(e=(11-(3*(t=t.split(\"\").map(Number))[0]+7*t[1]+6*t[2]+ +t[3]+8*t[4]+9*t[5]+4*t[6]+5*t[7]+2*t[8])%11)%11)===t[9]&&(11-(5*t[0]+4*t[1]+3*t[2]+2*t[3]+7*t[4]+6*t[5]+5*t[6]+4*t[7]+3*t[8]+2*e)%11)%11===t[10]},TH:function(t){if(!t.match(/^[1-8]\\d{12}$/))return!1;for(var e=0,r=0;r<12;r++)e+=parseInt(t[r],10)*(13-r);return t[12]===((11-e%11)%10).toString()},LK:function(t){return!(10!==t.length||!/^[1-9]\\d{8}[vx]$/i.test(t))||!(12!==t.length||!/^[1-9]\\d{11}$/i.test(t))},\"he-IL\":function(t){t=t.trim();if(!/^\\d{9}$/.test(t))return!1;for(var e,r=t,n=0,a=0;a<r.length;a++)n+=9<(e=Number(r[a])*(a%2+1))?e-9:e;return n%10==0},\"ar-LY\":function(t){t=t.trim();return!!/^(1|2)\\d{11}$/.test(t)},\"ar-TN\":function(t){t=t.trim();return!!/^\\d{8}$/.test(t)},\"zh-CN\":function(t){var e,r,n=[\"11\",\"12\",\"13\",\"14\",\"15\",\"21\",\"22\",\"23\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"50\",\"51\",\"52\",\"53\",\"54\",\"61\",\"62\",\"63\",\"64\",\"65\",\"71\",\"81\",\"82\",\"91\"],a=[\"7\",\"9\",\"10\",\"5\",\"8\",\"4\",\"2\",\"1\",\"6\",\"3\",\"7\",\"9\",\"10\",\"5\",\"8\",\"4\",\"2\"],i=[\"1\",\"0\",\"X\",\"9\",\"8\",\"7\",\"6\",\"5\",\"4\",\"3\",\"2\"],o=function(t){return Z(n,t)},s=function(t){var e=parseInt(t.substring(0,4),10),r=parseInt(t.substring(4,6),10),t=parseInt(t.substring(6),10),n=new Date(e,r-1,t);return!(n>new Date)&&n.getFullYear()===e&&n.getMonth()===r-1&&n.getDate()===t},c=function(t){for(var e=t.substring(0,17),r=0,n=0;n<17;n++)r+=parseInt(e.charAt(n),10)*parseInt(a[n],10);return i[r%11]},u=function(t){return c(t)===t.charAt(17).toUpperCase()};return t=t,!!/^\\d{15}|(\\d{17}(\\d|x|X))$/.test(t)&&(15===t.length?!!/^[1-9]\\d{7}((0[1-9])|(1[0-2]))((0[1-9])|([1-2][0-9])|(3[0-1]))\\d{3}$/.test(e=t)&&(r=e.substring(0,2),!!o(r))&&(r=\"19\".concat(e.substring(6,12)),!!s(r)):!!/^[1-9]\\d{5}[1-9]\\d{3}((0[1-9])|(1[0-2]))((0[1-9])|([1-2][0-9])|(3[0-1]))\\d{3}(\\d|x|X)$/.test(e=t)&&(r=e.substring(0,2),!!o(r))&&(r=e.substring(6,14),!!s(r))&&u(e))},\"zh-HK\":function(t){var e=/^[0-9]$/;if(t=(t=t.trim()).toUpperCase(),!/^[A-Z]{1,2}[0-9]{6}((\\([0-9A]\\))|(\\[[0-9A]\\])|([0-9A]))$/.test(t))return!1;8===(t=t.replace(/\\[|\\]|\\(|\\)/g,\"\")).length&&(t=\"3\".concat(t));for(var r=0,n=0;n<=7;n++)r+=(e.test(t[n])?t[n]:(t[n].charCodeAt(0)-55)%11)*(9-n);return(0===(r%=11)?\"0\":1===r?\"A\":String(11-r))===t[t.length-1]},\"zh-TW\":function(t){var a={A:10,B:11,C:12,D:13,E:14,F:15,G:16,H:17,I:34,J:18,K:19,L:20,M:21,N:22,O:35,P:23,Q:24,R:25,S:26,T:27,U:28,V:29,W:32,X:30,Y:31,Z:33},t=t.trim().toUpperCase();return!!/^[A-Z][0-9]{9}$/.test(t)&&Array.from(t).reduce(function(t,e,r){var n;return 0===r?(n=a[e])%10*9+Math.floor(n/10):9===r?(10-t%10-Number(e))%10==0:t+Number(e)*(9-r)},0)},PK:function(t){t=t.trim();return/^[1-7][0-9]{4}-[0-9]{7}-[1-9]$/.test(t)}};var ve=8,Le=14,Me=/^(\\d{8}|\\d{13}|\\d{14})$/;function Be(r){var t=10-r.slice(0,-1).split(\"\").map(function(t,e){return Number(t)*(t=r.length,e=e,t===ve||t===Le?e%2==0?3:1:e%2==0?1:3)}).reduce(function(t,e){return t+e},0)%10;return t<10?t:0}var Fe=/^[A-Z]{2}[0-9A-Z]{9}[0-9]$/;var Ne=/^(?:[0-9]{9}X|[0-9]{10})$/,Ce=/^(?:[0-9]{13})$/,De=[1,3];function Te(t){for(var e=10,r=0;r<t.length-1;r++)e=(parseInt(t[r],10)+e)%10==0?9:(parseInt(t[r],10)+e)%10*2%11;return(e=1===e?0:11-e)===parseInt(t[10],10)}function be(t){for(var e,r=0,n=!1,a=t.length-1;0<=a;a--)r+=n?9<(e=2*parseInt(t[a],10))?e.toString().split(\"\").map(function(t){return parseInt(t,10)}).reduce(function(t,e){return t+e},0):e:parseInt(t[a],10),n=!n;return r%10==0}function M(t,e){for(var r=0,n=0;n<t.length;n++)r+=t[n]*(e-n);return r}var Ge={andover:[\"10\",\"12\"],atlanta:[\"60\",\"67\"],austin:[\"50\",\"53\"],brookhaven:[\"01\",\"02\",\"03\",\"04\",\"05\",\"06\",\"11\",\"13\",\"14\",\"16\",\"21\",\"22\",\"23\",\"25\",\"34\",\"51\",\"52\",\"54\",\"55\",\"56\",\"57\",\"58\",\"59\",\"65\"],cincinnati:[\"30\",\"32\",\"35\",\"36\",\"37\",\"38\",\"61\"],fresno:[\"15\",\"24\"],internet:[\"20\",\"26\",\"27\",\"45\",\"46\",\"47\"],kansas:[\"40\",\"44\"],memphis:[\"94\",\"95\"],ogden:[\"80\",\"90\"],philadelphia:[\"33\",\"39\",\"41\",\"42\",\"43\",\"46\",\"48\",\"62\",\"63\",\"64\",\"66\",\"68\",\"71\",\"72\",\"73\",\"74\",\"75\",\"76\",\"77\",\"81\",\"82\",\"83\",\"84\",\"85\",\"86\",\"87\",\"88\",\"91\",\"92\",\"93\",\"98\",\"99\"],sba:[\"31\"]};function Oe(t){for(var e=!1,r=!1,n=0;n<3;n++)if(!e&&/[AEIOU]/.test(t[n]))e=!0;else if(!r&&e&&\"X\"===t[n])r=!0;else if(0<n){if(e&&!r&&!/[AEIOU]/.test(t[n]))return;if(r&&!/X/.test(t[n]))return}return 1}var B={\"bg-BG\":/^\\d{10}$/,\"cs-CZ\":/^\\d{6}\\/{0,1}\\d{3,4}$/,\"de-AT\":/^\\d{9}$/,\"de-DE\":/^[1-9]\\d{10}$/,\"dk-DK\":/^\\d{6}-{0,1}\\d{4}$/,\"el-CY\":/^[09]\\d{7}[A-Z]$/,\"el-GR\":/^([0-4]|[7-9])\\d{8}$/,\"en-CA\":/^\\d{9}$/,\"en-GB\":/^\\d{10}$|^(?!GB|NK|TN|ZZ)(?![DFIQUV])[A-Z](?![DFIQUVO])[A-Z]\\d{6}[ABCD ]$/i,\"en-IE\":/^\\d{7}[A-W][A-IW]{0,1}$/i,\"en-US\":/^\\d{2}[- ]{0,1}\\d{7}$/,\"es-AR\":/(20|23|24|27|30|33|34)[0-9]{8}[0-9]/,\"es-ES\":/^(\\d{0,8}|[XYZKLM]\\d{7})[A-HJ-NP-TV-Z]$/i,\"et-EE\":/^[1-6]\\d{6}(00[1-9]|0[1-9][0-9]|[1-6][0-9]{2}|70[0-9]|710)\\d$/,\"fi-FI\":/^\\d{6}[-+A]\\d{3}[0-9A-FHJ-NPR-Y]$/i,\"fr-BE\":/^\\d{11}$/,\"fr-FR\":/^[0-3]\\d{12}$|^[0-3]\\d\\s\\d{2}(\\s\\d{3}){3}$/,\"fr-LU\":/^\\d{13}$/,\"hr-HR\":/^\\d{11}$/,\"hu-HU\":/^8\\d{9}$/,\"it-IT\":/^[A-Z]{6}[L-NP-V0-9]{2}[A-EHLMPRST][L-NP-V0-9]{2}[A-ILMZ][L-NP-V0-9]{3}[A-Z]$/i,\"lv-LV\":/^\\d{6}-{0,1}\\d{5}$/,\"mt-MT\":/^\\d{3,7}[APMGLHBZ]$|^([1-8])\\1\\d{7}$/i,\"nl-NL\":/^\\d{9}$/,\"pl-PL\":/^\\d{10,11}$/,\"pt-BR\":/(?:^\\d{11}$)|(?:^\\d{14}$)/,\"pt-PT\":/^\\d{9}$/,\"ro-RO\":/^\\d{13}$/,\"sk-SK\":/^\\d{6}\\/{0,1}\\d{3,4}$/,\"sl-SI\":/^[1-9]\\d{7}$/,\"sv-SE\":/^(\\d{6}[-+]{0,1}\\d{4}|(18|19|20)\\d{6}[-+]{0,1}\\d{4})$/,\"uk-UA\":/^\\d{10}$/},F=(B[\"lb-LU\"]=B[\"fr-LU\"],B[\"lt-LT\"]=B[\"et-EE\"],B[\"nl-BE\"]=B[\"fr-BE\"],B[\"fr-CA\"]=B[\"en-CA\"],{\"bg-BG\":function(t){var e=t.slice(0,2),r=parseInt(t.slice(2,4),10),e=(40<r?(r-=40,\"20\"):20<r?(r-=20,\"18\"):\"19\").concat(e);if(r<10&&(r=\"0\".concat(r)),!m(\"\".concat(e,\"/\").concat(r,\"/\").concat(t.slice(4,6)),\"YYYY/MM/DD\"))return!1;for(var n=t.split(\"\").map(function(t){return parseInt(t,10)}),a=[2,4,8,5,10,9,7,3,6],i=0,o=0;o<a.length;o++)i+=n[o]*a[o];return(i=i%11==10?0:i%11)===n[9]},\"cs-CZ\":function(t){t=t.replace(/\\W/,\"\");var e=parseInt(t.slice(0,2),10);if(10===t.length)e=(e<54?\"20\":\"19\").concat(e);else{if(\"000\"===t.slice(6))return!1;if(!(e<54))return!1;e=\"19\".concat(e)}3===e.length&&(e=[e.slice(0,2),\"0\",e.slice(2)].join(\"\"));var r=parseInt(t.slice(2,4),10);if(50<r&&(r-=50),20<r){if(parseInt(e,10)<2004)return!1;r-=20}if(r<10&&(r=\"0\".concat(r)),!m(\"\".concat(e,\"/\").concat(r,\"/\").concat(t.slice(4,6)),\"YYYY/MM/DD\"))return!1;if(10===t.length&&parseInt(t,10)%11!=0){r=parseInt(t.slice(0,9),10)%11;if(!(parseInt(e,10)<1986&&10==r))return!1;if(0!==parseInt(t.slice(9),10))return!1}return!0},\"de-AT\":be,\"de-DE\":function(t){for(var e=t.split(\"\").map(function(t){return parseInt(t,10)}),r=[],n=0;n<e.length-1;n++){r.push(\"\");for(var a=0;a<e.length-1;a++)e[n]===e[a]&&(r[n]+=a)}if(2!==(r=r.filter(function(t){return 1<t.length})).length&&3!==r.length)return!1;if(3===r[0].length){for(var i=r[0].split(\"\").map(function(t){return parseInt(t,10)}),o=0,s=0;s<i.length-1;s++)i[s]+1===i[s+1]&&(o+=1);if(2===o)return!1}return Te(t)},\"dk-DK\":function(t){t=t.replace(/\\W/,\"\");var e=parseInt(t.slice(4,6),10);switch(t.slice(6,7)){case\"0\":case\"1\":case\"2\":case\"3\":e=\"19\".concat(e);break;case\"4\":case\"9\":e=(e<37?\"20\":\"19\").concat(e);break;default:if(e<37)e=\"20\".concat(e);else{if(!(58<e))return!1;e=\"18\".concat(e)}}if(3===e.length&&(e=[e.slice(0,2),\"0\",e.slice(2)].join(\"\")),!m(\"\".concat(e,\"/\").concat(t.slice(2,4),\"/\").concat(t.slice(0,2)),\"YYYY/MM/DD\"))return!1;for(var r=t.split(\"\").map(function(t){return parseInt(t,10)}),n=0,a=4,i=0;i<9;i++)n+=r[i]*a,1===--a&&(a=7);return 1!=(n%=11)&&(0===n?0===r[9]:r[9]===11-n)},\"el-CY\":function(t){for(var e=t.slice(0,8).split(\"\").map(function(t){return parseInt(t,10)}),r=0,n=1;n<e.length;n+=2)r+=e[n];for(var a=0;a<e.length;a+=2)e[a]<2?r+=1-e[a]:(r+=2*(e[a]-2)+5,4<e[a]&&(r+=2));return String.fromCharCode(r%26+65)===t.charAt(8)},\"el-GR\":function(t){for(var e=t.split(\"\").map(function(t){return parseInt(t,10)}),r=0,n=0;n<8;n++)r+=e[n]*Math.pow(2,8-n);return r%11%10===e[8]},\"en-CA\":function(t){var e=(t=t.split(\"\")).filter(function(t,e){return e%2}).map(function(t){return 2*Number(t)}).join(\"\").split(\"\");return t.filter(function(t,e){return!(e%2)}).concat(e).map(function(t){return Number(t)}).reduce(function(t,e){return t+e})%10==0},\"en-IE\":function(t){var e=M(t.split(\"\").slice(0,7).map(function(t){return parseInt(t,10)}),8);return 9===t.length&&\"W\"!==t[8]&&(e+=9*(t[8].charCodeAt(0)-64)),0===(e%=23)?\"W\"===t[7].toUpperCase():t[7].toUpperCase()===String.fromCharCode(64+e)},\"en-US\":function(t){return-1!==(()=>{var t,e=[];for(t in Ge)Ge.hasOwnProperty(t)&&e.push.apply(e,q(Ge[t]));return e})().indexOf(t.slice(0,2))},\"es-AR\":function(t){for(var e=0,r=t.split(\"\"),t=parseInt(r.pop(),10),n=0;n<r.length;n++)e+=r[9-n]*(2+n%6);var a=11-e%11;return 11===a?a=0:10===a&&(a=9),t===a},\"es-ES\":function(t){var e=t.toUpperCase().split(\"\");if(isNaN(parseInt(e[0],10))&&1<e.length){var r=0;switch(e[0]){case\"Y\":r=1;break;case\"Z\":r=2}e.splice(0,1,r)}else for(;e.length<9;)e.unshift(0);return e=e.join(\"\"),t=parseInt(e.slice(0,8),10)%23,e[8]===[\"T\",\"R\",\"W\",\"A\",\"G\",\"M\",\"Y\",\"F\",\"P\",\"D\",\"X\",\"B\",\"N\",\"J\",\"Z\",\"S\",\"Q\",\"V\",\"H\",\"L\",\"C\",\"K\",\"E\"][t]},\"et-EE\":function(t){var e=t.slice(1,3);switch(t.slice(0,1)){case\"1\":case\"2\":e=\"18\".concat(e);break;case\"3\":case\"4\":e=\"19\".concat(e);break;default:e=\"20\".concat(e)}if(!m(\"\".concat(e,\"/\").concat(t.slice(3,5),\"/\").concat(t.slice(5,7)),\"YYYY/MM/DD\"))return!1;for(var r=t.split(\"\").map(function(t){return parseInt(t,10)}),n=0,a=1,i=0;i<10;i++)n+=r[i]*a,10===(a+=1)&&(a=1);if(n%11==10){for(var n=0,a=3,o=0;o<10;o++)n+=r[o]*a,10===(a+=1)&&(a=1);if(n%11==10)return 0===r[10]}return n%11===r[10]},\"fi-FI\":function(t){var e,r=t.slice(4,6);switch(t.slice(6,7)){case\"+\":r=\"18\".concat(r);break;case\"-\":r=\"19\".concat(r);break;default:r=\"20\".concat(r)}return!!m(\"\".concat(r,\"/\").concat(t.slice(2,4),\"/\").concat(t.slice(0,2)),\"YYYY/MM/DD\")&&((e=parseInt(t.slice(0,6)+t.slice(7,10),10)%31)<10?e===parseInt(t.slice(10),10):[\"A\",\"B\",\"C\",\"D\",\"E\",\"F\",\"H\",\"J\",\"K\",\"L\",\"M\",\"N\",\"P\",\"R\",\"S\",\"T\",\"U\",\"V\",\"W\",\"X\",\"Y\"][e-=10]===t.slice(10))},\"fr-BE\":function(t){var e,r;return!!(\"00\"===t.slice(2,4)&&\"00\"===t.slice(4,6)||m(\"\".concat(t.slice(0,2),\"/\").concat(t.slice(2,4),\"/\").concat(t.slice(4,6)),\"YY/MM/DD\"))&&(e=97-parseInt(t.slice(0,9),10)%97,r=parseInt(t.slice(9,11),10),e===r||97-parseInt(\"2\".concat(t.slice(0,9)),10)%97===r)},\"fr-FR\":function(t){return t=t.replace(/\\s/g,\"\"),parseInt(t.slice(0,10),10)%511===parseInt(t.slice(10,13),10)},\"fr-LU\":function(t){if(m(\"\".concat(t.slice(0,4),\"/\").concat(t.slice(4,6),\"/\").concat(t.slice(6,8)),\"YYYY/MM/DD\")&&be(t.slice(0,12))){for(var t=\"\".concat(t.slice(0,11)).concat(t[12]),e=[[0,1,2,3,4,5,6,7,8,9],[1,2,3,4,0,6,7,8,9,5],[2,3,4,0,1,7,8,9,5,6],[3,4,0,1,2,8,9,5,6,7],[4,0,1,2,3,9,5,6,7,8],[5,9,8,7,6,0,4,3,2,1],[6,5,9,8,7,1,0,4,3,2],[7,6,5,9,8,2,1,0,4,3],[8,7,6,5,9,3,2,1,0,4],[9,8,7,6,5,4,3,2,1,0]],r=[[0,1,2,3,4,5,6,7,8,9],[1,5,7,6,2,8,3,0,9,4],[5,8,0,3,7,9,6,1,4,2],[8,9,1,6,0,4,3,5,2,7],[9,4,5,3,1,2,6,8,7,0],[4,2,8,6,5,7,3,9,0,1],[2,7,9,3,8,0,6,4,1,5],[7,0,4,6,9,1,3,2,5,8]],n=t.split(\"\").reverse().join(\"\"),a=0,i=0;i<n.length;i++)a=e[a][r[i%8][parseInt(n[i],10)]];return 0===a}return!1},\"hr-HR\":Te,\"hu-HU\":function(t){for(var e=t.split(\"\").map(function(t){return parseInt(t,10)}),r=8,n=1;n<9;n++)r+=e[n]*(n+1);return r%11===e[9]},\"it-IT\":function(t){var e=t.toUpperCase().split(\"\");if(!Oe(e.slice(0,3)))return!1;if(!Oe(e.slice(3,6)))return!1;for(var r={L:\"0\",M:\"1\",N:\"2\",P:\"3\",Q:\"4\",R:\"5\",S:\"6\",T:\"7\",U:\"8\",V:\"9\"},n=0,a=[6,7,9,10,12,13,14];n<a.length;n++){var i=a[n];e[i]in r&&e.splice(i,1,r[e[i]])}var t={A:\"01\",B:\"02\",C:\"03\",D:\"04\",E:\"05\",H:\"06\",L:\"07\",M:\"08\",P:\"09\",R:\"10\",S:\"11\",T:\"12\"}[e[8]],o=parseInt(e[9]+e[10],10);if(40<o&&(o-=40),o<10&&(o=\"0\".concat(o)),!m(\"\".concat(e[6]).concat(e[7],\"/\").concat(t,\"/\").concat(o),\"YY/MM/DD\"))return!1;for(var s=0,c=1;c<e.length-1;c+=2){var u=parseInt(e[c],10);s+=u=isNaN(u)?e[c].charCodeAt(0)-65:u}for(var l={A:1,B:0,C:5,D:7,E:9,F:13,G:15,H:17,I:19,J:21,K:2,L:4,M:18,N:20,O:11,P:3,Q:6,R:8,S:12,T:14,U:16,V:10,W:22,X:25,Y:24,Z:23,0:1,1:0},d=0;d<e.length-1;d+=2){var f,A=0;e[d]in l?A=l[e[d]]:(A=2*(f=parseInt(e[d],10))+1,4<f&&(A+=2)),s+=A}return String.fromCharCode(65+s%26)===e[15]},\"lv-LV\":function(t){var e=(t=t.replace(/\\W/,\"\")).slice(0,2);if(\"32\"===e)return!0;if(\"00\"!==t.slice(2,4)){var r=t.slice(4,6);switch(t[6]){case\"0\":r=\"18\".concat(r);break;case\"1\":r=\"19\".concat(r);break;default:r=\"20\".concat(r)}if(!m(\"\".concat(r,\"/\").concat(t.slice(2,4),\"/\").concat(e),\"YYYY/MM/DD\"))return!1}for(var n=1101,a=[1,6,3,7,9,10,5,8,4,2],i=0;i<t.length-1;i++)n-=parseInt(t[i],10)*a[i];return parseInt(t[10],10)===n%11},\"mt-MT\":function(t){if(9!==t.length){for(var e=t.toUpperCase().split(\"\");e.length<8;)e.unshift(0);switch(t[7]){case\"A\":case\"P\":if(0===parseInt(e[6],10))return!1;break;default:var r=parseInt(e.join(\"\").slice(0,5),10);if(32e3<r)return!1;if(r===parseInt(e.join(\"\").slice(5,7),10))return!1}}return!0},\"nl-NL\":function(t){return M(t.split(\"\").slice(0,8).map(function(t){return parseInt(t,10)}),9)%11===parseInt(t[8],10)},\"pl-PL\":function(t){if(10===t.length){for(var e=[6,5,7,2,3,4,5,6,7],r=0,n=0;n<e.length;n++)r+=parseInt(t[n],10)*e[n];return 10===(r%=11)?!1:r===parseInt(t[9],10)}var a=t.slice(0,2),i=parseInt(t.slice(2,4),10);if(80<i?(a=\"18\".concat(a),i-=80):60<i?(a=\"22\".concat(a),i-=60):40<i?(a=\"21\".concat(a),i-=40):20<i?(a=\"20\".concat(a),i-=20):a=\"19\".concat(a),i<10&&(i=\"0\".concat(i)),!m(\"\".concat(a,\"/\").concat(i,\"/\").concat(t.slice(4,6)),\"YYYY/MM/DD\"))return!1;for(var o=0,s=1,c=0;c<t.length-1;c++)o+=parseInt(t[c],10)*s%10,10<(s+=2)?s=1:5===s&&(s+=2);return(o=10-o%10)===parseInt(t[10],10)},\"pt-BR\":function(t){if(11===t.length){var e=0;if(\"11111111111\"===t||\"22222222222\"===t||\"33333333333\"===t||\"44444444444\"===t||\"55555555555\"===t||\"66666666666\"===t||\"77777777777\"===t||\"88888888888\"===t||\"99999999999\"===t||\"00000000000\"===t)return!1;for(var r=1;r<=9;r++)e+=parseInt(t.substring(r-1,r),10)*(11-r);if((o=10===(o=10*e%11)?0:o)!==parseInt(t.substring(9,10),10))return!1;e=0;for(var n=1;n<=10;n++)e+=parseInt(t.substring(n-1,n),10)*(12-n);return(o=10===(o=10*e%11)?0:o)!==parseInt(t.substring(10,11),10)?!1:!0}if(\"00000000000000\"===t||\"11111111111111\"===t||\"22222222222222\"===t||\"33333333333333\"===t||\"44444444444444\"===t||\"55555555555555\"===t||\"66666666666666\"===t||\"77777777777777\"===t||\"88888888888888\"===t||\"99999999999999\"===t)return!1;for(var a=t.length-2,i=t.substring(0,a),o=t.substring(a),s=0,c=a-7,u=a;1<=u;u--)s+=i.charAt(a-u)*c,--c<2&&(c=9);if((s%11<2?0:11-s%11)!==parseInt(o.charAt(0),10))return!1;for(var i=t.substring(0,a+=1),s=0,c=a-7,l=a;1<=l;l--)s+=i.charAt(a-l)*c,--c<2&&(c=9);return(s%11<2?0:11-s%11)===parseInt(o.charAt(1),10)},\"pt-PT\":function(t){var e=11-M(t.split(\"\").slice(0,8).map(function(t){return parseInt(t,10)}),9)%11;return 9<e?0===parseInt(t[8],10):e===parseInt(t[8],10)},\"ro-RO\":function(t){if(\"9000\"===t.slice(0,4))return!0;var e=t.slice(1,3);switch(t[0]){case\"1\":case\"2\":e=\"19\".concat(e);break;case\"3\":case\"4\":e=\"18\".concat(e);break;case\"5\":case\"6\":e=\"20\".concat(e)}var r=\"\".concat(e,\"/\").concat(t.slice(3,5),\"/\").concat(t.slice(5,7));if(8===r.length){if(!m(r,\"YY/MM/DD\"))return!1}else if(!m(r,\"YYYY/MM/DD\"))return!1;for(var n=t.split(\"\").map(function(t){return parseInt(t,10)}),a=[2,7,9,1,4,6,3,5,8,2,7,9],i=0,o=0;o<a.length;o++)i+=n[o]*a[o];return i%11==10?1===n[12]:n[12]===i%11},\"sk-SK\":function(t){if(9===t.length){if(\"000\"===(t=t.replace(/\\W/,\"\")).slice(6))return!1;if(53<(e=parseInt(t.slice(0,2),10)))return!1;var e=(e<10?\"190\":\"19\").concat(e),r=parseInt(t.slice(2,4),10);if(50<r&&(r-=50),r<10&&(r=\"0\".concat(r)),!m(\"\".concat(e,\"/\").concat(r,\"/\").concat(t.slice(4,6)),\"YYYY/MM/DD\"))return!1}return!0},\"sl-SI\":function(t){var e=11-M(t.split(\"\").slice(0,7).map(function(t){return parseInt(t,10)}),8)%11;return 10==e?0===parseInt(t[7],10):e===parseInt(t[7],10)},\"sv-SE\":function(t){var e=t.slice(0),r=\"\",n=(e=11<t.length?e.slice(2):e).slice(2,4),e=parseInt(e.slice(4,6),10);if(11<t.length)r=t.slice(0,4);else if(r=t.slice(0,2),11===t.length&&e<60){var a=(new Date).getFullYear().toString(),i=parseInt(a.slice(0,2),10),a=parseInt(a,10);if(\"-\"===t[6])r=(parseInt(\"\".concat(i).concat(r),10)>a?\"\".concat(i-1):\"\".concat(i)).concat(r);else if(r=\"\".concat(i-1).concat(r),a-parseInt(r,10)<100)return!1}if(60<e&&(e-=60),e<10&&(e=\"0\".concat(e)),8===(i=\"\".concat(r,\"/\").concat(n,\"/\").concat(e)).length){if(!m(i,\"YY/MM/DD\"))return!1}else if(!m(i,\"YYYY/MM/DD\"))return!1;return be(t.replace(/\\W/,\"\"))},\"uk-UA\":function(t){for(var e=t.split(\"\").map(function(t){return parseInt(t,10)}),r=[-1,5,7,9,4,6,10,5,7],n=0,a=0;a<r.length;a++)n+=e[a]*r[a];return n%11==10?0===e[9]:e[9]===n%11}}),E=(F[\"lb-LU\"]=F[\"fr-LU\"],F[\"lt-LT\"]=F[\"et-EE\"],F[\"nl-BE\"]=F[\"fr-BE\"],F[\"fr-CA\"]=F[\"en-CA\"],/[-\\\\\\/!@#$%\\^&\\*\\(\\)\\+\\=\\[\\]]+/g),N={\"de-AT\":E,\"de-DE\":/[\\/\\\\]/g,\"fr-BE\":E};N[\"nl-BE\"]=N[\"fr-BE\"];var C={\"am-AM\":/^(\\+?374|0)(33|4[134]|55|77|88|9[13-689])\\d{6}$/,\"ar-AE\":/^((\\+?971)|0)?5[024568]\\d{7}$/,\"ar-BH\":/^(\\+?973)?(3|6)\\d{7}$/,\"ar-DZ\":/^(\\+?213|0)(5|6|7)\\d{8}$/,\"ar-LB\":/^(\\+?961)?((3|81)\\d{6}|7\\d{7})$/,\"ar-EG\":/^((\\+?20)|0)?1[0125]\\d{8}$/,\"ar-IQ\":/^(\\+?964|0)?7[0-9]\\d{8}$/,\"ar-JO\":/^(\\+?962|0)?7[789]\\d{7}$/,\"ar-KW\":/^(\\+?965)([569]\\d{7}|41\\d{6})$/,\"ar-LY\":/^((\\+?218)|0)?(9[1-6]\\d{7}|[1-8]\\d{7,9})$/,\"ar-MA\":/^(?:(?:\\+|00)212|0)[5-7]\\d{8}$/,\"ar-OM\":/^((\\+|00)968)?([79][1-9])\\d{6}$/,\"ar-PS\":/^(\\+?970|0)5[6|9](\\d{7})$/,\"ar-SA\":/^(!?(\\+?966)|0)?5\\d{8}$/,\"ar-SD\":/^((\\+?249)|0)?(9[012369]|1[012])\\d{7}$/,\"ar-SY\":/^(!?(\\+?963)|0)?9\\d{8}$/,\"ar-TN\":/^(\\+?216)?[2459]\\d{7}$/,\"az-AZ\":/^(\\+994|0)(10|5[015]|7[07]|99)\\d{7}$/,\"ar-QA\":/^(\\+?974|0)?([3567]\\d{7})$/,\"bs-BA\":/^((((\\+|00)3876)|06))((([0-3]|[5-6])\\d{6})|(4\\d{7}))$/,\"be-BY\":/^(\\+?375)?(24|25|29|33|44)\\d{7}$/,\"bg-BG\":/^(\\+?359|0)?8[789]\\d{7}$/,\"bn-BD\":/^(\\+?880|0)1[13456789][0-9]{8}$/,\"ca-AD\":/^(\\+376)?[346]\\d{5}$/,\"cs-CZ\":/^(\\+?420)? ?[1-9][0-9]{2} ?[0-9]{3} ?[0-9]{3}$/,\"da-DK\":/^(\\+?45)?\\s?\\d{2}\\s?\\d{2}\\s?\\d{2}\\s?\\d{2}$/,\"de-DE\":/^((\\+49|0)1)(5[0-25-9]\\d|6([23]|0\\d?)|7([0-57-9]|6\\d))\\d{7,9}$/,\"de-AT\":/^(\\+43|0)\\d{1,4}\\d{3,12}$/,\"de-CH\":/^(\\+41|0)([1-9])\\d{1,9}$/,\"de-LU\":/^(\\+352)?((6\\d1)\\d{6})$/,\"dv-MV\":/^(\\+?960)?(7[2-9]|9[1-9])\\d{5}$/,\"el-GR\":/^(\\+?30|0)?6(8[5-9]|9(?![26])[0-9])\\d{7}$/,\"el-CY\":/^(\\+?357?)?(9(9|7|6|5|4)\\d{6})$/,\"en-AI\":/^(\\+?1|0)264(?:2(35|92)|4(?:6[1-2]|76|97)|5(?:3[6-9]|8[1-4])|7(?:2(4|9)|72))\\d{4}$/,\"en-AU\":/^(\\+?61|0)4\\d{8}$/,\"en-AG\":/^(?:\\+1|1)268(?:464|7(?:1[3-9]|[28]\\d|3[0246]|64|7[0-689]))\\d{4}$/,\"en-BM\":/^(\\+?1)?441(((3|7)\\d{6}$)|(5[0-3][0-9]\\d{4}$)|(59\\d{5}$))/,\"en-BS\":/^(\\+?1[-\\s]?|0)?\\(?242\\)?[-\\s]?\\d{3}[-\\s]?\\d{4}$/,\"en-GB\":/^(\\+?44|0)7[1-9]\\d{8}$/,\"en-GG\":/^(\\+?44|0)1481\\d{6}$/,\"en-GH\":/^(\\+233|0)(20|50|24|54|27|57|26|56|23|53|28|55|59)\\d{7}$/,\"en-GY\":/^(\\+592|0)6\\d{6}$/,\"en-HK\":/^(\\+?852[-\\s]?)?[456789]\\d{3}[-\\s]?\\d{4}$/,\"en-MO\":/^(\\+?853[-\\s]?)?[6]\\d{3}[-\\s]?\\d{4}$/,\"en-IE\":/^(\\+?353|0)8[356789]\\d{7}$/,\"en-IN\":/^(\\+?91|0)?[6789]\\d{9}$/,\"en-JM\":/^(\\+?876)?\\d{7}$/,\"en-KE\":/^(\\+?254|0)(7|1)\\d{8}$/,\"fr-CF\":/^(\\+?236| ?)(70|75|77|72|21|22)\\d{6}$/,\"en-SS\":/^(\\+?211|0)(9[1257])\\d{7}$/,\"en-KI\":/^((\\+686|686)?)?( )?((6|7)(2|3|8)[0-9]{6})$/,\"en-KN\":/^(?:\\+1|1)869(?:46\\d|48[89]|55[6-8]|66\\d|76[02-7])\\d{4}$/,\"en-LS\":/^(\\+?266)(22|28|57|58|59|27|52)\\d{6}$/,\"en-MT\":/^(\\+?356|0)?(99|79|77|21|27|22|25)[0-9]{6}$/,\"en-MU\":/^(\\+?230|0)?\\d{8}$/,\"en-MW\":/^(\\+?265|0)(((77|88|31|99|98|21)\\d{7})|(((111)|1)\\d{6})|(32000\\d{4}))$/,\"en-NA\":/^(\\+?264|0)(6|8)\\d{7}$/,\"en-NG\":/^(\\+?234|0)?[789]\\d{9}$/,\"en-NZ\":/^(\\+?64|0)[28]\\d{7,9}$/,\"en-PG\":/^(\\+?675|0)?(7\\d|8[18])\\d{6}$/,\"en-PK\":/^((00|\\+)?92|0)3[0-6]\\d{8}$/,\"en-PH\":/^(09|\\+639)\\d{9}$/,\"en-RW\":/^(\\+?250|0)?[7]\\d{8}$/,\"en-SG\":/^(\\+65)?[3689]\\d{7}$/,\"en-SL\":/^(\\+?232|0)\\d{8}$/,\"en-TZ\":/^(\\+?255|0)?[67]\\d{8}$/,\"en-UG\":/^(\\+?256|0)?[7]\\d{8}$/,\"en-US\":/^((\\+1|1)?( |-)?)?(\\([2-9][0-9]{2}\\)|[2-9][0-9]{2})( |-)?([2-9][0-9]{2}( |-)?[0-9]{4})$/,\"en-ZA\":/^(\\+?27|0)\\d{9}$/,\"en-ZM\":/^(\\+?26)?0[79][567]\\d{7}$/,\"en-ZW\":/^(\\+263)[0-9]{9}$/,\"en-BW\":/^(\\+?267)?(7[1-8]{1})\\d{6}$/,\"es-AR\":/^\\+?549(11|[2368]\\d)\\d{8}$/,\"es-BO\":/^(\\+?591)?(6|7)\\d{7}$/,\"es-CO\":/^(\\+?57)?3(0(0|1|2|4|5)|1\\d|2[0-4]|5(0|1))\\d{7}$/,\"es-CL\":/^(\\+?56|0)[2-9]\\d{1}\\d{7}$/,\"es-CR\":/^(\\+506)?[2-8]\\d{7}$/,\"es-CU\":/^(\\+53|0053)?5\\d{7}$/,\"es-DO\":/^(\\+?1)?8[024]9\\d{7}$/,\"es-HN\":/^(\\+?504)?[9|8|3|2]\\d{7}$/,\"es-EC\":/^(\\+?593|0)([2-7]|9[2-9])\\d{7}$/,\"es-ES\":/^(\\+?34)?[6|7]\\d{8}$/,\"es-GT\":/^(\\+?502)?[2|6|7]\\d{7}$/,\"es-PE\":/^(\\+?51)?9\\d{8}$/,\"es-MX\":/^(\\+?52)?(1|01)?\\d{10,11}$/,\"es-NI\":/^(\\+?505)\\d{7,8}$/,\"es-PA\":/^(\\+?507)\\d{7,8}$/,\"es-PY\":/^(\\+?595|0)9[9876]\\d{7}$/,\"es-SV\":/^(\\+?503)?[67]\\d{7}$/,\"es-UY\":/^(\\+598|0)9[1-9][\\d]{6}$/,\"es-VE\":/^(\\+?58)?(2|4)\\d{9}$/,\"et-EE\":/^(\\+?372)?\\s?(5|8[1-4])\\s?([0-9]\\s?){6,7}$/,\"fa-IR\":/^(\\+?98[\\-\\s]?|0)9[0-39]\\d[\\-\\s]?\\d{3}[\\-\\s]?\\d{4}$/,\"fi-FI\":/^(\\+?358|0)\\s?(4[0-6]|50)\\s?(\\d\\s?){4,8}$/,\"fj-FJ\":/^(\\+?679)?\\s?\\d{3}\\s?\\d{4}$/,\"fo-FO\":/^(\\+?298)?\\s?\\d{2}\\s?\\d{2}\\s?\\d{2}$/,\"fr-BF\":/^(\\+226|0)[67]\\d{7}$/,\"fr-BJ\":/^(\\+229)\\d{8}$/,\"fr-CD\":/^(\\+?243|0)?(8|9)\\d{8}$/,\"fr-CM\":/^(\\+?237)6[0-9]{8}$/,\"fr-FR\":/^(\\+?33|0)[67]\\d{8}$/,\"fr-GF\":/^(\\+?594|0|00594)[67]\\d{8}$/,\"fr-GP\":/^(\\+?590|0|00590)[67]\\d{8}$/,\"fr-MQ\":/^(\\+?596|0|00596)[67]\\d{8}$/,\"fr-PF\":/^(\\+?689)?8[789]\\d{6}$/,\"fr-RE\":/^(\\+?262|0|00262)[67]\\d{8}$/,\"fr-WF\":/^(\\+681)?\\d{6}$/,\"he-IL\":/^(\\+972|0)([23489]|5[012345689]|77)[1-9]\\d{6}$/,\"hu-HU\":/^(\\+?36|06)(20|30|31|50|70)\\d{7}$/,\"id-ID\":/^(\\+?62|0)8(1[123456789]|2[1238]|3[1238]|5[12356789]|7[78]|9[56789]|8[123456789])([\\s?|\\d]{5,11})$/,\"ir-IR\":/^(\\+98|0)?9\\d{9}$/,\"it-IT\":/^(\\+?39)?\\s?3\\d{2} ?\\d{6,7}$/,\"it-SM\":/^((\\+378)|(0549)|(\\+390549)|(\\+3780549))?6\\d{5,9}$/,\"ja-JP\":/^(\\+81[ \\-]?(\\(0\\))?|0)[6789]0[ \\-]?\\d{4}[ \\-]?\\d{4}$/,\"ka-GE\":/^(\\+?995)?(79\\d{7}|5\\d{8})$/,\"kk-KZ\":/^(\\+?7|8)?7\\d{9}$/,\"kl-GL\":/^(\\+?299)?\\s?\\d{2}\\s?\\d{2}\\s?\\d{2}$/,\"ko-KR\":/^((\\+?82)[ \\-]?)?0?1([0|1|6|7|8|9]{1})[ \\-]?\\d{3,4}[ \\-]?\\d{4}$/,\"ky-KG\":/^(\\+996\\s?)?(22[0-9]|50[0-9]|55[0-9]|70[0-9]|75[0-9]|77[0-9]|880|990|995|996|997|998)\\s?\\d{3}\\s?\\d{3}$/,\"lt-LT\":/^(\\+370|8)\\d{8}$/,\"lv-LV\":/^(\\+?371)2\\d{7}$/,\"mg-MG\":/^((\\+?261|0)(2|3)\\d)?\\d{7}$/,\"mn-MN\":/^(\\+|00|011)?976(77|81|88|91|94|95|96|99)\\d{6}$/,\"my-MM\":/^(\\+?959|09|9)(2[5-7]|3[1-2]|4[0-5]|6[6-9]|7[5-9]|9[6-9])[0-9]{7}$/,\"ms-MY\":/^(\\+?60|0)1(([0145](-|\\s)?\\d{7,8})|([236-9](-|\\s)?\\d{7}))$/,\"mz-MZ\":/^(\\+?258)?8[234567]\\d{7}$/,\"nb-NO\":/^(\\+?47)?[49]\\d{7}$/,\"ne-NP\":/^(\\+?977)?9[78]\\d{8}$/,\"nl-BE\":/^(\\+?32|0)4\\d{8}$/,\"nl-NL\":/^(((\\+|00)?31\\(0\\))|((\\+|00)?31)|0)6{1}\\d{8}$/,\"nl-AW\":/^(\\+)?297(56|59|64|73|74|99)\\d{5}$/,\"nn-NO\":/^(\\+?47)?[49]\\d{7}$/,\"pl-PL\":/^(\\+?48)? ?([5-8]\\d|45) ?\\d{3} ?\\d{2} ?\\d{2}$/,\"pt-BR\":/^((\\+?55\\ ?[1-9]{2}\\ ?)|(\\+?55\\ ?\\([1-9]{2}\\)\\ ?)|(0[1-9]{2}\\ ?)|(\\([1-9]{2}\\)\\ ?)|([1-9]{2}\\ ?))((\\d{4}\\-?\\d{4})|(9[1-9]{1}\\d{3}\\-?\\d{4}))$/,\"pt-PT\":/^(\\+?351)?9[1236]\\d{7}$/,\"pt-AO\":/^(\\+?244)?9\\d{8}$/,\"ro-MD\":/^(\\+?373|0)((6(0|1|2|6|7|8|9))|(7(6|7|8|9)))\\d{6}$/,\"ro-RO\":/^(\\+?40|0)\\s?7\\d{2}(\\/|\\s|\\.|-)?\\d{3}(\\s|\\.|-)?\\d{3}$/,\"ru-RU\":/^(\\+?7|8)?9\\d{9}$/,\"si-LK\":/^(?:0|94|\\+94)?(7(0|1|2|4|5|6|7|8)( |-)?)\\d{7}$/,\"sl-SI\":/^(\\+386\\s?|0)(\\d{1}\\s?\\d{3}\\s?\\d{2}\\s?\\d{2}|\\d{2}\\s?\\d{3}\\s?\\d{3})$/,\"sk-SK\":/^(\\+?421)? ?[1-9][0-9]{2} ?[0-9]{3} ?[0-9]{3}$/,\"so-SO\":/^(\\+?252|0)((6[0-9])\\d{7}|(7[1-9])\\d{7})$/,\"sq-AL\":/^(\\+355|0)6[2-9]\\d{7}$/,\"sr-RS\":/^(\\+3816|06)[- \\d]{5,9}$/,\"sv-SE\":/^(\\+?46|0)[\\s\\-]?7[\\s\\-]?[02369]([\\s\\-]?\\d){7}$/,\"tg-TJ\":/^(\\+?992)?[5][5]\\d{7}$/,\"th-TH\":/^(\\+66|66|0)\\d{9}$/,\"tr-TR\":/^(\\+?90|0)?5\\d{9}$/,\"tk-TM\":/^(\\+993|993|8)\\d{8}$/,\"uk-UA\":/^(\\+?38)?0(50|6[36-8]|7[357]|9[1-9])\\d{7}$/,\"uz-UZ\":/^(\\+?998)?(6[125-79]|7[1-69]|88|9\\d)\\d{7}$/,\"vi-VN\":/^((\\+?84)|0)((3([2-9]))|(5([25689]))|(7([0|6-9]))|(8([1-9]))|(9([0-9])))([0-9]{7})$/,\"zh-CN\":/^((\\+|00)86)?(1[3-9]|9[28])\\d{9}$/,\"zh-TW\":/^(\\+?886\\-?|0)?9\\d{8}$/,\"dz-BT\":/^(\\+?975|0)?(17|16|77|02)\\d{6}$/,\"ar-YE\":/^(((\\+|00)9677|0?7)[0137]\\d{7}|((\\+|00)967|0)[1-7]\\d{6})$/,\"ar-EH\":/^(\\+?212|0)[\\s\\-]?(5288|5289)[\\s\\-]?\\d{5}$/,\"fa-AF\":/^(\\+93|0)?(2{1}[0-8]{1}|[3-5]{1}[0-4]{1})(\\d{7})$/,\"mk-MK\":/^(\\+?389|0)?((?:2[2-9]\\d{6}|(?:3[1-4]|4[2-8])\\d{6}|500\\d{5}|5[2-9]\\d{6}|7[0-9][2-9]\\d{5}|8[1-9]\\d{6}|800\\d{5}|8009\\d{4}))$/};C[\"en-CA\"]=C[\"en-US\"],C[\"fr-CA\"]=C[\"en-CA\"],C[\"fr-BE\"]=C[\"nl-BE\"],C[\"zh-HK\"]=C[\"en-HK\"],C[\"zh-MO\"]=C[\"en-MO\"],C[\"ga-IE\"]=C[\"en-IE\"],C[\"fr-CH\"]=C[\"de-CH\"],C[\"it-CH\"]=C[\"fr-CH\"];var E=Object.keys(C),Pe=/^(0x)[0-9a-f]{40}$/i;var He={symbol:\"$\",require_symbol:!1,allow_space_after_symbol:!1,symbol_after_digits:!1,allow_negatives:!0,parens_for_negatives:!1,negative_sign_before_digits:!1,negative_sign_after_digits:!1,allow_negative_sign_placeholder:!1,thousands_separator:\",\",decimal_separator:\".\",allow_decimal:!0,require_decimal:!1,digits_after_decimal:[2],allow_space_after_digits:!1};var _e=/^(bc1|tb1|bc1p|tb1p)[ac-hj-np-z02-9]{39,58}$/,Ue=/^(1|2|3|m)[A-HJ-NP-Za-km-z1-9]{25,39}$/;var we=/^[A-Z]{3}(U[0-9]{7})|([J,Z][0-9]{6,7})$/,Ke=/^[0-9]$/;function ye(t){if(f(t),t=t.toUpperCase(),!we.test(t))return!1;if(11!==t.length)return!0;for(var e,r=0,n=0;n<t.length-1;n++)Ke.test(t[n])?r+=t[n]*Math.pow(2,n):r+=((e=t.charCodeAt(n)-55)<11?e:11<=e&&e<=20?12+e%11:21<=e&&e<=30?23+e%21:34+e%31)*Math.pow(2,n);var a=r%11;return 10===a&&(a=0),Number(t[t.length-1])===a}var xe=ye,We=new Set([\"aa\",\"ab\",\"ae\",\"af\",\"ak\",\"am\",\"an\",\"ar\",\"as\",\"av\",\"ay\",\"az\",\"az\",\"ba\",\"be\",\"bg\",\"bh\",\"bi\",\"bm\",\"bn\",\"bo\",\"br\",\"bs\",\"ca\",\"ce\",\"ch\",\"co\",\"cr\",\"cs\",\"cu\",\"cv\",\"cy\",\"da\",\"de\",\"dv\",\"dz\",\"ee\",\"el\",\"en\",\"eo\",\"es\",\"et\",\"eu\",\"fa\",\"ff\",\"fi\",\"fj\",\"fo\",\"fr\",\"fy\",\"ga\",\"gd\",\"gl\",\"gn\",\"gu\",\"gv\",\"ha\",\"he\",\"hi\",\"ho\",\"hr\",\"ht\",\"hu\",\"hy\",\"hz\",\"ia\",\"id\",\"ie\",\"ig\",\"ii\",\"ik\",\"io\",\"is\",\"it\",\"iu\",\"ja\",\"jv\",\"ka\",\"kg\",\"ki\",\"kj\",\"kk\",\"kl\",\"km\",\"kn\",\"ko\",\"kr\",\"ks\",\"ku\",\"kv\",\"kw\",\"ky\",\"la\",\"lb\",\"lg\",\"li\",\"ln\",\"lo\",\"lt\",\"lu\",\"lv\",\"mg\",\"mh\",\"mi\",\"mk\",\"ml\",\"mn\",\"mr\",\"ms\",\"mt\",\"my\",\"na\",\"nb\",\"nd\",\"ne\",\"ng\",\"nl\",\"nn\",\"no\",\"nr\",\"nv\",\"ny\",\"oc\",\"oj\",\"om\",\"or\",\"os\",\"pa\",\"pi\",\"pl\",\"ps\",\"pt\",\"qu\",\"rm\",\"rn\",\"ro\",\"ru\",\"rw\",\"sa\",\"sc\",\"sd\",\"se\",\"sg\",\"si\",\"sk\",\"sl\",\"sm\",\"sn\",\"so\",\"sq\",\"sr\",\"ss\",\"st\",\"su\",\"sv\",\"sw\",\"ta\",\"te\",\"tg\",\"th\",\"ti\",\"tk\",\"tl\",\"tn\",\"to\",\"tr\",\"ts\",\"tt\",\"tw\",\"ty\",\"ug\",\"uk\",\"ur\",\"uz\",\"ve\",\"vi\",\"vo\",\"wa\",\"wo\",\"xh\",\"yi\",\"yo\",\"za\",\"zh\",\"zu\"]);var ke=/^([\\+-]?\\d{4}(?!\\d{2}\\b))((-?)((0[1-9]|1[0-2])(\\3([12]\\d|0[1-9]|3[01]))?|W([0-4]\\d|5[0-3])(-?[1-7])?|(00[1-9]|0[1-9]\\d|[12]\\d{2}|3([0-5]\\d|6[1-6])))([T\\s]((([01]\\d|2[0-3])((:?)[0-5]\\d)?|24:?00)([\\.,]\\d+(?!:))?)?(\\17[0-5]\\d([\\.,]\\d+)?)?([zZ]|([\\+-])([01]\\d|2[0-3]):?([0-5]\\d)?)?)?)?$/,Ye=/^([\\+-]?\\d{4}(?!\\d{2}\\b))((-?)((0[1-9]|1[0-2])(\\3([12]\\d|0[1-9]|3[01]))?|W([0-4]\\d|5[0-3])(-?[1-7])?|(00[1-9]|0[1-9]\\d|[12]\\d{2}|3([0-5]\\d|6[1-6])))([T]((([01]\\d|2[0-3])((:?)[0-5]\\d)?|24:?00)([\\.,]\\d+(?!:))?)?(\\17[0-5]\\d([\\.,]\\d+)?)?([zZ]|([\\+-])([01]\\d|2[0-3]):?([0-5]\\d)?)?)?)?$/;var D=/([01][0-9]|2[0-3])/,T=/[0-5][0-9]/,b=new RegExp(\"[-+]\".concat(D.source,\":\").concat(T.source)),b=new RegExp(\"([zZ]|\".concat(b.source,\")\")),D=new RegExp(\"\".concat(D.source,\":\").concat(T.source,\":\").concat(/([0-5][0-9]|60)/.source).concat(/(\\.[0-9]+)?/.source)),T=new RegExp(\"\".concat(/[0-9]{4}/.source,\"-\").concat(/(0[1-9]|1[0-2])/.source,\"-\").concat(/([12]\\d|0[1-9]|3[01])/.source)),D=new RegExp(\"\".concat(D.source).concat(b.source)),Ve=new RegExp(\"^\".concat(T.source,\"[ tT]\").concat(D.source,\"$\"));var ze=new Set([\"Adlm\",\"Afak\",\"Aghb\",\"Ahom\",\"Arab\",\"Aran\",\"Armi\",\"Armn\",\"Avst\",\"Bali\",\"Bamu\",\"Bass\",\"Batk\",\"Beng\",\"Bhks\",\"Blis\",\"Bopo\",\"Brah\",\"Brai\",\"Bugi\",\"Buhd\",\"Cakm\",\"Cans\",\"Cari\",\"Cham\",\"Cher\",\"Chis\",\"Chrs\",\"Cirt\",\"Copt\",\"Cpmn\",\"Cprt\",\"Cyrl\",\"Cyrs\",\"Deva\",\"Diak\",\"Dogr\",\"Dsrt\",\"Dupl\",\"Egyd\",\"Egyh\",\"Egyp\",\"Elba\",\"Elym\",\"Ethi\",\"Gara\",\"Geok\",\"Geor\",\"Glag\",\"Gong\",\"Gonm\",\"Goth\",\"Gran\",\"Grek\",\"Gujr\",\"Gukh\",\"Guru\",\"Hanb\",\"Hang\",\"Hani\",\"Hano\",\"Hans\",\"Hant\",\"Hatr\",\"Hebr\",\"Hira\",\"Hluw\",\"Hmng\",\"Hmnp\",\"Hrkt\",\"Hung\",\"Inds\",\"Ital\",\"Jamo\",\"Java\",\"Jpan\",\"Jurc\",\"Kali\",\"Kana\",\"Kawi\",\"Khar\",\"Khmr\",\"Khoj\",\"Kitl\",\"Kits\",\"Knda\",\"Kore\",\"Kpel\",\"Krai\",\"Kthi\",\"Lana\",\"Laoo\",\"Latf\",\"Latg\",\"Latn\",\"Leke\",\"Lepc\",\"Limb\",\"Lina\",\"Linb\",\"Lisu\",\"Loma\",\"Lyci\",\"Lydi\",\"Mahj\",\"Maka\",\"Mand\",\"Mani\",\"Marc\",\"Maya\",\"Medf\",\"Mend\",\"Merc\",\"Mero\",\"Mlym\",\"Modi\",\"Mong\",\"Moon\",\"Mroo\",\"Mtei\",\"Mult\",\"Mymr\",\"Nagm\",\"Nand\",\"Narb\",\"Nbat\",\"Newa\",\"Nkdb\",\"Nkgb\",\"Nkoo\",\"Nshu\",\"Ogam\",\"Olck\",\"Onao\",\"Orkh\",\"Orya\",\"Osge\",\"Osma\",\"Ougr\",\"Palm\",\"Pauc\",\"Pcun\",\"Pelm\",\"Perm\",\"Phag\",\"Phli\",\"Phlp\",\"Phlv\",\"Phnx\",\"Plrd\",\"Piqd\",\"Prti\",\"Psin\",\"Qaaa\",\"Qaab\",\"Qaac\",\"Qaad\",\"Qaae\",\"Qaaf\",\"Qaag\",\"Qaah\",\"Qaai\",\"Qaaj\",\"Qaak\",\"Qaal\",\"Qaam\",\"Qaan\",\"Qaao\",\"Qaap\",\"Qaaq\",\"Qaar\",\"Qaas\",\"Qaat\",\"Qaau\",\"Qaav\",\"Qaaw\",\"Qaax\",\"Qaay\",\"Qaaz\",\"Qaba\",\"Qabb\",\"Qabc\",\"Qabd\",\"Qabe\",\"Qabf\",\"Qabg\",\"Qabh\",\"Qabi\",\"Qabj\",\"Qabk\",\"Qabl\",\"Qabm\",\"Qabn\",\"Qabo\",\"Qabp\",\"Qabq\",\"Qabr\",\"Qabs\",\"Qabt\",\"Qabu\",\"Qabv\",\"Qabw\",\"Qabx\",\"Ranj\",\"Rjng\",\"Rohg\",\"Roro\",\"Runr\",\"Samr\",\"Sara\",\"Sarb\",\"Saur\",\"Sgnw\",\"Shaw\",\"Shrd\",\"Shui\",\"Sidd\",\"Sidt\",\"Sind\",\"Sinh\",\"Sogd\",\"Sogo\",\"Sora\",\"Soyo\",\"Sund\",\"Sunu\",\"Sylo\",\"Syrc\",\"Syre\",\"Syrj\",\"Syrn\",\"Tagb\",\"Takr\",\"Tale\",\"Talu\",\"Taml\",\"Tang\",\"Tavt\",\"Tayo\",\"Telu\",\"Teng\",\"Tfng\",\"Tglg\",\"Thaa\",\"Thai\",\"Tibt\",\"Tirh\",\"Tnsa\",\"Todr\",\"Tols\",\"Toto\",\"Tutg\",\"Ugar\",\"Vaii\",\"Visp\",\"Vith\",\"Wara\",\"Wcho\",\"Wole\",\"Xpeo\",\"Xsux\",\"Yezi\",\"Yiii\",\"Zanb\",\"Zinh\",\"Zmth\",\"Zsye\",\"Zsym\",\"Zxxx\",\"Zyyy\",\"Zzzz\"]);var Qe=new Set([\"AFG\",\"ALA\",\"ALB\",\"DZA\",\"ASM\",\"AND\",\"AGO\",\"AIA\",\"ATA\",\"ATG\",\"ARG\",\"ARM\",\"ABW\",\"AUS\",\"AUT\",\"AZE\",\"BHS\",\"BHR\",\"BGD\",\"BRB\",\"BLR\",\"BEL\",\"BLZ\",\"BEN\",\"BMU\",\"BTN\",\"BOL\",\"BES\",\"BIH\",\"BWA\",\"BVT\",\"BRA\",\"IOT\",\"BRN\",\"BGR\",\"BFA\",\"BDI\",\"KHM\",\"CMR\",\"CAN\",\"CPV\",\"CYM\",\"CAF\",\"TCD\",\"CHL\",\"CHN\",\"CXR\",\"CCK\",\"COL\",\"COM\",\"COG\",\"COD\",\"COK\",\"CRI\",\"CIV\",\"HRV\",\"CUB\",\"CUW\",\"CYP\",\"CZE\",\"DNK\",\"DJI\",\"DMA\",\"DOM\",\"ECU\",\"EGY\",\"SLV\",\"GNQ\",\"ERI\",\"EST\",\"ETH\",\"FLK\",\"FRO\",\"FJI\",\"FIN\",\"FRA\",\"GUF\",\"PYF\",\"ATF\",\"GAB\",\"GMB\",\"GEO\",\"DEU\",\"GHA\",\"GIB\",\"GRC\",\"GRL\",\"GRD\",\"GLP\",\"GUM\",\"GTM\",\"GGY\",\"GIN\",\"GNB\",\"GUY\",\"HTI\",\"HMD\",\"VAT\",\"HND\",\"HKG\",\"HUN\",\"ISL\",\"IND\",\"IDN\",\"IRN\",\"IRQ\",\"IRL\",\"IMN\",\"ISR\",\"ITA\",\"JAM\",\"JPN\",\"JEY\",\"JOR\",\"KAZ\",\"KEN\",\"KIR\",\"PRK\",\"KOR\",\"KWT\",\"KGZ\",\"LAO\",\"LVA\",\"LBN\",\"LSO\",\"LBR\",\"LBY\",\"LIE\",\"LTU\",\"LUX\",\"MAC\",\"MKD\",\"MDG\",\"MWI\",\"MYS\",\"MDV\",\"MLI\",\"MLT\",\"MHL\",\"MTQ\",\"MRT\",\"MUS\",\"MYT\",\"MEX\",\"FSM\",\"MDA\",\"MCO\",\"MNG\",\"MNE\",\"MSR\",\"MAR\",\"MOZ\",\"MMR\",\"NAM\",\"NRU\",\"NPL\",\"NLD\",\"NCL\",\"NZL\",\"NIC\",\"NER\",\"NGA\",\"NIU\",\"NFK\",\"MNP\",\"NOR\",\"OMN\",\"PAK\",\"PLW\",\"PSE\",\"PAN\",\"PNG\",\"PRY\",\"PER\",\"PHL\",\"PCN\",\"POL\",\"PRT\",\"PRI\",\"QAT\",\"REU\",\"ROU\",\"RUS\",\"RWA\",\"BLM\",\"SHN\",\"KNA\",\"LCA\",\"MAF\",\"SPM\",\"VCT\",\"WSM\",\"SMR\",\"STP\",\"SAU\",\"SEN\",\"SRB\",\"SYC\",\"SLE\",\"SGP\",\"SXM\",\"SVK\",\"SVN\",\"SLB\",\"SOM\",\"ZAF\",\"SGS\",\"SSD\",\"ESP\",\"LKA\",\"SDN\",\"SUR\",\"SJM\",\"SWZ\",\"SWE\",\"CHE\",\"SYR\",\"TWN\",\"TJK\",\"TZA\",\"THA\",\"TLS\",\"TGO\",\"TKL\",\"TON\",\"TTO\",\"TUN\",\"TUR\",\"TKM\",\"TCA\",\"TUV\",\"UGA\",\"UKR\",\"ARE\",\"GBR\",\"USA\",\"UMI\",\"URY\",\"UZB\",\"VUT\",\"VEN\",\"VNM\",\"VGB\",\"VIR\",\"WLF\",\"ESH\",\"YEM\",\"ZMB\",\"ZWE\"]);var je=new Set([\"004\",\"008\",\"010\",\"012\",\"016\",\"020\",\"024\",\"028\",\"031\",\"032\",\"036\",\"040\",\"044\",\"048\",\"050\",\"051\",\"052\",\"056\",\"060\",\"064\",\"068\",\"070\",\"072\",\"074\",\"076\",\"084\",\"086\",\"090\",\"092\",\"096\",\"100\",\"104\",\"108\",\"112\",\"116\",\"120\",\"124\",\"132\",\"136\",\"140\",\"144\",\"148\",\"152\",\"156\",\"158\",\"162\",\"166\",\"170\",\"174\",\"175\",\"178\",\"180\",\"184\",\"188\",\"191\",\"192\",\"196\",\"203\",\"204\",\"208\",\"212\",\"214\",\"218\",\"222\",\"226\",\"231\",\"232\",\"233\",\"234\",\"238\",\"239\",\"242\",\"246\",\"248\",\"250\",\"254\",\"258\",\"260\",\"262\",\"266\",\"268\",\"270\",\"275\",\"276\",\"288\",\"292\",\"296\",\"300\",\"304\",\"308\",\"312\",\"316\",\"320\",\"324\",\"328\",\"332\",\"334\",\"336\",\"340\",\"344\",\"348\",\"352\",\"356\",\"360\",\"364\",\"368\",\"372\",\"376\",\"380\",\"384\",\"388\",\"392\",\"398\",\"400\",\"404\",\"408\",\"410\",\"414\",\"417\",\"418\",\"422\",\"426\",\"428\",\"430\",\"434\",\"438\",\"440\",\"442\",\"446\",\"450\",\"454\",\"458\",\"462\",\"466\",\"470\",\"474\",\"478\",\"480\",\"484\",\"492\",\"496\",\"498\",\"499\",\"500\",\"504\",\"508\",\"512\",\"516\",\"520\",\"524\",\"528\",\"531\",\"533\",\"534\",\"535\",\"540\",\"548\",\"554\",\"558\",\"562\",\"566\",\"570\",\"574\",\"578\",\"580\",\"581\",\"583\",\"584\",\"585\",\"586\",\"591\",\"598\",\"600\",\"604\",\"608\",\"612\",\"616\",\"620\",\"624\",\"626\",\"630\",\"634\",\"638\",\"642\",\"643\",\"646\",\"652\",\"654\",\"659\",\"660\",\"662\",\"663\",\"666\",\"670\",\"674\",\"678\",\"682\",\"686\",\"688\",\"690\",\"694\",\"702\",\"703\",\"704\",\"705\",\"706\",\"710\",\"716\",\"724\",\"728\",\"729\",\"732\",\"740\",\"744\",\"748\",\"752\",\"756\",\"760\",\"762\",\"764\",\"768\",\"772\",\"776\",\"780\",\"784\",\"788\",\"792\",\"795\",\"796\",\"798\",\"800\",\"804\",\"807\",\"818\",\"826\",\"831\",\"832\",\"833\",\"834\",\"840\",\"850\",\"854\",\"858\",\"860\",\"862\",\"876\",\"882\",\"887\",\"894\"]);var Je=new Set([\"AED\",\"AFN\",\"ALL\",\"AMD\",\"ANG\",\"AOA\",\"ARS\",\"AUD\",\"AWG\",\"AZN\",\"BAM\",\"BBD\",\"BDT\",\"BGN\",\"BHD\",\"BIF\",\"BMD\",\"BND\",\"BOB\",\"BOV\",\"BRL\",\"BSD\",\"BTN\",\"BWP\",\"BYN\",\"BZD\",\"CAD\",\"CDF\",\"CHE\",\"CHF\",\"CHW\",\"CLF\",\"CLP\",\"CNY\",\"COP\",\"COU\",\"CRC\",\"CUP\",\"CVE\",\"CZK\",\"DJF\",\"DKK\",\"DOP\",\"DZD\",\"EGP\",\"ERN\",\"ETB\",\"EUR\",\"FJD\",\"FKP\",\"GBP\",\"GEL\",\"GHS\",\"GIP\",\"GMD\",\"GNF\",\"GTQ\",\"GYD\",\"HKD\",\"HNL\",\"HTG\",\"HUF\",\"IDR\",\"ILS\",\"INR\",\"IQD\",\"IRR\",\"ISK\",\"JMD\",\"JOD\",\"JPY\",\"KES\",\"KGS\",\"KHR\",\"KMF\",\"KPW\",\"KRW\",\"KWD\",\"KYD\",\"KZT\",\"LAK\",\"LBP\",\"LKR\",\"LRD\",\"LSL\",\"LYD\",\"MAD\",\"MDL\",\"MGA\",\"MKD\",\"MMK\",\"MNT\",\"MOP\",\"MRU\",\"MUR\",\"MVR\",\"MWK\",\"MXN\",\"MXV\",\"MYR\",\"MZN\",\"NAD\",\"NGN\",\"NIO\",\"NOK\",\"NPR\",\"NZD\",\"OMR\",\"PAB\",\"PEN\",\"PGK\",\"PHP\",\"PKR\",\"PLN\",\"PYG\",\"QAR\",\"RON\",\"RSD\",\"RUB\",\"RWF\",\"SAR\",\"SBD\",\"SCR\",\"SDG\",\"SEK\",\"SGD\",\"SHP\",\"SLE\",\"SLL\",\"SOS\",\"SRD\",\"SSP\",\"STN\",\"SVC\",\"SYP\",\"SZL\",\"THB\",\"TJS\",\"TMT\",\"TND\",\"TOP\",\"TRY\",\"TTD\",\"TWD\",\"TZS\",\"UAH\",\"UGX\",\"USD\",\"USN\",\"UYI\",\"UYU\",\"UYW\",\"UZS\",\"VED\",\"VES\",\"VND\",\"VUV\",\"WST\",\"XAF\",\"XAG\",\"XAU\",\"XBA\",\"XBB\",\"XBC\",\"XBD\",\"XCD\",\"XDR\",\"XOF\",\"XPD\",\"XPF\",\"XPT\",\"XSU\",\"XTS\",\"XUA\",\"XXX\",\"YER\",\"ZAR\",\"ZMW\",\"ZWL\"]);var Xe=/^[A-Z2-7]+=*$/,qe=/^[A-HJKMNP-TV-Z0-9]+$/,tr={crockford:!1};var er=/^[A-HJ-NP-Za-km-z1-9]*$/;var rr=/^[a-z]+\\/[a-z0-9\\-\\+\\._]+$/i,nr=/^[a-z\\-]+=[a-z0-9\\-]+$/i,ar=/^[a-z0-9!\\$&'\\(\\)\\*\\+,;=\\-\\._~:@\\/\\?%\\s]*$/i;var ir=/(?:^magnet:\\?|[^?&]&)xt(?:\\.1)?=urn:(?:(?:aich|bitprint|btih|ed2k|ed2khash|kzhash|md5|sha1|tree:tiger):[a-z0-9]{32}(?:[a-z0-9]{8})?|btmh:1220[a-z0-9]{64})(?:$|&)/i;function or(t,e){if(f(t),e)return e=new RegExp(\"[\".concat(e.replace(/[.*+?^${}()|[\\]\\\\]/g,\"\\\\$&\"),\"]+$\"),\"g\"),t.replace(e,\"\");for(var r=t.length-1;/\\s/.test(t.charAt(r));)--r;return t.slice(0,r+1)}function sr(t,e){f(t);e=e?new RegExp(\"^[\".concat(e.replace(/[.*+?^${}()|[\\]\\\\]/g,\"\\\\$&\"),\"]+\"),\"g\"):/^\\s+/g;return t.replace(e,\"\")}function cr(t,e){return or(sr(t,e),e)}var ur=/^(application|audio|font|image|message|model|multipart|text|video)\\/[a-zA-Z0-9\\.\\-\\+_]{1,100}$/i,lr=/^text\\/[a-zA-Z0-9\\.\\-\\+]{1,100};\\s?charset=(\"[a-zA-Z0-9\\.\\-\\+\\s]{0,70}\"|[a-zA-Z0-9\\.\\-\\+]{0,70})(\\s?\\([a-zA-Z0-9\\.\\-\\+\\s]{1,20}\\))?$/i,dr=/^multipart\\/[a-zA-Z0-9\\.\\-\\+]{1,100}(;\\s?(boundary|charset)=(\"[a-zA-Z0-9\\.\\-\\+\\s]{0,70}\"|[a-zA-Z0-9\\.\\-\\+]{0,70})(\\s?\\([a-zA-Z0-9\\.\\-\\+\\s]{1,20}\\))?){0,2}$/i;var fr=/^\\(?[+-]?(90(\\.0+)?|[1-8]?\\d(\\.\\d+)?)$/,Ar=/^\\s?[+-]?(180(\\.0+)?|1[0-7]\\d(\\.\\d+)?|\\d{1,2}(\\.\\d+)?)\\)?$/,$r=/^(([1-8]?\\d)\\D+([1-5]?\\d|60)\\D+([1-5]?\\d|60)(\\.\\d+)?|90\\D+0\\D+0)\\D+[NSns]?$/i,pr=/^\\s*([1-7]?\\d{1,2}\\D+([1-5]?\\d|60)\\D+([1-5]?\\d|60)(\\.\\d+)?|180\\D+0\\D+0)\\D+[EWew]?$/i,hr={checkDMS:!1};var b=/^\\d{3}$/,T=/^\\d{4}$/,D=/^\\d{5}$/,gr=/^\\d{6}$/,G={AD:/^AD\\d{3}$/,AT:T,AU:T,AZ:/^AZ\\d{4}$/,BA:/^([7-8]\\d{4}$)/,BD:/^([1-8][0-9]{3}|9[0-4][0-9]{2})$/,BE:T,BG:T,BR:/^\\d{5}-?\\d{3}$/,BY:/^2[1-4]\\d{4}$/,CA:/^[ABCEGHJKLMNPRSTVXY]\\d[ABCEGHJ-NPRSTV-Z][\\s\\-]?\\d[ABCEGHJ-NPRSTV-Z]\\d$/i,CH:T,CN:/^(0[1-7]|1[012356]|2[0-7]|3[0-6]|4[0-7]|5[1-7]|6[1-7]|7[1-5]|8[1345]|9[09])\\d{4}$/,CO:/^(05|08|11|13|15|17|18|19|20|23|25|27|41|44|47|50|52|54|63|66|68|70|73|76|81|85|86|88|91|94|95|97|99)(\\d{4})$/,CZ:/^\\d{3}\\s?\\d{2}$/,DE:D,DK:T,DO:D,DZ:D,EE:D,ES:/^(5[0-2]{1}|[0-4]{1}\\d{1})\\d{3}$/,FI:D,FR:/^(?:(?:0[1-9]|[1-8]\\d|9[0-5])\\d{3}|97[1-46]\\d{2})$/,GB:/^(gir\\s?0aa|[a-z]{1,2}\\d[\\da-z]?\\s?(\\d[a-z]{2})?)$/i,GR:/^\\d{3}\\s?\\d{2}$/,HR:/^([1-5]\\d{4}$)/,HT:/^HT\\d{4}$/,HU:T,ID:D,IE:/^(?!.*(?:o))[A-Za-z]\\d[\\dw]\\s\\w{4}$/i,IL:/^(\\d{5}|\\d{7})$/,IN:/^((?!10|29|35|54|55|65|66|86|87|88|89)[1-9][0-9]{5})$/,IR:/^(?!(\\d)\\1{3})[13-9]{4}[1346-9][013-9]{5}$/,IS:b,IT:D,JP:/^\\d{3}\\-\\d{4}$/,KE:D,KR:/^(\\d{5}|\\d{6})$/,LI:/^(948[5-9]|949[0-7])$/,LT:/^LT\\-\\d{5}$/,LU:T,LV:/^LV\\-\\d{4}$/,LK:D,MG:b,MX:D,MT:/^[A-Za-z]{3}\\s{0,1}\\d{4}$/,MY:D,NL:/^[1-9]\\d{3}\\s?(?!sa|sd|ss)[a-z]{2}$/i,NO:T,NP:/^(10|21|22|32|33|34|44|45|56|57)\\d{3}$|^(977)$/i,NZ:T,PK:D,PL:/^\\d{2}\\-\\d{3}$/,PR:/^00[679]\\d{2}([ -]\\d{4})?$/,PT:/^\\d{4}\\-\\d{3}?$/,RO:gr,RU:gr,SA:D,SE:/^[1-9]\\d{2}\\s?\\d{2}$/,SG:gr,SI:T,SK:/^\\d{3}\\s?\\d{2}$/,TH:D,TN:T,TW:/^\\d{3}(\\d{2,3})?$/,UA:D,US:/^\\d{5}(-\\d{4})?$/,ZA:T,ZM:D},b=Object.keys(G);function Sr(t,e){return f(t),t.replace(new RegExp(\"[\".concat(e,\"]+\"),\"g\"),\"\")}var mr={all_lowercase:!0,gmail_lowercase:!0,gmail_remove_dots:!0,gmail_remove_subaddress:!0,gmail_convert_googlemaildotcom:!0,outlookdotcom_lowercase:!0,outlookdotcom_remove_subaddress:!0,yahoo_lowercase:!0,yahoo_remove_subaddress:!0,yandex_lowercase:!0,yandex_convert_yandexru:!0,icloud_lowercase:!0,icloud_remove_subaddress:!0},Zr=[\"icloud.com\",\"me.com\"],Er=[\"hotmail.at\",\"hotmail.be\",\"hotmail.ca\",\"hotmail.cl\",\"hotmail.co.il\",\"hotmail.co.nz\",\"hotmail.co.th\",\"hotmail.co.uk\",\"hotmail.com\",\"hotmail.com.ar\",\"hotmail.com.au\",\"hotmail.com.br\",\"hotmail.com.gr\",\"hotmail.com.mx\",\"hotmail.com.pe\",\"hotmail.com.tr\",\"hotmail.com.vn\",\"hotmail.cz\",\"hotmail.de\",\"hotmail.dk\",\"hotmail.es\",\"hotmail.fr\",\"hotmail.hu\",\"hotmail.id\",\"hotmail.ie\",\"hotmail.in\",\"hotmail.it\",\"hotmail.jp\",\"hotmail.kr\",\"hotmail.lv\",\"hotmail.my\",\"hotmail.ph\",\"hotmail.pt\",\"hotmail.sa\",\"hotmail.sg\",\"hotmail.sk\",\"live.be\",\"live.co.uk\",\"live.com\",\"live.com.ar\",\"live.com.mx\",\"live.de\",\"live.es\",\"live.eu\",\"live.fr\",\"live.it\",\"live.nl\",\"msn.com\",\"outlook.at\",\"outlook.be\",\"outlook.cl\",\"outlook.co.il\",\"outlook.co.nz\",\"outlook.co.th\",\"outlook.com\",\"outlook.com.ar\",\"outlook.com.au\",\"outlook.com.br\",\"outlook.com.gr\",\"outlook.com.pe\",\"outlook.com.tr\",\"outlook.com.vn\",\"outlook.cz\",\"outlook.de\",\"outlook.dk\",\"outlook.es\",\"outlook.fr\",\"outlook.hu\",\"outlook.id\",\"outlook.ie\",\"outlook.in\",\"outlook.it\",\"outlook.jp\",\"outlook.kr\",\"outlook.lv\",\"outlook.my\",\"outlook.ph\",\"outlook.pt\",\"outlook.sa\",\"outlook.sg\",\"outlook.sk\",\"passport.com\"],Ir=[\"rocketmail.com\",\"yahoo.ca\",\"yahoo.co.uk\",\"yahoo.com\",\"yahoo.de\",\"yahoo.fr\",\"yahoo.in\",\"yahoo.it\",\"ymail.com\"],Rr=[\"yandex.ru\",\"yandex.ua\",\"yandex.kz\",\"yandex.com\",\"yandex.by\",\"ya.ru\"];function vr(t){return 1<t.length?t:\"\"}var Lr=/^[^\\s-_](?!.*?[-_]{2,})[a-z0-9-\\\\][^\\s]*[^-_\\s]$/;var O={\"cs-CZ\":function(t){return/^(([ABCDEFHIJKLMNPRSTUVXYZ]|[0-9])-?){5,8}$/.test(t)},\"de-DE\":function(t){return/^((A|AA|AB|AC|AE|AH|AK|AM|AN|AÖ|AP|AS|AT|AU|AW|AZ|B|BA|BB|BC|BE|BF|BH|BI|BK|BL|BM|BN|BO|BÖ|BS|BT|BZ|C|CA|CB|CE|CO|CR|CW|D|DA|DD|DE|DH|DI|DL|DM|DN|DO|DU|DW|DZ|E|EA|EB|ED|EE|EF|EG|EH|EI|EL|EM|EN|ER|ES|EU|EW|F|FB|FD|FF|FG|FI|FL|FN|FO|FR|FS|FT|FÜ|FW|FZ|G|GA|GC|GD|GE|GF|GG|GI|GK|GL|GM|GN|GÖ|GP|GR|GS|GT|GÜ|GV|GW|GZ|H|HA|HB|HC|HD|HE|HF|HG|HH|HI|HK|HL|HM|HN|HO|HP|HR|HS|HU|HV|HX|HY|HZ|IK|IL|IN|IZ|J|JE|JL|K|KA|KB|KC|KE|KF|KG|KH|KI|KK|KL|KM|KN|KO|KR|KS|KT|KU|KW|KY|L|LA|LB|LC|LD|LF|LG|LH|LI|LL|LM|LN|LÖ|LP|LR|LU|M|MA|MB|MC|MD|ME|MG|MH|MI|MK|ML|MM|MN|MO|MQ|MR|MS|MÜ|MW|MY|MZ|N|NB|ND|NE|NF|NH|NI|NK|NM|NÖ|NP|NR|NT|NU|NW|NY|NZ|OA|OB|OC|OD|OE|OF|OG|OH|OK|OL|OP|OS|OZ|P|PA|PB|PE|PF|PI|PL|PM|PN|PR|PS|PW|PZ|R|RA|RC|RD|RE|RG|RH|RI|RL|RM|RN|RO|RP|RS|RT|RU|RV|RW|RZ|S|SB|SC|SE|SG|SI|SK|SL|SM|SN|SO|SP|SR|ST|SU|SW|SY|SZ|TE|TF|TG|TO|TP|TR|TS|TT|TÜ|ÜB|UE|UH|UL|UM|UN|V|VB|VG|VK|VR|VS|W|WA|WB|WE|WF|WI|WK|WL|WM|WN|WO|WR|WS|WT|WÜ|WW|WZ|Z|ZE|ZI|ZP|ZR|ZW|ZZ)[- ]?[A-Z]{1,2}[- ]?\\d{1,4}|(ABG|ABI|AIB|AIC|ALF|ALZ|ANA|ANG|ANK|APD|ARN|ART|ASL|ASZ|AUR|AZE|BAD|BAR|BBG|BCH|BED|BER|BGD|BGL|BID|BIN|BIR|BIT|BIW|BKS|BLB|BLK|BNA|BOG|BOH|BOR|BOT|BRA|BRB|BRG|BRK|BRL|BRV|BSB|BSK|BTF|BÜD|BUL|BÜR|BÜS|BÜZ|CAS|CHA|CLP|CLZ|COC|COE|CUX|DAH|DAN|DAU|DBR|DEG|DEL|DGF|DIL|DIN|DIZ|DKB|DLG|DON|DUD|DÜW|EBE|EBN|EBS|ECK|EIC|EIL|EIN|EIS|EMD|EMS|ERB|ERH|ERK|ERZ|ESB|ESW|FDB|FDS|FEU|FFB|FKB|FLÖ|FOR|FRG|FRI|FRW|FTL|FÜS|GAN|GAP|GDB|GEL|GEO|GER|GHA|GHC|GLA|GMN|GNT|GOA|GOH|GRA|GRH|GRI|GRM|GRZ|GTH|GUB|GUN|GVM|HAB|HAL|HAM|HAS|HBN|HBS|HCH|HDH|HDL|HEB|HEF|HEI|HER|HET|HGN|HGW|HHM|HIG|HIP|HMÜ|HOG|HOH|HOL|HOM|HOR|HÖS|HOT|HRO|HSK|HST|HVL|HWI|IGB|ILL|JÜL|KEH|KEL|KEM|KIB|KLE|KLZ|KÖN|KÖT|KÖZ|KRU|KÜN|KUS|KYF|LAN|LAU|LBS|LBZ|LDK|LDS|LEO|LER|LEV|LIB|LIF|LIP|LÖB|LOS|LRO|LSZ|LÜN|LUP|LWL|MAB|MAI|MAK|MAL|MED|MEG|MEI|MEK|MEL|MER|MET|MGH|MGN|MHL|MIL|MKK|MOD|MOL|MON|MOS|MSE|MSH|MSP|MST|MTK|MTL|MÜB|MÜR|MYK|MZG|NAB|NAI|NAU|NDH|NEA|NEB|NEC|NEN|NES|NEW|NMB|NMS|NOH|NOL|NOM|NOR|NVP|NWM|OAL|OBB|OBG|OCH|OHA|ÖHR|OHV|OHZ|OPR|OSL|OVI|OVL|OVP|PAF|PAN|PAR|PCH|PEG|PIR|PLÖ|PRÜ|QFT|QLB|RDG|REG|REH|REI|RID|RIE|ROD|ROF|ROK|ROL|ROS|ROT|ROW|RSL|RÜD|RÜG|SAB|SAD|SAN|SAW|SBG|SBK|SCZ|SDH|SDL|SDT|SEB|SEE|SEF|SEL|SFB|SFT|SGH|SHA|SHG|SHK|SHL|SIG|SIM|SLE|SLF|SLK|SLN|SLS|SLÜ|SLZ|SMÜ|SOB|SOG|SOK|SÖM|SON|SPB|SPN|SRB|SRO|STA|STB|STD|STE|STL|SUL|SÜW|SWA|SZB|TBB|TDO|TET|TIR|TÖL|TUT|UEM|UER|UFF|USI|VAI|VEC|VER|VIB|VIE|VIT|VOH|WAF|WAK|WAN|WAR|WAT|WBS|WDA|WEL|WEN|WER|WES|WHV|WIL|WIS|WIT|WIZ|WLG|WMS|WND|WOB|WOH|WOL|WOR|WOS|WRN|WSF|WST|WSW|WTL|WTM|WUG|WÜM|WUN|WUR|WZL|ZEL|ZIG)[- ]?(([A-Z][- ]?\\d{1,4})|([A-Z]{2}[- ]?\\d{1,3})))[- ]?(E|H)?$/.test(t)},\"de-LI\":function(t){return/^FL[- ]?\\d{1,5}[UZ]?$/.test(t)},\"en-IN\":function(t){return/^[A-Z]{2}[ -]?[0-9]{1,2}(?:[ -]?[A-Z])(?:[ -]?[A-Z]*)?[ -]?[0-9]{4}$/.test(t)},\"en-SG\":function(t){return/^[A-Z]{3}[ -]?[\\d]{4}[ -]?[A-Z]{1}$/.test(t)},\"es-AR\":function(t){return/^(([A-Z]{2} ?[0-9]{3} ?[A-Z]{2})|([A-Z]{3} ?[0-9]{3}))$/.test(t)},\"fi-FI\":function(t){return/^(?=.{4,7})(([A-Z]{1,3}|[0-9]{1,3})[\\s-]?([A-Z]{1,3}|[0-9]{1,5}))$/.test(t)},\"hu-HU\":function(t){return/^((((?!AAA)(([A-NPRSTVZWXY]{1})([A-PR-Z]{1})([A-HJ-NPR-Z]))|(A[ABC]I)|A[ABC]O|A[A-W]Q|BPI|BPO|UCO|UDO|XAO)-(?!000)\\d{3})|(M\\d{6})|((CK|DT|CD|HC|H[ABEFIKLMNPRSTVX]|MA|OT|R[A-Z]) \\d{2}-\\d{2})|(CD \\d{3}-\\d{3})|(C-(C|X) \\d{4})|(X-(A|B|C) \\d{4})|(([EPVZ]-\\d{5}))|(S A[A-Z]{2} \\d{2})|(SP \\d{2}-\\d{2}))$/.test(t)},\"pt-BR\":function(t){return/^[A-Z]{3}[ -]?[0-9][A-Z][0-9]{2}|[A-Z]{3}[ -]?[0-9]{4}$/.test(t)},\"pt-PT\":function(t){return/^(([A-Z]{2}[ -·]?[0-9]{2}[ -·]?[0-9]{2})|([0-9]{2}[ -·]?[A-Z]{2}[ -·]?[0-9]{2})|([0-9]{2}[ -·]?[0-9]{2}[ -·]?[A-Z]{2})|([A-Z]{2}[ -·]?[0-9]{2}[ -·]?[A-Z]{2}))$/.test(t)},\"sq-AL\":function(t){return/^[A-Z]{2}[- ]?((\\d{3}[- ]?(([A-Z]{2})|T))|(R[- ]?\\d{3}))$/.test(t)},\"sv-SE\":function(t){return/^[A-HJ-PR-UW-Z]{3} ?[\\d]{2}[A-HJ-PR-UW-Z1-9]$|(^[A-ZÅÄÖ ]{2,7}$)/.test(t.trim())},\"en-PK\":function(t){return/(^[A-Z]{2}((\\s|-){0,1})[0-9]{3,4}((\\s|-)[0-9]{2}){0,1}$)|(^[A-Z]{3}((\\s|-){0,1})[0-9]{3,4}((\\s|-)[0-9]{2}){0,1}$)|(^[A-Z]{4}((\\s|-){0,1})[0-9]{3,4}((\\s|-)[0-9]{2}){0,1}$)|(^[A-Z]((\\s|-){0,1})[0-9]{4}((\\s|-)[0-9]{2}){0,1}$)/.test(t.trim())}};var Mr=/^[A-Z]$/,Br=/^[a-z]$/,Fr=/^[0-9]$/,Nr=/^[-#!$@£%^&*()_+|~=`{}\\[\\]:\";'<>?,.\\/\\\\ ]$/,Cr={minLength:8,minLowercase:1,minUppercase:1,minNumbers:1,minSymbols:1,returnScore:!1,pointsPerUnique:1,pointsPerRepeat:.5,pointsForContainingLower:10,pointsForContainingUpper:10,pointsForContainingNumber:10,pointsForContainingSymbol:10};function Dr(t){e={},Array.from(t).forEach(function(t){e[t]?e[t]+=1:e[t]=1});var e,r=e,n={length:t.length,uniqueChars:Object.keys(r).length,uppercaseCount:0,lowercaseCount:0,numberCount:0,symbolCount:0};return Object.keys(r).forEach(function(t){Mr.test(t)?n.uppercaseCount+=r[t]:Br.test(t)?n.lowercaseCount+=r[t]:Fr.test(t)?n.numberCount+=r[t]:Nr.test(t)&&(n.symbolCount+=r[t])}),n}var Tr={AT:function(t){return/^(AT)?U\\d{8}$/.test(t)},BE:function(t){return/^(BE)?\\d{10}$/.test(t)},BG:function(t){return/^(BG)?\\d{9,10}$/.test(t)},HR:function(t){return/^(HR)?\\d{11}$/.test(t)},CY:function(t){return/^(CY)?\\w{9}$/.test(t)},CZ:function(t){return/^(CZ)?\\d{8,10}$/.test(t)},DK:function(t){return/^(DK)?\\d{8}$/.test(t)},EE:function(t){return/^(EE)?\\d{9}$/.test(t)},FI:function(t){return/^(FI)?\\d{8}$/.test(t)},FR:function(t){return/^(FR)([A-Z0-9]{2}\\d{9})$/.test(t)},DE:function(t){return/^(DE)?\\d{9}$/.test(t)},EL:function(t){return/^(EL)?\\d{9}$/.test(t)},HU:function(t){return/^(HU)?\\d{8}$/.test(t)},IE:function(t){return/^(IE)?\\d{7}\\w{1}(W)?$/.test(t)},IT:function(t){return/^(IT)?\\d{11}$/.test(t)},LV:function(t){return/^(LV)?\\d{11}$/.test(t)},LT:function(t){return/^(LT)?\\d{9,12}$/.test(t)},LU:function(t){return/^(LU)?\\d{8}$/.test(t)},MT:function(t){return/^(MT)?\\d{8}$/.test(t)},NL:function(t){return/^(NL)?\\d{9}B\\d{2}$/.test(t)},PL:function(t){return/^(PL)?(\\d{10}|(\\d{3}-\\d{3}-\\d{2}-\\d{2})|(\\d{3}-\\d{2}-\\d{2}-\\d{3}))$/.test(t)},PT:function(t){var e,t=t.match(/^(PT)?(\\d{9})$/);return!!t&&(9<(e=11-M((t=t[2]).split(\"\").slice(0,8).map(function(t){return parseInt(t,10)}),9)%11)?0===parseInt(t[8],10):e===parseInt(t[8],10))},RO:function(t){return/^(RO)?\\d{2,10}$/.test(t)},SK:function(t){return/^(SK)?\\d{10}$/.test(t)},SI:function(t){return/^(SI)?\\d{8}$/.test(t)},ES:function(t){return/^(ES)?\\w\\d{7}[A-Z]$/.test(t)},SE:function(t){return/^(SE)?\\d{12}$/.test(t)},AL:function(t){return/^(AL)?\\w{9}[A-Z]$/.test(t)},MK:function(t){return/^(MK)?\\d{13}$/.test(t)},AU:function(t){if(!t.match(/^(AU)?(\\d{11})$/))return!1;for(var e=[10,1,3,5,7,9,11,13,15,17,19],r=(t=t.replace(/^AU/,\"\"),(parseInt(t.slice(0,1),10)-1).toString()+t.slice(1)),n=0,a=0;a<11;a++)n+=e[a]*r.charAt(a);return 0!==n&&n%89==0},BY:function(t){return/^(УНП )?\\d{9}$/.test(t)},CA:function(t){return/^(CA)?\\d{9}$/.test(t)},IS:function(t){return/^(IS)?\\d{5,6}$/.test(t)},IN:function(t){return/^(IN)?\\d{15}$/.test(t)},ID:function(t){return/^(ID)?(\\d{15}|(\\d{2}.\\d{3}.\\d{3}.\\d{1}-\\d{3}.\\d{3}))$/.test(t)},IL:function(t){return/^(IL)?\\d{9}$/.test(t)},KZ:function(t){return/^(KZ)?\\d{12}$/.test(t)},NZ:function(t){return/^(NZ)?\\d{9}$/.test(t)},NG:function(t){return/^(NG)?(\\d{12}|(\\d{8}-\\d{4}))$/.test(t)},NO:function(t){return/^(NO)?\\d{9}MVA$/.test(t)},PH:function(t){return/^(PH)?(\\d{12}|\\d{3} \\d{3} \\d{3} \\d{3})$/.test(t)},RU:function(t){return/^(RU)?(\\d{10}|\\d{12})$/.test(t)},SM:function(t){return/^(SM)?\\d{5}$/.test(t)},SA:function(t){return/^(SA)?\\d{15}$/.test(t)},RS:function(t){return/^(RS)?\\d{9}$/.test(t)},CH:function(t){var e,n;return/^(CHE[- ]?)?(\\d{9}|(\\d{3}\\.\\d{3}\\.\\d{3})|(\\d{3} \\d{3} \\d{3})) ?(TVA|MWST|IVA)?$/.test(t)&&(t=t.match(/\\d/g).map(function(t){return+t}),e=t.pop(),n=[5,4,3,2,7,6,5,4],e===(11-t.reduce(function(t,e,r){return t+e*n[r]},0)%11)%11)},TR:function(t){return/^(TR)?\\d{10}$/.test(t)},UA:function(t){return/^(UA)?\\d{12}$/.test(t)},GB:function(t){return/^GB((\\d{3} \\d{4} ([0-8][0-9]|9[0-6]))|(\\d{9} \\d{3})|(((GD[0-4])|(HA[5-9]))[0-9]{2}))$/.test(t)},UZ:function(t){return/^(UZ)?\\d{9}$/.test(t)},AR:function(t){return/^(AR)?\\d{11}$/.test(t)},BO:function(t){return/^(BO)?\\d{7}$/.test(t)},BR:function(t){return/^(BR)?((\\d{2}.\\d{3}.\\d{3}\\/\\d{4}-\\d{2})|(\\d{3}.\\d{3}.\\d{3}-\\d{2}))$/.test(t)},CL:function(t){return/^(CL)?\\d{8}-\\d{1}$/.test(t)},CO:function(t){return/^(CO)?\\d{10}$/.test(t)},CR:function(t){return/^(CR)?\\d{9,12}$/.test(t)},EC:function(t){return/^(EC)?\\d{13}$/.test(t)},SV:function(t){return/^(SV)?\\d{4}-\\d{6}-\\d{3}-\\d{1}$/.test(t)},GT:function(t){return/^(GT)?\\d{7}-\\d{1}$/.test(t)},HN:function(t){return/^(HN)?$/.test(t)},MX:function(t){return/^(MX)?\\w{3,4}\\d{6}\\w{3}$/.test(t)},NI:function(t){return/^(NI)?\\d{3}-\\d{6}-\\d{4}\\w{1}$/.test(t)},PA:function(t){return/^(PA)?$/.test(t)},PY:function(t){return/^(PY)?\\d{6,8}-\\d{1}$/.test(t)},PE:function(t){return/^(PE)?\\d{11}$/.test(t)},DO:function(t){return/^(DO)?(\\d{11}|(\\d{3}-\\d{7}-\\d{1})|[1,4,5]{1}\\d{8}|([1,4,5]{1})-\\d{2}-\\d{5}-\\d{1})$/.test(t)},UY:function(t){return/^(UY)?\\d{12}$/.test(t)},VE:function(t){return/^(VE)?[J,G,V,E]{1}-(\\d{9}|(\\d{8}-\\d{1}))$/.test(t)}};return{version:\"13.15.26\",toDate:r,toFloat:j,toInt:function(t,e){return f(t),parseInt(t,e||10)},toBoolean:function(t,e){return f(t),e?\"1\"===t||/^true$/i.test(t):\"0\"!==t&&!/^false$/i.test(t)&&\"\"!==t},equals:function(t,e){return f(t),t===e},contains:function(t,e,r){return f(t),(r=$(r,rt)).ignoreCase?t.toLowerCase().split(et(e).toLowerCase()).length>r.minOccurrences:t.split(et(e)).length>r.minOccurrences},matches:function(t,e,r){return f(t),\"[object RegExp]\"!==Object.prototype.toString.call(e)&&(e=new RegExp(e,r)),!!t.match(e)},isEmail:$t,isURL:function(e,r){if(f(e),!e||/[\\s<>]/.test(e))return!1;if(0===e.indexOf(\"mailto:\"))return!1;if((r=$(r,pt)).validate_length&&e.length>r.max_allowed_length)return!1;if(!r.allow_fragments&&S(e,\"#\"))return!1;if(!r.allow_query_components&&(S(e,\"?\")||S(e,\"&\")))return!1;function t(t){return s=!0,n=t.toLowerCase(),(!r.require_valid_protocol||-1!==r.protocols.indexOf(n))&&e.substring(o[0].length)}var n,a,i=e.split(\"#\"),o=(e=(i=(e=i.shift()).split(\"?\")).shift()).match(/^([a-z][a-z0-9+\\-.]*):/i),s=!1;if(o){var c=o[1],u=e.substring(o[0].length);if(\"//\"===u.slice(0,2)){if(!1===(e=t(c)))return!1}else{var l=u.indexOf(\"/\"),l=-1===l?u:u.substring(0,l),d=l.indexOf(\"@\");if(-1!==d){var l=l.substring(0,d),d=/^[a-zA-Z0-9\\-_.%:]*$/.test(l),l=/%[0-9a-fA-F]{2}/.test(l);if(d&&!l){if(r.require_protocol)return!1}else if(!1===(e=t(c)))return!1}else if(/^[0-9]/.test(u)){if(r.require_protocol)return!1}else if(!1===(e=t(c)))return!1}}else if(r.require_protocol)return!1;if(\"//\"===e.slice(0,2)){if(!s&&!r.allow_protocol_relative_urls)return!1;e=e.slice(2)}if(\"\"===e)return!1;if(\"\"===(e=(i=e.split(\"/\")).shift())&&!r.require_host)return!0;if(1<(i=e.split(\"@\")).length){if(r.disallow_auth)return!1;if(\"\"===i[0])return!1;if(0<=(d=i.shift()).indexOf(\":\")&&2<d.split(\":\").length)return!1;l=A(d.split(\":\"),2);if(\"\"===l[0]&&\"\"===l[1])return!1}if(c=u=null,(l=(d=i.join(\"@\")).match(ht))?(a=\"\",c=l[1],u=l[2]||null):(a=(i=d.split(\":\")).shift(),i.length&&(u=i.join(\":\"))),null!==u&&0<u.length){if(l=parseInt(u,10),!/^[0-9]+$/.test(u)||l<=0||65535<l)return!1}else if(r.require_port)return!1;return r.host_whitelist?p(a,r.host_whitelist):\"\"===a&&!r.require_host||!!(g(a)||at(a,r)||c&&g(c,6))&&(a=a||c,!r.host_blacklist||!p(a,r.host_blacklist))},isMACAddress:function t(e,r){return f(e),null!=r&&r.eui&&(r.eui=String(r.eui)),null!=r&&r.no_colons||null!=r&&r.no_separators?\"48\"===r.eui?St.test(e):\"64\"!==r.eui&&St.test(e)||Et.test(e):\"48\"===(null==r?void 0:r.eui)?gt.test(e)||mt.test(e):\"64\"===(null==r?void 0:r.eui)?Zt.test(e)||It.test(e):t(e,{eui:\"48\"})||t(e,{eui:\"64\"})},isIP:g,isIPRange:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:\"\",r=(f(t),t.split(\"/\"));if(2!==r.length)return!1;if(!Rt.test(r[1]))return!1;if(1<r[1].length&&r[1].startsWith(\"0\"))return!1;if(!g(r[0],e))return!1;var n=null;switch(String(e)){case\"4\":n=32;break;case\"6\":n=128;break;default:n=g(r[0],\"6\")?128:32}return r[1]<=n&&0<=r[1]},isFQDN:at,isBoolean:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Bt;return f(t),e.loose?Z(Nt,t.toLowerCase()):Z(Ft,t)},isIBAN:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return f(t),ce(t,e)&&1===((e=(e=t).replace(/[^A-Z0-9]+/gi,\"\").toUpperCase()).slice(4)+e.slice(0,4)).replace(/[A-Z]/g,function(t){return t.charCodeAt(0)-55}).match(/\\d{1,7}/g).reduce(function(t,e){return Number(t+e)%97},\"\")},isBIC:function(t){f(t);var e=t.slice(4,6).toUpperCase();return!(!le.has(e)&&\"XK\"!==e)&&de.test(t)},isAbaRouting:function(t){if(f(t),!Tt.test(t))return!1;for(var e=0,r=0;r<t.length;r++)e+=r%3==0?3*t[r]:r%3==1?7*t[r]:+t[r];return e%10==0},isAlpha:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:\"en-US\",r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(f(t),r=r.ignore)if(r instanceof RegExp)t=t.replace(r,\"\");else{if(\"string\"!=typeof r)throw new Error(\"ignore should be instance of a String or RegExp\");t=t.replace(new RegExp(\"[\".concat(r.replace(/[-[\\]{}()*+?.,\\\\^$|#\\\\s]/g,\"\\\\$&\"),\"]\"),\"g\"),\"\")}if(e in n)return n[e].test(t);throw new Error(\"Invalid locale '\".concat(e,\"'\"))},isAlphaLocales:h,isAlphanumeric:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:\"en-US\",r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(f(t),r=r.ignore)if(r instanceof RegExp)t=t.replace(r,\"\");else{if(\"string\"!=typeof r)throw new Error(\"ignore should be instance of a String or RegExp\");t=t.replace(new RegExp(\"[\".concat(r.replace(/[-[\\]{}()*+?.,\\\\^$|#\\\\s]/g,\"\\\\$&\"),\"]\"),\"g\"),\"\")}if(e in a)return a[e].test(t);throw new Error(\"Invalid locale '\".concat(e,\"'\"))},isAlphanumericLocales:I,isNumeric:function(t,e){return f(t),(e&&e.no_symbols?bt:new RegExp(\"^[+-]?([0-9]*[\".concat((e||{}).locale?i[e.locale]:\".\",\"])?[0-9]+$\"))).test(t)},isPassportNumber:function(t,e){return f(t),t=t.replace(/\\s/g,\"\").toUpperCase(),e.toUpperCase()in Gt&&Gt[e].test(t)},passportNumberLocales:Ct,isPort:function(t){return Ht(t,{allow_leading_zeroes:!1,min:0,max:65535})},isLowercase:function(t){return f(t),t===t.toLowerCase()},isUppercase:function(t){return f(t),t===t.toUpperCase()},isAscii:function(t){return f(t),wt.test(t)},isFullWidth:function(t){return f(t),Kt.test(t)},isHalfWidth:function(t){return f(t),yt.test(t)},isVariableWidth:function(t){return f(t),Kt.test(t)&&yt.test(t)},isMultibyte:function(t){return f(t),xt.test(t)},isSemVer:function(t){return f(t),Wt.test(t)},isSurrogatePair:function(t){return f(t),kt.test(t)},isInt:Ht,isIMEI:function(t,e){f(t);var r=_t;if(!(r=(e=e||{}).allow_hyphens?Ut:r).test(t))return!1;t=t.replace(/-/g,\"\");for(var n=0,a=2,i=0;i<14;i++){var o=t.substring(14-i-1,14-i),o=parseInt(o,10)*a;n+=10<=o?o%10+1:o,1===a?a+=1:--a}return(10-n%10)%10===parseInt(t.substring(14,15),10)},isFloat:z,isFloatLocales:Q,isDecimal:function(t,e){if(f(t),(e=$(e,Yt)).locale in i)return!Z(Vt,t.replace(/ /g,\"\"))&&(r=e,new RegExp(\"^[-+]?([0-9]+)?(\\\\\".concat(i[r.locale],\"[0-9]{\").concat(r.decimal_digits,\"})\").concat(r.force_decimal?\"\":\"?\",\"$\")).test(t));var r;throw new Error(\"Invalid locale '\".concat(e.locale,\"'\"))},isHexadecimal:Qt,isOctal:function(t){return f(t),jt.test(t)},isDivisibleBy:function(t,e){return f(t),j(t)%parseInt(e,10)==0},isHexColor:function(t,e){return f(t),((e=$(e,qt)).require_hashtag?Xt:Jt).test(t)},isRgbColor:function(t,e){f(t);var r=!1,n=!0;if(\"object\"!==u(e)?2<=arguments.length&&(n=e):(r=void 0!==e.allowSpaces?e.allowSpaces:r,n=void 0!==e.includePercentValues?e.includePercentValues:n),r){if(!ae.test(t))return!1;t=t.replace(/\\s/g,\"\")}return n?te.test(t)||ee.test(t)||re.test(t)||ne.test(t):te.test(t)||ee.test(t)},isHSL:function(t){return f(t),(-1!==(t=t.replace(/\\s+/g,\" \").replace(/\\s?(hsla?\\(|\\)|,)\\s?/gi,\"$1\")).indexOf(\",\")?ie:oe).test(t)},isISRC:function(t){return f(t),se.test(t)},isMD5:function(t){return f(t),fe.test(t)},isHash:function(t,e){return f(t),new RegExp(\"^[a-fA-F0-9]{\".concat(Ae[e],\"}$\")).test(t)},isJWT:function(t){return f(t),3===(t=t.split(\".\")).length&&t.reduce(function(t,e){return t&&Se(e,{urlSafe:!0})},!0)},isJSON:function(t,e){f(t);try{e=$(e,me);var r=[],n=(e.allow_primitives&&(r=[null,!1,!0]),JSON.parse(t));return Z(r,n)||!!n&&\"object\"===u(n)}catch(t){}return!1},isEmpty:function(t,e){return f(t),0===((e=$(e,Ze)).ignore_whitespace?t.trim():t).length},isLength:function(t,e){f(t),n=\"object\"===u(e)?(r=e.min||0,e.max):(r=e||0,arguments[2]);var r,n,a=t.match(/[^\\uFE0F\\uFE0E][\\uFE0F\\uFE0E]/g)||[],i=t.match(/[\\uD800-\\uDBFF][\\uDC00-\\uDFFF]/g)||[],o=t.length-a.length-i.length,t=r<=o&&(void 0===n||o<=n);return t&&Array.isArray(null==e?void 0:e.discreteLengths)?e.discreteLengths.some(function(t){return t===o}):t},isLocale:function(t){return f(t),Dt.test(t)},isByteLength:l,isULID:function(t){return f(t),/^[0-7][0-9A-HJKMNP-TV-Z]{25}$/i.test(t)},isUUID:function(t,e){return f(t),(e=null==e?\"all\":e)in Ee&&Ee[e].test(t)},isMongoId:function(t){return f(t),Qt(t)&&24===t.length},isAfter:function(t,e){return e=r((\"object\"===u(e)?e.comparisonDate:e)||Date().toString()),!!((t=r(t))&&e&&e<t)},isBefore:function(t,e){return e=r((\"object\"===u(e)?e.comparisonDate:e)||Date().toString()),!!((t=r(t))&&e&&t<e)},isIn:function(t,e){if(f(t),\"[object Array]\"!==Object.prototype.toString.call(e))return\"object\"===u(e)?e.hasOwnProperty(t):!(!e||\"function\"!=typeof e.indexOf)&&0<=e.indexOf(t);var r,n=[];for(r in e)!{}.hasOwnProperty.call(e,r)||(n[r]=et(e[r]));return 0<=n.indexOf(t)},isLuhnNumber:Ie,isCreditCard:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},e=(f(t),e.provider),r=t.replace(/[- ]+/g,\"\");if(e&&e.toLowerCase()in v){if(!v[e.toLowerCase()].test(r))return!1}else{if(e&&!(e.toLowerCase()in v))throw new Error(\"\".concat(e,\" is not a valid credit card provider.\"));if(!Re.some(function(t){return t.test(r)}))return!1}return Ie(t)},isIdentityCard:function(t,e){if(f(t),e in L)return L[e](t);if(\"any\"!==e)throw new Error(\"Invalid locale '\".concat(e,\"'\"));for(var r in L)if(L.hasOwnProperty(r))if((0,L[r])(t))return!0;return!1},isEAN:function(t){f(t);var e=Number(t.slice(-1));return Me.test(t)&&e===Be(t)},isISIN:function(t){if(f(t),!Fe.test(t))return!1;for(var e=!0,r=0,n=t.length-2;0<=n;n--)if(\"A\"<=t[n]&&t[n]<=\"Z\")for(var a=t[n].charCodeAt(0)-55,i=0,o=[a%10,Math.trunc(a/10)];i<o.length;i++){var s=o[i];r+=e?5<=s?1+2*(s-5):2*s:s,e=!e}else{a=t[n].charCodeAt(0)-\"0\".charCodeAt(0);r+=e?5<=a?1+2*(a-5):2*a:a,e=!e}var c=10*Math.trunc((r+9)/10)-r;return+t[t.length-1]==c},isISBN:function t(e,r){f(e);var n=String((null==r?void 0:r.version)||r);if(!(null!=r&&r.version||r))return t(e,{version:10})||t(e,{version:13});var a=e.replace(/[\\s-]+/g,\"\"),i=0;if(\"10\"===n){if(!Ne.test(a))return!1;for(var o=0;o<n-1;o++)i+=(o+1)*a.charAt(o);if(\"X\"===a.charAt(9)?i+=100:i+=10*a.charAt(9),i%11==0)return!0}else if(\"13\"===n){if(!Ce.test(a))return!1;for(var s=0;s<12;s++)i+=De[s%2]*a.charAt(s);if(a.charAt(12)-(10-i%10)%10==0)return!0}return!1},isISSN:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=(f(t),\"^\\\\d{4}-?\\\\d{3}[\\\\dX]$\"),r=e.require_hyphen?r.replace(\"?\",\"\"):r;if(!(r=e.case_sensitive?new RegExp(r):new RegExp(r,\"i\")).test(t))return!1;for(var n=t.replace(\"-\",\"\").toUpperCase(),a=0,i=0;i<n.length;i++){var o=n[i];a+=(\"X\"===o?10:+o)*(8-i)}return a%11==0},isMobilePhone:function(e,t,r){if(f(e),!r||!r.strictMode||e.startsWith(\"+\")){if(Array.isArray(t))return t.some(function(t){if(C.hasOwnProperty(t)&&C[t].test(e))return!0;return!1});if(t in C)return C[t].test(e);if(t&&\"any\"!==t)throw new Error(\"Invalid locale '\".concat(t,\"'\"));for(var n in C)if(C.hasOwnProperty(n))if(C[n].test(e))return!0}return!1},isMobilePhoneLocales:E,isPostalCode:function(t,e){if(f(t),e in G)return G[e].test(t);if(\"any\"!==e)throw new Error(\"Invalid locale '\".concat(e,\"'\"));for(var r in G)if(G.hasOwnProperty(r))if(G[r].test(t))return!0;return!1},isPostalCodeLocales:b,isEthereumAddress:function(t){return f(t),Pe.test(t)},isCurrency:function(t,e){return f(t),e=e=$(e,He),r=\"\\\\d{\".concat(e.digits_after_decimal[0],\"}\"),e.digits_after_decimal.forEach(function(t,e){0!==e&&(r=\"\".concat(r,\"|\\\\d{\").concat(t,\"}\"))}),n=\"(\".concat(e.symbol.replace(/\\W/,function(t){return\"\\\\\".concat(t)}),\")\").concat(e.require_symbol?\"\":\"?\"),a=[\"0\",\"[1-9]\\\\d*\",\"[1-9]\\\\d{0,2}(\\\\\".concat(e.thousands_separator,\"\\\\d{3})*\")],a=\"(\".concat(a.join(\"|\"),\")?\"),i=\"(\\\\\".concat(e.decimal_separator,\"(\").concat(r,\"))\").concat(e.require_decimal?\"\":\"?\"),a+=e.allow_decimal||e.require_decimal?i:\"\",e.allow_negatives&&!e.parens_for_negatives&&(e.negative_sign_after_digits?a+=\"-?\":e.negative_sign_before_digits&&(a=\"-?\"+a)),e.allow_negative_sign_placeholder?a=\"( (?!\\\\-))?\".concat(a):e.allow_space_after_symbol?a=\" ?\".concat(a):e.allow_space_after_digits&&(a+=\"( (?!$))?\"),e.symbol_after_digits?a+=n:a=n+a,e.allow_negatives&&(e.parens_for_negatives?a=\"(\\\\(\".concat(a,\"\\\\)|\").concat(a,\")\"):e.negative_sign_before_digits||e.negative_sign_after_digits||(a=\"-?\"+a)),new RegExp(\"^(?!-? )(?=.*\\\\d)\".concat(a,\"$\")).test(t);var r,n,a,i},isBtcAddress:function(t){return f(t),_e.test(t)||Ue.test(t)},isISO6346:ye,isFreightContainerID:xe,isISO6391:function(t){return f(t),We.has(t)},isISO8601:function(t){var e,r,n,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=(f(t),(a.strictSeparator?Ye:ke).test(t));return i&&a.strict?(t=(a=t).match(/^(\\d{4})-?(\\d{3})([ T]{1}\\.*|$)/))?(e=Number(t[1]),t=Number(t[2]),e%4==0&&e%100!=0||e%400==0?t<=366:t<=365):(t=(e=a.match(/(\\d{4})-?(\\d{0,2})-?(\\d*)/).map(Number))[1],a=e[3],n=(e=e[2])&&\"0\".concat(e).slice(-2),r=a&&\"0\".concat(a).slice(-2),n=new Date(\"\".concat(t,\"-\").concat(n||\"01\",\"-\").concat(r||\"01\")),!e||!a||n.getUTCFullYear()===t&&n.getUTCMonth()+1===e&&n.getUTCDate()===a):i},isISO15924:function(t){return f(t),ze.has(t)},isRFC3339:function(t){return f(t),Ve.test(t)},isISO31661Alpha2:function(t){return f(t),ue.has(t.toUpperCase())},isISO31661Alpha3:function(t){return f(t),Qe.has(t.toUpperCase())},isISO31661Numeric:function(t){return f(t),je.has(t)},isISO4217:function(t){return f(t),Je.has(t.toUpperCase())},isBase32:function(t,e){return f(t),(e=$(e,tr)).crockford?qe.test(t):!(t.length%8!=0||!Xe.test(t))},isBase58:function(t){return f(t),!!er.test(t)},isBase64:Se,isDataURI:function(t){f(t);var e=t.split(\",\");if(e.length<2)return!1;var r=e.shift().trim().split(\";\");if(\"data:\"!==(t=r.shift()).slice(0,5))return!1;if(\"\"!==(t=t.slice(5))&&!rr.test(t))return!1;for(var n=0;n<r.length;n++)if((n!==r.length-1||\"base64\"!==r[n].toLowerCase())&&!nr.test(r[n]))return!1;for(var a=0;a<e.length;a++)if(!ar.test(e[a]))return!1;return!0},isMagnetURI:function(t){return f(t),0===t.indexOf(\"magnet:?\")&&ir.test(t)},isMailtoURI:function(t,e){var r;return f(t),0===t.indexOf(\"mailto:\")&&(r=(t=A(t.replace(\"mailto:\",\"\").split(\"?\"),2))[0],t=void 0===(t=t[1])?\"\":t,!r&&!t||!!(t=(t=>{var e=new Set([\"subject\",\"body\",\"cc\",\"bcc\"]),r={cc:\"\",bcc:\"\"},n=!1;if(4<(t=t.split(\"&\")).length)return!1;var a,i=X(t);try{for(i.s();!(a=i.n()).done;){var o=A(a.value.split(\"=\"),2),s=o[0],c=o[1];if(s&&!e.has(s)){n=!0;break}!c||\"cc\"!==s&&\"bcc\"!==s||(r[s]=c),s&&e.delete(s)}}catch(t){i.e(t)}finally{i.f()}return!n&&r})(t))&&\"\".concat(r,\",\").concat(t.cc,\",\").concat(t.bcc).split(\",\").every(function(t){return!(t=cr(t,\" \"))||$t(t,e)}))},isMimeType:function(t){return f(t),ur.test(t)||lr.test(t)||dr.test(t)},isLatLong:function(t,e){return f(t),e=$(e,hr),!!S(t,\",\")&&!((t=t.split(\",\"))[0].startsWith(\"(\")&&!t[1].endsWith(\")\")||t[1].endsWith(\")\")&&!t[0].startsWith(\"(\"))&&(e.checkDMS?$r.test(t[0])&&pr.test(t[1]):fr.test(t[0])&&Ar.test(t[1]))},ltrim:sr,rtrim:or,trim:cr,escape:function(t){return f(t),t.replace(/&/g,\"&amp;\").replace(/\"/g,\"&quot;\").replace(/'/g,\"&#x27;\").replace(/</g,\"&lt;\").replace(/>/g,\"&gt;\").replace(/\\//g,\"&#x2F;\").replace(/\\\\/g,\"&#x5C;\").replace(/`/g,\"&#96;\")},unescape:function(t){return f(t),t.replace(/&quot;/g,'\"').replace(/&#x27;/g,\"'\").replace(/&lt;/g,\"<\").replace(/&gt;/g,\">\").replace(/&#x2F;/g,\"/\").replace(/&#x5C;/g,\"\\\\\").replace(/&#96;/g,\"`\").replace(/&amp;/g,\"&\")},stripLow:function(t,e){return f(t),Sr(t,e?\"\\\\x00-\\\\x09\\\\x0B\\\\x0C\\\\x0E-\\\\x1F\\\\x7F\":\"\\\\x00-\\\\x1F\\\\x7F\")},whitelist:function(t,e){return f(t),t.replace(new RegExp(\"[^\".concat(e,\"]+\"),\"g\"),\"\")},blacklist:Sr,isWhitelisted:function(t,e){f(t);for(var r=t.length-1;0<=r;r--)if(-1===e.indexOf(t[r]))return!1;return!0},normalizeEmail:function(t,e){e=$(e,mr);var r=(t=t.split(\"@\")).pop();if((t=[t.join(\"@\"),r])[1]=t[1].toLowerCase(),\"gmail.com\"===t[1]||\"googlemail.com\"===t[1]){if(e.gmail_remove_subaddress&&(t[0]=t[0].split(\"+\")[0]),e.gmail_remove_dots&&(t[0]=t[0].replace(/\\.+/g,vr)),!t[0].length)return!1;(e.all_lowercase||e.gmail_lowercase)&&(t[0]=t[0].toLowerCase()),t[1]=e.gmail_convert_googlemaildotcom?\"gmail.com\":t[1]}else if(0<=Zr.indexOf(t[1])){if(e.icloud_remove_subaddress&&(t[0]=t[0].split(\"+\")[0]),!t[0].length)return!1;(e.all_lowercase||e.icloud_lowercase)&&(t[0]=t[0].toLowerCase())}else if(0<=Er.indexOf(t[1])){if(e.outlookdotcom_remove_subaddress&&(t[0]=t[0].split(\"+\")[0]),!t[0].length)return!1;(e.all_lowercase||e.outlookdotcom_lowercase)&&(t[0]=t[0].toLowerCase())}else if(0<=Ir.indexOf(t[1])){if(e.yahoo_remove_subaddress&&(r=t[0].split(\"-\"),t[0]=1<r.length?r.slice(0,-1).join(\"-\"):r[0]),!t[0].length)return!1;(e.all_lowercase||e.yahoo_lowercase)&&(t[0]=t[0].toLowerCase())}else 0<=Rr.indexOf(t[1])?((e.all_lowercase||e.yandex_lowercase)&&(t[0]=t[0].toLowerCase()),t[1]=e.yandex_convert_yandexru?\"yandex.ru\":t[1]):e.all_lowercase&&(t[0]=t[0].toLowerCase());return t.join(\"@\")},toString:toString,isSlug:function(t){return f(t),Lr.test(t)},isStrongPassword:function(t){var e,r,n,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,t=(f(t),Dr(t));return(a=$(a||{},Cr)).returnScore?(r=a,n=0,n=(n+=(e=t).uniqueChars*r.pointsPerUnique)+(e.length-e.uniqueChars)*r.pointsPerRepeat,0<e.lowercaseCount&&(n+=r.pointsForContainingLower),0<e.uppercaseCount&&(n+=r.pointsForContainingUpper),0<e.numberCount&&(n+=r.pointsForContainingNumber),0<e.symbolCount&&(n+=r.pointsForContainingSymbol),n):t.length>=a.minLength&&t.lowercaseCount>=a.minLowercase&&t.uppercaseCount>=a.minUppercase&&t.numberCount>=a.minNumbers&&t.symbolCount>=a.minSymbols},isTaxID:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:\"en-US\",t=(f(t),t.slice(0));if(e in B)return e in N&&(t=t.replace(N[e],\"\")),!!B[e].test(t)&&(!(e in F)||F[e](t));throw new Error(\"Invalid locale '\".concat(e,\"'\"))},isDate:m,isTime:function(t,e){return e=$(e,Lt),\"string\"==typeof t&&Mt[e.hourFormat][e.mode].test(t)},isLicensePlate:function(t,e){if(f(t),e in O)return O[e](t);if(\"any\"!==e)throw new Error(\"Invalid locale '\".concat(e,\"'\"));for(var r in O)if((0,O[r])(t))return!0;return!1},isVAT:function(t,e){if(f(t),f(e),e in Tr)return Tr[e](t);throw new Error(\"Invalid country code: '\".concat(e,\"'\"))},ibanLocales:d}});\n/Users/imorgado/SPLICE/splice-backend/node_modules/validator/validator.js:1073:   * @deprecated `no_colons` TODO: remove it in the next major\n/Users/imorgado/SPLICE/splice-backend/node_modules/validator/validator.js:4748:var validISO4217CurrencyCodes = new Set(['AED', 'AFN', 'ALL', 'AMD', 'ANG', 'AOA', 'ARS', 'AUD', 'AWG', 'AZN', 'BAM', 'BBD', 'BDT', 'BGN', 'BHD', 'BIF', 'BMD', 'BND', 'BOB', 'BOV', 'BRL', 'BSD', 'BTN', 'BWP', 'BYN', 'BZD', 'CAD', 'CDF', 'CHE', 'CHF', 'CHW', 'CLF', 'CLP', 'CNY', 'COP', 'COU', 'CRC', 'CUP', 'CVE', 'CZK', 'DJF', 'DKK', 'DOP', 'DZD', 'EGP', 'ERN', 'ETB', 'EUR', 'FJD', 'FKP', 'GBP', 'GEL', 'GHS', 'GIP', 'GMD', 'GNF', 'GTQ', 'GYD', 'HKD', 'HNL', 'HTG', 'HUF', 'IDR', 'ILS', 'INR', 'IQD', 'IRR', 'ISK', 'JMD', 'JOD', 'JPY', 'KES', 'KGS', 'KHR', 'KMF', 'KPW', 'KRW', 'KWD', 'KYD', 'KZT', 'LAK', 'LBP', 'LKR', 'LRD', 'LSL', 'LYD', 'MAD', 'MDL', 'MGA', 'MKD', 'MMK', 'MNT', 'MOP', 'MRU', 'MUR', 'MVR', 'MWK', 'MXN', 'MXV', 'MYR', 'MZN', 'NAD', 'NGN', 'NIO', 'NOK', 'NPR', 'NZD', 'OMR', 'PAB', 'PEN', 'PGK', 'PHP', 'PKR', 'PLN', 'PYG', 'QAR', 'RON', 'RSD', 'RUB', 'RWF', 'SAR', 'SBD', 'SCR', 'SDG', 'SEK', 'SGD', 'SHP', 'SLE', 'SLL', 'SOS', 'SRD', 'SSP', 'STN', 'SVC', 'SYP', 'SZL', 'THB', 'TJS', 'TMT', 'TND', 'TOP', 'TRY', 'TTD', 'TWD', 'TZS', 'UAH', 'UGX', 'USD', 'USN', 'UYI', 'UYU', 'UYW', 'UZS', 'VED', 'VES', 'VND', 'VUV', 'WST', 'XAF', 'XAG', 'XAU', 'XBA', 'XBB', 'XBC', 'XBD', 'XCD', 'XDR', 'XOF', 'XPD', 'XPF', 'XPT', 'XSU', 'XTS', 'XUA', 'XXX', 'YER', 'ZAR', 'ZMW', 'ZWL']);\n/Users/imorgado/SPLICE/splice-backend/node_modules/validator/lib/isMACAddress.js:21:   * @deprecated `no_colons` TODO: remove it in the next major\n/Users/imorgado/SPLICE/splice-backend/node_modules/validator/lib/isISO4217.js:11:var validISO4217CurrencyCodes = new Set(['AED', 'AFN', 'ALL', 'AMD', 'ANG', 'AOA', 'ARS', 'AUD', 'AWG', 'AZN', 'BAM', 'BBD', 'BDT', 'BGN', 'BHD', 'BIF', 'BMD', 'BND', 'BOB', 'BOV', 'BRL', 'BSD', 'BTN', 'BWP', 'BYN', 'BZD', 'CAD', 'CDF', 'CHE', 'CHF', 'CHW', 'CLF', 'CLP', 'CNY', 'COP', 'COU', 'CRC', 'CUP', 'CVE', 'CZK', 'DJF', 'DKK', 'DOP', 'DZD', 'EGP', 'ERN', 'ETB', 'EUR', 'FJD', 'FKP', 'GBP', 'GEL', 'GHS', 'GIP', 'GMD', 'GNF', 'GTQ', 'GYD', 'HKD', 'HNL', 'HTG', 'HUF', 'IDR', 'ILS', 'INR', 'IQD', 'IRR', 'ISK', 'JMD', 'JOD', 'JPY', 'KES', 'KGS', 'KHR', 'KMF', 'KPW', 'KRW', 'KWD', 'KYD', 'KZT', 'LAK', 'LBP', 'LKR', 'LRD', 'LSL', 'LYD', 'MAD', 'MDL', 'MGA', 'MKD', 'MMK', 'MNT', 'MOP', 'MRU', 'MUR', 'MVR', 'MWK', 'MXN', 'MXV', 'MYR', 'MZN', 'NAD', 'NGN', 'NIO', 'NOK', 'NPR', 'NZD', 'OMR', 'PAB', 'PEN', 'PGK', 'PHP', 'PKR', 'PLN', 'PYG', 'QAR', 'RON', 'RSD', 'RUB', 'RWF', 'SAR', 'SBD', 'SCR', 'SDG', 'SEK', 'SGD', 'SHP', 'SLE', 'SLL', 'SOS', 'SRD', 'SSP', 'STN', 'SVC', 'SYP', 'SZL', 'THB', 'TJS', 'TMT', 'TND', 'TOP', 'TRY', 'TTD', 'TWD', 'TZS', 'UAH', 'UGX', 'USD', 'USN', 'UYI', 'UYU', 'UYW', 'UZS', 'VED', 'VES', 'VND', 'VUV', 'WST', 'XAF', 'XAG', 'XAU', 'XBA', 'XBB', 'XBC', 'XBD', 'XCD', 'XDR', 'XOF', 'XPD', 'XPF', 'XPT', 'XSU', 'XTS', 'XUA', 'XXX', 'YER', 'ZAR', 'ZMW', 'ZWL']);\n/Users/imorgado/SPLICE/splice-backend/node_modules/validator/es/lib/isMACAddress.js:14:   * @deprecated `no_colons` TODO: remove it in the next major\n/Users/imorgado/SPLICE/splice-backend/node_modules/validator/es/lib/isISO4217.js:4:var validISO4217CurrencyCodes = new Set(['AED', 'AFN', 'ALL', 'AMD', 'ANG', 'AOA', 'ARS', 'AUD', 'AWG', 'AZN', 'BAM', 'BBD', 'BDT', 'BGN', 'BHD', 'BIF', 'BMD', 'BND', 'BOB', 'BOV', 'BRL', 'BSD', 'BTN', 'BWP', 'BYN', 'BZD', 'CAD', 'CDF', 'CHE', 'CHF', 'CHW', 'CLF', 'CLP', 'CNY', 'COP', 'COU', 'CRC', 'CUP', 'CVE', 'CZK', 'DJF', 'DKK', 'DOP', 'DZD', 'EGP', 'ERN', 'ETB', 'EUR', 'FJD', 'FKP', 'GBP', 'GEL', 'GHS', 'GIP', 'GMD', 'GNF', 'GTQ', 'GYD', 'HKD', 'HNL', 'HTG', 'HUF', 'IDR', 'ILS', 'INR', 'IQD', 'IRR', 'ISK', 'JMD', 'JOD', 'JPY', 'KES', 'KGS', 'KHR', 'KMF', 'KPW', 'KRW', 'KWD', 'KYD', 'KZT', 'LAK', 'LBP', 'LKR', 'LRD', 'LSL', 'LYD', 'MAD', 'MDL', 'MGA', 'MKD', 'MMK', 'MNT', 'MOP', 'MRU', 'MUR', 'MVR', 'MWK', 'MXN', 'MXV', 'MYR', 'MZN', 'NAD', 'NGN', 'NIO', 'NOK', 'NPR', 'NZD', 'OMR', 'PAB', 'PEN', 'PGK', 'PHP', 'PKR', 'PLN', 'PYG', 'QAR', 'RON', 'RSD', 'RUB', 'RWF', 'SAR', 'SBD', 'SCR', 'SDG', 'SEK', 'SGD', 'SHP', 'SLE', 'SLL', 'SOS', 'SRD', 'SSP', 'STN', 'SVC', 'SYP', 'SZL', 'THB', 'TJS', 'TMT', 'TND', 'TOP', 'TRY', 'TTD', 'TWD', 'TZS', 'UAH', 'UGX', 'USD', 'USN', 'UYI', 'UYU', 'UYW', 'UZS', 'VED', 'VES', 'VND', 'VUV', 'WST', 'XAF', 'XAG', 'XAU', 'XBA', 'XBB', 'XBC', 'XBD', 'XCD', 'XDR', 'XOF', 'XPD', 'XPF', 'XPT', 'XSU', 'XTS', 'XUA', 'XXX', 'YER', 'ZAR', 'ZMW', 'ZWL']);\n/Users/imorgado/SPLICE/splice-backend/node_modules/side-channel-list/index.js:111:\t// @ts-expect-error TODO: figure out why this is erroring\n/Users/imorgado/SPLICE/splice-backend/node_modules/pg-protocol/dist/parser.js:230:        // TODO(bmc): maybe better types here\n/Users/imorgado/SPLICE/splice-backend/node_modules/pg-protocol/dist/buffer-reader.js:9:        // TODO(bmc): support non-utf8 encoding?\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/config-array/dist/esm/index.js:781:\t// TODO: Throw more verbose error\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/config-array/node_modules/debug/src/common.js:120:\t\tdebug.destroy = createDebug.destroy; // XXX Temporary. Will be removed in the next major release.\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/config-array/node_modules/debug/src/common.js:280:\t* XXX DO NOT USE. This is a temporary stub function.\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/config-array/node_modules/debug/src/common.js:281:\t* XXX It WILL be removed in the next major release.\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/config-array/node_modules/debug/src/browser.js:111: * TODO: add a `localStorage` variable to explicitly enable/disable colors\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/config-array/node_modules/debug/src/browser.js:209:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/config-array/node_modules/debug/src/browser.js:225:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/config-array/node_modules/debug/src/browser.js:254:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/eslintrc/node_modules/debug/src/common.js:120:\t\tdebug.destroy = createDebug.destroy; // XXX Temporary. Will be removed in the next major release.\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/eslintrc/node_modules/debug/src/common.js:280:\t* XXX DO NOT USE. This is a temporary stub function.\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/eslintrc/node_modules/debug/src/common.js:281:\t* XXX It WILL be removed in the next major release.\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/eslintrc/node_modules/debug/src/browser.js:111: * TODO: add a `localStorage` variable to explicitly enable/disable colors\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/eslintrc/node_modules/debug/src/browser.js:209:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/eslintrc/node_modules/debug/src/browser.js:225:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/@eslint/eslintrc/node_modules/debug/src/browser.js:254:\t\t// XXX (@Qix-) should we be logging these?\n/Users/imorgado/SPLICE/splice-backend/node_modules/call-bind-apply-helpers/index.js:9:/** @type {(args: [Function, thisArg?: unknown, ...args: unknown[]]) => Function} TODO FIXME, find a way to use import('.') */\n/Users/imorgado/SPLICE/splice-backend/node_modules/acorn/dist/acorn.js:5448:    // Identifier or keyword. '\\uXXXX' sequences are allowed in\n/Users/imorgado/SPLICE/splice-backend/node_modules/acorn/dist/acorn.js:6148:          { this.invalidStringToken(this.pos, \"Expecting Unicode escape sequence \\\\uXXXX\"); }\n/Users/imorgado/SPLICE/splice-backend/node_modules/express/lib/request.js:452:// TODO: change req.host to return host in next major\n/Users/imorgado/SPLICE/splice-backend/node_modules/@mapbox/node-pre-gyp/lib/util/versioning.js:125:                    TODO: use semver module instead of custom version parsing\n/Users/imorgado/SPLICE/splice-backend/node_modules/ignore/index.js:72:    // TODO:","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"603216bd-a501-4f83-b60d-57b1d9291a2b"}
{"parentUuid":"3c24dfe4-c79c-4ca5-bb35-d895b7778c44","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012YAcqA5edko6GEGoYXQeuh","type":"message","role":"assistant","content":[{"type":"text","text":"Let me look at the new routes to understand the incomplete features:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":946,"cache_read_input_tokens":52295,"cache_creation":{"ephemeral_5m_input_tokens":946,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX48kfjHpwh5h1fFSdbYt","type":"assistant","uuid":"7a631cd1-ee09-4c23-8362-1d68b7fec2e9","timestamp":"2026-01-12T20:43:12.800Z"}
{"parentUuid":"7a631cd1-ee09-4c23-8362-1d68b7fec2e9","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012YAcqA5edko6GEGoYXQeuh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01F2HvX5Y5NzEbcAJGeXU5Ae","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-backend/routes/zoomPro.js","limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":946,"cache_read_input_tokens":52295,"cache_creation":{"ephemeral_5m_input_tokens":946,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX48kfjHpwh5h1fFSdbYt","type":"assistant","uuid":"88670f42-4d45-46e4-82b9-4c1bbc497d40","timestamp":"2026-01-12T20:43:13.114Z"}
{"parentUuid":"88670f42-4d45-46e4-82b9-4c1bbc497d40","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01F2HvX5Y5NzEbcAJGeXU5Ae","type":"tool_result","content":"     1→/**\n     2→ * SPLICE Zoom Routes (Production-Ready)\n     3→ *\n     4→ * Face detection and zoom keyframe generation endpoints\n     5→ * Based on FireCut's implementation approach\n     6→ */\n     7→\n     8→const express = require('express');\n     9→const faceDetection = require('../services/faceDetectionPro');\n    10→const { body, validationResult } = require('express-validator');\n    11→\n    12→/**\n    13→ * Create zoom routes\n    14→ * @param {Object} options - Route configuration options\n    15→ * @param {Object} options.middleware - Shared middleware (authenticateToken)\n    16→ * @returns {express.Router}\n    17→ */\n    18→function createZoomRoutes(options = {}) {\n    19→  const router = express.Router();\n    20→  const { authenticateToken } = options.middleware || {};\n    21→\n    22→  // Apply authentication to all routes\n    23→  if (authenticateToken) {\n    24→    router.use(authenticateToken);\n    25→  }\n    26→\n    27→// ============================================================================\n    28→// FACE DETECTION ENDPOINTS\n    29→// ============================================================================\n    30→\n    31→/**\n    32→ * POST /zoom/detect-faces\n    33→ *\n    34→ * Detect faces at multiple timestamps in video\n    35→ *\n    36→ * Body:\n    37→ * - videoPath: string (required) - Path to video file\n    38→ * - times: number[] (required) - Array of timestamps in seconds\n    39→ *\n    40→ * Response:\n    41→ * - success: boolean\n    42→ * - detections: Array of { time, face, success }\n    43→ *   - face: { x, y, confidence, box, model } or null\n    44→ * - summary: { total, detected, failed, detectionRate }\n    45→ */\n    46→router.post('/detect-faces',\n    47→  authenticateToken,\n    48→  [\n    49→    body('videoPath')\n    50→      .isString()\n    51→      .notEmpty()\n    52→      .withMessage('videoPath is required'),\n    53→    body('times')\n    54→      .isArray({ min: 1 })\n    55→      .withMessage('times must be a non-empty array'),\n    56→    body('times.*')\n    57→      .isNumeric()\n    58→      .withMessage('All times must be numbers')\n    59→  ],\n    60→  async (req, res) => {\n    61→    try {\n    62→      // Validate request\n    63→      const errors = validationResult(req);\n    64→      if (!errors.isEmpty()) {\n    65→        return res.status(400).json({\n    66→          success: false,\n    67→          errors: errors.array()\n    68→        });\n    69→      }\n    70→\n    71→      const { videoPath, times } = req.body;\n    72→\n    73→      // Validate video format\n    74→      const validExtensions = ['.mp4', '.mov', '.avi', '.mkv', '.webm'];\n    75→      const hasValidExt = validExtensions.some(ext => videoPath.toLowerCase().endsWith(ext));\n    76→\n    77→      if (!hasValidExt) {\n    78→        return res.status(400).json({\n    79→          success: false,\n    80→          error: `Invalid video format. Supported: ${validExtensions.join(', ')}`\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"da97fd40-840f-4bd5-9997-6a38a3fb2579","timestamp":"2026-01-12T20:43:13.157Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-backend/routes/zoomPro.js","content":"/**\n * SPLICE Zoom Routes (Production-Ready)\n *\n * Face detection and zoom keyframe generation endpoints\n * Based on FireCut's implementation approach\n */\n\nconst express = require('express');\nconst faceDetection = require('../services/faceDetectionPro');\nconst { body, validationResult } = require('express-validator');\n\n/**\n * Create zoom routes\n * @param {Object} options - Route configuration options\n * @param {Object} options.middleware - Shared middleware (authenticateToken)\n * @returns {express.Router}\n */\nfunction createZoomRoutes(options = {}) {\n  const router = express.Router();\n  const { authenticateToken } = options.middleware || {};\n\n  // Apply authentication to all routes\n  if (authenticateToken) {\n    router.use(authenticateToken);\n  }\n\n// ============================================================================\n// FACE DETECTION ENDPOINTS\n// ============================================================================\n\n/**\n * POST /zoom/detect-faces\n *\n * Detect faces at multiple timestamps in video\n *\n * Body:\n * - videoPath: string (required) - Path to video file\n * - times: number[] (required) - Array of timestamps in seconds\n *\n * Response:\n * - success: boolean\n * - detections: Array of { time, face, success }\n *   - face: { x, y, confidence, box, model } or null\n * - summary: { total, detected, failed, detectionRate }\n */\nrouter.post('/detect-faces',\n  authenticateToken,\n  [\n    body('videoPath')\n      .isString()\n      .notEmpty()\n      .withMessage('videoPath is required'),\n    body('times')\n      .isArray({ min: 1 })\n      .withMessage('times must be a non-empty array'),\n    body('times.*')\n      .isNumeric()\n      .withMessage('All times must be numbers')\n  ],\n  async (req, res) => {\n    try {\n      // Validate request\n      const errors = validationResult(req);\n      if (!errors.isEmpty()) {\n        return res.status(400).json({\n          success: false,\n          errors: errors.array()\n        });\n      }\n\n      const { videoPath, times } = req.body;\n\n      // Validate video format\n      const validExtensions = ['.mp4', '.mov', '.avi', '.mkv', '.webm'];\n      const hasValidExt = validExtensions.some(ext => videoPath.toLowerCase().endsWith(ext));\n\n      if (!hasValidExt) {\n        return res.status(400).json({\n          success: false,\n          error: `Invalid video format. Supported: ${validExtensions.join(', ')}`","numLines":80,"startLine":1,"totalLines":253}},"sourceToolAssistantUUID":"88670f42-4d45-46e4-82b9-4c1bbc497d40"}
{"parentUuid":"da97fd40-840f-4bd5-9997-6a38a3fb2579","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_013cTC9FNuponTKHECzKcddH","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the workflows route:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1142,"cache_read_input_tokens":53241,"cache_creation":{"ephemeral_5m_input_tokens":1142,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48komyeC3TCJg1bPF2f","type":"assistant","uuid":"111716f1-8580-4a06-a1f7-b6f724830c1f","timestamp":"2026-01-12T20:43:14.974Z"}
{"parentUuid":"111716f1-8580-4a06-a1f7-b6f724830c1f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_013cTC9FNuponTKHECzKcddH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WQMZ8khJ3N9DuYrzweK7PX","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-backend/routes/workflows.js","limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1142,"cache_read_input_tokens":53241,"cache_creation":{"ephemeral_5m_input_tokens":1142,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48komyeC3TCJg1bPF2f","type":"assistant","uuid":"aa4ce664-caf3-4d67-ad8b-a2b77cf3ba6f","timestamp":"2026-01-12T20:43:15.426Z"}
{"parentUuid":"aa4ce664-caf3-4d67-ad8b-a2b77cf3ba6f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WQMZ8khJ3N9DuYrzweK7PX","type":"tool_result","content":"     1→/**\n     2→ * Workflow API Routes\n     3→ *\n     4→ * REST API for workflow CRUD operations and execution\n     5→ * Based on FireCut's workflow system\n     6→ *\n     7→ * Date: 2026-01-12\n     8→ */\n     9→\n    10→const express = require('express');\n    11→const { Pool } = require('pg');\n    12→const { executeWorkflowAsync, getExecutionStatus } = require('../services/workflowExecutor');\n    13→const logger = require('../services/logger');\n    14→\n    15→// PostgreSQL connection pool\n    16→const sslConfig = process.env.NODE_ENV === 'production' ? {\n    17→  rejectUnauthorized: process.env.DATABASE_SSL_REJECT_UNAUTHORIZED === 'true',\n    18→  ca: process.env.DATABASE_SSL_CA || undefined\n    19→} : false;\n    20→\n    21→const pool = new Pool({\n    22→  connectionString: process.env.DATABASE_URL,\n    23→  ssl: sslConfig,\n    24→  max: 20,\n    25→  idleTimeoutMillis: 30000,\n    26→  connectionTimeoutMillis: 10000,\n    27→  statement_timeout: 30000,\n    28→  query_timeout: 30000\n    29→});\n    30→\n    31→/**\n    32→ * Create workflow routes\n    33→ * @param {Object} options - Route configuration options\n    34→ * @param {Object} options.middleware - Shared middleware (authenticateToken, csrfMiddleware, requireCredits)\n    35→ * @returns {express.Router}\n    36→ */\n    37→function createWorkflowRoutes(options = {}) {\n    38→  const router = express.Router();\n    39→  const { authenticateToken, validateCsrfToken } = options.middleware || {};\n    40→\n    41→  // Apply authentication to all routes\n    42→  if (authenticateToken) {\n    43→    router.use(authenticateToken);\n    44→  }\n    45→\n    46→  // Optional CSRF validation middleware\n    47→  const csrfMiddleware = validateCsrfToken || ((req, res, next) => next());\n    48→\n    49→/**\n    50→ * GET /api/workflows\n    51→ * List all workflows for authenticated user\n    52→ */\n    53→router.get('/', async (req, res) => {\n    54→  try {\n    55→    const userId = req.user.id;\n    56→\n    57→    const result = await pool.query(\n    58→      `SELECT id, name, description, scope, steps, created_at, updated_at\n    59→       FROM workflows\n    60→       WHERE user_id = $1\n    61→       ORDER BY updated_at DESC`,\n    62→      [userId]\n    63→    );\n    64→\n    65→    // Parse steps JSON if stored as string\n    66→    const workflows = result.rows.map(workflow => ({\n    67→      ...workflow,\n    68→      steps: typeof workflow.steps === 'string' ? JSON.parse(workflow.steps) : workflow.steps\n    69→    }));\n    70→\n    71→    res.json({\n    72→      success: true,\n    73→      workflows\n    74→    });\n    75→\n    76→  } catch (error) {\n    77→    logger.error('List workflows error:', error);\n    78→    res.status(500).json({\n    79→      success: false,\n    80→      error: 'Failed to list workflows'\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"78222984-1974-4c6b-a7cc-75318adb520c","timestamp":"2026-01-12T20:43:15.488Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-backend/routes/workflows.js","content":"/**\n * Workflow API Routes\n *\n * REST API for workflow CRUD operations and execution\n * Based on FireCut's workflow system\n *\n * Date: 2026-01-12\n */\n\nconst express = require('express');\nconst { Pool } = require('pg');\nconst { executeWorkflowAsync, getExecutionStatus } = require('../services/workflowExecutor');\nconst logger = require('../services/logger');\n\n// PostgreSQL connection pool\nconst sslConfig = process.env.NODE_ENV === 'production' ? {\n  rejectUnauthorized: process.env.DATABASE_SSL_REJECT_UNAUTHORIZED === 'true',\n  ca: process.env.DATABASE_SSL_CA || undefined\n} : false;\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: sslConfig,\n  max: 20,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 10000,\n  statement_timeout: 30000,\n  query_timeout: 30000\n});\n\n/**\n * Create workflow routes\n * @param {Object} options - Route configuration options\n * @param {Object} options.middleware - Shared middleware (authenticateToken, csrfMiddleware, requireCredits)\n * @returns {express.Router}\n */\nfunction createWorkflowRoutes(options = {}) {\n  const router = express.Router();\n  const { authenticateToken, validateCsrfToken } = options.middleware || {};\n\n  // Apply authentication to all routes\n  if (authenticateToken) {\n    router.use(authenticateToken);\n  }\n\n  // Optional CSRF validation middleware\n  const csrfMiddleware = validateCsrfToken || ((req, res, next) => next());\n\n/**\n * GET /api/workflows\n * List all workflows for authenticated user\n */\nrouter.get('/', async (req, res) => {\n  try {\n    const userId = req.user.id;\n\n    const result = await pool.query(\n      `SELECT id, name, description, scope, steps, created_at, updated_at\n       FROM workflows\n       WHERE user_id = $1\n       ORDER BY updated_at DESC`,\n      [userId]\n    );\n\n    // Parse steps JSON if stored as string\n    const workflows = result.rows.map(workflow => ({\n      ...workflow,\n      steps: typeof workflow.steps === 'string' ? JSON.parse(workflow.steps) : workflow.steps\n    }));\n\n    res.json({\n      success: true,\n      workflows\n    });\n\n  } catch (error) {\n    logger.error('List workflows error:', error);\n    res.status(500).json({\n      success: false,\n      error: 'Failed to list workflows'","numLines":80,"startLine":1,"totalLines":484}},"sourceToolAssistantUUID":"aa4ce664-caf3-4d67-ad8b-a2b77cf3ba6f"}
{"parentUuid":"78222984-1974-4c6b-a7cc-75318adb520c","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CaGwnyafUJERQqSfwFUJMg","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check what new test scripts and services were added:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1138,"cache_read_input_tokens":54383,"cache_creation":{"ephemeral_5m_input_tokens":1138,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CX48kzyvN3ZS41vJJKU19","type":"assistant","uuid":"6ca071bc-03de-465b-9931-42b16c4ed913","timestamp":"2026-01-12T20:43:18.073Z"}
{"parentUuid":"6ca071bc-03de-465b-9931-42b16c4ed913","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CaGwnyafUJERQqSfwFUJMg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019caPkdGw9CgAE6b5yfvBn7","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-backend/scripts/create-test-users.js","limit":60}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1138,"cache_read_input_tokens":54383,"cache_creation":{"ephemeral_5m_input_tokens":1138,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CX48kzyvN3ZS41vJJKU19","type":"assistant","uuid":"7659abbf-83ce-49dc-b175-3a509980e2cc","timestamp":"2026-01-12T20:43:18.622Z"}
{"parentUuid":"7659abbf-83ce-49dc-b175-3a509980e2cc","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019caPkdGw9CgAE6b5yfvBn7","type":"tool_result","content":"     1→#!/usr/bin/env node\n     2→/**\n     3→ * Create Test Users Script\n     4→ *\n     5→ * Creates authenticated test users for each subscription tier:\n     6→ * - Starter tier (4 hours/month)\n     7→ * - Pro tier (15 hours/month + 45 min isolation)\n     8→ * - Team tier (50 hours/month + 180 min isolation)\n     9→ *\n    10→ * Usage: node scripts/create-test-users.js\n    11→ */\n    12→\n    13→require('dotenv').config();\n    14→const { Pool } = require('pg');\n    15→const { generateLicenseKey } = require('../services/licenseService');\n    16→\n    17→// SSL Configuration (same as usageTracking.js)\n    18→const sslConfig = process.env.NODE_ENV === 'production' ? {\n    19→  rejectUnauthorized: process.env.DATABASE_SSL_REJECT_UNAUTHORIZED === 'true',\n    20→  ca: process.env.DATABASE_SSL_CA || undefined\n    21→} : false;\n    22→\n    23→const pool = new Pool({\n    24→  connectionString: process.env.DATABASE_URL,\n    25→  ssl: sslConfig,\n    26→  max: 5,\n    27→  idleTimeoutMillis: 30000,\n    28→  connectionTimeoutMillis: 5000\n    29→});\n    30→\n    31→// Test user configurations\n    32→const TEST_USERS = [\n    33→  {\n    34→    email: 'test-starter@splice.video',\n    35→    tier: 'starter',\n    36→    hours_remaining: 4,\n    37→    isolation_hours_remaining: 0,\n    38→    music_credits_remaining: 5,\n    39→    music_credits_total: 5,\n    40→    name: 'Test User - Starter',\n    41→    stripeCustomerId: 'cus_test_starter_001'\n    42→  },\n    43→  {\n    44→    email: 'test-pro@splice.video',\n    45→    tier: 'pro',\n    46→    hours_remaining: 15,\n    47→    isolation_hours_remaining: 0.75, // 45 minutes\n    48→    music_credits_remaining: 20,\n    49→    music_credits_total: 20,\n    50→    name: 'Test User - Pro',\n    51→    stripeCustomerId: 'cus_test_pro_001'\n    52→  },\n    53→  {\n    54→    email: 'test-team@splice.video',\n    55→    tier: 'team',\n    56→    hours_remaining: 50,\n    57→    isolation_hours_remaining: 3, // 180 minutes\n    58→    music_credits_remaining: 100,\n    59→    music_credits_total: 100,\n    60→    name: 'Test User - Team',\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5b986715-45b9-4425-9930-f0de852d0b48","timestamp":"2026-01-12T20:43:18.686Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-backend/scripts/create-test-users.js","content":"#!/usr/bin/env node\n/**\n * Create Test Users Script\n *\n * Creates authenticated test users for each subscription tier:\n * - Starter tier (4 hours/month)\n * - Pro tier (15 hours/month + 45 min isolation)\n * - Team tier (50 hours/month + 180 min isolation)\n *\n * Usage: node scripts/create-test-users.js\n */\n\nrequire('dotenv').config();\nconst { Pool } = require('pg');\nconst { generateLicenseKey } = require('../services/licenseService');\n\n// SSL Configuration (same as usageTracking.js)\nconst sslConfig = process.env.NODE_ENV === 'production' ? {\n  rejectUnauthorized: process.env.DATABASE_SSL_REJECT_UNAUTHORIZED === 'true',\n  ca: process.env.DATABASE_SSL_CA || undefined\n} : false;\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: sslConfig,\n  max: 5,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 5000\n});\n\n// Test user configurations\nconst TEST_USERS = [\n  {\n    email: 'test-starter@splice.video',\n    tier: 'starter',\n    hours_remaining: 4,\n    isolation_hours_remaining: 0,\n    music_credits_remaining: 5,\n    music_credits_total: 5,\n    name: 'Test User - Starter',\n    stripeCustomerId: 'cus_test_starter_001'\n  },\n  {\n    email: 'test-pro@splice.video',\n    tier: 'pro',\n    hours_remaining: 15,\n    isolation_hours_remaining: 0.75, // 45 minutes\n    music_credits_remaining: 20,\n    music_credits_total: 20,\n    name: 'Test User - Pro',\n    stripeCustomerId: 'cus_test_pro_001'\n  },\n  {\n    email: 'test-team@splice.video',\n    tier: 'team',\n    hours_remaining: 50,\n    isolation_hours_remaining: 3, // 180 minutes\n    music_credits_remaining: 100,\n    music_credits_total: 100,\n    name: 'Test User - Team',","numLines":60,"startLine":1,"totalLines":301}},"sourceToolAssistantUUID":"7659abbf-83ce-49dc-b175-3a509980e2cc"}
{"parentUuid":"5b986715-45b9-4425-9930-f0de852d0b48","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011axnZoCogzbrfN661xfwpB","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check the recent commits for more context:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1101,"cache_read_input_tokens":55521,"cache_creation":{"ephemeral_5m_input_tokens":1101,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CX48mDUzt78ZYCU9krway","type":"assistant","uuid":"5df63ebf-c2cc-42cf-8cad-94e3c637110e","timestamp":"2026-01-12T20:43:20.369Z"}
{"parentUuid":"5df63ebf-c2cc-42cf-8cad-94e3c637110e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011axnZoCogzbrfN661xfwpB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011xWw3XwgNk9uvtX1wa2yxS","name":"Bash","input":{"command":"git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git log --oneline -20"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1101,"cache_read_input_tokens":55521,"cache_creation":{"ephemeral_5m_input_tokens":1101,"ephemeral_1h_input_tokens":0},"output_tokens":97,"service_tier":"standard"}},"requestId":"req_011CX48mDUzt78ZYCU9krway","type":"assistant","uuid":"c9e5f807-c678-40d4-89fb-d7d951ed6379","timestamp":"2026-01-12T20:43:20.837Z"}
{"parentUuid":"c9e5f807-c678-40d4-89fb-d7d951ed6379","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011xWw3XwgNk9uvtX1wa2yxS","type":"tool_result","content":"89a6e05 Fix 16 CRITICAL production blockers - CEP panel stability and performance\nd544c84 Fix CEP EvalScript error: Update manifest to CEP 12, add cfprefsd fix script - v6.0.7\n37c3cfd Add better diagnostics to debug EvalScript errors - v6.0.6\n41f9313 Add quick fix for Danny's EvalScript error - enables CEP debug mode\n034d921 Add troubleshooting guide for Danny - extension not opening\n2e0c6dd Add SPLICE CEP v6.0.5 for Danny with debug button fix\na342cd8 Update plugin build with debug modal for Danny's troubleshooting\nad7371c Add DANNY_DOWNLOAD_FIXED.html with correct ZIP file link\nff00371 Fix Danny download issue: update DANNY_DOWNLOAD.html to point to ZIP file with extraction instructions\n8bc8219 Add debug version for Danny Isakov login issue investigation\n5e47942 Fix CEP panel backend URL for Danny\nf9f4788 Fix Vercel build: Add root package.json for monorepo\n8eed2ac Fix Vercel build: Configure root directory and move next.config.ts\n8c02660 Fix Vercel build - configure framework and output directory\ne29c428 Fix Vercel build - configure src directory in next.config.ts\n4c1c610 Add AccessList network permissions to CEP manifest\nb0fa60b Fix CEP panel network permissions - add AccessList to manifest\nff95940 Add vercel.json to enable downloads of installer files\nf90e69a Add downloads folder to middleware exclusions\nbf9e0b9 Remove unused download files - keep only essential installers","is_error":false}]},"uuid":"48a2bd5c-f988-468a-aa40-b8ce825f9364","timestamp":"2026-01-12T20:43:21.422Z","toolUseResult":{"stdout":"89a6e05 Fix 16 CRITICAL production blockers - CEP panel stability and performance\nd544c84 Fix CEP EvalScript error: Update manifest to CEP 12, add cfprefsd fix script - v6.0.7\n37c3cfd Add better diagnostics to debug EvalScript errors - v6.0.6\n41f9313 Add quick fix for Danny's EvalScript error - enables CEP debug mode\n034d921 Add troubleshooting guide for Danny - extension not opening\n2e0c6dd Add SPLICE CEP v6.0.5 for Danny with debug button fix\na342cd8 Update plugin build with debug modal for Danny's troubleshooting\nad7371c Add DANNY_DOWNLOAD_FIXED.html with correct ZIP file link\nff00371 Fix Danny download issue: update DANNY_DOWNLOAD.html to point to ZIP file with extraction instructions\n8bc8219 Add debug version for Danny Isakov login issue investigation\n5e47942 Fix CEP panel backend URL for Danny\nf9f4788 Fix Vercel build: Add root package.json for monorepo\n8eed2ac Fix Vercel build: Configure root directory and move next.config.ts\n8c02660 Fix Vercel build - configure framework and output directory\ne29c428 Fix Vercel build - configure src directory in next.config.ts\n4c1c610 Add AccessList network permissions to CEP manifest\nb0fa60b Fix CEP panel network permissions - add AccessList to manifest\nff95940 Add vercel.json to enable downloads of installer files\nf90e69a Add downloads folder to middleware exclusions\nbf9e0b9 Remove unused download files - keep only essential installers","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"c9e5f807-c678-40d4-89fb-d7d951ed6379"}
{"parentUuid":"a19302fd-ee0a-40c4-9b14-abd81c111541","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01NKBZF5gu6eXW7KomqJnB23","type":"message","role":"assistant","content":[{"type":"text","text":"Let me look at the most recent commit details:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":549,"cache_read_input_tokens":56622,"cache_creation":{"ephemeral_5m_input_tokens":549,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48mRLPVFLsUiQ311jsE","type":"assistant","uuid":"58b71845-d2b4-4be0-9ac2-d2a2d3a184b4","timestamp":"2026-01-12T20:43:23.552Z"}
{"parentUuid":"58b71845-d2b4-4be0-9ac2-d2a2d3a184b4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01NKBZF5gu6eXW7KomqJnB23","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01G5SpU9BzViyUkaGt8RyNdY","name":"Bash","input":{"command":"git --work-tree=/Users/imorgado/SPLICE --git-dir=/Users/imorgado/SPLICE/.git show --stat 89a6e05"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":549,"cache_read_input_tokens":56622,"cache_creation":{"ephemeral_5m_input_tokens":549,"ephemeral_1h_input_tokens":0},"output_tokens":100,"service_tier":"standard"}},"requestId":"req_011CX48mRLPVFLsUiQ311jsE","type":"assistant","uuid":"e1b49590-1d6f-4d84-bdd7-8390b920883a","timestamp":"2026-01-12T20:43:24.004Z"}
{"parentUuid":"e1b49590-1d6f-4d84-bdd7-8390b920883a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01G5SpU9BzViyUkaGt8RyNdY","type":"tool_result","content":"commit 89a6e05de589a50e4390a8720e6fd62e109b40b0\nAuthor: Isaac Morgado <isaacmorgado@users.noreply.github.com>\nDate:   Mon Jan 12 11:50:04 2026 -0500\n\n    Fix 16 CRITICAL production blockers - CEP panel stability and performance\n    \n    Resolves all 18 CRITICAL issues identified in E2E production audit. CEP panel is now production-ready.\n    \n    ## Core Stability Fixes (CRITICAL)\n    - **JSX Bridge Timeout**: Add configurable timeouts (5s/30s/120s/300s) to prevent UI freeze when ExtendScript hangs\n    - **Music Polling Memory Leak**: Add AbortController to cancel in-flight requests on cleanup\n    - **Music Audio Disposal**: Add disposeAudioPlayers() to prevent 2GB memory leak from undisposed Audio objects\n    - **Music DOM Thrashing**: Replace innerHTML loop with DocumentFragment + requestAnimationFrame (prevents 500ms freeze)\n    - **Music Network Timeouts**: Add AbortController to all music fetch calls for proper cancellation\n    - **Music Event Duplication**: Add guard flag to prevent duplicate listener registration (prevents 60 requests after 20 tab switches)\n    \n    ## UI/UX Performance Fixes\n    - **Animated Captions Timeline Loop**: Batch process markers (10 at a time) to prevent 15s UI freeze\n    - **Animated Captions Preview Debounce**: Add 150ms debouncing to prevent layout thrashing\n    - **Main.js Export Timeout**: Add LONG timeout (120s) for audio export operations\n    \n    ## Multitrack Fixes\n    - **Multitrack Race Condition**: Set operation flag immediately before async checks to prevent double operations\n    - **Multitrack JSX Error Handling**: Add timeouts and actionable error messages to all JSX calls\n    - **Multitrack Memory Leak**: Add sequence ID tracking and validation to prevent applying stale results\n    \n    ## Feature Timeouts\n    - **Social Reframe Timeouts**: Add proper timeouts (90s analysis, 120s export, 180s batch)\n    \n    ## Auth/Credits Fixes\n    - **Credits Token Refresh Race**: Add promise deduplication to prevent concurrent token refresh attempts\n    - **Credits Retry Timeout**: Change retry timeout from 120s to 30s for faster failure feedback\n    \n    All fixes include proper error handling, timeout protection, memory leak prevention, and race condition elimination.\n    \n    🤖 Generated with [Claude Code](https://claude.com/claude-code)\n    \n    Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\n\n splice-cep/panel/js/animatedCaptions.js |  67 ++-\n splice-cep/panel/js/config.js           | 842 +++++++++++++++++++++++++++++---\n splice-cep/panel/js/credits.js          |  65 ++-\n splice-cep/panel/js/main.js             | 241 +++++++--\n splice-cep/panel/js/multitrack.js       |  63 ++-\n splice-cep/panel/js/music.js            | 230 +++++++--\n splice-cep/panel/js/socialReframe.js    |   9 +-\n 7 files changed, 1335 insertions(+), 182 deletions(-)","is_error":false}]},"uuid":"86d44fb2-d7e1-4579-839c-e704bdbed74a","timestamp":"2026-01-12T20:43:24.836Z","toolUseResult":{"stdout":"commit 89a6e05de589a50e4390a8720e6fd62e109b40b0\nAuthor: Isaac Morgado <isaacmorgado@users.noreply.github.com>\nDate:   Mon Jan 12 11:50:04 2026 -0500\n\n    Fix 16 CRITICAL production blockers - CEP panel stability and performance\n    \n    Resolves all 18 CRITICAL issues identified in E2E production audit. CEP panel is now production-ready.\n    \n    ## Core Stability Fixes (CRITICAL)\n    - **JSX Bridge Timeout**: Add configurable timeouts (5s/30s/120s/300s) to prevent UI freeze when ExtendScript hangs\n    - **Music Polling Memory Leak**: Add AbortController to cancel in-flight requests on cleanup\n    - **Music Audio Disposal**: Add disposeAudioPlayers() to prevent 2GB memory leak from undisposed Audio objects\n    - **Music DOM Thrashing**: Replace innerHTML loop with DocumentFragment + requestAnimationFrame (prevents 500ms freeze)\n    - **Music Network Timeouts**: Add AbortController to all music fetch calls for proper cancellation\n    - **Music Event Duplication**: Add guard flag to prevent duplicate listener registration (prevents 60 requests after 20 tab switches)\n    \n    ## UI/UX Performance Fixes\n    - **Animated Captions Timeline Loop**: Batch process markers (10 at a time) to prevent 15s UI freeze\n    - **Animated Captions Preview Debounce**: Add 150ms debouncing to prevent layout thrashing\n    - **Main.js Export Timeout**: Add LONG timeout (120s) for audio export operations\n    \n    ## Multitrack Fixes\n    - **Multitrack Race Condition**: Set operation flag immediately before async checks to prevent double operations\n    - **Multitrack JSX Error Handling**: Add timeouts and actionable error messages to all JSX calls\n    - **Multitrack Memory Leak**: Add sequence ID tracking and validation to prevent applying stale results\n    \n    ## Feature Timeouts\n    - **Social Reframe Timeouts**: Add proper timeouts (90s analysis, 120s export, 180s batch)\n    \n    ## Auth/Credits Fixes\n    - **Credits Token Refresh Race**: Add promise deduplication to prevent concurrent token refresh attempts\n    - **Credits Retry Timeout**: Change retry timeout from 120s to 30s for faster failure feedback\n    \n    All fixes include proper error handling, timeout protection, memory leak prevention, and race condition elimination.\n    \n    🤖 Generated with [Claude Code](https://claude.com/claude-code)\n    \n    Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\n\n splice-cep/panel/js/animatedCaptions.js |  67 ++-\n splice-cep/panel/js/config.js           | 842 +++++++++++++++++++++++++++++---\n splice-cep/panel/js/credits.js          |  65 ++-\n splice-cep/panel/js/main.js             | 241 +++++++--\n splice-cep/panel/js/multitrack.js       |  63 ++-\n splice-cep/panel/js/music.js            | 230 +++++++--\n splice-cep/panel/js/socialReframe.js    |   9 +-\n 7 files changed, 1335 insertions(+), 182 deletions(-)","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"e1b49590-1d6f-4d84-bdd7-8390b920883a"}
{"parentUuid":"6f414a0f-7e76-4229-97c9-c76d7c7d8d09","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XtFLyC8NDRbaqRjTZZe4Ju","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me get a better summary of backend changes by checking which services and features are new:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":990,"cache_read_input_tokens":57171,"cache_creation":{"ephemeral_5m_input_tokens":990,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48mfq29583JMxYnPAuP","type":"assistant","uuid":"62f6bfcc-f2fc-44ec-83f5-9f542d869320","timestamp":"2026-01-12T20:43:26.767Z"}
{"parentUuid":"62f6bfcc-f2fc-44ec-83f5-9f542d869320","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01XtFLyC8NDRbaqRjTZZe4Ju","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GoezAmszmG93BHyGqMphsQ","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-backend/services/faceDetectionPro.js","limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":990,"cache_read_input_tokens":57171,"cache_creation":{"ephemeral_5m_input_tokens":990,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48mfq29583JMxYnPAuP","type":"assistant","uuid":"cea46c00-58b0-4bfe-acbc-3ab06a0ad2ef","timestamp":"2026-01-12T20:43:27.450Z"}
{"parentUuid":"cea46c00-58b0-4bfe-acbc-3ab06a0ad2ef","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GoezAmszmG93BHyGqMphsQ","type":"tool_result","content":"     1→/**\n     2→ * SPLICE Face Detection Service (Production-Ready)\n     3→ *\n     4→ * Based on FireCut's approach using face-api.js\n     5→ *\n     6→ * Models:\n     7→ * - SSD MobileNet v1 (fast, primary detection)\n     8→ * - MTCNN (accurate, fallback detection)\n     9→ *\n    10→ * Features:\n    11→ * - Face center calculation for zoom positioning\n    12→ * - Frame extraction from video using FFmpeg\n    13→ * - Safe zoom coordinate clamping\n    14→ * - Batch detection at multiple timestamps\n    15→ * - Retry with temporal fallback\n    16→ */\n    17→\n    18→const path = require('path');\n    19→const fs = require('fs').promises;\n    20→const { exec } = require('child_process');\n    21→const { promisify } = require('util');\n    22→const execAsync = promisify(exec);\n    23→\n    24→// Face detection library\n    25→const faceapi = require('face-api.js');\n    26→const canvas = require('canvas');\n    27→const { Canvas, Image, ImageData } = canvas;\n    28→\n    29→// Security utilities\n    30→const { validateAudioPath } = require('./securityUtils');\n    31→\n    32→// Polyfill for Node.js environment\n    33→faceapi.env.monkeyPatch({ Canvas, Image, ImageData });\n    34→\n    35→// ============================================================================\n    36→// CONFIGURATION\n    37→// ============================================================================\n    38→\n    39→const MODELS_DIR = path.join(__dirname, '../models/face-api');\n    40→const TEMP_DIR = path.join(__dirname, '../../temp/face-detection');\n    41→\n    42→// Face detection options (matching FireCut settings)\n    43→const SSD_OPTIONS = {\n    44→  minConfidence: 0.5,\n    45→  maxResults: 1\n    46→};\n    47→\n    48→const MTCNN_OPTIONS = {\n    49→  minFaceSize: 50,\n    50→  scaleFactor: 0.709\n    51→};\n    52→\n    53→// Retry offsets for temporal fallback (seconds)\n    54→const DEFAULT_OFFSETS = [0, 1, -1]; // Try exact, +1s, -1s\n    55→\n    56→// Safe zoom margin (prevents edge cropping at 150% zoom)\n    57→const SAFE_ZOOM_MARGIN = 25; // 25% margin (150% / 2 = 75%)\n    58→\n    59→// ============================================================================\n    60→// FACE DETECTION SERVICE CLASS\n    61→// ============================================================================\n    62→\n    63→class FaceDetectionService {\n    64→  constructor() {\n    65→    this.modelsLoaded = false;\n    66→    this.loadingPromise = null;\n    67→  }\n    68→\n    69→  /**\n    70→   * Initialize face detection models\n    71→   * Loads SSD MobileNet v1 and MTCNN models from disk\n    72→   */\n    73→  async initialize() {\n    74→    if (this.modelsLoaded) return;\n    75→    if (this.loadingPromise) return this.loadingPromise;\n    76→\n    77→    this.loadingPromise = (async () => {\n    78→      try {\n    79→        console.log('[Face Detection] Loading models from:', MODELS_DIR);\n    80→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"302f6a74-ffed-44db-aeee-59e5959dbefe","timestamp":"2026-01-12T20:43:27.496Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-backend/services/faceDetectionPro.js","content":"/**\n * SPLICE Face Detection Service (Production-Ready)\n *\n * Based on FireCut's approach using face-api.js\n *\n * Models:\n * - SSD MobileNet v1 (fast, primary detection)\n * - MTCNN (accurate, fallback detection)\n *\n * Features:\n * - Face center calculation for zoom positioning\n * - Frame extraction from video using FFmpeg\n * - Safe zoom coordinate clamping\n * - Batch detection at multiple timestamps\n * - Retry with temporal fallback\n */\n\nconst path = require('path');\nconst fs = require('fs').promises;\nconst { exec } = require('child_process');\nconst { promisify } = require('util');\nconst execAsync = promisify(exec);\n\n// Face detection library\nconst faceapi = require('face-api.js');\nconst canvas = require('canvas');\nconst { Canvas, Image, ImageData } = canvas;\n\n// Security utilities\nconst { validateAudioPath } = require('./securityUtils');\n\n// Polyfill for Node.js environment\nfaceapi.env.monkeyPatch({ Canvas, Image, ImageData });\n\n// ============================================================================\n// CONFIGURATION\n// ============================================================================\n\nconst MODELS_DIR = path.join(__dirname, '../models/face-api');\nconst TEMP_DIR = path.join(__dirname, '../../temp/face-detection');\n\n// Face detection options (matching FireCut settings)\nconst SSD_OPTIONS = {\n  minConfidence: 0.5,\n  maxResults: 1\n};\n\nconst MTCNN_OPTIONS = {\n  minFaceSize: 50,\n  scaleFactor: 0.709\n};\n\n// Retry offsets for temporal fallback (seconds)\nconst DEFAULT_OFFSETS = [0, 1, -1]; // Try exact, +1s, -1s\n\n// Safe zoom margin (prevents edge cropping at 150% zoom)\nconst SAFE_ZOOM_MARGIN = 25; // 25% margin (150% / 2 = 75%)\n\n// ============================================================================\n// FACE DETECTION SERVICE CLASS\n// ============================================================================\n\nclass FaceDetectionService {\n  constructor() {\n    this.modelsLoaded = false;\n    this.loadingPromise = null;\n  }\n\n  /**\n   * Initialize face detection models\n   * Loads SSD MobileNet v1 and MTCNN models from disk\n   */\n  async initialize() {\n    if (this.modelsLoaded) return;\n    if (this.loadingPromise) return this.loadingPromise;\n\n    this.loadingPromise = (async () => {\n      try {\n        console.log('[Face Detection] Loading models from:', MODELS_DIR);\n","numLines":80,"startLine":1,"totalLines":406}},"sourceToolAssistantUUID":"cea46c00-58b0-4bfe-acbc-3ab06a0ad2ef"}
{"parentUuid":"302f6a74-ffed-44db-aeee-59e5959dbefe","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011NhsGMPzgnSmSvgi1AiJxW","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect. Now let me create a comprehensive summary report. Let me check the git diff summary once more to be thorough:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1150,"cache_read_input_tokens":58161,"cache_creation":{"ephemeral_5m_input_tokens":1150,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48ms5wHk6De4hnnXz6p","type":"assistant","uuid":"a6b4d7bc-8857-40e4-8540-f53009bdf3cf","timestamp":"2026-01-12T20:43:29.478Z"}
{"parentUuid":"a6b4d7bc-8857-40e4-8540-f53009bdf3cf","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011NhsGMPzgnSmSvgi1AiJxW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FCqvthHCQwFkrZWUiS8GzB","name":"Bash","input":{"command":"git status --short | grep \"^\\?\" | wc -l"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1150,"cache_read_input_tokens":58161,"cache_creation":{"ephemeral_5m_input_tokens":1150,"ephemeral_1h_input_tokens":0},"output_tokens":102,"service_tier":"standard"}},"requestId":"req_011CX48ms5wHk6De4hnnXz6p","type":"assistant","uuid":"b932b69e-1cbe-41e6-b89e-6389e3f676e1","timestamp":"2026-01-12T20:43:29.920Z"}
{"parentUuid":"b932b69e-1cbe-41e6-b89e-6389e3f676e1","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FCqvthHCQwFkrZWUiS8GzB","type":"tool_result","content":"     211","is_error":false}]},"uuid":"fc6b3811-0a73-4984-9c48-9dd7fbc47ac0","timestamp":"2026-01-12T20:43:30.029Z","toolUseResult":{"stdout":"     211","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"b932b69e-1cbe-41e6-b89e-6389e3f676e1"}
{"parentUuid":"afd3dbef-0909-43c9-a1fb-badc2ae688c5","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"8ed1bd1d-99da-4880-9c1b-15fe12d3626d","version":"2.1.5","gitBranch":"main","agentId":"a398c92","slug":"mighty-sparking-clover","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Q21Z9Bu5SPYioowctnrfwk","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create a comprehensive summary:\n\n## Summary of Recent Changes to splice-backend\n\nBased on my exploration of the splice-backend directory, here's a comprehensive summary of the work that was in progress:\n\n### Version Bump\n**6.0.3 → 6.0.8** (5 versions of incremental improvements since last stable)\n\n---\n\n## Major Features & Work In Progress\n\n### 1. **Security & Authentication Hardening** (COMPLETED)\n**File:** `middleware/auth.js` (+126 lines)\n\n- **JWT Token Management**\n  - Added token blacklist system with Redis backend\n  - Implemented fallback in-memory storage when Redis unavailable\n  - Added token revocation (logout) with TTL-based auto-expiry\n  - Added `jti` (JWT ID) claim to each token for unique identification\n\n- **Legacy Authentication Deprecation** (Planned sunset: 2026-04-11)\n  - Deprecated `x-stripe-customer-id` header authentication\n  - Added configurable `ALLOW_LEGACY_AUTH` flag (disabled in production, enabled in dev)\n  - Added deprecation warnings to responses (`X-Deprecation-Warning`, `X-Deprecation-Sunset` headers)\n  - Migration path: Switch to JWT Bearer token authentication\n\n- **Admin RBAC** (HIGH-007)\n  - Added `requireAdmin` middleware with database-backed role checking\n  - Queries user roles from PostgreSQL instead of environment variables\n  - Proper access denial logging\n\n- **JWT Security Enforcement** (HIGH-001)\n  - Production-only checks: JWT_SECRET must be 64+ characters (512 bits)\n  - Exits process on startup if security requirements not met\n\n---\n\n### 2. **Input Validation & Security** (COMPLETED)\n**File:** `middleware/inputValidation.js` (+138 lines)\n\n- Comprehensive input validation functions:\n  - `validateString()` - Type checking, length limits, sanitization\n  - `validateNumber()` - Range validation, type coercion\n  - `validateBoolean()` - Flexible boolean parsing\n  - Email validation with RFC-compliant regex\n  - File upload validation (type whitelist, size enforcement)\n  - Path traversal prevention\n\n---\n\n### 3. **Rate Limiting Expansion** (COMPLETED)\n**File:** `middleware/rateLimiter.js` (+90 lines)\n\nAdded comprehensive rate limiting for expensive/AI endpoints:\n\n| Endpoint Category | Rate Limit | Reason |\n|---|---|---|\n| `/auth/login` | 10/min | Brute force prevention |\n| `/music/generate` | 10/min | Expensive AI API calls |\n| `/music/status` | 60/min | Status polling |\n| `/captions/animate` | 15/min | Compute-intensive transcription |\n| `/detection/takes`, `/detection/scenes` | 20/min | Face/scene detection |\n| `/chapters/detect` | 15/min | AI-powered chapter detection |\n| `/youtube/generate`, `/zoom/generate` | 10/min | Content generation |\n| `/batch/start` | 5/min | Batch operations (very expensive) |\n| `/referral/validate` | 10/min | Brute force on referral codes |\n\n**Security Intent:** Prevent API cost escalation, DoS on compute-intensive endpoints, and referral code brute-forcing\n\n---\n\n### 4. **Music Generation Service Improvements** (COMPLETED)\n**File:** `services/musicGeneration.js` (+55 lines)\n\n- **Timeout Handling**\n  - Added wall-clock timeout (10-minute hard limit) in addition to attempt count\n  - Tracks elapsed time vs max attempts independently\n  - Better timeout error messages\n\n- **Resilience to Transient Failures**\n  - Added consecutive failure tracking (aborts after 3 network failures)\n  - Distinguishes transient errors (timeout, connection refused) from fatal errors\n  - Improved error handling in polling loop\n\n- **Mureka API Integration**\n  - Updated MAX_TOTAL_TIME_MS = 10 minutes wall-clock limit\n  - Better progress reporting\n\n---\n\n### 5. **Deadlock Retry Helper for Database Operations** (COMPLETED)\n**File:** `services/usageTracking.js` (+77 lines)\n\n- **ERROR-HANDLING-HIGH-001: Automatic Deadlock Recovery**\n  - New `withDeadlockRetry()` function\n  - Retries on PostgreSQL error codes: 40P01 (deadlock), 40001 (serialization failure)\n  - Exponential backoff with jitter\n  - Configurable max retries (default: 3), base delay (default: 100ms)\n  - Helps prevent race conditions on concurrent credit/usage updates\n\n---\n\n### 6. **Performance Optimizations** (COMPLETED)\n**File:** `server.js` (+46 lines)\n\n- **PERF-003: Response Compression**\n  - Added gzip/deflate compression middleware\n  - 40-60% payload reduction for text responses\n  - Threshold: 1KB+ responses only\n  - Configurable compression level (default: 6)\n\n- **CORS Whitelist Expansion**\n  - Added `splice.video` and `www.splice.video` domains\n  - Added `splice-dusky.vercel.app` (staging environment)\n\n- **Version Update**\n  - Updated Sentry release version to 6.0.8\n\n- **Graceful Shutdown**\n  - Improved music worker shutdown tracking\n  - Proper cleanup on process termination\n\n---\n\n### 7. **New Feature: Auto Zoom with Face Detection** (IN PROGRESS)\n**Files:** \n- `routes/zoomPro.js` (NEW)\n- `services/faceDetectionPro.js` (NEW)\n- Package additions: `canvas`, `face-api.js`, `fluent-ffmpeg`\n\n**Status:** Framework in place, endpoints defined\n- `/zoom-pro/detect-faces` - Detect faces at multiple timestamps\n- Uses FFmpeg for frame extraction\n- face-api.js with SSD MobileNet v1 + MTCNN fallback\n- Safe zoom coordinate clamping (prevents edge cropping at 150% zoom)\n- Batch detection with temporal fallback (±1 second tolerance)\n\n**Notes:**\n- Models need to be downloaded/installed separately\n- Requires temporary directory setup for frame extraction\n\n---\n\n### 8. **New Feature: Workflow Automation** (IN PROGRESS)\n**Files:**\n- `routes/workflows.js` (NEW)\n- `services/workflowExecutor.js` (NEW)\n- `migrations/001_create_workflows.sql` (NEW)\n\n**Status:** API structure in place\n- REST endpoints for workflow CRUD operations\n- Workflow execution engine\n- Based on FireCut's workflow system\n- Database schema migration needed\n\n---\n\n### 9. **Test Infrastructure** (NEW)\n**Files:**\n- `scripts/create-test-users.js` (NEW)\n- `scripts/verify-test-users.js` (NEW)\n- `scripts/run-migration.js` (NEW)\n\n**Status:** Ready to use\n- Creates test users for each tier:\n  - Starter: 4h, 5 music credits\n  - Pro: 15h + 45min isolation, 20 music credits\n  - Team: 50h + 3h isolation, 100 music credits\n- Test user licenses can be used for authentication testing\n- Verification script confirms test users work correctly\n\n**Usage:**\n```bash\nnpm run test:users:create  # Create test users\nnpm run test:users         # Verify they authenticate\n```\n\n---\n\n### 10. **Music Route Refactoring** (COMPLETED)\n**File:** `routes/music.js` (+66 lines)\n\n- Added service lazy loading on first request\n- Updated `requireCredits` middleware calls to include endpoint-specific tracking:\n  - `music-identify`\n  - `music-generate`\n  - `music-generate-variations`\n  - `music-generate-scene-aware`\n  - `music-status`\n  - `music-variations-status`\n  - `music-variations-select`\n  - `music-library`\n  - `music-download`\n  - `music-delete`\n  - `music-align`\n  - `music-queue-stats`\n\n---\n\n## Patterns Observed\n\n### Security Focus (PRIMARY)\n1. **Token Management**: Redis-backed with fallback, auto-expiry\n2. **Rate Limiting**: Comprehensive coverage of expensive endpoints\n3. **Admin RBAC**: Database-driven, not env-var-driven\n4. **Input Validation**: Strict type checking and sanitization\n5. **Deprecation Strategy**: 90-day sunset window for legacy auth\n\n### Performance Focus (SECONDARY)\n1. **Compression**: Reduce payload sizes by 40-60%\n2. **Connection Pooling**: Better resource management\n3. **Lazy Loading**: Initialize services on-demand\n\n### Reliability Focus (TERTIARY)\n1. **Deadlock Retry**: Handle race conditions gracefully\n2. **Timeout Protection**: Wall-clock limits, not just attempt counts\n3. **Transient Error Handling**: Distinguish network errors from fatal errors\n4. **Graceful Shutdown**: Proper cleanup on process termination\n\n---\n\n## Incomplete/In-Progress Work\n\n### 1. **Face Detection Service**\n- ✅ Service framework exists\n- ❌ Models not installed (need separate download)\n- ❌ Temp directory setup needed\n- ❌ Integration tests needed\n\n### 2. **Workflow Automation**\n- ✅ API routes defined\n- ✅ Database migration file exists\n- ❌ Migration not yet run\n- ❌ Executor service implementation incomplete\n- ❌ Workflow execution logic needs testing\n\n### 3. **Test Users**\n- ✅ Creation script exists\n- ✅ Verification script exists\n- ❌ Not yet populated in database (need to run scripts)\n\n---\n\n## Dependencies Added\n\n```json\n{\n  \"canvas\": \"^2.11.2\",           // Face detection image processing\n  \"compression\": \"^1.8.0\",       // Response gzip/deflate\n  \"express-validator\": \"^7.3.1\", // Input validation\n  \"face-api.js\": \"^0.22.2\",      // Face detection models\n  \"fluent-ffmpeg\": \"^2.1.2\"      // Video frame extraction\n}\n```\n\n---\n\n## Deployment Checklist\n\n### Before Production Deployment:\n- [ ] Set `JWT_SECRET` to 64+ character secure value\n- [ ] Configure Redis (Railway Redis or Upstash)\n- [ ] Run workflow database migration: `npm run scripts/run-migration.js`\n- [ ] Disable legacy auth: `ALLOW_LEGACY_AUTH=false`\n- [ ] Download face detection models to `./models/face-api/`\n- [ ] Create `./temp/face-detection/` directory\n- [ ] Test rate limits don't block legitimate users\n- [ ] Verify token blacklist cleanup interval (15 minutes)\n\n### Post-Deployment Monitoring:\n- Monitor Redis connection status (fallback alerts)\n- Track deadlock retry rates (should be < 1%)\n- Watch token blacklist growth\n- Check music worker stability\n- Verify face detection performance (should be <2s per frame)\n\n---\n\n## Key Files Modified\n1. `middleware/auth.js` - JWT + token blacklist + admin RBAC\n2. `middleware/inputValidation.js` - Input validation utilities\n3. `middleware/rateLimiter.js` - Comprehensive rate limits\n4. `server.js` - Compression, CORS, graceful shutdown\n5. `services/musicGeneration.js` - Better timeout handling\n6. `services/usageTracking.js` - Deadlock retry helper\n7. `routes/music.js` - Endpoint-specific credit tracking\n8. `package.json` - Version bump + new dependencies\n\n## New Files Added\n1. `routes/zoomPro.js` - Face detection endpoints\n2. `routes/workflows.js` - Workflow automation API\n3. `services/faceDetectionPro.js` - Face detection service\n4. `services/workflowExecutor.js` - Workflow execution engine\n5. `migrations/001_create_workflows.sql` - Database schema\n6. `scripts/create-test-users.js` - Test user setup\n7. `scripts/verify-test-users.js` - Test user verification\n8. `scripts/run-migration.js` - Database migration runner"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":139,"cache_read_input_tokens":59311,"cache_creation":{"ephemeral_5m_input_tokens":139,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX48n4GeGUyeEudA6xQLx","type":"assistant","uuid":"eddd0270-e349-4902-a461-915f0898b3ac","timestamp":"2026-01-12T20:43:58.802Z"}
