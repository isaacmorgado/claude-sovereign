     1→/**
     2→ * SPLICE Email Service
     3→ *
     4→ * Handles email delivery for license keys, payment notifications, etc.
     5→ * Supports multiple providers: SendGrid (primary), AWS SES (fallback)
     6→ *
     7→ * Required env vars:
     8→ * - EMAIL_PROVIDER: 'sendgrid' | 'ses' | 'console' (default: 'console' for dev)
     9→ * - SENDGRID_API_KEY: SendGrid API key
    10→ * - AWS_SES_REGION: AWS SES region (default: 'us-east-1')
    11→ * - AWS_ACCESS_KEY_ID: AWS access key (for SES)
    12→ * - AWS_SECRET_ACCESS_KEY: AWS secret (for SES)
    13→ * - EMAIL_FROM: Sender email address (default: 'noreply@splice.video')
    14→ */
    15→
    16→// ============================================================================
    17→// CONFIGURATION
    18→// ============================================================================
    19→
    20→const EMAIL_CONFIG = {
    21→  provider: process.env.EMAIL_PROVIDER || 'console',
    22→  from: process.env.EMAIL_FROM || 'SPLICE <noreply@splice.video>',
    23→  replyTo: process.env.EMAIL_REPLY_TO || 'support@splice.video',
    24→  sendgrid: {
    25→    apiKey: process.env.SENDGRID_API_KEY
    26→  },
    27→  ses: {
    28→    region: process.env.AWS_SES_REGION || 'us-east-1'
    29→  }
    30→};
    31→
    32→// Email templates
    33→const TEMPLATES = {
    34→  licenseKey: {
    35→    subject: 'Your SPLICE License Key',
    36→    html: (data) => `
    37→<!DOCTYPE html>
    38→<html>
    39→<head>
    40→  <meta charset="utf-8">
    41→  <style>
    42→    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
    43→    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
    44→    .header { text-align: center; margin-bottom: 30px; }
    45→    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }
    46→    .license-box { background: #f8f5ff; border: 2px solid #7c3aed; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }
    47→    .license-key { font-family: monospace; font-size: 24px; font-weight: bold; color: #7c3aed; letter-spacing: 2px; }
    48→    .tier-badge { display: inline-block; background: #7c3aed; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-top: 10px; }
    49→    .instructions { background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; }
    50→    .instructions h3 { margin-top: 0; color: #374151; }
    51→    .instructions ol { margin: 0; padding-left: 20px; }
    52→    .instructions li { margin: 8px 0; }
    53→    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }
    54→    .button { display: inline-block; background: #7c3aed; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }
    55→  </style>
    56→</head>
    57→<body>
    58→  <div class="container">
    59→    <div class="header">
    60→      <div class="logo">SPLICE</div>
    61→      <p>AI-Powered Video Editing</p>
    62→    </div>
    63→
    64→    <h2>Welcome to SPLICE!</h2>
    65→    <p>Thank you for subscribing. Your license key is ready:</p>
    66→
    67→    <div class="license-box">
    68→      <div class="license-key">${escapeHtml(data.licenseKey)}</div>
    69→      <div class="tier-badge">${escapeHtml(data.tier.toUpperCase())} Plan</div>
    70→    </div>
    71→
    72→    <div class="instructions">
    73→      <h3>How to Activate</h3>
    74→      <ol>
    75→        <li>Open Adobe Premiere Pro</li>
    76→        <li>Go to <strong>Window > Extensions > SPLICE</strong></li>
    77→        <li>Click the <strong>Settings</strong> icon (gear)</li>
    78→        <li>Enter your license key in the activation field</li>
    79→        <li>Click <strong>Activate</strong></li>
    80→      </ol>
    81→    </div>
    82→
    83→    <p>Your ${escapeHtml(data.tier)} plan includes:</p>
    84→    <ul>
    85→      <li><strong>${escapeHtml(String(data.hours))} hours</strong> of AI processing per month</li>
    86→      <li><strong>${escapeHtml(String(data.musicCredits))} music credits</strong> per month</li>
    87→      <li>All premium features</li>
    88→    </ul>
    89→
    90→    <p style="text-align: center;">
    91→      <a href="https://splice.video/docs/getting-started" class="button">View Getting Started Guide</a>
    92→    </p>
    93→
    94→    <div class="footer">
    95→      <p>Need help? Reply to this email or visit <a href="https://splice.video/support">splice.video/support</a></p>
    96→      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
    97→    </div>
    98→  </div>
    99→</body>
   100→</html>
   101→    `,
   102→    text: (data) => `
   103→SPLICE - Your License Key
   104→
   105→Thank you for subscribing to SPLICE!
   106→
   107→Your license key: ${data.licenseKey}
   108→Plan: ${data.tier.toUpperCase()}
   109→
   110→HOW TO ACTIVATE:
   111→1. Open Adobe Premiere Pro
   112→2. Go to Window > Extensions > SPLICE
   113→3. Click the Settings icon (gear)
   114→4. Enter your license key in the activation field
   115→5. Click Activate
   116→
   117→Your ${data.tier} plan includes:
   118→- ${data.hours} hours of AI processing per month
   119→- ${data.musicCredits} music credits per month
   120→- All premium features
   121→
   122→Need help? Visit https://splice.video/support
   123→
   124→© ${new Date().getFullYear()} SPLICE. All rights reserved.
   125→    `
   126→  },
   127→
   128→  paymentWarning: {
   129→    subject: 'Action Required: Payment Failed for SPLICE',
   130→    html: (data) => `
   131→<!DOCTYPE html>
   132→<html>
   133→<head>
   134→  <meta charset="utf-8">
   135→  <style>
   136→    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
   137→    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
   138→    .header { text-align: center; margin-bottom: 30px; }
   139→    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }
   140→    .warning-box { background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; padding: 20px; margin: 20px 0; }
   141→    .warning-icon { font-size: 48px; text-align: center; }
   142→    .button { display: inline-block; background: #7c3aed; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }
   143→    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }
   144→  </style>
   145→</head>
   146→<body>
   147→  <div class="container">
   148→    <div class="header">
   149→      <div class="logo">SPLICE</div>
   150→    </div>
   151→
   152→    <div class="warning-box">
   153→      <div class="warning-icon">⚠️</div>
   154→      <h2 style="text-align: center; color: #dc2626; margin: 10px 0;">Payment Failed</h2>
   155→      <p>We were unable to process your payment for your SPLICE subscription. This was attempt ${escapeHtml(String(data.attemptCount))} of 3.</p>
   156→    </div>
   157→
   158→    <p>To keep your subscription active and avoid interruption to your service, please update your payment method:</p>
   159→
   160→    <p style="text-align: center;">
   161→      <a href="https://splice.video/account/billing" class="button">Update Payment Method</a>
   162→    </p>
   163→
   164→    <p><strong>What happens next?</strong></p>
   165→    <ul>
   166→      <li>We'll automatically retry the payment in a few days</li>
   167→      <li>If all payment attempts fail, your subscription will be cancelled</li>
   168→      <li>You'll lose access to premium features</li>
   169→    </ul>
   170→
   171→    <p>If you have any questions or need assistance, please don't hesitate to reach out.</p>
   172→
   173→    <div class="footer">
   174→      <p>Need help? Reply to this email or visit <a href="https://splice.video/support">splice.video/support</a></p>
   175→      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
   176→    </div>
   177→  </div>
   178→</body>
   179→</html>
   180→    `,
   181→    text: (data) => `
   182→SPLICE - Payment Failed
   183→
   184→We were unable to process your payment for your SPLICE subscription.
   185→This was attempt ${data.attemptCount} of 3.
   186→
   187→To keep your subscription active, please update your payment method:
   188→https://splice.video/account/billing
   189→
   190→WHAT HAPPENS NEXT:
   191→- We'll automatically retry the payment in a few days
   192→- If all payment attempts fail, your subscription will be cancelled
   193→- You'll lose access to premium features
   194→
   195→If you have any questions, please reply to this email.
   196→
   197→© ${new Date().getFullYear()} SPLICE. All rights reserved.
   198→    `
   199→  },
   200→
   201→  licenseLookup: {
   202→    subject: 'Your SPLICE License Key',
   203→    html: (data) => `
   204→<!DOCTYPE html>
   205→<html>
   206→<head>
   207→  <meta charset="utf-8">
   208→  <style>
   209→    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
   210→    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
   211→    .header { text-align: center; margin-bottom: 30px; }
   212→    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }
   213→    .license-box { background: #f8f5ff; border: 2px solid #7c3aed; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }
   214→    .license-key { font-family: monospace; font-size: 24px; font-weight: bold; color: #7c3aed; letter-spacing: 2px; }
   215→    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }
   216→  </style>
   217→</head>
   218→<body>
   219→  <div class="container">
   220→    <div class="header">
   221→      <div class="logo">SPLICE</div>
   222→    </div>
   223→
   224→    <h2>License Key Lookup</h2>
   225→    <p>You requested your SPLICE license key. Here it is:</p>
   226→
   227→    <div class="license-box">
   228→      <div class="license-key">${escapeHtml(data.licenseKey)}</div>
   229→    </div>
   230→
   231→    <p>If you didn't request this, you can safely ignore this email.</p>
   232→
   233→    <div class="footer">
   234→      <p>Need help? Reply to this email or visit <a href="https://splice.video/support">splice.video/support</a></p>
   235→      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>
   236→    </div>
   237→  </div>
   238→</body>
   239→</html>
   240→    `,
   241→    text: (data) => `
   242→SPLICE - License Key Lookup
   243→
   244→You requested your SPLICE license key. Here it is:
   245→
   246→${data.licenseKey}
   247→
   248→If you didn't request this, you can safely ignore this email.
   249→
   250→Need help? Visit https://splice.video/support
   251→
   252→© ${new Date().getFullYear()} SPLICE. All rights reserved.
   253→    `
   254→  }
   255→};
   256→
   257→// ============================================================================
   258→// HELPER FUNCTIONS
   259→// ============================================================================
   260→
   261→/**
   262→ * Escape HTML to prevent XSS in email content
   263→ */
   264→function escapeHtml(str) {
   265→  if (str === null || str === undefined) return '';
   266→  if (typeof str !== 'string') str = String(str);
   267→
   268→  const escapeMap = {
   269→    '&': '&amp;',
   270→    '<': '&lt;',
   271→    '>': '&gt;',
   272→    '"': '&quot;',
   273→    "'": '&#x27;'
   274→  };
   275→
   276→  return str.replace(/[&<>"']/g, char => escapeMap[char]);
   277→}
   278→
   279→/**
   280→ * Get tier details for email
   281→ */
   282→function getTierDetails(tier) {
   283→  const tiers = {
   284→    starter: { hours: 4, musicCredits: 2 },
   285→    pro: { hours: 15, musicCredits: 10 },
   286→    team: { hours: 50, musicCredits: 50 }
   287→  };
   288→  return tiers[tier] || tiers.starter;
   289→}
   290→
   291→// ============================================================================
   292→// EMAIL PROVIDERS
   293→// ============================================================================
   294→
   295→/**
   296→ * Send email via SendGrid
   297→ */
   298→async function sendViaSendGrid(to, subject, html, text) {
   299→  if (!EMAIL_CONFIG.sendgrid.apiKey) {
   300→    throw new Error('SENDGRID_API_KEY not configured');
   301→  }
   302→
   303→  const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
   304→    method: 'POST',
   305→    headers: {
   306→      'Authorization': `Bearer ${EMAIL_CONFIG.sendgrid.apiKey}`,
   307→      'Content-Type': 'application/json'
   308→    },
   309→    body: JSON.stringify({
   310→      personalizations: [{ to: [{ email: to }] }],
   311→      from: { email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || EMAIL_CONFIG.from, name: 'SPLICE' },
   312→      reply_to: { email: EMAIL_CONFIG.replyTo },
   313→      subject,
   314→      content: [
   315→        { type: 'text/plain', value: text },
   316→        { type: 'text/html', value: html }
   317→      ]
   318→    })
   319→  });
   320→
   321→  if (!response.ok) {
   322→    const error = await response.text();
   323→    throw new Error(`SendGrid error: ${response.status} - ${error}`);
   324→  }
   325→
   326→  return { provider: 'sendgrid', messageId: response.headers.get('x-message-id') };
   327→}
   328→
   329→/**
   330→ * Send email via AWS SES
   331→ */
   332→async function sendViaSES(to, subject, html, text) {
   333→  // Dynamically import AWS SDK to avoid loading if not needed
   334→  try {
   335→    const { SESClient, SendEmailCommand } = await import('@aws-sdk/client-ses');
   336→
   337→    const client = new SESClient({ region: EMAIL_CONFIG.ses.region });
   338→
   339→    const command = new SendEmailCommand({
   340→      Source: EMAIL_CONFIG.from,
   341→      Destination: { ToAddresses: [to] },
   342→      ReplyToAddresses: [EMAIL_CONFIG.replyTo],
   343→      Message: {
   344→        Subject: { Data: subject, Charset: 'UTF-8' },
   345→        Body: {
   346→          Html: { Data: html, Charset: 'UTF-8' },
   347→          Text: { Data: text, Charset: 'UTF-8' }
   348→        }
   349→      }
   350→    });
   351→
   352→    const result = await client.send(command);
   353→    return { provider: 'ses', messageId: result.MessageId };
   354→  } catch (err) {
   355→    if (err.code === 'ERR_MODULE_NOT_FOUND') {
   356→      throw new Error('AWS SDK not installed. Run: npm install @aws-sdk/client-ses');
   357→    }
   358→    throw err;
   359→  }
   360→}
   361→
   362→/**
   363→ * Log email to console (development mode)
   364→ */
   365→function sendViaConsole(to, subject, html, text) {
   366→  console.log('\n========== EMAIL (CONSOLE MODE) ==========');
   367→  console.log(`To: ${to}`);
   368→  console.log(`Subject: ${subject}`);
   369→  console.log(`From: ${EMAIL_CONFIG.from}`);
   370→  console.log('--- TEXT VERSION ---');
   371→  console.log(text);
   372→  console.log('==========================================\n');
   373→
   374→  return { provider: 'console', messageId: `console-${Date.now()}` };
   375→}
   376→
   377→// ============================================================================
   378→// PUBLIC API
   379→// ============================================================================
   380→
   381→/**
   382→ * Send an email using the configured provider
   383→ * @param {string} to - Recipient email
   384→ * @param {string} subject - Email subject
   385→ * @param {string} html - HTML content
   386→ * @param {string} text - Plain text content
   387→ * @returns {Promise<{provider: string, messageId: string}>}
   388→ */
   389→async function sendEmail(to, subject, html, text) {
   390→  const provider = EMAIL_CONFIG.provider.toLowerCase();
   391→
   392→  console.log(`[SPLICE Email] Sending to ${to} via ${provider}`);
   393→
   394→  try {
   395→    let result;
   396→
   397→    switch (provider) {
   398→      case 'sendgrid':
   399→        result = await sendViaSendGrid(to, subject, html, text);
   400→        break;
   401→      case 'ses':
   402→        result = await sendViaSES(to, subject, html, text);
   403→        break;
   404→      case 'console':
   405→      default:
   406→        result = sendViaConsole(to, subject, html, text);
   407→        break;
   408→    }
   409→
   410→    console.log(`[SPLICE Email] Sent successfully via ${result.provider}: ${result.messageId}`);
   411→    return result;
   412→  } catch (err) {
   413→    console.error(`[SPLICE Email] Failed to send via ${provider}:`, err.message);
   414→    throw err;
   415→  }
   416→}
   417→
   418→/**
   419→ * Send license key email to customer
   420→ * @param {string} email - Customer email
   421→ * @param {string} licenseKey - The license key
   422→ * @param {string} tier - Subscription tier (starter/pro/team)
   423→ */
   424→async function sendLicenseKeyEmail(email, licenseKey, tier) {
   425→  const tierDetails = getTierDetails(tier);
   426→  const template = TEMPLATES.licenseKey;
   427→
   428→  const data = {
   429→    licenseKey,
   430→    tier,
   431→    hours: tierDetails.hours,
   432→    musicCredits: tierDetails.musicCredits
   433→  };
   434→
   435→  return sendEmail(
   436→    email,
   437→    template.subject,
   438→    template.html(data),
   439→    template.text(data)
   440→  );
   441→}
   442→
   443→/**
   444→ * Send payment warning email to customer
   445→ * @param {string} email - Customer email
   446→ * @param {number} attemptCount - Which payment attempt failed (1-3)
   447→ */
   448→async function sendPaymentWarningEmail(email, attemptCount) {
   449→  const template = TEMPLATES.paymentWarning;
   450→  const data = { attemptCount };
   451→
   452→  return sendEmail(
   453→    email,
   454→    template.subject,
   455→    template.html(data),
   456→    template.text(data)
   457→  );
   458→}
   459→
   460→/**
   461→ * Send license key lookup email
   462→ * @param {string} email - Customer email
   463→ * @param {string} licenseKey - The license key
   464→ */
   465→async function sendLicenseLookupEmail(email, licenseKey) {
   466→  const template = TEMPLATES.licenseLookup;
   467→  const data = { licenseKey };
   468→
   469→  return sendEmail(
   470→    email,
   471→    template.subject,
   472→    template.html(data),
   473→    template.text(data)
   474→  );
   475→}
   476→
   477→/**
   478→ * Check if email service is configured for production use
   479→ */
   480→function isEmailConfigured() {
   481→  const provider = EMAIL_CONFIG.provider.toLowerCase();
   482→
   483→  if (provider === 'sendgrid') {
   484→    return !!EMAIL_CONFIG.sendgrid.apiKey;
   485→  }
   486→
   487→  if (provider === 'ses') {
   488→    return !!(process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY);
   489→  }
   490→
   491→  // Console mode is always "configured" (for dev)
   492→  return true;
   493→}
   494→
   495→// ============================================================================
   496→// EXPORTS
   497→// ============================================================================
   498→
   499→module.exports = {
   500→  sendEmail,
   501→  sendLicenseKeyEmail,
   502→  sendPaymentWarningEmail,
   503→  sendLicenseLookupEmail,
   504→  isEmailConfigured,
   505→  EMAIL_CONFIG
   506→};
   507→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
