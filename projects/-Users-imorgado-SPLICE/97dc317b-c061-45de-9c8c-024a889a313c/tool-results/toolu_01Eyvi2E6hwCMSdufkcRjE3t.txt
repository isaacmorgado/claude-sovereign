     1→/**
     2→ * Auth Routes
     3→ *
     4→ * Authentication endpoints (login, refresh, logout)
     5→ */
     6→
     7→const express = require('express');
     8→
     9→/**
    10→ * Create auth routes
    11→ * @param {Object} options - Route configuration options
    12→ * @param {Object} options.middleware - Shared middleware (authenticateToken)
    13→ * @param {Object} options.services - Shared services (usageTracking, licenseService)
    14→ * @param {Object} options.authHelpers - Auth helper functions
    15→ * @returns {express.Router}
    16→ */
    17→function createAuthRoutes(options = {}) {
    18→  const router = express.Router();
    19→  const { authenticateToken } = options.middleware || {};
    20→  const { generateToken, generateRefreshToken, verifyToken, maskSensitiveData } = options.authHelpers || {};
    21→  const { usageTracking, licenseService } = options.services || {};
    22→
    23→  /**
    24→   * POST /login - Authenticate with license key and get JWT token
    25→   *
    26→   * SECURITY: This is the primary authentication endpoint.
    27→   * Validates license key and returns a JWT token for API access.
    28→   */
    29→  router.post('/login', async (req, res) => {
    30→    const { licenseKey } = req.body;
    31→
    32→    if (!licenseKey) {
    33→      return res.status(400).json({
    34→        error: 'License key required',
    35→        message: 'Please provide your license key to log in'
    36→      });
    37→    }
    38→
    39→    try {
    40→      // Validate and activate the license key
    41→      const licenseResult = await licenseService.activateLicenseKey(licenseKey);
    42→
    43→      if (!licenseResult.success) {
    44→        console.log(`[Auth] Failed login attempt with key: ${maskSensitiveData(licenseKey)}`);
    45→        return res.status(401).json({
    46→          error: 'Invalid license key',
    47→          message: licenseResult.error || 'The license key is invalid or expired'
    48→        });
    49→      }
    50→
    51→      // Get user's tier and balance
    52→      const balance = await usageTracking.getBalance(licenseResult.customerId);
    53→
    54→      // Generate JWT tokens
    55→      const tokenResult = generateToken(licenseResult.customerId, {
    56→        tier: balance.tier,
    57→        email: licenseResult.email
    58→      });
    59→      const refreshResult = generateRefreshToken(licenseResult.customerId);
    60→
    61→      console.log(`[Auth] Successful login for ${maskSensitiveData(licenseResult.customerId)}`);
    62→
    63→      res.json({
    64→        success: true,
    65→        token: tokenResult.token,
    66→        tokenType: tokenResult.tokenType,
    67→        expiresIn: tokenResult.expiresIn,
    68→        refreshToken: refreshResult.refreshToken,
    69→        customerId: licenseResult.customerId,
    70→        tier: balance.tier,
    71→        hoursRemaining: balance.hoursRemaining
    72→      });
    73→    } catch (err) {
    74→      console.error('[Auth] Login error:', err.message);
    75→      res.status(500).json({ error: 'Authentication failed. Please try again.' });
    76→    }
    77→  });
    78→
    79→  /**
    80→   * POST /refresh - Refresh an expired JWT token
    81→   *
    82→   * Uses a refresh token to get a new access token
    83→   */
    84→  router.post('/refresh', async (req, res) => {
    85→    const { refreshToken } = req.body;
    86→
    87→    if (!refreshToken) {
    88→      return res.status(400).json({
    89→        error: 'Refresh token required'
    90→      });
    91→    }
    92→
    93→    try {
    94→      const decoded = verifyToken(refreshToken);
    95→
    96→      if (!decoded || decoded.type !== 'refresh') {
    97→        return res.status(401).json({
    98→          error: 'Invalid refresh token',
    99→          message: 'Please log in again'
   100→        });
   101→      }
   102→
   103→      // Get current user info
   104→      const balance = await usageTracking.getBalance(decoded.sub);
   105→
   106→      // Generate new access token
   107→      const tokenResult = generateToken(decoded.sub, {
   108→        tier: balance.tier
   109→      });
   110→
   111→      console.log(`[Auth] Token refreshed for ${maskSensitiveData(decoded.sub)}`);
   112→
   113→      res.json({
   114→        success: true,
   115→        token: tokenResult.token,
   116→        tokenType: tokenResult.tokenType,
   117→        expiresIn: tokenResult.expiresIn
   118→      });
   119→    } catch (err) {
   120→      console.error('[Auth] Token refresh error:', err.message);
   121→      res.status(401).json({
   122→        error: 'Failed to refresh token',
   123→        message: 'Please log in again'
   124→      });
   125→    }
   126→  });
   127→
   128→  /**
   129→   * POST /logout - Invalidate tokens (client-side)
   130→   *
   131→   * Note: JWT tokens are stateless, so this is primarily for logging
   132→   * and future token blacklisting if needed.
   133→   */
   134→  router.post('/logout', authenticateToken, (req, res) => {
   135→    console.log(`[Auth] Logout for ${maskSensitiveData(req.stripeCustomerId)}`);
   136→
   137→    // TODO: If implementing token blacklisting, add token to blacklist here
   138→
   139→    res.json({
   140→      success: true,
   141→      message: 'Logged out successfully'
   142→    });
   143→  });
   144→
   145→  return router;
   146→}
   147→
   148→module.exports = createAuthRoutes;
   149→

</system-reminder>
