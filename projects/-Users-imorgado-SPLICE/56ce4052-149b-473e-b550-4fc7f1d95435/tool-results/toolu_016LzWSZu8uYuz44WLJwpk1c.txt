     1→/**
     2→ * Zoom Routes
     3→ *
     4→ * Auto zoom generation endpoints
     5→ */
     6→
     7→const express = require('express');
     8→const fsPromises = require('fs').promises;
     9→const fs = require('fs');
    10→const { transcribeWithWords } = require('../services/transcription');
    11→const { generateZoomPoints, ZOOM_PRESETS, ZOOM_FREQUENCIES } = require('../services/zoomGenerator');
    12→
    13→// Async file existence check (non-blocking)
    14→async function fileExists(filePath) {
    15→  try {
    16→    await fsPromises.access(filePath, fs.constants.R_OK);
    17→    return true;
    18→  } catch {
    19→    return false;
    20→  }
    21→}
    22→
    23→/**
    24→ * Create zoom routes
    25→ * @param {Object} options - Route configuration options
    26→ * @param {Object} options.middleware - Shared middleware (requireCredits)
    27→ * @returns {express.Router}
    28→ */
    29→function createZoomRoutes(options = {}) {
    30→  const router = express.Router();
    31→  const { requireCredits } = options.middleware || {};
    32→
    33→  /**
    34→   * POST / - Generate zoom points from transcript
    35→   *
    36→   * Analyzes transcript to find emphasis points and generates zoom data.
    37→   *
    38→   * Body:
    39→   * - transcript: Transcript object with words/segments
    40→   * - settings: {
    41→   *     frequency: 'low'|'medium'|'high',
    42→   *     preset: 'subtle'|'medium'|'dramatic',
    43→   *     placement: 'sentence_start'|'keywords'|'random'|'speaker_change'
    44→   *   }
    45→   */
    46→  router.post('/', requireCredits({ endpoint: 'zoom' }), async (req, res) => {
    47→    const {
    48→      transcript,
    49→      wavPath,
    50→      settings = {}
    51→    } = req.body;
    52→
    53→    // Get transcript from wavPath if not provided directly
    54→    let transcriptData = transcript;
    55→    if (!transcriptData && wavPath) {
    56→      if (!(await fileExists(wavPath))) {
    57→        return res.status(404).json({ error: `File not found: ${wavPath}` });
    58→      }
    59→      try {
    60→        transcriptData = await transcribeWithWords(wavPath);
    61→      } catch (err) {
    62→        return res.status(500).json({ error: `Transcription failed: ${err.message}` });
    63→      }
    64→    }
    65→
    66→    if (!transcriptData) {
    67→      return res.status(400).json({ error: 'transcript or wavPath is required' });
    68→    }
    69→
    70→    console.log(`[SPLICE] Generating zoom points (${settings.frequency || 'medium'}/${settings.preset || 'medium'})`);
    71→
    72→    try {
    73→      const zoomPoints = generateZoomPoints(transcriptData, settings);
    74→
    75→      // Deduct usage based on audio duration
    76→      const audioDuration = transcriptData.duration || 0;
    77→      let balance = null;
    78→      if (audioDuration > 0 && req.deductUsage) {
    79→        balance = await req.deductUsage(audioDuration);
    80→      }
    81→
    82→      res.json({
    83→        success: true,
    84→        zoomPoints,
    85→        count: zoomPoints.length,
    86→        settings: {
    87→          frequency: settings.frequency || 'medium',
    88→          preset: settings.preset || 'medium',
    89→          placement: settings.placement || 'sentence_start'
    90→        },
    91→        presets: ZOOM_PRESETS,
    92→        frequencies: ZOOM_FREQUENCIES,
    93→        balance: balance ? { hoursRemaining: balance.hoursRemaining, tier: balance.tier } : undefined
    94→      });
    95→    } catch (err) {
    96→      console.error('[SPLICE] Zoom generation error:', err);
    97→      res.status(500).json({ error: err.message });
    98→    }
    99→  });
   100→
   101→  /**
   102→   * GET /presets - Get available zoom presets and frequencies
   103→   */
   104→  router.get('/presets', (req, res) => {
   105→    res.json({
   106→      success: true,
   107→      presets: ZOOM_PRESETS,
   108→      frequencies: ZOOM_FREQUENCIES,
   109→      placements: ['sentence_start', 'keywords', 'random', 'speaker_change']
   110→    });
   111→  });
   112→
   113→  return router;
   114→}
   115→
   116→module.exports = createZoomRoutes;
   117→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
