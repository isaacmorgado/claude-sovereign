     1→/**
     2→ * Text Edit Routes
     3→ *
     4→ * Text-based editing endpoints
     5→ */
     6→
     7→const express = require('express');
     8→
     9→/**
    10→ * Create text edit routes
    11→ * @param {Object} options - Route configuration options
    12→ * @param {Object} options.middleware - Shared middleware (requireCredits)
    13→ * @returns {express.Router}
    14→ */
    15→function createTextEditRoutes(options = {}) {
    16→  const router = express.Router();
    17→  const { requireCredits } = options.middleware || {};
    18→
    19→  /**
    20→   * POST /prepare - Create editable transcript structure
    21→   *
    22→   * Converts transcript to editable format with unique word IDs.
    23→   */
    24→  router.post('/prepare', requireCredits({ endpoint: 'text-edit' }), async (req, res) => {
    25→    const { transcript } = req.body;
    26→
    27→    if (!transcript) {
    28→      return res.status(400).json({ error: 'transcript is required' });
    29→    }
    30→
    31→    try {
    32→      const { generateEditableTranscript } = require('../services/textBasedEditing');
    33→      const result = generateEditableTranscript(transcript);
    34→
    35→      if (!result.success) {
    36→        return res.status(400).json({ error: result.error });
    37→      }
    38→
    39→      // Deduct usage
    40→      if (req.deductUsage) {
    41→        await req.deductUsage(0.25); // 0.25 credits
    42→      }
    43→
    44→      res.json(result);
    45→    } catch (err) {
    46→      console.error('[SPLICE] Text-edit prepare error:', err);
    47→      res.status(500).json({ error: err.message });
    48→    }
    49→  });
    50→
    51→  /**
    52→   * POST /apply - Apply text edits and get operations
    53→   *
    54→   * Compares original and edited text, returns edit operations.
    55→   */
    56→  router.post('/apply', requireCredits({ endpoint: 'text-edit' }), async (req, res) => {
    57→    const { transcript, editedText } = req.body;
    58→
    59→    if (!transcript) {
    60→      return res.status(400).json({ error: 'transcript is required' });
    61→    }
    62→
    63→    if (typeof editedText !== 'string') {
    64→      return res.status(400).json({ error: 'editedText is required' });
    65→    }
    66→
    67→    try {
    68→      const { applyTextEdits } = require('../services/textBasedEditing');
    69→      const result = applyTextEdits(transcript, editedText);
    70→
    71→      if (!result.success) {
    72→        return res.status(400).json({ error: result.error });
    73→      }
    74→
    75→      // Deduct usage
    76→      if (req.deductUsage) {
    77→        await req.deductUsage(0.5); // 0.5 credits
    78→      }
    79→
    80→      res.json(result);
    81→    } catch (err) {
    82→      console.error('[SPLICE] Text-edit apply error:', err);
    83→      res.status(500).json({ error: err.message });
    84→    }
    85→  });
    86→
    87→  /**
    88→   * POST /search - Search transcript with timestamps
    89→   */
    90→  router.post('/search', requireCredits({ endpoint: 'text-edit' }), async (req, res) => {
    91→    const { transcript, searchText } = req.body;
    92→
    93→    if (!transcript) {
    94→      return res.status(400).json({ error: 'transcript is required' });
    95→    }
    96→
    97→    if (!searchText) {
    98→      return res.status(400).json({ error: 'searchText is required' });
    99→    }
   100→
   101→    try {
   102→      const { searchTranscript } = require('../services/textBasedEditing');
   103→      const result = searchTranscript(transcript, searchText);
   104→
   105→      if (!result.success) {
   106→        return res.status(400).json({ error: result.error });
   107→      }
   108→
   109→      // Deduct usage
   110→      if (req.deductUsage) {
   111→        await req.deductUsage(0.1); // 0.1 credits
   112→      }
   113→
   114→      res.json(result);
   115→    } catch (err) {
   116→      console.error('[SPLICE] Text-edit search error:', err);
   117→      res.status(500).json({ error: err.message });
   118→    }
   119→  });
   120→
   121→  /**
   122→   * POST /replace - Search and replace (generates cut operations)
   123→   */
   124→  router.post('/replace', requireCredits({ endpoint: 'text-edit' }), async (req, res) => {
   125→    const { transcript, searchText, replaceText = '' } = req.body;
   126→
   127→    if (!transcript) {
   128→      return res.status(400).json({ error: 'transcript is required' });
   129→    }
   130→
   131→    if (!searchText) {
   132→      return res.status(400).json({ error: 'searchText is required' });
   133→    }
   134→
   135→    try {
   136→      const { searchAndReplace } = require('../services/textBasedEditing');
   137→      const result = searchAndReplace(transcript, searchText, replaceText);
   138→
   139→      if (!result.success) {
   140→        return res.status(400).json({ error: result.error });
   141→      }
   142→
   143→      // Deduct usage
   144→      if (req.deductUsage) {
   145→        await req.deductUsage(0.25); // 0.25 credits
   146→      }
   147→
   148→      res.json(result);
   149→    } catch (err) {
   150→      console.error('[SPLICE] Text-edit replace error:', err);
   151→      res.status(500).json({ error: err.message });
   152→    }
   153→  });
   154→
   155→  /**
   156→   * POST /preview - Preview edits without applying
   157→   */
   158→  router.post('/preview', requireCredits({ endpoint: 'text-edit' }), async (req, res) => {
   159→    const { transcript, editedText } = req.body;
   160→
   161→    if (!transcript) {
   162→      return res.status(400).json({ error: 'transcript is required' });
   163→    }
   164→
   165→    if (typeof editedText !== 'string') {
   166→      return res.status(400).json({ error: 'editedText is required' });
   167→    }
   168→
   169→    try {
   170→      const { previewEdits } = require('../services/textBasedEditing');
   171→      const result = previewEdits(transcript, editedText);
   172→
   173→      if (!result.success) {
   174→        return res.status(400).json({ error: result.error });
   175→      }
   176→
   177→      // Deduct usage (small amount for preview)
   178→      if (req.deductUsage) {
   179→        await req.deductUsage(0.1); // 0.1 credits
   180→      }
   181→
   182→      res.json(result);
   183→    } catch (err) {
   184→      console.error('[SPLICE] Text-edit preview error:', err);
   185→      res.status(500).json({ error: err.message });
   186→    }
   187→  });
   188→
   189→  /**
   190→   * POST /cut-list - Generate cut list from edit operations
   191→   */
   192→  router.post('/cut-list', requireCredits({ endpoint: 'text-edit' }), async (req, res) => {
   193→    const { operations, sourceInfo = {} } = req.body;
   194→
   195→    if (!operations || !Array.isArray(operations)) {
   196→      return res.status(400).json({ error: 'operations array is required' });
   197→    }
   198→
   199→    try {
   200→      const { generateEditCutList } = require('../services/textBasedEditing');
   201→      const result = generateEditCutList(operations, sourceInfo);
   202→
   203→      if (!result.success) {
   204→        return res.status(400).json({ error: result.error });
   205→      }
   206→
   207→      // Deduct usage
   208→      if (req.deductUsage) {
   209→        await req.deductUsage(0.25); // 0.25 credits
   210→      }
   211→
   212→      res.json(result);
   213→    } catch (err) {
   214→      console.error('[SPLICE] Text-edit cut-list error:', err);
   215→      res.status(500).json({ error: err.message });
   216→    }
   217→  });
   218→
   219→  return router;
   220→}
   221→
   222→module.exports = createTextEditRoutes;
   223→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
