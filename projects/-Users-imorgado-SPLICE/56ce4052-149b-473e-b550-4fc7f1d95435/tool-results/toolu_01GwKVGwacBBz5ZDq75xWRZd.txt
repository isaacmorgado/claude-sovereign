     1→/**
     2→ * Captions Routes
     3→ *
     4→ * Animated captions endpoints
     5→ */
     6→
     7→const express = require('express');
     8→
     9→/**
    10→ * Create captions routes
    11→ * @param {Object} options - Route configuration options
    12→ * @param {Object} options.middleware - Shared middleware (requireCredits)
    13→ * @returns {express.Router}
    14→ */
    15→function createCaptionsRoutes(options = {}) {
    16→  const router = express.Router();
    17→  const { requireCredits } = options.middleware || {};
    18→
    19→  /**
    20→   * POST /animate - Generate animated captions from transcript
    21→   *
    22→   * Creates word-by-word animated captions with template styling.
    23→   */
    24→  router.post('/animate', requireCredits({ endpoint: 'captions' }), async (req, res) => {
    25→    const { transcript, template = 'mrbeast', settings = {} } = req.body;
    26→
    27→    if (!transcript) {
    28→      return res.status(400).json({ error: 'transcript is required' });
    29→    }
    30→
    31→    try {
    32→      const { generateAnimatedCaptions } = require('../services/animatedCaptions');
    33→      const result = await generateAnimatedCaptions(transcript, template, settings);
    34→
    35→      if (!result.success) {
    36→        return res.status(400).json({ error: result.error });
    37→      }
    38→
    39→      // Deduct usage
    40→      if (req.deductUsage) {
    41→        await req.deductUsage(0.5); // 0.5 credits per caption generation
    42→      }
    43→
    44→      res.json(result);
    45→    } catch (err) {
    46→      console.error('[SPLICE] Animated captions error:', err);
    47→      res.status(500).json({ error: err.message });
    48→    }
    49→  });
    50→
    51→  /**
    52→   * GET /templates - Get available caption templates
    53→   */
    54→  router.get('/templates', (req, res) => {
    55→    const { getTemplates } = require('../services/animatedCaptions');
    56→    res.json(getTemplates());
    57→  });
    58→
    59→  /**
    60→   * GET /template/:id - Get specific template details
    61→   */
    62→  router.get('/template/:id', (req, res) => {
    63→    const { getTemplateById } = require('../services/animatedCaptions');
    64→    const template = getTemplateById(req.params.id);
    65→
    66→    if (!template) {
    67→      return res.status(404).json({ error: `Template '${req.params.id}' not found` });
    68→    }
    69→
    70→    res.json(template);
    71→  });
    72→
    73→  /**
    74→   * POST /detect-keywords - Detect keywords for highlighting
    75→   */
    76→  router.post('/detect-keywords', requireCredits({ endpoint: 'captions' }), async (req, res) => {
    77→    const { transcript, options: kwOptions = {} } = req.body;
    78→
    79→    if (!transcript) {
    80→      return res.status(400).json({ error: 'transcript is required' });
    81→    }
    82→
    83→    try {
    84→      const { detectKeywords } = require('../services/animatedCaptions');
    85→      const keywords = await detectKeywords(transcript, kwOptions);
    86→
    87→      // Deduct usage
    88→      if (req.deductUsage) {
    89→        await req.deductUsage(0.25); // 0.25 credits
    90→      }
    91→
    92→      res.json({ success: true, keywords });
    93→    } catch (err) {
    94→      console.error('[SPLICE] Keyword detection error:', err);
    95→      res.status(500).json({ error: err.message });
    96→    }
    97→  });
    98→
    99→  /**
   100→   * POST /insert-emojis - Insert emojis into transcript
   101→   */
   102→  router.post('/insert-emojis', requireCredits({ endpoint: 'captions' }), async (req, res) => {
   103→    const { transcript, options: emojiOptions = {} } = req.body;
   104→
   105→    if (!transcript) {
   106→      return res.status(400).json({ error: 'transcript is required' });
   107→    }
   108→
   109→    try {
   110→      const { insertEmojis } = require('../services/animatedCaptions');
   111→      const result = await insertEmojis(transcript, emojiOptions);
   112→
   113→      if (!result.success) {
   114→        return res.status(400).json({ error: result.error });
   115→      }
   116→
   117→      // Deduct usage
   118→      if (req.deductUsage) {
   119→        await req.deductUsage(0.25); // 0.25 credits
   120→      }
   121→
   122→      res.json(result);
   123→    } catch (err) {
   124→      console.error('[SPLICE] Emoji insertion error:', err);
   125→      res.status(500).json({ error: err.message });
   126→    }
   127→  });
   128→
   129→  /**
   130→   * POST /apply-template - Apply template to existing caption data
   131→   */
   132→  router.post('/apply-template', requireCredits({ endpoint: 'captions' }), (req, res) => {
   133→    const { captionData, templateId } = req.body;
   134→
   135→    if (!captionData || !templateId) {
   136→      return res.status(400).json({ error: 'captionData and templateId are required' });
   137→    }
   138→
   139→    const { applyTemplate } = require('../services/animatedCaptions');
   140→    const result = applyTemplate(captionData, templateId);
   141→
   142→    if (!result.success) {
   143→      return res.status(400).json(result);
   144→    }
   145→
   146→    res.json(result);
   147→  });
   148→
   149→  /**
   150→   * POST /export/mogrt - Generate MOGRT-compatible data
   151→   */
   152→  router.post('/export/mogrt', requireCredits({ endpoint: 'captions' }), async (req, res) => {
   153→    const { captions, settings = {} } = req.body;
   154→
   155→    if (!captions || !Array.isArray(captions)) {
   156→      return res.status(400).json({ error: 'captions array is required' });
   157→    }
   158→
   159→    try {
   160→      const { generateMOGRTData } = require('../services/animatedCaptions');
   161→      const result = generateMOGRTData(captions, settings);
   162→
   163→      // Deduct usage
   164→      if (req.deductUsage) {
   165→        await req.deductUsage(0.25); // 0.25 credits
   166→      }
   167→
   168→      res.json(result);
   169→    } catch (err) {
   170→      console.error('[SPLICE] MOGRT export error:', err);
   171→      res.status(500).json({ error: err.message });
   172→    }
   173→  });
   174→
   175→  /**
   176→   * POST /export/burned - Export captions for burning into video
   177→   */
   178→  router.post('/export/burned', requireCredits({ endpoint: 'captions' }), async (req, res) => {
   179→    const { videoPath, captions, outputPath } = req.body;
   180→
   181→    if (!captions || !Array.isArray(captions)) {
   182→      return res.status(400).json({ error: 'captions array is required' });
   183→    }
   184→
   185→    try {
   186→      const { exportBurnedInCaptions } = require('../services/animatedCaptions');
   187→      const result = await exportBurnedInCaptions(videoPath, captions, outputPath);
   188→
   189→      // Deduct usage
   190→      if (req.deductUsage) {
   191→        await req.deductUsage(0.5); // 0.5 credits
   192→      }
   193→
   194→      res.json(result);
   195→    } catch (err) {
   196→      console.error('[SPLICE] Burned captions export error:', err);
   197→      res.status(500).json({ error: err.message });
   198→    }
   199→  });
   200→
   201→  return router;
   202→}
   203→
   204→module.exports = createCaptionsRoutes;
   205→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
