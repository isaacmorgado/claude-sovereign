     1→/**
     2→ * SPLICE CEP Panel Configuration
     3→ * Backend URLs, paths, and utility functions
     4→ */
     5→
     6→// ============================================================================
     7→// BACKEND CONFIGURATION
     8→// ============================================================================
     9→const SPLICE_CONFIG = {
    10→    VERSION: '6.0.3',
    11→    BACKEND_PROD: 'https://splice-api-production.up.railway.app',
    12→    BACKEND_DEV: 'https://127.0.0.1:3847',
    13→    FETCH_TIMEOUT: 120000, // 2 minutes
    14→    RETRY_ATTEMPTS: 3,
    15→    RETRY_DELAY: 1000
    16→};
    17→
    18→/**
    19→ * Get the backend URL based on environment
    20→ * FIXED: CEP panels always run from file://, so we default to PROD
    21→ * Use localStorage to override for local development if needed
    22→ */
    23→function getBackendUrl() {
    24→    // Priority 1: Allow override via localStorage (for local dev testing)
    25→    const customUrl = localStorage.getItem('spliceBackendUrl');
    26→    if (customUrl) {
    27→        console.log('[SPLICE] Using custom backend URL from localStorage:', customUrl);
    28→        return customUrl;
    29→    }
    30→
    31→    // Priority 2: Default to production backend
    32→    // (CEP panels always run from file://, so can't reliably detect dev mode)
    33→    console.log('[SPLICE] Using production backend URL:', SPLICE_CONFIG.BACKEND_PROD);
    34→    return SPLICE_CONFIG.BACKEND_PROD;
    35→}
    36→
    37→// ============================================================================
    38→// JSX BRIDGE - Communicate with Premiere Pro
    39→// ============================================================================
    40→const jsx = {
    41→    cs: null,
    42→    _initPromise: null,
    43→    _initialized: false,
    44→
    45→    /**
    46→     * Initialize the CSInterface
    47→     * Returns a promise that resolves when ready (true/false)
    48→     * Does NOT reject - gracefully handles missing CEP environment
    49→     */
    50→    init: function() {
    51→        if (this._initPromise) return this._initPromise;
    52→
    53→        this._initPromise = new Promise((resolve) => {
    54→            try {
    55→                if (typeof CSInterface !== 'undefined') {
    56→                    this.cs = new CSInterface();
    57→                    // Verify we're in a real CEP environment by checking for __adobe_cep__
    58→                    if (window.__adobe_cep__) {
    59→                        this._initialized = true;
    60→                        console.log('[JSX] CSInterface initialized successfully (CEP environment detected)');
    61→                    } else {
    62→                        // CSInterface exists but no CEP runtime - browser/dev mode
    63→                        this._initialized = true;
    64→                        console.log('[JSX] CSInterface initialized (development/browser mode)');
    65→                    }
    66→                } else {
    67→                    console.warn('[JSX] CSInterface not available - panel may not function correctly');
    68→                    this._initialized = false;
    69→                }
    70→            } catch (err) {
    71→                console.error('[JSX] Failed to initialize CSInterface:', err);
    72→                this._initialized = false;
    73→            }
    74→            resolve(this._initialized);
    75→        });
    76→
    77→        return this._initPromise;
    78→    },
    79→
    80→    /**
    81→     * Ensure JSX is initialized before making calls
    82→     */
    83→    ensureInitialized: async function() {
    84→        if (!this._initialized) {
    85→            await this.init();
    86→        }
    87→        if (!this.cs) {
    88→            throw new Error('CSInterface not initialized. Make sure you are running in CEP environment.');
    89→        }
    90→    },
    91→
    92→    /**
    93→     * Execute ExtendScript in Premiere Pro
    94→     * @param {string} script - ExtendScript to execute
    95→     * @returns {Promise<any>} - Parsed result
    96→     */
    97→    evalScript: async function(script) {
    98→        await this.ensureInitialized();
    99→
   100→        return new Promise((resolve, reject) => {
   101→            this.cs.evalScript(script, (result) => {
   102→                if (result === 'undefined' || result === undefined) {
   103→                    resolve(null);
   104→                    return;
   105→                }
   106→
   107→                // Check for EvalScript error or ExtendScript runtime errors
   108→                if (typeof result === 'string' && (
   109→                    result.indexOf('EvalScript error') !== -1 ||
   110→                    result.indexOf('Error:') !== -1 ||
   111→                    result.indexOf('TypeError:') !== -1 ||
   112→                    result.indexOf('ReferenceError:') !== -1
   113→                )) {
   114→                    reject(new Error(result));
   115→                    return;
   116→                }
   117→
   118→                // Try to parse JSON
   119→                try {
   120→                    const parsed = JSON.parse(result);
   121→                    if (parsed.error) {
   122→                        reject(new Error(parsed.error));
   123→                    } else {
   124→                        resolve(parsed);
   125→                    }
   126→                } catch (e) {
   127→                    // Return as-is if not JSON
   128→                    resolve(result);
   129→                }
   130→            });
   131→        });
   132→    },
   133→
   134→    /**
   135→     * Call a JSX function with arguments
   136→     * @param {string} funcName - Function name
   137→     * @param {...any} args - Arguments to pass
   138→     * @returns {Promise<any>}
   139→     */
   140→    call: async function(funcName, ...args) {
   141→        await this.ensureInitialized();
   142→
   143→        const escapedArgs = args.map(arg => {
   144→            if (arg === null || arg === undefined) return 'null';
   145→            if (typeof arg === 'string') {
   146→                // Escape backslashes first, then other special chars
   147→                return `'${arg
   148→                    .replace(/\\/g, '\\\\')
   149→                    .replace(/'/g, "\\'")
   150→                    .replace(/\r/g, '\\r')
   151→                    .replace(/\n/g, '\\n')
   152→                    .replace(/\t/g, '\\t')}'`;
   153→            }
   154→            if (typeof arg === 'object') {
   155→                return `'${JSON.stringify(arg)
   156→                    .replace(/\\/g, '\\\\')
   157→                    .replace(/'/g, "\\'")}'`;
   158→            }
   159→            return String(arg);
   160→        });
   161→
   162→        const script = `${funcName}(${escapedArgs.join(', ')})`;
   163→        return this.evalScript(script);
   164→    }
   165→};
   166→
   167→// ============================================================================
   168→// FETCH UTILITIES
   169→// ============================================================================
   170→
   171→/**
   172→ * Fetch with timeout support
   173→ * @param {string} url - URL to fetch
   174→ * @param {object} options - Fetch options
   175→ * @param {number} timeout - Timeout in ms
   176→ */
   177→async function fetchWithTimeout(url, options = {}, timeout = SPLICE_CONFIG.FETCH_TIMEOUT) {
   178→    // DIAGNOSTIC: Log fetch request details before making request
   179→    console.log('[SPLICE FETCH] === FETCH REQUEST START ===');
   180→    console.log('[SPLICE FETCH] URL:', url);
   181→    console.log('[SPLICE FETCH] Method:', options?.method || 'GET');
   182→    console.log('[SPLICE FETCH] Headers:', options?.headers);
   183→    console.log('[SPLICE FETCH] Timeout:', timeout);
   184→    console.log('[SPLICE FETCH] Is CEP environment:', typeof CSInterface !== 'undefined');
   185→    console.log('[SPLICE FETCH] =================================');
   186→    
   187→    const controller = new AbortController();
   188→    const timeoutId = setTimeout(() => controller.abort(), timeout);
   189→
   190→    try {
   191→        const response = await fetch(url, {
   192→            ...options,
   193→            signal: controller.signal
   194→        });
   195→        clearTimeout(timeoutId);
   196→        
   197→        // DIAGNOSTIC: Log successful response
   198→        console.log('[SPLICE FETCH] === FETCH RESPONSE SUCCESS ===');
   199→        console.log('[SPLICE FETCH] Status:', response.status);
   200→        console.log('[SPLICE FETCH] OK:', response.ok);
   201→        console.log('[SPLICE FETCH] =================================');
   202→        
   203→        return response;
   204→    } catch (error) {
   205→        clearTimeout(timeoutId);
   206→        
   207→        // DIAGNOSTIC: Log raw fetch error before rethrowing
   208→        console.log('[SPLICE FETCH] === FETCH ERROR CAUGHT ===');
   209→        console.log('[SPLICE FETCH] Error name:', error?.name);
   210→        console.log('[SPLICE FETCH] Error message:', error?.message);
   211→        console.log('[SPLICE FETCH] Error type:', typeof error);
   212→        console.log('[SPLICE FETCH] Error constructor:', error?.constructor?.name);
   213→        console.log('[SPLICE FETCH] Is AbortError:', error.name === 'AbortError');
   214→        console.log('[SPLICE FETCH] Is TypeError:', error.name === 'TypeError');
   215→        console.log('[SPLICE FETCH] Full error object:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
   216→        console.log('[SPLICE FETCH] =================================');
   217→        
   218→        if (error.name === 'AbortError') {
   219→            throw new Error(`Request timeout after ${timeout}ms`);
   220→        }
   221→        throw error;
   222→    }
   223→}
   224→
   225→/**
   226→ * Parse error response from backend
   227→ * @param {Response} response - Fetch response
   228→ */
   229→async function parseErrorResponse(response) {
   230→    try {
   231→        const data = await response.json();
   232→        return data.error || data.message || `HTTP ${response.status}`;
   233→    } catch {
   234→        return `HTTP ${response.status}: ${response.statusText}`;
   235→    }
   236→}
   237→
   238→/**
   239→ * Get auth headers for API requests
   240→ */
   241→function getAuthHeaders() {
   242→    const headers = { 'Content-Type': 'application/json' };
   243→    const settings = getSettings();
   244→
   245→    if (settings.customerId) {
   246→        headers['x-stripe-customer-id'] = settings.customerId;
   247→    }
   248→    if (settings.licenseKey) {
   249→        headers['x-license-key'] = settings.licenseKey;
   250→    }
   251→
   252→    return headers;
   253→}
   254→
   255→// ============================================================================
   256→// SETTINGS MANAGEMENT
   257→// ============================================================================
   258→
   259→const DEFAULT_SETTINGS = {
   260→    sensitivity: 50,
   261→    minSilenceLength: 0.5,
   262→    sourceIsolated: false,
   263→    enableTakesDetection: true,
   264→    enableJCut: false,
   265→    jcutLeadIn: 0.3,
   266→    jcutLeadOut: 0.2,
   267→    enableZoom: false,
   268→    zoomFrequency: 'medium',
   269→    zoomPreset: 'medium',
   270→    zoomPlacement: 'sentence_start',
   271→    enableChapters: false,
   272→    maxChapters: 10,
   273→    minChapterLength: 60,
   274→    enableProfanity: false,
   275→    profanityLanguage: 'en',
   276→    bleepType: 'standard',
   277→    customerId: null,
   278→    licenseKey: null,
   279→    expandedOptions: false,
   280→    activePreset: 'podcast',
   281→    rememberOptions: false
   282→};
   283→
   284→/**
   285→ * Get settings from localStorage
   286→ */
   287→function getSettings() {
   288→    try {
   289→        const stored = localStorage.getItem('spliceSettings');
   290→        if (stored) {
   291→            return { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
   292→        }
   293→    } catch (e) {
   294→        console.warn('[Config] Error loading settings:', e);
   295→    }
   296→    return { ...DEFAULT_SETTINGS };
   297→}
   298→
   299→/**
   300→ * Save settings to localStorage
   301→ */
   302→function saveSettings(settings) {
   303→    try {
   304→        const merged = { ...getSettings(), ...settings };
   305→        localStorage.setItem('spliceSettings', JSON.stringify(merged));
   306→        return true;
   307→    } catch (e) {
   308→        console.warn('[Config] Error saving settings:', e);
   309→        return false;
   310→    }
   311→}
   312→
   313→/**
   314→ * Clear specific setting
   315→ */
   316→function clearSetting(key) {
   317→    const settings = getSettings();
   318→    delete settings[key];
   319→    localStorage.setItem('spliceSettings', JSON.stringify(settings));
   320→}
   321→
   322→// ============================================================================
   323→// OFFLINE DETECTION
   324→// ============================================================================
   325→
   326→let isOnlineState = true;
   327→let offlineCheckInterval = null;
   328→
   329→/**
   330→ * Check if online
   331→ */
   332→function isOnline() {
   333→    return isOnlineState && navigator.onLine;
   334→}
   335→
   336→/**
   337→ * Initialize offline detection
   338→ */
   339→function initOfflineDetection() {
   340→    // Browser events
   341→    window.addEventListener('online', () => {
   342→        isOnlineState = true;
   343→        updateOfflineUI(true);
   344→    });
   345→
   346→    window.addEventListener('offline', () => {
   347→        isOnlineState = false;
   348→        updateOfflineUI(false);
   349→    });
   350→
   351→    // Periodic check
   352→    offlineCheckInterval = setInterval(async () => {
   353→        try {
   354→            const response = await fetchWithTimeout(
   355→                `${getBackendUrl()}/health`,
   356→                { method: 'GET' },
   357→                5000
   358→            );
   359→            isOnlineState = response.ok;
   360→        } catch {
   361→            isOnlineState = false;
   362→        }
   363→        updateOfflineUI(isOnlineState);
   364→    }, 30000);
   365→}
   366→
   367→/**
   368→ * Update UI based on online state
   369→ */
   370→function updateOfflineUI(online) {
   371→    const goBtn = document.getElementById('goBtn');
   372→    const status = document.getElementById('status');
   373→
   374→    if (goBtn) {
   375→        goBtn.disabled = !online;
   376→    }
   377→
   378→    if (status) {
   379→        if (!online) {
   380→            status.textContent = 'Offline - Check your connection';
   381→            status.style.color = '#dc3545';
   382→        } else {
   383→            // Reset status when back online
   384→            status.textContent = 'Ready';
   385→            status.style.color = '#888';
   386→        }
   387→    }
   388→}
   389→
   390→// ============================================================================
   391→// UTILITY FUNCTIONS
   392→// ============================================================================
   393→
   394→/**
   395→ * SECURITY: Escape HTML to prevent XSS attacks
   396→ * Use this when inserting untrusted content into innerHTML
   397→ * @param {string} str - String to escape
   398→ * @returns {string} Escaped string safe for innerHTML
   399→ */
   400→function escapeHtml(str) {
   401→    if (str === null || str === undefined) return '';
   402→    if (typeof str !== 'string') str = String(str);
   403→
   404→    const escapeMap = {
   405→        '&': '&amp;',
   406→        '<': '&lt;',
   407→        '>': '&gt;',
   408→        '"': '&quot;',
   409→        "'": '&#x27;',
   410→        '/': '&#x2F;',
   411→        '`': '&#x60;'
   412→    };
   413→
   414→    return str.replace(/[&<>"'\/`]/g, char => escapeMap[char]);
   415→}
   416→
   417→/**
   418→ * SECURITY: Create safe HTML from template with escaped values
   419→ * @param {TemplateStringsArray} strings - Template strings
   420→ * @param {...any} values - Values to escape
   421→ * @returns {string} HTML with escaped values
   422→ */
   423→function safeHtml(strings, ...values) {
   424→    return strings.reduce((result, str, i) => {
   425→        const value = values[i - 1];
   426→        const escaped = escapeHtml(value);
   427→        return result + escaped + str;
   428→    });
   429→}
   430→
   431→/**
   432→ * Format time in MM:SS or HH:MM:SS
   433→ */
   434→function formatTime(seconds) {
   435→    if (isNaN(seconds) || seconds < 0) return '0:00';
   436→
   437→    const hours = Math.floor(seconds / 3600);
   438→    const minutes = Math.floor((seconds % 3600) / 60);
   439→    const secs = Math.floor(seconds % 60);
   440→
   441→    if (hours > 0) {
   442→        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
   443→    }
   444→    return `${minutes}:${secs.toString().padStart(2, '0')}`;
   445→}
   446→
   447→/**
   448→ * Set status message
   449→ */
   450→function setStatus(message, isError = false) {
   451→    const status = document.getElementById('status');
   452→    if (status) {
   453→        status.textContent = message;
   454→        status.style.color = isError ? '#dc3545' : '#888';
   455→    }
   456→}
   457→
   458→/**
   459→ * Debounce function calls
   460→ */
   461→function debounce(func, wait) {
   462→    let timeout;
   463→    return function executedFunction(...args) {
   464→        const later = () => {
   465→            clearTimeout(timeout);
   466→            func(...args);
   467→        };
   468→        clearTimeout(timeout);
   469→        timeout = setTimeout(later, wait);
   470→    };
   471→}
   472→
   473→// ============================================================================
   474→// PRESET PROFILES
   475→// ============================================================================
   476→
   477→/**
   478→ * Detection presets for different content types.
   479→ * Each preset defines optimal settings for a specific use case.
   480→ */
   481→const PRESETS = {
   482→    // Custom - user-defined settings (default)
   483→    custom: {
   484→        name: 'Custom',
   485→        description: 'Your custom settings',
   486→        icon: 'settings',
   487→        settings: null // Uses current user settings
   488→    },
   489→
   490→    // Podcast - longer pauses are natural, be conservative
   491→    podcast: {
   492→        name: 'Podcast',
   493→        description: 'Longer natural pauses, J-Cuts enabled',
   494→        icon: 'mic',
   495→        settings: {
   496→            sensitivity: 35,
   497→            threshold: -35,
   498→            minSilenceLength: 0.8,
   499→            paddingStart: 0.15,
   500→            paddingEnd: 0.15,
   501→            enableTakesDetection: true,
   502→            enableJCut: true,
   503→            jCutLeadIn: 0.3,
   504→            jCutLeadOut: 0.2
   505→        }
   506→    },
   507→
   508→    // Interview - balanced, respects speaker pauses
   509→    interview: {
   510→        name: 'Interview',
   511→        description: 'Balanced cuts, J-Cuts for smooth transitions',
   512→        icon: 'people',
   513→        settings: {
   514→            sensitivity: 50,
   515→            threshold: -32,
   516→            minSilenceLength: 0.5,
   517→            paddingStart: 0.12,
   518→            paddingEnd: 0.08,
   519→            enableTakesDetection: true,
   520→            enableJCut: true,
   521→            jCutLeadIn: 0.25,
   522→            jCutLeadOut: 0.15
   523→        }
   524→    },
   525→
   526→    // Reaction video - fast pacing, quick cuts
   527→    reaction: {
   528→        name: 'Reaction',
   529→        description: 'Fast-paced, tight cuts for energy',
   530→        icon: 'bolt',
   531→        settings: {
   532→            sensitivity: 70,
   533→            threshold: -28,
   534→            minSilenceLength: 0.3,
   535→            paddingStart: 0.05,
   536→            paddingEnd: 0.03,
   537→            enableTakesDetection: false,
   538→            enableJCut: false,
   539→            jCutLeadIn: 0,
   540→            jCutLeadOut: 0
   541→        }
   542→    },
   543→
   544→    // Tutorial/Educational - preserve thinking pauses
   545→    tutorial: {
   546→        name: 'Tutorial',
   547→        description: 'Preserves teaching pace, J-Cuts enabled',
   548→        icon: 'school',
   549→        settings: {
   550→            sensitivity: 30,
   551→            threshold: -38,
   552→            minSilenceLength: 1.0,
   553→            paddingStart: 0.2,
   554→            paddingEnd: 0.15,
   555→            enableTakesDetection: true,
   556→            enableJCut: true,
   557→            jCutLeadIn: 0.35,
   558→            jCutLeadOut: 0.25
   559→        }
   560→    },
   561→
   562→    // Vlog/YouTube - punchy edits, engagement-focused
   563→    vlog: {
   564→        name: 'Vlog',
   565→        description: 'Punchy edits for YouTube engagement',
   566→        icon: 'videocam',
   567→        settings: {
   568→            sensitivity: 65,
   569→            threshold: -30,
   570→            minSilenceLength: 0.35,
   571→            paddingStart: 0.08,
   572→            paddingEnd: 0.05,
   573→            enableTakesDetection: true,
   574→            enableJCut: false,
   575→            jCutLeadIn: 0,
   576→            jCutLeadOut: 0
   577→        }
   578→    }
   579→};
   580→
   581→/**
   582→ * List of built-in preset IDs
   583→ */
   584→const BUILT_IN_PRESET_IDS = ['custom', 'podcast', 'interview', 'reaction', 'tutorial', 'vlog'];
   585→
   586→/**
   587→ * Get all available presets
   588→ * @returns {Object} All preset definitions
   589→ */
   590→function getPresets() {
   591→    return { ...PRESETS };
   592→}
   593→
   594→/**
   595→ * Get a specific preset by name
   596→ * @param {string} presetName - Name of the preset
   597→ * @returns {Object|null} Preset definition or null if not found
   598→ */
   599→function getPreset(presetName) {
   600→    return PRESETS[presetName] || null;
   601→}
   602→
   603→/**
   604→ * Check if a preset is a built-in preset
   605→ * @param {string} id - Preset ID to check
   606→ * @returns {boolean} True if built-in, false if custom
   607→ */
   608→function isBuiltInPreset(id) {
   609→    return BUILT_IN_PRESET_IDS.includes(id);
   610→}
   611→
   612→/**
   613→ * Apply a preset to current settings
   614→ * @param {string} presetName - Name of the preset to apply
   615→ * @returns {Object} The applied settings
   616→ */
   617→function applyPreset(presetName) {
   618→    const preset = PRESETS[presetName];
   619→
   620→    if (!preset) {
   621→        console.warn(`[SPLICE] Unknown preset: ${presetName}`);
   622→        return getSettings();
   623→    }
   624→
   625→    // Custom preset uses current settings
   626→    if (presetName === 'custom' || !preset.settings) {
   627→        saveSettings({ activePreset: 'custom' });
   628→        return getSettings();
   629→    }
   630→
   631→    // Apply preset settings
   632→    const newSettings = {
   633→        ...preset.settings,
   634→        activePreset: presetName
   635→    };
   636→
   637→    saveSettings(newSettings);
   638→    console.log(`[SPLICE] Applied preset: ${preset.name}`);
   639→
   640→    return getSettings();
   641→}
   642→
   643→/**
   644→ * Get the currently active preset
   645→ * @returns {string} Active preset name
   646→ */
   647→function getActivePreset() {
   648→    const settings = getSettings();
   649→    return settings.activePreset || 'custom';
   650→}
   651→
   652→/**
   653→ * Initialize preset selector
   654→ */
   655→function initPresetSelector() {
   656→    const presetSelector = document.getElementById('presetSelector');
   657→    const sensitivitySlider = document.getElementById('sensitivitySlider');
   658→
   659→    if (!presetSelector) return;
   660→
   661→    // Set initial value from settings
   662→    const settings = getSettings();
   663→    presetSelector.value = settings.activePreset || 'podcast';
   664→
   665→    // Handle preset change
   666→    presetSelector.addEventListener('change', () => {
   667→        const presetId = presetSelector.value;
   668→        const appliedSettings = applyPreset(presetId);
   669→
   670→        // Update sensitivity slider to match preset
   671→        if (sensitivitySlider && appliedSettings.sensitivity !== undefined) {
   672→            sensitivitySlider.value = appliedSettings.sensitivity;
   673→            // Update display value
   674→            const sensitivityValue = document.getElementById('sensitivityValue');
   675→            if (sensitivityValue) {
   676→                sensitivityValue.textContent = appliedSettings.sensitivity;
   677→            }
   678→        }
   679→
   680→        // Update takes detection checkbox
   681→        const enableTakesDetection = document.getElementById('enableTakesDetection');
   682→        if (enableTakesDetection && appliedSettings.enableTakesDetection !== undefined) {
   683→            enableTakesDetection.checked = appliedSettings.enableTakesDetection;
   684→        }
   685→
   686→        // Update J-Cut checkbox
   687→        const enableJCut = document.getElementById('enableJCut');
   688→        if (enableJCut && appliedSettings.enableJCut !== undefined) {
   689→            enableJCut.checked = appliedSettings.enableJCut;
   690→            // Toggle J-Cut settings visibility
   691→            const jcutSettings = document.getElementById('jcutSettings');
   692→            if (jcutSettings) {
   693→                jcutSettings.classList.toggle('collapsed', !appliedSettings.enableJCut);
   694→            }
   695→        }
   696→
   697→        const preset = getPreset(presetId);
   698→        if (preset) {
   699→            setStatus(`Preset: ${preset.name} - ${preset.description}`);
   700→        }
   701→    });
   702→
   703→    // Switch to custom when user manually changes sensitivity
   704→    if (sensitivitySlider) {
   705→        sensitivitySlider.addEventListener('change', () => {
   706→            if (presetSelector.value !== 'custom') {
   707→                presetSelector.value = 'custom';
   708→                saveSettings({ activePreset: 'custom' });
   709→            }
   710→        });
   711→    }
   712→}
   713→
   714→// ============================================================================
   715→// LOGIN MODAL
   716→// ============================================================================
   717→
   718→/**
   719→ * Validate license key format: SPLICE-XXXX-XXXX-XXXX
   720→ * Character set excludes confusing chars: 0/O, 1/I/L
   721→ */
   722→function isValidLicenseKeyFormat(key) {
   723→    if (!key || typeof key !== 'string') return false;
   724→    const normalized = key.toUpperCase().trim();
   725→    const pattern = /^SPLICE-[ABCDEFGHJKMNPQRSTUVWXYZ23456789]{4}-[ABCDEFGHJKMNPQRSTUVWXYZ23456789]{4}-[ABCDEFGHJKMNPQRSTUVWXYZ23456789]{4}$/;
   726→    return pattern.test(normalized);
   727→}
   728→
   729→/**
   730→ * Initialize login modal handlers
   731→ */
   732→function initLoginModal() {
   733→    const loginModal = document.getElementById('loginModal');
   734→    const closeLoginBtn = document.getElementById('closeLoginBtn');
   735→    const saveLoginBtn = document.getElementById('saveLoginBtn');
   736→    const licenseKeyInput = document.getElementById('licenseKeyInput');
   737→    const creditBadge = document.getElementById('creditBadge');
   738→
   739→    // Handle credit badge click - retry on error, or show login modal
   740→    if (creditBadge) {
   741→        creditBadge.addEventListener('click', async () => {
   742→            if (creditBadge.classList.contains('error')) {
   743→                creditBadge.textContent = '...';
   744→                if (typeof refreshCredits === 'function') {
   745→                    await refreshCredits();
   746→                }
   747→                return;
   748→            }
   749→            showLoginModal();
   750→        });
   751→    }
   752→
   753→    // Close login modal
   754→    if (closeLoginBtn && loginModal) {
   755→        closeLoginBtn.addEventListener('click', () => {
   756→            loginModal.classList.add('hidden');
   757→        });
   758→    }
   759→
   760→    // Close on backdrop click
   761→    if (loginModal) {
   762→        loginModal.addEventListener('click', (e) => {
   763→            if (e.target === loginModal) {
   764→                loginModal.classList.add('hidden');
   765→            }
   766→        });
   767→    }
   768→
   769→    // Activate license key
   770→    if (saveLoginBtn) {
   771→        saveLoginBtn.addEventListener('click', async () => {
   772→            const licenseKey = licenseKeyInput?.value?.trim()?.toUpperCase();
   773→
   774→            if (!licenseKey) {
   775→                showLoginError('Please enter your license key');
   776→                return;
   777→            }
   778→
   779→            if (!isValidLicenseKeyFormat(licenseKey)) {
   780→                showLoginError('Invalid format. Expected: SPLICE-XXXX-XXXX-XXXX');
   781→                return;
   782→            }
   783→
   784→            saveLoginBtn.disabled = true;
   785→            saveLoginBtn.textContent = 'Activating...';
   786→
   787→            try {
   788→                const response = await fetchWithTimeout(`${getBackendUrl()}/license/activate`, {
   789→                    method: 'POST',
   790→                    headers: { 'Content-Type': 'application/json' },
   791→                    body: JSON.stringify({ key: licenseKey })
   792→                }, SPLICE_CONFIG.FETCH_TIMEOUT);
   793→
   794→                const result = await response.json();
   795→
   796→                if (!result.success) {
   797→                    showLoginError(result.error || 'Activation failed');
   798→                    return;
   799→                }
   800→
   801→                saveSettings({ customerId: result.customerId });
   802→                loginModal?.classList.add('hidden');
   803→
   804→                if (typeof refreshCredits === 'function') {
   805→                    await refreshCredits();
   806→                }
   807→
   808→                setStatus(`License activated! ${result.tierName} tier`);
   809→            } catch (err) {
   810→                console.error('[SPLICE] License activation error:', err);
   811→
   812→                // DIAGNOSTIC LOGGING: Capture exact error details for debugging
   813→                console.log('[SPLICE DEBUG] === CEP LICENSE ACTIVATION ERROR DIAGNOSTICS ===');
   814→                console.log('[SPLICE DEBUG] Error name:', err?.name);
   815→                console.log('[SPLICE DEBUG] Error message:', err?.message);
   816→                console.log('[SPLICE DEBUG] Error stack:', err?.stack);
   817→                console.log('[SPLICE DEBUG] Backend URL:', getBackendUrl());
   818→                console.log('[SPLICE DEBUG] Fetch timeout:', SPLICE_CONFIG.FETCH_TIMEOUT);
   819→                console.log('[SPLICE DEBUG] Is CEP environment:', typeof CSInterface !== 'undefined');
   820→                console.log('[SPLICE DEBUG] User agent:', navigator?.userAgent);
   821→                console.log('[SPLICE DEBUG] Error constructor:', err?.constructor?.name);
   822→                console.log('[SPLICE DEBUG] Is TypeError:', err?.name === 'TypeError');
   823→                console.log('[SPLICE DEBUG] Message contains "Failed to fetch":', err?.message?.includes('Failed to fetch'));
   824→                console.log('[SPLICE DEBUG] Message contains "fetch":', err?.message?.toLowerCase()?.includes('fetch'));
   825→                console.log('[SPLICE DEBUG] Message contains "network":', err?.message?.toLowerCase()?.includes('network'));
   826→                console.log('[SPLICE DEBUG] Message contains "CORS":', err?.message?.toLowerCase()?.includes('cors'));
   827→                console.log('[SPLICE DEBUG] Message contains "SSL":', err?.message?.toLowerCase()?.includes('ssl'));
   828→                console.log('[SPLICE DEBUG] Message contains "certificate":', err?.message?.toLowerCase()?.includes('certificate'));
   829→                console.log('[SPLICE DEBUG] Full error object:', JSON.stringify(err, Object.getOwnPropertyNames(err)));
   830→                console.log('[SPLICE DEBUG] ================================================');
   831→
   832→                // Provide detailed error message based on error type
   833→                let errorMessage = 'Connection error. ';
   834→
   835→                if (err.message === 'Request timed out') {
   836→                    errorMessage += 'Server is not responding. Check if backend is running.';
   837→                } else if (err.message?.includes('Failed to fetch') || err.name === 'TypeError') {
   838→                    errorMessage += `Cannot reach ${getBackendUrl()}. Check network/firewall.`;
   839→                } else if (err.message?.includes('CORS')) {
   840→                    errorMessage += 'CORS error. Contact support.';
   841→                } else if (err.message?.includes('SSL') || err.message?.includes('certificate')) {
   842→                    errorMessage += 'SSL certificate error. Try updating your system certificates.';
   843→                } else if (err.message) {
   844→                    errorMessage += err.message;
   845→                } else {
   846→                    errorMessage += 'Unknown error. Check console for details.';
   847→                }
   848→
   849→                console.log('[SPLICE DEBUG] Final error message shown to user:', errorMessage);
   850→                showLoginError(errorMessage);
   851→            } finally {
   852→                saveLoginBtn.disabled = false;
   853→                saveLoginBtn.textContent = 'Activate';
   854→            }
   855→        });
   856→    }
   857→
   858→    // Email lookup
   859→    const lookupLicenseBtn = document.getElementById('lookupLicenseBtn');
   860→    const lookupEmailInput = document.getElementById('lookupEmailInput');
   861→
   862→    if (lookupLicenseBtn) {
   863→        lookupLicenseBtn.addEventListener('click', async () => {
   864→            const email = lookupEmailInput?.value?.trim()?.toLowerCase();
   865→
   866→            if (!email) {
   867→                showLoginError('Please enter your email address');
   868→                return;
   869→            }
   870→
   871→            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
   872→            if (!emailRegex.test(email)) {
   873→                showLoginError('Please enter a valid email address');
   874→                return;
   875→            }
   876→
   877→            lookupLicenseBtn.disabled = true;
   878→            lookupLicenseBtn.textContent = 'Looking up...';
   879→
   880→            try {
   881→                const response = await fetchWithTimeout(`${getBackendUrl()}/license/lookup`, {
   882→                    method: 'POST',
   883→                    headers: { 'Content-Type': 'application/json' },
   884→                    body: JSON.stringify({ email })
   885→                }, 30000);
   886→
   887→                const result = await response.json();
   888→
   889→                // Note: For security, the backend does NOT return the license key directly.
   890→                // It sends the key via email to prevent enumeration attacks.
   891→                if (result.success) {
   892→                    setStatus(result.message || 'If a license exists, it will be sent to your email.');
   893→                } else {
   894→                    showLoginError(result.error || 'Lookup failed. Please try again.');
   895→                }
   896→            } catch (err) {
   897→                console.error('[SPLICE] License lookup error:', err);
   898→                showLoginError('Failed to look up license. Please try again.');
   899→            } finally {
   900→                lookupLicenseBtn.disabled = false;
   901→                lookupLicenseBtn.textContent = 'Lookup';
   902→            }
   903→        });
   904→    }
   905→
   906→    // Handle external URL buttons
   907→    // CEP panels cannot use target="_blank" for security reasons.
   908→    // Must use CSInterface.openURLInDefaultBrowser() instead.
   909→    initExternalLinkButtons();
   910→}
   911→
   912→/**
   913→ * Initialize all external link buttons that need CSInterface.openURLInDefaultBrowser()
   914→ * CEP panels cannot use target="_blank" due to security restrictions
   915→ */
   916→function initExternalLinkButtons() {
   917→    // Check if CSInterface is available
   918→    if (typeof CSInterface === 'undefined') {
   919→        console.warn('[SPLICE] CSInterface not available - external links disabled');
   920→        return;
   921→    }
   922→
   923→    let cs;
   924→    try {
   925→        cs = new CSInterface();
   926→    } catch (e) {
   927→        console.warn('[SPLICE] Failed to create CSInterface:', e.message);
   928→        return;
   929→    }
   930→
   931→    // Buy a License button
   932→    const buyLicenseBtn = document.querySelector('.btn-buy-license');
   933→
   934→    if (buyLicenseBtn) {
   935→        buyLicenseBtn.addEventListener('click', (e) => {
   936→            e.preventDefault();
   937→            e.stopPropagation();
   938→
   939→            // Visual feedback
   940→            buyLicenseBtn.textContent = 'Opening...';
   941→            buyLicenseBtn.style.backgroundColor = '#28a745';
   942→
   943→            try {
   944→                cs.openURLInDefaultBrowser('https://spliceclips.com/pricing');
   945→
   946→                // Reset button after a delay
   947→                setTimeout(() => {
   948→                    buyLicenseBtn.textContent = 'Buy License';
   949→                    buyLicenseBtn.style.backgroundColor = '';
   950→                }, 2000);
   951→            } catch (err) {
   952→                console.error('[SPLICE] Failed to open URL:', err.message);
   953→                buyLicenseBtn.textContent = 'Error';
   954→                buyLicenseBtn.style.backgroundColor = '#dc3545';
   955→            }
   956→        });
   957→    }
   958→    
   959→    // View Plans button (in upgrade modal)
   960→    const viewPlansBtn = document.querySelector('.btn-view-plans');
   961→    if (viewPlansBtn) {
   962→        viewPlansBtn.addEventListener('click', (e) => {
   963→            e.preventDefault();
   964→            e.stopPropagation();
   965→            const url = viewPlansBtn.dataset.url || 'https://spliceclips.com/pricing';
   966→            cs.openURLInDefaultBrowser(url);
   967→        });
   968→    }
   969→    
   970→    // Referral link button
   971→    const referralBtn = document.querySelector('.btn-referral');
   972→    if (referralBtn) {
   973→        referralBtn.addEventListener('click', (e) => {
   974→            e.preventDefault();
   975→            e.stopPropagation();
   976→            const url = referralBtn.dataset.url || 'https://splice.video/referrals';
   977→            cs.openURLInDefaultBrowser(url);
   978→        });
   979→    }
   980→}
   981→
   982→/**
   983→ * Show login modal
   984→ */
   985→function showLoginModal() {
   986→    const loginModal = document.getElementById('loginModal');
   987→    const loginError = document.getElementById('loginError');
   988→    if (loginError) loginError.style.display = 'none';
   989→    if (loginModal) loginModal.classList.remove('hidden');
   990→}
   991→
   992→/**
   993→ * Show login error message
   994→ */
   995→function showLoginError(message) {
   996→    const loginError = document.getElementById('loginError');
   997→    if (loginError) {
   998→        loginError.textContent = message;
   999→        loginError.style.display = 'block';
  1000→    }
  1001→}
  1002→
  1003→/**
  1004→ * Check if user is logged in
  1005→ */
  1006→function isLoggedIn() {
  1007→    const settings = getSettings();
  1008→    return !!settings.customerId;
  1009→}
  1010→
  1011→/**
  1012→ * Logout - clear customer ID
  1013→ */
  1014→function logout() {
  1015→    saveSettings({ customerId: null });
  1016→    if (typeof clearCreditsCache === 'function') {
  1017→        clearCreditsCache();
  1018→    }
  1019→    if (typeof updateCreditDisplay === 'function') {
  1020→        updateCreditDisplay(null);
  1021→    }
  1022→    setStatus('Logged out');
  1023→}
  1024→
  1025→// Initialize JSX bridge when loaded
  1026→document.addEventListener('DOMContentLoaded', () => {
  1027→    jsx.init();
  1028→});
  1029→
  1030→// Export for modules
  1031→window.SPLICE_CONFIG = SPLICE_CONFIG;
  1032→window.getBackendUrl = getBackendUrl;
  1033→window.fetchWithTimeout = fetchWithTimeout;
  1034→window.parseErrorResponse = parseErrorResponse;
  1035→window.getAuthHeaders = getAuthHeaders;
  1036→window.getSettings = getSettings;
  1037→window.saveSettings = saveSettings;
  1038→window.clearSetting = clearSetting;
  1039→window.isOnline = isOnline;
  1040→window.initOfflineDetection = initOfflineDetection;
  1041→window.formatTime = formatTime;
  1042→window.setStatus = setStatus;
  1043→window.debounce = debounce;
  1044→window.jsx = jsx;
  1045→window.PRESETS = PRESETS;
  1046→window.getPresets = getPresets;
  1047→window.getPreset = getPreset;
  1048→window.applyPreset = applyPreset;
  1049→window.getActivePreset = getActivePreset;
  1050→window.isBuiltInPreset = isBuiltInPreset;
  1051→window.initPresetSelector = initPresetSelector;
  1052→window.initLoginModal = initLoginModal;
  1053→window.showLoginModal = showLoginModal;
  1054→window.isLoggedIn = isLoggedIn;
  1055→window.logout = logout;
  1056→window.escapeHtml = escapeHtml;
  1057→window.safeHtml = safeHtml;
  1058→

</system-reminder>
