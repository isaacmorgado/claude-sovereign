     1â†’/**
     2â†’ * SPLICE CEP Panel - Main Entry Point
     3â†’ * v4.0.0 - CEP Migration
     4â†’ */
     5â†’
     6â†’// ============================================================================
     7â†’// CACHED DOM ELEMENTS
     8â†’// ============================================================================
     9â†’const ui = {};
    10â†’
    11â†’function cacheUIElements() {
    12â†’    ui.status = document.getElementById('status');
    13â†’    ui.goBtn = document.getElementById('goBtn');
    14â†’    ui.optionsToggle = document.getElementById('optionsToggle');
    15â†’    ui.optionsPanel = document.getElementById('optionsPanel');
    16â†’
    17â†’    // Sliders and options
    18â†’    ui.sensitivitySlider = document.getElementById('sensitivitySlider');
    19â†’    ui.sensitivityValue = document.getElementById('sensitivityValue');
    20â†’    ui.sourceOriginal = document.getElementById('sourceOriginal');
    21â†’    ui.sourceIsolated = document.getElementById('sourceIsolated');
    22â†’
    23â†’    // Feature toggles
    24â†’    ui.enableTakesDetection = document.getElementById('enableTakesDetection');
    25â†’    ui.enableJCut = document.getElementById('enableJCut');
    26â†’    ui.jcutSettings = document.getElementById('jcutSettings');
    27â†’    ui.jcutLeadIn = document.getElementById('jcutLeadIn');
    28â†’    ui.jcutLeadInValue = document.getElementById('jcutLeadInValue');
    29â†’    ui.jcutLeadOut = document.getElementById('jcutLeadOut');
    30â†’    ui.jcutLeadOutValue = document.getElementById('jcutLeadOutValue');
    31â†’
    32â†’    // Zoom settings
    33â†’    ui.enableZoom = document.getElementById('enableZoom');
    34â†’    ui.zoomSettings = document.getElementById('zoomSettings');
    35â†’    ui.zoomFrequency = document.getElementById('zoomFrequency');
    36â†’    ui.zoomPreset = document.getElementById('zoomPreset');
    37â†’    ui.zoomPlacement = document.getElementById('zoomPlacement');
    38â†’
    39â†’    // Chapter settings
    40â†’    ui.enableChapters = document.getElementById('enableChapters');
    41â†’    ui.chapterSettings = document.getElementById('chapterSettings');
    42â†’    ui.maxChapters = document.getElementById('maxChapters');
    43â†’    ui.minChapterLength = document.getElementById('minChapterLength');
    44â†’
    45â†’    // Profanity settings
    46â†’    ui.enableProfanity = document.getElementById('enableProfanity');
    47â†’    ui.profanitySettings = document.getElementById('profanitySettings');
    48â†’
    49â†’    // Filler word settings
    50â†’    ui.enableFillerDetection = document.getElementById('enableFillerDetection');
    51â†’    ui.fillerSettings = document.getElementById('fillerSettings');
    52â†’
    53â†’    // Progress
    54â†’    ui.progressContainer = document.getElementById('progressContainer');
    55â†’    ui.progressBar = document.getElementById('progressBar');
    56â†’    ui.progressText = document.getElementById('progressText');
    57â†’    ui.resultsEmpty = document.getElementById('resultsEmpty');
    58â†’
    59â†’    // Preview
    60â†’    ui.combinedPreview = document.getElementById('combinedPreview');
    61â†’    ui.previewList = document.getElementById('previewList');
    62â†’    ui.silenceCount = document.getElementById('silenceCount');
    63â†’    ui.takeCount = document.getElementById('takeCount');
    64â†’    ui.selectedCount = document.getElementById('selectedCount');
    65â†’    ui.selectAllSilences = document.getElementById('selectAllSilences');
    66â†’    ui.applyPreviewBtn = document.getElementById('applyPreviewBtn');
    67â†’    ui.cancelPreviewBtn = document.getElementById('cancelPreviewBtn');
    68â†’    ui.buildSequenceBtn = document.getElementById('buildSequenceBtn');
    69â†’
    70â†’    // Results
    71â†’    ui.zoomResults = document.getElementById('zoomResults');
    72â†’    ui.zoomList = document.getElementById('zoomList');
    73â†’    ui.chapterResults = document.getElementById('chapterResults');
    74â†’    ui.chapterList = document.getElementById('chapterList');
    75â†’    ui.copyYouTubeBtn = document.getElementById('copyYouTubeBtn');
    76â†’    ui.addChapterMarkersBtn = document.getElementById('addChapterMarkersBtn');
    77â†’
    78â†’    // Modals
    79â†’    ui.settingsBtn = document.getElementById('settingsBtn');
    80â†’    ui.settingsModal = document.getElementById('settingsModal');
    81â†’    ui.closeSettingsBtn = document.getElementById('closeSettingsBtn');
    82â†’    ui.loginModal = document.getElementById('loginModal');
    83â†’    ui.closeLoginBtn = document.getElementById('closeLoginBtn');
    84â†’    ui.licenseKeyInput = document.getElementById('licenseKeyInput');
    85â†’    ui.saveLoginBtn = document.getElementById('saveLoginBtn');
    86â†’
    87â†’    // Credit badge
    88â†’    ui.creditBadge = document.getElementById('creditBadge');
    89â†’
    90â†’    // Preset selector
    91â†’    ui.presetSelector = document.getElementById('presetSelector');
    92â†’}
    93â†’
    94â†’// ============================================================================
    95â†’// STATE MANAGEMENT
    96â†’// ============================================================================
    97â†’let previewSilences = [];
    98â†’let previewTakes = [];
    99â†’let currentChapters = [];
   100â†’let currentZooms = [];
   101â†’let currentProfanity = [];
   102â†’let selectedSilenceIndices = new Set();
   103â†’let isOperationInProgress = false;
   104â†’let lastDetectionResult = null;
   105â†’let currentAudioPath = null;
   106â†’let currentSequenceInfo = null;
   107â†’let currentTranscript = null;
   108â†’
   109â†’// Global state for captions/reframe modules
   110â†’window.spliceState = {
   111â†’    lastTranscript: null,
   112â†’    currentVideoPath: null,
   113â†’    activeSequence: null,
   114â†’    audioPath: null
   115â†’};
   116â†’
   117â†’// Also expose transcript globally for music module
   118â†’window.currentTranscript = null;
   119â†’
   120â†’// ============================================================================
   121â†’// INITIALIZATION
   122â†’// ============================================================================
   123â†’document.addEventListener('DOMContentLoaded', async () => {
   124â†’    // Premium Loading Experience
   125â†’    setTimeout(() => {
   126â†’        const loader = document.getElementById('loading-overlay');
   127â†’        if (loader) loader.classList.add('hidden');
   128â†’    }, 800); // Small delay for smooth perception
   129â†’    console.log('[SPLICE] Initializing CEP panel...');
   130â†’
   131â†’    // Debug: Show init started
   132â†’    const statusEl = document.getElementById('status');
   133â†’    if (statusEl) statusEl.textContent = 'Initializing...';
   134â†’
   135â†’    // Cache DOM elements
   136â†’    cacheUIElements();
   137â†’
   138â†’    // Load settings
   139â†’    loadSettingsToUI();
   140â†’
   141â†’    // Initialize UI handlers
   142â†’    initOptionsToggle();
   143â†’    initSliders();
   144â†’    initFeatureToggles();
   145â†’    initPresetSelector();
   146â†’    initGoButton();
   147â†’    initPreviewHandlers();
   148â†’    initModals();
   149â†’    initLoginModal();
   150â†’    initCredits();
   151â†’    initHelpButton();
   152â†’
   153â†’    // Initialize offline detection
   154â†’    if (typeof initOfflineDetection === 'function') {
   155â†’        initOfflineDetection();
   156â†’    }
   157â†’
   158â†’    // Initialize multitrack UI
   159â†’    if (typeof initMultitrackUI === 'function') {
   160â†’        initMultitrackUI();
   161â†’    }
   162â†’
   163â†’    // Initialize animated captions UI
   164â†’    if (typeof initAnimatedCaptions === 'function') {
   165â†’        initAnimatedCaptions();
   166â†’    }
   167â†’
   168â†’    // Initialize text editor UI
   169â†’    if (typeof initTextEditor === 'function') {
   170â†’        initTextEditor();
   171â†’    }
   172â†’
   173â†’    // Initialize text editor section toggle
   174â†’    initTextEditorToggle();
   175â†’
   176â†’    // Initialize social reframe UI
   177â†’    if (typeof initSocialReframe === 'function') {
   178â†’        initSocialReframe();
   179â†’    }
   180â†’
   181â†’    // Initialize social reframe section toggle
   182â†’    initSocialReframeToggle();
   183â†’
   184â†’    // Initialize music UI
   185â†’    if (typeof initMusicModule === 'function') {
   186â†’        initMusicModule();
   187â†’    }
   188â†’
   189â†’    // Initialize music section toggle
   190â†’    initMusicToggle();
   191â†’
   192â†’    // Initialize JSX bridge first, then check connection
   193â†’    // This ensures jsx.init() completes before checkJSXConnection() uses it
   194â†’    await jsx.init();
   195â†’    await checkJSXConnection();
   196â†’
   197â†’    // Initialize sequence event listeners for real-time state updates
   198â†’    initSequenceEventListeners();
   199â†’
   200â†’    setStatus('Ready');
   201â†’    console.log('[SPLICE] CEP panel initialized');
   202â†’});
   203â†’
   204â†’// ============================================================================
   205â†’// SEQUENCE EVENT LISTENERS
   206â†’// ============================================================================
   207â†’/**
   208â†’ * Initialize event listeners for sequence state changes
   209â†’ * This provides real-time updates when sequences are activated/deactivated
   210â†’ */
   211â†’function initSequenceEventListeners() {
   212â†’    if (!jsx.cs) {
   213â†’        console.warn('[SPLICE] Cannot init sequence listeners - CSInterface not available');
   214â†’        return;
   215â†’    }
   216â†’
   217â†’    try {
   218â†’        // Listen for sequence activation events
   219â†’        jsx.cs.addEventListener('com.adobe.csxs.events.SequenceActivated', async (event) => {
   220â†’            console.log('[SPLICE] Sequence activated event received');
   221â†’            try {
   222â†’                const seqInfo = await jsx.call('getActiveSequence');
   223â†’                if (seqInfo && !seqInfo.error) {
   224â†’                    window.spliceState.activeSequence = seqInfo;
   225â†’                    setStatus('Sequence: ' + (seqInfo.name || 'Unknown'));
   226â†’                    console.log('[SPLICE] Active sequence updated:', seqInfo.name);
   227â†’                }
   228â†’            } catch (e) {
   229â†’                console.warn('[SPLICE] Failed to get sequence info on activation:', e.message);
   230â†’            }
   231â†’        });
   232â†’
   233â†’        // Listen for sequence close/deactivation
   234â†’        jsx.cs.addEventListener('com.adobe.csxs.events.SequenceDeactivated', () => {
   235â†’            console.log('[SPLICE] Sequence deactivated event');
   236â†’            window.spliceState.activeSequence = null;
   237â†’            setStatus('No sequence open', true);
   238â†’        });
   239â†’
   240â†’        // Listen for project item selection changes (includes sequences)
   241â†’        jsx.cs.addEventListener('com.adobe.csxs.events.SelectionChanged', async () => {
   242â†’            // Debounce rapid selection changes
   243â†’            if (window._selectionChangeTimeout) {
   244â†’                clearTimeout(window._selectionChangeTimeout);
   245â†’            }
   246â†’            window._selectionChangeTimeout = setTimeout(async () => {
   247â†’                try {
   248â†’                    const hasSequence = await checkSequenceOpen(0, 0); // Quick check, no retries
   249â†’                    if (hasSequence && !window.spliceState.activeSequence) {
   250â†’                        const seqInfo = await jsx.call('getActiveSequence');
   251â†’                        if (seqInfo && !seqInfo.error) {
   252â†’                            window.spliceState.activeSequence = seqInfo;
   253â†’                            console.log('[SPLICE] Sequence detected via selection change:', seqInfo.name);
   254â†’                        }
   255â†’                    }
   256â†’                } catch (e) {
   257â†’                    // Ignore errors during selection change - it's just for proactive updates
   258â†’                }
   259â†’            }, 200);
   260â†’        });
   261â†’
   262â†’        console.log('[SPLICE] Sequence event listeners initialized');
   263â†’    } catch (e) {
   264â†’        console.error('[SPLICE] Failed to init sequence event listeners:', e.message);
   265â†’    }
   266â†’}
   267â†’
   268â†’// ============================================================================
   269â†’// JSX CONNECTION CHECK
   270â†’// ============================================================================
   271â†’async function checkJSXConnection() {
   272â†’    try {
   273â†’        const result = await jsx.call('getVersion');
   274â†’        console.log('[SPLICE] JSX connection OK, version:', result);
   275â†’        return true;
   276â†’    } catch (e) {
   277â†’        console.warn('[SPLICE] JSX connection failed:', e.message);
   278â†’        setStatus('Premiere Pro connection failed', true);
   279â†’        return false;
   280â†’    }
   281â†’}
   282â†’
   283â†’/**
   284â†’ * Check if a sequence is currently open in the Timeline
   285â†’ * Enhanced with logging and retry logic
   286â†’ * @param {number} retries - Number of retry attempts (default: 2)
   287â†’ * @param {number} delayMs - Delay between retries in ms (default: 300)
   288â†’ * @returns {Promise<boolean>} true if sequence is open
   289â†’ */
   290â†’async function checkSequenceOpen(retries = 2, delayMs = 300) {
   291â†’    for (let attempt = 0; attempt <= retries; attempt++) {
   292â†’        try {
   293â†’            const result = await jsx.call('checkSequenceOpen');
   294â†’            console.log('[SPLICE] checkSequenceOpen attempt', attempt + 1, 'result:', result, 'type:', typeof result);
   295â†’
   296â†’            if (result === true || result === 'true') {
   297â†’                return true;
   298â†’            }
   299â†’
   300â†’            // If false, wait and retry (sequence might be loading)
   301â†’            if (attempt < retries) {
   302â†’                console.log('[SPLICE] checkSequenceOpen: No sequence found, retrying in', delayMs, 'ms...');
   303â†’                await new Promise(r => setTimeout(r, delayMs));
   304â†’            }
   305â†’        } catch (error) {
   306â†’            console.error('[SPLICE] checkSequenceOpen attempt', attempt + 1, 'failed:', error.message);
   307â†’
   308â†’            // On last attempt, return false but log the actual error
   309â†’            if (attempt === retries) {
   310â†’                console.error('[SPLICE] checkSequenceOpen: All attempts failed. Last error:', error.message);
   311â†’                // Store error for diagnostics
   312â†’                window.spliceState.lastSequenceCheckError = error.message;
   313â†’                return false;
   314â†’            }
   315â†’
   316â†’            // Wait before retry
   317â†’            await new Promise(r => setTimeout(r, delayMs));
   318â†’        }
   319â†’    }
   320â†’    return false;
   321â†’}
   322â†’
   323â†’// ============================================================================
   324â†’// OPTIONS TOGGLE
   325â†’// ============================================================================
   326â†’function initOptionsToggle() {
   327â†’    console.log('[SPLICE] initOptionsToggle - toggle:', !!ui.optionsToggle, 'panel:', !!ui.optionsPanel);
   328â†’    if (ui.optionsToggle && ui.optionsPanel) {
   329â†’        ui.optionsToggle.addEventListener('click', () => {
   330â†’            console.log('[SPLICE] Options toggle clicked');
   331â†’            // Check current state BEFORE toggling
   332â†’            const wasCollapsed = ui.optionsPanel.classList.contains('collapsed');
   333â†’            ui.optionsPanel.classList.toggle('collapsed');
   334â†’            // If it was collapsed, it's now expanded (show 'expanded' class)
   335â†’            ui.optionsToggle.classList.toggle('expanded', wasCollapsed);
   336â†’            saveSettings({ expandedOptions: wasCollapsed });
   337â†’        });
   338â†’
   339â†’        // Restore state
   340â†’        const settings = getSettings();
   341â†’        if (!settings.expandedOptions) {
   342â†’            ui.optionsPanel.classList.add('collapsed');
   343â†’            ui.optionsToggle.classList.remove('expanded');
   344â†’        } else {
   345â†’            ui.optionsToggle.classList.add('expanded');
   346â†’            ui.optionsPanel.classList.remove('collapsed');
   347â†’        }
   348â†’    }
   349â†’}
   350â†’
   351â†’// ============================================================================
   352â†’// TEXT EDITOR TOGGLE
   353â†’// ============================================================================
   354â†’function initTextEditorToggle() {
   355â†’    const toggle = document.getElementById('textEditorToggle');
   356â†’    const panel = document.getElementById('text-editor-panel');
   357â†’    console.log('[SPLICE] initTextEditorToggle - toggle:', !!toggle, 'panel:', !!panel);
   358â†’
   359â†’    if (toggle && panel) {
   360â†’        toggle.addEventListener('click', (e) => {
   361â†’            e.preventDefault();
   362â†’            e.stopPropagation();
   363â†’            console.log('[SPLICE] Text Editor toggle clicked');
   364â†’            setStatus('Text Editor: ' + (panel.classList.contains('collapsed') ? 'Opening' : 'Closing'));
   365â†’            // Check state BEFORE toggling
   366â†’            const wasCollapsed = panel.classList.contains('collapsed');
   367â†’            panel.classList.toggle('collapsed');
   368â†’            const icon = toggle.querySelector('.toggle-icon');
   369â†’            console.log('[SPLICE] wasCollapsed:', wasCollapsed, 'icon:', !!icon);
   370â†’            if (icon) {
   371â†’                // If it was collapsed, it's now expanded (show -)
   372â†’                icon.textContent = wasCollapsed ? '-' : '+';
   373â†’            }
   374â†’        });
   375â†’    } else {
   376â†’        console.error('[SPLICE] Text Editor toggle elements not found!');
   377â†’    }
   378â†’}
   379â†’
   380â†’// ============================================================================
   381â†’// SOCIAL REFRAME TOGGLE
   382â†’// ============================================================================
   383â†’function initSocialReframeToggle() {
   384â†’    const toggle = document.getElementById('socialReframeToggle');
   385â†’    const panel = document.getElementById('social-reframe-panel');
   386â†’    console.log('[SPLICE] initSocialReframeToggle - toggle:', !!toggle, 'panel:', !!panel);
   387â†’
   388â†’    if (toggle && panel) {
   389â†’        toggle.addEventListener('click', () => {
   390â†’            console.log('[SPLICE] Social Reframe toggle clicked');
   391â†’            // Check state BEFORE toggling
   392â†’            const wasCollapsed = panel.classList.contains('collapsed');
   393â†’            panel.classList.toggle('collapsed');
   394â†’            const icon = toggle.querySelector('.toggle-icon');
   395â†’            if (icon) {
   396â†’                // If it was collapsed, it's now expanded (show -)
   397â†’                icon.textContent = wasCollapsed ? '-' : '+';
   398â†’            }
   399â†’        });
   400â†’    } else {
   401â†’        console.error('[SPLICE] Social Reframe toggle elements not found!');
   402â†’    }
   403â†’}
   404â†’
   405â†’// ============================================================================
   406â†’// MUSIC TOGGLE
   407â†’// ============================================================================
   408â†’function initMusicToggle() {
   409â†’    const toggle = document.getElementById('musicToggle');
   410â†’    const panel = document.getElementById('music-panel');
   411â†’    console.log('[SPLICE] initMusicToggle - toggle:', !!toggle, 'panel:', !!panel);
   412â†’
   413â†’    if (toggle && panel) {
   414â†’        toggle.addEventListener('click', () => {
   415â†’            console.log('[SPLICE] Music toggle clicked');
   416â†’            // Check state BEFORE toggling
   417â†’            const wasCollapsed = panel.classList.contains('collapsed');
   418â†’            panel.classList.toggle('collapsed');
   419â†’            const icon = toggle.querySelector('.toggle-icon');
   420â†’            if (icon) {
   421â†’                // If it was collapsed, it's now expanded (show -)
   422â†’                icon.textContent = wasCollapsed ? '-' : '+';
   423â†’            }
   424â†’        });
   425â†’    } else {
   426â†’        console.error('[SPLICE] Music toggle elements not found!');
   427â†’    }
   428â†’}
   429â†’
   430â†’// ============================================================================
   431â†’// SLIDERS
   432â†’// ============================================================================
   433â†’function initSliders() {
   434â†’    // Sensitivity slider
   435â†’    if (ui.sensitivitySlider && ui.sensitivityValue) {
   436â†’        ui.sensitivitySlider.addEventListener('input', () => {
   437â†’            ui.sensitivityValue.textContent = ui.sensitivitySlider.value;
   438â†’            saveSettings({ sensitivity: parseInt(ui.sensitivitySlider.value) });
   439â†’        });
   440â†’    }
   441â†’
   442â†’    // J-Cut sliders
   443â†’    if (ui.jcutLeadIn && ui.jcutLeadInValue) {
   444â†’        ui.jcutLeadIn.addEventListener('input', () => {
   445â†’            const val = (ui.jcutLeadIn.value / 100).toFixed(2);
   446â†’            ui.jcutLeadInValue.textContent = val + 's';
   447â†’            saveSettings({ jcutLeadIn: parseFloat(val) });
   448â†’        });
   449â†’    }
   450â†’
   451â†’    if (ui.jcutLeadOut && ui.jcutLeadOutValue) {
   452â†’        ui.jcutLeadOut.addEventListener('input', () => {
   453â†’            const val = (ui.jcutLeadOut.value / 100).toFixed(2);
   454â†’            ui.jcutLeadOutValue.textContent = val + 's';
   455â†’            saveSettings({ jcutLeadOut: parseFloat(val) });
   456â†’        });
   457â†’    }
   458â†’}
   459â†’
   460â†’// ============================================================================
   461â†’// FEATURE TOGGLES
   462â†’// ============================================================================
   463â†’function initFeatureToggles() {
   464â†’    // J-Cut toggle
   465â†’    if (ui.enableJCut && ui.jcutSettings) {
   466â†’        ui.enableJCut.addEventListener('change', () => {
   467â†’            ui.jcutSettings.classList.toggle('collapsed', !ui.enableJCut.checked);
   468â†’            saveSettings({ enableJCut: ui.enableJCut.checked });
   469â†’        });
   470â†’    }
   471â†’
   472â†’    // Zoom toggle
   473â†’    if (ui.enableZoom && ui.zoomSettings) {
   474â†’        ui.enableZoom.addEventListener('change', () => {
   475â†’            ui.zoomSettings.classList.toggle('collapsed', !ui.enableZoom.checked);
   476â†’            saveSettings({ enableZoom: ui.enableZoom.checked });
   477â†’        });
   478â†’    }
   479â†’
   480â†’    // Chapters toggle
   481â†’    if (ui.enableChapters && ui.chapterSettings) {
   482â†’        ui.enableChapters.addEventListener('change', () => {
   483â†’            ui.chapterSettings.classList.toggle('collapsed', !ui.enableChapters.checked);
   484â†’            saveSettings({ enableChapters: ui.enableChapters.checked });
   485â†’        });
   486â†’    }
   487â†’
   488â†’    // Takes detection toggle
   489â†’    if (ui.enableTakesDetection) {
   490â†’        ui.enableTakesDetection.addEventListener('change', () => {
   491â†’            saveSettings({ enableTakesDetection: ui.enableTakesDetection.checked });
   492â†’        });
   493â†’    }
   494â†’
   495â†’    // Profanity detection toggle
   496â†’    if (ui.enableProfanity && ui.profanitySettings) {
   497â†’        ui.enableProfanity.addEventListener('change', () => {
   498â†’            ui.profanitySettings.classList.toggle('collapsed', !ui.enableProfanity.checked);
   499â†’            saveSettings({ enableProfanity: ui.enableProfanity.checked });
   500â†’        });
   501â†’    }
   502â†’
   503â†’    // Filler word detection toggle
   504â†’    if (ui.enableFillerDetection && ui.fillerSettings) {
   505â†’        ui.enableFillerDetection.addEventListener('change', () => {
   506â†’            ui.fillerSettings.classList.toggle('collapsed', !ui.enableFillerDetection.checked);
   507â†’            saveSettings({ enableFillerDetection: ui.enableFillerDetection.checked });
   508â†’        });
   509â†’    }
   510â†’}
   511â†’
   512â†’// ============================================================================
   513â†’// PRESET SELECTOR
   514â†’// ============================================================================
   515â†’// PRESETS is defined in config.js
   516â†’
   517â†’function initPresetSelector() {
   518â†’    if (!ui.presetSelector) return;
   519â†’
   520â†’    ui.presetSelector.addEventListener('change', () => {
   521â†’        const presetId = ui.presetSelector.value;
   522â†’        applyPreset(presetId);
   523â†’    });
   524â†’
   525â†’    // Load current preset
   526â†’    const settings = getSettings();
   527â†’    if (settings.activePreset) {
   528â†’        ui.presetSelector.value = settings.activePreset;
   529â†’    }
   530â†’}
   531â†’
   532â†’function applyPreset(presetId) {
   533â†’    const preset = PRESETS[presetId];
   534â†’    if (!preset) return;
   535â†’
   536â†’    // Custom preset - keep current settings
   537â†’    if (presetId === 'custom' || !preset.settings) {
   538â†’        saveSettings({ activePreset: 'custom' });
   539â†’        setStatus('Using custom settings');
   540â†’        return;
   541â†’    }
   542â†’
   543â†’    const settings = preset.settings;
   544â†’
   545â†’    // Apply to UI
   546â†’    if (ui.sensitivitySlider && settings.sensitivity !== undefined) {
   547â†’        ui.sensitivitySlider.value = settings.sensitivity;
   548â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = settings.sensitivity;
   549â†’    }
   550â†’
   551â†’    if (ui.enableJCut) {
   552â†’        ui.enableJCut.checked = settings.enableJCut || false;
   553â†’        if (ui.jcutSettings) {
   554â†’            ui.jcutSettings.classList.toggle('collapsed', !settings.enableJCut);
   555â†’        }
   556â†’    }
   557â†’
   558â†’    if (settings.jCutLeadIn !== undefined && ui.jcutLeadIn) {
   559â†’        ui.jcutLeadIn.value = Math.round(settings.jCutLeadIn * 100);
   560â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = settings.jCutLeadIn + 's';
   561â†’    }
   562â†’
   563â†’    if (settings.jCutLeadOut !== undefined && ui.jcutLeadOut) {
   564â†’        ui.jcutLeadOut.value = Math.round(settings.jCutLeadOut * 100);
   565â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = settings.jCutLeadOut + 's';
   566â†’    }
   567â†’
   568â†’    // Save merged settings
   569â†’    saveSettings({
   570â†’        activePreset: presetId,
   571â†’        sensitivity: settings.sensitivity,
   572â†’        threshold: settings.threshold,
   573â†’        minSilenceLength: settings.minSilenceLength,
   574â†’        paddingStart: settings.paddingStart,
   575â†’        paddingEnd: settings.paddingEnd,
   576â†’        enableTakesDetection: settings.enableTakesDetection,
   577â†’        enableJCut: settings.enableJCut || false,
   578â†’        jcutLeadIn: settings.jCutLeadIn || 0.3,
   579â†’        jcutLeadOut: settings.jCutLeadOut || 0.2
   580â†’    });
   581â†’
   582â†’    setStatus(`Applied ${preset.name} preset`);
   583â†’}
   584â†’
   585â†’// ============================================================================
   586â†’// LOAD SETTINGS TO UI
   587â†’// ============================================================================
   588â†’function loadSettingsToUI() {
   589â†’    const settings = getSettings();
   590â†’
   591â†’    if (ui.sensitivitySlider) {
   592â†’        ui.sensitivitySlider.value = settings.sensitivity;
   593â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = settings.sensitivity;
   594â†’    }
   595â†’
   596â†’    if (ui.enableTakesDetection) ui.enableTakesDetection.checked = settings.enableTakesDetection;
   597â†’    if (ui.enableJCut) ui.enableJCut.checked = settings.enableJCut;
   598â†’    if (ui.enableZoom) ui.enableZoom.checked = settings.enableZoom;
   599â†’    if (ui.enableChapters) ui.enableChapters.checked = settings.enableChapters;
   600â†’
   601â†’    if (ui.jcutSettings) ui.jcutSettings.classList.toggle('collapsed', !settings.enableJCut);
   602â†’    if (ui.zoomSettings) ui.zoomSettings.classList.toggle('collapsed', !settings.enableZoom);
   603â†’    if (ui.chapterSettings) ui.chapterSettings.classList.toggle('collapsed', !settings.enableChapters);
   604â†’
   605â†’    if (ui.jcutLeadIn) {
   606â†’        ui.jcutLeadIn.value = Math.round(settings.jcutLeadIn * 100);
   607â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = settings.jcutLeadIn + 's';
   608â†’    }
   609â†’    if (ui.jcutLeadOut) {
   610â†’        ui.jcutLeadOut.value = Math.round(settings.jcutLeadOut * 100);
   611â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = settings.jcutLeadOut + 's';
   612â†’    }
   613â†’
   614â†’    if (ui.presetSelector && settings.activePreset) {
   615â†’        ui.presetSelector.value = settings.activePreset;
   616â†’    }
   617â†’}
   618â†’
   619â†’// ============================================================================
   620â†’// GO BUTTON - MAIN WORKFLOW
   621â†’// ============================================================================
   622â†’function initGoButton() {
   623â†’    if (!ui.goBtn) return;
   624â†’
   625â†’    ui.goBtn.addEventListener('click', async () => {
   626â†’        if (isOperationInProgress) return;
   627â†’        await runDetection();
   628â†’    });
   629â†’}
   630â†’
   631â†’async function runDetection() {
   632â†’    if (isOperationInProgress) return;
   633â†’
   634â†’    // Check sequence with enhanced error messaging
   635â†’    const hasSequence = await checkSequenceOpen();
   636â†’    if (!hasSequence) {
   637â†’        // Check if there was a communication error vs just no sequence
   638â†’        const lastError = window.spliceState.lastSequenceCheckError;
   639â†’        if (lastError && (lastError.includes('CEP') || lastError.includes('communication') || lastError.includes('evalScript'))) {
   640â†’            setStatus('Premiere Pro connection issue - try reopening panel', true);
   641â†’            console.error('[SPLICE] runDetection: JSX communication failure:', lastError);
   642â†’        } else {
   643â†’            setStatus('Please open a sequence in the Timeline first', true);
   644â†’            console.log('[SPLICE] runDetection: No active sequence in Timeline');
   645â†’        }
   646â†’        // Clear the error for next check
   647â†’        window.spliceState.lastSequenceCheckError = null;
   648â†’        return;
   649â†’    }
   650â†’
   651â†’    // Check online
   652â†’    if (!isOnline()) {
   653â†’        setStatus('Offline - Check your connection', true);
   654â†’        return;
   655â†’    }
   656â†’
   657â†’    isOperationInProgress = true;
   658â†’    ui.goBtn.disabled = true;
   659â†’    showProgress('Detecting silences...');
   660â†’
   661â†’    try {
   662â†’        const settings = getSettings();
   663â†’
   664â†’        // Get sequence info
   665â†’        const seqInfo = await jsx.call('getActiveSequence');
   666â†’        console.log('[SPLICE] Sequence info:', seqInfo);
   667â†’
   668â†’        // Store sequence info for later use
   669â†’        currentSequenceInfo = seqInfo;
   670â†’        window.spliceState.activeSequence = seqInfo;
   671â†’        if (seqInfo && seqInfo.videoPath) {
   672â†’            window.spliceState.currentVideoPath = seqInfo.videoPath;
   673â†’        }
   674â†’
   675â†’        // Export audio via JSX for silence detection
   676â†’        updateProgress(10, 'Exporting audio...');
   677â†’
   678â†’        let audioFilePath = null;
   679â†’        try {
   680â†’            // Get sequence info for audio export
   681â†’            const exportResult = await jsx.call('exportSequenceAudioForAnalysis');
   682â†’            if (exportResult && exportResult.success && exportResult.outputPath) {
   683â†’                audioFilePath = exportResult.outputPath;
   684â†’                console.log('[SPLICE] Audio exported to:', audioFilePath);
   685â†’            } else if (exportResult && exportResult.error) {
   686â†’                throw new Error(exportResult.error);
   687â†’            }
   688â†’        } catch (exportError) {
   689â†’            console.warn('[SPLICE] Audio export failed, trying fallback:', exportError.message);
   690â†’            // Try to get audio from first clip in timeline
   691â†’            try {
   692â†’                const clipInfo = await jsx.call('getFirstClipAudioPath');
   693â†’                if (clipInfo && clipInfo.path) {
   694â†’                    audioFilePath = clipInfo.path;
   695â†’                    console.log('[SPLICE] Using clip audio path:', audioFilePath);
   696â†’                }
   697â†’            } catch (clipError) {
   698â†’                console.warn('[SPLICE] Fallback audio path failed:', clipError.message);
   699â†’            }
   700â†’        }
   701â†’
   702â†’        if (!audioFilePath) {
   703â†’            throw new Error('Could not export or locate audio file. Please ensure sequence has audio tracks.');
   704â†’        }
   705â†’
   706â†’        // Store audio path globally for other modules
   707â†’        currentAudioPath = audioFilePath;
   708â†’        window.spliceState.audioPath = audioFilePath;
   709â†’
   710â†’        // Call backend for silence detection with audio file path
   711â†’        updateProgress(30, 'Detecting silences...');
   712â†’        const silenceResponse = await fetchWithTimeout(
   713â†’            `${getBackendUrl()}/silences-rms`,
   714â†’            {
   715â†’                method: 'POST',
   716â†’                headers: getAuthHeaders(),
   717â†’                body: JSON.stringify({
   718â†’                    wavPath: audioFilePath,
   719â†’                    sensitivity: settings.sensitivity,
   720â†’                    minSilenceLength: settings.minSilenceLength || 0.5
   721â†’                })
   722â†’            }
   723â†’        );
   724â†’
   725â†’        if (!silenceResponse.ok) {
   726â†’            throw new Error(await parseErrorResponse(silenceResponse));
   727â†’        }
   728â†’
   729â†’        const silenceData = await silenceResponse.json();
   730â†’        previewSilences = silenceData.silences || [];
   731â†’
   732â†’        // Detect takes if enabled
   733â†’        if (settings.enableTakesDetection) {
   734â†’            updateProgress(60, 'Detecting takes...');
   735â†’            try {
   736â†’                const analyzeResponse = await fetchWithTimeout(
   737â†’                    `${getBackendUrl()}/analyze`,
   738â†’                    {
   739â†’                        method: 'POST',
   740â†’                        headers: getAuthHeaders(),
   741â†’                        body: JSON.stringify({
   742â†’                            wavPath: audioFilePath,
   743â†’                            detectTakes: true
   744â†’                        })
   745â†’                    }
   746â†’                );
   747â†’
   748â†’                if (analyzeResponse.ok) {
   749â†’                    const analyzeData = await analyzeResponse.json();
   750â†’                    previewTakes = analyzeData.takes || [];
   751â†’
   752â†’                    // Store transcript for captions/music modules
   753â†’                    if (analyzeData.transcript) {
   754â†’                        currentTranscript = analyzeData.transcript;
   755â†’                        window.currentTranscript = analyzeData.transcript;
   756â†’                        window.spliceState.lastTranscript = analyzeData.transcript;
   757â†’                    }
   758â†’                } else {
   759â†’                    // Handle specific error codes
   760â†’                    const errorMsg = await parseErrorResponse(analyzeResponse);
   761â†’                    if (analyzeResponse.status === 402) {
   762â†’                        console.warn('[SPLICE] Takes detection skipped: insufficient credits');
   763â†’                        setStatus('Takes detection skipped: insufficient credits', true);
   764â†’                    } else if (analyzeResponse.status === 401) {
   765â†’                        console.warn('[SPLICE] Takes detection skipped: authentication required');
   766â†’                    } else {
   767â†’                        console.warn('[SPLICE] Takes detection failed:', errorMsg);
   768â†’                    }
   769â†’                }
   770â†’            } catch (e) {
   771â†’                console.warn('[SPLICE] Takes detection failed:', e.message);
   772â†’            }
   773â†’        }
   774â†’
   775â†’        // Detect profanity if enabled
   776â†’        if (settings.enableProfanity) {
   777â†’            updateProgress(65, 'Detecting profanity...');
   778â†’            try {
   779â†’                const profanityResponse = await fetchWithTimeout(
   780â†’                    `${getBackendUrl()}/profanity`,
   781â†’                    {
   782â†’                        method: 'POST',
   783â†’                        headers: getAuthHeaders(),
   784â†’                        body: JSON.stringify({
   785â†’                            wavPath: audioFilePath,
   786â†’                            language: settings.profanityLanguage || 'en',
   787â†’                            bleepType: settings.bleepType || 'standard'
   788â†’                        })
   789â†’                    }
   790â†’                );
   791â†’
   792â†’                if (profanityResponse.ok) {
   793â†’                    const profanityData = await profanityResponse.json();
   794â†’                    currentProfanity = profanityData.instances || [];
   795â†’                    if (currentProfanity.length > 0) {
   796â†’                        console.log(`[SPLICE] Found ${currentProfanity.length} profanity instances`);
   797â†’                    }
   798â†’                } else {
   799â†’                    console.warn('[SPLICE] Profanity detection failed:', await parseErrorResponse(profanityResponse));
   800â†’                }
   801â†’            } catch (e) {
   802â†’                console.warn('[SPLICE] Profanity detection failed:', e.message);
   803â†’            }
   804â†’        }
   805â†’
   806â†’        // Detect chapters if enabled
   807â†’        if (settings.enableChapters) {
   808â†’            updateProgress(80, 'Detecting chapters...');
   809â†’            try {
   810â†’                const chapterResponse = await fetchWithTimeout(
   811â†’                    `${getBackendUrl()}/chapters`,
   812â†’                    {
   813â†’                        method: 'POST',
   814â†’                        headers: getAuthHeaders(),
   815â†’                        body: JSON.stringify({
   816â†’                            wavPath: audioFilePath,
   817â†’                            transcript: currentTranscript,
   818â†’                            maxChapters: settings.maxChapters || 10,
   819â†’                            minChapterLength: settings.minChapterLength || 60
   820â†’                        })
   821â†’                    }
   822â†’                );
   823â†’
   824â†’                if (chapterResponse.ok) {
   825â†’                    const chapterData = await chapterResponse.json();
   826â†’                    currentChapters = chapterData.chapters || [];
   827â†’                }
   828â†’            } catch (e) {
   829â†’                console.warn('[SPLICE] Chapter detection failed:', e);
   830â†’            }
   831â†’        }
   832â†’
   833â†’        // Detect zoom points if enabled
   834â†’        if (settings.enableZoom) {
   835â†’            updateProgress(90, 'Detecting zoom points...');
   836â†’            try {
   837â†’                const zoomResponse = await fetchWithTimeout(
   838â†’                    `${getBackendUrl()}/zoom`,
   839â†’                    {
   840â†’                        method: 'POST',
   841â†’                        headers: getAuthHeaders(),
   842â†’                        body: JSON.stringify({
   843â†’                            wavPath: audioFilePath,
   844â†’                            transcript: currentTranscript,
   845â†’                            frequency: settings.zoomFrequency || 'medium',
   846â†’                            preset: settings.zoomPreset || 'medium',
   847â†’                            placement: settings.zoomPlacement || 'sentence_start'
   848â†’                        })
   849â†’                    }
   850â†’                );
   851â†’
   852â†’                if (zoomResponse.ok) {
   853â†’                    const zoomData = await zoomResponse.json();
   854â†’                    currentZooms = zoomData.zoomPoints || [];
   855â†’                }
   856â†’            } catch (e) {
   857â†’                console.warn('[SPLICE] Zoom detection failed:', e);
   858â†’            }
   859â†’        }
   860â†’
   861â†’        // Store results
   862â†’        lastDetectionResult = {
   863â†’            silences: previewSilences,
   864â†’            takes: previewTakes,
   865â†’            chapters: currentChapters,
   866â†’            zooms: currentZooms
   867â†’        };
   868â†’
   869â†’        // Show preview
   870â†’        hideProgress();
   871â†’        showCombinedPreview();
   872â†’        setStatus(`Found ${previewSilences.length} silences, ${previewTakes.length} takes`);
   873â†’
   874â†’    } catch (error) {
   875â†’        console.error('[SPLICE] Detection error:', error);
   876â†’        setStatus('Detection failed: ' + error.message, true);
   877â†’        hideProgress();
   878â†’    } finally {
   879â†’        isOperationInProgress = false;
   880â†’        ui.goBtn.disabled = false;
   881â†’    }
   882â†’}
   883â†’
   884â†’// ============================================================================
   885â†’// PROGRESS UI
   886â†’// ============================================================================
   887â†’function showProgress(message) {
   888â†’    if (ui.progressContainer) ui.progressContainer.classList.remove('hidden');
   889â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   890â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
   891â†’    updateProgress(0, message);
   892â†’}
   893â†’
   894â†’function updateProgress(percent, message) {
   895â†’    if (ui.progressBar) ui.progressBar.style.width = percent + '%';
   896â†’    if (ui.progressText) ui.progressText.textContent = message || '';
   897â†’}
   898â†’
   899â†’function hideProgress() {
   900â†’    if (ui.progressContainer) ui.progressContainer.classList.add('hidden');
   901â†’}
   902â†’
   903â†’// ============================================================================
   904â†’// COMBINED PREVIEW
   905â†’// ============================================================================
   906â†’function showCombinedPreview() {
   907â†’    if (!ui.combinedPreview) return;
   908â†’
   909â†’    ui.combinedPreview.classList.remove('hidden');
   910â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   911â†’
   912â†’    // Update counts
   913â†’    if (ui.silenceCount) ui.silenceCount.textContent = previewSilences.length;
   914â†’    if (ui.takeCount) ui.takeCount.textContent = previewTakes.length;
   915â†’
   916â†’    // Select all by default
   917â†’    selectedSilenceIndices.clear();
   918â†’    previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
   919â†’    updateSelectedCount();
   920â†’
   921â†’    // Render preview list
   922â†’    renderPreviewList();
   923â†’
   924â†’    // Show chapter results if available
   925â†’    if (currentChapters.length > 0 && ui.chapterResults) {
   926â†’        ui.chapterResults.classList.remove('hidden');
   927â†’        renderChapterList();
   928â†’    }
   929â†’
   930â†’    // Show zoom results if available
   931â†’    if (currentZooms.length > 0 && ui.zoomResults) {
   932â†’        ui.zoomResults.classList.remove('hidden');
   933â†’    }
   934â†’}
   935â†’
   936â†’function renderPreviewList() {
   937â†’    if (!ui.previewList) return;
   938â†’
   939â†’    const html = [];
   940â†’
   941â†’    // Render silences
   942â†’    previewSilences.forEach((silence, i) => {
   943â†’        const isSelected = selectedSilenceIndices.has(i);
   944â†’        const duration = silence.end - silence.start;
   945â†’        html.push(`
   946â†’            <div class="preview-item ${isSelected ? '' : 'excluded'}" data-index="${i}" data-type="silence">
   947â†’                <input type="checkbox" class="preview-item-check" ${isSelected ? 'checked' : ''}>
   948â†’                <div class="preview-item-info">
   949â†’                    <div class="preview-item-time">${formatTime(silence.start)} - ${formatTime(silence.end)}</div>
   950â†’                    <div class="preview-item-duration">${duration.toFixed(2)}s silence</div>
   951â†’                </div>
   952â†’            </div>
   953â†’        `);
   954â†’    });
   955â†’
   956â†’    // Render takes
   957â†’    previewTakes.forEach((take, i) => {
   958â†’        // SECURITY: Escape take label to prevent XSS
   959â†’        const safeLabel = escapeHtml(take.label || 'Take ' + (take.takeNumber || i + 1));
   960â†’        html.push(`
   961â†’            <div class="preview-item take-item" data-index="${i}" data-type="take">
   962â†’                <div class="preview-item-icon">ðŸŽ¬</div>
   963â†’                <div class="preview-item-info">
   964â†’                    <div class="preview-item-time">${formatTime(take.start)} - ${formatTime(take.end)}</div>
   965â†’                    <div class="preview-item-label">${safeLabel}</div>
   966â†’                </div>
   967â†’            </div>
   968â†’        `);
   969â†’    });
   970â†’
   971â†’    ui.previewList.innerHTML = html.join('');
   972â†’
   973â†’    // Add click handlers
   974â†’    ui.previewList.querySelectorAll('.preview-item').forEach(item => {
   975â†’        item.addEventListener('click', (e) => {
   976â†’            const index = parseInt(item.dataset.index);
   977â†’            const type = item.dataset.type;
   978â†’
   979â†’            if (e.target.classList.contains('preview-item-check')) {
   980â†’                // Checkbox clicked
   981â†’                toggleSilenceSelection(index);
   982â†’            } else {
   983â†’                // Item clicked - seek to time
   984â†’                const data = type === 'silence' ? previewSilences[index] : previewTakes[index];
   985â†’                seekToTime(data.start);
   986â†’            }
   987â†’        });
   988â†’    });
   989â†’}
   990â†’
   991â†’function toggleSilenceSelection(index) {
   992â†’    if (selectedSilenceIndices.has(index)) {
   993â†’        selectedSilenceIndices.delete(index);
   994â†’    } else {
   995â†’        selectedSilenceIndices.add(index);
   996â†’    }
   997â†’    updateSelectedCount();
   998â†’    renderPreviewList();
   999â†’}
  1000â†’
  1001â†’function updateSelectedCount() {
  1002â†’    if (ui.selectedCount) {
  1003â†’        ui.selectedCount.textContent = selectedSilenceIndices.size;
  1004â†’    }
  1005â†’    if (ui.selectAllSilences) {
  1006â†’        ui.selectAllSilences.checked = selectedSilenceIndices.size === previewSilences.length;
  1007â†’    }
  1008â†’}
  1009â†’
  1010â†’async function seekToTime(seconds) {
  1011â†’    try {
  1012â†’        // Check if there's an active sequence before seeking
  1013â†’        if (!app?.project?.activeSequence) {
  1014â†’            console.warn('[SPLICE] No active sequence to seek in');
  1015â†’            return;
  1016â†’        }
  1017â†’        // Use JSX to set playhead position
  1018â†’        // Note: setPlayerPosition expects ticks as a string without quotes around the number value
  1019â†’        const ticks = Math.round(seconds * 254016000000);
  1020â†’        await jsx.evalScript(`app.project.activeSequence.setPlayerPosition(${ticks})`);
  1021â†’    } catch (e) {
  1022â†’        console.warn('[SPLICE] Seek failed:', e);
  1023â†’    }
  1024â†’}
  1025â†’
  1026â†’// ============================================================================
  1027â†’// CHAPTER LIST
  1028â†’// ============================================================================
  1029â†’function renderChapterList() {
  1030â†’    if (!ui.chapterList) return;
  1031â†’
  1032â†’    const html = currentChapters.map((chapter, i) => {
  1033â†’        // SECURITY: Escape chapter title to prevent XSS
  1034â†’        const safeTitle = escapeHtml(chapter.title);
  1035â†’        return `
  1036â†’            <div class="chapter-item" data-index="${i}">
  1037â†’                <div class="chapter-time">${formatTime(chapter.startTime)}</div>
  1038â†’                <div class="chapter-title">${safeTitle}</div>
  1039â†’            </div>
  1040â†’        `;
  1041â†’    }).join('');
  1042â†’
  1043â†’    ui.chapterList.innerHTML = html;
  1044â†’
  1045â†’    // Add click handlers
  1046â†’    ui.chapterList.querySelectorAll('.chapter-item').forEach(item => {
  1047â†’        item.addEventListener('click', () => {
  1048â†’            const index = parseInt(item.dataset.index);
  1049â†’            seekToTime(currentChapters[index].startTime);
  1050â†’        });
  1051â†’    });
  1052â†’}
  1053â†’
  1054â†’// ============================================================================
  1055â†’// PREVIEW HANDLERS
  1056â†’// ============================================================================
  1057â†’function initPreviewHandlers() {
  1058â†’    // Select all checkbox
  1059â†’    if (ui.selectAllSilences) {
  1060â†’        ui.selectAllSilences.addEventListener('change', () => {
  1061â†’            if (ui.selectAllSilences.checked) {
  1062â†’                previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
  1063â†’            } else {
  1064â†’                selectedSilenceIndices.clear();
  1065â†’            }
  1066â†’            updateSelectedCount();
  1067â†’            renderPreviewList();
  1068â†’        });
  1069â†’    }
  1070â†’
  1071â†’    // Apply button
  1072â†’    if (ui.applyPreviewBtn) {
  1073â†’        ui.applyPreviewBtn.addEventListener('click', applyPreviewAndMarkers);
  1074â†’    }
  1075â†’
  1076â†’    // Cancel button
  1077â†’    if (ui.cancelPreviewBtn) {
  1078â†’        ui.cancelPreviewBtn.addEventListener('click', hidePreview);
  1079â†’    }
  1080â†’
  1081â†’    // Build sequence button
  1082â†’    if (ui.buildSequenceBtn) {
  1083â†’        ui.buildSequenceBtn.addEventListener('click', buildSequence);
  1084â†’    }
  1085â†’
  1086â†’    // Copy YouTube timestamps
  1087â†’    if (ui.copyYouTubeBtn) {
  1088â†’        ui.copyYouTubeBtn.addEventListener('click', copyYouTubeTimestamps);
  1089â†’    }
  1090â†’
  1091â†’    // Add chapter markers
  1092â†’    if (ui.addChapterMarkersBtn) {
  1093â†’        ui.addChapterMarkersBtn.addEventListener('click', addChapterMarkers);
  1094â†’    }
  1095â†’
  1096â†’    // Apply zoom markers
  1097â†’    const applyZoomsBtn = document.getElementById('applyZoomsBtn');
  1098â†’    if (applyZoomsBtn) {
  1099â†’        applyZoomsBtn.addEventListener('click', applyZoomMarkers);
  1100â†’    }
  1101â†’}
  1102â†’
  1103â†’async function applyPreviewAndMarkers() {
  1104â†’    if (isOperationInProgress) return;
  1105â†’
  1106â†’    isOperationInProgress = true;
  1107â†’    setStatus('Adding markers...');
  1108â†’
  1109â†’    try {
  1110â†’        // Add silence markers
  1111â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
  1112â†’        for (const silence of selectedSilences) {
  1113â†’            await jsx.call('createMarker', silence.start, 'SPLICE: Silence', silence.end - silence.start, null, 1);
  1114â†’        }
  1115â†’
  1116â†’        // Add take markers
  1117â†’        for (const take of previewTakes) {
  1118â†’            await jsx.call('createMarker', take.start, take.label || `Take ${take.takeNumber}`, take.end - take.start, null, 5);
  1119â†’        }
  1120â†’
  1121â†’        setStatus(`Added ${selectedSilences.length + previewTakes.length} markers`);
  1122â†’    } catch (error) {
  1123â†’        setStatus('Failed to add markers: ' + error.message, true);
  1124â†’    } finally {
  1125â†’        isOperationInProgress = false;
  1126â†’    }
  1127â†’}
  1128â†’
  1129â†’function hidePreview() {
  1130â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
  1131â†’    if (ui.chapterResults) ui.chapterResults.classList.add('hidden');
  1132â†’    if (ui.zoomResults) ui.zoomResults.classList.add('hidden');
  1133â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.remove('hidden');
  1134â†’    previewSilences = [];
  1135â†’    previewTakes = [];
  1136â†’    selectedSilenceIndices.clear();
  1137â†’}
  1138â†’
  1139â†’async function buildSequence() {
  1140â†’    if (isOperationInProgress) return;
  1141â†’
  1142â†’    isOperationInProgress = true;
  1143â†’    setStatus('Building sequence...');
  1144â†’
  1145â†’    try {
  1146â†’        const settings = getSettings();
  1147â†’
  1148â†’        // Ensure we have sequence info
  1149â†’        if (!currentSequenceInfo) {
  1150â†’            currentSequenceInfo = await jsx.call('getActiveSequence');
  1151â†’        }
  1152â†’
  1153â†’        // Create cut list from selected silences
  1154â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
  1155â†’
  1156â†’        // Calculate total duration from sequence info or last silence
  1157â†’        let duration = 0;
  1158â†’        if (currentSequenceInfo && currentSequenceInfo.duration) {
  1159â†’            duration = currentSequenceInfo.duration;
  1160â†’        } else if (previewSilences.length > 0) {
  1161â†’            const lastSilence = previewSilences[previewSilences.length - 1];
  1162â†’            duration = lastSilence.end + 10; // Add buffer
  1163â†’        }
  1164â†’
  1165â†’        // Call backend to generate cut list
  1166â†’        const cutListResponse = await fetchWithTimeout(
  1167â†’            `${getBackendUrl()}/cut-list`,
  1168â†’            {
  1169â†’                method: 'POST',
  1170â†’                headers: getAuthHeaders(),
  1171â†’                body: JSON.stringify({
  1172â†’                    sourceName: currentSequenceInfo?.name || 'Untitled Sequence',
  1173â†’                    sourcePath: currentSequenceInfo?.treePath || currentSequenceInfo?.name || 'Untitled',
  1174â†’                    duration: duration,
  1175â†’                    silences: selectedSilences,
  1176â†’                    takes: previewTakes,
  1177â†’                    enableTakes: settings.enableTakesDetection,
  1178â†’                    jCutOffset: settings.enableJCut ? settings.jcutLeadIn : 0,
  1179â†’                    lCutOffset: settings.enableJCut ? settings.jcutLeadOut : 0
  1180â†’                })
  1181â†’            }
  1182â†’        );
  1183â†’
  1184â†’        if (!cutListResponse.ok) {
  1185â†’            throw new Error(await parseErrorResponse(cutListResponse));
  1186â†’        }
  1187â†’
  1188â†’        const cutList = await cutListResponse.json();
  1189â†’
  1190â†’        // Build sequence via JSX
  1191â†’        const result = await jsx.call('buildSequenceFromCutList', JSON.stringify(cutList));
  1192â†’
  1193â†’        if (result && result.success) {
  1194â†’            setStatus(`Built sequence: ${result.sequenceName}`);
  1195â†’            hidePreview();
  1196â†’        } else {
  1197â†’            throw new Error(result?.error || 'Build failed');
  1198â†’        }
  1199â†’    } catch (error) {
  1200â†’        setStatus('Build failed: ' + error.message, true);
  1201â†’    } finally {
  1202â†’        isOperationInProgress = false;
  1203â†’    }
  1204â†’}
  1205â†’
  1206â†’function copyYouTubeTimestamps() {
  1207â†’    if (currentChapters.length === 0) return;
  1208â†’
  1209â†’    const timestamps = currentChapters.map(ch =>
  1210â†’        `${formatTime(ch.startTime)} ${ch.title}`
  1211â†’    ).join('\n');
  1212â†’
  1213â†’    navigator.clipboard.writeText(timestamps).then(() => {
  1214â†’        setStatus('Copied YouTube timestamps');
  1215â†’    }).catch(() => {
  1216â†’        setStatus('Failed to copy', true);
  1217â†’    });
  1218â†’}
  1219â†’
  1220â†’async function addChapterMarkers() {
  1221â†’    if (isOperationInProgress || currentChapters.length === 0) return;
  1222â†’
  1223â†’    isOperationInProgress = true;
  1224â†’    setStatus('Adding chapter markers...');
  1225â†’
  1226â†’    try {
  1227â†’        for (const chapter of currentChapters) {
  1228â†’            await jsx.call('addChapterMarker', chapter.startTime, chapter.title, chapter.description);
  1229â†’        }
  1230â†’        setStatus(`Added ${currentChapters.length} chapter markers`);
  1231â†’    } catch (error) {
  1232â†’        setStatus('Failed to add markers: ' + error.message, true);
  1233â†’    } finally {
  1234â†’        isOperationInProgress = false;
  1235â†’    }
  1236â†’}
  1237â†’
  1238â†’/**
  1239â†’ * Apply zoom point markers to the timeline
  1240â†’ */
  1241â†’async function applyZoomMarkers() {
  1242â†’    if (isOperationInProgress || currentZooms.length === 0) return;
  1243â†’
  1244â†’    isOperationInProgress = true;
  1245â†’    setStatus('Adding zoom markers...');
  1246â†’
  1247â†’    try {
  1248â†’        for (const zoom of currentZooms) {
  1249â†’            // Create a marker for each zoom point with zoom intensity info
  1250â†’            const comment = `Zoom ${zoom.intensity || 'medium'} - ${zoom.reason || 'emphasis'}`;
  1251â†’            await jsx.call('createMarker', zoom.time, 'SPLICE: Zoom', 0.5, comment, 3);
  1252â†’        }
  1253â†’        setStatus(`Added ${currentZooms.length} zoom markers`);
  1254â†’    } catch (error) {
  1255â†’        setStatus('Failed to add zoom markers: ' + error.message, true);
  1256â†’    } finally {
  1257â†’        isOperationInProgress = false;
  1258â†’    }
  1259â†’}
  1260â†’
  1261â†’// ============================================================================
  1262â†’// MODALS
  1263â†’// ============================================================================
  1264â†’function initModals() {
  1265â†’    // Settings modal
  1266â†’    if (ui.settingsBtn && ui.settingsModal) {
  1267â†’        ui.settingsBtn.addEventListener('click', () => {
  1268â†’            ui.settingsModal.classList.remove('hidden');
  1269â†’            // Sync remember options checkbox with current settings
  1270â†’            const rememberOptions = document.getElementById('rememberOptions');
  1271â†’            if (rememberOptions) {
  1272â†’                rememberOptions.checked = getSettings().rememberOptions;
  1273â†’            }
  1274â†’        });
  1275â†’    }
  1276â†’
  1277â†’    if (ui.closeSettingsBtn && ui.settingsModal) {
  1278â†’        ui.closeSettingsBtn.addEventListener('click', () => {
  1279â†’            ui.settingsModal.classList.add('hidden');
  1280â†’        });
  1281â†’    }
  1282â†’
  1283â†’    // Remember options checkbox
  1284â†’    const rememberOptions = document.getElementById('rememberOptions');
  1285â†’    if (rememberOptions) {
  1286â†’        rememberOptions.addEventListener('change', () => {
  1287â†’            saveSettings({ rememberOptions: rememberOptions.checked });
  1288â†’            if (rememberOptions.checked) {
  1289â†’                setStatus('Options will be remembered');
  1290â†’            } else {
  1291â†’                setStatus('Options will reset to defaults');
  1292â†’            }
  1293â†’        });
  1294â†’    }
  1295â†’
  1296â†’    // Credit badge click handler (handles login, retry, and refresh)
  1297â†’    if (ui.creditBadge) {
  1298â†’        ui.creditBadge.addEventListener('click', () => {
  1299â†’            // Use the centralized handler from credits.js
  1300â†’            if (typeof handleCreditBadgeClick === 'function') {
  1301â†’                handleCreditBadgeClick();
  1302â†’            } else {
  1303â†’                // Fallback if credits.js not loaded yet
  1304â†’                const settings = getSettings();
  1305â†’                if (!settings.customerId) {
  1306â†’                    showLoginModal();
  1307â†’                }
  1308â†’            }
  1309â†’        });
  1310â†’    }
  1311â†’
  1312â†’    if (ui.closeLoginBtn && ui.loginModal) {
  1313â†’        ui.closeLoginBtn.addEventListener('click', () => {
  1314â†’            ui.loginModal.classList.add('hidden');
  1315â†’        });
  1316â†’    }
  1317â†’
  1318â†’    if (ui.saveLoginBtn) {
  1319â†’        ui.saveLoginBtn.addEventListener('click', activateLicense);
  1320â†’    }
  1321â†’
  1322â†’    // License lookup button
  1323â†’    const lookupLicenseBtn = document.getElementById('lookupLicenseBtn');
  1324â†’    if (lookupLicenseBtn) {
  1325â†’        lookupLicenseBtn.addEventListener('click', lookupLicense);
  1326â†’    }
  1327â†’
  1328â†’    // Close modals on backdrop click
  1329â†’    document.querySelectorAll('.modal').forEach(modal => {
  1330â†’        modal.addEventListener('click', (e) => {
  1331â†’            if (e.target === modal) {
  1332â†’                modal.classList.add('hidden');
  1333â†’            }
  1334â†’        });
  1335â†’    });
  1336â†’}
  1337â†’
  1338â†’function showLoginModal() {
  1339â†’    if (ui.loginModal) ui.loginModal.classList.remove('hidden');
  1340â†’}
  1341â†’
  1342â†’/**
  1343â†’ * Show upgrade modal when user tries to access a gated feature
  1344â†’ * @param {string} featureName - Display name of the feature
  1345â†’ * @param {string} requiredTier - Required tier (Pro, Team)
  1346â†’ */
  1347â†’function showUpgradeModal(featureName, requiredTier = 'Pro') {
  1348â†’    const modal = document.getElementById('upgradeModal');
  1349â†’    const featureText = document.getElementById('upgradeFeatureName');
  1350â†’    const tierText = document.getElementById('upgradeRequiredTier');
  1351â†’
  1352â†’    if (featureText) {
  1353â†’        featureText.textContent = featureName;
  1354â†’    }
  1355â†’    if (tierText) {
  1356â†’        tierText.textContent = requiredTier;
  1357â†’    }
  1358â†’    if (modal) {
  1359â†’        modal.classList.remove('hidden');
  1360â†’    }
  1361â†’}
  1362â†’
  1363â†’/**
  1364â†’ * Close the upgrade modal
  1365â†’ */
  1366â†’function closeUpgradeModal() {
  1367â†’    const modal = document.getElementById('upgradeModal');
  1368â†’    if (modal) {
  1369â†’        modal.classList.add('hidden');
  1370â†’    }
  1371â†’}
  1372â†’
  1373â†’// Expose showUpgradeModal and closeUpgradeModal globally for feature modules
  1374â†’window.showUpgradeModal = showUpgradeModal;
  1375â†’window.closeUpgradeModal = closeUpgradeModal;
  1376â†’
  1377â†’async function activateLicense() {
  1378â†’    if (!ui.licenseKeyInput) return;
  1379â†’
  1380â†’    const licenseKey = ui.licenseKeyInput.value.trim();
  1381â†’    if (!licenseKey) {
  1382â†’        setStatus('Please enter a license key', true);
  1383â†’        return;
  1384â†’    }
  1385â†’
  1386â†’    try {
  1387â†’        const response = await fetchWithTimeout(
  1388â†’            `${getBackendUrl()}/license/activate`,
  1389â†’            {
  1390â†’                method: 'POST',
  1391â†’                headers: { 'Content-Type': 'application/json' },
  1392â†’                body: JSON.stringify({ key: licenseKey })
  1393â†’            }
  1394â†’        );
  1395â†’
  1396â†’        if (!response.ok) {
  1397â†’            throw new Error(await parseErrorResponse(response));
  1398â†’        }
  1399â†’
  1400â†’        const data = await response.json();
  1401â†’        saveSettings({
  1402â†’            customerId: data.customerId,
  1403â†’            licenseKey: licenseKey
  1404â†’        });
  1405â†’
  1406â†’        if (ui.loginModal) ui.loginModal.classList.add('hidden');
  1407â†’        setStatus('License activated');
  1408â†’        updateCredits();
  1409â†’    } catch (error) {
  1410â†’        setStatus('Activation failed: ' + error.message, true);
  1411â†’    }
  1412â†’}
  1413â†’
  1414â†’/**
  1415â†’ * Look up license key by email address
  1416â†’ */
  1417â†’async function lookupLicense() {
  1418â†’    const lookupEmailInput = document.getElementById('lookupEmailInput');
  1419â†’    const licenseKeyInput = document.getElementById('licenseKeyInput');
  1420â†’
  1421â†’    if (!lookupEmailInput) return;
  1422â†’
  1423â†’    const email = lookupEmailInput.value.trim().toLowerCase();
  1424â†’    if (!email) {
  1425â†’        setStatus('Please enter your email address', true);
  1426â†’        return;
  1427â†’    }
  1428â†’
  1429â†’    // Basic email validation
  1430â†’    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  1431â†’    if (!emailRegex.test(email)) {
  1432â†’        setStatus('Please enter a valid email address', true);
  1433â†’        return;
  1434â†’    }
  1435â†’
  1436â†’    const lookupBtn = document.getElementById('lookupLicenseBtn');
  1437â†’    if (lookupBtn) {
  1438â†’        lookupBtn.disabled = true;
  1439â†’        lookupBtn.textContent = 'Looking up...';
  1440â†’    }
  1441â†’
  1442â†’    try {
  1443â†’        const response = await fetchWithTimeout(
  1444â†’            `${getBackendUrl()}/license/lookup`,
  1445â†’            {
  1446â†’                method: 'POST',
  1447â†’                headers: { 'Content-Type': 'application/json' },
  1448â†’                body: JSON.stringify({ email })
  1449â†’            },
  1450â†’            30000
  1451â†’        );
  1452â†’
  1453â†’        const result = await response.json();
  1454â†’
  1455â†’        // Note: For security, the backend does NOT return the license key directly.
  1456â†’        // It sends the key via email to prevent enumeration attacks.
  1457â†’        if (result.success) {
  1458â†’            setStatus(result.message || 'If a license exists, it has been sent to your email.');
  1459â†’        } else {
  1460â†’            setStatus(result.error || 'Lookup failed. Please try again.', true);
  1461â†’        }
  1462â†’    } catch (error) {
  1463â†’        setStatus('Lookup failed: ' + error.message, true);
  1464â†’    } finally {
  1465â†’        if (lookupBtn) {
  1466â†’            lookupBtn.disabled = false;
  1467â†’            lookupBtn.textContent = 'Lookup';
  1468â†’        }
  1469â†’    }
  1470â†’}
  1471â†’
  1472â†’// ============================================================================
  1473â†’// CREDITS
  1474â†’// ============================================================================
  1475â†’function initCredits() {
  1476â†’    updateCredits();
  1477â†’}
  1478â†’
  1479â†’async function updateCredits() {
  1480â†’    if (!ui.creditBadge) return;
  1481â†’
  1482â†’    const settings = getSettings();
  1483â†’    if (!settings.customerId) {
  1484â†’        ui.creditBadge.className = 'credit-badge login';
  1485â†’        ui.creditBadge.textContent = 'Login';
  1486â†’        ui.creditBadge.style.display = 'flex';
  1487â†’        return;
  1488â†’    }
  1489â†’
  1490â†’    try {
  1491â†’        const response = await fetchWithTimeout(
  1492â†’            `${getBackendUrl()}/credits`,
  1493â†’            {
  1494â†’                method: 'GET',
  1495â†’                headers: getAuthHeaders()
  1496â†’            }
  1497â†’        );
  1498â†’
  1499â†’        if (response.ok) {
  1500â†’            const data = await response.json();
  1501â†’            // Backend returns hoursRemaining (not remainingMinutes)
  1502â†’            const hours = (data.hoursRemaining || 0).toFixed(1);
  1503â†’            ui.creditBadge.textContent = `${hours}h`;
  1504â†’            // Low warning when less than 1 hour remaining
  1505â†’            ui.creditBadge.className = data.hoursRemaining < 1 ? 'credit-badge low' : 'credit-badge ok';
  1506â†’            ui.creditBadge.style.display = 'flex';
  1507â†’        } else {
  1508â†’            ui.creditBadge.className = 'credit-badge error';
  1509â†’            ui.creditBadge.textContent = 'Error';
  1510â†’            ui.creditBadge.style.display = 'flex';
  1511â†’        }
  1512â†’    } catch {
  1513â†’        ui.creditBadge.className = 'credit-badge error';
  1514â†’        ui.creditBadge.textContent = 'Offline';
  1515â†’        ui.creditBadge.style.display = 'flex';
  1516â†’    }
  1517â†’}
  1518â†’
  1519â†’// ============================================================================
  1520â†’// HELP BUTTON
  1521â†’// ============================================================================
  1522â†’function initHelpButton() {
  1523â†’    const helpBtn = document.getElementById('helpBtn');
  1524â†’    if (helpBtn) {
  1525â†’        helpBtn.addEventListener('click', () => {
  1526â†’            setStatus('Silence: removes quiet gaps | Takes: detects repeated content | Chapters: AI topic segmentation');
  1527â†’        });
  1528â†’    }
  1529â†’}
  1530â†’
  1531â†’// Export for debugging
  1532â†’window.spliceDebug = {
  1533â†’    getState: () => ({
  1534â†’        silences: previewSilences,
  1535â†’        takes: previewTakes,
  1536â†’        chapters: currentChapters,
  1537â†’        zooms: currentZooms,
  1538â†’        selected: Array.from(selectedSilenceIndices)
  1539â†’    }),
  1540â†’    jsx,
  1541â†’    runDetection
  1542â†’};
  1543â†’

</system-reminder>
