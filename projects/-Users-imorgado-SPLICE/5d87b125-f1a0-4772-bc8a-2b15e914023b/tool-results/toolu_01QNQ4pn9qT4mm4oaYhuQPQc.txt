     1→/**
     2→ * SPLICE Plugin Main Entry Point
     3→ *
     4→ * Initializes all functionality when the plugin loads.
     5→ * v3.4 - Timeline Markers + Unified Take-Aware Workflow.
     6→ */
     7→
     8→// Initialize Premiere Pro API
     9→const ppro = require('premierepro');
    10→
    11→// ============================================================================
    12→// CACHED DOM ELEMENTS (Performance: avoid repeated getElementById calls)
    13→// ============================================================================
    14→const ui = {};
    15→
    16→function cacheUIElements() {
    17→  ui.status = document.getElementById('status');
    18→
    19→  // Main GO button (unified workflow)
    20→  ui.goBtn = document.getElementById('goBtn');
    21→  ui.optionsToggle = document.getElementById('optionsToggle');
    22→  ui.optionsPanel = document.getElementById('optionsPanel');
    23→
    24→  // Sliders and options
    25→  ui.sensitivitySlider = document.getElementById('sensitivitySlider');
    26→  ui.sourceOriginal = document.getElementById('sourceOriginal');
    27→  ui.sourceIsolated = document.getElementById('sourceIsolated');
    28→
    29→  // Settings checkboxes
    30→  ui.enableTakesDetection = document.getElementById('enableTakesDetection');
    31→  ui.autoMarkBest = document.getElementById('autoMarkBest');
    32→
    33→  // J-Cut UI elements (Phase 1)
    34→  ui.enableJCut = document.getElementById('enableJCut');
    35→  ui.jcutSettings = document.getElementById('jcutSettings');
    36→  ui.jcutLeadIn = document.getElementById('jcutLeadIn');
    37→  ui.jcutLeadInValue = document.getElementById('jcutLeadInValue');
    38→  ui.jcutLeadOut = document.getElementById('jcutLeadOut');
    39→  ui.jcutLeadOutValue = document.getElementById('jcutLeadOutValue');
    40→
    41→  // Progress
    42→  ui.progressContainer = document.getElementById('progressContainer');
    43→  ui.progressText = document.getElementById('progressText');
    44→  ui.resultsEmpty = document.getElementById('resultsEmpty');
    45→
    46→  // Combined Preview
    47→  ui.combinedPreview = document.getElementById('combinedPreview');
    48→  ui.previewList = document.getElementById('previewList');
    49→  ui.silenceCountDisplay = document.getElementById('silenceCount');
    50→  ui.takeCountDisplay = document.getElementById('takeCount');
    51→  ui.selectedCount = document.getElementById('selectedCount');
    52→  ui.selectAllSilences = document.getElementById('selectAllSilences');
    53→  ui.applyPreviewBtn = document.getElementById('applyPreviewBtn');
    54→  ui.cancelPreviewBtn = document.getElementById('cancelPreviewBtn');
    55→  ui.invertSelectionBtn = document.getElementById('invertSelectionBtn');
    56→  ui.reRunDetectionBtn = document.getElementById('reRunDetectionBtn');
    57→
    58→  // Results
    59→  ui.silenceResults = document.getElementById('silenceResults');
    60→  ui.resultsCount = document.getElementById('resultsCount');
    61→  ui.timeSaved = document.getElementById('timeSaved');
    62→  ui.clipsModified = document.getElementById('clipsModified');
    63→
    64→  // Build Sequence button (v3.5)
    65→  ui.buildSequenceBtn = document.getElementById('buildSequenceBtn');
    66→
    67→  // Buttons
    68→  ui.undoBtn = document.getElementById('undoBtn');
    69→  ui.advancedSection = document.getElementById('advancedSection');
    70→
    71→  // Settings modal
    72→  ui.settingsBtn = document.getElementById('settingsBtn');
    73→  ui.settingsModal = document.getElementById('settingsModal');
    74→  ui.closeSettingsBtn = document.getElementById('closeSettingsBtn');
    75→
    76→  // Media folder (v3.5)
    77→  ui.mediaFolderDisplay = document.getElementById('mediaFolderDisplay');
    78→  ui.setMediaFolderBtn = document.getElementById('setMediaFolderBtn');
    79→  ui.clearMediaFolderBtn = document.getElementById('clearMediaFolderBtn');
    80→
    81→  // Custom Presets (v3.5)
    82→  ui.savePresetBtn = document.getElementById('savePresetBtn');
    83→  ui.managePresetsBtn = document.getElementById('managePresetsBtn');
    84→  ui.presetModal = document.getElementById('presetModal');
    85→  ui.presetModalTitle = document.getElementById('presetModalTitle');
    86→  ui.closePresetModalBtn = document.getElementById('closePresetModalBtn');
    87→  ui.presetNameInput = document.getElementById('presetNameInput');
    88→  ui.presetDescInput = document.getElementById('presetDescInput');
    89→  ui.presetIconPicker = document.getElementById('presetIconPicker');
    90→  ui.presetEditId = document.getElementById('presetEditId');
    91→  ui.presetSelectedIcon = document.getElementById('presetSelectedIcon');
    92→  ui.savePresetConfirmBtn = document.getElementById('savePresetConfirmBtn');
    93→  ui.presetModalError = document.getElementById('presetModalError');
    94→  ui.managePresetsModal = document.getElementById('managePresetsModal');
    95→  ui.closeManagePresetsBtn = document.getElementById('closeManagePresetsBtn');
    96→  ui.presetsList = document.getElementById('presetsList');
    97→  ui.noCustomPresets = document.getElementById('noCustomPresets');
    98→  ui.presetSelector = document.getElementById('presetSelector');
    99→
   100→  // Preset settings inputs (Phase 3)
   101→  ui.presetSensitivity = document.getElementById('presetSensitivity');
   102→  ui.presetSensitivityValue = document.getElementById('presetSensitivityValue');
   103→  ui.presetThreshold = document.getElementById('presetThreshold');
   104→
   105→  // Export/Import buttons (Phase 3)
   106→  ui.exportPresetsBtn = document.getElementById('exportPresetsBtn');
   107→  ui.importPresetsBtn = document.getElementById('importPresetsBtn');
   108→
   109→  // Confirmation modal (UXP-compatible)
   110→  ui.confirmModal = document.getElementById('confirmModal');
   111→  ui.confirmModalTitle = document.getElementById('confirmModalTitle');
   112→  ui.confirmModalMessage = document.getElementById('confirmModalMessage');
   113→  ui.confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
   114→  ui.confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
   115→  ui.closeConfirmModalBtn = document.getElementById('closeConfirmModalBtn');
   116→
   117→  // Auto Zoom UI elements (Phase 3)
   118→  ui.enableZoom = document.getElementById('enableZoom');
   119→  ui.zoomSettings = document.getElementById('zoomSettings');
   120→  ui.zoomFrequency = document.getElementById('zoomFrequency');
   121→  ui.zoomPreset = document.getElementById('zoomPreset');
   122→  ui.zoomPlacement = document.getElementById('zoomPlacement');
   123→  ui.zoomResults = document.getElementById('zoomResults');
   124→  ui.zoomCount = document.getElementById('zoomCount');
   125→  ui.zoomList = document.getElementById('zoomList');
   126→  ui.applyZoomsBtn = document.getElementById('applyZoomsBtn');
   127→
   128→  // Chapter Detection UI elements (Phase 3)
   129→  ui.enableChapters = document.getElementById('enableChapters');
   130→  ui.chapterSettings = document.getElementById('chapterSettings');
   131→  ui.maxChapters = document.getElementById('maxChapters');
   132→  ui.minChapterLength = document.getElementById('minChapterLength');
   133→  ui.chapterResults = document.getElementById('chapterResults');
   134→  ui.chapterCount = document.getElementById('chapterCount');
   135→  ui.chapterList = document.getElementById('chapterList');
   136→  ui.youtubeTimestamps = document.getElementById('youtubeTimestamps');
   137→  ui.timestampText = document.getElementById('timestampText');
   138→  ui.copyYouTubeBtn = document.getElementById('copyYouTubeBtn');
   139→  ui.addChapterMarkersBtn = document.getElementById('addChapterMarkersBtn');
   140→}
   141→
   142→// ============================================================================
   143→// CONFIRMATION MODAL (UXP-compatible replacement for confirm())
   144→// ============================================================================
   145→let confirmModalCallback = null;
   146→
   147→/**
   148→ * Show a confirmation modal dialog (UXP-compatible replacement for confirm())
   149→ * @param {string} title - Modal title
   150→ * @param {string} message - Confirmation message
   151→ * @param {Function} onConfirm - Callback when confirmed
   152→ * @param {Function} [onCancel] - Optional callback when cancelled
   153→ * @param {Object} [options] - Optional customization { confirmText, cancelText, confirmStyle }
   154→ */
   155→function showConfirmModal(title, message, onConfirm, onCancel = null, options = {}) {
   156→  if (!ui.confirmModal) return;
   157→
   158→  // Set content
   159→  if (ui.confirmModalTitle) ui.confirmModalTitle.textContent = title;
   160→  if (ui.confirmModalMessage) ui.confirmModalMessage.textContent = message;
   161→
   162→  // Customize button text if provided
   163→  if (ui.confirmModalConfirmBtn) {
   164→    ui.confirmModalConfirmBtn.textContent = options.confirmText || 'Confirm';
   165→    ui.confirmModalConfirmBtn.style.background = options.confirmStyle || '#dc3545';
   166→  }
   167→  if (ui.confirmModalCancelBtn) {
   168→    ui.confirmModalCancelBtn.textContent = options.cancelText || 'Cancel';
   169→  }
   170→
   171→  // Store callbacks
   172→  confirmModalCallback = { onConfirm, onCancel };
   173→
   174→  // Show modal
   175→  ui.confirmModal.classList.remove('hidden');
   176→
   177→  // Focus cancel button for safety (user must explicitly confirm)
   178→  if (ui.confirmModalCancelBtn) ui.confirmModalCancelBtn.focus();
   179→}
   180→
   181→function hideConfirmModal(confirmed = false) {
   182→  if (!ui.confirmModal) return;
   183→
   184→  ui.confirmModal.classList.add('hidden');
   185→
   186→  // Execute callback
   187→  if (confirmModalCallback) {
   188→    if (confirmed && confirmModalCallback.onConfirm) {
   189→      confirmModalCallback.onConfirm();
   190→    } else if (!confirmed && confirmModalCallback.onCancel) {
   191→      confirmModalCallback.onCancel();
   192→    }
   193→    confirmModalCallback = null;
   194→  }
   195→}
   196→
   197→function initConfirmModal() {
   198→  // Confirm button
   199→  if (ui.confirmModalConfirmBtn) {
   200→    ui.confirmModalConfirmBtn.addEventListener('click', () => {
   201→      hideConfirmModal(true);
   202→    });
   203→  }
   204→
   205→  // Cancel button
   206→  if (ui.confirmModalCancelBtn) {
   207→    ui.confirmModalCancelBtn.addEventListener('click', () => {
   208→      hideConfirmModal(false);
   209→    });
   210→  }
   211→
   212→  // Close button (X)
   213→  if (ui.closeConfirmModalBtn) {
   214→    ui.closeConfirmModalBtn.addEventListener('click', () => {
   215→      hideConfirmModal(false);
   216→    });
   217→  }
   218→
   219→  // Close on backdrop click
   220→  if (ui.confirmModal) {
   221→    ui.confirmModal.addEventListener('click', (e) => {
   222→      if (e.target === ui.confirmModal) {
   223→        hideConfirmModal(false);
   224→      }
   225→    });
   226→  }
   227→
   228→  // Keyboard support
   229→  document.addEventListener('keydown', (e) => {
   230→    if (!ui.confirmModal || ui.confirmModal.classList.contains('hidden')) return;
   231→
   232→    if (e.key === 'Escape') {
   233→      e.preventDefault();
   234→      hideConfirmModal(false);
   235→    } else if (e.key === 'Enter') {
   236→      e.preventDefault();
   237→      hideConfirmModal(true);
   238→    }
   239→  });
   240→}
   241→
   242→// ============================================================================
   243→// STATE MANAGEMENT
   244→// ============================================================================
   245→let previewSilences = [];         // All detected silences
   246→let safeSilences = [];            // Silences that don't overlap takes (safe to remove)
   247→let protectedSilences = [];       // Silences that overlap takes (protected)
   248→let previewTakes = [];            // Detected takes (for display)
   249→let selectedSilenceIndices = new Set();
   250→let isOperationInProgress = false;
   251→let pendingUIUpdate = null;
   252→
   253→// Export preview state for other modules (Razor integration)
   254→window.splicePreviewState = {
   255→  getSelectedSilences: () => safeSilences.filter((_, i) => selectedSilenceIndices.has(i)),
   256→  getSelectedTakes: () => previewTakes,
   257→  hasPreview: () => safeSilences.length > 0 || previewTakes.length > 0
   258→};
   259→
   260→// ============================================================================
   261→// INITIALIZATION
   262→// ============================================================================
   263→document.addEventListener('DOMContentLoaded', async () => {
   264→  // Cache all DOM elements first
   265→  cacheUIElements();
   266→
   267→  // Initialize file paths (cross-platform support)
   268→  // Must be done early before any audio export operations
   269→  try {
   270→    await initPaths();
   271→    console.log('[SPLICE] File paths initialized');
   272→  } catch (err) {
   273→    console.warn('[SPLICE] Path initialization warning:', err.message);
   274→    // Continue anyway - fallback paths will be used
   275→  }
   276→
   277→  // Settings & UI
   278→  initSettingsUI();
   279→  initSettingsModal();
   280→  initLoginModal();
   281→  initConfirmModal();
   282→  initOptionsToggles();
   283→  initPresetSelector();
   284→  initHelpButton();
   285→
   286→  // Credits display
   287→  initCredits();
   288→
   289→  // Offline detection
   290→  if (typeof initOfflineDetection === 'function') {
   291→    initOfflineDetection();
   292→  }
   293→
   294→  // Unified workflow (silences + takes)
   295→  initUnifiedWorkflow();
   296→
   297→  // Preview handlers (event delegation)
   298→  initPreviewHandlers();
   299→
   300→  // Undo handlers
   301→  initUndoHandlers();
   302→
   303→  // Keyboard shortcuts
   304→  initKeyboardShortcuts();
   305→
   306→  // Advanced features (Razor - legacy)
   307→  initSlice9();
   308→
   309→  // Batch processing
   310→  initBatchHandlers();
   311→
   312→  // Multitrack editing (Phase 2)
   313→  if (typeof initMultitrackUI === 'function') {
   314→    initMultitrackUI();
   315→  }
   316→
   317→  // Media folder (v3.5)
   318→  initMediaFolderHandlers();
   319→
   320→  // Custom Presets UI (v3.5)
   321→  initCustomPresetsUI();
   322→
   323→  // J-Cut/L-Cut UI (Phase 1)
   324→  initJCutUI();
   325→
   326→  // Auto Zoom UI (Phase 3)
   327→  initZoomUI();
   328→
   329→  // Chapter Detection UI (Phase 3)
   330→  initChapterUI();
   331→
   332→  // Profanity Settings UI (Feature 5)
   333→  if (typeof initProfanitySettingsUI === 'function') {
   334→    initProfanitySettingsUI();
   335→  }
   336→
   337→  // Repetition Highlighting UI (Feature 8)
   338→  initRepetitionUI();
   339→
   340→  // Waveform Visualization UI (Feature 9)
   341→  initWaveformUI();
   342→
   343→  console.log('[SPLICE] Plugin initialized v3.9.6 (Feature 9: Waveform Visualization)');
   344→});
   345→
   346→// ============================================================================
   347→// J-CUT UI INITIALIZATION (Phase 1)
   348→// ============================================================================
   349→function initJCutUI() {
   350→  // Toggle J-Cut settings visibility
   351→  if (ui.enableJCut) {
   352→    ui.enableJCut.addEventListener('change', () => {
   353→      if (ui.jcutSettings) {
   354→        if (ui.enableJCut.checked) {
   355→          ui.jcutSettings.classList.remove('collapsed');
   356→          ui.jcutSettings.style.display = 'block';
   357→        } else {
   358→          ui.jcutSettings.classList.add('collapsed');
   359→          ui.jcutSettings.style.display = 'none';
   360→        }
   361→      }
   362→    });
   363→
   364→    // Initialize collapsed state
   365→    if (ui.jcutSettings) {
   366→      ui.jcutSettings.style.display = ui.enableJCut.checked ? 'block' : 'none';
   367→    }
   368→  }
   369→
   370→  // Lead-in slider
   371→  if (ui.jcutLeadIn && ui.jcutLeadInValue) {
   372→    ui.jcutLeadIn.addEventListener('input', () => {
   373→      ui.jcutLeadInValue.textContent = `${parseFloat(ui.jcutLeadIn.value).toFixed(2)}s`;
   374→    });
   375→  }
   376→
   377→  // Lead-out slider
   378→  if (ui.jcutLeadOut && ui.jcutLeadOutValue) {
   379→    ui.jcutLeadOut.addEventListener('input', () => {
   380→      ui.jcutLeadOutValue.textContent = `${parseFloat(ui.jcutLeadOut.value).toFixed(2)}s`;
   381→    });
   382→  }
   383→
   384→  console.log('[SPLICE] J-Cut UI initialized');
   385→}
   386→
   387→/**
   388→ * Get current J-Cut settings from UI
   389→ * @returns {Object} J-Cut settings { enabled, jCutOffset, lCutOffset }
   390→ */
   391→function getJCutSettings() {
   392→  const enabled = ui.enableJCut?.checked ?? false;
   393→
   394→  if (!enabled) {
   395→    return { enabled: false, jCutOffset: 0, lCutOffset: 0 };
   396→  }
   397→
   398→  // J-cut offset is negative (audio starts before video)
   399→  const leadIn = parseFloat(ui.jcutLeadIn?.value ?? 0.3);
   400→  // L-cut offset is positive (audio extends after video)
   401→  const leadOut = parseFloat(ui.jcutLeadOut?.value ?? 0.2);
   402→
   403→  return {
   404→    enabled: true,
   405→    jCutOffset: -leadIn, // Negative for J-cut
   406→    lCutOffset: leadOut   // Positive for L-cut
   407→  };
   408→}
   409→
   410→/**
   411→ * Update J-Cut UI from preset settings
   412→ * @param {Object} settings - Preset settings object
   413→ */
   414→function updateJCutUIFromSettings(settings) {
   415→  if (!settings) return;
   416→
   417→  // Update enable checkbox
   418→  if (ui.enableJCut && settings.enableJCut !== undefined) {
   419→    ui.enableJCut.checked = settings.enableJCut;
   420→
   421→    // Toggle visibility of settings panel
   422→    if (ui.jcutSettings) {
   423→      ui.jcutSettings.style.display = settings.enableJCut ? 'block' : 'none';
   424→    }
   425→  }
   426→
   427→  // Update lead-in slider and display
   428→  if (ui.jcutLeadIn && settings.jCutLeadIn !== undefined) {
   429→    ui.jcutLeadIn.value = settings.jCutLeadIn;
   430→    if (ui.jcutLeadInValue) {
   431→      ui.jcutLeadInValue.textContent = `${parseFloat(settings.jCutLeadIn).toFixed(2)}s`;
   432→    }
   433→  }
   434→
   435→  // Update lead-out slider and display
   436→  if (ui.jcutLeadOut && settings.jCutLeadOut !== undefined) {
   437→    ui.jcutLeadOut.value = settings.jCutLeadOut;
   438→    if (ui.jcutLeadOutValue) {
   439→      ui.jcutLeadOutValue.textContent = `${parseFloat(settings.jCutLeadOut).toFixed(2)}s`;
   440→    }
   441→  }
   442→}
   443→
   444→// ============================================================================
   445→// AUTO ZOOM UI INITIALIZATION (Phase 3)
   446→// ============================================================================
   447→let currentZoomPoints = [];
   448→
   449→function initZoomUI() {
   450→  // Toggle Zoom settings visibility
   451→  if (ui.enableZoom) {
   452→    ui.enableZoom.addEventListener('change', () => {
   453→      if (ui.zoomSettings) {
   454→        if (ui.enableZoom.checked) {
   455→          ui.zoomSettings.classList.remove('collapsed');
   456→          ui.zoomSettings.style.display = 'block';
   457→        } else {
   458→          ui.zoomSettings.classList.add('collapsed');
   459→          ui.zoomSettings.style.display = 'none';
   460→        }
   461→      }
   462→    });
   463→
   464→    // Initialize collapsed state
   465→    if (ui.zoomSettings) {
   466→      ui.zoomSettings.style.display = ui.enableZoom.checked ? 'block' : 'none';
   467→    }
   468→  }
   469→
   470→  // Apply zooms button
   471→  if (ui.applyZoomsBtn) {
   472→    ui.applyZoomsBtn.addEventListener('click', applyZoomsToTimeline);
   473→  }
   474→
   475→  console.log('[SPLICE] Auto Zoom UI initialized');
   476→}
   477→
   478→/**
   479→ * Get current Zoom settings from UI
   480→ * @returns {Object} Zoom settings
   481→ */
   482→function getZoomSettings() {
   483→  return {
   484→    enabled: ui.enableZoom?.checked ?? false,
   485→    frequency: ui.zoomFrequency?.value ?? 'medium',
   486→    preset: ui.zoomPreset?.value ?? 'medium',
   487→    placement: ui.zoomPlacement?.value ?? 'sentence_start'
   488→  };
   489→}
   490→
   491→/**
   492→ * Fetch zoom points from backend
   493→ * @param {Object} transcript - Transcript data
   494→ * @returns {Promise<Array>} Zoom points
   495→ */
   496→async function fetchZoomPoints(transcript) {
   497→  const settings = getZoomSettings();
   498→  if (!settings.enabled) return [];
   499→
   500→  try {

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
