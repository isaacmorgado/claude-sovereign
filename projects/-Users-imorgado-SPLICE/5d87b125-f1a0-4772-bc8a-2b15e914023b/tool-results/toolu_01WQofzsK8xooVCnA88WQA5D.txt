     1â†’/**
     2â†’ * SPLICE CEP Panel - Main Entry Point
     3â†’ * v4.0.0 - CEP Migration
     4â†’ */
     5â†’
     6â†’// ============================================================================
     7â†’// CACHED DOM ELEMENTS
     8â†’// ============================================================================
     9â†’const ui = {};
    10â†’
    11â†’function cacheUIElements() {
    12â†’    ui.status = document.getElementById('status');
    13â†’    ui.goBtn = document.getElementById('goBtn');
    14â†’    ui.optionsToggle = document.getElementById('optionsToggle');
    15â†’    ui.optionsPanel = document.getElementById('optionsPanel');
    16â†’
    17â†’    // Sliders and options
    18â†’    ui.sensitivitySlider = document.getElementById('sensitivitySlider');
    19â†’    ui.sensitivityValue = document.getElementById('sensitivityValue');
    20â†’    ui.sourceOriginal = document.getElementById('sourceOriginal');
    21â†’    ui.sourceIsolated = document.getElementById('sourceIsolated');
    22â†’
    23â†’    // Feature toggles
    24â†’    ui.enableTakesDetection = document.getElementById('enableTakesDetection');
    25â†’    ui.enableJCut = document.getElementById('enableJCut');
    26â†’    ui.jcutSettings = document.getElementById('jcutSettings');
    27â†’    ui.jcutLeadIn = document.getElementById('jcutLeadIn');
    28â†’    ui.jcutLeadInValue = document.getElementById('jcutLeadInValue');
    29â†’    ui.jcutLeadOut = document.getElementById('jcutLeadOut');
    30â†’    ui.jcutLeadOutValue = document.getElementById('jcutLeadOutValue');
    31â†’
    32â†’    // Zoom settings
    33â†’    ui.enableZoom = document.getElementById('enableZoom');
    34â†’    ui.zoomSettings = document.getElementById('zoomSettings');
    35â†’    ui.zoomFrequency = document.getElementById('zoomFrequency');
    36â†’    ui.zoomPreset = document.getElementById('zoomPreset');
    37â†’    ui.zoomPlacement = document.getElementById('zoomPlacement');
    38â†’
    39â†’    // Chapter settings
    40â†’    ui.enableChapters = document.getElementById('enableChapters');
    41â†’    ui.chapterSettings = document.getElementById('chapterSettings');
    42â†’    ui.maxChapters = document.getElementById('maxChapters');
    43â†’    ui.minChapterLength = document.getElementById('minChapterLength');
    44â†’
    45â†’    // Progress
    46â†’    ui.progressContainer = document.getElementById('progressContainer');
    47â†’    ui.progressBar = document.getElementById('progressBar');
    48â†’    ui.progressText = document.getElementById('progressText');
    49â†’    ui.resultsEmpty = document.getElementById('resultsEmpty');
    50â†’
    51â†’    // Preview
    52â†’    ui.combinedPreview = document.getElementById('combinedPreview');
    53â†’    ui.previewList = document.getElementById('previewList');
    54â†’    ui.silenceCount = document.getElementById('silenceCount');
    55â†’    ui.takeCount = document.getElementById('takeCount');
    56â†’    ui.selectedCount = document.getElementById('selectedCount');
    57â†’    ui.selectAllSilences = document.getElementById('selectAllSilences');
    58â†’    ui.applyPreviewBtn = document.getElementById('applyPreviewBtn');
    59â†’    ui.cancelPreviewBtn = document.getElementById('cancelPreviewBtn');
    60â†’    ui.buildSequenceBtn = document.getElementById('buildSequenceBtn');
    61â†’
    62â†’    // Results
    63â†’    ui.zoomResults = document.getElementById('zoomResults');
    64â†’    ui.chapterResults = document.getElementById('chapterResults');
    65â†’    ui.chapterList = document.getElementById('chapterList');
    66â†’    ui.copyYouTubeBtn = document.getElementById('copyYouTubeBtn');
    67â†’    ui.addChapterMarkersBtn = document.getElementById('addChapterMarkersBtn');
    68â†’
    69â†’    // Modals
    70â†’    ui.settingsBtn = document.getElementById('settingsBtn');
    71â†’    ui.settingsModal = document.getElementById('settingsModal');
    72â†’    ui.closeSettingsBtn = document.getElementById('closeSettingsBtn');
    73â†’    ui.loginModal = document.getElementById('loginModal');
    74â†’    ui.closeLoginBtn = document.getElementById('closeLoginBtn');
    75â†’    ui.licenseKeyInput = document.getElementById('licenseKeyInput');
    76â†’    ui.saveLoginBtn = document.getElementById('saveLoginBtn');
    77â†’
    78â†’    // Credit badge
    79â†’    ui.creditBadge = document.getElementById('creditBadge');
    80â†’
    81â†’    // Preset selector
    82â†’    ui.presetSelector = document.getElementById('presetSelector');
    83â†’}
    84â†’
    85â†’// ============================================================================
    86â†’// STATE MANAGEMENT
    87â†’// ============================================================================
    88â†’let previewSilences = [];
    89â†’let previewTakes = [];
    90â†’let currentChapters = [];
    91â†’let currentZooms = [];
    92â†’let selectedSilenceIndices = new Set();
    93â†’let isOperationInProgress = false;
    94â†’let lastDetectionResult = null;
    95â†’
    96â†’// ============================================================================
    97â†’// INITIALIZATION
    98â†’// ============================================================================
    99â†’document.addEventListener('DOMContentLoaded', async () => {
   100â†’    console.log('[SPLICE] Initializing CEP panel...');
   101â†’
   102â†’    // Cache DOM elements
   103â†’    cacheUIElements();
   104â†’
   105â†’    // Load settings
   106â†’    loadSettingsToUI();
   107â†’
   108â†’    // Initialize UI handlers
   109â†’    initOptionsToggle();
   110â†’    initSliders();
   111â†’    initFeatureToggles();
   112â†’    initPresetSelector();
   113â†’    initGoButton();
   114â†’    initPreviewHandlers();
   115â†’    initModals();
   116â†’    initCredits();
   117â†’
   118â†’    // Initialize offline detection
   119â†’    if (typeof initOfflineDetection === 'function') {
   120â†’        initOfflineDetection();
   121â†’    }
   122â†’
   123â†’    // Check JSX connection
   124â†’    await checkJSXConnection();
   125â†’
   126â†’    setStatus('Ready');
   127â†’    console.log('[SPLICE] CEP panel initialized');
   128â†’});
   129â†’
   130â†’// ============================================================================
   131â†’// JSX CONNECTION CHECK
   132â†’// ============================================================================
   133â†’async function checkJSXConnection() {
   134â†’    try {
   135â†’        const result = await jsx.call('getVersion');
   136â†’        console.log('[SPLICE] JSX connection OK, version:', result);
   137â†’        return true;
   138â†’    } catch (e) {
   139â†’        console.warn('[SPLICE] JSX connection failed:', e.message);
   140â†’        setStatus('Premiere Pro connection failed', true);
   141â†’        return false;
   142â†’    }
   143â†’}
   144â†’
   145â†’async function checkSequenceOpen() {
   146â†’    try {
   147â†’        const result = await jsx.call('checkSequenceOpen');
   148â†’        return result === true || result === 'true';
   149â†’    } catch {
   150â†’        return false;
   151â†’    }
   152â†’}
   153â†’
   154â†’// ============================================================================
   155â†’// OPTIONS TOGGLE
   156â†’// ============================================================================
   157â†’function initOptionsToggle() {
   158â†’    if (ui.optionsToggle && ui.optionsPanel) {
   159â†’        ui.optionsToggle.addEventListener('click', () => {
   160â†’            const isExpanded = ui.optionsPanel.classList.toggle('collapsed');
   161â†’            ui.optionsToggle.classList.toggle('expanded', !isExpanded);
   162â†’            saveSettings({ expandedOptions: !isExpanded });
   163â†’        });
   164â†’
   165â†’        // Restore state
   166â†’        const settings = getSettings();
   167â†’        if (!settings.expandedOptions) {
   168â†’            ui.optionsPanel.classList.add('collapsed');
   169â†’        } else {
   170â†’            ui.optionsToggle.classList.add('expanded');
   171â†’        }
   172â†’    }
   173â†’}
   174â†’
   175â†’// ============================================================================
   176â†’// SLIDERS
   177â†’// ============================================================================
   178â†’function initSliders() {
   179â†’    // Sensitivity slider
   180â†’    if (ui.sensitivitySlider && ui.sensitivityValue) {
   181â†’        ui.sensitivitySlider.addEventListener('input', () => {
   182â†’            ui.sensitivityValue.textContent = ui.sensitivitySlider.value;
   183â†’            saveSettings({ sensitivity: parseInt(ui.sensitivitySlider.value) });
   184â†’        });
   185â†’    }
   186â†’
   187â†’    // J-Cut sliders
   188â†’    if (ui.jcutLeadIn && ui.jcutLeadInValue) {
   189â†’        ui.jcutLeadIn.addEventListener('input', () => {
   190â†’            const val = (ui.jcutLeadIn.value / 100).toFixed(2);
   191â†’            ui.jcutLeadInValue.textContent = val + 's';
   192â†’            saveSettings({ jcutLeadIn: parseFloat(val) });
   193â†’        });
   194â†’    }
   195â†’
   196â†’    if (ui.jcutLeadOut && ui.jcutLeadOutValue) {
   197â†’        ui.jcutLeadOut.addEventListener('input', () => {
   198â†’            const val = (ui.jcutLeadOut.value / 100).toFixed(2);
   199â†’            ui.jcutLeadOutValue.textContent = val + 's';
   200â†’            saveSettings({ jcutLeadOut: parseFloat(val) });
   201â†’        });
   202â†’    }
   203â†’}
   204â†’
   205â†’// ============================================================================
   206â†’// FEATURE TOGGLES
   207â†’// ============================================================================
   208â†’function initFeatureToggles() {
   209â†’    // J-Cut toggle
   210â†’    if (ui.enableJCut && ui.jcutSettings) {
   211â†’        ui.enableJCut.addEventListener('change', () => {
   212â†’            ui.jcutSettings.classList.toggle('collapsed', !ui.enableJCut.checked);
   213â†’            saveSettings({ enableJCut: ui.enableJCut.checked });
   214â†’        });
   215â†’    }
   216â†’
   217â†’    // Zoom toggle
   218â†’    if (ui.enableZoom && ui.zoomSettings) {
   219â†’        ui.enableZoom.addEventListener('change', () => {
   220â†’            ui.zoomSettings.classList.toggle('collapsed', !ui.enableZoom.checked);
   221â†’            saveSettings({ enableZoom: ui.enableZoom.checked });
   222â†’        });
   223â†’    }
   224â†’
   225â†’    // Chapters toggle
   226â†’    if (ui.enableChapters && ui.chapterSettings) {
   227â†’        ui.enableChapters.addEventListener('change', () => {
   228â†’            ui.chapterSettings.classList.toggle('collapsed', !ui.enableChapters.checked);
   229â†’            saveSettings({ enableChapters: ui.enableChapters.checked });
   230â†’        });
   231â†’    }
   232â†’
   233â†’    // Takes detection toggle
   234â†’    if (ui.enableTakesDetection) {
   235â†’        ui.enableTakesDetection.addEventListener('change', () => {
   236â†’            saveSettings({ enableTakesDetection: ui.enableTakesDetection.checked });
   237â†’        });
   238â†’    }
   239â†’}
   240â†’
   241â†’// ============================================================================
   242â†’// PRESET SELECTOR
   243â†’// ============================================================================
   244â†’const PRESETS = {
   245â†’    podcast: { name: 'Podcast', sensitivity: 35, minSilence: 0.8, jcut: true, jcutLeadIn: 0.3, jcutLeadOut: 0.2 },
   246â†’    interview: { name: 'Interview', sensitivity: 50, minSilence: 0.5, jcut: true, jcutLeadIn: 0.25, jcutLeadOut: 0.15 },
   247â†’    reaction: { name: 'Reaction', sensitivity: 70, minSilence: 0.3, jcut: false },
   248â†’    tutorial: { name: 'Tutorial', sensitivity: 30, minSilence: 1.0, jcut: true, jcutLeadIn: 0.35, jcutLeadOut: 0.25 },
   249â†’    vlog: { name: 'Vlog', sensitivity: 65, minSilence: 0.35, jcut: false },
   250â†’    custom: { name: 'Custom', sensitivity: 50, minSilence: 0.5, jcut: false }
   251â†’};
   252â†’
   253â†’function initPresetSelector() {
   254â†’    if (!ui.presetSelector) return;
   255â†’
   256â†’    ui.presetSelector.addEventListener('change', () => {
   257â†’        const presetId = ui.presetSelector.value;
   258â†’        applyPreset(presetId);
   259â†’    });
   260â†’
   261â†’    // Load current preset
   262â†’    const settings = getSettings();
   263â†’    if (settings.activePreset) {
   264â†’        ui.presetSelector.value = settings.activePreset;
   265â†’    }
   266â†’}
   267â†’
   268â†’function applyPreset(presetId) {
   269â†’    const preset = PRESETS[presetId];
   270â†’    if (!preset) return;
   271â†’
   272â†’    // Apply to UI
   273â†’    if (ui.sensitivitySlider) {
   274â†’        ui.sensitivitySlider.value = preset.sensitivity;
   275â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = preset.sensitivity;
   276â†’    }
   277â†’
   278â†’    if (ui.enableJCut) {
   279â†’        ui.enableJCut.checked = preset.jcut || false;
   280â†’        if (ui.jcutSettings) {
   281â†’            ui.jcutSettings.classList.toggle('collapsed', !preset.jcut);
   282â†’        }
   283â†’    }
   284â†’
   285â†’    if (preset.jcutLeadIn && ui.jcutLeadIn) {
   286â†’        ui.jcutLeadIn.value = Math.round(preset.jcutLeadIn * 100);
   287â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = preset.jcutLeadIn + 's';
   288â†’    }
   289â†’
   290â†’    if (preset.jcutLeadOut && ui.jcutLeadOut) {
   291â†’        ui.jcutLeadOut.value = Math.round(preset.jcutLeadOut * 100);
   292â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = preset.jcutLeadOut + 's';
   293â†’    }
   294â†’
   295â†’    // Save
   296â†’    saveSettings({
   297â†’        activePreset: presetId,
   298â†’        sensitivity: preset.sensitivity,
   299â†’        enableJCut: preset.jcut || false,
   300â†’        jcutLeadIn: preset.jcutLeadIn || 0.3,
   301â†’        jcutLeadOut: preset.jcutLeadOut || 0.2
   302â†’    });
   303â†’
   304â†’    setStatus(`Applied ${preset.name} preset`);
   305â†’}
   306â†’
   307â†’// ============================================================================
   308â†’// LOAD SETTINGS TO UI
   309â†’// ============================================================================
   310â†’function loadSettingsToUI() {
   311â†’    const settings = getSettings();
   312â†’
   313â†’    if (ui.sensitivitySlider) {
   314â†’        ui.sensitivitySlider.value = settings.sensitivity;
   315â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = settings.sensitivity;
   316â†’    }
   317â†’
   318â†’    if (ui.enableTakesDetection) ui.enableTakesDetection.checked = settings.enableTakesDetection;
   319â†’    if (ui.enableJCut) ui.enableJCut.checked = settings.enableJCut;
   320â†’    if (ui.enableZoom) ui.enableZoom.checked = settings.enableZoom;
   321â†’    if (ui.enableChapters) ui.enableChapters.checked = settings.enableChapters;
   322â†’
   323â†’    if (ui.jcutSettings) ui.jcutSettings.classList.toggle('collapsed', !settings.enableJCut);
   324â†’    if (ui.zoomSettings) ui.zoomSettings.classList.toggle('collapsed', !settings.enableZoom);
   325â†’    if (ui.chapterSettings) ui.chapterSettings.classList.toggle('collapsed', !settings.enableChapters);
   326â†’
   327â†’    if (ui.jcutLeadIn) {
   328â†’        ui.jcutLeadIn.value = Math.round(settings.jcutLeadIn * 100);
   329â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = settings.jcutLeadIn + 's';
   330â†’    }
   331â†’    if (ui.jcutLeadOut) {
   332â†’        ui.jcutLeadOut.value = Math.round(settings.jcutLeadOut * 100);
   333â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = settings.jcutLeadOut + 's';
   334â†’    }
   335â†’
   336â†’    if (ui.presetSelector && settings.activePreset) {
   337â†’        ui.presetSelector.value = settings.activePreset;
   338â†’    }
   339â†’}
   340â†’
   341â†’// ============================================================================
   342â†’// GO BUTTON - MAIN WORKFLOW
   343â†’// ============================================================================
   344â†’function initGoButton() {
   345â†’    if (!ui.goBtn) return;
   346â†’
   347â†’    ui.goBtn.addEventListener('click', async () => {
   348â†’        if (isOperationInProgress) return;
   349â†’        await runDetection();
   350â†’    });
   351â†’}
   352â†’
   353â†’async function runDetection() {
   354â†’    if (isOperationInProgress) return;
   355â†’
   356â†’    // Check sequence
   357â†’    const hasSequence = await checkSequenceOpen();
   358â†’    if (!hasSequence) {
   359â†’        setStatus('Please open a sequence first', true);
   360â†’        return;
   361â†’    }
   362â†’
   363â†’    // Check online
   364â†’    if (!isOnline()) {
   365â†’        setStatus('Offline - Check your connection', true);
   366â†’        return;
   367â†’    }
   368â†’
   369â†’    isOperationInProgress = true;
   370â†’    ui.goBtn.disabled = true;
   371â†’    showProgress('Detecting silences...');
   372â†’
   373â†’    try {
   374â†’        const settings = getSettings();
   375â†’
   376â†’        // Get sequence info
   377â†’        const seqInfo = await jsx.call('getActiveSequence');
   378â†’        console.log('[SPLICE] Sequence info:', seqInfo);
   379â†’
   380â†’        // Export audio via JSX for silence detection
   381â†’        updateProgress(10, 'Exporting audio...');
   382â†’
   383â†’        let audioFilePath = null;
   384â†’        try {
   385â†’            // Get sequence info for audio export
   386â†’            const exportResult = await jsx.call('exportSequenceAudioForAnalysis');
   387â†’            if (exportResult && exportResult.success && exportResult.outputPath) {
   388â†’                audioFilePath = exportResult.outputPath;
   389â†’                console.log('[SPLICE] Audio exported to:', audioFilePath);
   390â†’            } else if (exportResult && exportResult.error) {
   391â†’                throw new Error(exportResult.error);
   392â†’            }
   393â†’        } catch (exportError) {
   394â†’            console.warn('[SPLICE] Audio export failed, trying fallback:', exportError.message);
   395â†’            // Try to get audio from first clip in timeline
   396â†’            try {
   397â†’                const clipInfo = await jsx.call('getFirstClipAudioPath');
   398â†’                if (clipInfo && clipInfo.path) {
   399â†’                    audioFilePath = clipInfo.path;
   400â†’                    console.log('[SPLICE] Using clip audio path:', audioFilePath);
   401â†’                }
   402â†’            } catch (clipError) {
   403â†’                console.warn('[SPLICE] Fallback audio path failed:', clipError.message);
   404â†’            }
   405â†’        }
   406â†’
   407â†’        if (!audioFilePath) {
   408â†’            throw new Error('Could not export or locate audio file. Please ensure sequence has audio tracks.');
   409â†’        }
   410â†’
   411â†’        // Call backend for silence detection with audio file path
   412â†’        updateProgress(30, 'Detecting silences...');
   413â†’        const silenceResponse = await fetchWithTimeout(
   414â†’            `${getBackendUrl()}/silences-rms`,
   415â†’            {
   416â†’                method: 'POST',
   417â†’                headers: getAuthHeaders(),
   418â†’                body: JSON.stringify({
   419â†’                    audioPath: audioFilePath,
   420â†’                    sensitivity: settings.sensitivity,
   421â†’                    minSilenceLength: settings.minSilenceLength || 0.5
   422â†’                })
   423â†’            }
   424â†’        );
   425â†’
   426â†’        if (!silenceResponse.ok) {
   427â†’            throw new Error(await parseErrorResponse(silenceResponse));
   428â†’        }
   429â†’
   430â†’        const silenceData = await silenceResponse.json();
   431â†’        previewSilences = silenceData.silences || [];
   432â†’
   433â†’        // Detect takes if enabled
   434â†’        if (settings.enableTakesDetection) {
   435â†’            updateProgress(60, 'Detecting takes...');
   436â†’            const analyzeResponse = await fetchWithTimeout(
   437â†’                `${getBackendUrl()}/analyze`,
   438â†’                {
   439â†’                    method: 'POST',
   440â†’                    headers: getAuthHeaders(),
   441â†’                    body: JSON.stringify({
   442â†’                        detectTakes: true
   443â†’                    })
   444â†’                }
   445â†’            );
   446â†’
   447â†’            if (analyzeResponse.ok) {
   448â†’                const analyzeData = await analyzeResponse.json();
   449â†’                previewTakes = analyzeData.takes || [];
   450â†’            }
   451â†’        }
   452â†’
   453â†’        // Detect chapters if enabled
   454â†’        if (settings.enableChapters) {
   455â†’            updateProgress(80, 'Detecting chapters...');
   456â†’            try {
   457â†’                const chapterResponse = await fetchWithTimeout(
   458â†’                    `${getBackendUrl()}/chapters`,
   459â†’                    {
   460â†’                        method: 'POST',
   461â†’                        headers: getAuthHeaders(),
   462â†’                        body: JSON.stringify({
   463â†’                            maxChapters: settings.maxChapters || 10,
   464â†’                            minChapterLength: settings.minChapterLength || 60
   465â†’                        })
   466â†’                    }
   467â†’                );
   468â†’
   469â†’                if (chapterResponse.ok) {
   470â†’                    const chapterData = await chapterResponse.json();
   471â†’                    currentChapters = chapterData.chapters || [];
   472â†’                }
   473â†’            } catch (e) {
   474â†’                console.warn('[SPLICE] Chapter detection failed:', e);
   475â†’            }
   476â†’        }
   477â†’
   478â†’        // Detect zoom points if enabled
   479â†’        if (settings.enableZoom) {
   480â†’            updateProgress(90, 'Detecting zoom points...');
   481â†’            try {
   482â†’                const zoomResponse = await fetchWithTimeout(
   483â†’                    `${getBackendUrl()}/zoom`,
   484â†’                    {
   485â†’                        method: 'POST',
   486â†’                        headers: getAuthHeaders(),
   487â†’                        body: JSON.stringify({
   488â†’                            frequency: settings.zoomFrequency || 'medium',
   489â†’                            preset: settings.zoomPreset || 'medium',
   490â†’                            placement: settings.zoomPlacement || 'sentence_start'
   491â†’                        })
   492â†’                    }
   493â†’                );
   494â†’
   495â†’                if (zoomResponse.ok) {
   496â†’                    const zoomData = await zoomResponse.json();
   497â†’                    currentZooms = zoomData.zoomPoints || [];
   498â†’                }
   499â†’            } catch (e) {
   500â†’                console.warn('[SPLICE] Zoom detection failed:', e);
   501â†’            }
   502â†’        }
   503â†’
   504â†’        // Store results
   505â†’        lastDetectionResult = {
   506â†’            silences: previewSilences,
   507â†’            takes: previewTakes,
   508â†’            chapters: currentChapters,
   509â†’            zooms: currentZooms
   510â†’        };
   511â†’
   512â†’        // Show preview
   513â†’        hideProgress();
   514â†’        showCombinedPreview();
   515â†’        setStatus(`Found ${previewSilences.length} silences, ${previewTakes.length} takes`);
   516â†’
   517â†’    } catch (error) {
   518â†’        console.error('[SPLICE] Detection error:', error);
   519â†’        setStatus('Detection failed: ' + error.message, true);
   520â†’        hideProgress();
   521â†’    } finally {
   522â†’        isOperationInProgress = false;
   523â†’        ui.goBtn.disabled = false;
   524â†’    }
   525â†’}
   526â†’
   527â†’// ============================================================================
   528â†’// PROGRESS UI
   529â†’// ============================================================================
   530â†’function showProgress(message) {
   531â†’    if (ui.progressContainer) ui.progressContainer.classList.remove('hidden');
   532â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   533â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
   534â†’    updateProgress(0, message);
   535â†’}
   536â†’
   537â†’function updateProgress(percent, message) {
   538â†’    if (ui.progressBar) ui.progressBar.style.width = percent + '%';
   539â†’    if (ui.progressText) ui.progressText.textContent = message || '';
   540â†’}
   541â†’
   542â†’function hideProgress() {
   543â†’    if (ui.progressContainer) ui.progressContainer.classList.add('hidden');
   544â†’}
   545â†’
   546â†’// ============================================================================
   547â†’// COMBINED PREVIEW
   548â†’// ============================================================================
   549â†’function showCombinedPreview() {
   550â†’    if (!ui.combinedPreview) return;
   551â†’
   552â†’    ui.combinedPreview.classList.remove('hidden');
   553â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   554â†’
   555â†’    // Update counts
   556â†’    if (ui.silenceCount) ui.silenceCount.textContent = previewSilences.length;
   557â†’    if (ui.takeCount) ui.takeCount.textContent = previewTakes.length;
   558â†’
   559â†’    // Select all by default
   560â†’    selectedSilenceIndices.clear();
   561â†’    previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
   562â†’    updateSelectedCount();
   563â†’
   564â†’    // Render preview list
   565â†’    renderPreviewList();
   566â†’
   567â†’    // Show chapter results if available
   568â†’    if (currentChapters.length > 0 && ui.chapterResults) {
   569â†’        ui.chapterResults.classList.remove('hidden');
   570â†’        renderChapterList();
   571â†’    }
   572â†’
   573â†’    // Show zoom results if available
   574â†’    if (currentZooms.length > 0 && ui.zoomResults) {
   575â†’        ui.zoomResults.classList.remove('hidden');
   576â†’    }
   577â†’}
   578â†’
   579â†’function renderPreviewList() {
   580â†’    if (!ui.previewList) return;
   581â†’
   582â†’    const html = [];
   583â†’
   584â†’    // Render silences
   585â†’    previewSilences.forEach((silence, i) => {
   586â†’        const isSelected = selectedSilenceIndices.has(i);
   587â†’        const duration = silence.end - silence.start;
   588â†’        html.push(`
   589â†’            <div class="preview-item ${isSelected ? '' : 'excluded'}" data-index="${i}" data-type="silence">
   590â†’                <input type="checkbox" class="preview-item-check" ${isSelected ? 'checked' : ''}>
   591â†’                <div class="preview-item-info">
   592â†’                    <div class="preview-item-time">${formatTime(silence.start)} - ${formatTime(silence.end)}</div>
   593â†’                    <div class="preview-item-duration">${duration.toFixed(2)}s silence</div>
   594â†’                </div>
   595â†’            </div>
   596â†’        `);
   597â†’    });
   598â†’
   599â†’    // Render takes
   600â†’    previewTakes.forEach((take, i) => {
   601â†’        html.push(`
   602â†’            <div class="preview-item take-item" data-index="${i}" data-type="take">
   603â†’                <div class="preview-item-icon">ðŸŽ¬</div>
   604â†’                <div class="preview-item-info">
   605â†’                    <div class="preview-item-time">${formatTime(take.start)} - ${formatTime(take.end)}</div>
   606â†’                    <div class="preview-item-label">${take.label || 'Take ' + (take.takeNumber || i + 1)}</div>
   607â†’                </div>
   608â†’            </div>
   609â†’        `);
   610â†’    });
   611â†’
   612â†’    ui.previewList.innerHTML = html.join('');
   613â†’
   614â†’    // Add click handlers
   615â†’    ui.previewList.querySelectorAll('.preview-item').forEach(item => {
   616â†’        item.addEventListener('click', (e) => {
   617â†’            const index = parseInt(item.dataset.index);
   618â†’            const type = item.dataset.type;
   619â†’
   620â†’            if (e.target.classList.contains('preview-item-check')) {
   621â†’                // Checkbox clicked
   622â†’                toggleSilenceSelection(index);
   623â†’            } else {
   624â†’                // Item clicked - seek to time
   625â†’                const data = type === 'silence' ? previewSilences[index] : previewTakes[index];
   626â†’                seekToTime(data.start);
   627â†’            }
   628â†’        });
   629â†’    });
   630â†’}
   631â†’
   632â†’function toggleSilenceSelection(index) {
   633â†’    if (selectedSilenceIndices.has(index)) {
   634â†’        selectedSilenceIndices.delete(index);
   635â†’    } else {
   636â†’        selectedSilenceIndices.add(index);
   637â†’    }
   638â†’    updateSelectedCount();
   639â†’    renderPreviewList();
   640â†’}
   641â†’
   642â†’function updateSelectedCount() {
   643â†’    if (ui.selectedCount) {
   644â†’        ui.selectedCount.textContent = selectedSilenceIndices.size;
   645â†’    }
   646â†’    if (ui.selectAllSilences) {
   647â†’        ui.selectAllSilences.checked = selectedSilenceIndices.size === previewSilences.length;
   648â†’    }
   649â†’}
   650â†’
   651â†’async function seekToTime(seconds) {
   652â†’    try {
   653â†’        // Use JSX to set playhead position
   654â†’        await jsx.evalScript(`app.project.activeSequence.setPlayerPosition("${seconds * 254016000000}")`);
   655â†’    } catch (e) {
   656â†’        console.warn('[SPLICE] Seek failed:', e);
   657â†’    }
   658â†’}
   659â†’
   660â†’// ============================================================================
   661â†’// CHAPTER LIST
   662â†’// ============================================================================
   663â†’function renderChapterList() {
   664â†’    if (!ui.chapterList) return;
   665â†’
   666â†’    const html = currentChapters.map((chapter, i) => `
   667â†’        <div class="chapter-item" data-index="${i}">
   668â†’            <div class="chapter-time">${formatTime(chapter.startTime)}</div>
   669â†’            <div class="chapter-title">${chapter.title}</div>
   670â†’        </div>
   671â†’    `).join('');
   672â†’
   673â†’    ui.chapterList.innerHTML = html;
   674â†’
   675â†’    // Add click handlers
   676â†’    ui.chapterList.querySelectorAll('.chapter-item').forEach(item => {
   677â†’        item.addEventListener('click', () => {
   678â†’            const index = parseInt(item.dataset.index);
   679â†’            seekToTime(currentChapters[index].startTime);
   680â†’        });
   681â†’    });
   682â†’}
   683â†’
   684â†’// ============================================================================
   685â†’// PREVIEW HANDLERS
   686â†’// ============================================================================
   687â†’function initPreviewHandlers() {
   688â†’    // Select all checkbox
   689â†’    if (ui.selectAllSilences) {
   690â†’        ui.selectAllSilences.addEventListener('change', () => {
   691â†’            if (ui.selectAllSilences.checked) {
   692â†’                previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
   693â†’            } else {
   694â†’                selectedSilenceIndices.clear();
   695â†’            }
   696â†’            updateSelectedCount();
   697â†’            renderPreviewList();
   698â†’        });
   699â†’    }
   700â†’
   701â†’    // Apply button
   702â†’    if (ui.applyPreviewBtn) {
   703â†’        ui.applyPreviewBtn.addEventListener('click', applyPreviewAndMarkers);
   704â†’    }
   705â†’
   706â†’    // Cancel button
   707â†’    if (ui.cancelPreviewBtn) {
   708â†’        ui.cancelPreviewBtn.addEventListener('click', hidePreview);
   709â†’    }
   710â†’
   711â†’    // Build sequence button
   712â†’    if (ui.buildSequenceBtn) {
   713â†’        ui.buildSequenceBtn.addEventListener('click', buildSequence);
   714â†’    }
   715â†’
   716â†’    // Copy YouTube timestamps
   717â†’    if (ui.copyYouTubeBtn) {
   718â†’        ui.copyYouTubeBtn.addEventListener('click', copyYouTubeTimestamps);
   719â†’    }
   720â†’
   721â†’    // Add chapter markers
   722â†’    if (ui.addChapterMarkersBtn) {
   723â†’        ui.addChapterMarkersBtn.addEventListener('click', addChapterMarkers);
   724â†’    }
   725â†’}
   726â†’
   727â†’async function applyPreviewAndMarkers() {
   728â†’    if (isOperationInProgress) return;
   729â†’
   730â†’    isOperationInProgress = true;
   731â†’    setStatus('Adding markers...');
   732â†’
   733â†’    try {
   734â†’        // Add silence markers
   735â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
   736â†’        for (const silence of selectedSilences) {
   737â†’            await jsx.call('createMarker', silence.start, 'SPLICE: Silence', silence.end - silence.start, null, 1);
   738â†’        }
   739â†’
   740â†’        // Add take markers
   741â†’        for (const take of previewTakes) {
   742â†’            await jsx.call('createMarker', take.start, take.label || `Take ${take.takeNumber}`, take.end - take.start, null, 5);
   743â†’        }
   744â†’
   745â†’        setStatus(`Added ${selectedSilences.length + previewTakes.length} markers`);
   746â†’    } catch (error) {
   747â†’        setStatus('Failed to add markers: ' + error.message, true);
   748â†’    } finally {
   749â†’        isOperationInProgress = false;
   750â†’    }
   751â†’}
   752â†’
   753â†’function hidePreview() {
   754â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
   755â†’    if (ui.chapterResults) ui.chapterResults.classList.add('hidden');
   756â†’    if (ui.zoomResults) ui.zoomResults.classList.add('hidden');
   757â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.remove('hidden');
   758â†’    previewSilences = [];
   759â†’    previewTakes = [];
   760â†’    selectedSilenceIndices.clear();
   761â†’}
   762â†’
   763â†’async function buildSequence() {
   764â†’    if (isOperationInProgress) return;
   765â†’
   766â†’    isOperationInProgress = true;
   767â†’    setStatus('Building sequence...');
   768â†’
   769â†’    try {
   770â†’        const settings = getSettings();
   771â†’
   772â†’        // Create cut list from selected silences
   773â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
   774â†’
   775â†’        // Call backend to generate cut list
   776â†’        const cutListResponse = await fetchWithTimeout(
   777â†’            `${getBackendUrl()}/cut-list`,
   778â†’            {
   779â†’                method: 'POST',
   780â†’                headers: getAuthHeaders(),
   781â†’                body: JSON.stringify({
   782â†’                    silences: selectedSilences,
   783â†’                    takes: previewTakes,
   784â†’                    enableTakes: settings.enableTakesDetection,
   785â†’                    jCutOffset: settings.enableJCut ? settings.jcutLeadIn : 0,
   786â†’                    lCutOffset: settings.enableJCut ? settings.jcutLeadOut : 0
   787â†’                })
   788â†’            }
   789â†’        );
   790â†’
   791â†’        if (!cutListResponse.ok) {
   792â†’            throw new Error(await parseErrorResponse(cutListResponse));
   793â†’        }
   794â†’
   795â†’        const cutList = await cutListResponse.json();
   796â†’
   797â†’        // Build sequence via JSX
   798â†’        const result = await jsx.call('buildSequenceFromCutList', JSON.stringify(cutList));
   799â†’
   800â†’        if (result.success) {
   801â†’            setStatus(`Built sequence: ${result.sequenceName}`);
   802â†’            hidePreview();
   803â†’        } else {
   804â†’            throw new Error(result.error || 'Build failed');
   805â†’        }
   806â†’    } catch (error) {
   807â†’        setStatus('Build failed: ' + error.message, true);
   808â†’    } finally {
   809â†’        isOperationInProgress = false;
   810â†’    }
   811â†’}
   812â†’
   813â†’function copyYouTubeTimestamps() {
   814â†’    if (currentChapters.length === 0) return;
   815â†’
   816â†’    const timestamps = currentChapters.map(ch =>
   817â†’        `${formatTime(ch.startTime)} ${ch.title}`
   818â†’    ).join('\n');
   819â†’
   820â†’    navigator.clipboard.writeText(timestamps).then(() => {
   821â†’        setStatus('Copied YouTube timestamps');
   822â†’    }).catch(() => {
   823â†’        setStatus('Failed to copy', true);
   824â†’    });
   825â†’}
   826â†’
   827â†’async function addChapterMarkers() {
   828â†’    if (isOperationInProgress || currentChapters.length === 0) return;
   829â†’
   830â†’    isOperationInProgress = true;
   831â†’    setStatus('Adding chapter markers...');
   832â†’
   833â†’    try {
   834â†’        for (const chapter of currentChapters) {
   835â†’            await jsx.call('addChapterMarker', chapter.startTime, chapter.title, chapter.description);
   836â†’        }
   837â†’        setStatus(`Added ${currentChapters.length} chapter markers`);
   838â†’    } catch (error) {
   839â†’        setStatus('Failed to add markers: ' + error.message, true);
   840â†’    } finally {
   841â†’        isOperationInProgress = false;
   842â†’    }
   843â†’}
   844â†’
   845â†’// ============================================================================
   846â†’// MODALS
   847â†’// ============================================================================
   848â†’function initModals() {
   849â†’    // Settings modal
   850â†’    if (ui.settingsBtn && ui.settingsModal) {
   851â†’        ui.settingsBtn.addEventListener('click', () => {
   852â†’            ui.settingsModal.classList.remove('hidden');
   853â†’        });
   854â†’    }
   855â†’
   856â†’    if (ui.closeSettingsBtn && ui.settingsModal) {
   857â†’        ui.closeSettingsBtn.addEventListener('click', () => {
   858â†’            ui.settingsModal.classList.add('hidden');
   859â†’        });
   860â†’    }
   861â†’
   862â†’    // Login modal
   863â†’    if (ui.creditBadge) {
   864â†’        ui.creditBadge.addEventListener('click', () => {
   865â†’            const settings = getSettings();
   866â†’            if (!settings.customerId) {
   867â†’                showLoginModal();
   868â†’            }
   869â†’        });
   870â†’    }
   871â†’
   872â†’    if (ui.closeLoginBtn && ui.loginModal) {
   873â†’        ui.closeLoginBtn.addEventListener('click', () => {
   874â†’            ui.loginModal.classList.add('hidden');
   875â†’        });
   876â†’    }
   877â†’
   878â†’    if (ui.saveLoginBtn) {
   879â†’        ui.saveLoginBtn.addEventListener('click', activateLicense);
   880â†’    }
   881â†’
   882â†’    // Close modals on backdrop click
   883â†’    document.querySelectorAll('.modal').forEach(modal => {
   884â†’        modal.addEventListener('click', (e) => {
   885â†’            if (e.target === modal) {
   886â†’                modal.classList.add('hidden');
   887â†’            }
   888â†’        });
   889â†’    });
   890â†’}
   891â†’
   892â†’function showLoginModal() {
   893â†’    if (ui.loginModal) ui.loginModal.classList.remove('hidden');
   894â†’}
   895â†’
   896â†’async function activateLicense() {
   897â†’    if (!ui.licenseKeyInput) return;
   898â†’
   899â†’    const licenseKey = ui.licenseKeyInput.value.trim();
   900â†’    if (!licenseKey) {
   901â†’        setStatus('Please enter a license key', true);
   902â†’        return;
   903â†’    }
   904â†’
   905â†’    try {
   906â†’        const response = await fetchWithTimeout(
   907â†’            `${getBackendUrl()}/license/activate`,
   908â†’            {
   909â†’                method: 'POST',
   910â†’                headers: { 'Content-Type': 'application/json' },
   911â†’                body: JSON.stringify({ licenseKey })
   912â†’            }
   913â†’        );
   914â†’
   915â†’        if (!response.ok) {
   916â†’            throw new Error(await parseErrorResponse(response));
   917â†’        }
   918â†’
   919â†’        const data = await response.json();
   920â†’        saveSettings({
   921â†’            customerId: data.customerId,
   922â†’            licenseKey: licenseKey
   923â†’        });
   924â†’
   925â†’        if (ui.loginModal) ui.loginModal.classList.add('hidden');
   926â†’        setStatus('License activated');
   927â†’        updateCredits();
   928â†’    } catch (error) {
   929â†’        setStatus('Activation failed: ' + error.message, true);
   930â†’    }
   931â†’}
   932â†’
   933â†’// ============================================================================
   934â†’// CREDITS
   935â†’// ============================================================================
   936â†’function initCredits() {
   937â†’    updateCredits();
   938â†’}
   939â†’
   940â†’async function updateCredits() {
   941â†’    if (!ui.creditBadge) return;
   942â†’
   943â†’    const settings = getSettings();
   944â†’    if (!settings.customerId) {
   945â†’        ui.creditBadge.className = 'credit-badge login';
   946â†’        ui.creditBadge.textContent = 'Login';
   947â†’        ui.creditBadge.style.display = 'flex';
   948â†’        return;
   949â†’    }
   950â†’
   951â†’    try {
   952â†’        const response = await fetchWithTimeout(
   953â†’            `${getBackendUrl()}/credits`,
   954â†’            {
   955â†’                method: 'GET',
   956â†’                headers: getAuthHeaders()
   957â†’            }
   958â†’        );
   959â†’
   960â†’        if (response.ok) {
   961â†’            const data = await response.json();
   962â†’            const hours = (data.remainingMinutes / 60).toFixed(1);
   963â†’            ui.creditBadge.textContent = `${hours}h`;
   964â†’            ui.creditBadge.className = data.remainingMinutes < 60 ? 'credit-badge low' : 'credit-badge ok';
   965â†’            ui.creditBadge.style.display = 'flex';
   966â†’        } else {
   967â†’            ui.creditBadge.className = 'credit-badge error';
   968â†’            ui.creditBadge.textContent = 'Error';
   969â†’            ui.creditBadge.style.display = 'flex';
   970â†’        }
   971â†’    } catch {
   972â†’        ui.creditBadge.className = 'credit-badge error';
   973â†’        ui.creditBadge.textContent = 'Offline';
   974â†’        ui.creditBadge.style.display = 'flex';
   975â†’    }
   976â†’}
   977â†’
   978â†’// Export for debugging
   979â†’window.spliceDebug = {
   980â†’    getState: () => ({
   981â†’        silences: previewSilences,
   982â†’        takes: previewTakes,
   983â†’        chapters: currentChapters,
   984â†’        zooms: currentZooms,
   985â†’        selected: Array.from(selectedSilenceIndices)
   986â†’    }),
   987â†’    jsx,
   988â†’    runDetection
   989â†’};
   990â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
