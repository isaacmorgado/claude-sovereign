     1→/**
     2→ * SPLICE CEP Panel Configuration
     3→ * Backend URLs, paths, and utility functions
     4→ */
     5→
     6→// ============================================================================
     7→// BACKEND CONFIGURATION
     8→// ============================================================================
     9→const SPLICE_CONFIG = {
    10→    VERSION: '6.0.3',
    11→    BACKEND_PROD: 'https://splice-api-production.up.railway.app',
    12→    BACKEND_DEV: 'https://127.0.0.1:3847',
    13→    FETCH_TIMEOUT: 120000, // 2 minutes
    14→    RETRY_ATTEMPTS: 3,
    15→    RETRY_DELAY: 1000
    16→};
    17→
    18→/**
    19→ * Get the backend URL based on environment
    20→ */
    21→function getBackendUrl() {
    22→    // Check for development mode
    23→    const isDev = window.location.protocol === 'file:' ||
    24→                  window.location.hostname === 'localhost' ||
    25→                  window.location.hostname === '127.0.0.1';
    26→
    27→    // Allow override via localStorage
    28→    const customUrl = localStorage.getItem('spliceBackendUrl');
    29→    if (customUrl) return customUrl;
    30→
    31→    return isDev ? SPLICE_CONFIG.BACKEND_DEV : SPLICE_CONFIG.BACKEND_PROD;
    32→}
    33→
    34→// ============================================================================
    35→// JSX BRIDGE - Communicate with Premiere Pro
    36→// ============================================================================
    37→const jsx = {
    38→    cs: null,
    39→    _initPromise: null,
    40→    _initialized: false,
    41→
    42→    /**
    43→     * Initialize the CSInterface
    44→     * Returns a promise that resolves when ready
    45→     */
    46→    init: function() {
    47→        if (this._initPromise) return this._initPromise;
    48→
    49→        this._initPromise = new Promise((resolve) => {
    50→            if (typeof CSInterface !== 'undefined') {
    51→                this.cs = new CSInterface();
    52→                this._initialized = true;
    53→                console.log('[JSX] CSInterface initialized successfully');
    54→            } else {
    55→                console.warn('[JSX] CSInterface not available');
    56→            }
    57→            resolve(this._initialized);
    58→        });
    59→
    60→        return this._initPromise;
    61→    },
    62→
    63→    /**
    64→     * Ensure JSX is initialized before making calls
    65→     */
    66→    ensureInitialized: async function() {
    67→        if (!this._initialized) {
    68→            await this.init();
    69→        }
    70→        if (!this.cs) {
    71→            throw new Error('CSInterface not initialized. Make sure you are running in CEP environment.');
    72→        }
    73→    },
    74→
    75→    /**
    76→     * Execute ExtendScript in Premiere Pro
    77→     * @param {string} script - ExtendScript to execute
    78→     * @returns {Promise<any>} - Parsed result
    79→     */
    80→    evalScript: async function(script) {
    81→        await this.ensureInitialized();
    82→
    83→        return new Promise((resolve, reject) => {
    84→            this.cs.evalScript(script, (result) => {
    85→                if (result === 'undefined' || result === undefined) {
    86→                    resolve(null);
    87→                    return;
    88→                }
    89→
    90→                // Check for EvalScript error
    91→                if (typeof result === 'string' && result.indexOf('EvalScript error') !== -1) {
    92→                    reject(new Error(result));
    93→                    return;
    94→                }
    95→
    96→                // Try to parse JSON
    97→                try {
    98→                    const parsed = JSON.parse(result);
    99→                    if (parsed.error) {
   100→                        reject(new Error(parsed.error));
   101→                    } else {
   102→                        resolve(parsed);
   103→                    }
   104→                } catch (e) {
   105→                    // Return as-is if not JSON
   106→                    resolve(result);
   107→                }
   108→            });
   109→        });
   110→    },
   111→
   112→    /**
   113→     * Call a JSX function with arguments
   114→     * @param {string} funcName - Function name
   115→     * @param {...any} args - Arguments to pass
   116→     * @returns {Promise<any>}
   117→     */
   118→    call: async function(funcName, ...args) {
   119→        await this.ensureInitialized();
   120→
   121→        const escapedArgs = args.map(arg => {
   122→            if (arg === null || arg === undefined) return 'null';
   123→            if (typeof arg === 'string') return `'${arg.replace(/'/g, "\\'").replace(/\n/g, '\\n')}'`;
   124→            if (typeof arg === 'object') return `'${JSON.stringify(arg).replace(/'/g, "\\'")}'`;
   125→            return String(arg);
   126→        });
   127→
   128→        const script = `${funcName}(${escapedArgs.join(', ')})`;
   129→        return this.evalScript(script);
   130→    }
   131→};
   132→
   133→// ============================================================================
   134→// FETCH UTILITIES
   135→// ============================================================================
   136→
   137→/**
   138→ * Fetch with timeout support
   139→ * @param {string} url - URL to fetch
   140→ * @param {object} options - Fetch options
   141→ * @param {number} timeout - Timeout in ms
   142→ */
   143→async function fetchWithTimeout(url, options = {}, timeout = SPLICE_CONFIG.FETCH_TIMEOUT) {
   144→    const controller = new AbortController();
   145→    const timeoutId = setTimeout(() => controller.abort(), timeout);
   146→
   147→    try {
   148→        const response = await fetch(url, {
   149→            ...options,
   150→            signal: controller.signal
   151→        });
   152→        clearTimeout(timeoutId);
   153→        return response;
   154→    } catch (error) {
   155→        clearTimeout(timeoutId);
   156→        if (error.name === 'AbortError') {
   157→            throw new Error(`Request timeout after ${timeout}ms`);
   158→        }
   159→        throw error;
   160→    }
   161→}
   162→
   163→/**
   164→ * Parse error response from backend
   165→ * @param {Response} response - Fetch response
   166→ */
   167→async function parseErrorResponse(response) {
   168→    try {
   169→        const data = await response.json();
   170→        return data.error || data.message || `HTTP ${response.status}`;
   171→    } catch {
   172→        return `HTTP ${response.status}: ${response.statusText}`;
   173→    }
   174→}
   175→
   176→/**
   177→ * Get auth headers for API requests
   178→ */
   179→function getAuthHeaders() {
   180→    const headers = { 'Content-Type': 'application/json' };
   181→    const settings = getSettings();
   182→
   183→    if (settings.customerId) {
   184→        headers['x-stripe-customer-id'] = settings.customerId;
   185→    }
   186→    if (settings.licenseKey) {
   187→        headers['x-license-key'] = settings.licenseKey;
   188→    }
   189→
   190→    return headers;
   191→}
   192→
   193→// ============================================================================
   194→// SETTINGS MANAGEMENT
   195→// ============================================================================
   196→
   197→const DEFAULT_SETTINGS = {
   198→    sensitivity: 50,
   199→    minSilenceLength: 0.5,
   200→    sourceIsolated: false,
   201→    enableTakesDetection: true,
   202→    enableJCut: false,
   203→    jcutLeadIn: 0.3,
   204→    jcutLeadOut: 0.2,
   205→    enableZoom: false,
   206→    zoomFrequency: 'medium',
   207→    zoomPreset: 'medium',
   208→    zoomPlacement: 'sentence_start',
   209→    enableChapters: false,
   210→    maxChapters: 10,
   211→    minChapterLength: 60,
   212→    enableProfanity: false,
   213→    profanityLanguage: 'en',
   214→    bleepType: 'standard',
   215→    customerId: null,
   216→    licenseKey: null,
   217→    expandedOptions: false,
   218→    activePreset: 'podcast',
   219→    rememberOptions: false
   220→};
   221→
   222→/**
   223→ * Get settings from localStorage
   224→ */
   225→function getSettings() {
   226→    try {
   227→        const stored = localStorage.getItem('spliceSettings');
   228→        if (stored) {
   229→            return { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
   230→        }
   231→    } catch (e) {
   232→        console.warn('[Config] Error loading settings:', e);
   233→    }
   234→    return { ...DEFAULT_SETTINGS };
   235→}
   236→
   237→/**
   238→ * Save settings to localStorage
   239→ */
   240→function saveSettings(settings) {
   241→    try {
   242→        const merged = { ...getSettings(), ...settings };
   243→        localStorage.setItem('spliceSettings', JSON.stringify(merged));
   244→        return true;
   245→    } catch (e) {
   246→        console.warn('[Config] Error saving settings:', e);
   247→        return false;
   248→    }
   249→}
   250→
   251→/**
   252→ * Clear specific setting
   253→ */
   254→function clearSetting(key) {
   255→    const settings = getSettings();
   256→    delete settings[key];
   257→    localStorage.setItem('spliceSettings', JSON.stringify(settings));
   258→}
   259→
   260→// ============================================================================
   261→// OFFLINE DETECTION
   262→// ============================================================================
   263→
   264→let isOnlineState = true;
   265→let offlineCheckInterval = null;
   266→
   267→/**
   268→ * Check if online
   269→ */
   270→function isOnline() {
   271→    return isOnlineState && navigator.onLine;
   272→}
   273→
   274→/**
   275→ * Initialize offline detection
   276→ */
   277→function initOfflineDetection() {
   278→    // Browser events
   279→    window.addEventListener('online', () => {
   280→        isOnlineState = true;
   281→        updateOfflineUI(true);
   282→    });
   283→
   284→    window.addEventListener('offline', () => {
   285→        isOnlineState = false;
   286→        updateOfflineUI(false);
   287→    });
   288→
   289→    // Periodic check
   290→    offlineCheckInterval = setInterval(async () => {
   291→        try {
   292→            const response = await fetchWithTimeout(
   293→                `${getBackendUrl()}/health`,
   294→                { method: 'GET' },
   295→                5000
   296→            );
   297→            isOnlineState = response.ok;
   298→        } catch {
   299→            isOnlineState = false;
   300→        }
   301→        updateOfflineUI(isOnlineState);
   302→    }, 30000);
   303→}
   304→
   305→/**
   306→ * Update UI based on online state
   307→ */
   308→function updateOfflineUI(online) {
   309→    const goBtn = document.getElementById('goBtn');
   310→    const status = document.getElementById('status');
   311→
   312→    if (goBtn) {
   313→        goBtn.disabled = !online;
   314→    }
   315→
   316→    if (status) {
   317→        if (!online) {
   318→            status.textContent = 'Offline - Check your connection';
   319→            status.style.color = '#dc3545';
   320→        } else {
   321→            // Reset status when back online
   322→            status.textContent = 'Ready';
   323→            status.style.color = '#888';
   324→        }
   325→    }
   326→}
   327→
   328→// ============================================================================
   329→// UTILITY FUNCTIONS
   330→// ============================================================================
   331→
   332→/**
   333→ * SECURITY: Escape HTML to prevent XSS attacks
   334→ * Use this when inserting untrusted content into innerHTML
   335→ * @param {string} str - String to escape
   336→ * @returns {string} Escaped string safe for innerHTML
   337→ */
   338→function escapeHtml(str) {
   339→    if (str === null || str === undefined) return '';
   340→    if (typeof str !== 'string') str = String(str);
   341→
   342→    const escapeMap = {
   343→        '&': '&amp;',
   344→        '<': '&lt;',
   345→        '>': '&gt;',
   346→        '"': '&quot;',
   347→        "'": '&#x27;',
   348→        '/': '&#x2F;',
   349→        '`': '&#x60;'
   350→    };
   351→
   352→    return str.replace(/[&<>"'\/`]/g, char => escapeMap[char]);
   353→}
   354→
   355→/**
   356→ * SECURITY: Create safe HTML from template with escaped values
   357→ * @param {TemplateStringsArray} strings - Template strings
   358→ * @param {...any} values - Values to escape
   359→ * @returns {string} HTML with escaped values
   360→ */
   361→function safeHtml(strings, ...values) {
   362→    return strings.reduce((result, str, i) => {
   363→        const value = values[i - 1];
   364→        const escaped = escapeHtml(value);
   365→        return result + escaped + str;
   366→    });
   367→}
   368→
   369→/**
   370→ * Format time in MM:SS or HH:MM:SS
   371→ */
   372→function formatTime(seconds) {
   373→    if (isNaN(seconds) || seconds < 0) return '0:00';
   374→
   375→    const hours = Math.floor(seconds / 3600);
   376→    const minutes = Math.floor((seconds % 3600) / 60);
   377→    const secs = Math.floor(seconds % 60);
   378→
   379→    if (hours > 0) {
   380→        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
   381→    }
   382→    return `${minutes}:${secs.toString().padStart(2, '0')}`;
   383→}
   384→
   385→/**
   386→ * Set status message
   387→ */
   388→function setStatus(message, isError = false) {
   389→    const status = document.getElementById('status');
   390→    if (status) {
   391→        status.textContent = message;
   392→        status.style.color = isError ? '#dc3545' : '#888';
   393→    }
   394→}
   395→
   396→/**
   397→ * Debounce function calls
   398→ */
   399→function debounce(func, wait) {
   400→    let timeout;
   401→    return function executedFunction(...args) {
   402→        const later = () => {
   403→            clearTimeout(timeout);
   404→            func(...args);
   405→        };
   406→        clearTimeout(timeout);
   407→        timeout = setTimeout(later, wait);
   408→    };
   409→}
   410→
   411→// ============================================================================
   412→// PRESET PROFILES
   413→// ============================================================================
   414→
   415→/**
   416→ * Detection presets for different content types.
   417→ * Each preset defines optimal settings for a specific use case.
   418→ */
   419→const PRESETS = {
   420→    // Custom - user-defined settings (default)
   421→    custom: {
   422→        name: 'Custom',
   423→        description: 'Your custom settings',
   424→        icon: 'settings',
   425→        settings: null // Uses current user settings
   426→    },
   427→
   428→    // Podcast - longer pauses are natural, be conservative
   429→    podcast: {
   430→        name: 'Podcast',
   431→        description: 'Longer natural pauses, J-Cuts enabled',
   432→        icon: 'mic',
   433→        settings: {
   434→            sensitivity: 35,
   435→            threshold: -35,
   436→            minSilenceLength: 0.8,
   437→            paddingStart: 0.15,
   438→            paddingEnd: 0.15,
   439→            enableTakesDetection: true,
   440→            enableJCut: true,
   441→            jCutLeadIn: 0.3,
   442→            jCutLeadOut: 0.2
   443→        }
   444→    },
   445→
   446→    // Interview - balanced, respects speaker pauses
   447→    interview: {
   448→        name: 'Interview',
   449→        description: 'Balanced cuts, J-Cuts for smooth transitions',
   450→        icon: 'people',
   451→        settings: {
   452→            sensitivity: 50,
   453→            threshold: -32,
   454→            minSilenceLength: 0.5,
   455→            paddingStart: 0.12,
   456→            paddingEnd: 0.08,
   457→            enableTakesDetection: true,
   458→            enableJCut: true,
   459→            jCutLeadIn: 0.25,
   460→            jCutLeadOut: 0.15
   461→        }
   462→    },
   463→
   464→    // Reaction video - fast pacing, quick cuts
   465→    reaction: {
   466→        name: 'Reaction',
   467→        description: 'Fast-paced, tight cuts for energy',
   468→        icon: 'bolt',
   469→        settings: {
   470→            sensitivity: 70,
   471→            threshold: -28,
   472→            minSilenceLength: 0.3,
   473→            paddingStart: 0.05,
   474→            paddingEnd: 0.03,
   475→            enableTakesDetection: false,
   476→            enableJCut: false,
   477→            jCutLeadIn: 0,
   478→            jCutLeadOut: 0
   479→        }
   480→    },
   481→
   482→    // Tutorial/Educational - preserve thinking pauses
   483→    tutorial: {
   484→        name: 'Tutorial',
   485→        description: 'Preserves teaching pace, J-Cuts enabled',
   486→        icon: 'school',
   487→        settings: {
   488→            sensitivity: 30,
   489→            threshold: -38,
   490→            minSilenceLength: 1.0,
   491→            paddingStart: 0.2,
   492→            paddingEnd: 0.15,
   493→            enableTakesDetection: true,
   494→            enableJCut: true,
   495→            jCutLeadIn: 0.35,
   496→            jCutLeadOut: 0.25
   497→        }
   498→    },
   499→
   500→    // Vlog/YouTube - punchy edits, engagement-focused
   501→    vlog: {
   502→        name: 'Vlog',
   503→        description: 'Punchy edits for YouTube engagement',
   504→        icon: 'videocam',
   505→        settings: {
   506→            sensitivity: 65,
   507→            threshold: -30,
   508→            minSilenceLength: 0.35,
   509→            paddingStart: 0.08,
   510→            paddingEnd: 0.05,
   511→            enableTakesDetection: true,
   512→            enableJCut: false,
   513→            jCutLeadIn: 0,
   514→            jCutLeadOut: 0
   515→        }
   516→    }
   517→};
   518→
   519→/**
   520→ * List of built-in preset IDs
   521→ */
   522→const BUILT_IN_PRESET_IDS = ['custom', 'podcast', 'interview', 'reaction', 'tutorial', 'vlog'];
   523→
   524→/**
   525→ * Get all available presets
   526→ * @returns {Object} All preset definitions
   527→ */
   528→function getPresets() {
   529→    return { ...PRESETS };
   530→}
   531→
   532→/**
   533→ * Get a specific preset by name
   534→ * @param {string} presetName - Name of the preset
   535→ * @returns {Object|null} Preset definition or null if not found
   536→ */
   537→function getPreset(presetName) {
   538→    return PRESETS[presetName] || null;
   539→}
   540→
   541→/**
   542→ * Check if a preset is a built-in preset
   543→ * @param {string} id - Preset ID to check
   544→ * @returns {boolean} True if built-in, false if custom
   545→ */
   546→function isBuiltInPreset(id) {
   547→    return BUILT_IN_PRESET_IDS.includes(id);
   548→}
   549→
   550→/**
   551→ * Apply a preset to current settings
   552→ * @param {string} presetName - Name of the preset to apply
   553→ * @returns {Object} The applied settings
   554→ */
   555→function applyPreset(presetName) {
   556→    const preset = PRESETS[presetName];
   557→
   558→    if (!preset) {
   559→        console.warn(`[SPLICE] Unknown preset: ${presetName}`);
   560→        return getSettings();
   561→    }
   562→
   563→    // Custom preset uses current settings
   564→    if (presetName === 'custom' || !preset.settings) {
   565→        saveSettings({ activePreset: 'custom' });
   566→        return getSettings();
   567→    }
   568→
   569→    // Apply preset settings
   570→    const newSettings = {
   571→        ...preset.settings,
   572→        activePreset: presetName
   573→    };
   574→
   575→    saveSettings(newSettings);
   576→    console.log(`[SPLICE] Applied preset: ${preset.name}`);
   577→
   578→    return getSettings();
   579→}
   580→
   581→/**
   582→ * Get the currently active preset
   583→ * @returns {string} Active preset name
   584→ */
   585→function getActivePreset() {
   586→    const settings = getSettings();
   587→    return settings.activePreset || 'custom';
   588→}
   589→
   590→/**
   591→ * Initialize preset selector
   592→ */
   593→function initPresetSelector() {
   594→    const presetSelector = document.getElementById('presetSelector');
   595→    const sensitivitySlider = document.getElementById('sensitivitySlider');
   596→
   597→    if (!presetSelector) return;
   598→
   599→    // Set initial value from settings
   600→    const settings = getSettings();
   601→    presetSelector.value = settings.activePreset || 'podcast';
   602→
   603→    // Handle preset change
   604→    presetSelector.addEventListener('change', () => {
   605→        const presetId = presetSelector.value;
   606→        const appliedSettings = applyPreset(presetId);
   607→
   608→        // Update sensitivity slider to match preset
   609→        if (sensitivitySlider && appliedSettings.sensitivity !== undefined) {
   610→            sensitivitySlider.value = appliedSettings.sensitivity;
   611→            // Update display value
   612→            const sensitivityValue = document.getElementById('sensitivityValue');
   613→            if (sensitivityValue) {
   614→                sensitivityValue.textContent = appliedSettings.sensitivity;
   615→            }
   616→        }
   617→
   618→        // Update takes detection checkbox
   619→        const enableTakesDetection = document.getElementById('enableTakesDetection');
   620→        if (enableTakesDetection && appliedSettings.enableTakesDetection !== undefined) {
   621→            enableTakesDetection.checked = appliedSettings.enableTakesDetection;
   622→        }
   623→
   624→        // Update J-Cut checkbox
   625→        const enableJCut = document.getElementById('enableJCut');
   626→        if (enableJCut && appliedSettings.enableJCut !== undefined) {
   627→            enableJCut.checked = appliedSettings.enableJCut;
   628→            // Toggle J-Cut settings visibility
   629→            const jcutSettings = document.getElementById('jcutSettings');
   630→            if (jcutSettings) {
   631→                jcutSettings.classList.toggle('collapsed', !appliedSettings.enableJCut);
   632→            }
   633→        }
   634→
   635→        const preset = getPreset(presetId);
   636→        if (preset) {
   637→            setStatus(`Preset: ${preset.name} - ${preset.description}`);
   638→        }
   639→    });
   640→
   641→    // Switch to custom when user manually changes sensitivity
   642→    if (sensitivitySlider) {
   643→        sensitivitySlider.addEventListener('change', () => {
   644→            if (presetSelector.value !== 'custom') {
   645→                presetSelector.value = 'custom';
   646→                saveSettings({ activePreset: 'custom' });
   647→            }
   648→        });
   649→    }
   650→}
   651→
   652→// ============================================================================
   653→// LOGIN MODAL
   654→// ============================================================================
   655→
   656→/**
   657→ * Validate license key format: SPLICE-XXXX-XXXX-XXXX
   658→ */
   659→function isValidLicenseKeyFormat(key) {
   660→    if (!key || typeof key !== 'string') return false;
   661→    const normalized = key.toUpperCase().trim();
   662→    const pattern = /^SPLICE-[A-Z2-9]{4}-[A-Z2-9]{4}-[A-Z2-9]{4}$/;
   663→    return pattern.test(normalized);
   664→}
   665→
   666→/**
   667→ * Initialize login modal handlers
   668→ */
   669→function initLoginModal() {
   670→    const loginModal = document.getElementById('loginModal');
   671→    const closeLoginBtn = document.getElementById('closeLoginBtn');
   672→    const saveLoginBtn = document.getElementById('saveLoginBtn');
   673→    const licenseKeyInput = document.getElementById('licenseKeyInput');
   674→    const creditBadge = document.getElementById('creditBadge');
   675→
   676→    // Handle credit badge click - retry on error, or show login modal
   677→    if (creditBadge) {
   678→        creditBadge.addEventListener('click', async () => {
   679→            if (creditBadge.classList.contains('error')) {
   680→                creditBadge.textContent = '...';
   681→                if (typeof refreshCredits === 'function') {
   682→                    await refreshCredits();
   683→                }
   684→                return;
   685→            }
   686→            showLoginModal();
   687→        });
   688→    }
   689→
   690→    // Close login modal
   691→    if (closeLoginBtn && loginModal) {
   692→        closeLoginBtn.addEventListener('click', () => {
   693→            loginModal.classList.add('hidden');
   694→        });
   695→    }
   696→
   697→    // Close on backdrop click
   698→    if (loginModal) {
   699→        loginModal.addEventListener('click', (e) => {
   700→            if (e.target === loginModal) {
   701→                loginModal.classList.add('hidden');
   702→            }
   703→        });
   704→    }
   705→
   706→    // Activate license key
   707→    if (saveLoginBtn) {
   708→        saveLoginBtn.addEventListener('click', async () => {
   709→            const licenseKey = licenseKeyInput?.value?.trim()?.toUpperCase();
   710→
   711→            if (!licenseKey) {
   712→                showLoginError('Please enter your license key');
   713→                return;
   714→            }
   715→
   716→            if (!isValidLicenseKeyFormat(licenseKey)) {
   717→                showLoginError('Invalid format. Expected: SPLICE-XXXX-XXXX-XXXX');
   718→                return;
   719→            }
   720→
   721→            saveLoginBtn.disabled = true;
   722→            saveLoginBtn.textContent = 'Activating...';
   723→
   724→            try {
   725→                const response = await fetchWithTimeout(`${getBackendUrl()}/license/activate`, {
   726→                    method: 'POST',
   727→                    headers: { 'Content-Type': 'application/json' },
   728→                    body: JSON.stringify({ key: licenseKey })
   729→                }, SPLICE_CONFIG.FETCH_TIMEOUT);
   730→
   731→                const result = await response.json();
   732→
   733→                if (!result.success) {
   734→                    showLoginError(result.error || 'Activation failed');
   735→                    return;
   736→                }
   737→
   738→                saveSettings({ customerId: result.customerId });
   739→                loginModal?.classList.add('hidden');
   740→
   741→                if (typeof refreshCredits === 'function') {
   742→                    await refreshCredits();
   743→                }
   744→
   745→                setStatus(`License activated! ${result.tierName} tier`);
   746→            } catch (err) {
   747→                console.error('[SPLICE] License activation error:', err);
   748→                showLoginError('Connection error. Check server is running.');
   749→            } finally {
   750→                saveLoginBtn.disabled = false;
   751→                saveLoginBtn.textContent = 'Activate';
   752→            }
   753→        });
   754→    }
   755→
   756→    // Email lookup
   757→    const lookupLicenseBtn = document.getElementById('lookupLicenseBtn');
   758→    const lookupEmailInput = document.getElementById('lookupEmailInput');
   759→
   760→    if (lookupLicenseBtn) {
   761→        lookupLicenseBtn.addEventListener('click', async () => {
   762→            const email = lookupEmailInput?.value?.trim()?.toLowerCase();
   763→
   764→            if (!email) {
   765→                showLoginError('Please enter your email address');
   766→                return;
   767→            }
   768→
   769→            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
   770→            if (!emailRegex.test(email)) {
   771→                showLoginError('Please enter a valid email address');
   772→                return;
   773→            }
   774→
   775→            lookupLicenseBtn.disabled = true;
   776→            lookupLicenseBtn.textContent = 'Looking up...';
   777→
   778→            try {
   779→                const response = await fetchWithTimeout(`${getBackendUrl()}/license/lookup`, {
   780→                    method: 'POST',
   781→                    headers: { 'Content-Type': 'application/json' },
   782→                    body: JSON.stringify({ email })
   783→                }, 30000);
   784→
   785→                const result = await response.json();
   786→
   787→                // Note: For security, the backend does NOT return the license key directly.
   788→                // It sends the key via email to prevent enumeration attacks.
   789→                if (result.success) {
   790→                    setStatus(result.message || 'If a license exists, it will be sent to your email.');
   791→                } else {
   792→                    showLoginError(result.error || 'Lookup failed. Please try again.');
   793→                }
   794→            } catch (err) {
   795→                console.error('[SPLICE] License lookup error:', err);
   796→                showLoginError('Failed to look up license. Please try again.');
   797→            } finally {
   798→                lookupLicenseBtn.disabled = false;
   799→                lookupLicenseBtn.textContent = 'Lookup';
   800→            }
   801→        });
   802→    }
   803→}
   804→
   805→/**
   806→ * Show login modal
   807→ */
   808→function showLoginModal() {
   809→    const loginModal = document.getElementById('loginModal');
   810→    const loginError = document.getElementById('loginError');
   811→    if (loginError) loginError.style.display = 'none';
   812→    if (loginModal) loginModal.classList.remove('hidden');
   813→}
   814→
   815→/**
   816→ * Show login error message
   817→ */
   818→function showLoginError(message) {
   819→    const loginError = document.getElementById('loginError');
   820→    if (loginError) {
   821→        loginError.textContent = message;
   822→        loginError.style.display = 'block';
   823→    }
   824→}
   825→
   826→/**
   827→ * Check if user is logged in
   828→ */
   829→function isLoggedIn() {
   830→    const settings = getSettings();
   831→    return !!settings.customerId;
   832→}
   833→
   834→/**
   835→ * Logout - clear customer ID
   836→ */
   837→function logout() {
   838→    saveSettings({ customerId: null });
   839→    if (typeof clearCreditsCache === 'function') {
   840→        clearCreditsCache();
   841→    }
   842→    if (typeof updateCreditDisplay === 'function') {
   843→        updateCreditDisplay(null);
   844→    }
   845→    setStatus('Logged out');
   846→}
   847→
   848→// Initialize JSX bridge when loaded
   849→document.addEventListener('DOMContentLoaded', () => {
   850→    jsx.init();
   851→});
   852→
   853→// Export for modules
   854→window.SPLICE_CONFIG = SPLICE_CONFIG;
   855→window.getBackendUrl = getBackendUrl;
   856→window.fetchWithTimeout = fetchWithTimeout;
   857→window.parseErrorResponse = parseErrorResponse;
   858→window.getAuthHeaders = getAuthHeaders;
   859→window.getSettings = getSettings;
   860→window.saveSettings = saveSettings;
   861→window.clearSetting = clearSetting;
   862→window.isOnline = isOnline;
   863→window.initOfflineDetection = initOfflineDetection;
   864→window.formatTime = formatTime;
   865→window.setStatus = setStatus;
   866→window.debounce = debounce;
   867→window.jsx = jsx;
   868→window.PRESETS = PRESETS;
   869→window.getPresets = getPresets;
   870→window.getPreset = getPreset;
   871→window.applyPreset = applyPreset;
   872→window.getActivePreset = getActivePreset;
   873→window.isBuiltInPreset = isBuiltInPreset;
   874→window.initPresetSelector = initPresetSelector;
   875→window.initLoginModal = initLoginModal;
   876→window.showLoginModal = showLoginModal;
   877→window.isLoggedIn = isLoggedIn;
   878→window.logout = logout;
   879→window.escapeHtml = escapeHtml;
   880→window.safeHtml = safeHtml;
   881→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
