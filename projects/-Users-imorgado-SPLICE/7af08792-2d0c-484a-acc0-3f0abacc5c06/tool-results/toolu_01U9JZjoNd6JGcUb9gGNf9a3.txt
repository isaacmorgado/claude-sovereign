   450→          console.error('[SPLICE] Missing customer ID in payment_failed event');
   451→          return res.status(400).json({ error: 'Missing customer ID' });
   452→        }
   453→
   454→        console.warn(`[SPLICE] Payment failed for customer ${customerId} (attempt ${attemptCount})`);
   455→
   456→        // Stripe will retry automatically per retry settings
   457→        // On final failure, Stripe will cancel subscription which triggers customer.subscription.deleted
   458→        // For now, just log and potentially notify user
   459→        if (attemptCount >= 3) {
   460→          console.error(`[SPLICE] Final payment attempt failed for customer ${customerId}`);
   461→          // TODO: Send warning email to customer about impending cancellation
   462→        }
   463→        break;
   464→      }
   465→
   466→      case 'customer.deleted': {
   467→        const customer = event.data.object;
   468→        const customerId = customer.id;
   469→
   470→        // Validate customerId
   471→        if (!customerId) {
   472→          console.error('[SPLICE] Missing customer ID in customer.deleted event');
   473→          return res.status(400).json({ error: 'Missing customer ID' });
   474→        }
   475→
   476→        // Clean up user data - downgrade to cancelled
   477→        await usageTracking.updateTier(customerId, 'cancelled');
   478→        console.log(`[SPLICE] Customer deleted: ${customerId}`);
   479→        break;
   480→      }
   481→
   482→      default:
   483→        console.log(`[SPLICE] Unhandled event type: ${event.type}`);
   484→    }
   485→
   486→    // Record event as processed (idempotency)
   487→    await usageTracking.recordWebhookEvent(event.id, event.type);
   488→
   489→    res.json({ received: true });
   490→  } catch (err) {
   491→    console.error('[SPLICE] Webhook handler error:', err);
   492→    res.status(500).json({ error: err.message });
   493→  }
   494→});
   495→
   496→// Parse JSON body for all other routes
   497→// SECURITY: Limit JSON body size to prevent DoS attacks
   498→app.use(express.json({ limit: '10mb' }));
   499→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
