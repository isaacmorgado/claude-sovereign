     1→/**
     2→ * SPLICE CEP Social Reframe Module
     3→ *
     4→ * Auto-crops video to vertical/square formats for social media.
     5→ * Supports TikTok, Instagram Reels, YouTube Shorts with face tracking.
     6→ */
     7→
     8→// ============================================================================
     9→// STATE
    10→// ============================================================================
    11→
    12→const socialReframeState = {
    13→  platforms: [],
    14→  aspectRatios: [],
    15→  selectedPlatform: 'tiktok',
    16→  selectedAspectRatio: 'portrait',
    17→  analysis: null,
    18→  exportQueue: [],
    19→  isAnalyzing: false,
    20→  isExporting: false,
    21→  currentVideoPath: null,
    22→  safeZones: null,
    23→  showSafeZones: false
    24→};
    25→
    26→// ============================================================================
    27→// DOM ELEMENT CACHE
    28→// ============================================================================
    29→
    30→const reframeElements = {
    31→  panel: null,
    32→  platformSelector: null,
    33→  aspectSelector: null,
    34→  analysisResults: null,
    35→  previewCanvas: null,
    36→  exportResults: null,
    37→  status: null,
    38→  analyzeBtn: null,
    39→  exportBtn: null,
    40→  exportAllBtn: null,
    41→  toggleSafeZonesBtn: null,
    42→  smoothingSlider: null,
    43→  smoothingDisplay: null
    44→};
    45→
    46→/**
    47→ * Cache DOM elements for social reframe
    48→ */
    49→function cacheReframeElements() {
    50→  reframeElements.panel = document.getElementById('social-reframe-panel');
    51→  reframeElements.platformSelector = document.getElementById('reframe-platform-selector');
    52→  reframeElements.aspectSelector = document.getElementById('reframe-aspect-selector');
    53→  reframeElements.analysisResults = document.getElementById('reframe-analysis-results');
    54→  reframeElements.previewCanvas = document.getElementById('reframe-preview-canvas');
    55→  reframeElements.exportResults = document.getElementById('reframe-export-results');
    56→  reframeElements.status = document.getElementById('reframe-status');
    57→  reframeElements.analyzeBtn = document.getElementById('analyze-reframe-btn');
    58→  reframeElements.exportBtn = document.getElementById('export-reframe-btn');
    59→  reframeElements.exportAllBtn = document.getElementById('export-all-formats-btn');
    60→  reframeElements.toggleSafeZonesBtn = document.getElementById('toggle-safe-zones-btn');
    61→  reframeElements.smoothingSlider = document.getElementById('motion-smoothing-slider');
    62→  reframeElements.smoothingDisplay = document.getElementById('smoothing-value-display');
    63→}
    64→
    65→// ============================================================================
    66→// INITIALIZATION
    67→// ============================================================================
    68→
    69→/**
    70→ * Initialize social reframe module
    71→ */
    72→async function initSocialReframe() {
    73→  console.log('[SPLICE] Initializing social reframe module');
    74→
    75→  // Cache DOM elements
    76→  cacheReframeElements();
    77→
    78→  // Load platforms and aspect ratios
    79→  await loadPlatformPresets();
    80→
    81→  // Setup event listeners
    82→  setupReframeEventListeners();
    83→
    84→  // Render platform buttons
    85→  renderPlatformSelector();
    86→
    87→  console.log('[SPLICE] Social reframe module initialized');
    88→}
    89→
    90→/**
    91→ * Load platform presets from backend
    92→ */
    93→async function loadPlatformPresets() {
    94→  try {
    95→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';
    96→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
    97→
    98→    const response = await fetchFn(`${backendUrl}/reframe/platforms`, {
    99→      method: 'GET',
   100→      headers: { 'Content-Type': 'application/json' }
   101→    });
   102→
   103→    if (response.ok) {
   104→      const data = await response.json();
   105→      socialReframeState.platforms = data.platforms || [];
   106→      socialReframeState.aspectRatios = data.aspectRatios || [];
   107→      console.log(`[SPLICE] Loaded ${socialReframeState.platforms.length} platforms`);
   108→    }
   109→  } catch (err) {
   110→    console.error('[SPLICE] Failed to load platform presets:', err);
   111→    // Use fallback presets
   112→    socialReframeState.platforms = [
   113→      { id: 'tiktok', name: 'TikTok', aspectRatio: 'portrait', maxDuration: 180 },
   114→      { id: 'reels', name: 'Instagram Reels', aspectRatio: 'portrait', maxDuration: 90 },
   115→      { id: 'shorts', name: 'YouTube Shorts', aspectRatio: 'portrait', maxDuration: 60 },
   116→      { id: 'instagram_feed', name: 'Instagram Feed', aspectRatio: 'square', maxDuration: 60 }
   117→    ];
   118→    socialReframeState.aspectRatios = [
   119→      { id: 'portrait', name: 'Portrait (9:16)', ratio: 0.5625 },
   120→      { id: 'square', name: 'Square (1:1)', ratio: 1 },
   121→      { id: 'portrait_4_5', name: 'Portrait (4:5)', ratio: 0.8 }
   122→    ];
   123→  }
   124→}
   125→
   126→/**
   127→ * Setup event listeners
   128→ */
   129→function setupReframeEventListeners() {
   130→  document.addEventListener('click', (e) => {
   131→    // Platform selection
   132→    if (e.target.closest('.reframe-platform-btn')) {
   133→      const btn = e.target.closest('.reframe-platform-btn');
   134→      const platformId = btn.dataset.platformId;
   135→      selectPlatform(platformId);
   136→    }
   137→
   138→    // Aspect ratio selection
   139→    if (e.target.closest('.reframe-aspect-btn')) {
   140→      const btn = e.target.closest('.reframe-aspect-btn');
   141→      const aspectId = btn.dataset.aspectId;
   142→      selectAspectRatio(aspectId);
   143→    }
   144→
   145→    // Analyze button
   146→    if (e.target.id === 'analyze-reframe-btn') {
   147→      analyzeForReframe();
   148→    }
   149→
   150→    // Export buttons
   151→    if (e.target.id === 'export-reframe-btn') {
   152→      exportReframe();
   153→    }
   154→    if (e.target.id === 'export-all-formats-btn') {
   155→      exportAllFormats();
   156→    }
   157→
   158→    // Preview toggle
   159→    if (e.target.id === 'toggle-safe-zones-btn') {
   160→      toggleSafeZones();
   161→    }
   162→
   163→    // Toggle panel collapse
   164→    if (e.target.closest('.reframe-header')) {
   165→      const panel = document.getElementById('social-reframe-panel');
   166→      if (panel) {
   167→        const isCollapsed = panel.classList.toggle('collapsed');
   168→        const icon = e.target.closest('.section-toggle')?.querySelector('.toggle-icon');
   169→        if (icon) {
   170→          icon.textContent = isCollapsed ? '+' : '-';
   171→        }
   172→      }
   173→    }
   174→  });
   175→
   176→  // Motion smoothing slider
   177→  document.addEventListener('input', (e) => {
   178→    if (e.target.id === 'motion-smoothing-slider') {
   179→      updateSmoothingValue(e.target.value);
   180→    }
   181→  });
   182→}
   183→
   184→// ============================================================================
   185→// PLATFORM & ASPECT RATIO SELECTION
   186→// ============================================================================
   187→
   188→/**
   189→ * SECURITY: Escape HTML to prevent XSS
   190→ */
   191→function escapeHtmlReframe(str) {
   192→  if (!str) return '';
   193→  const div = document.createElement('div');
   194→  div.textContent = str;
   195→  return div.innerHTML;
   196→}
   197→
   198→/**
   199→ * Render platform selector buttons
   200→ */
   201→function renderPlatformSelector() {
   202→  const container = reframeElements.platformSelector || document.getElementById('reframe-platform-selector');
   203→  if (!container) return;
   204→
   205→  // SECURITY: Escape platform data to prevent XSS
   206→  const html = socialReframeState.platforms.map(platform => {
   207→    const safeId = escapeHtmlReframe(platform.id);
   208→    const safeName = escapeHtmlReframe(platform.name);
   209→    return `
   210→    <button class="reframe-platform-btn ${socialReframeState.selectedPlatform === platform.id ? 'selected' : ''}"
   211→            data-platform-id="${safeId}"
   212→            aria-label="Select ${safeName}">
   213→      <span class="platform-icon platform-icon-${safeId}"></span>
   214→      <span class="platform-name">${safeName}</span>
   215→    </button>
   216→  `;
   217→  }).join('');
   218→
   219→  container.innerHTML = html;
   220→
   221→  // Also render aspect ratio buttons
   222→  renderAspectRatioSelector();
   223→}
   224→
   225→/**
   226→ * Render aspect ratio selector
   227→ */
   228→function renderAspectRatioSelector() {
   229→  const container = reframeElements.aspectSelector || document.getElementById('reframe-aspect-selector');
   230→  if (!container) return;
   231→
   232→  // SECURITY: Escape aspect ratio data to prevent XSS
   233→  const html = socialReframeState.aspectRatios.map(aspect => {
   234→    const safeId = escapeHtmlReframe(aspect.id);
   235→    const safeName = escapeHtmlReframe(aspect.name);
   236→    return `
   237→    <button class="reframe-aspect-btn ${socialReframeState.selectedAspectRatio === aspect.id ? 'selected' : ''}"
   238→            data-aspect-id="${safeId}"
   239→            aria-label="Select ${safeName}">
   240→      <span class="aspect-preview aspect-preview-${safeId}"></span>
   241→      <span class="aspect-name">${safeName}</span>
   242→    </button>
   243→  `;
   244→  }).join('');
   245→
   246→  container.innerHTML = html;
   247→}
   248→
   249→/**
   250→ * Select platform
   251→ */
   252→function selectPlatform(platformId) {
   253→  const platform = socialReframeState.platforms.find(p => p.id === platformId);
   254→  if (!platform) return;
   255→
   256→  socialReframeState.selectedPlatform = platformId;
   257→  socialReframeState.selectedAspectRatio = platform.aspectRatio;
   258→
   259→  // Update UI
   260→  document.querySelectorAll('.reframe-platform-btn').forEach(btn => {
   261→    btn.classList.toggle('selected', btn.dataset.platformId === platformId);
   262→  });
   263→
   264→  renderAspectRatioSelector();
   265→  loadSafeZones(platformId);
   266→
   267→  console.log(`[SPLICE] Selected platform: ${platform.name}`);
   268→}
   269→
   270→/**
   271→ * Select aspect ratio
   272→ */
   273→function selectAspectRatio(aspectId) {
   274→  socialReframeState.selectedAspectRatio = aspectId;
   275→
   276→  document.querySelectorAll('.reframe-aspect-btn').forEach(btn => {
   277→    btn.classList.toggle('selected', btn.dataset.aspectId === aspectId);
   278→  });
   279→
   280→  // Update preview if available
   281→  if (socialReframeState.analysis) {
   282→    updateCropPreview();
   283→  }
   284→
   285→  console.log(`[SPLICE] Selected aspect ratio: ${aspectId}`);
   286→}
   287→
   288→/**
   289→ * Load safe zones for platform
   290→ */
   291→async function loadSafeZones(platformId) {
   292→  try {
   293→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';
   294→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   295→
   296→    const response = await fetchFn(`${backendUrl}/reframe/safe-zones/${platformId}`, {
   297→      method: 'GET',
   298→      headers: { 'Content-Type': 'application/json' }
   299→    });
   300→
   301→    if (response.ok) {
   302→      const data = await response.json();
   303→      socialReframeState.safeZones = data;
   304→      renderSafeZoneOverlay();
   305→    }
   306→  } catch (err) {
   307→    console.error('[SPLICE] Failed to load safe zones:', err);
   308→  }
   309→}
   310→
   311→// ============================================================================
   312→// ANALYSIS
   313→// ============================================================================
   314→
   315→/**
   316→ * Analyze current video for reframe
   317→ */
   318→async function analyzeForReframe() {
   319→  // Check tier access - Social Reframe requires Pro or Team
   320→  if (typeof hasFeatureAccess === 'function' && !hasFeatureAccess('social_reframe')) {
   321→    const requiredTier = typeof getRequiredTier === 'function' ? getRequiredTier('social_reframe') : 'Pro';
   322→    showReframeStatus(`Social Reframe requires ${requiredTier} tier or higher`, 'error');
   323→    if (typeof showUpgradeModal === 'function') {
   324→      showUpgradeModal('Social Reframe', requiredTier);
   325→    }
   326→    return;
   327→  }
   328→
   329→  const videoPath = getCurrentVideoPath();
   330→  if (!videoPath) {
   331→    showReframeStatus('No video selected', 'error');
   332→    return;
   333→  }
   334→
   335→  socialReframeState.isAnalyzing = true;
   336→  updateAnalyzeButton(true);
   337→  showReframeStatus('Analyzing video for face tracking...', 'info');
   338→
   339→  try {
   340→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';
   341→    const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   342→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   343→
   344→    const slider = reframeElements.smoothingSlider || document.getElementById('motion-smoothing-slider');
   345→    const smoothing = slider?.value || 0.3;
   346→
   347→    const response = await fetchFn(`${backendUrl}/reframe/analyze`, {
   348→      method: 'POST',
   349→      headers,
   350→      body: JSON.stringify({
   351→        videoPath,
   352→        options: {
   353→          sampleRate: 0.5,
   354→          smoothing: parseFloat(smoothing)
   355→        }
   356→      })
   357→    });
   358→
   359→    if (!response.ok) {
   360→      const err = await response.json();
   361→      throw new Error(err.error || 'Analysis failed');
   362→    }
   363→
   364→    const data = await response.json();
   365→    socialReframeState.analysis = data;
   366→    socialReframeState.currentVideoPath = videoPath;
   367→
   368→    // Update UI
   369→    renderAnalysisResults(data);
   370→    updateCropPreview();
   371→    showReframeStatus(`Found ${data.faceTracking.tracksFound} face(s)`, 'success');
   372→
   373→  } catch (err) {
   374→    console.error('[SPLICE] Reframe analysis error:', err);
   375→    showReframeStatus(err.message, 'error');
   376→  } finally {
   377→    socialReframeState.isAnalyzing = false;
   378→    updateAnalyzeButton(false);
   379→  }
   380→}
   381→
   382→/**
   383→ * Get current video path from main module or JSX
   384→ */
   385→function getCurrentVideoPath() {
   386→  // Try to get from main module state
   387→  if (window.spliceState?.currentVideoPath) {
   388→    return window.spliceState.currentVideoPath;
   389→  }
   390→
   391→  // Try from active sequence
   392→  if (window.spliceState?.activeSequence?.projectItem?.treePath) {
   393→    return window.spliceState.activeSequence.projectItem.treePath;
   394→  }
   395→
   396→  return socialReframeState.currentVideoPath;
   397→}
   398→
   399→/**
   400→ * Set video path for reframe
   401→ */
   402→function setVideoPath(videoPath) {
   403→  socialReframeState.currentVideoPath = videoPath;
   404→}
   405→
   406→/**
   407→ * Render analysis results
   408→ */
   409→function renderAnalysisResults(analysis) {
   410→  const container = reframeElements.analysisResults || document.getElementById('reframe-analysis-results');
   411→  if (!container) return;
   412→
   413→  // SECURITY: Escape analysis data to prevent XSS
   414→  const html = `
   415→    <div class="analysis-summary">
   416→      <div class="analysis-stat">
   417→        <span class="stat-label">Faces Found</span>
   418→        <span class="stat-value">${escapeHtmlReframe(String(analysis.faceTracking.tracksFound))}</span>
   419→      </div>
   420→      <div class="analysis-stat">
   421→        <span class="stat-label">Video Duration</span>
   422→        <span class="stat-value">${escapeHtmlReframe(formatDuration(analysis.videoInfo.duration))}</span>
   423→      </div>
   424→      <div class="analysis-stat">
   425→        <span class="stat-label">Resolution</span>
   426→        <span class="stat-value">${escapeHtmlReframe(String(analysis.videoInfo.width))}x${escapeHtmlReframe(String(analysis.videoInfo.height))}</span>
   427→      </div>
   428→    </div>
   429→    <div class="analysis-formats">
   430→      ${Object.entries(analysis.suggestions).map(([key, suggestion]) => `
   431→        <div class="format-suggestion" data-format="${escapeHtmlReframe(key)}">
   432→          <span class="format-name">${escapeHtmlReframe(getAspectRatioName(key))}</span>
   433→          <span class="format-method">${escapeHtmlReframe(suggestion.method)}</span>
   434→          <span class="format-keyframes">${escapeHtmlReframe(String(suggestion.totalKeyframes || 0))} keyframes</span>
   435→        </div>
   436→      `).join('')}
   437→    </div>
   438→  `;
   439→
   440→  container.innerHTML = html;
   441→}
   442→
   443→/**
   444→ * Get aspect ratio name
   445→ */
   446→function getAspectRatioName(id) {
   447→  const aspect = socialReframeState.aspectRatios.find(a => a.id === id);
   448→  return aspect?.name || id;
   449→}
   450→
   451→// ============================================================================
   452→// PREVIEW
   453→// ============================================================================
   454→
   455→/**
   456→ * Update crop preview canvas
   457→ */
   458→function updateCropPreview() {
   459→  const canvas = reframeElements.previewCanvas || document.getElementById('reframe-preview-canvas');
   460→  if (!canvas || !socialReframeState.analysis) return;
   461→
   462→  const ctx = canvas.getContext('2d');
   463→  const { videoInfo, suggestions } = socialReframeState.analysis;
   464→  const aspectId = socialReframeState.selectedAspectRatio;
   465→  const suggestion = suggestions[aspectId];
   466→
   467→  if (!suggestion) return;
   468→
   469→  // Clear canvas
   470→  ctx.clearRect(0, 0, canvas.width, canvas.height);
   471→
   472→  // Draw video frame representation
   473→  const scale = Math.min(canvas.width / videoInfo.width, canvas.height / videoInfo.height);
   474→  const videoW = videoInfo.width * scale;
   475→  const videoH = videoInfo.height * scale;
   476→  const videoX = (canvas.width - videoW) / 2;
   477→  const videoY = (canvas.height - videoH) / 2;
   478→
   479→  // Draw video background
   480→  ctx.fillStyle = '#333';
   481→  ctx.fillRect(videoX, videoY, videoW, videoH);
   482→
   483→  // Draw crop region
   484→  const crop = suggestion.static ? suggestion.crop : suggestion.keyframes[0]?.crop;
   485→  if (crop) {
   486→    ctx.strokeStyle = '#00ff00';
   487→    ctx.lineWidth = 2;
   488→    ctx.strokeRect(
   489→      videoX + crop.x * videoW,
   490→      videoY + crop.y * videoH,
   491→      crop.width * videoW,
   492→      crop.height * videoH
   493→    );
   494→
   495→    // Draw face indicator
   496→    if (socialReframeState.analysis.faceTracking.tracks[0]) {
   497→      const face = socialReframeState.analysis.faceTracking.tracks[0].positions[0];
   498→      if (face) {
   499→        ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
   500→        ctx.fillRect(
   501→          videoX + face.x * videoW,
   502→          videoY + face.y * videoH,
   503→          face.width * videoW,
   504→          face.height * videoH
   505→        );
   506→      }
   507→    }
   508→  }
   509→
   510→  // Draw safe zones if enabled
   511→  if (socialReframeState.showSafeZones && socialReframeState.safeZones) {
   512→    renderSafeZoneOnCanvas(ctx, videoX, videoY, videoW, videoH);
   513→  }
   514→}
   515→
   516→/**
   517→ * Render safe zone overlay on canvas
   518→ */
   519→function renderSafeZoneOnCanvas(ctx, x, y, width, height) {
   520→  const sz = socialReframeState.safeZones.safeZone;
   521→  if (!sz) return;
   522→
   523→  ctx.fillStyle = 'rgba(255, 0, 0, 0.15)';
   524→
   525→  // Top safe zone
   526→  ctx.fillRect(x, y, width, height * sz.top);
   527→
   528→  // Bottom safe zone
   529→  ctx.fillRect(x, y + height * (1 - sz.bottom), width, height * sz.bottom);
   530→
   531→  // Left safe zone
   532→  ctx.fillRect(x, y, width * sz.left, height);
   533→
   534→  // Right safe zone
   535→  ctx.fillRect(x + width * (1 - sz.right), y, width * sz.right, height);
   536→}
   537→
   538→/**
   539→ * Render safe zone overlay
   540→ */
   541→function renderSafeZoneOverlay() {
   542→  updateCropPreview();
   543→}
   544→
   545→/**
   546→ * Toggle safe zones visibility
   547→ */
   548→function toggleSafeZones() {
   549→  socialReframeState.showSafeZones = !socialReframeState.showSafeZones;
   550→  updateCropPreview();
   551→
   552→  const btn = reframeElements.toggleSafeZonesBtn || document.getElementById('toggle-safe-zones-btn');
   553→  if (btn) {
   554→    btn.classList.toggle('active', socialReframeState.showSafeZones);
   555→  }
   556→}
   557→
   558→// ============================================================================
   559→// EXPORT
   560→// ============================================================================
   561→
   562→/**
   563→ * Export for selected format
   564→ */
   565→async function exportReframe() {
   566→  if (!socialReframeState.analysis) {
   567→    showReframeStatus('Analyze video first', 'error');
   568→    return;
   569→  }
   570→
   571→  socialReframeState.isExporting = true;
   572→  updateExportButton(true);
   573→  showReframeStatus('Generating export data...', 'info');
   574→
   575→  try {
   576→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';
   577→    const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   578→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   579→
   580→    const slider = reframeElements.smoothingSlider || document.getElementById('motion-smoothing-slider');
   581→    const smoothing = slider?.value || 0.3;
   582→
   583→    const response = await fetchFn(`${backendUrl}/reframe/export`, {
   584→      method: 'POST',
   585→      headers,
   586→      body: JSON.stringify({
   587→        videoPath: socialReframeState.currentVideoPath,
   588→        formats: [socialReframeState.selectedAspectRatio],
   589→        settings: {
   590→          quality: 'high',
   591→          motionSmoothing: parseFloat(smoothing)
   592→        }
   593→      })
   594→    });
   595→
   596→    if (!response.ok) {
   597→      const err = await response.json();
   598→      throw new Error(err.error || 'Export failed');
   599→    }
   600→
   601→    const data = await response.json();
   602→    renderExportResults(data);
   603→    showReframeStatus('Export data generated', 'success');
   604→
   605→  } catch (err) {
   606→    console.error('[SPLICE] Reframe export error:', err);
   607→    showReframeStatus(err.message, 'error');
   608→  } finally {
   609→    socialReframeState.isExporting = false;
   610→    updateExportButton(false);
   611→  }
   612→}
   613→
   614→/**
   615→ * Export all formats at once
   616→ */
   617→async function exportAllFormats() {
   618→  if (!socialReframeState.analysis) {
   619→    showReframeStatus('Analyze video first', 'error');
   620→    return;
   621→  }
   622→
   623→  const allFormats = socialReframeState.aspectRatios.map(a => a.id);
   624→
   625→  socialReframeState.isExporting = true;
   626→  updateExportButton(true);
   627→  showReframeStatus('Generating all formats...', 'info');
   628→
   629→  try {
   630→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';
   631→    const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   632→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   633→
   634→    const response = await fetchFn(`${backendUrl}/reframe/export`, {
   635→      method: 'POST',
   636→      headers,
   637→      body: JSON.stringify({
   638→        videoPath: socialReframeState.currentVideoPath,
   639→        formats: allFormats,
   640→        settings: { quality: 'high' }
   641→      })
   642→    });
   643→
   644→    if (!response.ok) {
   645→      const err = await response.json();
   646→      throw new Error(err.error || 'Export failed');
   647→    }
   648→
   649→    const data = await response.json();
   650→    renderExportResults(data);
   651→    showReframeStatus(`Generated ${data.totalFormats} formats`, 'success');
   652→
   653→  } catch (err) {
   654→    console.error('[SPLICE] Reframe batch export error:', err);
   655→    showReframeStatus(err.message, 'error');
   656→  } finally {
   657→    socialReframeState.isExporting = false;
   658→    updateExportButton(false);
   659→  }
   660→}
   661→
   662→/**
   663→ * Render export results
   664→ */
   665→function renderExportResults(data) {
   666→  const container = reframeElements.exportResults || document.getElementById('reframe-export-results');
   667→  if (!container) return;
   668→
   669→  // SECURITY: Escape export data to prevent XSS
   670→  const html = `
   671→    <div class="export-summary">
   672→      <span class="export-count">${escapeHtmlReframe(String(data.totalFormats))} format(s) ready</span>
   673→    </div>
   674→    <div class="export-list">
   675→      ${data.exports.map(exp => `
   676→        <div class="export-item">
   677→          <span class="export-format">${escapeHtmlReframe(exp.name)}</span>
   678→          <span class="export-dims">${escapeHtmlReframe(String(exp.dimensions.width))}x${escapeHtmlReframe(String(exp.dimensions.height))}</span>
   679→          <button class="copy-ffmpeg-btn btn btn-small" data-filter="${encodeURIComponent(exp.ffmpegFilter)}">
   680→            Copy FFmpeg
   681→          </button>
   682→        </div>
   683→      `).join('')}
   684→    </div>
   685→  `;
   686→
   687→  container.innerHTML = html;
   688→
   689→  // Add copy handlers
   690→  container.querySelectorAll('.copy-ffmpeg-btn').forEach(btn => {
   691→    btn.addEventListener('click', () => {
   692→      const filter = decodeURIComponent(btn.dataset.filter);
   693→      navigator.clipboard.writeText(filter).then(() => {
   694→        btn.textContent = 'Copied!';
   695→        setTimeout(() => btn.textContent = 'Copy FFmpeg', 2000);
   696→      });
   697→    });
   698→  });
   699→}
   700→
   701→// ============================================================================
   702→// UI HELPERS
   703→// ============================================================================
   704→
   705→/**
   706→ * Show status message
   707→ */
   708→function showReframeStatus(message, type = 'info') {
   709→  const statusEl = reframeElements.status || document.getElementById('reframe-status');
   710→  if (!statusEl) return;
   711→
   712→  statusEl.textContent = message;
   713→  statusEl.className = `reframe-status reframe-status-${type}`;
   714→
   715→  if (type !== 'error') {
   716→    setTimeout(() => {
   717→      statusEl.textContent = '';
   718→      statusEl.className = 'reframe-status';
   719→    }, 5000);
   720→  }
   721→}
   722→
   723→/**
   724→ * Update analyze button state
   725→ */
   726→function updateAnalyzeButton(isAnalyzing) {
   727→  const btn = reframeElements.analyzeBtn || document.getElementById('analyze-reframe-btn');
   728→  if (!btn) return;
   729→
   730→  btn.disabled = isAnalyzing;
   731→  btn.textContent = isAnalyzing ? 'Analyzing...' : 'Analyze Video';
   732→}
   733→
   734→/**
   735→ * Update export button state
   736→ */
   737→function updateExportButton(isExporting) {
   738→  const btn = reframeElements.exportBtn || document.getElementById('export-reframe-btn');
   739→  if (!btn) return;
   740→
   741→  btn.disabled = isExporting;
   742→  btn.textContent = isExporting ? 'Exporting...' : 'Export';
   743→}
   744→
   745→/**
   746→ * Update smoothing value display
   747→ */
   748→function updateSmoothingValue(value) {
   749→  const display = reframeElements.smoothingDisplay || document.getElementById('smoothing-value-display');
   750→  if (display) {
   751→    display.textContent = parseFloat(value).toFixed(2);
   752→  }
   753→}
   754→
   755→/**
   756→ * Format duration for display
   757→ */
   758→function formatDuration(seconds) {
   759→  const mins = Math.floor(seconds / 60);
   760→  const secs = Math.floor(seconds % 60);
   761→  return `${mins}:${secs.toString().padStart(2, '0')}`;
   762→}
   763→
   764→// ============================================================================
   765→// EXPORTS
   766→// ============================================================================
   767→
   768→// Export for global access
   769→window.spliceSocialReframe = {
   770→  init: initSocialReframe,
   771→  analyze: analyzeForReframe,
   772→  setVideoPath: setVideoPath,
   773→  selectPlatform: selectPlatform,
   774→  selectAspectRatio: selectAspectRatio,
   775→  export: exportReframe,
   776→  exportAll: exportAllFormats,
   777→  toggleSafeZones: toggleSafeZones,
   778→  getState: () => ({ ...socialReframeState })
   779→};
   780→
   781→// Also expose individual functions for direct access
   782→window.initSocialReframe = initSocialReframe;
   783→

</system-reminder>
