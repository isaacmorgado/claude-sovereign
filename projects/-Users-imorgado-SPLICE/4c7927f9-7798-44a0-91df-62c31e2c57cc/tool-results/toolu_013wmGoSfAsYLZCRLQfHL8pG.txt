     1→/**
     2→ * Shared Redis Client Service
     3→ * Uses Upstash Redis for distributed caching and storage
     4→ * Provides both REST-based (@upstash/redis) and ioredis connections
     5→ */
     6→
     7→const { Redis } = require('@upstash/redis');
     8→
     9→// Singleton instances
    10→let restClient = null;
    11→let isConnected = false;
    12→let connectionError = null;
    13→
    14→/**
    15→ * Get the Upstash REST Redis client (recommended for most operations)
    16→ * This client works well in serverless environments
    17→ * @returns {Redis|null} Redis client or null if not configured
    18→ */
    19→function getRedisClient() {
    20→  if (restClient) {
    21→    return restClient;
    22→  }
    23→
    24→  const url = process.env.UPSTASH_REDIS_REST_URL;
    25→  const token = process.env.UPSTASH_REDIS_REST_TOKEN;
    26→
    27→  if (!url || !token) {
    28→    console.warn('[Redis] Missing UPSTASH_REDIS_REST_URL or UPSTASH_REDIS_REST_TOKEN - Redis features disabled');
    29→    connectionError = new Error('Redis not configured');
    30→    return null;
    31→  }
    32→
    33→  try {
    34→    restClient = new Redis({
    35→      url,
    36→      token,
    37→      automaticDeserialization: true,
    38→    });
    39→    isConnected = true;
    40→    console.log('[Redis] Upstash REST client initialized');
    41→    return restClient;
    42→  } catch (err) {
    43→    console.error('[Redis] Failed to initialize Upstash REST client:', err.message);
    44→    connectionError = err;
    45→    return null;
    46→  }
    47→}
    48→
    49→/**
    50→ * Check if Redis is available and connected
    51→ * @returns {boolean} True if Redis is available
    52→ */
    53→function isRedisAvailable() {
    54→  if (restClient && isConnected) {
    55→    return true;
    56→  }
    57→  // Try to initialize if not yet attempted
    58→  const client = getRedisClient();
    59→  return client !== null;
    60→}
    61→
    62→/**
    63→ * Get Redis connection status
    64→ * @returns {Object} { connected, error }
    65→ */
    66→function getRedisStatus() {
    67→  return {
    68→    connected: isConnected && restClient !== null,
    69→    error: connectionError ? connectionError.message : null,
    70→    type: restClient ? 'upstash-rest' : 'none'
    71→  };
    72→}
    73→
    74→/**
    75→ * Ping Redis to check connectivity
    76→ * @returns {Promise<boolean>} True if ping successful
    77→ */
    78→async function pingRedis() {
    79→  const client = getRedisClient();
    80→  if (!client) {
    81→    return false;
    82→  }
    83→
    84→  try {
    85→    const result = await client.ping();
    86→    return result === 'PONG';
    87→  } catch (err) {
    88→    console.error('[Redis] Ping failed:', err.message);
    89→    isConnected = false;
    90→    connectionError = err;
    91→    return false;
    92→  }
    93→}
    94→
    95→/**
    96→ * Set a value with optional TTL
    97→ * @param {string} key - Redis key
    98→ * @param {any} value - Value to store (will be JSON serialized)
    99→ * @param {number} ttlSeconds - Optional TTL in seconds
   100→ * @returns {Promise<boolean>} True if successful
   101→ */
   102→async function set(key, value, ttlSeconds = null) {
   103→  const client = getRedisClient();
   104→  if (!client) {
   105→    return false;
   106→  }
   107→
   108→  try {
   109→    if (ttlSeconds) {
   110→      await client.set(key, value, { ex: ttlSeconds });
   111→    } else {
   112→      await client.set(key, value);
   113→    }
   114→    return true;
   115→  } catch (err) {
   116→    console.error('[Redis] SET failed:', err.message);
   117→    return false;
   118→  }
   119→}
   120→
   121→/**
   122→ * Get a value
   123→ * @param {string} key - Redis key
   124→ * @returns {Promise<any|null>} Value or null if not found
   125→ */
   126→async function get(key) {
   127→  const client = getRedisClient();
   128→  if (!client) {
   129→    return null;
   130→  }
   131→
   132→  try {
   133→    return await client.get(key);
   134→  } catch (err) {
   135→    console.error('[Redis] GET failed:', err.message);
   136→    return null;
   137→  }
   138→}
   139→
   140→/**
   141→ * Check if a key exists
   142→ * @param {string} key - Redis key
   143→ * @returns {Promise<boolean>} True if key exists
   144→ */
   145→async function exists(key) {
   146→  const client = getRedisClient();
   147→  if (!client) {
   148→    return false;
   149→  }
   150→
   151→  try {
   152→    const result = await client.exists(key);
   153→    return result === 1;
   154→  } catch (err) {
   155→    console.error('[Redis] EXISTS failed:', err.message);
   156→    return false;
   157→  }
   158→}
   159→
   160→/**
   161→ * Delete a key
   162→ * @param {string} key - Redis key
   163→ * @returns {Promise<boolean>} True if deleted
   164→ */
   165→async function del(key) {
   166→  const client = getRedisClient();
   167→  if (!client) {
   168→    return false;
   169→  }
   170→
   171→  try {
   172→    await client.del(key);
   173→    return true;
   174→  } catch (err) {
   175→    console.error('[Redis] DEL failed:', err.message);
   176→    return false;
   177→  }
   178→}
   179→
   180→/**
   181→ * Set a value only if it doesn't exist (SETNX)
   182→ * @param {string} key - Redis key
   183→ * @param {any} value - Value to store
   184→ * @param {number} ttlSeconds - Optional TTL in seconds
   185→ * @returns {Promise<boolean>} True if set (key didn't exist)
   186→ */
   187→async function setNX(key, value, ttlSeconds = null) {
   188→  const client = getRedisClient();
   189→  if (!client) {
   190→    return false;
   191→  }
   192→
   193→  try {
   194→    const options = { nx: true };
   195→    if (ttlSeconds) {
   196→      options.ex = ttlSeconds;
   197→    }
   198→    const result = await client.set(key, value, options);
   199→    return result === 'OK';
   200→  } catch (err) {
   201→    console.error('[Redis] SETNX failed:', err.message);
   202→    return false;
   203→  }
   204→}
   205→
   206→/**
   207→ * Get TTL of a key
   208→ * @param {string} key - Redis key
   209→ * @returns {Promise<number>} TTL in seconds, -1 if no TTL, -2 if key doesn't exist
   210→ */
   211→async function ttl(key) {
   212→  const client = getRedisClient();
   213→  if (!client) {
   214→    return -2;
   215→  }
   216→
   217→  try {
   218→    return await client.ttl(key);
   219→  } catch (err) {
   220→    console.error('[Redis] TTL failed:', err.message);
   221→    return -2;
   222→  }
   223→}
   224→
   225→module.exports = {
   226→  getRedisClient,
   227→  isRedisAvailable,
   228→  getRedisStatus,
   229→  pingRedis,
   230→  // Convenience methods
   231→  set,
   232→  get,
   233→  exists,
   234→  del,
   235→  setNX,
   236→  ttl
   237→};
   238→

</system-reminder>
