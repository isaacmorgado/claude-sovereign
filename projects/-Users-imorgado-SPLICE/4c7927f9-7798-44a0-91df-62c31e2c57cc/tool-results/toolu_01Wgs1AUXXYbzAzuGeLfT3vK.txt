     1→/**
     2→ * SPLICE CEP Panel Configuration
     3→ * Backend URLs, paths, and utility functions
     4→ */
     5→
     6→// ============================================================================
     7→// BACKEND CONFIGURATION
     8→// ============================================================================
     9→const SPLICE_CONFIG = {
    10→    VERSION: '6.0.3',
    11→    BACKEND_PROD: 'https://splice-api-production.up.railway.app',
    12→    BACKEND_DEV: 'https://127.0.0.1:3847',
    13→    FETCH_TIMEOUT: 120000, // 2 minutes
    14→    RETRY_ATTEMPTS: 3,
    15→    RETRY_DELAY: 1000
    16→};
    17→
    18→/**
    19→ * Get the backend URL based on environment
    20→ */
    21→function getBackendUrl() {
    22→    // Check for development mode
    23→    const isDev = window.location.protocol === 'file:' ||
    24→                  window.location.hostname === 'localhost' ||
    25→                  window.location.hostname === '127.0.0.1';
    26→
    27→    // Allow override via localStorage
    28→    const customUrl = localStorage.getItem('spliceBackendUrl');
    29→    if (customUrl) return customUrl;
    30→
    31→    return isDev ? SPLICE_CONFIG.BACKEND_DEV : SPLICE_CONFIG.BACKEND_PROD;
    32→}
    33→
    34→// ============================================================================
    35→// JSX BRIDGE - Communicate with Premiere Pro
    36→// ============================================================================
    37→const jsx = {
    38→    cs: null,
    39→    _initPromise: null,
    40→    _initialized: false,
    41→
    42→    /**
    43→     * Initialize the CSInterface
    44→     * Returns a promise that resolves when ready
    45→     */
    46→    init: function() {
    47→        if (this._initPromise) return this._initPromise;
    48→
    49→        this._initPromise = new Promise((resolve) => {
    50→            if (typeof CSInterface !== 'undefined') {
    51→                this.cs = new CSInterface();
    52→                this._initialized = true;
    53→                console.log('[JSX] CSInterface initialized successfully');
    54→            } else {
    55→                console.warn('[JSX] CSInterface not available');
    56→            }
    57→            resolve(this._initialized);
    58→        });
    59→
    60→        return this._initPromise;
    61→    },
    62→
    63→    /**
    64→     * Ensure JSX is initialized before making calls
    65→     */
    66→    ensureInitialized: async function() {
    67→        if (!this._initialized) {
    68→            await this.init();
    69→        }
    70→        if (!this.cs) {
    71→            throw new Error('CSInterface not initialized. Make sure you are running in CEP environment.');
    72→        }
    73→    },
    74→
    75→    /**
    76→     * Execute ExtendScript in Premiere Pro
    77→     * @param {string} script - ExtendScript to execute
    78→     * @returns {Promise<any>} - Parsed result
    79→     */
    80→    evalScript: async function(script) {
    81→        await this.ensureInitialized();
    82→
    83→        return new Promise((resolve, reject) => {
    84→            this.cs.evalScript(script, (result) => {
    85→                if (result === 'undefined' || result === undefined) {
    86→                    resolve(null);
    87→                    return;
    88→                }
    89→
    90→                // Check for EvalScript error or ExtendScript runtime errors
    91→                if (typeof result === 'string' && (
    92→                    result.indexOf('EvalScript error') !== -1 ||
    93→                    result.indexOf('Error:') !== -1 ||
    94→                    result.indexOf('TypeError:') !== -1 ||
    95→                    result.indexOf('ReferenceError:') !== -1
    96→                )) {
    97→                    reject(new Error(result));
    98→                    return;
    99→                }
   100→
   101→                // Try to parse JSON
   102→                try {
   103→                    const parsed = JSON.parse(result);
   104→                    if (parsed.error) {
   105→                        reject(new Error(parsed.error));
   106→                    } else {
   107→                        resolve(parsed);
   108→                    }
   109→                } catch (e) {
   110→                    // Return as-is if not JSON
   111→                    resolve(result);
   112→                }
   113→            });
   114→        });
   115→    },
   116→
   117→    /**
   118→     * Call a JSX function with arguments
   119→     * @param {string} funcName - Function name
   120→     * @param {...any} args - Arguments to pass
   121→     * @returns {Promise<any>}
   122→     */
   123→    call: async function(funcName, ...args) {
   124→        await this.ensureInitialized();
   125→
   126→        const escapedArgs = args.map(arg => {
   127→            if (arg === null || arg === undefined) return 'null';
   128→            if (typeof arg === 'string') {
   129→                // Escape backslashes first, then other special chars
   130→                return `'${arg
   131→                    .replace(/\\/g, '\\\\')
   132→                    .replace(/'/g, "\\'")
   133→                    .replace(/\r/g, '\\r')
   134→                    .replace(/\n/g, '\\n')
   135→                    .replace(/\t/g, '\\t')}'`;
   136→            }
   137→            if (typeof arg === 'object') {
   138→                return `'${JSON.stringify(arg)
   139→                    .replace(/\\/g, '\\\\')
   140→                    .replace(/'/g, "\\'")}'`;
   141→            }
   142→            return String(arg);
   143→        });
   144→
   145→        const script = `${funcName}(${escapedArgs.join(', ')})`;
   146→        return this.evalScript(script);
   147→    }
   148→};
   149→
   150→// ============================================================================
   151→// FETCH UTILITIES
   152→// ============================================================================
   153→
   154→/**
   155→ * Fetch with timeout support
   156→ * @param {string} url - URL to fetch
   157→ * @param {object} options - Fetch options
   158→ * @param {number} timeout - Timeout in ms
   159→ */
   160→async function fetchWithTimeout(url, options = {}, timeout = SPLICE_CONFIG.FETCH_TIMEOUT) {
   161→    const controller = new AbortController();
   162→    const timeoutId = setTimeout(() => controller.abort(), timeout);
   163→
   164→    try {
   165→        const response = await fetch(url, {
   166→            ...options,
   167→            signal: controller.signal
   168→        });
   169→        clearTimeout(timeoutId);
   170→        return response;
   171→    } catch (error) {
   172→        clearTimeout(timeoutId);
   173→        if (error.name === 'AbortError') {
   174→            throw new Error(`Request timeout after ${timeout}ms`);
   175→        }
   176→        throw error;
   177→    }
   178→}
   179→
   180→/**
   181→ * Parse error response from backend
   182→ * @param {Response} response - Fetch response
   183→ */
   184→async function parseErrorResponse(response) {
   185→    try {
   186→        const data = await response.json();
   187→        return data.error || data.message || `HTTP ${response.status}`;
   188→    } catch {
   189→        return `HTTP ${response.status}: ${response.statusText}`;
   190→    }
   191→}
   192→
   193→/**
   194→ * Get auth headers for API requests
   195→ */
   196→function getAuthHeaders() {
   197→    const headers = { 'Content-Type': 'application/json' };
   198→    const settings = getSettings();
   199→
   200→    if (settings.customerId) {
   201→        headers['x-stripe-customer-id'] = settings.customerId;
   202→    }
   203→    if (settings.licenseKey) {
   204→        headers['x-license-key'] = settings.licenseKey;
   205→    }
   206→
   207→    return headers;
   208→}
   209→
   210→// ============================================================================
   211→// SETTINGS MANAGEMENT
   212→// ============================================================================
   213→
   214→const DEFAULT_SETTINGS = {
   215→    sensitivity: 50,
   216→    minSilenceLength: 0.5,
   217→    sourceIsolated: false,
   218→    enableTakesDetection: true,
   219→    enableJCut: false,
   220→    jcutLeadIn: 0.3,
   221→    jcutLeadOut: 0.2,
   222→    enableZoom: false,
   223→    zoomFrequency: 'medium',
   224→    zoomPreset: 'medium',
   225→    zoomPlacement: 'sentence_start',
   226→    enableChapters: false,
   227→    maxChapters: 10,
   228→    minChapterLength: 60,
   229→    enableProfanity: false,
   230→    profanityLanguage: 'en',
   231→    bleepType: 'standard',
   232→    customerId: null,
   233→    licenseKey: null,
   234→    expandedOptions: false,
   235→    activePreset: 'podcast',
   236→    rememberOptions: false
   237→};
   238→
   239→/**
   240→ * Get settings from localStorage
   241→ */
   242→function getSettings() {
   243→    try {
   244→        const stored = localStorage.getItem('spliceSettings');
   245→        if (stored) {
   246→            return { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
   247→        }
   248→    } catch (e) {
   249→        console.warn('[Config] Error loading settings:', e);
   250→    }
   251→    return { ...DEFAULT_SETTINGS };
   252→}
   253→
   254→/**
   255→ * Save settings to localStorage
   256→ */
   257→function saveSettings(settings) {
   258→    try {
   259→        const merged = { ...getSettings(), ...settings };
   260→        localStorage.setItem('spliceSettings', JSON.stringify(merged));
   261→        return true;
   262→    } catch (e) {
   263→        console.warn('[Config] Error saving settings:', e);
   264→        return false;
   265→    }
   266→}
   267→
   268→/**
   269→ * Clear specific setting
   270→ */
   271→function clearSetting(key) {
   272→    const settings = getSettings();
   273→    delete settings[key];
   274→    localStorage.setItem('spliceSettings', JSON.stringify(settings));
   275→}
   276→
   277→// ============================================================================
   278→// OFFLINE DETECTION
   279→// ============================================================================
   280→
   281→let isOnlineState = true;
   282→let offlineCheckInterval = null;
   283→
   284→/**
   285→ * Check if online
   286→ */
   287→function isOnline() {
   288→    return isOnlineState && navigator.onLine;
   289→}
   290→
   291→/**
   292→ * Initialize offline detection
   293→ */
   294→function initOfflineDetection() {
   295→    // Browser events
   296→    window.addEventListener('online', () => {
   297→        isOnlineState = true;
   298→        updateOfflineUI(true);
   299→    });
   300→
   301→    window.addEventListener('offline', () => {
   302→        isOnlineState = false;
   303→        updateOfflineUI(false);
   304→    });
   305→
   306→    // Periodic check
   307→    offlineCheckInterval = setInterval(async () => {
   308→        try {
   309→            const response = await fetchWithTimeout(
   310→                `${getBackendUrl()}/health`,
   311→                { method: 'GET' },
   312→                5000
   313→            );
   314→            isOnlineState = response.ok;
   315→        } catch {
   316→            isOnlineState = false;
   317→        }
   318→        updateOfflineUI(isOnlineState);
   319→    }, 30000);
   320→}
   321→
   322→/**
   323→ * Update UI based on online state
   324→ */
   325→function updateOfflineUI(online) {
   326→    const goBtn = document.getElementById('goBtn');
   327→    const status = document.getElementById('status');
   328→
   329→    if (goBtn) {
   330→        goBtn.disabled = !online;
   331→    }
   332→
   333→    if (status) {
   334→        if (!online) {
   335→            status.textContent = 'Offline - Check your connection';
   336→            status.style.color = '#dc3545';
   337→        } else {
   338→            // Reset status when back online
   339→            status.textContent = 'Ready';
   340→            status.style.color = '#888';
   341→        }
   342→    }
   343→}
   344→
   345→// ============================================================================
   346→// UTILITY FUNCTIONS
   347→// ============================================================================
   348→
   349→/**
   350→ * SECURITY: Escape HTML to prevent XSS attacks
   351→ * Use this when inserting untrusted content into innerHTML
   352→ * @param {string} str - String to escape
   353→ * @returns {string} Escaped string safe for innerHTML
   354→ */
   355→function escapeHtml(str) {
   356→    if (str === null || str === undefined) return '';
   357→    if (typeof str !== 'string') str = String(str);
   358→
   359→    const escapeMap = {
   360→        '&': '&amp;',
   361→        '<': '&lt;',
   362→        '>': '&gt;',
   363→        '"': '&quot;',
   364→        "'": '&#x27;',
   365→        '/': '&#x2F;',
   366→        '`': '&#x60;'
   367→    };
   368→
   369→    return str.replace(/[&<>"'\/`]/g, char => escapeMap[char]);
   370→}
   371→
   372→/**
   373→ * SECURITY: Create safe HTML from template with escaped values
   374→ * @param {TemplateStringsArray} strings - Template strings
   375→ * @param {...any} values - Values to escape
   376→ * @returns {string} HTML with escaped values
   377→ */
   378→function safeHtml(strings, ...values) {
   379→    return strings.reduce((result, str, i) => {
   380→        const value = values[i - 1];
   381→        const escaped = escapeHtml(value);
   382→        return result + escaped + str;
   383→    });
   384→}
   385→
   386→/**
   387→ * Format time in MM:SS or HH:MM:SS
   388→ */
   389→function formatTime(seconds) {
   390→    if (isNaN(seconds) || seconds < 0) return '0:00';
   391→
   392→    const hours = Math.floor(seconds / 3600);
   393→    const minutes = Math.floor((seconds % 3600) / 60);
   394→    const secs = Math.floor(seconds % 60);
   395→
   396→    if (hours > 0) {
   397→        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
   398→    }
   399→    return `${minutes}:${secs.toString().padStart(2, '0')}`;
   400→}
   401→
   402→/**
   403→ * Set status message
   404→ */
   405→function setStatus(message, isError = false) {
   406→    const status = document.getElementById('status');
   407→    if (status) {
   408→        status.textContent = message;
   409→        status.style.color = isError ? '#dc3545' : '#888';
   410→    }
   411→}
   412→
   413→/**
   414→ * Debounce function calls
   415→ */
   416→function debounce(func, wait) {
   417→    let timeout;
   418→    return function executedFunction(...args) {
   419→        const later = () => {
   420→            clearTimeout(timeout);
   421→            func(...args);
   422→        };
   423→        clearTimeout(timeout);
   424→        timeout = setTimeout(later, wait);
   425→    };
   426→}
   427→
   428→// ============================================================================
   429→// PRESET PROFILES
   430→// ============================================================================
   431→
   432→/**
   433→ * Detection presets for different content types.
   434→ * Each preset defines optimal settings for a specific use case.
   435→ */
   436→const PRESETS = {
   437→    // Custom - user-defined settings (default)
   438→    custom: {
   439→        name: 'Custom',
   440→        description: 'Your custom settings',
   441→        icon: 'settings',
   442→        settings: null // Uses current user settings
   443→    },
   444→
   445→    // Podcast - longer pauses are natural, be conservative
   446→    podcast: {
   447→        name: 'Podcast',
   448→        description: 'Longer natural pauses, J-Cuts enabled',
   449→        icon: 'mic',
   450→        settings: {
   451→            sensitivity: 35,
   452→            threshold: -35,
   453→            minSilenceLength: 0.8,
   454→            paddingStart: 0.15,
   455→            paddingEnd: 0.15,
   456→            enableTakesDetection: true,
   457→            enableJCut: true,
   458→            jCutLeadIn: 0.3,
   459→            jCutLeadOut: 0.2
   460→        }
   461→    },
   462→
   463→    // Interview - balanced, respects speaker pauses
   464→    interview: {
   465→        name: 'Interview',
   466→        description: 'Balanced cuts, J-Cuts for smooth transitions',
   467→        icon: 'people',
   468→        settings: {
   469→            sensitivity: 50,
   470→            threshold: -32,
   471→            minSilenceLength: 0.5,
   472→            paddingStart: 0.12,
   473→            paddingEnd: 0.08,
   474→            enableTakesDetection: true,
   475→            enableJCut: true,
   476→            jCutLeadIn: 0.25,
   477→            jCutLeadOut: 0.15
   478→        }
   479→    },
   480→
   481→    // Reaction video - fast pacing, quick cuts
   482→    reaction: {
   483→        name: 'Reaction',
   484→        description: 'Fast-paced, tight cuts for energy',
   485→        icon: 'bolt',
   486→        settings: {
   487→            sensitivity: 70,
   488→            threshold: -28,
   489→            minSilenceLength: 0.3,
   490→            paddingStart: 0.05,
   491→            paddingEnd: 0.03,
   492→            enableTakesDetection: false,
   493→            enableJCut: false,
   494→            jCutLeadIn: 0,
   495→            jCutLeadOut: 0
   496→        }
   497→    },
   498→
   499→    // Tutorial/Educational - preserve thinking pauses
   500→    tutorial: {
   501→        name: 'Tutorial',
   502→        description: 'Preserves teaching pace, J-Cuts enabled',
   503→        icon: 'school',
   504→        settings: {
   505→            sensitivity: 30,
   506→            threshold: -38,
   507→            minSilenceLength: 1.0,
   508→            paddingStart: 0.2,
   509→            paddingEnd: 0.15,
   510→            enableTakesDetection: true,
   511→            enableJCut: true,
   512→            jCutLeadIn: 0.35,
   513→            jCutLeadOut: 0.25
   514→        }
   515→    },
   516→
   517→    // Vlog/YouTube - punchy edits, engagement-focused
   518→    vlog: {
   519→        name: 'Vlog',
   520→        description: 'Punchy edits for YouTube engagement',
   521→        icon: 'videocam',
   522→        settings: {
   523→            sensitivity: 65,
   524→            threshold: -30,
   525→            minSilenceLength: 0.35,
   526→            paddingStart: 0.08,
   527→            paddingEnd: 0.05,
   528→            enableTakesDetection: true,
   529→            enableJCut: false,
   530→            jCutLeadIn: 0,
   531→            jCutLeadOut: 0
   532→        }
   533→    }
   534→};
   535→
   536→/**
   537→ * List of built-in preset IDs
   538→ */
   539→const BUILT_IN_PRESET_IDS = ['custom', 'podcast', 'interview', 'reaction', 'tutorial', 'vlog'];
   540→
   541→/**
   542→ * Get all available presets
   543→ * @returns {Object} All preset definitions
   544→ */
   545→function getPresets() {
   546→    return { ...PRESETS };
   547→}
   548→
   549→/**
   550→ * Get a specific preset by name
   551→ * @param {string} presetName - Name of the preset
   552→ * @returns {Object|null} Preset definition or null if not found
   553→ */
   554→function getPreset(presetName) {
   555→    return PRESETS[presetName] || null;
   556→}
   557→
   558→/**
   559→ * Check if a preset is a built-in preset
   560→ * @param {string} id - Preset ID to check
   561→ * @returns {boolean} True if built-in, false if custom
   562→ */
   563→function isBuiltInPreset(id) {
   564→    return BUILT_IN_PRESET_IDS.includes(id);
   565→}
   566→
   567→/**
   568→ * Apply a preset to current settings
   569→ * @param {string} presetName - Name of the preset to apply
   570→ * @returns {Object} The applied settings
   571→ */
   572→function applyPreset(presetName) {
   573→    const preset = PRESETS[presetName];
   574→
   575→    if (!preset) {
   576→        console.warn(`[SPLICE] Unknown preset: ${presetName}`);
   577→        return getSettings();
   578→    }
   579→
   580→    // Custom preset uses current settings
   581→    if (presetName === 'custom' || !preset.settings) {
   582→        saveSettings({ activePreset: 'custom' });
   583→        return getSettings();
   584→    }
   585→
   586→    // Apply preset settings
   587→    const newSettings = {
   588→        ...preset.settings,
   589→        activePreset: presetName
   590→    };
   591→
   592→    saveSettings(newSettings);
   593→    console.log(`[SPLICE] Applied preset: ${preset.name}`);
   594→
   595→    return getSettings();
   596→}
   597→
   598→/**
   599→ * Get the currently active preset
   600→ * @returns {string} Active preset name
   601→ */
   602→function getActivePreset() {
   603→    const settings = getSettings();
   604→    return settings.activePreset || 'custom';
   605→}
   606→
   607→/**
   608→ * Initialize preset selector
   609→ */
   610→function initPresetSelector() {
   611→    const presetSelector = document.getElementById('presetSelector');
   612→    const sensitivitySlider = document.getElementById('sensitivitySlider');
   613→
   614→    if (!presetSelector) return;
   615→
   616→    // Set initial value from settings
   617→    const settings = getSettings();
   618→    presetSelector.value = settings.activePreset || 'podcast';
   619→
   620→    // Handle preset change
   621→    presetSelector.addEventListener('change', () => {
   622→        const presetId = presetSelector.value;
   623→        const appliedSettings = applyPreset(presetId);
   624→
   625→        // Update sensitivity slider to match preset
   626→        if (sensitivitySlider && appliedSettings.sensitivity !== undefined) {
   627→            sensitivitySlider.value = appliedSettings.sensitivity;
   628→            // Update display value
   629→            const sensitivityValue = document.getElementById('sensitivityValue');
   630→            if (sensitivityValue) {
   631→                sensitivityValue.textContent = appliedSettings.sensitivity;
   632→            }
   633→        }
   634→
   635→        // Update takes detection checkbox
   636→        const enableTakesDetection = document.getElementById('enableTakesDetection');
   637→        if (enableTakesDetection && appliedSettings.enableTakesDetection !== undefined) {
   638→            enableTakesDetection.checked = appliedSettings.enableTakesDetection;
   639→        }
   640→
   641→        // Update J-Cut checkbox
   642→        const enableJCut = document.getElementById('enableJCut');
   643→        if (enableJCut && appliedSettings.enableJCut !== undefined) {
   644→            enableJCut.checked = appliedSettings.enableJCut;
   645→            // Toggle J-Cut settings visibility
   646→            const jcutSettings = document.getElementById('jcutSettings');
   647→            if (jcutSettings) {
   648→                jcutSettings.classList.toggle('collapsed', !appliedSettings.enableJCut);
   649→            }
   650→        }
   651→
   652→        const preset = getPreset(presetId);
   653→        if (preset) {
   654→            setStatus(`Preset: ${preset.name} - ${preset.description}`);
   655→        }
   656→    });
   657→
   658→    // Switch to custom when user manually changes sensitivity
   659→    if (sensitivitySlider) {
   660→        sensitivitySlider.addEventListener('change', () => {
   661→            if (presetSelector.value !== 'custom') {
   662→                presetSelector.value = 'custom';
   663→                saveSettings({ activePreset: 'custom' });
   664→            }
   665→        });
   666→    }
   667→}
   668→
   669→// ============================================================================
   670→// LOGIN MODAL
   671→// ============================================================================
   672→
   673→/**
   674→ * Validate license key format: SPLICE-XXXX-XXXX-XXXX
   675→ * Character set excludes confusing chars: 0/O, 1/I/L
   676→ */
   677→function isValidLicenseKeyFormat(key) {
   678→    if (!key || typeof key !== 'string') return false;
   679→    const normalized = key.toUpperCase().trim();
   680→    const pattern = /^SPLICE-[ABCDEFGHJKMNPQRSTUVWXYZ23456789]{4}-[ABCDEFGHJKMNPQRSTUVWXYZ23456789]{4}-[ABCDEFGHJKMNPQRSTUVWXYZ23456789]{4}$/;
   681→    return pattern.test(normalized);
   682→}
   683→
   684→/**
   685→ * Initialize login modal handlers
   686→ */
   687→function initLoginModal() {
   688→    const loginModal = document.getElementById('loginModal');
   689→    const closeLoginBtn = document.getElementById('closeLoginBtn');
   690→    const saveLoginBtn = document.getElementById('saveLoginBtn');
   691→    const licenseKeyInput = document.getElementById('licenseKeyInput');
   692→    const creditBadge = document.getElementById('creditBadge');
   693→
   694→    // Handle credit badge click - retry on error, or show login modal
   695→    if (creditBadge) {
   696→        creditBadge.addEventListener('click', async () => {
   697→            if (creditBadge.classList.contains('error')) {
   698→                creditBadge.textContent = '...';
   699→                if (typeof refreshCredits === 'function') {
   700→                    await refreshCredits();
   701→                }
   702→                return;
   703→            }
   704→            showLoginModal();
   705→        });
   706→    }
   707→
   708→    // Close login modal
   709→    if (closeLoginBtn && loginModal) {
   710→        closeLoginBtn.addEventListener('click', () => {
   711→            loginModal.classList.add('hidden');
   712→        });
   713→    }
   714→
   715→    // Close on backdrop click
   716→    if (loginModal) {
   717→        loginModal.addEventListener('click', (e) => {
   718→            if (e.target === loginModal) {
   719→                loginModal.classList.add('hidden');
   720→            }
   721→        });
   722→    }
   723→
   724→    // Activate license key
   725→    if (saveLoginBtn) {
   726→        saveLoginBtn.addEventListener('click', async () => {
   727→            const licenseKey = licenseKeyInput?.value?.trim()?.toUpperCase();
   728→
   729→            if (!licenseKey) {
   730→                showLoginError('Please enter your license key');
   731→                return;
   732→            }
   733→
   734→            if (!isValidLicenseKeyFormat(licenseKey)) {
   735→                showLoginError('Invalid format. Expected: SPLICE-XXXX-XXXX-XXXX');
   736→                return;
   737→            }
   738→
   739→            saveLoginBtn.disabled = true;
   740→            saveLoginBtn.textContent = 'Activating...';
   741→
   742→            try {
   743→                const response = await fetchWithTimeout(`${getBackendUrl()}/license/activate`, {
   744→                    method: 'POST',
   745→                    headers: { 'Content-Type': 'application/json' },
   746→                    body: JSON.stringify({ key: licenseKey })
   747→                }, SPLICE_CONFIG.FETCH_TIMEOUT);
   748→
   749→                const result = await response.json();
   750→
   751→                if (!result.success) {
   752→                    showLoginError(result.error || 'Activation failed');
   753→                    return;
   754→                }
   755→
   756→                saveSettings({ customerId: result.customerId });
   757→                loginModal?.classList.add('hidden');
   758→
   759→                if (typeof refreshCredits === 'function') {
   760→                    await refreshCredits();
   761→                }
   762→
   763→                setStatus(`License activated! ${result.tierName} tier`);
   764→            } catch (err) {
   765→                console.error('[SPLICE] License activation error:', err);
   766→                showLoginError('Connection error. Check server is running.');
   767→            } finally {
   768→                saveLoginBtn.disabled = false;
   769→                saveLoginBtn.textContent = 'Activate';
   770→            }
   771→        });
   772→    }
   773→
   774→    // Email lookup
   775→    const lookupLicenseBtn = document.getElementById('lookupLicenseBtn');
   776→    const lookupEmailInput = document.getElementById('lookupEmailInput');
   777→
   778→    if (lookupLicenseBtn) {
   779→        lookupLicenseBtn.addEventListener('click', async () => {
   780→            const email = lookupEmailInput?.value?.trim()?.toLowerCase();
   781→
   782→            if (!email) {
   783→                showLoginError('Please enter your email address');
   784→                return;
   785→            }
   786→
   787→            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
   788→            if (!emailRegex.test(email)) {
   789→                showLoginError('Please enter a valid email address');
   790→                return;
   791→            }
   792→
   793→            lookupLicenseBtn.disabled = true;
   794→            lookupLicenseBtn.textContent = 'Looking up...';
   795→
   796→            try {
   797→                const response = await fetchWithTimeout(`${getBackendUrl()}/license/lookup`, {
   798→                    method: 'POST',
   799→                    headers: { 'Content-Type': 'application/json' },
   800→                    body: JSON.stringify({ email })
   801→                }, 30000);
   802→
   803→                const result = await response.json();
   804→
   805→                // Note: For security, the backend does NOT return the license key directly.
   806→                // It sends the key via email to prevent enumeration attacks.
   807→                if (result.success) {
   808→                    setStatus(result.message || 'If a license exists, it will be sent to your email.');
   809→                } else {
   810→                    showLoginError(result.error || 'Lookup failed. Please try again.');
   811→                }
   812→            } catch (err) {
   813→                console.error('[SPLICE] License lookup error:', err);
   814→                showLoginError('Failed to look up license. Please try again.');
   815→            } finally {
   816→                lookupLicenseBtn.disabled = false;
   817→                lookupLicenseBtn.textContent = 'Lookup';
   818→            }
   819→        });
   820→    }
   821→}
   822→
   823→/**
   824→ * Show login modal
   825→ */
   826→function showLoginModal() {
   827→    const loginModal = document.getElementById('loginModal');
   828→    const loginError = document.getElementById('loginError');
   829→    if (loginError) loginError.style.display = 'none';
   830→    if (loginModal) loginModal.classList.remove('hidden');
   831→}
   832→
   833→/**
   834→ * Show login error message
   835→ */
   836→function showLoginError(message) {
   837→    const loginError = document.getElementById('loginError');
   838→    if (loginError) {
   839→        loginError.textContent = message;
   840→        loginError.style.display = 'block';
   841→    }
   842→}
   843→
   844→/**
   845→ * Check if user is logged in
   846→ */
   847→function isLoggedIn() {
   848→    const settings = getSettings();
   849→    return !!settings.customerId;
   850→}
   851→
   852→/**
   853→ * Logout - clear customer ID
   854→ */
   855→function logout() {
   856→    saveSettings({ customerId: null });
   857→    if (typeof clearCreditsCache === 'function') {
   858→        clearCreditsCache();
   859→    }
   860→    if (typeof updateCreditDisplay === 'function') {
   861→        updateCreditDisplay(null);
   862→    }
   863→    setStatus('Logged out');
   864→}
   865→
   866→// Initialize JSX bridge when loaded
   867→document.addEventListener('DOMContentLoaded', () => {
   868→    jsx.init();
   869→});
   870→
   871→// Export for modules
   872→window.SPLICE_CONFIG = SPLICE_CONFIG;
   873→window.getBackendUrl = getBackendUrl;
   874→window.fetchWithTimeout = fetchWithTimeout;
   875→window.parseErrorResponse = parseErrorResponse;
   876→window.getAuthHeaders = getAuthHeaders;
   877→window.getSettings = getSettings;
   878→window.saveSettings = saveSettings;
   879→window.clearSetting = clearSetting;
   880→window.isOnline = isOnline;
   881→window.initOfflineDetection = initOfflineDetection;
   882→window.formatTime = formatTime;
   883→window.setStatus = setStatus;
   884→window.debounce = debounce;
   885→window.jsx = jsx;
   886→window.PRESETS = PRESETS;
   887→window.getPresets = getPresets;
   888→window.getPreset = getPreset;
   889→window.applyPreset = applyPreset;
   890→window.getActivePreset = getActivePreset;
   891→window.isBuiltInPreset = isBuiltInPreset;
   892→window.initPresetSelector = initPresetSelector;
   893→window.initLoginModal = initLoginModal;
   894→window.showLoginModal = showLoginModal;
   895→window.isLoggedIn = isLoggedIn;
   896→window.logout = logout;
   897→window.escapeHtml = escapeHtml;
   898→window.safeHtml = safeHtml;
   899→

</system-reminder>
