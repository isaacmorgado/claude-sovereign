     1→/**
     2→ * SPLICE CEP Music Module
     3→ * AI-powered music generation for video projects
     4→ */
     5→
     6→// ============================================
     7→// STATE
     8→// ============================================
     9→const musicState = {
    10→  jobs: [],
    11→  selectedJob: null,
    12→  isIdentifying: false,
    13→  isGenerating: false,
    14→  identifiedSong: null,
    15→  audioPlayer: null,
    16→  pollInterval: null,
    17→  currentPollingJobId: null,  // Track which job we're polling to prevent race conditions
    18→  variationsJob: null,
    19→  variationsPollingInterval: null,
    20→  currentVariationsJobId: null,  // Track which variations job we're polling
    21→  selectedVariationIndex: null,
    22→  variationPlayers: [null, null, null],
    23→  sceneAwareEnabled: false,
    24→  isAligning: false,
    25→  alignmentOptions: null,
    26→  beatAnalysis: null,
    27→  isGeneratingTimeline: false,
    28→  timelineOptions: null
    29→};
    30→
    31→// ============================================
    32→// CONSTANTS
    33→// ============================================
    34→const MUSIC_POLL_INTERVAL = 5000;
    35→
    36→const MOOD_OPTIONS = [
    37→  { id: 'energetic', name: 'Energetic', description: 'Upbeat, high energy' },
    38→  { id: 'relaxed', name: 'Relaxed', description: 'Calm, peaceful' },
    39→  { id: 'melancholic', name: 'Melancholic', description: 'Sad, emotional' },
    40→  { id: 'intense', name: 'Intense', description: 'Powerful, dramatic' },
    41→  { id: 'happy', name: 'Happy', description: 'Joyful, cheerful' },
    42→  { id: 'mysterious', name: 'Mysterious', description: 'Dark, suspenseful' },
    43→  { id: 'romantic', name: 'Romantic', description: 'Warm, intimate' },
    44→  { id: 'epic', name: 'Epic', description: 'Grand, orchestral' },
    45→  { id: 'chill', name: 'Chill', description: 'Lo-fi, laid-back' },
    46→  { id: 'neutral', name: 'Neutral', description: 'Balanced, versatile' }
    47→];
    48→
    49→const INSTRUMENT_OPTIONS = [
    50→  { id: 'acoustic', name: 'Acoustic', description: 'Guitar, piano, strings' },
    51→  { id: 'electronic', name: 'Electronic', description: 'Synths, beats' },
    52→  { id: 'rock', name: 'Rock', description: 'Electric guitars, drums' },
    53→  { id: 'orchestral', name: 'Orchestral', description: 'Strings, brass, woodwinds' },
    54→  { id: 'minimal', name: 'Minimal', description: 'Piano, ambient' },
    55→  { id: 'hiphop', name: 'Hip-Hop', description: '808s, trap drums' }
    56→];
    57→
    58→const DURATION_OPTIONS = [
    59→  { value: 30, label: '30 seconds' },
    60→  { value: 60, label: '1 minute' },
    61→  { value: 90, label: '1.5 minutes' },
    62→  { value: 120, label: '2 minutes' },
    63→  { value: 180, label: '3 minutes' }
    64→];
    65→
    66→// ============================================
    67→// DOM ELEMENT CACHE
    68→// ============================================
    69→const musicElements = {
    70→  section: null,
    71→  panel: null,
    72→  status: null,
    73→  creditsBadge: null,
    74→  youtubeUrl: null,
    75→  identifyBtn: null,
    76→  referenceDisplay: null,
    77→  moodSelector: null,
    78→  instrumentSelector: null,
    79→  durationSlider: null,
    80→  durationValue: null,
    81→  promptInput: null,
    82→  generateBtn: null,
    83→  variationsCheckbox: null,
    84→  sceneAwareToggle: null,
    85→  timelineBtn: null,
    86→  jobsList: null,
    87→  library: null,
    88→  variationsPanel: null,
    89→  variationsList: null,
    90→  progressContainer: null,
    91→  progressBar: null,
    92→  progressText: null,
    93→  tabGenerate: null,
    94→  tabIdentify: null,
    95→  tabLibrary: null
    96→};
    97→
    98→function cacheMusicElements() {
    99→  musicElements.section = document.getElementById('musicSection');
   100→  musicElements.panel = document.getElementById('music-panel');
   101→  musicElements.status = document.getElementById('music-status');
   102→  musicElements.creditsBadge = document.getElementById('music-credits-badge');
   103→  musicElements.youtubeUrl = document.getElementById('music-youtube-url');
   104→  musicElements.identifyBtn = document.getElementById('music-identify-btn');
   105→  musicElements.referenceDisplay = document.getElementById('music-identify-result');
   106→  musicElements.moodSelector = document.getElementById('music-mood-selector');
   107→  musicElements.instrumentSelector = document.getElementById('music-instrument-selector');
   108→  musicElements.durationSlider = document.getElementById('music-duration-slider');
   109→  musicElements.durationValue = document.getElementById('music-duration-value');
   110→  musicElements.promptInput = document.getElementById('music-custom-prompt');
   111→  musicElements.generateBtn = document.getElementById('music-generate-btn');
   112→  musicElements.variationsCheckbox = document.getElementById('music-variations');
   113→  musicElements.sceneAwareToggle = document.getElementById('music-scene-aware');
   114→  musicElements.timelineBtn = document.getElementById('music-timeline-btn');
   115→  musicElements.jobsList = document.getElementById('music-jobs-list');
   116→  musicElements.library = document.getElementById('music-library-list');
   117→  musicElements.variationsPanel = document.getElementById('music-variations-panel');
   118→  musicElements.variationsList = document.getElementById('music-variations-list');
   119→  musicElements.progressContainer = document.getElementById('music-progress');
   120→  musicElements.progressBar = document.getElementById('music-progress-bar');
   121→  musicElements.progressText = document.getElementById('music-progress-text');
   122→
   123→  // Tab elements
   124→  musicElements.tabGenerate = document.getElementById('music-tab-generate');
   125→  musicElements.tabIdentify = document.getElementById('music-tab-identify');
   126→  musicElements.tabLibrary = document.getElementById('music-tab-library');
   127→}
   128→
   129→// ============================================
   130→// API FUNCTIONS
   131→// ============================================
   132→
   133→async function identifySong(youtubeUrl) {
   134→  const backendUrl = getBackendUrl();
   135→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   136→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   137→
   138→  const response = await fetchFn(`${backendUrl}/music/identify`, {
   139→    method: 'POST',
   140→    headers: { ...headers, 'Content-Type': 'application/json' },
   141→    body: JSON.stringify({ youtubeUrl })
   142→  }, 90000);
   143→
   144→  if (!response.ok) {
   145→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   146→    throw new Error(error.message || 'Failed to identify song');
   147→  }
   148→  return response.json();
   149→}
   150→
   151→async function generateMusicRequest(options) {
   152→  const backendUrl = getBackendUrl();
   153→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   154→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   155→
   156→  const response = await fetchFn(`${backendUrl}/music/generate`, {
   157→    method: 'POST',
   158→    headers: { ...headers, 'Content-Type': 'application/json' },
   159→    body: JSON.stringify(options)
   160→  });
   161→
   162→  if (!response.ok) {
   163→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   164→    throw new Error(error.message || 'Failed to start music generation');
   165→  }
   166→  return response.json();
   167→}
   168→
   169→async function getJobStatus(jobId) {
   170→  const backendUrl = getBackendUrl();
   171→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   172→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   173→
   174→  const response = await fetchFn(`${backendUrl}/music/status/${jobId}`, { headers });
   175→
   176→  if (!response.ok) {
   177→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   178→    throw new Error(error.message || 'Failed to get job status');
   179→  }
   180→  return response.json();
   181→}
   182→
   183→async function getMusicLibrary() {
   184→  const backendUrl = getBackendUrl();
   185→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   186→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   187→
   188→  const response = await fetchFn(`${backendUrl}/music/library`, { headers });
   189→
   190→  if (!response.ok) {
   191→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   192→    throw new Error(error.message || 'Failed to load music library');
   193→  }
   194→  return response.json();
   195→}
   196→
   197→async function getMusicFile(jobId) {
   198→  const backendUrl = getBackendUrl();
   199→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   200→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   201→
   202→  const response = await fetchFn(`${backendUrl}/music/${jobId}`, { headers });
   203→
   204→  if (!response.ok) {
   205→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   206→    throw new Error(error.message || 'Failed to get music file');
   207→  }
   208→  return response.json();
   209→}
   210→
   211→async function deleteMusicFile(jobId) {
   212→  const backendUrl = getBackendUrl();
   213→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   214→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   215→
   216→  const response = await fetchFn(`${backendUrl}/music/${jobId}`, { method: 'DELETE', headers });
   217→
   218→  if (!response.ok) {
   219→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   220→    throw new Error(error.message || 'Failed to delete music');
   221→  }
   222→  return response.json();
   223→}
   224→
   225→async function getMusicCredits() {
   226→  const backendUrl = getBackendUrl();
   227→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   228→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   229→
   230→  const response = await fetchFn(`${backendUrl}/music/credits`, { headers });
   231→
   232→  if (!response.ok) {
   233→    return { remaining: 0, total: 0 };
   234→  }
   235→  return response.json();
   236→}
   237→
   238→// ============================================
   239→// VARIATIONS API FUNCTIONS
   240→// ============================================
   241→
   242→async function generateVariationsRequest(options) {
   243→  const backendUrl = getBackendUrl();
   244→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   245→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   246→
   247→  const response = await fetchFn(`${backendUrl}/music/generate-variations`, {
   248→    method: 'POST',
   249→    headers: { ...headers, 'Content-Type': 'application/json' },
   250→    body: JSON.stringify(options)
   251→  });
   252→
   253→  if (!response.ok) {
   254→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   255→    throw new Error(error.message || 'Failed to start variations generation');
   256→  }
   257→  return response.json();
   258→}
   259→
   260→async function getVariationsStatus(jobId) {
   261→  const backendUrl = getBackendUrl();
   262→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   263→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   264→
   265→  const response = await fetchFn(`${backendUrl}/music/variations/status/${jobId}`, { headers });
   266→
   267→  if (!response.ok) {
   268→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   269→    throw new Error(error.message || 'Failed to get variations status');
   270→  }
   271→  return response.json();
   272→}
   273→
   274→async function selectVariation(jobId, variationIndex) {
   275→  const backendUrl = getBackendUrl();
   276→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   277→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   278→
   279→  const response = await fetchFn(`${backendUrl}/music/variations/${jobId}/select`, {
   280→    method: 'POST',
   281→    headers: { ...headers, 'Content-Type': 'application/json' },
   282→    body: JSON.stringify({ variationIndex })
   283→  });
   284→
   285→  if (!response.ok) {
   286→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   287→    throw new Error(error.message || 'Failed to select variation');
   288→  }
   289→  return response.json();
   290→}
   291→
   292→// ============================================
   293→// SCENE-AWARE API FUNCTIONS
   294→// ============================================
   295→
   296→async function generateSceneAwareRequest(options, segments) {
   297→  const backendUrl = getBackendUrl();
   298→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   299→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   300→
   301→  const response = await fetchFn(`${backendUrl}/music/generate-scene-aware`, {
   302→    method: 'POST',
   303→    headers: { ...headers, 'Content-Type': 'application/json' },
   304→    body: JSON.stringify({ ...options, segments })
   305→  });
   306→
   307→  if (!response.ok) {
   308→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   309→    throw new Error(error.message || 'Failed to start scene-aware music generation');
   310→  }
   311→  return response.json();
   312→}
   313→
   314→function getCurrentTranscriptSegments() {
   315→  if (window.currentTranscript && window.currentTranscript.segments) {
   316→    return window.currentTranscript.segments;
   317→  }
   318→  return null;
   319→}
   320→
   321→// ============================================
   322→// ALIGNMENT API FUNCTIONS
   323→// ============================================
   324→
   325→async function alignMusicRequest(jobId, targetDuration, options = {}) {
   326→  const backendUrl = getBackendUrl();
   327→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   328→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   329→
   330→  const response = await fetchFn(`${backendUrl}/music/align`, {
   331→    method: 'POST',
   332→    headers: { ...headers, 'Content-Type': 'application/json' },
   333→    body: JSON.stringify({
   334→      jobId,
   335→      targetDuration,
   336→      fadeDuration: options.fadeDuration,
   337→      beatAlign: options.beatAlign !== false,
   338→      searchWindow: options.searchWindow
   339→    })
   340→  }, 120000);
   341→
   342→  if (!response.ok) {
   343→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   344→    throw new Error(error.message || 'Failed to align music');
   345→  }
   346→  return response.json();
   347→}
   348→
   349→async function analyzeBeatsRequest(jobId) {
   350→  const backendUrl = getBackendUrl();
   351→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   352→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   353→
   354→  const response = await fetchFn(`${backendUrl}/music/analyze-beats`, {
   355→    method: 'POST',
   356→    headers: { ...headers, 'Content-Type': 'application/json' },
   357→    body: JSON.stringify({ jobId })
   358→  }, 60000);
   359→
   360→  if (!response.ok) {
   361→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   362→    throw new Error(error.message || 'Failed to analyze beats');
   363→  }
   364→  return response.json();
   365→}
   366→
   367→async function getAlignmentOptions() {
   368→  const backendUrl = getBackendUrl();
   369→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   370→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   371→
   372→  const response = await fetchFn(`${backendUrl}/music/alignment-options`, { headers });
   373→
   374→  if (!response.ok) {
   375→    return {
   376→      fadeDuration: { default: 2, min: 0.5, max: 5 },
   377→      searchWindow: { default: 3, min: 0.5, max: 10 },
   378→      minAudioDuration: 5
   379→    };
   380→  }
   381→  return response.json();
   382→}
   383→
   384→// ============================================
   385→// TIMELINE API FUNCTIONS
   386→// ============================================
   387→
   388→async function generateTimelineRequest(transcript, options = {}) {
   389→  const backendUrl = getBackendUrl();
   390→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   391→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   392→
   393→  const response = await fetchFn(`${backendUrl}/music/generate-timeline`, {
   394→    method: 'POST',
   395→    headers: { ...headers, 'Content-Type': 'application/json' },
   396→    body: JSON.stringify({
   397→      transcript,
   398→      maxChapters: options.maxChapters || 10,
   399→      minChapterLength: options.minChapterLength || 60,
   400→      crossfadeDuration: options.crossfadeDuration || 2,
   401→      instruments: options.instruments || [],
   402→      prompt: options.prompt || ''
   403→    })
   404→  }, 600000);
   405→
   406→  if (!response.ok) {
   407→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   408→    throw new Error(error.message || 'Failed to generate timeline music');
   409→  }
   410→  return response.json();
   411→}
   412→
   413→async function getTimelineOptions() {
   414→  const backendUrl = getBackendUrl();
   415→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   416→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   417→
   418→  const response = await fetchFn(`${backendUrl}/music/timeline-options`, { headers });
   419→
   420→  if (!response.ok) {
   421→    return {
   422→      defaults: { maxChapters: 10, minChapterLength: 60, crossfadeDuration: 2 },
   423→      constraints: { minCrossfadeDuration: 0.5, maxCrossfadeDuration: 5 }
   424→    };
   425→  }
   426→  return response.json();
   427→}
   428→
   429→async function estimateTimelineRequest(transcript, options = {}) {
   430→  const backendUrl = getBackendUrl();
   431→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   432→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   433→
   434→  const response = await fetchFn(`${backendUrl}/music/timeline-estimate`, {
   435→    method: 'POST',
   436→    headers: { ...headers, 'Content-Type': 'application/json' },
   437→    body: JSON.stringify({
   438→      transcript,
   439→      maxChapters: options.maxChapters,
   440→      minChapterLength: options.minChapterLength
   441→    })
   442→  });
   443→
   444→  if (!response.ok) {
   445→    return { estimatedChapters: 3, estimatedMinutes: 12, estimatedTimeDisplay: '10-15 minutes' };
   446→  }
   447→  return response.json();
   448→}
   449→
   450→function getCurrentTranscript() {
   451→  if (window.currentTranscript) {
   452→    return window.currentTranscript;
   453→  }
   454→  return null;
   455→}
   456→
   457→async function getSequenceDuration() {
   458→  try {
   459→    const result = await jsx.call('getSequenceDuration');
   460→    if (result && result.duration) {
   461→      return result.duration;
   462→    }
   463→  } catch (error) {
   464→    console.error('Could not get sequence duration:', error);
   465→  }
   466→  return null;
   467→}
   468→
   469→// ============================================
   470→// INITIALIZATION
   471→// ============================================
   472→
   473→function initMusicModule() {
   474→  console.log('[SPLICE] Initializing music module');
   475→
   476→  cacheMusicElements();
   477→  setupMusicEventListeners();
   478→  setupTabSwitching();
   479→  populateMoodSelector();
   480→  populateInstrumentSelector();
   481→  setupDurationSlider();
   482→  loadMusicLibrary();
   483→  updateMusicCreditsDisplay();
   484→
   485→  console.log('[SPLICE] Music module initialized');
   486→}
   487→
   488→function setupTabSwitching() {
   489→  const tabs = document.querySelectorAll('.music-tab');
   490→  const contents = {
   491→    generate: musicElements.tabGenerate || document.getElementById('music-tab-generate'),
   492→    identify: musicElements.tabIdentify || document.getElementById('music-tab-identify'),
   493→    library: musicElements.tabLibrary || document.getElementById('music-tab-library')
   494→  };
   495→
   496→  tabs.forEach(tab => {
   497→    tab.addEventListener('click', () => {
   498→      const tabName = tab.dataset.tab;
   499→
   500→      // Update tab buttons
   501→      tabs.forEach(t => t.classList.remove('active'));
   502→      tab.classList.add('active');
   503→
   504→      // Update tab content
   505→      Object.entries(contents).forEach(([name, content]) => {
   506→        if (content) {
   507→          content.classList.toggle('active', name === tabName);
   508→        }
   509→      });
   510→
   511→      // Refresh library when switching to library tab
   512→      if (tabName === 'library') {
   513→        loadMusicLibrary();
   514→      }
   515→    });
   516→  });
   517→}
   518→
   519→function setupMusicEventListeners() {
   520→  document.addEventListener('input', (e) => {
   521→    if (e.target.id === 'music-youtube-url') {
   522→      handleYoutubeUrlChange();
   523→    }
   524→  });
   525→
   526→  document.addEventListener('click', (e) => {
   527→    const id = e.target.id;
   528→
   529→    switch (id) {
   530→      case 'music-identify-btn':
   531→        handleIdentifySong();
   532→        break;
   533→      case 'music-generate-btn':
   534→        handleGenerateMusic();
   535→        break;
   536→      case 'musicClearRefBtn':
   537→        handleClearReference();
   538→        break;
   539→      case 'music-timeline-btn':
   540→        showTimelineModal();
   541→        break;
   542→    }
   543→
   544→    // Library action buttons
   545→    if (e.target.classList.contains('music-action-btn')) {
   546→      handleLibraryAction(e);
   547→    }
   548→  });
   549→
   550→  document.addEventListener('change', (e) => {
   551→    if (e.target.id === 'music-scene-aware') {
   552→      handleSceneAwareToggle();
   553→    }
   554→    if (e.target.id === 'music-variations') {
   555→      // Handle variations checkbox - will be checked in handleGenerateMusic
   556→    }
   557→  });
   558→
   559→  updateSceneAwareAvailability();
   560→  updateTimelineAvailability();
   561→}
   562→
   563→function handleSceneAwareToggle() {
   564→  const toggle = musicElements.sceneAwareToggle || document.getElementById('music-scene-aware');
   565→  musicState.sceneAwareEnabled = toggle?.checked || false;
   566→
   567→  const indicator = document.getElementById('sceneAwareIndicator');
   568→  if (indicator) {
   569→    indicator.style.display = musicState.sceneAwareEnabled ? 'block' : 'none';
   570→  }
   571→
   572→  if (musicState.sceneAwareEnabled) {
   573→    const segments = getCurrentTranscriptSegments();
   574→    if (segments) {
   575→      setMusicStatus(`Scene-aware enabled: ${segments.length} segments detected`, 'info');
   576→    } else {
   577→      setMusicStatus('Scene-aware enabled: Run transcription first for best results', 'warning');
   578→    }
   579→  }
   580→}
   581→
   582→function updateSceneAwareAvailability() {
   583→  const toggle = musicElements.sceneAwareToggle || document.getElementById('music-scene-aware');
   584→  const segments = getCurrentTranscriptSegments();
   585→
   586→  if (toggle) {
   587→    toggle.disabled = !segments;
   588→    toggle.parentElement?.classList.toggle('disabled', !segments);
   589→  }
   590→}
   591→
   592→// ============================================
   593→// UI POPULATION (Card-Based)
   594→// ============================================
   595→
   596→function populateMoodSelector() {
   597→  const container = musicElements.moodSelector || document.getElementById('music-mood-selector');
   598→  if (!container) return;
   599→
   600→  container.innerHTML = MOOD_OPTIONS.map(mood =>
   601→    `<div class="music-mood-card ${mood.id === 'neutral' ? 'selected' : ''}" data-mood="${mood.id}" title="${mood.description}">
   602→      <span class="mood-name">${mood.name}</span>
   603→    </div>`
   604→  ).join('');
   605→
   606→  // Add click handlers
   607→  container.querySelectorAll('.music-mood-card').forEach(card => {
   608→    card.addEventListener('click', () => {
   609→      container.querySelectorAll('.music-mood-card').forEach(c => c.classList.remove('selected'));
   610→      card.classList.add('selected');
   611→    });
   612→  });
   613→}
   614→
   615→function populateInstrumentSelector() {
   616→  const container = musicElements.instrumentSelector || document.getElementById('music-instrument-selector');
   617→  if (!container) return;
   618→
   619→  container.innerHTML = INSTRUMENT_OPTIONS.map(inst =>
   620→    `<div class="music-instrument-card ${inst.id === 'acoustic' ? 'selected' : ''}" data-instrument="${inst.id}" title="${inst.description}">
   621→      <span class="instrument-name">${inst.name}</span>
   622→    </div>`
   623→  ).join('');
   624→
   625→  // Add click handlers
   626→  container.querySelectorAll('.music-instrument-card').forEach(card => {
   627→    card.addEventListener('click', () => {
   628→      container.querySelectorAll('.music-instrument-card').forEach(c => c.classList.remove('selected'));
   629→      card.classList.add('selected');
   630→    });
   631→  });
   632→}
   633→
   634→function setupDurationSlider() {
   635→  const slider = musicElements.durationSlider || document.getElementById('music-duration-slider');
   636→  const valueDisplay = musicElements.durationValue || document.getElementById('music-duration-value');
   637→  if (!slider) return;
   638→
   639→  slider.addEventListener('input', () => {
   640→    if (valueDisplay) valueDisplay.textContent = slider.value;
   641→  });
   642→}
   643→
   644→function getSelectedMood() {
   645→  const container = musicElements.moodSelector || document.getElementById('music-mood-selector');
   646→  const selected = container?.querySelector('.music-mood-card.selected');
   647→  return selected?.dataset.mood || 'neutral';
   648→}
   649→
   650→function getSelectedInstrument() {
   651→  const container = musicElements.instrumentSelector || document.getElementById('music-instrument-selector');
   652→  const selected = container?.querySelector('.music-instrument-card.selected');
   653→  return selected?.dataset.instrument || 'acoustic';
   654→}
   655→
   656→function getSelectedDuration() {
   657→  const slider = musicElements.durationSlider || document.getElementById('music-duration-slider');
   658→  return parseInt(slider?.value) || 60;
   659→}
   660→
   661→// ============================================
   662→// YOUTUBE URL HANDLING
   663→// ============================================
   664→
   665→function handleYoutubeUrlChange() {
   666→  const urlInput = musicElements.youtubeUrl || document.getElementById('music-youtube-url');
   667→  const identifyBtn = musicElements.identifyBtn || document.getElementById('music-identify-btn');
   668→
   669→  if (!urlInput || !identifyBtn) return;
   670→
   671→  const url = urlInput.value.trim();
   672→  const isValidUrl = isValidYouTubeUrl(url);
   673→  identifyBtn.disabled = !isValidUrl;
   674→
   675→  if (musicState.identifiedSong) {
   676→    handleClearReference();
   677→  }
   678→}
   679→
   680→function isValidYouTubeUrl(url) {
   681→  if (!url) return false;
   682→  const patterns = [
   683→    /youtube\.com\/watch\?v=[\w-]{11}/,
   684→    /youtu\.be\/[\w-]{11}/,
   685→    /youtube\.com\/embed\/[\w-]{11}/
   686→  ];
   687→  return patterns.some(p => p.test(url));
   688→}
   689→
   690→async function handleIdentifySong() {
   691→  const urlInput = musicElements.youtubeUrl || document.getElementById('music-youtube-url');
   692→  const identifyBtn = musicElements.identifyBtn || document.getElementById('music-identify-btn');
   693→
   694→  if (!urlInput || !identifyBtn) return;
   695→
   696→  const url = urlInput.value.trim();
   697→  if (!isValidYouTubeUrl(url)) {
   698→    setMusicStatus('Invalid YouTube URL', 'error');
   699→    return;
   700→  }
   701→
   702→  try {
   703→    musicState.isIdentifying = true;
   704→    identifyBtn.disabled = true;
   705→    identifyBtn.textContent = 'Identifying...';
   706→    setMusicStatus('Identifying song...', 'info');
   707→
   708→    const result = await identifySong(url);
   709→
   710→    if (result.identified) {
   711→      musicState.identifiedSong = result;
   712→      displayIdentifiedSong(result);
   713→      setMusicStatus(`Identified: ${result.title} by ${result.artist}`, 'success');
   714→    } else {
   715→      setMusicStatus('Could not identify song. You can still generate music.', 'warning');
   716→    }
   717→
   718→  } catch (error) {
   719→    console.error('Identification error:', error);
   720→    setMusicStatus(`Error: ${error.message}`, 'error');
   721→  } finally {
   722→    musicState.isIdentifying = false;
   723→    identifyBtn.disabled = false;
   724→    identifyBtn.textContent = 'Identify';
   725→  }
   726→}
   727→
   728→function displayIdentifiedSong(song) {
   729→  const display = musicElements.referenceDisplay || document.getElementById('music-identify-result');
   730→  if (!display) return;
   731→
   732→  const details = [];
   733→  if (song.bpm) details.push(`${song.bpm} BPM`);
   734→  if (song.key) details.push(song.key);
   735→  if (song.mood) details.push(song.mood);
   736→
   737→  display.innerHTML = `
   738→    <div class="music-reference-card">
   739→      <div class="music-ref-title">${escapeHtml(song.title)}</div>
   740→      <div class="music-ref-artist">${escapeHtml(song.artist)}</div>
   741→      <div class="music-ref-details">${details.join(' - ')}</div>
   742→      <button id="musicClearRefBtn" class="music-clear-ref-btn" title="Clear reference">x</button>
   743→    </div>
   744→  `;
   745→  display.style.display = 'block';
   746→}
   747→
   748→function handleClearReference() {
   749→  musicState.identifiedSong = null;
   750→
   751→  const display = musicElements.referenceDisplay || document.getElementById('music-identify-result');
   752→  if (display) {
   753→    display.innerHTML = '';
   754→    display.style.display = 'none';
   755→  }
   756→
   757→  const urlInput = musicElements.youtubeUrl || document.getElementById('music-youtube-url');
   758→  if (urlInput) urlInput.value = '';
   759→
   760→  const identifyBtn = musicElements.identifyBtn || document.getElementById('music-identify-btn');
   761→  if (identifyBtn) identifyBtn.disabled = true;
   762→}
   763→
   764→// ============================================
   765→// MUSIC GENERATION
   766→// ============================================
   767→
   768→async function handleGenerateMusic() {
   769→  const generateBtn = musicElements.generateBtn || document.getElementById('music-generate-btn');
   770→  const promptInput = musicElements.promptInput || document.getElementById('music-custom-prompt');
   771→  const variationsCheckbox = musicElements.variationsCheckbox || document.getElementById('music-variations');
   772→
   773→  if (!generateBtn) return;
   774→
   775→  // Check if variations mode is enabled
   776→  const generateVariations = variationsCheckbox?.checked || false;
   777→  if (generateVariations) {
   778→    return handleGenerateVariations();
   779→  }
   780→
   781→  try {
   782→    musicState.isGenerating = true;
   783→    generateBtn.disabled = true;
   784→    generateBtn.textContent = 'Starting...';
   785→
   786→    const options = {
   787→      mood: getSelectedMood(),
   788→      instruments: [getSelectedInstrument()],
   789→      duration: getSelectedDuration(),
   790→      prompt: promptInput?.value || '',
   791→      youtubeUrl: musicState.identifiedSong?.sourceUrl || null,
   792→      referenceSong: musicState.identifiedSong || null
   793→    };
   794→
   795→    let result;
   796→
   797→    if (musicState.sceneAwareEnabled) {
   798→      const segments = getCurrentTranscriptSegments();
   799→      if (segments && segments.length > 0) {
   800→        setMusicStatus('Analyzing transcript and generating scene-aware music...', 'info');
   801→        result = await generateSceneAwareRequest(options, segments);
   802→        setMusicStatus(`Scene-aware generation started! Job ID: ${result.jobId}`, 'success');
   803→      } else {
   804→        setMusicStatus('No transcript available, using regular generation...', 'warning');
   805→        result = await generateMusicRequest(options);
   806→        setMusicStatus(`Generation started! Job ID: ${result.jobId}`, 'success');
   807→      }
   808→    } else {
   809→      setMusicStatus('Submitting generation request...', 'info');
   810→      result = await generateMusicRequest(options);
   811→      setMusicStatus(`Generation started! Job ID: ${result.jobId}`, 'success');
   812→    }
   813→
   814→    addJobToList(result.jobId, options, result.isSceneAware);
   815→    startPollingJob(result.jobId);
   816→    handleClearReference();
   817→    if (promptInput) promptInput.value = '';
   818→
   819→  } catch (error) {
   820→    console.error('Generation error:', error);
   821→    setMusicStatus(`Error: ${error.message}`, 'error');
   822→  } finally {
   823→    musicState.isGenerating = false;
   824→    generateBtn.disabled = false;
   825→    generateBtn.textContent = 'Generate Music';
   826→  }
   827→}
   828→
   829→// ============================================
   830→// VARIATIONS
   831→// ============================================
   832→
   833→async function handleGenerateVariations() {
   834→  const generateBtn = musicElements.generateBtn || document.getElementById('music-generate-btn');
   835→  const promptInput = musicElements.promptInput || document.getElementById('music-custom-prompt');
   836→
   837→  if (!generateBtn) return;
   838→
   839→  try {
   840→    musicState.isGenerating = true;
   841→    generateBtn.disabled = true;
   842→    generateBtn.textContent = 'Starting...';
   843→    setMusicStatus('Generating 3 variations... This may take 5-8 minutes.', 'info');
   844→
   845→    const options = {
   846→      mood: getSelectedMood(),
   847→      instruments: [getSelectedInstrument()],
   848→      duration: getSelectedDuration(),
   849→      prompt: promptInput?.value || '',
   850→      referenceSong: musicState.identifiedSong || null
   851→    };
   852→
   853→    const result = await generateVariationsRequest(options);
   854→    setMusicStatus(`Variations generation started! Job ID: ${result.jobId}`, 'success');
   855→
   856→    musicState.variationsJob = { jobId: result.jobId, status: 'pending', options };
   857→    startPollingVariations(result.jobId);
   858→    showVariationsPanel();
   859→    handleClearReference();
   860→    if (promptInput) promptInput.value = '';
   861→
   862→  } catch (error) {
   863→    console.error('Variations error:', error);
   864→    setMusicStatus(`Error: ${error.message}`, 'error');
   865→  } finally {
   866→    musicState.isGenerating = false;
   867→    generateBtn.disabled = false;
   868→    generateBtn.textContent = 'Generate 3 Variations';
   869→  }
   870→}
   871→
   872→function startPollingVariations(jobId) {
   873→  // Clear any existing polling
   874→  if (musicState.variationsPollingInterval) {
   875→    clearInterval(musicState.variationsPollingInterval);
   876→  }
   877→
   878→  // Track which variations job we're polling for (race condition fix)
   879→  musicState.currentVariationsJobId = jobId;
   880→
   881→  musicState.variationsPollingInterval = setInterval(async () => {
   882→    // Race condition check: verify we're still polling for this job
   883→    if (musicState.currentVariationsJobId !== jobId) {
   884→      return; // A new variations job started polling, ignore this callback
   885→    }
   886→
   887→    try {
   888→      const status = await getVariationsStatus(jobId);
   889→
   890→      // Double-check after async operation
   891→      if (musicState.currentVariationsJobId !== jobId) {
   892→        return;
   893→      }
   894→
   895→      musicState.variationsJob = { ...musicState.variationsJob, ...status };
   896→      renderVariationsProgress(status);
   897→
   898→      if (status.status === 'selecting' || status.status === 'completed') {
   899→        clearInterval(musicState.variationsPollingInterval);
   900→        musicState.variationsPollingInterval = null;
   901→        musicState.currentVariationsJobId = null;
   902→
   903→        if (status.variations && status.variations.length > 0) {
   904→          setMusicStatus('Variations ready! Select your favorite.', 'success');
   905→          renderVariationsSelection(status.variations);
   906→        }
   907→      } else if (status.status === 'failed') {
   908→        clearInterval(musicState.variationsPollingInterval);
   909→        musicState.variationsPollingInterval = null;
   910→        musicState.currentVariationsJobId = null;
   911→        setMusicStatus(`Variations failed: ${status.failedReason || 'Unknown error'}`, 'error');
   912→      }
   913→    } catch (error) {
   914→      console.error('Variations polling error:', error);
   915→    }
   916→  }, MUSIC_POLL_INTERVAL);
   917→}
   918→
   919→function showVariationsPanel() {
   920→  let panel = musicElements.variationsPanel || document.getElementById('variationsPanel');
   921→  if (!panel) {
   922→    panel = document.createElement('div');
   923→    panel.id = 'variationsPanel';
   924→    panel.className = 'variations-panel';
   925→    const section = musicElements.section || document.getElementById('musicSection');
   926→    if (section) section.appendChild(panel);
   927→  }
   928→
   929→  panel.style.display = 'block';
   930→  panel.innerHTML = `
   931→    <div class="variations-header">
   932→      <h4>Generating 3 Variations</h4>
   933→      <button id="variationsCancelBtn" class="variations-cancel-btn" title="Cancel">x</button>
   934→    </div>
   935→    <div class="variations-progress">
   936→      <div class="variation-progress-item" data-index="0">
   937→        <span class="variation-name">Version A</span>
   938→        <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
   939→        <span class="progress-text">0%</span>
   940→      </div>
   941→      <div class="variation-progress-item" data-index="1">
   942→        <span class="variation-name">Version B</span>
   943→        <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
   944→        <span class="progress-text">0%</span>
   945→      </div>
   946→      <div class="variation-progress-item" data-index="2">
   947→        <span class="variation-name">Version C</span>
   948→        <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
   949→        <span class="progress-text">0%</span>
   950→      </div>
   951→    </div>
   952→    <div id="variationsSelection" class="variations-selection" style="display: none;"></div>
   953→  `;
   954→
   955→  document.getElementById('variationsCancelBtn')?.addEventListener('click', hideVariationsPanel);
   956→}
   957→
   958→function hideVariationsPanel() {
   959→  const panel = musicElements.variationsPanel || document.getElementById('variationsPanel');
   960→  if (panel) {
   961→    panel.style.display = 'none';
   962→    panel.innerHTML = '';
   963→  }
   964→
   965→  if (musicState.variationsPollingInterval) {
   966→    clearInterval(musicState.variationsPollingInterval);
   967→    musicState.variationsPollingInterval = null;
   968→  }
   969→
   970→  musicState.variationPlayers.forEach(player => {
   971→    if (player) { player.pause(); player.src = ''; }
   972→  });
   973→  musicState.variationPlayers = [null, null, null];
   974→  musicState.variationsJob = null;
   975→  musicState.selectedVariationIndex = null;
   976→}
   977→
   978→function renderVariationsProgress(status) {
   979→  const progressItems = document.querySelectorAll('.variation-progress-item');
   980→  const variationProgress = status.variationProgress || [0, 0, 0];
   981→
   982→  progressItems.forEach((item, index) => {
   983→    const progress = variationProgress[index] || 0;
   984→    const fill = item.querySelector('.progress-fill');
   985→    const text = item.querySelector('.progress-text');
   986→
   987→    if (fill) fill.style.width = `${progress}%`;
   988→    if (text) text.textContent = `${progress}%`;
   989→    if (progress >= 100) item.classList.add('completed');
   990→  });
   991→}
   992→
   993→function renderVariationsSelection(variations) {
   994→  const container = document.getElementById('variationsSelection');
   995→  if (!container) return;
   996→
   997→  const progressContainer = document.querySelector('.variations-progress');
   998→  if (progressContainer) progressContainer.style.display = 'none';
   999→
  1000→  container.style.display = 'block';
  1001→  container.innerHTML = `
  1002→    <div class="variations-header">
  1003→      <h4>Select Your Favorite</h4>
  1004→      <p class="variations-subtitle">Preview each variation and choose one to keep</p>
  1005→    </div>
  1006→    <div class="variations-cards">
  1007→      ${variations.map((v, index) => `
  1008→        <div class="variation-card ${v.status === 'failed' ? 'failed' : ''}" data-index="${index}">
  1009→          <div class="variation-card-header">
  1010→            <span class="variation-name">${escapeHtml(v.variationName)}</span>
  1011→            ${v.status === 'failed' ? '<span class="failed-badge">Failed</span>' : ''}
  1012→          </div>
  1013→          ${v.promptDescription ? `<div class="variation-description">${escapeHtml(v.promptDescription)}</div>` : ''}
  1014→          ${v.status !== 'failed' ? `
  1015→            <div class="variation-player" data-index="${index}">
  1016→              <button class="play-btn" data-action="play" data-index="${index}" data-url="${v.previewUrl || ''}">Play</button>
  1017→              <span class="duration">${v.duration ? `${v.duration}s` : '--'}</span>
  1018→            </div>
  1019→            <button class="select-variation-btn btn btn-primary" data-index="${index}">Select This Version</button>
  1020→          ` : `<div class="variation-error">${escapeHtml(v.error || 'Generation failed')}</div>`}
  1021→        </div>
  1022→      `).join('')}
  1023→    </div>
  1024→  `;
  1025→
  1026→  container.querySelectorAll('.play-btn').forEach(btn => btn.addEventListener('click', handleVariationPlay));
  1027→  container.querySelectorAll('.select-variation-btn').forEach(btn => btn.addEventListener('click', handleVariationSelect));
  1028→}
  1029→
  1030→async function handleVariationPlay(event) {
  1031→  const btn = event.target;
  1032→  const index = parseInt(btn.dataset.index);
  1033→  const url = btn.dataset.url;
  1034→
  1035→  if (!url) { setMusicStatus('No preview available', 'warning'); return; }
  1036→
  1037→  musicState.variationPlayers.forEach((player, i) => {
  1038→    if (player && i !== index) {
  1039→      player.pause();
  1040→      const otherBtn = document.querySelector(`.play-btn[data-index="${i}"]`);
  1041→      if (otherBtn) otherBtn.textContent = 'Play';
  1042→    }
  1043→  });
  1044→
  1045→  if (!musicState.variationPlayers[index]) {
  1046→    musicState.variationPlayers[index] = new Audio();
  1047→    musicState.variationPlayers[index].addEventListener('ended', () => { btn.textContent = 'Play'; });
  1048→  }
  1049→
  1050→  const player = musicState.variationPlayers[index];
  1051→
  1052→  if (player.paused || player.src !== url) {
  1053→    player.src = url;
  1054→    try {
  1055→      await player.play();
  1056→      btn.textContent = 'Pause';
  1057→    } catch (error) {
  1058→      console.error('Play error:', error);
  1059→      setMusicStatus('Could not play preview', 'error');
  1060→    }
  1061→  } else {
  1062→    player.pause();
  1063→    btn.textContent = 'Play';
  1064→  }
  1065→}
  1066→
  1067→async function handleVariationSelect(event) {
  1068→  const btn = event.target;
  1069→  const index = parseInt(btn.dataset.index);
  1070→  const jobId = musicState.variationsJob?.jobId;
  1071→
  1072→  if (!jobId) { setMusicStatus('No variations job found', 'error'); return; }
  1073→
  1074→  try {
  1075→    document.querySelectorAll('.select-variation-btn').forEach(b => { b.disabled = true; });
  1076→    btn.textContent = 'Selecting...';
  1077→    setMusicStatus('Finalizing your selection...', 'info');
  1078→
  1079→    const result = await selectVariation(jobId, index);
  1080→    setMusicStatus(`Selected ${result.variationName}! Music added to library.`, 'success');
  1081→
  1082→    musicState.variationPlayers.forEach(player => { if (player) player.pause(); });
  1083→    hideVariationsPanel();
  1084→    loadMusicLibrary();
  1085→    updateMusicCreditsDisplay();
  1086→
  1087→  } catch (error) {
  1088→    console.error('Selection error:', error);
  1089→    setMusicStatus(`Error: ${error.message}`, 'error');
  1090→    document.querySelectorAll('.select-variation-btn').forEach(b => { b.disabled = false; });
  1091→    btn.textContent = 'Select This Version';
  1092→  }
  1093→}
  1094→
  1095→// ============================================
  1096→// JOBS LIST
  1097→// ============================================
  1098→
  1099→function addJobToList(jobId, options, isSceneAware = false) {
  1100→  const job = {
  1101→    jobId,
  1102→    status: 'pending',
  1103→    progress: 0,
  1104→    mood: options.mood,
  1105→    duration: options.duration,
  1106→    isSceneAware,
  1107→    createdAt: new Date().toISOString()
  1108→  };
  1109→  musicState.jobs.unshift(job);
  1110→  renderJobsList();
  1111→}
  1112→
  1113→function startPollingJob(jobId) {
  1114→  // Clear any existing polling
  1115→  if (musicState.pollInterval) clearInterval(musicState.pollInterval);
  1116→
  1117→  // Track which job we're now polling for (race condition fix)
  1118→  musicState.currentPollingJobId = jobId;
  1119→
  1120→  musicState.pollInterval = setInterval(async () => {
  1121→    // Race condition check: verify we're still polling for this job
  1122→    if (musicState.currentPollingJobId !== jobId) {
  1123→      return; // A new job started polling, ignore this callback
  1124→    }
  1125→
  1126→    try {
  1127→      const status = await getJobStatus(jobId);
  1128→
  1129→      // Double-check after async operation
  1130→      if (musicState.currentPollingJobId !== jobId) {
  1131→        return;
  1132→      }
  1133→
  1134→      const jobIndex = musicState.jobs.findIndex(j => j.jobId === jobId);
  1135→      if (jobIndex !== -1) {
  1136→        musicState.jobs[jobIndex] = { ...musicState.jobs[jobIndex], ...status };
  1137→        renderJobsList();
  1138→      }
  1139→
  1140→      if (status.status === 'completed' || status.status === 'failed') {
  1141→        clearInterval(musicState.pollInterval);
  1142→        musicState.pollInterval = null;
  1143→        musicState.currentPollingJobId = null;
  1144→        if (status.status === 'completed') {
  1145→          setMusicStatus('Music generation completed!', 'success');
  1146→          loadMusicLibrary();
  1147→        } else {
  1148→          setMusicStatus(`Generation failed: ${status.failedReason || 'Unknown error'}`, 'error');
  1149→        }
  1150→      }
  1151→    } catch (error) {
  1152→      console.error('Polling error:', error);
  1153→    }
  1154→  }, MUSIC_POLL_INTERVAL);
  1155→}
  1156→
  1157→function renderJobsList() {
  1158→  const container = musicElements.jobsList || document.getElementById('music-jobs-list');
  1159→  if (!container) return;
  1160→
  1161→  if (musicState.jobs.length === 0) {
  1162→    container.innerHTML = '<div class="music-empty">No generation jobs yet</div>';
  1163→    return;
  1164→  }
  1165→
  1166→  // SECURITY: Escape dynamic content to prevent XSS
  1167→  container.innerHTML = musicState.jobs.map(job => `
  1168→    <div class="music-job-item ${escapeHtml(job.status)}" data-job-id="${escapeHtml(job.jobId)}">
  1169→      <div class="music-job-status ${escapeHtml(job.status)}"></div>
  1170→      <div class="music-job-info">
  1171→        <span class="music-job-mood">${escapeHtml(job.mood || 'Music')}${job.isSceneAware ? ' Scene' : ''}</span>
  1172→        <span class="music-job-duration">${escapeHtml(job.duration)}s</span>
  1173→      </div>
  1174→      <div class="music-job-progress">
  1175→        ${job.status === 'completed' ? 'Done' : job.status === 'failed' ? 'Failed' : `${escapeHtml(job.progress)}%`}
  1176→      </div>
  1177→    </div>
  1178→  `).join('');
  1179→}
  1180→
  1181→// ============================================
  1182→// MUSIC LIBRARY
  1183→// ============================================
  1184→
  1185→async function loadMusicLibrary() {
  1186→  const container = musicElements.library || document.getElementById('music-library-list');
  1187→  if (!container) return;
  1188→
  1189→  try {
  1190→    container.innerHTML = '<div class="music-loading">Loading library...</div>';
  1191→    const library = await getMusicLibrary();
  1192→
  1193→    if (library.length === 0) {
  1194→      container.innerHTML = '<div class="music-empty">Your music library is empty</div>';
  1195→      return;
  1196→    }
  1197→
  1198→    // SECURITY: Escape dynamic content to prevent XSS
  1199→    container.innerHTML = library.map(item => {
  1200→      const safeJobId = escapeHtml(item.jobId);
  1201→      return `
  1202→        <div class="music-library-item" data-job-id="${safeJobId}">
  1203→          <div class="music-item-info">
  1204→            <div class="music-item-title">${escapeHtml(item.title || 'Untitled')}</div>
  1205→            <div class="music-item-meta">${escapeHtml(item.duration)}s - ${escapeHtml(item.mood || 'Music')}</div>
  1206→          </div>
  1207→          <div class="music-item-actions">
  1208→            <button class="music-action-btn btn btn-small" data-action="preview" data-job-id="${safeJobId}" title="Preview">Play</button>
  1209→            <button class="music-action-btn btn btn-small" data-action="align" data-job-id="${safeJobId}" title="Align to Video">Align</button>
  1210→            <button class="music-action-btn btn btn-small btn-secondary" data-action="delete" data-job-id="${safeJobId}" title="Delete">Del</button>
  1211→          </div>
  1212→        </div>
  1213→      `;
  1214→    }).join('');
  1215→
  1216→  } catch (error) {
  1217→    console.error('Library load error:', error);
  1218→    container.innerHTML = '<div class="music-error">Failed to load library</div>';
  1219→  }
  1220→}
  1221→
  1222→async function handleLibraryAction(event) {
  1223→  const btn = event.target;
  1224→  const action = btn.dataset.action;
  1225→  const jobId = btn.dataset.jobId;
  1226→
  1227→  switch (action) {
  1228→    case 'preview': await previewMusic(jobId); break;
  1229→    case 'align': await showAlignmentModal(jobId); break;
  1230→    case 'delete': await confirmDeleteMusic(jobId); break;
  1231→  }
  1232→}
  1233→
  1234→async function previewMusic(jobId) {
  1235→  try {
  1236→    setMusicStatus('Loading preview...', 'info');
  1237→    const music = await getMusicFile(jobId);
  1238→
  1239→    if (!music.previewUrl && !music.downloadUrl) {
  1240→      setMusicStatus('No preview available', 'warning');
  1241→      return;
  1242→    }
  1243→
  1244→    if (!musicState.audioPlayer) {
  1245→      musicState.audioPlayer = new Audio();
  1246→      musicState.audioPlayer.addEventListener('ended', () => { setMusicStatus('Preview finished', 'info'); });
  1247→    }
  1248→
  1249→    musicState.audioPlayer.src = music.previewUrl || music.downloadUrl;
  1250→    musicState.audioPlayer.play();
  1251→    setMusicStatus('Playing preview...', 'success');
  1252→
  1253→  } catch (error) {
  1254→    console.error('Preview error:', error);
  1255→    setMusicStatus(`Preview error: ${error.message}`, 'error');
  1256→  }
  1257→}
  1258→
  1259→async function confirmDeleteMusic(jobId) {
  1260→  if (!confirm('Are you sure you want to delete this music file?')) return;
  1261→
  1262→  try {
  1263→    setMusicStatus('Deleting...', 'info');
  1264→    await deleteMusicFile(jobId);
  1265→    setMusicStatus('Music deleted', 'success');
  1266→    loadMusicLibrary();
  1267→  } catch (error) {
  1268→    console.error('Delete error:', error);
  1269→    setMusicStatus(`Delete error: ${error.message}`, 'error');
  1270→  }
  1271→}
  1272→
  1273→// ============================================
  1274→// ALIGNMENT UI
  1275→// ============================================
  1276→
  1277→async function showAlignmentModal(jobId) {
  1278→  try {
  1279→    setMusicStatus('Loading alignment options...', 'info');
  1280→    const options = await getAlignmentOptions();
  1281→    musicState.alignmentOptions = options;
  1282→
  1283→    const sequenceDuration = await getSequenceDuration();
  1284→
  1285→    setMusicStatus('Analyzing beats...', 'info');
  1286→    const beatAnalysis = await analyzeBeatsRequest(jobId);
  1287→    musicState.beatAnalysis = beatAnalysis;
  1288→
  1289→    renderAlignmentModal(jobId, beatAnalysis, options, sequenceDuration);
  1290→    setMusicStatus('', 'info');
  1291→
  1292→  } catch (error) {
  1293→    console.error('Alignment modal error:', error);
  1294→    setMusicStatus(`Error: ${error.message}`, 'error');
  1295→  }
  1296→}
  1297→
  1298→function renderAlignmentModal(jobId, beatAnalysis, options, sequenceDuration) {
  1299→  const modal = document.getElementById('music-align-modal');
  1300→  if (!modal) {
  1301→    console.error('Alignment modal not found in DOM');
  1302→    return;
  1303→  }
  1304→
  1305→  // Populate Info
  1306→  const infoEl = document.getElementById('music-align-info');
  1307→  if (infoEl) {
  1308→    const defaultDuration = sequenceDuration ? Math.round(sequenceDuration) : Math.round(beatAnalysis.duration * 0.8);
  1309→
  1310→    // SECURITY: Escape dynamic content to prevent XSS
  1311→    let html = `
  1312→          <p><strong>Original Duration:</strong> ${escapeHtml(formatDuration(beatAnalysis.duration))}</p>
  1313→          <p><strong>Detected BPM:</strong> ${escapeHtml(beatAnalysis.bpm || 'Unknown')}</p>
  1314→          <p><strong>Beat Count:</strong> ${escapeHtml(beatAnalysis.beatCount)}</p>
  1315→      `;
  1316→    if (sequenceDuration) {
  1317→      html += `<p class="highlight"><strong>Sequence Duration:</strong> ${escapeHtml(formatDuration(sequenceDuration))}</p>`;
  1318→    }
  1319→    infoEl.innerHTML = html;
  1320→
  1321→    // Set default target duration
  1322→    const targetInput = document.getElementById('music-align-target');
  1323→    if (targetInput) {
  1324→      targetInput.value = defaultDuration;
  1325→      targetInput.max = Math.ceil(beatAnalysis.duration);
  1326→    }
  1327→  }
  1328→
  1329→  // Setup Fade Slider
  1330→  const fadeSlider = document.getElementById('music-fade-slider');
  1331→  const fadeValue = document.getElementById('music-fade-value');
  1332→  if (fadeSlider && fadeValue) {
  1333→    fadeSlider.min = options.fadeDuration.min;
  1334→    fadeSlider.max = options.fadeDuration.max;
  1335→    fadeSlider.value = options.fadeDuration.default;
  1336→    fadeValue.textContent = options.fadeDuration.default;
  1337→
  1338→    // Remove old listener to avoid duplicates if any
  1339→    const newSlider = fadeSlider.cloneNode(true);
  1340→    fadeSlider.parentNode.replaceChild(newSlider, fadeSlider);
  1341→
  1342→    newSlider.addEventListener('input', (e) => {
  1343→      if (fadeValue) fadeValue.textContent = e.target.value;
  1344→    });
  1345→  }
  1346→
  1347→  // Setup Match Sequence Button
  1348→  const matchBtn = document.getElementById('music-align-match-seq');
  1349→  if (matchBtn) {
  1350→    if (sequenceDuration) {
  1351→      matchBtn.style.display = 'inline-block';
  1352→      matchBtn.onclick = () => {
  1353→        const targetInput = document.getElementById('music-align-target');
  1354→        if (targetInput) targetInput.value = Math.round(sequenceDuration);
  1355→      };
  1356→    } else {
  1357→      matchBtn.style.display = 'none';
  1358→    }
  1359→  }
  1360→
  1361→  // Setup Confirm Button
  1362→  const confirmBtn = document.getElementById('music-align-btn');
  1363→  if (confirmBtn) {
  1364→    confirmBtn.onclick = (e) => handleAlignmentConfirm(e, jobId);
  1365→    confirmBtn.disabled = false;
  1366→    confirmBtn.textContent = 'Align & Trim';
  1367→  }
  1368→
  1369→  // Setup Close Handlers
  1370→  const closeBtn = document.getElementById('music-align-close');
  1371→  if (closeBtn) closeBtn.onclick = hideAlignmentModal;
  1372→
  1373→  // Show Modal
  1374→  modal.classList.remove('hidden');
  1375→}
  1376→
  1377→function hideAlignmentModal() {
  1378→  const modal = document.getElementById('music-align-modal');
  1379→  if (modal) {
  1380→    modal.classList.add('hidden');
  1381→  }
  1382→  musicState.beatAnalysis = null;
  1383→}
  1384→
  1385→async function handleAlignmentConfirm(event, jobId) {
  1386→  const btn = event.target;
  1387→  // jobId is passed directly now, or fallback to state? 
  1388→  // The original code used dataset.jobId. We passed it in the onclick handler closure.
  1389→
  1390→  const targetInput = document.getElementById('music-align-target');
  1391→  const fadeInput = document.getElementById('music-fade-slider'); // It's a slider now in HTML
  1392→  const beatAlignInput = document.getElementById('music-beat-align');
  1393→
  1394→  const targetDuration = parseFloat(targetInput?.value);
  1395→  const fadeDuration = parseFloat(fadeInput?.value);
  1396→  const beatAlign = beatAlignInput?.checked;
  1397→
  1398→  if (!targetDuration || targetDuration < 5) {
  1399→    setMusicStatus('Target duration must be at least 5 seconds', 'error');
  1400→    return;
  1401→  }
  1402→
  1403→  try {
  1404→    musicState.isAligning = true;
  1405→    btn.disabled = true;
  1406→    btn.textContent = 'Aligning...';
  1407→    setMusicStatus('Aligning music to video duration...', 'info');
  1408→
  1409→    const result = await alignMusicRequest(jobId, targetDuration, { fadeDuration, beatAlign });
  1410→    setMusicStatus(`Aligned! Cut at ${formatDuration(result.actualDuration)} (${result.wasAligned ? 'beat-aligned' : 'exact'})`, 'success');
  1411→    hideAlignmentModal();
  1412→
  1413→    if (result.downloadUrl) {
  1414→      showAlignedDownload(result);
  1415→    }
  1416→
  1417→  } catch (error) {
  1418→    console.error('Alignment error:', error);
  1419→    setMusicStatus(`Alignment failed: ${error.message}`, 'error');
  1420→    btn.disabled = false;
  1421→    btn.textContent = 'Align Music';
  1422→  } finally {
  1423→    musicState.isAligning = false;
  1424→  }
  1425→}
  1426→
  1427→function showAlignedDownload(result) {
  1428→  const notification = document.createElement('div');
  1429→  notification.className = 'alignment-notification';
  1430→
  1431→  // SECURITY: Escape URL to prevent XSS - use encodeURI for URL safety
  1432→  const safeUrl = escapeHtml(result.downloadUrl || '');
  1433→  const safeDuration = escapeHtml(formatDuration(result.actualDuration));
  1434→
  1435→  notification.innerHTML = `
  1436→    <div class="notification-content">
  1437→      <span class="notification-icon">Done</span>
  1438→      <div class="notification-text">
  1439→        <strong>Music Aligned!</strong>
  1440→        <span>Duration: ${safeDuration}</span>
  1441→      </div>
  1442→      <div class="notification-actions">
  1443→        <button class="btn btn-small" data-action="download">Download</button>
  1444→        <button class="btn-close" data-action="close">x</button>
  1445→      </div>
  1446→    </div>
  1447→  `;
  1448→
  1449→  const container = musicElements.section || document.getElementById('musicSection') || document.body;
  1450→  container.appendChild(notification);
  1451→
  1452→  // Store URL safely via JS property instead of data attribute
  1453→  const downloadBtn = notification.querySelector('[data-action="download"]');
  1454→  downloadBtn._downloadUrl = result.downloadUrl;
  1455→  downloadBtn.addEventListener('click', (e) => {
  1456→    window.open(e.target._downloadUrl, '_blank');
  1457→    notification.remove();
  1458→  });
  1459→
  1460→  notification.querySelector('[data-action="close"]').addEventListener('click', () => { notification.remove(); });
  1461→  setTimeout(() => notification.remove(), 30000);
  1462→}
  1463→
  1464→// ============================================
  1465→// TIMELINE UI
  1466→// ============================================
  1467→
  1468→function updateTimelineAvailability() {
  1469→  const btn = musicElements.timelineBtn || document.getElementById('music-timeline-btn');
  1470→  const transcript = getCurrentTranscript();
  1471→
  1472→  if (btn) {
  1473→    btn.disabled = !transcript || !transcript.segments || transcript.segments.length === 0;
  1474→    if (!transcript) {
  1475→      btn.title = 'Run transcription first to enable mood timeline';
  1476→    } else if (!transcript.segments || transcript.segments.length === 0) {
  1477→      btn.title = 'No transcript segments available';
  1478→    } else {
  1479→      btn.title = 'Generate per-chapter music with mood matching';
  1480→    }
  1481→  }
  1482→}
  1483→
  1484→async function showTimelineModal() {
  1485→  const transcript = getCurrentTranscript();
  1486→  if (!transcript) {
  1487→    setMusicStatus('Run transcription first to generate mood timeline', 'error');
  1488→    return;
  1489→  }
  1490→
  1491→  try {
  1492→    setMusicStatus('Loading timeline options...', 'info');
  1493→    const options = await getTimelineOptions();
  1494→    musicState.timelineOptions = options;
  1495→    const estimate = await estimateTimelineRequest(transcript);
  1496→    renderTimelineModal(transcript, options, estimate);
  1497→    setMusicStatus('', 'info');
  1498→  } catch (error) {
  1499→    console.error('Timeline modal error:', error);
  1500→    setMusicStatus(`Error: ${error.message}`, 'error');
  1501→  }
  1502→}
  1503→
  1504→function renderTimelineModal(transcript, options, estimate) {
  1505→  let modal = document.getElementById('timelineModal');
  1506→  if (!modal) {
  1507→    modal = document.createElement('div');
  1508→    modal.id = 'timelineModal';
  1509→    modal.className = 'modal-overlay';
  1510→    document.body.appendChild(modal);
  1511→  }
  1512→
  1513→  const defaults = options.defaults || {};
  1514→  const constraints = options.constraints || {};
  1515→
  1516→  modal.innerHTML = `
  1517→    <div class="modal-content timeline-modal">
  1518→      <div class="modal-header">
  1519→        <h3>Generate Mood Timeline</h3>
  1520→        <button class="modal-close-btn" id="timelineCloseBtn">x</button>
  1521→      </div>
  1522→      <div class="modal-body">
  1523→        <div class="timeline-info">
  1524→          <p>Video Duration: ${formatDuration(transcript.duration)}</p>
  1525→          <p>Transcript Segments: ${transcript.segments?.length || 0}</p>
  1526→          <p><strong>Estimated Chapters: ${estimate.estimatedChapters}</strong></p>
  1527→          <p><strong>Estimated Time: ${estimate.estimatedTimeDisplay}</strong></p>
  1528→        </div>
  1529→        <p>This will analyze your video transcript to detect chapters and their emotional tone, then generate unique music for each chapter with crossfades between them.</p>
  1530→        <p><strong>Cost:</strong> 3 music credits</p>
  1531→        <div class="timeline-form">
  1532→          <div class="form-group">
  1533→            <label for="timelineMaxChapters">Maximum Chapters</label>
  1534→            <input type="number" id="timelineMaxChapters" value="${defaults.maxChapters || 10}" min="1" max="20" step="1">
  1535→          </div>
  1536→          <div class="form-group">
  1537→            <label for="timelineMinLength">Minimum Chapter Length (seconds)</label>
  1538→            <input type="number" id="timelineMinLength" value="${defaults.minChapterLength || 60}" min="30" max="300" step="10">
  1539→          </div>
  1540→          <div class="form-group">
  1541→            <label for="timelineCrossfade">Crossfade Duration (seconds)</label>
  1542→            <input type="number" id="timelineCrossfade" value="${defaults.crossfadeDuration || 2}" min="${constraints.minCrossfadeDuration || 0.5}" max="${constraints.maxCrossfadeDuration || 5}" step="0.5">
  1543→          </div>
  1544→          <div class="form-group">
  1545→            <label for="timelineInstruments">Instrument Style</label>
  1546→            <select id="timelineInstruments">
  1547→              <option value="">Auto-detect from content</option>
  1548→              ${INSTRUMENT_OPTIONS.map(i => `<option value="${i.id}">${i.name} - ${i.description}</option>`).join('')}
  1549→            </select>
  1550→          </div>
  1551→          <div class="form-group">
  1552→            <label for="timelinePrompt">Additional Instructions (optional)</label>
  1553→            <textarea id="timelinePrompt" rows="2" placeholder="E.g., 'Modern electronic feel'"></textarea>
  1554→          </div>
  1555→        </div>
  1556→      </div>
  1557→      <div class="modal-footer">
  1558→        <button type="button" id="timelineCancelBtn" class="btn btn-secondary">Cancel</button>
  1559→        <button type="button" id="timelineConfirmBtn" class="btn btn-primary">Generate Timeline Music (3 credits)</button>
  1560→      </div>
  1561→    </div>
  1562→  `;
  1563→
  1564→  modal.style.display = 'flex';
  1565→
  1566→  document.getElementById('timelineCloseBtn').addEventListener('click', hideTimelineModal);
  1567→  document.getElementById('timelineCancelBtn').addEventListener('click', hideTimelineModal);
  1568→  document.getElementById('timelineConfirmBtn').addEventListener('click', handleTimelineConfirm);
  1569→  modal.addEventListener('click', (e) => { if (e.target === modal) hideTimelineModal(); });
  1570→}
  1571→
  1572→function hideTimelineModal() {
  1573→  const modal = document.getElementById('timelineModal');
  1574→  if (modal) { modal.style.display = 'none'; modal.innerHTML = ''; }
  1575→}
  1576→
  1577→async function handleTimelineConfirm() {
  1578→  const transcript = getCurrentTranscript();
  1579→  if (!transcript) {
  1580→    setMusicStatus('Transcript not available', 'error');
  1581→    return;
  1582→  }
  1583→
  1584→  const maxChapters = parseInt(document.getElementById('timelineMaxChapters').value) || 10;
  1585→  const minChapterLength = parseInt(document.getElementById('timelineMinLength').value) || 60;
  1586→  const crossfadeDuration = parseFloat(document.getElementById('timelineCrossfade').value) || 2;
  1587→  const instruments = document.getElementById('timelineInstruments').value;
  1588→  const prompt = document.getElementById('timelinePrompt').value || '';
  1589→
  1590→  const confirmBtn = document.getElementById('timelineConfirmBtn');
  1591→
  1592→  try {
  1593→    musicState.isGeneratingTimeline = true;
  1594→    confirmBtn.disabled = true;
  1595→    confirmBtn.textContent = 'Generating...';
  1596→
  1597→    setMusicStatus('Generating mood timeline... This may take several minutes.', 'info');
  1598→    hideTimelineModal();
  1599→
  1600→    const result = await generateTimelineRequest(transcript, {
  1601→      maxChapters,
  1602→      minChapterLength,
  1603→      crossfadeDuration,
  1604→      instruments: instruments ? [instruments] : [],
  1605→      prompt
  1606→    });
  1607→
  1608→    setMusicStatus(`Timeline generated! ${result.chapters?.length || 0} chapters, ${formatDuration(result.duration)}`, 'success');
  1609→
  1610→    if (result.audioUrl) {
  1611→      showTimelineResult(result);
  1612→    }
  1613→
  1614→    loadMusicLibrary();
  1615→    updateMusicCreditsDisplay();
  1616→
  1617→  } catch (error) {
  1618→    console.error('Timeline generation error:', error);
  1619→    setMusicStatus(`Timeline generation failed: ${error.message}`, 'error');
  1620→  } finally {
  1621→    musicState.isGeneratingTimeline = false;
  1622→    if (confirmBtn) {
  1623→      confirmBtn.disabled = false;
  1624→      confirmBtn.textContent = 'Generate Timeline Music (3 credits)';
  1625→    }
  1626→  }
  1627→}
  1628→
  1629→function showTimelineResult(result) {
  1630→  let resultPanel = document.getElementById('timelineResultPanel');
  1631→  if (!resultPanel) {
  1632→    resultPanel = document.createElement('div');
  1633→    resultPanel.id = 'timelineResultPanel';
  1634→    resultPanel.className = 'timeline-result-panel';
  1635→    const container = musicElements.section || document.getElementById('musicSection') || document.body;
  1636→    container.insertBefore(resultPanel, container.firstChild);
  1637→  }
  1638→
  1639→  // SECURITY: Escape dynamic content to prevent XSS
  1640→  const chapterList = (result.chapters || []).map((ch, i) => `
  1641→    <div class="timeline-chapter">
  1642→      <span class="chapter-num">${i + 1}</span>
  1643→      <span class="chapter-title">${escapeHtml(ch.title)}</span>
  1644→      <span class="chapter-mood">${escapeHtml(ch.mood || 'neutral')}</span>
  1645→    </div>
  1646→  `).join('');
  1647→
  1648→  resultPanel.innerHTML = `
  1649→    <div class="timeline-result-content">
  1650→      <div class="timeline-result-header">
  1651→        <span class="result-icon">Done</span>
  1652→        <span class="result-title">Mood Timeline Generated!</span>
  1653→        <button class="close-btn" data-action="close">x</button>
  1654→      </div>
  1655→      <div class="timeline-result-stats">
  1656→        <p>Duration: ${escapeHtml(formatDuration(result.duration))}</p>
  1657→        <p>Chapters: ${escapeHtml(result.chapters?.length || 0)}</p>
  1658→        <p>Credits Used: ${escapeHtml(result.creditCost || 3)}</p>
  1659→      </div>
  1660→      <div class="timeline-chapters"><h4>Chapters</h4>${chapterList}</div>
  1661→      <div class="timeline-result-actions">
  1662→        <button class="btn btn-primary" data-action="download" data-url="${escapeHtml(result.audioUrl)}">Download</button>
  1663→      </div>
  1664→    </div>
  1665→  `;
  1666→
  1667→  resultPanel.style.display = 'block';
  1668→
  1669→  resultPanel.querySelector('[data-action="close"]').addEventListener('click', () => { resultPanel.style.display = 'none'; });
  1670→  resultPanel.querySelector('[data-action="download"]').addEventListener('click', (e) => {
  1671→    window.open(e.target.dataset.url, '_blank');
  1672→  });
  1673→
  1674→  setTimeout(() => { if (resultPanel) resultPanel.style.display = 'none'; }, 60000);
  1675→}
  1676→
  1677→// ============================================
  1678→// UTILITY FUNCTIONS
  1679→// ============================================
  1680→
  1681→function formatDuration(seconds) {
  1682→  if (!seconds) return '0:00';
  1683→  const mins = Math.floor(seconds / 60);
  1684→  const secs = Math.round(seconds % 60);
  1685→  return `${mins}:${secs.toString().padStart(2, '0')}`;
  1686→}
  1687→
  1688→async function updateMusicCreditsDisplay() {
  1689→  const badge = musicElements.creditsBadge || document.getElementById('music-credits-badge');
  1690→  if (!badge) return;
  1691→
  1692→  try {
  1693→    const credits = await getMusicCredits();
  1694→    badge.textContent = `${credits.remaining}/${credits.total} songs`;
  1695→    badge.className = 'music-credits-badge';
  1696→    if (credits.remaining === 0) badge.classList.add('empty');
  1697→    else if (credits.remaining <= 2) badge.classList.add('low');
  1698→  } catch (error) {
  1699→    badge.textContent = 'Credits: --';
  1700→  }
  1701→}
  1702→
  1703→function setMusicStatus(message, type = 'info') {
  1704→  const status = musicElements.status || document.getElementById('music-status');
  1705→  if (!status) return;
  1706→
  1707→  status.textContent = message;
  1708→  status.className = `music-status music-status-${type}`;
  1709→  status.style.display = 'block';
  1710→
  1711→  if (type !== 'error') {
  1712→    setTimeout(() => { status.style.display = 'none'; }, 5000);
  1713→  }
  1714→}
  1715→
  1716→function escapeHtml(str) {
  1717→  if (!str) return '';
  1718→  const div = document.createElement('div');
  1719→  div.textContent = str;
  1720→  return div.innerHTML;
  1721→}
  1722→
  1723→// ============================================
  1724→// EXPORTS
  1725→// ============================================
  1726→
  1727→window.musicModule = {
  1728→  init: initMusicModule,
  1729→  identifySong,
  1730→  generateMusicRequest,
  1731→  getMusicLibrary,
  1732→  getMusicCredits,
  1733→  loadMusicLibrary,
  1734→  previewMusic,
  1735→  generateVariationsRequest,
  1736→  getVariationsStatus,
  1737→  selectVariation,
  1738→  handleGenerateVariations,
  1739→  showVariationsPanel,
  1740→  hideVariationsPanel,
  1741→  generateSceneAwareRequest,
  1742→  getCurrentTranscriptSegments,
  1743→  handleSceneAwareToggle,
  1744→  updateSceneAwareAvailability,
  1745→  alignMusicRequest,
  1746→  analyzeBeatsRequest,
  1747→  getAlignmentOptions,
  1748→  showAlignmentModal,
  1749→  hideAlignmentModal,
  1750→  formatDuration,
  1751→  getSequenceDuration,
  1752→  generateTimelineRequest,
  1753→  getTimelineOptions,
  1754→  estimateTimelineRequest,
  1755→  getCurrentTranscript,
  1756→  showTimelineModal,
  1757→  hideTimelineModal,
  1758→  updateTimelineAvailability,
  1759→  MOOD_OPTIONS,
  1760→  INSTRUMENT_OPTIONS,
  1761→  DURATION_OPTIONS
  1762→};
  1763→
  1764→window.initMusicModule = initMusicModule;
  1765→

</system-reminder>
