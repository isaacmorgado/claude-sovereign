     1→/**
     2→ * SPLICE CEP Music Module
     3→ * AI-powered music generation for video projects
     4→ */
     5→
     6→// ============================================
     7→// STATE
     8→// ============================================
     9→const musicState = {
    10→  jobs: [],
    11→  selectedJob: null,
    12→  isIdentifying: false,
    13→  isGenerating: false,
    14→  identifiedSong: null,
    15→  audioPlayer: null,
    16→  pollInterval: null,
    17→  variationsJob: null,
    18→  variationsPollingInterval: null,
    19→  selectedVariationIndex: null,
    20→  variationPlayers: [null, null, null],
    21→  sceneAwareEnabled: false,
    22→  isAligning: false,
    23→  alignmentOptions: null,
    24→  beatAnalysis: null,
    25→  isGeneratingTimeline: false,
    26→  timelineOptions: null
    27→};
    28→
    29→// ============================================
    30→// CONSTANTS
    31→// ============================================
    32→const MUSIC_POLL_INTERVAL = 5000;
    33→
    34→const MOOD_OPTIONS = [
    35→  { id: 'energetic', name: 'Energetic', description: 'Upbeat, high energy' },
    36→  { id: 'relaxed', name: 'Relaxed', description: 'Calm, peaceful' },
    37→  { id: 'melancholic', name: 'Melancholic', description: 'Sad, emotional' },
    38→  { id: 'intense', name: 'Intense', description: 'Powerful, dramatic' },
    39→  { id: 'happy', name: 'Happy', description: 'Joyful, cheerful' },
    40→  { id: 'mysterious', name: 'Mysterious', description: 'Dark, suspenseful' },
    41→  { id: 'romantic', name: 'Romantic', description: 'Warm, intimate' },
    42→  { id: 'epic', name: 'Epic', description: 'Grand, orchestral' },
    43→  { id: 'chill', name: 'Chill', description: 'Lo-fi, laid-back' },
    44→  { id: 'neutral', name: 'Neutral', description: 'Balanced, versatile' }
    45→];
    46→
    47→const INSTRUMENT_OPTIONS = [
    48→  { id: 'acoustic', name: 'Acoustic', description: 'Guitar, piano, strings' },
    49→  { id: 'electronic', name: 'Electronic', description: 'Synths, beats' },
    50→  { id: 'rock', name: 'Rock', description: 'Electric guitars, drums' },
    51→  { id: 'orchestral', name: 'Orchestral', description: 'Strings, brass, woodwinds' },
    52→  { id: 'minimal', name: 'Minimal', description: 'Piano, ambient' },
    53→  { id: 'hiphop', name: 'Hip-Hop', description: '808s, trap drums' }
    54→];
    55→
    56→const DURATION_OPTIONS = [
    57→  { value: 30, label: '30 seconds' },
    58→  { value: 60, label: '1 minute' },
    59→  { value: 90, label: '1.5 minutes' },
    60→  { value: 120, label: '2 minutes' },
    61→  { value: 180, label: '3 minutes' }
    62→];
    63→
    64→// ============================================
    65→// DOM ELEMENT CACHE
    66→// ============================================
    67→const musicElements = {
    68→  section: null,
    69→  panel: null,
    70→  status: null,
    71→  creditsBadge: null,
    72→  youtubeUrl: null,
    73→  identifyBtn: null,
    74→  referenceDisplay: null,
    75→  moodSelector: null,
    76→  instrumentSelector: null,
    77→  durationSlider: null,
    78→  durationValue: null,
    79→  promptInput: null,
    80→  generateBtn: null,
    81→  variationsCheckbox: null,
    82→  sceneAwareToggle: null,
    83→  timelineBtn: null,
    84→  jobsList: null,
    85→  library: null,
    86→  variationsPanel: null,
    87→  variationsList: null,
    88→  progressContainer: null,
    89→  progressBar: null,
    90→  progressText: null,
    91→  tabGenerate: null,
    92→  tabIdentify: null,
    93→  tabLibrary: null
    94→};
    95→
    96→function cacheMusicElements() {
    97→  musicElements.section = document.getElementById('musicSection');
    98→  musicElements.panel = document.getElementById('music-panel');
    99→  musicElements.status = document.getElementById('music-status');
   100→  musicElements.creditsBadge = document.getElementById('music-credits-badge');
   101→  musicElements.youtubeUrl = document.getElementById('music-youtube-url');
   102→  musicElements.identifyBtn = document.getElementById('music-identify-btn');
   103→  musicElements.referenceDisplay = document.getElementById('music-identify-result');
   104→  musicElements.moodSelector = document.getElementById('music-mood-selector');
   105→  musicElements.instrumentSelector = document.getElementById('music-instrument-selector');
   106→  musicElements.durationSlider = document.getElementById('music-duration-slider');
   107→  musicElements.durationValue = document.getElementById('music-duration-value');
   108→  musicElements.promptInput = document.getElementById('music-custom-prompt');
   109→  musicElements.generateBtn = document.getElementById('music-generate-btn');
   110→  musicElements.variationsCheckbox = document.getElementById('music-variations');
   111→  musicElements.sceneAwareToggle = document.getElementById('music-scene-aware');
   112→  musicElements.timelineBtn = document.getElementById('music-timeline-btn');
   113→  musicElements.jobsList = document.getElementById('music-jobs-list');
   114→  musicElements.library = document.getElementById('music-library-list');
   115→  musicElements.variationsPanel = document.getElementById('music-variations-panel');
   116→  musicElements.variationsList = document.getElementById('music-variations-list');
   117→  musicElements.progressContainer = document.getElementById('music-progress');
   118→  musicElements.progressBar = document.getElementById('music-progress-bar');
   119→  musicElements.progressText = document.getElementById('music-progress-text');
   120→
   121→  // Tab elements
   122→  musicElements.tabGenerate = document.getElementById('music-tab-generate');
   123→  musicElements.tabIdentify = document.getElementById('music-tab-identify');
   124→  musicElements.tabLibrary = document.getElementById('music-tab-library');
   125→}
   126→
   127→// ============================================
   128→// API FUNCTIONS
   129→// ============================================
   130→
   131→async function identifySong(youtubeUrl) {
   132→  const backendUrl = getBackendUrl();
   133→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   134→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   135→
   136→  const response = await fetchFn(`${backendUrl}/music/identify`, {
   137→    method: 'POST',
   138→    headers: { ...headers, 'Content-Type': 'application/json' },
   139→    body: JSON.stringify({ youtubeUrl })
   140→  }, 90000);
   141→
   142→  if (!response.ok) {
   143→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   144→    throw new Error(error.message || 'Failed to identify song');
   145→  }
   146→  return response.json();
   147→}
   148→
   149→async function generateMusicRequest(options) {
   150→  const backendUrl = getBackendUrl();
   151→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   152→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   153→
   154→  const response = await fetchFn(`${backendUrl}/music/generate`, {
   155→    method: 'POST',
   156→    headers: { ...headers, 'Content-Type': 'application/json' },
   157→    body: JSON.stringify(options)
   158→  });
   159→
   160→  if (!response.ok) {
   161→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   162→    throw new Error(error.message || 'Failed to start music generation');
   163→  }
   164→  return response.json();
   165→}
   166→
   167→async function getJobStatus(jobId) {
   168→  const backendUrl = getBackendUrl();
   169→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   170→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   171→
   172→  const response = await fetchFn(`${backendUrl}/music/status/${jobId}`, { headers });
   173→
   174→  if (!response.ok) {
   175→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   176→    throw new Error(error.message || 'Failed to get job status');
   177→  }
   178→  return response.json();
   179→}
   180→
   181→async function getMusicLibrary() {
   182→  const backendUrl = getBackendUrl();
   183→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   184→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   185→
   186→  const response = await fetchFn(`${backendUrl}/music/library`, { headers });
   187→
   188→  if (!response.ok) {
   189→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   190→    throw new Error(error.message || 'Failed to load music library');
   191→  }
   192→  return response.json();
   193→}
   194→
   195→async function getMusicFile(jobId) {
   196→  const backendUrl = getBackendUrl();
   197→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   198→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   199→
   200→  const response = await fetchFn(`${backendUrl}/music/${jobId}`, { headers });
   201→
   202→  if (!response.ok) {
   203→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   204→    throw new Error(error.message || 'Failed to get music file');
   205→  }
   206→  return response.json();
   207→}
   208→
   209→async function deleteMusicFile(jobId) {
   210→  const backendUrl = getBackendUrl();
   211→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   212→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   213→
   214→  const response = await fetchFn(`${backendUrl}/music/${jobId}`, { method: 'DELETE', headers });
   215→
   216→  if (!response.ok) {
   217→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   218→    throw new Error(error.message || 'Failed to delete music');
   219→  }
   220→  return response.json();
   221→}
   222→
   223→async function getMusicCredits() {
   224→  const backendUrl = getBackendUrl();
   225→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   226→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   227→
   228→  const response = await fetchFn(`${backendUrl}/music/credits`, { headers });
   229→
   230→  if (!response.ok) {
   231→    return { remaining: 0, total: 0 };
   232→  }
   233→  return response.json();
   234→}
   235→
   236→// ============================================
   237→// VARIATIONS API FUNCTIONS
   238→// ============================================
   239→
   240→async function generateVariationsRequest(options) {
   241→  const backendUrl = getBackendUrl();
   242→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   243→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   244→
   245→  const response = await fetchFn(`${backendUrl}/music/generate-variations`, {
   246→    method: 'POST',
   247→    headers: { ...headers, 'Content-Type': 'application/json' },
   248→    body: JSON.stringify(options)
   249→  });
   250→
   251→  if (!response.ok) {
   252→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   253→    throw new Error(error.message || 'Failed to start variations generation');
   254→  }
   255→  return response.json();
   256→}
   257→
   258→async function getVariationsStatus(jobId) {
   259→  const backendUrl = getBackendUrl();
   260→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   261→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   262→
   263→  const response = await fetchFn(`${backendUrl}/music/variations/status/${jobId}`, { headers });
   264→
   265→  if (!response.ok) {
   266→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   267→    throw new Error(error.message || 'Failed to get variations status');
   268→  }
   269→  return response.json();
   270→}
   271→
   272→async function selectVariation(jobId, variationIndex) {
   273→  const backendUrl = getBackendUrl();
   274→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   275→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   276→
   277→  const response = await fetchFn(`${backendUrl}/music/variations/${jobId}/select`, {
   278→    method: 'POST',
   279→    headers: { ...headers, 'Content-Type': 'application/json' },
   280→    body: JSON.stringify({ variationIndex })
   281→  });
   282→
   283→  if (!response.ok) {
   284→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   285→    throw new Error(error.message || 'Failed to select variation');
   286→  }
   287→  return response.json();
   288→}
   289→
   290→// ============================================
   291→// SCENE-AWARE API FUNCTIONS
   292→// ============================================
   293→
   294→async function generateSceneAwareRequest(options, segments) {
   295→  const backendUrl = getBackendUrl();
   296→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   297→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   298→
   299→  const response = await fetchFn(`${backendUrl}/music/generate-scene-aware`, {
   300→    method: 'POST',
   301→    headers: { ...headers, 'Content-Type': 'application/json' },
   302→    body: JSON.stringify({ ...options, segments })
   303→  });
   304→
   305→  if (!response.ok) {
   306→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   307→    throw new Error(error.message || 'Failed to start scene-aware music generation');
   308→  }
   309→  return response.json();
   310→}
   311→
   312→function getCurrentTranscriptSegments() {
   313→  if (window.currentTranscript && window.currentTranscript.segments) {
   314→    return window.currentTranscript.segments;
   315→  }
   316→  return null;
   317→}
   318→
   319→// ============================================
   320→// ALIGNMENT API FUNCTIONS
   321→// ============================================
   322→
   323→async function alignMusicRequest(jobId, targetDuration, options = {}) {
   324→  const backendUrl = getBackendUrl();
   325→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   326→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   327→
   328→  const response = await fetchFn(`${backendUrl}/music/align`, {
   329→    method: 'POST',
   330→    headers: { ...headers, 'Content-Type': 'application/json' },
   331→    body: JSON.stringify({
   332→      jobId,
   333→      targetDuration,
   334→      fadeDuration: options.fadeDuration,
   335→      beatAlign: options.beatAlign !== false,
   336→      searchWindow: options.searchWindow
   337→    })
   338→  }, 120000);
   339→
   340→  if (!response.ok) {
   341→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   342→    throw new Error(error.message || 'Failed to align music');
   343→  }
   344→  return response.json();
   345→}
   346→
   347→async function analyzeBeatsRequest(jobId) {
   348→  const backendUrl = getBackendUrl();
   349→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   350→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   351→
   352→  const response = await fetchFn(`${backendUrl}/music/analyze-beats`, {
   353→    method: 'POST',
   354→    headers: { ...headers, 'Content-Type': 'application/json' },
   355→    body: JSON.stringify({ jobId })
   356→  }, 60000);
   357→
   358→  if (!response.ok) {
   359→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   360→    throw new Error(error.message || 'Failed to analyze beats');
   361→  }
   362→  return response.json();
   363→}
   364→
   365→async function getAlignmentOptions() {
   366→  const backendUrl = getBackendUrl();
   367→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   368→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   369→
   370→  const response = await fetchFn(`${backendUrl}/music/alignment-options`, { headers });
   371→
   372→  if (!response.ok) {
   373→    return {
   374→      fadeDuration: { default: 2, min: 0.5, max: 5 },
   375→      searchWindow: { default: 3, min: 0.5, max: 10 },
   376→      minAudioDuration: 5
   377→    };
   378→  }
   379→  return response.json();
   380→}
   381→
   382→// ============================================
   383→// TIMELINE API FUNCTIONS
   384→// ============================================
   385→
   386→async function generateTimelineRequest(transcript, options = {}) {
   387→  const backendUrl = getBackendUrl();
   388→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   389→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   390→
   391→  const response = await fetchFn(`${backendUrl}/music/generate-timeline`, {
   392→    method: 'POST',
   393→    headers: { ...headers, 'Content-Type': 'application/json' },
   394→    body: JSON.stringify({
   395→      transcript,
   396→      maxChapters: options.maxChapters || 10,
   397→      minChapterLength: options.minChapterLength || 60,
   398→      crossfadeDuration: options.crossfadeDuration || 2,
   399→      instruments: options.instruments || [],
   400→      prompt: options.prompt || ''
   401→    })
   402→  }, 600000);
   403→
   404→  if (!response.ok) {
   405→    const error = typeof parseErrorResponse === 'function' ? await parseErrorResponse(response) : await response.json();
   406→    throw new Error(error.message || 'Failed to generate timeline music');
   407→  }
   408→  return response.json();
   409→}
   410→
   411→async function getTimelineOptions() {
   412→  const backendUrl = getBackendUrl();
   413→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   414→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   415→
   416→  const response = await fetchFn(`${backendUrl}/music/timeline-options`, { headers });
   417→
   418→  if (!response.ok) {
   419→    return {
   420→      defaults: { maxChapters: 10, minChapterLength: 60, crossfadeDuration: 2 },
   421→      constraints: { minCrossfadeDuration: 0.5, maxCrossfadeDuration: 5 }
   422→    };
   423→  }
   424→  return response.json();
   425→}
   426→
   427→async function estimateTimelineRequest(transcript, options = {}) {
   428→  const backendUrl = getBackendUrl();
   429→  const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };
   430→  const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;
   431→
   432→  const response = await fetchFn(`${backendUrl}/music/timeline-estimate`, {
   433→    method: 'POST',
   434→    headers: { ...headers, 'Content-Type': 'application/json' },
   435→    body: JSON.stringify({
   436→      transcript,
   437→      maxChapters: options.maxChapters,
   438→      minChapterLength: options.minChapterLength
   439→    })
   440→  });
   441→
   442→  if (!response.ok) {
   443→    return { estimatedChapters: 3, estimatedMinutes: 12, estimatedTimeDisplay: '10-15 minutes' };
   444→  }
   445→  return response.json();
   446→}
   447→
   448→function getCurrentTranscript() {
   449→  if (window.currentTranscript) {
   450→    return window.currentTranscript;
   451→  }
   452→  return null;
   453→}
   454→
   455→async function getSequenceDuration() {
   456→  try {
   457→    const result = await jsx.call('getSequenceDuration');
   458→    if (result && result.duration) {
   459→      return result.duration;
   460→    }
   461→  } catch (error) {
   462→    console.error('Could not get sequence duration:', error);
   463→  }
   464→  return null;
   465→}
   466→
   467→// ============================================
   468→// INITIALIZATION
   469→// ============================================
   470→
   471→function initMusicModule() {
   472→  console.log('[SPLICE] Initializing music module');
   473→
   474→  cacheMusicElements();
   475→  setupMusicEventListeners();
   476→  setupTabSwitching();
   477→  populateMoodSelector();
   478→  populateInstrumentSelector();
   479→  setupDurationSlider();
   480→  loadMusicLibrary();
   481→  updateMusicCreditsDisplay();
   482→
   483→  console.log('[SPLICE] Music module initialized');
   484→}
   485→
   486→function setupTabSwitching() {
   487→  const tabs = document.querySelectorAll('.music-tab');
   488→  const contents = {
   489→    generate: musicElements.tabGenerate || document.getElementById('music-tab-generate'),
   490→    identify: musicElements.tabIdentify || document.getElementById('music-tab-identify'),
   491→    library: musicElements.tabLibrary || document.getElementById('music-tab-library')
   492→  };
   493→
   494→  tabs.forEach(tab => {
   495→    tab.addEventListener('click', () => {
   496→      const tabName = tab.dataset.tab;
   497→
   498→      // Update tab buttons
   499→      tabs.forEach(t => t.classList.remove('active'));
   500→      tab.classList.add('active');
   501→
   502→      // Update tab content
   503→      Object.entries(contents).forEach(([name, content]) => {
   504→        if (content) {
   505→          content.classList.toggle('active', name === tabName);
   506→        }
   507→      });
   508→
   509→      // Refresh library when switching to library tab
   510→      if (tabName === 'library') {
   511→        loadMusicLibrary();
   512→      }
   513→    });
   514→  });
   515→}
   516→
   517→function setupMusicEventListeners() {
   518→  document.addEventListener('input', (e) => {
   519→    if (e.target.id === 'music-youtube-url') {
   520→      handleYoutubeUrlChange();
   521→    }
   522→  });
   523→
   524→  document.addEventListener('click', (e) => {
   525→    const id = e.target.id;
   526→
   527→    switch (id) {
   528→      case 'music-identify-btn':
   529→        handleIdentifySong();
   530→        break;
   531→      case 'music-generate-btn':
   532→        handleGenerateMusic();
   533→        break;
   534→      case 'musicClearRefBtn':
   535→        handleClearReference();
   536→        break;
   537→      case 'music-timeline-btn':
   538→        showTimelineModal();
   539→        break;
   540→    }
   541→
   542→    // Library action buttons
   543→    if (e.target.classList.contains('music-action-btn')) {
   544→      handleLibraryAction(e);
   545→    }
   546→  });
   547→
   548→  document.addEventListener('change', (e) => {
   549→    if (e.target.id === 'music-scene-aware') {
   550→      handleSceneAwareToggle();
   551→    }
   552→    if (e.target.id === 'music-variations') {
   553→      // Handle variations checkbox - will be checked in handleGenerateMusic
   554→    }
   555→  });
   556→
   557→  updateSceneAwareAvailability();
   558→  updateTimelineAvailability();
   559→}
   560→
   561→function handleSceneAwareToggle() {
   562→  const toggle = musicElements.sceneAwareToggle || document.getElementById('music-scene-aware');
   563→  musicState.sceneAwareEnabled = toggle?.checked || false;
   564→
   565→  const indicator = document.getElementById('sceneAwareIndicator');
   566→  if (indicator) {
   567→    indicator.style.display = musicState.sceneAwareEnabled ? 'block' : 'none';
   568→  }
   569→
   570→  if (musicState.sceneAwareEnabled) {
   571→    const segments = getCurrentTranscriptSegments();
   572→    if (segments) {
   573→      setMusicStatus(`Scene-aware enabled: ${segments.length} segments detected`, 'info');
   574→    } else {
   575→      setMusicStatus('Scene-aware enabled: Run transcription first for best results', 'warning');
   576→    }
   577→  }
   578→}
   579→
   580→function updateSceneAwareAvailability() {
   581→  const toggle = musicElements.sceneAwareToggle || document.getElementById('music-scene-aware');
   582→  const segments = getCurrentTranscriptSegments();
   583→
   584→  if (toggle) {
   585→    toggle.disabled = !segments;
   586→    toggle.parentElement?.classList.toggle('disabled', !segments);
   587→  }
   588→}
   589→
   590→// ============================================
   591→// UI POPULATION (Card-Based)
   592→// ============================================
   593→
   594→function populateMoodSelector() {
   595→  const container = musicElements.moodSelector || document.getElementById('music-mood-selector');
   596→  if (!container) return;
   597→
   598→  container.innerHTML = MOOD_OPTIONS.map(mood =>
   599→    `<div class="music-mood-card ${mood.id === 'neutral' ? 'selected' : ''}" data-mood="${mood.id}" title="${mood.description}">
   600→      <span class="mood-name">${mood.name}</span>
   601→    </div>`
   602→  ).join('');
   603→
   604→  // Add click handlers
   605→  container.querySelectorAll('.music-mood-card').forEach(card => {
   606→    card.addEventListener('click', () => {
   607→      container.querySelectorAll('.music-mood-card').forEach(c => c.classList.remove('selected'));
   608→      card.classList.add('selected');
   609→    });
   610→  });
   611→}
   612→
   613→function populateInstrumentSelector() {
   614→  const container = musicElements.instrumentSelector || document.getElementById('music-instrument-selector');
   615→  if (!container) return;
   616→
   617→  container.innerHTML = INSTRUMENT_OPTIONS.map(inst =>
   618→    `<div class="music-instrument-card ${inst.id === 'acoustic' ? 'selected' : ''}" data-instrument="${inst.id}" title="${inst.description}">
   619→      <span class="instrument-name">${inst.name}</span>
   620→    </div>`
   621→  ).join('');
   622→
   623→  // Add click handlers
   624→  container.querySelectorAll('.music-instrument-card').forEach(card => {
   625→    card.addEventListener('click', () => {
   626→      container.querySelectorAll('.music-instrument-card').forEach(c => c.classList.remove('selected'));
   627→      card.classList.add('selected');
   628→    });
   629→  });
   630→}
   631→
   632→function setupDurationSlider() {
   633→  const slider = musicElements.durationSlider || document.getElementById('music-duration-slider');
   634→  const valueDisplay = musicElements.durationValue || document.getElementById('music-duration-value');
   635→  if (!slider) return;
   636→
   637→  slider.addEventListener('input', () => {
   638→    if (valueDisplay) valueDisplay.textContent = slider.value;
   639→  });
   640→}
   641→
   642→function getSelectedMood() {
   643→  const container = musicElements.moodSelector || document.getElementById('music-mood-selector');
   644→  const selected = container?.querySelector('.music-mood-card.selected');
   645→  return selected?.dataset.mood || 'neutral';
   646→}
   647→
   648→function getSelectedInstrument() {
   649→  const container = musicElements.instrumentSelector || document.getElementById('music-instrument-selector');
   650→  const selected = container?.querySelector('.music-instrument-card.selected');
   651→  return selected?.dataset.instrument || 'acoustic';
   652→}
   653→
   654→function getSelectedDuration() {
   655→  const slider = musicElements.durationSlider || document.getElementById('music-duration-slider');
   656→  return parseInt(slider?.value) || 60;
   657→}
   658→
   659→// ============================================
   660→// YOUTUBE URL HANDLING
   661→// ============================================
   662→
   663→function handleYoutubeUrlChange() {
   664→  const urlInput = musicElements.youtubeUrl || document.getElementById('music-youtube-url');
   665→  const identifyBtn = musicElements.identifyBtn || document.getElementById('music-identify-btn');
   666→
   667→  if (!urlInput || !identifyBtn) return;
   668→
   669→  const url = urlInput.value.trim();
   670→  const isValidUrl = isValidYouTubeUrl(url);
   671→  identifyBtn.disabled = !isValidUrl;
   672→
   673→  if (musicState.identifiedSong) {
   674→    handleClearReference();
   675→  }
   676→}
   677→
   678→function isValidYouTubeUrl(url) {
   679→  if (!url) return false;
   680→  const patterns = [
   681→    /youtube\.com\/watch\?v=[\w-]{11}/,
   682→    /youtu\.be\/[\w-]{11}/,
   683→    /youtube\.com\/embed\/[\w-]{11}/
   684→  ];
   685→  return patterns.some(p => p.test(url));
   686→}
   687→
   688→async function handleIdentifySong() {
   689→  const urlInput = musicElements.youtubeUrl || document.getElementById('music-youtube-url');
   690→  const identifyBtn = musicElements.identifyBtn || document.getElementById('music-identify-btn');
   691→
   692→  if (!urlInput || !identifyBtn) return;
   693→
   694→  const url = urlInput.value.trim();
   695→  if (!isValidYouTubeUrl(url)) {
   696→    setMusicStatus('Invalid YouTube URL', 'error');
   697→    return;
   698→  }
   699→
   700→  try {
   701→    musicState.isIdentifying = true;
   702→    identifyBtn.disabled = true;
   703→    identifyBtn.textContent = 'Identifying...';
   704→    setMusicStatus('Identifying song...', 'info');
   705→
   706→    const result = await identifySong(url);
   707→
   708→    if (result.identified) {
   709→      musicState.identifiedSong = result;
   710→      displayIdentifiedSong(result);
   711→      setMusicStatus(`Identified: ${result.title} by ${result.artist}`, 'success');
   712→    } else {
   713→      setMusicStatus('Could not identify song. You can still generate music.', 'warning');
   714→    }
   715→
   716→  } catch (error) {
   717→    console.error('Identification error:', error);
   718→    setMusicStatus(`Error: ${error.message}`, 'error');
   719→  } finally {
   720→    musicState.isIdentifying = false;
   721→    identifyBtn.disabled = false;
   722→    identifyBtn.textContent = 'Identify';
   723→  }
   724→}
   725→
   726→function displayIdentifiedSong(song) {
   727→  const display = musicElements.referenceDisplay || document.getElementById('music-identify-result');
   728→  if (!display) return;
   729→
   730→  const details = [];
   731→  if (song.bpm) details.push(`${song.bpm} BPM`);
   732→  if (song.key) details.push(song.key);
   733→  if (song.mood) details.push(song.mood);
   734→
   735→  display.innerHTML = `
   736→    <div class="music-reference-card">
   737→      <div class="music-ref-title">${escapeHtml(song.title)}</div>
   738→      <div class="music-ref-artist">${escapeHtml(song.artist)}</div>
   739→      <div class="music-ref-details">${details.join(' - ')}</div>
   740→      <button id="musicClearRefBtn" class="music-clear-ref-btn" title="Clear reference">x</button>
   741→    </div>
   742→  `;
   743→  display.style.display = 'block';
   744→}
   745→
   746→function handleClearReference() {
   747→  musicState.identifiedSong = null;
   748→
   749→  const display = musicElements.referenceDisplay || document.getElementById('music-identify-result');
   750→  if (display) {
   751→    display.innerHTML = '';
   752→    display.style.display = 'none';
   753→  }
   754→
   755→  const urlInput = musicElements.youtubeUrl || document.getElementById('music-youtube-url');
   756→  if (urlInput) urlInput.value = '';
   757→
   758→  const identifyBtn = musicElements.identifyBtn || document.getElementById('music-identify-btn');
   759→  if (identifyBtn) identifyBtn.disabled = true;
   760→}
   761→
   762→// ============================================
   763→// MUSIC GENERATION
   764→// ============================================
   765→
   766→async function handleGenerateMusic() {
   767→  const generateBtn = musicElements.generateBtn || document.getElementById('music-generate-btn');
   768→  const promptInput = musicElements.promptInput || document.getElementById('music-custom-prompt');
   769→  const variationsCheckbox = musicElements.variationsCheckbox || document.getElementById('music-variations');
   770→
   771→  if (!generateBtn) return;
   772→
   773→  // Check if variations mode is enabled
   774→  const generateVariations = variationsCheckbox?.checked || false;
   775→  if (generateVariations) {
   776→    return handleGenerateVariations();
   777→  }
   778→
   779→  try {
   780→    musicState.isGenerating = true;
   781→    generateBtn.disabled = true;
   782→    generateBtn.textContent = 'Starting...';
   783→
   784→    const options = {
   785→      mood: getSelectedMood(),
   786→      instruments: [getSelectedInstrument()],
   787→      duration: getSelectedDuration(),
   788→      prompt: promptInput?.value || '',
   789→      youtubeUrl: musicState.identifiedSong?.sourceUrl || null,
   790→      referenceSong: musicState.identifiedSong || null
   791→    };
   792→
   793→    let result;
   794→
   795→    if (musicState.sceneAwareEnabled) {
   796→      const segments = getCurrentTranscriptSegments();
   797→      if (segments && segments.length > 0) {
   798→        setMusicStatus('Analyzing transcript and generating scene-aware music...', 'info');
   799→        result = await generateSceneAwareRequest(options, segments);
   800→        setMusicStatus(`Scene-aware generation started! Job ID: ${result.jobId}`, 'success');
   801→      } else {
   802→        setMusicStatus('No transcript available, using regular generation...', 'warning');
   803→        result = await generateMusicRequest(options);
   804→        setMusicStatus(`Generation started! Job ID: ${result.jobId}`, 'success');
   805→      }
   806→    } else {
   807→      setMusicStatus('Submitting generation request...', 'info');
   808→      result = await generateMusicRequest(options);
   809→      setMusicStatus(`Generation started! Job ID: ${result.jobId}`, 'success');
   810→    }
   811→
   812→    addJobToList(result.jobId, options, result.isSceneAware);
   813→    startPollingJob(result.jobId);
   814→    handleClearReference();
   815→    if (promptInput) promptInput.value = '';
   816→
   817→  } catch (error) {
   818→    console.error('Generation error:', error);
   819→    setMusicStatus(`Error: ${error.message}`, 'error');
   820→  } finally {
   821→    musicState.isGenerating = false;
   822→    generateBtn.disabled = false;
   823→    generateBtn.textContent = 'Generate Music';
   824→  }
   825→}
   826→
   827→// ============================================
   828→// VARIATIONS
   829→// ============================================
   830→
   831→async function handleGenerateVariations() {
   832→  const generateBtn = musicElements.generateBtn || document.getElementById('music-generate-btn');
   833→  const promptInput = musicElements.promptInput || document.getElementById('music-custom-prompt');
   834→
   835→  if (!generateBtn) return;
   836→
   837→  try {
   838→    musicState.isGenerating = true;
   839→    generateBtn.disabled = true;
   840→    generateBtn.textContent = 'Starting...';
   841→    setMusicStatus('Generating 3 variations... This may take 5-8 minutes.', 'info');
   842→
   843→    const options = {
   844→      mood: getSelectedMood(),
   845→      instruments: [getSelectedInstrument()],
   846→      duration: getSelectedDuration(),
   847→      prompt: promptInput?.value || '',
   848→      referenceSong: musicState.identifiedSong || null
   849→    };
   850→
   851→    const result = await generateVariationsRequest(options);
   852→    setMusicStatus(`Variations generation started! Job ID: ${result.jobId}`, 'success');
   853→
   854→    musicState.variationsJob = { jobId: result.jobId, status: 'pending', options };
   855→    startPollingVariations(result.jobId);
   856→    showVariationsPanel();
   857→    handleClearReference();
   858→    if (promptInput) promptInput.value = '';
   859→
   860→  } catch (error) {
   861→    console.error('Variations error:', error);
   862→    setMusicStatus(`Error: ${error.message}`, 'error');
   863→  } finally {
   864→    musicState.isGenerating = false;
   865→    generateBtn.disabled = false;
   866→    generateBtn.textContent = 'Generate 3 Variations';
   867→  }
   868→}
   869→
   870→function startPollingVariations(jobId) {
   871→  if (musicState.variationsPollingInterval) {
   872→    clearInterval(musicState.variationsPollingInterval);
   873→  }
   874→
   875→  musicState.variationsPollingInterval = setInterval(async () => {
   876→    try {
   877→      const status = await getVariationsStatus(jobId);
   878→      musicState.variationsJob = { ...musicState.variationsJob, ...status };
   879→      renderVariationsProgress(status);
   880→
   881→      if (status.status === 'selecting' || status.status === 'completed') {
   882→        clearInterval(musicState.variationsPollingInterval);
   883→        musicState.variationsPollingInterval = null;
   884→
   885→        if (status.variations && status.variations.length > 0) {
   886→          setMusicStatus('Variations ready! Select your favorite.', 'success');
   887→          renderVariationsSelection(status.variations);
   888→        }
   889→      } else if (status.status === 'failed') {
   890→        clearInterval(musicState.variationsPollingInterval);
   891→        musicState.variationsPollingInterval = null;
   892→        setMusicStatus(`Variations failed: ${status.failedReason || 'Unknown error'}`, 'error');
   893→      }
   894→    } catch (error) {
   895→      console.error('Variations polling error:', error);
   896→    }
   897→  }, MUSIC_POLL_INTERVAL);
   898→}
   899→
   900→function showVariationsPanel() {
   901→  let panel = musicElements.variationsPanel || document.getElementById('variationsPanel');
   902→  if (!panel) {
   903→    panel = document.createElement('div');
   904→    panel.id = 'variationsPanel';
   905→    panel.className = 'variations-panel';
   906→    const section = musicElements.section || document.getElementById('musicSection');
   907→    if (section) section.appendChild(panel);
   908→  }
   909→
   910→  panel.style.display = 'block';
   911→  panel.innerHTML = `
   912→    <div class="variations-header">
   913→      <h4>Generating 3 Variations</h4>
   914→      <button id="variationsCancelBtn" class="variations-cancel-btn" title="Cancel">x</button>
   915→    </div>
   916→    <div class="variations-progress">
   917→      <div class="variation-progress-item" data-index="0">
   918→        <span class="variation-name">Version A</span>
   919→        <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
   920→        <span class="progress-text">0%</span>
   921→      </div>
   922→      <div class="variation-progress-item" data-index="1">
   923→        <span class="variation-name">Version B</span>
   924→        <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
   925→        <span class="progress-text">0%</span>
   926→      </div>
   927→      <div class="variation-progress-item" data-index="2">
   928→        <span class="variation-name">Version C</span>
   929→        <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
   930→        <span class="progress-text">0%</span>
   931→      </div>
   932→    </div>
   933→    <div id="variationsSelection" class="variations-selection" style="display: none;"></div>
   934→  `;
   935→
   936→  document.getElementById('variationsCancelBtn')?.addEventListener('click', hideVariationsPanel);
   937→}
   938→
   939→function hideVariationsPanel() {
   940→  const panel = musicElements.variationsPanel || document.getElementById('variationsPanel');
   941→  if (panel) {
   942→    panel.style.display = 'none';
   943→    panel.innerHTML = '';
   944→  }
   945→
   946→  if (musicState.variationsPollingInterval) {
   947→    clearInterval(musicState.variationsPollingInterval);
   948→    musicState.variationsPollingInterval = null;
   949→  }
   950→
   951→  musicState.variationPlayers.forEach(player => {
   952→    if (player) { player.pause(); player.src = ''; }
   953→  });
   954→  musicState.variationPlayers = [null, null, null];
   955→  musicState.variationsJob = null;
   956→  musicState.selectedVariationIndex = null;
   957→}
   958→
   959→function renderVariationsProgress(status) {
   960→  const progressItems = document.querySelectorAll('.variation-progress-item');
   961→  const variationProgress = status.variationProgress || [0, 0, 0];
   962→
   963→  progressItems.forEach((item, index) => {
   964→    const progress = variationProgress[index] || 0;
   965→    const fill = item.querySelector('.progress-fill');
   966→    const text = item.querySelector('.progress-text');
   967→
   968→    if (fill) fill.style.width = `${progress}%`;
   969→    if (text) text.textContent = `${progress}%`;
   970→    if (progress >= 100) item.classList.add('completed');
   971→  });
   972→}
   973→
   974→function renderVariationsSelection(variations) {
   975→  const container = document.getElementById('variationsSelection');
   976→  if (!container) return;
   977→
   978→  const progressContainer = document.querySelector('.variations-progress');
   979→  if (progressContainer) progressContainer.style.display = 'none';
   980→
   981→  container.style.display = 'block';
   982→  container.innerHTML = `
   983→    <div class="variations-header">
   984→      <h4>Select Your Favorite</h4>
   985→      <p class="variations-subtitle">Preview each variation and choose one to keep</p>
   986→    </div>
   987→    <div class="variations-cards">
   988→      ${variations.map((v, index) => `
   989→        <div class="variation-card ${v.status === 'failed' ? 'failed' : ''}" data-index="${index}">
   990→          <div class="variation-card-header">
   991→            <span class="variation-name">${escapeHtml(v.variationName)}</span>
   992→            ${v.status === 'failed' ? '<span class="failed-badge">Failed</span>' : ''}
   993→          </div>
   994→          ${v.promptDescription ? `<div class="variation-description">${escapeHtml(v.promptDescription)}</div>` : ''}
   995→          ${v.status !== 'failed' ? `
   996→            <div class="variation-player" data-index="${index}">
   997→              <button class="play-btn" data-action="play" data-index="${index}" data-url="${v.previewUrl || ''}">Play</button>
   998→              <span class="duration">${v.duration ? `${v.duration}s` : '--'}</span>
   999→            </div>
  1000→            <button class="select-variation-btn btn btn-primary" data-index="${index}">Select This Version</button>
  1001→          ` : `<div class="variation-error">${escapeHtml(v.error || 'Generation failed')}</div>`}
  1002→        </div>
  1003→      `).join('')}
  1004→    </div>
  1005→  `;
  1006→
  1007→  container.querySelectorAll('.play-btn').forEach(btn => btn.addEventListener('click', handleVariationPlay));
  1008→  container.querySelectorAll('.select-variation-btn').forEach(btn => btn.addEventListener('click', handleVariationSelect));
  1009→}
  1010→
  1011→async function handleVariationPlay(event) {
  1012→  const btn = event.target;
  1013→  const index = parseInt(btn.dataset.index);
  1014→  const url = btn.dataset.url;
  1015→
  1016→  if (!url) { setMusicStatus('No preview available', 'warning'); return; }
  1017→
  1018→  musicState.variationPlayers.forEach((player, i) => {
  1019→    if (player && i !== index) {
  1020→      player.pause();
  1021→      const otherBtn = document.querySelector(`.play-btn[data-index="${i}"]`);
  1022→      if (otherBtn) otherBtn.textContent = 'Play';
  1023→    }
  1024→  });
  1025→
  1026→  if (!musicState.variationPlayers[index]) {
  1027→    musicState.variationPlayers[index] = new Audio();
  1028→    musicState.variationPlayers[index].addEventListener('ended', () => { btn.textContent = 'Play'; });
  1029→  }
  1030→
  1031→  const player = musicState.variationPlayers[index];
  1032→
  1033→  if (player.paused || player.src !== url) {
  1034→    player.src = url;
  1035→    try {
  1036→      await player.play();
  1037→      btn.textContent = 'Pause';
  1038→    } catch (error) {
  1039→      console.error('Play error:', error);
  1040→      setMusicStatus('Could not play preview', 'error');
  1041→    }
  1042→  } else {
  1043→    player.pause();
  1044→    btn.textContent = 'Play';
  1045→  }
  1046→}
  1047→
  1048→async function handleVariationSelect(event) {
  1049→  const btn = event.target;
  1050→  const index = parseInt(btn.dataset.index);
  1051→  const jobId = musicState.variationsJob?.jobId;
  1052→
  1053→  if (!jobId) { setMusicStatus('No variations job found', 'error'); return; }
  1054→
  1055→  try {
  1056→    document.querySelectorAll('.select-variation-btn').forEach(b => { b.disabled = true; });
  1057→    btn.textContent = 'Selecting...';
  1058→    setMusicStatus('Finalizing your selection...', 'info');
  1059→
  1060→    const result = await selectVariation(jobId, index);
  1061→    setMusicStatus(`Selected ${result.variationName}! Music added to library.`, 'success');
  1062→
  1063→    musicState.variationPlayers.forEach(player => { if (player) player.pause(); });
  1064→    hideVariationsPanel();
  1065→    loadMusicLibrary();
  1066→    updateMusicCreditsDisplay();
  1067→
  1068→  } catch (error) {
  1069→    console.error('Selection error:', error);
  1070→    setMusicStatus(`Error: ${error.message}`, 'error');
  1071→    document.querySelectorAll('.select-variation-btn').forEach(b => { b.disabled = false; });
  1072→    btn.textContent = 'Select This Version';
  1073→  }
  1074→}
  1075→
  1076→// ============================================
  1077→// JOBS LIST
  1078→// ============================================
  1079→
  1080→function addJobToList(jobId, options, isSceneAware = false) {
  1081→  const job = {
  1082→    jobId,
  1083→    status: 'pending',
  1084→    progress: 0,
  1085→    mood: options.mood,
  1086→    duration: options.duration,
  1087→    isSceneAware,
  1088→    createdAt: new Date().toISOString()
  1089→  };
  1090→  musicState.jobs.unshift(job);
  1091→  renderJobsList();
  1092→}
  1093→
  1094→function startPollingJob(jobId) {
  1095→  if (musicState.pollInterval) clearInterval(musicState.pollInterval);
  1096→
  1097→  musicState.pollInterval = setInterval(async () => {
  1098→    try {
  1099→      const status = await getJobStatus(jobId);
  1100→      const jobIndex = musicState.jobs.findIndex(j => j.jobId === jobId);
  1101→      if (jobIndex !== -1) {
  1102→        musicState.jobs[jobIndex] = { ...musicState.jobs[jobIndex], ...status };
  1103→        renderJobsList();
  1104→      }
  1105→
  1106→      if (status.status === 'completed' || status.status === 'failed') {
  1107→        clearInterval(musicState.pollInterval);
  1108→        musicState.pollInterval = null;
  1109→        if (status.status === 'completed') {
  1110→          setMusicStatus('Music generation completed!', 'success');
  1111→          loadMusicLibrary();
  1112→        } else {
  1113→          setMusicStatus(`Generation failed: ${status.failedReason || 'Unknown error'}`, 'error');
  1114→        }
  1115→      }
  1116→    } catch (error) {
  1117→      console.error('Polling error:', error);
  1118→    }
  1119→  }, MUSIC_POLL_INTERVAL);
  1120→}
  1121→
  1122→function renderJobsList() {
  1123→  const container = musicElements.jobsList || document.getElementById('music-jobs-list');
  1124→  if (!container) return;
  1125→
  1126→  if (musicState.jobs.length === 0) {
  1127→    container.innerHTML = '<div class="music-empty">No generation jobs yet</div>';
  1128→    return;
  1129→  }
  1130→
  1131→  container.innerHTML = musicState.jobs.map(job => `
  1132→    <div class="music-job-item ${job.status}" data-job-id="${job.jobId}">
  1133→      <div class="music-job-status ${job.status}"></div>
  1134→      <div class="music-job-info">
  1135→        <span class="music-job-mood">${job.mood || 'Music'}${job.isSceneAware ? ' Scene' : ''}</span>
  1136→        <span class="music-job-duration">${job.duration}s</span>
  1137→      </div>
  1138→      <div class="music-job-progress">
  1139→        ${job.status === 'completed' ? 'Done' : job.status === 'failed' ? 'Failed' : `${job.progress}%`}
  1140→      </div>
  1141→    </div>
  1142→  `).join('');
  1143→}
  1144→
  1145→// ============================================
  1146→// MUSIC LIBRARY
  1147→// ============================================
  1148→
  1149→async function loadMusicLibrary() {
  1150→  const container = musicElements.library || document.getElementById('music-library-list');
  1151→  if (!container) return;
  1152→
  1153→  try {
  1154→    container.innerHTML = '<div class="music-loading">Loading library...</div>';
  1155→    const library = await getMusicLibrary();
  1156→
  1157→    if (library.length === 0) {
  1158→      container.innerHTML = '<div class="music-empty">Your music library is empty</div>';
  1159→      return;
  1160→    }
  1161→
  1162→    container.innerHTML = library.map(item => `
  1163→      <div class="music-library-item" data-job-id="${item.jobId}">
  1164→        <div class="music-item-info">
  1165→          <div class="music-item-title">${escapeHtml(item.title || 'Untitled')}</div>
  1166→          <div class="music-item-meta">${item.duration}s - ${item.mood || 'Music'}</div>
  1167→        </div>
  1168→        <div class="music-item-actions">
  1169→          <button class="music-action-btn btn btn-small" data-action="preview" data-job-id="${item.jobId}" title="Preview">Play</button>
  1170→          <button class="music-action-btn btn btn-small" data-action="align" data-job-id="${item.jobId}" title="Align to Video">Align</button>
  1171→          <button class="music-action-btn btn btn-small btn-secondary" data-action="delete" data-job-id="${item.jobId}" title="Delete">Del</button>
  1172→        </div>
  1173→      </div>
  1174→    `).join('');
  1175→
  1176→  } catch (error) {
  1177→    console.error('Library load error:', error);
  1178→    container.innerHTML = '<div class="music-error">Failed to load library</div>';
  1179→  }
  1180→}
  1181→
  1182→async function handleLibraryAction(event) {
  1183→  const btn = event.target;
  1184→  const action = btn.dataset.action;
  1185→  const jobId = btn.dataset.jobId;
  1186→
  1187→  switch (action) {
  1188→    case 'preview': await previewMusic(jobId); break;
  1189→    case 'align': await showAlignmentModal(jobId); break;
  1190→    case 'delete': await confirmDeleteMusic(jobId); break;
  1191→  }
  1192→}
  1193→
  1194→async function previewMusic(jobId) {
  1195→  try {
  1196→    setMusicStatus('Loading preview...', 'info');
  1197→    const music = await getMusicFile(jobId);
  1198→
  1199→    if (!music.previewUrl && !music.downloadUrl) {
  1200→      setMusicStatus('No preview available', 'warning');
  1201→      return;
  1202→    }
  1203→
  1204→    if (!musicState.audioPlayer) {
  1205→      musicState.audioPlayer = new Audio();
  1206→      musicState.audioPlayer.addEventListener('ended', () => { setMusicStatus('Preview finished', 'info'); });
  1207→    }
  1208→
  1209→    musicState.audioPlayer.src = music.previewUrl || music.downloadUrl;
  1210→    musicState.audioPlayer.play();
  1211→    setMusicStatus('Playing preview...', 'success');
  1212→
  1213→  } catch (error) {
  1214→    console.error('Preview error:', error);
  1215→    setMusicStatus(`Preview error: ${error.message}`, 'error');
  1216→  }
  1217→}
  1218→
  1219→async function confirmDeleteMusic(jobId) {
  1220→  if (!confirm('Are you sure you want to delete this music file?')) return;
  1221→
  1222→  try {
  1223→    setMusicStatus('Deleting...', 'info');
  1224→    await deleteMusicFile(jobId);
  1225→    setMusicStatus('Music deleted', 'success');
  1226→    loadMusicLibrary();
  1227→  } catch (error) {
  1228→    console.error('Delete error:', error);
  1229→    setMusicStatus(`Delete error: ${error.message}`, 'error');
  1230→  }
  1231→}
  1232→
  1233→// ============================================
  1234→// ALIGNMENT UI
  1235→// ============================================
  1236→
  1237→async function showAlignmentModal(jobId) {
  1238→  try {
  1239→    setMusicStatus('Loading alignment options...', 'info');
  1240→    const options = await getAlignmentOptions();
  1241→    musicState.alignmentOptions = options;
  1242→
  1243→    const sequenceDuration = await getSequenceDuration();
  1244→
  1245→    setMusicStatus('Analyzing beats...', 'info');
  1246→    const beatAnalysis = await analyzeBeatsRequest(jobId);
  1247→    musicState.beatAnalysis = beatAnalysis;
  1248→
  1249→    renderAlignmentModal(jobId, beatAnalysis, options, sequenceDuration);
  1250→    setMusicStatus('', 'info');
  1251→
  1252→  } catch (error) {
  1253→    console.error('Alignment modal error:', error);
  1254→    setMusicStatus(`Error: ${error.message}`, 'error');
  1255→  }
  1256→}
  1257→
  1258→function renderAlignmentModal(jobId, beatAnalysis, options, sequenceDuration) {
  1259→  const modal = document.getElementById('music-align-modal');
  1260→  if (!modal) {
  1261→    console.error('Alignment modal not found in DOM');
  1262→    return;
  1263→  }
  1264→
  1265→  // Populate Info
  1266→  const infoEl = document.getElementById('music-align-info');
  1267→  if (infoEl) {
  1268→    const defaultDuration = sequenceDuration ? Math.round(sequenceDuration) : Math.round(beatAnalysis.duration * 0.8);
  1269→
  1270→    let html = `
  1271→          <p><strong>Original Duration:</strong> ${formatDuration(beatAnalysis.duration)}</p>
  1272→          <p><strong>Detected BPM:</strong> ${beatAnalysis.bpm || 'Unknown'}</p>
  1273→          <p><strong>Beat Count:</strong> ${beatAnalysis.beatCount}</p>
  1274→      `;
  1275→    if (sequenceDuration) {
  1276→      html += `<p class="highlight"><strong>Sequence Duration:</strong> ${formatDuration(sequenceDuration)}</p>`;
  1277→    }
  1278→    infoEl.innerHTML = html;
  1279→
  1280→    // Set default target duration
  1281→    const targetInput = document.getElementById('music-align-target');
  1282→    if (targetInput) {
  1283→      targetInput.value = defaultDuration;
  1284→      targetInput.max = Math.ceil(beatAnalysis.duration);
  1285→    }
  1286→  }
  1287→
  1288→  // Setup Fade Slider
  1289→  const fadeSlider = document.getElementById('music-fade-slider');
  1290→  const fadeValue = document.getElementById('music-fade-value');
  1291→  if (fadeSlider && fadeValue) {
  1292→    fadeSlider.min = options.fadeDuration.min;
  1293→    fadeSlider.max = options.fadeDuration.max;
  1294→    fadeSlider.value = options.fadeDuration.default;
  1295→    fadeValue.textContent = options.fadeDuration.default;
  1296→
  1297→    // Remove old listener to avoid duplicates if any
  1298→    const newSlider = fadeSlider.cloneNode(true);
  1299→    fadeSlider.parentNode.replaceChild(newSlider, fadeSlider);
  1300→
  1301→    newSlider.addEventListener('input', (e) => {
  1302→      if (fadeValue) fadeValue.textContent = e.target.value;
  1303→    });
  1304→  }
  1305→
  1306→  // Setup Match Sequence Button
  1307→  const matchBtn = document.getElementById('music-align-match-seq');
  1308→  if (matchBtn) {
  1309→    if (sequenceDuration) {
  1310→      matchBtn.style.display = 'inline-block';
  1311→      matchBtn.onclick = () => {
  1312→        const targetInput = document.getElementById('music-align-target');
  1313→        if (targetInput) targetInput.value = Math.round(sequenceDuration);
  1314→      };
  1315→    } else {
  1316→      matchBtn.style.display = 'none';
  1317→    }
  1318→  }
  1319→
  1320→  // Setup Confirm Button
  1321→  const confirmBtn = document.getElementById('music-align-btn');
  1322→  if (confirmBtn) {
  1323→    confirmBtn.onclick = (e) => handleAlignmentConfirm(e, jobId);
  1324→    confirmBtn.disabled = false;
  1325→    confirmBtn.textContent = 'Align & Trim';
  1326→  }
  1327→
  1328→  // Setup Close Handlers
  1329→  const closeBtn = document.getElementById('music-align-close');
  1330→  if (closeBtn) closeBtn.onclick = hideAlignmentModal;
  1331→
  1332→  // Show Modal
  1333→  modal.classList.remove('hidden');
  1334→}
  1335→
  1336→function hideAlignmentModal() {
  1337→  const modal = document.getElementById('music-align-modal');
  1338→  if (modal) {
  1339→    modal.classList.add('hidden');
  1340→  }
  1341→  musicState.beatAnalysis = null;
  1342→}
  1343→
  1344→async function handleAlignmentConfirm(event, jobId) {
  1345→  const btn = event.target;
  1346→  // jobId is passed directly now, or fallback to state? 
  1347→  // The original code used dataset.jobId. We passed it in the onclick handler closure.
  1348→
  1349→  const targetInput = document.getElementById('music-align-target');
  1350→  const fadeInput = document.getElementById('music-fade-slider'); // It's a slider now in HTML
  1351→  const beatAlignInput = document.getElementById('music-beat-align');
  1352→
  1353→  const targetDuration = parseFloat(targetInput?.value);
  1354→  const fadeDuration = parseFloat(fadeInput?.value);
  1355→  const beatAlign = beatAlignInput?.checked;
  1356→
  1357→  if (!targetDuration || targetDuration < 5) {
  1358→    setMusicStatus('Target duration must be at least 5 seconds', 'error');
  1359→    return;
  1360→  }
  1361→
  1362→  try {
  1363→    musicState.isAligning = true;
  1364→    btn.disabled = true;
  1365→    btn.textContent = 'Aligning...';
  1366→    setMusicStatus('Aligning music to video duration...', 'info');
  1367→
  1368→    const result = await alignMusicRequest(jobId, targetDuration, { fadeDuration, beatAlign });
  1369→    setMusicStatus(`Aligned! Cut at ${formatDuration(result.actualDuration)} (${result.wasAligned ? 'beat-aligned' : 'exact'})`, 'success');
  1370→    hideAlignmentModal();
  1371→
  1372→    if (result.downloadUrl) {
  1373→      showAlignedDownload(result);
  1374→    }
  1375→
  1376→  } catch (error) {
  1377→    console.error('Alignment error:', error);
  1378→    setMusicStatus(`Alignment failed: ${error.message}`, 'error');
  1379→    btn.disabled = false;
  1380→    btn.textContent = 'Align Music';
  1381→  } finally {
  1382→    musicState.isAligning = false;
  1383→  }
  1384→}
  1385→
  1386→function showAlignedDownload(result) {
  1387→  const notification = document.createElement('div');
  1388→  notification.className = 'alignment-notification';
  1389→  notification.innerHTML = `
  1390→    <div class="notification-content">
  1391→      <span class="notification-icon">Done</span>
  1392→      <div class="notification-text">
  1393→        <strong>Music Aligned!</strong>
  1394→        <span>Duration: ${formatDuration(result.actualDuration)}</span>
  1395→      </div>
  1396→      <div class="notification-actions">
  1397→        <button class="btn btn-small" data-action="download" data-url="${result.downloadUrl}">Download</button>
  1398→        <button class="btn-close" data-action="close">x</button>
  1399→      </div>
  1400→    </div>
  1401→  `;
  1402→
  1403→  const container = musicElements.section || document.getElementById('musicSection') || document.body;
  1404→  container.appendChild(notification);
  1405→
  1406→  notification.querySelector('[data-action="download"]').addEventListener('click', (e) => {
  1407→    window.open(e.target.dataset.url, '_blank');
  1408→    notification.remove();
  1409→  });
  1410→
  1411→  notification.querySelector('[data-action="close"]').addEventListener('click', () => { notification.remove(); });
  1412→  setTimeout(() => notification.remove(), 30000);
  1413→}
  1414→
  1415→// ============================================
  1416→// TIMELINE UI
  1417→// ============================================
  1418→
  1419→function updateTimelineAvailability() {
  1420→  const btn = musicElements.timelineBtn || document.getElementById('music-timeline-btn');
  1421→  const transcript = getCurrentTranscript();
  1422→
  1423→  if (btn) {
  1424→    btn.disabled = !transcript || !transcript.segments || transcript.segments.length === 0;
  1425→    if (!transcript) {
  1426→      btn.title = 'Run transcription first to enable mood timeline';
  1427→    } else if (!transcript.segments || transcript.segments.length === 0) {
  1428→      btn.title = 'No transcript segments available';
  1429→    } else {
  1430→      btn.title = 'Generate per-chapter music with mood matching';
  1431→    }
  1432→  }
  1433→}
  1434→
  1435→async function showTimelineModal() {
  1436→  const transcript = getCurrentTranscript();
  1437→  if (!transcript) {
  1438→    setMusicStatus('Run transcription first to generate mood timeline', 'error');
  1439→    return;
  1440→  }
  1441→
  1442→  try {
  1443→    setMusicStatus('Loading timeline options...', 'info');
  1444→    const options = await getTimelineOptions();
  1445→    musicState.timelineOptions = options;
  1446→    const estimate = await estimateTimelineRequest(transcript);
  1447→    renderTimelineModal(transcript, options, estimate);
  1448→    setMusicStatus('', 'info');
  1449→  } catch (error) {
  1450→    console.error('Timeline modal error:', error);
  1451→    setMusicStatus(`Error: ${error.message}`, 'error');
  1452→  }
  1453→}
  1454→
  1455→function renderTimelineModal(transcript, options, estimate) {
  1456→  let modal = document.getElementById('timelineModal');
  1457→  if (!modal) {
  1458→    modal = document.createElement('div');
  1459→    modal.id = 'timelineModal';
  1460→    modal.className = 'modal-overlay';
  1461→    document.body.appendChild(modal);
  1462→  }
  1463→
  1464→  const defaults = options.defaults || {};
  1465→  const constraints = options.constraints || {};
  1466→
  1467→  modal.innerHTML = `
  1468→    <div class="modal-content timeline-modal">
  1469→      <div class="modal-header">
  1470→        <h3>Generate Mood Timeline</h3>
  1471→        <button class="modal-close-btn" id="timelineCloseBtn">x</button>
  1472→      </div>
  1473→      <div class="modal-body">
  1474→        <div class="timeline-info">
  1475→          <p>Video Duration: ${formatDuration(transcript.duration)}</p>
  1476→          <p>Transcript Segments: ${transcript.segments?.length || 0}</p>
  1477→          <p><strong>Estimated Chapters: ${estimate.estimatedChapters}</strong></p>
  1478→          <p><strong>Estimated Time: ${estimate.estimatedTimeDisplay}</strong></p>
  1479→        </div>
  1480→        <p>This will analyze your video transcript to detect chapters and their emotional tone, then generate unique music for each chapter with crossfades between them.</p>
  1481→        <p><strong>Cost:</strong> 3 music credits</p>
  1482→        <div class="timeline-form">
  1483→          <div class="form-group">
  1484→            <label for="timelineMaxChapters">Maximum Chapters</label>
  1485→            <input type="number" id="timelineMaxChapters" value="${defaults.maxChapters || 10}" min="1" max="20" step="1">
  1486→          </div>
  1487→          <div class="form-group">
  1488→            <label for="timelineMinLength">Minimum Chapter Length (seconds)</label>
  1489→            <input type="number" id="timelineMinLength" value="${defaults.minChapterLength || 60}" min="30" max="300" step="10">
  1490→          </div>
  1491→          <div class="form-group">
  1492→            <label for="timelineCrossfade">Crossfade Duration (seconds)</label>
  1493→            <input type="number" id="timelineCrossfade" value="${defaults.crossfadeDuration || 2}" min="${constraints.minCrossfadeDuration || 0.5}" max="${constraints.maxCrossfadeDuration || 5}" step="0.5">
  1494→          </div>
  1495→          <div class="form-group">
  1496→            <label for="timelineInstruments">Instrument Style</label>
  1497→            <select id="timelineInstruments">
  1498→              <option value="">Auto-detect from content</option>
  1499→              ${INSTRUMENT_OPTIONS.map(i => `<option value="${i.id}">${i.name} - ${i.description}</option>`).join('')}
  1500→            </select>
  1501→          </div>
  1502→          <div class="form-group">
  1503→            <label for="timelinePrompt">Additional Instructions (optional)</label>
  1504→            <textarea id="timelinePrompt" rows="2" placeholder="E.g., 'Modern electronic feel'"></textarea>
  1505→          </div>
  1506→        </div>
  1507→      </div>
  1508→      <div class="modal-footer">
  1509→        <button type="button" id="timelineCancelBtn" class="btn btn-secondary">Cancel</button>
  1510→        <button type="button" id="timelineConfirmBtn" class="btn btn-primary">Generate Timeline Music (3 credits)</button>
  1511→      </div>
  1512→    </div>
  1513→  `;
  1514→
  1515→  modal.style.display = 'flex';
  1516→
  1517→  document.getElementById('timelineCloseBtn').addEventListener('click', hideTimelineModal);
  1518→  document.getElementById('timelineCancelBtn').addEventListener('click', hideTimelineModal);
  1519→  document.getElementById('timelineConfirmBtn').addEventListener('click', handleTimelineConfirm);
  1520→  modal.addEventListener('click', (e) => { if (e.target === modal) hideTimelineModal(); });
  1521→}
  1522→
  1523→function hideTimelineModal() {
  1524→  const modal = document.getElementById('timelineModal');
  1525→  if (modal) { modal.style.display = 'none'; modal.innerHTML = ''; }
  1526→}
  1527→
  1528→async function handleTimelineConfirm() {
  1529→  const transcript = getCurrentTranscript();
  1530→  if (!transcript) {
  1531→    setMusicStatus('Transcript not available', 'error');
  1532→    return;
  1533→  }
  1534→
  1535→  const maxChapters = parseInt(document.getElementById('timelineMaxChapters').value) || 10;
  1536→  const minChapterLength = parseInt(document.getElementById('timelineMinLength').value) || 60;
  1537→  const crossfadeDuration = parseFloat(document.getElementById('timelineCrossfade').value) || 2;
  1538→  const instruments = document.getElementById('timelineInstruments').value;
  1539→  const prompt = document.getElementById('timelinePrompt').value || '';
  1540→
  1541→  const confirmBtn = document.getElementById('timelineConfirmBtn');
  1542→
  1543→  try {
  1544→    musicState.isGeneratingTimeline = true;
  1545→    confirmBtn.disabled = true;
  1546→    confirmBtn.textContent = 'Generating...';
  1547→
  1548→    setMusicStatus('Generating mood timeline... This may take several minutes.', 'info');
  1549→    hideTimelineModal();
  1550→
  1551→    const result = await generateTimelineRequest(transcript, {
  1552→      maxChapters,
  1553→      minChapterLength,
  1554→      crossfadeDuration,
  1555→      instruments: instruments ? [instruments] : [],
  1556→      prompt
  1557→    });
  1558→
  1559→    setMusicStatus(`Timeline generated! ${result.chapters?.length || 0} chapters, ${formatDuration(result.duration)}`, 'success');
  1560→
  1561→    if (result.audioUrl) {
  1562→      showTimelineResult(result);
  1563→    }
  1564→
  1565→    loadMusicLibrary();
  1566→    updateMusicCreditsDisplay();
  1567→
  1568→  } catch (error) {
  1569→    console.error('Timeline generation error:', error);
  1570→    setMusicStatus(`Timeline generation failed: ${error.message}`, 'error');
  1571→  } finally {
  1572→    musicState.isGeneratingTimeline = false;
  1573→    if (confirmBtn) {
  1574→      confirmBtn.disabled = false;
  1575→      confirmBtn.textContent = 'Generate Timeline Music (3 credits)';
  1576→    }
  1577→  }
  1578→}
  1579→
  1580→function showTimelineResult(result) {
  1581→  let resultPanel = document.getElementById('timelineResultPanel');
  1582→  if (!resultPanel) {
  1583→    resultPanel = document.createElement('div');
  1584→    resultPanel.id = 'timelineResultPanel';
  1585→    resultPanel.className = 'timeline-result-panel';
  1586→    const container = musicElements.section || document.getElementById('musicSection') || document.body;
  1587→    container.insertBefore(resultPanel, container.firstChild);
  1588→  }
  1589→
  1590→  const chapterList = (result.chapters || []).map((ch, i) => `
  1591→    <div class="timeline-chapter">
  1592→      <span class="chapter-num">${i + 1}</span>
  1593→      <span class="chapter-title">${escapeHtml(ch.title)}</span>
  1594→      <span class="chapter-mood">${ch.mood || 'neutral'}</span>
  1595→    </div>
  1596→  `).join('');
  1597→
  1598→  resultPanel.innerHTML = `
  1599→    <div class="timeline-result-content">
  1600→      <div class="timeline-result-header">
  1601→        <span class="result-icon">Done</span>
  1602→        <span class="result-title">Mood Timeline Generated!</span>
  1603→        <button class="close-btn" data-action="close">x</button>
  1604→      </div>
  1605→      <div class="timeline-result-stats">
  1606→        <p>Duration: ${formatDuration(result.duration)}</p>
  1607→        <p>Chapters: ${result.chapters?.length || 0}</p>
  1608→        <p>Credits Used: ${result.creditCost || 3}</p>
  1609→      </div>
  1610→      <div class="timeline-chapters"><h4>Chapters</h4>${chapterList}</div>
  1611→      <div class="timeline-result-actions">
  1612→        <button class="btn btn-primary" data-action="download" data-url="${result.audioUrl}">Download</button>
  1613→      </div>
  1614→    </div>
  1615→  `;
  1616→
  1617→  resultPanel.style.display = 'block';
  1618→
  1619→  resultPanel.querySelector('[data-action="close"]').addEventListener('click', () => { resultPanel.style.display = 'none'; });
  1620→  resultPanel.querySelector('[data-action="download"]').addEventListener('click', (e) => {
  1621→    window.open(e.target.dataset.url, '_blank');
  1622→  });
  1623→
  1624→  setTimeout(() => { if (resultPanel) resultPanel.style.display = 'none'; }, 60000);
  1625→}
  1626→
  1627→// ============================================
  1628→// UTILITY FUNCTIONS
  1629→// ============================================
  1630→
  1631→function formatDuration(seconds) {
  1632→  if (!seconds) return '0:00';
  1633→  const mins = Math.floor(seconds / 60);
  1634→  const secs = Math.round(seconds % 60);
  1635→  return `${mins}:${secs.toString().padStart(2, '0')}`;
  1636→}
  1637→
  1638→async function updateMusicCreditsDisplay() {
  1639→  const badge = musicElements.creditsBadge || document.getElementById('music-credits-badge');
  1640→  if (!badge) return;
  1641→
  1642→  try {
  1643→    const credits = await getMusicCredits();
  1644→    badge.textContent = `${credits.remaining}/${credits.total} songs`;
  1645→    badge.className = 'music-credits-badge';
  1646→    if (credits.remaining === 0) badge.classList.add('empty');
  1647→    else if (credits.remaining <= 2) badge.classList.add('low');
  1648→  } catch (error) {
  1649→    badge.textContent = 'Credits: --';
  1650→  }
  1651→}
  1652→
  1653→function setMusicStatus(message, type = 'info') {
  1654→  const status = musicElements.status || document.getElementById('music-status');
  1655→  if (!status) return;
  1656→
  1657→  status.textContent = message;
  1658→  status.className = `music-status music-status-${type}`;
  1659→  status.style.display = 'block';
  1660→
  1661→  if (type !== 'error') {
  1662→    setTimeout(() => { status.style.display = 'none'; }, 5000);
  1663→  }
  1664→}
  1665→
  1666→function escapeHtml(str) {
  1667→  if (!str) return '';
  1668→  const div = document.createElement('div');
  1669→  div.textContent = str;
  1670→  return div.innerHTML;
  1671→}
  1672→
  1673→// ============================================
  1674→// EXPORTS
  1675→// ============================================
  1676→
  1677→window.musicModule = {
  1678→  init: initMusicModule,
  1679→  identifySong,
  1680→  generateMusicRequest,
  1681→  getMusicLibrary,
  1682→  getMusicCredits,
  1683→  loadMusicLibrary,
  1684→  previewMusic,
  1685→  generateVariationsRequest,
  1686→  getVariationsStatus,
  1687→  selectVariation,
  1688→  handleGenerateVariations,
  1689→  showVariationsPanel,
  1690→  hideVariationsPanel,
  1691→  generateSceneAwareRequest,
  1692→  getCurrentTranscriptSegments,
  1693→  handleSceneAwareToggle,
  1694→  updateSceneAwareAvailability,
  1695→  alignMusicRequest,
  1696→  analyzeBeatsRequest,
  1697→  getAlignmentOptions,
  1698→  showAlignmentModal,
  1699→  hideAlignmentModal,
  1700→  formatDuration,
  1701→  getSequenceDuration,
  1702→  generateTimelineRequest,
  1703→  getTimelineOptions,
  1704→  estimateTimelineRequest,
  1705→  getCurrentTranscript,
  1706→  showTimelineModal,
  1707→  hideTimelineModal,
  1708→  updateTimelineAvailability,
  1709→  MOOD_OPTIONS,
  1710→  INSTRUMENT_OPTIONS,
  1711→  DURATION_OPTIONS
  1712→};
  1713→
  1714→window.initMusicModule = initMusicModule;
  1715→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
