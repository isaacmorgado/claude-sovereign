     1→/**
     2→ * SPLICE CEP Panel Configuration
     3→ * Backend URLs, paths, and utility functions
     4→ */
     5→
     6→// ============================================================================
     7→// BACKEND CONFIGURATION
     8→// ============================================================================
     9→const SPLICE_CONFIG = {
    10→    VERSION: '4.0.0',
    11→    BACKEND_PROD: 'https://splice-api-production.up.railway.app',
    12→    BACKEND_DEV: 'https://127.0.0.1:3847',
    13→    FETCH_TIMEOUT: 120000, // 2 minutes
    14→    RETRY_ATTEMPTS: 3,
    15→    RETRY_DELAY: 1000
    16→};
    17→
    18→/**
    19→ * Get the backend URL based on environment
    20→ */
    21→function getBackendUrl() {
    22→    // Check for development mode
    23→    const isDev = window.location.protocol === 'file:' ||
    24→                  window.location.hostname === 'localhost' ||
    25→                  window.location.hostname === '127.0.0.1';
    26→
    27→    // Allow override via localStorage
    28→    const customUrl = localStorage.getItem('spliceBackendUrl');
    29→    if (customUrl) return customUrl;
    30→
    31→    return isDev ? SPLICE_CONFIG.BACKEND_DEV : SPLICE_CONFIG.BACKEND_PROD;
    32→}
    33→
    34→// ============================================================================
    35→// JSX BRIDGE - Communicate with Premiere Pro
    36→// ============================================================================
    37→const jsx = {
    38→    cs: null,
    39→    _initPromise: null,
    40→    _initialized: false,
    41→
    42→    /**
    43→     * Initialize the CSInterface
    44→     * Returns a promise that resolves when ready
    45→     */
    46→    init: function() {
    47→        if (this._initPromise) return this._initPromise;
    48→
    49→        this._initPromise = new Promise((resolve) => {
    50→            if (typeof CSInterface !== 'undefined') {
    51→                this.cs = new CSInterface();
    52→                this._initialized = true;
    53→                console.log('[JSX] CSInterface initialized successfully');
    54→            } else {
    55→                console.warn('[JSX] CSInterface not available');
    56→            }
    57→            resolve(this._initialized);
    58→        });
    59→
    60→        return this._initPromise;
    61→    },
    62→
    63→    /**
    64→     * Ensure JSX is initialized before making calls
    65→     */
    66→    ensureInitialized: async function() {
    67→        if (!this._initialized) {
    68→            await this.init();
    69→        }
    70→        if (!this.cs) {
    71→            throw new Error('CSInterface not initialized. Make sure you are running in CEP environment.');
    72→        }
    73→    },
    74→
    75→    /**
    76→     * Execute ExtendScript in Premiere Pro
    77→     * @param {string} script - ExtendScript to execute
    78→     * @returns {Promise<any>} - Parsed result
    79→     */
    80→    evalScript: async function(script) {
    81→        await this.ensureInitialized();
    82→
    83→        return new Promise((resolve, reject) => {
    84→            this.cs.evalScript(script, (result) => {
    85→                if (result === 'undefined' || result === undefined) {
    86→                    resolve(null);
    87→                    return;
    88→                }
    89→
    90→                // Check for EvalScript error
    91→                if (typeof result === 'string' && result.indexOf('EvalScript error') !== -1) {
    92→                    reject(new Error(result));
    93→                    return;
    94→                }
    95→
    96→                // Try to parse JSON
    97→                try {
    98→                    const parsed = JSON.parse(result);
    99→                    if (parsed.error) {
   100→                        reject(new Error(parsed.error));
   101→                    } else {
   102→                        resolve(parsed);
   103→                    }
   104→                } catch (e) {
   105→                    // Return as-is if not JSON
   106→                    resolve(result);
   107→                }
   108→            });
   109→        });
   110→    },
   111→
   112→    /**
   113→     * Call a JSX function with arguments
   114→     * @param {string} funcName - Function name
   115→     * @param {...any} args - Arguments to pass
   116→     * @returns {Promise<any>}
   117→     */
   118→    call: async function(funcName, ...args) {
   119→        await this.ensureInitialized();
   120→
   121→        const escapedArgs = args.map(arg => {
   122→            if (arg === null || arg === undefined) return 'null';
   123→            if (typeof arg === 'string') return `'${arg.replace(/'/g, "\\'").replace(/\n/g, '\\n')}'`;
   124→            if (typeof arg === 'object') return `'${JSON.stringify(arg).replace(/'/g, "\\'")}'`;
   125→            return String(arg);
   126→        });
   127→
   128→        const script = `${funcName}(${escapedArgs.join(', ')})`;
   129→        return this.evalScript(script);
   130→    }
   131→};
   132→
   133→// ============================================================================
   134→// FETCH UTILITIES
   135→// ============================================================================
   136→
   137→/**
   138→ * Fetch with timeout support
   139→ * @param {string} url - URL to fetch
   140→ * @param {object} options - Fetch options
   141→ * @param {number} timeout - Timeout in ms
   142→ */
   143→async function fetchWithTimeout(url, options = {}, timeout = SPLICE_CONFIG.FETCH_TIMEOUT) {
   144→    const controller = new AbortController();
   145→    const timeoutId = setTimeout(() => controller.abort(), timeout);
   146→
   147→    try {
   148→        const response = await fetch(url, {
   149→            ...options,
   150→            signal: controller.signal
   151→        });
   152→        clearTimeout(timeoutId);
   153→        return response;
   154→    } catch (error) {
   155→        clearTimeout(timeoutId);
   156→        if (error.name === 'AbortError') {
   157→            throw new Error(`Request timeout after ${timeout}ms`);
   158→        }
   159→        throw error;
   160→    }
   161→}
   162→
   163→/**
   164→ * Parse error response from backend
   165→ * @param {Response} response - Fetch response
   166→ */
   167→async function parseErrorResponse(response) {
   168→    try {
   169→        const data = await response.json();
   170→        return data.error || data.message || `HTTP ${response.status}`;
   171→    } catch {
   172→        return `HTTP ${response.status}: ${response.statusText}`;
   173→    }
   174→}
   175→
   176→/**
   177→ * Get auth headers for API requests
   178→ */
   179→function getAuthHeaders() {
   180→    const headers = { 'Content-Type': 'application/json' };
   181→    const settings = getSettings();
   182→
   183→    if (settings.customerId) {
   184→        headers['x-stripe-customer-id'] = settings.customerId;
   185→    }
   186→    if (settings.licenseKey) {
   187→        headers['x-license-key'] = settings.licenseKey;
   188→    }
   189→
   190→    return headers;
   191→}
   192→
   193→// ============================================================================
   194→// SETTINGS MANAGEMENT
   195→// ============================================================================
   196→
   197→const DEFAULT_SETTINGS = {
   198→    sensitivity: 50,
   199→    minSilenceLength: 0.5,
   200→    sourceIsolated: false,
   201→    enableTakesDetection: true,
   202→    enableJCut: false,
   203→    jcutLeadIn: 0.3,
   204→    jcutLeadOut: 0.2,
   205→    enableZoom: false,
   206→    zoomFrequency: 'medium',
   207→    zoomPreset: 'medium',
   208→    zoomPlacement: 'sentence_start',
   209→    enableChapters: false,
   210→    maxChapters: 10,
   211→    minChapterLength: 60,
   212→    enableProfanity: false,
   213→    profanityLanguage: 'en',
   214→    bleepType: 'standard',
   215→    customerId: null,
   216→    licenseKey: null,
   217→    expandedOptions: false,
   218→    activePreset: 'podcast',
   219→    rememberOptions: false
   220→};
   221→
   222→/**
   223→ * Get settings from localStorage
   224→ */
   225→function getSettings() {
   226→    try {
   227→        const stored = localStorage.getItem('spliceSettings');
   228→        if (stored) {
   229→            return { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
   230→        }
   231→    } catch (e) {
   232→        console.warn('[Config] Error loading settings:', e);
   233→    }
   234→    return { ...DEFAULT_SETTINGS };
   235→}
   236→
   237→/**
   238→ * Save settings to localStorage
   239→ */
   240→function saveSettings(settings) {
   241→    try {
   242→        const merged = { ...getSettings(), ...settings };
   243→        localStorage.setItem('spliceSettings', JSON.stringify(merged));
   244→        return true;
   245→    } catch (e) {
   246→        console.warn('[Config] Error saving settings:', e);
   247→        return false;
   248→    }
   249→}
   250→
   251→/**
   252→ * Clear specific setting
   253→ */
   254→function clearSetting(key) {
   255→    const settings = getSettings();
   256→    delete settings[key];
   257→    localStorage.setItem('spliceSettings', JSON.stringify(settings));
   258→}
   259→
   260→// ============================================================================
   261→// OFFLINE DETECTION
   262→// ============================================================================
   263→
   264→let isOnlineState = true;
   265→let offlineCheckInterval = null;
   266→
   267→/**
   268→ * Check if online
   269→ */
   270→function isOnline() {
   271→    return isOnlineState && navigator.onLine;
   272→}
   273→
   274→/**
   275→ * Initialize offline detection
   276→ */
   277→function initOfflineDetection() {
   278→    // Browser events
   279→    window.addEventListener('online', () => {
   280→        isOnlineState = true;
   281→        updateOfflineUI(true);
   282→    });
   283→
   284→    window.addEventListener('offline', () => {
   285→        isOnlineState = false;
   286→        updateOfflineUI(false);
   287→    });
   288→
   289→    // Periodic check
   290→    offlineCheckInterval = setInterval(async () => {
   291→        try {
   292→            const response = await fetchWithTimeout(
   293→                `${getBackendUrl()}/health`,
   294→                { method: 'GET' },
   295→                5000
   296→            );
   297→            isOnlineState = response.ok;
   298→        } catch {
   299→            isOnlineState = false;
   300→        }
   301→        updateOfflineUI(isOnlineState);
   302→    }, 30000);
   303→}
   304→
   305→/**
   306→ * Update UI based on online state
   307→ */
   308→function updateOfflineUI(online) {
   309→    const goBtn = document.getElementById('goBtn');
   310→    const status = document.getElementById('status');
   311→
   312→    if (goBtn) {
   313→        goBtn.disabled = !online;
   314→    }
   315→
   316→    if (status) {
   317→        if (!online) {
   318→            status.textContent = 'Offline - Check your connection';
   319→            status.style.color = '#dc3545';
   320→        } else {
   321→            // Reset status when back online
   322→            status.textContent = 'Ready';
   323→            status.style.color = '#888';
   324→        }
   325→    }
   326→}
   327→
   328→// ============================================================================
   329→// UTILITY FUNCTIONS
   330→// ============================================================================
   331→
   332→/**
   333→ * Format time in MM:SS or HH:MM:SS
   334→ */
   335→function formatTime(seconds) {
   336→    if (isNaN(seconds) || seconds < 0) return '0:00';
   337→
   338→    const hours = Math.floor(seconds / 3600);
   339→    const minutes = Math.floor((seconds % 3600) / 60);
   340→    const secs = Math.floor(seconds % 60);
   341→
   342→    if (hours > 0) {
   343→        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
   344→    }
   345→    return `${minutes}:${secs.toString().padStart(2, '0')}`;
   346→}
   347→
   348→/**
   349→ * Set status message
   350→ */
   351→function setStatus(message, isError = false) {
   352→    const status = document.getElementById('status');
   353→    if (status) {
   354→        status.textContent = message;
   355→        status.style.color = isError ? '#dc3545' : '#888';
   356→    }
   357→}
   358→
   359→/**
   360→ * Debounce function calls
   361→ */
   362→function debounce(func, wait) {
   363→    let timeout;
   364→    return function executedFunction(...args) {
   365→        const later = () => {
   366→            clearTimeout(timeout);
   367→            func(...args);
   368→        };
   369→        clearTimeout(timeout);
   370→        timeout = setTimeout(later, wait);
   371→    };
   372→}
   373→
   374→// ============================================================================
   375→// PRESET PROFILES
   376→// ============================================================================
   377→
   378→/**
   379→ * Detection presets for different content types.
   380→ * Each preset defines optimal settings for a specific use case.
   381→ */
   382→const PRESETS = {
   383→    // Custom - user-defined settings (default)
   384→    custom: {
   385→        name: 'Custom',
   386→        description: 'Your custom settings',
   387→        icon: 'settings',
   388→        settings: null // Uses current user settings
   389→    },
   390→
   391→    // Podcast - longer pauses are natural, be conservative
   392→    podcast: {
   393→        name: 'Podcast',
   394→        description: 'Longer natural pauses, J-Cuts enabled',
   395→        icon: 'mic',
   396→        settings: {
   397→            sensitivity: 35,
   398→            threshold: -35,
   399→            minSilenceLength: 0.8,
   400→            paddingStart: 0.15,
   401→            paddingEnd: 0.15,
   402→            enableTakesDetection: true,
   403→            enableJCut: true,
   404→            jCutLeadIn: 0.3,
   405→            jCutLeadOut: 0.2
   406→        }
   407→    },
   408→
   409→    // Interview - balanced, respects speaker pauses
   410→    interview: {
   411→        name: 'Interview',
   412→        description: 'Balanced cuts, J-Cuts for smooth transitions',
   413→        icon: 'people',
   414→        settings: {
   415→            sensitivity: 50,
   416→            threshold: -32,
   417→            minSilenceLength: 0.5,
   418→            paddingStart: 0.12,
   419→            paddingEnd: 0.08,
   420→            enableTakesDetection: true,
   421→            enableJCut: true,
   422→            jCutLeadIn: 0.25,
   423→            jCutLeadOut: 0.15
   424→        }
   425→    },
   426→
   427→    // Reaction video - fast pacing, quick cuts
   428→    reaction: {
   429→        name: 'Reaction',
   430→        description: 'Fast-paced, tight cuts for energy',
   431→        icon: 'bolt',
   432→        settings: {
   433→            sensitivity: 70,
   434→            threshold: -28,
   435→            minSilenceLength: 0.3,
   436→            paddingStart: 0.05,
   437→            paddingEnd: 0.03,
   438→            enableTakesDetection: false,
   439→            enableJCut: false,
   440→            jCutLeadIn: 0,
   441→            jCutLeadOut: 0
   442→        }
   443→    },
   444→
   445→    // Tutorial/Educational - preserve thinking pauses
   446→    tutorial: {
   447→        name: 'Tutorial',
   448→        description: 'Preserves teaching pace, J-Cuts enabled',
   449→        icon: 'school',
   450→        settings: {
   451→            sensitivity: 30,
   452→            threshold: -38,
   453→            minSilenceLength: 1.0,
   454→            paddingStart: 0.2,
   455→            paddingEnd: 0.15,
   456→            enableTakesDetection: true,
   457→            enableJCut: true,
   458→            jCutLeadIn: 0.35,
   459→            jCutLeadOut: 0.25
   460→        }
   461→    },
   462→
   463→    // Vlog/YouTube - punchy edits, engagement-focused
   464→    vlog: {
   465→        name: 'Vlog',
   466→        description: 'Punchy edits for YouTube engagement',
   467→        icon: 'videocam',
   468→        settings: {
   469→            sensitivity: 65,
   470→            threshold: -30,
   471→            minSilenceLength: 0.35,
   472→            paddingStart: 0.08,
   473→            paddingEnd: 0.05,
   474→            enableTakesDetection: true,
   475→            enableJCut: false,
   476→            jCutLeadIn: 0,
   477→            jCutLeadOut: 0
   478→        }
   479→    }
   480→};
   481→
   482→/**
   483→ * List of built-in preset IDs
   484→ */
   485→const BUILT_IN_PRESET_IDS = ['custom', 'podcast', 'interview', 'reaction', 'tutorial', 'vlog'];
   486→
   487→/**
   488→ * Get all available presets
   489→ * @returns {Object} All preset definitions
   490→ */
   491→function getPresets() {
   492→    return { ...PRESETS };
   493→}
   494→
   495→/**
   496→ * Get a specific preset by name
   497→ * @param {string} presetName - Name of the preset
   498→ * @returns {Object|null} Preset definition or null if not found
   499→ */
   500→function getPreset(presetName) {
   501→    return PRESETS[presetName] || null;
   502→}
   503→
   504→/**
   505→ * Check if a preset is a built-in preset
   506→ * @param {string} id - Preset ID to check
   507→ * @returns {boolean} True if built-in, false if custom
   508→ */
   509→function isBuiltInPreset(id) {
   510→    return BUILT_IN_PRESET_IDS.includes(id);
   511→}
   512→
   513→/**
   514→ * Apply a preset to current settings
   515→ * @param {string} presetName - Name of the preset to apply
   516→ * @returns {Object} The applied settings
   517→ */
   518→function applyPreset(presetName) {
   519→    const preset = PRESETS[presetName];
   520→
   521→    if (!preset) {
   522→        console.warn(`[SPLICE] Unknown preset: ${presetName}`);
   523→        return getSettings();
   524→    }
   525→
   526→    // Custom preset uses current settings
   527→    if (presetName === 'custom' || !preset.settings) {
   528→        saveSettings({ activePreset: 'custom' });
   529→        return getSettings();
   530→    }
   531→
   532→    // Apply preset settings
   533→    const newSettings = {
   534→        ...preset.settings,
   535→        activePreset: presetName
   536→    };
   537→
   538→    saveSettings(newSettings);
   539→    console.log(`[SPLICE] Applied preset: ${preset.name}`);
   540→
   541→    return getSettings();
   542→}
   543→
   544→/**
   545→ * Get the currently active preset
   546→ * @returns {string} Active preset name
   547→ */
   548→function getActivePreset() {
   549→    const settings = getSettings();
   550→    return settings.activePreset || 'custom';
   551→}
   552→
   553→/**
   554→ * Initialize preset selector
   555→ */
   556→function initPresetSelector() {
   557→    const presetSelector = document.getElementById('presetSelector');
   558→    const sensitivitySlider = document.getElementById('sensitivitySlider');
   559→
   560→    if (!presetSelector) return;
   561→
   562→    // Set initial value from settings
   563→    const settings = getSettings();
   564→    presetSelector.value = settings.activePreset || 'podcast';
   565→
   566→    // Handle preset change
   567→    presetSelector.addEventListener('change', () => {
   568→        const presetId = presetSelector.value;
   569→        const appliedSettings = applyPreset(presetId);
   570→
   571→        // Update sensitivity slider to match preset
   572→        if (sensitivitySlider && appliedSettings.sensitivity !== undefined) {
   573→            sensitivitySlider.value = appliedSettings.sensitivity;
   574→            // Update display value
   575→            const sensitivityValue = document.getElementById('sensitivityValue');
   576→            if (sensitivityValue) {
   577→                sensitivityValue.textContent = appliedSettings.sensitivity;
   578→            }
   579→        }
   580→
   581→        // Update takes detection checkbox
   582→        const enableTakesDetection = document.getElementById('enableTakesDetection');
   583→        if (enableTakesDetection && appliedSettings.enableTakesDetection !== undefined) {
   584→            enableTakesDetection.checked = appliedSettings.enableTakesDetection;
   585→        }
   586→
   587→        // Update J-Cut checkbox
   588→        const enableJCut = document.getElementById('enableJCut');
   589→        if (enableJCut && appliedSettings.enableJCut !== undefined) {
   590→            enableJCut.checked = appliedSettings.enableJCut;
   591→            // Toggle J-Cut settings visibility
   592→            const jcutSettings = document.getElementById('jcutSettings');
   593→            if (jcutSettings) {
   594→                jcutSettings.classList.toggle('collapsed', !appliedSettings.enableJCut);
   595→            }
   596→        }
   597→
   598→        const preset = getPreset(presetId);
   599→        if (preset) {
   600→            setStatus(`Preset: ${preset.name} - ${preset.description}`);
   601→        }
   602→    });
   603→
   604→    // Switch to custom when user manually changes sensitivity
   605→    if (sensitivitySlider) {
   606→        sensitivitySlider.addEventListener('change', () => {
   607→            if (presetSelector.value !== 'custom') {
   608→                presetSelector.value = 'custom';
   609→                saveSettings({ activePreset: 'custom' });
   610→            }
   611→        });
   612→    }
   613→}
   614→
   615→// ============================================================================
   616→// LOGIN MODAL
   617→// ============================================================================
   618→
   619→/**
   620→ * Validate license key format: SPLICE-XXXX-XXXX-XXXX
   621→ */
   622→function isValidLicenseKeyFormat(key) {
   623→    if (!key || typeof key !== 'string') return false;
   624→    const normalized = key.toUpperCase().trim();
   625→    const pattern = /^SPLICE-[A-Z2-9]{4}-[A-Z2-9]{4}-[A-Z2-9]{4}$/;
   626→    return pattern.test(normalized);
   627→}
   628→
   629→/**
   630→ * Initialize login modal handlers
   631→ */
   632→function initLoginModal() {
   633→    const loginModal = document.getElementById('loginModal');
   634→    const closeLoginBtn = document.getElementById('closeLoginBtn');
   635→    const saveLoginBtn = document.getElementById('saveLoginBtn');
   636→    const licenseKeyInput = document.getElementById('licenseKeyInput');
   637→    const creditBadge = document.getElementById('creditBadge');
   638→
   639→    // Handle credit badge click - retry on error, or show login modal
   640→    if (creditBadge) {
   641→        creditBadge.addEventListener('click', async () => {
   642→            if (creditBadge.classList.contains('error')) {
   643→                creditBadge.textContent = '...';
   644→                if (typeof refreshCredits === 'function') {
   645→                    await refreshCredits();
   646→                }
   647→                return;
   648→            }
   649→            showLoginModal();
   650→        });
   651→    }
   652→
   653→    // Close login modal
   654→    if (closeLoginBtn && loginModal) {
   655→        closeLoginBtn.addEventListener('click', () => {
   656→            loginModal.classList.add('hidden');
   657→        });
   658→    }
   659→
   660→    // Close on backdrop click
   661→    if (loginModal) {
   662→        loginModal.addEventListener('click', (e) => {
   663→            if (e.target === loginModal) {
   664→                loginModal.classList.add('hidden');
   665→            }
   666→        });
   667→    }
   668→
   669→    // Activate license key
   670→    if (saveLoginBtn) {
   671→        saveLoginBtn.addEventListener('click', async () => {
   672→            const licenseKey = licenseKeyInput?.value?.trim()?.toUpperCase();
   673→
   674→            if (!licenseKey) {
   675→                showLoginError('Please enter your license key');
   676→                return;
   677→            }
   678→
   679→            if (!isValidLicenseKeyFormat(licenseKey)) {
   680→                showLoginError('Invalid format. Expected: SPLICE-XXXX-XXXX-XXXX');
   681→                return;
   682→            }
   683→
   684→            saveLoginBtn.disabled = true;
   685→            saveLoginBtn.textContent = 'Activating...';
   686→
   687→            try {
   688→                const response = await fetchWithTimeout(`${getBackendUrl()}/license/activate`, {
   689→                    method: 'POST',
   690→                    headers: { 'Content-Type': 'application/json' },
   691→                    body: JSON.stringify({ key: licenseKey })
   692→                }, SPLICE_CONFIG.FETCH_TIMEOUT);
   693→
   694→                const result = await response.json();
   695→
   696→                if (!result.success) {
   697→                    showLoginError(result.error || 'Activation failed');
   698→                    return;
   699→                }
   700→
   701→                saveSettings({ customerId: result.customerId });
   702→                loginModal?.classList.add('hidden');
   703→
   704→                if (typeof refreshCredits === 'function') {
   705→                    await refreshCredits();
   706→                }
   707→
   708→                setStatus(`License activated! ${result.tierName} tier`);
   709→            } catch (err) {
   710→                console.error('[SPLICE] License activation error:', err);
   711→                showLoginError('Connection error. Check server is running.');
   712→            } finally {
   713→                saveLoginBtn.disabled = false;
   714→                saveLoginBtn.textContent = 'Activate';
   715→            }
   716→        });
   717→    }
   718→
   719→    // Email lookup
   720→    const lookupLicenseBtn = document.getElementById('lookupLicenseBtn');
   721→    const lookupEmailInput = document.getElementById('lookupEmailInput');
   722→
   723→    if (lookupLicenseBtn) {
   724→        lookupLicenseBtn.addEventListener('click', async () => {
   725→            const email = lookupEmailInput?.value?.trim()?.toLowerCase();
   726→
   727→            if (!email) {
   728→                showLoginError('Please enter your email address');
   729→                return;
   730→            }
   731→
   732→            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
   733→            if (!emailRegex.test(email)) {
   734→                showLoginError('Please enter a valid email address');
   735→                return;
   736→            }
   737→
   738→            lookupLicenseBtn.disabled = true;
   739→            lookupLicenseBtn.textContent = 'Looking up...';
   740→
   741→            try {
   742→                const response = await fetchWithTimeout(`${getBackendUrl()}/license/lookup`, {
   743→                    method: 'POST',
   744→                    headers: { 'Content-Type': 'application/json' },
   745→                    body: JSON.stringify({ email })
   746→                }, 30000);
   747→
   748→                const result = await response.json();
   749→
   750→                // Note: For security, the backend does NOT return the license key directly.
   751→                // It sends the key via email to prevent enumeration attacks.
   752→                if (result.success) {
   753→                    setStatus(result.message || 'If a license exists, it will be sent to your email.');
   754→                } else {
   755→                    showLoginError(result.error || 'Lookup failed. Please try again.');
   756→                }
   757→            } catch (err) {
   758→                console.error('[SPLICE] License lookup error:', err);
   759→                showLoginError('Failed to look up license. Please try again.');
   760→            } finally {
   761→                lookupLicenseBtn.disabled = false;
   762→                lookupLicenseBtn.textContent = 'Lookup';
   763→            }
   764→        });
   765→    }
   766→}
   767→
   768→/**
   769→ * Show login modal
   770→ */
   771→function showLoginModal() {
   772→    const loginModal = document.getElementById('loginModal');
   773→    const loginError = document.getElementById('loginError');
   774→    if (loginError) loginError.style.display = 'none';
   775→    if (loginModal) loginModal.classList.remove('hidden');
   776→}
   777→
   778→/**
   779→ * Show login error message
   780→ */
   781→function showLoginError(message) {
   782→    const loginError = document.getElementById('loginError');
   783→    if (loginError) {
   784→        loginError.textContent = message;
   785→        loginError.style.display = 'block';
   786→    }
   787→}
   788→
   789→/**
   790→ * Check if user is logged in
   791→ */
   792→function isLoggedIn() {
   793→    const settings = getSettings();
   794→    return !!settings.customerId;
   795→}
   796→
   797→/**
   798→ * Logout - clear customer ID
   799→ */
   800→function logout() {
   801→    saveSettings({ customerId: null });
   802→    if (typeof clearCreditsCache === 'function') {
   803→        clearCreditsCache();
   804→    }
   805→    if (typeof updateCreditDisplay === 'function') {
   806→        updateCreditDisplay(null);
   807→    }
   808→    setStatus('Logged out');
   809→}
   810→
   811→// Initialize JSX bridge when loaded
   812→document.addEventListener('DOMContentLoaded', () => {
   813→    jsx.init();
   814→});
   815→
   816→// Export for modules
   817→window.SPLICE_CONFIG = SPLICE_CONFIG;
   818→window.getBackendUrl = getBackendUrl;
   819→window.fetchWithTimeout = fetchWithTimeout;
   820→window.parseErrorResponse = parseErrorResponse;
   821→window.getAuthHeaders = getAuthHeaders;
   822→window.getSettings = getSettings;
   823→window.saveSettings = saveSettings;
   824→window.clearSetting = clearSetting;
   825→window.isOnline = isOnline;
   826→window.initOfflineDetection = initOfflineDetection;
   827→window.formatTime = formatTime;
   828→window.setStatus = setStatus;
   829→window.debounce = debounce;
   830→window.jsx = jsx;
   831→window.PRESETS = PRESETS;
   832→window.getPresets = getPresets;
   833→window.getPreset = getPreset;
   834→window.applyPreset = applyPreset;
   835→window.getActivePreset = getActivePreset;
   836→window.isBuiltInPreset = isBuiltInPreset;
   837→window.initPresetSelector = initPresetSelector;
   838→window.initLoginModal = initLoginModal;
   839→window.showLoginModal = showLoginModal;
   840→window.isLoggedIn = isLoggedIn;
   841→window.logout = logout;
   842→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
