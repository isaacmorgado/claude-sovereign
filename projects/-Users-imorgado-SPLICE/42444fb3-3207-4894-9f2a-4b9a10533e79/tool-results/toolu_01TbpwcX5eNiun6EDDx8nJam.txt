     1â†’/**
     2â†’ * SPLICE CEP Panel - Main Entry Point
     3â†’ * v4.0.0 - CEP Migration
     4â†’ */
     5â†’
     6â†’// ============================================================================
     7â†’// CACHED DOM ELEMENTS
     8â†’// ============================================================================
     9â†’const ui = {};
    10â†’
    11â†’function cacheUIElements() {
    12â†’    ui.status = document.getElementById('status');
    13â†’    ui.goBtn = document.getElementById('goBtn');
    14â†’    ui.optionsToggle = document.getElementById('optionsToggle');
    15â†’    ui.optionsPanel = document.getElementById('optionsPanel');
    16â†’
    17â†’    // Sliders and options
    18â†’    ui.sensitivitySlider = document.getElementById('sensitivitySlider');
    19â†’    ui.sensitivityValue = document.getElementById('sensitivityValue');
    20â†’    ui.sourceOriginal = document.getElementById('sourceOriginal');
    21â†’    ui.sourceIsolated = document.getElementById('sourceIsolated');
    22â†’
    23â†’    // Feature toggles
    24â†’    ui.enableTakesDetection = document.getElementById('enableTakesDetection');
    25â†’    ui.enableJCut = document.getElementById('enableJCut');
    26â†’    ui.jcutSettings = document.getElementById('jcutSettings');
    27â†’    ui.jcutLeadIn = document.getElementById('jcutLeadIn');
    28â†’    ui.jcutLeadInValue = document.getElementById('jcutLeadInValue');
    29â†’    ui.jcutLeadOut = document.getElementById('jcutLeadOut');
    30â†’    ui.jcutLeadOutValue = document.getElementById('jcutLeadOutValue');
    31â†’
    32â†’    // Zoom settings
    33â†’    ui.enableZoom = document.getElementById('enableZoom');
    34â†’    ui.zoomSettings = document.getElementById('zoomSettings');
    35â†’    ui.zoomFrequency = document.getElementById('zoomFrequency');
    36â†’    ui.zoomPreset = document.getElementById('zoomPreset');
    37â†’    ui.zoomPlacement = document.getElementById('zoomPlacement');
    38â†’
    39â†’    // Chapter settings
    40â†’    ui.enableChapters = document.getElementById('enableChapters');
    41â†’    ui.chapterSettings = document.getElementById('chapterSettings');
    42â†’    ui.maxChapters = document.getElementById('maxChapters');
    43â†’    ui.minChapterLength = document.getElementById('minChapterLength');
    44â†’
    45â†’    // Progress
    46â†’    ui.progressContainer = document.getElementById('progressContainer');
    47â†’    ui.progressBar = document.getElementById('progressBar');
    48â†’    ui.progressText = document.getElementById('progressText');
    49â†’    ui.resultsEmpty = document.getElementById('resultsEmpty');
    50â†’
    51â†’    // Preview
    52â†’    ui.combinedPreview = document.getElementById('combinedPreview');
    53â†’    ui.previewList = document.getElementById('previewList');
    54â†’    ui.silenceCount = document.getElementById('silenceCount');
    55â†’    ui.takeCount = document.getElementById('takeCount');
    56â†’    ui.selectedCount = document.getElementById('selectedCount');
    57â†’    ui.selectAllSilences = document.getElementById('selectAllSilences');
    58â†’    ui.applyPreviewBtn = document.getElementById('applyPreviewBtn');
    59â†’    ui.cancelPreviewBtn = document.getElementById('cancelPreviewBtn');
    60â†’    ui.buildSequenceBtn = document.getElementById('buildSequenceBtn');
    61â†’
    62â†’    // Results
    63â†’    ui.zoomResults = document.getElementById('zoomResults');
    64â†’    ui.zoomList = document.getElementById('zoomList');
    65â†’    ui.chapterResults = document.getElementById('chapterResults');
    66â†’    ui.chapterList = document.getElementById('chapterList');
    67â†’    ui.copyYouTubeBtn = document.getElementById('copyYouTubeBtn');
    68â†’    ui.addChapterMarkersBtn = document.getElementById('addChapterMarkersBtn');
    69â†’
    70â†’    // Modals
    71â†’    ui.settingsBtn = document.getElementById('settingsBtn');
    72â†’    ui.settingsModal = document.getElementById('settingsModal');
    73â†’    ui.closeSettingsBtn = document.getElementById('closeSettingsBtn');
    74â†’    ui.loginModal = document.getElementById('loginModal');
    75â†’    ui.closeLoginBtn = document.getElementById('closeLoginBtn');
    76â†’    ui.licenseKeyInput = document.getElementById('licenseKeyInput');
    77â†’    ui.saveLoginBtn = document.getElementById('saveLoginBtn');
    78â†’
    79â†’    // Credit badge
    80â†’    ui.creditBadge = document.getElementById('creditBadge');
    81â†’
    82â†’    // Preset selector
    83â†’    ui.presetSelector = document.getElementById('presetSelector');
    84â†’}
    85â†’
    86â†’// ============================================================================
    87â†’// STATE MANAGEMENT
    88â†’// ============================================================================
    89â†’let previewSilences = [];
    90â†’let previewTakes = [];
    91â†’let currentChapters = [];
    92â†’let currentZooms = [];
    93â†’let selectedSilenceIndices = new Set();
    94â†’let isOperationInProgress = false;
    95â†’let lastDetectionResult = null;
    96â†’let currentAudioPath = null;
    97â†’let currentSequenceInfo = null;
    98â†’let currentTranscript = null;
    99â†’
   100â†’// Global state for captions/reframe modules
   101â†’window.spliceState = {
   102â†’    lastTranscript: null,
   103â†’    currentVideoPath: null,
   104â†’    activeSequence: null,
   105â†’    audioPath: null
   106â†’};
   107â†’
   108â†’// Also expose transcript globally for music module
   109â†’window.currentTranscript = null;
   110â†’
   111â†’// ============================================================================
   112â†’// INITIALIZATION
   113â†’// ============================================================================
   114â†’document.addEventListener('DOMContentLoaded', async () => {
   115â†’    // Premium Loading Experience
   116â†’    setTimeout(() => {
   117â†’        const loader = document.getElementById('loading-overlay');
   118â†’        if (loader) loader.classList.add('hidden');
   119â†’    }, 800); // Small delay for smooth perception
   120â†’    console.log('[SPLICE] Initializing CEP panel...');
   121â†’
   122â†’    // Cache DOM elements
   123â†’    cacheUIElements();
   124â†’
   125â†’    // Load settings
   126â†’    loadSettingsToUI();
   127â†’
   128â†’    // Initialize UI handlers
   129â†’    initOptionsToggle();
   130â†’    initSliders();
   131â†’    initFeatureToggles();
   132â†’    initPresetSelector();
   133â†’    initGoButton();
   134â†’    initPreviewHandlers();
   135â†’    initModals();
   136â†’    initCredits();
   137â†’    initHelpButton();
   138â†’
   139â†’    // Initialize offline detection
   140â†’    if (typeof initOfflineDetection === 'function') {
   141â†’        initOfflineDetection();
   142â†’    }
   143â†’
   144â†’    // Initialize multitrack UI
   145â†’    if (typeof initMultitrackUI === 'function') {
   146â†’        initMultitrackUI();
   147â†’    }
   148â†’
   149â†’    // Initialize animated captions UI
   150â†’    if (typeof initAnimatedCaptions === 'function') {
   151â†’        initAnimatedCaptions();
   152â†’    }
   153â†’
   154â†’    // Initialize text editor UI
   155â†’    if (typeof initTextEditor === 'function') {
   156â†’        initTextEditor();
   157â†’    }
   158â†’
   159â†’    // Initialize text editor section toggle
   160â†’    initTextEditorToggle();
   161â†’
   162â†’    // Initialize social reframe UI
   163â†’    if (typeof initSocialReframe === 'function') {
   164â†’        initSocialReframe();
   165â†’    }
   166â†’
   167â†’    // Initialize social reframe section toggle
   168â†’    initSocialReframeToggle();
   169â†’
   170â†’    // Initialize music UI
   171â†’    if (typeof initMusicModule === 'function') {
   172â†’        initMusicModule();
   173â†’    }
   174â†’
   175â†’    // Initialize music section toggle
   176â†’    initMusicToggle();
   177â†’
   178â†’    // Check JSX connection
   179â†’    await checkJSXConnection();
   180â†’
   181â†’    setStatus('Ready');
   182â†’    console.log('[SPLICE] CEP panel initialized');
   183â†’});
   184â†’
   185â†’// ============================================================================
   186â†’// JSX CONNECTION CHECK
   187â†’// ============================================================================
   188â†’async function checkJSXConnection() {
   189â†’    try {
   190â†’        const result = await jsx.call('getVersion');
   191â†’        console.log('[SPLICE] JSX connection OK, version:', result);
   192â†’        return true;
   193â†’    } catch (e) {
   194â†’        console.warn('[SPLICE] JSX connection failed:', e.message);
   195â†’        setStatus('Premiere Pro connection failed', true);
   196â†’        return false;
   197â†’    }
   198â†’}
   199â†’
   200â†’async function checkSequenceOpen() {
   201â†’    try {
   202â†’        const result = await jsx.call('checkSequenceOpen');
   203â†’        return result === true || result === 'true';
   204â†’    } catch {
   205â†’        return false;
   206â†’    }
   207â†’}
   208â†’
   209â†’// ============================================================================
   210â†’// OPTIONS TOGGLE
   211â†’// ============================================================================
   212â†’function initOptionsToggle() {
   213â†’    if (ui.optionsToggle && ui.optionsPanel) {
   214â†’        ui.optionsToggle.addEventListener('click', () => {
   215â†’            const isExpanded = ui.optionsPanel.classList.toggle('collapsed');
   216â†’            ui.optionsToggle.classList.toggle('expanded', !isExpanded);
   217â†’            saveSettings({ expandedOptions: !isExpanded });
   218â†’        });
   219â†’
   220â†’        // Restore state
   221â†’        const settings = getSettings();
   222â†’        if (!settings.expandedOptions) {
   223â†’            ui.optionsPanel.classList.add('collapsed');
   224â†’        } else {
   225â†’            ui.optionsToggle.classList.add('expanded');
   226â†’        }
   227â†’    }
   228â†’}
   229â†’
   230â†’// ============================================================================
   231â†’// TEXT EDITOR TOGGLE
   232â†’// ============================================================================
   233â†’function initTextEditorToggle() {
   234â†’    const toggle = document.getElementById('textEditorToggle');
   235â†’    const panel = document.getElementById('text-editor-panel');
   236â†’
   237â†’    if (toggle && panel) {
   238â†’        toggle.addEventListener('click', () => {
   239â†’            const isCollapsed = panel.classList.toggle('collapsed');
   240â†’            const icon = toggle.querySelector('.toggle-icon');
   241â†’            if (icon) {
   242â†’                icon.textContent = isCollapsed ? '+' : '-';
   243â†’            }
   244â†’        });
   245â†’    }
   246â†’}
   247â†’
   248â†’// ============================================================================
   249â†’// SOCIAL REFRAME TOGGLE
   250â†’// ============================================================================
   251â†’function initSocialReframeToggle() {
   252â†’    const toggle = document.getElementById('socialReframeToggle');
   253â†’    const panel = document.getElementById('social-reframe-panel');
   254â†’
   255â†’    if (toggle && panel) {
   256â†’        toggle.addEventListener('click', () => {
   257â†’            const isCollapsed = panel.classList.toggle('collapsed');
   258â†’            const icon = toggle.querySelector('.toggle-icon');
   259â†’            if (icon) {
   260â†’                icon.textContent = isCollapsed ? '+' : '-';
   261â†’            }
   262â†’        });
   263â†’    }
   264â†’}
   265â†’
   266â†’// ============================================================================
   267â†’// MUSIC TOGGLE
   268â†’// ============================================================================
   269â†’function initMusicToggle() {
   270â†’    const toggle = document.getElementById('musicToggle');
   271â†’    const panel = document.getElementById('music-panel');
   272â†’
   273â†’    if (toggle && panel) {
   274â†’        toggle.addEventListener('click', () => {
   275â†’            const isCollapsed = panel.classList.toggle('collapsed');
   276â†’            const icon = toggle.querySelector('.toggle-icon');
   277â†’            if (icon) {
   278â†’                icon.textContent = isCollapsed ? '+' : '-';
   279â†’            }
   280â†’        });
   281â†’    }
   282â†’}
   283â†’
   284â†’// ============================================================================
   285â†’// SLIDERS
   286â†’// ============================================================================
   287â†’function initSliders() {
   288â†’    // Sensitivity slider
   289â†’    if (ui.sensitivitySlider && ui.sensitivityValue) {
   290â†’        ui.sensitivitySlider.addEventListener('input', () => {
   291â†’            ui.sensitivityValue.textContent = ui.sensitivitySlider.value;
   292â†’            saveSettings({ sensitivity: parseInt(ui.sensitivitySlider.value) });
   293â†’        });
   294â†’    }
   295â†’
   296â†’    // J-Cut sliders
   297â†’    if (ui.jcutLeadIn && ui.jcutLeadInValue) {
   298â†’        ui.jcutLeadIn.addEventListener('input', () => {
   299â†’            const val = (ui.jcutLeadIn.value / 100).toFixed(2);
   300â†’            ui.jcutLeadInValue.textContent = val + 's';
   301â†’            saveSettings({ jcutLeadIn: parseFloat(val) });
   302â†’        });
   303â†’    }
   304â†’
   305â†’    if (ui.jcutLeadOut && ui.jcutLeadOutValue) {
   306â†’        ui.jcutLeadOut.addEventListener('input', () => {
   307â†’            const val = (ui.jcutLeadOut.value / 100).toFixed(2);
   308â†’            ui.jcutLeadOutValue.textContent = val + 's';
   309â†’            saveSettings({ jcutLeadOut: parseFloat(val) });
   310â†’        });
   311â†’    }
   312â†’}
   313â†’
   314â†’// ============================================================================
   315â†’// FEATURE TOGGLES
   316â†’// ============================================================================
   317â†’function initFeatureToggles() {
   318â†’    // J-Cut toggle
   319â†’    if (ui.enableJCut && ui.jcutSettings) {
   320â†’        ui.enableJCut.addEventListener('change', () => {
   321â†’            ui.jcutSettings.classList.toggle('collapsed', !ui.enableJCut.checked);
   322â†’            saveSettings({ enableJCut: ui.enableJCut.checked });
   323â†’        });
   324â†’    }
   325â†’
   326â†’    // Zoom toggle
   327â†’    if (ui.enableZoom && ui.zoomSettings) {
   328â†’        ui.enableZoom.addEventListener('change', () => {
   329â†’            ui.zoomSettings.classList.toggle('collapsed', !ui.enableZoom.checked);
   330â†’            saveSettings({ enableZoom: ui.enableZoom.checked });
   331â†’        });
   332â†’    }
   333â†’
   334â†’    // Chapters toggle
   335â†’    if (ui.enableChapters && ui.chapterSettings) {
   336â†’        ui.enableChapters.addEventListener('change', () => {
   337â†’            ui.chapterSettings.classList.toggle('collapsed', !ui.enableChapters.checked);
   338â†’            saveSettings({ enableChapters: ui.enableChapters.checked });
   339â†’        });
   340â†’    }
   341â†’
   342â†’    // Takes detection toggle
   343â†’    if (ui.enableTakesDetection) {
   344â†’        ui.enableTakesDetection.addEventListener('change', () => {
   345â†’            saveSettings({ enableTakesDetection: ui.enableTakesDetection.checked });
   346â†’        });
   347â†’    }
   348â†’}
   349â†’
   350â†’// ============================================================================
   351â†’// PRESET SELECTOR
   352â†’// ============================================================================
   353â†’// PRESETS is defined in config.js
   354â†’
   355â†’function initPresetSelector() {
   356â†’    if (!ui.presetSelector) return;
   357â†’
   358â†’    ui.presetSelector.addEventListener('change', () => {
   359â†’        const presetId = ui.presetSelector.value;
   360â†’        applyPreset(presetId);
   361â†’    });
   362â†’
   363â†’    // Load current preset
   364â†’    const settings = getSettings();
   365â†’    if (settings.activePreset) {
   366â†’        ui.presetSelector.value = settings.activePreset;
   367â†’    }
   368â†’}
   369â†’
   370â†’function applyPreset(presetId) {
   371â†’    const preset = PRESETS[presetId];
   372â†’    if (!preset) return;
   373â†’
   374â†’    // Custom preset - keep current settings
   375â†’    if (presetId === 'custom' || !preset.settings) {
   376â†’        saveSettings({ activePreset: 'custom' });
   377â†’        setStatus('Using custom settings');
   378â†’        return;
   379â†’    }
   380â†’
   381â†’    const settings = preset.settings;
   382â†’
   383â†’    // Apply to UI
   384â†’    if (ui.sensitivitySlider && settings.sensitivity !== undefined) {
   385â†’        ui.sensitivitySlider.value = settings.sensitivity;
   386â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = settings.sensitivity;
   387â†’    }
   388â†’
   389â†’    if (ui.enableJCut) {
   390â†’        ui.enableJCut.checked = settings.enableJCut || false;
   391â†’        if (ui.jcutSettings) {
   392â†’            ui.jcutSettings.classList.toggle('collapsed', !settings.enableJCut);
   393â†’        }
   394â†’    }
   395â†’
   396â†’    if (settings.jCutLeadIn !== undefined && ui.jcutLeadIn) {
   397â†’        ui.jcutLeadIn.value = Math.round(settings.jCutLeadIn * 100);
   398â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = settings.jCutLeadIn + 's';
   399â†’    }
   400â†’
   401â†’    if (settings.jCutLeadOut !== undefined && ui.jcutLeadOut) {
   402â†’        ui.jcutLeadOut.value = Math.round(settings.jCutLeadOut * 100);
   403â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = settings.jCutLeadOut + 's';
   404â†’    }
   405â†’
   406â†’    // Save merged settings
   407â†’    saveSettings({
   408â†’        activePreset: presetId,
   409â†’        sensitivity: settings.sensitivity,
   410â†’        threshold: settings.threshold,
   411â†’        minSilenceLength: settings.minSilenceLength,
   412â†’        paddingStart: settings.paddingStart,
   413â†’        paddingEnd: settings.paddingEnd,
   414â†’        enableTakesDetection: settings.enableTakesDetection,
   415â†’        enableJCut: settings.enableJCut || false,
   416â†’        jcutLeadIn: settings.jCutLeadIn || 0.3,
   417â†’        jcutLeadOut: settings.jCutLeadOut || 0.2
   418â†’    });
   419â†’
   420â†’    setStatus(`Applied ${preset.name} preset`);
   421â†’}
   422â†’
   423â†’// ============================================================================
   424â†’// LOAD SETTINGS TO UI
   425â†’// ============================================================================
   426â†’function loadSettingsToUI() {
   427â†’    const settings = getSettings();
   428â†’
   429â†’    if (ui.sensitivitySlider) {
   430â†’        ui.sensitivitySlider.value = settings.sensitivity;
   431â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = settings.sensitivity;
   432â†’    }
   433â†’
   434â†’    if (ui.enableTakesDetection) ui.enableTakesDetection.checked = settings.enableTakesDetection;
   435â†’    if (ui.enableJCut) ui.enableJCut.checked = settings.enableJCut;
   436â†’    if (ui.enableZoom) ui.enableZoom.checked = settings.enableZoom;
   437â†’    if (ui.enableChapters) ui.enableChapters.checked = settings.enableChapters;
   438â†’
   439â†’    if (ui.jcutSettings) ui.jcutSettings.classList.toggle('collapsed', !settings.enableJCut);
   440â†’    if (ui.zoomSettings) ui.zoomSettings.classList.toggle('collapsed', !settings.enableZoom);
   441â†’    if (ui.chapterSettings) ui.chapterSettings.classList.toggle('collapsed', !settings.enableChapters);
   442â†’
   443â†’    if (ui.jcutLeadIn) {
   444â†’        ui.jcutLeadIn.value = Math.round(settings.jcutLeadIn * 100);
   445â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = settings.jcutLeadIn + 's';
   446â†’    }
   447â†’    if (ui.jcutLeadOut) {
   448â†’        ui.jcutLeadOut.value = Math.round(settings.jcutLeadOut * 100);
   449â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = settings.jcutLeadOut + 's';
   450â†’    }
   451â†’
   452â†’    if (ui.presetSelector && settings.activePreset) {
   453â†’        ui.presetSelector.value = settings.activePreset;
   454â†’    }
   455â†’}
   456â†’
   457â†’// ============================================================================
   458â†’// GO BUTTON - MAIN WORKFLOW
   459â†’// ============================================================================
   460â†’function initGoButton() {
   461â†’    if (!ui.goBtn) return;
   462â†’
   463â†’    ui.goBtn.addEventListener('click', async () => {
   464â†’        if (isOperationInProgress) return;
   465â†’        await runDetection();
   466â†’    });
   467â†’}
   468â†’
   469â†’async function runDetection() {
   470â†’    if (isOperationInProgress) return;
   471â†’
   472â†’    // Check sequence
   473â†’    const hasSequence = await checkSequenceOpen();
   474â†’    if (!hasSequence) {
   475â†’        setStatus('Please open a sequence first', true);
   476â†’        return;
   477â†’    }
   478â†’
   479â†’    // Check online
   480â†’    if (!isOnline()) {
   481â†’        setStatus('Offline - Check your connection', true);
   482â†’        return;
   483â†’    }
   484â†’
   485â†’    isOperationInProgress = true;
   486â†’    ui.goBtn.disabled = true;
   487â†’    showProgress('Detecting silences...');
   488â†’
   489â†’    try {
   490â†’        const settings = getSettings();
   491â†’
   492â†’        // Get sequence info
   493â†’        const seqInfo = await jsx.call('getActiveSequence');
   494â†’        console.log('[SPLICE] Sequence info:', seqInfo);
   495â†’
   496â†’        // Store sequence info for later use
   497â†’        currentSequenceInfo = seqInfo;
   498â†’        window.spliceState.activeSequence = seqInfo;
   499â†’        if (seqInfo && seqInfo.videoPath) {
   500â†’            window.spliceState.currentVideoPath = seqInfo.videoPath;
   501â†’        }
   502â†’
   503â†’        // Export audio via JSX for silence detection
   504â†’        updateProgress(10, 'Exporting audio...');
   505â†’
   506â†’        let audioFilePath = null;
   507â†’        try {
   508â†’            // Get sequence info for audio export
   509â†’            const exportResult = await jsx.call('exportSequenceAudioForAnalysis');
   510â†’            if (exportResult && exportResult.success && exportResult.outputPath) {
   511â†’                audioFilePath = exportResult.outputPath;
   512â†’                console.log('[SPLICE] Audio exported to:', audioFilePath);
   513â†’            } else if (exportResult && exportResult.error) {
   514â†’                throw new Error(exportResult.error);
   515â†’            }
   516â†’        } catch (exportError) {
   517â†’            console.warn('[SPLICE] Audio export failed, trying fallback:', exportError.message);
   518â†’            // Try to get audio from first clip in timeline
   519â†’            try {
   520â†’                const clipInfo = await jsx.call('getFirstClipAudioPath');
   521â†’                if (clipInfo && clipInfo.path) {
   522â†’                    audioFilePath = clipInfo.path;
   523â†’                    console.log('[SPLICE] Using clip audio path:', audioFilePath);
   524â†’                }
   525â†’            } catch (clipError) {
   526â†’                console.warn('[SPLICE] Fallback audio path failed:', clipError.message);
   527â†’            }
   528â†’        }
   529â†’
   530â†’        if (!audioFilePath) {
   531â†’            throw new Error('Could not export or locate audio file. Please ensure sequence has audio tracks.');
   532â†’        }
   533â†’
   534â†’        // Store audio path globally for other modules
   535â†’        currentAudioPath = audioFilePath;
   536â†’        window.spliceState.audioPath = audioFilePath;
   537â†’
   538â†’        // Call backend for silence detection with audio file path
   539â†’        updateProgress(30, 'Detecting silences...');
   540â†’        const silenceResponse = await fetchWithTimeout(
   541â†’            `${getBackendUrl()}/silences-rms`,
   542â†’            {
   543â†’                method: 'POST',
   544â†’                headers: getAuthHeaders(),
   545â†’                body: JSON.stringify({
   546â†’                    wavPath: audioFilePath,
   547â†’                    sensitivity: settings.sensitivity,
   548â†’                    minSilenceLength: settings.minSilenceLength || 0.5
   549â†’                })
   550â†’            }
   551â†’        );
   552â†’
   553â†’        if (!silenceResponse.ok) {
   554â†’            throw new Error(await parseErrorResponse(silenceResponse));
   555â†’        }
   556â†’
   557â†’        const silenceData = await silenceResponse.json();
   558â†’        previewSilences = silenceData.silences || [];
   559â†’
   560â†’        // Detect takes if enabled
   561â†’        if (settings.enableTakesDetection) {
   562â†’            updateProgress(60, 'Detecting takes...');
   563â†’            const analyzeResponse = await fetchWithTimeout(
   564â†’                `${getBackendUrl()}/analyze`,
   565â†’                {
   566â†’                    method: 'POST',
   567â†’                    headers: getAuthHeaders(),
   568â†’                    body: JSON.stringify({
   569â†’                        wavPath: audioFilePath,
   570â†’                        detectTakes: true
   571â†’                    })
   572â†’                }
   573â†’            );
   574â†’
   575â†’            if (analyzeResponse.ok) {
   576â†’                const analyzeData = await analyzeResponse.json();
   577â†’                previewTakes = analyzeData.takes || [];
   578â†’
   579â†’                // Store transcript for captions/music modules
   580â†’                if (analyzeData.transcript) {
   581â†’                    currentTranscript = analyzeData.transcript;
   582â†’                    window.currentTranscript = analyzeData.transcript;
   583â†’                    window.spliceState.lastTranscript = analyzeData.transcript;
   584â†’                }
   585â†’            }
   586â†’        }
   587â†’
   588â†’        // Detect chapters if enabled
   589â†’        if (settings.enableChapters) {
   590â†’            updateProgress(80, 'Detecting chapters...');
   591â†’            try {
   592â†’                const chapterResponse = await fetchWithTimeout(
   593â†’                    `${getBackendUrl()}/chapters`,
   594â†’                    {
   595â†’                        method: 'POST',
   596â†’                        headers: getAuthHeaders(),
   597â†’                        body: JSON.stringify({
   598â†’                            wavPath: audioFilePath,
   599â†’                            transcript: currentTranscript,
   600â†’                            maxChapters: settings.maxChapters || 10,
   601â†’                            minChapterLength: settings.minChapterLength || 60
   602â†’                        })
   603â†’                    }
   604â†’                );
   605â†’
   606â†’                if (chapterResponse.ok) {
   607â†’                    const chapterData = await chapterResponse.json();
   608â†’                    currentChapters = chapterData.chapters || [];
   609â†’                }
   610â†’            } catch (e) {
   611â†’                console.warn('[SPLICE] Chapter detection failed:', e);
   612â†’            }
   613â†’        }
   614â†’
   615â†’        // Detect zoom points if enabled
   616â†’        if (settings.enableZoom) {
   617â†’            updateProgress(90, 'Detecting zoom points...');
   618â†’            try {
   619â†’                const zoomResponse = await fetchWithTimeout(
   620â†’                    `${getBackendUrl()}/zoom`,
   621â†’                    {
   622â†’                        method: 'POST',
   623â†’                        headers: getAuthHeaders(),
   624â†’                        body: JSON.stringify({
   625â†’                            wavPath: audioFilePath,
   626â†’                            transcript: currentTranscript,
   627â†’                            frequency: settings.zoomFrequency || 'medium',
   628â†’                            preset: settings.zoomPreset || 'medium',
   629â†’                            placement: settings.zoomPlacement || 'sentence_start'
   630â†’                        })
   631â†’                    }
   632â†’                );
   633â†’
   634â†’                if (zoomResponse.ok) {
   635â†’                    const zoomData = await zoomResponse.json();
   636â†’                    currentZooms = zoomData.zoomPoints || [];
   637â†’                }
   638â†’            } catch (e) {
   639â†’                console.warn('[SPLICE] Zoom detection failed:', e);
   640â†’            }
   641â†’        }
   642â†’
   643â†’        // Store results
   644â†’        lastDetectionResult = {
   645â†’            silences: previewSilences,
   646â†’            takes: previewTakes,
   647â†’            chapters: currentChapters,
   648â†’            zooms: currentZooms
   649â†’        };
   650â†’
   651â†’        // Show preview
   652â†’        hideProgress();
   653â†’        showCombinedPreview();
   654â†’        setStatus(`Found ${previewSilences.length} silences, ${previewTakes.length} takes`);
   655â†’
   656â†’    } catch (error) {
   657â†’        console.error('[SPLICE] Detection error:', error);
   658â†’        setStatus('Detection failed: ' + error.message, true);
   659â†’        hideProgress();
   660â†’    } finally {
   661â†’        isOperationInProgress = false;
   662â†’        ui.goBtn.disabled = false;
   663â†’    }
   664â†’}
   665â†’
   666â†’// ============================================================================
   667â†’// PROGRESS UI
   668â†’// ============================================================================
   669â†’function showProgress(message) {
   670â†’    if (ui.progressContainer) ui.progressContainer.classList.remove('hidden');
   671â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   672â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
   673â†’    updateProgress(0, message);
   674â†’}
   675â†’
   676â†’function updateProgress(percent, message) {
   677â†’    if (ui.progressBar) ui.progressBar.style.width = percent + '%';
   678â†’    if (ui.progressText) ui.progressText.textContent = message || '';
   679â†’}
   680â†’
   681â†’function hideProgress() {
   682â†’    if (ui.progressContainer) ui.progressContainer.classList.add('hidden');
   683â†’}
   684â†’
   685â†’// ============================================================================
   686â†’// COMBINED PREVIEW
   687â†’// ============================================================================
   688â†’function showCombinedPreview() {
   689â†’    if (!ui.combinedPreview) return;
   690â†’
   691â†’    ui.combinedPreview.classList.remove('hidden');
   692â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   693â†’
   694â†’    // Update counts
   695â†’    if (ui.silenceCount) ui.silenceCount.textContent = previewSilences.length;
   696â†’    if (ui.takeCount) ui.takeCount.textContent = previewTakes.length;
   697â†’
   698â†’    // Select all by default
   699â†’    selectedSilenceIndices.clear();
   700â†’    previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
   701â†’    updateSelectedCount();
   702â†’
   703â†’    // Render preview list
   704â†’    renderPreviewList();
   705â†’
   706â†’    // Show chapter results if available
   707â†’    if (currentChapters.length > 0 && ui.chapterResults) {
   708â†’        ui.chapterResults.classList.remove('hidden');
   709â†’        renderChapterList();
   710â†’    }
   711â†’
   712â†’    // Show zoom results if available
   713â†’    if (currentZooms.length > 0 && ui.zoomResults) {
   714â†’        ui.zoomResults.classList.remove('hidden');
   715â†’    }
   716â†’}
   717â†’
   718â†’function renderPreviewList() {
   719â†’    if (!ui.previewList) return;
   720â†’
   721â†’    const html = [];
   722â†’
   723â†’    // Render silences
   724â†’    previewSilences.forEach((silence, i) => {
   725â†’        const isSelected = selectedSilenceIndices.has(i);
   726â†’        const duration = silence.end - silence.start;
   727â†’        html.push(`
   728â†’            <div class="preview-item ${isSelected ? '' : 'excluded'}" data-index="${i}" data-type="silence">
   729â†’                <input type="checkbox" class="preview-item-check" ${isSelected ? 'checked' : ''}>
   730â†’                <div class="preview-item-info">
   731â†’                    <div class="preview-item-time">${formatTime(silence.start)} - ${formatTime(silence.end)}</div>
   732â†’                    <div class="preview-item-duration">${duration.toFixed(2)}s silence</div>
   733â†’                </div>
   734â†’            </div>
   735â†’        `);
   736â†’    });
   737â†’
   738â†’    // Render takes
   739â†’    previewTakes.forEach((take, i) => {
   740â†’        html.push(`
   741â†’            <div class="preview-item take-item" data-index="${i}" data-type="take">
   742â†’                <div class="preview-item-icon">ðŸŽ¬</div>
   743â†’                <div class="preview-item-info">
   744â†’                    <div class="preview-item-time">${formatTime(take.start)} - ${formatTime(take.end)}</div>
   745â†’                    <div class="preview-item-label">${take.label || 'Take ' + (take.takeNumber || i + 1)}</div>
   746â†’                </div>
   747â†’            </div>
   748â†’        `);
   749â†’    });
   750â†’
   751â†’    ui.previewList.innerHTML = html.join('');
   752â†’
   753â†’    // Add click handlers
   754â†’    ui.previewList.querySelectorAll('.preview-item').forEach(item => {
   755â†’        item.addEventListener('click', (e) => {
   756â†’            const index = parseInt(item.dataset.index);
   757â†’            const type = item.dataset.type;
   758â†’
   759â†’            if (e.target.classList.contains('preview-item-check')) {
   760â†’                // Checkbox clicked
   761â†’                toggleSilenceSelection(index);
   762â†’            } else {
   763â†’                // Item clicked - seek to time
   764â†’                const data = type === 'silence' ? previewSilences[index] : previewTakes[index];
   765â†’                seekToTime(data.start);
   766â†’            }
   767â†’        });
   768â†’    });
   769â†’}
   770â†’
   771â†’function toggleSilenceSelection(index) {
   772â†’    if (selectedSilenceIndices.has(index)) {
   773â†’        selectedSilenceIndices.delete(index);
   774â†’    } else {
   775â†’        selectedSilenceIndices.add(index);
   776â†’    }
   777â†’    updateSelectedCount();
   778â†’    renderPreviewList();
   779â†’}
   780â†’
   781â†’function updateSelectedCount() {
   782â†’    if (ui.selectedCount) {
   783â†’        ui.selectedCount.textContent = selectedSilenceIndices.size;
   784â†’    }
   785â†’    if (ui.selectAllSilences) {
   786â†’        ui.selectAllSilences.checked = selectedSilenceIndices.size === previewSilences.length;
   787â†’    }
   788â†’}
   789â†’
   790â†’async function seekToTime(seconds) {
   791â†’    try {
   792â†’        // Use JSX to set playhead position
   793â†’        // Note: setPlayerPosition expects ticks as a string without quotes around the number value
   794â†’        const ticks = Math.round(seconds * 254016000000);
   795â†’        await jsx.evalScript(`app.project.activeSequence.setPlayerPosition(${ticks})`);
   796â†’    } catch (e) {
   797â†’        console.warn('[SPLICE] Seek failed:', e);
   798â†’    }
   799â†’}
   800â†’
   801â†’// ============================================================================
   802â†’// CHAPTER LIST
   803â†’// ============================================================================
   804â†’function renderChapterList() {
   805â†’    if (!ui.chapterList) return;
   806â†’
   807â†’    const html = currentChapters.map((chapter, i) => `
   808â†’        <div class="chapter-item" data-index="${i}">
   809â†’            <div class="chapter-time">${formatTime(chapter.startTime)}</div>
   810â†’            <div class="chapter-title">${chapter.title}</div>
   811â†’        </div>
   812â†’    `).join('');
   813â†’
   814â†’    ui.chapterList.innerHTML = html;
   815â†’
   816â†’    // Add click handlers
   817â†’    ui.chapterList.querySelectorAll('.chapter-item').forEach(item => {
   818â†’        item.addEventListener('click', () => {
   819â†’            const index = parseInt(item.dataset.index);
   820â†’            seekToTime(currentChapters[index].startTime);
   821â†’        });
   822â†’    });
   823â†’}
   824â†’
   825â†’// ============================================================================
   826â†’// PREVIEW HANDLERS
   827â†’// ============================================================================
   828â†’function initPreviewHandlers() {
   829â†’    // Select all checkbox
   830â†’    if (ui.selectAllSilences) {
   831â†’        ui.selectAllSilences.addEventListener('change', () => {
   832â†’            if (ui.selectAllSilences.checked) {
   833â†’                previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
   834â†’            } else {
   835â†’                selectedSilenceIndices.clear();
   836â†’            }
   837â†’            updateSelectedCount();
   838â†’            renderPreviewList();
   839â†’        });
   840â†’    }
   841â†’
   842â†’    // Apply button
   843â†’    if (ui.applyPreviewBtn) {
   844â†’        ui.applyPreviewBtn.addEventListener('click', applyPreviewAndMarkers);
   845â†’    }
   846â†’
   847â†’    // Cancel button
   848â†’    if (ui.cancelPreviewBtn) {
   849â†’        ui.cancelPreviewBtn.addEventListener('click', hidePreview);
   850â†’    }
   851â†’
   852â†’    // Build sequence button
   853â†’    if (ui.buildSequenceBtn) {
   854â†’        ui.buildSequenceBtn.addEventListener('click', buildSequence);
   855â†’    }
   856â†’
   857â†’    // Copy YouTube timestamps
   858â†’    if (ui.copyYouTubeBtn) {
   859â†’        ui.copyYouTubeBtn.addEventListener('click', copyYouTubeTimestamps);
   860â†’    }
   861â†’
   862â†’    // Add chapter markers
   863â†’    if (ui.addChapterMarkersBtn) {
   864â†’        ui.addChapterMarkersBtn.addEventListener('click', addChapterMarkers);
   865â†’    }
   866â†’
   867â†’    // Apply zoom markers
   868â†’    const applyZoomsBtn = document.getElementById('applyZoomsBtn');
   869â†’    if (applyZoomsBtn) {
   870â†’        applyZoomsBtn.addEventListener('click', applyZoomMarkers);
   871â†’    }
   872â†’}
   873â†’
   874â†’async function applyPreviewAndMarkers() {
   875â†’    if (isOperationInProgress) return;
   876â†’
   877â†’    isOperationInProgress = true;
   878â†’    setStatus('Adding markers...');
   879â†’
   880â†’    try {
   881â†’        // Add silence markers
   882â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
   883â†’        for (const silence of selectedSilences) {
   884â†’            await jsx.call('createMarker', silence.start, 'SPLICE: Silence', silence.end - silence.start, null, 1);
   885â†’        }
   886â†’
   887â†’        // Add take markers
   888â†’        for (const take of previewTakes) {
   889â†’            await jsx.call('createMarker', take.start, take.label || `Take ${take.takeNumber}`, take.end - take.start, null, 5);
   890â†’        }
   891â†’
   892â†’        setStatus(`Added ${selectedSilences.length + previewTakes.length} markers`);
   893â†’    } catch (error) {
   894â†’        setStatus('Failed to add markers: ' + error.message, true);
   895â†’    } finally {
   896â†’        isOperationInProgress = false;
   897â†’    }
   898â†’}
   899â†’
   900â†’function hidePreview() {
   901â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
   902â†’    if (ui.chapterResults) ui.chapterResults.classList.add('hidden');
   903â†’    if (ui.zoomResults) ui.zoomResults.classList.add('hidden');
   904â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.remove('hidden');
   905â†’    previewSilences = [];
   906â†’    previewTakes = [];
   907â†’    selectedSilenceIndices.clear();
   908â†’}
   909â†’
   910â†’async function buildSequence() {
   911â†’    if (isOperationInProgress) return;
   912â†’
   913â†’    isOperationInProgress = true;
   914â†’    setStatus('Building sequence...');
   915â†’
   916â†’    try {
   917â†’        const settings = getSettings();
   918â†’
   919â†’        // Ensure we have sequence info
   920â†’        if (!currentSequenceInfo) {
   921â†’            currentSequenceInfo = await jsx.call('getActiveSequence');
   922â†’        }
   923â†’
   924â†’        // Create cut list from selected silences
   925â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
   926â†’
   927â†’        // Calculate total duration from sequence info or last silence
   928â†’        let duration = 0;
   929â†’        if (currentSequenceInfo && currentSequenceInfo.duration) {
   930â†’            duration = currentSequenceInfo.duration;
   931â†’        } else if (previewSilences.length > 0) {
   932â†’            const lastSilence = previewSilences[previewSilences.length - 1];
   933â†’            duration = lastSilence.end + 10; // Add buffer
   934â†’        }
   935â†’
   936â†’        // Call backend to generate cut list
   937â†’        const cutListResponse = await fetchWithTimeout(
   938â†’            `${getBackendUrl()}/cut-list`,
   939â†’            {
   940â†’                method: 'POST',
   941â†’                headers: getAuthHeaders(),
   942â†’                body: JSON.stringify({
   943â†’                    sourceName: currentSequenceInfo?.name || 'Untitled Sequence',
   944â†’                    sourcePath: currentSequenceInfo?.treePath || currentSequenceInfo?.name || 'Untitled',
   945â†’                    duration: duration,
   946â†’                    silences: selectedSilences,
   947â†’                    takes: previewTakes,
   948â†’                    enableTakes: settings.enableTakesDetection,
   949â†’                    jCutOffset: settings.enableJCut ? settings.jcutLeadIn : 0,
   950â†’                    lCutOffset: settings.enableJCut ? settings.jcutLeadOut : 0
   951â†’                })
   952â†’            }
   953â†’        );
   954â†’
   955â†’        if (!cutListResponse.ok) {
   956â†’            throw new Error(await parseErrorResponse(cutListResponse));
   957â†’        }
   958â†’
   959â†’        const cutList = await cutListResponse.json();
   960â†’
   961â†’        // Build sequence via JSX
   962â†’        const result = await jsx.call('buildSequenceFromCutList', JSON.stringify(cutList));
   963â†’
   964â†’        if (result && result.success) {
   965â†’            setStatus(`Built sequence: ${result.sequenceName}`);
   966â†’            hidePreview();
   967â†’        } else {
   968â†’            throw new Error(result?.error || 'Build failed');
   969â†’        }
   970â†’    } catch (error) {
   971â†’        setStatus('Build failed: ' + error.message, true);
   972â†’    } finally {
   973â†’        isOperationInProgress = false;
   974â†’    }
   975â†’}
   976â†’
   977â†’function copyYouTubeTimestamps() {
   978â†’    if (currentChapters.length === 0) return;
   979â†’
   980â†’    const timestamps = currentChapters.map(ch =>
   981â†’        `${formatTime(ch.startTime)} ${ch.title}`
   982â†’    ).join('\n');
   983â†’
   984â†’    navigator.clipboard.writeText(timestamps).then(() => {
   985â†’        setStatus('Copied YouTube timestamps');
   986â†’    }).catch(() => {
   987â†’        setStatus('Failed to copy', true);
   988â†’    });
   989â†’}
   990â†’
   991â†’async function addChapterMarkers() {
   992â†’    if (isOperationInProgress || currentChapters.length === 0) return;
   993â†’
   994â†’    isOperationInProgress = true;
   995â†’    setStatus('Adding chapter markers...');
   996â†’
   997â†’    try {
   998â†’        for (const chapter of currentChapters) {
   999â†’            await jsx.call('addChapterMarker', chapter.startTime, chapter.title, chapter.description);
  1000â†’        }
  1001â†’        setStatus(`Added ${currentChapters.length} chapter markers`);
  1002â†’    } catch (error) {
  1003â†’        setStatus('Failed to add markers: ' + error.message, true);
  1004â†’    } finally {
  1005â†’        isOperationInProgress = false;
  1006â†’    }
  1007â†’}
  1008â†’
  1009â†’/**
  1010â†’ * Apply zoom point markers to the timeline
  1011â†’ */
  1012â†’async function applyZoomMarkers() {
  1013â†’    if (isOperationInProgress || currentZooms.length === 0) return;
  1014â†’
  1015â†’    isOperationInProgress = true;
  1016â†’    setStatus('Adding zoom markers...');
  1017â†’
  1018â†’    try {
  1019â†’        for (const zoom of currentZooms) {
  1020â†’            // Create a marker for each zoom point with zoom intensity info
  1021â†’            const comment = `Zoom ${zoom.intensity || 'medium'} - ${zoom.reason || 'emphasis'}`;
  1022â†’            await jsx.call('createMarker', zoom.time, 'SPLICE: Zoom', 0.5, comment, 3);
  1023â†’        }
  1024â†’        setStatus(`Added ${currentZooms.length} zoom markers`);
  1025â†’    } catch (error) {
  1026â†’        setStatus('Failed to add zoom markers: ' + error.message, true);
  1027â†’    } finally {
  1028â†’        isOperationInProgress = false;
  1029â†’    }
  1030â†’}
  1031â†’
  1032â†’// ============================================================================
  1033â†’// MODALS
  1034â†’// ============================================================================
  1035â†’function initModals() {
  1036â†’    // Settings modal
  1037â†’    if (ui.settingsBtn && ui.settingsModal) {
  1038â†’        ui.settingsBtn.addEventListener('click', () => {
  1039â†’            ui.settingsModal.classList.remove('hidden');
  1040â†’            // Sync remember options checkbox with current settings
  1041â†’            const rememberOptions = document.getElementById('rememberOptions');
  1042â†’            if (rememberOptions) {
  1043â†’                rememberOptions.checked = getSettings().rememberOptions;
  1044â†’            }
  1045â†’        });
  1046â†’    }
  1047â†’
  1048â†’    if (ui.closeSettingsBtn && ui.settingsModal) {
  1049â†’        ui.closeSettingsBtn.addEventListener('click', () => {
  1050â†’            ui.settingsModal.classList.add('hidden');
  1051â†’        });
  1052â†’    }
  1053â†’
  1054â†’    // Remember options checkbox
  1055â†’    const rememberOptions = document.getElementById('rememberOptions');
  1056â†’    if (rememberOptions) {
  1057â†’        rememberOptions.addEventListener('change', () => {
  1058â†’            saveSettings({ rememberOptions: rememberOptions.checked });
  1059â†’            if (rememberOptions.checked) {
  1060â†’                setStatus('Options will be remembered');
  1061â†’            } else {
  1062â†’                setStatus('Options will reset to defaults');
  1063â†’            }
  1064â†’        });
  1065â†’    }
  1066â†’
  1067â†’    // Login modal
  1068â†’    if (ui.creditBadge) {
  1069â†’        ui.creditBadge.addEventListener('click', () => {
  1070â†’            const settings = getSettings();
  1071â†’            if (!settings.customerId) {
  1072â†’                showLoginModal();
  1073â†’            }
  1074â†’        });
  1075â†’    }
  1076â†’
  1077â†’    if (ui.closeLoginBtn && ui.loginModal) {
  1078â†’        ui.closeLoginBtn.addEventListener('click', () => {
  1079â†’            ui.loginModal.classList.add('hidden');
  1080â†’        });
  1081â†’    }
  1082â†’
  1083â†’    if (ui.saveLoginBtn) {
  1084â†’        ui.saveLoginBtn.addEventListener('click', activateLicense);
  1085â†’    }
  1086â†’
  1087â†’    // License lookup button
  1088â†’    const lookupLicenseBtn = document.getElementById('lookupLicenseBtn');
  1089â†’    if (lookupLicenseBtn) {
  1090â†’        lookupLicenseBtn.addEventListener('click', lookupLicense);
  1091â†’    }
  1092â†’
  1093â†’    // Close modals on backdrop click
  1094â†’    document.querySelectorAll('.modal').forEach(modal => {
  1095â†’        modal.addEventListener('click', (e) => {
  1096â†’            if (e.target === modal) {
  1097â†’                modal.classList.add('hidden');
  1098â†’            }
  1099â†’        });
  1100â†’    });
  1101â†’}
  1102â†’
  1103â†’function showLoginModal() {
  1104â†’    if (ui.loginModal) ui.loginModal.classList.remove('hidden');
  1105â†’}
  1106â†’
  1107â†’async function activateLicense() {
  1108â†’    if (!ui.licenseKeyInput) return;
  1109â†’
  1110â†’    const licenseKey = ui.licenseKeyInput.value.trim();
  1111â†’    if (!licenseKey) {
  1112â†’        setStatus('Please enter a license key', true);
  1113â†’        return;
  1114â†’    }
  1115â†’
  1116â†’    try {
  1117â†’        const response = await fetchWithTimeout(
  1118â†’            `${getBackendUrl()}/license/activate`,
  1119â†’            {
  1120â†’                method: 'POST',
  1121â†’                headers: { 'Content-Type': 'application/json' },
  1122â†’                body: JSON.stringify({ key: licenseKey })
  1123â†’            }
  1124â†’        );
  1125â†’
  1126â†’        if (!response.ok) {
  1127â†’            throw new Error(await parseErrorResponse(response));
  1128â†’        }
  1129â†’
  1130â†’        const data = await response.json();
  1131â†’        saveSettings({
  1132â†’            customerId: data.customerId,
  1133â†’            licenseKey: licenseKey
  1134â†’        });
  1135â†’
  1136â†’        if (ui.loginModal) ui.loginModal.classList.add('hidden');
  1137â†’        setStatus('License activated');
  1138â†’        updateCredits();
  1139â†’    } catch (error) {
  1140â†’        setStatus('Activation failed: ' + error.message, true);
  1141â†’    }
  1142â†’}
  1143â†’
  1144â†’/**
  1145â†’ * Look up license key by email address
  1146â†’ */
  1147â†’async function lookupLicense() {
  1148â†’    const lookupEmailInput = document.getElementById('lookupEmailInput');
  1149â†’    const licenseKeyInput = document.getElementById('licenseKeyInput');
  1150â†’
  1151â†’    if (!lookupEmailInput) return;
  1152â†’
  1153â†’    const email = lookupEmailInput.value.trim().toLowerCase();
  1154â†’    if (!email) {
  1155â†’        setStatus('Please enter your email address', true);
  1156â†’        return;
  1157â†’    }
  1158â†’
  1159â†’    // Basic email validation
  1160â†’    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  1161â†’    if (!emailRegex.test(email)) {
  1162â†’        setStatus('Please enter a valid email address', true);
  1163â†’        return;
  1164â†’    }
  1165â†’
  1166â†’    const lookupBtn = document.getElementById('lookupLicenseBtn');
  1167â†’    if (lookupBtn) {
  1168â†’        lookupBtn.disabled = true;
  1169â†’        lookupBtn.textContent = 'Looking up...';
  1170â†’    }
  1171â†’
  1172â†’    try {
  1173â†’        const response = await fetchWithTimeout(
  1174â†’            `${getBackendUrl()}/license/lookup`,
  1175â†’            {
  1176â†’                method: 'POST',
  1177â†’                headers: { 'Content-Type': 'application/json' },
  1178â†’                body: JSON.stringify({ email })
  1179â†’            },
  1180â†’            30000
  1181â†’        );
  1182â†’
  1183â†’        const result = await response.json();
  1184â†’
  1185â†’        // Note: For security, the backend does NOT return the license key directly.
  1186â†’        // It sends the key via email to prevent enumeration attacks.
  1187â†’        if (result.success) {
  1188â†’            setStatus(result.message || 'If a license exists, it has been sent to your email.');
  1189â†’        } else {
  1190â†’            setStatus(result.error || 'Lookup failed. Please try again.', true);
  1191â†’        }
  1192â†’    } catch (error) {
  1193â†’        setStatus('Lookup failed: ' + error.message, true);
  1194â†’    } finally {
  1195â†’        if (lookupBtn) {
  1196â†’            lookupBtn.disabled = false;
  1197â†’            lookupBtn.textContent = 'Lookup';
  1198â†’        }
  1199â†’    }
  1200â†’}
  1201â†’
  1202â†’// ============================================================================
  1203â†’// CREDITS
  1204â†’// ============================================================================
  1205â†’function initCredits() {
  1206â†’    updateCredits();
  1207â†’}
  1208â†’
  1209â†’async function updateCredits() {
  1210â†’    if (!ui.creditBadge) return;
  1211â†’
  1212â†’    const settings = getSettings();
  1213â†’    if (!settings.customerId) {
  1214â†’        ui.creditBadge.className = 'credit-badge login';
  1215â†’        ui.creditBadge.textContent = 'Login';
  1216â†’        ui.creditBadge.style.display = 'flex';
  1217â†’        return;
  1218â†’    }
  1219â†’
  1220â†’    try {
  1221â†’        const response = await fetchWithTimeout(
  1222â†’            `${getBackendUrl()}/credits`,
  1223â†’            {
  1224â†’                method: 'GET',
  1225â†’                headers: getAuthHeaders()
  1226â†’            }
  1227â†’        );
  1228â†’
  1229â†’        if (response.ok) {
  1230â†’            const data = await response.json();
  1231â†’            // Backend returns hoursRemaining (not remainingMinutes)
  1232â†’            const hours = (data.hoursRemaining || 0).toFixed(1);
  1233â†’            ui.creditBadge.textContent = `${hours}h`;
  1234â†’            // Low warning when less than 1 hour remaining
  1235â†’            ui.creditBadge.className = data.hoursRemaining < 1 ? 'credit-badge low' : 'credit-badge ok';
  1236â†’            ui.creditBadge.style.display = 'flex';
  1237â†’        } else {
  1238â†’            ui.creditBadge.className = 'credit-badge error';
  1239â†’            ui.creditBadge.textContent = 'Error';
  1240â†’            ui.creditBadge.style.display = 'flex';
  1241â†’        }
  1242â†’    } catch {
  1243â†’        ui.creditBadge.className = 'credit-badge error';
  1244â†’        ui.creditBadge.textContent = 'Offline';
  1245â†’        ui.creditBadge.style.display = 'flex';
  1246â†’    }
  1247â†’}
  1248â†’
  1249â†’// ============================================================================
  1250â†’// HELP BUTTON
  1251â†’// ============================================================================
  1252â†’function initHelpButton() {
  1253â†’    const helpBtn = document.getElementById('helpBtn');
  1254â†’    if (helpBtn) {
  1255â†’        helpBtn.addEventListener('click', () => {
  1256â†’            setStatus('Silence: removes quiet gaps | Takes: detects repeated content | Chapters: AI topic segmentation');
  1257â†’        });
  1258â†’    }
  1259â†’}
  1260â†’
  1261â†’// Export for debugging
  1262â†’window.spliceDebug = {
  1263â†’    getState: () => ({
  1264â†’        silences: previewSilences,
  1265â†’        takes: previewTakes,
  1266â†’        chapters: currentChapters,
  1267â†’        zooms: currentZooms,
  1268â†’        selected: Array.from(selectedSilenceIndices)
  1269â†’    }),
  1270â†’    jsx,
  1271â†’    runDetection
  1272â†’};
  1273â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
