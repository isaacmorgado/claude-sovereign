{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":"Create a contact form API endpoint at `/Users/imorgado/SPLICE/splice-website/src/app/api/contact/route.ts`.\n\nThe endpoint should:\n1. Accept POST requests with JSON body: { name, email, company, teamSize, message }\n2. Validate required fields (name, email, message)\n3. Call the backend to send email notification to sales@splice.app\n4. Return success/error JSON response\n\nUse Next.js App Router conventions (export async function POST).\n\nLook at existing API routes in `/Users/imorgado/SPLICE/splice-website/src/app/api/` for patterns.\n\nThe backend email service is at splice-backend and has a `sendEmail` function, but since this is the website (Next.js), you may need to either:\n- Make an HTTP call to a backend endpoint, OR\n- Use SendGrid directly with SENDGRID_API_KEY env var\n\nCheck what approach other API routes use and be consistent. WRITE the complete file."},"uuid":"fe7b25f7-a992-42d5-b038-0a78012097f9","timestamp":"2025-12-30T00:29:57.373Z"}
{"parentUuid":"fe7b25f7-a992-42d5-b038-0a78012097f9","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_012ejDvU9VcSLMzhSSpZcQ3k","type":"message","role":"assistant","content":[{"type":"text","text":"I'll look at the existing API routes to understand the patterns used in this project."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":0,"cache_read_input_tokens":19597,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWbvipjE8Eyusk4XJTrVE","type":"assistant","uuid":"7e7ae804-8b64-4933-ad4c-0b7c87333405","timestamp":"2025-12-30T00:30:01.935Z"}
{"parentUuid":"7e7ae804-8b64-4933-ad4c-0b7c87333405","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_012ejDvU9VcSLMzhSSpZcQ3k","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0133TVcwfKPYcbjVkrknh1eZ","name":"Glob","input":{"pattern":"**/api/**/*.ts","path":"/Users/imorgado/SPLICE/splice-website/src/app"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":0,"cache_read_input_tokens":19597,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWbvipjE8Eyusk4XJTrVE","type":"assistant","uuid":"2cb6a34d-7fab-481a-8812-cd988b5efe00","timestamp":"2025-12-30T00:30:02.934Z"}
{"parentUuid":"2cb6a34d-7fab-481a-8812-cd988b5efe00","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_012ejDvU9VcSLMzhSSpZcQ3k","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Xv5C3rtmbHHcKwHtEdy5ct","name":"Bash","input":{"command":"ls -la /Users/imorgado/SPLICE/splice-website/src/app/api/","description":"List API directory contents"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":0,"cache_read_input_tokens":19597,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWbvipjE8Eyusk4XJTrVE","type":"assistant","uuid":"a7f05e80-f862-4f96-8cf2-5c6eb0c74f78","timestamp":"2025-12-30T00:30:03.912Z"}
{"parentUuid":"a7f05e80-f862-4f96-8cf2-5c6eb0c74f78","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0133TVcwfKPYcbjVkrknh1eZ","type":"tool_result","content":"/Users/imorgado/SPLICE/splice-website/src/app/api/checkout/route.ts\n/Users/imorgado/SPLICE/splice-website/src/app/api/webhook/route.ts"}]},"uuid":"610627e8-16b9-4e7e-b814-5c1599b01942","timestamp":"2025-12-30T00:30:03.968Z","toolUseResult":{"filenames":["/Users/imorgado/SPLICE/splice-website/src/app/api/checkout/route.ts","/Users/imorgado/SPLICE/splice-website/src/app/api/webhook/route.ts"],"durationMs":10,"numFiles":2,"truncated":false}}
{"parentUuid":"610627e8-16b9-4e7e-b814-5c1599b01942","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Xv5C3rtmbHHcKwHtEdy5ct","type":"tool_result","content":"total 0\ndrwxr-xr-x@  4 imorgado  staff  128 Dec 26 12:14 .\ndrwxr-xr-x@ 20 imorgado  staff  640 Dec 29 19:17 ..\ndrwxr-xr-x@  3 imorgado  staff   96 Dec 26 22:27 checkout\ndrwxr-xr-x@  3 imorgado  staff   96 Dec 27 07:34 webhook","is_error":false}]},"uuid":"cc4e08b2-833a-469d-b06b-059f6670e1e8","timestamp":"2025-12-30T00:30:04.023Z","toolUseResult":{"stdout":"total 0\ndrwxr-xr-x@  4 imorgado  staff  128 Dec 26 12:14 .\ndrwxr-xr-x@ 20 imorgado  staff  640 Dec 29 19:17 ..\ndrwxr-xr-x@  3 imorgado  staff   96 Dec 26 22:27 checkout\ndrwxr-xr-x@  3 imorgado  staff   96 Dec 27 07:34 webhook","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"cc4e08b2-833a-469d-b06b-059f6670e1e8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GnFxEhtpkHR34ipNzqRCZb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012RgbbscPgZT8eqxiX6tnic","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-website/src/app/api/checkout/route.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":425,"cache_read_input_tokens":19597,"cache_creation":{"ephemeral_5m_input_tokens":425,"ephemeral_1h_input_tokens":0},"output_tokens":18,"service_tier":"standard"}},"requestId":"req_011CWbvjJiyDzfhNNM7nJGw1","type":"assistant","uuid":"ad8ec4a3-e9be-45a5-8302-6ae283ea6821","timestamp":"2025-12-30T00:30:07.590Z"}
{"parentUuid":"ad8ec4a3-e9be-45a5-8302-6ae283ea6821","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GnFxEhtpkHR34ipNzqRCZb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XXGuHVUVxT6M5acyfvqMax","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-website/src/app/api/webhook/route.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":425,"cache_read_input_tokens":19597,"cache_creation":{"ephemeral_5m_input_tokens":425,"ephemeral_1h_input_tokens":0},"output_tokens":137,"service_tier":"standard"}},"requestId":"req_011CWbvjJiyDzfhNNM7nJGw1","type":"assistant","uuid":"cdcf8024-a47f-4a3a-93ba-c250f3e3f489","timestamp":"2025-12-30T00:30:08.319Z"}
{"parentUuid":"cdcf8024-a47f-4a3a-93ba-c250f3e3f489","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012RgbbscPgZT8eqxiX6tnic","type":"tool_result","content":"     1‚Üíimport { NextRequest, NextResponse } from \"next/server\";\n     2‚Üíimport Stripe from \"stripe\";\n     3‚Üí\n     4‚Üí// Force Node.js runtime (not Edge) for better Stripe compatibility\n     5‚Üíexport const runtime = \"nodejs\";\n     6‚Üíexport const maxDuration = 30;\n     7‚Üí\n     8‚Üí// Lazy initialization to avoid errors during build\n     9‚Üílet stripe: Stripe | null = null;\n    10‚Üífunction getStripe(): Stripe {\n    11‚Üí  if (!stripe) {\n    12‚Üí    if (!process.env.STRIPE_SECRET_KEY) {\n    13‚Üí      throw new Error(\"STRIPE_SECRET_KEY is not configured\");\n    14‚Üí    }\n    15‚Üí    stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\n    16‚Üí      timeout: 10000,\n    17‚Üí      maxNetworkRetries: 2,\n    18‚Üí    });\n    19‚Üí  }\n    20‚Üí  return stripe;\n    21‚Üí}\n    22‚Üí\n    23‚Üí// Get price IDs at runtime to ensure env vars are loaded\n    24‚Üífunction getPriceIds() {\n    25‚Üí  return {\n    26‚Üí    monthly: {\n    27‚Üí      starter: process.env.STRIPE_PRICE_STARTER || \"\",\n    28‚Üí      pro: process.env.STRIPE_PRICE_PRO || \"\",\n    29‚Üí      team: process.env.STRIPE_PRICE_TEAM || \"\",\n    30‚Üí    },\n    31‚Üí    annual: {\n    32‚Üí      starter: process.env.STRIPE_PRICE_STARTER_ANNUAL || \"\",\n    33‚Üí      pro: process.env.STRIPE_PRICE_PRO_ANNUAL || \"\",\n    34‚Üí      team: process.env.STRIPE_PRICE_TEAM_ANNUAL || \"\",\n    35‚Üí    },\n    36‚Üí  };\n    37‚Üí}\n    38‚Üí\n    39‚Üíexport async function POST(request: NextRequest) {\n    40‚Üí  try {\n    41‚Üí    const body = await request.json();\n    42‚Üí    const { plan, email, successUrl, cancelUrl, billing = \"monthly\" } = body;\n    43‚Üí\n    44‚Üí    // Get price IDs at runtime\n    45‚Üí    const allPrices = getPriceIds();\n    46‚Üí    const priceIds = billing === \"annual\" ? allPrices.annual : allPrices.monthly;\n    47‚Üí\n    48‚Üí    if (!plan || !priceIds[plan as keyof typeof priceIds]) {\n    49‚Üí      return NextResponse.json(\n    50‚Üí        { error: \"Invalid plan selected\" },\n    51‚Üí        { status: 400 }\n    52‚Üí      );\n    53‚Üí    }\n    54‚Üí\n    55‚Üí    const priceId = priceIds[plan as keyof typeof priceIds];\n    56‚Üí\n    57‚Üí    if (!priceId) {\n    58‚Üí      return NextResponse.json(\n    59‚Üí        { error: \"Price ID not configured for this plan\" },\n    60‚Üí        { status: 500 }\n    61‚Üí      );\n    62‚Üí    }\n    63‚Üí\n    64‚Üí    // Create Stripe checkout session using raw fetch (workaround for Vercel SDK connectivity issues)\n    65‚Üí    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || \"https://splice-website.vercel.app\";\n    66‚Üí    const successUrlFinal = successUrl || `${baseUrl}/checkout/success`;\n    67‚Üí    const cancelUrlFinal = cancelUrl || `${baseUrl}/pricing`;\n    68‚Üí\n    69‚Üí    const params = new URLSearchParams();\n    70‚Üí    params.append(\"mode\", \"subscription\");\n    71‚Üí    params.append(\"payment_method_types[0]\", \"card\");\n    72‚Üí    params.append(\"line_items[0][price]\", priceId);\n    73‚Üí    params.append(\"line_items[0][quantity]\", \"1\");\n    74‚Üí    if (email) params.append(\"customer_email\", email);\n    75‚Üí    params.append(\"success_url\", successUrlFinal);\n    76‚Üí    params.append(\"cancel_url\", cancelUrlFinal);\n    77‚Üí    params.append(\"subscription_data[trial_period_days]\", \"14\");\n    78‚Üí    params.append(\"subscription_data[metadata][plan]\", plan);\n    79‚Üí    params.append(\"subscription_data[metadata][billing]\", billing);\n    80‚Üí    params.append(\"metadata[plan]\", plan);\n    81‚Üí    params.append(\"metadata[billing]\", billing);\n    82‚Üí    params.append(\"allow_promotion_codes\", \"true\");\n    83‚Üí    params.append(\"billing_address_collection\", \"required\");\n    84‚Üí\n    85‚Üí    const response = await fetch(\"https://api.stripe.com/v1/checkout/sessions\", {\n    86‚Üí      method: \"POST\",\n    87‚Üí      headers: {\n    88‚Üí        \"Authorization\": `Bearer ${process.env.STRIPE_SECRET_KEY}`,\n    89‚Üí        \"Content-Type\": \"application/x-www-form-urlencoded\",\n    90‚Üí      },\n    91‚Üí      body: params,\n    92‚Üí    });\n    93‚Üí\n    94‚Üí    if (!response.ok) {\n    95‚Üí      const errorData = await response.json();\n    96‚Üí      console.error(\"[Checkout] Stripe API error:\", errorData);\n    97‚Üí      throw new Error(errorData.error?.message || \"Stripe API error\");\n    98‚Üí    }\n    99‚Üí\n   100‚Üí    const session = await response.json();\n   101‚Üí\n   102‚Üí    return NextResponse.json({\n   103‚Üí      sessionId: session.id,\n   104‚Üí      url: session.url,\n   105‚Üí    });\n   106‚Üí  } catch (error) {\n   107‚Üí    console.error(\"[Checkout] Error:\", error instanceof Error ? error.message : error);\n   108‚Üí    return NextResponse.json(\n   109‚Üí      {\n   110‚Üí        error:\n   111‚Üí          error instanceof Error ? error.message : \"Failed to create checkout session\",\n   112‚Üí      },\n   113‚Üí      { status: 500 }\n   114‚Üí    );\n   115‚Üí  }\n   116‚Üí}\n   117‚Üí\n   118‚Üíexport async function GET(request: NextRequest) {\n   119‚Üí  const searchParams = request.nextUrl.searchParams;\n   120‚Üí  const sessionId = searchParams.get(\"session_id\");\n   121‚Üí\n   122‚Üí  if (!sessionId) {\n   123‚Üí    return NextResponse.json(\n   124‚Üí      { error: \"Session ID is required\" },\n   125‚Üí      { status: 400 }\n   126‚Üí    );\n   127‚Üí  }\n   128‚Üí\n   129‚Üí  try {\n   130‚Üí    const session = await getStripe().checkout.sessions.retrieve(sessionId, {\n   131‚Üí      expand: [\"subscription\", \"customer\"],\n   132‚Üí    });\n   133‚Üí\n   134‚Üí    return NextResponse.json({\n   135‚Üí      status: session.status,\n   136‚Üí      customerEmail: session.customer_details?.email,\n   137‚Üí      plan: session.metadata?.plan,\n   138‚Üí      subscriptionId:\n   139‚Üí        typeof session.subscription === \"string\"\n   140‚Üí          ? session.subscription\n   141‚Üí          : session.subscription?.id,\n   142‚Üí    });\n   143‚Üí  } catch (error) {\n   144‚Üí    console.error(\"Session retrieval error:\", error);\n   145‚Üí    return NextResponse.json(\n   146‚Üí      {\n   147‚Üí        error:\n   148‚Üí          error instanceof Error\n   149‚Üí            ? error.message\n   150‚Üí            : \"Failed to retrieve session\",\n   151‚Üí      },\n   152‚Üí      { status: 500 }\n   153‚Üí    );\n   154‚Üí  }\n   155‚Üí}\n   156‚Üí\n\n</system-reminder>\n"}]},"uuid":"05c332bc-b5de-4652-8f2b-d780d49d47e7","timestamp":"2025-12-30T00:30:08.375Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-website/src/app/api/checkout/route.ts","content":"import { NextRequest, NextResponse } from \"next/server\";\nimport Stripe from \"stripe\";\n\n// Force Node.js runtime (not Edge) for better Stripe compatibility\nexport const runtime = \"nodejs\";\nexport const maxDuration = 30;\n\n// Lazy initialization to avoid errors during build\nlet stripe: Stripe | null = null;\nfunction getStripe(): Stripe {\n  if (!stripe) {\n    if (!process.env.STRIPE_SECRET_KEY) {\n      throw new Error(\"STRIPE_SECRET_KEY is not configured\");\n    }\n    stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\n      timeout: 10000,\n      maxNetworkRetries: 2,\n    });\n  }\n  return stripe;\n}\n\n// Get price IDs at runtime to ensure env vars are loaded\nfunction getPriceIds() {\n  return {\n    monthly: {\n      starter: process.env.STRIPE_PRICE_STARTER || \"\",\n      pro: process.env.STRIPE_PRICE_PRO || \"\",\n      team: process.env.STRIPE_PRICE_TEAM || \"\",\n    },\n    annual: {\n      starter: process.env.STRIPE_PRICE_STARTER_ANNUAL || \"\",\n      pro: process.env.STRIPE_PRICE_PRO_ANNUAL || \"\",\n      team: process.env.STRIPE_PRICE_TEAM_ANNUAL || \"\",\n    },\n  };\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { plan, email, successUrl, cancelUrl, billing = \"monthly\" } = body;\n\n    // Get price IDs at runtime\n    const allPrices = getPriceIds();\n    const priceIds = billing === \"annual\" ? allPrices.annual : allPrices.monthly;\n\n    if (!plan || !priceIds[plan as keyof typeof priceIds]) {\n      return NextResponse.json(\n        { error: \"Invalid plan selected\" },\n        { status: 400 }\n      );\n    }\n\n    const priceId = priceIds[plan as keyof typeof priceIds];\n\n    if (!priceId) {\n      return NextResponse.json(\n        { error: \"Price ID not configured for this plan\" },\n        { status: 500 }\n      );\n    }\n\n    // Create Stripe checkout session using raw fetch (workaround for Vercel SDK connectivity issues)\n    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || \"https://splice-website.vercel.app\";\n    const successUrlFinal = successUrl || `${baseUrl}/checkout/success`;\n    const cancelUrlFinal = cancelUrl || `${baseUrl}/pricing`;\n\n    const params = new URLSearchParams();\n    params.append(\"mode\", \"subscription\");\n    params.append(\"payment_method_types[0]\", \"card\");\n    params.append(\"line_items[0][price]\", priceId);\n    params.append(\"line_items[0][quantity]\", \"1\");\n    if (email) params.append(\"customer_email\", email);\n    params.append(\"success_url\", successUrlFinal);\n    params.append(\"cancel_url\", cancelUrlFinal);\n    params.append(\"subscription_data[trial_period_days]\", \"14\");\n    params.append(\"subscription_data[metadata][plan]\", plan);\n    params.append(\"subscription_data[metadata][billing]\", billing);\n    params.append(\"metadata[plan]\", plan);\n    params.append(\"metadata[billing]\", billing);\n    params.append(\"allow_promotion_codes\", \"true\");\n    params.append(\"billing_address_collection\", \"required\");\n\n    const response = await fetch(\"https://api.stripe.com/v1/checkout/sessions\", {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${process.env.STRIPE_SECRET_KEY}`,\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n      },\n      body: params,\n    });\n\n    if (!response.ok) {\n      const errorData = await response.json();\n      console.error(\"[Checkout] Stripe API error:\", errorData);\n      throw new Error(errorData.error?.message || \"Stripe API error\");\n    }\n\n    const session = await response.json();\n\n    return NextResponse.json({\n      sessionId: session.id,\n      url: session.url,\n    });\n  } catch (error) {\n    console.error(\"[Checkout] Error:\", error instanceof Error ? error.message : error);\n    return NextResponse.json(\n      {\n        error:\n          error instanceof Error ? error.message : \"Failed to create checkout session\",\n      },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  const searchParams = request.nextUrl.searchParams;\n  const sessionId = searchParams.get(\"session_id\");\n\n  if (!sessionId) {\n    return NextResponse.json(\n      { error: \"Session ID is required\" },\n      { status: 400 }\n    );\n  }\n\n  try {\n    const session = await getStripe().checkout.sessions.retrieve(sessionId, {\n      expand: [\"subscription\", \"customer\"],\n    });\n\n    return NextResponse.json({\n      status: session.status,\n      customerEmail: session.customer_details?.email,\n      plan: session.metadata?.plan,\n      subscriptionId:\n        typeof session.subscription === \"string\"\n          ? session.subscription\n          : session.subscription?.id,\n    });\n  } catch (error) {\n    console.error(\"Session retrieval error:\", error);\n    return NextResponse.json(\n      {\n        error:\n          error instanceof Error\n            ? error.message\n            : \"Failed to retrieve session\",\n      },\n      { status: 500 }\n    );\n  }\n}\n","numLines":156,"startLine":1,"totalLines":156}}}
{"parentUuid":"05c332bc-b5de-4652-8f2b-d780d49d47e7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XXGuHVUVxT6M5acyfvqMax","type":"tool_result","content":"     1‚Üíimport { NextRequest, NextResponse } from \"next/server\";\n     2‚Üíimport Stripe from \"stripe\";\n     3‚Üí\n     4‚Üí// Lazy initialization to avoid errors during build\n     5‚Üílet stripe: Stripe | null = null;\n     6‚Üífunction getStripe(): Stripe {\n     7‚Üí  if (!stripe) {\n     8‚Üí    if (!process.env.STRIPE_SECRET_KEY) {\n     9‚Üí      throw new Error(\"STRIPE_SECRET_KEY is not configured\");\n    10‚Üí    }\n    11‚Üí    stripe = new Stripe(process.env.STRIPE_SECRET_KEY);\n    12‚Üí  }\n    13‚Üí  return stripe;\n    14‚Üí}\n    15‚Üí\n    16‚Üíconst webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;\n    17‚Üí\n    18‚Üí// Backend API URL for forwarding events\n    19‚Üíconst BACKEND_API_URL =\n    20‚Üí  process.env.BACKEND_API_URL || \"https://splice-api-production.up.railway.app\";\n    21‚Üí\n    22‚Üíexport async function POST(request: NextRequest) {\n    23‚Üí  // Validate webhook secret in production\n    24‚Üí  if (!webhookSecret && process.env.NODE_ENV === 'production') {\n    25‚Üí    console.error('[SPLICE] CRITICAL: STRIPE_WEBHOOK_SECRET not set in production');\n    26‚Üí    return NextResponse.json({ error: 'Webhook configuration error' }, { status: 500 });\n    27‚Üí  }\n    28‚Üí\n    29‚Üí  const body = await request.text();\n    30‚Üí  const signature = request.headers.get(\"stripe-signature\");\n    31‚Üí\n    32‚Üí  if (!signature) {\n    33‚Üí    return NextResponse.json(\n    34‚Üí      { error: \"Missing stripe-signature header\" },\n    35‚Üí      { status: 400 }\n    36‚Üí    );\n    37‚Üí  }\n    38‚Üí\n    39‚Üí  let event: Stripe.Event;\n    40‚Üí\n    41‚Üí  try {\n    42‚Üí    event = getStripe().webhooks.constructEvent(body, signature, webhookSecret || \"\");\n    43‚Üí  } catch (error) {\n    44‚Üí    console.error(\"Webhook signature verification failed:\", error);\n    45‚Üí    return NextResponse.json(\n    46‚Üí      {\n    47‚Üí        error:\n    48‚Üí          error instanceof Error ? error.message : \"Webhook signature verification failed\",\n    49‚Üí      },\n    50‚Üí      { status: 400 }\n    51‚Üí    );\n    52‚Üí  }\n    53‚Üí\n    54‚Üí  // Handle the event\n    55‚Üí  try {\n    56‚Üí    switch (event.type) {\n    57‚Üí      case \"checkout.session.completed\": {\n    58‚Üí        const session = event.data.object as Stripe.Checkout.Session;\n    59‚Üí        await handleCheckoutComplete(session);\n    60‚Üí        break;\n    61‚Üí      }\n    62‚Üí\n    63‚Üí      case \"customer.subscription.created\":\n    64‚Üí      case \"customer.subscription.updated\": {\n    65‚Üí        const subscription = event.data.object as Stripe.Subscription;\n    66‚Üí        await handleSubscriptionUpdate(subscription);\n    67‚Üí        break;\n    68‚Üí      }\n    69‚Üí\n    70‚Üí      case \"customer.subscription.deleted\": {\n    71‚Üí        const subscription = event.data.object as Stripe.Subscription;\n    72‚Üí        await handleSubscriptionCanceled(subscription);\n    73‚Üí        break;\n    74‚Üí      }\n    75‚Üí\n    76‚Üí      case \"invoice.payment_succeeded\": {\n    77‚Üí        const invoice = event.data.object as Stripe.Invoice;\n    78‚Üí        await handleInvoicePaid(invoice);\n    79‚Üí        break;\n    80‚Üí      }\n    81‚Üí\n    82‚Üí      case \"invoice.payment_failed\": {\n    83‚Üí        const invoice = event.data.object as Stripe.Invoice;\n    84‚Üí        await handleInvoicePaymentFailed(invoice);\n    85‚Üí        break;\n    86‚Üí      }\n    87‚Üí\n    88‚Üí      default:\n    89‚Üí        console.log(`Unhandled event type: ${event.type}`);\n    90‚Üí    }\n    91‚Üí\n    92‚Üí    // Forward the event to the backend API for processing\n    93‚Üí    await forwardToBackend(event);\n    94‚Üí\n    95‚Üí    return NextResponse.json({ received: true });\n    96‚Üí  } catch (error) {\n    97‚Üí    console.error(\"Error processing webhook:\", error);\n    98‚Üí    return NextResponse.json(\n    99‚Üí      {\n   100‚Üí        error:\n   101‚Üí          error instanceof Error ? error.message : \"Error processing webhook\",\n   102‚Üí      },\n   103‚Üí      { status: 500 }\n   104‚Üí    );\n   105‚Üí  }\n   106‚Üí}\n   107‚Üí\n   108‚Üíasync function handleCheckoutComplete(session: Stripe.Checkout.Session) {\n   109‚Üí  console.log(\"Checkout completed:\", {\n   110‚Üí    sessionId: session.id,\n   111‚Üí    customerEmail: session.customer_details?.email,\n   112‚Üí    plan: session.metadata?.plan,\n   113‚Üí    subscriptionId: session.subscription,\n   114‚Üí  });\n   115‚Üí\n   116‚Üí  // Here you could:\n   117‚Üí  // - Send welcome email\n   118‚Üí  // - Provision user account\n   119‚Üí  // - Grant access to the plugin\n   120‚Üí}\n   121‚Üí\n   122‚Üíasync function handleSubscriptionUpdate(subscription: Stripe.Subscription) {\n   123‚Üí  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n   124‚Üí  const sub = subscription as any;\n   125‚Üí  console.log(\"Subscription updated:\", {\n   126‚Üí    subscriptionId: subscription.id,\n   127‚Üí    status: subscription.status,\n   128‚Üí    customerId: subscription.customer,\n   129‚Üí    currentPeriodEnd: sub.current_period_end\n   130‚Üí      ? new Date(sub.current_period_end * 1000)\n   131‚Üí      : null,\n   132‚Üí  });\n   133‚Üí\n   134‚Üí  // Here you could:\n   135‚Üí  // - Update user's plan in database\n   136‚Üí  // - Adjust feature access\n   137‚Üí}\n   138‚Üí\n   139‚Üíasync function handleSubscriptionCanceled(subscription: Stripe.Subscription) {\n   140‚Üí  console.log(\"Subscription canceled:\", {\n   141‚Üí    subscriptionId: subscription.id,\n   142‚Üí    customerId: subscription.customer,\n   143‚Üí  });\n   144‚Üí\n   145‚Üí  // Here you could:\n   146‚Üí  // - Revoke access at end of billing period\n   147‚Üí  // - Send cancellation confirmation\n   148‚Üí  // - Trigger win-back campaign\n   149‚Üí}\n   150‚Üí\n   151‚Üíasync function handleInvoicePaid(invoice: Stripe.Invoice) {\n   152‚Üí  console.log(\"Invoice paid:\", {\n   153‚Üí    invoiceId: invoice.id,\n   154‚Üí    customerId: invoice.customer,\n   155‚Üí    amount: invoice.amount_paid,\n   156‚Üí  });\n   157‚Üí\n   158‚Üí  // Here you could:\n   159‚Üí  // - Send receipt\n   160‚Üí  // - Reset usage limits\n   161‚Üí  // - Update billing history\n   162‚Üí}\n   163‚Üí\n   164‚Üíasync function handleInvoicePaymentFailed(invoice: Stripe.Invoice) {\n   165‚Üí  console.log(\"Invoice payment failed:\", {\n   166‚Üí    invoiceId: invoice.id,\n   167‚Üí    customerId: invoice.customer,\n   168‚Üí    amount: invoice.amount_due,\n   169‚Üí  });\n   170‚Üí\n   171‚Üí  // Here you could:\n   172‚Üí  // - Send payment failure notification\n   173‚Üí  // - Retry payment\n   174‚Üí  // - Pause account if needed\n   175‚Üí}\n   176‚Üí\n   177‚Üíasync function forwardToBackend(event: Stripe.Event) {\n   178‚Üí  try {\n   179‚Üí    const response = await fetch(`${BACKEND_API_URL}/webhooks/stripe`, {\n   180‚Üí      method: \"POST\",\n   181‚Üí      headers: {\n   182‚Üí        \"Content-Type\": \"application/json\",\n   183‚Üí        \"X-Webhook-Source\": \"splice-website\",\n   184‚Üí      },\n   185‚Üí      body: JSON.stringify(event),\n   186‚Üí    });\n   187‚Üí\n   188‚Üí    if (!response.ok) {\n   189‚Üí      console.error(\"Failed to forward webhook to backend:\", await response.text());\n   190‚Üí    }\n   191‚Üí  } catch (error) {\n   192‚Üí    console.error(\"Error forwarding webhook to backend:\", error);\n   193‚Üí  }\n   194‚Üí}\n   195‚Üí\n\n</system-reminder>\n"}]},"uuid":"5101f852-7236-4645-8fdf-20e1654bfa01","timestamp":"2025-12-30T00:30:08.375Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-website/src/app/api/webhook/route.ts","content":"import { NextRequest, NextResponse } from \"next/server\";\nimport Stripe from \"stripe\";\n\n// Lazy initialization to avoid errors during build\nlet stripe: Stripe | null = null;\nfunction getStripe(): Stripe {\n  if (!stripe) {\n    if (!process.env.STRIPE_SECRET_KEY) {\n      throw new Error(\"STRIPE_SECRET_KEY is not configured\");\n    }\n    stripe = new Stripe(process.env.STRIPE_SECRET_KEY);\n  }\n  return stripe;\n}\n\nconst webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;\n\n// Backend API URL for forwarding events\nconst BACKEND_API_URL =\n  process.env.BACKEND_API_URL || \"https://splice-api-production.up.railway.app\";\n\nexport async function POST(request: NextRequest) {\n  // Validate webhook secret in production\n  if (!webhookSecret && process.env.NODE_ENV === 'production') {\n    console.error('[SPLICE] CRITICAL: STRIPE_WEBHOOK_SECRET not set in production');\n    return NextResponse.json({ error: 'Webhook configuration error' }, { status: 500 });\n  }\n\n  const body = await request.text();\n  const signature = request.headers.get(\"stripe-signature\");\n\n  if (!signature) {\n    return NextResponse.json(\n      { error: \"Missing stripe-signature header\" },\n      { status: 400 }\n    );\n  }\n\n  let event: Stripe.Event;\n\n  try {\n    event = getStripe().webhooks.constructEvent(body, signature, webhookSecret || \"\");\n  } catch (error) {\n    console.error(\"Webhook signature verification failed:\", error);\n    return NextResponse.json(\n      {\n        error:\n          error instanceof Error ? error.message : \"Webhook signature verification failed\",\n      },\n      { status: 400 }\n    );\n  }\n\n  // Handle the event\n  try {\n    switch (event.type) {\n      case \"checkout.session.completed\": {\n        const session = event.data.object as Stripe.Checkout.Session;\n        await handleCheckoutComplete(session);\n        break;\n      }\n\n      case \"customer.subscription.created\":\n      case \"customer.subscription.updated\": {\n        const subscription = event.data.object as Stripe.Subscription;\n        await handleSubscriptionUpdate(subscription);\n        break;\n      }\n\n      case \"customer.subscription.deleted\": {\n        const subscription = event.data.object as Stripe.Subscription;\n        await handleSubscriptionCanceled(subscription);\n        break;\n      }\n\n      case \"invoice.payment_succeeded\": {\n        const invoice = event.data.object as Stripe.Invoice;\n        await handleInvoicePaid(invoice);\n        break;\n      }\n\n      case \"invoice.payment_failed\": {\n        const invoice = event.data.object as Stripe.Invoice;\n        await handleInvoicePaymentFailed(invoice);\n        break;\n      }\n\n      default:\n        console.log(`Unhandled event type: ${event.type}`);\n    }\n\n    // Forward the event to the backend API for processing\n    await forwardToBackend(event);\n\n    return NextResponse.json({ received: true });\n  } catch (error) {\n    console.error(\"Error processing webhook:\", error);\n    return NextResponse.json(\n      {\n        error:\n          error instanceof Error ? error.message : \"Error processing webhook\",\n      },\n      { status: 500 }\n    );\n  }\n}\n\nasync function handleCheckoutComplete(session: Stripe.Checkout.Session) {\n  console.log(\"Checkout completed:\", {\n    sessionId: session.id,\n    customerEmail: session.customer_details?.email,\n    plan: session.metadata?.plan,\n    subscriptionId: session.subscription,\n  });\n\n  // Here you could:\n  // - Send welcome email\n  // - Provision user account\n  // - Grant access to the plugin\n}\n\nasync function handleSubscriptionUpdate(subscription: Stripe.Subscription) {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const sub = subscription as any;\n  console.log(\"Subscription updated:\", {\n    subscriptionId: subscription.id,\n    status: subscription.status,\n    customerId: subscription.customer,\n    currentPeriodEnd: sub.current_period_end\n      ? new Date(sub.current_period_end * 1000)\n      : null,\n  });\n\n  // Here you could:\n  // - Update user's plan in database\n  // - Adjust feature access\n}\n\nasync function handleSubscriptionCanceled(subscription: Stripe.Subscription) {\n  console.log(\"Subscription canceled:\", {\n    subscriptionId: subscription.id,\n    customerId: subscription.customer,\n  });\n\n  // Here you could:\n  // - Revoke access at end of billing period\n  // - Send cancellation confirmation\n  // - Trigger win-back campaign\n}\n\nasync function handleInvoicePaid(invoice: Stripe.Invoice) {\n  console.log(\"Invoice paid:\", {\n    invoiceId: invoice.id,\n    customerId: invoice.customer,\n    amount: invoice.amount_paid,\n  });\n\n  // Here you could:\n  // - Send receipt\n  // - Reset usage limits\n  // - Update billing history\n}\n\nasync function handleInvoicePaymentFailed(invoice: Stripe.Invoice) {\n  console.log(\"Invoice payment failed:\", {\n    invoiceId: invoice.id,\n    customerId: invoice.customer,\n    amount: invoice.amount_due,\n  });\n\n  // Here you could:\n  // - Send payment failure notification\n  // - Retry payment\n  // - Pause account if needed\n}\n\nasync function forwardToBackend(event: Stripe.Event) {\n  try {\n    const response = await fetch(`${BACKEND_API_URL}/webhooks/stripe`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"X-Webhook-Source\": \"splice-website\",\n      },\n      body: JSON.stringify(event),\n    });\n\n    if (!response.ok) {\n      console.error(\"Failed to forward webhook to backend:\", await response.text());\n    }\n  } catch (error) {\n    console.error(\"Error forwarding webhook to backend:\", error);\n  }\n}\n","numLines":195,"startLine":1,"totalLines":195}}}
{"parentUuid":"5101f852-7236-4645-8fdf-20e1654bfa01","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VxhX1GWUGV6F635d7ALfhs","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check if there's an email service in the backend to understand the email sending pattern:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":4282,"cache_read_input_tokens":20022,"cache_creation":{"ephemeral_5m_input_tokens":4282,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWbvjdFgv8EjFegmSbs99","type":"assistant","uuid":"ccb5991a-aacc-4678-9961-f8df20154eb8","timestamp":"2025-12-30T00:30:16.791Z"}
{"parentUuid":"ccb5991a-aacc-4678-9961-f8df20154eb8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VxhX1GWUGV6F635d7ALfhs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B113S6J62Hrqen38Wb67ZJ","name":"Glob","input":{"pattern":"**/*email*.{js,ts}","path":"/Users/imorgado/SPLICE/splice-backend"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":4282,"cache_read_input_tokens":20022,"cache_creation":{"ephemeral_5m_input_tokens":4282,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWbvjdFgv8EjFegmSbs99","type":"assistant","uuid":"c101cb4c-dd99-4b9a-8625-bf3cd1888b2d","timestamp":"2025-12-30T00:30:17.596Z"}
{"parentUuid":"c101cb4c-dd99-4b9a-8625-bf3cd1888b2d","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VxhX1GWUGV6F635d7ALfhs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0117ZnF3S3dtmr3oVZ64eF8E","name":"Grep","input":{"pattern":"sendgrid|SENDGRID","path":"/Users/imorgado/SPLICE","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":4282,"cache_read_input_tokens":20022,"cache_creation":{"ephemeral_5m_input_tokens":4282,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWbvjdFgv8EjFegmSbs99","type":"assistant","uuid":"fd06df68-7be0-4dbf-897b-8c90e20883e8","timestamp":"2025-12-30T00:30:18.573Z"}
{"parentUuid":"fd06df68-7be0-4dbf-897b-8c90e20883e8","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0117ZnF3S3dtmr3oVZ64eF8E","type":"tool_result","content":"Found 3 files\nsplice-backend/.env.template\nCLAUDE.md\nsplice-backend/services/emailService.js"}]},"uuid":"02cd7418-25bb-423f-a1db-ab92b727e7cf","timestamp":"2025-12-30T00:30:18.655Z","toolUseResult":{"mode":"files_with_matches","filenames":["splice-backend/.env.template","CLAUDE.md","splice-backend/services/emailService.js"],"numFiles":3}}
{"parentUuid":"02cd7418-25bb-423f-a1db-ab92b727e7cf","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B113S6J62Hrqen38Wb67ZJ","type":"tool_result","content":"/Users/imorgado/SPLICE/splice-backend/services/emailService.js"}]},"uuid":"39763fcf-1794-4e37-bfae-5bd6630b47b7","timestamp":"2025-12-30T00:30:18.686Z","toolUseResult":{"filenames":["/Users/imorgado/SPLICE/splice-backend/services/emailService.js"],"durationMs":60,"numFiles":1,"truncated":false}}
{"parentUuid":"39763fcf-1794-4e37-bfae-5bd6630b47b7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UKg5YZ7wQroFR5pF7A96T6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015n4VeteeSyACEgxbGuf8T3","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-backend/services/emailService.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":59,"cache_creation_input_tokens":352,"cache_read_input_tokens":24304,"cache_creation":{"ephemeral_5m_input_tokens":352,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CWbvkPJpg1Lfb7i7UG7pm","type":"assistant","uuid":"710c5e4c-1146-4a6e-9892-3a5e86c419de","timestamp":"2025-12-30T00:30:24.118Z"}
{"parentUuid":"710c5e4c-1146-4a6e-9892-3a5e86c419de","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015n4VeteeSyACEgxbGuf8T3","type":"tool_result","content":"     1‚Üí/**\n     2‚Üí * SPLICE Email Service\n     3‚Üí *\n     4‚Üí * Handles email delivery for license keys, payment notifications, etc.\n     5‚Üí * Supports multiple providers: SendGrid (primary), AWS SES (fallback)\n     6‚Üí *\n     7‚Üí * Required env vars:\n     8‚Üí * - EMAIL_PROVIDER: 'sendgrid' | 'ses' | 'console' (default: 'console' for dev)\n     9‚Üí * - SENDGRID_API_KEY: SendGrid API key\n    10‚Üí * - AWS_SES_REGION: AWS SES region (default: 'us-east-1')\n    11‚Üí * - AWS_ACCESS_KEY_ID: AWS access key (for SES)\n    12‚Üí * - AWS_SECRET_ACCESS_KEY: AWS secret (for SES)\n    13‚Üí * - EMAIL_FROM: Sender email address (default: 'noreply@splice.video')\n    14‚Üí */\n    15‚Üí\n    16‚Üí// ============================================================================\n    17‚Üí// CONFIGURATION\n    18‚Üí// ============================================================================\n    19‚Üí\n    20‚Üíconst EMAIL_CONFIG = {\n    21‚Üí  provider: process.env.EMAIL_PROVIDER || 'console',\n    22‚Üí  from: process.env.EMAIL_FROM || 'SPLICE <noreply@splice.video>',\n    23‚Üí  replyTo: process.env.EMAIL_REPLY_TO || 'support@splice.video',\n    24‚Üí  sendgrid: {\n    25‚Üí    apiKey: process.env.SENDGRID_API_KEY\n    26‚Üí  },\n    27‚Üí  ses: {\n    28‚Üí    region: process.env.AWS_SES_REGION || 'us-east-1'\n    29‚Üí  }\n    30‚Üí};\n    31‚Üí\n    32‚Üí// SendGrid Dynamic Template IDs\n    33‚Üíconst TEMPLATE_IDS = {\n    34‚Üí  signinCode: 'd-8ba02a0aacf0425da03610dce44fd08d'\n    35‚Üí};\n    36‚Üí\n    37‚Üí// Email templates\n    38‚Üíconst TEMPLATES = {\n    39‚Üí  licenseKey: {\n    40‚Üí    subject: 'Welcome to SPLICE! Your License Key + Quick Start Guide',\n    41‚Üí    html: (data) => `\n    42‚Üí<!DOCTYPE html>\n    43‚Üí<html>\n    44‚Üí<head>\n    45‚Üí  <meta charset=\"utf-8\">\n    46‚Üí  <style>\n    47‚Üí    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; margin: 0; padding: 0; }\n    48‚Üí    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; background: white; }\n    49‚Üí    .header { text-align: center; margin-bottom: 30px; }\n    50‚Üí    .logo { font-size: 32px; font-weight: bold; color: #00D4FF; }\n    51‚Üí    .tagline { color: #6b7280; font-size: 14px; margin-top: 5px; }\n    52‚Üí    .hero-cta { background: linear-gradient(135deg, #00D4FF, #00A8CC); border-radius: 12px; padding: 30px; text-align: center; margin: 30px 0; }\n    53‚Üí    .hero-cta h2 { color: white; margin: 0 0 15px 0; font-size: 22px; }\n    54‚Üí    .hero-cta p { color: rgba(255,255,255,0.9); margin: 0 0 20px 0; }\n    55‚Üí    .button-primary { display: inline-block; background: white; color: #00A8CC; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }\n    56‚Üí    .button-primary:hover { background: #f0f0f0; }\n    57‚Üí    .license-box { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }\n    58‚Üí    .license-key { font-family: monospace; font-size: 22px; font-weight: bold; color: #1e293b; letter-spacing: 2px; }\n    59‚Üí    .tier-badge { display: inline-block; background: #00D4FF; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-top: 10px; }\n    60‚Üí    .quick-wins { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px; margin: 20px 0; }\n    61‚Üí    .quick-wins h3 { color: #166534; margin-top: 0; }\n    62‚Üí    .quick-wins ul { margin: 0; padding-left: 20px; }\n    63‚Üí    .quick-wins li { margin: 8px 0; color: #15803d; }\n    64‚Üí    .instructions { background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; }\n    65‚Üí    .instructions h3 { margin-top: 0; color: #374151; }\n    66‚Üí    .instructions ol { margin: 0; padding-left: 20px; }\n    67‚Üí    .instructions li { margin: 8px 0; }\n    68‚Üí    .resources { display: table; width: 100%; margin: 20px 0; }\n    69‚Üí    .resource-item { display: table-cell; text-align: center; padding: 15px; width: 33%; }\n    70‚Üí    .resource-item a { display: block; color: #00A8CC; text-decoration: none; font-weight: 500; }\n    71‚Üí    .resource-item span { display: block; font-size: 12px; color: #6b7280; margin-top: 5px; }\n    72‚Üí    .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px; }\n    73‚Üí    .button { display: inline-block; background: #00D4FF; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }\n    74‚Üí  </style>\n    75‚Üí</head>\n    76‚Üí<body>\n    77‚Üí  <div class=\"container\">\n    78‚Üí    <div class=\"header\">\n    79‚Üí      <div class=\"logo\">SPLICE</div>\n    80‚Üí      <p class=\"tagline\">Cut Your Editing Time in Half. Automatically.</p>\n    81‚Üí    </div>\n    82‚Üí\n    83‚Üí    <div class=\"hero-cta\">\n    84‚Üí      <h2>üéâ You're In! Let's Get Started</h2>\n    85‚Üí      <p>Download SPLICE and make your first AI-powered edit in under 2 minutes.</p>\n    86‚Üí      <a href=\"https://splice.video/download\" class=\"button-primary\">Download SPLICE ‚Üí</a>\n    87‚Üí    </div>\n    88‚Üí\n    89‚Üí    <div class=\"license-box\">\n    90‚Üí      <p style=\"margin: 0 0 10px; color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;\">Your License Key</p>\n    91‚Üí      <div class=\"license-key\">${escapeHtml(data.licenseKey)}</div>\n    92‚Üí      <div class=\"tier-badge\">${escapeHtml(data.tier.toUpperCase())} Plan</div>\n    93‚Üí    </div>\n    94‚Üí\n    95‚Üí    <div class=\"quick-wins\">\n    96‚Üí      <h3>‚ö° Your First 5-Minute Win</h3>\n    97‚Üí      <ul>\n    98‚Üí        <li><strong>Open any project</strong> in Premiere Pro</li>\n    99‚Üí        <li><strong>Click GO</strong> in the SPLICE panel</li>\n   100‚Üí        <li><strong>Watch silences vanish</strong> automatically</li>\n   101‚Üí      </ul>\n   102‚Üí      <p style=\"margin-bottom: 0; font-size: 14px;\">Most editors save <strong>2+ hours per video</strong> on their first use!</p>\n   103‚Üí    </div>\n   104‚Üí\n   105‚Üí    <div class=\"instructions\">\n   106‚Üí      <h3>üìã Setup Instructions</h3>\n   107‚Üí      <ol>\n   108‚Üí        <li>Open Adobe Premiere Pro (2023 or later)</li>\n   109‚Üí        <li>Go to <strong>Window ‚Üí Extensions ‚Üí SPLICE</strong></li>\n   110‚Üí        <li>Click the Login button and enter your license key</li>\n   111‚Üí        <li>You're ready! Open any sequence and hit <strong>GO</strong></li>\n   112‚Üí      </ol>\n   113‚Üí    </div>\n   114‚Üí\n   115‚Üí    <p>Your ${escapeHtml(data.tier)} plan includes:</p>\n   116‚Üí    <ul>\n   117‚Üí      <li><strong>${escapeHtml(String(data.hours))} hours</strong> of AI processing per month</li>\n   118‚Üí      <li><strong>${escapeHtml(String(data.musicCredits))} music credits</strong> per month</li>\n   119‚Üí      <li>14-day free trial - cancel anytime</li>\n   120‚Üí    </ul>\n   121‚Üí\n   122‚Üí    <div class=\"resources\">\n   123‚Üí      <div class=\"resource-item\">\n   124‚Üí        <a href=\"https://splice.video/docs/tutorials\">üìö Tutorials</a>\n   125‚Üí        <span>Step-by-step guides</span>\n   126‚Üí      </div>\n   127‚Üí      <div class=\"resource-item\">\n   128‚Üí        <a href=\"https://splice.video/docs/faq\">‚ùì FAQ</a>\n   129‚Üí        <span>Common questions</span>\n   130‚Üí      </div>\n   131‚Üí      <div class=\"resource-item\">\n   132‚Üí        <a href=\"mailto:support@splice.video\">üí¨ Support</a>\n   133‚Üí        <span>We're here to help</span>\n   134‚Üí      </div>\n   135‚Üí    </div>\n   136‚Üí\n   137‚Üí    <div class=\"footer\">\n   138‚Üí      <p>Questions? Just reply to this email - we read every message!</p>\n   139‚Üí      <p style=\"font-size: 12px;\">&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n   140‚Üí    </div>\n   141‚Üí  </div>\n   142‚Üí</body>\n   143‚Üí</html>\n   144‚Üí    `,\n   145‚Üí    text: (data) => `\n   146‚ÜíSPLICE - Welcome! Your License Key + Quick Start Guide\n   147‚Üí=======================================================\n   148‚Üí\n   149‚Üíüéâ YOU'RE IN! LET'S GET STARTED\n   150‚Üí\n   151‚ÜíDownload SPLICE: https://splice.video/download\n   152‚Üí\n   153‚ÜíYOUR LICENSE KEY:\n   154‚Üí${data.licenseKey}\n   155‚ÜíPlan: ${data.tier.toUpperCase()}\n   156‚Üí\n   157‚Üí‚ö° YOUR FIRST 5-MINUTE WIN:\n   158‚Üí1. Open any project in Premiere Pro\n   159‚Üí2. Click GO in the SPLICE panel\n   160‚Üí3. Watch silences vanish automatically\n   161‚Üí\n   162‚ÜíMost editors save 2+ hours per video on their first use!\n   163‚Üí\n   164‚Üíüìã SETUP INSTRUCTIONS:\n   165‚Üí1. Open Adobe Premiere Pro (2023 or later)\n   166‚Üí2. Go to Window ‚Üí Extensions ‚Üí SPLICE\n   167‚Üí3. Click the Login button and enter your license key\n   168‚Üí4. You're ready! Open any sequence and hit GO\n   169‚Üí\n   170‚ÜíYOUR ${data.tier.toUpperCase()} PLAN INCLUDES:\n   171‚Üí- ${data.hours} hours of AI processing per month\n   172‚Üí- ${data.musicCredits} music credits per month\n   173‚Üí- 14-day free trial - cancel anytime\n   174‚Üí\n   175‚ÜíHELPFUL RESOURCES:\n   176‚Üíüìö Tutorials: https://splice.video/docs/tutorials\n   177‚Üí‚ùì FAQ: https://splice.video/docs/faq\n   178‚Üíüí¨ Support: support@splice.video\n   179‚Üí\n   180‚ÜíQuestions? Just reply to this email - we read every message!\n   181‚Üí\n   182‚Üí¬© ${new Date().getFullYear()} SPLICE. All rights reserved.\n   183‚Üí    `\n   184‚Üí  },\n   185‚Üí\n   186‚Üí  paymentWarning: {\n   187‚Üí    subject: 'Action Required: Payment Failed for SPLICE',\n   188‚Üí    html: (data) => `\n   189‚Üí<!DOCTYPE html>\n   190‚Üí<html>\n   191‚Üí<head>\n   192‚Üí  <meta charset=\"utf-8\">\n   193‚Üí  <style>\n   194‚Üí    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }\n   195‚Üí    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }\n   196‚Üí    .header { text-align: center; margin-bottom: 30px; }\n   197‚Üí    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }\n   198‚Üí    .warning-box { background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; padding: 20px; margin: 20px 0; }\n   199‚Üí    .warning-icon { font-size: 48px; text-align: center; }\n   200‚Üí    .button { display: inline-block; background: #7c3aed; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }\n   201‚Üí    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }\n   202‚Üí  </style>\n   203‚Üí</head>\n   204‚Üí<body>\n   205‚Üí  <div class=\"container\">\n   206‚Üí    <div class=\"header\">\n   207‚Üí      <div class=\"logo\">SPLICE</div>\n   208‚Üí    </div>\n   209‚Üí\n   210‚Üí    <div class=\"warning-box\">\n   211‚Üí      <div class=\"warning-icon\">‚ö†Ô∏è</div>\n   212‚Üí      <h2 style=\"text-align: center; color: #dc2626; margin: 10px 0;\">Payment Failed</h2>\n   213‚Üí      <p>We were unable to process your payment for your SPLICE subscription. This was attempt ${escapeHtml(String(data.attemptCount))} of 3.</p>\n   214‚Üí    </div>\n   215‚Üí\n   216‚Üí    <p>To keep your subscription active and avoid interruption to your service, please update your payment method:</p>\n   217‚Üí\n   218‚Üí    <p style=\"text-align: center;\">\n   219‚Üí      <a href=\"https://splice.video/account/billing\" class=\"button\">Update Payment Method</a>\n   220‚Üí    </p>\n   221‚Üí\n   222‚Üí    <p><strong>What happens next?</strong></p>\n   223‚Üí    <ul>\n   224‚Üí      <li>We'll automatically retry the payment in a few days</li>\n   225‚Üí      <li>If all payment attempts fail, your subscription will be cancelled</li>\n   226‚Üí      <li>You'll lose access to premium features</li>\n   227‚Üí    </ul>\n   228‚Üí\n   229‚Üí    <p>If you have any questions or need assistance, please don't hesitate to reach out.</p>\n   230‚Üí\n   231‚Üí    <div class=\"footer\">\n   232‚Üí      <p>Need help? Reply to this email or visit <a href=\"https://splice.video/support\">splice.video/support</a></p>\n   233‚Üí      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n   234‚Üí    </div>\n   235‚Üí  </div>\n   236‚Üí</body>\n   237‚Üí</html>\n   238‚Üí    `,\n   239‚Üí    text: (data) => `\n   240‚ÜíSPLICE - Payment Failed\n   241‚Üí\n   242‚ÜíWe were unable to process your payment for your SPLICE subscription.\n   243‚ÜíThis was attempt ${data.attemptCount} of 3.\n   244‚Üí\n   245‚ÜíTo keep your subscription active, please update your payment method:\n   246‚Üíhttps://splice.video/account/billing\n   247‚Üí\n   248‚ÜíWHAT HAPPENS NEXT:\n   249‚Üí- We'll automatically retry the payment in a few days\n   250‚Üí- If all payment attempts fail, your subscription will be cancelled\n   251‚Üí- You'll lose access to premium features\n   252‚Üí\n   253‚ÜíIf you have any questions, please reply to this email.\n   254‚Üí\n   255‚Üí¬© ${new Date().getFullYear()} SPLICE. All rights reserved.\n   256‚Üí    `\n   257‚Üí  },\n   258‚Üí\n   259‚Üí  licenseLookup: {\n   260‚Üí    subject: 'Your SPLICE License Key',\n   261‚Üí    html: (data) => `\n   262‚Üí<!DOCTYPE html>\n   263‚Üí<html>\n   264‚Üí<head>\n   265‚Üí  <meta charset=\"utf-8\">\n   266‚Üí  <style>\n   267‚Üí    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }\n   268‚Üí    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }\n   269‚Üí    .header { text-align: center; margin-bottom: 30px; }\n   270‚Üí    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }\n   271‚Üí    .license-box { background: #f8f5ff; border: 2px solid #7c3aed; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }\n   272‚Üí    .license-key { font-family: monospace; font-size: 24px; font-weight: bold; color: #7c3aed; letter-spacing: 2px; }\n   273‚Üí    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }\n   274‚Üí  </style>\n   275‚Üí</head>\n   276‚Üí<body>\n   277‚Üí  <div class=\"container\">\n   278‚Üí    <div class=\"header\">\n   279‚Üí      <div class=\"logo\">SPLICE</div>\n   280‚Üí    </div>\n   281‚Üí\n   282‚Üí    <h2>License Key Lookup</h2>\n   283‚Üí    <p>You requested your SPLICE license key. Here it is:</p>\n   284‚Üí\n   285‚Üí    <div class=\"license-box\">\n   286‚Üí      <div class=\"license-key\">${escapeHtml(data.licenseKey)}</div>\n   287‚Üí    </div>\n   288‚Üí\n   289‚Üí    <p>If you didn't request this, you can safely ignore this email.</p>\n   290‚Üí\n   291‚Üí    <div class=\"footer\">\n   292‚Üí      <p>Need help? Reply to this email or visit <a href=\"https://splice.video/support\">splice.video/support</a></p>\n   293‚Üí      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n   294‚Üí    </div>\n   295‚Üí  </div>\n   296‚Üí</body>\n   297‚Üí</html>\n   298‚Üí    `,\n   299‚Üí    text: (data) => `\n   300‚ÜíSPLICE - License Key Lookup\n   301‚Üí\n   302‚ÜíYou requested your SPLICE license key. Here it is:\n   303‚Üí\n   304‚Üí${data.licenseKey}\n   305‚Üí\n   306‚ÜíIf you didn't request this, you can safely ignore this email.\n   307‚Üí\n   308‚ÜíNeed help? Visit https://splice.video/support\n   309‚Üí\n   310‚Üí¬© ${new Date().getFullYear()} SPLICE. All rights reserved.\n   311‚Üí    `\n   312‚Üí  },\n   313‚Üí\n   314‚Üí  // Sign-in code email (passwordless auth)\n   315‚Üí  signinCode: {\n   316‚Üí    subject: 'Your SPLICE Sign-In Code: {{code}}',\n   317‚Üí    html: (data) => `\n   318‚Üí<!DOCTYPE html>\n   319‚Üí<html lang=\"en\">\n   320‚Üí<head>\n   321‚Üí  <meta charset=\"UTF-8\">\n   322‚Üí  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n   323‚Üí  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n   324‚Üí  <title>Your SPLICE Sign-In Code</title>\n   325‚Üí  <!--[if mso]>\n   326‚Üí  <noscript>\n   327‚Üí    <xml>\n   328‚Üí      <o:OfficeDocumentSettings>\n   329‚Üí        <o:PixelsPerInch>96</o:PixelsPerInch>\n   330‚Üí      </o:OfficeDocumentSettings>\n   331‚Üí    </xml>\n   332‚Üí  </noscript>\n   333‚Üí  <![endif]-->\n   334‚Üí  <style>\n   335‚Üí    body, table, td, p, a, li { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }\n   336‚Üí    table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; }\n   337‚Üí    img { -ms-interpolation-mode: bicubic; border: 0; outline: none; text-decoration: none; }\n   338‚Üí    body { margin: 0; padding: 0; width: 100%; background-color: #060b14; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }\n   339‚Üí    @media only screen and (max-width: 600px) {\n   340‚Üí      .container { width: 100% !important; padding: 16px !important; }\n   341‚Üí      .code-box { font-size: 28px !important; letter-spacing: 6px !important; }\n   342‚Üí    }\n   343‚Üí  </style>\n   344‚Üí</head>\n   345‚Üí<body style=\"margin: 0; padding: 0; background-color: #060b14;\">\n   346‚Üí  <div style=\"display: none; max-height: 0; overflow: hidden; font-size: 1px; line-height: 1px; color: #060b14;\">Your SPLICE sign-in code is inside. Start editing 10x faster today!</div>\n   347‚Üí  <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color: #060b14;\">\n   348‚Üí    <tr>\n   349‚Üí      <td align=\"center\" style=\"padding: 40px 20px;\">\n   350‚Üí        <table role=\"presentation\" class=\"container\" cellpadding=\"0\" cellspacing=\"0\" width=\"560\" style=\"max-width: 560px;\">\n   351‚Üí          <tr>\n   352‚Üí            <td align=\"center\" style=\"padding-bottom: 32px;\">\n   353‚Üí              <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n   354‚Üí                <tr>\n   355‚Üí                  <td style=\"vertical-align: middle; padding-right: 10px;\">\n   356‚Üí                    <img src=\"https://splice.video/images/logo.jpg\" alt=\"SPLICE\" width=\"40\" height=\"40\" style=\"display: block; border-radius: 8px;\">\n   357‚Üí                  </td>\n   358‚Üí                  <td style=\"vertical-align: middle;\">\n   359‚Üí                    <span style=\"font-size: 26px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px;\">SPLICE</span>\n   360‚Üí                  </td>\n   361‚Üí                </tr>\n   362‚Üí              </table>\n   363‚Üí            </td>\n   364‚Üí          </tr>\n   365‚Üí          <tr>\n   366‚Üí            <td>\n   367‚Üí              <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background: linear-gradient(180deg, #0f1629 0%, #0a0f1a 100%); border-radius: 16px; border: 1px solid rgba(0, 212, 255, 0.15); box-shadow: 0 0 40px rgba(0, 212, 255, 0.08);\">\n   368‚Üí                <tr>\n   369‚Üí                  <td align=\"center\" style=\"padding: 40px 40px 24px 40px;\">\n   370‚Üí                    <h1 style=\"margin: 0; font-size: 28px; font-weight: 600; color: #ffffff; line-height: 1.3;\">Welcome to the future of editing ‚ú®</h1>\n   371‚Üí                  </td>\n   372‚Üí                </tr>\n   373‚Üí                <tr>\n   374‚Üí                  <td align=\"center\" style=\"padding: 0 40px 32px 40px;\">\n   375‚Üí                    <p style=\"margin: 0; font-size: 16px; color: #94a3b8; line-height: 1.6;\">You're one step away from editing 10x faster. Use this code to sign in:</p>\n   376‚Üí                  </td>\n   377‚Üí                </tr>\n   378‚Üí                <tr>\n   379‚Üí                  <td align=\"center\" style=\"padding: 0 40px 32px 40px;\">\n   380‚Üí                    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" style=\"background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 168, 204, 0.05) 100%); border-radius: 12px; border: 2px solid #00D4FF; box-shadow: 0 0 24px rgba(0, 212, 255, 0.25);\">\n   381‚Üí                      <tr>\n   382‚Üí                        <td align=\"center\" style=\"padding: 24px 48px;\">\n   383‚Üí                          <span class=\"code-box\" style=\"font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 36px; font-weight: 700; color: #00D4FF; letter-spacing: 10px; text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);\">${escapeHtml(data.code)}</span>\n   384‚Üí                        </td>\n   385‚Üí                      </tr>\n   386‚Üí                    </table>\n   387‚Üí                  </td>\n   388‚Üí                </tr>\n   389‚Üí                <tr>\n   390‚Üí                  <td align=\"center\" style=\"padding: 0 40px 40px 40px;\">\n   391‚Üí                    <p style=\"margin: 0; font-size: 14px; color: #64748b;\">‚è±Ô∏è This code expires in <strong style=\"color: #ffffff;\">10 minutes</strong></p>\n   392‚Üí                  </td>\n   393‚Üí                </tr>\n   394‚Üí                <tr>\n   395‚Üí                  <td style=\"padding: 0 40px;\">\n   396‚Üí                    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n   397‚Üí                      <tr><td style=\"border-top: 1px solid rgba(148, 163, 184, 0.1);\"></td></tr>\n   398‚Üí                    </table>\n   399‚Üí                  </td>\n   400‚Üí                </tr>\n   401‚Üí                <tr>\n   402‚Üí                  <td style=\"padding: 40px;\">\n   403‚Üí                    <h2 style=\"margin: 0 0 24px 0; font-size: 18px; font-weight: 600; color: #ffffff;\">üöÄ What you'll unlock:</h2>\n   404‚Üí                    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n   405‚Üí                      <tr>\n   406‚Üí                        <td width=\"50%\" style=\"padding: 8px 8px 8px 0; vertical-align: top;\">\n   407‚Üí                          <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n   408‚Üí                            <tr>\n   409‚Üí                              <td style=\"padding-right: 12px; vertical-align: top;\"><span style=\"font-size: 20px;\">‚ö°</span></td>\n   410‚Üí                              <td style=\"vertical-align: top;\">\n   411‚Üí                                <p style=\"margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;\">AI Silence Removal</p>\n   412‚Üí                                <p style=\"margin: 4px 0 0 0; font-size: 13px; color: #64748b;\">Auto-trim dead air</p>\n   413‚Üí                              </td>\n   414‚Üí                            </tr>\n   415‚Üí                          </table>\n   416‚Üí                        </td>\n   417‚Üí                        <td width=\"50%\" style=\"padding: 8px 0 8px 8px; vertical-align: top;\">\n   418‚Üí                          <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n   419‚Üí                            <tr>\n   420‚Üí                              <td style=\"padding-right: 12px; vertical-align: top;\"><span style=\"font-size: 20px;\">üé¨</span></td>\n   421‚Üí                              <td style=\"vertical-align: top;\">\n   422‚Üí                                <p style=\"margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;\">Smart Take Detection</p>\n   423‚Üí                                <p style=\"margin: 4px 0 0 0; font-size: 13px; color: #64748b;\">Find best takes fast</p>\n   424‚Üí                              </td>\n   425‚Üí                            </tr>\n   426‚Üí                          </table>\n   427‚Üí                        </td>\n   428‚Üí                      </tr>\n   429‚Üí                      <tr>\n   430‚Üí                        <td width=\"50%\" style=\"padding: 8px 8px 8px 0; vertical-align: top;\">\n   431‚Üí                          <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n   432‚Üí                            <tr>\n   433‚Üí                              <td style=\"padding-right: 12px; vertical-align: top;\"><span style=\"font-size: 20px;\">üéµ</span></td>\n   434‚Üí                              <td style=\"vertical-align: top;\">\n   435‚Üí                                <p style=\"margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;\">AI Music Generation</p>\n   436‚Üí                                <p style=\"margin: 4px 0 0 0; font-size: 13px; color: #64748b;\">Royalty-free tracks</p>\n   437‚Üí                              </td>\n   438‚Üí                            </tr>\n   439‚Üí                          </table>\n   440‚Üí                        </td>\n   441‚Üí                        <td width=\"50%\" style=\"padding: 8px 0 8px 8px; vertical-align: top;\">\n   442‚Üí                          <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n   443‚Üí                            <tr>\n   444‚Üí                              <td style=\"padding-right: 12px; vertical-align: top;\"><span style=\"font-size: 20px;\">üì±</span></td>\n   445‚Üí                              <td style=\"vertical-align: top;\">\n   446‚Üí                                <p style=\"margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;\">Social Reframe</p>\n   447‚Üí                                <p style=\"margin: 4px 0 0 0; font-size: 13px; color: #64748b;\">Export to any platform</p>\n   448‚Üí                              </td>\n   449‚Üí                            </tr>\n   450‚Üí                          </table>\n   451‚Üí                        </td>\n   452‚Üí                      </tr>\n   453‚Üí                    </table>\n   454‚Üí                  </td>\n   455‚Üí                </tr>\n   456‚Üí                <tr>\n   457‚Üí                  <td align=\"center\" style=\"padding: 0 40px 40px 40px;\">\n   458‚Üí                    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n   459‚Üí                      <tr>\n   460‚Üí                        <td align=\"center\" style=\"background: linear-gradient(135deg, #00D4FF 0%, #0099CC 100%); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);\">\n   461‚Üí                          <a href=\"https://splice.video/download\" target=\"_blank\" style=\"display: inline-block; padding: 16px 40px; font-size: 16px; font-weight: 600; color: #060b14; text-decoration: none; letter-spacing: -0.3px;\">Download SPLICE Now ‚Üí</a>\n   462‚Üí                        </td>\n   463‚Üí                      </tr>\n   464‚Üí                    </table>\n   465‚Üí                  </td>\n   466‚Üí                </tr>\n   467‚Üí              </table>\n   468‚Üí            </td>\n   469‚Üí          </tr>\n   470‚Üí          <tr>\n   471‚Üí            <td align=\"center\" style=\"padding: 40px 0 24px 0;\">\n   472‚Üí              <p style=\"margin: 0; font-size: 14px; color: #64748b;\">Need help getting started?</p>\n   473‚Üí            </td>\n   474‚Üí          </tr>\n   475‚Üí          <tr>\n   476‚Üí            <td align=\"center\" style=\"padding-bottom: 40px;\">\n   477‚Üí              <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n   478‚Üí                <tr>\n   479‚Üí                  <td style=\"padding: 0 12px;\"><a href=\"https://splice.video/docs/quickstart\" style=\"font-size: 14px; color: #00D4FF; text-decoration: none;\">Quick Start Guide</a></td>\n   480‚Üí                  <td style=\"color: #334155;\">|</td>\n   481‚Üí                  <td style=\"padding: 0 12px;\"><a href=\"https://discord.gg/splice\" style=\"font-size: 14px; color: #00D4FF; text-decoration: none;\">Join Discord</a></td>\n   482‚Üí                  <td style=\"color: #334155;\">|</td>\n   483‚Üí                  <td style=\"padding: 0 12px;\"><a href=\"mailto:support@splice.video\" style=\"font-size: 14px; color: #00D4FF; text-decoration: none;\">Contact Support</a></td>\n   484‚Üí                </tr>\n   485‚Üí              </table>\n   486‚Üí            </td>\n   487‚Üí          </tr>\n   488‚Üí          <tr>\n   489‚Üí            <td align=\"center\" style=\"padding: 24px 0; border-top: 1px solid rgba(148, 163, 184, 0.1);\">\n   490‚Üí              <p style=\"margin: 0 0 8px 0; font-size: 13px; color: #475569;\">You received this email because you signed up for SPLICE.</p>\n   491‚Üí              <p style=\"margin: 0; font-size: 13px; color: #475569;\">¬© ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n   492‚Üí            </td>\n   493‚Üí          </tr>\n   494‚Üí        </table>\n   495‚Üí      </td>\n   496‚Üí    </tr>\n   497‚Üí  </table>\n   498‚Üí</body>\n   499‚Üí</html>\n   500‚Üí    `,\n   501‚Üí    text: (data) => `\n   502‚ÜíWelcome to SPLICE!\n   503‚Üí\n   504‚ÜíYour sign-in code is: ${data.code}\n   505‚Üí\n   506‚ÜíThis code expires in 10 minutes.\n   507‚Üí\n   508‚ÜíWhat you'll unlock:\n   509‚Üí- ‚ö° AI Silence Removal - Auto-trim dead air\n   510‚Üí- üé¨ Smart Take Detection - Find best takes fast\n   511‚Üí- üéµ AI Music Generation - Royalty-free tracks\n   512‚Üí- üì± Social Reframe - Export to any platform\n   513‚Üí\n   514‚ÜíDownload SPLICE: https://splice.video/download\n   515‚Üí\n   516‚ÜíNeed help?\n   517‚Üí- Quick Start Guide: https://splice.video/docs/quickstart\n   518‚Üí- Join Discord: https://discord.gg/splice\n   519‚Üí- Contact Support: support@splice.video\n   520‚Üí\n   521‚Üí¬© ${new Date().getFullYear()} SPLICE. All rights reserved.\n   522‚Üí    `\n   523‚Üí  }\n   524‚Üí};\n   525‚Üí\n   526‚Üí// ============================================================================\n   527‚Üí// HELPER FUNCTIONS\n   528‚Üí// ============================================================================\n   529‚Üí\n   530‚Üí/**\n   531‚Üí * Escape HTML to prevent XSS in email content\n   532‚Üí */\n   533‚Üífunction escapeHtml(str) {\n   534‚Üí  if (str === null || str === undefined) return '';\n   535‚Üí  if (typeof str !== 'string') str = String(str);\n   536‚Üí\n   537‚Üí  const escapeMap = {\n   538‚Üí    '&': '&amp;',\n   539‚Üí    '<': '&lt;',\n   540‚Üí    '>': '&gt;',\n   541‚Üí    '\"': '&quot;',\n   542‚Üí    \"'\": '&#x27;'\n   543‚Üí  };\n   544‚Üí\n   545‚Üí  return str.replace(/[&<>\"']/g, char => escapeMap[char]);\n   546‚Üí}\n   547‚Üí\n   548‚Üí/**\n   549‚Üí * Get tier details for email\n   550‚Üí */\n   551‚Üífunction getTierDetails(tier) {\n   552‚Üí  const tiers = {\n   553‚Üí    starter: { hours: 4, musicCredits: 2 },\n   554‚Üí    pro: { hours: 15, musicCredits: 10 },\n   555‚Üí    team: { hours: 50, musicCredits: 50 }\n   556‚Üí  };\n   557‚Üí  return tiers[tier] || tiers.starter;\n   558‚Üí}\n   559‚Üí\n   560‚Üí// ============================================================================\n   561‚Üí// EMAIL PROVIDERS\n   562‚Üí// ============================================================================\n   563‚Üí\n   564‚Üí/**\n   565‚Üí * Send email via SendGrid\n   566‚Üí */\n   567‚Üíasync function sendViaSendGrid(to, subject, html, text) {\n   568‚Üí  if (!EMAIL_CONFIG.sendgrid.apiKey) {\n   569‚Üí    throw new Error('SENDGRID_API_KEY not configured');\n   570‚Üí  }\n   571‚Üí\n   572‚Üí  const response = await fetch('https://api.sendgrid.com/v3/mail/send', {\n   573‚Üí    method: 'POST',\n   574‚Üí    headers: {\n   575‚Üí      'Authorization': `Bearer ${EMAIL_CONFIG.sendgrid.apiKey}`,\n   576‚Üí      'Content-Type': 'application/json'\n   577‚Üí    },\n   578‚Üí    body: JSON.stringify({\n   579‚Üí      personalizations: [{ to: [{ email: to }] }],\n   580‚Üí      from: { email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || EMAIL_CONFIG.from, name: 'SPLICE' },\n   581‚Üí      reply_to: { email: EMAIL_CONFIG.replyTo },\n   582‚Üí      subject,\n   583‚Üí      content: [\n   584‚Üí        { type: 'text/plain', value: text },\n   585‚Üí        { type: 'text/html', value: html }\n   586‚Üí      ]\n   587‚Üí    })\n   588‚Üí  });\n   589‚Üí\n   590‚Üí  if (!response.ok) {\n   591‚Üí    const error = await response.text();\n   592‚Üí    throw new Error(`SendGrid error: ${response.status} - ${error}`);\n   593‚Üí  }\n   594‚Üí\n   595‚Üí  return { provider: 'sendgrid', messageId: response.headers.get('x-message-id') };\n   596‚Üí}\n   597‚Üí\n   598‚Üí/**\n   599‚Üí * Send email via SendGrid Dynamic Template\n   600‚Üí * @param {string} to - Recipient email\n   601‚Üí * @param {string} templateId - SendGrid dynamic template ID\n   602‚Üí * @param {Object} dynamicData - Template variables\n   603‚Üí */\n   604‚Üíasync function sendViaSendGridTemplate(to, templateId, dynamicData = {}) {\n   605‚Üí  if (!EMAIL_CONFIG.sendgrid.apiKey) {\n   606‚Üí    throw new Error('SENDGRID_API_KEY not configured');\n   607‚Üí  }\n   608‚Üí\n   609‚Üí  const response = await fetch('https://api.sendgrid.com/v3/mail/send', {\n   610‚Üí    method: 'POST',\n   611‚Üí    headers: {\n   612‚Üí      'Authorization': `Bearer ${EMAIL_CONFIG.sendgrid.apiKey}`,\n   613‚Üí      'Content-Type': 'application/json'\n   614‚Üí    },\n   615‚Üí    body: JSON.stringify({\n   616‚Üí      personalizations: [{\n   617‚Üí        to: [{ email: to }],\n   618‚Üí        dynamic_template_data: dynamicData\n   619‚Üí      }],\n   620‚Üí      from: { email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || EMAIL_CONFIG.from, name: 'SPLICE' },\n   621‚Üí      reply_to: { email: EMAIL_CONFIG.replyTo },\n   622‚Üí      template_id: templateId\n   623‚Üí    })\n   624‚Üí  });\n   625‚Üí\n   626‚Üí  if (!response.ok) {\n   627‚Üí    const error = await response.text();\n   628‚Üí    throw new Error(`SendGrid error: ${response.status} - ${error}`);\n   629‚Üí  }\n   630‚Üí\n   631‚Üí  return { provider: 'sendgrid-template', messageId: response.headers.get('x-message-id'), templateId };\n   632‚Üí}\n   633‚Üí\n   634‚Üí/**\n   635‚Üí * Send email via AWS SES\n   636‚Üí */\n   637‚Üíasync function sendViaSES(to, subject, html, text) {\n   638‚Üí  // Dynamically import AWS SDK to avoid loading if not needed\n   639‚Üí  try {\n   640‚Üí    const { SESClient, SendEmailCommand } = await import('@aws-sdk/client-ses');\n   641‚Üí\n   642‚Üí    const client = new SESClient({ region: EMAIL_CONFIG.ses.region });\n   643‚Üí\n   644‚Üí    const command = new SendEmailCommand({\n   645‚Üí      Source: EMAIL_CONFIG.from,\n   646‚Üí      Destination: { ToAddresses: [to] },\n   647‚Üí      ReplyToAddresses: [EMAIL_CONFIG.replyTo],\n   648‚Üí      Message: {\n   649‚Üí        Subject: { Data: subject, Charset: 'UTF-8' },\n   650‚Üí        Body: {\n   651‚Üí          Html: { Data: html, Charset: 'UTF-8' },\n   652‚Üí          Text: { Data: text, Charset: 'UTF-8' }\n   653‚Üí        }\n   654‚Üí      }\n   655‚Üí    });\n   656‚Üí\n   657‚Üí    const result = await client.send(command);\n   658‚Üí    return { provider: 'ses', messageId: result.MessageId };\n   659‚Üí  } catch (err) {\n   660‚Üí    if (err.code === 'ERR_MODULE_NOT_FOUND') {\n   661‚Üí      throw new Error('AWS SDK not installed. Run: npm install @aws-sdk/client-ses');\n   662‚Üí    }\n   663‚Üí    throw err;\n   664‚Üí  }\n   665‚Üí}\n   666‚Üí\n   667‚Üí/**\n   668‚Üí * Log email to console (development mode)\n   669‚Üí */\n   670‚Üífunction sendViaConsole(to, subject, html, text) {\n   671‚Üí  console.log('\\n========== EMAIL (CONSOLE MODE) ==========');\n   672‚Üí  console.log(`To: ${to}`);\n   673‚Üí  console.log(`Subject: ${subject}`);\n   674‚Üí  console.log(`From: ${EMAIL_CONFIG.from}`);\n   675‚Üí  console.log('--- TEXT VERSION ---');\n   676‚Üí  console.log(text);\n   677‚Üí  console.log('==========================================\\n');\n   678‚Üí\n   679‚Üí  return { provider: 'console', messageId: `console-${Date.now()}` };\n   680‚Üí}\n   681‚Üí\n   682‚Üí// ============================================================================\n   683‚Üí// PUBLIC API\n   684‚Üí// ============================================================================\n   685‚Üí\n   686‚Üí/**\n   687‚Üí * Send an email using the configured provider\n   688‚Üí * @param {string} to - Recipient email\n   689‚Üí * @param {string} subject - Email subject\n   690‚Üí * @param {string} html - HTML content\n   691‚Üí * @param {string} text - Plain text content\n   692‚Üí * @returns {Promise<{provider: string, messageId: string}>}\n   693‚Üí */\n   694‚Üíasync function sendEmail(to, subject, html, text) {\n   695‚Üí  const provider = EMAIL_CONFIG.provider.toLowerCase();\n   696‚Üí\n   697‚Üí  console.log(`[SPLICE Email] Sending to ${to} via ${provider}`);\n   698‚Üí\n   699‚Üí  try {\n   700‚Üí    let result;\n   701‚Üí\n   702‚Üí    switch (provider) {\n   703‚Üí      case 'sendgrid':\n   704‚Üí        result = await sendViaSendGrid(to, subject, html, text);\n   705‚Üí        break;\n   706‚Üí      case 'ses':\n   707‚Üí        result = await sendViaSES(to, subject, html, text);\n   708‚Üí        break;\n   709‚Üí      case 'console':\n   710‚Üí      default:\n   711‚Üí        result = sendViaConsole(to, subject, html, text);\n   712‚Üí        break;\n   713‚Üí    }\n   714‚Üí\n   715‚Üí    console.log(`[SPLICE Email] Sent successfully via ${result.provider}: ${result.messageId}`);\n   716‚Üí    return result;\n   717‚Üí  } catch (err) {\n   718‚Üí    console.error(`[SPLICE Email] Failed to send via ${provider}:`, err.message);\n   719‚Üí    throw err;\n   720‚Üí  }\n   721‚Üí}\n   722‚Üí\n   723‚Üí/**\n   724‚Üí * Send license key email to customer\n   725‚Üí * @param {string} email - Customer email\n   726‚Üí * @param {string} licenseKey - The license key\n   727‚Üí * @param {string} tier - Subscription tier (starter/pro/team)\n   728‚Üí */\n   729‚Üíasync function sendLicenseKeyEmail(email, licenseKey, tier) {\n   730‚Üí  const tierDetails = getTierDetails(tier);\n   731‚Üí  const template = TEMPLATES.licenseKey;\n   732‚Üí\n   733‚Üí  const data = {\n   734‚Üí    licenseKey,\n   735‚Üí    tier,\n   736‚Üí    hours: tierDetails.hours,\n   737‚Üí    musicCredits: tierDetails.musicCredits\n   738‚Üí  };\n   739‚Üí\n   740‚Üí  return sendEmail(\n   741‚Üí    email,\n   742‚Üí    template.subject,\n   743‚Üí    template.html(data),\n   744‚Üí    template.text(data)\n   745‚Üí  );\n   746‚Üí}\n   747‚Üí\n   748‚Üí/**\n   749‚Üí * Send payment warning email to customer\n   750‚Üí * @param {string} email - Customer email\n   751‚Üí * @param {number} attemptCount - Which payment attempt failed (1-3)\n   752‚Üí */\n   753‚Üíasync function sendPaymentWarningEmail(email, attemptCount) {\n   754‚Üí  const template = TEMPLATES.paymentWarning;\n   755‚Üí  const data = { attemptCount };\n   756‚Üí\n   757‚Üí  return sendEmail(\n   758‚Üí    email,\n   759‚Üí    template.subject,\n   760‚Üí    template.html(data),\n   761‚Üí    template.text(data)\n   762‚Üí  );\n   763‚Üí}\n   764‚Üí\n   765‚Üí/**\n   766‚Üí * Send license key lookup email\n   767‚Üí * @param {string} email - Customer email\n   768‚Üí * @param {string} licenseKey - The license key\n   769‚Üí */\n   770‚Üíasync function sendLicenseLookupEmail(email, licenseKey) {\n   771‚Üí  const template = TEMPLATES.licenseLookup;\n   772‚Üí  const data = { licenseKey };\n   773‚Üí\n   774‚Üí  return sendEmail(\n   775‚Üí    email,\n   776‚Üí    template.subject,\n   777‚Üí    template.html(data),\n   778‚Üí    template.text(data)\n   779‚Üí  );\n   780‚Üí}\n   781‚Üí\n   782‚Üí/**\n   783‚Üí * Send sign-in code email (passwordless authentication)\n   784‚Üí * @param {string} email - User email\n   785‚Üí * @param {string} code - The sign-in code (e.g., 6-digit code)\n   786‚Üí * @param {number} expiresInMinutes - How long until the code expires (default: 10)\n   787‚Üí */\n   788‚Üíasync function sendSignInCodeEmail(email, code, expiresInMinutes = 10) {\n   789‚Üí  const provider = EMAIL_CONFIG.provider.toLowerCase();\n   790‚Üí\n   791‚Üí  // Use SendGrid Dynamic Template when available\n   792‚Üí  if (provider === 'sendgrid' && TEMPLATE_IDS.signinCode && EMAIL_CONFIG.sendgrid.apiKey) {\n   793‚Üí    console.log(`[SPLICE Email] Sending sign-in code to ${email} via SendGrid Dynamic Template`);\n   794‚Üí    return sendViaSendGridTemplate(email, TEMPLATE_IDS.signinCode, {\n   795‚Üí      code: code,\n   796‚Üí      expiresInMinutes: expiresInMinutes\n   797‚Üí    });\n   798‚Üí  }\n   799‚Üí\n   800‚Üí  // Fallback to inline template\n   801‚Üí  const template = TEMPLATES.signinCode;\n   802‚Üí  const data = { code, expiresInMinutes };\n   803‚Üí  const subject = template.subject.replace('{{code}}', code);\n   804‚Üí\n   805‚Üí  return sendEmail(\n   806‚Üí    email,\n   807‚Üí    subject,\n   808‚Üí    template.html(data),\n   809‚Üí    template.text(data)\n   810‚Üí  );\n   811‚Üí}\n   812‚Üí\n   813‚Üí/**\n   814‚Üí * Check if email service is configured for production use\n   815‚Üí */\n   816‚Üífunction isEmailConfigured() {\n   817‚Üí  const provider = EMAIL_CONFIG.provider.toLowerCase();\n   818‚Üí\n   819‚Üí  if (provider === 'sendgrid') {\n   820‚Üí    return !!EMAIL_CONFIG.sendgrid.apiKey;\n   821‚Üí  }\n   822‚Üí\n   823‚Üí  if (provider === 'ses') {\n   824‚Üí    return !!(process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY);\n   825‚Üí  }\n   826‚Üí\n   827‚Üí  // Console mode is always \"configured\" (for dev)\n   828‚Üí  return true;\n   829‚Üí}\n   830‚Üí\n   831‚Üí// ============================================================================\n   832‚Üí// EXPORTS\n   833‚Üí// ============================================================================\n   834‚Üí\n   835‚Üímodule.exports = {\n   836‚Üí  sendEmail,\n   837‚Üí  sendLicenseKeyEmail,\n   838‚Üí  sendPaymentWarningEmail,\n   839‚Üí  sendLicenseLookupEmail,\n   840‚Üí  sendSignInCodeEmail,\n   841‚Üí  isEmailConfigured,\n   842‚Üí  EMAIL_CONFIG\n   843‚Üí};\n   844‚Üí\n\n</system-reminder>\n"}]},"uuid":"60c7ef25-702d-4010-9d37-135619274343","timestamp":"2025-12-30T00:30:24.350Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-backend/services/emailService.js","content":"/**\n * SPLICE Email Service\n *\n * Handles email delivery for license keys, payment notifications, etc.\n * Supports multiple providers: SendGrid (primary), AWS SES (fallback)\n *\n * Required env vars:\n * - EMAIL_PROVIDER: 'sendgrid' | 'ses' | 'console' (default: 'console' for dev)\n * - SENDGRID_API_KEY: SendGrid API key\n * - AWS_SES_REGION: AWS SES region (default: 'us-east-1')\n * - AWS_ACCESS_KEY_ID: AWS access key (for SES)\n * - AWS_SECRET_ACCESS_KEY: AWS secret (for SES)\n * - EMAIL_FROM: Sender email address (default: 'noreply@splice.video')\n */\n\n// ============================================================================\n// CONFIGURATION\n// ============================================================================\n\nconst EMAIL_CONFIG = {\n  provider: process.env.EMAIL_PROVIDER || 'console',\n  from: process.env.EMAIL_FROM || 'SPLICE <noreply@splice.video>',\n  replyTo: process.env.EMAIL_REPLY_TO || 'support@splice.video',\n  sendgrid: {\n    apiKey: process.env.SENDGRID_API_KEY\n  },\n  ses: {\n    region: process.env.AWS_SES_REGION || 'us-east-1'\n  }\n};\n\n// SendGrid Dynamic Template IDs\nconst TEMPLATE_IDS = {\n  signinCode: 'd-8ba02a0aacf0425da03610dce44fd08d'\n};\n\n// Email templates\nconst TEMPLATES = {\n  licenseKey: {\n    subject: 'Welcome to SPLICE! Your License Key + Quick Start Guide',\n    html: (data) => `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; margin: 0; padding: 0; }\n    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; background: white; }\n    .header { text-align: center; margin-bottom: 30px; }\n    .logo { font-size: 32px; font-weight: bold; color: #00D4FF; }\n    .tagline { color: #6b7280; font-size: 14px; margin-top: 5px; }\n    .hero-cta { background: linear-gradient(135deg, #00D4FF, #00A8CC); border-radius: 12px; padding: 30px; text-align: center; margin: 30px 0; }\n    .hero-cta h2 { color: white; margin: 0 0 15px 0; font-size: 22px; }\n    .hero-cta p { color: rgba(255,255,255,0.9); margin: 0 0 20px 0; }\n    .button-primary { display: inline-block; background: white; color: #00A8CC; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }\n    .button-primary:hover { background: #f0f0f0; }\n    .license-box { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }\n    .license-key { font-family: monospace; font-size: 22px; font-weight: bold; color: #1e293b; letter-spacing: 2px; }\n    .tier-badge { display: inline-block; background: #00D4FF; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-top: 10px; }\n    .quick-wins { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px; margin: 20px 0; }\n    .quick-wins h3 { color: #166534; margin-top: 0; }\n    .quick-wins ul { margin: 0; padding-left: 20px; }\n    .quick-wins li { margin: 8px 0; color: #15803d; }\n    .instructions { background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0; }\n    .instructions h3 { margin-top: 0; color: #374151; }\n    .instructions ol { margin: 0; padding-left: 20px; }\n    .instructions li { margin: 8px 0; }\n    .resources { display: table; width: 100%; margin: 20px 0; }\n    .resource-item { display: table-cell; text-align: center; padding: 15px; width: 33%; }\n    .resource-item a { display: block; color: #00A8CC; text-decoration: none; font-weight: 500; }\n    .resource-item span { display: block; font-size: 12px; color: #6b7280; margin-top: 5px; }\n    .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px; }\n    .button { display: inline-block; background: #00D4FF; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"logo\">SPLICE</div>\n      <p class=\"tagline\">Cut Your Editing Time in Half. Automatically.</p>\n    </div>\n\n    <div class=\"hero-cta\">\n      <h2>üéâ You're In! Let's Get Started</h2>\n      <p>Download SPLICE and make your first AI-powered edit in under 2 minutes.</p>\n      <a href=\"https://splice.video/download\" class=\"button-primary\">Download SPLICE ‚Üí</a>\n    </div>\n\n    <div class=\"license-box\">\n      <p style=\"margin: 0 0 10px; color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;\">Your License Key</p>\n      <div class=\"license-key\">${escapeHtml(data.licenseKey)}</div>\n      <div class=\"tier-badge\">${escapeHtml(data.tier.toUpperCase())} Plan</div>\n    </div>\n\n    <div class=\"quick-wins\">\n      <h3>‚ö° Your First 5-Minute Win</h3>\n      <ul>\n        <li><strong>Open any project</strong> in Premiere Pro</li>\n        <li><strong>Click GO</strong> in the SPLICE panel</li>\n        <li><strong>Watch silences vanish</strong> automatically</li>\n      </ul>\n      <p style=\"margin-bottom: 0; font-size: 14px;\">Most editors save <strong>2+ hours per video</strong> on their first use!</p>\n    </div>\n\n    <div class=\"instructions\">\n      <h3>üìã Setup Instructions</h3>\n      <ol>\n        <li>Open Adobe Premiere Pro (2023 or later)</li>\n        <li>Go to <strong>Window ‚Üí Extensions ‚Üí SPLICE</strong></li>\n        <li>Click the Login button and enter your license key</li>\n        <li>You're ready! Open any sequence and hit <strong>GO</strong></li>\n      </ol>\n    </div>\n\n    <p>Your ${escapeHtml(data.tier)} plan includes:</p>\n    <ul>\n      <li><strong>${escapeHtml(String(data.hours))} hours</strong> of AI processing per month</li>\n      <li><strong>${escapeHtml(String(data.musicCredits))} music credits</strong> per month</li>\n      <li>14-day free trial - cancel anytime</li>\n    </ul>\n\n    <div class=\"resources\">\n      <div class=\"resource-item\">\n        <a href=\"https://splice.video/docs/tutorials\">üìö Tutorials</a>\n        <span>Step-by-step guides</span>\n      </div>\n      <div class=\"resource-item\">\n        <a href=\"https://splice.video/docs/faq\">‚ùì FAQ</a>\n        <span>Common questions</span>\n      </div>\n      <div class=\"resource-item\">\n        <a href=\"mailto:support@splice.video\">üí¨ Support</a>\n        <span>We're here to help</span>\n      </div>\n    </div>\n\n    <div class=\"footer\">\n      <p>Questions? Just reply to this email - we read every message!</p>\n      <p style=\"font-size: 12px;\">&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n    </div>\n  </div>\n</body>\n</html>\n    `,\n    text: (data) => `\nSPLICE - Welcome! Your License Key + Quick Start Guide\n=======================================================\n\nüéâ YOU'RE IN! LET'S GET STARTED\n\nDownload SPLICE: https://splice.video/download\n\nYOUR LICENSE KEY:\n${data.licenseKey}\nPlan: ${data.tier.toUpperCase()}\n\n‚ö° YOUR FIRST 5-MINUTE WIN:\n1. Open any project in Premiere Pro\n2. Click GO in the SPLICE panel\n3. Watch silences vanish automatically\n\nMost editors save 2+ hours per video on their first use!\n\nüìã SETUP INSTRUCTIONS:\n1. Open Adobe Premiere Pro (2023 or later)\n2. Go to Window ‚Üí Extensions ‚Üí SPLICE\n3. Click the Login button and enter your license key\n4. You're ready! Open any sequence and hit GO\n\nYOUR ${data.tier.toUpperCase()} PLAN INCLUDES:\n- ${data.hours} hours of AI processing per month\n- ${data.musicCredits} music credits per month\n- 14-day free trial - cancel anytime\n\nHELPFUL RESOURCES:\nüìö Tutorials: https://splice.video/docs/tutorials\n‚ùì FAQ: https://splice.video/docs/faq\nüí¨ Support: support@splice.video\n\nQuestions? Just reply to this email - we read every message!\n\n¬© ${new Date().getFullYear()} SPLICE. All rights reserved.\n    `\n  },\n\n  paymentWarning: {\n    subject: 'Action Required: Payment Failed for SPLICE',\n    html: (data) => `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }\n    .header { text-align: center; margin-bottom: 30px; }\n    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }\n    .warning-box { background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; padding: 20px; margin: 20px 0; }\n    .warning-icon { font-size: 48px; text-align: center; }\n    .button { display: inline-block; background: #7c3aed; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin: 10px 0; }\n    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"logo\">SPLICE</div>\n    </div>\n\n    <div class=\"warning-box\">\n      <div class=\"warning-icon\">‚ö†Ô∏è</div>\n      <h2 style=\"text-align: center; color: #dc2626; margin: 10px 0;\">Payment Failed</h2>\n      <p>We were unable to process your payment for your SPLICE subscription. This was attempt ${escapeHtml(String(data.attemptCount))} of 3.</p>\n    </div>\n\n    <p>To keep your subscription active and avoid interruption to your service, please update your payment method:</p>\n\n    <p style=\"text-align: center;\">\n      <a href=\"https://splice.video/account/billing\" class=\"button\">Update Payment Method</a>\n    </p>\n\n    <p><strong>What happens next?</strong></p>\n    <ul>\n      <li>We'll automatically retry the payment in a few days</li>\n      <li>If all payment attempts fail, your subscription will be cancelled</li>\n      <li>You'll lose access to premium features</li>\n    </ul>\n\n    <p>If you have any questions or need assistance, please don't hesitate to reach out.</p>\n\n    <div class=\"footer\">\n      <p>Need help? Reply to this email or visit <a href=\"https://splice.video/support\">splice.video/support</a></p>\n      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n    </div>\n  </div>\n</body>\n</html>\n    `,\n    text: (data) => `\nSPLICE - Payment Failed\n\nWe were unable to process your payment for your SPLICE subscription.\nThis was attempt ${data.attemptCount} of 3.\n\nTo keep your subscription active, please update your payment method:\nhttps://splice.video/account/billing\n\nWHAT HAPPENS NEXT:\n- We'll automatically retry the payment in a few days\n- If all payment attempts fail, your subscription will be cancelled\n- You'll lose access to premium features\n\nIf you have any questions, please reply to this email.\n\n¬© ${new Date().getFullYear()} SPLICE. All rights reserved.\n    `\n  },\n\n  licenseLookup: {\n    subject: 'Your SPLICE License Key',\n    html: (data) => `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }\n    .header { text-align: center; margin-bottom: 30px; }\n    .logo { font-size: 32px; font-weight: bold; color: #7c3aed; }\n    .license-box { background: #f8f5ff; border: 2px solid #7c3aed; border-radius: 8px; padding: 20px; text-align: center; margin: 30px 0; }\n    .license-key { font-family: monospace; font-size: 24px; font-weight: bold; color: #7c3aed; letter-spacing: 2px; }\n    .footer { text-align: center; margin-top: 40px; color: #6b7280; font-size: 14px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"logo\">SPLICE</div>\n    </div>\n\n    <h2>License Key Lookup</h2>\n    <p>You requested your SPLICE license key. Here it is:</p>\n\n    <div class=\"license-box\">\n      <div class=\"license-key\">${escapeHtml(data.licenseKey)}</div>\n    </div>\n\n    <p>If you didn't request this, you can safely ignore this email.</p>\n\n    <div class=\"footer\">\n      <p>Need help? Reply to this email or visit <a href=\"https://splice.video/support\">splice.video/support</a></p>\n      <p>&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n    </div>\n  </div>\n</body>\n</html>\n    `,\n    text: (data) => `\nSPLICE - License Key Lookup\n\nYou requested your SPLICE license key. Here it is:\n\n${data.licenseKey}\n\nIf you didn't request this, you can safely ignore this email.\n\nNeed help? Visit https://splice.video/support\n\n¬© ${new Date().getFullYear()} SPLICE. All rights reserved.\n    `\n  },\n\n  // Sign-in code email (passwordless auth)\n  signinCode: {\n    subject: 'Your SPLICE Sign-In Code: {{code}}',\n    html: (data) => `\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n  <title>Your SPLICE Sign-In Code</title>\n  <!--[if mso]>\n  <noscript>\n    <xml>\n      <o:OfficeDocumentSettings>\n        <o:PixelsPerInch>96</o:PixelsPerInch>\n      </o:OfficeDocumentSettings>\n    </xml>\n  </noscript>\n  <![endif]-->\n  <style>\n    body, table, td, p, a, li { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }\n    table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; }\n    img { -ms-interpolation-mode: bicubic; border: 0; outline: none; text-decoration: none; }\n    body { margin: 0; padding: 0; width: 100%; background-color: #060b14; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }\n    @media only screen and (max-width: 600px) {\n      .container { width: 100% !important; padding: 16px !important; }\n      .code-box { font-size: 28px !important; letter-spacing: 6px !important; }\n    }\n  </style>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #060b14;\">\n  <div style=\"display: none; max-height: 0; overflow: hidden; font-size: 1px; line-height: 1px; color: #060b14;\">Your SPLICE sign-in code is inside. Start editing 10x faster today!</div>\n  <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color: #060b14;\">\n    <tr>\n      <td align=\"center\" style=\"padding: 40px 20px;\">\n        <table role=\"presentation\" class=\"container\" cellpadding=\"0\" cellspacing=\"0\" width=\"560\" style=\"max-width: 560px;\">\n          <tr>\n            <td align=\"center\" style=\"padding-bottom: 32px;\">\n              <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n                <tr>\n                  <td style=\"vertical-align: middle; padding-right: 10px;\">\n                    <img src=\"https://splice.video/images/logo.jpg\" alt=\"SPLICE\" width=\"40\" height=\"40\" style=\"display: block; border-radius: 8px;\">\n                  </td>\n                  <td style=\"vertical-align: middle;\">\n                    <span style=\"font-size: 26px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px;\">SPLICE</span>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <tr>\n            <td>\n              <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background: linear-gradient(180deg, #0f1629 0%, #0a0f1a 100%); border-radius: 16px; border: 1px solid rgba(0, 212, 255, 0.15); box-shadow: 0 0 40px rgba(0, 212, 255, 0.08);\">\n                <tr>\n                  <td align=\"center\" style=\"padding: 40px 40px 24px 40px;\">\n                    <h1 style=\"margin: 0; font-size: 28px; font-weight: 600; color: #ffffff; line-height: 1.3;\">Welcome to the future of editing ‚ú®</h1>\n                  </td>\n                </tr>\n                <tr>\n                  <td align=\"center\" style=\"padding: 0 40px 32px 40px;\">\n                    <p style=\"margin: 0; font-size: 16px; color: #94a3b8; line-height: 1.6;\">You're one step away from editing 10x faster. Use this code to sign in:</p>\n                  </td>\n                </tr>\n                <tr>\n                  <td align=\"center\" style=\"padding: 0 40px 32px 40px;\">\n                    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" style=\"background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 168, 204, 0.05) 100%); border-radius: 12px; border: 2px solid #00D4FF; box-shadow: 0 0 24px rgba(0, 212, 255, 0.25);\">\n                      <tr>\n                        <td align=\"center\" style=\"padding: 24px 48px;\">\n                          <span class=\"code-box\" style=\"font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 36px; font-weight: 700; color: #00D4FF; letter-spacing: 10px; text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);\">${escapeHtml(data.code)}</span>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n                <tr>\n                  <td align=\"center\" style=\"padding: 0 40px 40px 40px;\">\n                    <p style=\"margin: 0; font-size: 14px; color: #64748b;\">‚è±Ô∏è This code expires in <strong style=\"color: #ffffff;\">10 minutes</strong></p>\n                  </td>\n                </tr>\n                <tr>\n                  <td style=\"padding: 0 40px;\">\n                    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n                      <tr><td style=\"border-top: 1px solid rgba(148, 163, 184, 0.1);\"></td></tr>\n                    </table>\n                  </td>\n                </tr>\n                <tr>\n                  <td style=\"padding: 40px;\">\n                    <h2 style=\"margin: 0 0 24px 0; font-size: 18px; font-weight: 600; color: #ffffff;\">üöÄ What you'll unlock:</h2>\n                    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n                      <tr>\n                        <td width=\"50%\" style=\"padding: 8px 8px 8px 0; vertical-align: top;\">\n                          <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n                            <tr>\n                              <td style=\"padding-right: 12px; vertical-align: top;\"><span style=\"font-size: 20px;\">‚ö°</span></td>\n                              <td style=\"vertical-align: top;\">\n                                <p style=\"margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;\">AI Silence Removal</p>\n                                <p style=\"margin: 4px 0 0 0; font-size: 13px; color: #64748b;\">Auto-trim dead air</p>\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                        <td width=\"50%\" style=\"padding: 8px 0 8px 8px; vertical-align: top;\">\n                          <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n                            <tr>\n                              <td style=\"padding-right: 12px; vertical-align: top;\"><span style=\"font-size: 20px;\">üé¨</span></td>\n                              <td style=\"vertical-align: top;\">\n                                <p style=\"margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;\">Smart Take Detection</p>\n                                <p style=\"margin: 4px 0 0 0; font-size: 13px; color: #64748b;\">Find best takes fast</p>\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                      <tr>\n                        <td width=\"50%\" style=\"padding: 8px 8px 8px 0; vertical-align: top;\">\n                          <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n                            <tr>\n                              <td style=\"padding-right: 12px; vertical-align: top;\"><span style=\"font-size: 20px;\">üéµ</span></td>\n                              <td style=\"vertical-align: top;\">\n                                <p style=\"margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;\">AI Music Generation</p>\n                                <p style=\"margin: 4px 0 0 0; font-size: 13px; color: #64748b;\">Royalty-free tracks</p>\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                        <td width=\"50%\" style=\"padding: 8px 0 8px 8px; vertical-align: top;\">\n                          <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n                            <tr>\n                              <td style=\"padding-right: 12px; vertical-align: top;\"><span style=\"font-size: 20px;\">üì±</span></td>\n                              <td style=\"vertical-align: top;\">\n                                <p style=\"margin: 0; font-size: 14px; color: #e2e8f0; font-weight: 500;\">Social Reframe</p>\n                                <p style=\"margin: 4px 0 0 0; font-size: 13px; color: #64748b;\">Export to any platform</p>\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n                <tr>\n                  <td align=\"center\" style=\"padding: 0 40px 40px 40px;\">\n                    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n                      <tr>\n                        <td align=\"center\" style=\"background: linear-gradient(135deg, #00D4FF 0%, #0099CC 100%); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);\">\n                          <a href=\"https://splice.video/download\" target=\"_blank\" style=\"display: inline-block; padding: 16px 40px; font-size: 16px; font-weight: 600; color: #060b14; text-decoration: none; letter-spacing: -0.3px;\">Download SPLICE Now ‚Üí</a>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <tr>\n            <td align=\"center\" style=\"padding: 40px 0 24px 0;\">\n              <p style=\"margin: 0; font-size: 14px; color: #64748b;\">Need help getting started?</p>\n            </td>\n          </tr>\n          <tr>\n            <td align=\"center\" style=\"padding-bottom: 40px;\">\n              <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\">\n                <tr>\n                  <td style=\"padding: 0 12px;\"><a href=\"https://splice.video/docs/quickstart\" style=\"font-size: 14px; color: #00D4FF; text-decoration: none;\">Quick Start Guide</a></td>\n                  <td style=\"color: #334155;\">|</td>\n                  <td style=\"padding: 0 12px;\"><a href=\"https://discord.gg/splice\" style=\"font-size: 14px; color: #00D4FF; text-decoration: none;\">Join Discord</a></td>\n                  <td style=\"color: #334155;\">|</td>\n                  <td style=\"padding: 0 12px;\"><a href=\"mailto:support@splice.video\" style=\"font-size: 14px; color: #00D4FF; text-decoration: none;\">Contact Support</a></td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <tr>\n            <td align=\"center\" style=\"padding: 24px 0; border-top: 1px solid rgba(148, 163, 184, 0.1);\">\n              <p style=\"margin: 0 0 8px 0; font-size: 13px; color: #475569;\">You received this email because you signed up for SPLICE.</p>\n              <p style=\"margin: 0; font-size: 13px; color: #475569;\">¬© ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n</html>\n    `,\n    text: (data) => `\nWelcome to SPLICE!\n\nYour sign-in code is: ${data.code}\n\nThis code expires in 10 minutes.\n\nWhat you'll unlock:\n- ‚ö° AI Silence Removal - Auto-trim dead air\n- üé¨ Smart Take Detection - Find best takes fast\n- üéµ AI Music Generation - Royalty-free tracks\n- üì± Social Reframe - Export to any platform\n\nDownload SPLICE: https://splice.video/download\n\nNeed help?\n- Quick Start Guide: https://splice.video/docs/quickstart\n- Join Discord: https://discord.gg/splice\n- Contact Support: support@splice.video\n\n¬© ${new Date().getFullYear()} SPLICE. All rights reserved.\n    `\n  }\n};\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Escape HTML to prevent XSS in email content\n */\nfunction escapeHtml(str) {\n  if (str === null || str === undefined) return '';\n  if (typeof str !== 'string') str = String(str);\n\n  const escapeMap = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#x27;'\n  };\n\n  return str.replace(/[&<>\"']/g, char => escapeMap[char]);\n}\n\n/**\n * Get tier details for email\n */\nfunction getTierDetails(tier) {\n  const tiers = {\n    starter: { hours: 4, musicCredits: 2 },\n    pro: { hours: 15, musicCredits: 10 },\n    team: { hours: 50, musicCredits: 50 }\n  };\n  return tiers[tier] || tiers.starter;\n}\n\n// ============================================================================\n// EMAIL PROVIDERS\n// ============================================================================\n\n/**\n * Send email via SendGrid\n */\nasync function sendViaSendGrid(to, subject, html, text) {\n  if (!EMAIL_CONFIG.sendgrid.apiKey) {\n    throw new Error('SENDGRID_API_KEY not configured');\n  }\n\n  const response = await fetch('https://api.sendgrid.com/v3/mail/send', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${EMAIL_CONFIG.sendgrid.apiKey}`,\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      personalizations: [{ to: [{ email: to }] }],\n      from: { email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || EMAIL_CONFIG.from, name: 'SPLICE' },\n      reply_to: { email: EMAIL_CONFIG.replyTo },\n      subject,\n      content: [\n        { type: 'text/plain', value: text },\n        { type: 'text/html', value: html }\n      ]\n    })\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`SendGrid error: ${response.status} - ${error}`);\n  }\n\n  return { provider: 'sendgrid', messageId: response.headers.get('x-message-id') };\n}\n\n/**\n * Send email via SendGrid Dynamic Template\n * @param {string} to - Recipient email\n * @param {string} templateId - SendGrid dynamic template ID\n * @param {Object} dynamicData - Template variables\n */\nasync function sendViaSendGridTemplate(to, templateId, dynamicData = {}) {\n  if (!EMAIL_CONFIG.sendgrid.apiKey) {\n    throw new Error('SENDGRID_API_KEY not configured');\n  }\n\n  const response = await fetch('https://api.sendgrid.com/v3/mail/send', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${EMAIL_CONFIG.sendgrid.apiKey}`,\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      personalizations: [{\n        to: [{ email: to }],\n        dynamic_template_data: dynamicData\n      }],\n      from: { email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || EMAIL_CONFIG.from, name: 'SPLICE' },\n      reply_to: { email: EMAIL_CONFIG.replyTo },\n      template_id: templateId\n    })\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`SendGrid error: ${response.status} - ${error}`);\n  }\n\n  return { provider: 'sendgrid-template', messageId: response.headers.get('x-message-id'), templateId };\n}\n\n/**\n * Send email via AWS SES\n */\nasync function sendViaSES(to, subject, html, text) {\n  // Dynamically import AWS SDK to avoid loading if not needed\n  try {\n    const { SESClient, SendEmailCommand } = await import('@aws-sdk/client-ses');\n\n    const client = new SESClient({ region: EMAIL_CONFIG.ses.region });\n\n    const command = new SendEmailCommand({\n      Source: EMAIL_CONFIG.from,\n      Destination: { ToAddresses: [to] },\n      ReplyToAddresses: [EMAIL_CONFIG.replyTo],\n      Message: {\n        Subject: { Data: subject, Charset: 'UTF-8' },\n        Body: {\n          Html: { Data: html, Charset: 'UTF-8' },\n          Text: { Data: text, Charset: 'UTF-8' }\n        }\n      }\n    });\n\n    const result = await client.send(command);\n    return { provider: 'ses', messageId: result.MessageId };\n  } catch (err) {\n    if (err.code === 'ERR_MODULE_NOT_FOUND') {\n      throw new Error('AWS SDK not installed. Run: npm install @aws-sdk/client-ses');\n    }\n    throw err;\n  }\n}\n\n/**\n * Log email to console (development mode)\n */\nfunction sendViaConsole(to, subject, html, text) {\n  console.log('\\n========== EMAIL (CONSOLE MODE) ==========');\n  console.log(`To: ${to}`);\n  console.log(`Subject: ${subject}`);\n  console.log(`From: ${EMAIL_CONFIG.from}`);\n  console.log('--- TEXT VERSION ---');\n  console.log(text);\n  console.log('==========================================\\n');\n\n  return { provider: 'console', messageId: `console-${Date.now()}` };\n}\n\n// ============================================================================\n// PUBLIC API\n// ============================================================================\n\n/**\n * Send an email using the configured provider\n * @param {string} to - Recipient email\n * @param {string} subject - Email subject\n * @param {string} html - HTML content\n * @param {string} text - Plain text content\n * @returns {Promise<{provider: string, messageId: string}>}\n */\nasync function sendEmail(to, subject, html, text) {\n  const provider = EMAIL_CONFIG.provider.toLowerCase();\n\n  console.log(`[SPLICE Email] Sending to ${to} via ${provider}`);\n\n  try {\n    let result;\n\n    switch (provider) {\n      case 'sendgrid':\n        result = await sendViaSendGrid(to, subject, html, text);\n        break;\n      case 'ses':\n        result = await sendViaSES(to, subject, html, text);\n        break;\n      case 'console':\n      default:\n        result = sendViaConsole(to, subject, html, text);\n        break;\n    }\n\n    console.log(`[SPLICE Email] Sent successfully via ${result.provider}: ${result.messageId}`);\n    return result;\n  } catch (err) {\n    console.error(`[SPLICE Email] Failed to send via ${provider}:`, err.message);\n    throw err;\n  }\n}\n\n/**\n * Send license key email to customer\n * @param {string} email - Customer email\n * @param {string} licenseKey - The license key\n * @param {string} tier - Subscription tier (starter/pro/team)\n */\nasync function sendLicenseKeyEmail(email, licenseKey, tier) {\n  const tierDetails = getTierDetails(tier);\n  const template = TEMPLATES.licenseKey;\n\n  const data = {\n    licenseKey,\n    tier,\n    hours: tierDetails.hours,\n    musicCredits: tierDetails.musicCredits\n  };\n\n  return sendEmail(\n    email,\n    template.subject,\n    template.html(data),\n    template.text(data)\n  );\n}\n\n/**\n * Send payment warning email to customer\n * @param {string} email - Customer email\n * @param {number} attemptCount - Which payment attempt failed (1-3)\n */\nasync function sendPaymentWarningEmail(email, attemptCount) {\n  const template = TEMPLATES.paymentWarning;\n  const data = { attemptCount };\n\n  return sendEmail(\n    email,\n    template.subject,\n    template.html(data),\n    template.text(data)\n  );\n}\n\n/**\n * Send license key lookup email\n * @param {string} email - Customer email\n * @param {string} licenseKey - The license key\n */\nasync function sendLicenseLookupEmail(email, licenseKey) {\n  const template = TEMPLATES.licenseLookup;\n  const data = { licenseKey };\n\n  return sendEmail(\n    email,\n    template.subject,\n    template.html(data),\n    template.text(data)\n  );\n}\n\n/**\n * Send sign-in code email (passwordless authentication)\n * @param {string} email - User email\n * @param {string} code - The sign-in code (e.g., 6-digit code)\n * @param {number} expiresInMinutes - How long until the code expires (default: 10)\n */\nasync function sendSignInCodeEmail(email, code, expiresInMinutes = 10) {\n  const provider = EMAIL_CONFIG.provider.toLowerCase();\n\n  // Use SendGrid Dynamic Template when available\n  if (provider === 'sendgrid' && TEMPLATE_IDS.signinCode && EMAIL_CONFIG.sendgrid.apiKey) {\n    console.log(`[SPLICE Email] Sending sign-in code to ${email} via SendGrid Dynamic Template`);\n    return sendViaSendGridTemplate(email, TEMPLATE_IDS.signinCode, {\n      code: code,\n      expiresInMinutes: expiresInMinutes\n    });\n  }\n\n  // Fallback to inline template\n  const template = TEMPLATES.signinCode;\n  const data = { code, expiresInMinutes };\n  const subject = template.subject.replace('{{code}}', code);\n\n  return sendEmail(\n    email,\n    subject,\n    template.html(data),\n    template.text(data)\n  );\n}\n\n/**\n * Check if email service is configured for production use\n */\nfunction isEmailConfigured() {\n  const provider = EMAIL_CONFIG.provider.toLowerCase();\n\n  if (provider === 'sendgrid') {\n    return !!EMAIL_CONFIG.sendgrid.apiKey;\n  }\n\n  if (provider === 'ses') {\n    return !!(process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY);\n  }\n\n  // Console mode is always \"configured\" (for dev)\n  return true;\n}\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nmodule.exports = {\n  sendEmail,\n  sendLicenseKeyEmail,\n  sendPaymentWarningEmail,\n  sendLicenseLookupEmail,\n  sendSignInCodeEmail,\n  isEmailConfigured,\n  EMAIL_CONFIG\n};\n","numLines":844,"startLine":1,"totalLines":844}}}
{"parentUuid":"60c7ef25-702d-4010-9d37-135619274343","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_012rVxnFNLJ6ZQH6k48eaeyh","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a good understanding of the patterns. The existing API routes:\n1. Use Next.js App Router conventions with `NextRequest` and `NextResponse`\n2. Make direct API calls (e.g., to Stripe, or to the backend via fetch)\n3. Use SendGrid directly in the backend via fetch calls\n\nFor the contact form, I'll use SendGrid directly in the Next.js API route (like the backend does), since making an HTTP call to the backend for just sending an email would be unnecessary overhead. Let me create the contact form API endpoint:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":13537,"cache_read_input_tokens":24656,"cache_creation":{"ephemeral_5m_input_tokens":13537,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWbvkobpJZ2MTN1euEARe","type":"assistant","uuid":"8022aee2-914d-46ef-9c2a-3deb6f4a98d6","timestamp":"2025-12-30T00:30:33.777Z"}
{"parentUuid":"8022aee2-914d-46ef-9c2a-3deb6f4a98d6","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_012rVxnFNLJ6ZQH6k48eaeyh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QTZowJB4YJPJBbhWpBnnnf","name":"Bash","input":{"command":"mkdir -p /Users/imorgado/SPLICE/splice-website/src/app/api/contact","description":"Create contact API directory"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":13537,"cache_read_input_tokens":24656,"cache_creation":{"ephemeral_5m_input_tokens":13537,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWbvkobpJZ2MTN1euEARe","type":"assistant","uuid":"1c1082f6-8284-4b73-af8c-86a29b507a7a","timestamp":"2025-12-30T00:30:34.831Z"}
{"parentUuid":"1c1082f6-8284-4b73-af8c-86a29b507a7a","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QTZowJB4YJPJBbhWpBnnnf","type":"tool_result","content":"","is_error":false}]},"uuid":"bd053994-2672-498a-83d2-752edbf15391","timestamp":"2025-12-30T00:30:35.792Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"bd053994-2672-498a-83d2-752edbf15391","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GpJZ8yHjTbAtsQGPQxmeRw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FgD6nAkagQL1Qb3q9XRVzP","name":"Write","input":{"file_path":"/Users/imorgado/SPLICE/splice-website/src/app/api/contact/route.ts","content":"import { NextRequest, NextResponse } from \"next/server\";\n\n// Force Node.js runtime for better compatibility\nexport const runtime = \"nodejs\";\nexport const maxDuration = 30;\n\n// Email configuration\nconst EMAIL_CONFIG = {\n  from: process.env.EMAIL_FROM || \"SPLICE <noreply@splice.video>\",\n  salesEmail: \"sales@splice.app\",\n  sendgridApiKey: process.env.SENDGRID_API_KEY,\n};\n\n// Request body interface\ninterface ContactFormData {\n  name: string;\n  email: string;\n  company?: string;\n  teamSize?: string;\n  message: string;\n}\n\n// Validation helper\nfunction validateEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// Escape HTML to prevent XSS in email content\nfunction escapeHtml(str: string): string {\n  if (str === null || str === undefined) return \"\";\n  const escapeMap: Record<string, string> = {\n    \"&\": \"&amp;\",\n    \"<\": \"&lt;\",\n    \">\": \"&gt;\",\n    '\"': \"&quot;\",\n    \"'\": \"&#x27;\",\n  };\n  return str.replace(/[&<>\"']/g, (char) => escapeMap[char]);\n}\n\n// Generate email HTML template\nfunction generateEmailHtml(data: ContactFormData): string {\n  return `\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>New Contact Form Submission</title>\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; margin: 0; padding: 0; }\n    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; background: white; }\n    .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #00D4FF; }\n    .logo { font-size: 28px; font-weight: bold; color: #00D4FF; }\n    .badge { display: inline-block; background: #00D4FF; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-top: 10px; }\n    .content { padding: 20px 0; }\n    .field { margin-bottom: 20px; }\n    .field-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #6b7280; margin-bottom: 5px; }\n    .field-value { font-size: 16px; color: #1e293b; background: #f8fafc; padding: 12px 16px; border-radius: 8px; border-left: 3px solid #00D4FF; }\n    .message-box { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px; margin-top: 20px; }\n    .message-box h3 { color: #166534; margin-top: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }\n    .message-content { color: #15803d; white-space: pre-wrap; }\n    .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px; }\n    .reply-button { display: inline-block; background: #00D4FF; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin-top: 20px; font-weight: 500; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"logo\">SPLICE</div>\n      <div class=\"badge\">New Contact Form Submission</div>\n    </div>\n\n    <div class=\"content\">\n      <div class=\"field\">\n        <div class=\"field-label\">Name</div>\n        <div class=\"field-value\">${escapeHtml(data.name)}</div>\n      </div>\n\n      <div class=\"field\">\n        <div class=\"field-label\">Email</div>\n        <div class=\"field-value\"><a href=\"mailto:${escapeHtml(data.email)}\" style=\"color: #00A8CC;\">${escapeHtml(data.email)}</a></div>\n      </div>\n\n      ${\n        data.company\n          ? `\n      <div class=\"field\">\n        <div class=\"field-label\">Company</div>\n        <div class=\"field-value\">${escapeHtml(data.company)}</div>\n      </div>\n      `\n          : \"\"\n      }\n\n      ${\n        data.teamSize\n          ? `\n      <div class=\"field\">\n        <div class=\"field-label\">Team Size</div>\n        <div class=\"field-value\">${escapeHtml(data.teamSize)}</div>\n      </div>\n      `\n          : \"\"\n      }\n\n      <div class=\"message-box\">\n        <h3>Message</h3>\n        <div class=\"message-content\">${escapeHtml(data.message)}</div>\n      </div>\n\n      <div style=\"text-align: center;\">\n        <a href=\"mailto:${escapeHtml(data.email)}?subject=Re: SPLICE Contact Form\" class=\"reply-button\">Reply to ${escapeHtml(data.name)}</a>\n      </div>\n    </div>\n\n    <div class=\"footer\">\n      <p>This message was sent from the SPLICE website contact form.</p>\n      <p style=\"font-size: 12px;\">&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n    </div>\n  </div>\n</body>\n</html>\n  `;\n}\n\n// Generate plain text email\nfunction generateEmailText(data: ContactFormData): string {\n  return `\nNew Contact Form Submission - SPLICE\n=====================================\n\nName: ${data.name}\nEmail: ${data.email}\n${data.company ? `Company: ${data.company}` : \"\"}\n${data.teamSize ? `Team Size: ${data.teamSize}` : \"\"}\n\nMessage:\n---------\n${data.message}\n\n---\nThis message was sent from the SPLICE website contact form.\n  `.trim();\n}\n\n// Send email via SendGrid\nasync function sendEmailNotification(data: ContactFormData): Promise<void> {\n  if (!EMAIL_CONFIG.sendgridApiKey) {\n    console.warn(\"[Contact API] SENDGRID_API_KEY not configured, logging email to console\");\n    console.log(\"[Contact API] Would send email to:\", EMAIL_CONFIG.salesEmail);\n    console.log(\"[Contact API] From:\", data.name, `<${data.email}>`);\n    console.log(\"[Contact API] Message:\", data.message);\n    return;\n  }\n\n  const response = await fetch(\"https://api.sendgrid.com/v3/mail/send\", {\n    method: \"POST\",\n    headers: {\n      Authorization: `Bearer ${EMAIL_CONFIG.sendgridApiKey}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      personalizations: [\n        {\n          to: [{ email: EMAIL_CONFIG.salesEmail }],\n        },\n      ],\n      from: {\n        email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || \"noreply@splice.video\",\n        name: \"SPLICE Contact Form\",\n      },\n      reply_to: {\n        email: data.email,\n        name: data.name,\n      },\n      subject: `[SPLICE Contact] New inquiry from ${data.name}${data.company ? ` (${data.company})` : \"\"}`,\n      content: [\n        { type: \"text/plain\", value: generateEmailText(data) },\n        { type: \"text/html\", value: generateEmailHtml(data) },\n      ],\n    }),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    console.error(\"[Contact API] SendGrid error:\", response.status, errorText);\n    throw new Error(`Failed to send email: ${response.status}`);\n  }\n\n  console.log(\"[Contact API] Email sent successfully to\", EMAIL_CONFIG.salesEmail);\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Parse request body\n    let body: ContactFormData;\n    try {\n      body = await request.json();\n    } catch {\n      return NextResponse.json(\n        { error: \"Invalid JSON in request body\" },\n        { status: 400 }\n      );\n    }\n\n    const { name, email, company, teamSize, message } = body;\n\n    // Validate required fields\n    const errors: string[] = [];\n\n    if (!name || typeof name !== \"string\" || name.trim().length === 0) {\n      errors.push(\"Name is required\");\n    }\n\n    if (!email || typeof email !== \"string\" || email.trim().length === 0) {\n      errors.push(\"Email is required\");\n    } else if (!validateEmail(email.trim())) {\n      errors.push(\"Invalid email format\");\n    }\n\n    if (!message || typeof message !== \"string\" || message.trim().length === 0) {\n      errors.push(\"Message is required\");\n    }\n\n    if (errors.length > 0) {\n      return NextResponse.json(\n        { error: \"Validation failed\", details: errors },\n        { status: 400 }\n      );\n    }\n\n    // Sanitize and prepare data\n    const sanitizedData: ContactFormData = {\n      name: name.trim(),\n      email: email.trim().toLowerCase(),\n      company: company?.trim() || undefined,\n      teamSize: teamSize?.trim() || undefined,\n      message: message.trim(),\n    };\n\n    // Send email notification\n    await sendEmailNotification(sanitizedData);\n\n    // Return success response\n    return NextResponse.json({\n      success: true,\n      message: \"Your message has been sent successfully. We will get back to you soon!\",\n    });\n  } catch (error) {\n    console.error(\"[Contact API] Error processing contact form:\", error);\n\n    return NextResponse.json(\n      {\n        error: \"Failed to process your request. Please try again later.\",\n        details: error instanceof Error ? error.message : \"Unknown error\",\n      },\n      { status: 500 }\n    );\n  }\n}\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":332,"cache_read_input_tokens":38193,"cache_creation":{"ephemeral_5m_input_tokens":332,"ephemeral_1h_input_tokens":0},"output_tokens":2830,"service_tier":"standard"}},"requestId":"req_011CWbvmeeqExhHTcnGqUqUy","type":"assistant","uuid":"c916d8d0-47f9-4575-b187-bd4b8835308e","timestamp":"2025-12-30T00:31:17.242Z"}
{"parentUuid":"c916d8d0-47f9-4575-b187-bd4b8835308e","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FgD6nAkagQL1Qb3q9XRVzP","type":"tool_result","content":"File created successfully at: /Users/imorgado/SPLICE/splice-website/src/app/api/contact/route.ts"}]},"uuid":"bec313a9-2a19-44d5-aa09-127a3d7c15f7","timestamp":"2025-12-30T00:31:17.289Z","toolUseResult":{"type":"create","filePath":"/Users/imorgado/SPLICE/splice-website/src/app/api/contact/route.ts","content":"import { NextRequest, NextResponse } from \"next/server\";\n\n// Force Node.js runtime for better compatibility\nexport const runtime = \"nodejs\";\nexport const maxDuration = 30;\n\n// Email configuration\nconst EMAIL_CONFIG = {\n  from: process.env.EMAIL_FROM || \"SPLICE <noreply@splice.video>\",\n  salesEmail: \"sales@splice.app\",\n  sendgridApiKey: process.env.SENDGRID_API_KEY,\n};\n\n// Request body interface\ninterface ContactFormData {\n  name: string;\n  email: string;\n  company?: string;\n  teamSize?: string;\n  message: string;\n}\n\n// Validation helper\nfunction validateEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n// Escape HTML to prevent XSS in email content\nfunction escapeHtml(str: string): string {\n  if (str === null || str === undefined) return \"\";\n  const escapeMap: Record<string, string> = {\n    \"&\": \"&amp;\",\n    \"<\": \"&lt;\",\n    \">\": \"&gt;\",\n    '\"': \"&quot;\",\n    \"'\": \"&#x27;\",\n  };\n  return str.replace(/[&<>\"']/g, (char) => escapeMap[char]);\n}\n\n// Generate email HTML template\nfunction generateEmailHtml(data: ContactFormData): string {\n  return `\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>New Contact Form Submission</title>\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; margin: 0; padding: 0; }\n    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; background: white; }\n    .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #00D4FF; }\n    .logo { font-size: 28px; font-weight: bold; color: #00D4FF; }\n    .badge { display: inline-block; background: #00D4FF; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-top: 10px; }\n    .content { padding: 20px 0; }\n    .field { margin-bottom: 20px; }\n    .field-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #6b7280; margin-bottom: 5px; }\n    .field-value { font-size: 16px; color: #1e293b; background: #f8fafc; padding: 12px 16px; border-radius: 8px; border-left: 3px solid #00D4FF; }\n    .message-box { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px; margin-top: 20px; }\n    .message-box h3 { color: #166534; margin-top: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }\n    .message-content { color: #15803d; white-space: pre-wrap; }\n    .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px; }\n    .reply-button { display: inline-block; background: #00D4FF; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; margin-top: 20px; font-weight: 500; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"logo\">SPLICE</div>\n      <div class=\"badge\">New Contact Form Submission</div>\n    </div>\n\n    <div class=\"content\">\n      <div class=\"field\">\n        <div class=\"field-label\">Name</div>\n        <div class=\"field-value\">${escapeHtml(data.name)}</div>\n      </div>\n\n      <div class=\"field\">\n        <div class=\"field-label\">Email</div>\n        <div class=\"field-value\"><a href=\"mailto:${escapeHtml(data.email)}\" style=\"color: #00A8CC;\">${escapeHtml(data.email)}</a></div>\n      </div>\n\n      ${\n        data.company\n          ? `\n      <div class=\"field\">\n        <div class=\"field-label\">Company</div>\n        <div class=\"field-value\">${escapeHtml(data.company)}</div>\n      </div>\n      `\n          : \"\"\n      }\n\n      ${\n        data.teamSize\n          ? `\n      <div class=\"field\">\n        <div class=\"field-label\">Team Size</div>\n        <div class=\"field-value\">${escapeHtml(data.teamSize)}</div>\n      </div>\n      `\n          : \"\"\n      }\n\n      <div class=\"message-box\">\n        <h3>Message</h3>\n        <div class=\"message-content\">${escapeHtml(data.message)}</div>\n      </div>\n\n      <div style=\"text-align: center;\">\n        <a href=\"mailto:${escapeHtml(data.email)}?subject=Re: SPLICE Contact Form\" class=\"reply-button\">Reply to ${escapeHtml(data.name)}</a>\n      </div>\n    </div>\n\n    <div class=\"footer\">\n      <p>This message was sent from the SPLICE website contact form.</p>\n      <p style=\"font-size: 12px;\">&copy; ${new Date().getFullYear()} SPLICE. All rights reserved.</p>\n    </div>\n  </div>\n</body>\n</html>\n  `;\n}\n\n// Generate plain text email\nfunction generateEmailText(data: ContactFormData): string {\n  return `\nNew Contact Form Submission - SPLICE\n=====================================\n\nName: ${data.name}\nEmail: ${data.email}\n${data.company ? `Company: ${data.company}` : \"\"}\n${data.teamSize ? `Team Size: ${data.teamSize}` : \"\"}\n\nMessage:\n---------\n${data.message}\n\n---\nThis message was sent from the SPLICE website contact form.\n  `.trim();\n}\n\n// Send email via SendGrid\nasync function sendEmailNotification(data: ContactFormData): Promise<void> {\n  if (!EMAIL_CONFIG.sendgridApiKey) {\n    console.warn(\"[Contact API] SENDGRID_API_KEY not configured, logging email to console\");\n    console.log(\"[Contact API] Would send email to:\", EMAIL_CONFIG.salesEmail);\n    console.log(\"[Contact API] From:\", data.name, `<${data.email}>`);\n    console.log(\"[Contact API] Message:\", data.message);\n    return;\n  }\n\n  const response = await fetch(\"https://api.sendgrid.com/v3/mail/send\", {\n    method: \"POST\",\n    headers: {\n      Authorization: `Bearer ${EMAIL_CONFIG.sendgridApiKey}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      personalizations: [\n        {\n          to: [{ email: EMAIL_CONFIG.salesEmail }],\n        },\n      ],\n      from: {\n        email: EMAIL_CONFIG.from.match(/<(.+)>/)?.[1] || \"noreply@splice.video\",\n        name: \"SPLICE Contact Form\",\n      },\n      reply_to: {\n        email: data.email,\n        name: data.name,\n      },\n      subject: `[SPLICE Contact] New inquiry from ${data.name}${data.company ? ` (${data.company})` : \"\"}`,\n      content: [\n        { type: \"text/plain\", value: generateEmailText(data) },\n        { type: \"text/html\", value: generateEmailHtml(data) },\n      ],\n    }),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    console.error(\"[Contact API] SendGrid error:\", response.status, errorText);\n    throw new Error(`Failed to send email: ${response.status}`);\n  }\n\n  console.log(\"[Contact API] Email sent successfully to\", EMAIL_CONFIG.salesEmail);\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Parse request body\n    let body: ContactFormData;\n    try {\n      body = await request.json();\n    } catch {\n      return NextResponse.json(\n        { error: \"Invalid JSON in request body\" },\n        { status: 400 }\n      );\n    }\n\n    const { name, email, company, teamSize, message } = body;\n\n    // Validate required fields\n    const errors: string[] = [];\n\n    if (!name || typeof name !== \"string\" || name.trim().length === 0) {\n      errors.push(\"Name is required\");\n    }\n\n    if (!email || typeof email !== \"string\" || email.trim().length === 0) {\n      errors.push(\"Email is required\");\n    } else if (!validateEmail(email.trim())) {\n      errors.push(\"Invalid email format\");\n    }\n\n    if (!message || typeof message !== \"string\" || message.trim().length === 0) {\n      errors.push(\"Message is required\");\n    }\n\n    if (errors.length > 0) {\n      return NextResponse.json(\n        { error: \"Validation failed\", details: errors },\n        { status: 400 }\n      );\n    }\n\n    // Sanitize and prepare data\n    const sanitizedData: ContactFormData = {\n      name: name.trim(),\n      email: email.trim().toLowerCase(),\n      company: company?.trim() || undefined,\n      teamSize: teamSize?.trim() || undefined,\n      message: message.trim(),\n    };\n\n    // Send email notification\n    await sendEmailNotification(sanitizedData);\n\n    // Return success response\n    return NextResponse.json({\n      success: true,\n      message: \"Your message has been sent successfully. We will get back to you soon!\",\n    });\n  } catch (error) {\n    console.error(\"[Contact API] Error processing contact form:\", error);\n\n    return NextResponse.json(\n      {\n        error: \"Failed to process your request. Please try again later.\",\n        details: error instanceof Error ? error.message : \"Unknown error\",\n      },\n      { status: 500 }\n    );\n  }\n}\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"bec313a9-2a19-44d5-aa09-127a3d7c15f7","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE","sessionId":"5d8dde70-47da-4221-8add-3e18da9f045d","version":"2.0.76","gitBranch":"main","agentId":"a305aa4","slug":"structured-meandering-whisper","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Gk91it863rutgMdeBd75pw","type":"message","role":"assistant","content":[{"type":"text","text":"The contact form API endpoint has been created at `/Users/imorgado/SPLICE/splice-website/src/app/api/contact/route.ts`. Here is a summary of what the file does:\n\n**Endpoint:** `POST /api/contact`\n\n**Features:**\n\n1. **Request Body Validation:**\n   - Accepts JSON with fields: `name`, `email`, `company` (optional), `teamSize` (optional), `message`\n   - Validates required fields (name, email, message)\n   - Validates email format with regex\n   - Returns 400 status with detailed error messages if validation fails\n\n2. **Email Notification:**\n   - Uses SendGrid API directly (consistent with the backend pattern in `emailService.js`)\n   - Sends formatted HTML and plain text versions\n   - Email is sent to `sales@splice.app`\n   - Reply-to is set to the submitter's email for easy follow-up\n   - Subject includes the sender's name and company (if provided)\n\n3. **HTML Email Template:**\n   - Professional styling consistent with other SPLICE emails\n   - Displays all form fields with clear labels\n   - Includes a \"Reply\" button for quick response\n   - Escapes HTML to prevent XSS attacks\n\n4. **Error Handling:**\n   - Graceful fallback if SendGrid API key is not configured (logs to console in development)\n   - Verbose error logging with `[Contact API]` prefix\n   - Returns appropriate HTTP status codes (400 for validation, 500 for server errors)\n\n5. **Next.js App Router Conventions:**\n   - Uses `export async function POST`\n   - Uses `NextRequest` and `NextResponse`\n   - Sets `runtime = \"nodejs\"` and `maxDuration = 30` for better compatibility\n\n**Environment Variable Required:**\n- `SENDGRID_API_KEY` - for sending emails (falls back to console logging if not set)"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":2872,"cache_read_input_tokens":38525,"cache_creation":{"ephemeral_5m_input_tokens":2872,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWbvpi7mnm33zJsLs2K6Z","type":"assistant","uuid":"28d44ab4-bfa1-4305-8066-28140a9d873f","timestamp":"2025-12-30T00:31:28.425Z"}
