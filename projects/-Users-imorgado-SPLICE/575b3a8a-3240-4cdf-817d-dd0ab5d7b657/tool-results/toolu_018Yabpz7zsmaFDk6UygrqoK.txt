     1→/**
     2→ * Text Edit Routes
     3→ *
     4→ * Text-based editing endpoints
     5→ */
     6→
     7→const express = require('express');
     8→
     9→/**
    10→ * Create text edit routes
    11→ * @param {Object} options - Route configuration options
    12→ * @param {Object} options.middleware - Shared middleware (requireCredits)
    13→ * @returns {express.Router}
    14→ */
    15→function createTextEditRoutes(options = {}) {
    16→  const router = express.Router();
    17→  const { requireCredits, requireFeature } = options.middleware || {};
    18→
    19→  /**
    20→   * POST /prepare - Create editable transcript structure
    21→   * Requires: Pro tier or higher (text_editing feature)
    22→   *
    23→   * Converts transcript to editable format with unique word IDs.
    24→   */
    25→  router.post('/prepare', requireCredits({ endpoint: 'text-edit' }), requireFeature('text_editing'), async (req, res) => {
    26→    const { transcript } = req.body;
    27→
    28→    if (!transcript) {
    29→      return res.status(400).json({ error: 'transcript is required' });
    30→    }
    31→
    32→    try {
    33→      const { generateEditableTranscript } = require('../services/textBasedEditing');
    34→      const result = generateEditableTranscript(transcript);
    35→
    36→      if (!result.success) {
    37→        return res.status(400).json({ error: result.error });
    38→      }
    39→
    40→      // Deduct usage
    41→      if (req.deductUsage) {
    42→        await req.deductUsage(0.25); // 0.25 credits
    43→      }
    44→
    45→      res.json(result);
    46→    } catch (err) {
    47→      console.error('[SPLICE] Text-edit prepare error:', err);
    48→      res.status(500).json({ error: err.message });
    49→    }
    50→  });
    51→
    52→  /**
    53→   * POST /apply - Apply text edits and get operations
    54→   * Requires: Pro tier or higher (text_editing feature)
    55→   *
    56→   * Compares original and edited text, returns edit operations.
    57→   */
    58→  router.post('/apply', requireCredits({ endpoint: 'text-edit' }), requireFeature('text_editing'), async (req, res) => {
    59→    const { transcript, editedText } = req.body;
    60→
    61→    if (!transcript) {
    62→      return res.status(400).json({ error: 'transcript is required' });
    63→    }
    64→
    65→    if (typeof editedText !== 'string') {
    66→      return res.status(400).json({ error: 'editedText is required' });
    67→    }
    68→
    69→    try {
    70→      const { applyTextEdits } = require('../services/textBasedEditing');
    71→      const result = applyTextEdits(transcript, editedText);
    72→
    73→      if (!result.success) {
    74→        return res.status(400).json({ error: result.error });
    75→      }
    76→
    77→      // Deduct usage
    78→      if (req.deductUsage) {
    79→        await req.deductUsage(0.5); // 0.5 credits
    80→      }
    81→
    82→      res.json(result);
    83→    } catch (err) {
    84→      console.error('[SPLICE] Text-edit apply error:', err);
    85→      res.status(500).json({ error: err.message });
    86→    }
    87→  });
    88→
    89→  /**
    90→   * POST /search - Search transcript with timestamps
    91→   * Requires: Pro tier or higher (text_editing feature)
    92→   */
    93→  router.post('/search', requireCredits({ endpoint: 'text-edit' }), requireFeature('text_editing'), async (req, res) => {
    94→    const { transcript, searchText } = req.body;
    95→
    96→    if (!transcript) {
    97→      return res.status(400).json({ error: 'transcript is required' });
    98→    }
    99→
   100→    if (!searchText) {
   101→      return res.status(400).json({ error: 'searchText is required' });
   102→    }
   103→
   104→    try {
   105→      const { searchTranscript } = require('../services/textBasedEditing');
   106→      const result = searchTranscript(transcript, searchText);
   107→
   108→      if (!result.success) {
   109→        return res.status(400).json({ error: result.error });
   110→      }
   111→
   112→      // Deduct usage
   113→      if (req.deductUsage) {
   114→        await req.deductUsage(0.1); // 0.1 credits
   115→      }
   116→
   117→      res.json(result);
   118→    } catch (err) {
   119→      console.error('[SPLICE] Text-edit search error:', err);
   120→      res.status(500).json({ error: err.message });
   121→    }
   122→  });
   123→
   124→  /**
   125→   * POST /replace - Search and replace (generates cut operations)
   126→   * Requires: Pro tier or higher (text_editing feature)
   127→   */
   128→  router.post('/replace', requireCredits({ endpoint: 'text-edit' }), requireFeature('text_editing'), async (req, res) => {
   129→    const { transcript, searchText, replaceText = '' } = req.body;
   130→
   131→    if (!transcript) {
   132→      return res.status(400).json({ error: 'transcript is required' });
   133→    }
   134→
   135→    if (!searchText) {
   136→      return res.status(400).json({ error: 'searchText is required' });
   137→    }
   138→
   139→    try {
   140→      const { searchAndReplace } = require('../services/textBasedEditing');
   141→      const result = searchAndReplace(transcript, searchText, replaceText);
   142→
   143→      if (!result.success) {
   144→        return res.status(400).json({ error: result.error });
   145→      }
   146→
   147→      // Deduct usage
   148→      if (req.deductUsage) {
   149→        await req.deductUsage(0.25); // 0.25 credits
   150→      }
   151→
   152→      res.json(result);
   153→    } catch (err) {
   154→      console.error('[SPLICE] Text-edit replace error:', err);
   155→      res.status(500).json({ error: err.message });
   156→    }
   157→  });
   158→
   159→  /**
   160→   * POST /preview - Preview edits without applying
   161→   * Requires: Pro tier or higher (text_editing feature)
   162→   */
   163→  router.post('/preview', requireCredits({ endpoint: 'text-edit' }), requireFeature('text_editing'), async (req, res) => {
   164→    const { transcript, editedText } = req.body;
   165→
   166→    if (!transcript) {
   167→      return res.status(400).json({ error: 'transcript is required' });
   168→    }
   169→
   170→    if (typeof editedText !== 'string') {
   171→      return res.status(400).json({ error: 'editedText is required' });
   172→    }
   173→
   174→    try {
   175→      const { previewEdits } = require('../services/textBasedEditing');
   176→      const result = previewEdits(transcript, editedText);
   177→
   178→      if (!result.success) {
   179→        return res.status(400).json({ error: result.error });
   180→      }
   181→
   182→      // Deduct usage (small amount for preview)
   183→      if (req.deductUsage) {
   184→        await req.deductUsage(0.1); // 0.1 credits
   185→      }
   186→
   187→      res.json(result);
   188→    } catch (err) {
   189→      console.error('[SPLICE] Text-edit preview error:', err);
   190→      res.status(500).json({ error: err.message });
   191→    }
   192→  });
   193→
   194→  /**
   195→   * POST /cut-list - Generate cut list from edit operations
   196→   * Requires: Pro tier or higher (text_editing feature)
   197→   */
   198→  router.post('/cut-list', requireCredits({ endpoint: 'text-edit' }), requireFeature('text_editing'), async (req, res) => {
   199→    const { operations, sourceInfo = {} } = req.body;
   200→
   201→    if (!operations || !Array.isArray(operations)) {
   202→      return res.status(400).json({ error: 'operations array is required' });
   203→    }
   204→
   205→    try {
   206→      const { generateEditCutList } = require('../services/textBasedEditing');
   207→      const result = generateEditCutList(operations, sourceInfo);
   208→
   209→      if (!result.success) {
   210→        return res.status(400).json({ error: result.error });
   211→      }
   212→
   213→      // Deduct usage
   214→      if (req.deductUsage) {
   215→        await req.deductUsage(0.25); // 0.25 credits
   216→      }
   217→
   218→      res.json(result);
   219→    } catch (err) {
   220→      console.error('[SPLICE] Text-edit cut-list error:', err);
   221→      res.status(500).json({ error: err.message });
   222→    }
   223→  });
   224→
   225→  return router;
   226→}
   227→
   228→module.exports = createTextEditRoutes;
   229→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
