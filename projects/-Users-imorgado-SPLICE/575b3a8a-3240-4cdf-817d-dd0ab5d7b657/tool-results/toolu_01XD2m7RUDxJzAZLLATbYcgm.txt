     1→/**
     2→ * Reframe Routes
     3→ *
     4→ * Social reframe and face detection endpoints
     5→ */
     6→
     7→const express = require('express');
     8→
     9→/**
    10→ * Create reframe routes
    11→ * @param {Object} options - Route configuration options
    12→ * @param {Object} options.middleware - Shared middleware (requireCredits)
    13→ * @returns {express.Router}
    14→ */
    15→function createReframeRoutes(options = {}) {
    16→  const router = express.Router();
    17→  const { requireCredits, requireFeature } = options.middleware || {};
    18→
    19→  /**
    20→   * POST /analyze - Analyze video for reframe with face tracking
    21→   * Requires: Pro tier or higher (social_reframe feature)
    22→   */
    23→  router.post('/analyze', requireCredits({ endpoint: 'reframe' }), requireFeature('social_reframe'), async (req, res) => {
    24→    const { videoPath, options: analyzeOptions = {} } = req.body;
    25→
    26→    if (!videoPath) {
    27→      return res.status(400).json({ error: 'videoPath is required' });
    28→    }
    29→
    30→    try {
    31→      const { analyzeForReframe } = require('../services/socialReframe');
    32→      const result = await analyzeForReframe(videoPath, analyzeOptions);
    33→
    34→      if (!result.success) {
    35→        return res.status(400).json({ error: result.error });
    36→      }
    37→
    38→      // Deduct usage
    39→      if (req.deductUsage) {
    40→        await req.deductUsage(1.0); // 1 credit for analysis
    41→      }
    42→
    43→      res.json(result);
    44→    } catch (err) {
    45→      console.error('[SPLICE] Reframe analyze error:', err);
    46→      res.status(500).json({ error: err.message });
    47→    }
    48→  });
    49→
    50→  /**
    51→   * POST /calculate - Calculate crop positions for aspect ratio
    52→   * Requires: Pro tier or higher (social_reframe feature)
    53→   */
    54→  router.post('/calculate', requireCredits({ endpoint: 'reframe' }), requireFeature('social_reframe'), async (req, res) => {
    55→    const { tracking, targetAspect } = req.body;
    56→
    57→    if (!tracking) {
    58→      return res.status(400).json({ error: 'tracking data is required' });
    59→    }
    60→
    61→    if (!targetAspect) {
    62→      return res.status(400).json({ error: 'targetAspect is required' });
    63→    }
    64→
    65→    try {
    66→      const { calculateReframeCrops } = require('../services/socialReframe');
    67→      const result = calculateReframeCrops(tracking, targetAspect);
    68→
    69→      // Deduct usage
    70→      if (req.deductUsage) {
    71→        await req.deductUsage(0.25); // 0.25 credits
    72→      }
    73→
    74→      res.json({ success: true, crops: result });
    75→    } catch (err) {
    76→      console.error('[SPLICE] Reframe calculate error:', err);
    77→      res.status(500).json({ error: err.message });
    78→    }
    79→  });
    80→
    81→  /**
    82→   * POST /motion-path - Generate smooth motion path
    83→   * Requires: Pro tier or higher (social_reframe feature)
    84→   */
    85→  router.post('/motion-path', requireCredits({ endpoint: 'reframe' }), requireFeature('social_reframe'), async (req, res) => {
    86→    const { crops, duration, frameRate } = req.body;
    87→
    88→    if (!crops || !Array.isArray(crops)) {
    89→      return res.status(400).json({ error: 'crops array is required' });
    90→    }
    91→
    92→    if (!duration || !frameRate) {
    93→      return res.status(400).json({ error: 'duration and frameRate are required' });
    94→    }
    95→
    96→    try {
    97→      const { generateMotionPath } = require('../services/socialReframe');
    98→      const result = generateMotionPath(crops, duration, frameRate);
    99→
   100→      if (!result.success) {
   101→        return res.status(400).json({ error: result.error });
   102→      }
   103→
   104→      // Deduct usage
   105→      if (req.deductUsage) {
   106→        await req.deductUsage(0.25); // 0.25 credits
   107→      }
   108→
   109→      res.json(result);
   110→    } catch (err) {
   111→      console.error('[SPLICE] Reframe motion-path error:', err);
   112→      res.status(500).json({ error: err.message });
   113→    }
   114→  });
   115→
   116→  /**
   117→   * POST /export - Batch export all formats
   118→   * Requires: Pro tier or higher (social_reframe feature)
   119→   */
   120→  router.post('/export', requireCredits({ endpoint: 'reframe' }), requireFeature('social_reframe'), async (req, res) => {
   121→    const { videoPath, formats = ['portrait', 'square'], settings = {} } = req.body;
   122→
   123→    if (!videoPath) {
   124→      return res.status(400).json({ error: 'videoPath is required' });
   125→    }
   126→
   127→    try {
   128→      const { batchExportFormats } = require('../services/socialReframe');
   129→      const result = await batchExportFormats(videoPath, formats, settings);
   130→
   131→      if (!result.success) {
   132→        return res.status(400).json({ error: result.error });
   133→      }
   134→
   135→      // Deduct usage per format
   136→      if (req.deductUsage) {
   137→        await req.deductUsage(0.5 * formats.length);
   138→      }
   139→
   140→      res.json(result);
   141→    } catch (err) {
   142→      console.error('[SPLICE] Reframe export error:', err);
   143→      res.status(500).json({ error: err.message });
   144→    }
   145→  });
   146→
   147→  /**
   148→   * GET /platforms - Get available platforms and aspect ratios
   149→   */
   150→  router.get('/platforms', (req, res) => {
   151→    const { getPlatformPresets } = require('../services/socialReframe');
   152→    res.json(getPlatformPresets());
   153→  });
   154→
   155→  /**
   156→   * GET /safe-zones/:platform - Get safe zones for platform
   157→   */
   158→  router.get('/safe-zones/:platform', (req, res) => {
   159→    const { getSafeZones } = require('../services/socialReframe');
   160→    const result = getSafeZones(req.params.platform);
   161→
   162→    if (!result.success) {
   163→      return res.status(404).json(result);
   164→    }
   165→
   166→    res.json(result);
   167→  });
   168→
   169→  return router;
   170→}
   171→
   172→/**
   173→ * Create faces router (separate router for /faces prefix)
   174→ * @param {Object} options - Route configuration options
   175→ * @returns {express.Router}
   176→ */
   177→function createFacesRouter(options = {}) {
   178→  const router = express.Router();
   179→  const { requireCredits, requireFeature } = options.middleware || {};
   180→
   181→  /**
   182→   * POST /detect - Detect faces in video
   183→   * Requires: Pro tier or higher (social_reframe feature)
   184→   */
   185→  router.post('/detect', requireCredits({ endpoint: 'reframe' }), requireFeature('social_reframe'), async (req, res) => {
   186→    const { videoPath, options: detectOptions = {} } = req.body;
   187→
   188→    if (!videoPath) {
   189→      return res.status(400).json({ error: 'videoPath is required' });
   190→    }
   191→
   192→    try {
   193→      const { detectFaces } = require('../services/faceDetection');
   194→      const result = await detectFaces(videoPath, detectOptions);
   195→
   196→      if (!result.success) {
   197→        return res.status(400).json({ error: result.error });
   198→      }
   199→
   200→      // Deduct usage
   201→      if (req.deductUsage) {
   202→        await req.deductUsage(0.5); // 0.5 credits
   203→      }
   204→
   205→      res.json(result);
   206→    } catch (err) {
   207→      console.error('[SPLICE] Face detect error:', err);
   208→      res.status(500).json({ error: err.message });
   209→    }
   210→  });
   211→
   212→  /**
   213→   * POST /track - Track faces throughout video
   214→   * Requires: Pro tier or higher (social_reframe feature)
   215→   */
   216→  router.post('/track', requireCredits({ endpoint: 'reframe' }), requireFeature('social_reframe'), async (req, res) => {
   217→    const { videoPath, options: trackOptions = {} } = req.body;
   218→
   219→    if (!videoPath) {
   220→      return res.status(400).json({ error: 'videoPath is required' });
   221→    }
   222→
   223→    try {
   224→      const { trackFaces } = require('../services/faceDetection');
   225→      const result = await trackFaces(videoPath, trackOptions);
   226→
   227→      if (!result.success) {
   228→        return res.status(400).json({ error: result.error });
   229→      }
   230→
   231→      // Deduct usage
   232→      if (req.deductUsage) {
   233→        await req.deductUsage(1.0); // 1 credit for tracking
   234→      }
   235→
   236→      res.json(result);
   237→    } catch (err) {
   238→      console.error('[SPLICE] Face track error:', err);
   239→      res.status(500).json({ error: err.message });
   240→    }
   241→  });
   242→
   243→  /**
   244→   * POST /identify-speaker - Identify primary speaker
   245→   * Requires: Pro tier or higher (social_reframe feature)
   246→   */
   247→  router.post('/identify-speaker', requireCredits({ endpoint: 'reframe' }), requireFeature('social_reframe'), async (req, res) => {
   248→    const { faces, audioAnalysis = null } = req.body;
   249→
   250→    if (!faces || !Array.isArray(faces)) {
   251→      return res.status(400).json({ error: 'faces array is required' });
   252→    }
   253→
   254→    try {
   255→      const { identifySpeaker } = require('../services/faceDetection');
   256→      const result = identifySpeaker(faces, audioAnalysis);
   257→
   258→      // Deduct usage for speaker identification
   259→      if (req.deductUsage) {
   260→        await req.deductUsage(0.1); // 0.1 credits for speaker identification
   261→      }
   262→
   263→      res.json(result);
   264→    } catch (err) {
   265→      console.error('[SPLICE] Identify speaker error:', err);
   266→      res.status(500).json({ error: err.message });
   267→    }
   268→  });
   269→
   270→  return router;
   271→}
   272→
   273→// Attach facesRouter factory to main export
   274→createReframeRoutes.facesRouter = createFacesRouter;
   275→
   276→module.exports = createReframeRoutes;
   277→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
