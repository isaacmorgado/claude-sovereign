     1â†’/**
     2â†’ * SPLICE CEP Panel - Main Entry Point
     3â†’ * v4.0.0 - CEP Migration
     4â†’ */
     5â†’
     6â†’// ============================================================================
     7â†’// CACHED DOM ELEMENTS
     8â†’// ============================================================================
     9â†’const ui = {};
    10â†’
    11â†’function cacheUIElements() {
    12â†’    ui.status = document.getElementById('status');
    13â†’    ui.goBtn = document.getElementById('goBtn');
    14â†’    ui.optionsToggle = document.getElementById('optionsToggle');
    15â†’    ui.optionsPanel = document.getElementById('optionsPanel');
    16â†’
    17â†’    // Sliders and options
    18â†’    ui.sensitivitySlider = document.getElementById('sensitivitySlider');
    19â†’    ui.sensitivityValue = document.getElementById('sensitivityValue');
    20â†’    ui.sourceOriginal = document.getElementById('sourceOriginal');
    21â†’    ui.sourceIsolated = document.getElementById('sourceIsolated');
    22â†’
    23â†’    // Feature toggles
    24â†’    ui.enableTakesDetection = document.getElementById('enableTakesDetection');
    25â†’    ui.enableJCut = document.getElementById('enableJCut');
    26â†’    ui.jcutSettings = document.getElementById('jcutSettings');
    27â†’    ui.jcutLeadIn = document.getElementById('jcutLeadIn');
    28â†’    ui.jcutLeadInValue = document.getElementById('jcutLeadInValue');
    29â†’    ui.jcutLeadOut = document.getElementById('jcutLeadOut');
    30â†’    ui.jcutLeadOutValue = document.getElementById('jcutLeadOutValue');
    31â†’
    32â†’    // Zoom settings
    33â†’    ui.enableZoom = document.getElementById('enableZoom');
    34â†’    ui.zoomSettings = document.getElementById('zoomSettings');
    35â†’    ui.zoomFrequency = document.getElementById('zoomFrequency');
    36â†’    ui.zoomPreset = document.getElementById('zoomPreset');
    37â†’    ui.zoomPlacement = document.getElementById('zoomPlacement');
    38â†’
    39â†’    // Chapter settings
    40â†’    ui.enableChapters = document.getElementById('enableChapters');
    41â†’    ui.chapterSettings = document.getElementById('chapterSettings');
    42â†’    ui.maxChapters = document.getElementById('maxChapters');
    43â†’    ui.minChapterLength = document.getElementById('minChapterLength');
    44â†’
    45â†’    // Profanity settings
    46â†’    ui.enableProfanity = document.getElementById('enableProfanity');
    47â†’    ui.profanitySettings = document.getElementById('profanitySettings');
    48â†’
    49â†’    // Filler word settings
    50â†’    ui.enableFillerDetection = document.getElementById('enableFillerDetection');
    51â†’    ui.fillerSettings = document.getElementById('fillerSettings');
    52â†’
    53â†’    // Progress
    54â†’    ui.progressContainer = document.getElementById('progressContainer');
    55â†’    ui.progressBar = document.getElementById('progressBar');
    56â†’    ui.progressText = document.getElementById('progressText');
    57â†’    ui.resultsEmpty = document.getElementById('resultsEmpty');
    58â†’
    59â†’    // Preview
    60â†’    ui.combinedPreview = document.getElementById('combinedPreview');
    61â†’    ui.previewList = document.getElementById('previewList');
    62â†’    ui.silenceCount = document.getElementById('silenceCount');
    63â†’    ui.takeCount = document.getElementById('takeCount');
    64â†’    ui.selectedCount = document.getElementById('selectedCount');
    65â†’    ui.selectAllSilences = document.getElementById('selectAllSilences');
    66â†’    ui.applyPreviewBtn = document.getElementById('applyPreviewBtn');
    67â†’    ui.cancelPreviewBtn = document.getElementById('cancelPreviewBtn');
    68â†’    ui.buildSequenceBtn = document.getElementById('buildSequenceBtn');
    69â†’
    70â†’    // Results
    71â†’    ui.zoomResults = document.getElementById('zoomResults');
    72â†’    ui.zoomList = document.getElementById('zoomList');
    73â†’    ui.chapterResults = document.getElementById('chapterResults');
    74â†’    ui.chapterList = document.getElementById('chapterList');
    75â†’    ui.copyYouTubeBtn = document.getElementById('copyYouTubeBtn');
    76â†’    ui.addChapterMarkersBtn = document.getElementById('addChapterMarkersBtn');
    77â†’
    78â†’    // Modals
    79â†’    ui.settingsBtn = document.getElementById('settingsBtn');
    80â†’    ui.settingsModal = document.getElementById('settingsModal');
    81â†’    ui.closeSettingsBtn = document.getElementById('closeSettingsBtn');
    82â†’    ui.loginModal = document.getElementById('loginModal');
    83â†’    ui.closeLoginBtn = document.getElementById('closeLoginBtn');
    84â†’    ui.licenseKeyInput = document.getElementById('licenseKeyInput');
    85â†’    ui.saveLoginBtn = document.getElementById('saveLoginBtn');
    86â†’
    87â†’    // Credit badge
    88â†’    ui.creditBadge = document.getElementById('creditBadge');
    89â†’
    90â†’    // Preset selector
    91â†’    ui.presetSelector = document.getElementById('presetSelector');
    92â†’}
    93â†’
    94â†’// ============================================================================
    95â†’// STATE MANAGEMENT
    96â†’// ============================================================================
    97â†’let previewSilences = [];
    98â†’let previewTakes = [];
    99â†’let currentChapters = [];
   100â†’let currentZooms = [];
   101â†’let currentProfanity = [];
   102â†’let selectedSilenceIndices = new Set();
   103â†’let isOperationInProgress = false;
   104â†’let lastDetectionResult = null;
   105â†’let currentAudioPath = null;
   106â†’let currentSequenceInfo = null;
   107â†’let currentTranscript = null;
   108â†’
   109â†’// Global state for captions/reframe modules
   110â†’window.spliceState = {
   111â†’    lastTranscript: null,
   112â†’    currentVideoPath: null,
   113â†’    activeSequence: null,
   114â†’    audioPath: null
   115â†’};
   116â†’
   117â†’// Also expose transcript globally for music module
   118â†’window.currentTranscript = null;
   119â†’
   120â†’// ============================================================================
   121â†’// INITIALIZATION
   122â†’// ============================================================================
   123â†’document.addEventListener('DOMContentLoaded', async () => {
   124â†’    // Premium Loading Experience
   125â†’    setTimeout(() => {
   126â†’        const loader = document.getElementById('loading-overlay');
   127â†’        if (loader) loader.classList.add('hidden');
   128â†’    }, 800); // Small delay for smooth perception
   129â†’    console.log('[SPLICE] Initializing CEP panel...');
   130â†’
   131â†’    // Debug: Show init started
   132â†’    const statusEl = document.getElementById('status');
   133â†’    if (statusEl) statusEl.textContent = 'Initializing...';
   134â†’
   135â†’    // Cache DOM elements
   136â†’    cacheUIElements();
   137â†’
   138â†’    // Load settings
   139â†’    loadSettingsToUI();
   140â†’
   141â†’    // Initialize UI handlers
   142â†’    initOptionsToggle();
   143â†’    initSliders();
   144â†’    initFeatureToggles();
   145â†’    initPresetSelector();
   146â†’    initGoButton();
   147â†’    initPreviewHandlers();
   148â†’    initModals();
   149â†’    initCredits();
   150â†’    initHelpButton();
   151â†’
   152â†’    // Initialize offline detection
   153â†’    if (typeof initOfflineDetection === 'function') {
   154â†’        initOfflineDetection();
   155â†’    }
   156â†’
   157â†’    // Initialize multitrack UI
   158â†’    if (typeof initMultitrackUI === 'function') {
   159â†’        initMultitrackUI();
   160â†’    }
   161â†’
   162â†’    // Initialize animated captions UI
   163â†’    if (typeof initAnimatedCaptions === 'function') {
   164â†’        initAnimatedCaptions();
   165â†’    }
   166â†’
   167â†’    // Initialize text editor UI
   168â†’    if (typeof initTextEditor === 'function') {
   169â†’        initTextEditor();
   170â†’    }
   171â†’
   172â†’    // Initialize text editor section toggle
   173â†’    initTextEditorToggle();
   174â†’
   175â†’    // Initialize social reframe UI
   176â†’    if (typeof initSocialReframe === 'function') {
   177â†’        initSocialReframe();
   178â†’    }
   179â†’
   180â†’    // Initialize social reframe section toggle
   181â†’    initSocialReframeToggle();
   182â†’
   183â†’    // Initialize music UI
   184â†’    if (typeof initMusicModule === 'function') {
   185â†’        initMusicModule();
   186â†’    }
   187â†’
   188â†’    // Initialize music section toggle
   189â†’    initMusicToggle();
   190â†’
   191â†’    // Check JSX connection
   192â†’    await checkJSXConnection();
   193â†’
   194â†’    setStatus('Ready');
   195â†’    console.log('[SPLICE] CEP panel initialized');
   196â†’});
   197â†’
   198â†’// ============================================================================
   199â†’// JSX CONNECTION CHECK
   200â†’// ============================================================================
   201â†’async function checkJSXConnection() {
   202â†’    try {
   203â†’        const result = await jsx.call('getVersion');
   204â†’        console.log('[SPLICE] JSX connection OK, version:', result);
   205â†’        return true;
   206â†’    } catch (e) {
   207â†’        console.warn('[SPLICE] JSX connection failed:', e.message);
   208â†’        setStatus('Premiere Pro connection failed', true);
   209â†’        return false;
   210â†’    }
   211â†’}
   212â†’
   213â†’async function checkSequenceOpen() {
   214â†’    try {
   215â†’        const result = await jsx.call('checkSequenceOpen');
   216â†’        return result === true || result === 'true';
   217â†’    } catch {
   218â†’        return false;
   219â†’    }
   220â†’}
   221â†’
   222â†’// ============================================================================
   223â†’// OPTIONS TOGGLE
   224â†’// ============================================================================
   225â†’function initOptionsToggle() {
   226â†’    console.log('[SPLICE] initOptionsToggle - toggle:', !!ui.optionsToggle, 'panel:', !!ui.optionsPanel);
   227â†’    if (ui.optionsToggle && ui.optionsPanel) {
   228â†’        ui.optionsToggle.addEventListener('click', () => {
   229â†’            console.log('[SPLICE] Options toggle clicked');
   230â†’            // Check current state BEFORE toggling
   231â†’            const wasCollapsed = ui.optionsPanel.classList.contains('collapsed');
   232â†’            ui.optionsPanel.classList.toggle('collapsed');
   233â†’            // If it was collapsed, it's now expanded (show 'expanded' class)
   234â†’            ui.optionsToggle.classList.toggle('expanded', wasCollapsed);
   235â†’            saveSettings({ expandedOptions: wasCollapsed });
   236â†’        });
   237â†’
   238â†’        // Restore state
   239â†’        const settings = getSettings();
   240â†’        if (!settings.expandedOptions) {
   241â†’            ui.optionsPanel.classList.add('collapsed');
   242â†’            ui.optionsToggle.classList.remove('expanded');
   243â†’        } else {
   244â†’            ui.optionsToggle.classList.add('expanded');
   245â†’            ui.optionsPanel.classList.remove('collapsed');
   246â†’        }
   247â†’    }
   248â†’}
   249â†’
   250â†’// ============================================================================
   251â†’// TEXT EDITOR TOGGLE
   252â†’// ============================================================================
   253â†’function initTextEditorToggle() {
   254â†’    const toggle = document.getElementById('textEditorToggle');
   255â†’    const panel = document.getElementById('text-editor-panel');
   256â†’    console.log('[SPLICE] initTextEditorToggle - toggle:', !!toggle, 'panel:', !!panel);
   257â†’
   258â†’    if (toggle && panel) {
   259â†’        toggle.addEventListener('click', (e) => {
   260â†’            e.preventDefault();
   261â†’            e.stopPropagation();
   262â†’            console.log('[SPLICE] Text Editor toggle clicked');
   263â†’            setStatus('Text Editor: ' + (panel.classList.contains('collapsed') ? 'Opening' : 'Closing'));
   264â†’            // Check state BEFORE toggling
   265â†’            const wasCollapsed = panel.classList.contains('collapsed');
   266â†’            panel.classList.toggle('collapsed');
   267â†’            const icon = toggle.querySelector('.toggle-icon');
   268â†’            console.log('[SPLICE] wasCollapsed:', wasCollapsed, 'icon:', !!icon);
   269â†’            if (icon) {
   270â†’                // If it was collapsed, it's now expanded (show -)
   271â†’                icon.textContent = wasCollapsed ? '-' : '+';
   272â†’            }
   273â†’        });
   274â†’    } else {
   275â†’        console.error('[SPLICE] Text Editor toggle elements not found!');
   276â†’    }
   277â†’}
   278â†’
   279â†’// ============================================================================
   280â†’// SOCIAL REFRAME TOGGLE
   281â†’// ============================================================================
   282â†’function initSocialReframeToggle() {
   283â†’    const toggle = document.getElementById('socialReframeToggle');
   284â†’    const panel = document.getElementById('social-reframe-panel');
   285â†’    console.log('[SPLICE] initSocialReframeToggle - toggle:', !!toggle, 'panel:', !!panel);
   286â†’
   287â†’    if (toggle && panel) {
   288â†’        toggle.addEventListener('click', () => {
   289â†’            console.log('[SPLICE] Social Reframe toggle clicked');
   290â†’            // Check state BEFORE toggling
   291â†’            const wasCollapsed = panel.classList.contains('collapsed');
   292â†’            panel.classList.toggle('collapsed');
   293â†’            const icon = toggle.querySelector('.toggle-icon');
   294â†’            if (icon) {
   295â†’                // If it was collapsed, it's now expanded (show -)
   296â†’                icon.textContent = wasCollapsed ? '-' : '+';
   297â†’            }
   298â†’        });
   299â†’    } else {
   300â†’        console.error('[SPLICE] Social Reframe toggle elements not found!');
   301â†’    }
   302â†’}
   303â†’
   304â†’// ============================================================================
   305â†’// MUSIC TOGGLE
   306â†’// ============================================================================
   307â†’function initMusicToggle() {
   308â†’    const toggle = document.getElementById('musicToggle');
   309â†’    const panel = document.getElementById('music-panel');
   310â†’    console.log('[SPLICE] initMusicToggle - toggle:', !!toggle, 'panel:', !!panel);
   311â†’
   312â†’    if (toggle && panel) {
   313â†’        toggle.addEventListener('click', () => {
   314â†’            console.log('[SPLICE] Music toggle clicked');
   315â†’            // Check state BEFORE toggling
   316â†’            const wasCollapsed = panel.classList.contains('collapsed');
   317â†’            panel.classList.toggle('collapsed');
   318â†’            const icon = toggle.querySelector('.toggle-icon');
   319â†’            if (icon) {
   320â†’                // If it was collapsed, it's now expanded (show -)
   321â†’                icon.textContent = wasCollapsed ? '-' : '+';
   322â†’            }
   323â†’        });
   324â†’    } else {
   325â†’        console.error('[SPLICE] Music toggle elements not found!');
   326â†’    }
   327â†’}
   328â†’
   329â†’// ============================================================================
   330â†’// SLIDERS
   331â†’// ============================================================================
   332â†’function initSliders() {
   333â†’    // Sensitivity slider
   334â†’    if (ui.sensitivitySlider && ui.sensitivityValue) {
   335â†’        ui.sensitivitySlider.addEventListener('input', () => {
   336â†’            ui.sensitivityValue.textContent = ui.sensitivitySlider.value;
   337â†’            saveSettings({ sensitivity: parseInt(ui.sensitivitySlider.value) });
   338â†’        });
   339â†’    }
   340â†’
   341â†’    // J-Cut sliders
   342â†’    if (ui.jcutLeadIn && ui.jcutLeadInValue) {
   343â†’        ui.jcutLeadIn.addEventListener('input', () => {
   344â†’            const val = (ui.jcutLeadIn.value / 100).toFixed(2);
   345â†’            ui.jcutLeadInValue.textContent = val + 's';
   346â†’            saveSettings({ jcutLeadIn: parseFloat(val) });
   347â†’        });
   348â†’    }
   349â†’
   350â†’    if (ui.jcutLeadOut && ui.jcutLeadOutValue) {
   351â†’        ui.jcutLeadOut.addEventListener('input', () => {
   352â†’            const val = (ui.jcutLeadOut.value / 100).toFixed(2);
   353â†’            ui.jcutLeadOutValue.textContent = val + 's';
   354â†’            saveSettings({ jcutLeadOut: parseFloat(val) });
   355â†’        });
   356â†’    }
   357â†’}
   358â†’
   359â†’// ============================================================================
   360â†’// FEATURE TOGGLES
   361â†’// ============================================================================
   362â†’function initFeatureToggles() {
   363â†’    // J-Cut toggle
   364â†’    if (ui.enableJCut && ui.jcutSettings) {
   365â†’        ui.enableJCut.addEventListener('change', () => {
   366â†’            ui.jcutSettings.classList.toggle('collapsed', !ui.enableJCut.checked);
   367â†’            saveSettings({ enableJCut: ui.enableJCut.checked });
   368â†’        });
   369â†’    }
   370â†’
   371â†’    // Zoom toggle
   372â†’    if (ui.enableZoom && ui.zoomSettings) {
   373â†’        ui.enableZoom.addEventListener('change', () => {
   374â†’            ui.zoomSettings.classList.toggle('collapsed', !ui.enableZoom.checked);
   375â†’            saveSettings({ enableZoom: ui.enableZoom.checked });
   376â†’        });
   377â†’    }
   378â†’
   379â†’    // Chapters toggle
   380â†’    if (ui.enableChapters && ui.chapterSettings) {
   381â†’        ui.enableChapters.addEventListener('change', () => {
   382â†’            ui.chapterSettings.classList.toggle('collapsed', !ui.enableChapters.checked);
   383â†’            saveSettings({ enableChapters: ui.enableChapters.checked });
   384â†’        });
   385â†’    }
   386â†’
   387â†’    // Takes detection toggle
   388â†’    if (ui.enableTakesDetection) {
   389â†’        ui.enableTakesDetection.addEventListener('change', () => {
   390â†’            saveSettings({ enableTakesDetection: ui.enableTakesDetection.checked });
   391â†’        });
   392â†’    }
   393â†’
   394â†’    // Profanity detection toggle
   395â†’    if (ui.enableProfanity && ui.profanitySettings) {
   396â†’        ui.enableProfanity.addEventListener('change', () => {
   397â†’            ui.profanitySettings.classList.toggle('collapsed', !ui.enableProfanity.checked);
   398â†’            saveSettings({ enableProfanity: ui.enableProfanity.checked });
   399â†’        });
   400â†’    }
   401â†’
   402â†’    // Filler word detection toggle
   403â†’    if (ui.enableFillerDetection && ui.fillerSettings) {
   404â†’        ui.enableFillerDetection.addEventListener('change', () => {
   405â†’            ui.fillerSettings.classList.toggle('collapsed', !ui.enableFillerDetection.checked);
   406â†’            saveSettings({ enableFillerDetection: ui.enableFillerDetection.checked });
   407â†’        });
   408â†’    }
   409â†’}
   410â†’
   411â†’// ============================================================================
   412â†’// PRESET SELECTOR
   413â†’// ============================================================================
   414â†’// PRESETS is defined in config.js
   415â†’
   416â†’function initPresetSelector() {
   417â†’    if (!ui.presetSelector) return;
   418â†’
   419â†’    ui.presetSelector.addEventListener('change', () => {
   420â†’        const presetId = ui.presetSelector.value;
   421â†’        applyPreset(presetId);
   422â†’    });
   423â†’
   424â†’    // Load current preset
   425â†’    const settings = getSettings();
   426â†’    if (settings.activePreset) {
   427â†’        ui.presetSelector.value = settings.activePreset;
   428â†’    }
   429â†’}
   430â†’
   431â†’function applyPreset(presetId) {
   432â†’    const preset = PRESETS[presetId];
   433â†’    if (!preset) return;
   434â†’
   435â†’    // Custom preset - keep current settings
   436â†’    if (presetId === 'custom' || !preset.settings) {
   437â†’        saveSettings({ activePreset: 'custom' });
   438â†’        setStatus('Using custom settings');
   439â†’        return;
   440â†’    }
   441â†’
   442â†’    const settings = preset.settings;
   443â†’
   444â†’    // Apply to UI
   445â†’    if (ui.sensitivitySlider && settings.sensitivity !== undefined) {
   446â†’        ui.sensitivitySlider.value = settings.sensitivity;
   447â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = settings.sensitivity;
   448â†’    }
   449â†’
   450â†’    if (ui.enableJCut) {
   451â†’        ui.enableJCut.checked = settings.enableJCut || false;
   452â†’        if (ui.jcutSettings) {
   453â†’            ui.jcutSettings.classList.toggle('collapsed', !settings.enableJCut);
   454â†’        }
   455â†’    }
   456â†’
   457â†’    if (settings.jCutLeadIn !== undefined && ui.jcutLeadIn) {
   458â†’        ui.jcutLeadIn.value = Math.round(settings.jCutLeadIn * 100);
   459â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = settings.jCutLeadIn + 's';
   460â†’    }
   461â†’
   462â†’    if (settings.jCutLeadOut !== undefined && ui.jcutLeadOut) {
   463â†’        ui.jcutLeadOut.value = Math.round(settings.jCutLeadOut * 100);
   464â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = settings.jCutLeadOut + 's';
   465â†’    }
   466â†’
   467â†’    // Save merged settings
   468â†’    saveSettings({
   469â†’        activePreset: presetId,
   470â†’        sensitivity: settings.sensitivity,
   471â†’        threshold: settings.threshold,
   472â†’        minSilenceLength: settings.minSilenceLength,
   473â†’        paddingStart: settings.paddingStart,
   474â†’        paddingEnd: settings.paddingEnd,
   475â†’        enableTakesDetection: settings.enableTakesDetection,
   476â†’        enableJCut: settings.enableJCut || false,
   477â†’        jcutLeadIn: settings.jCutLeadIn || 0.3,
   478â†’        jcutLeadOut: settings.jCutLeadOut || 0.2
   479â†’    });
   480â†’
   481â†’    setStatus(`Applied ${preset.name} preset`);
   482â†’}
   483â†’
   484â†’// ============================================================================
   485â†’// LOAD SETTINGS TO UI
   486â†’// ============================================================================
   487â†’function loadSettingsToUI() {
   488â†’    const settings = getSettings();
   489â†’
   490â†’    if (ui.sensitivitySlider) {
   491â†’        ui.sensitivitySlider.value = settings.sensitivity;
   492â†’        if (ui.sensitivityValue) ui.sensitivityValue.textContent = settings.sensitivity;
   493â†’    }
   494â†’
   495â†’    if (ui.enableTakesDetection) ui.enableTakesDetection.checked = settings.enableTakesDetection;
   496â†’    if (ui.enableJCut) ui.enableJCut.checked = settings.enableJCut;
   497â†’    if (ui.enableZoom) ui.enableZoom.checked = settings.enableZoom;
   498â†’    if (ui.enableChapters) ui.enableChapters.checked = settings.enableChapters;
   499â†’
   500â†’    if (ui.jcutSettings) ui.jcutSettings.classList.toggle('collapsed', !settings.enableJCut);
   501â†’    if (ui.zoomSettings) ui.zoomSettings.classList.toggle('collapsed', !settings.enableZoom);
   502â†’    if (ui.chapterSettings) ui.chapterSettings.classList.toggle('collapsed', !settings.enableChapters);
   503â†’
   504â†’    if (ui.jcutLeadIn) {
   505â†’        ui.jcutLeadIn.value = Math.round(settings.jcutLeadIn * 100);
   506â†’        if (ui.jcutLeadInValue) ui.jcutLeadInValue.textContent = settings.jcutLeadIn + 's';
   507â†’    }
   508â†’    if (ui.jcutLeadOut) {
   509â†’        ui.jcutLeadOut.value = Math.round(settings.jcutLeadOut * 100);
   510â†’        if (ui.jcutLeadOutValue) ui.jcutLeadOutValue.textContent = settings.jcutLeadOut + 's';
   511â†’    }
   512â†’
   513â†’    if (ui.presetSelector && settings.activePreset) {
   514â†’        ui.presetSelector.value = settings.activePreset;
   515â†’    }
   516â†’}
   517â†’
   518â†’// ============================================================================
   519â†’// GO BUTTON - MAIN WORKFLOW
   520â†’// ============================================================================
   521â†’function initGoButton() {
   522â†’    if (!ui.goBtn) return;
   523â†’
   524â†’    ui.goBtn.addEventListener('click', async () => {
   525â†’        if (isOperationInProgress) return;
   526â†’        await runDetection();
   527â†’    });
   528â†’}
   529â†’
   530â†’async function runDetection() {
   531â†’    if (isOperationInProgress) return;
   532â†’
   533â†’    // Check sequence
   534â†’    const hasSequence = await checkSequenceOpen();
   535â†’    if (!hasSequence) {
   536â†’        setStatus('Please open a sequence first', true);
   537â†’        return;
   538â†’    }
   539â†’
   540â†’    // Check online
   541â†’    if (!isOnline()) {
   542â†’        setStatus('Offline - Check your connection', true);
   543â†’        return;
   544â†’    }
   545â†’
   546â†’    isOperationInProgress = true;
   547â†’    ui.goBtn.disabled = true;
   548â†’    showProgress('Detecting silences...');
   549â†’
   550â†’    try {
   551â†’        const settings = getSettings();
   552â†’
   553â†’        // Get sequence info
   554â†’        const seqInfo = await jsx.call('getActiveSequence');
   555â†’        console.log('[SPLICE] Sequence info:', seqInfo);
   556â†’
   557â†’        // Store sequence info for later use
   558â†’        currentSequenceInfo = seqInfo;
   559â†’        window.spliceState.activeSequence = seqInfo;
   560â†’        if (seqInfo && seqInfo.videoPath) {
   561â†’            window.spliceState.currentVideoPath = seqInfo.videoPath;
   562â†’        }
   563â†’
   564â†’        // Export audio via JSX for silence detection
   565â†’        updateProgress(10, 'Exporting audio...');
   566â†’
   567â†’        let audioFilePath = null;
   568â†’        try {
   569â†’            // Get sequence info for audio export
   570â†’            const exportResult = await jsx.call('exportSequenceAudioForAnalysis');
   571â†’            if (exportResult && exportResult.success && exportResult.outputPath) {
   572â†’                audioFilePath = exportResult.outputPath;
   573â†’                console.log('[SPLICE] Audio exported to:', audioFilePath);
   574â†’            } else if (exportResult && exportResult.error) {
   575â†’                throw new Error(exportResult.error);
   576â†’            }
   577â†’        } catch (exportError) {
   578â†’            console.warn('[SPLICE] Audio export failed, trying fallback:', exportError.message);
   579â†’            // Try to get audio from first clip in timeline
   580â†’            try {
   581â†’                const clipInfo = await jsx.call('getFirstClipAudioPath');
   582â†’                if (clipInfo && clipInfo.path) {
   583â†’                    audioFilePath = clipInfo.path;
   584â†’                    console.log('[SPLICE] Using clip audio path:', audioFilePath);
   585â†’                }
   586â†’            } catch (clipError) {
   587â†’                console.warn('[SPLICE] Fallback audio path failed:', clipError.message);
   588â†’            }
   589â†’        }
   590â†’
   591â†’        if (!audioFilePath) {
   592â†’            throw new Error('Could not export or locate audio file. Please ensure sequence has audio tracks.');
   593â†’        }
   594â†’
   595â†’        // Store audio path globally for other modules
   596â†’        currentAudioPath = audioFilePath;
   597â†’        window.spliceState.audioPath = audioFilePath;
   598â†’
   599â†’        // Call backend for silence detection with audio file path
   600â†’        updateProgress(30, 'Detecting silences...');
   601â†’        const silenceResponse = await fetchWithTimeout(
   602â†’            `${getBackendUrl()}/silences-rms`,
   603â†’            {
   604â†’                method: 'POST',
   605â†’                headers: getAuthHeaders(),
   606â†’                body: JSON.stringify({
   607â†’                    wavPath: audioFilePath,
   608â†’                    sensitivity: settings.sensitivity,
   609â†’                    minSilenceLength: settings.minSilenceLength || 0.5
   610â†’                })
   611â†’            }
   612â†’        );
   613â†’
   614â†’        if (!silenceResponse.ok) {
   615â†’            throw new Error(await parseErrorResponse(silenceResponse));
   616â†’        }
   617â†’
   618â†’        const silenceData = await silenceResponse.json();
   619â†’        previewSilences = silenceData.silences || [];
   620â†’
   621â†’        // Detect takes if enabled
   622â†’        if (settings.enableTakesDetection) {
   623â†’            updateProgress(60, 'Detecting takes...');
   624â†’            try {
   625â†’                const analyzeResponse = await fetchWithTimeout(
   626â†’                    `${getBackendUrl()}/analyze`,
   627â†’                    {
   628â†’                        method: 'POST',
   629â†’                        headers: getAuthHeaders(),
   630â†’                        body: JSON.stringify({
   631â†’                            wavPath: audioFilePath,
   632â†’                            detectTakes: true
   633â†’                        })
   634â†’                    }
   635â†’                );
   636â†’
   637â†’                if (analyzeResponse.ok) {
   638â†’                    const analyzeData = await analyzeResponse.json();
   639â†’                    previewTakes = analyzeData.takes || [];
   640â†’
   641â†’                    // Store transcript for captions/music modules
   642â†’                    if (analyzeData.transcript) {
   643â†’                        currentTranscript = analyzeData.transcript;
   644â†’                        window.currentTranscript = analyzeData.transcript;
   645â†’                        window.spliceState.lastTranscript = analyzeData.transcript;
   646â†’                    }
   647â†’                } else {
   648â†’                    // Handle specific error codes
   649â†’                    const errorMsg = await parseErrorResponse(analyzeResponse);
   650â†’                    if (analyzeResponse.status === 402) {
   651â†’                        console.warn('[SPLICE] Takes detection skipped: insufficient credits');
   652â†’                        setStatus('Takes detection skipped: insufficient credits', true);
   653â†’                    } else if (analyzeResponse.status === 401) {
   654â†’                        console.warn('[SPLICE] Takes detection skipped: authentication required');
   655â†’                    } else {
   656â†’                        console.warn('[SPLICE] Takes detection failed:', errorMsg);
   657â†’                    }
   658â†’                }
   659â†’            } catch (e) {
   660â†’                console.warn('[SPLICE] Takes detection failed:', e.message);
   661â†’            }
   662â†’        }
   663â†’
   664â†’        // Detect profanity if enabled
   665â†’        if (settings.enableProfanity) {
   666â†’            updateProgress(65, 'Detecting profanity...');
   667â†’            try {
   668â†’                const profanityResponse = await fetchWithTimeout(
   669â†’                    `${getBackendUrl()}/profanity`,
   670â†’                    {
   671â†’                        method: 'POST',
   672â†’                        headers: getAuthHeaders(),
   673â†’                        body: JSON.stringify({
   674â†’                            wavPath: audioFilePath,
   675â†’                            language: settings.profanityLanguage || 'en',
   676â†’                            bleepType: settings.bleepType || 'standard'
   677â†’                        })
   678â†’                    }
   679â†’                );
   680â†’
   681â†’                if (profanityResponse.ok) {
   682â†’                    const profanityData = await profanityResponse.json();
   683â†’                    currentProfanity = profanityData.instances || [];
   684â†’                    if (currentProfanity.length > 0) {
   685â†’                        console.log(`[SPLICE] Found ${currentProfanity.length} profanity instances`);
   686â†’                    }
   687â†’                } else {
   688â†’                    console.warn('[SPLICE] Profanity detection failed:', await parseErrorResponse(profanityResponse));
   689â†’                }
   690â†’            } catch (e) {
   691â†’                console.warn('[SPLICE] Profanity detection failed:', e.message);
   692â†’            }
   693â†’        }
   694â†’
   695â†’        // Detect chapters if enabled
   696â†’        if (settings.enableChapters) {
   697â†’            updateProgress(80, 'Detecting chapters...');
   698â†’            try {
   699â†’                const chapterResponse = await fetchWithTimeout(
   700â†’                    `${getBackendUrl()}/chapters`,
   701â†’                    {
   702â†’                        method: 'POST',
   703â†’                        headers: getAuthHeaders(),
   704â†’                        body: JSON.stringify({
   705â†’                            wavPath: audioFilePath,
   706â†’                            transcript: currentTranscript,
   707â†’                            maxChapters: settings.maxChapters || 10,
   708â†’                            minChapterLength: settings.minChapterLength || 60
   709â†’                        })
   710â†’                    }
   711â†’                );
   712â†’
   713â†’                if (chapterResponse.ok) {
   714â†’                    const chapterData = await chapterResponse.json();
   715â†’                    currentChapters = chapterData.chapters || [];
   716â†’                }
   717â†’            } catch (e) {
   718â†’                console.warn('[SPLICE] Chapter detection failed:', e);
   719â†’            }
   720â†’        }
   721â†’
   722â†’        // Detect zoom points if enabled
   723â†’        if (settings.enableZoom) {
   724â†’            updateProgress(90, 'Detecting zoom points...');
   725â†’            try {
   726â†’                const zoomResponse = await fetchWithTimeout(
   727â†’                    `${getBackendUrl()}/zoom`,
   728â†’                    {
   729â†’                        method: 'POST',
   730â†’                        headers: getAuthHeaders(),
   731â†’                        body: JSON.stringify({
   732â†’                            wavPath: audioFilePath,
   733â†’                            transcript: currentTranscript,
   734â†’                            frequency: settings.zoomFrequency || 'medium',
   735â†’                            preset: settings.zoomPreset || 'medium',
   736â†’                            placement: settings.zoomPlacement || 'sentence_start'
   737â†’                        })
   738â†’                    }
   739â†’                );
   740â†’
   741â†’                if (zoomResponse.ok) {
   742â†’                    const zoomData = await zoomResponse.json();
   743â†’                    currentZooms = zoomData.zoomPoints || [];
   744â†’                }
   745â†’            } catch (e) {
   746â†’                console.warn('[SPLICE] Zoom detection failed:', e);
   747â†’            }
   748â†’        }
   749â†’
   750â†’        // Store results
   751â†’        lastDetectionResult = {
   752â†’            silences: previewSilences,
   753â†’            takes: previewTakes,
   754â†’            chapters: currentChapters,
   755â†’            zooms: currentZooms
   756â†’        };
   757â†’
   758â†’        // Show preview
   759â†’        hideProgress();
   760â†’        showCombinedPreview();
   761â†’        setStatus(`Found ${previewSilences.length} silences, ${previewTakes.length} takes`);
   762â†’
   763â†’    } catch (error) {
   764â†’        console.error('[SPLICE] Detection error:', error);
   765â†’        setStatus('Detection failed: ' + error.message, true);
   766â†’        hideProgress();
   767â†’    } finally {
   768â†’        isOperationInProgress = false;
   769â†’        ui.goBtn.disabled = false;
   770â†’    }
   771â†’}
   772â†’
   773â†’// ============================================================================
   774â†’// PROGRESS UI
   775â†’// ============================================================================
   776â†’function showProgress(message) {
   777â†’    if (ui.progressContainer) ui.progressContainer.classList.remove('hidden');
   778â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   779â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
   780â†’    updateProgress(0, message);
   781â†’}
   782â†’
   783â†’function updateProgress(percent, message) {
   784â†’    if (ui.progressBar) ui.progressBar.style.width = percent + '%';
   785â†’    if (ui.progressText) ui.progressText.textContent = message || '';
   786â†’}
   787â†’
   788â†’function hideProgress() {
   789â†’    if (ui.progressContainer) ui.progressContainer.classList.add('hidden');
   790â†’}
   791â†’
   792â†’// ============================================================================
   793â†’// COMBINED PREVIEW
   794â†’// ============================================================================
   795â†’function showCombinedPreview() {
   796â†’    if (!ui.combinedPreview) return;
   797â†’
   798â†’    ui.combinedPreview.classList.remove('hidden');
   799â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.add('hidden');
   800â†’
   801â†’    // Update counts
   802â†’    if (ui.silenceCount) ui.silenceCount.textContent = previewSilences.length;
   803â†’    if (ui.takeCount) ui.takeCount.textContent = previewTakes.length;
   804â†’
   805â†’    // Select all by default
   806â†’    selectedSilenceIndices.clear();
   807â†’    previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
   808â†’    updateSelectedCount();
   809â†’
   810â†’    // Render preview list
   811â†’    renderPreviewList();
   812â†’
   813â†’    // Show chapter results if available
   814â†’    if (currentChapters.length > 0 && ui.chapterResults) {
   815â†’        ui.chapterResults.classList.remove('hidden');
   816â†’        renderChapterList();
   817â†’    }
   818â†’
   819â†’    // Show zoom results if available
   820â†’    if (currentZooms.length > 0 && ui.zoomResults) {
   821â†’        ui.zoomResults.classList.remove('hidden');
   822â†’    }
   823â†’}
   824â†’
   825â†’function renderPreviewList() {
   826â†’    if (!ui.previewList) return;
   827â†’
   828â†’    const html = [];
   829â†’
   830â†’    // Render silences
   831â†’    previewSilences.forEach((silence, i) => {
   832â†’        const isSelected = selectedSilenceIndices.has(i);
   833â†’        const duration = silence.end - silence.start;
   834â†’        html.push(`
   835â†’            <div class="preview-item ${isSelected ? '' : 'excluded'}" data-index="${i}" data-type="silence">
   836â†’                <input type="checkbox" class="preview-item-check" ${isSelected ? 'checked' : ''}>
   837â†’                <div class="preview-item-info">
   838â†’                    <div class="preview-item-time">${formatTime(silence.start)} - ${formatTime(silence.end)}</div>
   839â†’                    <div class="preview-item-duration">${duration.toFixed(2)}s silence</div>
   840â†’                </div>
   841â†’            </div>
   842â†’        `);
   843â†’    });
   844â†’
   845â†’    // Render takes
   846â†’    previewTakes.forEach((take, i) => {
   847â†’        // SECURITY: Escape take label to prevent XSS
   848â†’        const safeLabel = escapeHtml(take.label || 'Take ' + (take.takeNumber || i + 1));
   849â†’        html.push(`
   850â†’            <div class="preview-item take-item" data-index="${i}" data-type="take">
   851â†’                <div class="preview-item-icon">ðŸŽ¬</div>
   852â†’                <div class="preview-item-info">
   853â†’                    <div class="preview-item-time">${formatTime(take.start)} - ${formatTime(take.end)}</div>
   854â†’                    <div class="preview-item-label">${safeLabel}</div>
   855â†’                </div>
   856â†’            </div>
   857â†’        `);
   858â†’    });
   859â†’
   860â†’    ui.previewList.innerHTML = html.join('');
   861â†’
   862â†’    // Add click handlers
   863â†’    ui.previewList.querySelectorAll('.preview-item').forEach(item => {
   864â†’        item.addEventListener('click', (e) => {
   865â†’            const index = parseInt(item.dataset.index);
   866â†’            const type = item.dataset.type;
   867â†’
   868â†’            if (e.target.classList.contains('preview-item-check')) {
   869â†’                // Checkbox clicked
   870â†’                toggleSilenceSelection(index);
   871â†’            } else {
   872â†’                // Item clicked - seek to time
   873â†’                const data = type === 'silence' ? previewSilences[index] : previewTakes[index];
   874â†’                seekToTime(data.start);
   875â†’            }
   876â†’        });
   877â†’    });
   878â†’}
   879â†’
   880â†’function toggleSilenceSelection(index) {
   881â†’    if (selectedSilenceIndices.has(index)) {
   882â†’        selectedSilenceIndices.delete(index);
   883â†’    } else {
   884â†’        selectedSilenceIndices.add(index);
   885â†’    }
   886â†’    updateSelectedCount();
   887â†’    renderPreviewList();
   888â†’}
   889â†’
   890â†’function updateSelectedCount() {
   891â†’    if (ui.selectedCount) {
   892â†’        ui.selectedCount.textContent = selectedSilenceIndices.size;
   893â†’    }
   894â†’    if (ui.selectAllSilences) {
   895â†’        ui.selectAllSilences.checked = selectedSilenceIndices.size === previewSilences.length;
   896â†’    }
   897â†’}
   898â†’
   899â†’async function seekToTime(seconds) {
   900â†’    try {
   901â†’        // Check if there's an active sequence before seeking
   902â†’        if (!app?.project?.activeSequence) {
   903â†’            console.warn('[SPLICE] No active sequence to seek in');
   904â†’            return;
   905â†’        }
   906â†’        // Use JSX to set playhead position
   907â†’        // Note: setPlayerPosition expects ticks as a string without quotes around the number value
   908â†’        const ticks = Math.round(seconds * 254016000000);
   909â†’        await jsx.evalScript(`app.project.activeSequence.setPlayerPosition(${ticks})`);
   910â†’    } catch (e) {
   911â†’        console.warn('[SPLICE] Seek failed:', e);
   912â†’    }
   913â†’}
   914â†’
   915â†’// ============================================================================
   916â†’// CHAPTER LIST
   917â†’// ============================================================================
   918â†’function renderChapterList() {
   919â†’    if (!ui.chapterList) return;
   920â†’
   921â†’    const html = currentChapters.map((chapter, i) => {
   922â†’        // SECURITY: Escape chapter title to prevent XSS
   923â†’        const safeTitle = escapeHtml(chapter.title);
   924â†’        return `
   925â†’            <div class="chapter-item" data-index="${i}">
   926â†’                <div class="chapter-time">${formatTime(chapter.startTime)}</div>
   927â†’                <div class="chapter-title">${safeTitle}</div>
   928â†’            </div>
   929â†’        `;
   930â†’    }).join('');
   931â†’
   932â†’    ui.chapterList.innerHTML = html;
   933â†’
   934â†’    // Add click handlers
   935â†’    ui.chapterList.querySelectorAll('.chapter-item').forEach(item => {
   936â†’        item.addEventListener('click', () => {
   937â†’            const index = parseInt(item.dataset.index);
   938â†’            seekToTime(currentChapters[index].startTime);
   939â†’        });
   940â†’    });
   941â†’}
   942â†’
   943â†’// ============================================================================
   944â†’// PREVIEW HANDLERS
   945â†’// ============================================================================
   946â†’function initPreviewHandlers() {
   947â†’    // Select all checkbox
   948â†’    if (ui.selectAllSilences) {
   949â†’        ui.selectAllSilences.addEventListener('change', () => {
   950â†’            if (ui.selectAllSilences.checked) {
   951â†’                previewSilences.forEach((_, i) => selectedSilenceIndices.add(i));
   952â†’            } else {
   953â†’                selectedSilenceIndices.clear();
   954â†’            }
   955â†’            updateSelectedCount();
   956â†’            renderPreviewList();
   957â†’        });
   958â†’    }
   959â†’
   960â†’    // Apply button
   961â†’    if (ui.applyPreviewBtn) {
   962â†’        ui.applyPreviewBtn.addEventListener('click', applyPreviewAndMarkers);
   963â†’    }
   964â†’
   965â†’    // Cancel button
   966â†’    if (ui.cancelPreviewBtn) {
   967â†’        ui.cancelPreviewBtn.addEventListener('click', hidePreview);
   968â†’    }
   969â†’
   970â†’    // Build sequence button
   971â†’    if (ui.buildSequenceBtn) {
   972â†’        ui.buildSequenceBtn.addEventListener('click', buildSequence);
   973â†’    }
   974â†’
   975â†’    // Copy YouTube timestamps
   976â†’    if (ui.copyYouTubeBtn) {
   977â†’        ui.copyYouTubeBtn.addEventListener('click', copyYouTubeTimestamps);
   978â†’    }
   979â†’
   980â†’    // Add chapter markers
   981â†’    if (ui.addChapterMarkersBtn) {
   982â†’        ui.addChapterMarkersBtn.addEventListener('click', addChapterMarkers);
   983â†’    }
   984â†’
   985â†’    // Apply zoom markers
   986â†’    const applyZoomsBtn = document.getElementById('applyZoomsBtn');
   987â†’    if (applyZoomsBtn) {
   988â†’        applyZoomsBtn.addEventListener('click', applyZoomMarkers);
   989â†’    }
   990â†’}
   991â†’
   992â†’async function applyPreviewAndMarkers() {
   993â†’    if (isOperationInProgress) return;
   994â†’
   995â†’    isOperationInProgress = true;
   996â†’    setStatus('Adding markers...');
   997â†’
   998â†’    try {
   999â†’        // Add silence markers
  1000â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
  1001â†’        for (const silence of selectedSilences) {
  1002â†’            await jsx.call('createMarker', silence.start, 'SPLICE: Silence', silence.end - silence.start, null, 1);
  1003â†’        }
  1004â†’
  1005â†’        // Add take markers
  1006â†’        for (const take of previewTakes) {
  1007â†’            await jsx.call('createMarker', take.start, take.label || `Take ${take.takeNumber}`, take.end - take.start, null, 5);
  1008â†’        }
  1009â†’
  1010â†’        setStatus(`Added ${selectedSilences.length + previewTakes.length} markers`);
  1011â†’    } catch (error) {
  1012â†’        setStatus('Failed to add markers: ' + error.message, true);
  1013â†’    } finally {
  1014â†’        isOperationInProgress = false;
  1015â†’    }
  1016â†’}
  1017â†’
  1018â†’function hidePreview() {
  1019â†’    if (ui.combinedPreview) ui.combinedPreview.classList.add('hidden');
  1020â†’    if (ui.chapterResults) ui.chapterResults.classList.add('hidden');
  1021â†’    if (ui.zoomResults) ui.zoomResults.classList.add('hidden');
  1022â†’    if (ui.resultsEmpty) ui.resultsEmpty.classList.remove('hidden');
  1023â†’    previewSilences = [];
  1024â†’    previewTakes = [];
  1025â†’    selectedSilenceIndices.clear();
  1026â†’}
  1027â†’
  1028â†’async function buildSequence() {
  1029â†’    if (isOperationInProgress) return;
  1030â†’
  1031â†’    isOperationInProgress = true;
  1032â†’    setStatus('Building sequence...');
  1033â†’
  1034â†’    try {
  1035â†’        const settings = getSettings();
  1036â†’
  1037â†’        // Ensure we have sequence info
  1038â†’        if (!currentSequenceInfo) {
  1039â†’            currentSequenceInfo = await jsx.call('getActiveSequence');
  1040â†’        }
  1041â†’
  1042â†’        // Create cut list from selected silences
  1043â†’        const selectedSilences = previewSilences.filter((_, i) => selectedSilenceIndices.has(i));
  1044â†’
  1045â†’        // Calculate total duration from sequence info or last silence
  1046â†’        let duration = 0;
  1047â†’        if (currentSequenceInfo && currentSequenceInfo.duration) {
  1048â†’            duration = currentSequenceInfo.duration;
  1049â†’        } else if (previewSilences.length > 0) {
  1050â†’            const lastSilence = previewSilences[previewSilences.length - 1];
  1051â†’            duration = lastSilence.end + 10; // Add buffer
  1052â†’        }
  1053â†’
  1054â†’        // Call backend to generate cut list
  1055â†’        const cutListResponse = await fetchWithTimeout(
  1056â†’            `${getBackendUrl()}/cut-list`,
  1057â†’            {
  1058â†’                method: 'POST',
  1059â†’                headers: getAuthHeaders(),
  1060â†’                body: JSON.stringify({
  1061â†’                    sourceName: currentSequenceInfo?.name || 'Untitled Sequence',
  1062â†’                    sourcePath: currentSequenceInfo?.treePath || currentSequenceInfo?.name || 'Untitled',
  1063â†’                    duration: duration,
  1064â†’                    silences: selectedSilences,
  1065â†’                    takes: previewTakes,
  1066â†’                    enableTakes: settings.enableTakesDetection,
  1067â†’                    jCutOffset: settings.enableJCut ? settings.jcutLeadIn : 0,
  1068â†’                    lCutOffset: settings.enableJCut ? settings.jcutLeadOut : 0
  1069â†’                })
  1070â†’            }
  1071â†’        );
  1072â†’
  1073â†’        if (!cutListResponse.ok) {
  1074â†’            throw new Error(await parseErrorResponse(cutListResponse));
  1075â†’        }
  1076â†’
  1077â†’        const cutList = await cutListResponse.json();
  1078â†’
  1079â†’        // Build sequence via JSX
  1080â†’        const result = await jsx.call('buildSequenceFromCutList', JSON.stringify(cutList));
  1081â†’
  1082â†’        if (result && result.success) {
  1083â†’            setStatus(`Built sequence: ${result.sequenceName}`);
  1084â†’            hidePreview();
  1085â†’        } else {
  1086â†’            throw new Error(result?.error || 'Build failed');
  1087â†’        }
  1088â†’    } catch (error) {
  1089â†’        setStatus('Build failed: ' + error.message, true);
  1090â†’    } finally {
  1091â†’        isOperationInProgress = false;
  1092â†’    }
  1093â†’}
  1094â†’
  1095â†’function copyYouTubeTimestamps() {
  1096â†’    if (currentChapters.length === 0) return;
  1097â†’
  1098â†’    const timestamps = currentChapters.map(ch =>
  1099â†’        `${formatTime(ch.startTime)} ${ch.title}`
  1100â†’    ).join('\n');
  1101â†’
  1102â†’    navigator.clipboard.writeText(timestamps).then(() => {
  1103â†’        setStatus('Copied YouTube timestamps');
  1104â†’    }).catch(() => {
  1105â†’        setStatus('Failed to copy', true);
  1106â†’    });
  1107â†’}
  1108â†’
  1109â†’async function addChapterMarkers() {
  1110â†’    if (isOperationInProgress || currentChapters.length === 0) return;
  1111â†’
  1112â†’    isOperationInProgress = true;
  1113â†’    setStatus('Adding chapter markers...');
  1114â†’
  1115â†’    try {
  1116â†’        for (const chapter of currentChapters) {
  1117â†’            await jsx.call('addChapterMarker', chapter.startTime, chapter.title, chapter.description);
  1118â†’        }
  1119â†’        setStatus(`Added ${currentChapters.length} chapter markers`);
  1120â†’    } catch (error) {
  1121â†’        setStatus('Failed to add markers: ' + error.message, true);
  1122â†’    } finally {
  1123â†’        isOperationInProgress = false;
  1124â†’    }
  1125â†’}
  1126â†’
  1127â†’/**
  1128â†’ * Apply zoom point markers to the timeline
  1129â†’ */
  1130â†’async function applyZoomMarkers() {
  1131â†’    if (isOperationInProgress || currentZooms.length === 0) return;
  1132â†’
  1133â†’    isOperationInProgress = true;
  1134â†’    setStatus('Adding zoom markers...');
  1135â†’
  1136â†’    try {
  1137â†’        for (const zoom of currentZooms) {
  1138â†’            // Create a marker for each zoom point with zoom intensity info
  1139â†’            const comment = `Zoom ${zoom.intensity || 'medium'} - ${zoom.reason || 'emphasis'}`;
  1140â†’            await jsx.call('createMarker', zoom.time, 'SPLICE: Zoom', 0.5, comment, 3);
  1141â†’        }
  1142â†’        setStatus(`Added ${currentZooms.length} zoom markers`);
  1143â†’    } catch (error) {
  1144â†’        setStatus('Failed to add zoom markers: ' + error.message, true);
  1145â†’    } finally {
  1146â†’        isOperationInProgress = false;
  1147â†’    }
  1148â†’}
  1149â†’
  1150â†’// ============================================================================
  1151â†’// MODALS
  1152â†’// ============================================================================
  1153â†’function initModals() {
  1154â†’    // Settings modal
  1155â†’    if (ui.settingsBtn && ui.settingsModal) {
  1156â†’        ui.settingsBtn.addEventListener('click', () => {
  1157â†’            ui.settingsModal.classList.remove('hidden');
  1158â†’            // Sync remember options checkbox with current settings
  1159â†’            const rememberOptions = document.getElementById('rememberOptions');
  1160â†’            if (rememberOptions) {
  1161â†’                rememberOptions.checked = getSettings().rememberOptions;
  1162â†’            }
  1163â†’        });
  1164â†’    }
  1165â†’
  1166â†’    if (ui.closeSettingsBtn && ui.settingsModal) {
  1167â†’        ui.closeSettingsBtn.addEventListener('click', () => {
  1168â†’            ui.settingsModal.classList.add('hidden');
  1169â†’        });
  1170â†’    }
  1171â†’
  1172â†’    // Remember options checkbox
  1173â†’    const rememberOptions = document.getElementById('rememberOptions');
  1174â†’    if (rememberOptions) {
  1175â†’        rememberOptions.addEventListener('change', () => {
  1176â†’            saveSettings({ rememberOptions: rememberOptions.checked });
  1177â†’            if (rememberOptions.checked) {
  1178â†’                setStatus('Options will be remembered');
  1179â†’            } else {
  1180â†’                setStatus('Options will reset to defaults');
  1181â†’            }
  1182â†’        });
  1183â†’    }
  1184â†’
  1185â†’    // Credit badge click handler (handles login, retry, and refresh)
  1186â†’    if (ui.creditBadge) {
  1187â†’        ui.creditBadge.addEventListener('click', () => {
  1188â†’            // Use the centralized handler from credits.js
  1189â†’            if (typeof handleCreditBadgeClick === 'function') {
  1190â†’                handleCreditBadgeClick();
  1191â†’            } else {
  1192â†’                // Fallback if credits.js not loaded yet
  1193â†’                const settings = getSettings();
  1194â†’                if (!settings.customerId) {
  1195â†’                    showLoginModal();
  1196â†’                }
  1197â†’            }
  1198â†’        });
  1199â†’    }
  1200â†’
  1201â†’    if (ui.closeLoginBtn && ui.loginModal) {
  1202â†’        ui.closeLoginBtn.addEventListener('click', () => {
  1203â†’            ui.loginModal.classList.add('hidden');
  1204â†’        });
  1205â†’    }
  1206â†’
  1207â†’    if (ui.saveLoginBtn) {
  1208â†’        ui.saveLoginBtn.addEventListener('click', activateLicense);
  1209â†’    }
  1210â†’
  1211â†’    // License lookup button
  1212â†’    const lookupLicenseBtn = document.getElementById('lookupLicenseBtn');
  1213â†’    if (lookupLicenseBtn) {
  1214â†’        lookupLicenseBtn.addEventListener('click', lookupLicense);
  1215â†’    }
  1216â†’
  1217â†’    // Close modals on backdrop click
  1218â†’    document.querySelectorAll('.modal').forEach(modal => {
  1219â†’        modal.addEventListener('click', (e) => {
  1220â†’            if (e.target === modal) {
  1221â†’                modal.classList.add('hidden');
  1222â†’            }
  1223â†’        });
  1224â†’    });
  1225â†’}
  1226â†’
  1227â†’function showLoginModal() {
  1228â†’    if (ui.loginModal) ui.loginModal.classList.remove('hidden');
  1229â†’}
  1230â†’
  1231â†’/**
  1232â†’ * Show upgrade modal when user tries to access a gated feature
  1233â†’ * @param {string} featureName - Display name of the feature
  1234â†’ * @param {string} requiredTier - Required tier (Pro, Team)
  1235â†’ */
  1236â†’function showUpgradeModal(featureName, requiredTier = 'Pro') {
  1237â†’    const modal = document.getElementById('upgradeModal');
  1238â†’    const featureText = document.getElementById('upgradeFeatureName');
  1239â†’    const tierText = document.getElementById('upgradeRequiredTier');
  1240â†’
  1241â†’    if (featureText) {
  1242â†’        featureText.textContent = featureName;
  1243â†’    }
  1244â†’    if (tierText) {
  1245â†’        tierText.textContent = requiredTier;
  1246â†’    }
  1247â†’    if (modal) {
  1248â†’        modal.classList.remove('hidden');
  1249â†’    }
  1250â†’}
  1251â†’
  1252â†’/**
  1253â†’ * Close the upgrade modal
  1254â†’ */
  1255â†’function closeUpgradeModal() {
  1256â†’    const modal = document.getElementById('upgradeModal');
  1257â†’    if (modal) {
  1258â†’        modal.classList.add('hidden');
  1259â†’    }
  1260â†’}
  1261â†’
  1262â†’// Expose showUpgradeModal and closeUpgradeModal globally for feature modules
  1263â†’window.showUpgradeModal = showUpgradeModal;
  1264â†’window.closeUpgradeModal = closeUpgradeModal;
  1265â†’
  1266â†’async function activateLicense() {
  1267â†’    if (!ui.licenseKeyInput) return;
  1268â†’
  1269â†’    const licenseKey = ui.licenseKeyInput.value.trim();
  1270â†’    if (!licenseKey) {
  1271â†’        setStatus('Please enter a license key', true);
  1272â†’        return;
  1273â†’    }
  1274â†’
  1275â†’    try {
  1276â†’        const response = await fetchWithTimeout(
  1277â†’            `${getBackendUrl()}/license/activate`,
  1278â†’            {
  1279â†’                method: 'POST',
  1280â†’                headers: { 'Content-Type': 'application/json' },
  1281â†’                body: JSON.stringify({ key: licenseKey })
  1282â†’            }
  1283â†’        );
  1284â†’
  1285â†’        if (!response.ok) {
  1286â†’            throw new Error(await parseErrorResponse(response));
  1287â†’        }
  1288â†’
  1289â†’        const data = await response.json();
  1290â†’        saveSettings({
  1291â†’            customerId: data.customerId,
  1292â†’            licenseKey: licenseKey
  1293â†’        });
  1294â†’
  1295â†’        if (ui.loginModal) ui.loginModal.classList.add('hidden');
  1296â†’        setStatus('License activated');
  1297â†’        updateCredits();
  1298â†’    } catch (error) {
  1299â†’        setStatus('Activation failed: ' + error.message, true);
  1300â†’    }
  1301â†’}
  1302â†’
  1303â†’/**
  1304â†’ * Look up license key by email address
  1305â†’ */
  1306â†’async function lookupLicense() {
  1307â†’    const lookupEmailInput = document.getElementById('lookupEmailInput');
  1308â†’    const licenseKeyInput = document.getElementById('licenseKeyInput');
  1309â†’
  1310â†’    if (!lookupEmailInput) return;
  1311â†’
  1312â†’    const email = lookupEmailInput.value.trim().toLowerCase();
  1313â†’    if (!email) {
  1314â†’        setStatus('Please enter your email address', true);
  1315â†’        return;
  1316â†’    }
  1317â†’
  1318â†’    // Basic email validation
  1319â†’    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  1320â†’    if (!emailRegex.test(email)) {
  1321â†’        setStatus('Please enter a valid email address', true);
  1322â†’        return;
  1323â†’    }
  1324â†’
  1325â†’    const lookupBtn = document.getElementById('lookupLicenseBtn');
  1326â†’    if (lookupBtn) {
  1327â†’        lookupBtn.disabled = true;
  1328â†’        lookupBtn.textContent = 'Looking up...';
  1329â†’    }
  1330â†’
  1331â†’    try {
  1332â†’        const response = await fetchWithTimeout(
  1333â†’            `${getBackendUrl()}/license/lookup`,
  1334â†’            {
  1335â†’                method: 'POST',
  1336â†’                headers: { 'Content-Type': 'application/json' },
  1337â†’                body: JSON.stringify({ email })
  1338â†’            },
  1339â†’            30000
  1340â†’        );
  1341â†’
  1342â†’        const result = await response.json();
  1343â†’
  1344â†’        // Note: For security, the backend does NOT return the license key directly.
  1345â†’        // It sends the key via email to prevent enumeration attacks.
  1346â†’        if (result.success) {
  1347â†’            setStatus(result.message || 'If a license exists, it has been sent to your email.');
  1348â†’        } else {
  1349â†’            setStatus(result.error || 'Lookup failed. Please try again.', true);
  1350â†’        }
  1351â†’    } catch (error) {
  1352â†’        setStatus('Lookup failed: ' + error.message, true);
  1353â†’    } finally {
  1354â†’        if (lookupBtn) {
  1355â†’            lookupBtn.disabled = false;
  1356â†’            lookupBtn.textContent = 'Lookup';
  1357â†’        }
  1358â†’    }
  1359â†’}
  1360â†’
  1361â†’// ============================================================================
  1362â†’// CREDITS
  1363â†’// ============================================================================
  1364â†’function initCredits() {
  1365â†’    updateCredits();
  1366â†’}
  1367â†’
  1368â†’async function updateCredits() {
  1369â†’    if (!ui.creditBadge) return;
  1370â†’
  1371â†’    const settings = getSettings();
  1372â†’    if (!settings.customerId) {
  1373â†’        ui.creditBadge.className = 'credit-badge login';
  1374â†’        ui.creditBadge.textContent = 'Login';
  1375â†’        ui.creditBadge.style.display = 'flex';
  1376â†’        return;
  1377â†’    }
  1378â†’
  1379â†’    try {
  1380â†’        const response = await fetchWithTimeout(
  1381â†’            `${getBackendUrl()}/credits`,
  1382â†’            {
  1383â†’                method: 'GET',
  1384â†’                headers: getAuthHeaders()
  1385â†’            }
  1386â†’        );
  1387â†’
  1388â†’        if (response.ok) {
  1389â†’            const data = await response.json();
  1390â†’            // Backend returns hoursRemaining (not remainingMinutes)
  1391â†’            const hours = (data.hoursRemaining || 0).toFixed(1);
  1392â†’            ui.creditBadge.textContent = `${hours}h`;
  1393â†’            // Low warning when less than 1 hour remaining
  1394â†’            ui.creditBadge.className = data.hoursRemaining < 1 ? 'credit-badge low' : 'credit-badge ok';
  1395â†’            ui.creditBadge.style.display = 'flex';
  1396â†’        } else {
  1397â†’            ui.creditBadge.className = 'credit-badge error';
  1398â†’            ui.creditBadge.textContent = 'Error';
  1399â†’            ui.creditBadge.style.display = 'flex';
  1400â†’        }
  1401â†’    } catch {
  1402â†’        ui.creditBadge.className = 'credit-badge error';
  1403â†’        ui.creditBadge.textContent = 'Offline';
  1404â†’        ui.creditBadge.style.display = 'flex';
  1405â†’    }
  1406â†’}
  1407â†’
  1408â†’// ============================================================================
  1409â†’// HELP BUTTON
  1410â†’// ============================================================================
  1411â†’function initHelpButton() {
  1412â†’    const helpBtn = document.getElementById('helpBtn');
  1413â†’    if (helpBtn) {
  1414â†’        helpBtn.addEventListener('click', () => {
  1415â†’            setStatus('Silence: removes quiet gaps | Takes: detects repeated content | Chapters: AI topic segmentation');
  1416â†’        });
  1417â†’    }
  1418â†’}
  1419â†’
  1420â†’// Export for debugging
  1421â†’window.spliceDebug = {
  1422â†’    getState: () => ({
  1423â†’        silences: previewSilences,
  1424â†’        takes: previewTakes,
  1425â†’        chapters: currentChapters,
  1426â†’        zooms: currentZooms,
  1427â†’        selected: Array.from(selectedSilenceIndices)
  1428â†’    }),
  1429â†’    jsx,
  1430â†’    runDetection
  1431â†’};
  1432â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
