     1→#!/bin/bash
     2→#
     3→# Apple Developer ID Signing Setup Script
     4→# This script helps configure your environment for signed macOS installers
     5→#
     6→
     7→set -e
     8→
     9→SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    10→PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
    11→ENV_FILE="$PROJECT_ROOT/.env.apple-signing"
    12→
    13→RED='\033[0;31m'
    14→GREEN='\033[0;32m'
    15→YELLOW='\033[1;33m'
    16→BLUE='\033[0;34m'
    17→CYAN='\033[0;36m'
    18→NC='\033[0m'
    19→
    20→echo ""
    21→echo -e "${CYAN}╔════════════════════════════════════════════════════════════╗${NC}"
    22→echo -e "${CYAN}║      Apple Developer ID Signing Setup                      ║${NC}"
    23→echo -e "${CYAN}╚════════════════════════════════════════════════════════════╝${NC}"
    24→echo ""
    25→
    26→# Check if already configured
    27→if [[ -f "$ENV_FILE" ]]; then
    28→    echo -e "${YELLOW}[INFO]${NC} Existing configuration found at: $ENV_FILE"
    29→    read -p "Do you want to reconfigure? (y/N): " RECONFIGURE
    30→    if [[ "$RECONFIGURE" != "y" && "$RECONFIGURE" != "Y" ]]; then
    31→        echo -e "${GREEN}[INFO]${NC} Using existing configuration"
    32→        source "$ENV_FILE"
    33→        echo ""
    34→        echo "Current settings:"
    35→        echo "  APPLE_DEVELOPER_ID: $APPLE_DEVELOPER_ID"
    36→        echo "  APPLE_ID: $APPLE_ID"
    37→        echo "  APPLE_TEAM_ID: $APPLE_TEAM_ID"
    38→        echo "  APPLE_APP_PASSWORD: (hidden)"
    39→        exit 0
    40→    fi
    41→fi
    42→
    43→echo -e "${BLUE}This script will help you set up Apple Developer ID signing.${NC}"
    44→echo ""
    45→echo "Prerequisites:"
    46→echo "  1. Apple Developer Program membership (\$99/year)"
    47→echo "  2. Developer ID Installer certificate installed in Keychain"
    48→echo "  3. App-specific password for notarization"
    49→echo ""
    50→
    51→# Step 1: Check for certificates
    52→echo -e "${CYAN}Step 1: Checking for Developer ID certificates...${NC}"
    53→echo ""
    54→
    55→CERTS=$(security find-identity -v -p basic 2>/dev/null | grep "Developer ID" || true)
    56→
    57→if [[ -z "$CERTS" ]]; then
    58→    echo -e "${YELLOW}[WARNING]${NC} No Developer ID certificates found in Keychain"
    59→    echo ""
    60→    echo "To create one:"
    61→    echo "  1. Go to https://developer.apple.com/account/resources/certificates"
    62→    echo "  2. Click + to create new certificate"
    63→    echo "  3. Select 'Developer ID Installer'"
    64→    echo "  4. Follow the instructions to download and install"
    65→    echo ""
    66→    read -p "Press Enter to continue setup anyway, or Ctrl+C to exit..."
    67→else
    68→    echo -e "${GREEN}[SUCCESS]${NC} Found Developer ID certificates:"
    69→    echo "$CERTS" | head -5
    70→    echo ""
    71→fi
    72→
    73→# Step 2: Get Developer ID
    74→echo -e "${CYAN}Step 2: Enter your Developer ID Installer certificate name${NC}"
    75→echo ""
    76→echo "Format: Developer ID Installer: Your Name (TEAMID)"
    77→echo "Example: Developer ID Installer: John Smith (ABC123XYZ)"
    78→echo ""
    79→
    80→if [[ -n "$CERTS" ]]; then
    81→    # Try to extract the first Developer ID Installer
    82→    DEFAULT_CERT=$(echo "$CERTS" | grep "Developer ID Installer" | head -1 | sed 's/.*"\(.*\)".*/\1/' || true)
    83→    if [[ -n "$DEFAULT_CERT" ]]; then
    84→        echo "Detected: $DEFAULT_CERT"
    85→        read -p "Use this certificate? (Y/n): " USE_DEFAULT
    86→        if [[ "$USE_DEFAULT" != "n" && "$USE_DEFAULT" != "N" ]]; then
    87→            APPLE_DEVELOPER_ID="$DEFAULT_CERT"
    88→        fi
    89→    fi
    90→fi
    91→
    92→if [[ -z "$APPLE_DEVELOPER_ID" ]]; then
    93→    read -p "Developer ID Installer: " APPLE_DEVELOPER_ID
    94→fi
    95→
    96→# Step 3: Get Apple ID
    97→echo ""
    98→echo -e "${CYAN}Step 3: Enter your Apple ID (email)${NC}"
    99→echo "This is used for notarization"
   100→read -p "Apple ID: " APPLE_ID
   101→
   102→# Step 4: Get Team ID
   103→echo ""
   104→echo -e "${CYAN}Step 4: Enter your Team ID${NC}"
   105→echo "Find it at: https://developer.apple.com/account → Membership → Team ID"
   106→read -p "Team ID: " APPLE_TEAM_ID
   107→
   108→# Step 5: Get App-Specific Password
   109→echo ""
   110→echo -e "${CYAN}Step 5: Enter your App-Specific Password${NC}"
   111→echo ""
   112→echo "To create one:"
   113→echo "  1. Go to https://appleid.apple.com"
   114→echo "  2. Sign in → Security → App-Specific Passwords"
   115→echo "  3. Click + to generate a new password"
   116→echo "  4. Name it 'SPLICE Notarization'"
   117→echo ""
   118→read -s -p "App-Specific Password (hidden): " APPLE_APP_PASSWORD
   119→echo ""
   120→
   121→# Step 6: Save configuration
   122→echo ""
   123→echo -e "${CYAN}Step 6: Saving configuration...${NC}"
   124→
   125→cat > "$ENV_FILE" << EOF
   126→# Apple Developer Signing Configuration
   127→# Generated by setup-apple-signing.sh
   128→# DO NOT commit this file to git!
   129→
   130→export APPLE_DEVELOPER_ID="$APPLE_DEVELOPER_ID"
   131→export APPLE_ID="$APPLE_ID"
   132→export APPLE_TEAM_ID="$APPLE_TEAM_ID"
   133→export APPLE_APP_PASSWORD="$APPLE_APP_PASSWORD"
   134→EOF
   135→
   136→chmod 600 "$ENV_FILE"
   137→
   138→# Add to .gitignore if not already there
   139→if ! grep -q ".env.apple-signing" "$PROJECT_ROOT/.gitignore" 2>/dev/null; then
   140→    echo ".env.apple-signing" >> "$PROJECT_ROOT/.gitignore"
   141→    echo -e "${GREEN}[INFO]${NC} Added .env.apple-signing to .gitignore"
   142→fi
   143→
   144→echo -e "${GREEN}[SUCCESS]${NC} Configuration saved to: $ENV_FILE"
   145→echo ""
   146→
   147→# Step 7: Test the certificate
   148→echo -e "${CYAN}Step 7: Verifying certificate...${NC}"
   149→if security find-identity -v -p basic 2>/dev/null | grep -q "$APPLE_DEVELOPER_ID"; then
   150→    echo -e "${GREEN}[SUCCESS]${NC} Certificate verified in Keychain"
   151→else
   152→    echo -e "${YELLOW}[WARNING]${NC} Certificate not found in Keychain"
   153→    echo "Make sure you've downloaded and installed the certificate from developer.apple.com"
   154→fi
   155→
   156→echo ""
   157→echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
   158→echo -e "${GREEN}║      Setup Complete!                                        ║${NC}"
   159→echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
   160→echo ""
   161→echo "To build signed installers, run:"
   162→echo ""
   163→echo "  source $ENV_FILE"
   164→echo "  ./build/scripts/build-all.sh"
   165→echo ""
   166→echo "Or add this to your ~/.zshrc or ~/.bashrc:"
   167→echo ""
   168→echo "  source $ENV_FILE"
   169→echo ""
   170→

</system-reminder>
