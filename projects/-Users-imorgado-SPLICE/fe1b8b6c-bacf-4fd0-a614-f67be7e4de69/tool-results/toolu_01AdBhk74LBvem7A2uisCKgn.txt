     1→#!/bin/bash
     2→#
     3→# SPLICE CEP Extension - Certificate Creation Script
     4→# Creates a self-signed certificate for signing CEP extensions with ZXPSignCmd
     5→#
     6→# Usage: ./create-certificate.sh [--force]
     7→#   --force: Overwrite existing certificate
     8→#
     9→# Environment Variables:
    10→#   ZXP_CERT_PASSWORD - Password for the certificate (will prompt if not set)
    11→#   ZXP_CERT_COUNTRY - Country code (default: US)
    12→#   ZXP_CERT_STATE - State/Province (default: CA)
    13→#   ZXP_CERT_ORG - Organization name (default: SPLICE Inc)
    14→#   ZXP_CERT_NAME - Common name (default: SPLICE)
    15→#
    16→
    17→set -e
    18→
    19→# Get script directory and project root
    20→SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    21→PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
    22→BUILD_DIR="$PROJECT_ROOT/build"
    23→CERT_DIR="$BUILD_DIR/certificates"
    24→CERT_FILE="$CERT_DIR/splice-cert.p12"
    25→
    26→# Colors for output
    27→RED='\033[0;31m'
    28→GREEN='\033[0;32m'
    29→YELLOW='\033[1;33m'
    30→BLUE='\033[0;34m'
    31→NC='\033[0m' # No Color
    32→
    33→# Print functions
    34→print_info() {
    35→    echo -e "${BLUE}[INFO]${NC} $1"
    36→}
    37→
    38→print_success() {
    39→    echo -e "${GREEN}[SUCCESS]${NC} $1"
    40→}
    41→
    42→print_warning() {
    43→    echo -e "${YELLOW}[WARNING]${NC} $1"
    44→}
    45→
    46→print_error() {
    47→    echo -e "${RED}[ERROR]${NC} $1"
    48→}
    49→
    50→# Check prerequisites
    51→check_prerequisites() {
    52→    print_info "Checking prerequisites..."
    53→    
    54→    # Check for ZXPSignCmd
    55→    if ! command -v ZXPSignCmd &> /dev/null; then
    56→        # Check common installation locations
    57→        local zxp_paths=(
    58→            "/Applications/Adobe CC/ZXPSignCmd"
    59→            "$HOME/bin/ZXPSignCmd"
    60→            "/usr/local/bin/ZXPSignCmd"
    61→            "./ZXPSignCmd"
    62→        )
    63→        
    64→        local found=false
    65→        for path in "${zxp_paths[@]}"; do
    66→            if [[ -f "$path" ]]; then
    67→                export PATH="$(dirname "$path"):$PATH"
    68→                found=true
    69→                break
    70→            fi
    71→        done
    72→        
    73→        if [[ "$found" == "false" ]]; then
    74→            print_error "ZXPSignCmd not found in PATH"
    75→            echo ""
    76→            echo "Please download ZXPSignCmd from Adobe and add it to your PATH:"
    77→            echo "  - Download: https://github.com/AdobeDocs/adobeio-runtime/blob/master/resources/ZXPSignCmd.md"
    78→            echo "  - Or use: https://partners.adobe.com/exchangeprogram/creativecloud/support/exman-com-line-tool.html"
    79→            echo ""
    80→            echo "After downloading, you can:"
    81→            echo "  1. Add it to /usr/local/bin/: sudo cp ZXPSignCmd /usr/local/bin/ && sudo chmod +x /usr/local/bin/ZXPSignCmd"
    82→            echo "  2. Or add its location to PATH: export PATH=\"\$PATH:/path/to/ZXPSignCmd\""
    83→            exit 1
    84→        fi
    85→    fi
    86→    
    87→    print_success "ZXPSignCmd found: $(which ZXPSignCmd)"
    88→}
    89→
    90→# Get or prompt for password
    91→get_password() {
    92→    if [[ -n "$ZXP_CERT_PASSWORD" ]]; then
    93→        PASSWORD="$ZXP_CERT_PASSWORD"
    94→        print_info "Using password from ZXP_CERT_PASSWORD environment variable"
    95→    else
    96→        print_warning "No ZXP_CERT_PASSWORD environment variable set"
    97→        echo ""
    98→        read -s -p "Enter certificate password: " PASSWORD
    99→        echo ""
   100→        read -s -p "Confirm password: " PASSWORD_CONFIRM
   101→        echo ""
   102→        
   103→        if [[ "$PASSWORD" != "$PASSWORD_CONFIRM" ]]; then
   104→            print_error "Passwords do not match"
   105→            exit 1
   106→        fi
   107→        
   108→        if [[ -z "$PASSWORD" ]]; then
   109→            print_error "Password cannot be empty"
   110→            exit 1
   111→        fi
   112→    fi
   113→}
   114→
   115→# Create certificate
   116→create_certificate() {
   117→    # Configuration with defaults
   118→    local COUNTRY="${ZXP_CERT_COUNTRY:-US}"
   119→    local STATE="${ZXP_CERT_STATE:-CA}"
   120→    local ORG="${ZXP_CERT_ORG:-SPLICE Inc}"
   121→    local NAME="${ZXP_CERT_NAME:-SPLICE}"
   122→    
   123→    print_info "Creating certificate directory..."
   124→    mkdir -p "$CERT_DIR"
   125→    
   126→    # Check if certificate already exists
   127→    if [[ -f "$CERT_FILE" ]]; then
   128→        if [[ "$1" == "--force" ]]; then
   129→            print_warning "Overwriting existing certificate (--force specified)"
   130→            rm -f "$CERT_FILE"
   131→        else
   132→            print_error "Certificate already exists at: $CERT_FILE"
   133→            echo ""
   134→            echo "Use --force to overwrite, or delete the existing certificate:"
   135→            echo "  rm $CERT_FILE"
   136→            exit 1
   137→        fi
   138→    fi
   139→    
   140→    print_info "Creating self-signed certificate..."
   141→    echo "  Country: $COUNTRY"
   142→    echo "  State: $STATE"
   143→    echo "  Organization: $ORG"
   144→    echo "  Name: $NAME"
   145→    echo "  Output: $CERT_FILE"
   146→    echo ""
   147→    
   148→    # Create the certificate
   149→    ZXPSignCmd -selfSignedCert "$COUNTRY" "$STATE" "$ORG" "$NAME" "$PASSWORD" "$CERT_FILE"
   150→    
   151→    if [[ -f "$CERT_FILE" ]]; then
   152→        print_success "Certificate created successfully!"
   153→        echo ""
   154→        echo "Certificate location: $CERT_FILE"
   155→        echo ""
   156→        print_warning "IMPORTANT: Keep your certificate password secure!"
   157→        echo "For CI/CD, set the ZXP_CERT_PASSWORD environment variable."
   158→        echo ""
   159→        print_info "Next steps:"
   160→        echo "  1. Run ./build/scripts/sign-extension.sh to sign the extension"
   161→        echo "  2. Run ./build/scripts/build-all.sh to build installers"
   162→    else
   163→        print_error "Certificate creation failed"
   164→        exit 1
   165→    fi
   166→}
   167→
   168→# Main execution
   169→main() {
   170→    echo ""
   171→    echo "╔════════════════════════════════════════════════════════════╗"
   172→    echo "║          SPLICE CEP Certificate Creation Tool              ║"
   173→    echo "╚════════════════════════════════════════════════════════════╝"
   174→    echo ""
   175→    
   176→    check_prerequisites
   177→    get_password
   178→    create_certificate "$1"
   179→}
   180→
   181→main "$@"
   182→

</system-reminder>
