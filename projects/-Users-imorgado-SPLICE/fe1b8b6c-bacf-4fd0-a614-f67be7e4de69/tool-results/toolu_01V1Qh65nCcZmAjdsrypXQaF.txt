     1→#!/bin/bash
     2→#
     3→# SPLICE CEP Extension - Signing Script
     4→# Signs the CEP extension using ZXPSignCmd to create a distributable .zxp file
     5→#
     6→# Usage: ./sign-extension.sh [--dev]
     7→#   --dev: Create unsigned development build (no certificate required)
     8→#
     9→# Environment Variables:
    10→#   ZXP_CERT_PASSWORD - Password for the certificate (required unless --dev)
    11→#   ZXP_TIMESTAMP_URL - Timestamp server URL (default: http://timestamp.digicert.com/)
    12→#
    13→
    14→set -e
    15→
    16→# Get script directory and project root
    17→SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    18→PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
    19→BUILD_DIR="$PROJECT_ROOT/build"
    20→CERT_DIR="$BUILD_DIR/certificates"
    21→OUTPUT_DIR="$BUILD_DIR/output"
    22→CEP_SOURCE="$PROJECT_ROOT/splice-cep"
    23→CERT_FILE="$CERT_DIR/splice-cert.p12"
    24→MANIFEST_FILE="$CEP_SOURCE/CSXS/manifest.xml"
    25→
    26→# Default timestamp server
    27→TIMESTAMP_URL="${ZXP_TIMESTAMP_URL:-http://timestamp.digicert.com/}"
    28→
    29→# Colors for output
    30→RED='\033[0;31m'
    31→GREEN='\033[0;32m'
    32→YELLOW='\033[1;33m'
    33→BLUE='\033[0;34m'
    34→NC='\033[0m' # No Color
    35→
    36→# Print functions
    37→print_info() {
    38→    echo -e "${BLUE}[INFO]${NC} $1"
    39→}
    40→
    41→print_success() {
    42→    echo -e "${GREEN}[SUCCESS]${NC} $1"
    43→}
    44→
    45→print_warning() {
    46→    echo -e "${YELLOW}[WARNING]${NC} $1"
    47→}
    48→
    49→print_error() {
    50→    echo -e "${RED}[ERROR]${NC} $1"
    51→}
    52→
    53→# Extract version from manifest.xml
    54→get_version() {
    55→    if [[ -f "$MANIFEST_FILE" ]]; then
    56→        # Extract version from ExtensionBundleVersion attribute
    57→        VERSION=$(grep -o 'ExtensionBundleVersion="[^"]*"' "$MANIFEST_FILE" | cut -d'"' -f2)
    58→        if [[ -z "$VERSION" ]]; then
    59→            print_warning "Could not extract version from manifest.xml, using default"
    60→            VERSION="1.0.0"
    61→        fi
    62→    else
    63→        print_warning "manifest.xml not found, using default version"
    64→        VERSION="1.0.0"
    65→    fi
    66→    echo "$VERSION"
    67→}
    68→
    69→# Check prerequisites
    70→check_prerequisites() {
    71→    print_info "Checking prerequisites..."
    72→    
    73→    # Check for ZXPSignCmd
    74→    if ! command -v ZXPSignCmd &> /dev/null; then
    75→        # Check common installation locations (including project tools directory)
    76→        local zxp_paths=(
    77→            "$PROJECT_ROOT/tools/ZXPSignCmd"
    78→            "/Applications/Adobe CC/ZXPSignCmd"
    79→            "$HOME/bin/ZXPSignCmd"
    80→            "/usr/local/bin/ZXPSignCmd"
    81→            "./ZXPSignCmd"
    82→        )
    83→        
    84→        local found=false
    85→        for path in "${zxp_paths[@]}"; do
    86→            if [[ -f "$path" && -x "$path" ]]; then
    87→                export PATH="$(dirname "$path"):$PATH"
    88→                found=true
    89→                print_info "Found ZXPSignCmd at: $path"
    90→                break
    91→            fi
    92→        done
    93→        
    94→        if [[ "$found" == "false" ]]; then
    95→            print_error "ZXPSignCmd not found in PATH"
    96→            echo ""
    97→            echo "Please download ZXPSignCmd from Adobe and place it in:"
    98→            echo "  $PROJECT_ROOT/tools/ZXPSignCmd"
    99→            echo ""
   100→            echo "Or download from:"
   101→            echo "  https://github.com/AdobeDocs/adobeio-runtime/blob/master/resources/ZXPSignCmd.md"
   102→            exit 1
   103→        fi
   104→    fi
   105→    
   106→    print_success "ZXPSignCmd found: $(which ZXPSignCmd)"
   107→    
   108→    # Check for CEP source
   109→    if [[ ! -d "$CEP_SOURCE" ]]; then
   110→        print_error "CEP source directory not found: $CEP_SOURCE"
   111→        exit 1
   112→    fi
   113→    
   114→    if [[ ! -f "$MANIFEST_FILE" ]]; then
   115→        print_error "Manifest file not found: $MANIFEST_FILE"
   116→        exit 1
   117→    fi
   118→    
   119→    print_success "CEP source found: $CEP_SOURCE"
   120→}
   121→
   122→# Check certificate exists
   123→check_certificate() {
   124→    if [[ ! -f "$CERT_FILE" ]]; then
   125→        print_error "Certificate not found: $CERT_FILE"
   126→        echo ""
   127→        echo "Please create a certificate first by running:"
   128→        echo "  ./build/scripts/create-certificate.sh"
   129→        exit 1
   130→    fi
   131→    
   132→    print_success "Certificate found: $CERT_FILE"
   133→}
   134→
   135→# Get or prompt for password
   136→get_password() {
   137→    if [[ -n "$ZXP_CERT_PASSWORD" ]]; then
   138→        PASSWORD="$ZXP_CERT_PASSWORD"
   139→        print_info "Using password from ZXP_CERT_PASSWORD environment variable"
   140→    else
   141→        print_warning "No ZXP_CERT_PASSWORD environment variable set"
   142→        echo ""
   143→        read -s -p "Enter certificate password: " PASSWORD
   144→        echo ""
   145→        
   146→        if [[ -z "$PASSWORD" ]]; then
   147→            print_error "Password cannot be empty"
   148→            exit 1
   149→        fi
   150→    fi
   151→}
   152→
   153→# Create development (unsigned) build
   154→create_dev_build() {
   155→    VERSION=$(get_version)
   156→    OUTPUT_FILE="$OUTPUT_DIR/splice-v$VERSION-dev.zip"
   157→    
   158→    print_info "Creating development build (unsigned)..."
   159→    echo "  Version: $VERSION"
   160→    echo "  Output: $OUTPUT_FILE"
   161→    
   162→    # Create output directory
   163→    mkdir -p "$OUTPUT_DIR"
   164→    
   165→    # Create zip file
   166→    cd "$PROJECT_ROOT"
   167→    zip -r "$OUTPUT_FILE" splice-cep \
   168→        -x "splice-cep/.git/*" \
   169→        -x "splice-cep/.debug" \
   170→        -x "splice-cep/.debug.rtf" \
   171→        -x "splice-cep/tests/*" \
   172→        -x "splice-cep/*.html" \
   173→        -x "*.DS_Store"
   174→    
   175→    if [[ -f "$OUTPUT_FILE" ]]; then
   176→        print_success "Development build created: $OUTPUT_FILE"
   177→        echo ""
   178→        print_warning "This is an unsigned build for development only."
   179→        echo "Users will need to enable debug mode to install it."
   180→    else
   181→        print_error "Failed to create development build"
   182→        exit 1
   183→    fi
   184→}
   185→
   186→# Sign the extension
   187→sign_extension() {
   188→    VERSION=$(get_version)
   189→    OUTPUT_FILE="$OUTPUT_DIR/splice-v$VERSION.zxp"
   190→    
   191→    print_info "Signing CEP extension..."
   192→    echo "  Version: $VERSION"
   193→    echo "  Source: $CEP_SOURCE"
   194→    echo "  Certificate: $CERT_FILE"
   195→    echo "  Timestamp: $TIMESTAMP_URL"
   196→    echo "  Output: $OUTPUT_FILE"
   197→    echo ""
   198→    
   199→    # Create output directory
   200→    mkdir -p "$OUTPUT_DIR"
   201→    
   202→    # Remove old signed file if exists
   203→    if [[ -f "$OUTPUT_FILE" ]]; then
   204→        print_info "Removing existing signed extension..."
   205→        rm -f "$OUTPUT_FILE"
   206→    fi
   207→    
   208→    # Sign the extension
   209→    print_info "Running ZXPSignCmd..."
   210→    ZXPSignCmd -sign "$CEP_SOURCE" "$OUTPUT_FILE" "$CERT_FILE" "$PASSWORD" -tsa "$TIMESTAMP_URL"
   211→    
   212→    if [[ -f "$OUTPUT_FILE" ]]; then
   213→        # Verify the signature
   214→        print_info "Verifying signature..."
   215→        if ZXPSignCmd -verify "$OUTPUT_FILE" > /dev/null 2>&1; then
   216→            print_success "Signature verified!"
   217→        else
   218→            print_warning "Signature verification returned warnings (may still be valid)"
   219→        fi
   220→        
   221→        FILE_SIZE=$(ls -lh "$OUTPUT_FILE" | awk '{print $5}')
   222→        print_success "Extension signed successfully!"
   223→        echo ""
   224→        echo "  Output: $OUTPUT_FILE"
   225→        echo "  Size: $FILE_SIZE"
   226→        echo ""
   227→        print_info "Next steps:"
   228→        echo "  - Run ./build/scripts/build-macos.sh to create macOS installer"
   229→        echo "  - Run ./build/scripts/build-windows.sh to create Windows installer"
   230→        echo "  - Or run ./build/scripts/build-all.sh to build all installers"
   231→    else
   232→        print_error "Extension signing failed"
   233→        exit 1
   234→    fi
   235→}
   236→
   237→# Main execution
   238→main() {
   239→    echo ""
   240→    echo "╔════════════════════════════════════════════════════════════╗"
   241→    echo "║           SPLICE CEP Extension Signing Tool                ║"
   242→    echo "╚════════════════════════════════════════════════════════════╝"
   243→    echo ""
   244→    
   245→    check_prerequisites
   246→    
   247→    if [[ "$1" == "--dev" ]]; then
   248→        print_info "Creating development build (no signing)..."
   249→        create_dev_build
   250→    else
   251→        check_certificate
   252→        get_password
   253→        sign_extension
   254→    fi
   255→}
   256→
   257→main "$@"
   258→

</system-reminder>
