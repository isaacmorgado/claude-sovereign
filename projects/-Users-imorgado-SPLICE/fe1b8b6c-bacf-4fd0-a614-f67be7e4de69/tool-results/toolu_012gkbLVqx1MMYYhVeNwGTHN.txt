     1→#!/bin/bash
     2→# =============================================================================
     3→# SPLICE PKG Signing and Notarization Script
     4→# =============================================================================
     5→# This script signs a macOS PKG installer with Developer ID Installer certificate
     6→# and submits it to Apple's notary service for notarization.
     7→#
     8→# Prerequisites:
     9→#   - Developer ID Installer certificate installed in Keychain
    10→#   - Apple ID with App-Specific Password for notarization
    11→#   - xcrun notarytool (macOS 12+) or altool (legacy)
    12→#
    13→# Usage:
    14→#   ./sign-and-notarize.sh [options] <unsigned-pkg>
    15→#
    16→# Options:
    17→#   --identity    Certificate identity (default: auto-detect)
    18→#   --apple-id    Apple ID email for notarization
    19→#   --team-id     Apple Developer Team ID
    20→#   --password    App-specific password (or @keychain:name)
    21→#   --no-notarize Skip notarization (signing only)
    22→#   --output      Output path for signed PKG
    23→#   --help        Show this help message
    24→#
    25→# Environment Variables (alternative to options):
    26→#   SIGNING_IDENTITY  - Certificate identity
    27→#   APPLE_ID          - Apple ID email
    28→#   TEAM_ID           - Apple Developer Team ID  
    29→#   APP_PASSWORD      - App-specific password
    30→#
    31→# Example:
    32→#   ./sign-and-notarize.sh \
    33→#     --identity "Developer ID Installer: Your Company (TEAM_ID)" \
    34→#     --apple-id "your@email.com" \
    35→#     --team-id "TEAM_ID" \
    36→#     --password "@keychain:AC_PASSWORD" \
    37→#     dist/SPLICE-Installer-6.0.3.pkg
    38→# =============================================================================
    39→
    40→set -e  # Exit on error
    41→
    42→# Colors for output
    43→RED='\033[0;31m'
    44→GREEN='\033[0;32m'
    45→YELLOW='\033[1;33m'
    46→BLUE='\033[0;34m'
    47→NC='\033[0m' # No Color
    48→
    49→# Script directory
    50→SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    51→PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
    52→
    53→# Default values from environment
    54→SIGNING_IDENTITY="${SIGNING_IDENTITY:-}"
    55→APPLE_ID="${APPLE_ID:-}"
    56→TEAM_ID="${TEAM_ID:-}"
    57→APP_PASSWORD="${APP_PASSWORD:-}"
    58→NOTARIZE=true
    59→INPUT_PKG=""
    60→OUTPUT_PKG=""
    61→
    62→# Logging functions
    63→log_info() {
    64→    echo -e "${BLUE}[INFO]${NC} $1"
    65→}
    66→
    67→log_success() {
    68→    echo -e "${GREEN}[SUCCESS]${NC} $1"
    69→}
    70→
    71→log_warning() {
    72→    echo -e "${YELLOW}[WARNING]${NC} $1"
    73→}
    74→
    75→log_error() {
    76→    echo -e "${RED}[ERROR]${NC} $1"
    77→}
    78→
    79→# Show help
    80→show_help() {
    81→    head -50 "$0" | grep "^#" | sed 's/^# //' | sed 's/^#//'
    82→    exit 0
    83→}
    84→
    85→# Parse command line arguments
    86→parse_args() {
    87→    while [[ $# -gt 0 ]]; do
    88→        case $1 in
    89→            --identity)
    90→                SIGNING_IDENTITY="$2"
    91→                shift 2
    92→                ;;
    93→            --apple-id)
    94→                APPLE_ID="$2"
    95→                shift 2
    96→                ;;
    97→            --team-id)
    98→                TEAM_ID="$2"
    99→                shift 2
   100→                ;;
   101→            --password)
   102→                APP_PASSWORD="$2"
   103→                shift 2
   104→                ;;
   105→            --no-notarize)
   106→                NOTARIZE=false
   107→                shift
   108→                ;;
   109→            --output)
   110→                OUTPUT_PKG="$2"
   111→                shift 2
   112→                ;;
   113→            --help|-h)
   114→                show_help
   115→                ;;
   116→            -*)
   117→                log_error "Unknown option: $1"
   118→                exit 1
   119→                ;;
   120→            *)
   121→                INPUT_PKG="$1"
   122→                shift
   123→                ;;
   124→        esac
   125→    done
   126→}
   127→
   128→# Find Developer ID Installer certificate
   129→find_signing_identity() {
   130→    if [[ -n "$SIGNING_IDENTITY" ]]; then
   131→        log_info "Using specified signing identity: $SIGNING_IDENTITY"
   132→        return
   133→    fi
   134→    
   135→    log_info "Searching for Developer ID Installer certificate..."
   136→    
   137→    # Search for Developer ID Installer certificates
   138→    IDENTITIES=$(security find-identity -v -p basic 2>/dev/null | grep "Developer ID Installer" || true)
   139→    
   140→    if [[ -z "$IDENTITIES" ]]; then
   141→        log_error "No 'Developer ID Installer' certificate found in Keychain!"
   142→        echo ""
   143→        echo "To create a Developer ID Installer certificate:"
   144→        echo "1. Open Keychain Access"
   145→        echo "2. Go to: Keychain Access → Certificate Assistant → Request a Certificate From a Certificate Authority"
   146→        echo "3. Save the CSR file to disk"
   147→        echo "4. Go to: https://developer.apple.com/account/resources/certificates/list"
   148→        echo "5. Click '+' to create a new certificate"
   149→        echo "6. Select 'Developer ID Installer' (NOT Developer ID Application)"
   150→        echo "7. Upload your CSR file"
   151→        echo "8. Download and double-click to install the certificate"
   152→        echo ""
   153→        echo "See: installer/macos/create-app-specific-password.md for detailed instructions"
   154→        exit 1
   155→    fi
   156→    
   157→    # Extract the first certificate
   158→    SIGNING_IDENTITY=$(echo "$IDENTITIES" | head -1 | sed 's/.*"\(.*\)"/\1/')
   159→    log_success "Found signing identity: $SIGNING_IDENTITY"
   160→}
   161→
   162→# Verify input PKG exists
   163→verify_input() {
   164→    if [[ -z "$INPUT_PKG" ]]; then
   165→        log_error "No input PKG file specified!"
   166→        echo "Usage: $0 [options] <unsigned-pkg>"
   167→        exit 1
   168→    fi
   169→    
   170→    if [[ ! -f "$INPUT_PKG" ]]; then
   171→        log_error "Input PKG file not found: $INPUT_PKG"
   172→        exit 1
   173→    fi
   174→    
   175→    log_info "Input PKG: $INPUT_PKG"
   176→    
   177→    # Set output path if not specified
   178→    if [[ -z "$OUTPUT_PKG" ]]; then
   179→        BASENAME=$(basename "$INPUT_PKG" .pkg)
   180→        DIRNAME=$(dirname "$INPUT_PKG")
   181→        OUTPUT_PKG="${DIRNAME}/${BASENAME}-signed.pkg"
   182→    fi
   183→    
   184→    log_info "Output PKG: $OUTPUT_PKG"
   185→}
   186→
   187→# Sign the PKG
   188→sign_pkg() {
   189→    log_info "Signing PKG with productsign..."
   190→    
   191→    # Remove existing signed PKG if it exists
   192→    if [[ -f "$OUTPUT_PKG" ]]; then
   193→        rm "$OUTPUT_PKG"
   194→    fi
   195→    
   196→    # Sign with productsign
   197→    productsign --sign "$SIGNING_IDENTITY" "$INPUT_PKG" "$OUTPUT_PKG"
   198→    
   199→    if [[ $? -eq 0 ]]; then
   200→        log_success "PKG signed successfully!"
   201→    else
   202→        log_error "Failed to sign PKG"
   203→        exit 1
   204→    fi
   205→    
   206→    # Verify signature
   207→    log_info "Verifying signature..."
   208→    pkgutil --check-signature "$OUTPUT_PKG"
   209→    
   210→    if [[ $? -eq 0 ]]; then
   211→        log_success "Signature verified!"
   212→    else
   213→        log_error "Signature verification failed!"
   214→        exit 1
   215→    fi
   216→}
   217→
   218→# Notarize the PKG
   219→notarize_pkg() {
   220→    if [[ "$NOTARIZE" != "true" ]]; then
   221→        log_warning "Skipping notarization (--no-notarize specified)"
   222→        return
   223→    fi
   224→    
   225→    # Check required credentials
   226→    if [[ -z "$APPLE_ID" ]]; then
   227→        log_error "Apple ID not specified! Use --apple-id or set APPLE_ID environment variable"
   228→        exit 1
   229→    fi
   230→    
   231→    if [[ -z "$TEAM_ID" ]]; then
   232→        log_error "Team ID not specified! Use --team-id or set TEAM_ID environment variable"
   233→        exit 1
   234→    fi
   235→    
   236→    if [[ -z "$APP_PASSWORD" ]]; then
   237→        log_error "App-specific password not specified! Use --password or set APP_PASSWORD environment variable"
   238→        echo ""
   239→        echo "See: installer/macos/create-app-specific-password.md for instructions"
   240→        exit 1
   241→    fi
   242→    
   243→    log_info "Submitting to Apple notary service..."
   244→    log_info "This may take several minutes..."
   245→    
   246→    # Submit for notarization using notarytool (macOS 12+)
   247→    if xcrun notarytool --version &>/dev/null; then
   248→        # Use notarytool (preferred, macOS 12+)
   249→        SUBMISSION_OUTPUT=$(xcrun notarytool submit "$OUTPUT_PKG" \
   250→            --apple-id "$APPLE_ID" \
   251→            --team-id "$TEAM_ID" \
   252→            --password "$APP_PASSWORD" \
   253→            --wait 2>&1)
   254→        
   255→        echo "$SUBMISSION_OUTPUT"
   256→        
   257→        # Check if successful
   258→        if echo "$SUBMISSION_OUTPUT" | grep -q "status: Accepted"; then
   259→            log_success "Notarization successful!"
   260→        else
   261→            log_error "Notarization failed!"
   262→            
   263→            # Try to get the log
   264→            SUBMISSION_ID=$(echo "$SUBMISSION_OUTPUT" | grep "id:" | head -1 | awk '{print $2}')
   265→            if [[ -n "$SUBMISSION_ID" ]]; then
   266→                log_info "Fetching notarization log..."
   267→                xcrun notarytool log "$SUBMISSION_ID" \
   268→                    --apple-id "$APPLE_ID" \
   269→                    --team-id "$TEAM_ID" \
   270→                    --password "$APP_PASSWORD"
   271→            fi
   272→            exit 1
   273→        fi
   274→    else
   275→        # Fall back to altool (legacy)
   276→        log_warning "notarytool not found, using altool (legacy)..."
   277→        
   278→        xcrun altool --notarize-app \
   279→            --primary-bundle-id "com.splice.installer" \
   280→            --username "$APPLE_ID" \
   281→            --password "$APP_PASSWORD" \
   282→            --team-id "$TEAM_ID" \
   283→            --file "$OUTPUT_PKG"
   284→        
   285→        log_warning "Notarization submitted. Check status manually with:"
   286→        echo "  xcrun altool --notarization-history 0 -u $APPLE_ID -p <password>"
   287→    fi
   288→}
   289→
   290→# Staple the notarization ticket
   291→staple_pkg() {
   292→    if [[ "$NOTARIZE" != "true" ]]; then
   293→        return
   294→    fi
   295→    
   296→    log_info "Stapling notarization ticket to PKG..."
   297→    
   298→    xcrun stapler staple "$OUTPUT_PKG"
   299→    
   300→    if [[ $? -eq 0 ]]; then
   301→        log_success "Notarization ticket stapled successfully!"
   302→    else
   303→        log_error "Failed to staple notarization ticket"
   304→        exit 1
   305→    fi
   306→}
   307→
   308→# Final verification
   309→final_verification() {
   310→    log_info "Performing final verification..."
   311→    
   312→    echo ""
   313→    echo "=========================================="
   314→    echo "PKG Signature Information:"
   315→    echo "=========================================="
   316→    pkgutil --check-signature "$OUTPUT_PKG"
   317→    
   318→    echo ""
   319→    echo "=========================================="
   320→    echo "Gatekeeper Assessment:"
   321→    echo "=========================================="
   322→    spctl --assess -vv --type install "$OUTPUT_PKG" 2>&1 || true
   323→    
   324→    echo ""
   325→    log_success "All done!"
   326→    echo ""
   327→    echo "Signed PKG: $OUTPUT_PKG"
   328→    echo ""
   329→    echo "You can distribute this PKG. Users on macOS 10.15+ should be able to"
   330→    echo "install it without any Gatekeeper warnings."
   331→}
   332→
   333→# Main execution
   334→main() {
   335→    echo ""
   336→    echo "============================================="
   337→    echo "  SPLICE PKG Signing and Notarization Tool  "
   338→    echo "============================================="
   339→    echo ""
   340→    
   341→    parse_args "$@"
   342→    verify_input
   343→    find_signing_identity
   344→    sign_pkg
   345→    notarize_pkg
   346→    staple_pkg
   347→    final_verification
   348→}
   349→
   350→# Run main
   351→main "$@"
   352→

</system-reminder>
