{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE/splice-cep/panel/js","sessionId":"7fa929e3-00b9-497c-b311-19cb4c6b44f9","version":"2.0.76","gitBranch":"main","agentId":"a43232e","slug":"eager-questing-lagoon","type":"user","message":{"role":"user","content":"Analyze /Users/imorgado/SPLICE/splice-cep/panel/js/socialReframe.js for production bottlenecks:\n\n1. **Video Analysis**: Check if analysis operations timeout properly\n2. **Platform Selection**: Verify no blocking operations on platform changes\n3. **Aspect Ratio Calculations**: Check for expensive calculations\n4. **Export Operations**: Verify JSX calls have proper error handling\n5. **State Management**: Check for race conditions with analysis results\n\nReport issues with line numbers and severity."},"uuid":"53c39698-5c8e-4d80-ac5b-9d6d2e869a27","timestamp":"2026-01-12T16:26:51.371Z"}
{"parentUuid":"53c39698-5c8e-4d80-ac5b-9d6d2e869a27","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE/splice-cep/panel/js","sessionId":"7fa929e3-00b9-497c-b311-19cb4c6b44f9","version":"2.0.76","gitBranch":"main","agentId":"a43232e","slug":"eager-questing-lagoon","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01YDwjwajBcs18ALEVx1S6Qh","type":"message","role":"assistant","content":[{"type":"text","text":"I'll analyze the socialReframe.js file for production bottlenecks."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6725,"cache_read_input_tokens":24136,"cache_creation":{"ephemeral_5m_input_tokens":6725,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX3oCxGbkaPTkxWf2jtpw","type":"assistant","uuid":"b821b116-aae3-4871-99ab-6dc6623ece0f","timestamp":"2026-01-12T16:26:54.339Z"}
{"parentUuid":"b821b116-aae3-4871-99ab-6dc6623ece0f","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE/splice-cep/panel/js","sessionId":"7fa929e3-00b9-497c-b311-19cb4c6b44f9","version":"2.0.76","gitBranch":"main","agentId":"a43232e","slug":"eager-questing-lagoon","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01YDwjwajBcs18ALEVx1S6Qh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RHw2SwW42KQBRpXDPj4mLd","name":"Read","input":{"file_path":"/Users/imorgado/SPLICE/splice-cep/panel/js/socialReframe.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":6725,"cache_read_input_tokens":24136,"cache_creation":{"ephemeral_5m_input_tokens":6725,"ephemeral_1h_input_tokens":0},"output_tokens":94,"service_tier":"standard"}},"requestId":"req_011CX3oCxGbkaPTkxWf2jtpw","type":"assistant","uuid":"01689496-3c43-4f3a-b34c-96f6587e19e5","timestamp":"2026-01-12T16:26:54.887Z"}
{"parentUuid":"01689496-3c43-4f3a-b34c-96f6587e19e5","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE/splice-cep/panel/js","sessionId":"7fa929e3-00b9-497c-b311-19cb4c6b44f9","version":"2.0.76","gitBranch":"main","agentId":"a43232e","slug":"eager-questing-lagoon","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RHw2SwW42KQBRpXDPj4mLd","type":"tool_result","content":"     1→/**\n     2→ * SPLICE CEP Social Reframe Module\n     3→ *\n     4→ * Auto-crops video to vertical/square formats for social media.\n     5→ * Supports TikTok, Instagram Reels, YouTube Shorts with face tracking.\n     6→ */\n     7→\n     8→// ============================================================================\n     9→// STATE\n    10→// ============================================================================\n    11→\n    12→const socialReframeState = {\n    13→  platforms: [],\n    14→  aspectRatios: [],\n    15→  selectedPlatform: 'tiktok',\n    16→  selectedAspectRatio: 'portrait',\n    17→  analysis: null,\n    18→  exportQueue: [],\n    19→  isAnalyzing: false,\n    20→  isExporting: false,\n    21→  currentVideoPath: null,\n    22→  safeZones: null,\n    23→  showSafeZones: false\n    24→};\n    25→\n    26→// ============================================================================\n    27→// DOM ELEMENT CACHE\n    28→// ============================================================================\n    29→\n    30→const reframeElements = {\n    31→  panel: null,\n    32→  platformSelector: null,\n    33→  aspectSelector: null,\n    34→  analysisResults: null,\n    35→  previewCanvas: null,\n    36→  exportResults: null,\n    37→  status: null,\n    38→  analyzeBtn: null,\n    39→  exportBtn: null,\n    40→  exportAllBtn: null,\n    41→  toggleSafeZonesBtn: null,\n    42→  smoothingSlider: null,\n    43→  smoothingDisplay: null\n    44→};\n    45→\n    46→/**\n    47→ * Cache DOM elements for social reframe\n    48→ */\n    49→function cacheReframeElements() {\n    50→  reframeElements.panel = document.getElementById('social-reframe-panel');\n    51→  reframeElements.platformSelector = document.getElementById('reframe-platform-selector');\n    52→  reframeElements.aspectSelector = document.getElementById('reframe-aspect-selector');\n    53→  reframeElements.analysisResults = document.getElementById('reframe-analysis-results');\n    54→  reframeElements.previewCanvas = document.getElementById('reframe-preview-canvas');\n    55→  reframeElements.exportResults = document.getElementById('reframe-export-results');\n    56→  reframeElements.status = document.getElementById('reframe-status');\n    57→  reframeElements.analyzeBtn = document.getElementById('analyze-reframe-btn');\n    58→  reframeElements.exportBtn = document.getElementById('export-reframe-btn');\n    59→  reframeElements.exportAllBtn = document.getElementById('export-all-formats-btn');\n    60→  reframeElements.toggleSafeZonesBtn = document.getElementById('toggle-safe-zones-btn');\n    61→  reframeElements.smoothingSlider = document.getElementById('motion-smoothing-slider');\n    62→  reframeElements.smoothingDisplay = document.getElementById('smoothing-value-display');\n    63→}\n    64→\n    65→// ============================================================================\n    66→// INITIALIZATION\n    67→// ============================================================================\n    68→\n    69→/**\n    70→ * Initialize social reframe module\n    71→ */\n    72→async function initSocialReframe() {\n    73→  console.log('[SPLICE] Initializing social reframe module');\n    74→\n    75→  // Cache DOM elements\n    76→  cacheReframeElements();\n    77→\n    78→  // Load platforms and aspect ratios\n    79→  await loadPlatformPresets();\n    80→\n    81→  // Setup event listeners\n    82→  setupReframeEventListeners();\n    83→\n    84→  // Render platform buttons\n    85→  renderPlatformSelector();\n    86→\n    87→  console.log('[SPLICE] Social reframe module initialized');\n    88→}\n    89→\n    90→/**\n    91→ * Load platform presets from backend\n    92→ */\n    93→async function loadPlatformPresets() {\n    94→  try {\n    95→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n    96→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n    97→\n    98→    const response = await fetchFn(`${backendUrl}/reframe/platforms`, {\n    99→      method: 'GET',\n   100→      headers: { 'Content-Type': 'application/json' }\n   101→    });\n   102→\n   103→    if (response.ok) {\n   104→      const data = await response.json();\n   105→      socialReframeState.platforms = data.platforms || [];\n   106→      socialReframeState.aspectRatios = data.aspectRatios || [];\n   107→      console.log(`[SPLICE] Loaded ${socialReframeState.platforms.length} platforms`);\n   108→    }\n   109→  } catch (err) {\n   110→    console.error('[SPLICE] Failed to load platform presets:', err);\n   111→    // Use fallback presets\n   112→    socialReframeState.platforms = [\n   113→      { id: 'tiktok', name: 'TikTok', aspectRatio: 'portrait', maxDuration: 180 },\n   114→      { id: 'reels', name: 'Instagram Reels', aspectRatio: 'portrait', maxDuration: 90 },\n   115→      { id: 'shorts', name: 'YouTube Shorts', aspectRatio: 'portrait', maxDuration: 60 },\n   116→      { id: 'instagram_feed', name: 'Instagram Feed', aspectRatio: 'square', maxDuration: 60 }\n   117→    ];\n   118→    socialReframeState.aspectRatios = [\n   119→      { id: 'portrait', name: 'Portrait (9:16)', ratio: 0.5625 },\n   120→      { id: 'square', name: 'Square (1:1)', ratio: 1 },\n   121→      { id: 'portrait_4_5', name: 'Portrait (4:5)', ratio: 0.8 }\n   122→    ];\n   123→  }\n   124→}\n   125→\n   126→/**\n   127→ * Setup event listeners\n   128→ */\n   129→function setupReframeEventListeners() {\n   130→  document.addEventListener('click', (e) => {\n   131→    // Platform selection\n   132→    if (e.target.closest('.reframe-platform-btn')) {\n   133→      const btn = e.target.closest('.reframe-platform-btn');\n   134→      const platformId = btn.dataset.platformId;\n   135→      selectPlatform(platformId);\n   136→    }\n   137→\n   138→    // Aspect ratio selection\n   139→    if (e.target.closest('.reframe-aspect-btn')) {\n   140→      const btn = e.target.closest('.reframe-aspect-btn');\n   141→      const aspectId = btn.dataset.aspectId;\n   142→      selectAspectRatio(aspectId);\n   143→    }\n   144→\n   145→    // Analyze button\n   146→    if (e.target.id === 'analyze-reframe-btn') {\n   147→      analyzeForReframe();\n   148→    }\n   149→\n   150→    // Export buttons\n   151→    if (e.target.id === 'export-reframe-btn') {\n   152→      exportReframe();\n   153→    }\n   154→    if (e.target.id === 'export-all-formats-btn') {\n   155→      exportAllFormats();\n   156→    }\n   157→\n   158→    // Preview toggle\n   159→    if (e.target.id === 'toggle-safe-zones-btn') {\n   160→      toggleSafeZones();\n   161→    }\n   162→\n   163→    // Toggle panel collapse\n   164→    if (e.target.closest('.reframe-header')) {\n   165→      const panel = document.getElementById('social-reframe-panel');\n   166→      if (panel) {\n   167→        const isCollapsed = panel.classList.toggle('collapsed');\n   168→        const icon = e.target.closest('.section-toggle')?.querySelector('.toggle-icon');\n   169→        if (icon) {\n   170→          icon.textContent = isCollapsed ? '+' : '-';\n   171→        }\n   172→      }\n   173→    }\n   174→  });\n   175→\n   176→  // Motion smoothing slider\n   177→  document.addEventListener('input', (e) => {\n   178→    if (e.target.id === 'motion-smoothing-slider') {\n   179→      updateSmoothingValue(e.target.value);\n   180→    }\n   181→  });\n   182→}\n   183→\n   184→// ============================================================================\n   185→// PLATFORM & ASPECT RATIO SELECTION\n   186→// ============================================================================\n   187→\n   188→/**\n   189→ * SECURITY: Escape HTML to prevent XSS\n   190→ */\n   191→function escapeHtmlReframe(str) {\n   192→  if (!str) return '';\n   193→  const div = document.createElement('div');\n   194→  div.textContent = str;\n   195→  return div.innerHTML;\n   196→}\n   197→\n   198→/**\n   199→ * Render platform selector buttons\n   200→ */\n   201→function renderPlatformSelector() {\n   202→  const container = reframeElements.platformSelector || document.getElementById('reframe-platform-selector');\n   203→  if (!container) return;\n   204→\n   205→  // SECURITY: Escape platform data to prevent XSS\n   206→  const html = socialReframeState.platforms.map(platform => {\n   207→    const safeId = escapeHtmlReframe(platform.id);\n   208→    const safeName = escapeHtmlReframe(platform.name);\n   209→    return `\n   210→    <button class=\"reframe-platform-btn ${socialReframeState.selectedPlatform === platform.id ? 'selected' : ''}\"\n   211→            data-platform-id=\"${safeId}\"\n   212→            aria-label=\"Select ${safeName}\">\n   213→      <span class=\"platform-icon platform-icon-${safeId}\"></span>\n   214→      <span class=\"platform-name\">${safeName}</span>\n   215→    </button>\n   216→  `;\n   217→  }).join('');\n   218→\n   219→  container.innerHTML = html;\n   220→\n   221→  // Also render aspect ratio buttons\n   222→  renderAspectRatioSelector();\n   223→}\n   224→\n   225→/**\n   226→ * Render aspect ratio selector\n   227→ */\n   228→function renderAspectRatioSelector() {\n   229→  const container = reframeElements.aspectSelector || document.getElementById('reframe-aspect-selector');\n   230→  if (!container) return;\n   231→\n   232→  // SECURITY: Escape aspect ratio data to prevent XSS\n   233→  const html = socialReframeState.aspectRatios.map(aspect => {\n   234→    const safeId = escapeHtmlReframe(aspect.id);\n   235→    const safeName = escapeHtmlReframe(aspect.name);\n   236→    return `\n   237→    <button class=\"reframe-aspect-btn ${socialReframeState.selectedAspectRatio === aspect.id ? 'selected' : ''}\"\n   238→            data-aspect-id=\"${safeId}\"\n   239→            aria-label=\"Select ${safeName}\">\n   240→      <span class=\"aspect-preview aspect-preview-${safeId}\"></span>\n   241→      <span class=\"aspect-name\">${safeName}</span>\n   242→    </button>\n   243→  `;\n   244→  }).join('');\n   245→\n   246→  container.innerHTML = html;\n   247→}\n   248→\n   249→/**\n   250→ * Select platform\n   251→ */\n   252→function selectPlatform(platformId) {\n   253→  const platform = socialReframeState.platforms.find(p => p.id === platformId);\n   254→  if (!platform) return;\n   255→\n   256→  socialReframeState.selectedPlatform = platformId;\n   257→  socialReframeState.selectedAspectRatio = platform.aspectRatio;\n   258→\n   259→  // Update UI\n   260→  document.querySelectorAll('.reframe-platform-btn').forEach(btn => {\n   261→    btn.classList.toggle('selected', btn.dataset.platformId === platformId);\n   262→  });\n   263→\n   264→  renderAspectRatioSelector();\n   265→  loadSafeZones(platformId);\n   266→\n   267→  console.log(`[SPLICE] Selected platform: ${platform.name}`);\n   268→}\n   269→\n   270→/**\n   271→ * Select aspect ratio\n   272→ */\n   273→function selectAspectRatio(aspectId) {\n   274→  socialReframeState.selectedAspectRatio = aspectId;\n   275→\n   276→  document.querySelectorAll('.reframe-aspect-btn').forEach(btn => {\n   277→    btn.classList.toggle('selected', btn.dataset.aspectId === aspectId);\n   278→  });\n   279→\n   280→  // Update preview if available\n   281→  if (socialReframeState.analysis) {\n   282→    updateCropPreview();\n   283→  }\n   284→\n   285→  console.log(`[SPLICE] Selected aspect ratio: ${aspectId}`);\n   286→}\n   287→\n   288→/**\n   289→ * Load safe zones for platform\n   290→ */\n   291→async function loadSafeZones(platformId) {\n   292→  try {\n   293→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n   294→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n   295→\n   296→    const response = await fetchFn(`${backendUrl}/reframe/safe-zones/${platformId}`, {\n   297→      method: 'GET',\n   298→      headers: { 'Content-Type': 'application/json' }\n   299→    });\n   300→\n   301→    if (response.ok) {\n   302→      const data = await response.json();\n   303→      socialReframeState.safeZones = data;\n   304→      renderSafeZoneOverlay();\n   305→    }\n   306→  } catch (err) {\n   307→    console.error('[SPLICE] Failed to load safe zones:', err);\n   308→  }\n   309→}\n   310→\n   311→// ============================================================================\n   312→// ANALYSIS\n   313→// ============================================================================\n   314→\n   315→/**\n   316→ * Analyze current video for reframe\n   317→ */\n   318→async function analyzeForReframe() {\n   319→  // Check tier access - Social Reframe requires Pro or Team\n   320→  if (typeof hasFeatureAccess === 'function' && !hasFeatureAccess('social_reframe')) {\n   321→    const requiredTier = typeof getRequiredTier === 'function' ? getRequiredTier('social_reframe') : 'Pro';\n   322→    showReframeStatus(`Social Reframe requires ${requiredTier} tier or higher`, 'error');\n   323→    if (typeof showUpgradeModal === 'function') {\n   324→      showUpgradeModal('Social Reframe', requiredTier);\n   325→    }\n   326→    return;\n   327→  }\n   328→\n   329→  const videoPath = getCurrentVideoPath();\n   330→  if (!videoPath) {\n   331→    showReframeStatus('No video selected', 'error');\n   332→    return;\n   333→  }\n   334→\n   335→  socialReframeState.isAnalyzing = true;\n   336→  updateAnalyzeButton(true);\n   337→  showReframeStatus('Analyzing video for face tracking...', 'info');\n   338→\n   339→  try {\n   340→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n   341→    const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };\n   342→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n   343→\n   344→    const slider = reframeElements.smoothingSlider || document.getElementById('motion-smoothing-slider');\n   345→    const smoothing = slider?.value || 0.3;\n   346→\n   347→    const response = await fetchFn(`${backendUrl}/reframe/analyze`, {\n   348→      method: 'POST',\n   349→      headers,\n   350→      body: JSON.stringify({\n   351→        videoPath,\n   352→        options: {\n   353→          sampleRate: 0.5,\n   354→          smoothing: parseFloat(smoothing)\n   355→        }\n   356→      })\n   357→    });\n   358→\n   359→    if (!response.ok) {\n   360→      const err = await response.json();\n   361→      throw new Error(err.error || 'Analysis failed');\n   362→    }\n   363→\n   364→    const data = await response.json();\n   365→    socialReframeState.analysis = data;\n   366→    socialReframeState.currentVideoPath = videoPath;\n   367→\n   368→    // Update UI\n   369→    renderAnalysisResults(data);\n   370→    updateCropPreview();\n   371→    showReframeStatus(`Found ${data.faceTracking.tracksFound} face(s)`, 'success');\n   372→\n   373→  } catch (err) {\n   374→    console.error('[SPLICE] Reframe analysis error:', err);\n   375→    showReframeStatus(err.message, 'error');\n   376→  } finally {\n   377→    socialReframeState.isAnalyzing = false;\n   378→    updateAnalyzeButton(false);\n   379→  }\n   380→}\n   381→\n   382→/**\n   383→ * Get current video path from main module or JSX\n   384→ */\n   385→function getCurrentVideoPath() {\n   386→  // Try to get from main module state\n   387→  if (window.spliceState?.currentVideoPath) {\n   388→    return window.spliceState.currentVideoPath;\n   389→  }\n   390→\n   391→  // Try from active sequence\n   392→  if (window.spliceState?.activeSequence?.projectItem?.treePath) {\n   393→    return window.spliceState.activeSequence.projectItem.treePath;\n   394→  }\n   395→\n   396→  return socialReframeState.currentVideoPath;\n   397→}\n   398→\n   399→/**\n   400→ * Set video path for reframe\n   401→ */\n   402→function setVideoPath(videoPath) {\n   403→  socialReframeState.currentVideoPath = videoPath;\n   404→}\n   405→\n   406→/**\n   407→ * Render analysis results\n   408→ */\n   409→function renderAnalysisResults(analysis) {\n   410→  const container = reframeElements.analysisResults || document.getElementById('reframe-analysis-results');\n   411→  if (!container) return;\n   412→\n   413→  // SECURITY: Escape analysis data to prevent XSS\n   414→  const html = `\n   415→    <div class=\"analysis-summary\">\n   416→      <div class=\"analysis-stat\">\n   417→        <span class=\"stat-label\">Faces Found</span>\n   418→        <span class=\"stat-value\">${escapeHtmlReframe(String(analysis.faceTracking.tracksFound))}</span>\n   419→      </div>\n   420→      <div class=\"analysis-stat\">\n   421→        <span class=\"stat-label\">Video Duration</span>\n   422→        <span class=\"stat-value\">${escapeHtmlReframe(formatDuration(analysis.videoInfo.duration))}</span>\n   423→      </div>\n   424→      <div class=\"analysis-stat\">\n   425→        <span class=\"stat-label\">Resolution</span>\n   426→        <span class=\"stat-value\">${escapeHtmlReframe(String(analysis.videoInfo.width))}x${escapeHtmlReframe(String(analysis.videoInfo.height))}</span>\n   427→      </div>\n   428→    </div>\n   429→    <div class=\"analysis-formats\">\n   430→      ${Object.entries(analysis.suggestions).map(([key, suggestion]) => `\n   431→        <div class=\"format-suggestion\" data-format=\"${escapeHtmlReframe(key)}\">\n   432→          <span class=\"format-name\">${escapeHtmlReframe(getAspectRatioName(key))}</span>\n   433→          <span class=\"format-method\">${escapeHtmlReframe(suggestion.method)}</span>\n   434→          <span class=\"format-keyframes\">${escapeHtmlReframe(String(suggestion.totalKeyframes || 0))} keyframes</span>\n   435→        </div>\n   436→      `).join('')}\n   437→    </div>\n   438→  `;\n   439→\n   440→  container.innerHTML = html;\n   441→}\n   442→\n   443→/**\n   444→ * Get aspect ratio name\n   445→ */\n   446→function getAspectRatioName(id) {\n   447→  const aspect = socialReframeState.aspectRatios.find(a => a.id === id);\n   448→  return aspect?.name || id;\n   449→}\n   450→\n   451→// ============================================================================\n   452→// PREVIEW\n   453→// ============================================================================\n   454→\n   455→/**\n   456→ * Update crop preview canvas\n   457→ */\n   458→function updateCropPreview() {\n   459→  const canvas = reframeElements.previewCanvas || document.getElementById('reframe-preview-canvas');\n   460→  if (!canvas || !socialReframeState.analysis) return;\n   461→\n   462→  const ctx = canvas.getContext('2d');\n   463→  const { videoInfo, suggestions } = socialReframeState.analysis;\n   464→  const aspectId = socialReframeState.selectedAspectRatio;\n   465→  const suggestion = suggestions[aspectId];\n   466→\n   467→  if (!suggestion) return;\n   468→\n   469→  // Clear canvas\n   470→  ctx.clearRect(0, 0, canvas.width, canvas.height);\n   471→\n   472→  // Draw video frame representation\n   473→  const scale = Math.min(canvas.width / videoInfo.width, canvas.height / videoInfo.height);\n   474→  const videoW = videoInfo.width * scale;\n   475→  const videoH = videoInfo.height * scale;\n   476→  const videoX = (canvas.width - videoW) / 2;\n   477→  const videoY = (canvas.height - videoH) / 2;\n   478→\n   479→  // Draw video background\n   480→  ctx.fillStyle = '#333';\n   481→  ctx.fillRect(videoX, videoY, videoW, videoH);\n   482→\n   483→  // Draw crop region\n   484→  const crop = suggestion.static ? suggestion.crop : suggestion.keyframes[0]?.crop;\n   485→  if (crop) {\n   486→    ctx.strokeStyle = '#00ff00';\n   487→    ctx.lineWidth = 2;\n   488→    ctx.strokeRect(\n   489→      videoX + crop.x * videoW,\n   490→      videoY + crop.y * videoH,\n   491→      crop.width * videoW,\n   492→      crop.height * videoH\n   493→    );\n   494→\n   495→    // Draw face indicator\n   496→    if (socialReframeState.analysis.faceTracking.tracks[0]) {\n   497→      const face = socialReframeState.analysis.faceTracking.tracks[0].positions[0];\n   498→      if (face) {\n   499→        ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';\n   500→        ctx.fillRect(\n   501→          videoX + face.x * videoW,\n   502→          videoY + face.y * videoH,\n   503→          face.width * videoW,\n   504→          face.height * videoH\n   505→        );\n   506→      }\n   507→    }\n   508→  }\n   509→\n   510→  // Draw safe zones if enabled\n   511→  if (socialReframeState.showSafeZones && socialReframeState.safeZones) {\n   512→    renderSafeZoneOnCanvas(ctx, videoX, videoY, videoW, videoH);\n   513→  }\n   514→}\n   515→\n   516→/**\n   517→ * Render safe zone overlay on canvas\n   518→ */\n   519→function renderSafeZoneOnCanvas(ctx, x, y, width, height) {\n   520→  const sz = socialReframeState.safeZones.safeZone;\n   521→  if (!sz) return;\n   522→\n   523→  ctx.fillStyle = 'rgba(255, 0, 0, 0.15)';\n   524→\n   525→  // Top safe zone\n   526→  ctx.fillRect(x, y, width, height * sz.top);\n   527→\n   528→  // Bottom safe zone\n   529→  ctx.fillRect(x, y + height * (1 - sz.bottom), width, height * sz.bottom);\n   530→\n   531→  // Left safe zone\n   532→  ctx.fillRect(x, y, width * sz.left, height);\n   533→\n   534→  // Right safe zone\n   535→  ctx.fillRect(x + width * (1 - sz.right), y, width * sz.right, height);\n   536→}\n   537→\n   538→/**\n   539→ * Render safe zone overlay\n   540→ */\n   541→function renderSafeZoneOverlay() {\n   542→  updateCropPreview();\n   543→}\n   544→\n   545→/**\n   546→ * Toggle safe zones visibility\n   547→ */\n   548→function toggleSafeZones() {\n   549→  socialReframeState.showSafeZones = !socialReframeState.showSafeZones;\n   550→  updateCropPreview();\n   551→\n   552→  const btn = reframeElements.toggleSafeZonesBtn || document.getElementById('toggle-safe-zones-btn');\n   553→  if (btn) {\n   554→    btn.classList.toggle('active', socialReframeState.showSafeZones);\n   555→  }\n   556→}\n   557→\n   558→// ============================================================================\n   559→// EXPORT\n   560→// ============================================================================\n   561→\n   562→/**\n   563→ * Export for selected format\n   564→ */\n   565→async function exportReframe() {\n   566→  if (!socialReframeState.analysis) {\n   567→    showReframeStatus('Analyze video first', 'error');\n   568→    return;\n   569→  }\n   570→\n   571→  socialReframeState.isExporting = true;\n   572→  updateExportButton(true);\n   573→  showReframeStatus('Generating export data...', 'info');\n   574→\n   575→  try {\n   576→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n   577→    const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };\n   578→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n   579→\n   580→    const slider = reframeElements.smoothingSlider || document.getElementById('motion-smoothing-slider');\n   581→    const smoothing = slider?.value || 0.3;\n   582→\n   583→    const response = await fetchFn(`${backendUrl}/reframe/export`, {\n   584→      method: 'POST',\n   585→      headers,\n   586→      body: JSON.stringify({\n   587→        videoPath: socialReframeState.currentVideoPath,\n   588→        formats: [socialReframeState.selectedAspectRatio],\n   589→        settings: {\n   590→          quality: 'high',\n   591→          motionSmoothing: parseFloat(smoothing)\n   592→        }\n   593→      })\n   594→    });\n   595→\n   596→    if (!response.ok) {\n   597→      const err = await response.json();\n   598→      throw new Error(err.error || 'Export failed');\n   599→    }\n   600→\n   601→    const data = await response.json();\n   602→    renderExportResults(data);\n   603→    showReframeStatus('Export data generated', 'success');\n   604→\n   605→  } catch (err) {\n   606→    console.error('[SPLICE] Reframe export error:', err);\n   607→    showReframeStatus(err.message, 'error');\n   608→  } finally {\n   609→    socialReframeState.isExporting = false;\n   610→    updateExportButton(false);\n   611→  }\n   612→}\n   613→\n   614→/**\n   615→ * Export all formats at once\n   616→ */\n   617→async function exportAllFormats() {\n   618→  if (!socialReframeState.analysis) {\n   619→    showReframeStatus('Analyze video first', 'error');\n   620→    return;\n   621→  }\n   622→\n   623→  const allFormats = socialReframeState.aspectRatios.map(a => a.id);\n   624→\n   625→  socialReframeState.isExporting = true;\n   626→  updateExportButton(true);\n   627→  showReframeStatus('Generating all formats...', 'info');\n   628→\n   629→  try {\n   630→    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n   631→    const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };\n   632→    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n   633→\n   634→    const response = await fetchFn(`${backendUrl}/reframe/export`, {\n   635→      method: 'POST',\n   636→      headers,\n   637→      body: JSON.stringify({\n   638→        videoPath: socialReframeState.currentVideoPath,\n   639→        formats: allFormats,\n   640→        settings: { quality: 'high' }\n   641→      })\n   642→    });\n   643→\n   644→    if (!response.ok) {\n   645→      const err = await response.json();\n   646→      throw new Error(err.error || 'Export failed');\n   647→    }\n   648→\n   649→    const data = await response.json();\n   650→    renderExportResults(data);\n   651→    showReframeStatus(`Generated ${data.totalFormats} formats`, 'success');\n   652→\n   653→  } catch (err) {\n   654→    console.error('[SPLICE] Reframe batch export error:', err);\n   655→    showReframeStatus(err.message, 'error');\n   656→  } finally {\n   657→    socialReframeState.isExporting = false;\n   658→    updateExportButton(false);\n   659→  }\n   660→}\n   661→\n   662→/**\n   663→ * Render export results\n   664→ */\n   665→function renderExportResults(data) {\n   666→  const container = reframeElements.exportResults || document.getElementById('reframe-export-results');\n   667→  if (!container) return;\n   668→\n   669→  // SECURITY: Escape export data to prevent XSS\n   670→  const html = `\n   671→    <div class=\"export-summary\">\n   672→      <span class=\"export-count\">${escapeHtmlReframe(String(data.totalFormats))} format(s) ready</span>\n   673→    </div>\n   674→    <div class=\"export-list\">\n   675→      ${data.exports.map(exp => `\n   676→        <div class=\"export-item\">\n   677→          <span class=\"export-format\">${escapeHtmlReframe(exp.name)}</span>\n   678→          <span class=\"export-dims\">${escapeHtmlReframe(String(exp.dimensions.width))}x${escapeHtmlReframe(String(exp.dimensions.height))}</span>\n   679→          <button class=\"copy-ffmpeg-btn btn btn-small\" data-filter=\"${encodeURIComponent(exp.ffmpegFilter)}\">\n   680→            Copy FFmpeg\n   681→          </button>\n   682→        </div>\n   683→      `).join('')}\n   684→    </div>\n   685→  `;\n   686→\n   687→  container.innerHTML = html;\n   688→\n   689→  // Add copy handlers\n   690→  container.querySelectorAll('.copy-ffmpeg-btn').forEach(btn => {\n   691→    btn.addEventListener('click', () => {\n   692→      const filter = decodeURIComponent(btn.dataset.filter);\n   693→      navigator.clipboard.writeText(filter).then(() => {\n   694→        btn.textContent = 'Copied!';\n   695→        setTimeout(() => btn.textContent = 'Copy FFmpeg', 2000);\n   696→      });\n   697→    });\n   698→  });\n   699→}\n   700→\n   701→// ============================================================================\n   702→// UI HELPERS\n   703→// ============================================================================\n   704→\n   705→/**\n   706→ * Show status message\n   707→ */\n   708→function showReframeStatus(message, type = 'info') {\n   709→  const statusEl = reframeElements.status || document.getElementById('reframe-status');\n   710→  if (!statusEl) return;\n   711→\n   712→  statusEl.textContent = message;\n   713→  statusEl.className = `reframe-status reframe-status-${type}`;\n   714→\n   715→  if (type !== 'error') {\n   716→    setTimeout(() => {\n   717→      statusEl.textContent = '';\n   718→      statusEl.className = 'reframe-status';\n   719→    }, 5000);\n   720→  }\n   721→}\n   722→\n   723→/**\n   724→ * Update analyze button state\n   725→ */\n   726→function updateAnalyzeButton(isAnalyzing) {\n   727→  const btn = reframeElements.analyzeBtn || document.getElementById('analyze-reframe-btn');\n   728→  if (!btn) return;\n   729→\n   730→  btn.disabled = isAnalyzing;\n   731→  btn.textContent = isAnalyzing ? 'Analyzing...' : 'Analyze Video';\n   732→}\n   733→\n   734→/**\n   735→ * Update export button state\n   736→ */\n   737→function updateExportButton(isExporting) {\n   738→  const btn = reframeElements.exportBtn || document.getElementById('export-reframe-btn');\n   739→  if (!btn) return;\n   740→\n   741→  btn.disabled = isExporting;\n   742→  btn.textContent = isExporting ? 'Exporting...' : 'Export';\n   743→}\n   744→\n   745→/**\n   746→ * Update smoothing value display\n   747→ */\n   748→function updateSmoothingValue(value) {\n   749→  const display = reframeElements.smoothingDisplay || document.getElementById('smoothing-value-display');\n   750→  if (display) {\n   751→    display.textContent = parseFloat(value).toFixed(2);\n   752→  }\n   753→}\n   754→\n   755→/**\n   756→ * Format duration for display\n   757→ */\n   758→function formatDuration(seconds) {\n   759→  const mins = Math.floor(seconds / 60);\n   760→  const secs = Math.floor(seconds % 60);\n   761→  return `${mins}:${secs.toString().padStart(2, '0')}`;\n   762→}\n   763→\n   764→// ============================================================================\n   765→// EXPORTS\n   766→// ============================================================================\n   767→\n   768→// Export for global access\n   769→window.spliceSocialReframe = {\n   770→  init: initSocialReframe,\n   771→  analyze: analyzeForReframe,\n   772→  setVideoPath: setVideoPath,\n   773→  selectPlatform: selectPlatform,\n   774→  selectAspectRatio: selectAspectRatio,\n   775→  export: exportReframe,\n   776→  exportAll: exportAllFormats,\n   777→  toggleSafeZones: toggleSafeZones,\n   778→  getState: () => ({ ...socialReframeState })\n   779→};\n   780→\n   781→// Also expose individual functions for direct access\n   782→window.initSocialReframe = initSocialReframe;\n   783→\n\n</system-reminder>\n"}]},"uuid":"de5e61b0-1a5d-4d93-b6cb-bdc233f69ad4","timestamp":"2026-01-12T16:26:54.913Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/imorgado/SPLICE/splice-cep/panel/js/socialReframe.js","content":"/**\n * SPLICE CEP Social Reframe Module\n *\n * Auto-crops video to vertical/square formats for social media.\n * Supports TikTok, Instagram Reels, YouTube Shorts with face tracking.\n */\n\n// ============================================================================\n// STATE\n// ============================================================================\n\nconst socialReframeState = {\n  platforms: [],\n  aspectRatios: [],\n  selectedPlatform: 'tiktok',\n  selectedAspectRatio: 'portrait',\n  analysis: null,\n  exportQueue: [],\n  isAnalyzing: false,\n  isExporting: false,\n  currentVideoPath: null,\n  safeZones: null,\n  showSafeZones: false\n};\n\n// ============================================================================\n// DOM ELEMENT CACHE\n// ============================================================================\n\nconst reframeElements = {\n  panel: null,\n  platformSelector: null,\n  aspectSelector: null,\n  analysisResults: null,\n  previewCanvas: null,\n  exportResults: null,\n  status: null,\n  analyzeBtn: null,\n  exportBtn: null,\n  exportAllBtn: null,\n  toggleSafeZonesBtn: null,\n  smoothingSlider: null,\n  smoothingDisplay: null\n};\n\n/**\n * Cache DOM elements for social reframe\n */\nfunction cacheReframeElements() {\n  reframeElements.panel = document.getElementById('social-reframe-panel');\n  reframeElements.platformSelector = document.getElementById('reframe-platform-selector');\n  reframeElements.aspectSelector = document.getElementById('reframe-aspect-selector');\n  reframeElements.analysisResults = document.getElementById('reframe-analysis-results');\n  reframeElements.previewCanvas = document.getElementById('reframe-preview-canvas');\n  reframeElements.exportResults = document.getElementById('reframe-export-results');\n  reframeElements.status = document.getElementById('reframe-status');\n  reframeElements.analyzeBtn = document.getElementById('analyze-reframe-btn');\n  reframeElements.exportBtn = document.getElementById('export-reframe-btn');\n  reframeElements.exportAllBtn = document.getElementById('export-all-formats-btn');\n  reframeElements.toggleSafeZonesBtn = document.getElementById('toggle-safe-zones-btn');\n  reframeElements.smoothingSlider = document.getElementById('motion-smoothing-slider');\n  reframeElements.smoothingDisplay = document.getElementById('smoothing-value-display');\n}\n\n// ============================================================================\n// INITIALIZATION\n// ============================================================================\n\n/**\n * Initialize social reframe module\n */\nasync function initSocialReframe() {\n  console.log('[SPLICE] Initializing social reframe module');\n\n  // Cache DOM elements\n  cacheReframeElements();\n\n  // Load platforms and aspect ratios\n  await loadPlatformPresets();\n\n  // Setup event listeners\n  setupReframeEventListeners();\n\n  // Render platform buttons\n  renderPlatformSelector();\n\n  console.log('[SPLICE] Social reframe module initialized');\n}\n\n/**\n * Load platform presets from backend\n */\nasync function loadPlatformPresets() {\n  try {\n    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n\n    const response = await fetchFn(`${backendUrl}/reframe/platforms`, {\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' }\n    });\n\n    if (response.ok) {\n      const data = await response.json();\n      socialReframeState.platforms = data.platforms || [];\n      socialReframeState.aspectRatios = data.aspectRatios || [];\n      console.log(`[SPLICE] Loaded ${socialReframeState.platforms.length} platforms`);\n    }\n  } catch (err) {\n    console.error('[SPLICE] Failed to load platform presets:', err);\n    // Use fallback presets\n    socialReframeState.platforms = [\n      { id: 'tiktok', name: 'TikTok', aspectRatio: 'portrait', maxDuration: 180 },\n      { id: 'reels', name: 'Instagram Reels', aspectRatio: 'portrait', maxDuration: 90 },\n      { id: 'shorts', name: 'YouTube Shorts', aspectRatio: 'portrait', maxDuration: 60 },\n      { id: 'instagram_feed', name: 'Instagram Feed', aspectRatio: 'square', maxDuration: 60 }\n    ];\n    socialReframeState.aspectRatios = [\n      { id: 'portrait', name: 'Portrait (9:16)', ratio: 0.5625 },\n      { id: 'square', name: 'Square (1:1)', ratio: 1 },\n      { id: 'portrait_4_5', name: 'Portrait (4:5)', ratio: 0.8 }\n    ];\n  }\n}\n\n/**\n * Setup event listeners\n */\nfunction setupReframeEventListeners() {\n  document.addEventListener('click', (e) => {\n    // Platform selection\n    if (e.target.closest('.reframe-platform-btn')) {\n      const btn = e.target.closest('.reframe-platform-btn');\n      const platformId = btn.dataset.platformId;\n      selectPlatform(platformId);\n    }\n\n    // Aspect ratio selection\n    if (e.target.closest('.reframe-aspect-btn')) {\n      const btn = e.target.closest('.reframe-aspect-btn');\n      const aspectId = btn.dataset.aspectId;\n      selectAspectRatio(aspectId);\n    }\n\n    // Analyze button\n    if (e.target.id === 'analyze-reframe-btn') {\n      analyzeForReframe();\n    }\n\n    // Export buttons\n    if (e.target.id === 'export-reframe-btn') {\n      exportReframe();\n    }\n    if (e.target.id === 'export-all-formats-btn') {\n      exportAllFormats();\n    }\n\n    // Preview toggle\n    if (e.target.id === 'toggle-safe-zones-btn') {\n      toggleSafeZones();\n    }\n\n    // Toggle panel collapse\n    if (e.target.closest('.reframe-header')) {\n      const panel = document.getElementById('social-reframe-panel');\n      if (panel) {\n        const isCollapsed = panel.classList.toggle('collapsed');\n        const icon = e.target.closest('.section-toggle')?.querySelector('.toggle-icon');\n        if (icon) {\n          icon.textContent = isCollapsed ? '+' : '-';\n        }\n      }\n    }\n  });\n\n  // Motion smoothing slider\n  document.addEventListener('input', (e) => {\n    if (e.target.id === 'motion-smoothing-slider') {\n      updateSmoothingValue(e.target.value);\n    }\n  });\n}\n\n// ============================================================================\n// PLATFORM & ASPECT RATIO SELECTION\n// ============================================================================\n\n/**\n * SECURITY: Escape HTML to prevent XSS\n */\nfunction escapeHtmlReframe(str) {\n  if (!str) return '';\n  const div = document.createElement('div');\n  div.textContent = str;\n  return div.innerHTML;\n}\n\n/**\n * Render platform selector buttons\n */\nfunction renderPlatformSelector() {\n  const container = reframeElements.platformSelector || document.getElementById('reframe-platform-selector');\n  if (!container) return;\n\n  // SECURITY: Escape platform data to prevent XSS\n  const html = socialReframeState.platforms.map(platform => {\n    const safeId = escapeHtmlReframe(platform.id);\n    const safeName = escapeHtmlReframe(platform.name);\n    return `\n    <button class=\"reframe-platform-btn ${socialReframeState.selectedPlatform === platform.id ? 'selected' : ''}\"\n            data-platform-id=\"${safeId}\"\n            aria-label=\"Select ${safeName}\">\n      <span class=\"platform-icon platform-icon-${safeId}\"></span>\n      <span class=\"platform-name\">${safeName}</span>\n    </button>\n  `;\n  }).join('');\n\n  container.innerHTML = html;\n\n  // Also render aspect ratio buttons\n  renderAspectRatioSelector();\n}\n\n/**\n * Render aspect ratio selector\n */\nfunction renderAspectRatioSelector() {\n  const container = reframeElements.aspectSelector || document.getElementById('reframe-aspect-selector');\n  if (!container) return;\n\n  // SECURITY: Escape aspect ratio data to prevent XSS\n  const html = socialReframeState.aspectRatios.map(aspect => {\n    const safeId = escapeHtmlReframe(aspect.id);\n    const safeName = escapeHtmlReframe(aspect.name);\n    return `\n    <button class=\"reframe-aspect-btn ${socialReframeState.selectedAspectRatio === aspect.id ? 'selected' : ''}\"\n            data-aspect-id=\"${safeId}\"\n            aria-label=\"Select ${safeName}\">\n      <span class=\"aspect-preview aspect-preview-${safeId}\"></span>\n      <span class=\"aspect-name\">${safeName}</span>\n    </button>\n  `;\n  }).join('');\n\n  container.innerHTML = html;\n}\n\n/**\n * Select platform\n */\nfunction selectPlatform(platformId) {\n  const platform = socialReframeState.platforms.find(p => p.id === platformId);\n  if (!platform) return;\n\n  socialReframeState.selectedPlatform = platformId;\n  socialReframeState.selectedAspectRatio = platform.aspectRatio;\n\n  // Update UI\n  document.querySelectorAll('.reframe-platform-btn').forEach(btn => {\n    btn.classList.toggle('selected', btn.dataset.platformId === platformId);\n  });\n\n  renderAspectRatioSelector();\n  loadSafeZones(platformId);\n\n  console.log(`[SPLICE] Selected platform: ${platform.name}`);\n}\n\n/**\n * Select aspect ratio\n */\nfunction selectAspectRatio(aspectId) {\n  socialReframeState.selectedAspectRatio = aspectId;\n\n  document.querySelectorAll('.reframe-aspect-btn').forEach(btn => {\n    btn.classList.toggle('selected', btn.dataset.aspectId === aspectId);\n  });\n\n  // Update preview if available\n  if (socialReframeState.analysis) {\n    updateCropPreview();\n  }\n\n  console.log(`[SPLICE] Selected aspect ratio: ${aspectId}`);\n}\n\n/**\n * Load safe zones for platform\n */\nasync function loadSafeZones(platformId) {\n  try {\n    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n\n    const response = await fetchFn(`${backendUrl}/reframe/safe-zones/${platformId}`, {\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' }\n    });\n\n    if (response.ok) {\n      const data = await response.json();\n      socialReframeState.safeZones = data;\n      renderSafeZoneOverlay();\n    }\n  } catch (err) {\n    console.error('[SPLICE] Failed to load safe zones:', err);\n  }\n}\n\n// ============================================================================\n// ANALYSIS\n// ============================================================================\n\n/**\n * Analyze current video for reframe\n */\nasync function analyzeForReframe() {\n  // Check tier access - Social Reframe requires Pro or Team\n  if (typeof hasFeatureAccess === 'function' && !hasFeatureAccess('social_reframe')) {\n    const requiredTier = typeof getRequiredTier === 'function' ? getRequiredTier('social_reframe') : 'Pro';\n    showReframeStatus(`Social Reframe requires ${requiredTier} tier or higher`, 'error');\n    if (typeof showUpgradeModal === 'function') {\n      showUpgradeModal('Social Reframe', requiredTier);\n    }\n    return;\n  }\n\n  const videoPath = getCurrentVideoPath();\n  if (!videoPath) {\n    showReframeStatus('No video selected', 'error');\n    return;\n  }\n\n  socialReframeState.isAnalyzing = true;\n  updateAnalyzeButton(true);\n  showReframeStatus('Analyzing video for face tracking...', 'info');\n\n  try {\n    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n    const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };\n    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n\n    const slider = reframeElements.smoothingSlider || document.getElementById('motion-smoothing-slider');\n    const smoothing = slider?.value || 0.3;\n\n    const response = await fetchFn(`${backendUrl}/reframe/analyze`, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify({\n        videoPath,\n        options: {\n          sampleRate: 0.5,\n          smoothing: parseFloat(smoothing)\n        }\n      })\n    });\n\n    if (!response.ok) {\n      const err = await response.json();\n      throw new Error(err.error || 'Analysis failed');\n    }\n\n    const data = await response.json();\n    socialReframeState.analysis = data;\n    socialReframeState.currentVideoPath = videoPath;\n\n    // Update UI\n    renderAnalysisResults(data);\n    updateCropPreview();\n    showReframeStatus(`Found ${data.faceTracking.tracksFound} face(s)`, 'success');\n\n  } catch (err) {\n    console.error('[SPLICE] Reframe analysis error:', err);\n    showReframeStatus(err.message, 'error');\n  } finally {\n    socialReframeState.isAnalyzing = false;\n    updateAnalyzeButton(false);\n  }\n}\n\n/**\n * Get current video path from main module or JSX\n */\nfunction getCurrentVideoPath() {\n  // Try to get from main module state\n  if (window.spliceState?.currentVideoPath) {\n    return window.spliceState.currentVideoPath;\n  }\n\n  // Try from active sequence\n  if (window.spliceState?.activeSequence?.projectItem?.treePath) {\n    return window.spliceState.activeSequence.projectItem.treePath;\n  }\n\n  return socialReframeState.currentVideoPath;\n}\n\n/**\n * Set video path for reframe\n */\nfunction setVideoPath(videoPath) {\n  socialReframeState.currentVideoPath = videoPath;\n}\n\n/**\n * Render analysis results\n */\nfunction renderAnalysisResults(analysis) {\n  const container = reframeElements.analysisResults || document.getElementById('reframe-analysis-results');\n  if (!container) return;\n\n  // SECURITY: Escape analysis data to prevent XSS\n  const html = `\n    <div class=\"analysis-summary\">\n      <div class=\"analysis-stat\">\n        <span class=\"stat-label\">Faces Found</span>\n        <span class=\"stat-value\">${escapeHtmlReframe(String(analysis.faceTracking.tracksFound))}</span>\n      </div>\n      <div class=\"analysis-stat\">\n        <span class=\"stat-label\">Video Duration</span>\n        <span class=\"stat-value\">${escapeHtmlReframe(formatDuration(analysis.videoInfo.duration))}</span>\n      </div>\n      <div class=\"analysis-stat\">\n        <span class=\"stat-label\">Resolution</span>\n        <span class=\"stat-value\">${escapeHtmlReframe(String(analysis.videoInfo.width))}x${escapeHtmlReframe(String(analysis.videoInfo.height))}</span>\n      </div>\n    </div>\n    <div class=\"analysis-formats\">\n      ${Object.entries(analysis.suggestions).map(([key, suggestion]) => `\n        <div class=\"format-suggestion\" data-format=\"${escapeHtmlReframe(key)}\">\n          <span class=\"format-name\">${escapeHtmlReframe(getAspectRatioName(key))}</span>\n          <span class=\"format-method\">${escapeHtmlReframe(suggestion.method)}</span>\n          <span class=\"format-keyframes\">${escapeHtmlReframe(String(suggestion.totalKeyframes || 0))} keyframes</span>\n        </div>\n      `).join('')}\n    </div>\n  `;\n\n  container.innerHTML = html;\n}\n\n/**\n * Get aspect ratio name\n */\nfunction getAspectRatioName(id) {\n  const aspect = socialReframeState.aspectRatios.find(a => a.id === id);\n  return aspect?.name || id;\n}\n\n// ============================================================================\n// PREVIEW\n// ============================================================================\n\n/**\n * Update crop preview canvas\n */\nfunction updateCropPreview() {\n  const canvas = reframeElements.previewCanvas || document.getElementById('reframe-preview-canvas');\n  if (!canvas || !socialReframeState.analysis) return;\n\n  const ctx = canvas.getContext('2d');\n  const { videoInfo, suggestions } = socialReframeState.analysis;\n  const aspectId = socialReframeState.selectedAspectRatio;\n  const suggestion = suggestions[aspectId];\n\n  if (!suggestion) return;\n\n  // Clear canvas\n  ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n  // Draw video frame representation\n  const scale = Math.min(canvas.width / videoInfo.width, canvas.height / videoInfo.height);\n  const videoW = videoInfo.width * scale;\n  const videoH = videoInfo.height * scale;\n  const videoX = (canvas.width - videoW) / 2;\n  const videoY = (canvas.height - videoH) / 2;\n\n  // Draw video background\n  ctx.fillStyle = '#333';\n  ctx.fillRect(videoX, videoY, videoW, videoH);\n\n  // Draw crop region\n  const crop = suggestion.static ? suggestion.crop : suggestion.keyframes[0]?.crop;\n  if (crop) {\n    ctx.strokeStyle = '#00ff00';\n    ctx.lineWidth = 2;\n    ctx.strokeRect(\n      videoX + crop.x * videoW,\n      videoY + crop.y * videoH,\n      crop.width * videoW,\n      crop.height * videoH\n    );\n\n    // Draw face indicator\n    if (socialReframeState.analysis.faceTracking.tracks[0]) {\n      const face = socialReframeState.analysis.faceTracking.tracks[0].positions[0];\n      if (face) {\n        ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';\n        ctx.fillRect(\n          videoX + face.x * videoW,\n          videoY + face.y * videoH,\n          face.width * videoW,\n          face.height * videoH\n        );\n      }\n    }\n  }\n\n  // Draw safe zones if enabled\n  if (socialReframeState.showSafeZones && socialReframeState.safeZones) {\n    renderSafeZoneOnCanvas(ctx, videoX, videoY, videoW, videoH);\n  }\n}\n\n/**\n * Render safe zone overlay on canvas\n */\nfunction renderSafeZoneOnCanvas(ctx, x, y, width, height) {\n  const sz = socialReframeState.safeZones.safeZone;\n  if (!sz) return;\n\n  ctx.fillStyle = 'rgba(255, 0, 0, 0.15)';\n\n  // Top safe zone\n  ctx.fillRect(x, y, width, height * sz.top);\n\n  // Bottom safe zone\n  ctx.fillRect(x, y + height * (1 - sz.bottom), width, height * sz.bottom);\n\n  // Left safe zone\n  ctx.fillRect(x, y, width * sz.left, height);\n\n  // Right safe zone\n  ctx.fillRect(x + width * (1 - sz.right), y, width * sz.right, height);\n}\n\n/**\n * Render safe zone overlay\n */\nfunction renderSafeZoneOverlay() {\n  updateCropPreview();\n}\n\n/**\n * Toggle safe zones visibility\n */\nfunction toggleSafeZones() {\n  socialReframeState.showSafeZones = !socialReframeState.showSafeZones;\n  updateCropPreview();\n\n  const btn = reframeElements.toggleSafeZonesBtn || document.getElementById('toggle-safe-zones-btn');\n  if (btn) {\n    btn.classList.toggle('active', socialReframeState.showSafeZones);\n  }\n}\n\n// ============================================================================\n// EXPORT\n// ============================================================================\n\n/**\n * Export for selected format\n */\nasync function exportReframe() {\n  if (!socialReframeState.analysis) {\n    showReframeStatus('Analyze video first', 'error');\n    return;\n  }\n\n  socialReframeState.isExporting = true;\n  updateExportButton(true);\n  showReframeStatus('Generating export data...', 'info');\n\n  try {\n    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n    const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };\n    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n\n    const slider = reframeElements.smoothingSlider || document.getElementById('motion-smoothing-slider');\n    const smoothing = slider?.value || 0.3;\n\n    const response = await fetchFn(`${backendUrl}/reframe/export`, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify({\n        videoPath: socialReframeState.currentVideoPath,\n        formats: [socialReframeState.selectedAspectRatio],\n        settings: {\n          quality: 'high',\n          motionSmoothing: parseFloat(smoothing)\n        }\n      })\n    });\n\n    if (!response.ok) {\n      const err = await response.json();\n      throw new Error(err.error || 'Export failed');\n    }\n\n    const data = await response.json();\n    renderExportResults(data);\n    showReframeStatus('Export data generated', 'success');\n\n  } catch (err) {\n    console.error('[SPLICE] Reframe export error:', err);\n    showReframeStatus(err.message, 'error');\n  } finally {\n    socialReframeState.isExporting = false;\n    updateExportButton(false);\n  }\n}\n\n/**\n * Export all formats at once\n */\nasync function exportAllFormats() {\n  if (!socialReframeState.analysis) {\n    showReframeStatus('Analyze video first', 'error');\n    return;\n  }\n\n  const allFormats = socialReframeState.aspectRatios.map(a => a.id);\n\n  socialReframeState.isExporting = true;\n  updateExportButton(true);\n  showReframeStatus('Generating all formats...', 'info');\n\n  try {\n    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n    const headers = typeof getAuthHeaders === 'function' ? getAuthHeaders() : { 'Content-Type': 'application/json' };\n    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n\n    const response = await fetchFn(`${backendUrl}/reframe/export`, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify({\n        videoPath: socialReframeState.currentVideoPath,\n        formats: allFormats,\n        settings: { quality: 'high' }\n      })\n    });\n\n    if (!response.ok) {\n      const err = await response.json();\n      throw new Error(err.error || 'Export failed');\n    }\n\n    const data = await response.json();\n    renderExportResults(data);\n    showReframeStatus(`Generated ${data.totalFormats} formats`, 'success');\n\n  } catch (err) {\n    console.error('[SPLICE] Reframe batch export error:', err);\n    showReframeStatus(err.message, 'error');\n  } finally {\n    socialReframeState.isExporting = false;\n    updateExportButton(false);\n  }\n}\n\n/**\n * Render export results\n */\nfunction renderExportResults(data) {\n  const container = reframeElements.exportResults || document.getElementById('reframe-export-results');\n  if (!container) return;\n\n  // SECURITY: Escape export data to prevent XSS\n  const html = `\n    <div class=\"export-summary\">\n      <span class=\"export-count\">${escapeHtmlReframe(String(data.totalFormats))} format(s) ready</span>\n    </div>\n    <div class=\"export-list\">\n      ${data.exports.map(exp => `\n        <div class=\"export-item\">\n          <span class=\"export-format\">${escapeHtmlReframe(exp.name)}</span>\n          <span class=\"export-dims\">${escapeHtmlReframe(String(exp.dimensions.width))}x${escapeHtmlReframe(String(exp.dimensions.height))}</span>\n          <button class=\"copy-ffmpeg-btn btn btn-small\" data-filter=\"${encodeURIComponent(exp.ffmpegFilter)}\">\n            Copy FFmpeg\n          </button>\n        </div>\n      `).join('')}\n    </div>\n  `;\n\n  container.innerHTML = html;\n\n  // Add copy handlers\n  container.querySelectorAll('.copy-ffmpeg-btn').forEach(btn => {\n    btn.addEventListener('click', () => {\n      const filter = decodeURIComponent(btn.dataset.filter);\n      navigator.clipboard.writeText(filter).then(() => {\n        btn.textContent = 'Copied!';\n        setTimeout(() => btn.textContent = 'Copy FFmpeg', 2000);\n      });\n    });\n  });\n}\n\n// ============================================================================\n// UI HELPERS\n// ============================================================================\n\n/**\n * Show status message\n */\nfunction showReframeStatus(message, type = 'info') {\n  const statusEl = reframeElements.status || document.getElementById('reframe-status');\n  if (!statusEl) return;\n\n  statusEl.textContent = message;\n  statusEl.className = `reframe-status reframe-status-${type}`;\n\n  if (type !== 'error') {\n    setTimeout(() => {\n      statusEl.textContent = '';\n      statusEl.className = 'reframe-status';\n    }, 5000);\n  }\n}\n\n/**\n * Update analyze button state\n */\nfunction updateAnalyzeButton(isAnalyzing) {\n  const btn = reframeElements.analyzeBtn || document.getElementById('analyze-reframe-btn');\n  if (!btn) return;\n\n  btn.disabled = isAnalyzing;\n  btn.textContent = isAnalyzing ? 'Analyzing...' : 'Analyze Video';\n}\n\n/**\n * Update export button state\n */\nfunction updateExportButton(isExporting) {\n  const btn = reframeElements.exportBtn || document.getElementById('export-reframe-btn');\n  if (!btn) return;\n\n  btn.disabled = isExporting;\n  btn.textContent = isExporting ? 'Exporting...' : 'Export';\n}\n\n/**\n * Update smoothing value display\n */\nfunction updateSmoothingValue(value) {\n  const display = reframeElements.smoothingDisplay || document.getElementById('smoothing-value-display');\n  if (display) {\n    display.textContent = parseFloat(value).toFixed(2);\n  }\n}\n\n/**\n * Format duration for display\n */\nfunction formatDuration(seconds) {\n  const mins = Math.floor(seconds / 60);\n  const secs = Math.floor(seconds % 60);\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\n// Export for global access\nwindow.spliceSocialReframe = {\n  init: initSocialReframe,\n  analyze: analyzeForReframe,\n  setVideoPath: setVideoPath,\n  selectPlatform: selectPlatform,\n  selectAspectRatio: selectAspectRatio,\n  export: exportReframe,\n  exportAll: exportAllFormats,\n  toggleSafeZones: toggleSafeZones,\n  getState: () => ({ ...socialReframeState })\n};\n\n// Also expose individual functions for direct access\nwindow.initSocialReframe = initSocialReframe;\n","numLines":783,"startLine":1,"totalLines":783}}}
{"parentUuid":"de5e61b0-1a5d-4d93-b6cb-bdc233f69ad4","isSidechain":true,"userType":"external","cwd":"/Users/imorgado/SPLICE/splice-cep/panel/js","sessionId":"7fa929e3-00b9-497c-b311-19cb4c6b44f9","version":"2.0.76","gitBranch":"main","agentId":"a43232e","slug":"eager-questing-lagoon","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_016e4FWLwsgxgarT78H7qf3X","type":"message","role":"assistant","content":[{"type":"text","text":"# Production Bottleneck Analysis: socialReframe.js\n\n## Bug Summary\nThe socialReframe.js module contains **multiple critical production bottlenecks** that can cause timeouts, race conditions, and blocking operations.\n\n---\n\n## Root Cause Analysis\n\n### 1. ⛔ **CRITICAL: No Timeout on Video Analysis** (Lines 347-357)\n**Severity**: CRITICAL  \n**Impact**: Analysis operations can hang indefinitely\n\n#### Trace Path\n1. User clicks \"Analyze Video\" → `analyzeForReframe()` called (line 318)\n2. → Fetch request to `/reframe/analyze` (line 347)\n3. → **NO TIMEOUT SET** even when `fetchWithTimeout` is available\n4. → Long-running face detection can hang for minutes\n5. → UI becomes unresponsive, button stays disabled\n\n#### The Bug\n```javascript\n// Line 347 - Using fetchWithTimeout but NO timeout parameter\nconst response = await fetchFn(`${backendUrl}/reframe/analyze`, {\n  method: 'POST',\n  headers,\n  body: JSON.stringify({\n    videoPath,\n    options: {\n      sampleRate: 0.5,\n      smoothing: parseFloat(smoothing)\n    }\n  })\n  // ⛔ MISSING: timeout parameter\n});\n```\n\n**Root Cause**: Face detection analysis can take 30+ seconds on long videos. Without a timeout, the request can hang indefinitely if:\n- Backend processing stalls\n- Network connection drops\n- Video file is corrupted/large\n\n#### Fix\n```javascript\nconst response = await fetchFn(`${backendUrl}/reframe/analyze`, {\n  method: 'POST',\n  headers,\n  body: JSON.stringify({\n    videoPath,\n    options: {\n      sampleRate: 0.5,\n      smoothing: parseFloat(smoothing)\n    }\n  })\n}, 90000); // 90 second timeout for video analysis\n```\n\n---\n\n### 2. ⛔ **CRITICAL: No Timeout on Export Operations** (Lines 583-594, 634-642)\n**Severity**: CRITICAL  \n**Impact**: Export operations can hang indefinitely\n\n#### Trace Path\n1. User clicks \"Export\" → `exportReframe()` called (line 565)\n2. → Fetch request to `/reframe/export` (line 583)\n3. → **NO TIMEOUT SET**\n4. → Export generation can take minutes\n5. → Button stays disabled forever\n\n#### The Bug (Two Instances)\n```javascript\n// Line 583 - Single export\nconst response = await fetchFn(`${backendUrl}/reframe/export`, {\n  method: 'POST',\n  headers,\n  body: JSON.stringify({...})\n  // ⛔ MISSING: timeout parameter\n});\n\n// Line 634 - Batch export (all formats)\nconst response = await fetchFn(`${backendUrl}/reframe/export`, {\n  method: 'POST',\n  headers,\n  body: JSON.stringify({...})\n  // ⛔ MISSING: timeout parameter\n});\n```\n\n**Root Cause**: Export operations generate crop keyframes for entire video, which is CPU-intensive.\n\n#### Fix\n```javascript\n// Single export (line 583)\nconst response = await fetchFn(`${backendUrl}/reframe/export`, {\n  method: 'POST',\n  headers,\n  body: JSON.stringify({...})\n}, 120000); // 2 minute timeout\n\n// Batch export (line 634)\nconst response = await fetchFn(`${backendUrl}/reframe/export`, {\n  method: 'POST',\n  headers,\n  body: JSON.stringify({...})\n}, 180000); // 3 minute timeout (multiple formats)\n```\n\n---\n\n### 3. ⚠️ **HIGH: Race Condition in Platform Selection** (Lines 252-268)\n**Severity**: HIGH  \n**Impact**: Async safe zone loading can update state after user selects different platform\n\n#### Trace Path\n1. User clicks Platform A → `selectPlatform('A')` called (line 252)\n2. → State updated to Platform A (line 256-257)\n3. → UI updated (line 260-264)\n4. → `loadSafeZones('A')` called asynchronously (line 265)\n5. User immediately clicks Platform B → `selectPlatform('B')` called\n6. → State updated to Platform B\n7. → `loadSafeZones('B')` called\n8. → **Safe zones for Platform A finish loading AFTER Platform B selected**\n9. → `socialReframeState.safeZones` now contains Platform A data for Platform B\n\n#### The Bug\n```javascript\nfunction selectPlatform(platformId) {\n  const platform = socialReframeState.platforms.find(p => p.id === platformId);\n  if (!platform) return;\n\n  socialReframeState.selectedPlatform = platformId;\n  socialReframeState.selectedAspectRatio = platform.aspectRatio;\n\n  // Update UI\n  document.querySelectorAll('.reframe-platform-btn').forEach(btn => {\n    btn.classList.toggle('selected', btn.dataset.platformId === platformId);\n  });\n\n  renderAspectRatioSelector();\n  loadSafeZones(platformId); // ⛔ ASYNC - no await, no cancellation\n\n  console.log(`[SPLICE] Selected platform: ${platform.name}`);\n}\n```\n\n#### Fix\n```javascript\n// Add cancellation tracking\nlet currentSafeZoneRequest = null;\n\nasync function selectPlatform(platformId) {\n  const platform = socialReframeState.platforms.find(p => p.id === platformId);\n  if (!platform) return;\n\n  socialReframeState.selectedPlatform = platformId;\n  socialReframeState.selectedAspectRatio = platform.aspectRatio;\n\n  // Update UI\n  document.querySelectorAll('.reframe-platform-btn').forEach(btn => {\n    btn.classList.toggle('selected', btn.dataset.platformId === platformId);\n  });\n\n  renderAspectRatioSelector();\n  \n  // Cancel previous safe zone request\n  if (currentSafeZoneRequest) {\n    currentSafeZoneRequest.cancelled = true;\n  }\n  \n  // Track new request\n  const request = { cancelled: false, platformId };\n  currentSafeZoneRequest = request;\n  \n  await loadSafeZones(platformId, request);\n\n  console.log(`[SPLICE] Selected platform: ${platform.name}`);\n}\n\nasync function loadSafeZones(platformId, request) {\n  try {\n    const backendUrl = typeof getBackendUrl === 'function' ? getBackendUrl() : 'https://127.0.0.1:3847';\n    const fetchFn = typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch;\n\n    const response = await fetchFn(`${backendUrl}/reframe/safe-zones/${platformId}`, {\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' }\n    }, 10000); // 10 second timeout\n\n    // Check if request was cancelled\n    if (request && request.cancelled) {\n      console.log('[SPLICE] Safe zone request cancelled');\n      return;\n    }\n\n    if (response.ok) {\n      const data = await response.json();\n      \n      // Double-check platform still matches\n      if (!request || !request.cancelled && socialReframeState.selectedPlatform === platformId) {\n        socialReframeState.safeZones = data;\n        renderSafeZoneOverlay();\n      }\n    }\n  } catch (err) {\n    if (!request || !request.cancelled) {\n      console.error('[SPLICE] Failed to load safe zones:', err);\n    }\n  }\n}\n```\n\n---\n\n### 4. ⚠️ **MEDIUM: Blocking DOM Manipulation in Platform Selection** (Line 260-262)\n**Severity**: MEDIUM  \n**Impact**: UI can freeze with many platform buttons\n\n#### The Bug\n```javascript\n// Line 260 - Synchronous DOM query and manipulation\ndocument.querySelectorAll('.reframe-platform-btn').forEach(btn => {\n  btn.classList.toggle('selected', btn.dataset.platformId === platformId);\n});\n```\n\n**Root Cause**: `querySelectorAll` + `forEach` is synchronous and blocks the main thread. With many platforms, this causes perceptible lag.\n\n#### Fix\n```javascript\n// Use event delegation (already handled in line 130-136)\n// Just update the single clicked button instead of querying all\nfunction selectPlatform(platformId, clickedButton) {\n  const platform = socialReframeState.platforms.find(p => p.id === platformId);\n  if (!platform) return;\n\n  socialReframeState.selectedPlatform = platformId;\n  socialReframeState.selectedAspectRatio = platform.aspectRatio;\n\n  // Update only the clicked button and previously selected\n  const prevSelected = document.querySelector('.reframe-platform-btn.selected');\n  if (prevSelected) prevSelected.classList.remove('selected');\n  if (clickedButton) clickedButton.classList.add('selected');\n\n  renderAspectRatioSelector();\n  loadSafeZones(platformId);\n}\n\n// Update event handler (line 132-136)\nif (e.target.closest('.reframe-platform-btn')) {\n  const btn = e.target.closest('.reframe-platform-btn');\n  const platformId = btn.dataset.platformId;\n  selectPlatform(platformId, btn); // Pass button reference\n}\n```\n\n---\n\n### 5. ⚠️ **MEDIUM: Race Condition in Preview Updates** (Lines 281-283)\n**Severity**: MEDIUM  \n**Impact**: Preview can show wrong aspect ratio after rapid selections\n\n#### Trace Path\n1. User has analysis results loaded\n2. User clicks Aspect Ratio A → `selectAspectRatio('A')` (line 273)\n3. → State updated to A (line 274)\n4. → UI updated (line 276-278)\n5. → `updateCropPreview()` called (line 282)\n6. User immediately clicks Aspect Ratio B → `selectAspectRatio('B')` called\n7. → State updated to B\n8. → Second `updateCropPreview()` called\n9. → **Canvas rendering is not atomic - first preview can partially render after state changed**\n\n#### The Bug\n```javascript\nfunction selectAspectRatio(aspectId) {\n  socialReframeState.selectedAspectRatio = aspectId;\n\n  document.querySelectorAll('.reframe-aspect-btn').forEach(btn => {\n    btn.classList.toggle('selected', btn.dataset.aspectId === aspectId);\n  });\n\n  // Update preview if available\n  if (socialReframeState.analysis) {\n    updateCropPreview(); // ⛔ No debouncing, no cancellation\n  }\n\n  console.log(`[SPLICE] Selected aspect ratio: ${aspectId}`);\n}\n```\n\n#### Fix\n```javascript\nlet previewUpdateTimer = null;\n\nfunction selectAspectRatio(aspectId) {\n  socialReframeState.selectedAspectRatio = aspectId;\n\n  document.querySelectorAll('.reframe-aspect-btn').forEach(btn => {\n    btn.classList.toggle('selected', btn.dataset.aspectId === aspectId);\n  });\n\n  // Debounce preview update\n  if (previewUpdateTimer) {\n    clearTimeout(previewUpdateTimer);\n  }\n  \n  if (socialReframeState.analysis) {\n    previewUpdateTimer = setTimeout(() => {\n      updateCropPreview();\n      previewUpdateTimer = null;\n    }, 100); // 100ms debounce\n  }\n\n  console.log(`[SPLICE] Selected aspect ratio: ${aspectId}`);\n}\n```\n\n---\n\n### 6. ⚠️ **MEDIUM: Expensive Canvas Operations Without Debouncing** (Lines 458-514)\n**Severity**: MEDIUM  \n**Impact**: Canvas rendering can block UI during rapid interactions\n\n#### The Bug\n```javascript\nfunction updateCropPreview() {\n  const canvas = reframeElements.previewCanvas || document.getElementById('reframe-preview-canvas');\n  if (!canvas || !socialReframeState.analysis) return;\n\n  const ctx = canvas.getContext('2d');\n  // ... expensive calculations (line 463-477)\n  \n  // Multiple canvas draw calls (lines 480-508)\n  ctx.clearRect(0, 0, canvas.width, canvas.height);\n  ctx.fillRect(videoX, videoY, videoW, videoH);\n  ctx.strokeRect(...);\n  ctx.fillRect(...);\n  \n  // Additional safe zone rendering (line 511-513)\n  if (socialReframeState.showSafeZones && socialReframeState.safeZones) {\n    renderSafeZoneOnCanvas(ctx, videoX, videoY, videoW, videoH);\n  }\n}\n```\n\n**Root Cause**: Called from multiple places without debouncing:\n- `selectAspectRatio()` (line 282)\n- `renderSafeZoneOverlay()` (line 542)\n- `toggleSafeZones()` (line 550)\n\n#### Fix\nAlready addressed in Fix #5 above for `selectAspectRatio()`. Apply same pattern to other callers:\n\n```javascript\nlet previewUpdateTimer = null;\n\nfunction debouncedPreviewUpdate() {\n  if (previewUpdateTimer) {\n    clearTimeout(previewUpdateTimer);\n  }\n  previewUpdateTimer = setTimeout(() => {\n    updateCropPreview();\n    previewUpdateTimer = null;\n  }, 100);\n}\n\n// Update all callers\nfunction selectAspectRatio(aspectId) {\n  // ... state updates ...\n  if (socialReframeState.analysis) {\n    debouncedPreviewUpdate();\n  }\n}\n\nfunction toggleSafeZones() {\n  socialReframeState.showSafeZones = !socialReframeState.showSafeZones;\n  debouncedPreviewUpdate();\n  // ... button update ...\n}\n\nfunction renderSafeZoneOverlay() {\n  debouncedPreviewUpdate();\n}\n```\n\n---\n\n### 7. ⚠️ **LOW: No Timeout on Platform/Safe Zone Loading** (Lines 93-101, 291-299)\n**Severity**: LOW  \n**Impact**: Initialization can hang if backend is slow\n\n#### The Bug (Two Instances)\n```javascript\n// Line 98 - No timeout\nconst response = await fetchFn(`${backendUrl}/reframe/platforms`, {\n  method: 'GET',\n  headers: { 'Content-Type': 'application/json' }\n  // ⛔ MISSING: timeout parameter\n});\n\n// Line 296 - No timeout\nconst response = await fetchFn(`${backendUrl}/reframe/safe-zones/${platformId}`, {\n  method: 'GET',\n  headers: { 'Content-Type': 'application/json' }\n  // ⛔ MISSING: timeout parameter\n});\n```\n\n#### Fix\n```javascript\n// Line 98\nconst response = await fetchFn(`${backendUrl}/reframe/platforms`, {\n  method: 'GET',\n  headers: { 'Content-Type': 'application/json' }\n}, 10000); // 10 second timeout\n\n// Line 296 (already fixed in Fix #3)\nconst response = await fetchFn(`${backendUrl}/reframe/safe-zones/${platformId}`, {\n  method: 'GET',\n  headers: { 'Content-Type': 'application/json' }\n}, 10000); // 10 second timeout\n```\n\n---\n\n### 8. ✅ **GOOD: Proper Error Handling on Analysis/Export** (Lines 373-379, 605-611, 653-659)\nAll critical operations have proper try/catch with finally blocks:\n- State flags reset in finally (lines 377-378, 609-610, 657-658)\n- UI updated correctly (lines 378, 610, 658)\n- Errors logged and displayed (lines 374-375, 606-607, 654-655)\n\n---\n\n## Summary of Issues\n\n| Issue | Line(s) | Severity | Impact |\n|-------|---------|----------|--------|\n| No timeout on video analysis | 347-357 | ⛔ CRITICAL | Operations hang indefinitely |\n| No timeout on export operations | 583-594, 634-642 | ⛔ CRITICAL | UI becomes unresponsive |\n| Race condition in platform selection | 252-268 | ⚠️ HIGH | Wrong safe zones loaded |\n| Blocking DOM manipulation | 260-262, 276-278 | ⚠️ MEDIUM | UI lag with many buttons |\n| Race condition in preview updates | 281-283 | ⚠️ MEDIUM | Wrong preview rendered |\n| Expensive canvas operations | 458-514 | ⚠️ MEDIUM | UI blocked during rendering |\n| No timeout on platform/safe zone loading | 98, 296 | ⚠️ LOW | Initialization hangs |\n\n---\n\n## Regression Test\n\n```javascript\n// Test 1: Analysis timeout\nasync function testAnalysisTimeout() {\n  const mockFetch = async (url, options, timeout) => {\n    if (!timeout) throw new Error('No timeout set');\n    return { ok: true, json: async () => ({}) };\n  };\n  window.fetchWithTimeout = mockFetch;\n  \n  await analyzeForReframe();\n  console.assert(mockFetch.called, 'Analysis should use timeout');\n}\n\n// Test 2: Platform selection race\nasync function testPlatformRace() {\n  await initSocialReframe();\n  \n  // Rapidly switch platforms\n  selectPlatform('tiktok');\n  selectPlatform('reels');\n  selectPlatform('shorts');\n  \n  // Wait for async operations\n  await new Promise(resolve => setTimeout(resolve, 1000));\n  \n  // Safe zones should match current platform\n  console.assert(\n    socialReframeState.selectedPlatform === 'shorts',\n    'Current platform should be shorts'\n  );\n}\n\n// Test 3: Preview debouncing\nasync function testPreviewDebounce() {\n  let renderCount = 0;\n  const originalUpdate = updateCropPreview;\n  window.updateCropPreview = () => { renderCount++; };\n  \n  // Rapidly change aspect ratios\n  for (let i = 0; i < 10; i++) {\n    selectAspectRatio('portrait');\n    selectAspectRatio('square');\n  }\n  \n  await new Promise(resolve => setTimeout(resolve, 500));\n  \n  console.assert(\n    renderCount < 5,\n    'Preview should be debounced (got ' + renderCount + ' renders)'\n  );\n  \n  window.updateCropPreview = originalUpdate;\n}\n```\n\n---\n\n## Prevention\n\n1. **Timeout Enforcement**: Add ESLint rule to require timeout parameter on all `fetchWithTimeout` calls\n2. **Race Condition Detection**: Add request tracking pattern to all async UI update functions\n3. **Performance Monitoring**: Add canvas render time logging to detect slow operations\n4. **State Invariants**: Assert that `socialReframeState.safeZones` platform ID matches `socialReframeState.selectedPlatform`\n\n---\n\n## Files Referenced\n- `/Users/imorgado/SPLICE/splice-cep/panel/js/socialReframe.js` (783 lines)"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":9954,"cache_read_input_tokens":30861,"cache_creation":{"ephemeral_5m_input_tokens":9954,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CX3oDD9oZtFvnG2yBhkce","type":"assistant","uuid":"2d9621c2-7e10-4393-af9c-011ea8972242","timestamp":"2026-01-12T16:28:06.157Z"}
