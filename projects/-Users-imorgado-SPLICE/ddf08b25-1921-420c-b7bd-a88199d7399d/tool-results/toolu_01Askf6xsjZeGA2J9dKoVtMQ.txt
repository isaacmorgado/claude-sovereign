     1→/**
     2→ * SPLICE CEP Panel - Main Entry Point
     3→ * v4.0.0 - CEP Migration
     4→ */
     5→
     6→// ============================================================================
     7→// CACHED DOM ELEMENTS
     8→// ============================================================================
     9→const ui = {};
    10→
    11→function cacheUIElements() {
    12→    ui.status = document.getElementById('status');
    13→    ui.goBtn = document.getElementById('goBtn');
    14→    ui.optionsToggle = document.getElementById('optionsToggle');
    15→    ui.optionsPanel = document.getElementById('optionsPanel');
    16→
    17→    // DIAGNOSTIC: Log critical element status immediately
    18→    const criticalElements = {
    19→        'status': ui.status,
    20→        'goBtn': ui.goBtn,
    21→        'optionsToggle': ui.optionsToggle,
    22→        'optionsPanel': ui.optionsPanel
    23→    };
    24→    const missingCritical = Object.entries(criticalElements)
    25→        .filter(([name, el]) => !el)
    26→        .map(([name]) => name);
    27→
    28→    if (missingCritical.length > 0) {
    29→        console.error('[SPLICE] CRITICAL: Missing UI elements during cache:', missingCritical);
    30→        console.error('[SPLICE] DOM readyState:', document.readyState);
    31→    }
    32→
    33→    // Sliders and options
    34→    ui.sensitivitySlider = document.getElementById('sensitivitySlider');
    35→    ui.sensitivityValue = document.getElementById('sensitivityValue');
    36→    ui.sourceOriginal = document.getElementById('sourceOriginal');
    37→    ui.sourceIsolated = document.getElementById('sourceIsolated');
    38→
    39→    // Feature toggles
    40→    ui.enableTakesDetection = document.getElementById('enableTakesDetection');
    41→    ui.enableJCut = document.getElementById('enableJCut');
    42→    ui.jcutSettings = document.getElementById('jcutSettings');
    43→    ui.jcutLeadIn = document.getElementById('jcutLeadIn');
    44→    ui.jcutLeadInValue = document.getElementById('jcutLeadInValue');
    45→    ui.jcutLeadOut = document.getElementById('jcutLeadOut');
    46→    ui.jcutLeadOutValue = document.getElementById('jcutLeadOutValue');
    47→
    48→    // Zoom settings
    49→    ui.enableZoom = document.getElementById('enableZoom');
    50→    ui.zoomSettings = document.getElementById('zoomSettings');
    51→    ui.zoomFrequency = document.getElementById('zoomFrequency');
    52→    ui.zoomPreset = document.getElementById('zoomPreset');
    53→    ui.zoomPlacement = document.getElementById('zoomPlacement');
    54→
    55→    // Chapter settings
    56→    ui.enableChapters = document.getElementById('enableChapters');
    57→    ui.chapterSettings = document.getElementById('chapterSettings');
    58→    ui.maxChapters = document.getElementById('maxChapters');
    59→    ui.minChapterLength = document.getElementById('minChapterLength');
    60→
    61→    // Profanity settings
    62→    ui.enableProfanity = document.getElementById('enableProfanity');
    63→    ui.profanitySettings = document.getElementById('profanitySettings');
    64→
    65→    // Filler word settings
    66→    ui.enableFillerDetection = document.getElementById('enableFillerDetection');
    67→    ui.fillerSettings = document.getElementById('fillerSettings');
    68→
    69→    // Progress
    70→    ui.progressContainer = document.getElementById('progressContainer');
    71→    ui.progressBar = document.getElementById('progressBar');
    72→    ui.progressText = document.getElementById('progressText');
    73→    ui.resultsEmpty = document.getElementById('resultsEmpty');
    74→
    75→    // Preview
    76→    ui.combinedPreview = document.getElementById('combinedPreview');
    77→    ui.previewList = document.getElementById('previewList');
    78→    ui.silenceCount = document.getElementById('silenceCount');
    79→    ui.takeCount = document.getElementById('takeCount');
    80→    ui.selectedCount = document.getElementById('selectedCount');
    81→    ui.selectAllSilences = document.getElementById('selectAllSilences');
    82→    ui.applyPreviewBtn = document.getElementById('applyPreviewBtn');
    83→    ui.cancelPreviewBtn = document.getElementById('cancelPreviewBtn');
    84→    ui.buildSequenceBtn = document.getElementById('buildSequenceBtn');
    85→
    86→    // Results
    87→    ui.zoomResults = document.getElementById('zoomResults');
    88→    ui.zoomList = document.getElementById('zoomList');
    89→    ui.chapterResults = document.getElementById('chapterResults');
    90→    ui.chapterList = document.getElementById('chapterList');
    91→    ui.copyYouTubeBtn = document.getElementById('copyYouTubeBtn');
    92→    ui.addChapterMarkersBtn = document.getElementById('addChapterMarkersBtn');
    93→
    94→    // Modals
    95→    ui.settingsBtn = document.getElementById('settingsBtn');
    96→    ui.settingsModal = document.getElementById('settingsModal');
    97→    ui.closeSettingsBtn = document.getElementById('closeSettingsBtn');
    98→    ui.loginModal = document.getElementById('loginModal');
    99→    ui.closeLoginBtn = document.getElementById('closeLoginBtn');
   100→    ui.licenseKeyInput = document.getElementById('licenseKeyInput');
   101→    ui.saveLoginBtn = document.getElementById('saveLoginBtn');
   102→
   103→    // Debug modal
   104→    ui.debugBtn = document.getElementById('debugBtn');
   105→    ui.debugModal = document.getElementById('debugModal');
   106→    ui.closeDebugBtn = document.getElementById('closeDebugBtn');
   107→    ui.debugQuickDiagnosis = document.getElementById('debugQuickDiagnosis');
   108→    ui.debugLogs = document.getElementById('debugLogs');
   109→    ui.runDiagnosticsBtn = document.getElementById('runDiagnosticsBtn');
   110→    ui.copyDiagnosticsBtn = document.getElementById('copyDiagnosticsBtn');
   111→
   112→    // Credit badge
   113→    ui.creditBadge = document.getElementById('creditBadge');
   114→
   115→    // Preset selector
   116→    ui.presetSelector = document.getElementById('presetSelector');
   117→}
   118→
   119→// ============================================================================
   120→// STATE MANAGEMENT
   121→// ============================================================================
   122→let previewSilences = [];
   123→let previewTakes = [];
   124→let currentChapters = [];
   125→let currentZooms = [];
   126→let currentProfanity = [];
   127→let selectedSilenceIndices = new Set();
   128→let isOperationInProgress = false;
   129→let lastDetectionResult = null;
   130→let currentAudioPath = null;
   131→let currentSequenceInfo = null;
   132→let currentTranscript = null;
   133→
   134→// Global state for captions/reframe modules
   135→window.spliceState = {
   136→    lastTranscript: null,
   137→    currentVideoPath: null,
   138→    activeSequence: null,
   139→    audioPath: null
   140→};
   141→
   142→// Also expose transcript globally for music module
   143→window.currentTranscript = null;
   144→
   145→// ============================================================================
   146→// INITIALIZATION
   147→// ============================================================================
   148→document.addEventListener('DOMContentLoaded', async () => {
   149→    // Premium Loading Experience
   150→    setTimeout(() => {
   151→        const loader = document.getElementById('loading-overlay');
   152→        if (loader) loader.classList.add('hidden');
   153→    }, 800); // Small delay for smooth perception
   154→    debugLog('Initializing CEP panel...');
   155→
   156→    // Debug: Show init started
   157→    const statusEl = document.getElementById('status');
   158→    if (statusEl) statusEl.textContent = 'Initializing...';
   159→
   160→    // Cache DOM elements
   161→    cacheUIElements();
   162→
   163→    // Load settings
   164→    loadSettingsToUI();
   165→
   166→    // Initialize UI handlers
   167→    initOptionsToggle();
   168→    initSliders();
   169→    initFeatureToggles();
   170→    initPresetSelector();
   171→    initGoButton();
   172→    initPreviewHandlers();
   173→    initModals();
   174→    initLoginModal();
   175→    initCredits();
   176→    initHelpButton();
   177→    initDebugModal();
   178→
   179→    // Initialize offline detection
   180→    if (typeof initOfflineDetection === 'function') {
   181→        initOfflineDetection();
   182→    }
   183→
   184→    // Initialize multitrack UI
   185→    if (typeof initMultitrackUI === 'function') {
   186→        initMultitrackUI();
   187→    }
   188→
   189→    // Initialize animated captions UI
   190→    if (typeof initAnimatedCaptions === 'function') {
   191→        initAnimatedCaptions();
   192→    }
   193→
   194→    // Initialize text editor UI
   195→    if (typeof initTextEditor === 'function') {
   196→        initTextEditor();
   197→    }
   198→
   199→    // Initialize text editor section toggle
   200→    initTextEditorToggle();
   201→
   202→    // Initialize social reframe UI
   203→    if (typeof initSocialReframe === 'function') {
   204→        initSocialReframe();
   205→    }
   206→
   207→    // Initialize social reframe section toggle
   208→    initSocialReframeToggle();
   209→
   210→    // Initialize music UI
   211→    if (typeof initMusicModule === 'function') {
   212→        initMusicModule();
   213→    }
   214→
   215→    // Initialize music section toggle
   216→    initMusicToggle();
   217→
   218→    // Initialize JSX bridge first, then check connection
   219→    // This ensures jsx.init() completes before checkJSXConnection() uses it
   220→    await jsx.init();
   221→    await checkJSXConnection();
   222→
   223→    // Initialize sequence event listeners for real-time state updates
   224→    initSequenceEventListeners();
   225→
   226→    // DIAGNOSTIC: Verify all critical UI elements are properly initialized
   227→    verifyUIInitialization();
   228→
   229→    setStatus('Ready');
   230→    debugLog('CEP panel initialized');
   231→});
   232→
   233→/**
   234→ * Post-initialization diagnostic to verify all critical UI elements
   235→ * are properly cached and event listeners are attached
   236→ */
   237→function verifyUIInitialization() {
   238→    const criticalElements = {
   239→        'goBtn': { el: ui.goBtn, desc: 'GO button (main action)' },
   240→        'settingsBtn': { el: ui.settingsBtn, desc: 'Settings button' },
   241→        'debugBtn': { el: ui.debugBtn, desc: 'Debug button' },
   242→        'creditBadge': { el: ui.creditBadge, desc: 'Credit badge' },
   243→        'status': { el: ui.status, desc: 'Status bar' },
   244→        'optionsToggle': { el: ui.optionsToggle, desc: 'Options toggle' },
   245→        'optionsPanel': { el: ui.optionsPanel, desc: 'Options panel' }
   246→    };
   247→
   248→    const missingElements = [];
   249→    const presentElements = [];
   250→
   251→    Object.entries(criticalElements).forEach(([id, { el, desc }]) => {
   252→        if (!el) {
   253→            missingElements.push(`#${id} (${desc})`);
   254→        } else {
   255→            presentElements.push(id);
   256→        }
   257→    });
   258→
   259→    if (missingElements.length > 0) {
   260→        console.error('[SPLICE] ⚠️ UI INITIALIZATION INCOMPLETE');
   261→        console.error('[SPLICE] Missing critical elements:', missingElements);
   262→        console.error('[SPLICE] Panel may not function correctly. Check index.html structure.');
   263→
   264→        // Show error in status bar if available
   265→        const statusEl = document.getElementById('status');
   266→        if (statusEl) {
   267→            statusEl.textContent = 'Init error: ' + missingElements.length + ' UI elements missing';
   268→            statusEl.classList.add('error');
   269→        }
   270→    } else {
   271→        console.log('[SPLICE] ✓ All critical UI elements initialized:', presentElements.join(', '));
   272→    }
   273→
   274→    // Verify GO button has click listener
   275→    if (ui.goBtn) {
   276→        const listeners = getEventListeners ? getEventListeners(ui.goBtn) : null;
   277→        if (!listeners || !listeners.click || listeners.click.length === 0) {
   278→            // Can't check in production, but log that we tried
   279→            console.log('[SPLICE] GO button present - click handler should be attached');
   280→        }
   281→    }
   282→}
   283→
   284→// ============================================================================
   285→// SEQUENCE EVENT LISTENERS
   286→// ============================================================================
   287→/**
   288→ * Initialize event listeners for sequence state changes
   289→ * This provides real-time updates when sequences are activated/deactivated
   290→ */
   291→function initSequenceEventListeners() {
   292→    if (!jsx.cs) {
   293→        console.warn('[SPLICE] Cannot init sequence listeners - CSInterface not available');
   294→        return;
   295→    }
   296→
   297→    try {
   298→        // Listen for sequence activation events
   299→        jsx.cs.addEventListener('com.adobe.csxs.events.SequenceActivated', async (event) => {
   300→            debugLog('Sequence activated event received');
   301→            try {
   302→                const seqInfo = await jsx.call('getActiveSequence');
   303→                if (seqInfo && !seqInfo.error) {
   304→                    window.spliceState.activeSequence = seqInfo;
   305→                    setStatus('Sequence: ' + (seqInfo.name || 'Unknown'));
   306→                    debugLog('Active sequence updated:', seqInfo.name);
   307→                }
   308→            } catch (e) {
   309→                console.warn('[SPLICE] Failed to get sequence info on activation:', e.message);
   310→            }
   311→        });
   312→
   313→        // Listen for sequence close/deactivation
   314→        jsx.cs.addEventListener('com.adobe.csxs.events.SequenceDeactivated', () => {
   315→            debugLog('Sequence deactivated event');
   316→            window.spliceState.activeSequence = null;
   317→            setStatus('No sequence open', true);
   318→        });
   319→
   320→        // Listen for project item selection changes (includes sequences)
   321→        jsx.cs.addEventListener('com.adobe.csxs.events.SelectionChanged', async () => {
   322→            // Debounce rapid selection changes
   323→            if (window._selectionChangeTimeout) {
   324→                clearTimeout(window._selectionChangeTimeout);
   325→            }
   326→            // FIX: Increased debounce to 500ms to allow Premiere Pro state to settle
   327→            window._selectionChangeTimeout = setTimeout(async () => {
   328→                try {
   329→                    // FIX: Use retries (2 attempts, 300ms delay) to handle timing issues
   330→                    // Previous code used (0, 0) which caused race conditions
   331→                    const hasSequence = await checkSequenceOpen(2, 300);
   332→                    if (hasSequence && !window.spliceState.activeSequence) {
   333→                        const seqInfo = await jsx.call('getActiveSequence');
   334→                        if (seqInfo && !seqInfo.error) {
   335→                            window.spliceState.activeSequence = seqInfo;
   336→                            setStatus('Sequence: ' + (seqInfo.name || 'Unknown'));
   337→                            debugLog('Sequence detected via selection change:', seqInfo.name);
   338→                        }
   339→                    }
   340→                } catch (e) {
   341→                    // FIX: Log errors instead of silently ignoring
   342→                    console.warn('[SPLICE] Selection change handler error:', e.message);
   343→                    debugLog('Selection change failed:', e.message);
   344→                }
   345→            }, 500);
   346→        });
   347→
   348→        debugLog('Sequence event listeners initialized');
   349→    } catch (e) {
   350→        console.error('[SPLICE] Failed to init sequence event listeners:', e.message);
   351→    }
   352→}
   353→
   354→// ============================================================================
   355→// JSX CONNECTION CHECK
   356→// ============================================================================
   357→async function checkJSXConnection() {
   358→    try {
   359→        const result = await jsx.call('getVersion');
   360→        debugLog('JSX connection OK, version:', result);
   361→        return true;
   362→    } catch (e) {
   363→        console.warn('[SPLICE] JSX connection failed:', e.message);
   364→        setStatus('Premiere Pro connection failed', true);
   365→        return false;
   366→    }
   367→}
   368→
   369→/**
   370→ * Check if a sequence is currently open in the Timeline
   371→ * Enhanced with logging and retry logic
   372→ * @param {number} retries - Number of retry attempts (default: 2)
   373→ * @param {number} delayMs - Delay between retries in ms (default: 300)
   374→ * @returns {Promise<boolean>} true if sequence is open
   375→ */
   376→async function checkSequenceOpen(retries = 2, delayMs = 300) {
   377→    console.log('[SPLICE] ========== checkSequenceOpen DIAGNOSTIC START ==========');
   378→    console.log('[SPLICE] checkSequenceOpen: retries=' + retries + ', delayMs=' + delayMs);
   379→    console.log('[SPLICE] checkSequenceOpen: window.spliceState.activeSequence =', window.spliceState.activeSequence);
   380→    
   381→    for (let attempt = 0; attempt <= retries; attempt++) {
   382→        try {
   383→            console.log('[SPLICE] checkSequenceOpen: Attempt ' + (attempt + 1) + ' of ' + (retries + 1));
   384→            console.log('[SPLICE] checkSequenceOpen: Calling jsx.call("checkSequenceOpen")...');
   385→            const result = await jsx.call('checkSequenceOpen');
   386→            console.log('[SPLICE] checkSequenceOpen: JSX call returned');
   387→            console.log('[SPLICE] checkSequenceOpen: result =', result, '(type:', typeof result + ')');
   388→            debugLog('checkSequenceOpen attempt', attempt + 1, 'result:', result, 'type:', typeof result);
   389→
   390→            if (result === true || result === 'true') {
   391→                console.log('[SPLICE] checkSequenceOpen: Returning TRUE - sequence is open');
   392→                console.log('[SPLICE] ========== checkSequenceOpen DIAGNOSTIC END (TRUE) ==========');
   393→                return true;
   394→            }
   395→
   396→            // If false, wait and retry (sequence might be loading)
   397→            if (attempt < retries) {
   398→                console.log('[SPLICE] checkSequenceOpen: No sequence found, retrying in', delayMs, 'ms...');
   399→                debugLog('checkSequenceOpen: No sequence found, retrying in', delayMs, 'ms...');
   400→                await new Promise(r => setTimeout(r, delayMs));
   401→            }
   402→        } catch (error) {
   403→            console.error('[SPLICE] checkSequenceOpen: Attempt', attempt + 1, 'failed with exception:', error.message);
   404→            console.error('[SPLICE] checkSequenceOpen: Error stack:', error.stack);
   405→
   406→            // On last attempt, return false but log the actual error
   407→            if (attempt === retries) {
   408→                console.error('[SPLICE] checkSequenceOpen: All attempts failed. Last error:', error.message);
   409→                // Store error for diagnostics
   410→                window.spliceState.lastSequenceCheckError = error.message;
   411→                console.log('[SPLICE] checkSequenceOpen: Stored error in window.spliceState.lastSequenceCheckError:', error.message);
   412→                console.log('[SPLICE] ========== checkSequenceOpen DIAGNOSTIC END (ERROR) ==========');
   413→                return false;
   414→            }
   415→
   416→            // Wait before retry
   417→            console.log('[SPLICE] checkSequenceOpen: Waiting', delayMs, 'ms before retry...');
   418→            await new Promise(r => setTimeout(r, delayMs));
   419→        }
   420→    }
   421→    console.log('[SPLICE] checkSequenceOpen: All attempts completed without finding sequence');
   422→    console.log('[SPLICE] ========== checkSequenceOpen DIAGNOSTIC END (FALSE) ==========');
   423→    return false;
   424→}
   425→
   426→// ============================================================================
   427→// OPTIONS TOGGLE
   428→// ============================================================================
   429→function initOptionsToggle() {
   430→    debugLog('initOptionsToggle - toggle:', !!ui.optionsToggle, 'panel:', !!ui.optionsPanel);
   431→    if (ui.optionsToggle && ui.optionsPanel) {
   432→        ui.optionsToggle.addEventListener('click', () => {
   433→            debugLog('Options toggle clicked');
   434→            // Check current state BEFORE toggling
   435→            const wasCollapsed = ui.optionsPanel.classList.contains('collapsed');
   436→            ui.optionsPanel.classList.toggle('collapsed');
   437→            // If it was collapsed, it's now expanded (show 'expanded' class)
   438→            ui.optionsToggle.classList.toggle('expanded', wasCollapsed);
   439→            saveSettings({ expandedOptions: wasCollapsed });
   440→        });
   441→
   442→        // Restore state
   443→        const settings = getSettings();
   444→        if (!settings.expandedOptions) {
   445→            ui.optionsPanel.classList.add('collapsed');
   446→            ui.optionsToggle.classList.remove('expanded');
   447→        } else {
   448→            ui.optionsToggle.classList.add('expanded');
   449→            ui.optionsPanel.classList.remove('collapsed');
   450→        }
   451→    }
   452→}
   453→
   454→// ============================================================================
   455→// TEXT EDITOR TOGGLE
   456→// ============================================================================
   457→function initTextEditorToggle() {
   458→    const toggle = document.getElementById('textEditorToggle');
   459→    const panel = document.getElementById('text-editor-panel');
   460→    debugLog('initTextEditorToggle - toggle:', !!toggle, 'panel:', !!panel);
   461→
   462→    if (toggle && panel) {
   463→        toggle.addEventListener('click', (e) => {
   464→            e.preventDefault();
   465→            e.stopPropagation();
   466→            debugLog('Text Editor toggle clicked');
   467→            setStatus('Text Editor: ' + (panel.classList.contains('collapsed') ? 'Opening' : 'Closing'));
   468→            // Check state BEFORE toggling
   469→            const wasCollapsed = panel.classList.contains('collapsed');
   470→            panel.classList.toggle('collapsed');
   471→            const icon = toggle.querySelector('.toggle-icon');
   472→            debugLog('wasCollapsed:', wasCollapsed, 'icon:', !!icon);
   473→            if (icon) {
   474→                // If it was collapsed, it's now expanded (show -)
   475→                icon.textContent = wasCollapsed ? '-' : '+';
   476→            }
   477→        });
   478→    } else {
   479→        console.error('[SPLICE] Text Editor toggle elements not found!');
   480→    }
   481→}
   482→
   483→// ============================================================================
   484→// SOCIAL REFRAME TOGGLE
   485→// ============================================================================
   486→function initSocialReframeToggle() {
   487→    const toggle = document.getElementById('socialReframeToggle');
   488→    const panel = document.getElementById('social-reframe-panel');
   489→    debugLog('initSocialReframeToggle - toggle:', !!toggle, 'panel:', !!panel);
   490→
   491→    if (toggle && panel) {
   492→        toggle.addEventListener('click', () => {
   493→            debugLog('Social Reframe toggle clicked');
   494→            // Check state BEFORE toggling
   495→            const wasCollapsed = panel.classList.contains('collapsed');
   496→            panel.classList.toggle('collapsed');
   497→            const icon = toggle.querySelector('.toggle-icon');
   498→            if (icon) {
   499→                // If it was collapsed, it's now expanded (show -)
   500→                icon.textContent = wasCollapsed ? '-' : '+';
   501→            }
   502→        });
   503→    } else {
   504→        console.error('[SPLICE] Social Reframe toggle elements not found!');
   505→    }
   506→}
   507→
   508→// ============================================================================
   509→// MUSIC TOGGLE
   510→// ============================================================================
   511→function initMusicToggle() {
   512→    const toggle = document.getElementById('musicToggle');
   513→    const panel = document.getElementById('music-panel');
   514→    debugLog('initMusicToggle - toggle:', !!toggle, 'panel:', !!panel);
   515→
   516→    if (toggle && panel) {
   517→        toggle.addEventListener('click', () => {
   518→            debugLog('Music toggle clicked');
   519→            // Check state BEFORE toggling
   520→            const wasCollapsed = panel.classList.contains('collapsed');
   521→            panel.classList.toggle('collapsed');
   522→            const icon = toggle.querySelector('.toggle-icon');
   523→            if (icon) {
   524→                // If it was collapsed, it's now expanded (show -)
   525→                icon.textContent = wasCollapsed ? '-' : '+';
   526→            }
   527→        });
   528→    } else {
   529→        console.error('[SPLICE] Music toggle elements not found!');
   530→    }
   531→}
   532→
   533→// ============================================================================
   534→// SLIDERS
   535→// ============================================================================
   536→function initSliders() {
   537→    // Sensitivity slider
   538→    if (ui.sensitivitySlider && ui.sensitivityValue) {
   539→        ui.sensitivitySlider.addEventListener('input', () => {
   540→            ui.sensitivityValue.textContent = ui.sensitivitySlider.value;
   541→            saveSettings({ sensitivity: parseInt(ui.sensitivitySlider.value) });
   542→        });
   543→    }
   544→
   545→    // J-Cut sliders
   546→    if (ui.jcutLeadIn && ui.jcutLeadInValue) {
   547→        ui.jcutLeadIn.addEventListener('input', () => {
   548→            const val = (ui.jcutLeadIn.value / 100).toFixed(2);
   549→            ui.jcutLeadInValue.textContent = val + 's';
   550→            saveSettings({ jcutLeadIn: parseFloat(val) });
   551→        });
   552→    }
   553→
   554→    if (ui.jcutLeadOut && ui.jcutLeadOutValue) {
   555→        ui.jcutLeadOut.addEventListener('input', () => {
   556→            const val = (ui.jcutLeadOut.value / 100).toFixed(2);
   557→            ui.jcutLeadOutValue.textContent = val + 's';
   558→            saveSettings({ jcutLeadOut: parseFloat(val) });
   559→        });
   560→    }
   561→}
   562→
   563→// ============================================================================
   564→// FEATURE TOGGLES
   565→// ============================================================================
   566→function initFeatureToggles() {
   567→    // J-Cut toggle
   568→    if (ui.enableJCut && ui.jcutSettings) {
   569→        ui.enableJCut.addEventListener('change', () => {
   570→            ui.jcutSettings.classList.toggle('collapsed', !ui.enableJCut.checked);
   571→            saveSettings({ enableJCut: ui.enableJCut.checked });
   572→        });
   573→    }
   574→
   575→    // Zoom toggle
   576→    if (ui.enableZoom && ui.zoomSettings) {
   577→        ui.enableZoom.addEventListener('change', () => {
   578→            ui.zoomSettings.classList.toggle('collapsed', !ui.enableZoom.checked);
   579→            saveSettings({ enableZoom: ui.enableZoom.checked });
   580→        });
   581→    }
   582→
   583→    // Chapters toggle
   584→    if (ui.enableChapters && ui.chapterSettings) {
   585→        ui.enableChapters.addEventListener('change', () => {
   586→            ui.chapterSettings.classList.toggle('collapsed', !ui.enableChapters.checked);
   587→            saveSettings({ enableChapters: ui.enableChapters.checked });
   588→        });
   589→    }
   590→
   591→    // Takes detection toggle
   592→    if (ui.enableTakesDetection) {
   593→        ui.enableTakesDetection.addEventListener('change', () => {
   594→            saveSettings({ enableTakesDetection: ui.enableTakesDetection.checked });
   595→        });
   596→    }
   597→
   598→    // Profanity detection toggle
   599→    if (ui.enableProfanity && ui.profanitySettings) {
   600→        ui.enableProfanity.addEventListener('change', () => {

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
